index,text
23960,autonomous underwater vehicles auvs operate in the three dimensional and time dependent marine environment with strong and dynamic currents our goal is to predict the time history of the optimal three dimensional headings of these vehicles such that they reach the given destination location in the least amount of time starting from a known initial position we employ the exact differential equations for time optimal path planning and develop theory and numerical schemes to accurately predict three dimensional optimal paths for several classes of marine vehicles respecting their specific propulsion constraints we further show that the three dimensional path planning problem can be reduced to a two dimensional one if the motion of the vehicle is partially known e g if the vertical component of the motion is forced this reduces the computational cost we then apply the developed theory in three dimensional analytically known flow fields to verify the schemes benchmark the accuracy and demonstrate capabilities finally we showcase time optimal path planning in realistic data assimilative ocean simulations for the middle atlantic bight region integrating the primitive equation of the multidisciplinary simulation estimation and assimilation system mseas with the three dimensional path planning equations for three common marine vehicles namely propelled auvs with unrestricted motion floats that only propel vertically and gliders that often perform sinusoidal yo yo motions in vertical planes these results highlight the effects of dynamic three dimensional multiscale ocean currents on the optimal paths including the gulf stream shelfbreak front jet upper layer jets eddies and wind driven and tidal currents they also showcase the need to utilize data assimilative ocean forecasts for planning efficient autonomous missions from optimal deployment and pick up to monitoring and adaptive data collection keywords path planning three dimensional level set data assimilation ocean forecasting auvs gliders floats 1 introduction the problem of planning feasible safe and optimal paths in complex and dynamic environments has received much attention from many branches of science and engineering in the most general sense optimal path planning refers to a set of rules provided to an autonomous robot such that the robot can navigate from some initial configuration to the desired configuration in an optimal fashion typically such optimality is governed by some objective function autonomous robotic platforms are becoming ubiquitous day by day and are used to perform a variety of tasks with different levels of complexity this leads to a wide range of objective functions principled path planning theories that apply to several situations are thus not common optimal navigation of autonomous underwater vehicles auvs is crucial for many applications including security search and rescue monitoring and data collection underwater gliders and floats are ideal for ocean sampling due to their long range endurance and significant autonomy however these vehicles typically travel at relatively slow speeds in many cases comparable to that of the local ocean currents schmidt et al 1996 elisseeff et al 1999 yan et al 2014 hence the effect of currents on their net motion cannot be neglected and should be modeled accurately the ocean environment in which these vehicles operate is however a highly dynamic system with high spatio temporal variability cushman roisin and beckers 2011 it is therefore challenging to develop accurate and efficient methodologies to predict paths that optimize a desired objective function while modeling both the dynamic environment and the vehicle constraints achieving such principled path planning in three dimensions integrating data assimilative ocean modeling with model predictive control is the motivation of the present work existing works in underwater path planning have mostly studied two dimensional 2d or quasi two dimensional scenarios kulkarni 2017 however ocean currents often differ greatly with depth cushman roisin and beckers 2011 in order to reach the destination in optimal time underwater vehicles need to utilize favorable currents and also avoid adverse currents by diving or rising to appropriate depths underwater path planning in fully three dimensional 3d real ocean domains is thus of great importance predicting ocean currents over real domains is needed for such planning but numerically challenging oceans are complex dynamical systems with multiple time scales from seconds to years and length scales from millimeters to hundreds of kilometers cushman roisin and beckers 2011 robust and accurate numerical schemes and data assimilative models are thus needed lermusiaux et al 2006b lermusiaux et al 2006 pinardi et al 2017 further there are different types of marine vehicles with specific degrees of freedom and propulsion constraints typical marine gliders used for sampling data commonly perform a sinusoidal motion rudnick et al 2004 testor et al 2010 javaid et al 2014 whereas floats that drift with ocean currents are only able to perform vertical motion by adjusting their buoyancy roemmich et al 2009 kobayashi et al 2012 in order to plan feasible safe and optimal trajectories for such vehicles one needs to respect these specific propulsion constraints the desired attributes listed above are crucial to optimal path planning in real ocean scenarios in the present work we start from the governing path planning equations lolla et al 2012 2014a b lermusiaux et al 2016 they account for the effects of the dynamic environmental flow field on the net vehicle motion they predict exact globally optimal paths without heuristics lolla and lermusiaux 2020 are computationally efficient lolla et al 2012 and can account for unsafe forbidden regions and stationary or moving obstacles lolla et al 2015 the effectiveness of the algorithms was experimentally demonstrated in multiple sea trials subramani et al 2017b edwards et al 2017 mirabito et al 2017 results were extended to predict the paths that minimize the energy usage subramani and lermusiaux 2016 subramani et al 2017a or maximize the quality of data collected by the vehicles lolla 2016 lermusiaux et al 2017 presently for the first time we address both fully 3d realistic ocean setups and 3d propulsion constraints we develop the theory and numerical methods to handle the complexities of dynamic 3d flow fields and motion constraints on realistic marine vehicles we verify the schemes in benchmark flows we then analyze results in the middle atlantic bight region we describe the regional dynamics and our data assimilative ocean modeling system we finally showcase the impact of the dynamic 3d circulation features on the evolution of the reachability fronts and time optimal paths for several common types of marine vehicles the paper is organized as follows we first briefly review prior results on 3d path planning in static and dynamic environments in section 2 we state the problem and provide the equations that govern the optimal trajectories extensions to motion constrained marine vehicles in 3d domains are derived in section 3 in section 4 we develop numerical schemes to achieve high accuracy in real ocean domains in section 5 we verify the path planning in 3d analytical benchmark flows in section 6 we describe the dynamics and modeling of the middle atlantic bight region and complete realistic simulations to compare and contrast path planning for common types of marine vehicles the summary and conclusions are in section 7 1 1 prior progress in optimal path planning in three dimensional and realistic domains optimal path planning in 3d domains is a complex and challenging problem and hence algorithms for the same have not been studied extensively however utilizing environmental flows and planning feasible although sub optimal paths in three dimensions has been elaborately studied by several researchers from a wide variety of areas for example kiraly et al 2004 compute feasible 3d trajectories for a bronchoscope in various airways inside the human body while siddon 1985 plans paths for 3d computed tomography in radiology nature also serves as a motivation for optimal planning problems for example richardson 2012 and sachs et al 2013 mimic the dynamic soaring of the albatross for autonomous aerial vehicles in order to optimize energy consumption the albatross utilizes the lee eddies located downwind of sharp crested waves to increase its speed such a maneuver requires minor adjustments to the trajectory but saves significant energy other similar dynamic soaring patterns to minimize the energy spent during travel are also studied by bonnin 2016 and zhao 2004 planning feasible and collision free trajectories for aerial vehicles is an active field with many established approaches lozano pérez and wesley 1979 use a network based scheme to plan paths in domains with forbidden regions and obstacles mittal and deb 2007 attempt to plan feasible paths offline using evolutionary algorithms wong and fu 1986 utilize a network based scheme on two dimensional sections of the 3d domain for computational efficiency this idea of planning collision free paths is also extended to larger aircraft and congested airports for which most results rely on optimization techniques such as integer programming for example richards and how 2002 use mixed integer linear programming to plan collision free aircraft trajectories whereas frazzoli et al 2001 utilize semi definite programming prete and mitchell 2004 and krozel et al 2006 employ network based approaches to compute safe aircraft trajectories that minimize travel in time varying 3d hazardous weather regions in the ocean domain pereira et al 2013 provide an algorithm to compute 3d underwater vehicle paths that minimize the risk of collision with ships and land they use the regional ocean modeling system for oceanic flow fields and a markov decision process based approach and expectation minimization to decrease the risk of collision smith et al 2010 further extend this methodology to tracking a dynamically evolving ocean feature while minimizing the risk of collision with ships and other possible obstacles petillot et al 2001 utilize data from an onboard sonar sensor to plan paths that minimize the risk of collisions with objects and obstacles in the ocean a common approach towards optimal path planning is to use a myopic optimization where the vehicle chooses the short term optimal option among other options global optimality is then not guaranteed but the approach is nonetheless useful for example zamuda and sosa 2014 consider a glider that gathers data while following a path towards some set destination where a short term opportunistic sampling algorithm is used to maximize the quality of the data collected a continuum viewpoint has also been used for 3d robotic path planning such as the potential field method eliminating the need for network based models connolly et al 1990 wang and chirikjian 2000 all obstacles are then assumed to exert a repelling force whereas the target position exerts an attractive force on a potential function heuristics are needed to account for the effect of external flow fields on the computed path finally to plan glider paths in 3d ocean environments garau et al 2014 used the a algorithm hart et al 1968 with examples in the western mediterranean sea even though the a algorithm is efficient its use of heuristics does not guarantee global optimality witt and dunbabin 2008 build upon kruger et al 2007 to find paths that minimize the energy spent by an autonomous vehicle in 3d ocean domains this is achieved by using the present current to the greatest advantage this local method efficiently chooses an energy optimal path amongst the considered candidate paths however as all the possible paths are not considered strict global optimality is not ensured for more extensive reviews we refer to kulkarni 2017 2 optimal path planning using the level set method theory in what follows we formally describe the problem statement and introduce the exact time optimal path planning equations that establish the theoretical foundation further details can be found in lolla et al 2014b lolla 2016 and lolla and lermusiaux 2020 2 1 problem statement consider the motion of a vehicle from the start point x s to the destination x f in the domain ω r 3 let the trajectory of the vehicle be given by x t fig 1 illustrates the velocity components of the vehicle as it moves from the start point to the target the first component is the vehicle propulsion in the direction of the heading h ˆ with a speed f v that is bounded by zero and a maximum speed i e 0 f v f h ˆ x t this latter maximum nominal propulsion speed of the vehicle denoted by f h ˆ x t is in general a given function of the heading direction h ˆ spatial location x and present time t the vehicle is also forced by a dynamic external velocity field v x t ω 0 r 3 the second velocity component of vehicle is thus the advection by the velocity field v x t t i e the ocean currents the effective velocity experienced by the vehicle is given by 1 v e x t t d x t d t f v h ˆ v x t t in nautical jargon the magnitude of the horizontal component of the effective velocity v e is often referred to as speed over ground and the vehicle speed f v as speed through water we denote the first arrival time function by t x x 0 t 0 it is the time at which the vehicle reaches any specified point x for the first time given that it started from x 0 at time t 0 clearly we have 2 t x s x s 0 0 and x t x f x s 0 x f it is proven that in order for the vehicle to reach the desired destination in the minimum amount of time it must travel at the maximum allowable speed lolla and lermusiaux 2020 lolla 2016 we thus wish to compute the vehicle heading h ˆ as a function of time that yield minimum travel time for the vehicle between x s and x f subject to the constraints imposed by eqs 1 and 2 hence we search for h ˆ t o p t i m a l defined by 3 h ˆ t o p t i m a l arg min h ˆ f v t x f x s 0 note that in the above formulation the optimal heading choice h ˆ t o p t i m a l is also a function of the position of the vehicle along the optimal trajectory i e x t however as this position itself is function of time once the optimal path is known we drop this implicit dependency of h ˆ t o p t i m a l on x t 2 2 approach exact time optimal path planning hinges upon the concept of reachability lolla 2016 the reachable set is the set of all the points that can be visited by the vehicle by the considered time given the starting point of the vehicle at any time all the points that lie on the boundary of the reachable set i e the reachability front have been reached for the first time the value of their first arrival time function is the present time by keeping track of the reachability front at all times one can determine the time when this front reaches the target for the first time which is the minimum travel time between the start position and the target a path traced by a point that always travels on the reachability front and reaches the target is exactly an optimal path we wish to compute note that there can be multiple optimal paths this broadly divides the problem in two sub parts i first the forward evolution of the reachable set and front and ii second once the reachability front reaches the destination the optimal trajectory traced backwards in time we refer to these sub parts as forward evolution of the reachable set and backward tracing of the optimal path respectively fig 2 pictorially depicts the reachability front analogous to a first wave front and the possible heading choices at two different positions this two step approach involving the forward evolution of the reachability front followed by backward tracing of the optimal trajectory which is a characteristic passing through the destination of the pde governing the reachability front evolution has been proven to be exact even when the external flow speed is larger than the vehicle speed i e the vehicle is not fully controllable lolla 2016 lolla and lermusiaux 2020 2 3 forward evolution of the reachable set and backward tracing of the optimal path we use the level set method to predict the propagation of the reachability front the front is then embedded as the zero level set of a signed distance function henceforth denoted by ϕ the zero level set of a function is simply the set of points at which the function value is zero it is evolved until the target lies on it once this is achieved we compute the optimal path by tracing the trajectory of the particle that always traveled on the reachability front and reached the target at the first arrival time this is done by solving the particle motion ode eq 1 backward in time starting from the destination and by utilizing the optimal heading information from the reachable set evolution in general we have two free control parameters namely the vehicle speed f v and the vehicle heading h ˆ we would like to predict the optimal values of these control parameters as a function of time such that the first arrival time function for the target point t x f x s t 0 is minimized it is proven that for the vehicle to reach the desired destination in the minimum amount of time it must travel at the maximum allowable speed lolla and lermusiaux 2020 lolla 2016 this implies that the only control parameter is the heading of the vehicle we now simply state the significant results that express the solution of this minimization problem more details regarding the same may be found in appendix a and lolla and lermusiaux 2020 lolla 2016 we assume that the possible vehicle trajectories x t are governed by eq 1 with initial condition x 0 x s then the evolution of the reachability front is given by the zero level set of the function ϕ where ϕ x t is the unique viscosity solution osher and fedkiw 2006 lolla and lermusiaux 2020 of the following the hamilton jacobi level set equation 4 ϕ x t t max h ˆ x t f h ˆ x t h ˆ x t ϕ v x t ϕ x t 0 with the initial conditions 5 ϕ x 0 x x s the second term on the left hand side of eq 4 incorporates the propulsion of vehicles and is referred to as the optimal propulsion term the last term on the left hand side of eq 4 is referred to as the advection term as it accounts for the transport of the vehicle by the background external velocity field i e the predicted ocean currents in what follows for clarity we do not explicitly retain the functional dependencies of ϕ h ˆ and v on x t and of f on h ˆ x t unless there is a specific need to clearly denote these dependencies or when it helps in understanding in the special case when the vehicle speed f h ˆ x t is independent of the heading h ˆ of the vehicle isotropic speed the maximization can be performed analytically the resulting hamilton jacobi level set equation for this case is given by eq 6 6 ϕ t f x t ϕ v ϕ 0 we solve eq 4 until the target x f lies on or just inside the reachability front i e until ϕ x f t 0 once this is achieved the optimal trajectory or trajectories x t is given by the characteristic lines of eq 4 that is x t satisfies the following equation 7 d x t d t f h ˆ x t h ˆ t v x t where h ˆ t arg max h ˆ x t f h ˆ x t h ˆ x t ϕ x t these 3d governing path planning equations are exact it is only when they are numerically integrated that truncation round off errors are made and with fine enough resolutions these errors go to zero this is a major advantage when compared to planning schemes that are inexact due to heuristics or simplifications or that are too expensive of course all these schemes also make numerical errors once implemented on a computer e g for graph methods errors depend on graph resolution connectivity time step etc see mannarini et al 2020 3 modeling of realistic marine vehicles we now extend the theory to motion constrained vehicles in 3d domains capturing the behavior of commonly used marine vehicles first we treat vehicles whose speed depends on their heading direction such vehicles are referred to as vehicles with anisotropic speeds vehicles that are constrained to move only along certain directions may also be included in this category as it can be assumed that the vehicle speed is non zero only along the permitted direction s of travel the second class considers vehicles whose motion is known partially in general this motion is assumed to be known along a specific direction which itself could be a function of time we refer to such vehicles as vehicles with partially known motion 3 1 vehicles with anisotropic speeds the reachability front is governed by eq 4 where it is embedded as the zero level set of the level set function ϕ if the propulsion speed of the vehicle is dependent on its heading direction a maximization over all the heading directions is required to be performed at each point of the front or domain at all times to evaluate the optimal propulsion term details of the same are discussed in appendix b if the expression for vehicle speed f is known in terms of the heading h ˆ and the time t then the maximization may be performed analytically as an example we consider the case of an oceanic float these vehicles can only propel in the vertical direction by adjusting their buoyancy rudnick et al 2004 and are advected by the environmental flow mostly in the horizontal due to the commonly smaller ocean vertical currents we model this by enforcing the following 8 h ˆ h z n ˆ z n ˆ z 0 where h z is a subset of r 3 and n ˆ z 0 0 1 is the unit vector along the vertical z direction eq 8 implies that the only directions that the vehicle can be steered in are vertically up or vertically down using this in the maximization term we obtain 9 max h ˆ x t f h ˆ x t h ˆ x t ϕ x t f max 0 0 1 ϕ x ϕ y ϕ z f max ϕ z f ϕ x t z substituting this result in eq 4 the final hamilton jacobi equation to be solved for the motion of a float is given by 10 ϕ t f ϕ z v ϕ 0 with all the possible optimal headings on the reachability front given by 11 h ˆ x t s i g n ϕ x t z n ˆ z the optimal floats headings thus depend on the flow field implicitly through ϕ x t a float that first reaches the target x f will thus alter its upward or downward motion according to the sign of the vertical gradient of ϕ x t along the optimal trajectory governed by eq 7 3 2 vehicles with partially known motion we now examine vehicles whose motion is known along some time dependent direction we prove that in such cases the 3d problem can be decomposed into a two dimensional problem with a hybrid velocity field yielding significant computational savings as will be seen in sections 4 5 and 6 let us assume that the motion of the vehicle at a location x and time t is known along some direction n ˆ x t let the maximum propulsion speed of the vehicle along n ˆ x t be f n x t also assumed to be known let the heading of the vehicle in the plane orthogonal to n ˆ x t at position x and time t be h ˆ x t with speed f h ˆ x t f h ˆ x t 2 f n x t 2 1 2 in what follows for clarity we drop the dependencies of ϕ v n ˆ and f n on x t and of f on h ˆ x t note that f n cannot be a function of h ˆ as that implies that the component sub problems cannot be decoupled as will be seen however as f depends on h ˆ the resulting f is also a function of h ˆ since h ˆ is the unit vector in the direction h ˆ n ˆ where n ˆ is known at all locations at all times and cannot be optimized we can nonetheless reduce the dependency of f on h ˆ to a dependency on h ˆ only the hamilton jacobi equation 4 can thus be written as 12 ϕ t max h ˆ f n n ˆ f h ˆ ϕ v ϕ 0 ϕ t max h ˆ f h ˆ ϕ v f n n ˆ ϕ 0 the advective velocity field itself can be written in terms of component along n ˆ t and components orthogonal to n ˆ t let us denote this decomposition of the velocity field as 13 v x t v n x t n ˆ x t v x t n ˆ x t where n ˆ x t denotes the basis of the plane orthogonal to n ˆ x t and v x t v x t n ˆ x t is the corresponding velocity component substituting this in eq 12 we obtain 14 ϕ t max h ˆ f h ˆ ϕ v n ˆ v n f n n ˆ ϕ 0 we will next use a 1st order operator splitting fractional step method wheeler and dawson 1987 ferziger et al 2020 to split eq 14 into two constituent equations the first equation describes the evolution of the projection of ϕ onto n ˆ ϕ and the second describes the evolution of ϕ along n ˆ ϕ n together the sum of these two contributions yields the evolution of ϕ in ω if their full coupling is maintained as is seen in the following 15a ϕ t max h ˆ f h ˆ ϕ v n ˆ ϕ 0 15b ϕ n t v n f n n ˆ ϕ 0 15c ϕ t ϕ t ϕ n t eq 15a represents the evolution of the reachable set in the plane orthogonal to n ˆ t whereas eq 15b represents the contribution due to the advective and vehicle motion along n ˆ t which does not require any optimization hence in this case the only optimal control problem to be solved is represented by eq 15a which is a reachable set evolution in two dimensions the contribution due to eq 15b is then locally added in order to obtain the final value of ϕ t by summation the initial conditions are for eq 15a ϕ x 0 x x s and for eq 15b ϕ n x 0 x n x s n where the subscripts and n then indicate projection orthogonal to and along n ˆ 0 respectively as for the forward evolution the backward trajectory of the vehicle also consists of two parts i the motion in the orthogonal plane n ˆ t and ii the component along n ˆ t thus the ode defining the optimal trajectory also consists of the sum of two corresponding components 16a d x d t f h ˆ v 16b d x n d t f n n ˆ 16c d x d t d x d t d x n d t where h ˆ t arg max h ˆ x t f h ˆ x t h ˆ x t ϕ x t eq 16a represents the optimal trajectory orthogonal to n ˆ t while eq 16b governs the path along n ˆ t as with eq 7 eq 16c is solved in backward time starting from x t x f x s 0 x f to compute the optimal trajectory numerically if eqs 15a and 15b are integrated separately over δ t without coupling between them splitting errors are made the same can be said about the split backward tracing equations 16 these numerical issues are discussed in section 4 5 4 numerical schemes for realistic ocean domains we now develop accurate consistent and efficient numerical schemes for the path planning equations we first present challenges in realistic 3d ocean scenarios and obtain the non dimensional form of the hamilton jacobi level set equation which is crucial in solving underwater path planning problems we then emphasize the advantages of numerical consistency between the discrete forward evolution of the reachable set and discrete backward tracing of the optimal path finally we develop high order spatial and temporal numerical schemes for the forward evolution of the zero level set function and novel implicit schemes for the backward tracing of the optimal path 4 1 challenges in real ocean domains and non dimensionalization of the hamilton jacobi equation most stratified geophysical fluid flows are extremely anisotropic in terms of length and or velocity scales with orders of magnitude difference between the horizontal and vertical scales cushman roisin and beckers 2011 such disparity in the length scales e g horizontal scales of kilometers and vertical scales of meters significantly affects simulations of 3d oceanic domains where even small deviations in some direction may cause large changes in the other directions in many ocean prediction models the vertical velocity is obtained as a diagnostic variable for example in hydrostatic models one computes the vertical flow velocity by enforcing the divergence free condition and accounting for the free surface motion haley jr and lermusiaux 2010 these vertical velocities e g o 10 3 cm s to 10 1 cm s are typically much smaller in magnitude than horizontal ones e g o 1cm s to 1m s this implies that the vertical advective fluxes may be severely altered even by small relative errors in the fluxes in other directions thus impacting the accuracy of the zero level set evolution in three dimensions to ensure that such a discrepancy in scales does not affect the fidelity of the computation we non dimensionalize the hamilton jacobi level set equation 4 to non dimensionalize a reference scale needs to be set up for each of the variables for each of the spatial dimensions and each of the corresponding velocity components one commonly utilizes a characteristic length e g domain length and velocity magnitude the other variables that remain are the level set function ϕ and the time t the non dimensionalizing scales that we propose are summarized in table 1 the characteristic scales for the velocities are averages over the entire spatial and temporal domain of interest and are computed only once per simulation another suitable scale for velocities could also be the maximum velocity in that direction over the entire temporal domain of interest although an acceptable choice the maximum velocity can be much larger than the typical expected velocity magnitudes and the non dimensionalization would then not be very effective in such cases if the velocities in different regions vary greatly then the domain can be divided into appropriate sub domains and a separate non dimensional scale for the velocities can also be chosen in each of the domains the characteristic time scale used is an estimate for the travel time assuming that the vehicle either travels only at its own speed or is only advected with the flow whichever is the faster choice specifically we look at the maximum of the travel times along each of the basis directions that is along the x y and y directions when the vehicle optimally chooses to either travel with the flow or travel on its own but not both it must be stated that these choices are far from unique and appropriate characteristic scales should be chosen based on the specifics of the problem no scale for ϕ is required as the partial differential equation pde is linear in ϕ and independent of the scaling of ϕ the numerically well conditioned non dimensional form of eq 4 is given by eq 17 where the superscript refers to the non dimensional quantity corresponding to 17 1 t c ϕ t max h ˆ x h ˆ y h ˆ z f h ˆ x t l x ϕ x h ˆ y t l y ϕ y h ˆ z t l z ϕ z v x c l x v x ϕ x v y c l y v y ϕ y v z c l z v z ϕ z for the case of isotropic propulsion this eq 17 reduces to 18 1 t c ϕ t f 1 l x 2 ϕ x 2 1 l y 2 ϕ y 2 1 l z 2 ϕ z 2 v x c l x v x ϕ x v y c l y v y ϕ y v z c l z v z ϕ z the advective fluxes in each direction scale with the ratio v l in the corresponding direction as is well known from mass conservation even though both v z and l z are much smaller than either of v x and l x or v y and l y the ratio v z l z can easily be comparable to v x l x and v y l y this means that even though the length and the velocity in the z direction are small the advection contribution in this direction may not be negligible the contributions due to each of the directional terms in the optimal propulsion term scale as 1 l x 1 l y and 1 l z in eq 17 this again implies that even though length of the domain in the z direction is much smaller the contribution to the optimal propulsion term in this direction can be substantial even if the vertical propulsion speed is smaller than the horizontal one anisotropic propulsion hence ignoring or not completely resolving the motion in the vertical direction may cause large errors as its contributions to both the optimal propulsion and advection are comparable to the other horizontal terms 4 2 numerical consistency between the forward evolution and backward tracking a consideration in the computation of the optimal path is the numerical consistency between the discrete forward evolution and backward tracing the forward reachability evolution is governed by the pde 4 it represents the motion of all hypothetical optimal points that could reach the destination through a functional representation of the reachability front in space this pde is often solved using explicit numerical time integration backward tracing of the optimal involves an ode 7 that governs the spatial motion of an optimal point over time for consistent minimal numerical errors during discrete backtracking we should match the discrete forward reachability front i e exactly reverse the steps of the discrete forward time integration we then ensure that the optimal point numerically gets back to the start point specifically we should maintain three numerical consistencies forward backward explicit implicit time consistency type of time integration consistency and spatial discretization consistency for example if the forward temporal evolution is explicit then the backward temporal evolution should be implicit and vice versa the exact type of the forward evolution scheme also needs to be mimicked by the backtracking scheme for example if the forward evolution uses the forward euler time marching then the backward tracing should use the backward euler scheme finally numerical consistency in space should also be maintained between the pde and ode e g for the normals to the level set if these consistencies are not maintained the discrete local forward front and backward path integration do not exactly reverse numerically with compounding of errors during the backtracking we can then not guarantee getting back to the start point fig 3 schematically represents the discrepancy arising during one time step if numerical consistencies are not maintained as it is much easier to solve a pde through explicit time marching we use implicit time marching for the backward tracing of optimal path and hence an iterative solver is necessary for the ode 4 3 numerical schemes forward evolution the main interest is the accuracy of motion of the zero level of the level set function ϕ small deviations from the truth may not change the arrival times much but could severely alter the computation of the optimal path further due to the entropy condition ϕ x t may be non differentiable at the zero level set sethian 1994 as is well known finite difference and finite volume numerical schemes are diffusive of shocks and discontinuities and these errors are amplified with time mainly due to compounding of errors for marine vehicles whose speed strongly depends on the heading or which can only travel in a few permissible directions slight errors in the level set function computation can easily cause the computed heading direction to be vastly different from the optimal one hence we employ high order spatial and temporal schemes for the forward evolution of the level set function equation 17 in our present case for a simpler implementation of higher order schemes the pde is solved on a 3d structured grid using the finite volume fv method the optimal propulsion and advection terms are computed independently of each other the boundary conditions do not have a direct impact on the growth of the reachability front as it does not depend on the values of the level set function ϕ away from itself to this end we use radiation boundary conditions on ϕ at all the boundaries we employ essentially non oscillatory eno and weighted essentially non oscillatory weno schemes with up to 5th order accuracy shu and osher 1988 jiang and shu 1996 the optimal propulsion term needs to be treated differently depending upon whether the vehicle exhibits isotropic motion or not if the vehicle has isotropic speed then the optimal propulsion term from eq 6 is solved using the godunov scheme osher and fedkiw 2006 when the vehicle speed depends on its direction of travel a maximization needs to be carried out appendix b presents the details of the numerical schemes as well as the maximization methods required for the optimal propulsion term in conjunction with these spatial schemes we utilize total variation diminishing runge kutta tvd rk schemes of up to 3rd order accuracy for time marching osher and fedkiw 2006 the combination of eno weno schemes with tvd rk time marching ensures that the solution is total variation bounded tvb osher and fedkiw 2006 4 4 numerical schemes backward tracing the optimal path is obtained by solving eq 7 backward in time with x t x f x s 0 x f as all the time marching schemes that we utilize for eq 17 are explicit i e explicit time integration is used the consistent schemes for the optimal path computation must be implicit which implies that iterative solvers are required see section 4 2 further the specifics of the scheme used for the characteristic computation must mimic the temporal scheme from the forward evolution computation fig 4 illustrates the underlying ideas behind the implicit backward tracing for a fixed point iteration improved values are iteratively obtained by computing the predicted future position of the vehicle using the currently available heading and advective velocity values and then using the values of these parameters from this position to determine the optimal heading at any time the normal direction to the local reachability front needs to be computed this normal direction is then either directly used as the optimal heading direction or is passed as an argument to the maximization described in appendix b to obtain the optimal heading direction the novel algorithm used for the computation of the normals in 3d is detailed in appendix c appendix c also describes the implicit backward tracing schemes for time marching with forward euler tvd rk 1 heun s method tvd rk 2 and tvd rk 3 4 5 numerical schemes vehicles with partially known motion we now discuss numerical schemes for computing the optimal trajectory of vehicles with partially known motion specifically due to the operator splitting approach used to solve eqs 15 and 16 forward evolution as operator splitting is utilized to solve eqs 15 splitting errors are made the order of the splitting error depends on the specifics of the splitting method utilized two popular operator splitting techniques are lie splitting macnamara and strang 2016 and strang splitting strang 1968 which are at least 1st and 2nd order accurate respectively lie splitting simply involves explicitly solving eq 15a followed by eq 15b over one numerical time step each and then adding the respective contributions strang splitting on the other hand involves solving eq 15a over half a numerical time step and updating the field ϕ x t with the outcome then eq 15b is solved over one numerical time step using the updated field ϕ x t and the results are updated finally this new field is used to solve eq 15a another half numerical time step to arrive at the final evolution under certain constraints on the external velocity and known component of the vehicle motion these splitting methods can achieve higher orders of accuracy for example lie splitting is 2nd order accurate whereas strang splitting is exact for a vehicle following known motion along a fixed direction in a steady flow field more numerical details including sufficient conditions for these splittings to yield tighter accuracy bounds can be found in lanser and verwer 1999 and kulkarni and lermusiaux 2019 in general as long as the splitting error is of the same or higher order of accuracy as the numerical schemes employed for time marching for resolved numerics the accuracy of the complete numerical scheme is not affected by the splitting error backward tracing the implicit explicit nature of the forward schemes along with the order of the operator splitting must be mimicked in backward tracing the in plane in n ˆ t motion can be computed by the backtracking algorithm in a consistent way to the forward time marching used for the level set field the trajectory point obtained i e x t is actually the projection of the exact point onto the n ˆ t plane the actual position is then computed by adding the displacement along n ˆ t due to the vehicle velocity and the local flow velocity this contribution can be either explicit or implicit as shown by eqs 19 and 20 19 x t x t δ t δ t f h ˆ x t δ t t δ t h ˆ t δ t v x t δ t t δ t where h ˆ t δ t arg max h ˆ x t δ t t δ t f h ˆ x t δ t t δ t h ˆ x t δ t t δ t ϕ x t δ t t δ t 20 x t k 1 x t δ t δ t f h ˆ x t k t h ˆ t v x t k t where h ˆ t arg max h ˆ x t k t f h ˆ x t k t h ˆ x t k t ϕ x t k t with x t 0 x t δ t where x t is the auxiliary position at time t when only the horizontal motion is accounted for the effective velocity along n ˆ t can be computed either explicitly eq 21 or implicitly eq 22 21 x t x t δ t v z x t t f n x t t n ˆ x t t 22 x t k 1 x t δ t v z x t k t f n x t k t n ˆ x t k t with x t 0 x t 4 6 computational cost we now look at the asymptotic computational complexity for the level set based time optimal path planning in 3d environments in all the considered examples we numerically solve the forward evolution of the reachability front either eqs 6 or 4 using the finite volume method the asymptotic computational complexity is a function of the grid size in this analysis we assume that there are approximately n grid points in each direction and thus the total number of grid points in the domain denoted by n is about n o n 3 cost of solving the forward evolution of the reachable set in 3d to solve the forward evolution of the reachability front the level set equation is solved in the entire domain the computational cost per time step for this is o n 3 adalsteinsson and sethian 1995 the number of numerical time steps k that the solver runs for is directly related to the optimal travel time of the vehicle k t x x 0 0 δ t as the optimal travel time of the vehicle is not known a priori it is not possible to estimate the total number of time steps k to begin with further as we use explicit time marching to solve the level set pde the numerical time step δ t is inversely related to the number of grid points n which makes k directly proportional to n instead of solving the pde over the entire domain one can use the narrow band level set method adalsteinsson and sethian 1995 and solve the pde only around the zero level set reducing the computational cost from o n 3 to o d n 2 o n 2 where d n is the bandwidth cost of performing the maximization of the optimal propulsion term if solving eq 4 with an analytical maximization is not possible one can construct a look up table prior to the forward evolution that contains the optimal heading direction for every direction of the outward normal see appendix b this look up table needs to only be constructed once and its cost is directly proportional to the resolution used to discretize the optimal heading and outward normal directions specifically if the optimal heading space is discretized in o n h 2 points both the polar and the azimuthal directions contain o n h points and similarly the outward normal space is discretized in n n 2 points then the construction cost of the maximization look up table is o n h 2 n n 2 cost of solving the forward evolution of the reachable set for vehicles with partially known motion for vehicles with partially known motion the level set pde only needs to be solved in 2 dimensions and hence the computational cost per time step now becomes o n 2 adalsteinsson and sethian 1995 further if analytical maximization is not possible then the cost of constructing the look up table is o n h n n as the maximization is only performed in 2d and not in 3d finally the equation describing the vertical component of the reachable set growth is simply solved in 1d and hence its cost is o n thus the net cost of computing the forward evolution of the reachable set for vehicles with partially known motion is o n 2 n instead of o n 3 similarly to the 3d case if the level set pde is solved using the narrow band level set method the computational cost reduces to o n d n o n cost of backward tracing of the optimal path the backward tracing of the optimal path is simply done by solving an ode and hence the cost of this operation per time step is simply o 1 given the optimal heading direction is available in order to obtain this optimal heading direction one may need to construct the local outward normal to the reachability front and refer to the look up table however these costs are assumed constant and are much smaller than the forward evolution pde solve costs computational infrastructure used all the analytical and realistic simulations presented in sections 5 and 6 respectively were performed in matlab on a single quad core intel i7 4790 cpu clocked at 3 60 ghz matlab s internal vectorization parallelization for matrix vector operations was enabled for all computations the computational times required for the forward evolution of the reachable set and backward tracing of the optimal path for these applications are mentioned in their respective analyses 5 applications in benchmark three dimensional analytically known flow fields to verify schemes and benchmark accuracy we now apply the exact time optimal path planning in three 3d analytical flow fields first we study optimal path planning in a uniform advective flow analytical solution for the travel time are obtained which allows quantifying errors in our algorithm second a pulsating 3d vortical flow is used to benchmark the accuracy of our path planning in 3d dynamic flows with semi analytical optimal trajectories and duration third path planning in an analytical 3d double gyre shear flow is studied we effectively depict the ability to account for velocity fields that are spatially and temporally variable and also the ability to handle path planning for swarms of vehicles starting from the same location where only a single forward pde computation is required this reduces the computational cost as compared to heuristic schemes with independent computations for each of the vehicles 5 1 validation in uniform velocity field a theoretical value of the optimal travel time between a given pair of start and end points can be obtained for vehicles moving with isotropic speed in a uniform advective flow field let this advective flow be denoted as v x t v 0 u 0 v 0 w 0 for all x and t to derive the optimal travel time we consider the inertial reference frame moving with velocity v f r a m e v 0 the advective velocity field is absent in this frame however the effective target position will now be x f x f t v 0 if t is the sought optimal travel time in the absence of any advective velocity field the optimal path between x s and x f is a straight line joining these points and the required travel time is given by x f x s f which must be equal to t we thus have 23 t x f x s f x f x s t v 0 f defining x f x s δ δ x δ y δ z eq 23 leads to a quadratic equation for t with at most one non negative root 24 t δ v 0 δ v 0 2 f 2 v 0 2 δ 2 f 2 v 0 2 for f v 0 eq 24 fails to hold however eq 23 then reduces to a linear equation with 25 t δ 2 2 δ v 0 for f v 0 t is always real this implies that in such cases all points in the domain can be reached in a finite time this is a direct consequence of the fact that eq 6 can be reduced to a modified eikonal equation when f v 0 lolla and lermusiaux 2020 for the purposes of the simulation we consider a unit domain the start and the target positions are x s 0 25 0 30 0 40 and x f 0 70 0 65 0 80 with the vehicle traveling at a non dimensional speed of 0 1 units the external velocity field is given by v 0 0 050 0 075 0 065 hence v 0 0 11 f and the pde is not eikonal the theoretical optimal time computed using eq 24 for this setup is 3 377 our discretization for this benchmarking example consists of a 100 100 100 grid and a time step of 5 1 0 3 we use the finite volume method with the 5th order weno scheme for spatial gradients and tvd rk3 scheme for time marching see appendix b the computed optimal time is 3 375 which is only off from the true value by 0 059 this amount is extremely small and due to small truncation errors resolution in time and space and common computational inaccuracies round off errors etc the computational times required for the forward evolution and the backward tracing of the optimal path were 24 s and 1 03 s respectively for uniform advective velocities the zero level set grows as a sphere with radius r f t and is also advected along the velocity direction that is the center of this sphere lies at x c t v 0 this is clearly seen from fig 5 where the zero level set evolves as a sphere and moves along the direction of the velocity it can be shown that the optimal path is a straight line joining x s and x f as is observed 5 2 validation in spherical vortical flow we now consider a pulsating vortical flow to benchmark the accuracy of the optimal trajectory and travel time of our path planning the flow field is a sinusoidally pulsating version of the velocity field generated from the stream function for the rossby haurwitz benchmark problem for the shallow water wave equations williamson et al 1992 as reported in townsend et al 2016 it is defined in spherical coordinates by eq 26 where r is the radial coordinate with unit vector r ˆ λ π π is the azimuthal angle with unit vector λ ˆ θ 0 π is the polar angle with unit vector θ ˆ and s is the gradient in spherical coordinates 26 v r λ θ t r ˆ s ψ r λ θ t where ψ r λ θ t cos 2 π t t cos θ sin 4 θ cos θ cos 4 λ fig 6 shows this flow field plotted at t 0 on a sphere of r 1 the velocity field is v r λ θ t v λ r λ θ t λ ˆ v θ r λ θ t θ ˆ the flow field has no component in the radial direction and all the radial motions of the vehicle are thus due to its own propulsion we utilize this fact to design a suitable test case to benchmark our 3d method specifically we choose the destination of the vehicle for a given start location and travel time such that the analytical vehicle propulsion is always radially outwards let us assume that the vehicle starts at location x s r s λ s θ s and requires a to be determined travel time of t fixed to reach a given destination x f r f λ f θ f we assume that the vehicle can move isotropically and with a maximum speed f the to be optimized velocity of the vehicle relative to the flow field is f t h ˆ t f r t r ˆ f λ t λ ˆ f θ t θ ˆ with f r t 2 f λ t 2 f θ t 2 f 2 the trajectory ode of such a vehicle is thus 27 d x t d t f r t r ˆ f λ t v λ r λ θ t λ ˆ f θ t v θ r λ θ t θ ˆ separating the components of eq 27 we have r f r t r sin θ λ f λ t v λ r λ θ t and r θ f θ t v θ r λ θ t upon integrating the radial component we obtain 28 r s r f d r 0 t f r t d t 0 t f d t r f r s f r t t r s f t from eq 28 we can set r f r s f t λ f θ f still to be selected which implies that the optimal vehicle will have to move radially outwards with speed f at all times as any other choice will yield a larger travel time as f r t f this implies f λ t f θ t 0 the other two components of the trajectory eq 27 the coordinates λ f and θ f are thus defined by 29 λ v λ r λ θ t r sin θ v λ r s f t λ θ t r s f t sin θ θ v θ r λ θ t r v θ r s f t λ θ t r s f t as designed the optimal travel time between the chosen start point x s and the destination x f is t the vehicle always travels radially outwards with the maximum allowable speed f the optimal trajectory x t r t λ t θ t t 0 t can thus be semi analytically computed using eq 29 in 30 this completes our benchmark problem definition to be specific we choose the start location to be x s 0 1 0 π 4 the travel time t 0 9 and the vehicle speed f 1 this implies that the exact destination x f has the radial coordinate r f 1 0 integrating eq 30 its azimuthal and polar coordinates are found to be λ f 0 9754 π and θ f 0 2277 π to evaluate our numerical integration of the forward level set pde 6 and backward ode 7 we now compare the computed optimal travel time with its theoretical value t and the computed optimal trajectory with its exact optimal trajectory obtained by the semi analytical integration of eq 30 the 3d path planning problem to be solved using the level set methodology is thus to predict the optimal trajectory for a vehicle with maximum speed f 1 that is traveling from x s 0 1 0 π 4 to x f 1 0 0 9754 π 0 2277 π under the external dynamic velocity field v r λ θ t given by eq 26 we solve this problem on a domain ω 2 2 2 2 2 2 using the finite volume method with 200 grid points in each direction and a numerical time step of δ t 0 001 a 5th order weno scheme is used for spatial gradients and a tvd rk3 scheme for time marching see appendix b as the external velocity field has no radial component the reachability front grows as a sphere with its rate of radius increase being f 1 not shown the computational time required is found to be 341 09 s for this forward evolution of the reachability front and 1 34 s for backtracking the time optimal path the optimal time required for traveling from x s to x f is predicted to be t 0 902 which is extremely close to the exact value of t 0 9 with a relative error of 0 22 fig 7 compares the semi analytical trajectory integrating eq 30 using the forward euler method and a time step of δ t 0 001 to the level set computed backtracked trajectory in 3d and their components along the x y and z axes we find that the computed trajectory is also extremely close to the semi analytical trajectory at all times in all the coordinates 5 3 application in three dimensional analytical double gyre shear flow we now verify schemes with the analytical double gyre flow that is a periodic unsteady and divergence free velocity field shadden et al 2005 froyland and padberg 2009 note that this model is not a real fluid flow in that it is not obtained as a solution to the navier stokes pdes but is a simplification of the double gyre pattern that frequently occurs in geophysical flows coulliette and wiggins 2001 lolla et al 2014b subramani and lermusiaux 2016 we consider this flow in the domain 0 2 0 1 0 1 the classic double gyre is a two dimensional flow in space whose non dimensional velocity field is analytically described by 31 v x π a sin π f x cos π y v y π a cos π f x sin π y d f d x where 32 f x a t x 2 b t x 33 a t ϵ sin ω t 34 b t 1 2 ϵ sin ω t to create a 3d flow field from eq 31 we add an unsteady parabolic velocity profile for the z direction that bears positive values in the region of the first gyre and negative values within the other gyre specifically the z velocity is given by 35 v z x y 2 x 1 y 1 ϵ sin ω t x the velocity field is depicted in fig 8 the parameters used are a 0 1 ϵ 0 1 ω π 5 the vehicle speed is set to 0 05 and a 200 100 100 grid with a time step of 5 1 0 3 is used in a finite volume setup with the 5th order weno scheme for spatial gradients and tvd rk3 scheme for time marching see appendix b this example demonstrates a one to all broadcast where multiple vehicles leave from the same start point in order to travel to different target locations with our pde approach such a broadcast only requires one level set evolution per start point and hence it is computationally advantageous the zero level set is evolved from the start point until all the destination positions lie on or inside it the time at which the reachability front crosses a particular destination position is noted and the optimal path is backtracked from this stored time until the start time hence increasing the number of target positions only increases the cost of the backtracking ode computation which is much less than that of the forward evolution pde specifically the forward evolution of the reachability front required 82 33 s whereas the backward tracing of the three optimal paths required 0 87 s green 1 41 s orange and 1 56 s red respectively fig 9 shows the predicted optimal paths to be followed by the vehicles to reach the respective destinations in shortest time it is clear that the vehicles utilize the background flow field to their advantage even though they travel much longer distances as compared to straight line paths they do so at a higher effective speed thus reaching in shortest time 6 applications in three dimensional realistic oceanic flow fields this section integrates realistic ocean modeling and time optimal path prediction for common types of marine vehicles operations are planned for the complex four dimensional time space ocean flow fields of the middle atlantic bight region three types of marine vehicles are considered i vehicles with isotropic propulsion ii vehicles with anisotropic speeds specifically oceanic floats that can propel vertically by adjusting buoyancy but are advected in the horizontal rudnick et al 2004 and iii typical marine gliders that perform a vertical sinusoidal yo yo motion which reduces the path planning problem to a two dimensional one as shown in section 3 we first describe the 3d regional dynamics our data assimilative multi resolution ocean modeling and our computational time optimal path planning setup we then describe the evolution of the reachability front for these vehicles highlighting how the underlying dynamic flow features affect this evolution finally we analyze the actual time optimal paths and show how each type of optimal vehicle intelligently utilizes the currents most beneficial and avoids the most adverse in accord with its type 6 1 ocean modeling and oceanography the middle atlantic bight region off the coast of new jersey offers a variety of flow features interacting on multiple scales linder and gawarkiewicz 1998 lozier and gawarkiewicz 2001 lentz 2008 wilkin et al 2018 kelly and lermusiaux 2016 they include the gulf stream shelf break front coastal jets tidal currents internal tides and also hudson river outflow such conditions provide challenging environments for autonomous missions fig 10 shows the simulation domain overlaid on bathymetry from 37 56 n to 40 99 n and 73 97 w to 70 54 w the white circle and the star denote the start 37 90 n 72 22 w and target positions 39 85 n 72 30 w for our planning missions respectively both positions at the surface the multi scale ocean dynamics in this region is simulated using the mit multidisciplinary simulation estimation and assimilation system mseas haley jr and lermusiaux 2010 haley jr et al 2015 mseas is used for fundamental research as well as realistic applications such as monitoring lermusiaux et al 2007 real time ecosystem and acoustic predictions beşiktepe et al 2003 xu et al 2008 lermusiaux et al 2011 and environmental management cossarini et al 2009 the specific currents used for path planning are from a data assimilative mseas re analysis for august 28 2006 up to september 9 2006 haley jr et al 2015 subramani et al 2017a the data were collected as a part of the shallow water 06 sw06 initiative whoi 2006 lermusiaux et al 2006a newhall et al 2007 tang et al 2007 chapman and lynch 2010 lin et al 2010 mseas solves the nonlinear free surface hydrostatic primitive equation pe configured with generalized level vertical coordinates and implicit two way nested computational domains haley jr and lermusiaux 2010 in the horizontal the domains have a 3km and 1km grid resolution respectively and in the vertical they each employ 100 levels optimized to the thermocline and flow structures the tidal to mesoscale ocean re analysis is initialized with objectively analyzed temperature salinity and velocity fields for aug14 2006 two multiscale in space analyses lermusiaux 1999 2002 inshore and offshore of the expected shelfbreak front are combined using a shelfbreak front feature model lermusiaux 1999 gangopadhyay et al 2003 the gulf stream is initialized using synoptic and historical ctd profiles as well as estimates of its position based on sst and navoceano feature analyses high resolution barotropic tides logutov and lermusiaux 2008 based on the tpxo7 2 surface tide velocities and elevation egbert and erofeeva 2002 for aug14 2006 are merged with the subtidal initial fields following haley jr et al 2015 the re analysis free surface pe simulation is then integrated for 42 days during integration the ocean data collected during the awacs and sw06 exercises tang et al 2007 as well as data of opportunity nmfs etc are assimilated finally the numerical and sub grid scale parameters are tuned for the region by comparison of many pe simulations with independent in situ sw06 measurements 6 1 1 ocean flows and regional dynamics in the present period we observe that the optimal paths for the auv with isotropic speed and the float go down to a maximum depth of 22m the float travels deeper but for an extremely short duration and hence we focus on the top 20m of the ocean flows over the considered time of interest figs 11 12 and 13 plot the daily averaged horizontal currents at 0m 10m and 20m depth respectively also shown are the daily position of the isotropic auv pink circle denotes the current position i e position on the considered day at 00 utc whereas the gray circle s denote the horizontal position s of the vehicle on the past day s note that this is simply the horizontal location of the vehicle i e discarding depth the vehicle may not be at the particular depth at the considered instant we also plot the daily averaged horizontal currents depth averaged over the first 90m in fig 14 this is effectively the flow field experienced by the glider performing sinusoidal yo yo motion the daily position of the glider and its history are denoted in pink and gray similar to the previous figures the gulf stream is clearly seen in the southeast corner of the domain at all depths as well as the depth averaged fields with velocities reaching 2 m s the meandering shelfbreak front jet flowing to the west southwest and close to the 100m isobath is also visible lermusiaux 1999 linder and gawarkiewicz 1998 especially in fig 14 on august 28 figs 11 a 12 a 13 a 14 a there is a northeast to southwest jet just north of the gulf stream with speeds up to 25 cm s this flow is almost non existent at the surface but gets stronger with depth there is also a local northward flow between the gulf stream and the said jet locally at the mission start point on the shelf the surface flow reverses due to southwestward winds on august 29 developing first along the coast of long island and intensifying to a midshelf westward southwestward flow by august 30 as especially seen in the depth averaged velocities fig 14 b c and at the surface fig 11 b c we also find that the said northeast southwest jet strengthens at the surface and a bit deeper during this period and a cyclonic eddy feature develops north of the gulf stream near 38 9 n 71 9 w at depths of 10m onwards figs 12 b c 13 b c with its northern side linked to the south southwest shelfbreak front jet our vehicles take advantage of this eddy as will be shown in section 6 4 tropical storm ernesto passes over the domain during september 1 3 the operational region mostly sees the northeastern edge of the storm as it proceeds northward the ocean response is a northwestward flow at the surface 2 3 times stronger than on august 30 and shelf wide with intensification near the coast fig 11 e g due to 3d downwelling the flow changes direction with depth it is reversed to the south southwest at 20m figs 13 e g 14 e g after the storm the main flow on the shelf south of new jersey is generally southwestward parallel to the coast and shelfbreak it reaches a barotropic magnitude of 5 10cm s with currents decaying with depth this midshelf flow is a remnant of the shelf response to ernesto partly supported by a local cross shelf density gradient not shown that ernesto established on september 6 the shelfbreak front jet reaches a barotropic strength of 10 20cm s fig 11 j in part due to the minor wind event between 00 to 17 utc on that day finally weak density driven eddies and currents occur on the shelf during the whole period and affect the optimal paths 6 2 computational setup and simulation details our first example models auvs that can more or less propel in any direction at their operating speed we assume here that the vehicle has a maximum propulsion speed of 50cm s and a maximum allowable depth of 100 m which is well within the typical range of such vehicles rudnick et al 2004 haley jr et al 2009 ramp et al 2009 the second example looks at path planning for vehicles with heading dependent propulsion speeds and constrained motion section 3 1 particularly we consider a vehicle that can propel only in the vertical its motion in the horizontal plane is then only through flow advection most oceanic floats are able to maneuver this way wherein their vertical propulsion is a result of changing their effective buoyancy gould et al 2004 we assume that the float can travel at 10cm s vertically but with no propulsion in the horizontal directions and is allowed to travel at a maximum depth of 100 m we finally showcase an underwater glider that performs a sinusoidal yo yo motion as typical for ocean data collection fan and woolsey 2014 ramp et al 2009 haley jr et al 2009 leonard et al 2010 in our example we assume typical operational parameters to be similar to a seaglider rudnick et al 2004 the glider is assumed to slowly dive up to 90 meters in depth with subsequent up and down motions with a period of 4 h the average vertical speed is 1 25cm s in the horizontal plane the speed is assumed to be 50cm s stokey et al 2005 our 3d path planning numerically solves the exact non dimensional form of the forward hamilton jacobi level set eq 18 we employ the finite volume method on a grid of 128 128 50 elements in the longitudinal latitudinal and vertical directions respectively where each grid cell has an approximate size of 2 32km 2 98km 2m a time step of 6 min 360s is used we use the 5th order weno scheme for the spatial terms and the tvd rk3 for time marching in the case of partially known vehicle motion the 3d path planning problem reduces to a 2d one section 3 2 hence simulations are carried out on a 2d grid of resolution 128 128 elements with the rest of the computational setup being as above all the vehicles start their journey on august 28 at 00 utc from the same start location as stated above ref fig 10 the reachability front defined as the zero level set of ϕ is constructed by linear interpolation between grid points once the forward evolution of the reachability front is complete backward tracing of the optimal trajectory is computed using the fully implicit backward tracing schemes obtained in section 4 and further detailed in appendix c to compute this backtracked optimal path we need to compute the normal direction to the reachability front at certain locations appendix c describes the algorithm used to compute such normal directions at arbitrary locations on the reachability front table 2 summarizes the considered operating characteristics the optimal travel time results and the relevant figure numbers that contain the reachability front evolutions and optimal paths 6 3 evolution of the reachable sets isotropic auv fig 15 plots the growth of the zero level set the reachability front for the auv with isotropic propulsion we observe that the zero level set quickly reaches the deepest limit of the simulation domain and then evolves as a deforming and sloping curtain with clearly visible creases these variations of the curtain along the vertical happen due to the following reasons first the flow in this region is mainly dominated by surface tides wind driven flows and thermocline intensified currents and eddies this means that the variability of the horizontal velocities along the vertical direction is much smaller than the velocities themselves most horizontal motions have small and local reversals in the first 100m depth there are only a few regions and times where a flow reversal with depth is observed these phenomena prompt the zero level set to grow as curtains second the small variations and shifts of the zero level set with depth are further hidden by the skewed plot scales the x and y scales are in hundreds of kilometers whereas the z scale is in tens of meters in the deeper areas of the domain the evolving zero level set is abruptly halted and it forms a jagged surface parallel to the bottom this is because in these regions the zero level set is close to the sea floor we prohibit the zero level set from penetrating the sea floor as the vehicle cannot move inside land this is done by setting the advective velocity field v as well as the vehicle speed f v to zero at these depths which ensures that the optimal path never crosses through any land mass we observe that the initial reachable set for the auv is quickly advected northwards due to the local northward flow at the start point and hence fails to see the strong gulf stream currents over august 29 and 30 the reachability front grows due to the favorable flow on the east side of the cyclonic eddy that develops to the north of the gulf stream especially beyond 40m but is held back on the west side of this eddy this causes a crease like feature in the reachability front as seen in fig 15 c we can also see that the northeast southwest oriented jet north of the gulf stream pushes the reachability front out of the domain in the southwest corner finally the reachability front reaches the destination on august 31 2006 at 20 17 22 utc and the corresponding optimal travel time for this vehicle is 3 84 days vertical only propulsion float fig 16 shows the evolution of the zero level set for the float capable of slow vertical propulsion only the growth of the zero level set still locally stops at the sea floor or just before ensuring that the optimal path does not go through any land mass the evolution of the level set is comparatively slower and it takes longer for the float to reach the destination as the horizontal evolution of the reachability front is only due to oceanic flows it evolves faster in the region of faster ocean currents we find that the reachable set of the float is initially pushed to the northwest due to the local currents just north of the gulf stream the reachability front does not reach the entire depth at all locations as the float is slower than the isotropic auv ocean vertical velocities may thus prohibit the float from reaching all depths of the domain we initially observe low variation in the reachability front in the vertical but between days 5 and 7 5 fig 16 b c the reachability front grows much faster at the surface due to the favorable currents generated by tropical storm ernesto ernesto s impact is limited deeper the wind driven response thus generates major vertical variation in the reachability front growth much larger than that for the isotropically propelled auv by the time the float reaches the destination fig 16 d glider finally for a glider performing a sinusoidal motion in the vertical the projected reachable set evolution is solved as a 2d problem and the projected reachability front evolved as a 2d parametric contour if some of the points on this contour are within a tolerance of the ocean floor or surface at some particular time the propulsion of the glider is then reversed only at these points the vehicle can continue to move in the same direction at all other points until it either reaches the tolerance to the bottom or the maximum allowable depth or surface the location and time data of points at which such reversal of direction occurs are kept in memory and enforced while backtracking the optimal path while planning paths for such vehicles with known vertical motion it might happen that the vehicle reaches the horizontal coordinates of the target but at a different depth in such cases one can assume that the vehicle can rise sink locally to reach the exact target depth this is what is done in the present example but one could of course continue the level set computation until both the horizontal coordinates and proper depth are reached 6 4 three dimensional time optimal paths we now examine the time optimal paths for the three different types of vehicles considered their characteristic features and how they related to the ocean flows experienced by these vehicles 6 4 1 vehicles with isotropic speeds fig 17 depicts the optimal path followed by the isotropically propelled auv which requires a total travel time of 3 84 days to compare in the absence of currents the vehicle would travel in a straight line joining the start and target positions and would require 4 97 days hence it is clear that the optimal auv can here make efficient use of the oceanic velocities to reach the target in the shortest amount of time initially the optimal auv is advected north by the local northward currents at the start point it then dives deeper as the northeast to southwest jet to the north of the gulf stream is strong near the surface on august 29 surface currents are small on august 28 but increase significantly by august 29 and hence the auv starts to dive it is clear in fig 17 b how the auv navigates around the southwestward currents north of the gulf stream by august 30 and 31 the auv sails northward using the favorable flow on the eastern side of the cyclonic eddy figs 12 c 13 c that develops to the north of the gulf stream beyond 10m depth around august 31 the auv starts rising as the wind driven currents around 10m depth are northwestward and favorable fig 12 d while those at the surface and 20m are westward or southwestward and not favorable figs 11 d 13 d finally the impact of the tropical storm ernesto causes favorable surface currents from september 1 onwards and hence the auv rises to utilize these flows and ultimately reach the destination another interesting observation relates to the spacing between daily vehicle positions figs 11 a d 12 a d 13 a d it shows that the auv travels more on the second day than on the first and even more on the third and fourth days this is because on the first day and a part of the second day the auv is traveling against southwestward currents however once out of this adverse currents region it utilizes the favorable currents eastern edge of the cyclonic eddy and those driven by ernesto on days 3 and 4 and thus travels larger distances the computational time required for the forward evolution of the reachability front for the isotropic auv is 109 2 min for the numerical schemes of section 4 whereas the time required for backward tracing of the optimal path is 38 s as expected the computational time required for backward tracing is much less than that required for the forward evolution as one only solves an ode in backtracking the optimal path whereas a pde is solved on the entire 3d domain for the forward evolution importantly since the optimal travel time is 3 84days such exact pde path planning can be completed in real time 6 4 2 vehicles with anisotropic speeds for vehicles with constrained motion we resort to an offline maximization table to compute the optimal propulsion term as described in appendix b fig 18 shows the optimal path to be followed by the float propulsion only in the vertical direction the float is much slower than the isotropic propelled auv with a total travel time of 9 53 days this is expected as the float does not have any horizontal propulsion of its own further we can tune a tolerance parameter of the vehicle ref appendix b such that unless a major event happens the float tends to stay at the same depth the float initially dives to avoid adverse southwestward currents at shallow depths north of the gulf stream see fig 11 and utilizes west northwestward currents around the start point at 20m depth on august 29 and 30 it advects east northeastward with a favorable current that is present at 20m depth just to the north of the gulf stream see fig 13 b c however this current changes direction around sept 1 due to tropical storm ernesto and the float thus dives deeper down to about 45m to avoid the effect of this adverse change on september 2 and 3 tropical storm ernesto induces favorable velocities at the surface thus the float quickly rises to the surface to capture these currents deeper velocities on these days are unfavorable note that such frequent dives can be eliminated to respect the limits on the functional characteristics of the specific float by setting the appropriate value of a tolerance parameter of the float ref appendix b finally post ernesto the current magnitudes and variations are typically small and hence the float does not perform any vertical motion and is simply advected to reach the target the computational time required for the forward evolution of the reachable set and backtracking the optimal path for the float is 188 6 min and 32 s respectively the forward evolution takes longer than that of the isotropic auv because even though the cost per time step is comparable the float simply takes longer to reach the destination 9 53 days leading to higher a computational expense 6 4 3 vehicles with partially known motion for vehicles with partially known motion we solve for the 2d projection of the forward 3d reachable front to backtrack the full 3d optimal path we thus add back the deterministic displacement due to the vertical motion of the vehicle to the optimal projected path being backtracked in 2d fig 19 shows that 3d optimal path as predicted for a glider performing a sinusoidal yo yo motion the time for this journey is 4 15 days almost 25 dives which is slower than for the auv with isotropic speed but much faster than for the float this is expected as we impose no constraints on the motion of the auv in the first case whereas stricter constraints are enforced on the float motion note that for the last dive the glider is also close to the sea floor and hence it terminates the dive earlier in order to not collide with the bottom the optimal path qualitatively follows a pattern similar to isotropically propelled auv but with larger deviations from horizontally straight lines from fig 19 b we find that the glider initially utilizes the northern edge of the gulf stream to move eastwards and so avoid the large patch of southwestward currents just to the northwest from august 31 to september 1 it then advects north to hop on the moderately strong north to northwestward flow part of the eddy finally when just to the south of the target it leaves this flow which is now westward early on september 2 and travels north to reach the target similar to the isotropically propelled auv we can draw interesting remarks by looking at the spacing between the daily glider positions fig 14 a d the glider covers a large distance on the first day but travels a smaller one on the second this is because it utilizes the favorable gulf stream to initially travel east but then has to cross the southwestward jet only using its own speed it later travels large distances again on the third day this time by utilizing the north to northwestward eddy finally it covers a moderate distance on the fourth day i e more than day 2 but less than days 1 and 4 to finally reach the destination for the glider with a sinusoidal motion in the vertical it takes 4 9 min to solve the level set pde to compute the forward evolution of the reachability front and 52 s to compute the time optimal path by backward tracing when compared to the corresponding computational times for the isotropic auv 109 2 min for forward evolution 38 s for backward tracing we can clearly see that the forward evolution for the glider is much faster because the level set pde is now only solved in 2d instead of 3d however the backward tracing for the glider takes slightly longer as one needs to compute the contribution in the horizontal and the vertical and then combine them to yield the optimal travel direction of course the marginal cost increase in solving the backtracking ode is overshadowed by the significant gain in the solving the forward evolution pde fig 20 shows a top view of the optimal trajectories for the isotropic auv float and glider we find that the glider with its forced yo yo motion in the vertical between 0 and 90m makes the most use of the gulf stream the auv and float no such forced motion remain mostly at shallower depths and utilize favorable dynamic eddies meanders and sub surface currents to the north of the gulf stream to optimally reach the destination the float avoids the gulf stream in part to avoid challenges escaping it which would prevent reaching the target in fastest time if at all since the float can only move up and down 7 conclusions in this paper we first developed the theoretical foundations and practical aspects of exact time optimal path planning in 3d realistic ocean fields with strong and dynamic currents specifically we provided new extensions for the exact and efficient computation of optimal paths for commonly employed marine vehicles respecting their motion constraints we considered three main classes of propulsion behaviors unconstrained isotropic anisotropic and partially imposed for the latter two motions we specialized the exact reachability pde lolla et al 2012 lolla 2016 lolla and lermusiaux 2020 to vehicles that can propel only in certain directions e g only vertical propulsion or that have partially known motions e g forced yo yo motions respectively we showed that the 3d problem can be reduced to two dimensions if the motion of the vehicle is partially known such as gliders performing deterministic oscillatory vertical motions or propelled auvs forced to use specific patterns in the horizontal as a result the computational cost is reduced significantly second we obtained robust numerical schemes to solve the path planning equations consistently and with high accuracy in realistic 3d ocean domains since these domains have length and velocity scales that are much smaller in the vertical than the horizontal even small numerical errors along a certain dimension may have drastic consequences along the other dimensions to overcome this ill scaling we obtained the non dimensional form of the hamilton jacobi level set equation we next emphasized the new concept of numerical consistency between the discrete forward evolution of the reachable set and discrete backward tracing of the optimal path we discussed high order spatial and temporal numerical schemes for the forward evolution of the zero level set function and developed novel consistent implicit schemes for the backward tracing of the optimal path third we applied our schemes to analytical and realistic flows integrating ocean modeling with 3d path planning with motion constraints we validated the theory verified schemes and benchmarked accuracy using three analytical 3d flows numerical discretization errors were quantified by comparison to the analytically optimal paths and durations the capability of correctly handling dynamic 3d flows was confirmed using the data assimilative ocean currents of the mseas primitive equation modeling system in the middle atlantic bight region reachability fronts and optimal trajectories were predicted and analyzed for three classes of marine vehicles namely propelled auvs floats and gliders we described the regional ocean dynamics and the evolution of the reachability fronts in response to the instantaneous dynamic currents and propulsion characteristic of each vehicle type we found that the effects of 3d multiscale ocean currents on the actual optimal paths chosen by the vehicles were significant and that the vehicles tried to best utilize the favorable flow features while avoiding the adverse flows for such paths ocean forecasts should be employed for real time planning of efficient autonomous missions from optimal pick up and deployment to monitoring and adaptive data collection in the future since the 3d path planning pde and ode are exact they can be employed in any regions and dynamics e g low order flows such as in the sargasso sea vertically complex flows such as in equatorial regions strong and complex 3d flows such as in estuaries or in regions with physical obstacles lolla et al 2015 subramani et al 2017b numerically to further reduce the computational cost of the reachable set evolution the narrow band level set method adalsteinsson and sethian 1995 lolla 2016 lolla and lermusiaux 2020 could be utilized in 3d in that case only the values of the level set function that are strictly needed in the vicinity of the zero level set are computed another possible future direction is to study energy optimal paths or optimal paths in stochastic environments for such marine vehicles subramani et al 2017a 2018 subramani and lermusiaux 2019 finally onboard routing can be implemented using the developed theory and framework lermusiaux et al 2016 vehicle positions could be assimilated to correct the predicted advective velocity field and a modified optimal trajectory could be computed online from the real time position of the vehicle credit authorship contribution statement chinmay s kulkarni conceptualization methodology software pierre f j lermusiaux conceptualization methodology declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments we thank the members of our mseas group for insightful discussions we also thank the four anonymous reviewers for their useful comments we are grateful to the office of naval research united states of america for support under grants n00014 14 1 0476 science of autonomy learns and n00014 15 1 2616 dri nascar to the massachusetts institute of technology mit united states of america the mseas sw06 awacs 06 ocean re analyses employed were made possible by research support to mit from onr united states of america under grants n00014 11 1 0701 muri ioda and the national science foundation united states of america under grant oce 1061160 we thank all of our sw06 and awacs 06 colleagues especially g gawarkiewicz p abbot and t duda for their ocean data and m taylor and j hare for their nmfs survey data we also thank j evans s glenn and j wilkin for their real time wrf atmospheric fluxes and the fnmoc teams for their products appendix a theoretical results on the reachability set evolution in what follows we state the evolution of the reachability front governed by a hamilton jacobi equation specifically the following theorem provides the evolution of the reachable set by means of a pde and the optimal vehicle heading function that minimizes the total travel time the result is related to the principle of minimum action here time of classical mechanics theorem let v x t be a lipschitz continuous and bounded velocity field in all its arguments denote the set of permissible unit heading directions by h which is a subset of r 3 let the maximum vehicle speed f h ˆ t h 0 r be lipschitz continuous in all of its arguments we assume that the possible vehicle trajectories x t are governed by eq 1 with initial condition x 0 x s then the evolution of the reachability front is given by the zero level set of the function ϕ r 3 0 r where ϕ x t is the unique viscosity solution of the following equation a 1 ϕ t max h ˆ f h ˆ t h ˆ t ϕ v x t ϕ 0 with the initial conditions a 2 ϕ x 0 x x s the optimal arrival time t x f x s 0 satisfies a 3 t x f x s 0 inf t 0 t ϕ x f t 0 the optimal trajectory or trajectories x t is given by the characteristic lines of eq a 1 that is x t satisfies the following equation a 4 d x d t f h ˆ t h ˆ t v x t where a 5 h ˆ t arg max h ˆ f h ˆ t h ˆ t ϕ we refer to lolla and lermusiaux 2020 and lolla 2016 for the proof of this theorem remarks it is assumed that the external velocity field v x t is deterministic in real ocean applications the forecast fields are always associated with some uncertainty lermusiaux 2006 lermusiaux et al 2006 however the present results can be utilized to predict a sample path for a specific velocity realization or the path corresponding to the mean or the mode of the velocity field in such cases recent results by wei 2015 subramani et al 2018 and subramani and lermusiaux 2019 are indeed build upon such ideas to predict and study time optimal paths in stochastic flow environments in this work we only seek time optimality in many cases optimality in some other objective function such as energy spent quality of data collected etc may be desired the present results can be extended to optimize a general objective function that depends on the travel time followed trajectory and possible other parameters we refer the reader to subramani and lermusiaux 2016 for energy optimization and to lolla 2016 for computing optimal sampling locations in subramani et al 2018 and subramani 2018 risk optimal trajectory is studied depending on the whether the user is risk seeking risk neutral or risk averse for the case where the vehicle has a heading independent isotropic speed we have f f h ˆ x t this simplifies eq a 1 to yield eq a 6 a 6 ϕ t f ϕ v x t ϕ 0 further the optimal headings in this case are given by eq a 7 which are just the local outward normals to the reachability front a 7 h ˆ t ϕ ϕ appendix b numerical schemes for the forward reachable set evolution advection term the numerical schemes discretizing the advection term utilize the given velocity field explicitly and find suitable approximations for ϕ by using the sign of this known velocity field essentially non oscillatory eno schemes and their extension to weighted essentially non oscillatory weno schemes for hamilton jacobi equations shu and osher 1988 jiang and shu 1996 with up to 5th order accuracy are used to in the present work the general unsteady hamilton jacobi equation only contains at most the first derivatives of the unknown function ϕ crandall and lions 1983 osher and fedkiw 2006 and eno and weno schemes provide accurate estimates handling of anisotropic speeds if the propulsion speed of the vehicle depends on the direction of travel the optimal propulsion term is given by b 1 max h ˆ x t f h ˆ t h ˆ x t ϕ this in general cannot be reduced further in order to compute the contribution of this term a maximization is required to be performed at each point in the domain at all times we discuss some approaches to solve this maximization problem the most general way to solve the maximization is to construct a look up table prior to the forward evolution lolla 2016 lolla and lermusiaux 2020 this table holds the optimal heading directions for all possible reachability front gradient directions that is given the local outward normal ϕ x t ϕ x t the table returns the maximum value of the optimal propulsion term and the corresponding h ˆ x t required for backward tracing of the optimal path if the vehicle is permitted to only travel along certain directions then the maximum is calculated over all the directional derivatives along the permitted directions care needs to be taken in making sure that the discretization for computing the optimal heading is consistent with the grid discretization otherwise unfavorable errors may be introduced such a maximization can also be performed after every time step while the forward evolution of ϕ is being carried out this is called online maximization in this case the optimal heading direction is computed at each point and at each time by testing all permissible heading directions and choosing the maximum often offline maximization is computationally favorable especially when the speed does not vary with time as the propulsion term is only required to be computed once per heading direction if the maximum speed varies with time then the online maximization may prove to be more efficient as in such a case the offline table has to be separately constructed for each time tolerance parameter for discrete anisotropic speeds for vehicles with propulsion speeds that are only in specific discrete directions e g only up or down a tolerance parameter to limit the frequency of direction switch can be needed this is to avoid an optimal path with too many oscillations this occurs if the optimal propulsion term is close to zero or if it frequently flips signs these oscillations may not always be sufficiently accurate sub grid scale process or numerical diffusion effects and an actual marine vehicle typically should avoid such quick movements if such oscillations occur a simple approach to eliminate them is to use a tolerance parameter that is we then only consider the contribution due to the optimal propulsion term if its magnitude is larger than some tolerance value τ the value of τ controls the amount of switches in discrete propulsion direction in the optimal path of course setting this value to be too high can cause the path to deviate from optimality time marching all the temporal schemes used are total variation diminishing runge kutta tvd rk with up to 3rd order accuracy gottlieb and shu 1998 osher and fedkiw 2006 tvd rk schemes guarantee that no spurious oscillations are produced due to the temporal discretization as long as no spurious oscillations in time are produced with the forward euler scheme which is the building block of these schemes the first order accurate tvd rk scheme is just the standard forward euler time marching scheme whereas the second order tvd rk scheme is heun s method the reader is referred to osher and fedkiw 2006 for the details of the third order accurate tvd rk time marching appendix c numerical schemes for the backward tracing of the optimal path the optimal path is obtained by solving the ode given by eq c 1 backward in time c 1 d x d t v x t f h ˆ x t with the initial condition x t t x f x s 0 x f for the case of vehicles with isotropic speeds the optimal heading h ˆ x t is given by the local normal to the reachability front at the location x at time t for vehicles with anisotropic speeds the maximization table is used wherein the local normal direction is given as an input to obtain the optimal hading direction hence in either cases efficient computation of the normal direction to the reachability front in three dimensions is required computation of normals the reachability front is represented by multiple triangular surfaces for curved surfaces see ueckermann and lermusiaux 2010 the vertices of all these triangles along with the corresponding connectivity matrix are stored the procedure to compute the normal direction to a general surface is as follows 1 the triangle to which the given point belongs is found out 2 the normal direction to the plane of this triangle is computed by calculating the cross product of the edge vectors this normal is placed at the centroid of the triangle 3 normal directions at the vertices of this triangle are computed for each of the vertex points the normals to all the triangles that have the said point as a vertex are first computed as shown in fig c 21 the normal direction at this vertex is then given by a weighted combination of the constituent triangle normal directions where the weights are proportional to the angle subtended by the corresponding triangle at the concerned vertex 4 once the normals at each of the vertices and the centroids are computed the normal at the given point is computed by a weighted average of these 4 normals where the weights are proportional to the distance between the given point and the location of the normal backtracking schemes we now derive various backtracking schemes that are numerically consistent with the corresponding forward evolution schemes we only discuss the schemes for vehicles with isotropic speeds the extension to vehicles with anisotropic speeds is straightforward through the use of the maximization table as mentioned before since the forward evolution is explicit all these backtracking schemes of optimal paths are implicit and iterative solves are required at each time step our naming convention is such that the references to the backtracking schemes are made by the corresponding forward evolution schemes for example the backtracking scheme corresponding to the forward euler temporal evolution of the pde is referred to as the forward euler backtracking scheme hence even though the name of the backtracking scheme suggests explicit nature they indeed are implicit we use the superscript to represent the iteration number at a specific temporal instant the time is indicated in index form indexed with an interval of δ t and denoted as a subscript the stopping criterion used for all the schemes is given by eq c 2 where ε is a small number typically of the order of the smallest cell size c 2 stop if x k 1 x k ε forward euler backtracking this first backward tracing scheme mimics the forward euler scheme for the evolution of the level set function and serves as a building block for the higher order schemes c 3 x p k 1 x p 1 δ t f h ˆ x p k p δ t v x p k p δ t as we are solving eq c 3 backwards in time the value of x p 1 is known a priori and the normal h ˆ x p k t is computed by the method described above note that x p k may not in general lie on the zero level set of ϕ x p δ t in such cases the normal is computed by taking the projection of this point onto the closest constituent triangle of the zero level set surface for convenience in the forthcoming parts we define an operator b as c 4 b x p k p δ t f h ˆ x p k p δ t v x p k p δ t tvd rk2 backtracking eq c 5 describes the implicit backtracking scheme mimicking the tvd rk2 scheme for forward evolution c 5 x p k 1 x p 1 δ t b x p k 1 2 δ t b x p k p δ t p 1 2 δ t this scheme may be initiated similarly to the forward euler backtracking scheme with x p 0 x p 1 note that b is the euler building block and two computations of the forward euler building block are required per iteration doubling the computational cost per iteration tvd rk3 backtracking finally we obtain the backward tracing scheme corresponding the tvd rk3 forward evolution scheme eqs c 7 and c 9 are the iterative equations of this tvd rk3 backward tracing the optimal trajectory backtracking equation corresponding to the present step is c 6 x p 1 1 3 x p 2 3 x p 3 2 c 7 x p 3 x p 1 2 x p 3 2 even though we obtain x p without an iterative solve we require the value of x p at intermediate times which requires an iterative solve from tvd rk3 forward marching scheme we know that c 8 x p 3 2 x p 1 2 δ t f h ˆ x p 1 2 p 1 2 δ t v x p 1 2 p 1 2 δ t hence c 9 x p 1 2 k 1 x p 3 2 δ t b x p 1 2 k p 1 2 δ t in order to initialize this scheme we set x p 1 2 0 x p 3 2 similar to the earlier schemes eq c 7 is not iterative and hence does not require any initialization 
23960,autonomous underwater vehicles auvs operate in the three dimensional and time dependent marine environment with strong and dynamic currents our goal is to predict the time history of the optimal three dimensional headings of these vehicles such that they reach the given destination location in the least amount of time starting from a known initial position we employ the exact differential equations for time optimal path planning and develop theory and numerical schemes to accurately predict three dimensional optimal paths for several classes of marine vehicles respecting their specific propulsion constraints we further show that the three dimensional path planning problem can be reduced to a two dimensional one if the motion of the vehicle is partially known e g if the vertical component of the motion is forced this reduces the computational cost we then apply the developed theory in three dimensional analytically known flow fields to verify the schemes benchmark the accuracy and demonstrate capabilities finally we showcase time optimal path planning in realistic data assimilative ocean simulations for the middle atlantic bight region integrating the primitive equation of the multidisciplinary simulation estimation and assimilation system mseas with the three dimensional path planning equations for three common marine vehicles namely propelled auvs with unrestricted motion floats that only propel vertically and gliders that often perform sinusoidal yo yo motions in vertical planes these results highlight the effects of dynamic three dimensional multiscale ocean currents on the optimal paths including the gulf stream shelfbreak front jet upper layer jets eddies and wind driven and tidal currents they also showcase the need to utilize data assimilative ocean forecasts for planning efficient autonomous missions from optimal deployment and pick up to monitoring and adaptive data collection keywords path planning three dimensional level set data assimilation ocean forecasting auvs gliders floats 1 introduction the problem of planning feasible safe and optimal paths in complex and dynamic environments has received much attention from many branches of science and engineering in the most general sense optimal path planning refers to a set of rules provided to an autonomous robot such that the robot can navigate from some initial configuration to the desired configuration in an optimal fashion typically such optimality is governed by some objective function autonomous robotic platforms are becoming ubiquitous day by day and are used to perform a variety of tasks with different levels of complexity this leads to a wide range of objective functions principled path planning theories that apply to several situations are thus not common optimal navigation of autonomous underwater vehicles auvs is crucial for many applications including security search and rescue monitoring and data collection underwater gliders and floats are ideal for ocean sampling due to their long range endurance and significant autonomy however these vehicles typically travel at relatively slow speeds in many cases comparable to that of the local ocean currents schmidt et al 1996 elisseeff et al 1999 yan et al 2014 hence the effect of currents on their net motion cannot be neglected and should be modeled accurately the ocean environment in which these vehicles operate is however a highly dynamic system with high spatio temporal variability cushman roisin and beckers 2011 it is therefore challenging to develop accurate and efficient methodologies to predict paths that optimize a desired objective function while modeling both the dynamic environment and the vehicle constraints achieving such principled path planning in three dimensions integrating data assimilative ocean modeling with model predictive control is the motivation of the present work existing works in underwater path planning have mostly studied two dimensional 2d or quasi two dimensional scenarios kulkarni 2017 however ocean currents often differ greatly with depth cushman roisin and beckers 2011 in order to reach the destination in optimal time underwater vehicles need to utilize favorable currents and also avoid adverse currents by diving or rising to appropriate depths underwater path planning in fully three dimensional 3d real ocean domains is thus of great importance predicting ocean currents over real domains is needed for such planning but numerically challenging oceans are complex dynamical systems with multiple time scales from seconds to years and length scales from millimeters to hundreds of kilometers cushman roisin and beckers 2011 robust and accurate numerical schemes and data assimilative models are thus needed lermusiaux et al 2006b lermusiaux et al 2006 pinardi et al 2017 further there are different types of marine vehicles with specific degrees of freedom and propulsion constraints typical marine gliders used for sampling data commonly perform a sinusoidal motion rudnick et al 2004 testor et al 2010 javaid et al 2014 whereas floats that drift with ocean currents are only able to perform vertical motion by adjusting their buoyancy roemmich et al 2009 kobayashi et al 2012 in order to plan feasible safe and optimal trajectories for such vehicles one needs to respect these specific propulsion constraints the desired attributes listed above are crucial to optimal path planning in real ocean scenarios in the present work we start from the governing path planning equations lolla et al 2012 2014a b lermusiaux et al 2016 they account for the effects of the dynamic environmental flow field on the net vehicle motion they predict exact globally optimal paths without heuristics lolla and lermusiaux 2020 are computationally efficient lolla et al 2012 and can account for unsafe forbidden regions and stationary or moving obstacles lolla et al 2015 the effectiveness of the algorithms was experimentally demonstrated in multiple sea trials subramani et al 2017b edwards et al 2017 mirabito et al 2017 results were extended to predict the paths that minimize the energy usage subramani and lermusiaux 2016 subramani et al 2017a or maximize the quality of data collected by the vehicles lolla 2016 lermusiaux et al 2017 presently for the first time we address both fully 3d realistic ocean setups and 3d propulsion constraints we develop the theory and numerical methods to handle the complexities of dynamic 3d flow fields and motion constraints on realistic marine vehicles we verify the schemes in benchmark flows we then analyze results in the middle atlantic bight region we describe the regional dynamics and our data assimilative ocean modeling system we finally showcase the impact of the dynamic 3d circulation features on the evolution of the reachability fronts and time optimal paths for several common types of marine vehicles the paper is organized as follows we first briefly review prior results on 3d path planning in static and dynamic environments in section 2 we state the problem and provide the equations that govern the optimal trajectories extensions to motion constrained marine vehicles in 3d domains are derived in section 3 in section 4 we develop numerical schemes to achieve high accuracy in real ocean domains in section 5 we verify the path planning in 3d analytical benchmark flows in section 6 we describe the dynamics and modeling of the middle atlantic bight region and complete realistic simulations to compare and contrast path planning for common types of marine vehicles the summary and conclusions are in section 7 1 1 prior progress in optimal path planning in three dimensional and realistic domains optimal path planning in 3d domains is a complex and challenging problem and hence algorithms for the same have not been studied extensively however utilizing environmental flows and planning feasible although sub optimal paths in three dimensions has been elaborately studied by several researchers from a wide variety of areas for example kiraly et al 2004 compute feasible 3d trajectories for a bronchoscope in various airways inside the human body while siddon 1985 plans paths for 3d computed tomography in radiology nature also serves as a motivation for optimal planning problems for example richardson 2012 and sachs et al 2013 mimic the dynamic soaring of the albatross for autonomous aerial vehicles in order to optimize energy consumption the albatross utilizes the lee eddies located downwind of sharp crested waves to increase its speed such a maneuver requires minor adjustments to the trajectory but saves significant energy other similar dynamic soaring patterns to minimize the energy spent during travel are also studied by bonnin 2016 and zhao 2004 planning feasible and collision free trajectories for aerial vehicles is an active field with many established approaches lozano pérez and wesley 1979 use a network based scheme to plan paths in domains with forbidden regions and obstacles mittal and deb 2007 attempt to plan feasible paths offline using evolutionary algorithms wong and fu 1986 utilize a network based scheme on two dimensional sections of the 3d domain for computational efficiency this idea of planning collision free paths is also extended to larger aircraft and congested airports for which most results rely on optimization techniques such as integer programming for example richards and how 2002 use mixed integer linear programming to plan collision free aircraft trajectories whereas frazzoli et al 2001 utilize semi definite programming prete and mitchell 2004 and krozel et al 2006 employ network based approaches to compute safe aircraft trajectories that minimize travel in time varying 3d hazardous weather regions in the ocean domain pereira et al 2013 provide an algorithm to compute 3d underwater vehicle paths that minimize the risk of collision with ships and land they use the regional ocean modeling system for oceanic flow fields and a markov decision process based approach and expectation minimization to decrease the risk of collision smith et al 2010 further extend this methodology to tracking a dynamically evolving ocean feature while minimizing the risk of collision with ships and other possible obstacles petillot et al 2001 utilize data from an onboard sonar sensor to plan paths that minimize the risk of collisions with objects and obstacles in the ocean a common approach towards optimal path planning is to use a myopic optimization where the vehicle chooses the short term optimal option among other options global optimality is then not guaranteed but the approach is nonetheless useful for example zamuda and sosa 2014 consider a glider that gathers data while following a path towards some set destination where a short term opportunistic sampling algorithm is used to maximize the quality of the data collected a continuum viewpoint has also been used for 3d robotic path planning such as the potential field method eliminating the need for network based models connolly et al 1990 wang and chirikjian 2000 all obstacles are then assumed to exert a repelling force whereas the target position exerts an attractive force on a potential function heuristics are needed to account for the effect of external flow fields on the computed path finally to plan glider paths in 3d ocean environments garau et al 2014 used the a algorithm hart et al 1968 with examples in the western mediterranean sea even though the a algorithm is efficient its use of heuristics does not guarantee global optimality witt and dunbabin 2008 build upon kruger et al 2007 to find paths that minimize the energy spent by an autonomous vehicle in 3d ocean domains this is achieved by using the present current to the greatest advantage this local method efficiently chooses an energy optimal path amongst the considered candidate paths however as all the possible paths are not considered strict global optimality is not ensured for more extensive reviews we refer to kulkarni 2017 2 optimal path planning using the level set method theory in what follows we formally describe the problem statement and introduce the exact time optimal path planning equations that establish the theoretical foundation further details can be found in lolla et al 2014b lolla 2016 and lolla and lermusiaux 2020 2 1 problem statement consider the motion of a vehicle from the start point x s to the destination x f in the domain ω r 3 let the trajectory of the vehicle be given by x t fig 1 illustrates the velocity components of the vehicle as it moves from the start point to the target the first component is the vehicle propulsion in the direction of the heading h ˆ with a speed f v that is bounded by zero and a maximum speed i e 0 f v f h ˆ x t this latter maximum nominal propulsion speed of the vehicle denoted by f h ˆ x t is in general a given function of the heading direction h ˆ spatial location x and present time t the vehicle is also forced by a dynamic external velocity field v x t ω 0 r 3 the second velocity component of vehicle is thus the advection by the velocity field v x t t i e the ocean currents the effective velocity experienced by the vehicle is given by 1 v e x t t d x t d t f v h ˆ v x t t in nautical jargon the magnitude of the horizontal component of the effective velocity v e is often referred to as speed over ground and the vehicle speed f v as speed through water we denote the first arrival time function by t x x 0 t 0 it is the time at which the vehicle reaches any specified point x for the first time given that it started from x 0 at time t 0 clearly we have 2 t x s x s 0 0 and x t x f x s 0 x f it is proven that in order for the vehicle to reach the desired destination in the minimum amount of time it must travel at the maximum allowable speed lolla and lermusiaux 2020 lolla 2016 we thus wish to compute the vehicle heading h ˆ as a function of time that yield minimum travel time for the vehicle between x s and x f subject to the constraints imposed by eqs 1 and 2 hence we search for h ˆ t o p t i m a l defined by 3 h ˆ t o p t i m a l arg min h ˆ f v t x f x s 0 note that in the above formulation the optimal heading choice h ˆ t o p t i m a l is also a function of the position of the vehicle along the optimal trajectory i e x t however as this position itself is function of time once the optimal path is known we drop this implicit dependency of h ˆ t o p t i m a l on x t 2 2 approach exact time optimal path planning hinges upon the concept of reachability lolla 2016 the reachable set is the set of all the points that can be visited by the vehicle by the considered time given the starting point of the vehicle at any time all the points that lie on the boundary of the reachable set i e the reachability front have been reached for the first time the value of their first arrival time function is the present time by keeping track of the reachability front at all times one can determine the time when this front reaches the target for the first time which is the minimum travel time between the start position and the target a path traced by a point that always travels on the reachability front and reaches the target is exactly an optimal path we wish to compute note that there can be multiple optimal paths this broadly divides the problem in two sub parts i first the forward evolution of the reachable set and front and ii second once the reachability front reaches the destination the optimal trajectory traced backwards in time we refer to these sub parts as forward evolution of the reachable set and backward tracing of the optimal path respectively fig 2 pictorially depicts the reachability front analogous to a first wave front and the possible heading choices at two different positions this two step approach involving the forward evolution of the reachability front followed by backward tracing of the optimal trajectory which is a characteristic passing through the destination of the pde governing the reachability front evolution has been proven to be exact even when the external flow speed is larger than the vehicle speed i e the vehicle is not fully controllable lolla 2016 lolla and lermusiaux 2020 2 3 forward evolution of the reachable set and backward tracing of the optimal path we use the level set method to predict the propagation of the reachability front the front is then embedded as the zero level set of a signed distance function henceforth denoted by ϕ the zero level set of a function is simply the set of points at which the function value is zero it is evolved until the target lies on it once this is achieved we compute the optimal path by tracing the trajectory of the particle that always traveled on the reachability front and reached the target at the first arrival time this is done by solving the particle motion ode eq 1 backward in time starting from the destination and by utilizing the optimal heading information from the reachable set evolution in general we have two free control parameters namely the vehicle speed f v and the vehicle heading h ˆ we would like to predict the optimal values of these control parameters as a function of time such that the first arrival time function for the target point t x f x s t 0 is minimized it is proven that for the vehicle to reach the desired destination in the minimum amount of time it must travel at the maximum allowable speed lolla and lermusiaux 2020 lolla 2016 this implies that the only control parameter is the heading of the vehicle we now simply state the significant results that express the solution of this minimization problem more details regarding the same may be found in appendix a and lolla and lermusiaux 2020 lolla 2016 we assume that the possible vehicle trajectories x t are governed by eq 1 with initial condition x 0 x s then the evolution of the reachability front is given by the zero level set of the function ϕ where ϕ x t is the unique viscosity solution osher and fedkiw 2006 lolla and lermusiaux 2020 of the following the hamilton jacobi level set equation 4 ϕ x t t max h ˆ x t f h ˆ x t h ˆ x t ϕ v x t ϕ x t 0 with the initial conditions 5 ϕ x 0 x x s the second term on the left hand side of eq 4 incorporates the propulsion of vehicles and is referred to as the optimal propulsion term the last term on the left hand side of eq 4 is referred to as the advection term as it accounts for the transport of the vehicle by the background external velocity field i e the predicted ocean currents in what follows for clarity we do not explicitly retain the functional dependencies of ϕ h ˆ and v on x t and of f on h ˆ x t unless there is a specific need to clearly denote these dependencies or when it helps in understanding in the special case when the vehicle speed f h ˆ x t is independent of the heading h ˆ of the vehicle isotropic speed the maximization can be performed analytically the resulting hamilton jacobi level set equation for this case is given by eq 6 6 ϕ t f x t ϕ v ϕ 0 we solve eq 4 until the target x f lies on or just inside the reachability front i e until ϕ x f t 0 once this is achieved the optimal trajectory or trajectories x t is given by the characteristic lines of eq 4 that is x t satisfies the following equation 7 d x t d t f h ˆ x t h ˆ t v x t where h ˆ t arg max h ˆ x t f h ˆ x t h ˆ x t ϕ x t these 3d governing path planning equations are exact it is only when they are numerically integrated that truncation round off errors are made and with fine enough resolutions these errors go to zero this is a major advantage when compared to planning schemes that are inexact due to heuristics or simplifications or that are too expensive of course all these schemes also make numerical errors once implemented on a computer e g for graph methods errors depend on graph resolution connectivity time step etc see mannarini et al 2020 3 modeling of realistic marine vehicles we now extend the theory to motion constrained vehicles in 3d domains capturing the behavior of commonly used marine vehicles first we treat vehicles whose speed depends on their heading direction such vehicles are referred to as vehicles with anisotropic speeds vehicles that are constrained to move only along certain directions may also be included in this category as it can be assumed that the vehicle speed is non zero only along the permitted direction s of travel the second class considers vehicles whose motion is known partially in general this motion is assumed to be known along a specific direction which itself could be a function of time we refer to such vehicles as vehicles with partially known motion 3 1 vehicles with anisotropic speeds the reachability front is governed by eq 4 where it is embedded as the zero level set of the level set function ϕ if the propulsion speed of the vehicle is dependent on its heading direction a maximization over all the heading directions is required to be performed at each point of the front or domain at all times to evaluate the optimal propulsion term details of the same are discussed in appendix b if the expression for vehicle speed f is known in terms of the heading h ˆ and the time t then the maximization may be performed analytically as an example we consider the case of an oceanic float these vehicles can only propel in the vertical direction by adjusting their buoyancy rudnick et al 2004 and are advected by the environmental flow mostly in the horizontal due to the commonly smaller ocean vertical currents we model this by enforcing the following 8 h ˆ h z n ˆ z n ˆ z 0 where h z is a subset of r 3 and n ˆ z 0 0 1 is the unit vector along the vertical z direction eq 8 implies that the only directions that the vehicle can be steered in are vertically up or vertically down using this in the maximization term we obtain 9 max h ˆ x t f h ˆ x t h ˆ x t ϕ x t f max 0 0 1 ϕ x ϕ y ϕ z f max ϕ z f ϕ x t z substituting this result in eq 4 the final hamilton jacobi equation to be solved for the motion of a float is given by 10 ϕ t f ϕ z v ϕ 0 with all the possible optimal headings on the reachability front given by 11 h ˆ x t s i g n ϕ x t z n ˆ z the optimal floats headings thus depend on the flow field implicitly through ϕ x t a float that first reaches the target x f will thus alter its upward or downward motion according to the sign of the vertical gradient of ϕ x t along the optimal trajectory governed by eq 7 3 2 vehicles with partially known motion we now examine vehicles whose motion is known along some time dependent direction we prove that in such cases the 3d problem can be decomposed into a two dimensional problem with a hybrid velocity field yielding significant computational savings as will be seen in sections 4 5 and 6 let us assume that the motion of the vehicle at a location x and time t is known along some direction n ˆ x t let the maximum propulsion speed of the vehicle along n ˆ x t be f n x t also assumed to be known let the heading of the vehicle in the plane orthogonal to n ˆ x t at position x and time t be h ˆ x t with speed f h ˆ x t f h ˆ x t 2 f n x t 2 1 2 in what follows for clarity we drop the dependencies of ϕ v n ˆ and f n on x t and of f on h ˆ x t note that f n cannot be a function of h ˆ as that implies that the component sub problems cannot be decoupled as will be seen however as f depends on h ˆ the resulting f is also a function of h ˆ since h ˆ is the unit vector in the direction h ˆ n ˆ where n ˆ is known at all locations at all times and cannot be optimized we can nonetheless reduce the dependency of f on h ˆ to a dependency on h ˆ only the hamilton jacobi equation 4 can thus be written as 12 ϕ t max h ˆ f n n ˆ f h ˆ ϕ v ϕ 0 ϕ t max h ˆ f h ˆ ϕ v f n n ˆ ϕ 0 the advective velocity field itself can be written in terms of component along n ˆ t and components orthogonal to n ˆ t let us denote this decomposition of the velocity field as 13 v x t v n x t n ˆ x t v x t n ˆ x t where n ˆ x t denotes the basis of the plane orthogonal to n ˆ x t and v x t v x t n ˆ x t is the corresponding velocity component substituting this in eq 12 we obtain 14 ϕ t max h ˆ f h ˆ ϕ v n ˆ v n f n n ˆ ϕ 0 we will next use a 1st order operator splitting fractional step method wheeler and dawson 1987 ferziger et al 2020 to split eq 14 into two constituent equations the first equation describes the evolution of the projection of ϕ onto n ˆ ϕ and the second describes the evolution of ϕ along n ˆ ϕ n together the sum of these two contributions yields the evolution of ϕ in ω if their full coupling is maintained as is seen in the following 15a ϕ t max h ˆ f h ˆ ϕ v n ˆ ϕ 0 15b ϕ n t v n f n n ˆ ϕ 0 15c ϕ t ϕ t ϕ n t eq 15a represents the evolution of the reachable set in the plane orthogonal to n ˆ t whereas eq 15b represents the contribution due to the advective and vehicle motion along n ˆ t which does not require any optimization hence in this case the only optimal control problem to be solved is represented by eq 15a which is a reachable set evolution in two dimensions the contribution due to eq 15b is then locally added in order to obtain the final value of ϕ t by summation the initial conditions are for eq 15a ϕ x 0 x x s and for eq 15b ϕ n x 0 x n x s n where the subscripts and n then indicate projection orthogonal to and along n ˆ 0 respectively as for the forward evolution the backward trajectory of the vehicle also consists of two parts i the motion in the orthogonal plane n ˆ t and ii the component along n ˆ t thus the ode defining the optimal trajectory also consists of the sum of two corresponding components 16a d x d t f h ˆ v 16b d x n d t f n n ˆ 16c d x d t d x d t d x n d t where h ˆ t arg max h ˆ x t f h ˆ x t h ˆ x t ϕ x t eq 16a represents the optimal trajectory orthogonal to n ˆ t while eq 16b governs the path along n ˆ t as with eq 7 eq 16c is solved in backward time starting from x t x f x s 0 x f to compute the optimal trajectory numerically if eqs 15a and 15b are integrated separately over δ t without coupling between them splitting errors are made the same can be said about the split backward tracing equations 16 these numerical issues are discussed in section 4 5 4 numerical schemes for realistic ocean domains we now develop accurate consistent and efficient numerical schemes for the path planning equations we first present challenges in realistic 3d ocean scenarios and obtain the non dimensional form of the hamilton jacobi level set equation which is crucial in solving underwater path planning problems we then emphasize the advantages of numerical consistency between the discrete forward evolution of the reachable set and discrete backward tracing of the optimal path finally we develop high order spatial and temporal numerical schemes for the forward evolution of the zero level set function and novel implicit schemes for the backward tracing of the optimal path 4 1 challenges in real ocean domains and non dimensionalization of the hamilton jacobi equation most stratified geophysical fluid flows are extremely anisotropic in terms of length and or velocity scales with orders of magnitude difference between the horizontal and vertical scales cushman roisin and beckers 2011 such disparity in the length scales e g horizontal scales of kilometers and vertical scales of meters significantly affects simulations of 3d oceanic domains where even small deviations in some direction may cause large changes in the other directions in many ocean prediction models the vertical velocity is obtained as a diagnostic variable for example in hydrostatic models one computes the vertical flow velocity by enforcing the divergence free condition and accounting for the free surface motion haley jr and lermusiaux 2010 these vertical velocities e g o 10 3 cm s to 10 1 cm s are typically much smaller in magnitude than horizontal ones e g o 1cm s to 1m s this implies that the vertical advective fluxes may be severely altered even by small relative errors in the fluxes in other directions thus impacting the accuracy of the zero level set evolution in three dimensions to ensure that such a discrepancy in scales does not affect the fidelity of the computation we non dimensionalize the hamilton jacobi level set equation 4 to non dimensionalize a reference scale needs to be set up for each of the variables for each of the spatial dimensions and each of the corresponding velocity components one commonly utilizes a characteristic length e g domain length and velocity magnitude the other variables that remain are the level set function ϕ and the time t the non dimensionalizing scales that we propose are summarized in table 1 the characteristic scales for the velocities are averages over the entire spatial and temporal domain of interest and are computed only once per simulation another suitable scale for velocities could also be the maximum velocity in that direction over the entire temporal domain of interest although an acceptable choice the maximum velocity can be much larger than the typical expected velocity magnitudes and the non dimensionalization would then not be very effective in such cases if the velocities in different regions vary greatly then the domain can be divided into appropriate sub domains and a separate non dimensional scale for the velocities can also be chosen in each of the domains the characteristic time scale used is an estimate for the travel time assuming that the vehicle either travels only at its own speed or is only advected with the flow whichever is the faster choice specifically we look at the maximum of the travel times along each of the basis directions that is along the x y and y directions when the vehicle optimally chooses to either travel with the flow or travel on its own but not both it must be stated that these choices are far from unique and appropriate characteristic scales should be chosen based on the specifics of the problem no scale for ϕ is required as the partial differential equation pde is linear in ϕ and independent of the scaling of ϕ the numerically well conditioned non dimensional form of eq 4 is given by eq 17 where the superscript refers to the non dimensional quantity corresponding to 17 1 t c ϕ t max h ˆ x h ˆ y h ˆ z f h ˆ x t l x ϕ x h ˆ y t l y ϕ y h ˆ z t l z ϕ z v x c l x v x ϕ x v y c l y v y ϕ y v z c l z v z ϕ z for the case of isotropic propulsion this eq 17 reduces to 18 1 t c ϕ t f 1 l x 2 ϕ x 2 1 l y 2 ϕ y 2 1 l z 2 ϕ z 2 v x c l x v x ϕ x v y c l y v y ϕ y v z c l z v z ϕ z the advective fluxes in each direction scale with the ratio v l in the corresponding direction as is well known from mass conservation even though both v z and l z are much smaller than either of v x and l x or v y and l y the ratio v z l z can easily be comparable to v x l x and v y l y this means that even though the length and the velocity in the z direction are small the advection contribution in this direction may not be negligible the contributions due to each of the directional terms in the optimal propulsion term scale as 1 l x 1 l y and 1 l z in eq 17 this again implies that even though length of the domain in the z direction is much smaller the contribution to the optimal propulsion term in this direction can be substantial even if the vertical propulsion speed is smaller than the horizontal one anisotropic propulsion hence ignoring or not completely resolving the motion in the vertical direction may cause large errors as its contributions to both the optimal propulsion and advection are comparable to the other horizontal terms 4 2 numerical consistency between the forward evolution and backward tracking a consideration in the computation of the optimal path is the numerical consistency between the discrete forward evolution and backward tracing the forward reachability evolution is governed by the pde 4 it represents the motion of all hypothetical optimal points that could reach the destination through a functional representation of the reachability front in space this pde is often solved using explicit numerical time integration backward tracing of the optimal involves an ode 7 that governs the spatial motion of an optimal point over time for consistent minimal numerical errors during discrete backtracking we should match the discrete forward reachability front i e exactly reverse the steps of the discrete forward time integration we then ensure that the optimal point numerically gets back to the start point specifically we should maintain three numerical consistencies forward backward explicit implicit time consistency type of time integration consistency and spatial discretization consistency for example if the forward temporal evolution is explicit then the backward temporal evolution should be implicit and vice versa the exact type of the forward evolution scheme also needs to be mimicked by the backtracking scheme for example if the forward evolution uses the forward euler time marching then the backward tracing should use the backward euler scheme finally numerical consistency in space should also be maintained between the pde and ode e g for the normals to the level set if these consistencies are not maintained the discrete local forward front and backward path integration do not exactly reverse numerically with compounding of errors during the backtracking we can then not guarantee getting back to the start point fig 3 schematically represents the discrepancy arising during one time step if numerical consistencies are not maintained as it is much easier to solve a pde through explicit time marching we use implicit time marching for the backward tracing of optimal path and hence an iterative solver is necessary for the ode 4 3 numerical schemes forward evolution the main interest is the accuracy of motion of the zero level of the level set function ϕ small deviations from the truth may not change the arrival times much but could severely alter the computation of the optimal path further due to the entropy condition ϕ x t may be non differentiable at the zero level set sethian 1994 as is well known finite difference and finite volume numerical schemes are diffusive of shocks and discontinuities and these errors are amplified with time mainly due to compounding of errors for marine vehicles whose speed strongly depends on the heading or which can only travel in a few permissible directions slight errors in the level set function computation can easily cause the computed heading direction to be vastly different from the optimal one hence we employ high order spatial and temporal schemes for the forward evolution of the level set function equation 17 in our present case for a simpler implementation of higher order schemes the pde is solved on a 3d structured grid using the finite volume fv method the optimal propulsion and advection terms are computed independently of each other the boundary conditions do not have a direct impact on the growth of the reachability front as it does not depend on the values of the level set function ϕ away from itself to this end we use radiation boundary conditions on ϕ at all the boundaries we employ essentially non oscillatory eno and weighted essentially non oscillatory weno schemes with up to 5th order accuracy shu and osher 1988 jiang and shu 1996 the optimal propulsion term needs to be treated differently depending upon whether the vehicle exhibits isotropic motion or not if the vehicle has isotropic speed then the optimal propulsion term from eq 6 is solved using the godunov scheme osher and fedkiw 2006 when the vehicle speed depends on its direction of travel a maximization needs to be carried out appendix b presents the details of the numerical schemes as well as the maximization methods required for the optimal propulsion term in conjunction with these spatial schemes we utilize total variation diminishing runge kutta tvd rk schemes of up to 3rd order accuracy for time marching osher and fedkiw 2006 the combination of eno weno schemes with tvd rk time marching ensures that the solution is total variation bounded tvb osher and fedkiw 2006 4 4 numerical schemes backward tracing the optimal path is obtained by solving eq 7 backward in time with x t x f x s 0 x f as all the time marching schemes that we utilize for eq 17 are explicit i e explicit time integration is used the consistent schemes for the optimal path computation must be implicit which implies that iterative solvers are required see section 4 2 further the specifics of the scheme used for the characteristic computation must mimic the temporal scheme from the forward evolution computation fig 4 illustrates the underlying ideas behind the implicit backward tracing for a fixed point iteration improved values are iteratively obtained by computing the predicted future position of the vehicle using the currently available heading and advective velocity values and then using the values of these parameters from this position to determine the optimal heading at any time the normal direction to the local reachability front needs to be computed this normal direction is then either directly used as the optimal heading direction or is passed as an argument to the maximization described in appendix b to obtain the optimal heading direction the novel algorithm used for the computation of the normals in 3d is detailed in appendix c appendix c also describes the implicit backward tracing schemes for time marching with forward euler tvd rk 1 heun s method tvd rk 2 and tvd rk 3 4 5 numerical schemes vehicles with partially known motion we now discuss numerical schemes for computing the optimal trajectory of vehicles with partially known motion specifically due to the operator splitting approach used to solve eqs 15 and 16 forward evolution as operator splitting is utilized to solve eqs 15 splitting errors are made the order of the splitting error depends on the specifics of the splitting method utilized two popular operator splitting techniques are lie splitting macnamara and strang 2016 and strang splitting strang 1968 which are at least 1st and 2nd order accurate respectively lie splitting simply involves explicitly solving eq 15a followed by eq 15b over one numerical time step each and then adding the respective contributions strang splitting on the other hand involves solving eq 15a over half a numerical time step and updating the field ϕ x t with the outcome then eq 15b is solved over one numerical time step using the updated field ϕ x t and the results are updated finally this new field is used to solve eq 15a another half numerical time step to arrive at the final evolution under certain constraints on the external velocity and known component of the vehicle motion these splitting methods can achieve higher orders of accuracy for example lie splitting is 2nd order accurate whereas strang splitting is exact for a vehicle following known motion along a fixed direction in a steady flow field more numerical details including sufficient conditions for these splittings to yield tighter accuracy bounds can be found in lanser and verwer 1999 and kulkarni and lermusiaux 2019 in general as long as the splitting error is of the same or higher order of accuracy as the numerical schemes employed for time marching for resolved numerics the accuracy of the complete numerical scheme is not affected by the splitting error backward tracing the implicit explicit nature of the forward schemes along with the order of the operator splitting must be mimicked in backward tracing the in plane in n ˆ t motion can be computed by the backtracking algorithm in a consistent way to the forward time marching used for the level set field the trajectory point obtained i e x t is actually the projection of the exact point onto the n ˆ t plane the actual position is then computed by adding the displacement along n ˆ t due to the vehicle velocity and the local flow velocity this contribution can be either explicit or implicit as shown by eqs 19 and 20 19 x t x t δ t δ t f h ˆ x t δ t t δ t h ˆ t δ t v x t δ t t δ t where h ˆ t δ t arg max h ˆ x t δ t t δ t f h ˆ x t δ t t δ t h ˆ x t δ t t δ t ϕ x t δ t t δ t 20 x t k 1 x t δ t δ t f h ˆ x t k t h ˆ t v x t k t where h ˆ t arg max h ˆ x t k t f h ˆ x t k t h ˆ x t k t ϕ x t k t with x t 0 x t δ t where x t is the auxiliary position at time t when only the horizontal motion is accounted for the effective velocity along n ˆ t can be computed either explicitly eq 21 or implicitly eq 22 21 x t x t δ t v z x t t f n x t t n ˆ x t t 22 x t k 1 x t δ t v z x t k t f n x t k t n ˆ x t k t with x t 0 x t 4 6 computational cost we now look at the asymptotic computational complexity for the level set based time optimal path planning in 3d environments in all the considered examples we numerically solve the forward evolution of the reachability front either eqs 6 or 4 using the finite volume method the asymptotic computational complexity is a function of the grid size in this analysis we assume that there are approximately n grid points in each direction and thus the total number of grid points in the domain denoted by n is about n o n 3 cost of solving the forward evolution of the reachable set in 3d to solve the forward evolution of the reachability front the level set equation is solved in the entire domain the computational cost per time step for this is o n 3 adalsteinsson and sethian 1995 the number of numerical time steps k that the solver runs for is directly related to the optimal travel time of the vehicle k t x x 0 0 δ t as the optimal travel time of the vehicle is not known a priori it is not possible to estimate the total number of time steps k to begin with further as we use explicit time marching to solve the level set pde the numerical time step δ t is inversely related to the number of grid points n which makes k directly proportional to n instead of solving the pde over the entire domain one can use the narrow band level set method adalsteinsson and sethian 1995 and solve the pde only around the zero level set reducing the computational cost from o n 3 to o d n 2 o n 2 where d n is the bandwidth cost of performing the maximization of the optimal propulsion term if solving eq 4 with an analytical maximization is not possible one can construct a look up table prior to the forward evolution that contains the optimal heading direction for every direction of the outward normal see appendix b this look up table needs to only be constructed once and its cost is directly proportional to the resolution used to discretize the optimal heading and outward normal directions specifically if the optimal heading space is discretized in o n h 2 points both the polar and the azimuthal directions contain o n h points and similarly the outward normal space is discretized in n n 2 points then the construction cost of the maximization look up table is o n h 2 n n 2 cost of solving the forward evolution of the reachable set for vehicles with partially known motion for vehicles with partially known motion the level set pde only needs to be solved in 2 dimensions and hence the computational cost per time step now becomes o n 2 adalsteinsson and sethian 1995 further if analytical maximization is not possible then the cost of constructing the look up table is o n h n n as the maximization is only performed in 2d and not in 3d finally the equation describing the vertical component of the reachable set growth is simply solved in 1d and hence its cost is o n thus the net cost of computing the forward evolution of the reachable set for vehicles with partially known motion is o n 2 n instead of o n 3 similarly to the 3d case if the level set pde is solved using the narrow band level set method the computational cost reduces to o n d n o n cost of backward tracing of the optimal path the backward tracing of the optimal path is simply done by solving an ode and hence the cost of this operation per time step is simply o 1 given the optimal heading direction is available in order to obtain this optimal heading direction one may need to construct the local outward normal to the reachability front and refer to the look up table however these costs are assumed constant and are much smaller than the forward evolution pde solve costs computational infrastructure used all the analytical and realistic simulations presented in sections 5 and 6 respectively were performed in matlab on a single quad core intel i7 4790 cpu clocked at 3 60 ghz matlab s internal vectorization parallelization for matrix vector operations was enabled for all computations the computational times required for the forward evolution of the reachable set and backward tracing of the optimal path for these applications are mentioned in their respective analyses 5 applications in benchmark three dimensional analytically known flow fields to verify schemes and benchmark accuracy we now apply the exact time optimal path planning in three 3d analytical flow fields first we study optimal path planning in a uniform advective flow analytical solution for the travel time are obtained which allows quantifying errors in our algorithm second a pulsating 3d vortical flow is used to benchmark the accuracy of our path planning in 3d dynamic flows with semi analytical optimal trajectories and duration third path planning in an analytical 3d double gyre shear flow is studied we effectively depict the ability to account for velocity fields that are spatially and temporally variable and also the ability to handle path planning for swarms of vehicles starting from the same location where only a single forward pde computation is required this reduces the computational cost as compared to heuristic schemes with independent computations for each of the vehicles 5 1 validation in uniform velocity field a theoretical value of the optimal travel time between a given pair of start and end points can be obtained for vehicles moving with isotropic speed in a uniform advective flow field let this advective flow be denoted as v x t v 0 u 0 v 0 w 0 for all x and t to derive the optimal travel time we consider the inertial reference frame moving with velocity v f r a m e v 0 the advective velocity field is absent in this frame however the effective target position will now be x f x f t v 0 if t is the sought optimal travel time in the absence of any advective velocity field the optimal path between x s and x f is a straight line joining these points and the required travel time is given by x f x s f which must be equal to t we thus have 23 t x f x s f x f x s t v 0 f defining x f x s δ δ x δ y δ z eq 23 leads to a quadratic equation for t with at most one non negative root 24 t δ v 0 δ v 0 2 f 2 v 0 2 δ 2 f 2 v 0 2 for f v 0 eq 24 fails to hold however eq 23 then reduces to a linear equation with 25 t δ 2 2 δ v 0 for f v 0 t is always real this implies that in such cases all points in the domain can be reached in a finite time this is a direct consequence of the fact that eq 6 can be reduced to a modified eikonal equation when f v 0 lolla and lermusiaux 2020 for the purposes of the simulation we consider a unit domain the start and the target positions are x s 0 25 0 30 0 40 and x f 0 70 0 65 0 80 with the vehicle traveling at a non dimensional speed of 0 1 units the external velocity field is given by v 0 0 050 0 075 0 065 hence v 0 0 11 f and the pde is not eikonal the theoretical optimal time computed using eq 24 for this setup is 3 377 our discretization for this benchmarking example consists of a 100 100 100 grid and a time step of 5 1 0 3 we use the finite volume method with the 5th order weno scheme for spatial gradients and tvd rk3 scheme for time marching see appendix b the computed optimal time is 3 375 which is only off from the true value by 0 059 this amount is extremely small and due to small truncation errors resolution in time and space and common computational inaccuracies round off errors etc the computational times required for the forward evolution and the backward tracing of the optimal path were 24 s and 1 03 s respectively for uniform advective velocities the zero level set grows as a sphere with radius r f t and is also advected along the velocity direction that is the center of this sphere lies at x c t v 0 this is clearly seen from fig 5 where the zero level set evolves as a sphere and moves along the direction of the velocity it can be shown that the optimal path is a straight line joining x s and x f as is observed 5 2 validation in spherical vortical flow we now consider a pulsating vortical flow to benchmark the accuracy of the optimal trajectory and travel time of our path planning the flow field is a sinusoidally pulsating version of the velocity field generated from the stream function for the rossby haurwitz benchmark problem for the shallow water wave equations williamson et al 1992 as reported in townsend et al 2016 it is defined in spherical coordinates by eq 26 where r is the radial coordinate with unit vector r ˆ λ π π is the azimuthal angle with unit vector λ ˆ θ 0 π is the polar angle with unit vector θ ˆ and s is the gradient in spherical coordinates 26 v r λ θ t r ˆ s ψ r λ θ t where ψ r λ θ t cos 2 π t t cos θ sin 4 θ cos θ cos 4 λ fig 6 shows this flow field plotted at t 0 on a sphere of r 1 the velocity field is v r λ θ t v λ r λ θ t λ ˆ v θ r λ θ t θ ˆ the flow field has no component in the radial direction and all the radial motions of the vehicle are thus due to its own propulsion we utilize this fact to design a suitable test case to benchmark our 3d method specifically we choose the destination of the vehicle for a given start location and travel time such that the analytical vehicle propulsion is always radially outwards let us assume that the vehicle starts at location x s r s λ s θ s and requires a to be determined travel time of t fixed to reach a given destination x f r f λ f θ f we assume that the vehicle can move isotropically and with a maximum speed f the to be optimized velocity of the vehicle relative to the flow field is f t h ˆ t f r t r ˆ f λ t λ ˆ f θ t θ ˆ with f r t 2 f λ t 2 f θ t 2 f 2 the trajectory ode of such a vehicle is thus 27 d x t d t f r t r ˆ f λ t v λ r λ θ t λ ˆ f θ t v θ r λ θ t θ ˆ separating the components of eq 27 we have r f r t r sin θ λ f λ t v λ r λ θ t and r θ f θ t v θ r λ θ t upon integrating the radial component we obtain 28 r s r f d r 0 t f r t d t 0 t f d t r f r s f r t t r s f t from eq 28 we can set r f r s f t λ f θ f still to be selected which implies that the optimal vehicle will have to move radially outwards with speed f at all times as any other choice will yield a larger travel time as f r t f this implies f λ t f θ t 0 the other two components of the trajectory eq 27 the coordinates λ f and θ f are thus defined by 29 λ v λ r λ θ t r sin θ v λ r s f t λ θ t r s f t sin θ θ v θ r λ θ t r v θ r s f t λ θ t r s f t as designed the optimal travel time between the chosen start point x s and the destination x f is t the vehicle always travels radially outwards with the maximum allowable speed f the optimal trajectory x t r t λ t θ t t 0 t can thus be semi analytically computed using eq 29 in 30 this completes our benchmark problem definition to be specific we choose the start location to be x s 0 1 0 π 4 the travel time t 0 9 and the vehicle speed f 1 this implies that the exact destination x f has the radial coordinate r f 1 0 integrating eq 30 its azimuthal and polar coordinates are found to be λ f 0 9754 π and θ f 0 2277 π to evaluate our numerical integration of the forward level set pde 6 and backward ode 7 we now compare the computed optimal travel time with its theoretical value t and the computed optimal trajectory with its exact optimal trajectory obtained by the semi analytical integration of eq 30 the 3d path planning problem to be solved using the level set methodology is thus to predict the optimal trajectory for a vehicle with maximum speed f 1 that is traveling from x s 0 1 0 π 4 to x f 1 0 0 9754 π 0 2277 π under the external dynamic velocity field v r λ θ t given by eq 26 we solve this problem on a domain ω 2 2 2 2 2 2 using the finite volume method with 200 grid points in each direction and a numerical time step of δ t 0 001 a 5th order weno scheme is used for spatial gradients and a tvd rk3 scheme for time marching see appendix b as the external velocity field has no radial component the reachability front grows as a sphere with its rate of radius increase being f 1 not shown the computational time required is found to be 341 09 s for this forward evolution of the reachability front and 1 34 s for backtracking the time optimal path the optimal time required for traveling from x s to x f is predicted to be t 0 902 which is extremely close to the exact value of t 0 9 with a relative error of 0 22 fig 7 compares the semi analytical trajectory integrating eq 30 using the forward euler method and a time step of δ t 0 001 to the level set computed backtracked trajectory in 3d and their components along the x y and z axes we find that the computed trajectory is also extremely close to the semi analytical trajectory at all times in all the coordinates 5 3 application in three dimensional analytical double gyre shear flow we now verify schemes with the analytical double gyre flow that is a periodic unsteady and divergence free velocity field shadden et al 2005 froyland and padberg 2009 note that this model is not a real fluid flow in that it is not obtained as a solution to the navier stokes pdes but is a simplification of the double gyre pattern that frequently occurs in geophysical flows coulliette and wiggins 2001 lolla et al 2014b subramani and lermusiaux 2016 we consider this flow in the domain 0 2 0 1 0 1 the classic double gyre is a two dimensional flow in space whose non dimensional velocity field is analytically described by 31 v x π a sin π f x cos π y v y π a cos π f x sin π y d f d x where 32 f x a t x 2 b t x 33 a t ϵ sin ω t 34 b t 1 2 ϵ sin ω t to create a 3d flow field from eq 31 we add an unsteady parabolic velocity profile for the z direction that bears positive values in the region of the first gyre and negative values within the other gyre specifically the z velocity is given by 35 v z x y 2 x 1 y 1 ϵ sin ω t x the velocity field is depicted in fig 8 the parameters used are a 0 1 ϵ 0 1 ω π 5 the vehicle speed is set to 0 05 and a 200 100 100 grid with a time step of 5 1 0 3 is used in a finite volume setup with the 5th order weno scheme for spatial gradients and tvd rk3 scheme for time marching see appendix b this example demonstrates a one to all broadcast where multiple vehicles leave from the same start point in order to travel to different target locations with our pde approach such a broadcast only requires one level set evolution per start point and hence it is computationally advantageous the zero level set is evolved from the start point until all the destination positions lie on or inside it the time at which the reachability front crosses a particular destination position is noted and the optimal path is backtracked from this stored time until the start time hence increasing the number of target positions only increases the cost of the backtracking ode computation which is much less than that of the forward evolution pde specifically the forward evolution of the reachability front required 82 33 s whereas the backward tracing of the three optimal paths required 0 87 s green 1 41 s orange and 1 56 s red respectively fig 9 shows the predicted optimal paths to be followed by the vehicles to reach the respective destinations in shortest time it is clear that the vehicles utilize the background flow field to their advantage even though they travel much longer distances as compared to straight line paths they do so at a higher effective speed thus reaching in shortest time 6 applications in three dimensional realistic oceanic flow fields this section integrates realistic ocean modeling and time optimal path prediction for common types of marine vehicles operations are planned for the complex four dimensional time space ocean flow fields of the middle atlantic bight region three types of marine vehicles are considered i vehicles with isotropic propulsion ii vehicles with anisotropic speeds specifically oceanic floats that can propel vertically by adjusting buoyancy but are advected in the horizontal rudnick et al 2004 and iii typical marine gliders that perform a vertical sinusoidal yo yo motion which reduces the path planning problem to a two dimensional one as shown in section 3 we first describe the 3d regional dynamics our data assimilative multi resolution ocean modeling and our computational time optimal path planning setup we then describe the evolution of the reachability front for these vehicles highlighting how the underlying dynamic flow features affect this evolution finally we analyze the actual time optimal paths and show how each type of optimal vehicle intelligently utilizes the currents most beneficial and avoids the most adverse in accord with its type 6 1 ocean modeling and oceanography the middle atlantic bight region off the coast of new jersey offers a variety of flow features interacting on multiple scales linder and gawarkiewicz 1998 lozier and gawarkiewicz 2001 lentz 2008 wilkin et al 2018 kelly and lermusiaux 2016 they include the gulf stream shelf break front coastal jets tidal currents internal tides and also hudson river outflow such conditions provide challenging environments for autonomous missions fig 10 shows the simulation domain overlaid on bathymetry from 37 56 n to 40 99 n and 73 97 w to 70 54 w the white circle and the star denote the start 37 90 n 72 22 w and target positions 39 85 n 72 30 w for our planning missions respectively both positions at the surface the multi scale ocean dynamics in this region is simulated using the mit multidisciplinary simulation estimation and assimilation system mseas haley jr and lermusiaux 2010 haley jr et al 2015 mseas is used for fundamental research as well as realistic applications such as monitoring lermusiaux et al 2007 real time ecosystem and acoustic predictions beşiktepe et al 2003 xu et al 2008 lermusiaux et al 2011 and environmental management cossarini et al 2009 the specific currents used for path planning are from a data assimilative mseas re analysis for august 28 2006 up to september 9 2006 haley jr et al 2015 subramani et al 2017a the data were collected as a part of the shallow water 06 sw06 initiative whoi 2006 lermusiaux et al 2006a newhall et al 2007 tang et al 2007 chapman and lynch 2010 lin et al 2010 mseas solves the nonlinear free surface hydrostatic primitive equation pe configured with generalized level vertical coordinates and implicit two way nested computational domains haley jr and lermusiaux 2010 in the horizontal the domains have a 3km and 1km grid resolution respectively and in the vertical they each employ 100 levels optimized to the thermocline and flow structures the tidal to mesoscale ocean re analysis is initialized with objectively analyzed temperature salinity and velocity fields for aug14 2006 two multiscale in space analyses lermusiaux 1999 2002 inshore and offshore of the expected shelfbreak front are combined using a shelfbreak front feature model lermusiaux 1999 gangopadhyay et al 2003 the gulf stream is initialized using synoptic and historical ctd profiles as well as estimates of its position based on sst and navoceano feature analyses high resolution barotropic tides logutov and lermusiaux 2008 based on the tpxo7 2 surface tide velocities and elevation egbert and erofeeva 2002 for aug14 2006 are merged with the subtidal initial fields following haley jr et al 2015 the re analysis free surface pe simulation is then integrated for 42 days during integration the ocean data collected during the awacs and sw06 exercises tang et al 2007 as well as data of opportunity nmfs etc are assimilated finally the numerical and sub grid scale parameters are tuned for the region by comparison of many pe simulations with independent in situ sw06 measurements 6 1 1 ocean flows and regional dynamics in the present period we observe that the optimal paths for the auv with isotropic speed and the float go down to a maximum depth of 22m the float travels deeper but for an extremely short duration and hence we focus on the top 20m of the ocean flows over the considered time of interest figs 11 12 and 13 plot the daily averaged horizontal currents at 0m 10m and 20m depth respectively also shown are the daily position of the isotropic auv pink circle denotes the current position i e position on the considered day at 00 utc whereas the gray circle s denote the horizontal position s of the vehicle on the past day s note that this is simply the horizontal location of the vehicle i e discarding depth the vehicle may not be at the particular depth at the considered instant we also plot the daily averaged horizontal currents depth averaged over the first 90m in fig 14 this is effectively the flow field experienced by the glider performing sinusoidal yo yo motion the daily position of the glider and its history are denoted in pink and gray similar to the previous figures the gulf stream is clearly seen in the southeast corner of the domain at all depths as well as the depth averaged fields with velocities reaching 2 m s the meandering shelfbreak front jet flowing to the west southwest and close to the 100m isobath is also visible lermusiaux 1999 linder and gawarkiewicz 1998 especially in fig 14 on august 28 figs 11 a 12 a 13 a 14 a there is a northeast to southwest jet just north of the gulf stream with speeds up to 25 cm s this flow is almost non existent at the surface but gets stronger with depth there is also a local northward flow between the gulf stream and the said jet locally at the mission start point on the shelf the surface flow reverses due to southwestward winds on august 29 developing first along the coast of long island and intensifying to a midshelf westward southwestward flow by august 30 as especially seen in the depth averaged velocities fig 14 b c and at the surface fig 11 b c we also find that the said northeast southwest jet strengthens at the surface and a bit deeper during this period and a cyclonic eddy feature develops north of the gulf stream near 38 9 n 71 9 w at depths of 10m onwards figs 12 b c 13 b c with its northern side linked to the south southwest shelfbreak front jet our vehicles take advantage of this eddy as will be shown in section 6 4 tropical storm ernesto passes over the domain during september 1 3 the operational region mostly sees the northeastern edge of the storm as it proceeds northward the ocean response is a northwestward flow at the surface 2 3 times stronger than on august 30 and shelf wide with intensification near the coast fig 11 e g due to 3d downwelling the flow changes direction with depth it is reversed to the south southwest at 20m figs 13 e g 14 e g after the storm the main flow on the shelf south of new jersey is generally southwestward parallel to the coast and shelfbreak it reaches a barotropic magnitude of 5 10cm s with currents decaying with depth this midshelf flow is a remnant of the shelf response to ernesto partly supported by a local cross shelf density gradient not shown that ernesto established on september 6 the shelfbreak front jet reaches a barotropic strength of 10 20cm s fig 11 j in part due to the minor wind event between 00 to 17 utc on that day finally weak density driven eddies and currents occur on the shelf during the whole period and affect the optimal paths 6 2 computational setup and simulation details our first example models auvs that can more or less propel in any direction at their operating speed we assume here that the vehicle has a maximum propulsion speed of 50cm s and a maximum allowable depth of 100 m which is well within the typical range of such vehicles rudnick et al 2004 haley jr et al 2009 ramp et al 2009 the second example looks at path planning for vehicles with heading dependent propulsion speeds and constrained motion section 3 1 particularly we consider a vehicle that can propel only in the vertical its motion in the horizontal plane is then only through flow advection most oceanic floats are able to maneuver this way wherein their vertical propulsion is a result of changing their effective buoyancy gould et al 2004 we assume that the float can travel at 10cm s vertically but with no propulsion in the horizontal directions and is allowed to travel at a maximum depth of 100 m we finally showcase an underwater glider that performs a sinusoidal yo yo motion as typical for ocean data collection fan and woolsey 2014 ramp et al 2009 haley jr et al 2009 leonard et al 2010 in our example we assume typical operational parameters to be similar to a seaglider rudnick et al 2004 the glider is assumed to slowly dive up to 90 meters in depth with subsequent up and down motions with a period of 4 h the average vertical speed is 1 25cm s in the horizontal plane the speed is assumed to be 50cm s stokey et al 2005 our 3d path planning numerically solves the exact non dimensional form of the forward hamilton jacobi level set eq 18 we employ the finite volume method on a grid of 128 128 50 elements in the longitudinal latitudinal and vertical directions respectively where each grid cell has an approximate size of 2 32km 2 98km 2m a time step of 6 min 360s is used we use the 5th order weno scheme for the spatial terms and the tvd rk3 for time marching in the case of partially known vehicle motion the 3d path planning problem reduces to a 2d one section 3 2 hence simulations are carried out on a 2d grid of resolution 128 128 elements with the rest of the computational setup being as above all the vehicles start their journey on august 28 at 00 utc from the same start location as stated above ref fig 10 the reachability front defined as the zero level set of ϕ is constructed by linear interpolation between grid points once the forward evolution of the reachability front is complete backward tracing of the optimal trajectory is computed using the fully implicit backward tracing schemes obtained in section 4 and further detailed in appendix c to compute this backtracked optimal path we need to compute the normal direction to the reachability front at certain locations appendix c describes the algorithm used to compute such normal directions at arbitrary locations on the reachability front table 2 summarizes the considered operating characteristics the optimal travel time results and the relevant figure numbers that contain the reachability front evolutions and optimal paths 6 3 evolution of the reachable sets isotropic auv fig 15 plots the growth of the zero level set the reachability front for the auv with isotropic propulsion we observe that the zero level set quickly reaches the deepest limit of the simulation domain and then evolves as a deforming and sloping curtain with clearly visible creases these variations of the curtain along the vertical happen due to the following reasons first the flow in this region is mainly dominated by surface tides wind driven flows and thermocline intensified currents and eddies this means that the variability of the horizontal velocities along the vertical direction is much smaller than the velocities themselves most horizontal motions have small and local reversals in the first 100m depth there are only a few regions and times where a flow reversal with depth is observed these phenomena prompt the zero level set to grow as curtains second the small variations and shifts of the zero level set with depth are further hidden by the skewed plot scales the x and y scales are in hundreds of kilometers whereas the z scale is in tens of meters in the deeper areas of the domain the evolving zero level set is abruptly halted and it forms a jagged surface parallel to the bottom this is because in these regions the zero level set is close to the sea floor we prohibit the zero level set from penetrating the sea floor as the vehicle cannot move inside land this is done by setting the advective velocity field v as well as the vehicle speed f v to zero at these depths which ensures that the optimal path never crosses through any land mass we observe that the initial reachable set for the auv is quickly advected northwards due to the local northward flow at the start point and hence fails to see the strong gulf stream currents over august 29 and 30 the reachability front grows due to the favorable flow on the east side of the cyclonic eddy that develops to the north of the gulf stream especially beyond 40m but is held back on the west side of this eddy this causes a crease like feature in the reachability front as seen in fig 15 c we can also see that the northeast southwest oriented jet north of the gulf stream pushes the reachability front out of the domain in the southwest corner finally the reachability front reaches the destination on august 31 2006 at 20 17 22 utc and the corresponding optimal travel time for this vehicle is 3 84 days vertical only propulsion float fig 16 shows the evolution of the zero level set for the float capable of slow vertical propulsion only the growth of the zero level set still locally stops at the sea floor or just before ensuring that the optimal path does not go through any land mass the evolution of the level set is comparatively slower and it takes longer for the float to reach the destination as the horizontal evolution of the reachability front is only due to oceanic flows it evolves faster in the region of faster ocean currents we find that the reachable set of the float is initially pushed to the northwest due to the local currents just north of the gulf stream the reachability front does not reach the entire depth at all locations as the float is slower than the isotropic auv ocean vertical velocities may thus prohibit the float from reaching all depths of the domain we initially observe low variation in the reachability front in the vertical but between days 5 and 7 5 fig 16 b c the reachability front grows much faster at the surface due to the favorable currents generated by tropical storm ernesto ernesto s impact is limited deeper the wind driven response thus generates major vertical variation in the reachability front growth much larger than that for the isotropically propelled auv by the time the float reaches the destination fig 16 d glider finally for a glider performing a sinusoidal motion in the vertical the projected reachable set evolution is solved as a 2d problem and the projected reachability front evolved as a 2d parametric contour if some of the points on this contour are within a tolerance of the ocean floor or surface at some particular time the propulsion of the glider is then reversed only at these points the vehicle can continue to move in the same direction at all other points until it either reaches the tolerance to the bottom or the maximum allowable depth or surface the location and time data of points at which such reversal of direction occurs are kept in memory and enforced while backtracking the optimal path while planning paths for such vehicles with known vertical motion it might happen that the vehicle reaches the horizontal coordinates of the target but at a different depth in such cases one can assume that the vehicle can rise sink locally to reach the exact target depth this is what is done in the present example but one could of course continue the level set computation until both the horizontal coordinates and proper depth are reached 6 4 three dimensional time optimal paths we now examine the time optimal paths for the three different types of vehicles considered their characteristic features and how they related to the ocean flows experienced by these vehicles 6 4 1 vehicles with isotropic speeds fig 17 depicts the optimal path followed by the isotropically propelled auv which requires a total travel time of 3 84 days to compare in the absence of currents the vehicle would travel in a straight line joining the start and target positions and would require 4 97 days hence it is clear that the optimal auv can here make efficient use of the oceanic velocities to reach the target in the shortest amount of time initially the optimal auv is advected north by the local northward currents at the start point it then dives deeper as the northeast to southwest jet to the north of the gulf stream is strong near the surface on august 29 surface currents are small on august 28 but increase significantly by august 29 and hence the auv starts to dive it is clear in fig 17 b how the auv navigates around the southwestward currents north of the gulf stream by august 30 and 31 the auv sails northward using the favorable flow on the eastern side of the cyclonic eddy figs 12 c 13 c that develops to the north of the gulf stream beyond 10m depth around august 31 the auv starts rising as the wind driven currents around 10m depth are northwestward and favorable fig 12 d while those at the surface and 20m are westward or southwestward and not favorable figs 11 d 13 d finally the impact of the tropical storm ernesto causes favorable surface currents from september 1 onwards and hence the auv rises to utilize these flows and ultimately reach the destination another interesting observation relates to the spacing between daily vehicle positions figs 11 a d 12 a d 13 a d it shows that the auv travels more on the second day than on the first and even more on the third and fourth days this is because on the first day and a part of the second day the auv is traveling against southwestward currents however once out of this adverse currents region it utilizes the favorable currents eastern edge of the cyclonic eddy and those driven by ernesto on days 3 and 4 and thus travels larger distances the computational time required for the forward evolution of the reachability front for the isotropic auv is 109 2 min for the numerical schemes of section 4 whereas the time required for backward tracing of the optimal path is 38 s as expected the computational time required for backward tracing is much less than that required for the forward evolution as one only solves an ode in backtracking the optimal path whereas a pde is solved on the entire 3d domain for the forward evolution importantly since the optimal travel time is 3 84days such exact pde path planning can be completed in real time 6 4 2 vehicles with anisotropic speeds for vehicles with constrained motion we resort to an offline maximization table to compute the optimal propulsion term as described in appendix b fig 18 shows the optimal path to be followed by the float propulsion only in the vertical direction the float is much slower than the isotropic propelled auv with a total travel time of 9 53 days this is expected as the float does not have any horizontal propulsion of its own further we can tune a tolerance parameter of the vehicle ref appendix b such that unless a major event happens the float tends to stay at the same depth the float initially dives to avoid adverse southwestward currents at shallow depths north of the gulf stream see fig 11 and utilizes west northwestward currents around the start point at 20m depth on august 29 and 30 it advects east northeastward with a favorable current that is present at 20m depth just to the north of the gulf stream see fig 13 b c however this current changes direction around sept 1 due to tropical storm ernesto and the float thus dives deeper down to about 45m to avoid the effect of this adverse change on september 2 and 3 tropical storm ernesto induces favorable velocities at the surface thus the float quickly rises to the surface to capture these currents deeper velocities on these days are unfavorable note that such frequent dives can be eliminated to respect the limits on the functional characteristics of the specific float by setting the appropriate value of a tolerance parameter of the float ref appendix b finally post ernesto the current magnitudes and variations are typically small and hence the float does not perform any vertical motion and is simply advected to reach the target the computational time required for the forward evolution of the reachable set and backtracking the optimal path for the float is 188 6 min and 32 s respectively the forward evolution takes longer than that of the isotropic auv because even though the cost per time step is comparable the float simply takes longer to reach the destination 9 53 days leading to higher a computational expense 6 4 3 vehicles with partially known motion for vehicles with partially known motion we solve for the 2d projection of the forward 3d reachable front to backtrack the full 3d optimal path we thus add back the deterministic displacement due to the vertical motion of the vehicle to the optimal projected path being backtracked in 2d fig 19 shows that 3d optimal path as predicted for a glider performing a sinusoidal yo yo motion the time for this journey is 4 15 days almost 25 dives which is slower than for the auv with isotropic speed but much faster than for the float this is expected as we impose no constraints on the motion of the auv in the first case whereas stricter constraints are enforced on the float motion note that for the last dive the glider is also close to the sea floor and hence it terminates the dive earlier in order to not collide with the bottom the optimal path qualitatively follows a pattern similar to isotropically propelled auv but with larger deviations from horizontally straight lines from fig 19 b we find that the glider initially utilizes the northern edge of the gulf stream to move eastwards and so avoid the large patch of southwestward currents just to the northwest from august 31 to september 1 it then advects north to hop on the moderately strong north to northwestward flow part of the eddy finally when just to the south of the target it leaves this flow which is now westward early on september 2 and travels north to reach the target similar to the isotropically propelled auv we can draw interesting remarks by looking at the spacing between the daily glider positions fig 14 a d the glider covers a large distance on the first day but travels a smaller one on the second this is because it utilizes the favorable gulf stream to initially travel east but then has to cross the southwestward jet only using its own speed it later travels large distances again on the third day this time by utilizing the north to northwestward eddy finally it covers a moderate distance on the fourth day i e more than day 2 but less than days 1 and 4 to finally reach the destination for the glider with a sinusoidal motion in the vertical it takes 4 9 min to solve the level set pde to compute the forward evolution of the reachability front and 52 s to compute the time optimal path by backward tracing when compared to the corresponding computational times for the isotropic auv 109 2 min for forward evolution 38 s for backward tracing we can clearly see that the forward evolution for the glider is much faster because the level set pde is now only solved in 2d instead of 3d however the backward tracing for the glider takes slightly longer as one needs to compute the contribution in the horizontal and the vertical and then combine them to yield the optimal travel direction of course the marginal cost increase in solving the backtracking ode is overshadowed by the significant gain in the solving the forward evolution pde fig 20 shows a top view of the optimal trajectories for the isotropic auv float and glider we find that the glider with its forced yo yo motion in the vertical between 0 and 90m makes the most use of the gulf stream the auv and float no such forced motion remain mostly at shallower depths and utilize favorable dynamic eddies meanders and sub surface currents to the north of the gulf stream to optimally reach the destination the float avoids the gulf stream in part to avoid challenges escaping it which would prevent reaching the target in fastest time if at all since the float can only move up and down 7 conclusions in this paper we first developed the theoretical foundations and practical aspects of exact time optimal path planning in 3d realistic ocean fields with strong and dynamic currents specifically we provided new extensions for the exact and efficient computation of optimal paths for commonly employed marine vehicles respecting their motion constraints we considered three main classes of propulsion behaviors unconstrained isotropic anisotropic and partially imposed for the latter two motions we specialized the exact reachability pde lolla et al 2012 lolla 2016 lolla and lermusiaux 2020 to vehicles that can propel only in certain directions e g only vertical propulsion or that have partially known motions e g forced yo yo motions respectively we showed that the 3d problem can be reduced to two dimensions if the motion of the vehicle is partially known such as gliders performing deterministic oscillatory vertical motions or propelled auvs forced to use specific patterns in the horizontal as a result the computational cost is reduced significantly second we obtained robust numerical schemes to solve the path planning equations consistently and with high accuracy in realistic 3d ocean domains since these domains have length and velocity scales that are much smaller in the vertical than the horizontal even small numerical errors along a certain dimension may have drastic consequences along the other dimensions to overcome this ill scaling we obtained the non dimensional form of the hamilton jacobi level set equation we next emphasized the new concept of numerical consistency between the discrete forward evolution of the reachable set and discrete backward tracing of the optimal path we discussed high order spatial and temporal numerical schemes for the forward evolution of the zero level set function and developed novel consistent implicit schemes for the backward tracing of the optimal path third we applied our schemes to analytical and realistic flows integrating ocean modeling with 3d path planning with motion constraints we validated the theory verified schemes and benchmarked accuracy using three analytical 3d flows numerical discretization errors were quantified by comparison to the analytically optimal paths and durations the capability of correctly handling dynamic 3d flows was confirmed using the data assimilative ocean currents of the mseas primitive equation modeling system in the middle atlantic bight region reachability fronts and optimal trajectories were predicted and analyzed for three classes of marine vehicles namely propelled auvs floats and gliders we described the regional ocean dynamics and the evolution of the reachability fronts in response to the instantaneous dynamic currents and propulsion characteristic of each vehicle type we found that the effects of 3d multiscale ocean currents on the actual optimal paths chosen by the vehicles were significant and that the vehicles tried to best utilize the favorable flow features while avoiding the adverse flows for such paths ocean forecasts should be employed for real time planning of efficient autonomous missions from optimal pick up and deployment to monitoring and adaptive data collection in the future since the 3d path planning pde and ode are exact they can be employed in any regions and dynamics e g low order flows such as in the sargasso sea vertically complex flows such as in equatorial regions strong and complex 3d flows such as in estuaries or in regions with physical obstacles lolla et al 2015 subramani et al 2017b numerically to further reduce the computational cost of the reachable set evolution the narrow band level set method adalsteinsson and sethian 1995 lolla 2016 lolla and lermusiaux 2020 could be utilized in 3d in that case only the values of the level set function that are strictly needed in the vicinity of the zero level set are computed another possible future direction is to study energy optimal paths or optimal paths in stochastic environments for such marine vehicles subramani et al 2017a 2018 subramani and lermusiaux 2019 finally onboard routing can be implemented using the developed theory and framework lermusiaux et al 2016 vehicle positions could be assimilated to correct the predicted advective velocity field and a modified optimal trajectory could be computed online from the real time position of the vehicle credit authorship contribution statement chinmay s kulkarni conceptualization methodology software pierre f j lermusiaux conceptualization methodology declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments we thank the members of our mseas group for insightful discussions we also thank the four anonymous reviewers for their useful comments we are grateful to the office of naval research united states of america for support under grants n00014 14 1 0476 science of autonomy learns and n00014 15 1 2616 dri nascar to the massachusetts institute of technology mit united states of america the mseas sw06 awacs 06 ocean re analyses employed were made possible by research support to mit from onr united states of america under grants n00014 11 1 0701 muri ioda and the national science foundation united states of america under grant oce 1061160 we thank all of our sw06 and awacs 06 colleagues especially g gawarkiewicz p abbot and t duda for their ocean data and m taylor and j hare for their nmfs survey data we also thank j evans s glenn and j wilkin for their real time wrf atmospheric fluxes and the fnmoc teams for their products appendix a theoretical results on the reachability set evolution in what follows we state the evolution of the reachability front governed by a hamilton jacobi equation specifically the following theorem provides the evolution of the reachable set by means of a pde and the optimal vehicle heading function that minimizes the total travel time the result is related to the principle of minimum action here time of classical mechanics theorem let v x t be a lipschitz continuous and bounded velocity field in all its arguments denote the set of permissible unit heading directions by h which is a subset of r 3 let the maximum vehicle speed f h ˆ t h 0 r be lipschitz continuous in all of its arguments we assume that the possible vehicle trajectories x t are governed by eq 1 with initial condition x 0 x s then the evolution of the reachability front is given by the zero level set of the function ϕ r 3 0 r where ϕ x t is the unique viscosity solution of the following equation a 1 ϕ t max h ˆ f h ˆ t h ˆ t ϕ v x t ϕ 0 with the initial conditions a 2 ϕ x 0 x x s the optimal arrival time t x f x s 0 satisfies a 3 t x f x s 0 inf t 0 t ϕ x f t 0 the optimal trajectory or trajectories x t is given by the characteristic lines of eq a 1 that is x t satisfies the following equation a 4 d x d t f h ˆ t h ˆ t v x t where a 5 h ˆ t arg max h ˆ f h ˆ t h ˆ t ϕ we refer to lolla and lermusiaux 2020 and lolla 2016 for the proof of this theorem remarks it is assumed that the external velocity field v x t is deterministic in real ocean applications the forecast fields are always associated with some uncertainty lermusiaux 2006 lermusiaux et al 2006 however the present results can be utilized to predict a sample path for a specific velocity realization or the path corresponding to the mean or the mode of the velocity field in such cases recent results by wei 2015 subramani et al 2018 and subramani and lermusiaux 2019 are indeed build upon such ideas to predict and study time optimal paths in stochastic flow environments in this work we only seek time optimality in many cases optimality in some other objective function such as energy spent quality of data collected etc may be desired the present results can be extended to optimize a general objective function that depends on the travel time followed trajectory and possible other parameters we refer the reader to subramani and lermusiaux 2016 for energy optimization and to lolla 2016 for computing optimal sampling locations in subramani et al 2018 and subramani 2018 risk optimal trajectory is studied depending on the whether the user is risk seeking risk neutral or risk averse for the case where the vehicle has a heading independent isotropic speed we have f f h ˆ x t this simplifies eq a 1 to yield eq a 6 a 6 ϕ t f ϕ v x t ϕ 0 further the optimal headings in this case are given by eq a 7 which are just the local outward normals to the reachability front a 7 h ˆ t ϕ ϕ appendix b numerical schemes for the forward reachable set evolution advection term the numerical schemes discretizing the advection term utilize the given velocity field explicitly and find suitable approximations for ϕ by using the sign of this known velocity field essentially non oscillatory eno schemes and their extension to weighted essentially non oscillatory weno schemes for hamilton jacobi equations shu and osher 1988 jiang and shu 1996 with up to 5th order accuracy are used to in the present work the general unsteady hamilton jacobi equation only contains at most the first derivatives of the unknown function ϕ crandall and lions 1983 osher and fedkiw 2006 and eno and weno schemes provide accurate estimates handling of anisotropic speeds if the propulsion speed of the vehicle depends on the direction of travel the optimal propulsion term is given by b 1 max h ˆ x t f h ˆ t h ˆ x t ϕ this in general cannot be reduced further in order to compute the contribution of this term a maximization is required to be performed at each point in the domain at all times we discuss some approaches to solve this maximization problem the most general way to solve the maximization is to construct a look up table prior to the forward evolution lolla 2016 lolla and lermusiaux 2020 this table holds the optimal heading directions for all possible reachability front gradient directions that is given the local outward normal ϕ x t ϕ x t the table returns the maximum value of the optimal propulsion term and the corresponding h ˆ x t required for backward tracing of the optimal path if the vehicle is permitted to only travel along certain directions then the maximum is calculated over all the directional derivatives along the permitted directions care needs to be taken in making sure that the discretization for computing the optimal heading is consistent with the grid discretization otherwise unfavorable errors may be introduced such a maximization can also be performed after every time step while the forward evolution of ϕ is being carried out this is called online maximization in this case the optimal heading direction is computed at each point and at each time by testing all permissible heading directions and choosing the maximum often offline maximization is computationally favorable especially when the speed does not vary with time as the propulsion term is only required to be computed once per heading direction if the maximum speed varies with time then the online maximization may prove to be more efficient as in such a case the offline table has to be separately constructed for each time tolerance parameter for discrete anisotropic speeds for vehicles with propulsion speeds that are only in specific discrete directions e g only up or down a tolerance parameter to limit the frequency of direction switch can be needed this is to avoid an optimal path with too many oscillations this occurs if the optimal propulsion term is close to zero or if it frequently flips signs these oscillations may not always be sufficiently accurate sub grid scale process or numerical diffusion effects and an actual marine vehicle typically should avoid such quick movements if such oscillations occur a simple approach to eliminate them is to use a tolerance parameter that is we then only consider the contribution due to the optimal propulsion term if its magnitude is larger than some tolerance value τ the value of τ controls the amount of switches in discrete propulsion direction in the optimal path of course setting this value to be too high can cause the path to deviate from optimality time marching all the temporal schemes used are total variation diminishing runge kutta tvd rk with up to 3rd order accuracy gottlieb and shu 1998 osher and fedkiw 2006 tvd rk schemes guarantee that no spurious oscillations are produced due to the temporal discretization as long as no spurious oscillations in time are produced with the forward euler scheme which is the building block of these schemes the first order accurate tvd rk scheme is just the standard forward euler time marching scheme whereas the second order tvd rk scheme is heun s method the reader is referred to osher and fedkiw 2006 for the details of the third order accurate tvd rk time marching appendix c numerical schemes for the backward tracing of the optimal path the optimal path is obtained by solving the ode given by eq c 1 backward in time c 1 d x d t v x t f h ˆ x t with the initial condition x t t x f x s 0 x f for the case of vehicles with isotropic speeds the optimal heading h ˆ x t is given by the local normal to the reachability front at the location x at time t for vehicles with anisotropic speeds the maximization table is used wherein the local normal direction is given as an input to obtain the optimal hading direction hence in either cases efficient computation of the normal direction to the reachability front in three dimensions is required computation of normals the reachability front is represented by multiple triangular surfaces for curved surfaces see ueckermann and lermusiaux 2010 the vertices of all these triangles along with the corresponding connectivity matrix are stored the procedure to compute the normal direction to a general surface is as follows 1 the triangle to which the given point belongs is found out 2 the normal direction to the plane of this triangle is computed by calculating the cross product of the edge vectors this normal is placed at the centroid of the triangle 3 normal directions at the vertices of this triangle are computed for each of the vertex points the normals to all the triangles that have the said point as a vertex are first computed as shown in fig c 21 the normal direction at this vertex is then given by a weighted combination of the constituent triangle normal directions where the weights are proportional to the angle subtended by the corresponding triangle at the concerned vertex 4 once the normals at each of the vertices and the centroids are computed the normal at the given point is computed by a weighted average of these 4 normals where the weights are proportional to the distance between the given point and the location of the normal backtracking schemes we now derive various backtracking schemes that are numerically consistent with the corresponding forward evolution schemes we only discuss the schemes for vehicles with isotropic speeds the extension to vehicles with anisotropic speeds is straightforward through the use of the maximization table as mentioned before since the forward evolution is explicit all these backtracking schemes of optimal paths are implicit and iterative solves are required at each time step our naming convention is such that the references to the backtracking schemes are made by the corresponding forward evolution schemes for example the backtracking scheme corresponding to the forward euler temporal evolution of the pde is referred to as the forward euler backtracking scheme hence even though the name of the backtracking scheme suggests explicit nature they indeed are implicit we use the superscript to represent the iteration number at a specific temporal instant the time is indicated in index form indexed with an interval of δ t and denoted as a subscript the stopping criterion used for all the schemes is given by eq c 2 where ε is a small number typically of the order of the smallest cell size c 2 stop if x k 1 x k ε forward euler backtracking this first backward tracing scheme mimics the forward euler scheme for the evolution of the level set function and serves as a building block for the higher order schemes c 3 x p k 1 x p 1 δ t f h ˆ x p k p δ t v x p k p δ t as we are solving eq c 3 backwards in time the value of x p 1 is known a priori and the normal h ˆ x p k t is computed by the method described above note that x p k may not in general lie on the zero level set of ϕ x p δ t in such cases the normal is computed by taking the projection of this point onto the closest constituent triangle of the zero level set surface for convenience in the forthcoming parts we define an operator b as c 4 b x p k p δ t f h ˆ x p k p δ t v x p k p δ t tvd rk2 backtracking eq c 5 describes the implicit backtracking scheme mimicking the tvd rk2 scheme for forward evolution c 5 x p k 1 x p 1 δ t b x p k 1 2 δ t b x p k p δ t p 1 2 δ t this scheme may be initiated similarly to the forward euler backtracking scheme with x p 0 x p 1 note that b is the euler building block and two computations of the forward euler building block are required per iteration doubling the computational cost per iteration tvd rk3 backtracking finally we obtain the backward tracing scheme corresponding the tvd rk3 forward evolution scheme eqs c 7 and c 9 are the iterative equations of this tvd rk3 backward tracing the optimal trajectory backtracking equation corresponding to the present step is c 6 x p 1 1 3 x p 2 3 x p 3 2 c 7 x p 3 x p 1 2 x p 3 2 even though we obtain x p without an iterative solve we require the value of x p at intermediate times which requires an iterative solve from tvd rk3 forward marching scheme we know that c 8 x p 3 2 x p 1 2 δ t f h ˆ x p 1 2 p 1 2 δ t v x p 1 2 p 1 2 δ t hence c 9 x p 1 2 k 1 x p 3 2 δ t b x p 1 2 k p 1 2 δ t in order to initialize this scheme we set x p 1 2 0 x p 3 2 similar to the earlier schemes eq c 7 is not iterative and hence does not require any initialization 
23961,in this study we present model results derived from the tsunami current benchmarking workshop held by the nthmp national tsunami hazard mitigation program at portland oregon us in february 2015 for the two benchmark problems dealing with field data in this workshop the tsunami hysea model was used to perform the five proposed numerical benchmarks the other three benchmarks which are based on lab data are the subject of a related paper macías et al 2020 the results and comparisons with measured data for the two benchmarks which deal with field observations described in the present paper include 1 benchmark 2 impact of tsunami waves at hilo harbor hawaii and 2 benchmark 3 tsunami currents at tauranga harbor new zealand both for data of the 2011 tohoku tsunami the numerical results demonstrate that the tsunami hysea model is able to accurately reproduce sea surface elevations and current velocities for both the benchmark problems performed in a reduced local domain as in the case of the complete scenario modeled from the source to hilo harbor on the pacific ocean keywords model benchmarking tsunami currents tsunami hysea nthmp field data 1 introduction the tsunami modeling community has focused most of its effort on modeling wave height and runup as the key components of tsunami hazard assessment and model validation has been mostly restricted to these variables nicolsky et al 2011 nthmp 2012 and references therein tolkova 2014 horrillo et al 2015 and many others on the other hand studies focused on modeling the effects of tsunami currents or devoted to model validation for tsunami currents are less common lynett et al 2014 nevertheless the impact caused by the strong currents that typically accompany a tsunami is of key importance in ports bays and harbours it is even important with regard to streets in between buildings for larger tsunamis as in onagawa during the 2011 tohoku tsunami besides water height the ability to compute and predict tsunami flow velocities has revealed of great importance in risk assessment and hazard mitigation model results are increasingly being used to estimate damage to coastal infrastructure and therefore understanding the accuracy and precision of velocity predictions for tsunami currents becomes of undeniable importance nonetheless until recently a benchmarking based on velocity current observations was difficult to perform as few direct measurements of tsunami velocities existed to compare with the model results this has changed since the 2011 tohoku tsunami as many current meters were deployed in several locations around the pacific however despite the deployment of these current meters the numerical results and comparisons presented here and during the workshop revealed some deficiencies in these observed data in particular in the frequency of sampling which do not allow a completely satisfactory comparison with the numerical results being aware of this need for validation and verification and also aware of the lack of model benchmarking for tsunami currents the national tsunami hazard mitigation program nthmp decided to implement a benchmarking procedure to evaluate nthmp approved models for current predictions the previous benchmark tests mandated by the nthmp focused on wave height and runup nthmp 2012 to fulfill this new mandate a benchmarking workshop was organized in february 2015 in portland oregon http coastal usc edu currents workshop called nthmp mms benchmarking workshop tsunami currents for this workshop five different benchmark problems were proposed including lab measured datasets and observed data the first two benchmark problems were mandatory for all participating modelers models with the remainder of the tests being optional benchmarks 1 4 and 5 were based on lab measured data and are the subject of another paper macías et al 2020 bp2 proposed the simulation of a field case for the hilo harbor hawaii usa during the 2011 tohoku tsunami the third test dealt with the impact of the 2011 tohoku tsunami on tauranga harbor new zealand with the aim of including the effects of tides the edanya group www uma es edanya from the university of málaga participated in the workshop with the tsunami hysea model and presented numerical results for all five of the benchmark problems proposed as output of the workshop a model inter comparison study was elaborated lynett et al 2017 and a report containing results from all models was produced nthmp 2016 in the present work the numerical results obtained with the tsunami hysea model for the two benchmark problems based on field data are described and compared by the provided observed data this paper is outlined as follows section 2 describes the numerical model equations and numerical aspects sections 3 and 4 describe the two benchmark problems and present the numerical results obtained with the tsunami hysea model for hilo harbor and tauranga harbor respectively section 5 concludes the paper with some final comments and remarks 2 the tsunami hysea numerical model the open source tsunami hysea model edanya uma es hysea was used to perform the numerical simulations for the two benchmark problems considered in this work and based on field data different scenarios were simulated for both benchmarks based on field data the tsunami hysea numerical model combines robustness reliability and good accuracy in a model based on a gpu implementation that produces much faster than real time ftrt simulations in many configurations it has been rigorously tested and in particular it has passed all tests in synolakis et al 2008 along with other laboratory tests and proposed benchmark problems tsunami hysea has recently been approved february 2017 by the nthmp for tsunami hazard assessment studies in the us the numerical results submitted to the nthmp mapping and modeling subcommittee mms for obtaining this approval can be found in macías et al 2017 a comparison of tsunami hysea numerical results with the most model for the lantex 2013 scenario and tsunami impact on puerto rican coasts can be found in macías et al 2016 tsunami hysea implements the well known 2d nonlinear one layer shallow water system in both spherical and cartesian coordinates for the sake of brevity and simplicity only the cartesian system is written although the spherical coordinates version of the code is also used in the present study when large domains are considered h t q x x q y y 0 q x t q x 2 h g h 2 2 x q x q y h y g h h x s x q y t q x q y h x q y 2 h g h 2 2 y g h h y s y in the above set of equations h x t denotes the thickness of the water layer at point x d r 2 at time t with being d the horizontal projection of the 3d domain where the tsunami takes place h x is the depth of the bottom at point x measured from a fixed level of reference let us denote by q x t q x x t q y x t the mass flow of the water layer at point x at time t the mass flow is related to the depth averaged velocity u x t by means of the expression q x t h x t u x t the notation t x and y applies for temporal and spatial partial derivatives in the x and y directions respectively the terms s x and s y parameterize the friction effects and the manning law is used in this work i e s x g h m n 2 u x u h 4 3 s y g h m n 2 u y u h 4 3 where m n 0 is the manning coefficient for further details on the numerical method implemented in the tsunami hysea model can be found in macías et al 2020 the numerical implementation of tsunami hysea has been performed on gpu clusters de la asunción et al 2011 2013 castro et al 2011 and also includes nested grids macías et al 2016 2017 macías and ortega 2020 the benchmark problems as initially devised for the portland nthmp benchmarking workshop were named as local setup reduced scenarios with the source the input generating the tsunami described as a sea surface elevation time series to be imposed close to the coast additionally complete scenario simulations from the physical source were encouraged in the case of hilo harbor in that case bp2 we performed both the local setup and the complete scenario simulations and the model results were compared with observations in both cases for the complete scenario nested grids were used the gpu and multi gpu implementation and the use of nested grids allowed us to speed up the computations and perform complex simulations in very large domains much faster than real time macías et al 2016 2017 in this work we will present the figures for the wall clock time required for some of these simulations referring also to the size of the problems that are solved 3 benchmark problem 2 tsunami currents in hilo harbor the 2011 tohoku tsunami caused persistent oscillations and hazardous currents in coastal waters around hawaii that resulted in damage in harbors and marinas at the same time extensive current measurements were collected during this event in and around hawaii and estimates of tsunami induced currents were extracted from these measurements via spectral analysis cheung et al 2013 arcos and leveque 2015 the present benchmark test focuses on a smaller region around hilo harbor and proposes to conduct a model convergence test with respect to grid resolution the main goal was to assess the model s ability to simulate field scale tsunami currents under realistic grid resolutions used previously for tsunami propagation and inundation the aim of this benchmark is on understanding the importance of model resolution and numerics on prediction of tsunami currents in order to fulfill this objective some questions were proposed to modelers to be answered lynett et al 2017 1 what level of precision can we expect with regard to the simulated currents on real bathymetry 2 does your model converge with respect to velocity predictions as resolution is increased 3 what is the variation across different models using the same wave forcing resolution and bottom friction to answer this question was one of the main issues of this benchmark test in the inter comparison exercise performed at the end of it gathering the numerical results from all participants a paper was then produced containing the conclusions of such inter comparison lynett et al 2017 in order to get a more clear answer to these questions the field case was simplified providing a flattened bathymetry for depths greater than 30 m see fig 1 the dark blue area corresponds to this flattening this seems to contradict the aim of question 1 above but was done in order to get model results as similar as possible outside the protected harbor with inter model differences in the reproduced variables in particular tsunami currents resulting exclusively from differences in the shallow water region inside the harbor 3 1 model setup the computational domain is approximately a square of 7 by 7 km that in geographical coordinates covers the domain 204 90º 204 96º by 19 71º 19 773º in longitude and latitude respectively bathymetric data were provided in a lat lon mesh of 1 3 arcsec resolution 10 m in a 692 by 701 point mesh as mentioned above this problem has been reduced in an attempt to isolate differences in the employed incident wave forcing concerning the boundary conditions to be imposed a time series of offshore simulated free surface elevation at a control point in white in fig 1 located at 19 7576º 204 93º and marked as cp was provided to modelers fig 2 discontinuous black line this time series was generated as output of the neowave model therefore it is not given by observed data the proposed approach was that modelers may force their simulations in whichever way is convenient in order to obtain a modeled time series at the control point as close as possible to the provided data note that although this represents a new simplification aimed at reducing model differences up to this point it will lead to a physical mismatch between the simulated and the actual data in our case we chose to impose at the upper open boundary of the computational domain in fig 1 the same signal as the one provided for the control point which was the general common approach followed by all modelers no velocity correction is used and the velocity is therefore set to zero along the boundary in the eastern boundary transparent boundary conditions are imposed in the upper panel of fig 2 a comparison between the time series provided at the control point and that which is numerically simulated with tsunami hysea using the described boundary condition is presented this simple approach leads to a very good agreement between the two time series at least for the four first waves and a fairly good qualitative agreement along all the time series in the lower panel of fig 2 sensitivity to friction for sea surface elevation at this same control point is presented it is clear that for deep waters the influence of the manning friction coefficient used within a certain range of values is minor and that the magnitude of this coefficient will be mainly felt in very shallow waters and in the inundated coastal strip modelers were also encouraged to simulate the complete problem from the source to the harbor using nesting meshes techniques being this task optional the edanya group also presented numerical results for the complete scenario using the tsunami hysea model as we will show later 3 2 numerical results for the reduced scenario to study model convergence numerical results for three numerical resolutions 2 3 1 3 and 1 6 arcsec were requested corresponding to 20 10 and 5 meter resolutions besides in order to perform a sensitivity study to friction three values for the manning coefficient were considered m n 0 025 requested 0 030 and 0 035 in order to ensure convergence the high resolution grids must be built as an interpolation of the lowest resolution grid in order to not bring new bathymetric information into the problem when using the higher resolutions to meet this requirement the topo bathymetric data in the three meshes are constructed as follows first the topo bathymetry on the coarse grid 2 3 arcsec is obtained by considering the natural subsampling from the provided data in the 1 3 arcsec finer mesh next the standard bilinear interpolation is used to define the topo bathymetry on the finer grids 1 3 and 1 6 arcsec the first requested comparison consisted of checking the water surface elevation at the tidal station hilo tide station located at 19 7308º 204 9447º and marked with the blue dot and labeled ts in fig 1 the comparison of the water levels is presented in fig 3 and shows a reasonable match between the water levels modeled and the ones observed at the harbor gage the mismatch for the second wave about 8 1 2 h from triggering was a common feature in the time series provided by all models presenting their results during the workshop nthmp 2016 lynett et al 2017 and in zhang et al 2016 regardless of their nature nlsw boussinesq multi layer or navier stokes 3d in the lower panel of fig 3 the sensitivity of simulated sea surface elevation to friction at the same tide location is presented as expected for varying friction the main differences are found at the peaks of the tsunami wave with the frequency remaining unchanged then the velocity comparison for the two adcp locations provided marked in black in fig 1 was required the official locations of the adcps could eventually slightly change were ha 1125 harbour entrance 19 7452º 204 9180º ha 1126 inside harbour 19 7417º 204 9300º figs 4 and 5 show the comparison at these two locations for the u the e w and v the n s components of the velocity currents in these figures the black dots represent the actual observations the first clear remark is that the sampling frequency of the measured data is not high enough to perform a good comparison and precludes a more comprehensive assessment of model results the actual sampling frequency 6 min of the measured data cannot capture the oscillations simulated by the model or to assess if they are real but not captured by the sampling or if they are spurious oscillations produced by the model in any case this is a feature reproduced by many models participating in the workshop regardless the nature of the model as can be seen in the presentations that can be found at http coastal usc edu currents workshop for nlsw see tolkova nicolsky or arikawa s presentations for boussinesq models see yamazaki or kirby s and for 3d models see pampell s presentation in particular regarding the u velocity prediction at ha 1125 in fig 4 we do not know if the model is performing really well or if fortuitously the red line is always close to the observations marked with the black dots in any case the agreement for ha 1126 is worse and larger errors are evident see fig 5 this may be due to the sheltered and shallower location of this gage which made the comparison for all models particularly challenging in any case it is reassuring how current state of the art numerical modeling leads different models to produce qualitatively similar results nthmp 2016 for comparison with the figures appearing in nthmp 2016 for all models presenting results for this benchmark fig 6 is included in the same format as required for the nthmp report this figure presents the comparison for the modulus of the current velocity at the two adcp locations and the free surface elevation at the harbor tide gage in nthmp 2016 all model data have been smoothed to produce the analogous figure as can be observed when comparing for tsunami hysea in page 122 of this report 3 2 1 sensitivity to friction regarding the sensitivity to friction for current predictions we observe that it largely depends on the location this is related to the location of the measuring instrument itself at the entrance of the harbor for ha 1125 adcp and at the dock shelter for ha 1126 adcp and water depth shallower for ha 1126 adcp fig 7 shows u and v velocity component comparisons for ha 1125 and ha 1126 adcp locations it can be observed how the simulated component velocities at the second location are much more sensitive to varying friction than they are for ha 1125 current predictions for velocity predictions at ha 1125 differences are only observable at the peaks of the waves with larger amplitude waves for lower values of friction at location ha 1126 larger differences appear 3 2 2 convergence as mentioned above one of the objectives of the present benchmark problem was to assess model convergence with respect to velocity predictions as resolution is increased initially we tried to assess convergence comparing the time series at the location where measured data were provided in any case convergence at individual discrete locations did not provide much information the results can be found in fig 8 for the three mesh resolutions considered once again no significant differences are found for the ha 1125 adcp location at the entrance of the harbor while for the inside location differences between numerical resolutions are clearly observed although they are not relevant this can be explained by the fact that more complex flow behavior is expected in the shallower and closer to the pier ha 1126 adcp location to get a two dimensional picture for convergence in the case of velocity predictions we have considered the modeled maximum fluid velocity along the whole simulation for the three resolutions that have been used 20 10 and 5 m they are shown in fig 9 to better quantify the difference between the maximum velocity predicted for different resolutions the difference between the 20 m and the 5 m resolution simulations left panel and the difference between the 10 m and 5 m resolution simulations right panel are shown in fig 10 larger differences can be observed for the 20 m vs 5 m differences than for the 10 m vs 5 m differences which is an indication for convergence at least for the maximum predicted velocity nevertheless strict model simulated velocity convergence does not seem to occur the presence of eddies makes strict model convergence challenging lynett et al 2017 if not impossible if we think of the chaotic nature of the simulated phenomenon itself eddies this chaotic behavior is not present in the case of the sea surface elevation making its prediction much easier and successful finally regarding the computational cost required for the three tests presented with 5 10 and 20 m resolutions with computational sizes of 1 94m 482k and 121k volumes respectively the wall clock times in a single nvidia p100 graphic card for producing the 6 hour simulation presented here are 25 m 22 s 3 m 30 9 s and 34 55 s respectively 3 3 numerical results for the complete scenario the simulation of the complete scenario was optional for this case three nested grids were used with decreasing resolutions initially 128 3 for the ambient grid or a grid and 8 3 arcsec for the first refinement level the b grid for the finer grid c grid the same three resolutions as for the local case were used i e 2 3 1 3 and 1 6 arcsec corresponding to approximately 20 10 and 5 m respectively bathymetric data for a and b grids were taken and interpolated from srtm15 plus 0000 in these simulations the value for manning coefficient used was m n 0 025 requested see table 1 and figs 11 and 12 for further details on grid locations spatial coverage and sizes in the case of the initial setting just described the size of the problems to solve range from 13 1 for grid c1 to nearly 15 for grid c3 million cells the earthquake source for the tohoku 2011 tsunami was obtained by data inversion made from dart buoy waveforms is depicted in fig 13 it was provided by the nctr noaa center for tsunami research in section 3 3 1 sensitivity to c grid refinement will be discussed then in section 3 3 2 the spatial resolution of outer grids will be changed in order to assess the role of the ambient grid s resolution in model results 3 3 1 sensitivity to c grid mesh refinement to compare the results of the complete scenario with the provided data some numerical tests were performed first in the upper panel of fig 14 a comparison between the simulated free surface and the provided time series at the control point is presented showing the three numerical resolutions used for the grid c the comparison shows a good agreement in frequency and amplitude between the water level time series provided and the time series computed with tsunami hysea during the first three waves the sensitivity analysis shows that differences in surface elevations and velocities between different resolutions are negligible along all the numerical simulations at this location increasing the resolution of the c grid has very little effect on the simulated components of the velocity as shown in fig 14 the upper panel of fig 15 shows the comparison between ocean surface measured data and model results at the hilo harbor tide gage model results show a very good agreement with observations for the first wave the same behavior as in the reduced problem can be observed at time t 8 5 h a single larger simulated crest vs two smaller measured crests then the third and fourth waves are again well captured the second and third panels of fig 15 show the e w and n s velocities and their sensitivity to the grid c refinement in general the differences are minor but in some cases as for the peaks in the n s velocities larger differences are observed for the e w velocities in some time intervals besides the peaks larger differences appear in figs 16 and 17 surface elevation and the e w and n s velocities are shown for ha 1125 and ha 1126 adcp locations in the upper panel the free surface elevation is compared between the different c grid resolutions small differences can be found in surface elevations between different resolutions in the second and third panels in figs 16 and 17 e w and n s velocities are compared with measured data for ha 1125 and ha 1126 adcp locations the comparisons for ha 1125 fig 16 show that data and model results are in better agreement for the e w than for the n s velocities the same remark as for the reduced simulation is valid here about data sampling and model performance on the other hand regarding the sensitivity analysis we can observe larger differences in the u direction than in the v direction when the inner c mesh is refined for the ha 1126 adcp location in fig 17 the second and third panels show that the velocities also present a behavior similar to that observed in the reduced scenario and that in either case larger discrepancies appear regardless of the fact that a more frequent data sampling is required regarding the sensitivity analysis differences between the velocities can be observed essentially in peaks for the u direction while larger differences can be appreciated in the v direction mainly in the peaks but with differences everywhere in the time series 3 3 2 sensitivity to a and b grids mesh refinement in this section we focus on the importance of the ambient grids i e grids a and b on model results more precisely we try to assess the influence of their spatial resolution for doing so we considered coarser versions of grids a and b now with resolutions of 256 3 and 16 3 arcsec respectively named as coarser in the figures we also considered grids a and b with their initial resolutions of 128 3 and 8 3 arcsec respectively named as reference in the figures finally we also considered finer versions of grids a and b with resolutions of 64 3 and 4 3 arcsec respectively named as finer in the figures table 2 shows the resolution size and cell size of the different a and b meshes considered in order to ensure convergence in the numerical study to be performed the same approach as the one described for the c grids in the local study was followed here to generate the bathymetric meshes in the a and b grids coarser grids a1 and b1 interpolate data from srtm15 plus 0000 and standard bilinear interpolation was used to define the bathymetry in the reference and finer a and b grids comparisons for the control point hilo tidal station ha 1125 and ha 1126 for the coarser reference and finer a and b grids combined with the resolutions of 2 3 and 1 3 for the c grid are presented in this section a total of 8 numerical experiments have been performed in order to assess model sensitivity to mesh refinement and in particular the role of the resolution of ambient larger meshes on the numerical results table 2 gathers information about all these experiments the ratio between a and b meshes used here is always limited by the largest value we use in our simulations and that we recommend to tsunami hysea users this value is 16 this means that the resolution of the b mesh is 16 times larger than the corresponding a grid partner then for every couple of a b grids we performed a numerical test with the 3 c meshes considered here except if the maximum ratio relation of 16 is violated this is the reason why we did not perform experiment e3 in table 3 because the b c ratio would have become 32 table 3 presents information about the numerical tests performed as problem size and computing time required to integrate them using one single nvidia p100 gpu and one v100 gpu corresponding to the two latest nvidia architectures pascal and volta in the upper panel of fig 18 a comparison between the free surface time series provided at the control point with the signal recovered for the 8 numerical experiments in table 3 is presented lines in blue and red present the time series obtained with the coarser ambient grids lines in green orange and cyan depict the results obtained with the reference ambient grids and yellow purple and light pink lines presents the time series for the finer ambient grids it can be observed that the main differences between time series appear for the coarser grid experiments both in sea surface elevation and velocities for the reference and finer grid experiments the results are much closer it seems that for this particular scenario the minimal resolution required for the ambient meshes a and b is around 128 3 and 8 3 respectively and that this resolution cannot be halved it can be observed that in the three cases coarser reference or finer ambient meshes refining the inner c grid from 2 3 to 1 3 or 1 6 arcsec has a much smaller effect on the simulated results than the use of different ambient mesh resolutions this is unfortunate as refining the ambient grids requires significantly increasing the computational time see table 3 but this refinement produces different numerical results therefore it is required for increasing accuracy in other words convergence for these meshes has not been reached conversely refining the inner c grid has a smaller impact on computational time due to the smaller domain covered but it is not required as convergence for sea surface elevation seems to have been reached for the c grid in any case if the goal was assessing inundation then refining the c grid should be mandatory in fig 19 the comparison for time series at hilo harbor are presented the upper panel presenting the sea surface elevation shows larger amplitude in the finer ambient grids reference and finer suggesting higher numerical dissipation for the coarser ambient grids again refining the inner c grid produces no significant numerical results the second and third panels of fig 19 show the e w and n s velocities and their sensitivity to refinement of grids a and b refinement the same behavior as the one described for former location can also be observed here and the use of the coarser set of ambient grids must be ruled out finally figs 20 and 21 show the corresponding time series for the two adcp locations ha 1125 and ha 1126 for the first location differences in water surface elevation for the coarser compared with the reference and finer meshes are smaller than in the rest of locations and this is true too for the velocity components in this case the agreement between modeled velocity and observations is quite good the amplitude and main frequency of the signal is well captured for location ha 1126 the differences are again larger mainly in both components of the velocity while for the sea surface elevation different configurations provide closer results larger differences are in particular observed for the v component while for the u component amplitude and main frequency of the modeled signal are in good agreement with observations 3 4 some comments some conclusions can be extracted from the numerical results obtained for the hilo harbor benchmark problem first for the reduced scenario at ha 1125 the two initial perturbations in the u and v components of the velocity are well captured and then the simulated u component becomes too oscillatory however due to the time sampling of the observed data provided it is not possible to confirm if they are spurious numerical oscillations while present in most of the models participating in the workshop or if they are real in general the effects of varying friction and increasing resolution are very limited and are only slightly felt in the maximum and minimum values of the time series in velocity and surface elevation the observed behavior for ha 1126 numerical results is similar to the one described for ha 1125 however in this case larger differences are observed for different values of the friction parameter and increased resolution the differences for the maximum velocity maps between the 20 m and 5 m resolution simulations and the 10 m and 5 m resolution simulations suggest the convergence of the numerical solution for the maximum of the velocity field for the velocity vector field such a convergence seems to not be possible due to the chaotic nature of the simulated phenomena model agreement with the sea surface elevation at hilo tidal station is good for the complete scenario simulated from the source the computed variables reproduce well the first two or three initial waves in particular for the sea surface elevation at the control point at ha 1125 the simulated signal is also oscillatory as in the local scenario and mesh refinement has a minor effect further depending on the sampling frequency see comments of other modelers in nthmp 2016 the v component of the velocity is well captured or highly overestimated except for the first perturbation again at ha 1126 larger but still limited sensitivity to mesh refinement is observed the downside emerges when we try to assess sensitivity to the ambient and intermediate mesh resolutions much greater sensitivity is now observed meaning that the resolution of the ambient mesh is important and that the outer meshes cannot be very coarse which is something we would like to have in order to speed up computations furthermore our experience through many numerical simulations also shows that going beyond a certain resolution is also useless as at a certain point convergence is achieved and no further improvement in terms of precision in model results is obtained therefore this means that it is important to know the range of resolutions for which improved numerical results are obtained on the other hand the effect of increasing inner resolution remains limited for the three resolutions considered here 4 benchmark problem 3 tsunami currents in tauranga harbor this benchmark provides the data for comparison with a field database recording the 2011 tohoku tsunami in tauranga harbor new zealand complete details of the dataset provided for this benchmark can be found at http coastal usc edu currents workshop problems prob3 html and general information about the tsunami impact in new zealand can be found in borrero et al 2013 during the 2011 tohoku tsunami at tauranga harbor in the bay of plenty and home to the port of tauranga several sea water level and current velocity data were recorded they summed up a total of five water level gauges taut moturiki a beacon tug berth and sulfur point and one adcp measuring current velocity in the entrance of the harbour their locations can be found in fig 22 and their coordinates in geographical and as the x y coordinate system of the rotated bathymetry data provided to perform the simulations is collected in table 4 this represents one of the most comprehensive instrumental data set of a far field tsunami affecting a major commercial port besides at the adcp measurement location the velocity component of the tsunami signal is comparable to the tidal component indicating the possibility of a non linear superposition of the two components the aim of this test is to attempt to include the effects of the tides in the tsunami model simulations 4 1 model setup the numerical model setup used for the simulations presented here is the same as the one proposed in the benchmark description a rotated domain of 40 km by 20 km with a 20 meter numerical resolution was used resulting in a 2 million cell size problem bathymetry data resolution of 10 m is shown in fig 23 the computational domain was rotated in order to make it easier to impose the boundary condition along the upper domain boundary in fig 23 modelers were asked to drive their simulations with the most offshore measured free surface elevation at a beacon tide gage this tide gage is located at a 25 meter depth three separate time series at this location were provided 1 only tide 2 only tsunami and 3 the combined tide tsunami signals in figs 24 a 25 a and 26 a respectively modelers were requested to use these three different forcing signals to perform the corresponding only tide only tsunami and the tide plus tsunami simulations 4 2 numerical results the numerical results show a good agreement with measured data both for free surface elevation at the four tidal stations and for the three different configurations tide only tsunami only and tide plus tsunami signal in the present benchmark problem comparison with free surface elevation data was performed at the four tidal stations in fig 22 and table 4 4 2 1 sea surface elevation in fig 24 measured vs simulated tsunami only signal at the four tidal stations is shown very good agreement can be observed between both time series at the four locations fig 25 shows the same comparison but for the tide plus tsunami signal for the sake of completeness we also present the comparison for the tide only time series fig 26 as suggested in the benchmark instructions 4 2 2 tsunami currents in this section we compare the numerical results with the measured adcp velocity data in fig 27 the modulus for the measured velocity is presented in blue and the filtered tsunami and tidal signal are also shown in red and black respectively maximum measured current velocity during the tsunami reached 2 5 m s at the entrance of tauranga harbor removing the tidal component shows that the tsunami currents alone peaked at approximately 1 0 m s in fig 27 the green line represents the threshold for the passage of large container ships through the entrance to tauranga harbor borrero et al 2015 fig 28 depicts the comparison between the modulus of the depth average horizontal velocity for the data at adcp location and model output a very good agreement of the reproduced signal compared with the measured data can be observed it must be noted that this problem is much easier than the case at hilo harbor because in the case of tauranga harbor the location of the adcp device makes it much easier to get a better agreement between models and the observations the location of the adcp in the middle of a channel where water flow is confined causes eddies and chaotic behavior to be greatly reduced the present test problem with a size of 20 million volumes and a numerical resolution of 20 meters in both x and y directions integrated over 80 h took 2 h 4 min 16 s using a single nvidia p100 graphic card 5 concluding remarks the overall conclusion that we could extract from this validation exercise was that the tsunami hysea model performed well in all benchmark problems proposed for bp2 namely hilo harbor good agreement is obtained at the control point and the tidal station for sea surface elevation depth averaged velocities show a good fit for the initial pattern of the signal in u and v becoming noisier for the u component at location ha 1125 see comments in nthmp 2016 on data sampling for this case we analyzed sensitivity to friction and convergence when the mesh is refined differences in maximum velocity between 20 m 10 m and 5 m mesh resolutions suggest model convergence for the simulated maximum water height one of the conclusions of the benchmark workshop was that no model could achieve convergence on the velocity field due to the intrinsic chaotic nature of the phenomena involved eddies the simulation of the complete scenario from the source in the whole pacific domain was also performed obtaining also in this case a good fit for sea surface elevation signals at control point and at hilo tide station for the velocity time series a good agreement of the initial phase of the signal and less oscillatory time series for the u component is obtained in this case sensitivity to mesh refinement showed minor effects for inner finer meshes and larger effects for the outer coarser ambient meshes the study of bp3 in tauranga harbor was performed in the three requested configurations only tsunami tsunami tide and only tide the time series for these three configurations for the sea surface elevation at the four locations considered is very good and also a very good fit is obtained for the velocity signal at the acdp location in this case the good agreement between the measured and the simulated velocity data is due to the simpler nature of the problem the location of the current meter at a narrow passage that channeled and constrained the flow of water mostly avoided chaotic behavior and made it easier to get numerical results closer to the observations for large scale highly computationally demanding problems such as bp2 complete scenario tsunami hysea performs extremely fast producing accurate simulations in very short computational times for such problems nested meshes were used credit authorship contribution statement jorge macías writing review editing funding acquisition project administration conceptualization methodology validation investigation resources writing original draft visualization supervision manuel j castro funding acquisition project administration methodology software investigation visualization sergio ortega investigation visualization josé manuel gonzález vida investigation visualization declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research has been partially supported by the junta de andalucía research project tesela p11 rnm7069 the spanish government feder funded project megaflow rti2018 096064 b c21 the junta de andalucía feder funded project uma18 federja 161 and universidad de málaga campus de excelencia andalucía tech the multi gpu computations were performed at the unit of numerical methods university of malaga we would like to thank diego arcas from pmel noaa for providing the source for the complete scenario at hilo harbor a sincere thanks to the three reviewers whose comments have helped to greatly improve this work and also to the journal language editor 
23961,in this study we present model results derived from the tsunami current benchmarking workshop held by the nthmp national tsunami hazard mitigation program at portland oregon us in february 2015 for the two benchmark problems dealing with field data in this workshop the tsunami hysea model was used to perform the five proposed numerical benchmarks the other three benchmarks which are based on lab data are the subject of a related paper macías et al 2020 the results and comparisons with measured data for the two benchmarks which deal with field observations described in the present paper include 1 benchmark 2 impact of tsunami waves at hilo harbor hawaii and 2 benchmark 3 tsunami currents at tauranga harbor new zealand both for data of the 2011 tohoku tsunami the numerical results demonstrate that the tsunami hysea model is able to accurately reproduce sea surface elevations and current velocities for both the benchmark problems performed in a reduced local domain as in the case of the complete scenario modeled from the source to hilo harbor on the pacific ocean keywords model benchmarking tsunami currents tsunami hysea nthmp field data 1 introduction the tsunami modeling community has focused most of its effort on modeling wave height and runup as the key components of tsunami hazard assessment and model validation has been mostly restricted to these variables nicolsky et al 2011 nthmp 2012 and references therein tolkova 2014 horrillo et al 2015 and many others on the other hand studies focused on modeling the effects of tsunami currents or devoted to model validation for tsunami currents are less common lynett et al 2014 nevertheless the impact caused by the strong currents that typically accompany a tsunami is of key importance in ports bays and harbours it is even important with regard to streets in between buildings for larger tsunamis as in onagawa during the 2011 tohoku tsunami besides water height the ability to compute and predict tsunami flow velocities has revealed of great importance in risk assessment and hazard mitigation model results are increasingly being used to estimate damage to coastal infrastructure and therefore understanding the accuracy and precision of velocity predictions for tsunami currents becomes of undeniable importance nonetheless until recently a benchmarking based on velocity current observations was difficult to perform as few direct measurements of tsunami velocities existed to compare with the model results this has changed since the 2011 tohoku tsunami as many current meters were deployed in several locations around the pacific however despite the deployment of these current meters the numerical results and comparisons presented here and during the workshop revealed some deficiencies in these observed data in particular in the frequency of sampling which do not allow a completely satisfactory comparison with the numerical results being aware of this need for validation and verification and also aware of the lack of model benchmarking for tsunami currents the national tsunami hazard mitigation program nthmp decided to implement a benchmarking procedure to evaluate nthmp approved models for current predictions the previous benchmark tests mandated by the nthmp focused on wave height and runup nthmp 2012 to fulfill this new mandate a benchmarking workshop was organized in february 2015 in portland oregon http coastal usc edu currents workshop called nthmp mms benchmarking workshop tsunami currents for this workshop five different benchmark problems were proposed including lab measured datasets and observed data the first two benchmark problems were mandatory for all participating modelers models with the remainder of the tests being optional benchmarks 1 4 and 5 were based on lab measured data and are the subject of another paper macías et al 2020 bp2 proposed the simulation of a field case for the hilo harbor hawaii usa during the 2011 tohoku tsunami the third test dealt with the impact of the 2011 tohoku tsunami on tauranga harbor new zealand with the aim of including the effects of tides the edanya group www uma es edanya from the university of málaga participated in the workshop with the tsunami hysea model and presented numerical results for all five of the benchmark problems proposed as output of the workshop a model inter comparison study was elaborated lynett et al 2017 and a report containing results from all models was produced nthmp 2016 in the present work the numerical results obtained with the tsunami hysea model for the two benchmark problems based on field data are described and compared by the provided observed data this paper is outlined as follows section 2 describes the numerical model equations and numerical aspects sections 3 and 4 describe the two benchmark problems and present the numerical results obtained with the tsunami hysea model for hilo harbor and tauranga harbor respectively section 5 concludes the paper with some final comments and remarks 2 the tsunami hysea numerical model the open source tsunami hysea model edanya uma es hysea was used to perform the numerical simulations for the two benchmark problems considered in this work and based on field data different scenarios were simulated for both benchmarks based on field data the tsunami hysea numerical model combines robustness reliability and good accuracy in a model based on a gpu implementation that produces much faster than real time ftrt simulations in many configurations it has been rigorously tested and in particular it has passed all tests in synolakis et al 2008 along with other laboratory tests and proposed benchmark problems tsunami hysea has recently been approved february 2017 by the nthmp for tsunami hazard assessment studies in the us the numerical results submitted to the nthmp mapping and modeling subcommittee mms for obtaining this approval can be found in macías et al 2017 a comparison of tsunami hysea numerical results with the most model for the lantex 2013 scenario and tsunami impact on puerto rican coasts can be found in macías et al 2016 tsunami hysea implements the well known 2d nonlinear one layer shallow water system in both spherical and cartesian coordinates for the sake of brevity and simplicity only the cartesian system is written although the spherical coordinates version of the code is also used in the present study when large domains are considered h t q x x q y y 0 q x t q x 2 h g h 2 2 x q x q y h y g h h x s x q y t q x q y h x q y 2 h g h 2 2 y g h h y s y in the above set of equations h x t denotes the thickness of the water layer at point x d r 2 at time t with being d the horizontal projection of the 3d domain where the tsunami takes place h x is the depth of the bottom at point x measured from a fixed level of reference let us denote by q x t q x x t q y x t the mass flow of the water layer at point x at time t the mass flow is related to the depth averaged velocity u x t by means of the expression q x t h x t u x t the notation t x and y applies for temporal and spatial partial derivatives in the x and y directions respectively the terms s x and s y parameterize the friction effects and the manning law is used in this work i e s x g h m n 2 u x u h 4 3 s y g h m n 2 u y u h 4 3 where m n 0 is the manning coefficient for further details on the numerical method implemented in the tsunami hysea model can be found in macías et al 2020 the numerical implementation of tsunami hysea has been performed on gpu clusters de la asunción et al 2011 2013 castro et al 2011 and also includes nested grids macías et al 2016 2017 macías and ortega 2020 the benchmark problems as initially devised for the portland nthmp benchmarking workshop were named as local setup reduced scenarios with the source the input generating the tsunami described as a sea surface elevation time series to be imposed close to the coast additionally complete scenario simulations from the physical source were encouraged in the case of hilo harbor in that case bp2 we performed both the local setup and the complete scenario simulations and the model results were compared with observations in both cases for the complete scenario nested grids were used the gpu and multi gpu implementation and the use of nested grids allowed us to speed up the computations and perform complex simulations in very large domains much faster than real time macías et al 2016 2017 in this work we will present the figures for the wall clock time required for some of these simulations referring also to the size of the problems that are solved 3 benchmark problem 2 tsunami currents in hilo harbor the 2011 tohoku tsunami caused persistent oscillations and hazardous currents in coastal waters around hawaii that resulted in damage in harbors and marinas at the same time extensive current measurements were collected during this event in and around hawaii and estimates of tsunami induced currents were extracted from these measurements via spectral analysis cheung et al 2013 arcos and leveque 2015 the present benchmark test focuses on a smaller region around hilo harbor and proposes to conduct a model convergence test with respect to grid resolution the main goal was to assess the model s ability to simulate field scale tsunami currents under realistic grid resolutions used previously for tsunami propagation and inundation the aim of this benchmark is on understanding the importance of model resolution and numerics on prediction of tsunami currents in order to fulfill this objective some questions were proposed to modelers to be answered lynett et al 2017 1 what level of precision can we expect with regard to the simulated currents on real bathymetry 2 does your model converge with respect to velocity predictions as resolution is increased 3 what is the variation across different models using the same wave forcing resolution and bottom friction to answer this question was one of the main issues of this benchmark test in the inter comparison exercise performed at the end of it gathering the numerical results from all participants a paper was then produced containing the conclusions of such inter comparison lynett et al 2017 in order to get a more clear answer to these questions the field case was simplified providing a flattened bathymetry for depths greater than 30 m see fig 1 the dark blue area corresponds to this flattening this seems to contradict the aim of question 1 above but was done in order to get model results as similar as possible outside the protected harbor with inter model differences in the reproduced variables in particular tsunami currents resulting exclusively from differences in the shallow water region inside the harbor 3 1 model setup the computational domain is approximately a square of 7 by 7 km that in geographical coordinates covers the domain 204 90º 204 96º by 19 71º 19 773º in longitude and latitude respectively bathymetric data were provided in a lat lon mesh of 1 3 arcsec resolution 10 m in a 692 by 701 point mesh as mentioned above this problem has been reduced in an attempt to isolate differences in the employed incident wave forcing concerning the boundary conditions to be imposed a time series of offshore simulated free surface elevation at a control point in white in fig 1 located at 19 7576º 204 93º and marked as cp was provided to modelers fig 2 discontinuous black line this time series was generated as output of the neowave model therefore it is not given by observed data the proposed approach was that modelers may force their simulations in whichever way is convenient in order to obtain a modeled time series at the control point as close as possible to the provided data note that although this represents a new simplification aimed at reducing model differences up to this point it will lead to a physical mismatch between the simulated and the actual data in our case we chose to impose at the upper open boundary of the computational domain in fig 1 the same signal as the one provided for the control point which was the general common approach followed by all modelers no velocity correction is used and the velocity is therefore set to zero along the boundary in the eastern boundary transparent boundary conditions are imposed in the upper panel of fig 2 a comparison between the time series provided at the control point and that which is numerically simulated with tsunami hysea using the described boundary condition is presented this simple approach leads to a very good agreement between the two time series at least for the four first waves and a fairly good qualitative agreement along all the time series in the lower panel of fig 2 sensitivity to friction for sea surface elevation at this same control point is presented it is clear that for deep waters the influence of the manning friction coefficient used within a certain range of values is minor and that the magnitude of this coefficient will be mainly felt in very shallow waters and in the inundated coastal strip modelers were also encouraged to simulate the complete problem from the source to the harbor using nesting meshes techniques being this task optional the edanya group also presented numerical results for the complete scenario using the tsunami hysea model as we will show later 3 2 numerical results for the reduced scenario to study model convergence numerical results for three numerical resolutions 2 3 1 3 and 1 6 arcsec were requested corresponding to 20 10 and 5 meter resolutions besides in order to perform a sensitivity study to friction three values for the manning coefficient were considered m n 0 025 requested 0 030 and 0 035 in order to ensure convergence the high resolution grids must be built as an interpolation of the lowest resolution grid in order to not bring new bathymetric information into the problem when using the higher resolutions to meet this requirement the topo bathymetric data in the three meshes are constructed as follows first the topo bathymetry on the coarse grid 2 3 arcsec is obtained by considering the natural subsampling from the provided data in the 1 3 arcsec finer mesh next the standard bilinear interpolation is used to define the topo bathymetry on the finer grids 1 3 and 1 6 arcsec the first requested comparison consisted of checking the water surface elevation at the tidal station hilo tide station located at 19 7308º 204 9447º and marked with the blue dot and labeled ts in fig 1 the comparison of the water levels is presented in fig 3 and shows a reasonable match between the water levels modeled and the ones observed at the harbor gage the mismatch for the second wave about 8 1 2 h from triggering was a common feature in the time series provided by all models presenting their results during the workshop nthmp 2016 lynett et al 2017 and in zhang et al 2016 regardless of their nature nlsw boussinesq multi layer or navier stokes 3d in the lower panel of fig 3 the sensitivity of simulated sea surface elevation to friction at the same tide location is presented as expected for varying friction the main differences are found at the peaks of the tsunami wave with the frequency remaining unchanged then the velocity comparison for the two adcp locations provided marked in black in fig 1 was required the official locations of the adcps could eventually slightly change were ha 1125 harbour entrance 19 7452º 204 9180º ha 1126 inside harbour 19 7417º 204 9300º figs 4 and 5 show the comparison at these two locations for the u the e w and v the n s components of the velocity currents in these figures the black dots represent the actual observations the first clear remark is that the sampling frequency of the measured data is not high enough to perform a good comparison and precludes a more comprehensive assessment of model results the actual sampling frequency 6 min of the measured data cannot capture the oscillations simulated by the model or to assess if they are real but not captured by the sampling or if they are spurious oscillations produced by the model in any case this is a feature reproduced by many models participating in the workshop regardless the nature of the model as can be seen in the presentations that can be found at http coastal usc edu currents workshop for nlsw see tolkova nicolsky or arikawa s presentations for boussinesq models see yamazaki or kirby s and for 3d models see pampell s presentation in particular regarding the u velocity prediction at ha 1125 in fig 4 we do not know if the model is performing really well or if fortuitously the red line is always close to the observations marked with the black dots in any case the agreement for ha 1126 is worse and larger errors are evident see fig 5 this may be due to the sheltered and shallower location of this gage which made the comparison for all models particularly challenging in any case it is reassuring how current state of the art numerical modeling leads different models to produce qualitatively similar results nthmp 2016 for comparison with the figures appearing in nthmp 2016 for all models presenting results for this benchmark fig 6 is included in the same format as required for the nthmp report this figure presents the comparison for the modulus of the current velocity at the two adcp locations and the free surface elevation at the harbor tide gage in nthmp 2016 all model data have been smoothed to produce the analogous figure as can be observed when comparing for tsunami hysea in page 122 of this report 3 2 1 sensitivity to friction regarding the sensitivity to friction for current predictions we observe that it largely depends on the location this is related to the location of the measuring instrument itself at the entrance of the harbor for ha 1125 adcp and at the dock shelter for ha 1126 adcp and water depth shallower for ha 1126 adcp fig 7 shows u and v velocity component comparisons for ha 1125 and ha 1126 adcp locations it can be observed how the simulated component velocities at the second location are much more sensitive to varying friction than they are for ha 1125 current predictions for velocity predictions at ha 1125 differences are only observable at the peaks of the waves with larger amplitude waves for lower values of friction at location ha 1126 larger differences appear 3 2 2 convergence as mentioned above one of the objectives of the present benchmark problem was to assess model convergence with respect to velocity predictions as resolution is increased initially we tried to assess convergence comparing the time series at the location where measured data were provided in any case convergence at individual discrete locations did not provide much information the results can be found in fig 8 for the three mesh resolutions considered once again no significant differences are found for the ha 1125 adcp location at the entrance of the harbor while for the inside location differences between numerical resolutions are clearly observed although they are not relevant this can be explained by the fact that more complex flow behavior is expected in the shallower and closer to the pier ha 1126 adcp location to get a two dimensional picture for convergence in the case of velocity predictions we have considered the modeled maximum fluid velocity along the whole simulation for the three resolutions that have been used 20 10 and 5 m they are shown in fig 9 to better quantify the difference between the maximum velocity predicted for different resolutions the difference between the 20 m and the 5 m resolution simulations left panel and the difference between the 10 m and 5 m resolution simulations right panel are shown in fig 10 larger differences can be observed for the 20 m vs 5 m differences than for the 10 m vs 5 m differences which is an indication for convergence at least for the maximum predicted velocity nevertheless strict model simulated velocity convergence does not seem to occur the presence of eddies makes strict model convergence challenging lynett et al 2017 if not impossible if we think of the chaotic nature of the simulated phenomenon itself eddies this chaotic behavior is not present in the case of the sea surface elevation making its prediction much easier and successful finally regarding the computational cost required for the three tests presented with 5 10 and 20 m resolutions with computational sizes of 1 94m 482k and 121k volumes respectively the wall clock times in a single nvidia p100 graphic card for producing the 6 hour simulation presented here are 25 m 22 s 3 m 30 9 s and 34 55 s respectively 3 3 numerical results for the complete scenario the simulation of the complete scenario was optional for this case three nested grids were used with decreasing resolutions initially 128 3 for the ambient grid or a grid and 8 3 arcsec for the first refinement level the b grid for the finer grid c grid the same three resolutions as for the local case were used i e 2 3 1 3 and 1 6 arcsec corresponding to approximately 20 10 and 5 m respectively bathymetric data for a and b grids were taken and interpolated from srtm15 plus 0000 in these simulations the value for manning coefficient used was m n 0 025 requested see table 1 and figs 11 and 12 for further details on grid locations spatial coverage and sizes in the case of the initial setting just described the size of the problems to solve range from 13 1 for grid c1 to nearly 15 for grid c3 million cells the earthquake source for the tohoku 2011 tsunami was obtained by data inversion made from dart buoy waveforms is depicted in fig 13 it was provided by the nctr noaa center for tsunami research in section 3 3 1 sensitivity to c grid refinement will be discussed then in section 3 3 2 the spatial resolution of outer grids will be changed in order to assess the role of the ambient grid s resolution in model results 3 3 1 sensitivity to c grid mesh refinement to compare the results of the complete scenario with the provided data some numerical tests were performed first in the upper panel of fig 14 a comparison between the simulated free surface and the provided time series at the control point is presented showing the three numerical resolutions used for the grid c the comparison shows a good agreement in frequency and amplitude between the water level time series provided and the time series computed with tsunami hysea during the first three waves the sensitivity analysis shows that differences in surface elevations and velocities between different resolutions are negligible along all the numerical simulations at this location increasing the resolution of the c grid has very little effect on the simulated components of the velocity as shown in fig 14 the upper panel of fig 15 shows the comparison between ocean surface measured data and model results at the hilo harbor tide gage model results show a very good agreement with observations for the first wave the same behavior as in the reduced problem can be observed at time t 8 5 h a single larger simulated crest vs two smaller measured crests then the third and fourth waves are again well captured the second and third panels of fig 15 show the e w and n s velocities and their sensitivity to the grid c refinement in general the differences are minor but in some cases as for the peaks in the n s velocities larger differences are observed for the e w velocities in some time intervals besides the peaks larger differences appear in figs 16 and 17 surface elevation and the e w and n s velocities are shown for ha 1125 and ha 1126 adcp locations in the upper panel the free surface elevation is compared between the different c grid resolutions small differences can be found in surface elevations between different resolutions in the second and third panels in figs 16 and 17 e w and n s velocities are compared with measured data for ha 1125 and ha 1126 adcp locations the comparisons for ha 1125 fig 16 show that data and model results are in better agreement for the e w than for the n s velocities the same remark as for the reduced simulation is valid here about data sampling and model performance on the other hand regarding the sensitivity analysis we can observe larger differences in the u direction than in the v direction when the inner c mesh is refined for the ha 1126 adcp location in fig 17 the second and third panels show that the velocities also present a behavior similar to that observed in the reduced scenario and that in either case larger discrepancies appear regardless of the fact that a more frequent data sampling is required regarding the sensitivity analysis differences between the velocities can be observed essentially in peaks for the u direction while larger differences can be appreciated in the v direction mainly in the peaks but with differences everywhere in the time series 3 3 2 sensitivity to a and b grids mesh refinement in this section we focus on the importance of the ambient grids i e grids a and b on model results more precisely we try to assess the influence of their spatial resolution for doing so we considered coarser versions of grids a and b now with resolutions of 256 3 and 16 3 arcsec respectively named as coarser in the figures we also considered grids a and b with their initial resolutions of 128 3 and 8 3 arcsec respectively named as reference in the figures finally we also considered finer versions of grids a and b with resolutions of 64 3 and 4 3 arcsec respectively named as finer in the figures table 2 shows the resolution size and cell size of the different a and b meshes considered in order to ensure convergence in the numerical study to be performed the same approach as the one described for the c grids in the local study was followed here to generate the bathymetric meshes in the a and b grids coarser grids a1 and b1 interpolate data from srtm15 plus 0000 and standard bilinear interpolation was used to define the bathymetry in the reference and finer a and b grids comparisons for the control point hilo tidal station ha 1125 and ha 1126 for the coarser reference and finer a and b grids combined with the resolutions of 2 3 and 1 3 for the c grid are presented in this section a total of 8 numerical experiments have been performed in order to assess model sensitivity to mesh refinement and in particular the role of the resolution of ambient larger meshes on the numerical results table 2 gathers information about all these experiments the ratio between a and b meshes used here is always limited by the largest value we use in our simulations and that we recommend to tsunami hysea users this value is 16 this means that the resolution of the b mesh is 16 times larger than the corresponding a grid partner then for every couple of a b grids we performed a numerical test with the 3 c meshes considered here except if the maximum ratio relation of 16 is violated this is the reason why we did not perform experiment e3 in table 3 because the b c ratio would have become 32 table 3 presents information about the numerical tests performed as problem size and computing time required to integrate them using one single nvidia p100 gpu and one v100 gpu corresponding to the two latest nvidia architectures pascal and volta in the upper panel of fig 18 a comparison between the free surface time series provided at the control point with the signal recovered for the 8 numerical experiments in table 3 is presented lines in blue and red present the time series obtained with the coarser ambient grids lines in green orange and cyan depict the results obtained with the reference ambient grids and yellow purple and light pink lines presents the time series for the finer ambient grids it can be observed that the main differences between time series appear for the coarser grid experiments both in sea surface elevation and velocities for the reference and finer grid experiments the results are much closer it seems that for this particular scenario the minimal resolution required for the ambient meshes a and b is around 128 3 and 8 3 respectively and that this resolution cannot be halved it can be observed that in the three cases coarser reference or finer ambient meshes refining the inner c grid from 2 3 to 1 3 or 1 6 arcsec has a much smaller effect on the simulated results than the use of different ambient mesh resolutions this is unfortunate as refining the ambient grids requires significantly increasing the computational time see table 3 but this refinement produces different numerical results therefore it is required for increasing accuracy in other words convergence for these meshes has not been reached conversely refining the inner c grid has a smaller impact on computational time due to the smaller domain covered but it is not required as convergence for sea surface elevation seems to have been reached for the c grid in any case if the goal was assessing inundation then refining the c grid should be mandatory in fig 19 the comparison for time series at hilo harbor are presented the upper panel presenting the sea surface elevation shows larger amplitude in the finer ambient grids reference and finer suggesting higher numerical dissipation for the coarser ambient grids again refining the inner c grid produces no significant numerical results the second and third panels of fig 19 show the e w and n s velocities and their sensitivity to refinement of grids a and b refinement the same behavior as the one described for former location can also be observed here and the use of the coarser set of ambient grids must be ruled out finally figs 20 and 21 show the corresponding time series for the two adcp locations ha 1125 and ha 1126 for the first location differences in water surface elevation for the coarser compared with the reference and finer meshes are smaller than in the rest of locations and this is true too for the velocity components in this case the agreement between modeled velocity and observations is quite good the amplitude and main frequency of the signal is well captured for location ha 1126 the differences are again larger mainly in both components of the velocity while for the sea surface elevation different configurations provide closer results larger differences are in particular observed for the v component while for the u component amplitude and main frequency of the modeled signal are in good agreement with observations 3 4 some comments some conclusions can be extracted from the numerical results obtained for the hilo harbor benchmark problem first for the reduced scenario at ha 1125 the two initial perturbations in the u and v components of the velocity are well captured and then the simulated u component becomes too oscillatory however due to the time sampling of the observed data provided it is not possible to confirm if they are spurious numerical oscillations while present in most of the models participating in the workshop or if they are real in general the effects of varying friction and increasing resolution are very limited and are only slightly felt in the maximum and minimum values of the time series in velocity and surface elevation the observed behavior for ha 1126 numerical results is similar to the one described for ha 1125 however in this case larger differences are observed for different values of the friction parameter and increased resolution the differences for the maximum velocity maps between the 20 m and 5 m resolution simulations and the 10 m and 5 m resolution simulations suggest the convergence of the numerical solution for the maximum of the velocity field for the velocity vector field such a convergence seems to not be possible due to the chaotic nature of the simulated phenomena model agreement with the sea surface elevation at hilo tidal station is good for the complete scenario simulated from the source the computed variables reproduce well the first two or three initial waves in particular for the sea surface elevation at the control point at ha 1125 the simulated signal is also oscillatory as in the local scenario and mesh refinement has a minor effect further depending on the sampling frequency see comments of other modelers in nthmp 2016 the v component of the velocity is well captured or highly overestimated except for the first perturbation again at ha 1126 larger but still limited sensitivity to mesh refinement is observed the downside emerges when we try to assess sensitivity to the ambient and intermediate mesh resolutions much greater sensitivity is now observed meaning that the resolution of the ambient mesh is important and that the outer meshes cannot be very coarse which is something we would like to have in order to speed up computations furthermore our experience through many numerical simulations also shows that going beyond a certain resolution is also useless as at a certain point convergence is achieved and no further improvement in terms of precision in model results is obtained therefore this means that it is important to know the range of resolutions for which improved numerical results are obtained on the other hand the effect of increasing inner resolution remains limited for the three resolutions considered here 4 benchmark problem 3 tsunami currents in tauranga harbor this benchmark provides the data for comparison with a field database recording the 2011 tohoku tsunami in tauranga harbor new zealand complete details of the dataset provided for this benchmark can be found at http coastal usc edu currents workshop problems prob3 html and general information about the tsunami impact in new zealand can be found in borrero et al 2013 during the 2011 tohoku tsunami at tauranga harbor in the bay of plenty and home to the port of tauranga several sea water level and current velocity data were recorded they summed up a total of five water level gauges taut moturiki a beacon tug berth and sulfur point and one adcp measuring current velocity in the entrance of the harbour their locations can be found in fig 22 and their coordinates in geographical and as the x y coordinate system of the rotated bathymetry data provided to perform the simulations is collected in table 4 this represents one of the most comprehensive instrumental data set of a far field tsunami affecting a major commercial port besides at the adcp measurement location the velocity component of the tsunami signal is comparable to the tidal component indicating the possibility of a non linear superposition of the two components the aim of this test is to attempt to include the effects of the tides in the tsunami model simulations 4 1 model setup the numerical model setup used for the simulations presented here is the same as the one proposed in the benchmark description a rotated domain of 40 km by 20 km with a 20 meter numerical resolution was used resulting in a 2 million cell size problem bathymetry data resolution of 10 m is shown in fig 23 the computational domain was rotated in order to make it easier to impose the boundary condition along the upper domain boundary in fig 23 modelers were asked to drive their simulations with the most offshore measured free surface elevation at a beacon tide gage this tide gage is located at a 25 meter depth three separate time series at this location were provided 1 only tide 2 only tsunami and 3 the combined tide tsunami signals in figs 24 a 25 a and 26 a respectively modelers were requested to use these three different forcing signals to perform the corresponding only tide only tsunami and the tide plus tsunami simulations 4 2 numerical results the numerical results show a good agreement with measured data both for free surface elevation at the four tidal stations and for the three different configurations tide only tsunami only and tide plus tsunami signal in the present benchmark problem comparison with free surface elevation data was performed at the four tidal stations in fig 22 and table 4 4 2 1 sea surface elevation in fig 24 measured vs simulated tsunami only signal at the four tidal stations is shown very good agreement can be observed between both time series at the four locations fig 25 shows the same comparison but for the tide plus tsunami signal for the sake of completeness we also present the comparison for the tide only time series fig 26 as suggested in the benchmark instructions 4 2 2 tsunami currents in this section we compare the numerical results with the measured adcp velocity data in fig 27 the modulus for the measured velocity is presented in blue and the filtered tsunami and tidal signal are also shown in red and black respectively maximum measured current velocity during the tsunami reached 2 5 m s at the entrance of tauranga harbor removing the tidal component shows that the tsunami currents alone peaked at approximately 1 0 m s in fig 27 the green line represents the threshold for the passage of large container ships through the entrance to tauranga harbor borrero et al 2015 fig 28 depicts the comparison between the modulus of the depth average horizontal velocity for the data at adcp location and model output a very good agreement of the reproduced signal compared with the measured data can be observed it must be noted that this problem is much easier than the case at hilo harbor because in the case of tauranga harbor the location of the adcp device makes it much easier to get a better agreement between models and the observations the location of the adcp in the middle of a channel where water flow is confined causes eddies and chaotic behavior to be greatly reduced the present test problem with a size of 20 million volumes and a numerical resolution of 20 meters in both x and y directions integrated over 80 h took 2 h 4 min 16 s using a single nvidia p100 graphic card 5 concluding remarks the overall conclusion that we could extract from this validation exercise was that the tsunami hysea model performed well in all benchmark problems proposed for bp2 namely hilo harbor good agreement is obtained at the control point and the tidal station for sea surface elevation depth averaged velocities show a good fit for the initial pattern of the signal in u and v becoming noisier for the u component at location ha 1125 see comments in nthmp 2016 on data sampling for this case we analyzed sensitivity to friction and convergence when the mesh is refined differences in maximum velocity between 20 m 10 m and 5 m mesh resolutions suggest model convergence for the simulated maximum water height one of the conclusions of the benchmark workshop was that no model could achieve convergence on the velocity field due to the intrinsic chaotic nature of the phenomena involved eddies the simulation of the complete scenario from the source in the whole pacific domain was also performed obtaining also in this case a good fit for sea surface elevation signals at control point and at hilo tide station for the velocity time series a good agreement of the initial phase of the signal and less oscillatory time series for the u component is obtained in this case sensitivity to mesh refinement showed minor effects for inner finer meshes and larger effects for the outer coarser ambient meshes the study of bp3 in tauranga harbor was performed in the three requested configurations only tsunami tsunami tide and only tide the time series for these three configurations for the sea surface elevation at the four locations considered is very good and also a very good fit is obtained for the velocity signal at the acdp location in this case the good agreement between the measured and the simulated velocity data is due to the simpler nature of the problem the location of the current meter at a narrow passage that channeled and constrained the flow of water mostly avoided chaotic behavior and made it easier to get numerical results closer to the observations for large scale highly computationally demanding problems such as bp2 complete scenario tsunami hysea performs extremely fast producing accurate simulations in very short computational times for such problems nested meshes were used credit authorship contribution statement jorge macías writing review editing funding acquisition project administration conceptualization methodology validation investigation resources writing original draft visualization supervision manuel j castro funding acquisition project administration methodology software investigation visualization sergio ortega investigation visualization josé manuel gonzález vida investigation visualization declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research has been partially supported by the junta de andalucía research project tesela p11 rnm7069 the spanish government feder funded project megaflow rti2018 096064 b c21 the junta de andalucía feder funded project uma18 federja 161 and universidad de málaga campus de excelencia andalucía tech the multi gpu computations were performed at the unit of numerical methods university of malaga we would like to thank diego arcas from pmel noaa for providing the source for the complete scenario at hilo harbor a sincere thanks to the three reviewers whose comments have helped to greatly improve this work and also to the journal language editor 
23962,the effects of horizontal resolution and wave drag damping on the semidiurnal m 2 tidal energetics are studied for two realistically forced global hybrid coordinate ocean model hycom simulations with 41 layers and horizontal resolutions of 8 km 1 12 5 h12 and 4 km 1 25 h25 in both simulations the surface tidal error is minimized by tuning the strength of the linear wave drag which is a parameterization of the surface tide energy conversion to the unresolved baroclinic wave modes in both simulations the m 2 surface tide error with tpxo8 atlas an altimetry constrained model is 2 6 cm compared to h12 the surface tide energy conversion to the resolved vertical modes is increased by 50 in h25 this coincides with an equivalent reduction in the tuned loss of energy from the surface tide to the wave drag for the configurations studied here the horizontal and not the vertical resolution is the factor limiting the number of vertical modes that are resolved in most of the global ocean modes 1 2 in h12 and modes 1 5 in h25 the wave drag also dampens the resolved internal tides the 40 reduction in wave drag strength does not result in a proportional increase in the mode 1 energy density in h25 in the higher resolution simulations topographic mode scattering and wave wave interactions are better resolved this allows for an energy flux out of mode 1 to the higher modes mitigating the need for an internal tide damping term the hycom simulations are validated with analytical conversion models and altimetry inferred sea surface height fluxes and surface tide dissipation h25 agrees best with these data sets to within 10 to facilitate the comparison of stationary tide signals extracted from time series with different durations we successfully apply a spatially varying correction factor keywords numerical models internal tides wave damping vertical modes 1 introduction over the last decade or so much progress has been made in introducing tides into ocean general circulation models arbic et al 2018 detail the progress made in models of this type including the progress in model observational comparisons while the barotropic tides in some models of this type are now reasonably accurate in both amplitude and phase ngodock et al 2016 the accuracy of modeled internal tides and their sensitivity to damping is at a somewhat more nascent phase ansong et al 2015 buijsman et al 2016 arbic et al 2018 internal tides are internal waves at tidal frequencies and they are generated by the vertical displacement of isopycnals as the barotropic tide flows over rough bathymetry buijsman et al 2019 we are motivated to study internal tides for several reasons first internal tides act to redistribute energy from the barotropic tide on a global scale the dissipation of internal tides whether close to their generation sites or away across ocean basins mackinnon et al 2017 de lavergne et al 2019 contributes roughly one terawatt tw of energy to vertical mixing globally munk and wunsch 1998 wunsch and ferrari 2004 waterhouse et al 2014 kunze 2017 a better understanding of internal wave mixing is relevant to develop better mixing parameterizations for climate models melet et al 2013 mackinnon et al 2017 second low mode internal tides can propagate for 1000s of kilometers as observed in satellite altimetry ray and zaron 2016 zhao et al 2016 and they may affect the local generation of internal tides across ocean basins kelly and nash 2010 buijsman et al 2010 ponte and cornuelle 2013 the inclusion of these remote internal tides as a boundary condition is relevant for the correct simulation of internal tides in regional models kerry et al 2013 mazloff et al 2020 finally correctly predicting the time varying amplitudes and phases of the internal tides facilitates the separation of the sub mesoscale circulation from the internal tides which is important for the upcoming surface water and ocean topography swot mission fu et al 2012 many facets affect the predictability of the internal tide in global ocean models surface tidal forcing time variable background stratification and flow topography model resolution and subgridscale dissipation parameterizations in this paper we analyze the m 2 internal tide energetics in state of the art realistically forced global forward hybrid coordinate ocean model hycom simulations in particular we are interested in how the model horizontal resolution and wave drag damping affect the internal tide predictability internal tides undergo a myriad of dissipative processes due to lee wave breaking at generation wave wave interactions topographic scattering shear instabilities dissipation at critical slopes and shoaling on farfield continental shelves for an overview see mackinnon et al 2017 these processes are generally not well resolved in regional and global numerical ocean models and they need to be parameterized in general these parameterizations are relatively crude and do not differentiate between the various dissipation processes for example niwa and hibiya 2014 used a tuned linear damping term that operates on the baroclinic velocities in their global model with a damping time of 30 days hycom uses a linear wave drag term that operates on both the near bottom barotropic and baroclinic tidal velocities arbic et al 2010 shriver et al 2012 ansong et al 2015 buijsman et al 2016 if the wave drag is not applied to the baroclinic velocities ansong et al 2015 showed that the internal tides become too energetic as compared to the satellite altimetry however additional wave damping is not used in all global ocean model simulations for example the realistically forced global mitgcm marshall et al 1997 is run without wave drag at 1 48 horizontal resolution and its solution is too energetic in the tidal bands when compared to observations savage et al 2017a yu et al 2019 luecke et al 2020 müller et al 2012 performed global simulations with the mpi om model jungclaus et al 2006 at 1 10 horizontal resolution without wave drag and found that the internal tides are weaker than observed most likely because the model set up is too diffusive wave drag parameterizations were originally intended for global barotropic models which do not resolve internal tides these schemes represent the energy conversion from the surface tide to the full spectrum of unresolved internal tides at mid ocean ridges and continental shelves jayne and st laurent 2001 green and nycander 2013 buijsman et al 2015 however these wave drag parameterizations have also been applied in baroclinic global ocean simulations to primarily optimize the surface tide accuracy arbic et al 2004 minimized the surface tidal error by tuning the wave drag with a drag scale in global baroclinic simulations baroclinic global ocean models can only convert surface tidal energy to internal wave modes for which the horizontal and vertical grid spacings determine how well the motions are resolved the energy conversion to the unresolved higher modes is parameterized by the wave drag if one assumes that the drag scale for a drag scheme that represents the full modal spectrum is 1 in barotropic simulations it should be 1 in baroclinic simulations and increasingly smaller for higher horizontal resolutions as more vertical modes are resolved it is well known that an increase in vertical and horizontal resolution increases the wave energy in particular that of the smaller scale waves in global internal tide simulations niwa and hibiya 2014 showed that the barotropic to baroclinic energy conversion increased for higher horizontal resolutions but they did not specify if this increase was due to the contribution of higher modes the effect of model resolution on realistically forced global baroclinic simulations has been explored in several studies when analyzing hycom simulations with horizontal resolutions of 8 and 4 km and mitgcm simulations with resolutions of 8 4 and 2 km it was found that the higher frequency and higher wave number tails of the energy spectra had more energy and the simulated frequency spectra were closer to observations in the higher resolution simulations savage et al 2017b a luecke et al 2020 the higher resolution simulations featured stronger non linear wave wave interactions facilitating an improved cascade to smaller scales müller et al 2015 ansong et al 2018 one objective of this paper is to understand the effects of both horizontal resolution and wave drag strength on the energetics of the resolved internal tide modes in realistically forced global hycom simulations with horizontal grid sizes of about 8 km 1 12 and 4 km 1 25 and 41 hybrid layers in the vertical in these simulations the wave drag affects both the surface and internal tides our focus is on the m 2 internal tide as it contains about 70 of all tidal energy egbert and ray 2003 we analyze the internal tide modal energy balance kelly et al 2012 on a global scale which has not been done before in hycom or any other global forward model a second objective is to validate these hycom simulations with internal tide sea surface height amplitudes and modal energy fluxes inferred from altimetry surface tide dissipation rates estimated from an altimetry constrained model and modal conversion rates computed from analytical models as in ansong et al 2015 we note that the magnitude of the altimetry inferred sea surface height amplitudes and the modal energy fluxes is affected by the duration of the time series they are extracted from since our model simulations are shorter we apply a correction newly developed in the present work to facilitate a comparison the correction factor is explained in the appendix in the following sections we first present the model set up and energy equations we then discuss the m 2 surface and internal tide energetics that are not decomposed into vertical modes this is followed by a presentation of the modal energetics in the discussion section we synthesize our results and compare them with the literature we end with conclusions 2 methodology 2 1 hycom hycom is the operational global ocean forecast model used by the united states navy metzger et al 2014 the hybrid vertical coordinate is isopycnal in the open ocean and transitions to terrain following in shallow water with z coordinates to resolve the surface mixed layer we discuss two model simulations that are run in a forward non data assimilative mode on a tripolar grid at 1 12 5 8 km and 1 2 5 4 km nominal horizontal resolutions with 41 layers in the vertical 27 levels above 250 m most 8 m apart hereafter we refer to these simulations as h12 and h25 respectively in hycom terminology these simulations are also referred to as expt 06 1 and expt 22 1 both simulations are run with realistic atmospheric forcing from the navy global environmental model navgem hogan et al 2014 and astronomical tidal forcing for the m 2 s 2 k 1 o 1 and n 2 tidal constituents to account for numerical errors in the tidal solution due to imperfect topography and damping terms an augmented state ensemble kalman filter asenkf is applied to optimize the spatially varying self attraction and loading sal term used in the simulations ngodock et al 2016 both simulations employ a quadratic bottom drag and a linear wave drag to dampen tidal flows ansong et al 2015 to account for the energy conversion from the surface tide to the unresolved baroclinic modes and to dampen the resolved internal tides we use the scalar internal wave drag parameterization of jayne and st laurent 2001 1 ℂ π l t h ˆ 2 n b where h ˆ is the bottom roughness n b is the buoyancy frequency at the bottom and l t is the wavelength of the topography the calculation of this wave drag and its performance in barotropic simulations is discussed in buijsman et al 2015 the jayne and st laurent 2001 drag is applied to the total barotropic and baroclinic flow in the bottom 500 m for seafloor depths greater than 1000 m in addition to tidal flows the drag also acts on subtidal bottom flows to compensate for this an anti drag is applied to the bottom flows the anti drag uses non tidal bottom velocities that are a weighted average over 49 h and lagged by 24 h for a detailed description of the application of the anti drag and its impact on the baroclinic simulations the reader is referred to arbic et al 2010 to minimize the impact on non tidal motions we clip the value of ℂ at rough topography so that its minimum e folding time h ℂ 1 day where h is seafloor depth moreover ℂ is set to zero for smooth topography with an e folding time 10 days for each model simulation the wave drag is tuned with a drag scale χ to minimize the global mean m 2 root mean square error r m s e between the altimetric sea surface height from tpxo8 atlas egbert et al 1994 and the simulated sea surface height the tuned wave drag scale of buijsman et al 2015 is reset to χ 1 0 before the tuning of the h12 and h25 simulations after tuning the optimal drag scales in h12 and h25 are 0 5 and 0 3 respectively this implies that the barotropic energy loss to the resolved parameterized internal tides in h25 has been increased reduced relative to h12 the r m s e is 2 6 cm for both simulations which is similar to the results in ngodock et al 2016 instead of tuning the wave drag one could argue that it would make more sense to extract the modal drag component from the analytical modal conversion models of falahat et al 2014 or vic et al 2019 for example if the numerical model simulation resolves modes 1 and 2 one needs to apply the wave drag components of modes 3 and higher in the numerical simulation we have attempted this for the falahat et al 2014 scheme in hycom unpublished results but the high mode drag scheme needed to be modified through smoothing clipping and tuning such that it defeated the purpose of having such scheme moreover the surface and internal tides in simulations with this modal drag scheme do not significantly improve as compared to the full spectrum jayne and st laurent 2001 scheme the three dimensional 3d hycom output is saved hourly for one full year for h12 from october 2011 through september 2012 due to storage limitations we can only store 2d fields of h25 such as sea surface height ssh for an entire year 1 january to 31 december 2016 at an hourly frequency the 3d data for h25 is only stored for the month of september 2016 in this paper we perform the energy diagnostics on model data for the first two weeks of september 2012 h12 and september 2016 h25 we compare sea surface height variance computed for two week and one year long hycom time series with altimetry 2 2 m 2 energetics the hycom model output is analyzed using two different methods first we perform m 2 barotropic and baroclinic energetic calculations for the 3d fields that are not decomposed into vertical modes in the second method we decompose the 3d fields into vertical modes and compute m 2 energy metrics for these modes the application of these two methods facilitates the comparison of the model results with various observational data sets and analytical models 2 2 1 barotropic and undecomposed baroclinic energetics to better frame the modal energetics we first consider the barotropic and undecomposed baroclinic energy balances for the m 2 tide as in buijsman et al 2016 the time averaged depth integrated barotropic energy balance reads 2 p 0 f 0 c l d w0 d b0 r 0 where p 0 is the tidal energy input f 0 is the horizontal barotropic flux vector c l is the conversion of the barotropic energy to the resolved baroclinic modes d w0 is the barotropic energy loss to the wave drag i e the unresolved high mode waves d b0 is the barotropic energy loss to the quadratic bottom drag r 0 is a residual term accounting for numerical and viscous dissipation small nonlinear terms and discretization errors and subscripts 0 and l refer to the barotropic and the resolved baroclinic low modes respectively the depth integrated and time mean baroclinic energy balance reads 3 c l f l d l where 4 d l d wl d bl r l f l is the depth integrated baroclinic flux vector d l is the low mode dissipation d wl is baroclinic dissipation due to linear wave drag d bl is the dissipation due to bottom drag and r l is a residual term accounting for unresolved dissipation due to viscosity small nonlinear terms and discretization errors in this paper we evaluate some of the terms in eqs 2 and 3 for h12 and h25 we perform a least squares harmonic analysis over a two week long time series to extract the m 2 harmonic constants for the 3d hycom fields and compute the energy terms in layer space as detailed in buijsman et al 2016 we limit our time series to two weeks to mitigate data storage issues the original and interpolated time series of h12 and h25 amount to more than 100 tera bytes tb of storage we assume that during this period the internal tides are stationary in most places i e their phases and amplitudes are minimally affected by the time varying background flow see appendix 2 2 2 modal energetics we decompose the baroclinic fields into vertical modes and compute modal energetics following gerkema and zimmerman 2008 kelly et al 2012 and buijsman et al 2014 to better understand the interplay between model horizontal resolution and wave drag in a first step we interpolate the baroclinic velocities u and v and the potential density referenced to 2000 decibar ρ 2 on the hybrid coordinate grid to a z grid with δ z 25 m for every time step we average the density over two weeks and compute the buoyancy frequency n z for each horizontal grid cell we solve the hydrostatic stürm liouville equation 5 2 w n z z 2 n 2 c n 2 w n z 0 where w n z is the eigenfunction of the vertical velocity of mode n c n is the eigenspeed and z is the vertical coordinate the eigenspeed is computed as 6 c n ω 2 f 2 k n where f and ω are the coriolis and m 2 frequencies and k n is the horizontal wave number note that the phase speed is c p n ω k n and the group speed is c g n c n 2 k n ω we then compute the horizontal velocity eigenfunction 7 u n z w n z z and normalize it by 1 h h 0 u n 2 z d z where h is the seafloor depth in a next step the m 2 complex harmonic constants are extracted with a least squares harmonic fit of the interpolated u v and ρ 2 time series the perturbation pressure is computed by depth integrating the complex harmonic constants of ρ 2 and by removing the depth mean pressure then the horizontal velocity eigenfunctions are projected onto the vertical profiles of the horizontal velocity and pressure harmonic constants to yield the complex modal amplitudes in each horizontal grid cell e g 8 u ˆ n 1 h h 0 u n z u z d z where u is the complex harmonic constant of u each fitted mode is removed from the profiles of the complex harmonic constants before fitting the next mode to avoid overfitting after obtaining the eigenspeeds and complex modal amplitudes we compute the terms in the depth integrated and time averaged modal energy equation kelly et al 2012 9 m 0 5 c m n conversion ρ c h 4 u ˆ n 2 k e 1 f 2 ω 2 p ˆ n 2 ρ c c n 2 a p e t 1 2 h u ˆ n p ˆ n flux div d n dissipation where ρ c is the space and time invariant density t is time u ˆ n and p ˆ n are the complex modal amplitudes of the velocity vector and perturbation pressure is the complex conjugate and n and m are mode numbers the first term on the l h s of eq 9 is the intermodal energy conversion and the first term on the r h s is the time mean of the rate of change of kinetic k e and available potential energy a p e the second term is the energy flux divergence and the third term is the dissipation a residual term the factor 1 2 arises from time averaging over a tidal cycle note that in this case the rate of change term is close to zero and can be ignored we compute these terms for the first five modes because up to five modes are resolved in the h25 simulation see next section the barotropic to baroclinic conversion to the first five modes is n 1 5 c 0 n and should be comparable to c l of eq 2 the intermodal energy conversion term for n 0 and m 0 is computed as kelly et al 2012 10 c m n h 0 u m p n u n p m d z where u n z u ˆ n u n z and p m z p ˆ m u m z this mode scattering term is non zero when horizontal gradients in topography and stratification are present however c m n mostly correlates with topographic gradients in our simulations this term does not represent nonlinear mode mode interactions which result from the advective term in the momentum equation ignored in this analysis we compute m 1 5 c m n which is the energy transfer between each mode n and the other four modes the uncertainty for this term may be larger than for c 0 n the horizontal gradients in eq 10 are computed using central finite differences the values of the vertical profile of u m z p n z u n z p m z are set to zero downslope of the shallowest seafloor depths to avoid erroneously large values to show that this term is relevant we compute for each mode of h25 the spatial correlation r a between 1 2 h u ˆ n p ˆ n and c 0 n and the correlation r b between 1 2 h u ˆ n p ˆ n and c 0 n m 1 5 c m n the inclusion of m 1 5 c m n increases the correlation from r a 0 73 0 44 0 29 0 15 0 05 to r b 0 77 0 65 0 54 0 34 0 17 for modes 1 5 and it lowers the standard deviation of the residual dissipation d n by maximally 13 8 7 1 0 4 w m 2 68 8 1 0 4 w m 2 for mode 2 this demonstrates that the mode scattering term is relevant in particular in the h25 simulation 2 3 resolved modes the horizontal and vertical resolutions of the hycom simulations determine the number of modes that can be resolved for the simulations considered we find that the horizontal resolution is the limiting factor over most of the ocean area and not the vertical resolution of 41 layers hence in the following we discuss the effect on the horizontal wavelength the stratification in both the h12 and h25 simulations is similar yielding the same low mode wavelengths as computed with eq 6 in fig 1 we plot the mode 1 and 2 wavelengths of h25 as an example latitude seafloor depth and stratification affect the spatial variability in wavelengths the wavelength of the first baroclinic m 2 mode varies from 80 km in the eastern equatorial ocean basins to 200 km at higher latitudes fig 1a the mode 2 wavelength is about half as long fig 1b although not shown the mode 1 and 2 wavelengths agree with the wavelengths inferred from climatology and altimetry wave number spectra by ray and zaron 2016 we compute the number of grid cells that can fit inside the wavelengths of the first five modes l n δ x where l n is the modal wavelength and δ x is the maximum grid spacing of each grid cell fig 2 shows global maps of l n δ x for the first five modes for h12 and h25 if we assume that the minimum number of grid cells needed to resolve a wave mode is five then the first two and the first five modes are resolved in most of the global ocean in the h12 and h25 simulations respectively in h12 modes 3 5 are not well resolved in the equatorial and mid latitude regions white areas in fig 2 to better quantify the effect of seafloor depth on the resolved modes we area average l n δ x for seafloor depth bins with a width of 500 m e g 250 750 m 750 1250 m 1250 1750 m 5750 6250 m and for latitudes equatorward of 50 fig 3 for seafloor depths deeper than 1250 m we find that the first two and the first five modes are resolved in the h12 and h25 simulations respectively in the shallowest depth bin of 250 750 m only mode 1 and the first three modes are resolved in h12 and h25 respectively hence we solve for the first five modes in h12 and h25 as the waves are not well resolved in shallow water due to the horizontal model resolution and the vertical spacing of the z grid we do not compute modal energetics shallower than seafloor depths of 250 m hycom s horizontal grid is a c grid arakawa and lamb 1977 a c grid is prone to gridscale noise that is due to spatial averaging of coriolis momentum terms and that is apparent when the grid resolution is coarse with respect to the baroclinic deformation radius l ρ adcroft et al 1999 according to adcroft et al 1999 the c grid may cause noise when the wave resolution r w 2 l ρ δ x 1 we compute r w for modes 1 5 and find that r w 1 for the resolved modes in h12 and h25 i e it is unlikely that these modes feed energy into short scale perturbations that allow standing gridscale noise to persist such noise has not been observed in the simulations 2 4 validation data and statistical analysis we validate our hycom simulations with observations and analytical model results for some model data comparisons we compute the following statistics ansong et al 2017 the correlation coefficient r the ratio γ between the simulated and observed variables and the regression coefficient a i e the slope which is obtained with a linear least squares regression v a r hycom a v a r observation where v a r is a variable the results of the statistical analysis are in table 1 in the following we discuss the various validation data sets we compare hycom m 2 internal tide sea surface height variance computed for a two week and one year long time series with that extracted from 17 years of altimetry time series which were also used by shriver et al 2012 we apply a least squares harmonic fit to the altimetry and hycom data to extract the harmonic constants we interpolate the harmonic constants of hycom to the same locations as the altimetry data for seafloor depths deeper than 1500 m the internal tide harmonic constants are recovered from the hycom and altimeter data sets via along track band pass filtering to permit wavelengths in the 50 400 km range at the mid latitudes the internal tide length scales and periods are similar to those of the mesoscales hence the non tidal motions may be aliased into the internal tide signals extracted from satellite altimetry ray and byrne 2010 shriver et al 2012 to reduce these effects data that coincide with eddy kinetic energy e k e 200 cm 2 s 2 are excluded from the statistical analysis although e k e is large near the equator the rossby radii are much larger than the internal tide wavelengths hence we do not omit data for latitudes ϕ equatorward of 20 this e k e data set is based on surface drifter velocities from the global drifter program and is adapted from whalen et al 2012 we compare the area integrated loss of surface tide energy in hycom to the barotropic dissipation inferred from tpxo8 atlas these dissipation rates are computed as the residual of the sum of the tidal energy input and barotropic flux divergence green and nycander 2013 the dissipation rates used here have also been used in buijsman et al 2015 the globally integrated modal conversion rates of hycom are compared with the rates from analytical models by falahat et al 2014 and vic et al 2019 in these analytical models the conversion rates are computed by multiplying a linear wave drag parameterization based on theory by bell 1975 with barotropic tidal velocities from the tpxo tide model as in vic et al 2019 we do this comparison for seafloor depths 700 m because the linear analytical models do not well predict conversion rates at supercritical slopes we compare the mode 1 and 2 fluxes of h25 to the energy fluxes that are extracted from altimetry data sets with a plane wave fit method by zhao et al 2016 and zhao 2018 the plane wave fit method yields fluxes for three directions we use their vector sum for the comparison the hycom fluxes are averaged to the cartesian 0 2 grid of the altimetry data to facilitate the statistical analysis data that coincide with e k e 200 cm 2 s 2 except for ϕ 20 are excluded from this analysis 3 results 3 1 undecomposed fields 3 1 1 m 2 internal tide sea surface height variance before considering the tidal energetics we compare the stationary m 2 internal tide sea surface height variance of h12 and h25 to altimetry the variance is computed as σ 2 1 2 η 2 where η is the complex harmonic constant computed over the two week and one year long time series the sea surface height variance is mostly dominated by the low vertical modes the internal tide ssh variance of the two week long uncorrected h12 and h25 time series σ 2 2w in fig 4a and b is about twice as large as the variance of the altimetry in fig 4i and table 1 the mean variance in h12 and h25 in the hotspot regions is respectively 71 0 22 cm 2 0 30 cm 2 and 108 0 33 cm 2 0 30 cm 2 larger than the altimetry variance averaged over the global ocean the variance in h12 and h25 is 71 0 08 cm 2 0 11 cm 2 and 110 0 12 cm 2 0 11 cm 2 larger respectively the correlation between the simulated variance and the altimetry is modest albeit that it is slightly better for h25 r 0 54 than for h12 r 0 52 table 1 when we compare the h12 to the h25 simulations we find that the h25 simulation is about 21 0 11 cm 2 0 52 cm 2 more energetic than h12 in the hotspot regions whereas in a globally integrated sense h25 is 23 0 04 cm 2 0 19 cm 2 more energetic than h12 this difference is because the atlantic ocean which does not have hotspot boxes is more energetic in h25 than in h12 it is to be expected that the stationary variance for the two week long hycom time series is larger than the variance extracted from the 17 year long altimetry time series because the stationary variance decreases with the time series duration appendix to illustrate this point we also compute the m 2 variance for the one year long hycom time series σ 2 1y fig 4c and d the largest differences between σ 2 2w and σ 2 1y occur in areas with the strongest time variability in subtidal background flows such as in the equatorial pacific buijsman et al 2017 although σ 2 1y is smaller than σ 2 2w the globally averaged σ 2 1y is still larger than the altimetry variance by 15 0 02 cm 2 0 11 cm 2 and 28 0 03 cm 2 0 11 cm 2 for h12 and h25 respectively this difference is larger in the hotspot regions 36 0 11 cm 2 0 30 cm 2 and 43 0 13 cm 2 0 30 cm 2 for h12 and h25 respectively the correlation between the year long hycom and altimetry variance is better than for the two week time series r 0 68 for h12 and r 0 77 for h25 table 1 to ensure a more apples to apples comparison we correct the hycom variance for the two week and one year long time series with a spatially varying correction coefficient which is close to unity in the nearfield and small in the farfield this correction coefficient is derived in the appendix using an older six year long 8 km hycom simulation the corrected m 2 ssh variance for the two week long time series σ 2 2wc and the one year long time series σ 2 1yc are shown in fig 4e and g for h12 and in fig 4f and h for h25 although the correction factor reduces the variance more for the two week than for the one year long time series the corrected variance of h12 and h25 for both durations is approximately similar to the altimetry variance in accordance the relative increase in the correlation coefficient due to the correction is larger for the two week time series table 1 while the corrected variance for h12 is generally underpredicted the corrected variance for h25 is overpredicted for both durations the agreement for the one year long h25 time series is the best with γ r and a being the closest to unity table 1 after correction the mean variance of the two week long h25 time series is 11 0 03 cm 2 0 30 cm 2 larger than the altimetry variance in the hotspot regions while it is only 2 0 002 cm 2 0 110 cm 2 larger when averaged over the global ocean in contrast the mean variance of the one year long time series is 23 larger 0 07 cm 2 0 30 cm 2 in the hotspot regions and 9 0 01 cm 2 0 11 cm 2 larger over the global ocean 3 1 2 barotropic and baroclinic m 2 energetics for h12 and h25 we compute the time mean depth integrated and global area integrated energy input p 0 the barotropic conversion to the resolved internal tides c l the barotropic loss to the wave drag d w0 the barotropic energy loss to the resolved and unresolved wave modes c l d w0 and the energy loss of the resolved internal tides to the wave drag d wl where indicates an area integration fig 5 the m 2 energy input and the barotropic energy loss to the internal tides are also computed for tpxo8 atlas data green and nycander 2013 and compared with the hycom simulations p 0 is computed for all seafloor depths while the other terms are computed for seafloor depths deeper than 250 m the tpxo8 atlas dissipation includes both surface tide energy loss to the internal tides and bottom drag the former occurs in deep water while the latter occurs primarily in coastal shelf seas shallower than 250 m the energy input for both hycom solutions compares well with that of tpxo in h25 the resolved barotropic to baroclinic energy conversion c l is about 0 21 tw larger than in h12 this increase in the conversion in h25 is offset by a near equal reduction of 0 20 tw in the energy conversion to the unresolved modes d w0 in h25 as a consequence c l d w0 is about the same for both h12 and h25 simulations this result is consistent with both simulations having the same tidal accuracy and energy input c l d w0 is about 11 0 09 tw 0 87 tw larger than the deep water barotropic dissipation of tpxo which is a fairly good agreement the weaker drag scale in h25 yields a smaller d w0 as compared to h12 at the same time h25 resolves more higher modes increasing c l the increase of c l in h25 relative to h12 is the largest over the deeper mid ocean ridges not shown which are more efficient higher mode generators in contrast the differences in c l at the tall mid ocean ridges such as hawaii are smaller because the conversion at these ridges is mostly due to low modes which are both resolved in h12 and h25 although the drag scale is smaller for h25 the internal tide energy loss to the wave drag d wl is about the same in h12 and h25 because h25 features more internal tide energy in the next section we discuss the modal decomposition of this energy 3 2 modal m 2 energetics 3 2 1 internal tide generation as the surface tide oscillates over underwater topography surface tide energy is transferred to baroclinic modes the global integral of the time mean barotropic to baroclinic conversion to the full spectrum of the resolved internal tides c l of eq 2 and to the first five modes c 0 n of eq 9 is presented in fig 6 the rates computed for seafloor depths 250 m are shown in fig 6a in the open ocean most of the surface tide energy is converted into mode 1 in the h12 and h25 simulations however the higher horizontal resolution of h25 resolves more higher vertical modes than h12 c 01 of h25 is 19 0 05 tw 0 27 tw larger than that of h12 the increase in the mode 1 conversion may be attributed to a better resolved bathymetry in h25 the mode 2 conversion is 63 0 05 tw 0 08 tw larger in h25 and this difference becomes much larger for higher modes the sum of the conversion over all modes is about 8 smaller than the undecomposed conversion c l for both h12 0 03 tw 0 40 tw and h25 0 05 tw 0 60 tw the difference may be due to missed higher modes imperfect modal fits and interpolation errors we also compare the hycom conversion rates to the rates computed with the analytical models of vic et al 2019 and falahat et al 2014 for seafloor depths 700 m in fig 6b compared to the analytical conversion rates h25 performs quite well for modes 1 to 4 while only modes 1 and 2 of h12 compare well with the analytical rates the mode 5 conversion of h25 is about 30 0 01 tw 0 03 tw smaller than the analytical rates we note that for h12 and h25 about 30 0 08 tw 0 27 tw and 0 10 tw 0 32 tw of the mode 1 conversion occurs in the seafloor depth range of 250 700 m this implies that the choice of the minimum cutoff depth can impact global energy budget calculations to visualize the spatial distribution of the modal conversion rates in h25 we average the rates to 2 2 bins fig 7 this procedure reduces the visually distracting presence of negative conversion rates which occur when the perturbation pressure is out of phase with the local barotropic velocities i e energy is transferred from the internal to the surface tide simmons et al 2004 buijsman et al 2010 kelly and nash 2010 the mode 1 conversion rates in fig 7a are largest at tall ocean ridges e g in the western pacific and indian ocean and along some continental shelves e g the bay of biscay and the amazon shelf although the appearance of the most energetic mode in fig 7b and the mode 1 conversion as fraction of the first five modes in fig 7c is noisy large scale patterns are visible these patterns are in agreement with results by de lavergne et al 2019 and vic et al 2019 in most of the ocean the mode 1 conversion dominates in h25 while modes 2 4 are relatively more important at the flat and wide mid ocean spreading ridges such as the mid atlantic ridge the southwest and central indian ridges and the east pacific rise fig 7b and c at these deep ridges mode 1 comprises less than 20 0 11 tw 0 55 tw of the conversion to the first five modes fig 7c 3 2 2 internal tide propagation next we evaluate the energy density and energy fluxes to better understand the propagation of the internal tide modes in h12 and h25 in fig 8 we present maps of the kinetic energy k e for the first five modes for h12 and h25 maps of the available potential energy a p e are similar and are not shown in both h12 and h25 beams of mode 1 energy radiate away from generation hotspots such as the hawaiian polynesian and mariana ridges in the pacific georges bank and the amazon shelf in the atlantic and the mascarene nicobar and andaman island ridges in the indian ocean fig 8a and f the lengths of some mode 1 beams are longer than 3000 km reflecting the low decay rates of the mode 1 waves beams of mode 2 energy are not as intense nor do they propagate as far but strong signals extend hundreds of kilometers away from generation sites such as the amazon shelf the mascarene ridge and the aleutians fig 8b and g while the difference in mode 1 energy density between h12 and h25 is relatively small the mode 2 beams of h25 are more energetic than those of h12 for baroclinic modes 3 to 5 more differences are evident in the kinetic energy maps for h12 and h25 fig 8c e and h j for h12 little to no high mode energy is present in areas where l n δ x 5 in fig 2 at higher latitudes where the grid spacing decreases some energy is present equatorward of the turning latitude 74 5 for the m 2 tide for example south of tasmania in h25 baroclinic kinetic energy in modes 3 to 5 is found near topography in the interior ocean especially near island chains like hawaii polynesia indonesia madagascar and along the mid atlantic ridge in contrast to modes 1 and 2 higher mode beams are more diffusive and harder to distinguish this may be attributed to higher modes having more generation sites than modes 1 and 2 topographic scattering wave wave interactions and refraction by the background flow to which higher modes are more susceptible than low modes rainville and pinkel 2006 there is a patch of elevated energy for modes 3 to 5 in the north pacific in both simulations fig 8c e and h j this is likely caused by a thermobaric instability tbi hallberg 2005 a numerical instability in isopycnal hybrid models that implement thermobaricity as a perturbation from reference compressibility states the tbi effect is larger in h25 because the instability has a strong vertical shear that projects onto the higher modes tbi mostly affects the energy density energy fluxes and dissipation of modes 3 to 5 whereas the conversion and topographic scattering are not much affected we note that the tbi noise differs from gridscale noise associated with c grids adcroft et al 1999 because in the former progressive high mode waves are generated while in the latter standing noise patterns are generated we do not observe these standing noise patterns in h12 and h25 we compute global integrals of the modal k e and a p e and the sum over all modes for seafloor depths 250 m fig 9 the energy density of modes 3 5 inside the polygons marking the extent of the tbi areas in fig 8e and j is excluded from the analysis on average k e is about 15 larger than a p e for both h12 and h25 ignoring modes 3 5 of h12 h25 has more total energy than h12 for all modes 34 22 0 pj 64 2 pj more in mode 1 68 15 4 pj 22 6 pj more energy in mode 2 and increasingly more for higher modes note that this 34 increase in mode 1 energy is of the same order of magnitude as the 23 increase in two week ssh variance in h25 relative to h12 fig 4 summed over all modes k e a p e and their sum are about 60 larger in h25 than in h12 the globally integrated kinetic available potential and total energies of h25 are 84 pj 69 pj and 153 pj respectively of which mode 1 comprises about 56 we compare the uncorrected and corrected m 2 mode 1 and mode 2 fluxes of h25 with the mode 1 and mode 2 fluxes extracted from altimetry in fig 10 and table 1 the uncorrected mode 1 and mode 2 fluxes of h25 in fig 10a and d are larger than the altimetry fluxes in fig 10c and f the differences are largest for the mode 2 fluxes the application of the spatially varying correction factor appendix to the h25 fluxes improves the agreement with the altimetry fig 10c and e the correction factor is the same for both ssh variance and fluxes because both scale with u 2 the improvement is most noticeable in the equatorial pacific after the correction the regression a ratio γ and correlation r coefficients are closer to unity for the magnitude and the x and y vector components of the energy flux table 1 of all the vector components the correlation is the largest for the absolute mode 1 flux f 1 the correlation has improved from 0 54 to 0 60 after correction due to the aforementioned north south bias of the altimetry the model correlates better with the altimetry for f y than for f x the coefficients a γ and r for the flux comparison deviate more from unity than the coefficients computed for the ssh variance table 1 this is particularly true for the mode 2 fluxes in addition to the north south bias other reasons for this deviation may be that the plane wave fit yields a more diffuse beam field than the simulated wave field and that the location of some beams is incorrectly predicted by hycom 3 2 3 mode scattering propagating low mode internal tides may scatter to higher modes at spatially varying underwater topography and stratification the low mode scattering in the h12 and h25 simulations is mostly due to topographic gradients the scattering process is represented by c m n for m 0 and n 0 the global integral of m 1 5 c m n for seafloor depths deeper than 250 m is shown in fig 11 for both the h12 and h25 simulations m 1 5 c m n is negative for mode 1 and positive for modes 2 5 implying that energy is transferred from mode 1 to higher modes the scattering out of mode 1 is about twice as strong in h25 because h25 has a better resolved bathymetry and it resolves more higher modes than h12 for h12 and h25 m 1 5 c m 1 is about 10 0 03 tw 0 27 tw and 20 0 07 tw 0 32 tw of c 01 respectively this fraction is of the same magnitude as the estimate by de lavergne et al 2019 who found that 19 of mode 1 is scattered by hills thus excluding continental shelf topography but lower than the estimate by eden and olbers 2014 who found that 53 of mode 1 is scattered at both hills and shelves the spatial variability of the energy scattered from mode 1 m 1 5 c m 1 is highlighted in fig 12 as for the conversion in fig 7a we average m 1 5 c m 1 to 2 2 bins to better visualize the spatial trends overall m 1 5 c m 1 is negative although some randomly distributed positive values occur which are invisible due to the choice of colormap similar to the energy conversion from the surface tide to mode 1 fig 7a the energy scattered out of mode 1 is also large at steep topography such as mid ocean ridges hills islands and shelves fig 12 in contrast to the energy conversion from the surface tide to mode 1 the conversion from mode 1 to higher modes is relatively more important at the slightly wider and deeper ridges and hills such as the mid atlantic ridge the line islands ridge south of hawaii johnston et al 2003 and the mascarene plateau north of madagascar in the indian ocean 3 2 4 synthesis of the baroclinic energy balance in this section we discuss the relevant energy terms as a function of seafloor depth fig 13 shows the total energy and the terms from the modal and undecomposed baroclinic energy balances for the h12 and h25 simulations we compare the modal energy terms of eq 9 summed over the first five modes solid black blue and red lines in fig 13 with the undecomposed energy terms of eq 3 same colored dotted lines the summed modal terms generally demonstrate the same trends as the undecomposed terms but they are slightly smaller this shows that the modal computations are credible even though they are based on depth interpolated fields all energy terms have larger amplitudes in h25 as compared to h12 which is attributed to the larger contribution of the higher modes in h25 the total energy in fig 13a and b is proportional to the binned seafloor area r 0 99 fig 13b and reaches a maximum for seafloor depths of about 4500 m the mode 1 energy of h12 is about the same as in h25 fig 13a and b the difference between the modal sums of the energy densities of h12 and h25 is largest over the deeper ridges where more higher modes are generated see also fig 7b and c in contrast to the depth integrated energy a relatively large fraction of the total conversion occurs in shallow water about 31 0 10 tw 0 33 tw of the mode 1 conversion and 21 0 12 tw 0 56 tw of the conversion to modes 1 5 occurs for seafloor depths 750 m for larger seafloor depths the conversion portrays a linear decline with depth in both h12 and h25 the flux divergence is positive for seafloor depths shallower than 3 km while it is negative for larger depths fig 13c and d this pattern reflects an energy flux from shallow water where the conversion is large to deeper water where the energy and dissipation are large the large conversion for the shallow seafloor depth bin of 250 750 m coincides with relatively large dissipation rates fig 13c and d both can be attributed to mode 1 which is the most dominant mode at tall and steep topography in h12 and h25 about 75 62 gw 83 gw and 62 63 gw 102 gw of the mode 1 conversion is locally dissipated hydraulic jumps and lee waves which can occur at tall ridges legg and huijts 2006 are not well resolved in hycom simulations this may inflate the modeled dissipation rates relative to values in the actual ocean in idealized high resolution simulations that resolve breaking lee waves the local dissipation fraction is about 10 40 buijsman et al 2012 alford et al 2015 which is lower than observed in hycom in deep water the dissipation in fig 13c and d is attributed to the remotely generated low modes and locally generated higher modes for seafloor depths of 4500 m about 40 of the dissipation over modes 1 5 is due to mode 1 in h25 the dissipation in h25 is about 50 0 19 tw 0 40 tw larger than in h12 red solid and dotted lines in fig 13c and d which is due to the increase in high mode internal tide energy in h25 the increase in the energy density in h25 has contributed to a 21 0 03 tw 0 15 tw increase in the baroclinic drag loss d wl gray dashed line in fig 13c and d despite the 40 0 2 0 5 reduction in drag scale in h25 the difference between d wl and d l red dotted line represents the viscous and numerical dissipation nonlinear wave wave interaction and wave scattering terms this difference is largest in shallow water due to the relatively large conversion rates and the small baroclinic drag loss which peaks for seafloor depths of about 3500 m 4 discussion 4 1 interplay between model resolution and wave drag the reduction in hycom s horizontal grid spacing from 8 to 4 km has resulted in the generation of more higher wave modes in h25 figs 5 and 6 while in h12 only 2 modes are resolved in h25 up to 5 modes are resolved we emphasize that the horizontal and not the vertical resolution is the limiting factor in the number of modes that can be resolved in our simulations the increase in resolved high mode conversion in h25 is offset by a decrease in surface tide energy loss to the wave drag d w0 fig 5a which parameterizes the energy conversion to the unresolved high modes this reduction in wave drag loss by the surface tide is due to a reduction in the drag scale by 40 which is tuned in the h12 and h25 simulations to optimize the barotropic tidal accuracy since the wave drag also operates on the internal tides one may expect that a 40 reduction in drag strength will further increase the internal tide energy in h25 since mode 1 is the dominant mode we will evaluate the impact of this drag scale reduction on mode 1 in a linear system the reduction in wave drag damping may increase the mode 1 energy by a factor 1 1 0 4 1 67 a 67 increase compared to h12 the mode 1 conversion has increased by about 19 in h25 fig 6 this implies that the energy can increase by a factor 1 67 1 19 1 98 a 98 increase however the mode 1 energy has increased by only 34 in h25 fig 9 the difference between these numbers may be attributed to an increase in the scattering of mode 1 waves to higher modes at topography fig 11 non linear wave wave interactions müller et al 2015 ansong et al 2018 and numerical and viscous dissipation fig 13 in the h25 simulation as compared to the h12 simulation ansong et al 2018 find that about 0 04 tw is lost to parametric subharmonic instability psi from the semidiurnal internal tide in 4 km hycom simulations this is of the same order of magnitude as the energy lost from mode 1 due to topographic scattering 0 066 tw 4 2 how realistic are the internal tides in hycom as explained in the introduction no other realistically forced global ocean model has been validated as thoroughly as hycom see arbic et al 2018 for a recent accounting of our many model data validation efforts in this paper we have validated the internal tides in the h12 and h25 simulations with altimetry derived ssh variance and energy fluxes tpxo8 atlas surface tide dissipation rates and conversion rates estimated from analytical models in addition these simulations have also been compared to mooring data in savage et al 2017a ansong et al 2017 and luecke et al 2020 overall the h25 simulation is in better agreement with observations and analytical models than h12 hence we will only discuss h25 in this section we note that h12 is an improvement over the 8 km hycom simulation discussed in shriver et al 2012 and buijsman et al 2016 because the surface tides in h12 are more accurate h12 has 41 layers as opposed to 32 and the wave drag damping is less in h12 for example the uncorrected global mean m 2 internal tide ssh variance of the h12 simulation is about 40 0 035 cm 2 0 08 cm 2 larger than the hycom simulation analyzed by shriver et al 2012 and buijsman et al 2016 4 2 1 mooring observations ansong et al 2017 compare the simulated mode 1 and mode 2 m 2 internal tide energy fluxes to observed fluxes at 79 historical mooring locations they find that the spatially averaged mode 1 mode 2 hycom fluxes computed from model data subsampled at instrument depths are 4 32 smaller than the observed fluxes i e γ equals 0 96 0 68 the regression coefficient a is 0 82 0 55 luecke et al 2020 compares k e and temperature variance in h25 for 3000 historical mooring observations for the semidiurnal frequency band γ is 0 64 and 0 44 and a is 0 64 and 0 47 for k e and temperature variance respectively in both studies γ and a are close to unity although the hycom values bias low possibly due to the under representation of higher modes in the simulations 4 2 2 altimetry how do these findings compare to the model validation of this paper the corrected m 2 internal tide ssh variance of h25 for the one year time series agrees well with altimetry after we apply a correction for time series duration r 0 78 γ 1 09 and a 0 97 table 1 and fig 4 however h25 is slightly more energetic than the altimetry the corrected variance in the hotspot regions is 23 larger and the global mean variance is 9 larger for the year long time series despite this fair agreement there are reasons for caution first we note that the correction factor represents both the nonstationary scattering and dissipation it is not clear from this analysis how well hycom simulates the individual nonstationary scattering and dissipation processes moreover the variance correction method also has some uncertainty the corrected global mean variances for the two week and one year long time series for h12 and h25 differ by about 20 0 018 cm 2 0 089 cm 2 and 7 0 008 cm 2 0 112 cm 2 respectively ideally these differences should not exist after correction our correction method is based on the older hycom simulations discussed in shriver et al 2012 appendix we do not yet know how the variance decay is affected by the higher horizontal and vertical resolution of the h12 and h25 simulations on the other hand there is uncertainty in separating the mesoscales from the internal tide scales in the altimetry signal ray and byrne 2010 the differences between the corrected hycom and the altimetry inferred fluxes for mode 1 and 2 are larger than for the ssh variance table 1 and fig 10 in particular for mode 2 similar to the ssh variance the predicted fluxes are larger than the altimetry fluxes the differences may be attributed to the different flux calculation methods and the along track bias of the plane wave fit method the global integral of the resolved and parameterized surface to internal tide energy conversion c l d w0 for seafloor depths 250 m in h25 is also in agreement with the surface tide dissipation inferred from tpxo8 atlas fig 5 the dissipation in h25 is only 11 larger than in tpxo8 atlas we are aware of several uncertainties associated with the calculation of d w0 in h25 and the surface tide dissipation inferred from tpxo8 atlas the wave drag dissipation in hycom should be computed using the total tidal flow d w ρ c ℂ u t u t buijsman et al 2016 where ℂ is the wave drag and u t u u u and u are the total baroclinic and barotropic horizontal velocity vectors respectively in order to avoid barotropic baroclinic cross terms based on u u we apply a linear split to compute the barotropic and baroclinic components d w0 and d wl these terms are based on u t u and u t u respectively buijsman et al 2016 we find that the cross term amounts to about 10 of d w0 which is about the same as the difference between c l d w0 and tpxo the surface tide dissipation from tpxo8 atlas has also some uncertainty it is computed as a residual term as a consequence the dissipation as function of the horizontal coordinate has negative values at high latitudes and in some coastal shelf areas where the tpxo solution is less well constrained egbert and ray 2003 green and nycander 2013 buijsman et al 2015 egbert and ray 2003 estimated error bars of 20 for an older tpxo inverse model 4 2 3 analytical conversion models the modal conversion in the h25 simulation agrees very well with the analytical models by falahat et al 2014 and vic et al 2019 for seafloor depths 700 m the global integrals over the first 5 modes for the three models differ by less than 1 fig 6b we find that the mode 1 conversion for seafloor depths 700 m constitutes about 21 0 19 tw 0 90 tw and 27 0 22 tw 0 83 tw of the sum of the resolved and parameterized conversion n 1 5 c 0 n d w 0 in h12 and h25 respectively these ratios are in accordance with those computed with the analytical model by vic et al 2019 34 and 29 when abyssal hills are excluded and included respectively the catch is that a relatively large fraction of the resolved conversion in h25 occurs over seafloor depths ranging from 250 m to 750 m about 21 of the conversion to modes 1 5 and about 31 of the conversion to mode 1 however the shallow water conversion rates of hycom are more difficult to validate because the analytical models break down on super critical slopes that mostly occur in shallow water unfortunately the 4 km hycom simulation and most other global simulations of similar and coarser resolution see introduction the altimetry constrained models and the analytical conversion models are currently unable to reliably estimate the internal tide generation at shelf breaks and in shelf seas shallower than 250 m at the global scale here thus lies an opportunity for future research to better constrain the barotropic to baroclinic conversion in these shallow seas 4 2 4 energy density few studies exist that report on estimates of the global internal tide energy de lavergne et al 2019 computed 165 pj in mode 1 for seafloor depths 400 m zhao et al 2016 applied a harmonic plane wave fit to 20 year long time series of altimetry ssh and estimated 36 pj of energy in the mode 1 internal tide for seafloor depths greater than 500 m the h25 mode 1 k e a p e for seafloor depths 500 m is 84 6 pj which is only 1 9 smaller than the energy for depths 250 m fig 9 compared to h25 the mode 1 energy in the model of de lavergne et al 2019 is quite large this may be attributed to the large wave wave interaction e folding decay times used in their model the hycom and de lavergne et al 2019 internal tide energy reflect the sum of the stationary and nonstationary fractions whereas the altimetry based estimate only reflects the stationary fraction moreover zhao et al 2016 estimated energy by excluding the western boundary and antarctic circumpolar current regions hence we omit regions with e k e 200 j m 2 for ϕ 20 and we correct our mode 1 energy estimate of h25 with the spatially varying correction factor from the appendix after these corrections the globally integrated mode 1 stationary energy of h25 equals about 45 pj which is in closer agreement with the altimetry estimate by zhao et al 2016 as pointed out by de lavergne et al 2019 the estimate by zhao et al 2016 may still be a lower bound because the plane wave fit technique is biased towards the north south beams which are more aligned with the altimetry tracks 4 3 future research in contrast to buijsman et al 2016 de lavergne et al 2019 and vic et al 2019 we have not compared our hycom model simulations with microscale and finestructure dissipation observations in this paper the nonlinear dissipation depends on the integral of all tidal flows whereas we have only considered the m 2 tide in this paper we plan to compute the dissipation due to the combined effect of the diurnal and semidiurnal internal tides and compare these with observations in a follow up paper we have been fortunate with the choice of the wave drag set up in h25 as it provides accurate surface tides and it does not seem to greatly under or overdamp the internal tides these hycom experiments suggest that the need for an explicit baroclinic wave damping is mitigated in higher resolution simulations because topographic wave scattering and wave wave interactions are better resolved yet in our 4 km simulations some damping is still necessary ideally we would like to apply an internal tide damping term that is decoupled from the surface tide damping most likely such scheme would still need a tuning parameter 5 conclusions in this paper we have performed a full and modal energy balance analysis for the m 2 internal tide in realistically forced global hycom simulations with a horizontal resolution of 8 km h12 and 4 km h25 these simulations have been evaluated with altimetry inferred sea surface height and fluxes tpxo8 atlas surface tide dissipation rates and analytical models of the barotropic to baroclinic energy conversion our most important findings are the increase in horizontal grid size from 8 to 4 km coincides with a reduction in wave drag strength by 40 this reduction is due to the tuning of the drag to optimize the barotropic tidal accuracy the associated reduction in surface tide energy loss to the wave drag i e the parameterized energy conversion to the unresolved high modes is offset by an increase in the barotropic to baroclinic energy conversion to the resolved baroclinic wave modes in h25 in both the h12 and h25 simulations the sum of the resolved and parameterized conversion is equal which is consistent with both simulations having the same tidal accuracy the energy conversion is larger in h25 than in h12 because the higher resolution of h25 resolves up to 5 modes in contrast only 2 modes can be resolved in h12 for seafloor depths deeper than 250 m the horizontal resolution and not the vertical resolution determines the number of modes that can be resolved at least in the simulations presented here overall mode 1 is the dominant mode in both the h12 and h25 simulations in both simulations the mode 1 conversion constitutes about 30 of the sum of the resolved and parameterized conversion which is in agreement with the analytical conversion model of vic et al 2019 in the h25 simulation the mode 1 conversion is largest over the tall mid ocean ridges and shelf breaks whereas the higher mode conversion becomes relatively more important over the deep mid ocean ridges such as the mid atlantic ridge compared to h12 the global integral of barotropic to baroclinic energy conversion in h25 has increased by 19 for mode 1 and by 49 for modes 1 5 while the global integral of the energy density has increased by 34 for mode 1 and by 60 for modes 1 5 the wave drag also dampens the internal tides in a linear system a 40 reduction in damping and a 19 increase in mode 1 conversion should double the mode 1 energy density when the grid size is increased from 8 to 4 km however the mode 1 energy density increase is much smaller because the increased resolution facilitates the transfer of energy out of mode 1 to smaller scales and higher frequencies due to enhanced topographic mode scattering about 20 of the mode 1 conversion and wave wave interactions the higher resolution 4 km hycom simulation begins to cascade energy to smaller scales and higher frequencies but these energy transfers are not yet strong enough to omit the application of an internal wave damping parameterization h25 agrees better with observations and analytical models than h12 and a prior hycom simulation discussed in buijsman et al 2016 on the one hand the comparison with the sparse mooring data suggests that h25 underestimates the internal tide energy by less than 10 while on the other hand the comparison with the altimetry inferred ssh variance indicates that h25 overestimates the global mean wave energy density by about 10 and the energy density in the hotspot regions by about 20 the sum of the resolved and parameterized conversion in h25 is also 10 larger than the surface tide dissipation estimated from tpxo8 atlas however the simulated modal conversion rates are in good agreement with the analytical conversion models it is plausible that these differences fall within the range of uncertainties associated with the analysis techniques and the validation data sets the hycom and altimetry sea surface height time series have durations of one year and about 20 years respectively which prevents a direct comparison of stationary tide signals to permit an apples to apples comparison we apply a correction to account for the decrease in the stationary signal as a function of the duration of a time series that includes both tidal and mesoscale variability appendix this correction improves the correlation regression and variance ratios between the altimetry and corrected hycom data sets credit authorship contribution statement maarten c buijsman conceptualization formal analysis funding acquisition project administration visualization writing original draft writing review editing gordon r stephenson formal analysis visualization writing original draft writing review editing joseph k ansong writing review editing brian k arbic funding acquisition writing review editing j a mattias green resources writing review editing james g richman writing review editing jay f shriver formal analysis resources software writing review editing clément vic resources writing review editing alan j wallcraft formal analysis resources software writing review editing zhongxiang zhao resources writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments m buijsman and g stephenson are funded by the office of naval research onr usa grants n00014 15 1 2288 and n00014 15 1 2578 national science foundation nsf usa grant oce1537449 and national aeronautic space administration nasa usa grants 80nssc18k0771 and nnx17ah55g b k arbic acknowledges support from onr usa grant n00014 15 1 2288 nasa grants nnx17ah55g and nnx16ah79g j ansong and b arbic acknowledge funding from the university of michigan usa associate professor support fund which is supported by the margaret and herman sokol faculty awards and from national science foundation nsf usa grant oce 0968783 the latter was part of a multi institution climate process team grant led by j mackinnon we thank c whalen a waterhouse e kunze and e zaron for comments and suggestions on an earlier version of this manuscript finally we acknowledge the two reviewers who s comments and suggestions have improved this article appendix computation of the variance correction factor as internal tides propagate through a time varying mesoscale background field the observed eulerian internal tide amplitudes and phases will vary in time due to refraction reflection and ducting shriver et al 2014 zaron and egbert 2014 zaron 2017 buijsman et al 2017 duda et al 2018 nelson et al 2019 to extract amplitudes and phases harmonic constants from model simulations and observations such as satellite altimetry and mooring records a least squares harmonic analysis is generally applied this yields the stationary internal tide variance which is inversely proportional to the duration of the time series colosi and munk 2006 nash et al 2012 ansong et al 2015 in this paper we validate two week and one year long m 2 steric sea surface height ssh records of the hycom simulations with 17 year long altimetry records m 2 ssh variance extracted from altimetry records that are longer than 10 years is most likely close to equilibrium while hycom simulations of one year or shorter are not colosi and munk 2006 ansong et al 2015 hence we need to make a correction for the time series duration to compare the stationary signal extracted from the hycom simulations with the stationary internal tide signal extracted from altimetry this correction factor has the form a 1 λ τ σ oeq 2 σ o τ 2 where σ oeq 2 is the equilibrium stationary variance and σ o τ 2 is the stationary variance of a time series with a duration τ both σ oeq 2 and σ o τ 2 can be spatially varying and should be computed from an observational record e g altimetry that is sufficiently long such that its variance has equilibrated to compare the variance of the short duration hycom simulations σ h τ 2 with the equilibrated altimetry variance the hycom variance can be corrected as follows a 2 σ heq 2 λ τ σ h τ 2 technically σ oeq 2 and σ o τ 2 should be computed from the altimetry record however the altimetry record is sparse with a sampling interval of 10 days and no coverage poleward of 66 the long sampling interval allows for the aliasing of non tidal signals into the tidal record in the western boundary current regions ray and byrne 2010 and makes it difficult to compute accurate σ o τ 2 for time series records shorter than 3 to 4 years similar to colosi and munk 2006 we could use tide gauge time series to compute λ τ however the mesoscale background variability is variable in space shriver et al 2014 buijsman et al 2017 consequently close to the internal tide generation site the internal tide is very stationary while farther away from the source the nonstationary fraction is much larger as is shown below this also causes λ τ to be spatially variable in particular for time series shorter than one year to account for the spatial variability we compute λ τ using 8 km hycom simulations with a duration of six years these simulations have been extensively discussed in shriver et al 2012 buijsman et al 2016 ansong et al 2015 and nelson et al 2019 although the dynamics have improved in more recent hycom simulations i e the 8 and 4 km simulations discussed in this paper as compared to this six year simulation we argue that potentially adverse effects are mitigated by the fact that λ τ is a ratio for each horizontal grid point we perform a least squares fit to extract the m 2 stationary ssh variance σ 2 1 2 η 2 where η is the complex harmonic constant σ 2 is computed for τ equal to 0 5 1 2 3 4 6 and 9 months and 1 1 5 2 3 4 and 6 years the time series with a duration of 2 3 and 4 years have overlapping windows to compute better statistics to reduce noise we average the variance to 0 5 cells the decay of the m 2 stationary ssh variance as a function of time series duration is shown in fig a 14 for two locations along a beam radiating equatorward from hawaii one location near the source features relatively strong stationary tides and little variance decay here the stationary fraction is 94 for a six year time series duration in contrast the second location is in the equatorial pacific which features strong tropical instability wave variability buijsman et al 2017 hence the variance decay is relatively strong and the stationary fraction is 21 for a time series duration of 6 years the equilibrium variance at these two locations as in most other places is reached for durations of less than three years for convenience we assume that σ oeq 2 σ heq 2 and that equilibrium occurs for a duration of six years in this paper we validate hycom sea surface height and modal energetics computed for two week and or one year long time series with altimetry for this purpose the energetics and sea surface height variance are corrected with λ τ for two weeks and one year as shown in fig a 15a and b λ τ is largest near the generation sites and away from the equatorial jets and the antarctic circumpolar and western boundary currents as the time series duration increases from two weeks to one year the correction factor becomes closer to unity fig a 15b however in areas with strong mesoscale variability like the equatorial pacific λ τ remains relatively small the identity 1 λ τ where τ is equal to two weeks fig a 15a represents the ratio between the nonstationary m 2 variance and the total m 2 variance nonstationary fraction and is similar to maps of the nonstationary fraction in figure 9 of zaron 2017 and figure 4 of nelson et al 2019 the globally averaged nonstationary fraction that we compute for the six year long hycom time series is about 40 which is similar to the 44 nonstationary fraction of zaron 2017 
23962,the effects of horizontal resolution and wave drag damping on the semidiurnal m 2 tidal energetics are studied for two realistically forced global hybrid coordinate ocean model hycom simulations with 41 layers and horizontal resolutions of 8 km 1 12 5 h12 and 4 km 1 25 h25 in both simulations the surface tidal error is minimized by tuning the strength of the linear wave drag which is a parameterization of the surface tide energy conversion to the unresolved baroclinic wave modes in both simulations the m 2 surface tide error with tpxo8 atlas an altimetry constrained model is 2 6 cm compared to h12 the surface tide energy conversion to the resolved vertical modes is increased by 50 in h25 this coincides with an equivalent reduction in the tuned loss of energy from the surface tide to the wave drag for the configurations studied here the horizontal and not the vertical resolution is the factor limiting the number of vertical modes that are resolved in most of the global ocean modes 1 2 in h12 and modes 1 5 in h25 the wave drag also dampens the resolved internal tides the 40 reduction in wave drag strength does not result in a proportional increase in the mode 1 energy density in h25 in the higher resolution simulations topographic mode scattering and wave wave interactions are better resolved this allows for an energy flux out of mode 1 to the higher modes mitigating the need for an internal tide damping term the hycom simulations are validated with analytical conversion models and altimetry inferred sea surface height fluxes and surface tide dissipation h25 agrees best with these data sets to within 10 to facilitate the comparison of stationary tide signals extracted from time series with different durations we successfully apply a spatially varying correction factor keywords numerical models internal tides wave damping vertical modes 1 introduction over the last decade or so much progress has been made in introducing tides into ocean general circulation models arbic et al 2018 detail the progress made in models of this type including the progress in model observational comparisons while the barotropic tides in some models of this type are now reasonably accurate in both amplitude and phase ngodock et al 2016 the accuracy of modeled internal tides and their sensitivity to damping is at a somewhat more nascent phase ansong et al 2015 buijsman et al 2016 arbic et al 2018 internal tides are internal waves at tidal frequencies and they are generated by the vertical displacement of isopycnals as the barotropic tide flows over rough bathymetry buijsman et al 2019 we are motivated to study internal tides for several reasons first internal tides act to redistribute energy from the barotropic tide on a global scale the dissipation of internal tides whether close to their generation sites or away across ocean basins mackinnon et al 2017 de lavergne et al 2019 contributes roughly one terawatt tw of energy to vertical mixing globally munk and wunsch 1998 wunsch and ferrari 2004 waterhouse et al 2014 kunze 2017 a better understanding of internal wave mixing is relevant to develop better mixing parameterizations for climate models melet et al 2013 mackinnon et al 2017 second low mode internal tides can propagate for 1000s of kilometers as observed in satellite altimetry ray and zaron 2016 zhao et al 2016 and they may affect the local generation of internal tides across ocean basins kelly and nash 2010 buijsman et al 2010 ponte and cornuelle 2013 the inclusion of these remote internal tides as a boundary condition is relevant for the correct simulation of internal tides in regional models kerry et al 2013 mazloff et al 2020 finally correctly predicting the time varying amplitudes and phases of the internal tides facilitates the separation of the sub mesoscale circulation from the internal tides which is important for the upcoming surface water and ocean topography swot mission fu et al 2012 many facets affect the predictability of the internal tide in global ocean models surface tidal forcing time variable background stratification and flow topography model resolution and subgridscale dissipation parameterizations in this paper we analyze the m 2 internal tide energetics in state of the art realistically forced global forward hybrid coordinate ocean model hycom simulations in particular we are interested in how the model horizontal resolution and wave drag damping affect the internal tide predictability internal tides undergo a myriad of dissipative processes due to lee wave breaking at generation wave wave interactions topographic scattering shear instabilities dissipation at critical slopes and shoaling on farfield continental shelves for an overview see mackinnon et al 2017 these processes are generally not well resolved in regional and global numerical ocean models and they need to be parameterized in general these parameterizations are relatively crude and do not differentiate between the various dissipation processes for example niwa and hibiya 2014 used a tuned linear damping term that operates on the baroclinic velocities in their global model with a damping time of 30 days hycom uses a linear wave drag term that operates on both the near bottom barotropic and baroclinic tidal velocities arbic et al 2010 shriver et al 2012 ansong et al 2015 buijsman et al 2016 if the wave drag is not applied to the baroclinic velocities ansong et al 2015 showed that the internal tides become too energetic as compared to the satellite altimetry however additional wave damping is not used in all global ocean model simulations for example the realistically forced global mitgcm marshall et al 1997 is run without wave drag at 1 48 horizontal resolution and its solution is too energetic in the tidal bands when compared to observations savage et al 2017a yu et al 2019 luecke et al 2020 müller et al 2012 performed global simulations with the mpi om model jungclaus et al 2006 at 1 10 horizontal resolution without wave drag and found that the internal tides are weaker than observed most likely because the model set up is too diffusive wave drag parameterizations were originally intended for global barotropic models which do not resolve internal tides these schemes represent the energy conversion from the surface tide to the full spectrum of unresolved internal tides at mid ocean ridges and continental shelves jayne and st laurent 2001 green and nycander 2013 buijsman et al 2015 however these wave drag parameterizations have also been applied in baroclinic global ocean simulations to primarily optimize the surface tide accuracy arbic et al 2004 minimized the surface tidal error by tuning the wave drag with a drag scale in global baroclinic simulations baroclinic global ocean models can only convert surface tidal energy to internal wave modes for which the horizontal and vertical grid spacings determine how well the motions are resolved the energy conversion to the unresolved higher modes is parameterized by the wave drag if one assumes that the drag scale for a drag scheme that represents the full modal spectrum is 1 in barotropic simulations it should be 1 in baroclinic simulations and increasingly smaller for higher horizontal resolutions as more vertical modes are resolved it is well known that an increase in vertical and horizontal resolution increases the wave energy in particular that of the smaller scale waves in global internal tide simulations niwa and hibiya 2014 showed that the barotropic to baroclinic energy conversion increased for higher horizontal resolutions but they did not specify if this increase was due to the contribution of higher modes the effect of model resolution on realistically forced global baroclinic simulations has been explored in several studies when analyzing hycom simulations with horizontal resolutions of 8 and 4 km and mitgcm simulations with resolutions of 8 4 and 2 km it was found that the higher frequency and higher wave number tails of the energy spectra had more energy and the simulated frequency spectra were closer to observations in the higher resolution simulations savage et al 2017b a luecke et al 2020 the higher resolution simulations featured stronger non linear wave wave interactions facilitating an improved cascade to smaller scales müller et al 2015 ansong et al 2018 one objective of this paper is to understand the effects of both horizontal resolution and wave drag strength on the energetics of the resolved internal tide modes in realistically forced global hycom simulations with horizontal grid sizes of about 8 km 1 12 and 4 km 1 25 and 41 hybrid layers in the vertical in these simulations the wave drag affects both the surface and internal tides our focus is on the m 2 internal tide as it contains about 70 of all tidal energy egbert and ray 2003 we analyze the internal tide modal energy balance kelly et al 2012 on a global scale which has not been done before in hycom or any other global forward model a second objective is to validate these hycom simulations with internal tide sea surface height amplitudes and modal energy fluxes inferred from altimetry surface tide dissipation rates estimated from an altimetry constrained model and modal conversion rates computed from analytical models as in ansong et al 2015 we note that the magnitude of the altimetry inferred sea surface height amplitudes and the modal energy fluxes is affected by the duration of the time series they are extracted from since our model simulations are shorter we apply a correction newly developed in the present work to facilitate a comparison the correction factor is explained in the appendix in the following sections we first present the model set up and energy equations we then discuss the m 2 surface and internal tide energetics that are not decomposed into vertical modes this is followed by a presentation of the modal energetics in the discussion section we synthesize our results and compare them with the literature we end with conclusions 2 methodology 2 1 hycom hycom is the operational global ocean forecast model used by the united states navy metzger et al 2014 the hybrid vertical coordinate is isopycnal in the open ocean and transitions to terrain following in shallow water with z coordinates to resolve the surface mixed layer we discuss two model simulations that are run in a forward non data assimilative mode on a tripolar grid at 1 12 5 8 km and 1 2 5 4 km nominal horizontal resolutions with 41 layers in the vertical 27 levels above 250 m most 8 m apart hereafter we refer to these simulations as h12 and h25 respectively in hycom terminology these simulations are also referred to as expt 06 1 and expt 22 1 both simulations are run with realistic atmospheric forcing from the navy global environmental model navgem hogan et al 2014 and astronomical tidal forcing for the m 2 s 2 k 1 o 1 and n 2 tidal constituents to account for numerical errors in the tidal solution due to imperfect topography and damping terms an augmented state ensemble kalman filter asenkf is applied to optimize the spatially varying self attraction and loading sal term used in the simulations ngodock et al 2016 both simulations employ a quadratic bottom drag and a linear wave drag to dampen tidal flows ansong et al 2015 to account for the energy conversion from the surface tide to the unresolved baroclinic modes and to dampen the resolved internal tides we use the scalar internal wave drag parameterization of jayne and st laurent 2001 1 ℂ π l t h ˆ 2 n b where h ˆ is the bottom roughness n b is the buoyancy frequency at the bottom and l t is the wavelength of the topography the calculation of this wave drag and its performance in barotropic simulations is discussed in buijsman et al 2015 the jayne and st laurent 2001 drag is applied to the total barotropic and baroclinic flow in the bottom 500 m for seafloor depths greater than 1000 m in addition to tidal flows the drag also acts on subtidal bottom flows to compensate for this an anti drag is applied to the bottom flows the anti drag uses non tidal bottom velocities that are a weighted average over 49 h and lagged by 24 h for a detailed description of the application of the anti drag and its impact on the baroclinic simulations the reader is referred to arbic et al 2010 to minimize the impact on non tidal motions we clip the value of ℂ at rough topography so that its minimum e folding time h ℂ 1 day where h is seafloor depth moreover ℂ is set to zero for smooth topography with an e folding time 10 days for each model simulation the wave drag is tuned with a drag scale χ to minimize the global mean m 2 root mean square error r m s e between the altimetric sea surface height from tpxo8 atlas egbert et al 1994 and the simulated sea surface height the tuned wave drag scale of buijsman et al 2015 is reset to χ 1 0 before the tuning of the h12 and h25 simulations after tuning the optimal drag scales in h12 and h25 are 0 5 and 0 3 respectively this implies that the barotropic energy loss to the resolved parameterized internal tides in h25 has been increased reduced relative to h12 the r m s e is 2 6 cm for both simulations which is similar to the results in ngodock et al 2016 instead of tuning the wave drag one could argue that it would make more sense to extract the modal drag component from the analytical modal conversion models of falahat et al 2014 or vic et al 2019 for example if the numerical model simulation resolves modes 1 and 2 one needs to apply the wave drag components of modes 3 and higher in the numerical simulation we have attempted this for the falahat et al 2014 scheme in hycom unpublished results but the high mode drag scheme needed to be modified through smoothing clipping and tuning such that it defeated the purpose of having such scheme moreover the surface and internal tides in simulations with this modal drag scheme do not significantly improve as compared to the full spectrum jayne and st laurent 2001 scheme the three dimensional 3d hycom output is saved hourly for one full year for h12 from october 2011 through september 2012 due to storage limitations we can only store 2d fields of h25 such as sea surface height ssh for an entire year 1 january to 31 december 2016 at an hourly frequency the 3d data for h25 is only stored for the month of september 2016 in this paper we perform the energy diagnostics on model data for the first two weeks of september 2012 h12 and september 2016 h25 we compare sea surface height variance computed for two week and one year long hycom time series with altimetry 2 2 m 2 energetics the hycom model output is analyzed using two different methods first we perform m 2 barotropic and baroclinic energetic calculations for the 3d fields that are not decomposed into vertical modes in the second method we decompose the 3d fields into vertical modes and compute m 2 energy metrics for these modes the application of these two methods facilitates the comparison of the model results with various observational data sets and analytical models 2 2 1 barotropic and undecomposed baroclinic energetics to better frame the modal energetics we first consider the barotropic and undecomposed baroclinic energy balances for the m 2 tide as in buijsman et al 2016 the time averaged depth integrated barotropic energy balance reads 2 p 0 f 0 c l d w0 d b0 r 0 where p 0 is the tidal energy input f 0 is the horizontal barotropic flux vector c l is the conversion of the barotropic energy to the resolved baroclinic modes d w0 is the barotropic energy loss to the wave drag i e the unresolved high mode waves d b0 is the barotropic energy loss to the quadratic bottom drag r 0 is a residual term accounting for numerical and viscous dissipation small nonlinear terms and discretization errors and subscripts 0 and l refer to the barotropic and the resolved baroclinic low modes respectively the depth integrated and time mean baroclinic energy balance reads 3 c l f l d l where 4 d l d wl d bl r l f l is the depth integrated baroclinic flux vector d l is the low mode dissipation d wl is baroclinic dissipation due to linear wave drag d bl is the dissipation due to bottom drag and r l is a residual term accounting for unresolved dissipation due to viscosity small nonlinear terms and discretization errors in this paper we evaluate some of the terms in eqs 2 and 3 for h12 and h25 we perform a least squares harmonic analysis over a two week long time series to extract the m 2 harmonic constants for the 3d hycom fields and compute the energy terms in layer space as detailed in buijsman et al 2016 we limit our time series to two weeks to mitigate data storage issues the original and interpolated time series of h12 and h25 amount to more than 100 tera bytes tb of storage we assume that during this period the internal tides are stationary in most places i e their phases and amplitudes are minimally affected by the time varying background flow see appendix 2 2 2 modal energetics we decompose the baroclinic fields into vertical modes and compute modal energetics following gerkema and zimmerman 2008 kelly et al 2012 and buijsman et al 2014 to better understand the interplay between model horizontal resolution and wave drag in a first step we interpolate the baroclinic velocities u and v and the potential density referenced to 2000 decibar ρ 2 on the hybrid coordinate grid to a z grid with δ z 25 m for every time step we average the density over two weeks and compute the buoyancy frequency n z for each horizontal grid cell we solve the hydrostatic stürm liouville equation 5 2 w n z z 2 n 2 c n 2 w n z 0 where w n z is the eigenfunction of the vertical velocity of mode n c n is the eigenspeed and z is the vertical coordinate the eigenspeed is computed as 6 c n ω 2 f 2 k n where f and ω are the coriolis and m 2 frequencies and k n is the horizontal wave number note that the phase speed is c p n ω k n and the group speed is c g n c n 2 k n ω we then compute the horizontal velocity eigenfunction 7 u n z w n z z and normalize it by 1 h h 0 u n 2 z d z where h is the seafloor depth in a next step the m 2 complex harmonic constants are extracted with a least squares harmonic fit of the interpolated u v and ρ 2 time series the perturbation pressure is computed by depth integrating the complex harmonic constants of ρ 2 and by removing the depth mean pressure then the horizontal velocity eigenfunctions are projected onto the vertical profiles of the horizontal velocity and pressure harmonic constants to yield the complex modal amplitudes in each horizontal grid cell e g 8 u ˆ n 1 h h 0 u n z u z d z where u is the complex harmonic constant of u each fitted mode is removed from the profiles of the complex harmonic constants before fitting the next mode to avoid overfitting after obtaining the eigenspeeds and complex modal amplitudes we compute the terms in the depth integrated and time averaged modal energy equation kelly et al 2012 9 m 0 5 c m n conversion ρ c h 4 u ˆ n 2 k e 1 f 2 ω 2 p ˆ n 2 ρ c c n 2 a p e t 1 2 h u ˆ n p ˆ n flux div d n dissipation where ρ c is the space and time invariant density t is time u ˆ n and p ˆ n are the complex modal amplitudes of the velocity vector and perturbation pressure is the complex conjugate and n and m are mode numbers the first term on the l h s of eq 9 is the intermodal energy conversion and the first term on the r h s is the time mean of the rate of change of kinetic k e and available potential energy a p e the second term is the energy flux divergence and the third term is the dissipation a residual term the factor 1 2 arises from time averaging over a tidal cycle note that in this case the rate of change term is close to zero and can be ignored we compute these terms for the first five modes because up to five modes are resolved in the h25 simulation see next section the barotropic to baroclinic conversion to the first five modes is n 1 5 c 0 n and should be comparable to c l of eq 2 the intermodal energy conversion term for n 0 and m 0 is computed as kelly et al 2012 10 c m n h 0 u m p n u n p m d z where u n z u ˆ n u n z and p m z p ˆ m u m z this mode scattering term is non zero when horizontal gradients in topography and stratification are present however c m n mostly correlates with topographic gradients in our simulations this term does not represent nonlinear mode mode interactions which result from the advective term in the momentum equation ignored in this analysis we compute m 1 5 c m n which is the energy transfer between each mode n and the other four modes the uncertainty for this term may be larger than for c 0 n the horizontal gradients in eq 10 are computed using central finite differences the values of the vertical profile of u m z p n z u n z p m z are set to zero downslope of the shallowest seafloor depths to avoid erroneously large values to show that this term is relevant we compute for each mode of h25 the spatial correlation r a between 1 2 h u ˆ n p ˆ n and c 0 n and the correlation r b between 1 2 h u ˆ n p ˆ n and c 0 n m 1 5 c m n the inclusion of m 1 5 c m n increases the correlation from r a 0 73 0 44 0 29 0 15 0 05 to r b 0 77 0 65 0 54 0 34 0 17 for modes 1 5 and it lowers the standard deviation of the residual dissipation d n by maximally 13 8 7 1 0 4 w m 2 68 8 1 0 4 w m 2 for mode 2 this demonstrates that the mode scattering term is relevant in particular in the h25 simulation 2 3 resolved modes the horizontal and vertical resolutions of the hycom simulations determine the number of modes that can be resolved for the simulations considered we find that the horizontal resolution is the limiting factor over most of the ocean area and not the vertical resolution of 41 layers hence in the following we discuss the effect on the horizontal wavelength the stratification in both the h12 and h25 simulations is similar yielding the same low mode wavelengths as computed with eq 6 in fig 1 we plot the mode 1 and 2 wavelengths of h25 as an example latitude seafloor depth and stratification affect the spatial variability in wavelengths the wavelength of the first baroclinic m 2 mode varies from 80 km in the eastern equatorial ocean basins to 200 km at higher latitudes fig 1a the mode 2 wavelength is about half as long fig 1b although not shown the mode 1 and 2 wavelengths agree with the wavelengths inferred from climatology and altimetry wave number spectra by ray and zaron 2016 we compute the number of grid cells that can fit inside the wavelengths of the first five modes l n δ x where l n is the modal wavelength and δ x is the maximum grid spacing of each grid cell fig 2 shows global maps of l n δ x for the first five modes for h12 and h25 if we assume that the minimum number of grid cells needed to resolve a wave mode is five then the first two and the first five modes are resolved in most of the global ocean in the h12 and h25 simulations respectively in h12 modes 3 5 are not well resolved in the equatorial and mid latitude regions white areas in fig 2 to better quantify the effect of seafloor depth on the resolved modes we area average l n δ x for seafloor depth bins with a width of 500 m e g 250 750 m 750 1250 m 1250 1750 m 5750 6250 m and for latitudes equatorward of 50 fig 3 for seafloor depths deeper than 1250 m we find that the first two and the first five modes are resolved in the h12 and h25 simulations respectively in the shallowest depth bin of 250 750 m only mode 1 and the first three modes are resolved in h12 and h25 respectively hence we solve for the first five modes in h12 and h25 as the waves are not well resolved in shallow water due to the horizontal model resolution and the vertical spacing of the z grid we do not compute modal energetics shallower than seafloor depths of 250 m hycom s horizontal grid is a c grid arakawa and lamb 1977 a c grid is prone to gridscale noise that is due to spatial averaging of coriolis momentum terms and that is apparent when the grid resolution is coarse with respect to the baroclinic deformation radius l ρ adcroft et al 1999 according to adcroft et al 1999 the c grid may cause noise when the wave resolution r w 2 l ρ δ x 1 we compute r w for modes 1 5 and find that r w 1 for the resolved modes in h12 and h25 i e it is unlikely that these modes feed energy into short scale perturbations that allow standing gridscale noise to persist such noise has not been observed in the simulations 2 4 validation data and statistical analysis we validate our hycom simulations with observations and analytical model results for some model data comparisons we compute the following statistics ansong et al 2017 the correlation coefficient r the ratio γ between the simulated and observed variables and the regression coefficient a i e the slope which is obtained with a linear least squares regression v a r hycom a v a r observation where v a r is a variable the results of the statistical analysis are in table 1 in the following we discuss the various validation data sets we compare hycom m 2 internal tide sea surface height variance computed for a two week and one year long time series with that extracted from 17 years of altimetry time series which were also used by shriver et al 2012 we apply a least squares harmonic fit to the altimetry and hycom data to extract the harmonic constants we interpolate the harmonic constants of hycom to the same locations as the altimetry data for seafloor depths deeper than 1500 m the internal tide harmonic constants are recovered from the hycom and altimeter data sets via along track band pass filtering to permit wavelengths in the 50 400 km range at the mid latitudes the internal tide length scales and periods are similar to those of the mesoscales hence the non tidal motions may be aliased into the internal tide signals extracted from satellite altimetry ray and byrne 2010 shriver et al 2012 to reduce these effects data that coincide with eddy kinetic energy e k e 200 cm 2 s 2 are excluded from the statistical analysis although e k e is large near the equator the rossby radii are much larger than the internal tide wavelengths hence we do not omit data for latitudes ϕ equatorward of 20 this e k e data set is based on surface drifter velocities from the global drifter program and is adapted from whalen et al 2012 we compare the area integrated loss of surface tide energy in hycom to the barotropic dissipation inferred from tpxo8 atlas these dissipation rates are computed as the residual of the sum of the tidal energy input and barotropic flux divergence green and nycander 2013 the dissipation rates used here have also been used in buijsman et al 2015 the globally integrated modal conversion rates of hycom are compared with the rates from analytical models by falahat et al 2014 and vic et al 2019 in these analytical models the conversion rates are computed by multiplying a linear wave drag parameterization based on theory by bell 1975 with barotropic tidal velocities from the tpxo tide model as in vic et al 2019 we do this comparison for seafloor depths 700 m because the linear analytical models do not well predict conversion rates at supercritical slopes we compare the mode 1 and 2 fluxes of h25 to the energy fluxes that are extracted from altimetry data sets with a plane wave fit method by zhao et al 2016 and zhao 2018 the plane wave fit method yields fluxes for three directions we use their vector sum for the comparison the hycom fluxes are averaged to the cartesian 0 2 grid of the altimetry data to facilitate the statistical analysis data that coincide with e k e 200 cm 2 s 2 except for ϕ 20 are excluded from this analysis 3 results 3 1 undecomposed fields 3 1 1 m 2 internal tide sea surface height variance before considering the tidal energetics we compare the stationary m 2 internal tide sea surface height variance of h12 and h25 to altimetry the variance is computed as σ 2 1 2 η 2 where η is the complex harmonic constant computed over the two week and one year long time series the sea surface height variance is mostly dominated by the low vertical modes the internal tide ssh variance of the two week long uncorrected h12 and h25 time series σ 2 2w in fig 4a and b is about twice as large as the variance of the altimetry in fig 4i and table 1 the mean variance in h12 and h25 in the hotspot regions is respectively 71 0 22 cm 2 0 30 cm 2 and 108 0 33 cm 2 0 30 cm 2 larger than the altimetry variance averaged over the global ocean the variance in h12 and h25 is 71 0 08 cm 2 0 11 cm 2 and 110 0 12 cm 2 0 11 cm 2 larger respectively the correlation between the simulated variance and the altimetry is modest albeit that it is slightly better for h25 r 0 54 than for h12 r 0 52 table 1 when we compare the h12 to the h25 simulations we find that the h25 simulation is about 21 0 11 cm 2 0 52 cm 2 more energetic than h12 in the hotspot regions whereas in a globally integrated sense h25 is 23 0 04 cm 2 0 19 cm 2 more energetic than h12 this difference is because the atlantic ocean which does not have hotspot boxes is more energetic in h25 than in h12 it is to be expected that the stationary variance for the two week long hycom time series is larger than the variance extracted from the 17 year long altimetry time series because the stationary variance decreases with the time series duration appendix to illustrate this point we also compute the m 2 variance for the one year long hycom time series σ 2 1y fig 4c and d the largest differences between σ 2 2w and σ 2 1y occur in areas with the strongest time variability in subtidal background flows such as in the equatorial pacific buijsman et al 2017 although σ 2 1y is smaller than σ 2 2w the globally averaged σ 2 1y is still larger than the altimetry variance by 15 0 02 cm 2 0 11 cm 2 and 28 0 03 cm 2 0 11 cm 2 for h12 and h25 respectively this difference is larger in the hotspot regions 36 0 11 cm 2 0 30 cm 2 and 43 0 13 cm 2 0 30 cm 2 for h12 and h25 respectively the correlation between the year long hycom and altimetry variance is better than for the two week time series r 0 68 for h12 and r 0 77 for h25 table 1 to ensure a more apples to apples comparison we correct the hycom variance for the two week and one year long time series with a spatially varying correction coefficient which is close to unity in the nearfield and small in the farfield this correction coefficient is derived in the appendix using an older six year long 8 km hycom simulation the corrected m 2 ssh variance for the two week long time series σ 2 2wc and the one year long time series σ 2 1yc are shown in fig 4e and g for h12 and in fig 4f and h for h25 although the correction factor reduces the variance more for the two week than for the one year long time series the corrected variance of h12 and h25 for both durations is approximately similar to the altimetry variance in accordance the relative increase in the correlation coefficient due to the correction is larger for the two week time series table 1 while the corrected variance for h12 is generally underpredicted the corrected variance for h25 is overpredicted for both durations the agreement for the one year long h25 time series is the best with γ r and a being the closest to unity table 1 after correction the mean variance of the two week long h25 time series is 11 0 03 cm 2 0 30 cm 2 larger than the altimetry variance in the hotspot regions while it is only 2 0 002 cm 2 0 110 cm 2 larger when averaged over the global ocean in contrast the mean variance of the one year long time series is 23 larger 0 07 cm 2 0 30 cm 2 in the hotspot regions and 9 0 01 cm 2 0 11 cm 2 larger over the global ocean 3 1 2 barotropic and baroclinic m 2 energetics for h12 and h25 we compute the time mean depth integrated and global area integrated energy input p 0 the barotropic conversion to the resolved internal tides c l the barotropic loss to the wave drag d w0 the barotropic energy loss to the resolved and unresolved wave modes c l d w0 and the energy loss of the resolved internal tides to the wave drag d wl where indicates an area integration fig 5 the m 2 energy input and the barotropic energy loss to the internal tides are also computed for tpxo8 atlas data green and nycander 2013 and compared with the hycom simulations p 0 is computed for all seafloor depths while the other terms are computed for seafloor depths deeper than 250 m the tpxo8 atlas dissipation includes both surface tide energy loss to the internal tides and bottom drag the former occurs in deep water while the latter occurs primarily in coastal shelf seas shallower than 250 m the energy input for both hycom solutions compares well with that of tpxo in h25 the resolved barotropic to baroclinic energy conversion c l is about 0 21 tw larger than in h12 this increase in the conversion in h25 is offset by a near equal reduction of 0 20 tw in the energy conversion to the unresolved modes d w0 in h25 as a consequence c l d w0 is about the same for both h12 and h25 simulations this result is consistent with both simulations having the same tidal accuracy and energy input c l d w0 is about 11 0 09 tw 0 87 tw larger than the deep water barotropic dissipation of tpxo which is a fairly good agreement the weaker drag scale in h25 yields a smaller d w0 as compared to h12 at the same time h25 resolves more higher modes increasing c l the increase of c l in h25 relative to h12 is the largest over the deeper mid ocean ridges not shown which are more efficient higher mode generators in contrast the differences in c l at the tall mid ocean ridges such as hawaii are smaller because the conversion at these ridges is mostly due to low modes which are both resolved in h12 and h25 although the drag scale is smaller for h25 the internal tide energy loss to the wave drag d wl is about the same in h12 and h25 because h25 features more internal tide energy in the next section we discuss the modal decomposition of this energy 3 2 modal m 2 energetics 3 2 1 internal tide generation as the surface tide oscillates over underwater topography surface tide energy is transferred to baroclinic modes the global integral of the time mean barotropic to baroclinic conversion to the full spectrum of the resolved internal tides c l of eq 2 and to the first five modes c 0 n of eq 9 is presented in fig 6 the rates computed for seafloor depths 250 m are shown in fig 6a in the open ocean most of the surface tide energy is converted into mode 1 in the h12 and h25 simulations however the higher horizontal resolution of h25 resolves more higher vertical modes than h12 c 01 of h25 is 19 0 05 tw 0 27 tw larger than that of h12 the increase in the mode 1 conversion may be attributed to a better resolved bathymetry in h25 the mode 2 conversion is 63 0 05 tw 0 08 tw larger in h25 and this difference becomes much larger for higher modes the sum of the conversion over all modes is about 8 smaller than the undecomposed conversion c l for both h12 0 03 tw 0 40 tw and h25 0 05 tw 0 60 tw the difference may be due to missed higher modes imperfect modal fits and interpolation errors we also compare the hycom conversion rates to the rates computed with the analytical models of vic et al 2019 and falahat et al 2014 for seafloor depths 700 m in fig 6b compared to the analytical conversion rates h25 performs quite well for modes 1 to 4 while only modes 1 and 2 of h12 compare well with the analytical rates the mode 5 conversion of h25 is about 30 0 01 tw 0 03 tw smaller than the analytical rates we note that for h12 and h25 about 30 0 08 tw 0 27 tw and 0 10 tw 0 32 tw of the mode 1 conversion occurs in the seafloor depth range of 250 700 m this implies that the choice of the minimum cutoff depth can impact global energy budget calculations to visualize the spatial distribution of the modal conversion rates in h25 we average the rates to 2 2 bins fig 7 this procedure reduces the visually distracting presence of negative conversion rates which occur when the perturbation pressure is out of phase with the local barotropic velocities i e energy is transferred from the internal to the surface tide simmons et al 2004 buijsman et al 2010 kelly and nash 2010 the mode 1 conversion rates in fig 7a are largest at tall ocean ridges e g in the western pacific and indian ocean and along some continental shelves e g the bay of biscay and the amazon shelf although the appearance of the most energetic mode in fig 7b and the mode 1 conversion as fraction of the first five modes in fig 7c is noisy large scale patterns are visible these patterns are in agreement with results by de lavergne et al 2019 and vic et al 2019 in most of the ocean the mode 1 conversion dominates in h25 while modes 2 4 are relatively more important at the flat and wide mid ocean spreading ridges such as the mid atlantic ridge the southwest and central indian ridges and the east pacific rise fig 7b and c at these deep ridges mode 1 comprises less than 20 0 11 tw 0 55 tw of the conversion to the first five modes fig 7c 3 2 2 internal tide propagation next we evaluate the energy density and energy fluxes to better understand the propagation of the internal tide modes in h12 and h25 in fig 8 we present maps of the kinetic energy k e for the first five modes for h12 and h25 maps of the available potential energy a p e are similar and are not shown in both h12 and h25 beams of mode 1 energy radiate away from generation hotspots such as the hawaiian polynesian and mariana ridges in the pacific georges bank and the amazon shelf in the atlantic and the mascarene nicobar and andaman island ridges in the indian ocean fig 8a and f the lengths of some mode 1 beams are longer than 3000 km reflecting the low decay rates of the mode 1 waves beams of mode 2 energy are not as intense nor do they propagate as far but strong signals extend hundreds of kilometers away from generation sites such as the amazon shelf the mascarene ridge and the aleutians fig 8b and g while the difference in mode 1 energy density between h12 and h25 is relatively small the mode 2 beams of h25 are more energetic than those of h12 for baroclinic modes 3 to 5 more differences are evident in the kinetic energy maps for h12 and h25 fig 8c e and h j for h12 little to no high mode energy is present in areas where l n δ x 5 in fig 2 at higher latitudes where the grid spacing decreases some energy is present equatorward of the turning latitude 74 5 for the m 2 tide for example south of tasmania in h25 baroclinic kinetic energy in modes 3 to 5 is found near topography in the interior ocean especially near island chains like hawaii polynesia indonesia madagascar and along the mid atlantic ridge in contrast to modes 1 and 2 higher mode beams are more diffusive and harder to distinguish this may be attributed to higher modes having more generation sites than modes 1 and 2 topographic scattering wave wave interactions and refraction by the background flow to which higher modes are more susceptible than low modes rainville and pinkel 2006 there is a patch of elevated energy for modes 3 to 5 in the north pacific in both simulations fig 8c e and h j this is likely caused by a thermobaric instability tbi hallberg 2005 a numerical instability in isopycnal hybrid models that implement thermobaricity as a perturbation from reference compressibility states the tbi effect is larger in h25 because the instability has a strong vertical shear that projects onto the higher modes tbi mostly affects the energy density energy fluxes and dissipation of modes 3 to 5 whereas the conversion and topographic scattering are not much affected we note that the tbi noise differs from gridscale noise associated with c grids adcroft et al 1999 because in the former progressive high mode waves are generated while in the latter standing noise patterns are generated we do not observe these standing noise patterns in h12 and h25 we compute global integrals of the modal k e and a p e and the sum over all modes for seafloor depths 250 m fig 9 the energy density of modes 3 5 inside the polygons marking the extent of the tbi areas in fig 8e and j is excluded from the analysis on average k e is about 15 larger than a p e for both h12 and h25 ignoring modes 3 5 of h12 h25 has more total energy than h12 for all modes 34 22 0 pj 64 2 pj more in mode 1 68 15 4 pj 22 6 pj more energy in mode 2 and increasingly more for higher modes note that this 34 increase in mode 1 energy is of the same order of magnitude as the 23 increase in two week ssh variance in h25 relative to h12 fig 4 summed over all modes k e a p e and their sum are about 60 larger in h25 than in h12 the globally integrated kinetic available potential and total energies of h25 are 84 pj 69 pj and 153 pj respectively of which mode 1 comprises about 56 we compare the uncorrected and corrected m 2 mode 1 and mode 2 fluxes of h25 with the mode 1 and mode 2 fluxes extracted from altimetry in fig 10 and table 1 the uncorrected mode 1 and mode 2 fluxes of h25 in fig 10a and d are larger than the altimetry fluxes in fig 10c and f the differences are largest for the mode 2 fluxes the application of the spatially varying correction factor appendix to the h25 fluxes improves the agreement with the altimetry fig 10c and e the correction factor is the same for both ssh variance and fluxes because both scale with u 2 the improvement is most noticeable in the equatorial pacific after the correction the regression a ratio γ and correlation r coefficients are closer to unity for the magnitude and the x and y vector components of the energy flux table 1 of all the vector components the correlation is the largest for the absolute mode 1 flux f 1 the correlation has improved from 0 54 to 0 60 after correction due to the aforementioned north south bias of the altimetry the model correlates better with the altimetry for f y than for f x the coefficients a γ and r for the flux comparison deviate more from unity than the coefficients computed for the ssh variance table 1 this is particularly true for the mode 2 fluxes in addition to the north south bias other reasons for this deviation may be that the plane wave fit yields a more diffuse beam field than the simulated wave field and that the location of some beams is incorrectly predicted by hycom 3 2 3 mode scattering propagating low mode internal tides may scatter to higher modes at spatially varying underwater topography and stratification the low mode scattering in the h12 and h25 simulations is mostly due to topographic gradients the scattering process is represented by c m n for m 0 and n 0 the global integral of m 1 5 c m n for seafloor depths deeper than 250 m is shown in fig 11 for both the h12 and h25 simulations m 1 5 c m n is negative for mode 1 and positive for modes 2 5 implying that energy is transferred from mode 1 to higher modes the scattering out of mode 1 is about twice as strong in h25 because h25 has a better resolved bathymetry and it resolves more higher modes than h12 for h12 and h25 m 1 5 c m 1 is about 10 0 03 tw 0 27 tw and 20 0 07 tw 0 32 tw of c 01 respectively this fraction is of the same magnitude as the estimate by de lavergne et al 2019 who found that 19 of mode 1 is scattered by hills thus excluding continental shelf topography but lower than the estimate by eden and olbers 2014 who found that 53 of mode 1 is scattered at both hills and shelves the spatial variability of the energy scattered from mode 1 m 1 5 c m 1 is highlighted in fig 12 as for the conversion in fig 7a we average m 1 5 c m 1 to 2 2 bins to better visualize the spatial trends overall m 1 5 c m 1 is negative although some randomly distributed positive values occur which are invisible due to the choice of colormap similar to the energy conversion from the surface tide to mode 1 fig 7a the energy scattered out of mode 1 is also large at steep topography such as mid ocean ridges hills islands and shelves fig 12 in contrast to the energy conversion from the surface tide to mode 1 the conversion from mode 1 to higher modes is relatively more important at the slightly wider and deeper ridges and hills such as the mid atlantic ridge the line islands ridge south of hawaii johnston et al 2003 and the mascarene plateau north of madagascar in the indian ocean 3 2 4 synthesis of the baroclinic energy balance in this section we discuss the relevant energy terms as a function of seafloor depth fig 13 shows the total energy and the terms from the modal and undecomposed baroclinic energy balances for the h12 and h25 simulations we compare the modal energy terms of eq 9 summed over the first five modes solid black blue and red lines in fig 13 with the undecomposed energy terms of eq 3 same colored dotted lines the summed modal terms generally demonstrate the same trends as the undecomposed terms but they are slightly smaller this shows that the modal computations are credible even though they are based on depth interpolated fields all energy terms have larger amplitudes in h25 as compared to h12 which is attributed to the larger contribution of the higher modes in h25 the total energy in fig 13a and b is proportional to the binned seafloor area r 0 99 fig 13b and reaches a maximum for seafloor depths of about 4500 m the mode 1 energy of h12 is about the same as in h25 fig 13a and b the difference between the modal sums of the energy densities of h12 and h25 is largest over the deeper ridges where more higher modes are generated see also fig 7b and c in contrast to the depth integrated energy a relatively large fraction of the total conversion occurs in shallow water about 31 0 10 tw 0 33 tw of the mode 1 conversion and 21 0 12 tw 0 56 tw of the conversion to modes 1 5 occurs for seafloor depths 750 m for larger seafloor depths the conversion portrays a linear decline with depth in both h12 and h25 the flux divergence is positive for seafloor depths shallower than 3 km while it is negative for larger depths fig 13c and d this pattern reflects an energy flux from shallow water where the conversion is large to deeper water where the energy and dissipation are large the large conversion for the shallow seafloor depth bin of 250 750 m coincides with relatively large dissipation rates fig 13c and d both can be attributed to mode 1 which is the most dominant mode at tall and steep topography in h12 and h25 about 75 62 gw 83 gw and 62 63 gw 102 gw of the mode 1 conversion is locally dissipated hydraulic jumps and lee waves which can occur at tall ridges legg and huijts 2006 are not well resolved in hycom simulations this may inflate the modeled dissipation rates relative to values in the actual ocean in idealized high resolution simulations that resolve breaking lee waves the local dissipation fraction is about 10 40 buijsman et al 2012 alford et al 2015 which is lower than observed in hycom in deep water the dissipation in fig 13c and d is attributed to the remotely generated low modes and locally generated higher modes for seafloor depths of 4500 m about 40 of the dissipation over modes 1 5 is due to mode 1 in h25 the dissipation in h25 is about 50 0 19 tw 0 40 tw larger than in h12 red solid and dotted lines in fig 13c and d which is due to the increase in high mode internal tide energy in h25 the increase in the energy density in h25 has contributed to a 21 0 03 tw 0 15 tw increase in the baroclinic drag loss d wl gray dashed line in fig 13c and d despite the 40 0 2 0 5 reduction in drag scale in h25 the difference between d wl and d l red dotted line represents the viscous and numerical dissipation nonlinear wave wave interaction and wave scattering terms this difference is largest in shallow water due to the relatively large conversion rates and the small baroclinic drag loss which peaks for seafloor depths of about 3500 m 4 discussion 4 1 interplay between model resolution and wave drag the reduction in hycom s horizontal grid spacing from 8 to 4 km has resulted in the generation of more higher wave modes in h25 figs 5 and 6 while in h12 only 2 modes are resolved in h25 up to 5 modes are resolved we emphasize that the horizontal and not the vertical resolution is the limiting factor in the number of modes that can be resolved in our simulations the increase in resolved high mode conversion in h25 is offset by a decrease in surface tide energy loss to the wave drag d w0 fig 5a which parameterizes the energy conversion to the unresolved high modes this reduction in wave drag loss by the surface tide is due to a reduction in the drag scale by 40 which is tuned in the h12 and h25 simulations to optimize the barotropic tidal accuracy since the wave drag also operates on the internal tides one may expect that a 40 reduction in drag strength will further increase the internal tide energy in h25 since mode 1 is the dominant mode we will evaluate the impact of this drag scale reduction on mode 1 in a linear system the reduction in wave drag damping may increase the mode 1 energy by a factor 1 1 0 4 1 67 a 67 increase compared to h12 the mode 1 conversion has increased by about 19 in h25 fig 6 this implies that the energy can increase by a factor 1 67 1 19 1 98 a 98 increase however the mode 1 energy has increased by only 34 in h25 fig 9 the difference between these numbers may be attributed to an increase in the scattering of mode 1 waves to higher modes at topography fig 11 non linear wave wave interactions müller et al 2015 ansong et al 2018 and numerical and viscous dissipation fig 13 in the h25 simulation as compared to the h12 simulation ansong et al 2018 find that about 0 04 tw is lost to parametric subharmonic instability psi from the semidiurnal internal tide in 4 km hycom simulations this is of the same order of magnitude as the energy lost from mode 1 due to topographic scattering 0 066 tw 4 2 how realistic are the internal tides in hycom as explained in the introduction no other realistically forced global ocean model has been validated as thoroughly as hycom see arbic et al 2018 for a recent accounting of our many model data validation efforts in this paper we have validated the internal tides in the h12 and h25 simulations with altimetry derived ssh variance and energy fluxes tpxo8 atlas surface tide dissipation rates and conversion rates estimated from analytical models in addition these simulations have also been compared to mooring data in savage et al 2017a ansong et al 2017 and luecke et al 2020 overall the h25 simulation is in better agreement with observations and analytical models than h12 hence we will only discuss h25 in this section we note that h12 is an improvement over the 8 km hycom simulation discussed in shriver et al 2012 and buijsman et al 2016 because the surface tides in h12 are more accurate h12 has 41 layers as opposed to 32 and the wave drag damping is less in h12 for example the uncorrected global mean m 2 internal tide ssh variance of the h12 simulation is about 40 0 035 cm 2 0 08 cm 2 larger than the hycom simulation analyzed by shriver et al 2012 and buijsman et al 2016 4 2 1 mooring observations ansong et al 2017 compare the simulated mode 1 and mode 2 m 2 internal tide energy fluxes to observed fluxes at 79 historical mooring locations they find that the spatially averaged mode 1 mode 2 hycom fluxes computed from model data subsampled at instrument depths are 4 32 smaller than the observed fluxes i e γ equals 0 96 0 68 the regression coefficient a is 0 82 0 55 luecke et al 2020 compares k e and temperature variance in h25 for 3000 historical mooring observations for the semidiurnal frequency band γ is 0 64 and 0 44 and a is 0 64 and 0 47 for k e and temperature variance respectively in both studies γ and a are close to unity although the hycom values bias low possibly due to the under representation of higher modes in the simulations 4 2 2 altimetry how do these findings compare to the model validation of this paper the corrected m 2 internal tide ssh variance of h25 for the one year time series agrees well with altimetry after we apply a correction for time series duration r 0 78 γ 1 09 and a 0 97 table 1 and fig 4 however h25 is slightly more energetic than the altimetry the corrected variance in the hotspot regions is 23 larger and the global mean variance is 9 larger for the year long time series despite this fair agreement there are reasons for caution first we note that the correction factor represents both the nonstationary scattering and dissipation it is not clear from this analysis how well hycom simulates the individual nonstationary scattering and dissipation processes moreover the variance correction method also has some uncertainty the corrected global mean variances for the two week and one year long time series for h12 and h25 differ by about 20 0 018 cm 2 0 089 cm 2 and 7 0 008 cm 2 0 112 cm 2 respectively ideally these differences should not exist after correction our correction method is based on the older hycom simulations discussed in shriver et al 2012 appendix we do not yet know how the variance decay is affected by the higher horizontal and vertical resolution of the h12 and h25 simulations on the other hand there is uncertainty in separating the mesoscales from the internal tide scales in the altimetry signal ray and byrne 2010 the differences between the corrected hycom and the altimetry inferred fluxes for mode 1 and 2 are larger than for the ssh variance table 1 and fig 10 in particular for mode 2 similar to the ssh variance the predicted fluxes are larger than the altimetry fluxes the differences may be attributed to the different flux calculation methods and the along track bias of the plane wave fit method the global integral of the resolved and parameterized surface to internal tide energy conversion c l d w0 for seafloor depths 250 m in h25 is also in agreement with the surface tide dissipation inferred from tpxo8 atlas fig 5 the dissipation in h25 is only 11 larger than in tpxo8 atlas we are aware of several uncertainties associated with the calculation of d w0 in h25 and the surface tide dissipation inferred from tpxo8 atlas the wave drag dissipation in hycom should be computed using the total tidal flow d w ρ c ℂ u t u t buijsman et al 2016 where ℂ is the wave drag and u t u u u and u are the total baroclinic and barotropic horizontal velocity vectors respectively in order to avoid barotropic baroclinic cross terms based on u u we apply a linear split to compute the barotropic and baroclinic components d w0 and d wl these terms are based on u t u and u t u respectively buijsman et al 2016 we find that the cross term amounts to about 10 of d w0 which is about the same as the difference between c l d w0 and tpxo the surface tide dissipation from tpxo8 atlas has also some uncertainty it is computed as a residual term as a consequence the dissipation as function of the horizontal coordinate has negative values at high latitudes and in some coastal shelf areas where the tpxo solution is less well constrained egbert and ray 2003 green and nycander 2013 buijsman et al 2015 egbert and ray 2003 estimated error bars of 20 for an older tpxo inverse model 4 2 3 analytical conversion models the modal conversion in the h25 simulation agrees very well with the analytical models by falahat et al 2014 and vic et al 2019 for seafloor depths 700 m the global integrals over the first 5 modes for the three models differ by less than 1 fig 6b we find that the mode 1 conversion for seafloor depths 700 m constitutes about 21 0 19 tw 0 90 tw and 27 0 22 tw 0 83 tw of the sum of the resolved and parameterized conversion n 1 5 c 0 n d w 0 in h12 and h25 respectively these ratios are in accordance with those computed with the analytical model by vic et al 2019 34 and 29 when abyssal hills are excluded and included respectively the catch is that a relatively large fraction of the resolved conversion in h25 occurs over seafloor depths ranging from 250 m to 750 m about 21 of the conversion to modes 1 5 and about 31 of the conversion to mode 1 however the shallow water conversion rates of hycom are more difficult to validate because the analytical models break down on super critical slopes that mostly occur in shallow water unfortunately the 4 km hycom simulation and most other global simulations of similar and coarser resolution see introduction the altimetry constrained models and the analytical conversion models are currently unable to reliably estimate the internal tide generation at shelf breaks and in shelf seas shallower than 250 m at the global scale here thus lies an opportunity for future research to better constrain the barotropic to baroclinic conversion in these shallow seas 4 2 4 energy density few studies exist that report on estimates of the global internal tide energy de lavergne et al 2019 computed 165 pj in mode 1 for seafloor depths 400 m zhao et al 2016 applied a harmonic plane wave fit to 20 year long time series of altimetry ssh and estimated 36 pj of energy in the mode 1 internal tide for seafloor depths greater than 500 m the h25 mode 1 k e a p e for seafloor depths 500 m is 84 6 pj which is only 1 9 smaller than the energy for depths 250 m fig 9 compared to h25 the mode 1 energy in the model of de lavergne et al 2019 is quite large this may be attributed to the large wave wave interaction e folding decay times used in their model the hycom and de lavergne et al 2019 internal tide energy reflect the sum of the stationary and nonstationary fractions whereas the altimetry based estimate only reflects the stationary fraction moreover zhao et al 2016 estimated energy by excluding the western boundary and antarctic circumpolar current regions hence we omit regions with e k e 200 j m 2 for ϕ 20 and we correct our mode 1 energy estimate of h25 with the spatially varying correction factor from the appendix after these corrections the globally integrated mode 1 stationary energy of h25 equals about 45 pj which is in closer agreement with the altimetry estimate by zhao et al 2016 as pointed out by de lavergne et al 2019 the estimate by zhao et al 2016 may still be a lower bound because the plane wave fit technique is biased towards the north south beams which are more aligned with the altimetry tracks 4 3 future research in contrast to buijsman et al 2016 de lavergne et al 2019 and vic et al 2019 we have not compared our hycom model simulations with microscale and finestructure dissipation observations in this paper the nonlinear dissipation depends on the integral of all tidal flows whereas we have only considered the m 2 tide in this paper we plan to compute the dissipation due to the combined effect of the diurnal and semidiurnal internal tides and compare these with observations in a follow up paper we have been fortunate with the choice of the wave drag set up in h25 as it provides accurate surface tides and it does not seem to greatly under or overdamp the internal tides these hycom experiments suggest that the need for an explicit baroclinic wave damping is mitigated in higher resolution simulations because topographic wave scattering and wave wave interactions are better resolved yet in our 4 km simulations some damping is still necessary ideally we would like to apply an internal tide damping term that is decoupled from the surface tide damping most likely such scheme would still need a tuning parameter 5 conclusions in this paper we have performed a full and modal energy balance analysis for the m 2 internal tide in realistically forced global hycom simulations with a horizontal resolution of 8 km h12 and 4 km h25 these simulations have been evaluated with altimetry inferred sea surface height and fluxes tpxo8 atlas surface tide dissipation rates and analytical models of the barotropic to baroclinic energy conversion our most important findings are the increase in horizontal grid size from 8 to 4 km coincides with a reduction in wave drag strength by 40 this reduction is due to the tuning of the drag to optimize the barotropic tidal accuracy the associated reduction in surface tide energy loss to the wave drag i e the parameterized energy conversion to the unresolved high modes is offset by an increase in the barotropic to baroclinic energy conversion to the resolved baroclinic wave modes in h25 in both the h12 and h25 simulations the sum of the resolved and parameterized conversion is equal which is consistent with both simulations having the same tidal accuracy the energy conversion is larger in h25 than in h12 because the higher resolution of h25 resolves up to 5 modes in contrast only 2 modes can be resolved in h12 for seafloor depths deeper than 250 m the horizontal resolution and not the vertical resolution determines the number of modes that can be resolved at least in the simulations presented here overall mode 1 is the dominant mode in both the h12 and h25 simulations in both simulations the mode 1 conversion constitutes about 30 of the sum of the resolved and parameterized conversion which is in agreement with the analytical conversion model of vic et al 2019 in the h25 simulation the mode 1 conversion is largest over the tall mid ocean ridges and shelf breaks whereas the higher mode conversion becomes relatively more important over the deep mid ocean ridges such as the mid atlantic ridge compared to h12 the global integral of barotropic to baroclinic energy conversion in h25 has increased by 19 for mode 1 and by 49 for modes 1 5 while the global integral of the energy density has increased by 34 for mode 1 and by 60 for modes 1 5 the wave drag also dampens the internal tides in a linear system a 40 reduction in damping and a 19 increase in mode 1 conversion should double the mode 1 energy density when the grid size is increased from 8 to 4 km however the mode 1 energy density increase is much smaller because the increased resolution facilitates the transfer of energy out of mode 1 to smaller scales and higher frequencies due to enhanced topographic mode scattering about 20 of the mode 1 conversion and wave wave interactions the higher resolution 4 km hycom simulation begins to cascade energy to smaller scales and higher frequencies but these energy transfers are not yet strong enough to omit the application of an internal wave damping parameterization h25 agrees better with observations and analytical models than h12 and a prior hycom simulation discussed in buijsman et al 2016 on the one hand the comparison with the sparse mooring data suggests that h25 underestimates the internal tide energy by less than 10 while on the other hand the comparison with the altimetry inferred ssh variance indicates that h25 overestimates the global mean wave energy density by about 10 and the energy density in the hotspot regions by about 20 the sum of the resolved and parameterized conversion in h25 is also 10 larger than the surface tide dissipation estimated from tpxo8 atlas however the simulated modal conversion rates are in good agreement with the analytical conversion models it is plausible that these differences fall within the range of uncertainties associated with the analysis techniques and the validation data sets the hycom and altimetry sea surface height time series have durations of one year and about 20 years respectively which prevents a direct comparison of stationary tide signals to permit an apples to apples comparison we apply a correction to account for the decrease in the stationary signal as a function of the duration of a time series that includes both tidal and mesoscale variability appendix this correction improves the correlation regression and variance ratios between the altimetry and corrected hycom data sets credit authorship contribution statement maarten c buijsman conceptualization formal analysis funding acquisition project administration visualization writing original draft writing review editing gordon r stephenson formal analysis visualization writing original draft writing review editing joseph k ansong writing review editing brian k arbic funding acquisition writing review editing j a mattias green resources writing review editing james g richman writing review editing jay f shriver formal analysis resources software writing review editing clément vic resources writing review editing alan j wallcraft formal analysis resources software writing review editing zhongxiang zhao resources writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments m buijsman and g stephenson are funded by the office of naval research onr usa grants n00014 15 1 2288 and n00014 15 1 2578 national science foundation nsf usa grant oce1537449 and national aeronautic space administration nasa usa grants 80nssc18k0771 and nnx17ah55g b k arbic acknowledges support from onr usa grant n00014 15 1 2288 nasa grants nnx17ah55g and nnx16ah79g j ansong and b arbic acknowledge funding from the university of michigan usa associate professor support fund which is supported by the margaret and herman sokol faculty awards and from national science foundation nsf usa grant oce 0968783 the latter was part of a multi institution climate process team grant led by j mackinnon we thank c whalen a waterhouse e kunze and e zaron for comments and suggestions on an earlier version of this manuscript finally we acknowledge the two reviewers who s comments and suggestions have improved this article appendix computation of the variance correction factor as internal tides propagate through a time varying mesoscale background field the observed eulerian internal tide amplitudes and phases will vary in time due to refraction reflection and ducting shriver et al 2014 zaron and egbert 2014 zaron 2017 buijsman et al 2017 duda et al 2018 nelson et al 2019 to extract amplitudes and phases harmonic constants from model simulations and observations such as satellite altimetry and mooring records a least squares harmonic analysis is generally applied this yields the stationary internal tide variance which is inversely proportional to the duration of the time series colosi and munk 2006 nash et al 2012 ansong et al 2015 in this paper we validate two week and one year long m 2 steric sea surface height ssh records of the hycom simulations with 17 year long altimetry records m 2 ssh variance extracted from altimetry records that are longer than 10 years is most likely close to equilibrium while hycom simulations of one year or shorter are not colosi and munk 2006 ansong et al 2015 hence we need to make a correction for the time series duration to compare the stationary signal extracted from the hycom simulations with the stationary internal tide signal extracted from altimetry this correction factor has the form a 1 λ τ σ oeq 2 σ o τ 2 where σ oeq 2 is the equilibrium stationary variance and σ o τ 2 is the stationary variance of a time series with a duration τ both σ oeq 2 and σ o τ 2 can be spatially varying and should be computed from an observational record e g altimetry that is sufficiently long such that its variance has equilibrated to compare the variance of the short duration hycom simulations σ h τ 2 with the equilibrated altimetry variance the hycom variance can be corrected as follows a 2 σ heq 2 λ τ σ h τ 2 technically σ oeq 2 and σ o τ 2 should be computed from the altimetry record however the altimetry record is sparse with a sampling interval of 10 days and no coverage poleward of 66 the long sampling interval allows for the aliasing of non tidal signals into the tidal record in the western boundary current regions ray and byrne 2010 and makes it difficult to compute accurate σ o τ 2 for time series records shorter than 3 to 4 years similar to colosi and munk 2006 we could use tide gauge time series to compute λ τ however the mesoscale background variability is variable in space shriver et al 2014 buijsman et al 2017 consequently close to the internal tide generation site the internal tide is very stationary while farther away from the source the nonstationary fraction is much larger as is shown below this also causes λ τ to be spatially variable in particular for time series shorter than one year to account for the spatial variability we compute λ τ using 8 km hycom simulations with a duration of six years these simulations have been extensively discussed in shriver et al 2012 buijsman et al 2016 ansong et al 2015 and nelson et al 2019 although the dynamics have improved in more recent hycom simulations i e the 8 and 4 km simulations discussed in this paper as compared to this six year simulation we argue that potentially adverse effects are mitigated by the fact that λ τ is a ratio for each horizontal grid point we perform a least squares fit to extract the m 2 stationary ssh variance σ 2 1 2 η 2 where η is the complex harmonic constant σ 2 is computed for τ equal to 0 5 1 2 3 4 6 and 9 months and 1 1 5 2 3 4 and 6 years the time series with a duration of 2 3 and 4 years have overlapping windows to compute better statistics to reduce noise we average the variance to 0 5 cells the decay of the m 2 stationary ssh variance as a function of time series duration is shown in fig a 14 for two locations along a beam radiating equatorward from hawaii one location near the source features relatively strong stationary tides and little variance decay here the stationary fraction is 94 for a six year time series duration in contrast the second location is in the equatorial pacific which features strong tropical instability wave variability buijsman et al 2017 hence the variance decay is relatively strong and the stationary fraction is 21 for a time series duration of 6 years the equilibrium variance at these two locations as in most other places is reached for durations of less than three years for convenience we assume that σ oeq 2 σ heq 2 and that equilibrium occurs for a duration of six years in this paper we validate hycom sea surface height and modal energetics computed for two week and or one year long time series with altimetry for this purpose the energetics and sea surface height variance are corrected with λ τ for two weeks and one year as shown in fig a 15a and b λ τ is largest near the generation sites and away from the equatorial jets and the antarctic circumpolar and western boundary currents as the time series duration increases from two weeks to one year the correction factor becomes closer to unity fig a 15b however in areas with strong mesoscale variability like the equatorial pacific λ τ remains relatively small the identity 1 λ τ where τ is equal to two weeks fig a 15a represents the ratio between the nonstationary m 2 variance and the total m 2 variance nonstationary fraction and is similar to maps of the nonstationary fraction in figure 9 of zaron 2017 and figure 4 of nelson et al 2019 the globally averaged nonstationary fraction that we compute for the six year long hycom time series is about 40 which is similar to the 44 nonstationary fraction of zaron 2017 
23963,studies have suggested that the ocean dynamics in the south china sea scs play a crucial role in local air sea processes and the regional weather or climate system we used a high resolution regional coupled model to investigate the impact of the el niño southern oscillation enso on the atmospheric and oceanic processes in the scs during enso decaying winter spring the coupled model demonstrates the important roles of mesoscale features in the regional air sea interaction induced by the anomalous enso conditions during el niño the kuroshio intrusion into the scs is enhanced which further modifies the upper and middle layer circulation of the scs the reduced planetary vorticity transport during el niño results in a weakened cyclonic circulation and thinner mixed layer in the southern scs the modulations of the cyclonic circulation in the southern scs vietnam offshore jet and the coastal current during enso event enhance oceanic advection that favors an ocean forcing energy exchange to the atmosphere across the air sea interface the relative importance of atmospheric and oceanic forcing on the sst change during the enso evolution is verified using a heat budget analysis for different regions of scs in the el niño following spring the advective term due to anomalous ekman drift dominates the cooling process in the northern and eastern scs these thermal structure changes in the scs are contributed by the wind current topography interactions keywords regional coupled model south china sea enso 1 introduction the south china sea scs is one of the world s largest marginal seas fig 1 its surface thermal conditions greatly affect the weather and climate conditions in the sea and its adjacent landmass particularly the thermal conditions influence the path and intensity of tropical cyclones that travel across the scs wang et al 2007 surface circulation in the scs is mainly driven by seasonally reversed monsoon winds which are southwesterly in summer and northeasterly in winter fang et al 1998 hu et al 2000 qu 2000 asian monsoons also control water exchange between the scs and adjacent seas for example warm indian ocean surface water flows northward through the karimata strait into the scs in summer during winter a branch of the warm kuroshio current flows into the northeastern scs through the luzon strait qu et al 2009 fig 1 the connection between the scs s climate and the pacific el niño southern oscillation enso has drawn considerable attention wang et al 2000 suggested that the key system connecting el niño events and the east asian climate is an anomalous atmospheric anticyclone located in the philippine sea during el niño an anomalous cyclonic atmospheric circulation forms north of the equator as a rossby wave response to heating anomalies in the central equatorial pacific the anomalous northerlies to the west of the rossby gyre advect low background moist enthalpy defined as c p t l v q where c p and l v denote the specific heat at constant pressure and the latent heat of vaporization respectively southward leading to anomalous subsidence which further induces an anomalous low level anticyclone over the philippine sea as a rossby wave response wu et al 2017a b li et al 2017 this philippine sea anticyclone psac is a typical enso phenomenon affecting the east asian climate zhang et al 1999 wang et al 2000 wang and zhang 2002 anticyclonic anomalies typically develop rapidly in the western north pacific during late autumn and then strengthen to reach their mature phase in winter december to february the anomalous winds reverse during la niña hoerling et al 1997 lau and nath 2009 the surface heat flux shf sea surface temperature sst and surface circulation in the scs all change in response to an anomalous low level anticyclone or cyclone rainfall is also decreased increased in the scs during el niño la niña chao et al 1996 wang et al 2006 yang et al 2015 chen et al 2018 satellite and in situ measurements have revealed substantial warming in the scs during el niño and the role of ocean advection caused by the anomalous wind has been discovered to be crucial to the warming process wang et al 2002 xiao et al 2018 furthermore a double peak in the sst evolution following el niño events has been observed with the maximums occurring in february and august wang et al 2006 liu et al 2014 relevant studies have primarily used low resolution atmospheric and satellite data to clarify the large scale influence of the enso on the surface of the scs however ocean mesoscale features may play a crucial role in the local air sea process and provide feedback to the regional weather system as well as global climate variability bishop et al 2017 reported that in addition to atmospheric thermal forcing eddy stirring in the ocean can strongly influence shf variability qu et al 2004 reported that in addition to anomalous low level circulation triggering air sea interactions in the scs horizontal heat transport through the luzon strait is a critical process that conveys the impact of the enso into the scs many questions remain unanswered such as how the surface and subsurface ocean circulations in the scs change in response to the phases of the enso the associated ocean processes and the roles of mesoscale oceanic features in the enso related air sea process also remain to be identified in this study we employed a high resolution coupled model to investigate the process associated with the enso s effect on the scs the coupled model reveals strong air sea heat exchange anomalies and the relative contributions of the ocean and atmosphere in response to enso variability to our knowledge the ocean processes have not yet been examined carefully our results suggest the essential roles of mesoscale features in the regional air sea interaction triggered by anomalous atmosphere circulation to reduce the complexity resulting from the enso s decadal modulation e g hu et al 2017 we select two strong events from the last decade the 2015 2016 el niño and 2011 2012 la niña events by comparing our results with the average of the atmosphere low level circulation from six strong enso events el niño 1997 1998 2009 2010 and 2015 2016 la niña 1999 2000 2007 2008 and 2011 2012 using the national centers for environmental prediction ncep reanalysis we confirm that these two selected years are representative of psac variation over the scs for the general ocean response during the enso decay of winter to spring regardless of the type of el niño events the central pacific and eastern pacific types of el niño may cause some slightly different sst warming in the scs mostly resulting from the actual location of the anomalous low level anticyclone liu et al 2014 but do not affect the generality of the conclusion in this paper see the appendix for further discussion wang and wang 2013 classified the central pacific type of el niño el niño modoki into two groups el niño modoki i and ii tan et al 2016 suggested that the response of sst anomalies was similar during the canonical el niño and el niño modoki i whereas differences existed for el niño modoki ii the response of the scs to modoki ii requires further investigation but is beyond the scope of this study our major results address the following four aspects anomalous atmospheric circulation over the scs associated with the enso the associated response at the scs surface local air sea heat exchange and the subsurface scs response 2 model and observational data 2 1 atmosphere ocean coupled model the coupled ocean atmosphere wave sediment transport modeling system developed at woods hole coastal and marine science center in the united states has three state of the art dynamic components for modeling the atmosphere oceans waves and coastal environments warner et al 2010 these components are the weather research and forecasting wrf model skamarock et al 2005 regional ocean modeling system roms and simulating waves nearshore model these individual models communicate through the model coupling toolkit using the message passing interface to exchange model state variables warner et al 2010 to emphasize the interaction between the ocean and atmosphere in this study we only couple the ocean and atmosphere components without considering wave effects a pair of two way nested domains is used for both atmosphere and ocean models fig 1 the horizontal resolution for the first outer domains is 36 and 24 km for the wrf model and roms respectively whereas that of the second inner domains is 12 and 8 km 1 3 of the first domain vertically 36 and 25 levels are used in wrf model and roms respectively the ncep final fnl operational model global tropospheric analyses data are used as the initial and lateral boundary conditions updated every 6 h for the wrf model the roms uses realistic topography from the etopo2 us department of commerce national oceanic and atmospheric administration national geophysical data center 2006 the global 1 12 ocean predictions with the hybrid coordinate ocean model or navy coupled ocean data assimilation analysis data are used as the initial and lateral boundary conditions updated every 10 days the el niño simulation period is november 1 2015 to june 30 2016 and the la niña simulation period is november 1 2011 to june 30 2012 the major river runoffs included in the roms marked in fig 1 are based on the climatological monthly river runoff data retrieved from the global river flow and continental discharge dataset http www cgd ucar edu cas catalog surface dai runoff see dai 2016 for a detailed description note that xijiang beijiang and dongjiang all contribute to the pearl river estuary 2 2 observational and reanalysis data moderate resolution imaging spectroradiometer modis level 3 monthly sst images http dx doi org 10 5067 modst mo4d4 are used to examine the sst patterns during the two enso decaying years the ground resolution of the modis is approximately 4 km in addition temperature salinity t s profiles provided by the global array of argo floats are used for the validation freely available from http www argo ucsd edu and http argo jcommops org the monthly mean sea level pressure slp and surface wind data from the ncep reanalysis http www esrl noaa gov psd data gridded data ncep reanalysis derived html were also compared with the low level atmospheric circulation in the model results the ocean reanalysis hycom gofs 3 1 global ocean forecasting system hycom ncoda global 1 12 analysis is retrieved from http tds hycom org thredds catalogs glbv0 08 expt 53 x html data after 2015 is retrieved from http tds hycom org thredds catalogs glbv0 08 expt 56 3 html the temporal and spatial resolutions of gofs 3 1 are 3 h and 0 08 respectively 3 results 3 1 model validation seasonal variation in the scs fig 2a plots the modeled 8 month averaged november 2015 to june 2016 pattern of low level circulation the modeled biases model reanalysis are shown in fig 2b the average model circulation pattern is similar to the ncep reanalysis showing prevailing northeasterly winds in the scs fig 2c f shows that the consecutive 2 month averaged patterns deviate from the 8 month averaged pattern in fig 2a the biases of the 2 month averaged patterns are shown in fig 2g j during the early winter november december northeasterly wind anomalies prevail in the scs with positive slp anomalies centered in china the anomalies continually strengthen during january february and later change to negative and positive slp anomalies in china and the central scs respectively southerlies dominate the low level winds in the scs during may june the modeled seasonal variation and patterns are generally consistent with the reanalysis fig 3a b present a comparison of the 8 month averaged sst patterns between the model results and modis ssts for the same time period the modeled pattern is in favorable agreement with the observed modis ssts with slightly lower ssts in the model the average sst decreases gradually from the southeast of the scs to the northwest the coolest temperature is observed off the continental shelf of the scs and the kuroshio intrusion into the scs results in a warm tongue in the luzon strait fig 3a b the consecutive 2 month averaged patterns fig 3c j deviate from the average fields presented in fig 3a and b both the observations and the model reveal that the coolest ssts occur during january february with the ssts then gradually increasing throughout may june this warming occurs more quickly in the northern scs than the other regions the fastest warming occurs along the coast of southern china because of this coast s extremely shallow shelf the modeled ocean surface currents 2 month averaged vectors are superimposed on the bottom panels in fig 3 also indicate a southward western boundary current in the scs resulting in a cyclonic circulation in the southern scs during the northeasterly winter monsoon november february in addition the kuroshio intrusion into the scs through the luzon strait is considerable these surface current features are consistent with those reported previously hu et al 2000 additional comparison of the modeled subsurface t s data with the available argo floats is provided in fig 4 to quantitatively compare the t s data we defined three regions from north to south namely west of the luzon strait r1 west of luzon island r2 and east of vietnam r3 the regions are indicated in fig 4a all available trajectories from january to june 2016 are shown the 2 month averaged t s data lines in fig 4b g in these regions are directly compared with the argo data dots for the upper 500 m in r1 and r2 the modeled temperature and salinity profiles are all within the observational range in r3 the modeled surface salinity is slightly higher than the observation but is still within the range of the argo data at the subsurface the modeled salinity profile values were lower than the observed values because argo data are only available for may june 2016 in r3 with relatively few argo float sampling data the available argo data may not be representative for the 2 month average the difference may also result from the direct impact of interannual varying freshwater mekong river input the climatological value is specified in the model additional simulation without the river runoff input in the model confirmed the key role of river runoff in the scs salinity simulation without the river runoff data the modeled surface salinity is completely outside the observational data figure not shown in general the overall t s characteristics in the scs were reasonably represented by the model reasonable agreement with the observation in the la niña year was also discovered figures not shown 3 2 anomalous low level atmospheric circulation associated with the enso fig 5a d displays the modeled 2 month averaged slp and surface wind differences between el niño 2015 2016 and la niña 2011 2012 difference el niño value la niña value similar differences obtained from the ncep reanalysis are superimposed blue contours and vectors the anticyclone in the central scs appears in november december it intensifies during the matured enso january february and then decays during the following months in late spring may june the anticyclone intensifies again but its central location moves to the northern scs and this is accompanied by an enhanced easterly in the southern scs these features are similar to the ncep reanalysis fig 5e h the anomalous anticyclone associated southwesterly northeasterly in the northern southern scs indicates a weaker or stronger east asian winter monsoon in different parts of the scs during el niño the modeled anticyclonic circulation is stronger than the ncep reanalysis possibly due to the much finer resolution 24 km in the current model we note that the modeled location of the anomalous anticyclone slightly shifts westward compared to the ncep reanalysis this minor varying of location does not influence the major ocean responses discussed in the following sections since the anti cyclonic cyclonic circulation is a very robust atmospheric feature during el niño la niña regardless of the strengths and types of enso events wang et al 2000 li et al 2017 wu et al 2017a miller et al 2017 therefore the important oceanic responses will not matter too much we also perform additional ocean only numerical experiments forced by the reanalysis to confirm this similarity see the detailed comparison in the appendix the use of coupled model run here is to highlight not only the oceanic response but also the relevant air sea interaction to confirm that the selected two years are representative of the general enso response we superimposed the average slp differences magenta contours in fig 5e h from the six enso events el niño 1997 1998 2009 2010 and 2015 2016 la niña 1999 2000 2007 2008 and 2011 2012 http ggweather com enso oni htm similar patterns of slp differences suggest that the anticyclone strengthens during january february and then decays after march april this anomalous anticyclone forms because of the remote large scale enso impact e g wang et al 2000 wang and zhang 2002 we further discuss the ocean s response to the anomalous low level circulation and its coupled air sea interaction in the following sections 3 3 scs ocean surface temperature and current response to the enso fig 6a b shows the november june averaged sst differences between the el niño year and the la niña year from the modis and the model the general patterns are similar but a weaker sst contrast was observed in the model than in the modis this may be due to the higher skin temperature in the modis data than in the model s upper layer which is assumed to be well mixed the sst differences highlight the opposite dynamical processes in response to el niño and la niña mostly positive to the east of vietnam to further examine the seasonal evolution consecutive 2 month averaged differences in sst and model ocean surface flow between el niño and la niña are illustrated in fig 6c j the evolution november to june in sst difference is similar to that in the modis data except that the simulated warming during january february is weaker than the observation and the model indicates slower warming from march april to may june during november february northeasterly monsoon the anomalous low level anticyclonic circulation weakens the northeasterlies over the northwestern scs in the ocean the surface current difference off the vietnam coast is northward fig 6g i suggesting a weak western boundary current during el niño this phenomenon has been confirmed using long term altimetry and in situ data zu et al 2019 the surface current difference also reveals an anticyclonic mesoscale feature in the southern scs weakening the existing cyclonic eddy in the same location during el niño fig 3g h west of the luzon strait the anticyclonic feature suggests the enhancement of kuroshio intrusion during el niño whereas the kuroshio loop is common in winter we next examine the evolution of sst differences in november and december positive sst differences occur in the western scs fig 6g the amount of advective cool water is reduced because of the weakened southward boundary current during el niño this effect together with reduced upward surface turbulent heat flux in the northwestern scs during an el niño winter leads to relatively large positive sst anomalies in the western scs heat budget and air sea heat exchange is discussed in the following sections in january february the positive sst differences in the western scs are decreased during march april the northerlies weaken and are gradually replaced by southerlies leading to a northward western boundary current fig 3i the sst differences mostly become negative in the northern scs during this period simultaneously an anticyclonic feature forms to the west of the luzon island during el niño lasting through early summer this feature was noted and explained by chu and chang 1997 during the subsequent may june a positive sst occurs again over the eastern scs and northwestern pacific region this rewarming phenomenon after el niño was reported by xie et al 2009 who suggested that the sst increase during the summer of an el niño decaying year is due to enhanced high pressure resulting from the equatorial kelvin wave triggered by tropical indian ocean warming during may june a pair of cyclonic anticyclonic features exists to the east of vietnam 10 15 n these features suggest a northward shift of the offshore jet to the east of vietnam during spring to early summer the meridional displacement of the jet associated with the enso has been observed using satellite data li et al 2014 it was due to the anomalous and simultaneous easterly wind in the central scs fig 5 to further confirm the chosen enso years reflect the general responses to enso we calculate the same upper ocean responses using the composite of hycom reanalysis from the 8 strongest enso cases in the recent decades fig 6k n el niño 1997 98 2002 03 2009 10 2015 16 la niña 1999 00 2007 08 2010 11 2011 12 the composite shows similar sst and surface current difference marked by black circles in fig 6 except positive sst difference during march april negative in the difference between 2015 16 and 2011 12 however the overall sst tendency from winter to spring and early summer is similar to the chosen enso years 3 3 1 heat budget analysis fig 6 suggests that the sst in the scs responds differently during differing enso decay phases negative tendency is found in the sst difference from november december to march april with the largest change in the northern scs we quantify the associated physical processes using monthly heat budget analysis eq 1 1 t t u t x v t y w t z z k t z a h t 0 the first term is the surface layer temperature tendency followed by the advection term associated with horizontal and vertical fluid motions the last two terms are vertical and horizontal diffusion the vertical diffusion term is represented by the difference between the net shf and turbulent flux at the bottom of the ocean surface layer positive downward i e warming the ocean the horizontal diffusion is negligible fig 7 presents the surface layer heat budgets averaged over two boxes northern scs a1 southern scs a2 illustrated in fig 6a for el niño left la niña middle and their differences right the accumulated monthly tendency term is superimposed as a blue line and reflects the temperature change from the initial condition we note that the november initial sst for the el niño 2015 2016 simulation is higher than that for the la niña 2011 2012 in the northern scs a1 region fig 7a c during winter the surface layer is cooled in both el niño and la niña resulting mainly from the vertical diffusion term fig 7a b during spring the vertical diffusion becomes positive warming and the advective warming is as important as the warming by the vertical diffusion during winter to spring the diffusion term advection term in el niño is weaker stronger than in la niña fig 7c this is mainly due to the presence of anomalous anticyclonic circulation in the low level atmosphere that suppresses the upward shf by reducing surface wind speed the advection term plays a crucial role in bringing warm water northward to the northern scs to compensate for heat loss the difference in the advection term can also be viewed as an anomalous ekman drift toward southeast in the northern scs during el niño triggered by the southwesterly anomalies this transport results in the spread of cooler water in the coastal region of the northwestern scs toward the eastern scs our budget analysis suggests that in the northern scs a1 box weaker upward shf during el niño winter causes higher surface temperature than the la niña winter whereas lower ocean advection during the el niño spring causes lower surface temperature than the la niña spring in the southern scs a2 box fig 7d f the sst is higher and more homogeneous than that in the northern scs fig 3a b comparing the two enso events both the advection and vertical diffusion terms are larger during la niña the advection is crucial for warming during la niña winter this is associated with a stronger cyclonic circulation in the southern scs during el niño spring the temperature tendency is mainly determined by the vertical diffusion term however during la niña spring it is determined by both advection and vertical diffusion 3 3 2 air sea heat exchange fig 8 illustrates the mean differences in wind stress rainfall rate net radiative flux and surface turbulent heat flux sthf latent heat flux sensible heat flux between el niño and la niña difference el niño value la niña value during the winter december february and spring march may a positive heat flux difference indicates an upward difference i e more flux released to the atmosphere during el niño than la niña the lower rain rate in the el niño winter is mainly due to the anomalous descending flow under the anomalous anticyclonic circulation in the low level atmosphere fig 8b the net radiation flux differences fig 8c are relatively small compared with the sthf differences fig 8d regarding the wind stress and sthf differences we can clearly observe opposite features between the northern and southern scs mainly due to the anomalous low level anticyclonic circulation fig 5 that reduces enhances the wind speed in the northern southern scs during el niño in addition the higher sst in the southern scs during el niño contributes to the larger sthf than during la niña fig 6 note that in the heat budget the vertical diffusion term is weaker in el niño than la niña fig 7d f even with a stronger surface heat flux in the southern scs fig 8d this is because during la niña the cyclonic circulation in the southern scs is stronger accompanying with a thinner mixed layer depths mlds figs 3g i and 6g h that enhances turbulent flux at the bottom of the surface layer similar contrast patterns can be observed in the wind stress rain rate net radiative flux and sthf in the northern scs during spring fig 8e h in the southern scs the large sthf pattern during the winter is absent during spring because the sst contrast quickly decreases over time fig 6 to further investigate the relative contribution of the ocean and the atmosphere in the heat flux variations associated with enso variability we evaluated the relationship between the sst sst tendency rate of sst change and shf across the ocean surface which can help us identify whether the ocean drives atmospheric shf variability or the atmosphere forces ocean sst variability wu et al 2006 he and wu 2013 the statistical relationship has been clarified using simple stochastic models von storch 2000 wu et al 2006 the local energy balance of the coupled atmospheric system is as follows d t a d t α t o t a γ a t a n a d t o d t β t a t o γ o t o n o where t a is the near surface atmospheric temperature t o is the sst α and β are the exchange coefficients associated with the heat capacity of the atmosphere and ocean respectively α β γ a and γ o are the radiative damping coefficients and n a and n o represent stochastic forcing if the forcing arises only in the atmosphere n a 0 and n o 0 wu et al 2006 demonstrated that when atmosphere forcing dominates the sst tendency and shf have a significant negative relationship and the correlation between t o and shf is small conversely when ocean forcing dominates the correlation between sst tendency d t o dt and shf is small and that between t o and shf α t o t a is positive von storch 2000 wu et al 2006 related studies have shown that thermal inertial waves in the upper ocean generally serve to integrate high frequency atmospheric weather forcing an sst response von storch 2000 park et al 2005 wu et al 2006 however bishop et al 2017 noted that enhanced ocean advection features such as fronts and mesoscale eddies can result in the dominance of ocean forcing fig 9 illustrates the modeled relationship between sst or sst tendency anomalies and shf anomalies during the el niño and la niña winter december february and spring march may respectively the anomalies are calculated by subtracting the climatological monthly mean ncep reanalysis 1979 2009 during the el niño winter atmospheric forcing dominates the anomalous shf variation in the northern and central parts of the scs fig 9a and b anomalous low level anticyclonic circulation over the scs fig 5 suppresses convection and upward heat flux resulting in atmospheric forcing dominance during the la niña winter although atmospheric forcing predominates in the scs the ocean forces anomalous air sea heat flux in some regions including off the china coast and southwest of taiwan in the northern scs and in the cyclonic mesoscale eddy region in the southern scs fig 9c and d the cold china coastal current intensifies the cool water advection in the northern scs in addition an anomalous cyclonic upper ocean circulation in the southern scs provides a relatively strong advective ocean heat flux from the south resulting in sst forced atmospheric feedback in the southern scs during the el niño spring march may the atmosphere forces the sst except to the east of vietnam fig 9e and f similar results are obtained for the la niña spring except in the region of the sst forcing the shifts southward fig 9g and h this location shift also occurs in the difference in the upper ocean currents fig 6i and j in this region the advective heat flux caused by the ocean current is important xie et al 2007 li et al 2014 and the sst forces the anomalous air sea heat flux variation 3 4 scs subsurface response to the enso 3 4 1 modulation of mlds and related mesoscale features in the scs the subsurface response of the scs to enso variability plays a crucial role in the air sea interaction and the water and heat exchange between the scs and other ocean basins fig 10a and b depict the winter december february and spring march may mean mlds during 2015 2016 respectively the mld is defined as the depth at which the temperature is 0 5 c lower than at the surface levitus 1982 during winter the western boundary current in the scs has a relatively large mld fig 10a because the strengthening of the western boundary current enhances the vertical shear the enhanced downward momentum flux and vertical mixing increase the mlds in the region 110 112 e 12 16 n the larger mlds are associated with an anticyclonic circulation located to the north of the cyclonic circulation in the upper layer of the southern scs fig 3h j these circulation patterns are commonly found in the scs in winter hu et al 2000 during spring the mlds are smaller because of relaxation of the winter monsoon fig 10b which contributes to the change in vertical mixing and large surface heating slightly greater mlds are observed in the kuroshio loop in the luzon strait and anticyclonic eddy to the east of vietnam as expected fig 10 c and d further show the corresponding difference in mld between el niño and la niña the differences in surface wind stress curl between el niño and la niña are superimposed as contours the mlds in the el niño winter are generally greater than in the la niña winter particularly in the southern scs off the shore of southwestern taiwan and in the western boundary current the mld difference in the southern scs is directly related to the negative surface wind stress curl and strength of the cyclonic mesoscale eddy in the area a strong cyclonic eddy is accompanied by a small mld during the winter of the el niño la niña year the southward water transport along the western boundary of the scs is reduced enhanced fig 6g h which decreases increases the planetary vorticity flux in the southern scs consequently the cyclonic eddy in the southern scs is weakened intensified off the shore of china the relatively large mlds in the el niño winter are accompanied by a weaker coastal current than in the la niña winter which cannot be explained by the difference in positive wind stress curl fig 10c the mechanism responsible for the greater mlds in this region is associated with wind current topography interaction fig 11 shows the composite of mlds from eight enso events using the hycom reanalysis gofs 3 1 the results show similar pattern to those in fig 10 except a weaker magnitude confirming the robustness of these features fig 12 shows the time averaged december february temperature shaded and v velocity contours along 114 e 18 23 n the stronger weaker horizontal convergence off the southern coast of china due to the stronger weaker ekman flow during the la niña el niño winter drives more less cool bottom water offshore cooling the subsurface in the offshore region process schematic presented in fig 12 the pattern of mld difference during spring is similar to that for winter but with considerably lower magnitude 3 4 2 modulation of water exchange in the scs climatologically the major water exchange that occurs in the scs is that through the inflow luzon strait to the north and the outflow is through the mindoro and karimata straits to the south qu et al 2009 the luzon strait is the only deep strait that connects the middle and deep layers of the scs to the other basins annually the following three layer structure of luzon strait transport is observed upper layer inflow middle layer inflow and deep layer inflow hsin et al 2012 xu and oey 2014 however during the spring and summer the luzon strait inflow commonly decreases because the kuroshio mainstream shifts eastward across the luzon strait liang et al 2008 causing the northern scs current to flow eastward across the northern luzon strait outflow in summer hsin et al 2012 although the annual mean water transport in the taiwan strait is northward outflow in winter the transport turns southward because of driving by the strong northeasterly monsoon jan et al 2006 table 1 summarizes the water transport through the main straits in the scs on the basis of observation and numerical data figs 13a and 14b compare the 2 month averaged water transport through the four main straits labeled in fig 1 connecting the scs with other basins during the two enso years a schematic of water transport through the main straits between the el niño and la niña is also provided fig 13c and d the inflow through taiwan strait during el niño winter is considerably weaker than in la niña winter resulting from a reduced northeasterly monsoon associated with the anticyclonic atmospheric circulation fig 5 the luzon strait inflow is considerably larger during el niño than la niña and is accompanied by a higher and lower increase of outflow through the mindoro strait and karimata strait respectively the mindoro strait outflow has been reported to be strongly correlated with the luzon strait inflow metzger and hurlburt 1996 as expected the outflow through the middle layer of the luzon strait is weaker during el niño fig 13 to further explore the long term impact of the enso on water transport through the scs we quantify the winter water transport november february in the four straits between 1994 and 2015 using the hybrid coordinate ocean model hycom reanalysis data gofs 3 1 41 layer hycom navy coupled ocean data assimilation ncoda global 1 12 reanalysis fig 14 the interannual transport in the upper and middle layers of the luzon strait varies considerably with enso variability correlations of 0 62 and 0 54 respectively the correlation between the taiwan strait and nino3 4 is 0 55 suggesting similar enso effects due to the low level surface wind changes however the transport in the mindoro strait is not strongly correlated with the enso overall the interannual water transport is consistent with the schematic presented in fig 13 c and d the hycom reanalysis uses data assimilation with in situ and satellite observations this relatively large inflow through the luzon strait during el niño is associated with enhanced kuroshio intrusion previous studies have suggested that the kuroshio current loops into the luzon strait and its strength is mainly determined by the upstream kuroshio speed local wind stress and mesoscale eddies yuan et al 2006 sheremet and kuehl 2007 hsin et al 2012 considering only the enso related wind variability the reduced northeasterlies during el niño favor an eastward shift of the kuroshio mainstream in the luzon strait hence the local wind stress is not responsible for the enhanced kuroshio intrusion the lower or higher upstream kuroshio speed is responsible for the enhanced or weakened kuroshio loop respectively in the luzon strait the volume transport at 0 700 m off the eastern coast of luzon island 18 n 121 124 e averaged over 8 months november june during la niña is 5 51sv larger than that during el niño for a western boundary current encountering a boundary gap such as the kuroshio current in the luzon strait the vorticity balance is dominated by the advection and β terms when the upstream kuroshio speed is small enough such that the β effect dominates the flow the kuroshio current tends to intrude westward into the northern scs and then drastically returns forming an intense loop that preserves the potential vorticity with a strong curved flow sheremet and kuehl 2007 kuehl and sheremet 2009 the interannually varying water transport off the eastern coast of luzon island is correlated with the northward or southward shift of the north equatorial current nec bifurcation which is the origin of the kuroshio current fig 1 the southward migration of the nec bifurcation latitude results in an intensified kuroshio current east of luzon island yuan et al 2014 kim et al 2004 suggested that this relationship is mainly due to westward propagation of upwelling downwelling rossby waves generated by winds in the central equatorial pacific and by an anomalous low level anticyclone cyclone located in the western north pacific during el niño la niña qiu and chen 2010 discovered that the latitude of nec bifurcation is determined by the surface wind forcing wind stress and its curl in the 12 14 n band in the western pacific basin and the associated anomalies are significantly influenced by the enso the westerlies easterlies and positive negative wind stress curl anomalies during el niño la niña cause divergence convergence in the upper ocean that lowers increases the sea level height and are accompanied by northward southward movement of the latitude of nec bifurcation 3 4 3 three dimensional circulation in the scs the ocean circulation in the scs generally consists of a three layer structure top to bottom cyclonic anticyclonic and cyclonic using the reduced gravity equations xu and oey 2014 deduced that the cyclonic circulation in the upper layer results from wind induced ekman pumping and potential vorticity fluxes through the luzon and mindoro straits the mindoro strait offsets the influx from the luzon strait because the influence of the anomalous wind stress is mostly confined to the upper ocean and the luzon strait is the only channel deep enough to connect the middle layer of the scs with the pacific ocean the middle layer transport of the luzon strait controls the circulation anomalies in the middle layer of the scs the basin s middle layer 570 2000 m circulation is anticyclonic because of the outflow transport through the luzon strait gan et al 2016 deduced the dominant term for the circulation is the vortex stretching the major source of vortex stretching is the negative planetary vorticity flux extrinsically induced by the outflow in the middle layer 750 1500 m through the luzon strait fig 15 depicts the layer integrated transport stream function in the upper 750 m middle 750 1500 m and lower 1500 m layers during el niño and la niña this followed the definition of gan et al 2016 fig 16 presents a comparison of the three layer flow rate m3 s patterns between el niño and la niña in the upper layer both circulation patterns are cyclonic similar to the climatological mean however the circulation is weaker during the el niño year than the la niña year in the middle layer an anomalous cyclonic circulation is discovered during el niño fig 15a the anomalous cyclonic circulation in the middle layer is consistent with the water exchange through the main straits around the scs xu and oey 2014 gan et al 2016 the planetary vorticity influx accompanied by the enhanced kuroshio intrusion into the scs is the major source of anomalous cyclonic circulation in the upper and middle layers during el niño november june the anomalous cyclonic circulation in the scs s middle layer is attributed to the increased middle layer inflow in the luzon strait in the lower layer cyclonic circulation exists in both events consistent with the climatological mean structure the enso s influence on deep layer circulation is weak compared with that on the upper and middle layers 4 discussion and conclusion we used a high resolution regional coupled model to understand the crucial roles of oceanic mesoscale features in the air sea interaction and subsurface ocean response during the enso and its decay the relative importance of atmospheric and oceanic forcing in the sst change in different regions of the scs was also addressed we revealed that an anomalous anticyclonic cyclonic circulation in the low level atmosphere strongly affects the surface and subsurface patterns of the scs during el niño la niña particularly the response of the scs differs between regions fig 17 details the dynamical processes underlying the impact of the enso on the northern and southern scs in the northern scs the anomalous anticyclonic circulation in the low level atmosphere suppresses the upward sthf during an el niño winter however the anomalous ekman drift toward the southwest near the coast causes anomalous ocean surface cooling the combination of weakened upward sthf warming and a weaker southward western boundary current cooling results in a net higher sst in the northwestern scs this phenomenon is reversed during a la niña winter during an el niño and la niña spring displacement of the vietnam coastal jet can trigger an sst forced atmosphere condition both wind stress curl anomalies and the wind flow topography interaction play critical roles in the change in mld figs 10 12 in addition enhanced kuroshio intrusion during el niño which is associated with northward movement of the nec bifurcation results in water exchange between the scs and the western pacific modifying the circulation pattern in the scs in the southern scs the anomalous low level anticyclonic atmospheric circulation suppresses convection and rainfall in the southern scs during el niño winter to spring simultaneously the commonly observed cyclonic upper ocean circulation is weakened and the mld is decreased during el niño this is associated with a weaker wind driven western boundary current and anomalous negative wind stress curl the weakened western boundary current and cyclonic circulation associated with the enso alter the relative oceanic and atmospheric contributions to energy exchange across the air sea interface leading to a complex scenario that cannot be easily explained using the typical low resolution coupled global circulation model section 3 3 2 finally the sst forces shf anomalies off the shore of china during la niña winter our results clarify many regional air sea coupling issues in the scs declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the constructive comments from the anonymous reviewers are greatly appreciated this study is supported by the ministry of science and technology most taiwan grant 107 2611 m 002 013 m y4 and 108 2111 m 002 006 my3 appendix in the expa1 and expa2 table a 1 the roms model is forced by the era interim reanalysis without coupling with the wrf model the 3 hourly surface data with a resolution of 80 km is retrieved from https apps ecmwf int datasets data interim full daily levtype sfc themonthly averaged surface winds from the era interim is similar to the ncep reanalysis figure not shown by comparing these runs with the original coupled simulations we can clearly examine the ocean response differences driven by a more correct surface forcing however we note that the air sea coupling process e g fig 9 is missing in the additional runs fig a 1 compares the sea surface temperature and current from the satellite observation the coupled run and the forced run exp a1 during el niño the 8 month mean patterns are generally similar among them the kuroshio intrusion into the scs accompanying with high sst west of the luzon strait is evident the forced expa1 has warmer sst than the coupled run especially in the southern scs but the western boundary current and enhanced kuroshio intrusion is similar to the coupled run the 2 month averaged deviation also shows similar patterns but slightly different magnitudes particularly during may june expa1 shows higher sst in the northern scs fig a 1d than the coupled run fig a 1c in the 8 month mean pattern fig a 1a expa1 also shows higher sst than the modis observation these results suggest that the sst is overestimated during may june in the forced run the surface currents are similar in both the coupled and exp a1 runs including the southward western boundary current the cyclonic circulation in the southern scs and the kuroshio intrusion into the northern scs after spring the western boundary current reverses in both runs while the offshore current to the east of vietnam in the expa1 is weaker with southward shift fig a 2 a c compares 2 month mean differences in sst and surface current between el niño and la niña in the modis coupled run and expa respectively the winter sst difference in the expa is weaker than that in the coupled run and the modis observation also the spatial pattern of the march april sst difference northern and southern scs in the coupled run is closer to the modis than the difference of exp a the second time warming during may june is slightly stronger in the exp a but still weaker than the modis similarly the surface current differences show consistent mesoscale features in the coupled and forced expa runs before spring the consistent northward flow difference in the western boundary region and the anticyclonic difference in the southern scs marked by the circles in fig a 2 however after spring the surface current difference to the east of vietnam associated with the northward southward shifting of the offshore jets during el niño la niña is absent in the forced expa this shift of the offshore jets can be found from the hycom reanalysis composite fig 6n and has been noted in li et al 2014 these results suggest that either the spatial resolution of the wind forcing 80 km in the expa versus 12 km in the coupled run or the air sea coupling process might play an important role in the displacement of the eastward jet which is an interesting topic but beyond the scope of this study fig a 3 further shows the 2 month averaged water budget of scs inflow is positive in expa1 and expa2 the similar budgets to the original coupled runs fig 13 suggest that the dynamics and differences between these two enso events are consistent as shown in fig 13c d overall the general ocean responses in scs in the additional experiments suggest that the slightly displaced anticyclonic circulation westward shift in the coupled model does not affect the robust ocean responses 
23963,studies have suggested that the ocean dynamics in the south china sea scs play a crucial role in local air sea processes and the regional weather or climate system we used a high resolution regional coupled model to investigate the impact of the el niño southern oscillation enso on the atmospheric and oceanic processes in the scs during enso decaying winter spring the coupled model demonstrates the important roles of mesoscale features in the regional air sea interaction induced by the anomalous enso conditions during el niño the kuroshio intrusion into the scs is enhanced which further modifies the upper and middle layer circulation of the scs the reduced planetary vorticity transport during el niño results in a weakened cyclonic circulation and thinner mixed layer in the southern scs the modulations of the cyclonic circulation in the southern scs vietnam offshore jet and the coastal current during enso event enhance oceanic advection that favors an ocean forcing energy exchange to the atmosphere across the air sea interface the relative importance of atmospheric and oceanic forcing on the sst change during the enso evolution is verified using a heat budget analysis for different regions of scs in the el niño following spring the advective term due to anomalous ekman drift dominates the cooling process in the northern and eastern scs these thermal structure changes in the scs are contributed by the wind current topography interactions keywords regional coupled model south china sea enso 1 introduction the south china sea scs is one of the world s largest marginal seas fig 1 its surface thermal conditions greatly affect the weather and climate conditions in the sea and its adjacent landmass particularly the thermal conditions influence the path and intensity of tropical cyclones that travel across the scs wang et al 2007 surface circulation in the scs is mainly driven by seasonally reversed monsoon winds which are southwesterly in summer and northeasterly in winter fang et al 1998 hu et al 2000 qu 2000 asian monsoons also control water exchange between the scs and adjacent seas for example warm indian ocean surface water flows northward through the karimata strait into the scs in summer during winter a branch of the warm kuroshio current flows into the northeastern scs through the luzon strait qu et al 2009 fig 1 the connection between the scs s climate and the pacific el niño southern oscillation enso has drawn considerable attention wang et al 2000 suggested that the key system connecting el niño events and the east asian climate is an anomalous atmospheric anticyclone located in the philippine sea during el niño an anomalous cyclonic atmospheric circulation forms north of the equator as a rossby wave response to heating anomalies in the central equatorial pacific the anomalous northerlies to the west of the rossby gyre advect low background moist enthalpy defined as c p t l v q where c p and l v denote the specific heat at constant pressure and the latent heat of vaporization respectively southward leading to anomalous subsidence which further induces an anomalous low level anticyclone over the philippine sea as a rossby wave response wu et al 2017a b li et al 2017 this philippine sea anticyclone psac is a typical enso phenomenon affecting the east asian climate zhang et al 1999 wang et al 2000 wang and zhang 2002 anticyclonic anomalies typically develop rapidly in the western north pacific during late autumn and then strengthen to reach their mature phase in winter december to february the anomalous winds reverse during la niña hoerling et al 1997 lau and nath 2009 the surface heat flux shf sea surface temperature sst and surface circulation in the scs all change in response to an anomalous low level anticyclone or cyclone rainfall is also decreased increased in the scs during el niño la niña chao et al 1996 wang et al 2006 yang et al 2015 chen et al 2018 satellite and in situ measurements have revealed substantial warming in the scs during el niño and the role of ocean advection caused by the anomalous wind has been discovered to be crucial to the warming process wang et al 2002 xiao et al 2018 furthermore a double peak in the sst evolution following el niño events has been observed with the maximums occurring in february and august wang et al 2006 liu et al 2014 relevant studies have primarily used low resolution atmospheric and satellite data to clarify the large scale influence of the enso on the surface of the scs however ocean mesoscale features may play a crucial role in the local air sea process and provide feedback to the regional weather system as well as global climate variability bishop et al 2017 reported that in addition to atmospheric thermal forcing eddy stirring in the ocean can strongly influence shf variability qu et al 2004 reported that in addition to anomalous low level circulation triggering air sea interactions in the scs horizontal heat transport through the luzon strait is a critical process that conveys the impact of the enso into the scs many questions remain unanswered such as how the surface and subsurface ocean circulations in the scs change in response to the phases of the enso the associated ocean processes and the roles of mesoscale oceanic features in the enso related air sea process also remain to be identified in this study we employed a high resolution coupled model to investigate the process associated with the enso s effect on the scs the coupled model reveals strong air sea heat exchange anomalies and the relative contributions of the ocean and atmosphere in response to enso variability to our knowledge the ocean processes have not yet been examined carefully our results suggest the essential roles of mesoscale features in the regional air sea interaction triggered by anomalous atmosphere circulation to reduce the complexity resulting from the enso s decadal modulation e g hu et al 2017 we select two strong events from the last decade the 2015 2016 el niño and 2011 2012 la niña events by comparing our results with the average of the atmosphere low level circulation from six strong enso events el niño 1997 1998 2009 2010 and 2015 2016 la niña 1999 2000 2007 2008 and 2011 2012 using the national centers for environmental prediction ncep reanalysis we confirm that these two selected years are representative of psac variation over the scs for the general ocean response during the enso decay of winter to spring regardless of the type of el niño events the central pacific and eastern pacific types of el niño may cause some slightly different sst warming in the scs mostly resulting from the actual location of the anomalous low level anticyclone liu et al 2014 but do not affect the generality of the conclusion in this paper see the appendix for further discussion wang and wang 2013 classified the central pacific type of el niño el niño modoki into two groups el niño modoki i and ii tan et al 2016 suggested that the response of sst anomalies was similar during the canonical el niño and el niño modoki i whereas differences existed for el niño modoki ii the response of the scs to modoki ii requires further investigation but is beyond the scope of this study our major results address the following four aspects anomalous atmospheric circulation over the scs associated with the enso the associated response at the scs surface local air sea heat exchange and the subsurface scs response 2 model and observational data 2 1 atmosphere ocean coupled model the coupled ocean atmosphere wave sediment transport modeling system developed at woods hole coastal and marine science center in the united states has three state of the art dynamic components for modeling the atmosphere oceans waves and coastal environments warner et al 2010 these components are the weather research and forecasting wrf model skamarock et al 2005 regional ocean modeling system roms and simulating waves nearshore model these individual models communicate through the model coupling toolkit using the message passing interface to exchange model state variables warner et al 2010 to emphasize the interaction between the ocean and atmosphere in this study we only couple the ocean and atmosphere components without considering wave effects a pair of two way nested domains is used for both atmosphere and ocean models fig 1 the horizontal resolution for the first outer domains is 36 and 24 km for the wrf model and roms respectively whereas that of the second inner domains is 12 and 8 km 1 3 of the first domain vertically 36 and 25 levels are used in wrf model and roms respectively the ncep final fnl operational model global tropospheric analyses data are used as the initial and lateral boundary conditions updated every 6 h for the wrf model the roms uses realistic topography from the etopo2 us department of commerce national oceanic and atmospheric administration national geophysical data center 2006 the global 1 12 ocean predictions with the hybrid coordinate ocean model or navy coupled ocean data assimilation analysis data are used as the initial and lateral boundary conditions updated every 10 days the el niño simulation period is november 1 2015 to june 30 2016 and the la niña simulation period is november 1 2011 to june 30 2012 the major river runoffs included in the roms marked in fig 1 are based on the climatological monthly river runoff data retrieved from the global river flow and continental discharge dataset http www cgd ucar edu cas catalog surface dai runoff see dai 2016 for a detailed description note that xijiang beijiang and dongjiang all contribute to the pearl river estuary 2 2 observational and reanalysis data moderate resolution imaging spectroradiometer modis level 3 monthly sst images http dx doi org 10 5067 modst mo4d4 are used to examine the sst patterns during the two enso decaying years the ground resolution of the modis is approximately 4 km in addition temperature salinity t s profiles provided by the global array of argo floats are used for the validation freely available from http www argo ucsd edu and http argo jcommops org the monthly mean sea level pressure slp and surface wind data from the ncep reanalysis http www esrl noaa gov psd data gridded data ncep reanalysis derived html were also compared with the low level atmospheric circulation in the model results the ocean reanalysis hycom gofs 3 1 global ocean forecasting system hycom ncoda global 1 12 analysis is retrieved from http tds hycom org thredds catalogs glbv0 08 expt 53 x html data after 2015 is retrieved from http tds hycom org thredds catalogs glbv0 08 expt 56 3 html the temporal and spatial resolutions of gofs 3 1 are 3 h and 0 08 respectively 3 results 3 1 model validation seasonal variation in the scs fig 2a plots the modeled 8 month averaged november 2015 to june 2016 pattern of low level circulation the modeled biases model reanalysis are shown in fig 2b the average model circulation pattern is similar to the ncep reanalysis showing prevailing northeasterly winds in the scs fig 2c f shows that the consecutive 2 month averaged patterns deviate from the 8 month averaged pattern in fig 2a the biases of the 2 month averaged patterns are shown in fig 2g j during the early winter november december northeasterly wind anomalies prevail in the scs with positive slp anomalies centered in china the anomalies continually strengthen during january february and later change to negative and positive slp anomalies in china and the central scs respectively southerlies dominate the low level winds in the scs during may june the modeled seasonal variation and patterns are generally consistent with the reanalysis fig 3a b present a comparison of the 8 month averaged sst patterns between the model results and modis ssts for the same time period the modeled pattern is in favorable agreement with the observed modis ssts with slightly lower ssts in the model the average sst decreases gradually from the southeast of the scs to the northwest the coolest temperature is observed off the continental shelf of the scs and the kuroshio intrusion into the scs results in a warm tongue in the luzon strait fig 3a b the consecutive 2 month averaged patterns fig 3c j deviate from the average fields presented in fig 3a and b both the observations and the model reveal that the coolest ssts occur during january february with the ssts then gradually increasing throughout may june this warming occurs more quickly in the northern scs than the other regions the fastest warming occurs along the coast of southern china because of this coast s extremely shallow shelf the modeled ocean surface currents 2 month averaged vectors are superimposed on the bottom panels in fig 3 also indicate a southward western boundary current in the scs resulting in a cyclonic circulation in the southern scs during the northeasterly winter monsoon november february in addition the kuroshio intrusion into the scs through the luzon strait is considerable these surface current features are consistent with those reported previously hu et al 2000 additional comparison of the modeled subsurface t s data with the available argo floats is provided in fig 4 to quantitatively compare the t s data we defined three regions from north to south namely west of the luzon strait r1 west of luzon island r2 and east of vietnam r3 the regions are indicated in fig 4a all available trajectories from january to june 2016 are shown the 2 month averaged t s data lines in fig 4b g in these regions are directly compared with the argo data dots for the upper 500 m in r1 and r2 the modeled temperature and salinity profiles are all within the observational range in r3 the modeled surface salinity is slightly higher than the observation but is still within the range of the argo data at the subsurface the modeled salinity profile values were lower than the observed values because argo data are only available for may june 2016 in r3 with relatively few argo float sampling data the available argo data may not be representative for the 2 month average the difference may also result from the direct impact of interannual varying freshwater mekong river input the climatological value is specified in the model additional simulation without the river runoff input in the model confirmed the key role of river runoff in the scs salinity simulation without the river runoff data the modeled surface salinity is completely outside the observational data figure not shown in general the overall t s characteristics in the scs were reasonably represented by the model reasonable agreement with the observation in the la niña year was also discovered figures not shown 3 2 anomalous low level atmospheric circulation associated with the enso fig 5a d displays the modeled 2 month averaged slp and surface wind differences between el niño 2015 2016 and la niña 2011 2012 difference el niño value la niña value similar differences obtained from the ncep reanalysis are superimposed blue contours and vectors the anticyclone in the central scs appears in november december it intensifies during the matured enso january february and then decays during the following months in late spring may june the anticyclone intensifies again but its central location moves to the northern scs and this is accompanied by an enhanced easterly in the southern scs these features are similar to the ncep reanalysis fig 5e h the anomalous anticyclone associated southwesterly northeasterly in the northern southern scs indicates a weaker or stronger east asian winter monsoon in different parts of the scs during el niño the modeled anticyclonic circulation is stronger than the ncep reanalysis possibly due to the much finer resolution 24 km in the current model we note that the modeled location of the anomalous anticyclone slightly shifts westward compared to the ncep reanalysis this minor varying of location does not influence the major ocean responses discussed in the following sections since the anti cyclonic cyclonic circulation is a very robust atmospheric feature during el niño la niña regardless of the strengths and types of enso events wang et al 2000 li et al 2017 wu et al 2017a miller et al 2017 therefore the important oceanic responses will not matter too much we also perform additional ocean only numerical experiments forced by the reanalysis to confirm this similarity see the detailed comparison in the appendix the use of coupled model run here is to highlight not only the oceanic response but also the relevant air sea interaction to confirm that the selected two years are representative of the general enso response we superimposed the average slp differences magenta contours in fig 5e h from the six enso events el niño 1997 1998 2009 2010 and 2015 2016 la niña 1999 2000 2007 2008 and 2011 2012 http ggweather com enso oni htm similar patterns of slp differences suggest that the anticyclone strengthens during january february and then decays after march april this anomalous anticyclone forms because of the remote large scale enso impact e g wang et al 2000 wang and zhang 2002 we further discuss the ocean s response to the anomalous low level circulation and its coupled air sea interaction in the following sections 3 3 scs ocean surface temperature and current response to the enso fig 6a b shows the november june averaged sst differences between the el niño year and the la niña year from the modis and the model the general patterns are similar but a weaker sst contrast was observed in the model than in the modis this may be due to the higher skin temperature in the modis data than in the model s upper layer which is assumed to be well mixed the sst differences highlight the opposite dynamical processes in response to el niño and la niña mostly positive to the east of vietnam to further examine the seasonal evolution consecutive 2 month averaged differences in sst and model ocean surface flow between el niño and la niña are illustrated in fig 6c j the evolution november to june in sst difference is similar to that in the modis data except that the simulated warming during january february is weaker than the observation and the model indicates slower warming from march april to may june during november february northeasterly monsoon the anomalous low level anticyclonic circulation weakens the northeasterlies over the northwestern scs in the ocean the surface current difference off the vietnam coast is northward fig 6g i suggesting a weak western boundary current during el niño this phenomenon has been confirmed using long term altimetry and in situ data zu et al 2019 the surface current difference also reveals an anticyclonic mesoscale feature in the southern scs weakening the existing cyclonic eddy in the same location during el niño fig 3g h west of the luzon strait the anticyclonic feature suggests the enhancement of kuroshio intrusion during el niño whereas the kuroshio loop is common in winter we next examine the evolution of sst differences in november and december positive sst differences occur in the western scs fig 6g the amount of advective cool water is reduced because of the weakened southward boundary current during el niño this effect together with reduced upward surface turbulent heat flux in the northwestern scs during an el niño winter leads to relatively large positive sst anomalies in the western scs heat budget and air sea heat exchange is discussed in the following sections in january february the positive sst differences in the western scs are decreased during march april the northerlies weaken and are gradually replaced by southerlies leading to a northward western boundary current fig 3i the sst differences mostly become negative in the northern scs during this period simultaneously an anticyclonic feature forms to the west of the luzon island during el niño lasting through early summer this feature was noted and explained by chu and chang 1997 during the subsequent may june a positive sst occurs again over the eastern scs and northwestern pacific region this rewarming phenomenon after el niño was reported by xie et al 2009 who suggested that the sst increase during the summer of an el niño decaying year is due to enhanced high pressure resulting from the equatorial kelvin wave triggered by tropical indian ocean warming during may june a pair of cyclonic anticyclonic features exists to the east of vietnam 10 15 n these features suggest a northward shift of the offshore jet to the east of vietnam during spring to early summer the meridional displacement of the jet associated with the enso has been observed using satellite data li et al 2014 it was due to the anomalous and simultaneous easterly wind in the central scs fig 5 to further confirm the chosen enso years reflect the general responses to enso we calculate the same upper ocean responses using the composite of hycom reanalysis from the 8 strongest enso cases in the recent decades fig 6k n el niño 1997 98 2002 03 2009 10 2015 16 la niña 1999 00 2007 08 2010 11 2011 12 the composite shows similar sst and surface current difference marked by black circles in fig 6 except positive sst difference during march april negative in the difference between 2015 16 and 2011 12 however the overall sst tendency from winter to spring and early summer is similar to the chosen enso years 3 3 1 heat budget analysis fig 6 suggests that the sst in the scs responds differently during differing enso decay phases negative tendency is found in the sst difference from november december to march april with the largest change in the northern scs we quantify the associated physical processes using monthly heat budget analysis eq 1 1 t t u t x v t y w t z z k t z a h t 0 the first term is the surface layer temperature tendency followed by the advection term associated with horizontal and vertical fluid motions the last two terms are vertical and horizontal diffusion the vertical diffusion term is represented by the difference between the net shf and turbulent flux at the bottom of the ocean surface layer positive downward i e warming the ocean the horizontal diffusion is negligible fig 7 presents the surface layer heat budgets averaged over two boxes northern scs a1 southern scs a2 illustrated in fig 6a for el niño left la niña middle and their differences right the accumulated monthly tendency term is superimposed as a blue line and reflects the temperature change from the initial condition we note that the november initial sst for the el niño 2015 2016 simulation is higher than that for the la niña 2011 2012 in the northern scs a1 region fig 7a c during winter the surface layer is cooled in both el niño and la niña resulting mainly from the vertical diffusion term fig 7a b during spring the vertical diffusion becomes positive warming and the advective warming is as important as the warming by the vertical diffusion during winter to spring the diffusion term advection term in el niño is weaker stronger than in la niña fig 7c this is mainly due to the presence of anomalous anticyclonic circulation in the low level atmosphere that suppresses the upward shf by reducing surface wind speed the advection term plays a crucial role in bringing warm water northward to the northern scs to compensate for heat loss the difference in the advection term can also be viewed as an anomalous ekman drift toward southeast in the northern scs during el niño triggered by the southwesterly anomalies this transport results in the spread of cooler water in the coastal region of the northwestern scs toward the eastern scs our budget analysis suggests that in the northern scs a1 box weaker upward shf during el niño winter causes higher surface temperature than the la niña winter whereas lower ocean advection during the el niño spring causes lower surface temperature than the la niña spring in the southern scs a2 box fig 7d f the sst is higher and more homogeneous than that in the northern scs fig 3a b comparing the two enso events both the advection and vertical diffusion terms are larger during la niña the advection is crucial for warming during la niña winter this is associated with a stronger cyclonic circulation in the southern scs during el niño spring the temperature tendency is mainly determined by the vertical diffusion term however during la niña spring it is determined by both advection and vertical diffusion 3 3 2 air sea heat exchange fig 8 illustrates the mean differences in wind stress rainfall rate net radiative flux and surface turbulent heat flux sthf latent heat flux sensible heat flux between el niño and la niña difference el niño value la niña value during the winter december february and spring march may a positive heat flux difference indicates an upward difference i e more flux released to the atmosphere during el niño than la niña the lower rain rate in the el niño winter is mainly due to the anomalous descending flow under the anomalous anticyclonic circulation in the low level atmosphere fig 8b the net radiation flux differences fig 8c are relatively small compared with the sthf differences fig 8d regarding the wind stress and sthf differences we can clearly observe opposite features between the northern and southern scs mainly due to the anomalous low level anticyclonic circulation fig 5 that reduces enhances the wind speed in the northern southern scs during el niño in addition the higher sst in the southern scs during el niño contributes to the larger sthf than during la niña fig 6 note that in the heat budget the vertical diffusion term is weaker in el niño than la niña fig 7d f even with a stronger surface heat flux in the southern scs fig 8d this is because during la niña the cyclonic circulation in the southern scs is stronger accompanying with a thinner mixed layer depths mlds figs 3g i and 6g h that enhances turbulent flux at the bottom of the surface layer similar contrast patterns can be observed in the wind stress rain rate net radiative flux and sthf in the northern scs during spring fig 8e h in the southern scs the large sthf pattern during the winter is absent during spring because the sst contrast quickly decreases over time fig 6 to further investigate the relative contribution of the ocean and the atmosphere in the heat flux variations associated with enso variability we evaluated the relationship between the sst sst tendency rate of sst change and shf across the ocean surface which can help us identify whether the ocean drives atmospheric shf variability or the atmosphere forces ocean sst variability wu et al 2006 he and wu 2013 the statistical relationship has been clarified using simple stochastic models von storch 2000 wu et al 2006 the local energy balance of the coupled atmospheric system is as follows d t a d t α t o t a γ a t a n a d t o d t β t a t o γ o t o n o where t a is the near surface atmospheric temperature t o is the sst α and β are the exchange coefficients associated with the heat capacity of the atmosphere and ocean respectively α β γ a and γ o are the radiative damping coefficients and n a and n o represent stochastic forcing if the forcing arises only in the atmosphere n a 0 and n o 0 wu et al 2006 demonstrated that when atmosphere forcing dominates the sst tendency and shf have a significant negative relationship and the correlation between t o and shf is small conversely when ocean forcing dominates the correlation between sst tendency d t o dt and shf is small and that between t o and shf α t o t a is positive von storch 2000 wu et al 2006 related studies have shown that thermal inertial waves in the upper ocean generally serve to integrate high frequency atmospheric weather forcing an sst response von storch 2000 park et al 2005 wu et al 2006 however bishop et al 2017 noted that enhanced ocean advection features such as fronts and mesoscale eddies can result in the dominance of ocean forcing fig 9 illustrates the modeled relationship between sst or sst tendency anomalies and shf anomalies during the el niño and la niña winter december february and spring march may respectively the anomalies are calculated by subtracting the climatological monthly mean ncep reanalysis 1979 2009 during the el niño winter atmospheric forcing dominates the anomalous shf variation in the northern and central parts of the scs fig 9a and b anomalous low level anticyclonic circulation over the scs fig 5 suppresses convection and upward heat flux resulting in atmospheric forcing dominance during the la niña winter although atmospheric forcing predominates in the scs the ocean forces anomalous air sea heat flux in some regions including off the china coast and southwest of taiwan in the northern scs and in the cyclonic mesoscale eddy region in the southern scs fig 9c and d the cold china coastal current intensifies the cool water advection in the northern scs in addition an anomalous cyclonic upper ocean circulation in the southern scs provides a relatively strong advective ocean heat flux from the south resulting in sst forced atmospheric feedback in the southern scs during the el niño spring march may the atmosphere forces the sst except to the east of vietnam fig 9e and f similar results are obtained for the la niña spring except in the region of the sst forcing the shifts southward fig 9g and h this location shift also occurs in the difference in the upper ocean currents fig 6i and j in this region the advective heat flux caused by the ocean current is important xie et al 2007 li et al 2014 and the sst forces the anomalous air sea heat flux variation 3 4 scs subsurface response to the enso 3 4 1 modulation of mlds and related mesoscale features in the scs the subsurface response of the scs to enso variability plays a crucial role in the air sea interaction and the water and heat exchange between the scs and other ocean basins fig 10a and b depict the winter december february and spring march may mean mlds during 2015 2016 respectively the mld is defined as the depth at which the temperature is 0 5 c lower than at the surface levitus 1982 during winter the western boundary current in the scs has a relatively large mld fig 10a because the strengthening of the western boundary current enhances the vertical shear the enhanced downward momentum flux and vertical mixing increase the mlds in the region 110 112 e 12 16 n the larger mlds are associated with an anticyclonic circulation located to the north of the cyclonic circulation in the upper layer of the southern scs fig 3h j these circulation patterns are commonly found in the scs in winter hu et al 2000 during spring the mlds are smaller because of relaxation of the winter monsoon fig 10b which contributes to the change in vertical mixing and large surface heating slightly greater mlds are observed in the kuroshio loop in the luzon strait and anticyclonic eddy to the east of vietnam as expected fig 10 c and d further show the corresponding difference in mld between el niño and la niña the differences in surface wind stress curl between el niño and la niña are superimposed as contours the mlds in the el niño winter are generally greater than in the la niña winter particularly in the southern scs off the shore of southwestern taiwan and in the western boundary current the mld difference in the southern scs is directly related to the negative surface wind stress curl and strength of the cyclonic mesoscale eddy in the area a strong cyclonic eddy is accompanied by a small mld during the winter of the el niño la niña year the southward water transport along the western boundary of the scs is reduced enhanced fig 6g h which decreases increases the planetary vorticity flux in the southern scs consequently the cyclonic eddy in the southern scs is weakened intensified off the shore of china the relatively large mlds in the el niño winter are accompanied by a weaker coastal current than in the la niña winter which cannot be explained by the difference in positive wind stress curl fig 10c the mechanism responsible for the greater mlds in this region is associated with wind current topography interaction fig 11 shows the composite of mlds from eight enso events using the hycom reanalysis gofs 3 1 the results show similar pattern to those in fig 10 except a weaker magnitude confirming the robustness of these features fig 12 shows the time averaged december february temperature shaded and v velocity contours along 114 e 18 23 n the stronger weaker horizontal convergence off the southern coast of china due to the stronger weaker ekman flow during the la niña el niño winter drives more less cool bottom water offshore cooling the subsurface in the offshore region process schematic presented in fig 12 the pattern of mld difference during spring is similar to that for winter but with considerably lower magnitude 3 4 2 modulation of water exchange in the scs climatologically the major water exchange that occurs in the scs is that through the inflow luzon strait to the north and the outflow is through the mindoro and karimata straits to the south qu et al 2009 the luzon strait is the only deep strait that connects the middle and deep layers of the scs to the other basins annually the following three layer structure of luzon strait transport is observed upper layer inflow middle layer inflow and deep layer inflow hsin et al 2012 xu and oey 2014 however during the spring and summer the luzon strait inflow commonly decreases because the kuroshio mainstream shifts eastward across the luzon strait liang et al 2008 causing the northern scs current to flow eastward across the northern luzon strait outflow in summer hsin et al 2012 although the annual mean water transport in the taiwan strait is northward outflow in winter the transport turns southward because of driving by the strong northeasterly monsoon jan et al 2006 table 1 summarizes the water transport through the main straits in the scs on the basis of observation and numerical data figs 13a and 14b compare the 2 month averaged water transport through the four main straits labeled in fig 1 connecting the scs with other basins during the two enso years a schematic of water transport through the main straits between the el niño and la niña is also provided fig 13c and d the inflow through taiwan strait during el niño winter is considerably weaker than in la niña winter resulting from a reduced northeasterly monsoon associated with the anticyclonic atmospheric circulation fig 5 the luzon strait inflow is considerably larger during el niño than la niña and is accompanied by a higher and lower increase of outflow through the mindoro strait and karimata strait respectively the mindoro strait outflow has been reported to be strongly correlated with the luzon strait inflow metzger and hurlburt 1996 as expected the outflow through the middle layer of the luzon strait is weaker during el niño fig 13 to further explore the long term impact of the enso on water transport through the scs we quantify the winter water transport november february in the four straits between 1994 and 2015 using the hybrid coordinate ocean model hycom reanalysis data gofs 3 1 41 layer hycom navy coupled ocean data assimilation ncoda global 1 12 reanalysis fig 14 the interannual transport in the upper and middle layers of the luzon strait varies considerably with enso variability correlations of 0 62 and 0 54 respectively the correlation between the taiwan strait and nino3 4 is 0 55 suggesting similar enso effects due to the low level surface wind changes however the transport in the mindoro strait is not strongly correlated with the enso overall the interannual water transport is consistent with the schematic presented in fig 13 c and d the hycom reanalysis uses data assimilation with in situ and satellite observations this relatively large inflow through the luzon strait during el niño is associated with enhanced kuroshio intrusion previous studies have suggested that the kuroshio current loops into the luzon strait and its strength is mainly determined by the upstream kuroshio speed local wind stress and mesoscale eddies yuan et al 2006 sheremet and kuehl 2007 hsin et al 2012 considering only the enso related wind variability the reduced northeasterlies during el niño favor an eastward shift of the kuroshio mainstream in the luzon strait hence the local wind stress is not responsible for the enhanced kuroshio intrusion the lower or higher upstream kuroshio speed is responsible for the enhanced or weakened kuroshio loop respectively in the luzon strait the volume transport at 0 700 m off the eastern coast of luzon island 18 n 121 124 e averaged over 8 months november june during la niña is 5 51sv larger than that during el niño for a western boundary current encountering a boundary gap such as the kuroshio current in the luzon strait the vorticity balance is dominated by the advection and β terms when the upstream kuroshio speed is small enough such that the β effect dominates the flow the kuroshio current tends to intrude westward into the northern scs and then drastically returns forming an intense loop that preserves the potential vorticity with a strong curved flow sheremet and kuehl 2007 kuehl and sheremet 2009 the interannually varying water transport off the eastern coast of luzon island is correlated with the northward or southward shift of the north equatorial current nec bifurcation which is the origin of the kuroshio current fig 1 the southward migration of the nec bifurcation latitude results in an intensified kuroshio current east of luzon island yuan et al 2014 kim et al 2004 suggested that this relationship is mainly due to westward propagation of upwelling downwelling rossby waves generated by winds in the central equatorial pacific and by an anomalous low level anticyclone cyclone located in the western north pacific during el niño la niña qiu and chen 2010 discovered that the latitude of nec bifurcation is determined by the surface wind forcing wind stress and its curl in the 12 14 n band in the western pacific basin and the associated anomalies are significantly influenced by the enso the westerlies easterlies and positive negative wind stress curl anomalies during el niño la niña cause divergence convergence in the upper ocean that lowers increases the sea level height and are accompanied by northward southward movement of the latitude of nec bifurcation 3 4 3 three dimensional circulation in the scs the ocean circulation in the scs generally consists of a three layer structure top to bottom cyclonic anticyclonic and cyclonic using the reduced gravity equations xu and oey 2014 deduced that the cyclonic circulation in the upper layer results from wind induced ekman pumping and potential vorticity fluxes through the luzon and mindoro straits the mindoro strait offsets the influx from the luzon strait because the influence of the anomalous wind stress is mostly confined to the upper ocean and the luzon strait is the only channel deep enough to connect the middle layer of the scs with the pacific ocean the middle layer transport of the luzon strait controls the circulation anomalies in the middle layer of the scs the basin s middle layer 570 2000 m circulation is anticyclonic because of the outflow transport through the luzon strait gan et al 2016 deduced the dominant term for the circulation is the vortex stretching the major source of vortex stretching is the negative planetary vorticity flux extrinsically induced by the outflow in the middle layer 750 1500 m through the luzon strait fig 15 depicts the layer integrated transport stream function in the upper 750 m middle 750 1500 m and lower 1500 m layers during el niño and la niña this followed the definition of gan et al 2016 fig 16 presents a comparison of the three layer flow rate m3 s patterns between el niño and la niña in the upper layer both circulation patterns are cyclonic similar to the climatological mean however the circulation is weaker during the el niño year than the la niña year in the middle layer an anomalous cyclonic circulation is discovered during el niño fig 15a the anomalous cyclonic circulation in the middle layer is consistent with the water exchange through the main straits around the scs xu and oey 2014 gan et al 2016 the planetary vorticity influx accompanied by the enhanced kuroshio intrusion into the scs is the major source of anomalous cyclonic circulation in the upper and middle layers during el niño november june the anomalous cyclonic circulation in the scs s middle layer is attributed to the increased middle layer inflow in the luzon strait in the lower layer cyclonic circulation exists in both events consistent with the climatological mean structure the enso s influence on deep layer circulation is weak compared with that on the upper and middle layers 4 discussion and conclusion we used a high resolution regional coupled model to understand the crucial roles of oceanic mesoscale features in the air sea interaction and subsurface ocean response during the enso and its decay the relative importance of atmospheric and oceanic forcing in the sst change in different regions of the scs was also addressed we revealed that an anomalous anticyclonic cyclonic circulation in the low level atmosphere strongly affects the surface and subsurface patterns of the scs during el niño la niña particularly the response of the scs differs between regions fig 17 details the dynamical processes underlying the impact of the enso on the northern and southern scs in the northern scs the anomalous anticyclonic circulation in the low level atmosphere suppresses the upward sthf during an el niño winter however the anomalous ekman drift toward the southwest near the coast causes anomalous ocean surface cooling the combination of weakened upward sthf warming and a weaker southward western boundary current cooling results in a net higher sst in the northwestern scs this phenomenon is reversed during a la niña winter during an el niño and la niña spring displacement of the vietnam coastal jet can trigger an sst forced atmosphere condition both wind stress curl anomalies and the wind flow topography interaction play critical roles in the change in mld figs 10 12 in addition enhanced kuroshio intrusion during el niño which is associated with northward movement of the nec bifurcation results in water exchange between the scs and the western pacific modifying the circulation pattern in the scs in the southern scs the anomalous low level anticyclonic atmospheric circulation suppresses convection and rainfall in the southern scs during el niño winter to spring simultaneously the commonly observed cyclonic upper ocean circulation is weakened and the mld is decreased during el niño this is associated with a weaker wind driven western boundary current and anomalous negative wind stress curl the weakened western boundary current and cyclonic circulation associated with the enso alter the relative oceanic and atmospheric contributions to energy exchange across the air sea interface leading to a complex scenario that cannot be easily explained using the typical low resolution coupled global circulation model section 3 3 2 finally the sst forces shf anomalies off the shore of china during la niña winter our results clarify many regional air sea coupling issues in the scs declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the constructive comments from the anonymous reviewers are greatly appreciated this study is supported by the ministry of science and technology most taiwan grant 107 2611 m 002 013 m y4 and 108 2111 m 002 006 my3 appendix in the expa1 and expa2 table a 1 the roms model is forced by the era interim reanalysis without coupling with the wrf model the 3 hourly surface data with a resolution of 80 km is retrieved from https apps ecmwf int datasets data interim full daily levtype sfc themonthly averaged surface winds from the era interim is similar to the ncep reanalysis figure not shown by comparing these runs with the original coupled simulations we can clearly examine the ocean response differences driven by a more correct surface forcing however we note that the air sea coupling process e g fig 9 is missing in the additional runs fig a 1 compares the sea surface temperature and current from the satellite observation the coupled run and the forced run exp a1 during el niño the 8 month mean patterns are generally similar among them the kuroshio intrusion into the scs accompanying with high sst west of the luzon strait is evident the forced expa1 has warmer sst than the coupled run especially in the southern scs but the western boundary current and enhanced kuroshio intrusion is similar to the coupled run the 2 month averaged deviation also shows similar patterns but slightly different magnitudes particularly during may june expa1 shows higher sst in the northern scs fig a 1d than the coupled run fig a 1c in the 8 month mean pattern fig a 1a expa1 also shows higher sst than the modis observation these results suggest that the sst is overestimated during may june in the forced run the surface currents are similar in both the coupled and exp a1 runs including the southward western boundary current the cyclonic circulation in the southern scs and the kuroshio intrusion into the northern scs after spring the western boundary current reverses in both runs while the offshore current to the east of vietnam in the expa1 is weaker with southward shift fig a 2 a c compares 2 month mean differences in sst and surface current between el niño and la niña in the modis coupled run and expa respectively the winter sst difference in the expa is weaker than that in the coupled run and the modis observation also the spatial pattern of the march april sst difference northern and southern scs in the coupled run is closer to the modis than the difference of exp a the second time warming during may june is slightly stronger in the exp a but still weaker than the modis similarly the surface current differences show consistent mesoscale features in the coupled and forced expa runs before spring the consistent northward flow difference in the western boundary region and the anticyclonic difference in the southern scs marked by the circles in fig a 2 however after spring the surface current difference to the east of vietnam associated with the northward southward shifting of the offshore jets during el niño la niña is absent in the forced expa this shift of the offshore jets can be found from the hycom reanalysis composite fig 6n and has been noted in li et al 2014 these results suggest that either the spatial resolution of the wind forcing 80 km in the expa versus 12 km in the coupled run or the air sea coupling process might play an important role in the displacement of the eastward jet which is an interesting topic but beyond the scope of this study fig a 3 further shows the 2 month averaged water budget of scs inflow is positive in expa1 and expa2 the similar budgets to the original coupled runs fig 13 suggest that the dynamics and differences between these two enso events are consistent as shown in fig 13c d overall the general ocean responses in scs in the additional experiments suggest that the slightly displaced anticyclonic circulation westward shift in the coupled model does not affect the robust ocean responses 
23964,a two dimensional vertical section of the strait of gibraltar is simulated numerically with the nonhydrostatic non boussinesq three dimensional croco model to investigate details of small scale dynamics the proposed configuration is simple computationally efficient and incorporates the configuration of sills characteristic of this region despite the shortcomings of a 2d representation this configuration provides a realistic depiction of small scale mechanisms in the strait during a typical tidal cycle internal solitary waves generation and propagation occurrence of hydraulic controls and hydraulic jumps at the sills and presence of active turbulent patches in particular the well known eastward propagation of large amplitude internal waves is assessed using the korteweg de vries kdv propagation model for solitary waves as a step towards establishing a realistic three dimensional large eddy simulation les the sensitivity of the configuration to various choices e g resolution amplitude of tidal forcing or numerical schemes is investigated our analyses indicate that the representation of small scale dynamics in the strait of gibraltar can be much improved by increasing resolution and relaxing the hydrostatic assumption further studies are necessary to grasp the mechanisms of mixing and or stirring induced by this fine scale process keywords strait of gibraltar internal solitary waves nonhydrostatic processes large eddy simulation 1 introduction the strait of gibraltar connects two major basins the northern atlantic and the mediterranean sea over which evaporation exceeds precipitation and river run off to compensate the resulting loss exchanges of mass and salt are required through the strait fig 1 illustrates the rather complex exchanges occurring there inflowing atlantic water is less salty salinity s a 36 than the outflowing mediterranean water s m 38 and spreads as a surface layer in the alboran sea the interface between the two water masses is distorted by undulations that are not precisely periodic with regard to the tidal cycle but exhibit regularity in some areas one of the paper objectives is to better understand the small scale processes that lead to the atlantic and mediterranean water masses transformation in the vicinity of the strait of gibraltar to further illustrate the exchange between the northern atlantic and the mediterranean a very simple steady state model can be expressed as a system of two basic conservation equations volume conservation is expressed as 1 q a q m e p while the conservation of salt requires 2 q a s a q m s m 0 where q a is the atlantic water volume flux positive q m is the mediterranean water volume flux negative both localized in the strait of gibraltar and e p is the space averaged evaporation minus precipitation and river runoff water budget integrated over the whole mediterranean sea e p is positive s a s m stands for atlantic mediterranean water mean salinity and s m s a 2 bethoux 1979 the water budget e p is positive in the mediterranean due to excess evaporation that correspond to a yearly averaged loss of water of about 1 metre over the whole basin garrett et al 1990 a major dynamical feature in the strait of gibraltar is the so called flow criticality usually characterized by the froude number f it compares the internal wave phase speed with a flow characteristic velocity several definitions of the non dimensional froude number can be found in the literature it can notably be defined for each layer resulting in a composite number for the whole water column as in farmer and armi 1988 or in sannino et al 2009b a subcritical respectively supercritical regime lies in the range of small respectively large values of the froude number f 1 respectively f 1 with an intermediate critical regime for f 1 the upstream propagation of internal waves is inhibited for supercritical flow so that a hydraulic control occurs at the transition from subcritical to supercritical flow it persists during periods and within regions of large froude numbers as such the hydraulic regime at a given point will vary in time according to substantial currents variations occurring along the tidal cycle it is for example well established that large amplitude solitary waves in the strait of gibraltar can develop due to the hydraulic control at camarinal sill farmer and armi 1988 making it a crucial process to represent several analytical models have been proposed to investigate the hydraulic control in the gibraltar region bryden and stommel 1984 farmer and armi 1986 garrett et al 1990 the hydraulic control usually occurs in these models at camarinal sill cs espartel sill es and tarifa narrows tn although the modelled hydraulic control location and frequency vary according to the model refinement 1 farmer and armi 1986 s two layer model accounts for the strait geometry depth and width the exchanged volumes q a and q m and the salinity contrast s a s m this simple model is able to simulate two hydraulic controls the first one located by the sill the other in the tn contraction defining maximal exchange regime further details are given below 2 in a slightly more elaborated model the inclusion of entrainment between the two layers and the subsequent interfacial layer introduction modify the left hand terms of eqs 1 and 2 with the introduction of horizontal and vertical transports in the interfacial layer bray et al 1995 critical conditions are changed within such two interfaces model which may support two baroclinic modes and new hydraulic controls sannino et al 2009b 3 considering a three dimensional flow the definition of the control needs to account for cross strait variations such as the tilt of the density interface in the latitudinal direction in the maximal exchange solution control in tn may induce the detachment of the surface layer from the northern coast sannino et al 2009b the hydraulic control effect within the strait is illustrated in fig 1 the flow is initially subcritical in the strait the propagation of internal waves is not hindered at the interface between atlantic and mediterranean waters denoted a in fig 1 then the tidal flood in the vicinity of the camarinal sill becomes supercritical in the supercritical to subcritical transition downstream of the sill a hydraulic jump b in fig 1 may occur hydraulic jumps are large amplitude depressions in the regions where hydraulic controls occur there intense mixing between the atlantic and mediterranean waters takes place as observed by wesson and gregg 1994 shear flow instabilities can develop in the hydraulic jump of the camarinal sill denoted c in fig 1 the release of hydraulic jumps generates large amplitude non linear nonhydrostatic internal solitary waves isw trains denoted d in fig 1 farmer and armi 1988 as the barotropic tide is constrained by the bathymetry large vertical velocities appear and induce energy transfer to several normal modes of internal waves some observations in the strait of gibraltar identify the largest isw amplitude to the first baroclinic mode for which vertical velocities have the same direction throughout the water column and all isopycnal surface displacements are in phase the signature of mode 2 waves the vertical velocity profile exhibits one node has also been observed in the region of gibraltar strait farmer and armi 1988 vázquez et al 2006 the internal waves propagate at the interface of mediterranean and atlantic waters as the strait flow varies at various timescales during the year some deviation is expected in the occurrence of the hydraulic control in the strait this may have a wide impact since local flow conditions combined with the above two conservation equations 1 and 2 determine the relation between the volume fluxes the evaporation minus precipitation budget e p and the salinity difference s a s m bryden and kinder 1991 practically an overmixed solution corresponds to a minimal salinity difference and a maximal exchange of water mass in the strait it would thus constrict the formation of mediterranean waters and diapycnal mixing over the mediterranean basin bryden and stommel 1984 garrett et al 1990 moreover the small scale processes occurring in the strait itself can directly modify the local characteristics of mediterranean waters garcía lafuente et al 2011 naranjo et al 2015 and atlantic waters millot 2014 this can affect their characteristics as they enter respectively in the north atlantic sub basin and in the mediterranean sea to study the flow dynamics in the strait in further details more realistic numerical modelling is of great help early attempts used two layer models brandt et al 1996 izquierdo et al 2001 the increase of computational power led to 3d modelling sannino et al 2004 with increasing vertical and horizontal resolution explicitly addressing the tidal cycle and flow characteristics more recently even nonhydrostatic models have been used sánchez garrido et al 2011 sannino et al 2014 to explicitly represent the isw other configurations include the strait of gibraltar into a mediterranean circulation model soto navarro et al 2015 in this case the increased resolution locally in the strait naranjo et al 2014 or the nesting of high resolution grids within a coarse resolved regional model sannino et al 2009a shows a clear impact on mediterranean stratification and improves the representation of convective events in the northwestern mediterranean basin the coastal and regional ocean modelling community model croco 1 1 http www croco ocean org is based on a new nonhydrostatic and non boussinesq solver auclair et al 2018 developed within the former roms kernel shchepetkin and mcwilliams 2005 for an optimal accuracy and cost efficiency croco opens up new perspectives in terms of modelling of small scale processes fox kemper et al 2019 lemarié et al 2019 in this sense the present study objectives are also numerical we show that a new generation of nonhydrostatic ocean models can be used efficiently to simulate complex nonlinear fine scale physics in a realistic but computationally affordable configuration the complete solution of navier stokes equations is thus solved numerically for the very first time in a complex realistic regional configuration the present configuration of the strait of gibraltar is based on a classical lock exchange initialization sannino et al 2002 a 2d vertical section of the strait is adopted in order to reduce the number of parameters impacting the studied dynamics this rather simple configuration is thus of weak computational cost and reduces the implementation burden it allows to reach the horizontal and vertical scales of the largest turbulent structures observed in this area in the strait where most transverse dynamical feature are an order of magnitude weaker our numerical approach is some kind of ersatz of a large eddy simulation les 2 2 les large eddy simulation les as opposed to dns direct numerical simulation does not cope with the full 3d kolmogorov energy cascade down to molecular scales however at least the onset of this cascade the largest turbulent structures is explicitly represented unlike in rans reynolds averaged navier stokes for which at least the generation process of primary instabilities is correctly represented however les is a 3d concept as the route to molecular dissipation differs in 2d and 3d turbulence the present study is focused on the description of the largest primary instabilities in the strait of gibraltar as well as providing order of magnitudes for explicit simulations of these dynamics along with these physical aims the relevance of the chosen numerical methods is a major concern a quantified impact of the largest turbulent structures on the water masses is out of the scope of what is presented hereafter it would require a fully three dimensional les also achievable with the croco model in complement with dedicated relevant experimental measurements in section 2 we present an overview of croco equations and the implementation for the 2d lock exchange experiment we describe the implementation of the bathymetry profile water masses and the exchange and tidal flows in section 3 we analyse the physics of the 2d configuration comparing the model solution to already published data e g in farmer and armi 1988 emphasis is then made on the hydraulic control section 3 2 the hydraulic jump section 3 3 and the mode 1 and mode 2 isw non linear internal trains of solitary waves propagation section 3 4 last the sensitivity to the tidal forcing amplitude and to the numerical choices are analysed respectively in sections 4 1 and 4 2 with a focus on the fine scales dynamics listed in fig 1 2 model description and configuration 2 1 the numerical modelling system the proposed numerical model of the strait of gibraltar simulates explicitly the fine scale processes from tens to hundreds of metres discussed previously this assumes that i a sufficient grid resolution is provided in the strait and ii a well suited numerical kernel is used the nonhydrostatic non boussinesq croco version is chosen for its ability to allow the explicit representation of primary instabilities that cascade the kinetic energy injected at large scale down to the smaller scales this direct transfer ends at the finest scale resolved the subgrid dissipation of energy is performed both by the implicit mixing of the advection schemes and the explicit closure schemes the dissipation is solely performed by quasi monotonic numerical advection schemes grinstein et al 2007 when no parametrized turbulent closure scheme accounts for the subgrid scale mixing croco is an extension of roms from which it inherited the robustness and efficiency of its time splitting implementation the accuracy of high order methods including its pressure gradient scheme for terrain following coordinates and computing performances shchepetkin and mcwilliams 2005 debreu et al 2012 soufflet et al 2016 in croco s time splitting algorithm the slow mode is similar to roms internal baroclinic mode shchepetkin and mcwilliams 2005 its fast mode includes the usual external barotropic mode and a new pseudo acoustic mode that allows computation of the nonhydrostatic pressure within a non boussinesq formalism auclair et al 2018 a two level time splitting kernel is thus conserved in croco as opposed to the first implementation of the 3 level time splitting by auclair et al 2018 but the fast time step integrates a 3d compressible flow furthermore the slow internal mode is enhanced by a prognostic equation of the vertical velocity replacing the hydrostatic equation 2 2 continuous free surface compressible equations the full set of navier stokes equations for a free surface ocean is explicitly integrated including the continuity and momentum equations the surface kinematic relation the heat salt and state equations in cartesian coordinates 3 t ρ ρ v 4 t ρ v ρ v v 2 ρ ω v p ρ g μ δ v λ v 5 t ζ w z ζ v z ζ ζ 6 t ρ θ ρ θ v κ θ δ θ 7 t ρ s ρ s v κ s δ s 8 ρ ϱ θ s p where v u v w is the velocity p the total pressure ζ the free surface anomaly ρ the density θ and s the potential temperature and salinity respectively ω is the instantaneous earth rotation vector g is the acceleration of gravity and μ λ κ θ and κ s are respectively the dynamical and second bulk viscosity and the thermal and salinity diffusivities ϱ θ s p is a linear approximation of the seawater equation of state 2 3 density and pressure decomposition as part of the time splitting the density is split into one slow and one fast component based on a first order decomposition with respect to the total pressure in the following s and f subscripts refer to these slow and fast components respectively 9 ρ ρ s θ s p ρ p θ s δ p δ ρ ρ f o δ p 2 10 p p a t m z ζ ρ s ρ 0 g d z s l o w m o d e ρ 0 g ζ z δ p p f f a s t m o d e no further decomposition is required for the other variables note that δ p is the nonhydrostatic pressure 2 4 slow vs fast components navier stokes equations are integrated with two different time steps in a time splitting algorithm the slow mode is identical to roms whereas the fast mode is now 3d and includes the integration of the compressible terms of the momentum and continuity equations the free surface anomaly is computed through the surface kinematic condition t ρ f t ρ s ρ v 11 t ρ v ρ v v 2 ρ ω v z ζ f ρ s ρ 0 g d z μ δ v λ s ρ 0 g ζ f p ρ g λ v λ f t ζ f w f z ζ v f z ζ ζ f t ρ θ s θ s ρ θ s v κ θ δ θ s t ρ s s σ s ρ s s v κ s δ s s ρ s ϱ θ s s s ζ f ρ f c s 2 p f the momentum equations are integrated both in the slow and fast modes but the right hand side of the equation is split in two parts a slow part λ s made of slowly varying terms advection coriolis force baroclinic pressure force and viscous dissipation and a fast part λ f made of fast varying terms the surface induced and compressible pressure force the weight and dissipation associated with bulk viscosity this momentum equation is numerically integrated twice once with a large time step keeping λ f constant and once with a smaller time step keeping λ s constant this time splitting is much more computationally efficient than integrating the whole set of equations at the same short time step the general compressible equations set 11 can basically propagate three types of waves internal and external gravity waves and acoustic waves propagating at c s the speed of sound the nonhydrostatic pressure anomaly is not a solution of a diagnostic elliptic poisson like equation as it is for a boussinesq equations set the pressure anomalies travel at the acoustic waves velocity the acoustic solver is not global anymore as it is in the poisson like set it is now local in space meaning that no 3d global linear system of equations needs to be inverted anymore the price of solving fast acoustic waves is however enhanced due to a more restrictive cfl conditions both acoustic and surface waves are integrated in croco s fast mode with a smaller time step to cope with this as a linear set of simplified compressible equations needs to be integrated in this fast mode the whole computations remain affordable in addition since the sound speed is at least one order of magnitude larger than the phase velocity of the fastest propagating waves and much larger than any ocean advection velocity it can be artificially reduced the only requirement is that the speed of sound remains larger than any other propagating wave or flow velocity in the domain in particular it must remain larger than the phase velocity of long surface waves so that nonhydrostatic anomalies can be propagated vertically fast enough to set up the corresponding wave structure over the water column sensitivity tests show that in this case a slower sound speed has no impact on lower frequency dynamics in the region of the strait more details on that point can be found in auclair et al 2018 2 5 bathymetry fig 2 a presents the 500 m resolution bathymetry gathered in the framework of the homonim project coordinated by the french navy shom and meteofrance and as provided by the french navy biscara et al 2016 the main bathymetric features as well as the localization of the studied 2d vertical section are exhibited this section is chosen as close as possible to the transect of farmer and armi s gibraltar experiment performed in april 1986 farmer and armi 1988 and coincides in the western area with the mediterranean waters privileged path hereafter u is the velocity in the longitudinal direction of the section and v the velocity in the transverse direction fig 2 b presents the gibraltar strait width according to different reference depths this plot shows that an averaged thirteen kilometre width can be used featuring steep slopes at the lateral boundaries of the strait especially in tarifa narrows simulations are performed with 50 m and 220 m horizontal resolutions the bathymetry used in the simulations is averaged laterally to limit the unrealistic effect of local seamounts in the transverse direction such as those found in tn which can end up acting as another sill in a 2d vertical section to that end a gaussian interpolation of the bathymetry along the section in fig 2 a is used with a greater gaussian radius in the transverse direction than in the longitudinal direction the gaussian radius in the transverse direction is set to 1500 m i e lower than the width of the strait in fig 2 b as a consequence the bathymetry only reflects the deepest areas in the canal in the longitudinal direction the gaussian interpolation radius is set to 300 m to preserve the bathymetry variability in this direction the minimum depth thus assessed at camarinal sill i e the main sill in the strait along the transect s path goes from the value of approximately 200 m to 245 m the model bathymetry used is the one shown in fig 1 a reference simulation hereafter named simref is carried out at 50 m horizontal resolution with additional characteristics and parameters listed in 1 2 6 initial water masses tidal forcing and boundary conditions the temperature and salinity reference profiles are chosen to initialize the density field of the simulations a minimum of two profiles for each of those variables is needed to initialize gradients associated with sloping isopycnal surfaces in a given direction according to sannino et al 2002 a lock exchange initialization is performed with homogeneous atlantic water initially to the west of the cs and homogeneous mediterranean water to the east a three day spin up described in section 2 7 is then performed to set up the exchange flow in the strait the initial temperature and salinity profiles are presented in fig 3 the contrast in salinity between atlantic and mediterranean waters is noticeable with respective mean values of 35 9 and 38 2 in the following the interface between atlantic and mediterranean layers is taken as the 37 isohaline following bryden et al 1994 density is now expressed as an anomaly written ρ relative to a reference mean density ρ 0 from now on the implicit reference density unless contraindicated will be ρ 0 1033 7 kg m 3 a value reached in the pycnocline separating the two water masses an idealized m2 tidal forcing of period t 12 4 h is prescribed at the open boundaries after the spin up period at t 3 days 5 8 t it is introduced thanks to a barotropic current of amplitude 0 4 m s at the western boundary 0 8 m s at cs corresponding to a moderate regime according to the tpxo 8 tidal atlas egbert and erofeeva 2002 lateral forcing is introduced at the open eastern and western boundaries through mixed active passive radiation conditions marchesiello et al 2001 cyclic conditions are imposed to the northern and southern open boundaries 2 7 initial flow and effect of coriolis force the gibraltar strait lateral boundaries are distant of about 15 km with a clear funnelling effect from the cs to the eastern end of the strait 5 4 w see fig 2 b the internal rossby radius r appendix a is usually found to vary from 10 to 20 km bormans and garrett 1989 candela et al 1990 vlasenko et al 2009 the width of the strait and the rossby radius r being of the same order of magnitude rotational effects can be neglected as a rather good approximation therefore the momentum balance is mainly between the acceleration and the pressure force in eq 4 and the geostrophic adjustment in the along strait direction is locally neglected in their observations farmer and armi 1988 and the 3d modelling configurations sannino et al 2002 the consequence of earth s rotation is a cross strait shear of along strait velocity bormans and garrett 1989 and a tilt of the isopycnals along the southern boundary i e along the moroccan coast the interfacial isopycnal is deeper and the flow reaches larger velocities as the transverse flow the coastal boundaries and the resulting funnelling effect cannot be simulated in a 2d vertical section it is necessary to examine whether completely ignoring rotational effects is viable in a 2d vertical approximation to that end three different numerical simulations of the stratification and the mean circulation are compared i one simulation with the coriolis force activated from start to end simallcor f 8 5 1 0 5 s 1 ii the second one without the coriolis force simnocor f 0 and iii the last one with the coriolis force activated only after a three days spin up period simref apart from the coriolis parameter all the three simulations were performed with the characteristics given in table 1 for simref during the very first hours of simulation time the lock exchange dam separating the atlantic and mediterranean water masses disappears a gravity current is generated with dense mediterranean waters flowing down the western slope of cs and light atlantic water spreading in the surface layer east of the sill fig 4 presents the field of the longitudinal velocity u as well as some isopycnals for simallcor a and simnocor b at t 72 h i e the end of the spinup period the bold isopycnal surface ρ 0 7 kg m 3 corresponds at that time to the 37psu isohaline fig 4 a b also present the transverse velocity v isotachs 0 5 m s fig 4 c d show the tidal residual components u and v in the water column at the two dashed vertical lines in fig 4 a b these locations correspond to the moorings indicated in figure 1 of candela et al 1990 using the 37psu isohaline as a frontier between the two water masses the 3t time averaged transport through the left dashed line at the cs is given in the columns labelled transport of table 2 in simnocor fig 4 b a clear vertical shear of the along section velocity can be seen between the two water masses the shear is still featured in the 3t averaged current profiles of fig 4 c and is for station m2 in accordance with the observations given by the moorings at the cs this shear has decreased since initialization as progressive mixing of the two water masses reduces the baroclinicity the currents in simallcor and simref are weaker with locally negative currents in the upper layer see fig 4 c this is confirmed by the layer averaged transports presented in table 2 where values in simallcor and simref are one order of magnitude smaller than in simnocor using an average strait s width of 13 km an approximate baroclinic transport for the strait can be estimated from the values in table 2 for simnocor it would be of 0 6 sv it is slightly weaker than the range of 0 7 1 sv estimated from various field observations see a review in sammartino et al 2015 in simallcor and simref the cross section velocity is due to the inclusion of the coriolis force more precisely during the spin up phase of simallcor the effect of rotation can no more be neglected after 6 h at that time the upper atlantic layer has spread over a distance of about 26 km and the cross section velocity featured in fig 4 a is already significant with no coastal boundaries to hinder the geostrophic adjustment within the strait the initially longitudinal gravity current is almost completely converted into transverse geostrophic current with spurious non physical consequences on the slope of the isopycnals geostrophy enables a thermal wind balance for the transverse v component 12 v z g ρ 0 f ρ x this is particularly apparent to the east of the cs in fig 4 a where the pycnocline is located at the transition between positive and negative transverse velocities as a consequence the pycnocline slope is δ z δ x 6 1 0 3 table 2 and the atlantic water cannot spread further than the resulting surface front in simref the coriolis force is introduced only after a 72 h spin up period leading to the state presented in fig 4 b in this case the resulting slope and transverse velocity are smaller than in simallcor the pycnocline in the eastern part of the domain is deeper whereas it is shallower in the western part however longitudinal currents remain weak in contrast in simnocor the thermal wind balance is not allowed and away from the sills δ z δ x vanishes in the longitudinal direction the main balance is between the pressure force 1 ρ 0 p x and the acceleration term in this case the shear of the longitudinal velocity is better represented at the two moorings the larger transports in both layers indicate that a larger amount of mediterranean water enters the tangier basin than in simallcor this is confirmed by the stratification fig 4 a and table 2 since the pycnocline is shallower over the espartel sill and deeper within the tn a perfect balance between the transports in the upper and lower layers is not achieved in any of these three numerical experiments while there is no numerical challenge in achieving longer simulation the fluxes of mediterranean and atlantic waters are not realistically specified to re stratify properly the water column in these academic configurations after the spin up period the intense tidal mixing and other dissipative processes may end up homogenizing the initial water masses the gap between the transports in the upper and lower layers disappears as the depth averaged absolute transports decrease this process is faster in simnocor than in the other configurations in which the thermal wind balance maintains the isopycnal slopes in this case the depth of the 37 psu isohaline taken as a moving average over one tidal period at x 5 4 w increases from 130 to 175 m in simnocor over three tidal periods not shown this impacts the large amplitude internal waves propagation the difficulty to obtain both realistic ambient stratification and circulation is a limitation of the restriction to a 2d vertical section of the dynamical problem targeted in the proposed implementation an initial state is obtained by lock exchange with a spin up period of 72 h dedicated to the adjustment of the gravity current produced by the dam break for the remainder of this paper the reference simulation simref is chosen as the simulation whose adjustment is made in a non rotating framework this initial state has a correct mean exchange but it is weakened as the tidal forcing is introduced and changes the stratification conditions to mitigate this problem the rotation is restored at the end of the spin up period the geostrophic balance that ensues stabilizes the slopes of isopycnals by generating a transverse current the mean exchange is nevertheless reduced but the stratification i e both the slope of the isopycnals and the vertical density gradient thus saved is crucial to the generation and propagation of the large amplitude solitary waves furthermore the small scale processes discussed hereafter take place during the tidal cycle at this time scale the barotropic exchange is dominated by the tidal currents so that in the reference simulation the amplitude of the baroclinic exchange is correct note that if rotation is activated from the beginning of the spin up period simallcor it leads to unrealistically large slopes of the isopycnals see table 2 3 the reference simulation the reference simulation presented previously is now evaluated thanks to the observational data from the gibraltar experiment farmer and armi 1988 we describe the hydraulic controls the primary instabilities and the dynamics of the isw in this reference simulation 3 1 comparison with in situ observations in the present section observations from the gibraltar experiment farmer and armi 1988 are investigated in order to evaluate the quality of the model solution obtained with the reference configuration simref table 2 presents the pycnocline depth and slope at different locations along the section for the three configurations and the observational data the depth and slope for simallcor and simnocor are calculated after 72 h of simulation and correspond to the isopycnal surface ρ 0 7 kg m 3 in fig 4 a b whereas for configuration simref the same isopycnal taken in a 3t averaged stratification corresponding to fig 5 in simallcor the isopycnals have a greater slope than the reported observations from gibraltar experiment 0 006 vs 0 003 in simnocor there is no slope away from the sills while as discussed before the slope obtained in simref is small the stratification in simref is close to that of simnocor in the eastern part with an isopycnal close to the horizontal in the western part and over the cs the pycnocline is shallower than in the other two simulations table 2 in the following we further investigate small scale dynamical processes such as hydraulic jump and isw propagation in configuration simref this is also the baseline configuration used to perform all sensitivity tests presented hereafter 3 2 tidal currents hydraulic control in the present study the froude number f is simply defined at each grid point as the ratio between the local longitudinal velocity u and the theoretical speed c 1 of the first internal wave mode computed with the modal decomposition for each point of the x axis see appendix b for details for single layer flows hydraulic control occurs in the region of transition between subcritical and supercritical flows in this region the condition f 1 is met over the whole water column for multi layer flows the froude number condition may be satisfied in a few layers only in this case the layers where the flow becomes supercritical are considered as hydraulically controlled three areas of potential hydraulic control in gibraltar strait are identified from previous studies the cs the es and the narrowest part of the tn near 5 5 w longitude in fig 2 farmer and armi 1988 found persistent controls for first internal wave mode at the es the cs and the tn sannino et al 2009b found only ephemeral appearances of such controls except at the es where it is permanent the discrepancy is likely lying in the definition and the estimation of the composite froude number fig 5 shows the regions where the flow is critical closed contours indicate the locations of critical froude number f 1 inside which the flow is supercritical the longitudinal velocity fields u used to estimate f are taken at maximum outflow grey at t 7 5 t and maximum inflow black at t 8 t the internal waves phase speed c 1 is computed from the 3t time averaged stratification represented in fig 5 no control of the first mode is ever seen in tn this is a consequence of the 2d simplification which excludes the representation of the tidal flow intensification by the narrowing of the strait at tn on the other hand hydraulic control is expected at both sills the location where it should occur alternates between the eastern during ebb and western during flood sides of the sills with a return to subcritical flow when tidal current slackens the froude number easily goes beyond 2 in the mediterranean outflow at cs where the flow is supercritical through most of the water column except sometime at the surface at es the lower layer may become supercritical with froude number that never exceeds 1 5 the lack of persistent control at es may be a consequence of the crudely imposed stratification 3 3 primary instabilities in the hydraulic jump area one manifestation of the hydraulic control is the formation of hydraulic jumps in specific regions where the flow transitions from supercritical to subcritical this is a complex area with steep slopes and high shears where flow topography interaction can generate small scale coherent structures the largest ones are resolved in simref and are characterized here with various methods first the okubo weiss parameter appendix c is computed to investigate the presence of new coherent structures in the hydraulic jump area their dynamics are further investigated using empirical orthogonal functions eofs computed with a singular value decomposition svd their typical length and velocity scales are finally compared with the expected analytical values of shear instabilities and lee waves the dynamics of the cs hydraulic jump are illustrated in fig 6 in which the density field fig 6 a and the vertical velocity field fig 6 b over the western slope of the cs are represented during flood several flow parameters were also computed and are depicted in fig 6 a and b these parameters are 1 the froude number defined in appendix b the contours of critical froude number f 1 are shown in fig 6 b inside which the flow is supercritical 2 the richardson gradient number defined as r i n 2 u z 2 with n the brunt väisälä frequency defined in eq 13 contours of r i 0 25 are depicted in fig 6 a as r i 0 25 is a required condition for the development of shear instabilities 13 n g ρ 0 ρ z 3 the okubo weiss parameter defined in appendix c negative values of ow indicate vortical circulation and so contours of o w 4 1 0 4 s 2 are shown in both fig 6 a and b in fig 6 b the supercritical flow region f 1 follows the slope of the sill where the velocity in the mediterranean outflow is larger than 2 m s see the contour f 1 running approximately parallel to isopycnals between 5 76 w and 5 77 w at 5 77 w the density field in fig 6 a shows a sharp transition e g isopycnal ρ 0 5 kg m 3 rises from 350 to 225 m depth and forms a wedge shaped region over the supercritical mediterranean outflow this is the signature of an internal hydraulic jump downstream of the hydraulic jump several small scale structures are visible fig 6 a shows patches of lighter water billows associated with areas of negative ow values at a depth of 400 m and large amplitude disturbances of isopycnals at 150 m negative ow values are also located at troughs and can reach o w 4 1 0 4 s 2 both types of structures are propagating westward and are quite probably shed from the internal hydraulic jump at the tip of the wedge shaped region at 5 773 w with the size of billows growing rapidly as they travel down slope in the potential generation area richardson number values are less than 0 25 indicating favourable conditions for generation of primary shear instabilities further identification of the simulated new features of fig 6 is achieved by proceeding with a complex singular value decomposition svd pairaud and auclair 2005 of the velocity field w i u in the water column between 5 795 w and 5 78 w longitude during outflow conditions this region is highlighted in fig 7 a in which the time mean field of longitudinal velocity u is presented showing the intense outflow below layers of lesser velocities the mean density field and location of r i 0 25 are also indicated the former showing a homogeneous area between 50 150 m above the seafloor the svd gives a first singular vector responsible for 28 of the total variance corresponding to the evolution of the barotropic forcing not shown the remaining singular eigenvectors have lesser corresponding variance and show smaller structures with high frequency variations in the singular right eigenvector two consecutive singular vectors often have very close eigenvalues and temporal variations fig 7 b shows the reconstructed field of the combination of the second and third singular vectors respectively responsible for 13 and 11 of total variance added to the mean field shown in fig 7 a the okubo weiss parameter is again computed for the resulting velocity field which shows two rows of y axis vortices centred at z 300 m anti clockwise and 400 m clockwise the upper row of vortices appears to generate the observed interface oscillations based on ow 0 contours the lower clockwise vortices have an estimated horizontal scale of 200 m and a vertical scale of 150 m corresponding to horizontal and vertical wavenumbers 3 10 2 and 4 10 2 m 1 respectively their propagation speed can be estimated as 0 7 m s by following the centre of the billows defined by areas of negative ow values the distance between the centres of two consecutive vortices is l 530 m the centres of the upper anti clockwise and lower clockwise vortices are shifted along flow by l 2 so that the extrema of their respective vertical velocities are aligned vertically it seems that a transfer of momentum occurs between the two rows of vortices in a way reminiscent of the vallis model of edge waves in a stratified region of a shear flow pp 254 258 in vallis 2006 the length scales deduced from this svd analysis can now be compared with expected scales from simple analytical models for shear instabilities and internal waves based on the general characteristics of the flow on the western slope of camarinal shear flow instability in a two layer system of infinite depth results in a mixed interface of vertical extent δ h expressed by equation 14 6 of cushman roisin and beckers 2011 14 δ h 1 k m i n ρ 0 u 1 u 2 2 2 ρ 2 ρ 1 g with k m i n the wave number of the most unstable mode in this system taken as the scale of the primary instability that will develop in the generation area of cs u 1 u 2 is in the range of 1 2 to 2 m s and ρ 2 ρ 1 is in the range of 1 2 to 1 7 kg m 3 additional values are ρ 0 1033 7 kg m 3 and g 9 81 m 2 s this gives a range of vertical scales between 44 m and 183 m and k m i n between 2 10 2 m 1 and 5 10 3 m 1 the scales of the simulated lower row of vortices are in the upper part of this range lee waves are another candidate for small scale transient flow and the interfacial oscillations observed in our solutions their generation over topography is expected when tidal excursion is larger that the topographic length scale 1 k b i e k b u 0 ω 1 st laurent and garrett 2002 the slopes of camarinal sill are not symmetrical as can be seen for example in fig 4 on the western side of the sill the depth increases from 250 m at 5 76 w to 510 m at 5 78 w over only 1 8 km whereas on the eastern side it increases from 250 m to 620 m at 5 65 w over 9 4 km k b is thus chosen in a range between 3 1 0 3 m 1 and 6 1 0 4 m 1 u 0 0 4 m s is the amplitude of the barotropic tidal current away from the sill in these conditions the ratio k b u 0 ω ranges between 1 7 over the west slope and 8 9 over the east slope based on this we cannot rule out the possibility that lee waves are generated over the cs if the simulated small scale structures would originate from lee waves their phase speed would be comparable to a mode 1 internal gravity waves this can be estimated using the same method as in appendix b for the average stratification presented in fig 7 a it yields a value of 1 4 m s in the area down flow of the hydraulic jump which is twice the estimated propagation speed of both rows of simulated structures therefore even though lee wave generation is theoretically possible the interfacial oscillations observed in the simulation appear more consistent with the stirring effect of the bottom coherent vortices whose scales fall within the range of expected values for kh instability we conclude that coherent structures are clearly identified in our simulations they are generated in an area of potentially unstable shear r i 0 25 and are associated with billows of lighter mixed fluid the deeper row of vortices can reasonably be interpreted as kelvin helmholtz primary instabilities their downstream behaviour further corresponds to a 2d pairing of two consecutive kelvin helmholtz billows these billows are advected in a region of westward flow between the mediterranean vein and atlantic waters up until 5 8 w at this location advection is reduced as the lower layer decelerates and the billows are uplifted in a flow recirculation and mixed in the pycnocline these small scale features appear in the simulation for as long as the hydraulic jump is present injecting water from the pycnocline in the outflow and vigorously mixing the atlantic and mediterranean waters until the tidal currents weaken sufficiently for the flow to become subcritical however the dynamics simulated in a 2d vertical section with no transverse flow and no transverse instability may differ from the real ocean in a fully 3d configuration primary kelvin helmholtz instabilities should decay faster as secondary kelvin helmholtz instabilities develop along the transverse rotation axis of the primary billows this is precluded in the present 2d configuration even with enhanced resolution as only y axis billows can occur wesson and gregg 1994 observed billow structures in the area of cs with an extension of several tens of metres this length scale is much smaller than the one simulated in the present numerical configuration however these observations were made in shallower regions i e probably closer to the generation area larger billows more in line with those simulated in the present study could thus develop downstream further observations on site are needed although short length scales and fast propagation speed would require adapted measurement strategies 3 4 internal tide dynamics in simref two main types of large amplitude wave propagating eastward can be observed both of them are generated at cs while tidal currents reverse from westward to eastward this is illustrated in fig 8 a b first a mode 1 wave appears as a bore over the sill s crest approximately 2 25 h after the westward flow peaks in fig 8 a it has propagated over the eastern slope of the sill s crest and is now at 5 7 w longitude the corresponding profile in fig 8 c has only one maximum as expected for a mode 1 internal wave this wave rapidly steepens while a hydraulic control is maintained on the western side of the sill with lower values of the froude number one hour and 15 min later the flow becomes subcritical and a large amplitude mode 2 wave crosses the sill in fig 8 b this new wave is propagating over the eastern slope of the sill its vertical velocity profile is presented in fig 8 c it exhibits two maxima of opposite signs and a zero crossing at the pycnocline s depth as expected for a mode 2 internal wave additionally it can be seen in this figure that the bore like wave has evolved into a train of internal solitary waves whose propagation is discussed below the propagation of internal waves can be characterized by plotting a space time evolution of a particular isopycnal in fig 9 b the depth evolution of the 0 7 kg m 3 isopycnal is represented also in a white contour in fig 8 regions of sharp horizontal density gradients can be identified periodically in the region of the cs next to 5 76 w longitude they correspond to the generation of hydraulic jumps the propagation of internal waves are identified by the tilt of isolines whose slopes provide an estimate of wave propagation speed there are differences from one tidal cycle to the next because mixing progressively changes the background stratification in the domain in the following we focus on the tidal cycle t 7 5 t 8 5 t second cycle after the end of the spin up phase for which the three tidal cycle averaged velocity shear and stratification are shown in figs 4 and 5 the mode 1 bore of fig 8 a propagates down slope of the cs into the tn where it experiences a transition into a train of solitary waves moving at a speed of 1 5 m s in fig 9 c such a train made of four mode 1 waves can be seen at 5 5 w longitude the amplitude of the first wave reaches 100 m the solitons train amplitude momentarily increases and exceeds 150 m as it propagates over the slope near 5 5 w longitude in the tn still during ebb tide from then on the wave amplitude decreases as it propagates towards the deeper region meanwhile the dispersion increases the number of waves as well as their wavelength as noticed in the space time diagram which shows the envelop of the train of solitons expanding while it propagates eastward the dispersion as simulated in croco is compared with the korteweg devries model in appendix d similarly the mode 2 wave shown in fig 8 b propagates through the shallowest part of the tn at a speed of 0 9 m s as a new hydraulic jump is being generated over the eastern slope of cs it is located at 5 65 w longitude in fig 9 c with an amplitude of approximately 100 m the propagation speed of this mode 2 internal wave subsequently decreases when it reaches the deepest part of the domain while simultaneously the tidal phase shifts to flood the amplitude of these waves is simultaneously strongly reduced the signatures of other large amplitude internal waves can be seen propagating to the west of the cs in fig 9 b they are mode 1 and mode 2 internal waves with amplitude in the tens of metres i e smaller than the eastward propagating wave they are generated when tidal currents switch from eastward to westward in the same fashion as previously described for the wave train produced east of the cs as tidal currents reverse from westward to eastward as discussed in section 3 2 a hydraulic control also occurs at the es fig 9 b shows the same variations of isopycnal depth in this area as near the cs during the tidal cycle t 7 5 t 8 5 t but not on the following cycle anymore in the latter case the computed froude number does not exceed 0 7 as opposed to previous cycles t 6 5 t 7 5 t and t 7 5 t 8 5 t or later ones t 9 5 t 10 5 t and t 10 5 t 11 5 t in these cases the variations are similar and hydraulic control occurs at es the sequence is as in cs with a hydraulic control briefly lost at the barotropic flow reversal then internal mode 1 waves of 50 m amplitude at a depth of 300 m are released and propagate toward the cs in fig 9 c a mode 1 wave can be found at 5 87 w these waves dissipate in the area near the sill as the absolute value of the barotropic current decreases in fig 9 c two vertical lines are drawn in the tn they refer to measurements made by farmer and armi 1988 the lines indicate the first two baroclinic modes locations three and a half hours after high tide the right hand vertical line corresponds to a mode 1 wave and is in agreement with the simulation however in simref the distance between the two modes is twice as large as in the observations based on observed wave arrivals at various stations farmer and armi 1988 estimated the propagation speed of both mode 1 and mode 2 waves at about 1 to 2 5 m s for mode 1 and 1 to 1 5 m s for mode 2 the wave train they observed contained two to three large amplitude waves the first one having an amplitude of 100 m additional observations by garrido et al 2008 in the tn region give a propagation speed for mode 1 waves ranging in 1 2 m s and 2 m s with a large variation in the velocity of two consecutive wave trains due to the weight of the tidal diurnal inequality k1 and o1 the mode 1 dynamics simulated in simref are consistent with these observations reported by farmer and armi 1988 in terms of propagation speed and longitudinal position however the simulated mode 2 wave seems too slow and its amplitude too large its slower propagation might be due to an underestimation of the barotropic flow that carries the mode 2 within the tn as our 2d vertical approach does not catch well the tunnelling effects of this narrowing this would not affect the mode 1 wave as much because its linear propagation speed is more intense and the barotropic current advection becomes comparatively small the brief hydraulic control loss observed when the tidal currents reverse does not reflect the quasi permanent control thought to be taking place at es in this case no internal waves packet can be emitted from the es 4 sensitivity testing the reference configuration presented in the previous section is based on several physical and numerical choices which are now investigated mostly the impact of the forcing amplitude momentum balance hydrostatic approximation and numerical parameters spatial resolution advection schemes 4 1 tidal regime an additional simulation sims is first performed similarly to simref changing only the tidal forcing amplitude the imposed tidal current amplitude at the western boundary is now increased up to 0 6 m s so that it reaches 1 3 m s over the cs this corresponds to a spring tide regime fig 10 presents a comparison between sims and simref in fig 10 a the contours of supercritical regions f 1 show the cs hydraulic jump extends further east in sims as a result a mode 1 disturbance denoted a in fig 10 a is trapped at 5 725 w longitude it propagates eastward when the flow becomes subcritical but the faster bore that is crossing the cs can rapidly catch it up the outflowing mediterranean water vein on the westward side of the sill is also thicker in sims and so is the supercritical area in addition a new supercritical region appears on the western slope of a secondary relief at 5 83 w longitude denoted b in fig 10 a with trailing lee waves fig 10 b shows an eastward propagating mode 1 solitons packet since the initial stratifications are similar linear phase velocities are the same in simref and sims at the beginning the amplitude of the first trough of the train is 50 m larger in sims than in simref this should result in increased propagation speed of the solitons in sims in contradiction with a slower propagation seen in fig 10 b it can be explained by the stronger tidal currents advection in the opposite direction in sims a mode 2 wave is also generated in both sims and simref but is only visible in simref in fig 10 b as it quickly dissipates in sims due to stronger tidal currents consistent with our results farmer and armi 1988 show that the isw amplitude increases with the tidal current during the spring tide neap tide cycle in addition two concomitant hydraulic jumps were observed in the strait during spring tide sánchez garrido et al 2011 they exhibit a transverse asymmetry as the second jump only appears in the northern part of the strait this could not be confirmed in the present 2d configuration 4 2 nonhydrostatic balance and numerical factors the consequences of several numerical choices are now investigated by running five additional simulations whose differences with simref are laid out in table 3 in particular the sensitivity to both vertical and horizontal resolution is targeted a hydrostatic kernel and a weno5 z advection scheme for momentum borges et al 2008 are also tested and compared with simref we focus on the impact of these modifications on two types of small scale processes studied in the previous sections the primary kh instability generation in the hydraulic jump at the cs and the eastward propagating solitary waves generated at the same place 4 2 1 hydraulic jump and instabilities hydraulic controls section 3 2 occur in all simulations as revealed by systematic estimations of the froude numbers low richardson numbers 0 25 are also diagnosed for all simulations over at least part of the cs western slope during flood however the features that have been identified as kh instabilities in section 3 3 do not appear in all simulations they are absent in the simulations performed in the hydrostatic framework and or with low horizontal resolution siml simlh and simh weak horizontal vorticity tilting under the hydrostatic assumption prevents such instabilities to develop instead a smooth large recirculation appears west of the cs fig 11 for simlh in the remaining sensitivity experiments simv and simw kh instabilities are generated at the edge of the hydraulic jump and their dynamics is overall similar to the one described in section 3 3 for simref pairing of kh billows can occur whereas anti clockwise vortices induce oscillations of the interface fine resolution a few tens of metres in the present region and non hydrostatic equations are both required to explicitly simulate the turbulent cascade onset with kh instabilities between mediterranean and atlantic flows interestingly enough a comparison of fig 6 nonhydrostatic configuration and 11 hydrostatic configuration shows that the fine scale solution is largely filtered out by the hydrostatic assumption without dedicated observations in the area it remains difficult to conclude that simref is more realistic although low richardson numbers in this region lead us to expect kh instability 4 2 2 large internal waves as described in section 3 4 mode 1 and mode 2 large amplitude internal waves are generated in the cs vicinity and propagate eastward during each ebb in all nonhydrostatic simulations fig 12 presents the density fields in the region of the tn at t 8 1 t a wave train with a minimum of two solitons can only be identified in the nonhydrostatic experiments in the hydrostatic cases simh and simlh the lack of nonhydrostatic dispersion produces internal waves propagating as internal bores in the nonhydrostatic cases these internal waves can propagate as trains of solitons with varying numbers of solitons and celerity 6 in simref 8 in simw 4 in simv and 2 in siml this illustrates a second aspect of the effect of hydrostatic assumptions besides the inhibition of turbulent primary instabilities kh instabilities in the region of the hydraulic jump as already noted by previous authors sannino et al 2004 the dispersion needed to balance nonlinear steepening in large amplitude solitary waves is missing in hydrostatic simulations such as simh and simlh fig 12 4 2 3 evolution of stratification the previous results lead us to anticipate large differences in the way density stratification evolves in simref simw simv simh siml or simlh to go further fig 13 shows for each configuration the profiles of brunt väisälä frequency n defined in eq 13 at 5 8 w a and at 5 55 w b profiles are time averaged over one flood at 5 8 w stratification is similar in simh and simlh with an interface region defined as the region where n is maximal here n 8 10 3 s 1 located at a depth of 250 m fig 13 a the nonhydrostatic simulations simref and siml present an interface region at a similar depth but the vertical gradients are larger in simref and smaller in siml simv shows larger vertical gradients of density n 1 1 10 2 s 1 and a shallower interface at a depth of 150 m simw is weakly stratified over most of the water column with no clear interface between the two water masses this result may seem surprising because the weno5 scheme is of fifth order accuracy with more selective quasi monotonic corrections near shocks than the tvd scheme and is thus expected to produce less smoothing this apparent contradiction can be explained by the generation of more intense primary shear instabilities i e with higher values of associated vertical velocity and vertical velocity gradients which has the effect of diffusing density gradients in fig 13 b averaged n profiles over one flood are shown at 5 55 w longitude in a region subjected to intense internal wave activity simh simlh and siml exhibit similar profiles with n slowly decreasing below the interface at 160 m simref has a similar interface at 160 m but with higher n value although weaker stratification appears at the top of the lower layer simv and simw both have shallower interfaces at 130 m with n reaching the highest values in simv n 1 25 10 2 s 1 as the enhanced vertical resolution allows the representation of stronger gradients clear conclusions cannot yet be drawn concerning mixing kh instabilities are expected in the region of the hydraulic jump and downstream they lead to more stirring and consequently open up new opportunities to improve modelling of the route to mixing further investigation and diagnostics are now required to better understand the energy cascades in particular the present comparison between weno5 and tvd advection schemes and their implicit dissipation indicates that numerical choices may unfortunately still have large consequences therefore the role of physical and numerical closure must be considered comprehensively marchesiello et al 2011 soufflet et al 2016 5 discussion and conclusion the present study focuses on small scale dynamics in the strait of gibraltar and on the capacity of a new split explicit free surface nonhydrostatic regional oceanic model croco to represent such dynamics both objectives were pursued in parallel and several seminal results are obtained the study confirms that the generation of large amplitude mode 1 and mode 2 internal waves in the strait of gibraltar as well as the onset of stratified turbulence and its energy cascade can be simulated with a computationally efficient 2d vertical section the characteristics of the simulated internal waves compare qualitatively well with published observations and previous numerical studies internal tides dynamics and shear instability in the hydraulic jump area are then analysed in more details revealing characteristics and mechanisms the results of the study rely on a new type of nonhydrostatic non boussinesq free surface kernel auclair et al 2018 implemented in the croco model the resulting compressible oceanic model is presented in a realistic nonhydrostatic configuration for the first time sensitivity tests confirm that a nonhydrostatic here non boussinesq kernel is required i to simulate isw trains and ii to explicitly simulate the onset of stratified turbulence energy cascade provided that resolution is increased from about 200 m to 50 m we conclude that resolutions finer than a few hundred metres are required in addition to a refinement of dynamical equations relaxation of hydrostatic assumption in order to solve the dominant dynamical processes in a key region of the mediterranean detailed characteristics of the vertical 2d configuration are also given with particular attention to the bathymetry and to the representation of the coriolis force implicit representation of funnelling effect in the strait the proposed approach offers a computationally affordable way to make preliminary investigations of internal wave dynamics in regions where these waves are important however the vertical 2d configuration is limited by the simplified representation of bathymetry and associated biases in the velocity shear between in flowing atlantic waters and out flowing mediterranean waters the inclusion of restratification processes surface and boundary forcing would allow the model to remain accurate for a greater number of tidal cycles the present configuration is considered accurate within three days after the spin up period before mixing starts to homogenize the water masses several remaining processes could not be considered the transverse propagation of isws in the strait of gibraltar sánchez garrido et al 2011 vlasenko et al 2009 and in the alboran sea the hydraulic control at the tn farmer and armi 1988 sannino et al 2009b the boiling water over the cs bruno et al 2002 or reflections on the strait s coasts only the onset of turbulence cascade could be simulated showing complex dynamics occurring in the area of the hydraulic jump at cs with some small scale features identified as primary kelvin helmholtz instabilities although this 2d study highlights how interesting this area can be there is no doubt that simulation of secondary kh instabilities and subsequent energy cascade as well as the long term impact of these small scale processes on mediterranean and north atlantic circulation will require a fully 3d les approach as well as dedicated field campaigns that explore these fine scale processes credit authorship contribution statement margaux hilt conceptualization software writing original draft writing review editing visualization methodology investigation francis auclair conceptualization software writing review editing funding acquisition supervision rachid benshila software writing review editing lucie bordois software writing review editing methodology xavier capet software writing review editing laurent debreu software writing review editing franck dumas software writing review editing funding acquisition swen jullien software writing review editing florian lemarié software writing review editing patrick marchesiello software writing review editing conceptualization cyril nguyen software writing review editing laurent roblou software writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was partly funded by the dga etude amont protevs driven by the shom it was granted access to the hpc ressources of calmip supercomputing center under the allocation p18017 we also gratefully thank the computer team of the laboratoire d aérologie for its support margaux hilt s ph d thesis was funded by a mesri scholarship appendix a evaluation of the first internal rossby radius the first internal rossby radius is defined as a 1 r g h f at the gibraltar strait s latitude the coriolis parameter is f 8 5 1 0 5 s 1 the numerator c g h is the phase speed of the linear interfacial waves into which the reduced gravity is a 2 g g ρ m s m ρ a s a ρ 0 where ρ m s m ρ a s a 2 kg m 3 if the reference density is set to ρ 0 1033 7 kg m 3 and the gravity acceleration by g 9 81 m 2 s g 0 02 m s 2 which is in agreement with in situ data cf bryden et al 1994 h is a characteristic height given by a 3 h h 1 h 2 h 1 h 2 where h 1 and h 2 are respectively the upper and lower layer thicknesses picking up the data values from farmer and armi 1988 table 2 first line we obtain a range of h 50 100 m which combined with the previous values for g and f leads to r ranging in 11 5 km east of camarinal sill to 16 km west of camarinal sill g h can be replaced by the mode 1 internal waves speed c 1 which is estimated in the present study appendix b for the 3t averaged stratification simref presented in fig 5 c 1 ranges between 0 8 m s at camarinal sill and 1 8 m s in the eastern part of the strait giving an estimated range of rossby radius c 1 f between 9 5 and 21 km for the simulated section appendix b computation of a froude number a single value of mode n linear internal wave phase speed c n can be computed for a flat bottom and a linear stratification this velocity can then be compared at each depth with the magnitude of local horizontal currents u to estimate when and where internal waves can propagate against currents a diagnostic tool is the ratio of velocities i e a froude number f n defined as f n u c n c n ω k n where ω is the wave frequency here the m2 tidal frequency and k n are eigenvalues obtained by solving numerically the sturm liouville problem associated with the linear propagation equation e g ill 1982 b 1 w n k 2 n 2 ω 2 ω 2 f 2 w n 0 with bottom and surface boundary conditions w n 0 0 and w n h 0 w n gives the structures of vertical modes for each point on the x axis the profile n z is computed with eq 13 from the 3t averaged stratification in simref shown in fig 5 the value of the first mode phase speed c 1 x is indicated in the lower panel of fig b 14 and compared to the longitudinal velocity u x z at t 8 5 t plotted in the upper panel the areas where u x z c 1 x equivalent to froude number f 1 larger than 1 are presented in the upper panel as well the flow inside those contours is called supercritical appendix c computation of okubo weiss parameter the okubo weiss parameter ow is defined as c 1 o w s n 2 s s 2 ω 2 with s n the normal strain component s s the shear strain component and ω the vorticity usually it is used in a xy plane e g for tracking eddies in chelton et al 2007 but it is computed here in the zx plane with the strains and vorticity expressed as c 2 s n w z u x s s u z w x ω u z w x negative values of ow indicate a greater role of rotation over deformation and thus the presence of coherent vortices appendix d comparison with korteweg de vries kdv model following many studies garrido et al 2008 sannino et al 2009b vlasenko et al 2009 the large amplitude internal waves of section 3 4 are termed isws for internal solitary waves to confirm that the internal waves observed in this section are isws they are now compared with solutions of the korteweg de vries equation which is recalled below the solutions of this equation satisfy a balance between nonhydrostatic dispersion and nonlinear advection nonlinear advection steepens the wave front whereas nonhydrostatic dispersion reduces steepening by transferring energy from large to small scales resulting in a relatively stable entity called a solitary wave or soliton the korteweg de vries kdv equation describes the evolution of an infinitely thin interface in a two layer system with constant bottom topography d 1 ζ t c ζ x 3 2 h 1 h 2 h 1 h 2 c ζ ζ x a 1 6 h 1 h 2 c 3 ζ x 3 b 3 8 ζ 2 c h 1 2 6 h 1 h 2 h 2 2 8 h 1 h 2 2 c 0 where c is the interfacial speed of small amplitude internal waves c g h r f and ζ is the vertical displacement of the interface g and h have already been defined in a the first two terms on the left hand side of d 1 are those involved in the classical propagation equation for a small amplitude linear interfacial wave travelling in the x direction at speed c the third term bracket a is a first order approximation with respect to amplitude of nonlinear advection term b is a dispersive term the fifth term c is a higher order non linear term associated with a second order development for advection the complete equation d 1 will be referred to as extended kdv or ekdv whereas the same equation without term c will simply be referred to as kdv dossmann 2012 the simulated large amplitude waves presented in this study are compared with the solutions of the kdv or ekdv equation to gain insight into their dynamics for optimal comparison a new simulation called simref was carried out its characteristics are similar to simref table 1 except that i the eastern boundary is shifted 42 km to the east into the mediterranean sea and ii the tidal forcing is stopped after only 7 25 periods the first eastward propagating train of mode 1 waves generated by the tide at the cs is compared with the propagation given by numerical integration of the kdv and ekdv equations d 1 the vertical displacement of isopycnal ρ 0 5 kg m 3 is extracted 3 3 due to the extension of the domain to the east a new value of ρ 0 is computed ρ 0 1033 9 kg m 3 to optimize computations at t 0 7 5 t when the mode 1 isw train propagates over a region of constant depth h 890 m east of tn fig d 15 so as to get closer to the kdv framework the position of the chosen isopycnal surface at this time is shown in fig d 15 a at that time the distance between the first and second solitons of the train is 5 km the first soliton has an amplitude of 75 m and the train includes 7 solitons this isopycnal is chosen as initial state for the kdv or ekdv model the kdv and ekdv equations are integrated either with the interfacial wave speed c 1 27 m s or with mode 1 velocity c 1 1 45 m s see appendix b for details on c 1 evaluation fig d 15 b e compare the interface depth obtained at t t 0 0 25 t in the kdv and ekdv models with the position of the 0 5 kg m 3 isopycnal in simref in the latter the distance between the first two solitons has grown since t t 0 and reaches 7 km with an amplitude of 70 m for the first trough the train is now made of 11 solitons the first three have decreasing amplitudes then two smaller solitons of comparable amplitude 40 m and one soliton of greater amplitude followed by solitons with decreasing amplitude again in the kdv solution obtained with propagation speed c the first solitary wave is slightly slower but its amplitude is markedly larger fig d 15 d the remaining solitons of the train are well located but a secondary trough is generated between the first two solitons whereas it is absent in simref using the larger mode 1 speed c 1 instead of c fig d 15 b the train of solitons in kdv is too fast when the ekdv equation is used with speed c e the solitons are too slow whereas this same extended equation with c 1 c leads to a correct displacement of the solitons overall the temporal evolution of solitary waves in simref is consistent with the solutions of the kdv or ekdv equation d 1 however the kdv or ekdv framework remains an inviscid simplification note that closer evolution of soliton amplitudes between kdv or ekdv and simref solutions can be obtained by simply adding a diffusive term in kdv or ekdv equation this also slows down propagation in kdv and to a lesser extent in ekdv not shown the kdv or ekdv model also involves adjustable parameters such as the linear wave speed which ranges between the interfacial speed c and the mode 1 speed c 1 each being one particular approximation of the wave s behaviour that being said the wave trains in simref are appropriately modelled as kdv or ekdv isws which confirms i the propagation of interfacial troughs as trains of solitons and ii croco s ability to simulate the subtle balance between nonhydrostatic effects responsible for dispersion and nonlinear advection 
23964,a two dimensional vertical section of the strait of gibraltar is simulated numerically with the nonhydrostatic non boussinesq three dimensional croco model to investigate details of small scale dynamics the proposed configuration is simple computationally efficient and incorporates the configuration of sills characteristic of this region despite the shortcomings of a 2d representation this configuration provides a realistic depiction of small scale mechanisms in the strait during a typical tidal cycle internal solitary waves generation and propagation occurrence of hydraulic controls and hydraulic jumps at the sills and presence of active turbulent patches in particular the well known eastward propagation of large amplitude internal waves is assessed using the korteweg de vries kdv propagation model for solitary waves as a step towards establishing a realistic three dimensional large eddy simulation les the sensitivity of the configuration to various choices e g resolution amplitude of tidal forcing or numerical schemes is investigated our analyses indicate that the representation of small scale dynamics in the strait of gibraltar can be much improved by increasing resolution and relaxing the hydrostatic assumption further studies are necessary to grasp the mechanisms of mixing and or stirring induced by this fine scale process keywords strait of gibraltar internal solitary waves nonhydrostatic processes large eddy simulation 1 introduction the strait of gibraltar connects two major basins the northern atlantic and the mediterranean sea over which evaporation exceeds precipitation and river run off to compensate the resulting loss exchanges of mass and salt are required through the strait fig 1 illustrates the rather complex exchanges occurring there inflowing atlantic water is less salty salinity s a 36 than the outflowing mediterranean water s m 38 and spreads as a surface layer in the alboran sea the interface between the two water masses is distorted by undulations that are not precisely periodic with regard to the tidal cycle but exhibit regularity in some areas one of the paper objectives is to better understand the small scale processes that lead to the atlantic and mediterranean water masses transformation in the vicinity of the strait of gibraltar to further illustrate the exchange between the northern atlantic and the mediterranean a very simple steady state model can be expressed as a system of two basic conservation equations volume conservation is expressed as 1 q a q m e p while the conservation of salt requires 2 q a s a q m s m 0 where q a is the atlantic water volume flux positive q m is the mediterranean water volume flux negative both localized in the strait of gibraltar and e p is the space averaged evaporation minus precipitation and river runoff water budget integrated over the whole mediterranean sea e p is positive s a s m stands for atlantic mediterranean water mean salinity and s m s a 2 bethoux 1979 the water budget e p is positive in the mediterranean due to excess evaporation that correspond to a yearly averaged loss of water of about 1 metre over the whole basin garrett et al 1990 a major dynamical feature in the strait of gibraltar is the so called flow criticality usually characterized by the froude number f it compares the internal wave phase speed with a flow characteristic velocity several definitions of the non dimensional froude number can be found in the literature it can notably be defined for each layer resulting in a composite number for the whole water column as in farmer and armi 1988 or in sannino et al 2009b a subcritical respectively supercritical regime lies in the range of small respectively large values of the froude number f 1 respectively f 1 with an intermediate critical regime for f 1 the upstream propagation of internal waves is inhibited for supercritical flow so that a hydraulic control occurs at the transition from subcritical to supercritical flow it persists during periods and within regions of large froude numbers as such the hydraulic regime at a given point will vary in time according to substantial currents variations occurring along the tidal cycle it is for example well established that large amplitude solitary waves in the strait of gibraltar can develop due to the hydraulic control at camarinal sill farmer and armi 1988 making it a crucial process to represent several analytical models have been proposed to investigate the hydraulic control in the gibraltar region bryden and stommel 1984 farmer and armi 1986 garrett et al 1990 the hydraulic control usually occurs in these models at camarinal sill cs espartel sill es and tarifa narrows tn although the modelled hydraulic control location and frequency vary according to the model refinement 1 farmer and armi 1986 s two layer model accounts for the strait geometry depth and width the exchanged volumes q a and q m and the salinity contrast s a s m this simple model is able to simulate two hydraulic controls the first one located by the sill the other in the tn contraction defining maximal exchange regime further details are given below 2 in a slightly more elaborated model the inclusion of entrainment between the two layers and the subsequent interfacial layer introduction modify the left hand terms of eqs 1 and 2 with the introduction of horizontal and vertical transports in the interfacial layer bray et al 1995 critical conditions are changed within such two interfaces model which may support two baroclinic modes and new hydraulic controls sannino et al 2009b 3 considering a three dimensional flow the definition of the control needs to account for cross strait variations such as the tilt of the density interface in the latitudinal direction in the maximal exchange solution control in tn may induce the detachment of the surface layer from the northern coast sannino et al 2009b the hydraulic control effect within the strait is illustrated in fig 1 the flow is initially subcritical in the strait the propagation of internal waves is not hindered at the interface between atlantic and mediterranean waters denoted a in fig 1 then the tidal flood in the vicinity of the camarinal sill becomes supercritical in the supercritical to subcritical transition downstream of the sill a hydraulic jump b in fig 1 may occur hydraulic jumps are large amplitude depressions in the regions where hydraulic controls occur there intense mixing between the atlantic and mediterranean waters takes place as observed by wesson and gregg 1994 shear flow instabilities can develop in the hydraulic jump of the camarinal sill denoted c in fig 1 the release of hydraulic jumps generates large amplitude non linear nonhydrostatic internal solitary waves isw trains denoted d in fig 1 farmer and armi 1988 as the barotropic tide is constrained by the bathymetry large vertical velocities appear and induce energy transfer to several normal modes of internal waves some observations in the strait of gibraltar identify the largest isw amplitude to the first baroclinic mode for which vertical velocities have the same direction throughout the water column and all isopycnal surface displacements are in phase the signature of mode 2 waves the vertical velocity profile exhibits one node has also been observed in the region of gibraltar strait farmer and armi 1988 vázquez et al 2006 the internal waves propagate at the interface of mediterranean and atlantic waters as the strait flow varies at various timescales during the year some deviation is expected in the occurrence of the hydraulic control in the strait this may have a wide impact since local flow conditions combined with the above two conservation equations 1 and 2 determine the relation between the volume fluxes the evaporation minus precipitation budget e p and the salinity difference s a s m bryden and kinder 1991 practically an overmixed solution corresponds to a minimal salinity difference and a maximal exchange of water mass in the strait it would thus constrict the formation of mediterranean waters and diapycnal mixing over the mediterranean basin bryden and stommel 1984 garrett et al 1990 moreover the small scale processes occurring in the strait itself can directly modify the local characteristics of mediterranean waters garcía lafuente et al 2011 naranjo et al 2015 and atlantic waters millot 2014 this can affect their characteristics as they enter respectively in the north atlantic sub basin and in the mediterranean sea to study the flow dynamics in the strait in further details more realistic numerical modelling is of great help early attempts used two layer models brandt et al 1996 izquierdo et al 2001 the increase of computational power led to 3d modelling sannino et al 2004 with increasing vertical and horizontal resolution explicitly addressing the tidal cycle and flow characteristics more recently even nonhydrostatic models have been used sánchez garrido et al 2011 sannino et al 2014 to explicitly represent the isw other configurations include the strait of gibraltar into a mediterranean circulation model soto navarro et al 2015 in this case the increased resolution locally in the strait naranjo et al 2014 or the nesting of high resolution grids within a coarse resolved regional model sannino et al 2009a shows a clear impact on mediterranean stratification and improves the representation of convective events in the northwestern mediterranean basin the coastal and regional ocean modelling community model croco 1 1 http www croco ocean org is based on a new nonhydrostatic and non boussinesq solver auclair et al 2018 developed within the former roms kernel shchepetkin and mcwilliams 2005 for an optimal accuracy and cost efficiency croco opens up new perspectives in terms of modelling of small scale processes fox kemper et al 2019 lemarié et al 2019 in this sense the present study objectives are also numerical we show that a new generation of nonhydrostatic ocean models can be used efficiently to simulate complex nonlinear fine scale physics in a realistic but computationally affordable configuration the complete solution of navier stokes equations is thus solved numerically for the very first time in a complex realistic regional configuration the present configuration of the strait of gibraltar is based on a classical lock exchange initialization sannino et al 2002 a 2d vertical section of the strait is adopted in order to reduce the number of parameters impacting the studied dynamics this rather simple configuration is thus of weak computational cost and reduces the implementation burden it allows to reach the horizontal and vertical scales of the largest turbulent structures observed in this area in the strait where most transverse dynamical feature are an order of magnitude weaker our numerical approach is some kind of ersatz of a large eddy simulation les 2 2 les large eddy simulation les as opposed to dns direct numerical simulation does not cope with the full 3d kolmogorov energy cascade down to molecular scales however at least the onset of this cascade the largest turbulent structures is explicitly represented unlike in rans reynolds averaged navier stokes for which at least the generation process of primary instabilities is correctly represented however les is a 3d concept as the route to molecular dissipation differs in 2d and 3d turbulence the present study is focused on the description of the largest primary instabilities in the strait of gibraltar as well as providing order of magnitudes for explicit simulations of these dynamics along with these physical aims the relevance of the chosen numerical methods is a major concern a quantified impact of the largest turbulent structures on the water masses is out of the scope of what is presented hereafter it would require a fully three dimensional les also achievable with the croco model in complement with dedicated relevant experimental measurements in section 2 we present an overview of croco equations and the implementation for the 2d lock exchange experiment we describe the implementation of the bathymetry profile water masses and the exchange and tidal flows in section 3 we analyse the physics of the 2d configuration comparing the model solution to already published data e g in farmer and armi 1988 emphasis is then made on the hydraulic control section 3 2 the hydraulic jump section 3 3 and the mode 1 and mode 2 isw non linear internal trains of solitary waves propagation section 3 4 last the sensitivity to the tidal forcing amplitude and to the numerical choices are analysed respectively in sections 4 1 and 4 2 with a focus on the fine scales dynamics listed in fig 1 2 model description and configuration 2 1 the numerical modelling system the proposed numerical model of the strait of gibraltar simulates explicitly the fine scale processes from tens to hundreds of metres discussed previously this assumes that i a sufficient grid resolution is provided in the strait and ii a well suited numerical kernel is used the nonhydrostatic non boussinesq croco version is chosen for its ability to allow the explicit representation of primary instabilities that cascade the kinetic energy injected at large scale down to the smaller scales this direct transfer ends at the finest scale resolved the subgrid dissipation of energy is performed both by the implicit mixing of the advection schemes and the explicit closure schemes the dissipation is solely performed by quasi monotonic numerical advection schemes grinstein et al 2007 when no parametrized turbulent closure scheme accounts for the subgrid scale mixing croco is an extension of roms from which it inherited the robustness and efficiency of its time splitting implementation the accuracy of high order methods including its pressure gradient scheme for terrain following coordinates and computing performances shchepetkin and mcwilliams 2005 debreu et al 2012 soufflet et al 2016 in croco s time splitting algorithm the slow mode is similar to roms internal baroclinic mode shchepetkin and mcwilliams 2005 its fast mode includes the usual external barotropic mode and a new pseudo acoustic mode that allows computation of the nonhydrostatic pressure within a non boussinesq formalism auclair et al 2018 a two level time splitting kernel is thus conserved in croco as opposed to the first implementation of the 3 level time splitting by auclair et al 2018 but the fast time step integrates a 3d compressible flow furthermore the slow internal mode is enhanced by a prognostic equation of the vertical velocity replacing the hydrostatic equation 2 2 continuous free surface compressible equations the full set of navier stokes equations for a free surface ocean is explicitly integrated including the continuity and momentum equations the surface kinematic relation the heat salt and state equations in cartesian coordinates 3 t ρ ρ v 4 t ρ v ρ v v 2 ρ ω v p ρ g μ δ v λ v 5 t ζ w z ζ v z ζ ζ 6 t ρ θ ρ θ v κ θ δ θ 7 t ρ s ρ s v κ s δ s 8 ρ ϱ θ s p where v u v w is the velocity p the total pressure ζ the free surface anomaly ρ the density θ and s the potential temperature and salinity respectively ω is the instantaneous earth rotation vector g is the acceleration of gravity and μ λ κ θ and κ s are respectively the dynamical and second bulk viscosity and the thermal and salinity diffusivities ϱ θ s p is a linear approximation of the seawater equation of state 2 3 density and pressure decomposition as part of the time splitting the density is split into one slow and one fast component based on a first order decomposition with respect to the total pressure in the following s and f subscripts refer to these slow and fast components respectively 9 ρ ρ s θ s p ρ p θ s δ p δ ρ ρ f o δ p 2 10 p p a t m z ζ ρ s ρ 0 g d z s l o w m o d e ρ 0 g ζ z δ p p f f a s t m o d e no further decomposition is required for the other variables note that δ p is the nonhydrostatic pressure 2 4 slow vs fast components navier stokes equations are integrated with two different time steps in a time splitting algorithm the slow mode is identical to roms whereas the fast mode is now 3d and includes the integration of the compressible terms of the momentum and continuity equations the free surface anomaly is computed through the surface kinematic condition t ρ f t ρ s ρ v 11 t ρ v ρ v v 2 ρ ω v z ζ f ρ s ρ 0 g d z μ δ v λ s ρ 0 g ζ f p ρ g λ v λ f t ζ f w f z ζ v f z ζ ζ f t ρ θ s θ s ρ θ s v κ θ δ θ s t ρ s s σ s ρ s s v κ s δ s s ρ s ϱ θ s s s ζ f ρ f c s 2 p f the momentum equations are integrated both in the slow and fast modes but the right hand side of the equation is split in two parts a slow part λ s made of slowly varying terms advection coriolis force baroclinic pressure force and viscous dissipation and a fast part λ f made of fast varying terms the surface induced and compressible pressure force the weight and dissipation associated with bulk viscosity this momentum equation is numerically integrated twice once with a large time step keeping λ f constant and once with a smaller time step keeping λ s constant this time splitting is much more computationally efficient than integrating the whole set of equations at the same short time step the general compressible equations set 11 can basically propagate three types of waves internal and external gravity waves and acoustic waves propagating at c s the speed of sound the nonhydrostatic pressure anomaly is not a solution of a diagnostic elliptic poisson like equation as it is for a boussinesq equations set the pressure anomalies travel at the acoustic waves velocity the acoustic solver is not global anymore as it is in the poisson like set it is now local in space meaning that no 3d global linear system of equations needs to be inverted anymore the price of solving fast acoustic waves is however enhanced due to a more restrictive cfl conditions both acoustic and surface waves are integrated in croco s fast mode with a smaller time step to cope with this as a linear set of simplified compressible equations needs to be integrated in this fast mode the whole computations remain affordable in addition since the sound speed is at least one order of magnitude larger than the phase velocity of the fastest propagating waves and much larger than any ocean advection velocity it can be artificially reduced the only requirement is that the speed of sound remains larger than any other propagating wave or flow velocity in the domain in particular it must remain larger than the phase velocity of long surface waves so that nonhydrostatic anomalies can be propagated vertically fast enough to set up the corresponding wave structure over the water column sensitivity tests show that in this case a slower sound speed has no impact on lower frequency dynamics in the region of the strait more details on that point can be found in auclair et al 2018 2 5 bathymetry fig 2 a presents the 500 m resolution bathymetry gathered in the framework of the homonim project coordinated by the french navy shom and meteofrance and as provided by the french navy biscara et al 2016 the main bathymetric features as well as the localization of the studied 2d vertical section are exhibited this section is chosen as close as possible to the transect of farmer and armi s gibraltar experiment performed in april 1986 farmer and armi 1988 and coincides in the western area with the mediterranean waters privileged path hereafter u is the velocity in the longitudinal direction of the section and v the velocity in the transverse direction fig 2 b presents the gibraltar strait width according to different reference depths this plot shows that an averaged thirteen kilometre width can be used featuring steep slopes at the lateral boundaries of the strait especially in tarifa narrows simulations are performed with 50 m and 220 m horizontal resolutions the bathymetry used in the simulations is averaged laterally to limit the unrealistic effect of local seamounts in the transverse direction such as those found in tn which can end up acting as another sill in a 2d vertical section to that end a gaussian interpolation of the bathymetry along the section in fig 2 a is used with a greater gaussian radius in the transverse direction than in the longitudinal direction the gaussian radius in the transverse direction is set to 1500 m i e lower than the width of the strait in fig 2 b as a consequence the bathymetry only reflects the deepest areas in the canal in the longitudinal direction the gaussian interpolation radius is set to 300 m to preserve the bathymetry variability in this direction the minimum depth thus assessed at camarinal sill i e the main sill in the strait along the transect s path goes from the value of approximately 200 m to 245 m the model bathymetry used is the one shown in fig 1 a reference simulation hereafter named simref is carried out at 50 m horizontal resolution with additional characteristics and parameters listed in 1 2 6 initial water masses tidal forcing and boundary conditions the temperature and salinity reference profiles are chosen to initialize the density field of the simulations a minimum of two profiles for each of those variables is needed to initialize gradients associated with sloping isopycnal surfaces in a given direction according to sannino et al 2002 a lock exchange initialization is performed with homogeneous atlantic water initially to the west of the cs and homogeneous mediterranean water to the east a three day spin up described in section 2 7 is then performed to set up the exchange flow in the strait the initial temperature and salinity profiles are presented in fig 3 the contrast in salinity between atlantic and mediterranean waters is noticeable with respective mean values of 35 9 and 38 2 in the following the interface between atlantic and mediterranean layers is taken as the 37 isohaline following bryden et al 1994 density is now expressed as an anomaly written ρ relative to a reference mean density ρ 0 from now on the implicit reference density unless contraindicated will be ρ 0 1033 7 kg m 3 a value reached in the pycnocline separating the two water masses an idealized m2 tidal forcing of period t 12 4 h is prescribed at the open boundaries after the spin up period at t 3 days 5 8 t it is introduced thanks to a barotropic current of amplitude 0 4 m s at the western boundary 0 8 m s at cs corresponding to a moderate regime according to the tpxo 8 tidal atlas egbert and erofeeva 2002 lateral forcing is introduced at the open eastern and western boundaries through mixed active passive radiation conditions marchesiello et al 2001 cyclic conditions are imposed to the northern and southern open boundaries 2 7 initial flow and effect of coriolis force the gibraltar strait lateral boundaries are distant of about 15 km with a clear funnelling effect from the cs to the eastern end of the strait 5 4 w see fig 2 b the internal rossby radius r appendix a is usually found to vary from 10 to 20 km bormans and garrett 1989 candela et al 1990 vlasenko et al 2009 the width of the strait and the rossby radius r being of the same order of magnitude rotational effects can be neglected as a rather good approximation therefore the momentum balance is mainly between the acceleration and the pressure force in eq 4 and the geostrophic adjustment in the along strait direction is locally neglected in their observations farmer and armi 1988 and the 3d modelling configurations sannino et al 2002 the consequence of earth s rotation is a cross strait shear of along strait velocity bormans and garrett 1989 and a tilt of the isopycnals along the southern boundary i e along the moroccan coast the interfacial isopycnal is deeper and the flow reaches larger velocities as the transverse flow the coastal boundaries and the resulting funnelling effect cannot be simulated in a 2d vertical section it is necessary to examine whether completely ignoring rotational effects is viable in a 2d vertical approximation to that end three different numerical simulations of the stratification and the mean circulation are compared i one simulation with the coriolis force activated from start to end simallcor f 8 5 1 0 5 s 1 ii the second one without the coriolis force simnocor f 0 and iii the last one with the coriolis force activated only after a three days spin up period simref apart from the coriolis parameter all the three simulations were performed with the characteristics given in table 1 for simref during the very first hours of simulation time the lock exchange dam separating the atlantic and mediterranean water masses disappears a gravity current is generated with dense mediterranean waters flowing down the western slope of cs and light atlantic water spreading in the surface layer east of the sill fig 4 presents the field of the longitudinal velocity u as well as some isopycnals for simallcor a and simnocor b at t 72 h i e the end of the spinup period the bold isopycnal surface ρ 0 7 kg m 3 corresponds at that time to the 37psu isohaline fig 4 a b also present the transverse velocity v isotachs 0 5 m s fig 4 c d show the tidal residual components u and v in the water column at the two dashed vertical lines in fig 4 a b these locations correspond to the moorings indicated in figure 1 of candela et al 1990 using the 37psu isohaline as a frontier between the two water masses the 3t time averaged transport through the left dashed line at the cs is given in the columns labelled transport of table 2 in simnocor fig 4 b a clear vertical shear of the along section velocity can be seen between the two water masses the shear is still featured in the 3t averaged current profiles of fig 4 c and is for station m2 in accordance with the observations given by the moorings at the cs this shear has decreased since initialization as progressive mixing of the two water masses reduces the baroclinicity the currents in simallcor and simref are weaker with locally negative currents in the upper layer see fig 4 c this is confirmed by the layer averaged transports presented in table 2 where values in simallcor and simref are one order of magnitude smaller than in simnocor using an average strait s width of 13 km an approximate baroclinic transport for the strait can be estimated from the values in table 2 for simnocor it would be of 0 6 sv it is slightly weaker than the range of 0 7 1 sv estimated from various field observations see a review in sammartino et al 2015 in simallcor and simref the cross section velocity is due to the inclusion of the coriolis force more precisely during the spin up phase of simallcor the effect of rotation can no more be neglected after 6 h at that time the upper atlantic layer has spread over a distance of about 26 km and the cross section velocity featured in fig 4 a is already significant with no coastal boundaries to hinder the geostrophic adjustment within the strait the initially longitudinal gravity current is almost completely converted into transverse geostrophic current with spurious non physical consequences on the slope of the isopycnals geostrophy enables a thermal wind balance for the transverse v component 12 v z g ρ 0 f ρ x this is particularly apparent to the east of the cs in fig 4 a where the pycnocline is located at the transition between positive and negative transverse velocities as a consequence the pycnocline slope is δ z δ x 6 1 0 3 table 2 and the atlantic water cannot spread further than the resulting surface front in simref the coriolis force is introduced only after a 72 h spin up period leading to the state presented in fig 4 b in this case the resulting slope and transverse velocity are smaller than in simallcor the pycnocline in the eastern part of the domain is deeper whereas it is shallower in the western part however longitudinal currents remain weak in contrast in simnocor the thermal wind balance is not allowed and away from the sills δ z δ x vanishes in the longitudinal direction the main balance is between the pressure force 1 ρ 0 p x and the acceleration term in this case the shear of the longitudinal velocity is better represented at the two moorings the larger transports in both layers indicate that a larger amount of mediterranean water enters the tangier basin than in simallcor this is confirmed by the stratification fig 4 a and table 2 since the pycnocline is shallower over the espartel sill and deeper within the tn a perfect balance between the transports in the upper and lower layers is not achieved in any of these three numerical experiments while there is no numerical challenge in achieving longer simulation the fluxes of mediterranean and atlantic waters are not realistically specified to re stratify properly the water column in these academic configurations after the spin up period the intense tidal mixing and other dissipative processes may end up homogenizing the initial water masses the gap between the transports in the upper and lower layers disappears as the depth averaged absolute transports decrease this process is faster in simnocor than in the other configurations in which the thermal wind balance maintains the isopycnal slopes in this case the depth of the 37 psu isohaline taken as a moving average over one tidal period at x 5 4 w increases from 130 to 175 m in simnocor over three tidal periods not shown this impacts the large amplitude internal waves propagation the difficulty to obtain both realistic ambient stratification and circulation is a limitation of the restriction to a 2d vertical section of the dynamical problem targeted in the proposed implementation an initial state is obtained by lock exchange with a spin up period of 72 h dedicated to the adjustment of the gravity current produced by the dam break for the remainder of this paper the reference simulation simref is chosen as the simulation whose adjustment is made in a non rotating framework this initial state has a correct mean exchange but it is weakened as the tidal forcing is introduced and changes the stratification conditions to mitigate this problem the rotation is restored at the end of the spin up period the geostrophic balance that ensues stabilizes the slopes of isopycnals by generating a transverse current the mean exchange is nevertheless reduced but the stratification i e both the slope of the isopycnals and the vertical density gradient thus saved is crucial to the generation and propagation of the large amplitude solitary waves furthermore the small scale processes discussed hereafter take place during the tidal cycle at this time scale the barotropic exchange is dominated by the tidal currents so that in the reference simulation the amplitude of the baroclinic exchange is correct note that if rotation is activated from the beginning of the spin up period simallcor it leads to unrealistically large slopes of the isopycnals see table 2 3 the reference simulation the reference simulation presented previously is now evaluated thanks to the observational data from the gibraltar experiment farmer and armi 1988 we describe the hydraulic controls the primary instabilities and the dynamics of the isw in this reference simulation 3 1 comparison with in situ observations in the present section observations from the gibraltar experiment farmer and armi 1988 are investigated in order to evaluate the quality of the model solution obtained with the reference configuration simref table 2 presents the pycnocline depth and slope at different locations along the section for the three configurations and the observational data the depth and slope for simallcor and simnocor are calculated after 72 h of simulation and correspond to the isopycnal surface ρ 0 7 kg m 3 in fig 4 a b whereas for configuration simref the same isopycnal taken in a 3t averaged stratification corresponding to fig 5 in simallcor the isopycnals have a greater slope than the reported observations from gibraltar experiment 0 006 vs 0 003 in simnocor there is no slope away from the sills while as discussed before the slope obtained in simref is small the stratification in simref is close to that of simnocor in the eastern part with an isopycnal close to the horizontal in the western part and over the cs the pycnocline is shallower than in the other two simulations table 2 in the following we further investigate small scale dynamical processes such as hydraulic jump and isw propagation in configuration simref this is also the baseline configuration used to perform all sensitivity tests presented hereafter 3 2 tidal currents hydraulic control in the present study the froude number f is simply defined at each grid point as the ratio between the local longitudinal velocity u and the theoretical speed c 1 of the first internal wave mode computed with the modal decomposition for each point of the x axis see appendix b for details for single layer flows hydraulic control occurs in the region of transition between subcritical and supercritical flows in this region the condition f 1 is met over the whole water column for multi layer flows the froude number condition may be satisfied in a few layers only in this case the layers where the flow becomes supercritical are considered as hydraulically controlled three areas of potential hydraulic control in gibraltar strait are identified from previous studies the cs the es and the narrowest part of the tn near 5 5 w longitude in fig 2 farmer and armi 1988 found persistent controls for first internal wave mode at the es the cs and the tn sannino et al 2009b found only ephemeral appearances of such controls except at the es where it is permanent the discrepancy is likely lying in the definition and the estimation of the composite froude number fig 5 shows the regions where the flow is critical closed contours indicate the locations of critical froude number f 1 inside which the flow is supercritical the longitudinal velocity fields u used to estimate f are taken at maximum outflow grey at t 7 5 t and maximum inflow black at t 8 t the internal waves phase speed c 1 is computed from the 3t time averaged stratification represented in fig 5 no control of the first mode is ever seen in tn this is a consequence of the 2d simplification which excludes the representation of the tidal flow intensification by the narrowing of the strait at tn on the other hand hydraulic control is expected at both sills the location where it should occur alternates between the eastern during ebb and western during flood sides of the sills with a return to subcritical flow when tidal current slackens the froude number easily goes beyond 2 in the mediterranean outflow at cs where the flow is supercritical through most of the water column except sometime at the surface at es the lower layer may become supercritical with froude number that never exceeds 1 5 the lack of persistent control at es may be a consequence of the crudely imposed stratification 3 3 primary instabilities in the hydraulic jump area one manifestation of the hydraulic control is the formation of hydraulic jumps in specific regions where the flow transitions from supercritical to subcritical this is a complex area with steep slopes and high shears where flow topography interaction can generate small scale coherent structures the largest ones are resolved in simref and are characterized here with various methods first the okubo weiss parameter appendix c is computed to investigate the presence of new coherent structures in the hydraulic jump area their dynamics are further investigated using empirical orthogonal functions eofs computed with a singular value decomposition svd their typical length and velocity scales are finally compared with the expected analytical values of shear instabilities and lee waves the dynamics of the cs hydraulic jump are illustrated in fig 6 in which the density field fig 6 a and the vertical velocity field fig 6 b over the western slope of the cs are represented during flood several flow parameters were also computed and are depicted in fig 6 a and b these parameters are 1 the froude number defined in appendix b the contours of critical froude number f 1 are shown in fig 6 b inside which the flow is supercritical 2 the richardson gradient number defined as r i n 2 u z 2 with n the brunt väisälä frequency defined in eq 13 contours of r i 0 25 are depicted in fig 6 a as r i 0 25 is a required condition for the development of shear instabilities 13 n g ρ 0 ρ z 3 the okubo weiss parameter defined in appendix c negative values of ow indicate vortical circulation and so contours of o w 4 1 0 4 s 2 are shown in both fig 6 a and b in fig 6 b the supercritical flow region f 1 follows the slope of the sill where the velocity in the mediterranean outflow is larger than 2 m s see the contour f 1 running approximately parallel to isopycnals between 5 76 w and 5 77 w at 5 77 w the density field in fig 6 a shows a sharp transition e g isopycnal ρ 0 5 kg m 3 rises from 350 to 225 m depth and forms a wedge shaped region over the supercritical mediterranean outflow this is the signature of an internal hydraulic jump downstream of the hydraulic jump several small scale structures are visible fig 6 a shows patches of lighter water billows associated with areas of negative ow values at a depth of 400 m and large amplitude disturbances of isopycnals at 150 m negative ow values are also located at troughs and can reach o w 4 1 0 4 s 2 both types of structures are propagating westward and are quite probably shed from the internal hydraulic jump at the tip of the wedge shaped region at 5 773 w with the size of billows growing rapidly as they travel down slope in the potential generation area richardson number values are less than 0 25 indicating favourable conditions for generation of primary shear instabilities further identification of the simulated new features of fig 6 is achieved by proceeding with a complex singular value decomposition svd pairaud and auclair 2005 of the velocity field w i u in the water column between 5 795 w and 5 78 w longitude during outflow conditions this region is highlighted in fig 7 a in which the time mean field of longitudinal velocity u is presented showing the intense outflow below layers of lesser velocities the mean density field and location of r i 0 25 are also indicated the former showing a homogeneous area between 50 150 m above the seafloor the svd gives a first singular vector responsible for 28 of the total variance corresponding to the evolution of the barotropic forcing not shown the remaining singular eigenvectors have lesser corresponding variance and show smaller structures with high frequency variations in the singular right eigenvector two consecutive singular vectors often have very close eigenvalues and temporal variations fig 7 b shows the reconstructed field of the combination of the second and third singular vectors respectively responsible for 13 and 11 of total variance added to the mean field shown in fig 7 a the okubo weiss parameter is again computed for the resulting velocity field which shows two rows of y axis vortices centred at z 300 m anti clockwise and 400 m clockwise the upper row of vortices appears to generate the observed interface oscillations based on ow 0 contours the lower clockwise vortices have an estimated horizontal scale of 200 m and a vertical scale of 150 m corresponding to horizontal and vertical wavenumbers 3 10 2 and 4 10 2 m 1 respectively their propagation speed can be estimated as 0 7 m s by following the centre of the billows defined by areas of negative ow values the distance between the centres of two consecutive vortices is l 530 m the centres of the upper anti clockwise and lower clockwise vortices are shifted along flow by l 2 so that the extrema of their respective vertical velocities are aligned vertically it seems that a transfer of momentum occurs between the two rows of vortices in a way reminiscent of the vallis model of edge waves in a stratified region of a shear flow pp 254 258 in vallis 2006 the length scales deduced from this svd analysis can now be compared with expected scales from simple analytical models for shear instabilities and internal waves based on the general characteristics of the flow on the western slope of camarinal shear flow instability in a two layer system of infinite depth results in a mixed interface of vertical extent δ h expressed by equation 14 6 of cushman roisin and beckers 2011 14 δ h 1 k m i n ρ 0 u 1 u 2 2 2 ρ 2 ρ 1 g with k m i n the wave number of the most unstable mode in this system taken as the scale of the primary instability that will develop in the generation area of cs u 1 u 2 is in the range of 1 2 to 2 m s and ρ 2 ρ 1 is in the range of 1 2 to 1 7 kg m 3 additional values are ρ 0 1033 7 kg m 3 and g 9 81 m 2 s this gives a range of vertical scales between 44 m and 183 m and k m i n between 2 10 2 m 1 and 5 10 3 m 1 the scales of the simulated lower row of vortices are in the upper part of this range lee waves are another candidate for small scale transient flow and the interfacial oscillations observed in our solutions their generation over topography is expected when tidal excursion is larger that the topographic length scale 1 k b i e k b u 0 ω 1 st laurent and garrett 2002 the slopes of camarinal sill are not symmetrical as can be seen for example in fig 4 on the western side of the sill the depth increases from 250 m at 5 76 w to 510 m at 5 78 w over only 1 8 km whereas on the eastern side it increases from 250 m to 620 m at 5 65 w over 9 4 km k b is thus chosen in a range between 3 1 0 3 m 1 and 6 1 0 4 m 1 u 0 0 4 m s is the amplitude of the barotropic tidal current away from the sill in these conditions the ratio k b u 0 ω ranges between 1 7 over the west slope and 8 9 over the east slope based on this we cannot rule out the possibility that lee waves are generated over the cs if the simulated small scale structures would originate from lee waves their phase speed would be comparable to a mode 1 internal gravity waves this can be estimated using the same method as in appendix b for the average stratification presented in fig 7 a it yields a value of 1 4 m s in the area down flow of the hydraulic jump which is twice the estimated propagation speed of both rows of simulated structures therefore even though lee wave generation is theoretically possible the interfacial oscillations observed in the simulation appear more consistent with the stirring effect of the bottom coherent vortices whose scales fall within the range of expected values for kh instability we conclude that coherent structures are clearly identified in our simulations they are generated in an area of potentially unstable shear r i 0 25 and are associated with billows of lighter mixed fluid the deeper row of vortices can reasonably be interpreted as kelvin helmholtz primary instabilities their downstream behaviour further corresponds to a 2d pairing of two consecutive kelvin helmholtz billows these billows are advected in a region of westward flow between the mediterranean vein and atlantic waters up until 5 8 w at this location advection is reduced as the lower layer decelerates and the billows are uplifted in a flow recirculation and mixed in the pycnocline these small scale features appear in the simulation for as long as the hydraulic jump is present injecting water from the pycnocline in the outflow and vigorously mixing the atlantic and mediterranean waters until the tidal currents weaken sufficiently for the flow to become subcritical however the dynamics simulated in a 2d vertical section with no transverse flow and no transverse instability may differ from the real ocean in a fully 3d configuration primary kelvin helmholtz instabilities should decay faster as secondary kelvin helmholtz instabilities develop along the transverse rotation axis of the primary billows this is precluded in the present 2d configuration even with enhanced resolution as only y axis billows can occur wesson and gregg 1994 observed billow structures in the area of cs with an extension of several tens of metres this length scale is much smaller than the one simulated in the present numerical configuration however these observations were made in shallower regions i e probably closer to the generation area larger billows more in line with those simulated in the present study could thus develop downstream further observations on site are needed although short length scales and fast propagation speed would require adapted measurement strategies 3 4 internal tide dynamics in simref two main types of large amplitude wave propagating eastward can be observed both of them are generated at cs while tidal currents reverse from westward to eastward this is illustrated in fig 8 a b first a mode 1 wave appears as a bore over the sill s crest approximately 2 25 h after the westward flow peaks in fig 8 a it has propagated over the eastern slope of the sill s crest and is now at 5 7 w longitude the corresponding profile in fig 8 c has only one maximum as expected for a mode 1 internal wave this wave rapidly steepens while a hydraulic control is maintained on the western side of the sill with lower values of the froude number one hour and 15 min later the flow becomes subcritical and a large amplitude mode 2 wave crosses the sill in fig 8 b this new wave is propagating over the eastern slope of the sill its vertical velocity profile is presented in fig 8 c it exhibits two maxima of opposite signs and a zero crossing at the pycnocline s depth as expected for a mode 2 internal wave additionally it can be seen in this figure that the bore like wave has evolved into a train of internal solitary waves whose propagation is discussed below the propagation of internal waves can be characterized by plotting a space time evolution of a particular isopycnal in fig 9 b the depth evolution of the 0 7 kg m 3 isopycnal is represented also in a white contour in fig 8 regions of sharp horizontal density gradients can be identified periodically in the region of the cs next to 5 76 w longitude they correspond to the generation of hydraulic jumps the propagation of internal waves are identified by the tilt of isolines whose slopes provide an estimate of wave propagation speed there are differences from one tidal cycle to the next because mixing progressively changes the background stratification in the domain in the following we focus on the tidal cycle t 7 5 t 8 5 t second cycle after the end of the spin up phase for which the three tidal cycle averaged velocity shear and stratification are shown in figs 4 and 5 the mode 1 bore of fig 8 a propagates down slope of the cs into the tn where it experiences a transition into a train of solitary waves moving at a speed of 1 5 m s in fig 9 c such a train made of four mode 1 waves can be seen at 5 5 w longitude the amplitude of the first wave reaches 100 m the solitons train amplitude momentarily increases and exceeds 150 m as it propagates over the slope near 5 5 w longitude in the tn still during ebb tide from then on the wave amplitude decreases as it propagates towards the deeper region meanwhile the dispersion increases the number of waves as well as their wavelength as noticed in the space time diagram which shows the envelop of the train of solitons expanding while it propagates eastward the dispersion as simulated in croco is compared with the korteweg devries model in appendix d similarly the mode 2 wave shown in fig 8 b propagates through the shallowest part of the tn at a speed of 0 9 m s as a new hydraulic jump is being generated over the eastern slope of cs it is located at 5 65 w longitude in fig 9 c with an amplitude of approximately 100 m the propagation speed of this mode 2 internal wave subsequently decreases when it reaches the deepest part of the domain while simultaneously the tidal phase shifts to flood the amplitude of these waves is simultaneously strongly reduced the signatures of other large amplitude internal waves can be seen propagating to the west of the cs in fig 9 b they are mode 1 and mode 2 internal waves with amplitude in the tens of metres i e smaller than the eastward propagating wave they are generated when tidal currents switch from eastward to westward in the same fashion as previously described for the wave train produced east of the cs as tidal currents reverse from westward to eastward as discussed in section 3 2 a hydraulic control also occurs at the es fig 9 b shows the same variations of isopycnal depth in this area as near the cs during the tidal cycle t 7 5 t 8 5 t but not on the following cycle anymore in the latter case the computed froude number does not exceed 0 7 as opposed to previous cycles t 6 5 t 7 5 t and t 7 5 t 8 5 t or later ones t 9 5 t 10 5 t and t 10 5 t 11 5 t in these cases the variations are similar and hydraulic control occurs at es the sequence is as in cs with a hydraulic control briefly lost at the barotropic flow reversal then internal mode 1 waves of 50 m amplitude at a depth of 300 m are released and propagate toward the cs in fig 9 c a mode 1 wave can be found at 5 87 w these waves dissipate in the area near the sill as the absolute value of the barotropic current decreases in fig 9 c two vertical lines are drawn in the tn they refer to measurements made by farmer and armi 1988 the lines indicate the first two baroclinic modes locations three and a half hours after high tide the right hand vertical line corresponds to a mode 1 wave and is in agreement with the simulation however in simref the distance between the two modes is twice as large as in the observations based on observed wave arrivals at various stations farmer and armi 1988 estimated the propagation speed of both mode 1 and mode 2 waves at about 1 to 2 5 m s for mode 1 and 1 to 1 5 m s for mode 2 the wave train they observed contained two to three large amplitude waves the first one having an amplitude of 100 m additional observations by garrido et al 2008 in the tn region give a propagation speed for mode 1 waves ranging in 1 2 m s and 2 m s with a large variation in the velocity of two consecutive wave trains due to the weight of the tidal diurnal inequality k1 and o1 the mode 1 dynamics simulated in simref are consistent with these observations reported by farmer and armi 1988 in terms of propagation speed and longitudinal position however the simulated mode 2 wave seems too slow and its amplitude too large its slower propagation might be due to an underestimation of the barotropic flow that carries the mode 2 within the tn as our 2d vertical approach does not catch well the tunnelling effects of this narrowing this would not affect the mode 1 wave as much because its linear propagation speed is more intense and the barotropic current advection becomes comparatively small the brief hydraulic control loss observed when the tidal currents reverse does not reflect the quasi permanent control thought to be taking place at es in this case no internal waves packet can be emitted from the es 4 sensitivity testing the reference configuration presented in the previous section is based on several physical and numerical choices which are now investigated mostly the impact of the forcing amplitude momentum balance hydrostatic approximation and numerical parameters spatial resolution advection schemes 4 1 tidal regime an additional simulation sims is first performed similarly to simref changing only the tidal forcing amplitude the imposed tidal current amplitude at the western boundary is now increased up to 0 6 m s so that it reaches 1 3 m s over the cs this corresponds to a spring tide regime fig 10 presents a comparison between sims and simref in fig 10 a the contours of supercritical regions f 1 show the cs hydraulic jump extends further east in sims as a result a mode 1 disturbance denoted a in fig 10 a is trapped at 5 725 w longitude it propagates eastward when the flow becomes subcritical but the faster bore that is crossing the cs can rapidly catch it up the outflowing mediterranean water vein on the westward side of the sill is also thicker in sims and so is the supercritical area in addition a new supercritical region appears on the western slope of a secondary relief at 5 83 w longitude denoted b in fig 10 a with trailing lee waves fig 10 b shows an eastward propagating mode 1 solitons packet since the initial stratifications are similar linear phase velocities are the same in simref and sims at the beginning the amplitude of the first trough of the train is 50 m larger in sims than in simref this should result in increased propagation speed of the solitons in sims in contradiction with a slower propagation seen in fig 10 b it can be explained by the stronger tidal currents advection in the opposite direction in sims a mode 2 wave is also generated in both sims and simref but is only visible in simref in fig 10 b as it quickly dissipates in sims due to stronger tidal currents consistent with our results farmer and armi 1988 show that the isw amplitude increases with the tidal current during the spring tide neap tide cycle in addition two concomitant hydraulic jumps were observed in the strait during spring tide sánchez garrido et al 2011 they exhibit a transverse asymmetry as the second jump only appears in the northern part of the strait this could not be confirmed in the present 2d configuration 4 2 nonhydrostatic balance and numerical factors the consequences of several numerical choices are now investigated by running five additional simulations whose differences with simref are laid out in table 3 in particular the sensitivity to both vertical and horizontal resolution is targeted a hydrostatic kernel and a weno5 z advection scheme for momentum borges et al 2008 are also tested and compared with simref we focus on the impact of these modifications on two types of small scale processes studied in the previous sections the primary kh instability generation in the hydraulic jump at the cs and the eastward propagating solitary waves generated at the same place 4 2 1 hydraulic jump and instabilities hydraulic controls section 3 2 occur in all simulations as revealed by systematic estimations of the froude numbers low richardson numbers 0 25 are also diagnosed for all simulations over at least part of the cs western slope during flood however the features that have been identified as kh instabilities in section 3 3 do not appear in all simulations they are absent in the simulations performed in the hydrostatic framework and or with low horizontal resolution siml simlh and simh weak horizontal vorticity tilting under the hydrostatic assumption prevents such instabilities to develop instead a smooth large recirculation appears west of the cs fig 11 for simlh in the remaining sensitivity experiments simv and simw kh instabilities are generated at the edge of the hydraulic jump and their dynamics is overall similar to the one described in section 3 3 for simref pairing of kh billows can occur whereas anti clockwise vortices induce oscillations of the interface fine resolution a few tens of metres in the present region and non hydrostatic equations are both required to explicitly simulate the turbulent cascade onset with kh instabilities between mediterranean and atlantic flows interestingly enough a comparison of fig 6 nonhydrostatic configuration and 11 hydrostatic configuration shows that the fine scale solution is largely filtered out by the hydrostatic assumption without dedicated observations in the area it remains difficult to conclude that simref is more realistic although low richardson numbers in this region lead us to expect kh instability 4 2 2 large internal waves as described in section 3 4 mode 1 and mode 2 large amplitude internal waves are generated in the cs vicinity and propagate eastward during each ebb in all nonhydrostatic simulations fig 12 presents the density fields in the region of the tn at t 8 1 t a wave train with a minimum of two solitons can only be identified in the nonhydrostatic experiments in the hydrostatic cases simh and simlh the lack of nonhydrostatic dispersion produces internal waves propagating as internal bores in the nonhydrostatic cases these internal waves can propagate as trains of solitons with varying numbers of solitons and celerity 6 in simref 8 in simw 4 in simv and 2 in siml this illustrates a second aspect of the effect of hydrostatic assumptions besides the inhibition of turbulent primary instabilities kh instabilities in the region of the hydraulic jump as already noted by previous authors sannino et al 2004 the dispersion needed to balance nonlinear steepening in large amplitude solitary waves is missing in hydrostatic simulations such as simh and simlh fig 12 4 2 3 evolution of stratification the previous results lead us to anticipate large differences in the way density stratification evolves in simref simw simv simh siml or simlh to go further fig 13 shows for each configuration the profiles of brunt väisälä frequency n defined in eq 13 at 5 8 w a and at 5 55 w b profiles are time averaged over one flood at 5 8 w stratification is similar in simh and simlh with an interface region defined as the region where n is maximal here n 8 10 3 s 1 located at a depth of 250 m fig 13 a the nonhydrostatic simulations simref and siml present an interface region at a similar depth but the vertical gradients are larger in simref and smaller in siml simv shows larger vertical gradients of density n 1 1 10 2 s 1 and a shallower interface at a depth of 150 m simw is weakly stratified over most of the water column with no clear interface between the two water masses this result may seem surprising because the weno5 scheme is of fifth order accuracy with more selective quasi monotonic corrections near shocks than the tvd scheme and is thus expected to produce less smoothing this apparent contradiction can be explained by the generation of more intense primary shear instabilities i e with higher values of associated vertical velocity and vertical velocity gradients which has the effect of diffusing density gradients in fig 13 b averaged n profiles over one flood are shown at 5 55 w longitude in a region subjected to intense internal wave activity simh simlh and siml exhibit similar profiles with n slowly decreasing below the interface at 160 m simref has a similar interface at 160 m but with higher n value although weaker stratification appears at the top of the lower layer simv and simw both have shallower interfaces at 130 m with n reaching the highest values in simv n 1 25 10 2 s 1 as the enhanced vertical resolution allows the representation of stronger gradients clear conclusions cannot yet be drawn concerning mixing kh instabilities are expected in the region of the hydraulic jump and downstream they lead to more stirring and consequently open up new opportunities to improve modelling of the route to mixing further investigation and diagnostics are now required to better understand the energy cascades in particular the present comparison between weno5 and tvd advection schemes and their implicit dissipation indicates that numerical choices may unfortunately still have large consequences therefore the role of physical and numerical closure must be considered comprehensively marchesiello et al 2011 soufflet et al 2016 5 discussion and conclusion the present study focuses on small scale dynamics in the strait of gibraltar and on the capacity of a new split explicit free surface nonhydrostatic regional oceanic model croco to represent such dynamics both objectives were pursued in parallel and several seminal results are obtained the study confirms that the generation of large amplitude mode 1 and mode 2 internal waves in the strait of gibraltar as well as the onset of stratified turbulence and its energy cascade can be simulated with a computationally efficient 2d vertical section the characteristics of the simulated internal waves compare qualitatively well with published observations and previous numerical studies internal tides dynamics and shear instability in the hydraulic jump area are then analysed in more details revealing characteristics and mechanisms the results of the study rely on a new type of nonhydrostatic non boussinesq free surface kernel auclair et al 2018 implemented in the croco model the resulting compressible oceanic model is presented in a realistic nonhydrostatic configuration for the first time sensitivity tests confirm that a nonhydrostatic here non boussinesq kernel is required i to simulate isw trains and ii to explicitly simulate the onset of stratified turbulence energy cascade provided that resolution is increased from about 200 m to 50 m we conclude that resolutions finer than a few hundred metres are required in addition to a refinement of dynamical equations relaxation of hydrostatic assumption in order to solve the dominant dynamical processes in a key region of the mediterranean detailed characteristics of the vertical 2d configuration are also given with particular attention to the bathymetry and to the representation of the coriolis force implicit representation of funnelling effect in the strait the proposed approach offers a computationally affordable way to make preliminary investigations of internal wave dynamics in regions where these waves are important however the vertical 2d configuration is limited by the simplified representation of bathymetry and associated biases in the velocity shear between in flowing atlantic waters and out flowing mediterranean waters the inclusion of restratification processes surface and boundary forcing would allow the model to remain accurate for a greater number of tidal cycles the present configuration is considered accurate within three days after the spin up period before mixing starts to homogenize the water masses several remaining processes could not be considered the transverse propagation of isws in the strait of gibraltar sánchez garrido et al 2011 vlasenko et al 2009 and in the alboran sea the hydraulic control at the tn farmer and armi 1988 sannino et al 2009b the boiling water over the cs bruno et al 2002 or reflections on the strait s coasts only the onset of turbulence cascade could be simulated showing complex dynamics occurring in the area of the hydraulic jump at cs with some small scale features identified as primary kelvin helmholtz instabilities although this 2d study highlights how interesting this area can be there is no doubt that simulation of secondary kh instabilities and subsequent energy cascade as well as the long term impact of these small scale processes on mediterranean and north atlantic circulation will require a fully 3d les approach as well as dedicated field campaigns that explore these fine scale processes credit authorship contribution statement margaux hilt conceptualization software writing original draft writing review editing visualization methodology investigation francis auclair conceptualization software writing review editing funding acquisition supervision rachid benshila software writing review editing lucie bordois software writing review editing methodology xavier capet software writing review editing laurent debreu software writing review editing franck dumas software writing review editing funding acquisition swen jullien software writing review editing florian lemarié software writing review editing patrick marchesiello software writing review editing conceptualization cyril nguyen software writing review editing laurent roblou software writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was partly funded by the dga etude amont protevs driven by the shom it was granted access to the hpc ressources of calmip supercomputing center under the allocation p18017 we also gratefully thank the computer team of the laboratoire d aérologie for its support margaux hilt s ph d thesis was funded by a mesri scholarship appendix a evaluation of the first internal rossby radius the first internal rossby radius is defined as a 1 r g h f at the gibraltar strait s latitude the coriolis parameter is f 8 5 1 0 5 s 1 the numerator c g h is the phase speed of the linear interfacial waves into which the reduced gravity is a 2 g g ρ m s m ρ a s a ρ 0 where ρ m s m ρ a s a 2 kg m 3 if the reference density is set to ρ 0 1033 7 kg m 3 and the gravity acceleration by g 9 81 m 2 s g 0 02 m s 2 which is in agreement with in situ data cf bryden et al 1994 h is a characteristic height given by a 3 h h 1 h 2 h 1 h 2 where h 1 and h 2 are respectively the upper and lower layer thicknesses picking up the data values from farmer and armi 1988 table 2 first line we obtain a range of h 50 100 m which combined with the previous values for g and f leads to r ranging in 11 5 km east of camarinal sill to 16 km west of camarinal sill g h can be replaced by the mode 1 internal waves speed c 1 which is estimated in the present study appendix b for the 3t averaged stratification simref presented in fig 5 c 1 ranges between 0 8 m s at camarinal sill and 1 8 m s in the eastern part of the strait giving an estimated range of rossby radius c 1 f between 9 5 and 21 km for the simulated section appendix b computation of a froude number a single value of mode n linear internal wave phase speed c n can be computed for a flat bottom and a linear stratification this velocity can then be compared at each depth with the magnitude of local horizontal currents u to estimate when and where internal waves can propagate against currents a diagnostic tool is the ratio of velocities i e a froude number f n defined as f n u c n c n ω k n where ω is the wave frequency here the m2 tidal frequency and k n are eigenvalues obtained by solving numerically the sturm liouville problem associated with the linear propagation equation e g ill 1982 b 1 w n k 2 n 2 ω 2 ω 2 f 2 w n 0 with bottom and surface boundary conditions w n 0 0 and w n h 0 w n gives the structures of vertical modes for each point on the x axis the profile n z is computed with eq 13 from the 3t averaged stratification in simref shown in fig 5 the value of the first mode phase speed c 1 x is indicated in the lower panel of fig b 14 and compared to the longitudinal velocity u x z at t 8 5 t plotted in the upper panel the areas where u x z c 1 x equivalent to froude number f 1 larger than 1 are presented in the upper panel as well the flow inside those contours is called supercritical appendix c computation of okubo weiss parameter the okubo weiss parameter ow is defined as c 1 o w s n 2 s s 2 ω 2 with s n the normal strain component s s the shear strain component and ω the vorticity usually it is used in a xy plane e g for tracking eddies in chelton et al 2007 but it is computed here in the zx plane with the strains and vorticity expressed as c 2 s n w z u x s s u z w x ω u z w x negative values of ow indicate a greater role of rotation over deformation and thus the presence of coherent vortices appendix d comparison with korteweg de vries kdv model following many studies garrido et al 2008 sannino et al 2009b vlasenko et al 2009 the large amplitude internal waves of section 3 4 are termed isws for internal solitary waves to confirm that the internal waves observed in this section are isws they are now compared with solutions of the korteweg de vries equation which is recalled below the solutions of this equation satisfy a balance between nonhydrostatic dispersion and nonlinear advection nonlinear advection steepens the wave front whereas nonhydrostatic dispersion reduces steepening by transferring energy from large to small scales resulting in a relatively stable entity called a solitary wave or soliton the korteweg de vries kdv equation describes the evolution of an infinitely thin interface in a two layer system with constant bottom topography d 1 ζ t c ζ x 3 2 h 1 h 2 h 1 h 2 c ζ ζ x a 1 6 h 1 h 2 c 3 ζ x 3 b 3 8 ζ 2 c h 1 2 6 h 1 h 2 h 2 2 8 h 1 h 2 2 c 0 where c is the interfacial speed of small amplitude internal waves c g h r f and ζ is the vertical displacement of the interface g and h have already been defined in a the first two terms on the left hand side of d 1 are those involved in the classical propagation equation for a small amplitude linear interfacial wave travelling in the x direction at speed c the third term bracket a is a first order approximation with respect to amplitude of nonlinear advection term b is a dispersive term the fifth term c is a higher order non linear term associated with a second order development for advection the complete equation d 1 will be referred to as extended kdv or ekdv whereas the same equation without term c will simply be referred to as kdv dossmann 2012 the simulated large amplitude waves presented in this study are compared with the solutions of the kdv or ekdv equation to gain insight into their dynamics for optimal comparison a new simulation called simref was carried out its characteristics are similar to simref table 1 except that i the eastern boundary is shifted 42 km to the east into the mediterranean sea and ii the tidal forcing is stopped after only 7 25 periods the first eastward propagating train of mode 1 waves generated by the tide at the cs is compared with the propagation given by numerical integration of the kdv and ekdv equations d 1 the vertical displacement of isopycnal ρ 0 5 kg m 3 is extracted 3 3 due to the extension of the domain to the east a new value of ρ 0 is computed ρ 0 1033 9 kg m 3 to optimize computations at t 0 7 5 t when the mode 1 isw train propagates over a region of constant depth h 890 m east of tn fig d 15 so as to get closer to the kdv framework the position of the chosen isopycnal surface at this time is shown in fig d 15 a at that time the distance between the first and second solitons of the train is 5 km the first soliton has an amplitude of 75 m and the train includes 7 solitons this isopycnal is chosen as initial state for the kdv or ekdv model the kdv and ekdv equations are integrated either with the interfacial wave speed c 1 27 m s or with mode 1 velocity c 1 1 45 m s see appendix b for details on c 1 evaluation fig d 15 b e compare the interface depth obtained at t t 0 0 25 t in the kdv and ekdv models with the position of the 0 5 kg m 3 isopycnal in simref in the latter the distance between the first two solitons has grown since t t 0 and reaches 7 km with an amplitude of 70 m for the first trough the train is now made of 11 solitons the first three have decreasing amplitudes then two smaller solitons of comparable amplitude 40 m and one soliton of greater amplitude followed by solitons with decreasing amplitude again in the kdv solution obtained with propagation speed c the first solitary wave is slightly slower but its amplitude is markedly larger fig d 15 d the remaining solitons of the train are well located but a secondary trough is generated between the first two solitons whereas it is absent in simref using the larger mode 1 speed c 1 instead of c fig d 15 b the train of solitons in kdv is too fast when the ekdv equation is used with speed c e the solitons are too slow whereas this same extended equation with c 1 c leads to a correct displacement of the solitons overall the temporal evolution of solitary waves in simref is consistent with the solutions of the kdv or ekdv equation d 1 however the kdv or ekdv framework remains an inviscid simplification note that closer evolution of soliton amplitudes between kdv or ekdv and simref solutions can be obtained by simply adding a diffusive term in kdv or ekdv equation this also slows down propagation in kdv and to a lesser extent in ekdv not shown the kdv or ekdv model also involves adjustable parameters such as the linear wave speed which ranges between the interfacial speed c and the mode 1 speed c 1 each being one particular approximation of the wave s behaviour that being said the wave trains in simref are appropriately modelled as kdv or ekdv isws which confirms i the propagation of interfacial troughs as trains of solitons and ii croco s ability to simulate the subtle balance between nonhydrostatic effects responsible for dispersion and nonlinear advection 
