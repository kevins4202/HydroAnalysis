index,text
25835,present study links physical habitat simulation with the irrigation loss function to assess optimal environmental flow regime the main motivation is lack of optimization framework in the structure of reliable environmental flow methods such as physical habitat simulation data driven model was used to simulate physical habitats moreover a multi objective particle swarm optimization was utilized to optimize environmental flow regime by considering two objective functions including weighted useable area function and normalized benefit function for irrigation demand based on results physical habitat data driven model was robust to assess habitat suitability moreover proposed multi objective optimization model is able to assess environmental flow properly in the case study physical habitat impact was minimized to 30 that means 70 of useable habitats would be protected in contrast 60 of maximum requested water demand would be supplied which implies a fair balance between demand and environmental flow keywords physical habitat adaptive neuro fuzzy inference system particle swarm optimization multi objective two dimensional hydraulic model 1 introduction vital role of rivers as a main surface water resource to supply drinking irrigation and industrial water demands has been identified from many years ago due to higher population and economic activities in future years increasing offstream is expected which means instream flow would be reduced consequently postel 1998 given the serious concerns regarding damages to river ecosystems concept of environmental flow regime has been defined that may guarantee sustainable ecological status of river tharme 2003 in other words environmental flow regime mainly protects aquatic habitats which could be assessed by different methods including historic flow methods hydraulic rating methods and habitat methods jowett 1997 habitat approach as the best practice in assessment of environmental flow includes many methods such as instream flow incremental methodology ifim and building block methodology bbm payne and jowett 2013 king et al 2000 ifim is a qualified process to manage environmental impacts of water resources projects in which physical habitat simulation is an important factor in fact physical habitat simulation has been introduced as reliable tool to assess river habitats and environmental flow stalnaker 1994 using diversion dams is prevalent to divert flow toward urban and agricultural lands it is specifically very applicable for rivers in which construction of large dams is not possible due to technical or economic limitations thus many diversion dams have been constructed all around the world purpose of these structures is to supply regional water demands mainly in close areas hence a serious conflict between stakeholders and environmental managers would be anticipated because stakeholders such as farmers are intended to receive maximum water however environmental requirements may be violated therefore there is a challenge how to allocate environmental flow at downstream of diversion dams it is more important in arid and semi arid regions where water scarcity is a limitation factor for agriculture thus it is required to design an optimal environmental flow regime that is able to cover water demand and environmental requirements as much as possible environmental assessment methods do not sadly include any optimization component to design an applicable environmental flow regime physical habitat simulation originally developed by applying univariate method to assess physical habitat suitability in a river this method has been called univariate because it separately assesses suitability of physical factors without considering combined ecological effects in other words it uses mathematical model to combine suitability of physical parameters in contrast each method that is able to consider combined ecological effects could be considered as multivariate physical habitat assessment method in other word univariate method develops depth velocity and substrate suitability separately in the following combined habitat suitability would be computed using three methods including product minimum and geometric mean waddle 2001 univariate method has however been criticized in the literature due to lack of sufficient robustness to predict suitability of physical habitat such as spawning habitats noack et al 2013 fuzzy multivariate method is another known approach to simulate physical habitats in the rivers that has successfully been utilized in some cases e g mouton et al 2007 jorde et al 2001 marsili libelli et al 2013 main limitation on its application is to develop physical habitat fuzzy rules because it is essential to have remarkable expert s knowledge for development of correct habitat fuzzy rules however it is not possible in many cases due to lack of ecological knowledge on many fish species it seems that development of habitat suitability criteria must be based on actual observations and considering main physical factors such as depth and velocity simultaneously hence data driven models are perfect tools to develop a robust physical habitat model new computers with high computational powers were a revolution to carry out complex computations in many branches of engineering data driven models such as artificial neural networks anns or fuzzy inference systems fiss have been used in river and environmental engineering lobbrecht et al 2002 for example these models have been utilized to optimize reservoir operation or runoff forecasting e g chandramouli and deka 2005 zhang et al 2018a b chang and chang 2006 nourani et al 2009 anns and fiss suffer from some inherent deficits that have been addressed in the literature dumitru and maria 2013 atmaca et al 2001 hence neuro fuzzy inference systems nfiss improved them by putting neural network in a fuzzy inference system adaptive neuro fuzzy inference system anfis is one of the applicable and known combined networks that has successfully been used for prediction of non observed data jang 1993 data driven models have been applied in different problems of water science for example najafzadeh and tafarojnoruz 2016 applied neuro fuzzy based group method of data handling to evaluate the longitudinal dispersion coefficient in rivers their model was improved through particle swarm optimization results demonstrated that proposed model is robust to predict longitudinal dispersion coefficient moreover najafzadeh et al 2017 used data driven model to predict local scour depth downstream of sluice gates results showed more reliability compared with conventional equations another example of applying data driven models in water science is prediction of riprap stone size najafzadeh et al 2018 data driven models have rarely been addressed as physical habitat model in the literature e g im et al 2018 jung and choi 2015 zhao et al 2013 previous studies used hybrid algorithm for training model either practical protection of river habitats or environmental flow assessment needs a reliable optimization framework that should be able to present optimal daily or monthly environmental flow in other words an optimal environmental flow must not only maximize environmental benefits but it must be also able to maximize water demand benefits for stakeholders in fact it must be able to provide a counterbalance between environmental requirements and water demands hence a multiobjective optimization model is a requirement for designing environmental flow regime multiobjective optimization is relatively known method to solve optimization problems that has been addressed for different problems such as reservoir operation guo et al 2013 si et al 2019 we focused on the using multi objective particle swarm optimization mopso in the present study hence it is essential to review some previous studies regarding using this algorithm hu et al 2020 used mopso for feature selection by fuzzy cost moreover zhang et al 2012 developed a bare bones multi objective particle swarm optimization algorithm for environmental economic dispatch mopso has been utilized for building energy performance successfully yong et al 2020 zhang et al 2018a b developed a decomposition based archiving approach for multi objective evolutionary optimization different applications of mopso in the literature demonstrate its robustness for engineering problems present study proposes a coupled pso anfis based physical habitat model and multiobjective optimization model to optimize environmental flow in the first step we developed pso anfis based habitat model to simulate physical habitats in the second step habitat hydraulic function has been developed using linked anfis habitat model 2d hydrodynamic model in the third step an irrigation demand function was developed then a multi objective optimization model has been implemented to maximize two objective functions finally analysis on results of optimal environmental flow was carried out the main novelty of present study is development of a new framework to assess environmental flow at downstream of diversion dams in which three components have been coupled to improve assessment of environmental flow including anfis based physical habitat model benefit function of farming and a multiobjective evolutionary algorithm in other words proposed framework opens a new window to assess environmental flow by a complex optimization process it should be noted that proposed physical habitat based methods to assess environmental flow in the previous studies have a significant drawback which is lack of optimization framework in the structure of method present study covers this drawback by presenting a novel framework proposed method could be considered as powerful tool to optimize environmental flow regime at the downstream of diversion dams 2 application and methodology 2 1 study area and field observations proposed method has been utilized in the tajan river basin as one of the most important rivers in southern caspian sea basin this river is responsible for supply of irrigation demand in the region a diversion dam has been constructed in the sary city where is accountable for water supply of vast farms in this area main crop in this river basin is rice that means this crop could be considered as representative crop for assessment of agricultural water demand fig 1 displays location of tajan river basin populated irrigated farms could be seen at downstream of sari diversion dam owing to importance of downstream habitats protection of these aquatic habitats is essential as well as supply of irrigation water demand in other words optimizing of water demand for agriculture and environment is necessary based initial ecological studies capoeta was selected as target species more detail on this species has been addressed in the literature kiabi et al 1999 abdoli et al 2008 fish observation and measurement of depth and velocity in microhabitats were required field studies sampling methods classified in two groups including direct and indirect methods each method might have its own strength and drawbacks harby et al 2004 for example video telemetry is a direct method for observing fish in actual fish habitats however it is not useable in turbid waters in contrast electrofishing is an applicable indirect method for sampling we applied electrofishing due to previous experience on its application and its advantages we utilized minimum voltage to reduce environmental impacts velocity has been measured using propeller as well as depth using large metal ruler harby et al 2004 2 2 architecture of data driven physical habitat model three main physical factors may usually be taken into account to simulate physical habitats including depth velocity and substrate sedighkia et al 2017 however we only considered depth and velocity due to some technical considerations first bed particle size in representative reach was relatively similar in different parts that means effect of substrate on habitat suitability was not probable moreover our observations in other parts of river indicated that physical habitat suitability for target species is mainly depended on depth and velocity as key hydraulic characteristics hence data driven physical habitat model was finalized based on depth and velocity main features of developed network has been displayed in table 1 moreover we used particle swarm optimization pso which is a robust evolutionary algorithm to train anfis based habitat model eberhart and kennedy 1995 pso anifs flowchart is shown in fig 2 it should be noted that 80 of sampled data was used to train data driven model which means 20 of data was utilized to test and verify habitat model in fact 200 points were measured in different parts of river to develop physical habitat model 160 points was used for training and 40 was used for testing nash sutcliffe model efficiency coefficient nse and root mean square error rmse were utilized to measure performance of data driven model nse 1 means model is perfect regarding predictive skill however nse more than 0 5 demonstrates acceptable predictive skills for the model mccuen et al 2006 equation 1 displays mathematical definition of this index in the present study nse is a robust index to measure predictive skills of model that might be utilized in different simulation processes such as physical habitat simulation however it is initially developed for hydrological modeling 1 n s e 1 i 1 t m i o i i 1 t m i o m where m is modelled habitat suitability an o is observed or recorded habitat suitability equation 2 displays mathematical definition for rmse 2 r m s e i 1 t m i o i 2 t 2 3 habitat hydraulic model coupled pso anfis habitat model 2d hydraulic model is able to simulate physical habitat suitability we selected a representative reach to simulate physical habitat then digital elevation model dem of main channel and flood plain was provided by data bank of department of environment finally two dimensional hydraulic modelling was carried out using hec ras 2d which is a known model to simulate depth and velocity in rivers brunner 2016 recent studies corroborated efficiency of hec ras 2d to simulate habitat hydraulics more detail on its method and application for habitat hydraulic modelling is available in the literature papaioannou et al 2020 moreover we used weighted useable area concept to assess suitability of physical habitat as displayed in equation 3 3 w u a i 1 i n h s i i a i l 1000 where a is area of each habitat cell l is total length of reach and hsi is habitat suitability index in each cell equation 3 computes wua in each 1000 m of river reach which is properly able to demonstrate physical habitat suitability hsi is outcome of combining simulated depth and velocity with anfis based habitat model in other words anfis based habitat model computes suitability by considering simulated depth and velocity in each cell based on results of habitat suitability for all of the cells weighted useable area is computed by equation 3 for simulated river reach an important point should be noted regarding 2d hydraulic modelling calibration of 2d models is usually difficult in the present study extensive field studies were helpful to calibrate 2d hydraulic model in other words depth and velocity were measured in different cross sections of the simulated river reach we measured depth and velocity along different cross sections by propeller and large metal ruler moreover flowrate was measured by sub division methods it should be noted that this study was part of a comprehensive project in this river basin thus measurements were carried out in several days in a year that provided an appropriate data bank of depth and velocity in different cross sections in other words depth and velocity distributions were provided in different flows then collected data was utilized to calibrate 2d hydraulic model by comparing results of model with the observed depths and velocities in each cross section and revising calibration parameters such as manning coefficient 2 4 optimization model multi objective optimization by particle swarm optimization method mopso has been used in many previous studies for hydro environment systems reddy and kumar 2007 niu et al 2018 hence extensive description on its method has been addressed in the literature fig 3 displays mopso flowchart that has been utilized in the present study coello et al 2004 two objective functions were defined first function was defined to maximize normalized weighted useable area moreover second function was defined to maximize irrigation demand or benefits from the rice fields as the main crop in the river basin used objective functions have been displayed in equations 4 6 we considered a direct and linear relationship between irrigation demand and benefits from the farms in the present study 4 z 1 t 1 t n w u a t t 1 t f q e t 5 z 2 t 1 t n b t t 1 t g q t t q e t 6 z z 1 z 2 where nwua is normalized weighted useable area that is between zero and one qe is environmental flow qt is total available flow in the river nb is normalized benefit from current agricultural activities with focus on the rice fields as a more description on optimization model it has two objectives the first objective is to maximize protection from downstream habitats the second objective is to maximize benefits for the farms for the first objective it is required to maximize normalized weighted useable area function flow rate of maximum possible nwua was defined as ideal environmental flow for further analysis on the other hand normalized benefit function was defined based on maximum requested water demand for the rice farms in fact main limitation for agriculture in the study area was lack of sufficient water nb 100 means maximum requested water demand is supplied in contrast nb 0 means no water is available for farms it was essential to use some indices to measure system performance of environmental flow optimization model as presented ideal environmental flow provides the highest physical habitat suitability in other words physical habitat impacts are close to zero two indices were developed which has been called reliability and vulnerability indices as displayed in equations 7 and 8 7 α e t 1 t a e t t 1 t i e t 8 γ e m a x t 1 t i e t a e t i e t where ae is actual environmental flow and ie is ideal environmental flow it should be noted ie means environmental flow in which wua is maximum in fact it is peak point of wua curve these indices have originally been developed to measure system performance of reservoir operation optimization models e g ehteram et al 2018 fig 4 displays how we utilized mopso to optimize environmental flow in the present study two constraints were considered in the optimization system including upper limit and lower limit for environmental flow upper limit is natural flow in the simulated period and lower limit is minimum environmental flow 3 results and discussion fig 5 displays depth and velocity distribution of sampled microhabitats which has been utilized in the testing process of physical habitat model it seems that provided data bank for testing process of habitat model is sufficient because it covers a wide range of microhabitats depth range is between 0 2 and 1 4 m as well as velocity which is between 0 3 and 1 2 m s in other words diversity of microhabitats in terms of depth and velocity demonstrated that results of testing is reliable and data driven habitat model could be used for further applications fig 6 displays habitat suitability by pso anfis habitat model and recorded microhabitats it demonstrates that model is robust to simulate physical habitats based on computations nse is 0 93 which corroborates robustness of physical habitat model moreover rmse is 0 009 which indicates high accuracy of physical habitat model hence proposed pso anfis model could be utilized for the optimization model in the next step presenting results of habitat hydraulic simulation is necessary figs 7 and 8 display depth and velocity distribution respectively in some simulated flows alteration of depth and width of river reach could be observed by changing flow in the lowest simulated flow depth would be less than 1 65 m whereas increasing depth could be observed to 2 21 m which means increase in depth might not be very remarkable due to geometric characteristics of simulated reach it should however be noted that this change is considerable for habitats in other words it can dramatically affect physical habitat suitability of stream fig 9 has displayed habitat suitability maps it demonstrates that incrementing rate of flow may increase total available habitat area however some habitats are unsuitable especially close to centreline of streams because increasing of velocity significantly affect habitat suitability hence by increasing discharge suitable habitats mainly are located near to stream banks interestingly low discharges such as 1 cms and 5 cms provide suitable habitats for target species high flow rates including 21 25 and 30 cms are not appropriate for target species however it should be noted that these flows are probable during flood seasons furthermore fig 10 shows developed nwua function equation 9 displays conditional form of nwua that has directly been used in the programming of optimization model based on available agricultural data hydro module irrigation was calculated normalized benefit function of regional agricultural activities was computed based on assuming direct and linear relationship between irrigation demand and economic benefit as displayed in equation 10 where x is continuous discharge image 1 10 n b 0 0083 x 2 0 1818 x 0 0015 fig 11 displays non dominated solutions for used objective functions the best solution provides minimum distance between nwua and nb at z 0 7387 0 5722 fig 12 as direct output of optimization model shows daily environmental flow proposed by multiobjective optimization model unit of flow is cubic meters per second cms or m3 s furthermore available flow and supplied water demand are shown in this figure it should be noted that a minimum environmental flow has been considered in development of optimization model which provides minimum required protection from the habitats in all of the time steps this flow was considered 0 7 cms approximately this value was defined based on opinion by an experienced ecologist in fact minimum required physical habitat suitability was defined 45 that is equal to 0 7 cms management of environmental flow and agricultural water demand are practically monthly thus it is essential to convert daily flow to monthly flow to measure performance of optimization model fig 13 displays monthly optimal environmental flow regime total available flow and optimal water demand respectively results demonstrate that mopso is able to propose an optimal regime for environmental flow and water demand measurement of system performance demonstrated half of ideal environmental flow could be supplied for river habitats it sounds that proposed method is reliable to assess environmental flow because supply of ideal environmental flow is not naturally possible due to natural changes of river flow supply of half of ideal annual environmental flow demonstrates that developed model is reliable for further studies moreover vulnerability index indicates maximum deviation from ideal environmental flow is 55 in the next step it is essential to compare results of the present study with the previous assessments in the case study tennant 1976 developed a method to assess environmental flow based on environmental observations in some rivers of the united states tennant is an old method newer methods have been developed in the recent decades such as physical habitat simulation and building block methodology however newer methods are not officially in use due to complexities to use these methods in practical projects and lack of enough experts for these methods in many developing countries such as iran tennant method is accepted method by iranian ministry of energy and previous environmental flow studies have been carried out by this method we used this method for comparing current used method in this river basin with proposed advanced method moreover tennant method provides appropriate initial estimation on environmental flow tennant s recommendations are based on assessing environmental flow as a proportion of mean annual flow in different months different statuses were considered including poor good and outstanding based on tennant method poor status means least protection of river habitat outstanding status means offstream flow is minimized and protection is maximized in the river comparison is helpful to compare proposed ecological status by optimal environmental flow with the natural river flow regime fig 14 displays monthly proposed environmental flow compared with tennant method optimization model proposed environmental flow regime much more than poor status that means assessed environmental flow is reliable moreover it is much lower than outstanding status in some months that means it is able to consider required water demand properly in other words environmental flow has not been overestimated assessed environmental flow is close to good status especially in april september environmental flow by tennant for outstanding and good statuses have considerably reduced in some months hence optimal environmental flow is closer to outstanding ecological river status fig 15 displays annual environmental flow by proposed optimization method and different statuses by tennant method it demonstrates that proposed method provides environmental flow equal to good or outstanding ecological status fig 16 average nwua is 0 7 that means proposed multiobjective optimization model is able to protect physical habitats properly in fact it is able to provide 70 of maximum it seems that proposed method provides proper ecological status for the river ecosystem because river might have unsuitable habitats in natural flow thus performance of optimization model is acceptable maximum requested water demand is 208 mcm and supplied demand by the proposed optimization system is 125 mcm it demonstrates that optimization model is able to protect 60 of economic profits in other words more than half of agricultural water demand has been supplied it should be noted that a direct and linear relationship between irrigation demand and economic profit was assumed in the present study optimization model provides a balance between environmental requirements and water demands using proposed method is recommendable to assess environmental flow regime the most important advantage of proposed method is to enhance reliability of environmental flow assessment method by an optimization framework some points must be discussed to clarify advantages of the proposed method in other words why the proposed strategy mechanism can achieve good results considering a robust function for environmental requirement of the river ecosystem is one of the main reasons for robustness of proposed framework in fact physical habitat suitability is a clear definition on suitability of habitats in a stream hence applying weighted useable area function in the structure of the optimization model demonstrates applicability of proposed method for the future studies moreover proposed method is able to consider requirements for the environment and benefits for the farms simultaneously previous environmental flow assessment methods lack ability of optimizing instream flow we assumed that scarcity of water is the main limitation in development of benefit function that is a correct assumption for many arid areas furthermore using a robust multiobjective optimization method is another reason for achieving good results because optimizing environmental flow in each time step might be complex that needs a robust optimization solution optimization algorithm was able to maximize objective functions in the simulated period well it is required to discuss on computational complexities of the proposed method to optimize environmental flow as a general definition on computational complexities it is the amount of resources required to run it with focus on time and memory requirements low computational time might be the most advantages for the proposed framework because our experience demonstrates that it is efficient in terms of computational time in short term simulation period however covering long term simulation period might need considerable time it seems that implementing more complex framework might increase computational time as a disadvantage it should be noted that practical projects need numerous simulations hence computational time must be noticed in the application of proposed framework moreover performance of proposed optimization model is efficient in terms of memory requirement to sum up it seems that low computational complexity is an advantage for the proposed method limitations of proposed method should be noted for the future studies field studies is one of the limitations for applying method because required field studies might be expensive and time consuming moreover we used a linear relationship between economic benefits and irrigation demand based on requirements of case study however it is not correct for all of the cases that is another limitation in the proposed framework furthermore absence of considering requirements for water quality is another limitation for the proposed framework it seems that these limitations must be considered in the future studies to improve optimization model in other words we recommend focusing on methods to reduce costs of field studies considering water quality requirements and improving benefit function in the future studies it should be noted that proposed method is based on environmental values of river ecosystem and water demand by agriculture however using this method in other application might need some improvements for example if diversion project is utilized for supply of urban water it will be needed to add loss function of urban water supply to the optimization system in fact proposed method was defined based on two principal aspects for the river engineering projects including suitability of aquatic habitats at the downstream of diversion dam as environmental requirement and supply of irrigation demand in the study area using proposed framework for supply of urban water needs development of urban water loss function 4 conclusion present study proposed a multi objective optimization method to minimize physical habitat impacts at downstream of diversion dams two main components including pso anfis habitat model and multiobjective optimization model were considered this system is able to optimize environmental flow regime by considering two targets including maximizing normalized weighted useable area and normalized benefits simultaneously as a result pso anfis method was robust to simulate physical habitats nash sutcliffe model efficiency coefficient and root means square error demonstrated that predictive skill of anfis based physical habitat model is acceptable moreover mopso optimized environmental flow regime well monthly environmental flow regime analysis indicated 70 of maximum available useable area is available for target species furthermore performance of model to optimize water demand was acceptable because it could protect 60 of maximum agricultural benefits in the study area we recommend focusing on adding water quality requirements to the optimization model improvement of benefit function for the urban water demand and using other relationship between economic benefit and irrigation demand in the future studies we recommend utilizing proposed framework at downstream of water diversion projects declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
25835,present study links physical habitat simulation with the irrigation loss function to assess optimal environmental flow regime the main motivation is lack of optimization framework in the structure of reliable environmental flow methods such as physical habitat simulation data driven model was used to simulate physical habitats moreover a multi objective particle swarm optimization was utilized to optimize environmental flow regime by considering two objective functions including weighted useable area function and normalized benefit function for irrigation demand based on results physical habitat data driven model was robust to assess habitat suitability moreover proposed multi objective optimization model is able to assess environmental flow properly in the case study physical habitat impact was minimized to 30 that means 70 of useable habitats would be protected in contrast 60 of maximum requested water demand would be supplied which implies a fair balance between demand and environmental flow keywords physical habitat adaptive neuro fuzzy inference system particle swarm optimization multi objective two dimensional hydraulic model 1 introduction vital role of rivers as a main surface water resource to supply drinking irrigation and industrial water demands has been identified from many years ago due to higher population and economic activities in future years increasing offstream is expected which means instream flow would be reduced consequently postel 1998 given the serious concerns regarding damages to river ecosystems concept of environmental flow regime has been defined that may guarantee sustainable ecological status of river tharme 2003 in other words environmental flow regime mainly protects aquatic habitats which could be assessed by different methods including historic flow methods hydraulic rating methods and habitat methods jowett 1997 habitat approach as the best practice in assessment of environmental flow includes many methods such as instream flow incremental methodology ifim and building block methodology bbm payne and jowett 2013 king et al 2000 ifim is a qualified process to manage environmental impacts of water resources projects in which physical habitat simulation is an important factor in fact physical habitat simulation has been introduced as reliable tool to assess river habitats and environmental flow stalnaker 1994 using diversion dams is prevalent to divert flow toward urban and agricultural lands it is specifically very applicable for rivers in which construction of large dams is not possible due to technical or economic limitations thus many diversion dams have been constructed all around the world purpose of these structures is to supply regional water demands mainly in close areas hence a serious conflict between stakeholders and environmental managers would be anticipated because stakeholders such as farmers are intended to receive maximum water however environmental requirements may be violated therefore there is a challenge how to allocate environmental flow at downstream of diversion dams it is more important in arid and semi arid regions where water scarcity is a limitation factor for agriculture thus it is required to design an optimal environmental flow regime that is able to cover water demand and environmental requirements as much as possible environmental assessment methods do not sadly include any optimization component to design an applicable environmental flow regime physical habitat simulation originally developed by applying univariate method to assess physical habitat suitability in a river this method has been called univariate because it separately assesses suitability of physical factors without considering combined ecological effects in other words it uses mathematical model to combine suitability of physical parameters in contrast each method that is able to consider combined ecological effects could be considered as multivariate physical habitat assessment method in other word univariate method develops depth velocity and substrate suitability separately in the following combined habitat suitability would be computed using three methods including product minimum and geometric mean waddle 2001 univariate method has however been criticized in the literature due to lack of sufficient robustness to predict suitability of physical habitat such as spawning habitats noack et al 2013 fuzzy multivariate method is another known approach to simulate physical habitats in the rivers that has successfully been utilized in some cases e g mouton et al 2007 jorde et al 2001 marsili libelli et al 2013 main limitation on its application is to develop physical habitat fuzzy rules because it is essential to have remarkable expert s knowledge for development of correct habitat fuzzy rules however it is not possible in many cases due to lack of ecological knowledge on many fish species it seems that development of habitat suitability criteria must be based on actual observations and considering main physical factors such as depth and velocity simultaneously hence data driven models are perfect tools to develop a robust physical habitat model new computers with high computational powers were a revolution to carry out complex computations in many branches of engineering data driven models such as artificial neural networks anns or fuzzy inference systems fiss have been used in river and environmental engineering lobbrecht et al 2002 for example these models have been utilized to optimize reservoir operation or runoff forecasting e g chandramouli and deka 2005 zhang et al 2018a b chang and chang 2006 nourani et al 2009 anns and fiss suffer from some inherent deficits that have been addressed in the literature dumitru and maria 2013 atmaca et al 2001 hence neuro fuzzy inference systems nfiss improved them by putting neural network in a fuzzy inference system adaptive neuro fuzzy inference system anfis is one of the applicable and known combined networks that has successfully been used for prediction of non observed data jang 1993 data driven models have been applied in different problems of water science for example najafzadeh and tafarojnoruz 2016 applied neuro fuzzy based group method of data handling to evaluate the longitudinal dispersion coefficient in rivers their model was improved through particle swarm optimization results demonstrated that proposed model is robust to predict longitudinal dispersion coefficient moreover najafzadeh et al 2017 used data driven model to predict local scour depth downstream of sluice gates results showed more reliability compared with conventional equations another example of applying data driven models in water science is prediction of riprap stone size najafzadeh et al 2018 data driven models have rarely been addressed as physical habitat model in the literature e g im et al 2018 jung and choi 2015 zhao et al 2013 previous studies used hybrid algorithm for training model either practical protection of river habitats or environmental flow assessment needs a reliable optimization framework that should be able to present optimal daily or monthly environmental flow in other words an optimal environmental flow must not only maximize environmental benefits but it must be also able to maximize water demand benefits for stakeholders in fact it must be able to provide a counterbalance between environmental requirements and water demands hence a multiobjective optimization model is a requirement for designing environmental flow regime multiobjective optimization is relatively known method to solve optimization problems that has been addressed for different problems such as reservoir operation guo et al 2013 si et al 2019 we focused on the using multi objective particle swarm optimization mopso in the present study hence it is essential to review some previous studies regarding using this algorithm hu et al 2020 used mopso for feature selection by fuzzy cost moreover zhang et al 2012 developed a bare bones multi objective particle swarm optimization algorithm for environmental economic dispatch mopso has been utilized for building energy performance successfully yong et al 2020 zhang et al 2018a b developed a decomposition based archiving approach for multi objective evolutionary optimization different applications of mopso in the literature demonstrate its robustness for engineering problems present study proposes a coupled pso anfis based physical habitat model and multiobjective optimization model to optimize environmental flow in the first step we developed pso anfis based habitat model to simulate physical habitats in the second step habitat hydraulic function has been developed using linked anfis habitat model 2d hydrodynamic model in the third step an irrigation demand function was developed then a multi objective optimization model has been implemented to maximize two objective functions finally analysis on results of optimal environmental flow was carried out the main novelty of present study is development of a new framework to assess environmental flow at downstream of diversion dams in which three components have been coupled to improve assessment of environmental flow including anfis based physical habitat model benefit function of farming and a multiobjective evolutionary algorithm in other words proposed framework opens a new window to assess environmental flow by a complex optimization process it should be noted that proposed physical habitat based methods to assess environmental flow in the previous studies have a significant drawback which is lack of optimization framework in the structure of method present study covers this drawback by presenting a novel framework proposed method could be considered as powerful tool to optimize environmental flow regime at the downstream of diversion dams 2 application and methodology 2 1 study area and field observations proposed method has been utilized in the tajan river basin as one of the most important rivers in southern caspian sea basin this river is responsible for supply of irrigation demand in the region a diversion dam has been constructed in the sary city where is accountable for water supply of vast farms in this area main crop in this river basin is rice that means this crop could be considered as representative crop for assessment of agricultural water demand fig 1 displays location of tajan river basin populated irrigated farms could be seen at downstream of sari diversion dam owing to importance of downstream habitats protection of these aquatic habitats is essential as well as supply of irrigation water demand in other words optimizing of water demand for agriculture and environment is necessary based initial ecological studies capoeta was selected as target species more detail on this species has been addressed in the literature kiabi et al 1999 abdoli et al 2008 fish observation and measurement of depth and velocity in microhabitats were required field studies sampling methods classified in two groups including direct and indirect methods each method might have its own strength and drawbacks harby et al 2004 for example video telemetry is a direct method for observing fish in actual fish habitats however it is not useable in turbid waters in contrast electrofishing is an applicable indirect method for sampling we applied electrofishing due to previous experience on its application and its advantages we utilized minimum voltage to reduce environmental impacts velocity has been measured using propeller as well as depth using large metal ruler harby et al 2004 2 2 architecture of data driven physical habitat model three main physical factors may usually be taken into account to simulate physical habitats including depth velocity and substrate sedighkia et al 2017 however we only considered depth and velocity due to some technical considerations first bed particle size in representative reach was relatively similar in different parts that means effect of substrate on habitat suitability was not probable moreover our observations in other parts of river indicated that physical habitat suitability for target species is mainly depended on depth and velocity as key hydraulic characteristics hence data driven physical habitat model was finalized based on depth and velocity main features of developed network has been displayed in table 1 moreover we used particle swarm optimization pso which is a robust evolutionary algorithm to train anfis based habitat model eberhart and kennedy 1995 pso anifs flowchart is shown in fig 2 it should be noted that 80 of sampled data was used to train data driven model which means 20 of data was utilized to test and verify habitat model in fact 200 points were measured in different parts of river to develop physical habitat model 160 points was used for training and 40 was used for testing nash sutcliffe model efficiency coefficient nse and root mean square error rmse were utilized to measure performance of data driven model nse 1 means model is perfect regarding predictive skill however nse more than 0 5 demonstrates acceptable predictive skills for the model mccuen et al 2006 equation 1 displays mathematical definition of this index in the present study nse is a robust index to measure predictive skills of model that might be utilized in different simulation processes such as physical habitat simulation however it is initially developed for hydrological modeling 1 n s e 1 i 1 t m i o i i 1 t m i o m where m is modelled habitat suitability an o is observed or recorded habitat suitability equation 2 displays mathematical definition for rmse 2 r m s e i 1 t m i o i 2 t 2 3 habitat hydraulic model coupled pso anfis habitat model 2d hydraulic model is able to simulate physical habitat suitability we selected a representative reach to simulate physical habitat then digital elevation model dem of main channel and flood plain was provided by data bank of department of environment finally two dimensional hydraulic modelling was carried out using hec ras 2d which is a known model to simulate depth and velocity in rivers brunner 2016 recent studies corroborated efficiency of hec ras 2d to simulate habitat hydraulics more detail on its method and application for habitat hydraulic modelling is available in the literature papaioannou et al 2020 moreover we used weighted useable area concept to assess suitability of physical habitat as displayed in equation 3 3 w u a i 1 i n h s i i a i l 1000 where a is area of each habitat cell l is total length of reach and hsi is habitat suitability index in each cell equation 3 computes wua in each 1000 m of river reach which is properly able to demonstrate physical habitat suitability hsi is outcome of combining simulated depth and velocity with anfis based habitat model in other words anfis based habitat model computes suitability by considering simulated depth and velocity in each cell based on results of habitat suitability for all of the cells weighted useable area is computed by equation 3 for simulated river reach an important point should be noted regarding 2d hydraulic modelling calibration of 2d models is usually difficult in the present study extensive field studies were helpful to calibrate 2d hydraulic model in other words depth and velocity were measured in different cross sections of the simulated river reach we measured depth and velocity along different cross sections by propeller and large metal ruler moreover flowrate was measured by sub division methods it should be noted that this study was part of a comprehensive project in this river basin thus measurements were carried out in several days in a year that provided an appropriate data bank of depth and velocity in different cross sections in other words depth and velocity distributions were provided in different flows then collected data was utilized to calibrate 2d hydraulic model by comparing results of model with the observed depths and velocities in each cross section and revising calibration parameters such as manning coefficient 2 4 optimization model multi objective optimization by particle swarm optimization method mopso has been used in many previous studies for hydro environment systems reddy and kumar 2007 niu et al 2018 hence extensive description on its method has been addressed in the literature fig 3 displays mopso flowchart that has been utilized in the present study coello et al 2004 two objective functions were defined first function was defined to maximize normalized weighted useable area moreover second function was defined to maximize irrigation demand or benefits from the rice fields as the main crop in the river basin used objective functions have been displayed in equations 4 6 we considered a direct and linear relationship between irrigation demand and benefits from the farms in the present study 4 z 1 t 1 t n w u a t t 1 t f q e t 5 z 2 t 1 t n b t t 1 t g q t t q e t 6 z z 1 z 2 where nwua is normalized weighted useable area that is between zero and one qe is environmental flow qt is total available flow in the river nb is normalized benefit from current agricultural activities with focus on the rice fields as a more description on optimization model it has two objectives the first objective is to maximize protection from downstream habitats the second objective is to maximize benefits for the farms for the first objective it is required to maximize normalized weighted useable area function flow rate of maximum possible nwua was defined as ideal environmental flow for further analysis on the other hand normalized benefit function was defined based on maximum requested water demand for the rice farms in fact main limitation for agriculture in the study area was lack of sufficient water nb 100 means maximum requested water demand is supplied in contrast nb 0 means no water is available for farms it was essential to use some indices to measure system performance of environmental flow optimization model as presented ideal environmental flow provides the highest physical habitat suitability in other words physical habitat impacts are close to zero two indices were developed which has been called reliability and vulnerability indices as displayed in equations 7 and 8 7 α e t 1 t a e t t 1 t i e t 8 γ e m a x t 1 t i e t a e t i e t where ae is actual environmental flow and ie is ideal environmental flow it should be noted ie means environmental flow in which wua is maximum in fact it is peak point of wua curve these indices have originally been developed to measure system performance of reservoir operation optimization models e g ehteram et al 2018 fig 4 displays how we utilized mopso to optimize environmental flow in the present study two constraints were considered in the optimization system including upper limit and lower limit for environmental flow upper limit is natural flow in the simulated period and lower limit is minimum environmental flow 3 results and discussion fig 5 displays depth and velocity distribution of sampled microhabitats which has been utilized in the testing process of physical habitat model it seems that provided data bank for testing process of habitat model is sufficient because it covers a wide range of microhabitats depth range is between 0 2 and 1 4 m as well as velocity which is between 0 3 and 1 2 m s in other words diversity of microhabitats in terms of depth and velocity demonstrated that results of testing is reliable and data driven habitat model could be used for further applications fig 6 displays habitat suitability by pso anfis habitat model and recorded microhabitats it demonstrates that model is robust to simulate physical habitats based on computations nse is 0 93 which corroborates robustness of physical habitat model moreover rmse is 0 009 which indicates high accuracy of physical habitat model hence proposed pso anfis model could be utilized for the optimization model in the next step presenting results of habitat hydraulic simulation is necessary figs 7 and 8 display depth and velocity distribution respectively in some simulated flows alteration of depth and width of river reach could be observed by changing flow in the lowest simulated flow depth would be less than 1 65 m whereas increasing depth could be observed to 2 21 m which means increase in depth might not be very remarkable due to geometric characteristics of simulated reach it should however be noted that this change is considerable for habitats in other words it can dramatically affect physical habitat suitability of stream fig 9 has displayed habitat suitability maps it demonstrates that incrementing rate of flow may increase total available habitat area however some habitats are unsuitable especially close to centreline of streams because increasing of velocity significantly affect habitat suitability hence by increasing discharge suitable habitats mainly are located near to stream banks interestingly low discharges such as 1 cms and 5 cms provide suitable habitats for target species high flow rates including 21 25 and 30 cms are not appropriate for target species however it should be noted that these flows are probable during flood seasons furthermore fig 10 shows developed nwua function equation 9 displays conditional form of nwua that has directly been used in the programming of optimization model based on available agricultural data hydro module irrigation was calculated normalized benefit function of regional agricultural activities was computed based on assuming direct and linear relationship between irrigation demand and economic benefit as displayed in equation 10 where x is continuous discharge image 1 10 n b 0 0083 x 2 0 1818 x 0 0015 fig 11 displays non dominated solutions for used objective functions the best solution provides minimum distance between nwua and nb at z 0 7387 0 5722 fig 12 as direct output of optimization model shows daily environmental flow proposed by multiobjective optimization model unit of flow is cubic meters per second cms or m3 s furthermore available flow and supplied water demand are shown in this figure it should be noted that a minimum environmental flow has been considered in development of optimization model which provides minimum required protection from the habitats in all of the time steps this flow was considered 0 7 cms approximately this value was defined based on opinion by an experienced ecologist in fact minimum required physical habitat suitability was defined 45 that is equal to 0 7 cms management of environmental flow and agricultural water demand are practically monthly thus it is essential to convert daily flow to monthly flow to measure performance of optimization model fig 13 displays monthly optimal environmental flow regime total available flow and optimal water demand respectively results demonstrate that mopso is able to propose an optimal regime for environmental flow and water demand measurement of system performance demonstrated half of ideal environmental flow could be supplied for river habitats it sounds that proposed method is reliable to assess environmental flow because supply of ideal environmental flow is not naturally possible due to natural changes of river flow supply of half of ideal annual environmental flow demonstrates that developed model is reliable for further studies moreover vulnerability index indicates maximum deviation from ideal environmental flow is 55 in the next step it is essential to compare results of the present study with the previous assessments in the case study tennant 1976 developed a method to assess environmental flow based on environmental observations in some rivers of the united states tennant is an old method newer methods have been developed in the recent decades such as physical habitat simulation and building block methodology however newer methods are not officially in use due to complexities to use these methods in practical projects and lack of enough experts for these methods in many developing countries such as iran tennant method is accepted method by iranian ministry of energy and previous environmental flow studies have been carried out by this method we used this method for comparing current used method in this river basin with proposed advanced method moreover tennant method provides appropriate initial estimation on environmental flow tennant s recommendations are based on assessing environmental flow as a proportion of mean annual flow in different months different statuses were considered including poor good and outstanding based on tennant method poor status means least protection of river habitat outstanding status means offstream flow is minimized and protection is maximized in the river comparison is helpful to compare proposed ecological status by optimal environmental flow with the natural river flow regime fig 14 displays monthly proposed environmental flow compared with tennant method optimization model proposed environmental flow regime much more than poor status that means assessed environmental flow is reliable moreover it is much lower than outstanding status in some months that means it is able to consider required water demand properly in other words environmental flow has not been overestimated assessed environmental flow is close to good status especially in april september environmental flow by tennant for outstanding and good statuses have considerably reduced in some months hence optimal environmental flow is closer to outstanding ecological river status fig 15 displays annual environmental flow by proposed optimization method and different statuses by tennant method it demonstrates that proposed method provides environmental flow equal to good or outstanding ecological status fig 16 average nwua is 0 7 that means proposed multiobjective optimization model is able to protect physical habitats properly in fact it is able to provide 70 of maximum it seems that proposed method provides proper ecological status for the river ecosystem because river might have unsuitable habitats in natural flow thus performance of optimization model is acceptable maximum requested water demand is 208 mcm and supplied demand by the proposed optimization system is 125 mcm it demonstrates that optimization model is able to protect 60 of economic profits in other words more than half of agricultural water demand has been supplied it should be noted that a direct and linear relationship between irrigation demand and economic profit was assumed in the present study optimization model provides a balance between environmental requirements and water demands using proposed method is recommendable to assess environmental flow regime the most important advantage of proposed method is to enhance reliability of environmental flow assessment method by an optimization framework some points must be discussed to clarify advantages of the proposed method in other words why the proposed strategy mechanism can achieve good results considering a robust function for environmental requirement of the river ecosystem is one of the main reasons for robustness of proposed framework in fact physical habitat suitability is a clear definition on suitability of habitats in a stream hence applying weighted useable area function in the structure of the optimization model demonstrates applicability of proposed method for the future studies moreover proposed method is able to consider requirements for the environment and benefits for the farms simultaneously previous environmental flow assessment methods lack ability of optimizing instream flow we assumed that scarcity of water is the main limitation in development of benefit function that is a correct assumption for many arid areas furthermore using a robust multiobjective optimization method is another reason for achieving good results because optimizing environmental flow in each time step might be complex that needs a robust optimization solution optimization algorithm was able to maximize objective functions in the simulated period well it is required to discuss on computational complexities of the proposed method to optimize environmental flow as a general definition on computational complexities it is the amount of resources required to run it with focus on time and memory requirements low computational time might be the most advantages for the proposed framework because our experience demonstrates that it is efficient in terms of computational time in short term simulation period however covering long term simulation period might need considerable time it seems that implementing more complex framework might increase computational time as a disadvantage it should be noted that practical projects need numerous simulations hence computational time must be noticed in the application of proposed framework moreover performance of proposed optimization model is efficient in terms of memory requirement to sum up it seems that low computational complexity is an advantage for the proposed method limitations of proposed method should be noted for the future studies field studies is one of the limitations for applying method because required field studies might be expensive and time consuming moreover we used a linear relationship between economic benefits and irrigation demand based on requirements of case study however it is not correct for all of the cases that is another limitation in the proposed framework furthermore absence of considering requirements for water quality is another limitation for the proposed framework it seems that these limitations must be considered in the future studies to improve optimization model in other words we recommend focusing on methods to reduce costs of field studies considering water quality requirements and improving benefit function in the future studies it should be noted that proposed method is based on environmental values of river ecosystem and water demand by agriculture however using this method in other application might need some improvements for example if diversion project is utilized for supply of urban water it will be needed to add loss function of urban water supply to the optimization system in fact proposed method was defined based on two principal aspects for the river engineering projects including suitability of aquatic habitats at the downstream of diversion dam as environmental requirement and supply of irrigation demand in the study area using proposed framework for supply of urban water needs development of urban water loss function 4 conclusion present study proposed a multi objective optimization method to minimize physical habitat impacts at downstream of diversion dams two main components including pso anfis habitat model and multiobjective optimization model were considered this system is able to optimize environmental flow regime by considering two targets including maximizing normalized weighted useable area and normalized benefits simultaneously as a result pso anfis method was robust to simulate physical habitats nash sutcliffe model efficiency coefficient and root means square error demonstrated that predictive skill of anfis based physical habitat model is acceptable moreover mopso optimized environmental flow regime well monthly environmental flow regime analysis indicated 70 of maximum available useable area is available for target species furthermore performance of model to optimize water demand was acceptable because it could protect 60 of maximum agricultural benefits in the study area we recommend focusing on adding water quality requirements to the optimization model improvement of benefit function for the urban water demand and using other relationship between economic benefit and irrigation demand in the future studies we recommend utilizing proposed framework at downstream of water diversion projects declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
25836,we present a comprehensive critical review of well established satellite remote sensing water indices and offer a novel robust augmented normalized difference water index andwi andwi employs an expanded set of spectral bands rgb nir and swir1 2 to maximize the contrast between water and non water pixels further we implement a dynamic thresholding method the otsu algorithm to enhance andwi s performance applied to a variety of environmental conditions andwi with otsu thresholding offered the highest overall accuracy accuracy 0 98 f1 0 98 and kappa 0 96 compared to other indices ndwi mndwi awei wi we also propose a novel cloud filtering algorithm that substantially increases the number of useable images compared to the conventional cloud free composites 124 increased observations in the studied area and resolves inappropriate masking of water bodies and hot sands as clouds by conventional methods finally we develop a google earth engine app to readily delineate 16 day surface water bodies across the globe graphical abstract image 1 keywords satellite water mapping spectral index mndwi awei wi landsat 1 introduction land surface water bodies provide crucial ecosystem and societal services saft et al 2016 sohl et al 2019 pourmohamad et al 2019 safarianzengir et al 2020 they are however vulnerable to various climatic and anthropogenic stressors aghakouchak et al 2015 alborzi et al 2018 ashraf et al 2019 mahbod et al 2019 rad et al 2016 2017 understanding the dynamics of water bodies is critical for short term operations and long term planning of water and land management remote sensing provides an inexpensive consistent and accurate approach to monitor changes in surface water using upwelling electromagnetic radiation reflected and emitted from land surfaces schmugge et al 2002 beveridge et al 2020 in the past four decades the application of remote sensing techniques for hydrological monitoring and landscape analysis has significantly increased sadeghi et al 2015 2017 wilson et al 2016 wilson and norman 2018 li et al 2019 mhawej and faour 2020 zhang et al 2020 farahmand et al 2020 numerous remote sensing methodologies have been proposed to map surface water bodies which can be grouped into three general categories huang et al 2018 a density slicing with a threshold bennett 1987 frazier and page 2000 b machine learning classification monegaglia et al 2018 shen and li 2010 tulbure and broich 2013 wright and gallant 2007 and c spectral water indices mcfeeters 1996 feyisa et al 2014 sheng et al 2016 density slicing methods are the simplest form of classification but can be very inaccurate in noise abundant images rees 2013 machine learning classification methods require a large amount of data to train a generalizable model classifier and the training and retraining processes can be computationally demanding hollstein et al 2016 further exporting trained classifiers from one platform to another is cumbersome and requires programming in the target platform baylor et al 2017 spectral water indices on the contrary are computationally inexpensive and easy to implement and can easily transfer across platforms making them an appealing approach to delineate surface water using remotely sensed data zhang et al 2017 several spectral based water indices have been presented in the literature e g crist 1985 xiao et al 2002 guerschman et al 2011 jiang et al 2014 chen et al 2020 mcfeeters 1996 proposed a normalized difference water index ndwi that determines water pixels using the difference in the green and near infrared nir bands xu 2006 however argued that ndwi can result in significant built up land e g asphalt and rooftops in urban areas vegetation and soil noises and proposed a modified ndwi mndwi that uses the difference in the green and shortwave infrared swir bands lacaux et al 2007 proposed a normalized difference pond index that is expressed similar to mndwi except that the band order is reversed danaher and collett 2006 developed a water index wi that uses five bands from top of atmosphere toa landsat reflectance products fisher et al 2016 argued that surface reflectance data would be more accurate for water delineation and used linear discriminant analysis classification to update the wi shen and li 2010 proposed a water ratio index which utilizes the dominance of water spectral reflectance in the green and red bands in comparison to the nir and swir bands finally feyisa et al 2014 introduced two versions of automated water extraction index awei to account for commission errors caused by areas of shadow and dark surfaces with which most classification methods struggle a comprehensive literature review and critical analysis of most widely used spectral water indices indicate that they are prone to misclassification errors under certain scenarios malahlela 2016 rishikeshan and ramesh 2018 wang et al 2015 2018 these errors are pronounced in areas where the background contains low albedo surfaces such as dark vegetation asphalt roads rooftops and shadows feyisa et al 2014 fisher et al 2016 other error prone circumstances include dust storms over water bodies muddy water hydrothermal water and frozen water and ice lacaux et al 2007 li et al 2016 these conditions cause misclassifications because 1 similarity in reflectance patterns of non water features e g rooftops with normal water pixels contributes to increased commission errors and 2 dissimilarity of reflectance properties of water pixels under specific conditions e g muddy water with clear water pixels contributes to increased omission errors yang et al 2020 such circumstances can significantly lower water classification accuracy fisher et al 2016 there also remote sensing derived continental or global maps of water bodies but these products are associated with are some limitations the global surface water explorer pekel et al 2016 is one such product that uses a machine learning classification algorithm to produce a variety of surface water products from 1984 to 2019 this product uses a cloud masking filtering procedure based on expert systems fmask zhu and woodcock 2012 the accuracy of which may be challenged by some features such as water and hot sands find detailed discussion in section 2 8 further this product is not evaluated under challenging environmental conditions e g muddy water more to come later another available product is the dynamic surface water extent which provides classified raster products of open water partial surface water and not water classes for all cloud snow and shadow free landsat 4 8 scenes jones 2015 2019 however the product is only available for the contiguous u s alaska and hawaii this paper builds upon the progress on spectral water indices and advances in cloud computing with google earth engine gee and offers several contributions 1 we propose an augmented normalized difference water index andwi as a robust water delineation index that outperforms other spectral water indices this index was developed based on comprehensive experiments conducted on spectral characteristics of different aquatic and terrestrial land cover types obtained from landsat 4 5 7 and 8 surface reflectance sr tier 1 products andwi successfully suppresses the omission and commission errors caused by land cover e g rooftops and or natural events e g dust storms we also employ the otsu method to automate threshold selection otsu 1979 prost et al 2008 vos et al 2019 this enhances water detection accuracy for any given location and time by tuning a locally relevant threshold 2 we propose a novel cloud filtering algorithm for delineation of water bodies based on functional differences of various spectral water indices this algorithm uses two spectral water indices one classifying clouds as water and the other not the difference in identified surface water area between the two indices is used along with a statistical procedure to remove images in which clouds directly conceal the water body this resolves issues with the state of the art cloud and shadow masking and cloud percentage based image filtering processes issues include 1 creating a cloud free landsat composite or filtering the image collection based on cloud cover percentage of clouds in an image causes loss of images in which water bodies are not directly obscured and could be used and 2 masking clouds using the cloud detection machine learning algorithms such as cfmask foga et al 2017 may result in faulty removal of water pixels as cloud 3 we develop a novel gee app for monitoring historical changes in water bodies this app modaresi rad 2020 provides a 16 day time series of water body areas from 1984 present and allows the user to select an area of interest with choices of different spectral water indices and hard thresholding conventional zero thresholding or dynamic thresholding otsu method 2 methods 2 1 study sites we focus on sites with unique water land and atmospheric features that introduce noise when delineating water bodies with spectral indices selected features increase error rate through omission error water pixels that are not identified as water by the spectral index or reduce precision through commission error non water pixels that are identified as water by the spectral index to this end several water bodies with distinct features were selected to study possible commission errors caused by shadow asphalt paved roads and dark and bright rooftops and omission errors caused by hydrothermal waters ice and dust storms obscuring water bodies fig 1 site 1 is in the city of denver colorado u s a and is an ideal location for studying commission errors due to the existence of different lakes and various low albedo surfaces such as dark rooftops asphalt and building shadows site 2 the blue lagoon is a geothermal power plant and hydrothermal pond located in southwestern iceland and is selected to assess omission errors caused by hydrothermal water bodies sites 3 and 4 are from the hamun lakes located on the border of iran and afghanistan site 3 is an ideal place for studying omission errors caused by muddy water due to frequent flash floods in this monsoon impacted region and site 4 is studied for commission errors introduced by dark vegetation site 5 is the chah nimeh an artificial lake near the hamun lakes and is selected for studying omission errors induced by dust storms over the lake site 6 is the arghandab reservoir located in a mountainous area of afghanistan in this site mountain shadows create an ideal scene for studying commission errors site 7 includes several frozen lakes and areas of abundant ice in tibet that are appropriate for studying omission errors site 8 is nong han lake in thailand where aquatic plants on the water surface create a good site for studying the mixture of dark vegetation and water details of image composition and the number of pixels extracted in each scenario are presented in table s1 see supplementary materials 2 2 remote sensing imagery this study was performed on landsat 8 oli tirs landsat 7 etm landsat 5 etm and landsat 4 etm surface reflectance tier 1 multispectral imagery these datasets are available in the gee cloud storage and computing platform gorelick et al 2017 all landsat surface reflectance products are atmospherically corrected and have undergone geometric and radiometric processing more specifically to produce land surface reflectance the lasrc algorithm was used for landsat 8 oli tirs and the ledaps algorithm was used for landsat 4 7 vermote et al 2016 masek et al 2006 hence spectral reflectance values obtained from these data can be compared across time space or sensor to images that have undergone the same level of correction very high resolution multispectral worldview 2 and worldview 3 imagery with 0 46 m and 0 31 m resolution respectively were considered as ground truth for evaluating the accuracy of spectral water indices and the water bodies derived from landsat 7 and 8 imagery some specific scenarios like dust storms that dissipate quickly were not captured by the worldview imagery and were instead evaluated either with sentinel 2 level 2a and level 1c 10 m resolution or landsat 7 and 8 panchromatic sharpened imagery 15 m resolution for scenarios that include shadows and dust storms we used the enhanced landsat 7 and 8 panchromatic sharpened imagery as ground truth hence there is no difference in image acquisition dates in these scenarios for all other scenarios a maximum of 5 day difference between landsat and sentinel worldview image acquisition dates was maintained to diminish potential biases 2 3 spectral water indices conventionally reflectance characteristics of clear water are used for delineating surface water these include greater reflectance in the visible portion of the electromagnetic spectrum highest reflectance in the blue channel and nearly no reflectance in the nir and swir bands mcfeeters 1996 xu 2006 inspired by the normalized difference vegetation index ndvi mcfeeters 1996 proposed ndwi 1 n d w i g r e e n n i r g r e e n n i r later xu 2006 modified this equation to use the normalized difference of green and swir1 instead of green and nir and named it as the mndwi equation 2 mndwi is shown to more efficiently suppress vegetation and soil induced noises and is generally more robust compared to ndwi 2 m n d w i g r e e n s w i r 1 g r e e n s w i r 1 feyisa et al 2014 introduced two versions of awei equations 3 and 4 1 aweinsh which uses the weighted difference in green and summation of the nir and swir1 2 bands to classify water in urban areas and is shown to effectively remove commission errors caused by shadows and rooftops and 2 aweish that considers the weighted difference in summation of blue and green and summation of nir and swir1 2 bands 3 a w e i n s h 4 g r e e n s w i r 1 0 25 n i r 2 75 s w i r 2 4 a w e i s h b l u e 2 5 g r e e n 1 5 n i r s w i r 1 0 25 s w i r 2 fisher et al 2016 proposed a water index wi equation 5 that uses a calibrated regression of the green red nir and swir1 2 bands 5 w i 1 7204 171 g r e e n 3 r e d 70 n i r 45 s w i r 1 71 s w i r 2 normalized water indices e g ndwi mndwi traditionally use zero as a hard threshold to separate water from non water pixels mcfeeters 1996 but some studies have strived to tune this threshold to improve spectral indices accuracy by considering local features malahlela 2016 non normalized spectral water indices aweinsh aweish and wi were proposed to remedy the problem of manual manipulation of the threshold value for normalized indices but the performance of non normalized indices largely depends on land surface features and the complexity of terrain that was used to derive the regression model fisher et al 2016 2 4 conceptual assessment of water indices surface water bodies and their reflectance properties are often affected by their surrounding environment to analyze the capability of different spectral indices to correctly detect water it is crucial to investigate spectral characteristics of water under different conditions as well as spectral properties of land surface features that may induce false positives and false negatives zeng et al 2017 spectral properties of normal muddy and hydrothermal water as well as dark vegetation shadow ice rooftops and water obscured by dust storms are demonstrated in fig 2 by closely inspecting fig 2a and equations 1 5 we can expect erroneous classification by traditional water indices under some scenarios in muddy and hydrothermal waters reflectance in nir is greater than visible bands which is contrary to the expected reflectance pattern associated with clear water under these scenarios ndwi may not perform accurately because it depends on reflectance in the green band being higher than that of the nir band to classify a pixel as water similarly ndwi may introduce commission errors from rooftops and shadows since these features have similar reflectance patterns to clear water fig 2b mndwi however uses the difference in green and swir1 bands thereby resolving the classification problem with hydrothermal and muddy water however mndwi is expected to misclassify dark vegetation shadows and rooftops as water depending on their reflectance patterns aweinsh uses the weighted difference in the green and summation of nir and swir1 2 bands to classify water and thereby it effectively removes commission errors caused by shadows and rooftops but hydrothermal and muddy waters as well as dust storms over body of water cause reflectance in the nir and swir1 2 bands to be higher than those in clear water implicating the efficacy of aweinsh to summarize spectral water indices such as ndwi and mndwi are expected to fail under various conditions due to the use of very narrow spectral ranges 2 bands aweish and wi are both prone to misclassifying shadows and rooftops as water and aweinsh may fail where water has high reflectance in the nir and swir portion of the spectrum 2 5 augmented normalized difference water index andwi we propose andwi equation 6 as a robust water index that outperforms its predecessors by successfully separating water from non water pixels in all presented scenarios 6 a n d w i b l u e g r e e n r e d n i r s w i r 1 s w i r 2 b l u e g r e e n r e d n i r s w i r 1 s w i r 2 as compared to other indices even though the nir band has the highest reflectance in muddy and hydrothermal waters inclusion of the blue and red bands in andwi results in correct classification of these water types while aweinsh may misclassify them further andwi is conceptually expected to outperform mndwi by removing noise generated from dark vegetation the difference in blue green and red bands and nir swir1 2 bands of dark vegetation is negative and hence they are classified as non water by andwi while the difference in green and swir1 bands in mndwi results in misclassification of dark vegetation as water andwi identifies water bodies as features that have higher reflectance in rgb than that of combined nir and swir1 2 and this nullifies the very high reflectance of nir in hydrothermal and muddy water types unlike ndwi and aweinsh similarly andwi can correctly classify waters obscured by dust storms and can suppress noises generated from rooftops in urban areas where reflectance in swir bands is higher than clear water conditions but not higher than reflectance in rgb 2 6 automated optimum thresholding appropriate choice of thresholding to differentiate between water and non water pixels can significantly reduce omission and commission errors in spectral water indices jones 2015 xu 2006 studies have shown that the traditional zero thresholding approach can introduce errors due to spatiotemporal changes in brightness and contrast of remote sensing images bai et al 2011 campos et al 2012 li et al 2013 jiang et al 2014 to address these challenges and automate the threshold detection we use the otsu s binarization algorithm otsu 1979 du et al 2012 2014 xie et al 2016 this approach is superior to other methods including the manual search for optimum threshold value xu 2006 li et al 2013 feyisa et al 2014 and validation using receiver operating characteristic curves in which accuracy measurements and ground truths are spatiotemporally specific fisher et al 2016 the otsu algorithm maximizes the difference between water and non water pixels by minimizing intra class variance and maximizing inter class variance in bimodal histograms of pixel values for the target image this method computes the inter class variance between water index values of all pixels in an image and finds a threshold t that maximizes the inter class variance otsu 1979 2 7 evaluation of spectral indices the literature uses two sources of reference data for assessing classification accuracy of water indices 1 previously classified land cover data baldridge et al 2009 jiang et al 2012 ji et al 2015 and 2 visual interpretation of pixel type using very high high spatial resolution imagery davranche et al 2010 xie et al 2016 malahlela 2016 halabisky et al 2016 zhang et al 2017 wang et al 2018 in very high high resolution imagery it is relatively easy to visually distinguish water and non water surfaces feyisa et al 2014 fisher et al 2016 in this study classification accuracy was assessed using a balanced dataset of very high high resolution imagery worldview sentinel and landsat panchromatic imagery where for each scenario the number of water and background pixels are comparable this will allow a proper assessment of classification accuracy of spectral water indices particularly in scenarios where anomaly detection is consequential e g omission errors from urban areas mountainous regions where skewed class proportions i e imbalanced dataset are prevalent we use a down sampling technique to compute accuracy metrics in this approach a new dataset containing all classes is created by randomly drawing pixels from the dominant classes while including all samples from other classes accuracy metrics include commission and omission errors precision recall accuracy f1 score and cohen s kappa coefficient see supplementary materials section for accuracy metrics 2 8 filtering clouds not only clouds block information retrieval from the land surface but also most spectral water indices may misclassify clouds as water conventional approaches to deal with clouds involve masking pixels containing clouds or filtering images based on the proportion of cloudy to non cloudy pixels here we briefly discuss these two methods their implementation in gee and their shortcomings 1 creating a cloud free landsat composite using the function ee algorithms landsat simplecomposite deng et al 2020 or filtering the image collection based on cloud cover with a predefined arbitrary threshold e g 50 using filtermetadata cloud cover less than 50 nguyen et al 2019 both approaches may result in losing useable imagery in which clouds do not necessarily conceal the water body 2 eliminating pixels that are covered by clouds and cloud induced shadows all gee landsat surface reflectance products have a pixel qa band generated by the cfmask algorithm that can be used to mask out clouds and their shadows foga et al 2017 the machine learning based classification methods such as fmask cfmask and expert systems however can result in faulty removal of water pixels e g 16 commission error of cfmask foga et al 2017 inaccuracies of machine learning based results can stem from different sources including lack of sufficient training data under and over fitting of the model and model structural deficiencies among others tuia et al 2011 to address these weaknesses and for enhanced continuous monitoring of water bodies we propose a novel algorithm to only remove images in which clouds conceal the water bodies our proposed framework uses distinct properties of two water indices one of which wi classifies clouds as water and the other ndwi does not to determine whether or not clouds are obscuring the body of water the difference between these two indices estimated over a long period of observation is used as a basis for identifying images with clouds concealing the water body pseudo code described in algorithm 1 and is described with a flowchart in the supplementary materials fig s1 this process is comprised of calculating a time series of the difference between the two indices and a statistical procedure to tag the cloudy images the statistical procedure marks images with a high difference in ndwi and wi estimated surface water areas i e greater than 70 of moving average of the last two months as cloudy this cloud filtering approach is also implemented in our gee app refer to the app availability section algorithm 1 proposed cloud filtering algorithm image 1 2 9 filtering snow separating snow covered land surface areas from water bodies using spectral indices is difficult since water and snow have similar spectral characteristics in fact spectral indices developed for snow detection use the same reflectance properties used in water indices to classify snow for example normalized difference snow index uses the difference in green and swir bands similar to mndwi sharma et al 2016 the common approach in literature is to mask snow areas when performing water delineation two widely used methods for this purpose include a exploiting a hue saturation value hsv color model and developing a spectral snow index that leverages the difference between the brightness v and spectral color h to effectively separate water and snow smith 1978 and b using machine learning models to differentiate snow from other land surface features o connell and alber 2016 here and in the developed gee app modaresi rad 2020 we used a random forest classifier trained by samples from landsat 4 5 7 and 8 imagery from different regions across the globe to mask snow areas 3 results in this section we first qualitatively compare the results of andwi against other indices and ground truth using visual images then we provide quantitative comparison results using various accuracy measures 3 1 qualitative analysis we selected several scenes with pronounced features and atmospheric environmental scenarios that can help critically assess the robustness of spectral water indices fig 3 illustrates true and false color images for an urban area site 1 denver colorado u s along with detected water pixels light blue for all water indices this case includes shadows generated from skyscrapers and noises generated from dark and bright rooftops that challenges the accuracy of water indices see supplementary materials fig s2 for a higher resolution image first traditionally used zero thresholding was employed to evaluate different water indices showing that wi and aweish misclassify almost all rooftops shadows and some asphalt pixels as water aweinsh perfectly removes all noises associated with low albedo surfaces and shadows whereas andwi mndwi and ndwi provide mixed results subsequently we employed otsu thresholding to enhance the water indices effectiveness this was accomplished by generating a histogram of water index values for an area with a mixture of water shadow and rooftop pixels and selecting a threshold that maximizes the distance between the two modes of this histogram results of otsu thresholding show that andwi and mndwi remove all noise whereas ndwi does not this approach however introduces a high level of misclassification in non normalized indices of aweinsh aweish and wi fig 4 shows identified water pixels for a hydrothermal water body site 2 blue lagoon iceland where high reflectance in nir and swir bands leads to misclassification of hydrothermal water as a non water surface for ndwi and aweinsh with a zero thresholding approach aweish and wi overestimate the surface water area and best results are achieved by andwi and mndwi when a zero threshold is used we also compare these results to the global surface water product which underestimates hydrothermal waters and is associated with omission errors see fig s3 applying otsu thresholding prompts an overestimation of water area by misclassifying steam and rooftops as water with aweinsh and mndwi and leads to underestimation of water bodies with ndwi aweish and wi changes in the andwi results with otsu thresholding however are minimal in the scenario of muddy water site 3 hamun lakes located on the border of iran and afghanistan all indices except ndwi performed relatively well fig 5 and s4 however the global surface water monthly product is associated with significant omission error when mapping this muddy water body fig 5 c although failing in this scenario we note that the machine learning methods such as the expert systems of the global surface water can be accurate depending on the robustness of training testing and validation processes and availability of large and diverse training data aguilera et al 2011 farizhandi et al 2016 2020 results from the scenario of dark vegetation sites 4 and 8 the hamun lakes on the border of iran and afghanistan and nong han lake thailand also show commission errors from slightly higher reflectance in the green band compared to the swir1 band for mndwi and aweish with zero thresholding table s1 figs s5 s6 and s7 non normalized water indices i e andwi aweish and wi also show substantial commission error in this scenario once otsu thresholding was applied figs s5 s6 and s7 in a scenario of dust storms over the water body site 5 chah nimeh an artificial lake near the hamun lakes on the border of iran and afghanistan aweinsh and ndwi with zero thresholding underestimate the water area fig s8 appling otsu thresholding improves the results of aweinsh in this case but does not help with ndwi fig 6 compares various water indices for a case of shadow induced commission errors in mountainous areas site 6 arghandab reservoir located in afghanistan using a zero thresholding approach ndwi aweish and wi misclassify a majority of shadow areas as water resulting in an overestimation of the water body but mndwi andwi and aweinsh successfully suppress a majority of the noises generated by shadows fig 6 in this scenario implementing otsu thresholding by selecting an area with a mixture of pixels from water shadow and soil prompts a significant improvement of all normalized water indices andwi mndwi and ndwi but reduces the classification accuracy of non normalized indices aweinsh aweish and wi finally in a scenario of frozen water site 7 multiple lakes in tibet all indices performed relatively well fig s9 further discussion and qualitative analysis can be found in the supplementary materials 3 2 quantitative analysis we also quantitatively evaluated the performance of the proposed index andwi and other spectral water indices by comparing different accuracy metrics including percentages of commission and omission errors precision recall accuracy f1 score and cohen s kappa coefficient table s1 as in section 3 1 seven scenarios were considered to assess the robustness of various indices results of quantitative analysis with cohen s kappa coefficient for each scenario and the overall kappa coefficient for all scenarios combined are summarized in table 1 andwi with zero thresholding shows high classification accuracy in most scenarios although it introduces minor commission errors when the background consists of shadows and low albedo surfaces andwi with otsu thresholding resolves challenges with commission errors and removes noise generated from low albedo surfaces and shadows e g achieves 100 precision in urban areas in urban areas otsu thresholding with andwi causes minor underestimation of water bodies omission errors as compared to zero thresholding lowering the recall from 100 to 97 table s1 further andwi with otsu thresholding can detect muddy waters and waters concealed by dust storms table 1 it also has the highest accuracy when it comes to distinguishing dark vegetation from water ndwi however lacks the generalizability needed to detect water in various scenarios according to its overall accuracy f1 score and kappa coefficient table s1 as an example for muddy water ndwi has a 100 omission error i e a complete miss rate and for hydrothermal water it has relatively high commission and omission errors that result in 90 precision and 74 recall in most studied scenarios otsu thresholding significantly improved the ndwi s accuracy only in frozen water and ice does the use of otsu thresholding result in a decrease 3 in precision of ndwi compared to zero thresholding mndwi with zero thresholding is only unbiased in the muddy water scenario the classification accuracy of mndwi with otsu thresholding is greatly improved by minimizing commission errors making it the second best index after andwi in terms of overall accuracy f1 score and kappa coefficient table s1 the mndwi s accuracy is however compromised when dark vegetation is present in the image with zero thresholding and in the dark vegetation scenario mndwi has a very high commission error and misclassifies dark vegetation as water rendering a very low precision 70 implementing otsu thresholding improves mndwi s precision to some extent 76 but does not resolve the misclassification issue due to the absence of the red and nir bands that are required to capture dark vegetation both awei indices with zero thresholding show high classification accuracy under certain scenarios while having extremely poor performance in others aweinsh with zero thresholding cannot effectively separate dark vegetation from water resulting in significant commission errors and low precision 78 it also produces significant omission errors when classifying hydrothermal water and offers a very low recall 59 when a dust storm passes over a water body the miss rate of aweinsh with zero thresholding increases and results in a notable underestimation of the surface water area as documented by its low recall 13 otsu thresholding in general did not help with the efficacy of aweinsh compared to zero thresholding as is the case for all non normalized water indices the occurrence of dust storms over a water body was the only scenario in which otsu thresholding helped improve aweinsh accuracy the other form of this index aweish is an effective index in most studied scenarios but its accuracy is challenged in urban and mountainous areas due to the presence of shadows shadows from mountainous areas introduce substantial commission errors that lower the precision of this index 46 finally wi with zero thresholding has significant commission errors and renders relatively low precision in mountainous and urban areas 84 and 95 respectively due to the presence of shadows and low albedo surfaces the wi s efficacy as for other non normalized water indices was compromised by otsu thresholding in most scenarios and the only instance where otsu thresholding improved the wi s accuracy was in detecting water concealed by dust storms wi also shows a relatively low recall 89 and precision 93 in the hydrothermal water scenario implying that wi was not able to identify all water pixels correctly nevertheless this index performed relatively well in other scenarios 3 3 cloud filtering algorithm traditional cloud filtering algorithms often discard several images and introduce gaps in the long term monitoring water resources our analysis however shows that even when clouds obscure a significant portion of some images the imagery may still be useful for monitoring of water bodies in fig 7 b for example even though the percentage of cloud coverage is more than that of fig 7a 34 5 vs 24 6 clouds are not obscuring the water body rendering this image acceptable for surface water mapping whereas clouds in fig 7a are obscuring the water body requiring this image to be discarded therefore using percentage based cloud filtering methods can induce improper removal of useable imagery another commonly used method only masks cloud obscured pixels of images landsat level 1 data products include a quality assessment qa band based on cfmask foga et al 2017 which is presented as bit mapped values for example bits 3 and 5 represent cloud shadow and cloud respectively and bit 7 presents cloud confidence foga et al 2017 detailed analysis however shows that this approach can result in faulty removal of pixels with high reflectance from water bodies and hot sands fig 8 a shows a true color image from landsat 8 without any masking in which no cloud cover is observed fig 8b shows the image with shadows being masked fig 8c shows the same image with clouds being masked and fig 8d shows the image with both clouds and cloud shadows being masked these figures clearly point to faulty detection of water and hot sand pixels as cloud and cloud shadow fig 9 illustrates a time series of water body area for the kajaki reservoir in afghanistan between 1984 and 2020 obtained using two different approaches gee cloud percentage based orange dots and our proposed cloud filtering algorithm blue dots based on the functional difference of water indices it is evident that percentage based cloud filtering significantly reduces the number of useable landsat images for the studied area our proposed algorithm resulted in more than twice the number of useable images compared to filtering scenes based on their cloud percentage 240 observations with our proposed approach compared to 107 observations with a 1 cloud cover threshold note that 1 cloud cover is chosen here since most spectral water indices detect clouds as water and therefore a cloud free composite is required to generate unbiased estimates of water area in conventional percentage based cloud filtering approaches the gap in the plot is a result of the absence of landsat 5 imagery and scan line corrector failure in landsat 7 that created wedge shaped gaps in the imagery for this particular region between mid 2003 and mid 2008 4 discussion automating the process of surface water delineation enables time series analysis of water resources and has been a topic of interest for decades chignell et al 2015 while several spectral water indices have been introduced in the literature little analysis has been conducted to evaluate the performance of different water indices for a comprehensive set of scenarios with different noise characteristics ji et al 2009 studies often consider only a few scenarios of noisy scenes such as studies by feyisa et al 2014 that assessed water indices in the presence of shadow and dark surfaces in urban areas and xu 2006 that studied the impact of noises generated from vegetation and soil on water indices in this study we evaluated the classification accuracy of several spectral water indices for a comprehensive set of extreme water and atmospheric conditions high and low albedo and background land cover types further we developed the augmented normalized difference water index andwi as a universal robust index to accurately map water bodies under various atmospheric and terrestrial conditions our results show that although each spectral water index performed well under certain environmental conditions they except for andwi could not be generalized to all conditions andwi once coupled with otsu thresholding can produce higher classification accuracy as compared to non normalized indices aweish aweinsh and wi and therefore has more flexibility to adapt to different background noises and ambient atmospheric conditions similar results were obtained in a study by xie et al 2016 for mndwi we further show that andwi by incorporating more spectral bands compared to mndwi is a more flexible water index for separating dark vegetation surfaces from water surfaces which is useful to separate densely vegetated islands within bodies of water or late season crops in agricultural areas from water bodies see supplementary materials fig s10 the presence of dark vegetation inside water bodies however can be misleading as some aquatic plants float on the water surface blocking the water body and thereby causing underestimation of the water body with andwi in such cases although andwi separates floating aquatic plants from water otsu thresholding can be used to effectively classify these plants as water by tuning the separating threshold fig 10 shows the nong han lake some portions of which pointed by green arrows are covered with floating aquatic plants to classify areas with floating aquatic vegetation as water we select a sampling area with a combination of land aquatic vegetation and water pixels and create a histogram of andwi pixel values for automatic threshold selection by the otsu algorithm green rectangle in fig 10b the otsu method uses bimodal histograms of andwi values for selected sampling areas and minimizes intraclass variance and maximizes interclass variance this allows appropriate thresholding in the presence of aquatic vegetation however if the selected sampling area does not contain aquatic vegetation andwi would classify aquatic vegetation floating on the surface of the lake as non water red rectangle in fig 10a furthermore we demonstrate that the higher reflectance in the nir and swir1 2 bands in the presence of dust storms and for hydrothermal and muddy water conditions as compared to those of clear water and clear sky can result in significant omission errors in ndwi in particular ndwi is unable to successfully detect water in these scenarios i e omission error regardless of the choice of thresholding as it does not include swir bands in its formula equation 1 using otsu thresholding with ndwi significantly reduces the commission errors generated from shadows and low albedo surfaces but it does not reduce the omission errors due to lack of representative spectral information absence of swir bands the widely used awei indices are among the most effective spectral water indices in the literature for delineation of water bodies in urban areas our study however indicates that the efficacy of aweinsh is compromised when mapping i hydrothermal waters ii waters obscured by dust storms and iii water bodies that have dark vegetation in the scene we also show that although aweish misclassified dark and bright rooftops shadows and dark vegetation as water it offers a relatively higher overall accuracy compared to aweinsh in all studied scenarios this agrees with the findings of zhang et al 2017 who demonstrated that both awei indices show high misclassification in turbid water based on the accuracy f1 score and kappa coefficient table s1 we conclude that i the calibrated coefficients in aweinsh and aweish although effective in general may not sufficiently represent all scenarios and or ii the difference in the green and all nir and swir bands in aweinsh and the difference in the green blue and all nir and swir bands in aweish may not be adequate to characterize all water conditions and suppress background noises based on the obtained accuracy results table 1 we do not recommend otsu thresholding with aweinsh and aweish wi shows relatively good overall performance for all scenarios and offers an overall higher accuracy compared to both aweis however the performance of this index is compromised in urban and mountainous areas where there is abundant noise as a result of low albedo features such as asphalts and shadows wi also overestimates hydrothermal water by capturing steam as water similar to aweis the use of otsu thresholding is not recommended for wi finally cloud filtering is also a major issue in the long term monitoring of surface water we show that machine learning based masking of clouds and shadows can induce inappropriate removal of water bodies and can cause underestimation of a total water body area our proposed cloud filtering algorithm is also a remedy for the loss of useable imagery in cloud percentage based image filtering in which images with higher cloud coverage than a specific percentage e g 1 wang et al 2018 0 donchyts et al 2016 are discarded our method only removes images in which clouds conceal the water body regardless of the percentage of clouds in the scene this is especially relevant in tropical climates where cloud interference results in higher percentages of cloudy scenes li et al 2016 our proposed cloud filtering algorithm provides more frequent more than twice water body observations in the study area compared to the conventional cloud percentage based image filtering approach 5 conclusion we introduce a novel spectral water index augmented normalized difference water index andwi that uses an expanded spectral range from landsat imagery to resolve limitations of existing water indices we critically evaluate the performance of andwi as compared to widely used water indices ndwi mndwi wi aweish and aweinsh using seven different scenarios where the presence of certain land surface features challenges accurate classification of water bodies scenarios include urban areas hydrothermal water muddy water presence of dark vegetation in the scene dust storms over the water body mountains with abundant shade area and frozen water and ice the evaluated spectral water indices perform well in some scenarios and poorly in others whereas the proposed andwi index consistently performs well in all scenarios results indicate that andwi not only is an accurate water index but also is a robust method that can be used under different environmental conditions across the globe we also show that dynamic thresholding with the otsu method enhances the accuracy of andwi this approach provides an accuracy of more than 95 for all scenarios except for hydrothermal and frozen water and ice scenarios that are associated with 85 95 accuracy for which other indices offer 20 95 accuracy in other words andwi with otsu thresholding is robust computationally efficient and offers the highest accuracy compared to other water indices making it an ideal water mapping tool this approach does not require training and retraining processes of a machine learning framework and is easily transferable across platforms e g envi arcgis gee further we demonstrate that conventional methods for handling cloudy images may not be ideal for long term monitoring of water bodies we show that the cloud masking approach may result in faulty removal of water pixels and areas with high reflectance such as hot sands as clouds which ultimately prompts an underestimation of the actual area of the water body filtering images based on cloud percentage also results in unnecessary removal of images that can be used for water mapping clouds not covering water body to tackle these problems we propose a cloud filtering algorithm based on the functional difference between two spectral water indices one classifying clouds as water and the other not results show that the proposed algorithm can increase the number of valid images images with clouds not concealing water boundaries for a case study of kajaki reservoir by 124 from 1984 to 2020 thus providing more frequent observations finally we develop a gee app that uses our proposed cloud filtering approach to maximize the number of landsat images for study areas of interest and enables the user to select any of the discussed spectral water indices to delineate water bodies this app is freely available to the public at https arashmodrad github io water mapping app and produces16 day time series of surface water areas from 1984 present declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this study is partially supported by the hydroinformatics fellowship from cuahsi with support from the national science foundation nsf cooperative agreement no ear 1849458 and the u s geological survey s land change science program this manuscript is submitted for publication with the understanding that the united states government is authorized to reproduce and distribute reprints for governmental purposes any use of trade product or firm names is for descriptive purposes only and does not imply endorsement by the united states government the authors appreciate the support from the u s geological survey through the provision of digitalglobe worldview 2 and 3 imagery under the nga nextview license agreement landsat and sentinel imagery were acquired and processed through the google earth engine javascript api appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2021 105030 app availability the app generated for this study is available at https arashmodrad github io water mapping app that can be cloned using the instructions on the websitecite this app as modaresi rad a 2020 water mapping app hydroshare http www hydroshare org resource 4dbd35f77b89416eaa0e44f5119eb72c 
25836,we present a comprehensive critical review of well established satellite remote sensing water indices and offer a novel robust augmented normalized difference water index andwi andwi employs an expanded set of spectral bands rgb nir and swir1 2 to maximize the contrast between water and non water pixels further we implement a dynamic thresholding method the otsu algorithm to enhance andwi s performance applied to a variety of environmental conditions andwi with otsu thresholding offered the highest overall accuracy accuracy 0 98 f1 0 98 and kappa 0 96 compared to other indices ndwi mndwi awei wi we also propose a novel cloud filtering algorithm that substantially increases the number of useable images compared to the conventional cloud free composites 124 increased observations in the studied area and resolves inappropriate masking of water bodies and hot sands as clouds by conventional methods finally we develop a google earth engine app to readily delineate 16 day surface water bodies across the globe graphical abstract image 1 keywords satellite water mapping spectral index mndwi awei wi landsat 1 introduction land surface water bodies provide crucial ecosystem and societal services saft et al 2016 sohl et al 2019 pourmohamad et al 2019 safarianzengir et al 2020 they are however vulnerable to various climatic and anthropogenic stressors aghakouchak et al 2015 alborzi et al 2018 ashraf et al 2019 mahbod et al 2019 rad et al 2016 2017 understanding the dynamics of water bodies is critical for short term operations and long term planning of water and land management remote sensing provides an inexpensive consistent and accurate approach to monitor changes in surface water using upwelling electromagnetic radiation reflected and emitted from land surfaces schmugge et al 2002 beveridge et al 2020 in the past four decades the application of remote sensing techniques for hydrological monitoring and landscape analysis has significantly increased sadeghi et al 2015 2017 wilson et al 2016 wilson and norman 2018 li et al 2019 mhawej and faour 2020 zhang et al 2020 farahmand et al 2020 numerous remote sensing methodologies have been proposed to map surface water bodies which can be grouped into three general categories huang et al 2018 a density slicing with a threshold bennett 1987 frazier and page 2000 b machine learning classification monegaglia et al 2018 shen and li 2010 tulbure and broich 2013 wright and gallant 2007 and c spectral water indices mcfeeters 1996 feyisa et al 2014 sheng et al 2016 density slicing methods are the simplest form of classification but can be very inaccurate in noise abundant images rees 2013 machine learning classification methods require a large amount of data to train a generalizable model classifier and the training and retraining processes can be computationally demanding hollstein et al 2016 further exporting trained classifiers from one platform to another is cumbersome and requires programming in the target platform baylor et al 2017 spectral water indices on the contrary are computationally inexpensive and easy to implement and can easily transfer across platforms making them an appealing approach to delineate surface water using remotely sensed data zhang et al 2017 several spectral based water indices have been presented in the literature e g crist 1985 xiao et al 2002 guerschman et al 2011 jiang et al 2014 chen et al 2020 mcfeeters 1996 proposed a normalized difference water index ndwi that determines water pixels using the difference in the green and near infrared nir bands xu 2006 however argued that ndwi can result in significant built up land e g asphalt and rooftops in urban areas vegetation and soil noises and proposed a modified ndwi mndwi that uses the difference in the green and shortwave infrared swir bands lacaux et al 2007 proposed a normalized difference pond index that is expressed similar to mndwi except that the band order is reversed danaher and collett 2006 developed a water index wi that uses five bands from top of atmosphere toa landsat reflectance products fisher et al 2016 argued that surface reflectance data would be more accurate for water delineation and used linear discriminant analysis classification to update the wi shen and li 2010 proposed a water ratio index which utilizes the dominance of water spectral reflectance in the green and red bands in comparison to the nir and swir bands finally feyisa et al 2014 introduced two versions of automated water extraction index awei to account for commission errors caused by areas of shadow and dark surfaces with which most classification methods struggle a comprehensive literature review and critical analysis of most widely used spectral water indices indicate that they are prone to misclassification errors under certain scenarios malahlela 2016 rishikeshan and ramesh 2018 wang et al 2015 2018 these errors are pronounced in areas where the background contains low albedo surfaces such as dark vegetation asphalt roads rooftops and shadows feyisa et al 2014 fisher et al 2016 other error prone circumstances include dust storms over water bodies muddy water hydrothermal water and frozen water and ice lacaux et al 2007 li et al 2016 these conditions cause misclassifications because 1 similarity in reflectance patterns of non water features e g rooftops with normal water pixels contributes to increased commission errors and 2 dissimilarity of reflectance properties of water pixels under specific conditions e g muddy water with clear water pixels contributes to increased omission errors yang et al 2020 such circumstances can significantly lower water classification accuracy fisher et al 2016 there also remote sensing derived continental or global maps of water bodies but these products are associated with are some limitations the global surface water explorer pekel et al 2016 is one such product that uses a machine learning classification algorithm to produce a variety of surface water products from 1984 to 2019 this product uses a cloud masking filtering procedure based on expert systems fmask zhu and woodcock 2012 the accuracy of which may be challenged by some features such as water and hot sands find detailed discussion in section 2 8 further this product is not evaluated under challenging environmental conditions e g muddy water more to come later another available product is the dynamic surface water extent which provides classified raster products of open water partial surface water and not water classes for all cloud snow and shadow free landsat 4 8 scenes jones 2015 2019 however the product is only available for the contiguous u s alaska and hawaii this paper builds upon the progress on spectral water indices and advances in cloud computing with google earth engine gee and offers several contributions 1 we propose an augmented normalized difference water index andwi as a robust water delineation index that outperforms other spectral water indices this index was developed based on comprehensive experiments conducted on spectral characteristics of different aquatic and terrestrial land cover types obtained from landsat 4 5 7 and 8 surface reflectance sr tier 1 products andwi successfully suppresses the omission and commission errors caused by land cover e g rooftops and or natural events e g dust storms we also employ the otsu method to automate threshold selection otsu 1979 prost et al 2008 vos et al 2019 this enhances water detection accuracy for any given location and time by tuning a locally relevant threshold 2 we propose a novel cloud filtering algorithm for delineation of water bodies based on functional differences of various spectral water indices this algorithm uses two spectral water indices one classifying clouds as water and the other not the difference in identified surface water area between the two indices is used along with a statistical procedure to remove images in which clouds directly conceal the water body this resolves issues with the state of the art cloud and shadow masking and cloud percentage based image filtering processes issues include 1 creating a cloud free landsat composite or filtering the image collection based on cloud cover percentage of clouds in an image causes loss of images in which water bodies are not directly obscured and could be used and 2 masking clouds using the cloud detection machine learning algorithms such as cfmask foga et al 2017 may result in faulty removal of water pixels as cloud 3 we develop a novel gee app for monitoring historical changes in water bodies this app modaresi rad 2020 provides a 16 day time series of water body areas from 1984 present and allows the user to select an area of interest with choices of different spectral water indices and hard thresholding conventional zero thresholding or dynamic thresholding otsu method 2 methods 2 1 study sites we focus on sites with unique water land and atmospheric features that introduce noise when delineating water bodies with spectral indices selected features increase error rate through omission error water pixels that are not identified as water by the spectral index or reduce precision through commission error non water pixels that are identified as water by the spectral index to this end several water bodies with distinct features were selected to study possible commission errors caused by shadow asphalt paved roads and dark and bright rooftops and omission errors caused by hydrothermal waters ice and dust storms obscuring water bodies fig 1 site 1 is in the city of denver colorado u s a and is an ideal location for studying commission errors due to the existence of different lakes and various low albedo surfaces such as dark rooftops asphalt and building shadows site 2 the blue lagoon is a geothermal power plant and hydrothermal pond located in southwestern iceland and is selected to assess omission errors caused by hydrothermal water bodies sites 3 and 4 are from the hamun lakes located on the border of iran and afghanistan site 3 is an ideal place for studying omission errors caused by muddy water due to frequent flash floods in this monsoon impacted region and site 4 is studied for commission errors introduced by dark vegetation site 5 is the chah nimeh an artificial lake near the hamun lakes and is selected for studying omission errors induced by dust storms over the lake site 6 is the arghandab reservoir located in a mountainous area of afghanistan in this site mountain shadows create an ideal scene for studying commission errors site 7 includes several frozen lakes and areas of abundant ice in tibet that are appropriate for studying omission errors site 8 is nong han lake in thailand where aquatic plants on the water surface create a good site for studying the mixture of dark vegetation and water details of image composition and the number of pixels extracted in each scenario are presented in table s1 see supplementary materials 2 2 remote sensing imagery this study was performed on landsat 8 oli tirs landsat 7 etm landsat 5 etm and landsat 4 etm surface reflectance tier 1 multispectral imagery these datasets are available in the gee cloud storage and computing platform gorelick et al 2017 all landsat surface reflectance products are atmospherically corrected and have undergone geometric and radiometric processing more specifically to produce land surface reflectance the lasrc algorithm was used for landsat 8 oli tirs and the ledaps algorithm was used for landsat 4 7 vermote et al 2016 masek et al 2006 hence spectral reflectance values obtained from these data can be compared across time space or sensor to images that have undergone the same level of correction very high resolution multispectral worldview 2 and worldview 3 imagery with 0 46 m and 0 31 m resolution respectively were considered as ground truth for evaluating the accuracy of spectral water indices and the water bodies derived from landsat 7 and 8 imagery some specific scenarios like dust storms that dissipate quickly were not captured by the worldview imagery and were instead evaluated either with sentinel 2 level 2a and level 1c 10 m resolution or landsat 7 and 8 panchromatic sharpened imagery 15 m resolution for scenarios that include shadows and dust storms we used the enhanced landsat 7 and 8 panchromatic sharpened imagery as ground truth hence there is no difference in image acquisition dates in these scenarios for all other scenarios a maximum of 5 day difference between landsat and sentinel worldview image acquisition dates was maintained to diminish potential biases 2 3 spectral water indices conventionally reflectance characteristics of clear water are used for delineating surface water these include greater reflectance in the visible portion of the electromagnetic spectrum highest reflectance in the blue channel and nearly no reflectance in the nir and swir bands mcfeeters 1996 xu 2006 inspired by the normalized difference vegetation index ndvi mcfeeters 1996 proposed ndwi 1 n d w i g r e e n n i r g r e e n n i r later xu 2006 modified this equation to use the normalized difference of green and swir1 instead of green and nir and named it as the mndwi equation 2 mndwi is shown to more efficiently suppress vegetation and soil induced noises and is generally more robust compared to ndwi 2 m n d w i g r e e n s w i r 1 g r e e n s w i r 1 feyisa et al 2014 introduced two versions of awei equations 3 and 4 1 aweinsh which uses the weighted difference in green and summation of the nir and swir1 2 bands to classify water in urban areas and is shown to effectively remove commission errors caused by shadows and rooftops and 2 aweish that considers the weighted difference in summation of blue and green and summation of nir and swir1 2 bands 3 a w e i n s h 4 g r e e n s w i r 1 0 25 n i r 2 75 s w i r 2 4 a w e i s h b l u e 2 5 g r e e n 1 5 n i r s w i r 1 0 25 s w i r 2 fisher et al 2016 proposed a water index wi equation 5 that uses a calibrated regression of the green red nir and swir1 2 bands 5 w i 1 7204 171 g r e e n 3 r e d 70 n i r 45 s w i r 1 71 s w i r 2 normalized water indices e g ndwi mndwi traditionally use zero as a hard threshold to separate water from non water pixels mcfeeters 1996 but some studies have strived to tune this threshold to improve spectral indices accuracy by considering local features malahlela 2016 non normalized spectral water indices aweinsh aweish and wi were proposed to remedy the problem of manual manipulation of the threshold value for normalized indices but the performance of non normalized indices largely depends on land surface features and the complexity of terrain that was used to derive the regression model fisher et al 2016 2 4 conceptual assessment of water indices surface water bodies and their reflectance properties are often affected by their surrounding environment to analyze the capability of different spectral indices to correctly detect water it is crucial to investigate spectral characteristics of water under different conditions as well as spectral properties of land surface features that may induce false positives and false negatives zeng et al 2017 spectral properties of normal muddy and hydrothermal water as well as dark vegetation shadow ice rooftops and water obscured by dust storms are demonstrated in fig 2 by closely inspecting fig 2a and equations 1 5 we can expect erroneous classification by traditional water indices under some scenarios in muddy and hydrothermal waters reflectance in nir is greater than visible bands which is contrary to the expected reflectance pattern associated with clear water under these scenarios ndwi may not perform accurately because it depends on reflectance in the green band being higher than that of the nir band to classify a pixel as water similarly ndwi may introduce commission errors from rooftops and shadows since these features have similar reflectance patterns to clear water fig 2b mndwi however uses the difference in green and swir1 bands thereby resolving the classification problem with hydrothermal and muddy water however mndwi is expected to misclassify dark vegetation shadows and rooftops as water depending on their reflectance patterns aweinsh uses the weighted difference in the green and summation of nir and swir1 2 bands to classify water and thereby it effectively removes commission errors caused by shadows and rooftops but hydrothermal and muddy waters as well as dust storms over body of water cause reflectance in the nir and swir1 2 bands to be higher than those in clear water implicating the efficacy of aweinsh to summarize spectral water indices such as ndwi and mndwi are expected to fail under various conditions due to the use of very narrow spectral ranges 2 bands aweish and wi are both prone to misclassifying shadows and rooftops as water and aweinsh may fail where water has high reflectance in the nir and swir portion of the spectrum 2 5 augmented normalized difference water index andwi we propose andwi equation 6 as a robust water index that outperforms its predecessors by successfully separating water from non water pixels in all presented scenarios 6 a n d w i b l u e g r e e n r e d n i r s w i r 1 s w i r 2 b l u e g r e e n r e d n i r s w i r 1 s w i r 2 as compared to other indices even though the nir band has the highest reflectance in muddy and hydrothermal waters inclusion of the blue and red bands in andwi results in correct classification of these water types while aweinsh may misclassify them further andwi is conceptually expected to outperform mndwi by removing noise generated from dark vegetation the difference in blue green and red bands and nir swir1 2 bands of dark vegetation is negative and hence they are classified as non water by andwi while the difference in green and swir1 bands in mndwi results in misclassification of dark vegetation as water andwi identifies water bodies as features that have higher reflectance in rgb than that of combined nir and swir1 2 and this nullifies the very high reflectance of nir in hydrothermal and muddy water types unlike ndwi and aweinsh similarly andwi can correctly classify waters obscured by dust storms and can suppress noises generated from rooftops in urban areas where reflectance in swir bands is higher than clear water conditions but not higher than reflectance in rgb 2 6 automated optimum thresholding appropriate choice of thresholding to differentiate between water and non water pixels can significantly reduce omission and commission errors in spectral water indices jones 2015 xu 2006 studies have shown that the traditional zero thresholding approach can introduce errors due to spatiotemporal changes in brightness and contrast of remote sensing images bai et al 2011 campos et al 2012 li et al 2013 jiang et al 2014 to address these challenges and automate the threshold detection we use the otsu s binarization algorithm otsu 1979 du et al 2012 2014 xie et al 2016 this approach is superior to other methods including the manual search for optimum threshold value xu 2006 li et al 2013 feyisa et al 2014 and validation using receiver operating characteristic curves in which accuracy measurements and ground truths are spatiotemporally specific fisher et al 2016 the otsu algorithm maximizes the difference between water and non water pixels by minimizing intra class variance and maximizing inter class variance in bimodal histograms of pixel values for the target image this method computes the inter class variance between water index values of all pixels in an image and finds a threshold t that maximizes the inter class variance otsu 1979 2 7 evaluation of spectral indices the literature uses two sources of reference data for assessing classification accuracy of water indices 1 previously classified land cover data baldridge et al 2009 jiang et al 2012 ji et al 2015 and 2 visual interpretation of pixel type using very high high spatial resolution imagery davranche et al 2010 xie et al 2016 malahlela 2016 halabisky et al 2016 zhang et al 2017 wang et al 2018 in very high high resolution imagery it is relatively easy to visually distinguish water and non water surfaces feyisa et al 2014 fisher et al 2016 in this study classification accuracy was assessed using a balanced dataset of very high high resolution imagery worldview sentinel and landsat panchromatic imagery where for each scenario the number of water and background pixels are comparable this will allow a proper assessment of classification accuracy of spectral water indices particularly in scenarios where anomaly detection is consequential e g omission errors from urban areas mountainous regions where skewed class proportions i e imbalanced dataset are prevalent we use a down sampling technique to compute accuracy metrics in this approach a new dataset containing all classes is created by randomly drawing pixels from the dominant classes while including all samples from other classes accuracy metrics include commission and omission errors precision recall accuracy f1 score and cohen s kappa coefficient see supplementary materials section for accuracy metrics 2 8 filtering clouds not only clouds block information retrieval from the land surface but also most spectral water indices may misclassify clouds as water conventional approaches to deal with clouds involve masking pixels containing clouds or filtering images based on the proportion of cloudy to non cloudy pixels here we briefly discuss these two methods their implementation in gee and their shortcomings 1 creating a cloud free landsat composite using the function ee algorithms landsat simplecomposite deng et al 2020 or filtering the image collection based on cloud cover with a predefined arbitrary threshold e g 50 using filtermetadata cloud cover less than 50 nguyen et al 2019 both approaches may result in losing useable imagery in which clouds do not necessarily conceal the water body 2 eliminating pixels that are covered by clouds and cloud induced shadows all gee landsat surface reflectance products have a pixel qa band generated by the cfmask algorithm that can be used to mask out clouds and their shadows foga et al 2017 the machine learning based classification methods such as fmask cfmask and expert systems however can result in faulty removal of water pixels e g 16 commission error of cfmask foga et al 2017 inaccuracies of machine learning based results can stem from different sources including lack of sufficient training data under and over fitting of the model and model structural deficiencies among others tuia et al 2011 to address these weaknesses and for enhanced continuous monitoring of water bodies we propose a novel algorithm to only remove images in which clouds conceal the water bodies our proposed framework uses distinct properties of two water indices one of which wi classifies clouds as water and the other ndwi does not to determine whether or not clouds are obscuring the body of water the difference between these two indices estimated over a long period of observation is used as a basis for identifying images with clouds concealing the water body pseudo code described in algorithm 1 and is described with a flowchart in the supplementary materials fig s1 this process is comprised of calculating a time series of the difference between the two indices and a statistical procedure to tag the cloudy images the statistical procedure marks images with a high difference in ndwi and wi estimated surface water areas i e greater than 70 of moving average of the last two months as cloudy this cloud filtering approach is also implemented in our gee app refer to the app availability section algorithm 1 proposed cloud filtering algorithm image 1 2 9 filtering snow separating snow covered land surface areas from water bodies using spectral indices is difficult since water and snow have similar spectral characteristics in fact spectral indices developed for snow detection use the same reflectance properties used in water indices to classify snow for example normalized difference snow index uses the difference in green and swir bands similar to mndwi sharma et al 2016 the common approach in literature is to mask snow areas when performing water delineation two widely used methods for this purpose include a exploiting a hue saturation value hsv color model and developing a spectral snow index that leverages the difference between the brightness v and spectral color h to effectively separate water and snow smith 1978 and b using machine learning models to differentiate snow from other land surface features o connell and alber 2016 here and in the developed gee app modaresi rad 2020 we used a random forest classifier trained by samples from landsat 4 5 7 and 8 imagery from different regions across the globe to mask snow areas 3 results in this section we first qualitatively compare the results of andwi against other indices and ground truth using visual images then we provide quantitative comparison results using various accuracy measures 3 1 qualitative analysis we selected several scenes with pronounced features and atmospheric environmental scenarios that can help critically assess the robustness of spectral water indices fig 3 illustrates true and false color images for an urban area site 1 denver colorado u s along with detected water pixels light blue for all water indices this case includes shadows generated from skyscrapers and noises generated from dark and bright rooftops that challenges the accuracy of water indices see supplementary materials fig s2 for a higher resolution image first traditionally used zero thresholding was employed to evaluate different water indices showing that wi and aweish misclassify almost all rooftops shadows and some asphalt pixels as water aweinsh perfectly removes all noises associated with low albedo surfaces and shadows whereas andwi mndwi and ndwi provide mixed results subsequently we employed otsu thresholding to enhance the water indices effectiveness this was accomplished by generating a histogram of water index values for an area with a mixture of water shadow and rooftop pixels and selecting a threshold that maximizes the distance between the two modes of this histogram results of otsu thresholding show that andwi and mndwi remove all noise whereas ndwi does not this approach however introduces a high level of misclassification in non normalized indices of aweinsh aweish and wi fig 4 shows identified water pixels for a hydrothermal water body site 2 blue lagoon iceland where high reflectance in nir and swir bands leads to misclassification of hydrothermal water as a non water surface for ndwi and aweinsh with a zero thresholding approach aweish and wi overestimate the surface water area and best results are achieved by andwi and mndwi when a zero threshold is used we also compare these results to the global surface water product which underestimates hydrothermal waters and is associated with omission errors see fig s3 applying otsu thresholding prompts an overestimation of water area by misclassifying steam and rooftops as water with aweinsh and mndwi and leads to underestimation of water bodies with ndwi aweish and wi changes in the andwi results with otsu thresholding however are minimal in the scenario of muddy water site 3 hamun lakes located on the border of iran and afghanistan all indices except ndwi performed relatively well fig 5 and s4 however the global surface water monthly product is associated with significant omission error when mapping this muddy water body fig 5 c although failing in this scenario we note that the machine learning methods such as the expert systems of the global surface water can be accurate depending on the robustness of training testing and validation processes and availability of large and diverse training data aguilera et al 2011 farizhandi et al 2016 2020 results from the scenario of dark vegetation sites 4 and 8 the hamun lakes on the border of iran and afghanistan and nong han lake thailand also show commission errors from slightly higher reflectance in the green band compared to the swir1 band for mndwi and aweish with zero thresholding table s1 figs s5 s6 and s7 non normalized water indices i e andwi aweish and wi also show substantial commission error in this scenario once otsu thresholding was applied figs s5 s6 and s7 in a scenario of dust storms over the water body site 5 chah nimeh an artificial lake near the hamun lakes on the border of iran and afghanistan aweinsh and ndwi with zero thresholding underestimate the water area fig s8 appling otsu thresholding improves the results of aweinsh in this case but does not help with ndwi fig 6 compares various water indices for a case of shadow induced commission errors in mountainous areas site 6 arghandab reservoir located in afghanistan using a zero thresholding approach ndwi aweish and wi misclassify a majority of shadow areas as water resulting in an overestimation of the water body but mndwi andwi and aweinsh successfully suppress a majority of the noises generated by shadows fig 6 in this scenario implementing otsu thresholding by selecting an area with a mixture of pixels from water shadow and soil prompts a significant improvement of all normalized water indices andwi mndwi and ndwi but reduces the classification accuracy of non normalized indices aweinsh aweish and wi finally in a scenario of frozen water site 7 multiple lakes in tibet all indices performed relatively well fig s9 further discussion and qualitative analysis can be found in the supplementary materials 3 2 quantitative analysis we also quantitatively evaluated the performance of the proposed index andwi and other spectral water indices by comparing different accuracy metrics including percentages of commission and omission errors precision recall accuracy f1 score and cohen s kappa coefficient table s1 as in section 3 1 seven scenarios were considered to assess the robustness of various indices results of quantitative analysis with cohen s kappa coefficient for each scenario and the overall kappa coefficient for all scenarios combined are summarized in table 1 andwi with zero thresholding shows high classification accuracy in most scenarios although it introduces minor commission errors when the background consists of shadows and low albedo surfaces andwi with otsu thresholding resolves challenges with commission errors and removes noise generated from low albedo surfaces and shadows e g achieves 100 precision in urban areas in urban areas otsu thresholding with andwi causes minor underestimation of water bodies omission errors as compared to zero thresholding lowering the recall from 100 to 97 table s1 further andwi with otsu thresholding can detect muddy waters and waters concealed by dust storms table 1 it also has the highest accuracy when it comes to distinguishing dark vegetation from water ndwi however lacks the generalizability needed to detect water in various scenarios according to its overall accuracy f1 score and kappa coefficient table s1 as an example for muddy water ndwi has a 100 omission error i e a complete miss rate and for hydrothermal water it has relatively high commission and omission errors that result in 90 precision and 74 recall in most studied scenarios otsu thresholding significantly improved the ndwi s accuracy only in frozen water and ice does the use of otsu thresholding result in a decrease 3 in precision of ndwi compared to zero thresholding mndwi with zero thresholding is only unbiased in the muddy water scenario the classification accuracy of mndwi with otsu thresholding is greatly improved by minimizing commission errors making it the second best index after andwi in terms of overall accuracy f1 score and kappa coefficient table s1 the mndwi s accuracy is however compromised when dark vegetation is present in the image with zero thresholding and in the dark vegetation scenario mndwi has a very high commission error and misclassifies dark vegetation as water rendering a very low precision 70 implementing otsu thresholding improves mndwi s precision to some extent 76 but does not resolve the misclassification issue due to the absence of the red and nir bands that are required to capture dark vegetation both awei indices with zero thresholding show high classification accuracy under certain scenarios while having extremely poor performance in others aweinsh with zero thresholding cannot effectively separate dark vegetation from water resulting in significant commission errors and low precision 78 it also produces significant omission errors when classifying hydrothermal water and offers a very low recall 59 when a dust storm passes over a water body the miss rate of aweinsh with zero thresholding increases and results in a notable underestimation of the surface water area as documented by its low recall 13 otsu thresholding in general did not help with the efficacy of aweinsh compared to zero thresholding as is the case for all non normalized water indices the occurrence of dust storms over a water body was the only scenario in which otsu thresholding helped improve aweinsh accuracy the other form of this index aweish is an effective index in most studied scenarios but its accuracy is challenged in urban and mountainous areas due to the presence of shadows shadows from mountainous areas introduce substantial commission errors that lower the precision of this index 46 finally wi with zero thresholding has significant commission errors and renders relatively low precision in mountainous and urban areas 84 and 95 respectively due to the presence of shadows and low albedo surfaces the wi s efficacy as for other non normalized water indices was compromised by otsu thresholding in most scenarios and the only instance where otsu thresholding improved the wi s accuracy was in detecting water concealed by dust storms wi also shows a relatively low recall 89 and precision 93 in the hydrothermal water scenario implying that wi was not able to identify all water pixels correctly nevertheless this index performed relatively well in other scenarios 3 3 cloud filtering algorithm traditional cloud filtering algorithms often discard several images and introduce gaps in the long term monitoring water resources our analysis however shows that even when clouds obscure a significant portion of some images the imagery may still be useful for monitoring of water bodies in fig 7 b for example even though the percentage of cloud coverage is more than that of fig 7a 34 5 vs 24 6 clouds are not obscuring the water body rendering this image acceptable for surface water mapping whereas clouds in fig 7a are obscuring the water body requiring this image to be discarded therefore using percentage based cloud filtering methods can induce improper removal of useable imagery another commonly used method only masks cloud obscured pixels of images landsat level 1 data products include a quality assessment qa band based on cfmask foga et al 2017 which is presented as bit mapped values for example bits 3 and 5 represent cloud shadow and cloud respectively and bit 7 presents cloud confidence foga et al 2017 detailed analysis however shows that this approach can result in faulty removal of pixels with high reflectance from water bodies and hot sands fig 8 a shows a true color image from landsat 8 without any masking in which no cloud cover is observed fig 8b shows the image with shadows being masked fig 8c shows the same image with clouds being masked and fig 8d shows the image with both clouds and cloud shadows being masked these figures clearly point to faulty detection of water and hot sand pixels as cloud and cloud shadow fig 9 illustrates a time series of water body area for the kajaki reservoir in afghanistan between 1984 and 2020 obtained using two different approaches gee cloud percentage based orange dots and our proposed cloud filtering algorithm blue dots based on the functional difference of water indices it is evident that percentage based cloud filtering significantly reduces the number of useable landsat images for the studied area our proposed algorithm resulted in more than twice the number of useable images compared to filtering scenes based on their cloud percentage 240 observations with our proposed approach compared to 107 observations with a 1 cloud cover threshold note that 1 cloud cover is chosen here since most spectral water indices detect clouds as water and therefore a cloud free composite is required to generate unbiased estimates of water area in conventional percentage based cloud filtering approaches the gap in the plot is a result of the absence of landsat 5 imagery and scan line corrector failure in landsat 7 that created wedge shaped gaps in the imagery for this particular region between mid 2003 and mid 2008 4 discussion automating the process of surface water delineation enables time series analysis of water resources and has been a topic of interest for decades chignell et al 2015 while several spectral water indices have been introduced in the literature little analysis has been conducted to evaluate the performance of different water indices for a comprehensive set of scenarios with different noise characteristics ji et al 2009 studies often consider only a few scenarios of noisy scenes such as studies by feyisa et al 2014 that assessed water indices in the presence of shadow and dark surfaces in urban areas and xu 2006 that studied the impact of noises generated from vegetation and soil on water indices in this study we evaluated the classification accuracy of several spectral water indices for a comprehensive set of extreme water and atmospheric conditions high and low albedo and background land cover types further we developed the augmented normalized difference water index andwi as a universal robust index to accurately map water bodies under various atmospheric and terrestrial conditions our results show that although each spectral water index performed well under certain environmental conditions they except for andwi could not be generalized to all conditions andwi once coupled with otsu thresholding can produce higher classification accuracy as compared to non normalized indices aweish aweinsh and wi and therefore has more flexibility to adapt to different background noises and ambient atmospheric conditions similar results were obtained in a study by xie et al 2016 for mndwi we further show that andwi by incorporating more spectral bands compared to mndwi is a more flexible water index for separating dark vegetation surfaces from water surfaces which is useful to separate densely vegetated islands within bodies of water or late season crops in agricultural areas from water bodies see supplementary materials fig s10 the presence of dark vegetation inside water bodies however can be misleading as some aquatic plants float on the water surface blocking the water body and thereby causing underestimation of the water body with andwi in such cases although andwi separates floating aquatic plants from water otsu thresholding can be used to effectively classify these plants as water by tuning the separating threshold fig 10 shows the nong han lake some portions of which pointed by green arrows are covered with floating aquatic plants to classify areas with floating aquatic vegetation as water we select a sampling area with a combination of land aquatic vegetation and water pixels and create a histogram of andwi pixel values for automatic threshold selection by the otsu algorithm green rectangle in fig 10b the otsu method uses bimodal histograms of andwi values for selected sampling areas and minimizes intraclass variance and maximizes interclass variance this allows appropriate thresholding in the presence of aquatic vegetation however if the selected sampling area does not contain aquatic vegetation andwi would classify aquatic vegetation floating on the surface of the lake as non water red rectangle in fig 10a furthermore we demonstrate that the higher reflectance in the nir and swir1 2 bands in the presence of dust storms and for hydrothermal and muddy water conditions as compared to those of clear water and clear sky can result in significant omission errors in ndwi in particular ndwi is unable to successfully detect water in these scenarios i e omission error regardless of the choice of thresholding as it does not include swir bands in its formula equation 1 using otsu thresholding with ndwi significantly reduces the commission errors generated from shadows and low albedo surfaces but it does not reduce the omission errors due to lack of representative spectral information absence of swir bands the widely used awei indices are among the most effective spectral water indices in the literature for delineation of water bodies in urban areas our study however indicates that the efficacy of aweinsh is compromised when mapping i hydrothermal waters ii waters obscured by dust storms and iii water bodies that have dark vegetation in the scene we also show that although aweish misclassified dark and bright rooftops shadows and dark vegetation as water it offers a relatively higher overall accuracy compared to aweinsh in all studied scenarios this agrees with the findings of zhang et al 2017 who demonstrated that both awei indices show high misclassification in turbid water based on the accuracy f1 score and kappa coefficient table s1 we conclude that i the calibrated coefficients in aweinsh and aweish although effective in general may not sufficiently represent all scenarios and or ii the difference in the green and all nir and swir bands in aweinsh and the difference in the green blue and all nir and swir bands in aweish may not be adequate to characterize all water conditions and suppress background noises based on the obtained accuracy results table 1 we do not recommend otsu thresholding with aweinsh and aweish wi shows relatively good overall performance for all scenarios and offers an overall higher accuracy compared to both aweis however the performance of this index is compromised in urban and mountainous areas where there is abundant noise as a result of low albedo features such as asphalts and shadows wi also overestimates hydrothermal water by capturing steam as water similar to aweis the use of otsu thresholding is not recommended for wi finally cloud filtering is also a major issue in the long term monitoring of surface water we show that machine learning based masking of clouds and shadows can induce inappropriate removal of water bodies and can cause underestimation of a total water body area our proposed cloud filtering algorithm is also a remedy for the loss of useable imagery in cloud percentage based image filtering in which images with higher cloud coverage than a specific percentage e g 1 wang et al 2018 0 donchyts et al 2016 are discarded our method only removes images in which clouds conceal the water body regardless of the percentage of clouds in the scene this is especially relevant in tropical climates where cloud interference results in higher percentages of cloudy scenes li et al 2016 our proposed cloud filtering algorithm provides more frequent more than twice water body observations in the study area compared to the conventional cloud percentage based image filtering approach 5 conclusion we introduce a novel spectral water index augmented normalized difference water index andwi that uses an expanded spectral range from landsat imagery to resolve limitations of existing water indices we critically evaluate the performance of andwi as compared to widely used water indices ndwi mndwi wi aweish and aweinsh using seven different scenarios where the presence of certain land surface features challenges accurate classification of water bodies scenarios include urban areas hydrothermal water muddy water presence of dark vegetation in the scene dust storms over the water body mountains with abundant shade area and frozen water and ice the evaluated spectral water indices perform well in some scenarios and poorly in others whereas the proposed andwi index consistently performs well in all scenarios results indicate that andwi not only is an accurate water index but also is a robust method that can be used under different environmental conditions across the globe we also show that dynamic thresholding with the otsu method enhances the accuracy of andwi this approach provides an accuracy of more than 95 for all scenarios except for hydrothermal and frozen water and ice scenarios that are associated with 85 95 accuracy for which other indices offer 20 95 accuracy in other words andwi with otsu thresholding is robust computationally efficient and offers the highest accuracy compared to other water indices making it an ideal water mapping tool this approach does not require training and retraining processes of a machine learning framework and is easily transferable across platforms e g envi arcgis gee further we demonstrate that conventional methods for handling cloudy images may not be ideal for long term monitoring of water bodies we show that the cloud masking approach may result in faulty removal of water pixels and areas with high reflectance such as hot sands as clouds which ultimately prompts an underestimation of the actual area of the water body filtering images based on cloud percentage also results in unnecessary removal of images that can be used for water mapping clouds not covering water body to tackle these problems we propose a cloud filtering algorithm based on the functional difference between two spectral water indices one classifying clouds as water and the other not results show that the proposed algorithm can increase the number of valid images images with clouds not concealing water boundaries for a case study of kajaki reservoir by 124 from 1984 to 2020 thus providing more frequent observations finally we develop a gee app that uses our proposed cloud filtering approach to maximize the number of landsat images for study areas of interest and enables the user to select any of the discussed spectral water indices to delineate water bodies this app is freely available to the public at https arashmodrad github io water mapping app and produces16 day time series of surface water areas from 1984 present declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this study is partially supported by the hydroinformatics fellowship from cuahsi with support from the national science foundation nsf cooperative agreement no ear 1849458 and the u s geological survey s land change science program this manuscript is submitted for publication with the understanding that the united states government is authorized to reproduce and distribute reprints for governmental purposes any use of trade product or firm names is for descriptive purposes only and does not imply endorsement by the united states government the authors appreciate the support from the u s geological survey through the provision of digitalglobe worldview 2 and 3 imagery under the nga nextview license agreement landsat and sentinel imagery were acquired and processed through the google earth engine javascript api appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2021 105030 app availability the app generated for this study is available at https arashmodrad github io water mapping app that can be cloned using the instructions on the websitecite this app as modaresi rad a 2020 water mapping app hydroshare http www hydroshare org resource 4dbd35f77b89416eaa0e44f5119eb72c 
25837,cassie is an open source web tool for automatic shoreline mapping and analysis using satellite imagery www cassiengine com this tool was built in javascript using google earth engine gee api and can be applied to any coastal region on earth where a boundary between water and land exists cassie use the landsat and sentinel 2 satellite imagery freely available from gee and implements an automatic shoreline detection using the normalized difference water index ndwi together with otsu image segmentation algorithm the satellite derived shorelines are analysed for a set of user defined cross shore transects along which several statistical analyses are performed comparisons of the cassie derived shorelines and rate of changes with state of the art methods show that the products from this tool have sub pixel accuracy the new concept of big data cloud based computing and storage platform gee together with a user friendly interface and high level of automation makes of cassie a complete tool to support a wide variety of studies and applications where the knowledge of the shoreline behaviour is fundamental keywords shoreline evolution google earth engine remote sensing coastal management software availability software name cassie developer rudimar luís scaranto dazzi rodrigo lyra and israel efraim de oliveira luis pedro almeida antonio henrique da fontoura klein year first official release 2019 hardware requirements pc smartphone or tablet system requirements windows linux mac program language javascript program size not applicable works online availability http cassiengine com license gpl3 documentation http cassiengine com 1 introduction the shoreline position defined as the interface between land and water surface is the most commonly used indicator to quantify erosion accretion changes in coastal areas douglas and crowell 2000 boak and turner 2005 hanslow 2007 luijendijk et al 2018 vousdoukas et al 2020 shorelines are inherently dynamic features in constant modification driven by natural processes such as wave induced runup and setup tides astronomic and meteorological and mean sea level oscillations or anthropogenic factors such as coastal structures and side effects of human activities like dams or clearing of coastal ecosystems such as mangrove forests mentaschi et al 2018 it is estimated that 24 of world s sandy coasts are suffering shoreline retreat rates exceeding 0 5 m yr while 28 are accreting and 48 are stable luijendijk et al 2018 land losses areas due to coastal erosion are significantly higher than the gained land and according to mentaschi et al 2018 anthropogenic factors are the dominant driver underlying this change currently the global mean sea level is rising at a rate of 2 9 mm yr nerem et al 2018 and more frequent extreme events are expected to occur mölter et al 2016 murakami et al 2017 increasing the likelihood of shoreline retreat being enhanced during the 21st century voudoukas et al 2020 shoreline monitoring is a vital element of planning and management of the coast to mitigate and adapt to impacts of climate change quantitative assessment of shoreline trends erosion or accretion is considered as a crucial indicator of coastal vulnerability to natural hazards and one of the most important parameters used to determine coastal vulnerability indices mclaughlin and cooper 2010 hzami et al 2021 or to feed shoreline prediction models e g montaño et al 2020 data scarcity however remains an ongoing challenge as long term coastal monitoring programs based on in situ measurements are limited to only a few sites around the world e g barnard et al 2015 turner et al 2016 publicly available earth observation satellite imagery e g nasa landsat missions or esa sentinel s mission emerge in this context as potential solution to overcome this problem providing long term observations since 1984 to the present for the case of landsat missions moderate spatial resolution pixel size between 10 and 30 m short revisit times between 5 and 16 days and worldwide coverage goward et al 2006 bergsma and almar 2020 previous studies have investigated the potential of medium spatial resolution satellite images to study shoreline change blodget et al 1991 white and el asmar 1999 liu and jezek 2004 ekercin 2007 wang et al 2010 pardo pascual et al 2012 vos et al 2019a uncertainties associated to the shoreline detection was found to be in the range between 5 m and 14 m e g garcia rubio et al 2015 wang et al 2018 pardo pascual et al 2018 yadav et al 2018 vos et al 2019b highlighting that these datasets are suitable to monitor moderate and significant structural changes in the shoreline position mapping and analysing shoreline evolution requires an exhaustive and multi task process that involves selection and download of satellite imagery freely available on usgs earth explorer portal or esa sentinel data hub image pre processing e g radiometric calibration and atmospheric corrections manual or automatic shoreline digitalization and statistical analysis e g using freely available software like digital shoreline analysis system thieler et al 2017 in addition to this the increasingly quality of satellite imagery higher spatial and radiometric resolution demands for higher computing capacity including storage space and processing power that are not always available especially in developing countries crucially the advent of google earth engine gorelick et al 2017 has facilitated the access to the growing archive of publicly available satellite imagery processing tools and computing power google cloud providing the opportunity for global scale analyses stretching back decades e g donchyts et al 2016 li et al 2019 luijendijk et al 2018 mentaschi et al 2018 in addition to the web platform with code editor that allow users to access and analyse historical remote sensing datasets google earth engine gee offers the possibility for developers to create their own tools using the gee application programming interface api advent of the use of gee technology is the recently developed coastsat software vos et al 2019b this toolkit was written in python and enables the user to obtain time series of shoreline position at any coastline worldwide of publicly available gee satellite imagery although coastsat implement novel shoreline detection techniques with sub pixel accuracy its use of gee platform is restricted to the access to the satellite imagery while the remaining processes are performed in other platforms in addition to this coastsat does not produce statistical analysis on the shoreline dataset which makes of this task dependent from other software s the aim of this work is to present a new webtool built with gee api cassie coastal analyst system from space imagery engine that can both automatically extract shoreline position from satellite imagery and perform statistical analysis at any coastal area worldwide in contrast with the existing tools that can only perform one of these tasks palomar vázquez et al 2018 vos et al 2019b jackson et al 2012 or thieler et al 2017 cassie combines these two processes into a single tool and in addition to this makes use of gee computing power storage google cloud that reduces the user requirement infrastructure to internet access only cassie webtool is freely available and can operate in different platforms e g desktop pc laptop or smartphone which makes of this tool highly portable e g can be used in classrooms workshops office or fieldwork with cassie is possible to perform shoreline analysis and export the products shorelines baseline transects and statistical results to esri shapefile format which allows the end user to further explore their datasets in gis tools in this work we present a detailed description of cassie workflow and implemented algorithms section 2 1 a comparison between cassie derived shoreline position with ground truth rtk gps shoreline observations and a comparison between cassie derived shoreline rates of change with existing similar datasets section 2 2 2 materials and methods 2 1 cassie workflow the shoreanalyst module of cassie is a graphical user interface gui built with javascript gee api and can be used to load and visualize satellite imagery and to conduct automatic shoreline detection and analysis to any location on earth where a boundary between water and land exist the workflow of the different processes that involve the user interaction with the gui and internal processing that leads to cassie results is presented in fig 1 and described in the following subsections 2 1 1 satellite mission time window and cloud filter the cassie enables access to all surface reflectance sr images from the landsat 5 tm landsat 7 emt and landsat 8 oli tier 1 collections and sentinel 2 msi level 1c products available in gee the landsat sr products masek et al 2006 vermote et al 2016 correct for atmospheric and illumination viewing geometry effects and are the highest level of image processing available for landsat data the sentinel 2 msi level 1c are provided in top of atmosphere toa reflectance along with the parameters to transform them into radiances table 1 summarizes the satellite data available on gee that can be used on cassie to reduce the size of imagery used a user defined region of interest roi is used to crop the images while still on the gee server in addition only the specific spectral bands that are required for the shoreline detection red green and near infrared bands are loaded and used in the process after the selection of the satellite mission and roi definition cassie performs a set of sequential operations in order to pre process the available images pre processing processes include image mosaicking process of spatially assembling image datasets to produce a spatially continuous image when roi intersects more than one tile image registration correction of horizontal displacements between images and cloud percentage calculated over the roi using cfmask foga et al 2017 following the initial pre processing the user is required to specify the temporal interval of the analysis using the slider bar and define the threshold of the cloud percentage 2 1 2 baseline and transects before cassie performs automatic shoreline detection on the pre selected images a baseline is required cassie shoreline statistics e g rate of change are based on the baseline distance method leatherman and clow 1983 thieler et al 1994 the baseline is manually digitized by the user and serves as the starting point for all transects cast by the cassie the baseline should be placed on the landward side and at a certain distance from the shoreline to avoid intersection with any historical shorelines after the drawing of the baseline the user is required to define transects spacing and length along which the shoreline change statistics will be evaluated fig 2 2 1 3 automatic shoreline detection cassie applies an automatic shoreline detection algorithm to the pre processed images which is performed using the normalized difference water index ndwi applied to each of the selected images as follows 1 n d w i n i r g r e e n n i r g r e e n where nir and green are the pixel sr reflectance in the near infrared band and green band respectively when the resulting ndwi image has a clear bimodal histogram the two classes land and water are well distinguish in the image the water body and land are classified using a two classes otsu s thresholding algorithm otsu 1979 although when the histogram of the ndwi image presents three peaks as for example in estuarine environments where intertidal features typically composed by muddy or fine sand sediments with high water content create a peak between land and water the two classes otsu s thresholding produces a poor land water classification fig 3 b as a result an undesirable seaward shift on the satellite derived shorelines can be observed for these cases a multilevel otsu thresholding algorithm liao et al 2001 is implemented and the ndwi image histogram is first classified into three classes water land and intertidal features fig 3c according with the frequency of similar ndwi pixel values lower ndwi values darker pixels in fig 3 that reflect lower water content are grouped into the land class higher ndwi values lighter pixels in fig 3 into the water class while the intermediate ndwi values which reveal some water content are grouped into the intertidal features class finally water and intertidal features classes are grouped into a single class identified as water in fig 3e improving the land water segmentation fig 3c by default cassie uses the two classes otsu algorithm otsu 1979 for ndwi thresholding when the threshold field in the input parameters dialog box is set equal to zero see fig 2 and if the user wants to use the three classes multilevel otsu thresholding algorithm it needs to set to 1 the field threshold in the input parameters dialog box fig 2 the ndwi image classification results in a binary image where pixel values equal to zero means water and pixels equal to one are relative to land that is after vectorised into polygons fig 4 b the polygon edge that first intersects with the pre defined transects is identified as the shoreline fig 4c while the remaining polygons are ignored finally the extracted shoreline is smoothed using a 1d gaussian smoothing filter fig 4d which consists in a moving average filter that removes the pixel induced staircase effect from digitized shoreline vector the filter is controlled by two parameters 1 the kernel size that determines how many neighbour points are considered in the local moving average and 2 the standard deviation that regulates the gaussian curve which defines the weights given to each of the neighbour points used in the moving average procedure 2 1 4 shoreline statistical analysis after the automatic shoreline extraction from all the selected images cassie computes a set of statistical analysis for each individual transect following the approach used in the software digital shoreline analysis system dsas thieler et al 2017 described below shoreline change envelope sce the distance in meters between the shoreline farthest from and closest to the baseline at each transect net shoreline movement nsm distance in meters between the oldest and youngest shorelines for each transect end point rate epr rate of shoreline change in meters year calculated by dividing the distance of shoreline movement by the time elapsed between the oldest and the most recent shoreline linear regression rate lrr rate of shoreline change in meters year based on the slope of the linear regression line and computed by fitting a least squares regression line to all shoreline points for all transects the lrr results are classified using the chronic beach erosion classification scheme proposed by esteves e finkl 1998 following the below scheme table 2 2 1 5 visualization shoreline analysis report and data exportation when cassie finalize all the statistical calculations the results are added to a final map where the baseline shorelines and transects can be visualized over either a high resolution satellite image or google map base map to choose the type of base map two pushbuttons will be available in the upper left corner of the final map the transects are coloured according to the classification of the lrr results table 2 to facilitate a preliminary qualitative assessment of the spatial variability of the shoreline trends the user is allowed to perform a query to all the transect individually which will automatically open a scatter plot of the time series of shoreline positions distance to the baseline used in the statistical analysis together with a short report of the results computed for the selected transect fig 5 a final report containing all the statistical results in the form of a table is also added automatically to the map fig 6 the information in this report is organized in a table where the lines correspond to the different transect and columns to the statistical parameters additional information including the geographical coordinates in wgs84 coordinate system of the transects or the statistical parameters e g slope of the linear fit and correlation coefficient of the fit that describe the goodness of the fit are also included in this report fig 6 the information in the report embedded in the attribute table of the transects geometry and together with the shorelines and baseline can be exported in three formats esri shapefile shp javascript object notation json or comma separated values file csv 2 2 accuracy assessment of cassie derived shoreline products the accuracy of the resulting satellite derived shoreline position and rate of changes were assessed by performing the following comparisons 2 2 1 cassie derived shoreline position and in situ measurements the cassie derived shoreline position was compared with a in situ shoreline survey performed along four sandy beaches canasvieiras ingleses jurere and santinho in the island of santa catarina brazil between the 10 and 17 of june 2013 fig 7 these sandy beaches are composed by well sorted fine sand medium sediment size of approximately 0 2 mm and vary from sheltered reflective beaches ingleses canasvieiras and jurere to intermediate beach santinho in the east klein et al 2016 the wave climate in this region is characterized by dominant south waves with offshore significant wave height hs varying between 1 and 1 5 m and average wave peak period tp of 12 s the largest waves come from south and southeast direction with hs greater than 4 m and average tp above 11 s da silva et al 2016 the astronomical tide is microtidal ranging between 0 4 and 1 2 m during neap and spring tides periods respectively whereas the low frequency oscillations including storm surges can be as high as 1 m truccolo et al 2004 the in situ survey was performed on foot with real time kinematic differential global positioning system rtk dgps mounted on a wheel rover rod fig 7 operating in continuous mode measuring at 1 hz and using the high water level mark hwl as the shoreline indicator fig 7 this type of in situ shoreline survey has a sub decimetre accuracy e g baptista et al 2008 harley et al 2011 considering the rover rod operation errors including the sinking tilting and shaking and the errors associated to the visual identification of the high water level mark for comparisons a single landsat 8 oli sensor scene was selected acquired along the path 220 row 79 on the 4 of june 2013 at 13 13 gmt in cassie and the derived shoreline position compared with in situ measurements at all the four selected beaches along a number of transects fig 7 to assess the effect of 1d gaussian smoothing filter on the location of the cassie derived shoreline preliminary sensitivity analysis was performed to the 1d gaussian smoothing filter different levels of smoothing were tested by changing the number of points that define the kernel window and the standard deviation values that define the gaussian curve and the results were compared with the in situ shoreline observations and the best combination of parameters was defined and set as default in cassie 2 2 2 cassie derived shoreline rate of change with other similar works the cassie derived shoreline linear rate of change lrr was compared with rate of changes estimated by luijendijk et al 2018 for eight coastal segments along the coast of brazil fig 8 for the period 1984 to 2016 in the work presented by luijendijk et al 2018 a global scale assessment of the shoreline lrr computed along a global shoreline with transects spaced by 500 m was performed using yearly composite landsat images aggregating all the images of each year in single scenes to identify shoreline position the accuracy of satellite derived shorelines method used by luijendijk et al 2018 is with subpixel precision smaller than 10 30 m but according to hagenaars et al 2018 can deteriorate in the presence of clouds and or waves leading seaward offset of multiple pixels on the image a number of factors were considered to use the luijendijk et al 2018 datasets for comparison with cassie derived shoreline lrr estimates 1 both cassie and luijendijk et al 2018 use a similar methodological approach for shoreline mapping and analysis 2 luijendijk et al 2018 datasets were validated with field observation therefore they can be used has a reference for this comparison 3 the lrr results are freely available on a global scale offering the possibility to perform comparisons in distinct coastal environments and in some cases where in situ observations are inexistent e g estuarine environments the study sites were specifically selected to cover the full variability of coastal environments of brazil classified by short and klein 2016 based on the geological geomorphological and relative tide range rtr characteristics table 3 the cassie derived shorelines were obtained using the landsat mission including 5 7 and 8 imagery and were combined and averaged into mean annual shorelines that were further used to estimate the rates of changes similarly to the methodology implemented by luijendijk et al 2018 the comparisons were performed along cross shore transects with 500 m spacing used in luijendijk et al 2018 for the estuarine environments aoi 1 2 and 8 the multilevel otsu thresholding algorithm was implemented the aforementioned comparisons were evaluated through conventional statistical analysis the latter consisted of a calculation of the following parameters 1 correlation coefficient cc 2 bias and 3 root mean squared error rmse 3 results and discussion 3 1 comparison of shoreline position with in situ measurements the comparison between the cassie derived shorelines retrieved from landsat 8 image using different levels of smoothing and rtk gps in situ observations show an overall very good agreement with the best scores showing coefficient of determination of 0 95 and a rmse of 8 84 m using 3 neighbour points and 0 75 standard deviation fig 9 these parameters that resulted in the best scores were set as default in cassie smoothing filter similar method 1d gaussian filter and number of points are used in the shoreline smoothing process used by luijendijk et al 2018 nevertheless is not specified the standard deviation value used from the present results fig 9 is possible to verify that using 3 points and varying the standard deviation values can result in a maximum error increment of about 1 6 m rmse from this evaluation is possible to verify that this smoothing method is more sensitive to variations in the number of points produce larger errors than the standard deviation parameter fig 9 the obtained rmse values are within the magnitude of errors observed in previous studies that from comparisons between satellite derived shorelines and in situ observations found rmse values that vary between 1 48 and 36 47 m hagenaars et al 2018 or do et al 2018 for imagery with spatial resolution between 10 and 30 m and 4 69 12 7 m when sub pixel shoreline extraction methods when original pixel is downsampled before shoreline detection were implemented muslim et al 2007 pardo pascual et al 2012 or vos et al 2019a the comparison between cassie derived shorelines and rtk gps in situ observations using the best smoothing configuration are represented in fig 10 all the observed differences between cassie derived shoreline position retrieved from landsat 8 image and rtk gps survey were found to be under the pixel size 30 m nevertheless the cassie derived shorelines are found to be biased in seaward direction relative to the in situ shoreline surveys by average of 8 3 m fig 10 similar behaviour has been identified by almonacid caballer et al 2016 who found on both instantaneous and mean annual shorelines derived from landsat a seaward bias of about 4 5 m compared to those obtained using lidar and rtk gps factors such as the short term shoreline displacements associated to wave run up or the width of the intertidal zone can affect the accuracy of satellite shoreline extraction and have been identified in previous studies as the cause of this seaward shoreline displacement almonacid caballer et al 2016 do et al 2018 in addition to the aforementioned factors in the present comparison were identified two additional aspects that can explain the identified seaward shift in the cassie derived shorelines 1 the time lag between the image acquisition and in situ survey or 2 the use of a different shoreline indicator considering that cassie shoreline indicator is the instantaneous land water edge while the high water mark was the shoreline indicator used in the rtk survey fig 7 it is expected that the latter will be invariably located landward from the instantaneous water level thus creating this constant shift 3 2 comparison with other similar works the comparison between cassie derived and luijendijk et al 2018 shoreline rate of changes evaluated by comparing the parameter lrr show an overall good agreement with the statistical evaluation showing correlation coefficient of 0 85 rmse of 2 41 m yr and bias of 0 091 m yr fig 11 the observed errors are within the magnitude of errors of the shoreline detection method identified in this work and in previous studies e g hagenaars et al 2018 thus demonstrating that cassie has the skills to estimate structural shoreline rate of changes of a variety of coastal environments from all the coastal environments analysed the aoi 2 located in caranguejo island maranhão state was the one where the highest magnitude of lrr changes both positive and negative and at the same time the highest rmse values fig 11 this coastal area is located on a very active region characterized by both extreme coastal erosion and accretion mentashi et al 2018 where according to vousoukas et al 2020 projections significant shoreline erosion is expected to happen by 2050 and 2100 fig 12 compares the lrr estimates for cassie and luijendijk et al 2018 along the 38 cross shore transects analysed within aoi 2 the purpose of fig 12 is to demonstrate that despite some level of variability found between the two datasets fig 10 cassie derived lrr values follow well the direction of the shoreline trend accretion or erosion and only in a few sections of the coast the magnitude of the rates differs in addition in fig 12 is presented the cassie derived shoreline position for 1986 and 2015 where is possible to verify that cassie was capable to capture important shoreline modifications important to note that the use of a multilevel otsu thresholding algorithm liao et al 2001 in estuarine environments exemplified by the results presented in fig 12 showed to be an efficient method to eliminate intertidal features such as sand mud terraces typically present in estuarine macro tidal environments similar to other studies e g hagenaars et al 2018 kuleli et al 2011 liu et al 2017 cassie shoreline detection method is based on an image thresholding algorithm that is applied only to the user defined area of interest aoi the inclusion of an automatic multilevel otsu thresholding algorithm liao et al 2001 in cassie improves the shoreline detection in estuarine environments by removing undesirable low tide morphological features with high content of water such as tidal flats other tools such as coastsat vos et al 2019a deal with this by performing a supervised land cover classification to extract the boundary between pre classified water and sand pixels only removing from this process all additional land cover elements e g buildings roads white water rocky headlands this approach requires a user interaction for the training the classification algorithm and more computing power for the image processing in cassie the implemented method multilevel otsu is automatic and faster nevertheless restricted to three classes 3 3 limitations and future developments although the quantitative evaluation of the cassie derived shows good results figs 10 and 11 further verification is essential especially on estuarine environments rocky coastlines or coarse grained beaches where comparisons are lacking or scarce in the literature as demonstrated by liu et al 2017 the accuracy of satellite shoreline detection can be improved if sub pixel resolution border segmentation and tide correction is implemented in the present version of cassie the shoreline is derived from natural resolution satellite imagery and a future development includes employing the super resolution border segmentation method described by liu et al 2017 tide correction is not applied in the present version of cassie because no tidal model or dataset is available in gee platform for the moment this aspect can represent an important source of errors in the shoreline analysis e g rates of changes in coastal regions with macrotidal amplitudes where the difference between low and high tide can imply hundreds of meters of difference in the shoreline position nevertheless to overcome this limitation cassie provides to the user the possibility to remove some of the pre select the images manually from the analysis this option offers the possibility to the user to only select the images that were acquired with the same tide level further developments include the addition of the astronomical tide information and consequent shoreline horizontal correction liu et al 2017 an alternative method to avoid astronomical tidal influence in the shoreline extraction is the use of annual composite images luijendijk et al 2018 nevertheless this approach significantly reduces the length of the dataset and hampers analysis at sub annual temporal scales 4 conclusions this work describes and demonstrates capabilities of a new tool cassie for automatic shoreline mapping and analysis based on satellite imagery cassie was built with javascript gee api and can be applied to any location on earth where a boundary between water and land exists cassie makes use of the landsat and sentinel 2 satellite imagery available on gee and of the power computing capacity and storage of google cloud therefore it can be run from a standard desktop laptop or smartphone and the only requirement is an internet access and browser the comparison between cassie derived shorelines and rate of changes show that this tool can perform shoreline detection with sub pixel accuracy rmse of 7 97 m and quantify structural shoreline trends similar state of the art methods the main current limitation of cassie is the absence of global tide predictions datasets on gee necessary to correct tide induced shoreline displacements on the time of the image acquisition further investigation on methodological procedures to link global tidal datasets to cassie via gee will be developed to overcome this limitation finally the limited logistical requirements together with the user friendly interface and fully automatic shoreline extraction and analysis makes of cassie an important tool for shoreline management in developing countries declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to thank the conselho nacional de desenvolvimento científico e tecnológico cnpq and ministério da ciência tecnologia e inovações mctic of brazil for funding this research project no 441545 2017 3 the authors would like to thank the national fund on climate change of the ministry of the environment of brazil process number 352012 for sharing the field observations of the shoreline position measured by rtk gps the authors would like to thank franco prado and maiara werner both from loc ufsc for the provided shoreline data and support on the initial development of the tool respectively 
25837,cassie is an open source web tool for automatic shoreline mapping and analysis using satellite imagery www cassiengine com this tool was built in javascript using google earth engine gee api and can be applied to any coastal region on earth where a boundary between water and land exists cassie use the landsat and sentinel 2 satellite imagery freely available from gee and implements an automatic shoreline detection using the normalized difference water index ndwi together with otsu image segmentation algorithm the satellite derived shorelines are analysed for a set of user defined cross shore transects along which several statistical analyses are performed comparisons of the cassie derived shorelines and rate of changes with state of the art methods show that the products from this tool have sub pixel accuracy the new concept of big data cloud based computing and storage platform gee together with a user friendly interface and high level of automation makes of cassie a complete tool to support a wide variety of studies and applications where the knowledge of the shoreline behaviour is fundamental keywords shoreline evolution google earth engine remote sensing coastal management software availability software name cassie developer rudimar luís scaranto dazzi rodrigo lyra and israel efraim de oliveira luis pedro almeida antonio henrique da fontoura klein year first official release 2019 hardware requirements pc smartphone or tablet system requirements windows linux mac program language javascript program size not applicable works online availability http cassiengine com license gpl3 documentation http cassiengine com 1 introduction the shoreline position defined as the interface between land and water surface is the most commonly used indicator to quantify erosion accretion changes in coastal areas douglas and crowell 2000 boak and turner 2005 hanslow 2007 luijendijk et al 2018 vousdoukas et al 2020 shorelines are inherently dynamic features in constant modification driven by natural processes such as wave induced runup and setup tides astronomic and meteorological and mean sea level oscillations or anthropogenic factors such as coastal structures and side effects of human activities like dams or clearing of coastal ecosystems such as mangrove forests mentaschi et al 2018 it is estimated that 24 of world s sandy coasts are suffering shoreline retreat rates exceeding 0 5 m yr while 28 are accreting and 48 are stable luijendijk et al 2018 land losses areas due to coastal erosion are significantly higher than the gained land and according to mentaschi et al 2018 anthropogenic factors are the dominant driver underlying this change currently the global mean sea level is rising at a rate of 2 9 mm yr nerem et al 2018 and more frequent extreme events are expected to occur mölter et al 2016 murakami et al 2017 increasing the likelihood of shoreline retreat being enhanced during the 21st century voudoukas et al 2020 shoreline monitoring is a vital element of planning and management of the coast to mitigate and adapt to impacts of climate change quantitative assessment of shoreline trends erosion or accretion is considered as a crucial indicator of coastal vulnerability to natural hazards and one of the most important parameters used to determine coastal vulnerability indices mclaughlin and cooper 2010 hzami et al 2021 or to feed shoreline prediction models e g montaño et al 2020 data scarcity however remains an ongoing challenge as long term coastal monitoring programs based on in situ measurements are limited to only a few sites around the world e g barnard et al 2015 turner et al 2016 publicly available earth observation satellite imagery e g nasa landsat missions or esa sentinel s mission emerge in this context as potential solution to overcome this problem providing long term observations since 1984 to the present for the case of landsat missions moderate spatial resolution pixel size between 10 and 30 m short revisit times between 5 and 16 days and worldwide coverage goward et al 2006 bergsma and almar 2020 previous studies have investigated the potential of medium spatial resolution satellite images to study shoreline change blodget et al 1991 white and el asmar 1999 liu and jezek 2004 ekercin 2007 wang et al 2010 pardo pascual et al 2012 vos et al 2019a uncertainties associated to the shoreline detection was found to be in the range between 5 m and 14 m e g garcia rubio et al 2015 wang et al 2018 pardo pascual et al 2018 yadav et al 2018 vos et al 2019b highlighting that these datasets are suitable to monitor moderate and significant structural changes in the shoreline position mapping and analysing shoreline evolution requires an exhaustive and multi task process that involves selection and download of satellite imagery freely available on usgs earth explorer portal or esa sentinel data hub image pre processing e g radiometric calibration and atmospheric corrections manual or automatic shoreline digitalization and statistical analysis e g using freely available software like digital shoreline analysis system thieler et al 2017 in addition to this the increasingly quality of satellite imagery higher spatial and radiometric resolution demands for higher computing capacity including storage space and processing power that are not always available especially in developing countries crucially the advent of google earth engine gorelick et al 2017 has facilitated the access to the growing archive of publicly available satellite imagery processing tools and computing power google cloud providing the opportunity for global scale analyses stretching back decades e g donchyts et al 2016 li et al 2019 luijendijk et al 2018 mentaschi et al 2018 in addition to the web platform with code editor that allow users to access and analyse historical remote sensing datasets google earth engine gee offers the possibility for developers to create their own tools using the gee application programming interface api advent of the use of gee technology is the recently developed coastsat software vos et al 2019b this toolkit was written in python and enables the user to obtain time series of shoreline position at any coastline worldwide of publicly available gee satellite imagery although coastsat implement novel shoreline detection techniques with sub pixel accuracy its use of gee platform is restricted to the access to the satellite imagery while the remaining processes are performed in other platforms in addition to this coastsat does not produce statistical analysis on the shoreline dataset which makes of this task dependent from other software s the aim of this work is to present a new webtool built with gee api cassie coastal analyst system from space imagery engine that can both automatically extract shoreline position from satellite imagery and perform statistical analysis at any coastal area worldwide in contrast with the existing tools that can only perform one of these tasks palomar vázquez et al 2018 vos et al 2019b jackson et al 2012 or thieler et al 2017 cassie combines these two processes into a single tool and in addition to this makes use of gee computing power storage google cloud that reduces the user requirement infrastructure to internet access only cassie webtool is freely available and can operate in different platforms e g desktop pc laptop or smartphone which makes of this tool highly portable e g can be used in classrooms workshops office or fieldwork with cassie is possible to perform shoreline analysis and export the products shorelines baseline transects and statistical results to esri shapefile format which allows the end user to further explore their datasets in gis tools in this work we present a detailed description of cassie workflow and implemented algorithms section 2 1 a comparison between cassie derived shoreline position with ground truth rtk gps shoreline observations and a comparison between cassie derived shoreline rates of change with existing similar datasets section 2 2 2 materials and methods 2 1 cassie workflow the shoreanalyst module of cassie is a graphical user interface gui built with javascript gee api and can be used to load and visualize satellite imagery and to conduct automatic shoreline detection and analysis to any location on earth where a boundary between water and land exist the workflow of the different processes that involve the user interaction with the gui and internal processing that leads to cassie results is presented in fig 1 and described in the following subsections 2 1 1 satellite mission time window and cloud filter the cassie enables access to all surface reflectance sr images from the landsat 5 tm landsat 7 emt and landsat 8 oli tier 1 collections and sentinel 2 msi level 1c products available in gee the landsat sr products masek et al 2006 vermote et al 2016 correct for atmospheric and illumination viewing geometry effects and are the highest level of image processing available for landsat data the sentinel 2 msi level 1c are provided in top of atmosphere toa reflectance along with the parameters to transform them into radiances table 1 summarizes the satellite data available on gee that can be used on cassie to reduce the size of imagery used a user defined region of interest roi is used to crop the images while still on the gee server in addition only the specific spectral bands that are required for the shoreline detection red green and near infrared bands are loaded and used in the process after the selection of the satellite mission and roi definition cassie performs a set of sequential operations in order to pre process the available images pre processing processes include image mosaicking process of spatially assembling image datasets to produce a spatially continuous image when roi intersects more than one tile image registration correction of horizontal displacements between images and cloud percentage calculated over the roi using cfmask foga et al 2017 following the initial pre processing the user is required to specify the temporal interval of the analysis using the slider bar and define the threshold of the cloud percentage 2 1 2 baseline and transects before cassie performs automatic shoreline detection on the pre selected images a baseline is required cassie shoreline statistics e g rate of change are based on the baseline distance method leatherman and clow 1983 thieler et al 1994 the baseline is manually digitized by the user and serves as the starting point for all transects cast by the cassie the baseline should be placed on the landward side and at a certain distance from the shoreline to avoid intersection with any historical shorelines after the drawing of the baseline the user is required to define transects spacing and length along which the shoreline change statistics will be evaluated fig 2 2 1 3 automatic shoreline detection cassie applies an automatic shoreline detection algorithm to the pre processed images which is performed using the normalized difference water index ndwi applied to each of the selected images as follows 1 n d w i n i r g r e e n n i r g r e e n where nir and green are the pixel sr reflectance in the near infrared band and green band respectively when the resulting ndwi image has a clear bimodal histogram the two classes land and water are well distinguish in the image the water body and land are classified using a two classes otsu s thresholding algorithm otsu 1979 although when the histogram of the ndwi image presents three peaks as for example in estuarine environments where intertidal features typically composed by muddy or fine sand sediments with high water content create a peak between land and water the two classes otsu s thresholding produces a poor land water classification fig 3 b as a result an undesirable seaward shift on the satellite derived shorelines can be observed for these cases a multilevel otsu thresholding algorithm liao et al 2001 is implemented and the ndwi image histogram is first classified into three classes water land and intertidal features fig 3c according with the frequency of similar ndwi pixel values lower ndwi values darker pixels in fig 3 that reflect lower water content are grouped into the land class higher ndwi values lighter pixels in fig 3 into the water class while the intermediate ndwi values which reveal some water content are grouped into the intertidal features class finally water and intertidal features classes are grouped into a single class identified as water in fig 3e improving the land water segmentation fig 3c by default cassie uses the two classes otsu algorithm otsu 1979 for ndwi thresholding when the threshold field in the input parameters dialog box is set equal to zero see fig 2 and if the user wants to use the three classes multilevel otsu thresholding algorithm it needs to set to 1 the field threshold in the input parameters dialog box fig 2 the ndwi image classification results in a binary image where pixel values equal to zero means water and pixels equal to one are relative to land that is after vectorised into polygons fig 4 b the polygon edge that first intersects with the pre defined transects is identified as the shoreline fig 4c while the remaining polygons are ignored finally the extracted shoreline is smoothed using a 1d gaussian smoothing filter fig 4d which consists in a moving average filter that removes the pixel induced staircase effect from digitized shoreline vector the filter is controlled by two parameters 1 the kernel size that determines how many neighbour points are considered in the local moving average and 2 the standard deviation that regulates the gaussian curve which defines the weights given to each of the neighbour points used in the moving average procedure 2 1 4 shoreline statistical analysis after the automatic shoreline extraction from all the selected images cassie computes a set of statistical analysis for each individual transect following the approach used in the software digital shoreline analysis system dsas thieler et al 2017 described below shoreline change envelope sce the distance in meters between the shoreline farthest from and closest to the baseline at each transect net shoreline movement nsm distance in meters between the oldest and youngest shorelines for each transect end point rate epr rate of shoreline change in meters year calculated by dividing the distance of shoreline movement by the time elapsed between the oldest and the most recent shoreline linear regression rate lrr rate of shoreline change in meters year based on the slope of the linear regression line and computed by fitting a least squares regression line to all shoreline points for all transects the lrr results are classified using the chronic beach erosion classification scheme proposed by esteves e finkl 1998 following the below scheme table 2 2 1 5 visualization shoreline analysis report and data exportation when cassie finalize all the statistical calculations the results are added to a final map where the baseline shorelines and transects can be visualized over either a high resolution satellite image or google map base map to choose the type of base map two pushbuttons will be available in the upper left corner of the final map the transects are coloured according to the classification of the lrr results table 2 to facilitate a preliminary qualitative assessment of the spatial variability of the shoreline trends the user is allowed to perform a query to all the transect individually which will automatically open a scatter plot of the time series of shoreline positions distance to the baseline used in the statistical analysis together with a short report of the results computed for the selected transect fig 5 a final report containing all the statistical results in the form of a table is also added automatically to the map fig 6 the information in this report is organized in a table where the lines correspond to the different transect and columns to the statistical parameters additional information including the geographical coordinates in wgs84 coordinate system of the transects or the statistical parameters e g slope of the linear fit and correlation coefficient of the fit that describe the goodness of the fit are also included in this report fig 6 the information in the report embedded in the attribute table of the transects geometry and together with the shorelines and baseline can be exported in three formats esri shapefile shp javascript object notation json or comma separated values file csv 2 2 accuracy assessment of cassie derived shoreline products the accuracy of the resulting satellite derived shoreline position and rate of changes were assessed by performing the following comparisons 2 2 1 cassie derived shoreline position and in situ measurements the cassie derived shoreline position was compared with a in situ shoreline survey performed along four sandy beaches canasvieiras ingleses jurere and santinho in the island of santa catarina brazil between the 10 and 17 of june 2013 fig 7 these sandy beaches are composed by well sorted fine sand medium sediment size of approximately 0 2 mm and vary from sheltered reflective beaches ingleses canasvieiras and jurere to intermediate beach santinho in the east klein et al 2016 the wave climate in this region is characterized by dominant south waves with offshore significant wave height hs varying between 1 and 1 5 m and average wave peak period tp of 12 s the largest waves come from south and southeast direction with hs greater than 4 m and average tp above 11 s da silva et al 2016 the astronomical tide is microtidal ranging between 0 4 and 1 2 m during neap and spring tides periods respectively whereas the low frequency oscillations including storm surges can be as high as 1 m truccolo et al 2004 the in situ survey was performed on foot with real time kinematic differential global positioning system rtk dgps mounted on a wheel rover rod fig 7 operating in continuous mode measuring at 1 hz and using the high water level mark hwl as the shoreline indicator fig 7 this type of in situ shoreline survey has a sub decimetre accuracy e g baptista et al 2008 harley et al 2011 considering the rover rod operation errors including the sinking tilting and shaking and the errors associated to the visual identification of the high water level mark for comparisons a single landsat 8 oli sensor scene was selected acquired along the path 220 row 79 on the 4 of june 2013 at 13 13 gmt in cassie and the derived shoreline position compared with in situ measurements at all the four selected beaches along a number of transects fig 7 to assess the effect of 1d gaussian smoothing filter on the location of the cassie derived shoreline preliminary sensitivity analysis was performed to the 1d gaussian smoothing filter different levels of smoothing were tested by changing the number of points that define the kernel window and the standard deviation values that define the gaussian curve and the results were compared with the in situ shoreline observations and the best combination of parameters was defined and set as default in cassie 2 2 2 cassie derived shoreline rate of change with other similar works the cassie derived shoreline linear rate of change lrr was compared with rate of changes estimated by luijendijk et al 2018 for eight coastal segments along the coast of brazil fig 8 for the period 1984 to 2016 in the work presented by luijendijk et al 2018 a global scale assessment of the shoreline lrr computed along a global shoreline with transects spaced by 500 m was performed using yearly composite landsat images aggregating all the images of each year in single scenes to identify shoreline position the accuracy of satellite derived shorelines method used by luijendijk et al 2018 is with subpixel precision smaller than 10 30 m but according to hagenaars et al 2018 can deteriorate in the presence of clouds and or waves leading seaward offset of multiple pixels on the image a number of factors were considered to use the luijendijk et al 2018 datasets for comparison with cassie derived shoreline lrr estimates 1 both cassie and luijendijk et al 2018 use a similar methodological approach for shoreline mapping and analysis 2 luijendijk et al 2018 datasets were validated with field observation therefore they can be used has a reference for this comparison 3 the lrr results are freely available on a global scale offering the possibility to perform comparisons in distinct coastal environments and in some cases where in situ observations are inexistent e g estuarine environments the study sites were specifically selected to cover the full variability of coastal environments of brazil classified by short and klein 2016 based on the geological geomorphological and relative tide range rtr characteristics table 3 the cassie derived shorelines were obtained using the landsat mission including 5 7 and 8 imagery and were combined and averaged into mean annual shorelines that were further used to estimate the rates of changes similarly to the methodology implemented by luijendijk et al 2018 the comparisons were performed along cross shore transects with 500 m spacing used in luijendijk et al 2018 for the estuarine environments aoi 1 2 and 8 the multilevel otsu thresholding algorithm was implemented the aforementioned comparisons were evaluated through conventional statistical analysis the latter consisted of a calculation of the following parameters 1 correlation coefficient cc 2 bias and 3 root mean squared error rmse 3 results and discussion 3 1 comparison of shoreline position with in situ measurements the comparison between the cassie derived shorelines retrieved from landsat 8 image using different levels of smoothing and rtk gps in situ observations show an overall very good agreement with the best scores showing coefficient of determination of 0 95 and a rmse of 8 84 m using 3 neighbour points and 0 75 standard deviation fig 9 these parameters that resulted in the best scores were set as default in cassie smoothing filter similar method 1d gaussian filter and number of points are used in the shoreline smoothing process used by luijendijk et al 2018 nevertheless is not specified the standard deviation value used from the present results fig 9 is possible to verify that using 3 points and varying the standard deviation values can result in a maximum error increment of about 1 6 m rmse from this evaluation is possible to verify that this smoothing method is more sensitive to variations in the number of points produce larger errors than the standard deviation parameter fig 9 the obtained rmse values are within the magnitude of errors observed in previous studies that from comparisons between satellite derived shorelines and in situ observations found rmse values that vary between 1 48 and 36 47 m hagenaars et al 2018 or do et al 2018 for imagery with spatial resolution between 10 and 30 m and 4 69 12 7 m when sub pixel shoreline extraction methods when original pixel is downsampled before shoreline detection were implemented muslim et al 2007 pardo pascual et al 2012 or vos et al 2019a the comparison between cassie derived shorelines and rtk gps in situ observations using the best smoothing configuration are represented in fig 10 all the observed differences between cassie derived shoreline position retrieved from landsat 8 image and rtk gps survey were found to be under the pixel size 30 m nevertheless the cassie derived shorelines are found to be biased in seaward direction relative to the in situ shoreline surveys by average of 8 3 m fig 10 similar behaviour has been identified by almonacid caballer et al 2016 who found on both instantaneous and mean annual shorelines derived from landsat a seaward bias of about 4 5 m compared to those obtained using lidar and rtk gps factors such as the short term shoreline displacements associated to wave run up or the width of the intertidal zone can affect the accuracy of satellite shoreline extraction and have been identified in previous studies as the cause of this seaward shoreline displacement almonacid caballer et al 2016 do et al 2018 in addition to the aforementioned factors in the present comparison were identified two additional aspects that can explain the identified seaward shift in the cassie derived shorelines 1 the time lag between the image acquisition and in situ survey or 2 the use of a different shoreline indicator considering that cassie shoreline indicator is the instantaneous land water edge while the high water mark was the shoreline indicator used in the rtk survey fig 7 it is expected that the latter will be invariably located landward from the instantaneous water level thus creating this constant shift 3 2 comparison with other similar works the comparison between cassie derived and luijendijk et al 2018 shoreline rate of changes evaluated by comparing the parameter lrr show an overall good agreement with the statistical evaluation showing correlation coefficient of 0 85 rmse of 2 41 m yr and bias of 0 091 m yr fig 11 the observed errors are within the magnitude of errors of the shoreline detection method identified in this work and in previous studies e g hagenaars et al 2018 thus demonstrating that cassie has the skills to estimate structural shoreline rate of changes of a variety of coastal environments from all the coastal environments analysed the aoi 2 located in caranguejo island maranhão state was the one where the highest magnitude of lrr changes both positive and negative and at the same time the highest rmse values fig 11 this coastal area is located on a very active region characterized by both extreme coastal erosion and accretion mentashi et al 2018 where according to vousoukas et al 2020 projections significant shoreline erosion is expected to happen by 2050 and 2100 fig 12 compares the lrr estimates for cassie and luijendijk et al 2018 along the 38 cross shore transects analysed within aoi 2 the purpose of fig 12 is to demonstrate that despite some level of variability found between the two datasets fig 10 cassie derived lrr values follow well the direction of the shoreline trend accretion or erosion and only in a few sections of the coast the magnitude of the rates differs in addition in fig 12 is presented the cassie derived shoreline position for 1986 and 2015 where is possible to verify that cassie was capable to capture important shoreline modifications important to note that the use of a multilevel otsu thresholding algorithm liao et al 2001 in estuarine environments exemplified by the results presented in fig 12 showed to be an efficient method to eliminate intertidal features such as sand mud terraces typically present in estuarine macro tidal environments similar to other studies e g hagenaars et al 2018 kuleli et al 2011 liu et al 2017 cassie shoreline detection method is based on an image thresholding algorithm that is applied only to the user defined area of interest aoi the inclusion of an automatic multilevel otsu thresholding algorithm liao et al 2001 in cassie improves the shoreline detection in estuarine environments by removing undesirable low tide morphological features with high content of water such as tidal flats other tools such as coastsat vos et al 2019a deal with this by performing a supervised land cover classification to extract the boundary between pre classified water and sand pixels only removing from this process all additional land cover elements e g buildings roads white water rocky headlands this approach requires a user interaction for the training the classification algorithm and more computing power for the image processing in cassie the implemented method multilevel otsu is automatic and faster nevertheless restricted to three classes 3 3 limitations and future developments although the quantitative evaluation of the cassie derived shows good results figs 10 and 11 further verification is essential especially on estuarine environments rocky coastlines or coarse grained beaches where comparisons are lacking or scarce in the literature as demonstrated by liu et al 2017 the accuracy of satellite shoreline detection can be improved if sub pixel resolution border segmentation and tide correction is implemented in the present version of cassie the shoreline is derived from natural resolution satellite imagery and a future development includes employing the super resolution border segmentation method described by liu et al 2017 tide correction is not applied in the present version of cassie because no tidal model or dataset is available in gee platform for the moment this aspect can represent an important source of errors in the shoreline analysis e g rates of changes in coastal regions with macrotidal amplitudes where the difference between low and high tide can imply hundreds of meters of difference in the shoreline position nevertheless to overcome this limitation cassie provides to the user the possibility to remove some of the pre select the images manually from the analysis this option offers the possibility to the user to only select the images that were acquired with the same tide level further developments include the addition of the astronomical tide information and consequent shoreline horizontal correction liu et al 2017 an alternative method to avoid astronomical tidal influence in the shoreline extraction is the use of annual composite images luijendijk et al 2018 nevertheless this approach significantly reduces the length of the dataset and hampers analysis at sub annual temporal scales 4 conclusions this work describes and demonstrates capabilities of a new tool cassie for automatic shoreline mapping and analysis based on satellite imagery cassie was built with javascript gee api and can be applied to any location on earth where a boundary between water and land exists cassie makes use of the landsat and sentinel 2 satellite imagery available on gee and of the power computing capacity and storage of google cloud therefore it can be run from a standard desktop laptop or smartphone and the only requirement is an internet access and browser the comparison between cassie derived shorelines and rate of changes show that this tool can perform shoreline detection with sub pixel accuracy rmse of 7 97 m and quantify structural shoreline trends similar state of the art methods the main current limitation of cassie is the absence of global tide predictions datasets on gee necessary to correct tide induced shoreline displacements on the time of the image acquisition further investigation on methodological procedures to link global tidal datasets to cassie via gee will be developed to overcome this limitation finally the limited logistical requirements together with the user friendly interface and fully automatic shoreline extraction and analysis makes of cassie an important tool for shoreline management in developing countries declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to thank the conselho nacional de desenvolvimento científico e tecnológico cnpq and ministério da ciência tecnologia e inovações mctic of brazil for funding this research project no 441545 2017 3 the authors would like to thank the national fund on climate change of the ministry of the environment of brazil process number 352012 for sharing the field observations of the shoreline position measured by rtk gps the authors would like to thank franco prado and maiara werner both from loc ufsc for the provided shoreline data and support on the initial development of the tool respectively 
25838,spatially distributed process models represent soil water plant nutrient interactions within a watershed we investigated spatial patterns of water balance components and nitrate transport simulated using the fully distributed ages agricultural ecosystems services and the semi distributed swat soil and water assessment tool 2012 models in the big dry creek watershed a mixed agricultural and suburban watershed in semi arid colorado usa we analyzed patterns of hydrological fluxes using daily model outputs for the period 2010 2018 the two models simulated drastically different spatial patterns swat predicted extremely low interflow and routed excess irrigation water to surface runoff and groundwater discharge ages produced realistic estimation of streamflow irrigation return flows and nitrate simulation of less surface runoff and greater interflow and baseflow contributed to improved simulation of nitrate transport in the interior watersheds this study demonstrated the impacts of simulating spatially explicit hydrology that captures interactions among fields and other areas within a managed watershed keywords semi arid hydrology watershed processes wastewater treatment plants irrigation return flow spatial routing 1 introduction changes in land use land management practices and climate variability have significantly altered regional hydrological cycles over the past century mishra and singh 2010 oki and kanae 2006 nijssen et al 2001 vörösmarty et al 2000 thereby affecting freshwater resources at local to regional scales the scientific community has developed several hydrologic simulation models for investigating these compounding challenges on freshwater resources van liew et al 2003 sood and smakhtin 2015 watershed models with various capabilities and degrees of complexity are used to predict or estimate streamflow and nutrient load applicable to sustainable watershed management borah et al 2006 parajuli et al 2009 although a wide variety of hydrological models are available for simulating current and future scenarios model selection is challenging because of model prediction uncertainty associated with input variables e g land use and climate model parameters and scale issues in watershed modeling surfleet et al 2012 however physically distributed models are capable of accurate representation of the spatial distribution of meteorological conditions as well as physical watershed characteristics such as slope soil properties land cover and land use which are not represented well in lumped conceptual models beven 1989 reed et al 2004 el nasr et al 2005 yang et al 2000 another potential benefit of distributed modeling is the ability to produce streamflow predictions at interior ungauged sub catchments khakbaz et al 2012 moreover distributed models are capable of using measured data at small sub catchment spatial units moreda et al 2006 based on the water and nutrient routing over the sub catchment spatial structure within a physically distributed model has been categorized as semi distributed or fully distributed khakbaz et al 2012 biftu and gan 2001 semi distributed models simulate hydrological fluxes at the basin outlet by utilizing sub catchment averaged data and distributed properties such as land use soil type and precipitation lumped into a discrete area pai et al 2012 therefore the smallest spatial units hydrologic response units hrus may not be continuous and there is no routing among them kalcic et al 2015 whereas fully distributed models are capable of routing water and nutrients among the hrus however calibrating watershed variables such as streamflow only at the basin outlet may not improve the spatial accuracy of the hydrologic model in the interior watersheds arabi et al 2006 rathjens et al 2015 therefore we cannot assume that the fully distributed model performs better than semi distributed systems in quantifying hydrological processes in a watershed in the case of fully distributed models considerable computational cost is associated with the development and a large number of model performance evaluations with the observed variables kim et al 2007 vivoni et al 2011 that has not been well addressed in the water resource sector kollat et al 2006 in addition the computational cost increases with the model complexity such as quantification of groundwater elements pulido velazquez et al 2007 and addition of water quality modules in this study we applied a fully distributed model called the agricultural ecosystems services ages model green et al 2014 2015 ascough et al 2015 to an intensively managed suburban and agricultural watershed located in a semi arid region we compare simulation results of ages with the semi distributed swat soil and water assessment tool version 2012 with user interface arcswat 2012 winchell et al 2013 for simulating the water balance return flow and nitrate transport swat has been used for simulating the hydrological fluxes for many different landscapes arnold and fohrer 2005 arabi et al 2006 abbaspour et al 2015 veettil and mishra 2016 2018 aliyari et al 2019 and several studies compared the performance of the swat model with other types of models for instance van liew et al 2003 compared swat with the hydrologic simulation program fortran hspf semi distributed model and observed that swat consistently performed better than hspf for agricultural watersheds under various climatic conditions el nasr et al 2005 investigated the performance of fully distributed mike she models with swat and in this case mike she predicted the streamflow variation over the watershed slightly better than swat a study conducted at catchments in ireland nasr et al 2007 compared the performance of hspf and system hydrologic european transport shetran fully distributed model with swat they found that hspf accurately predicted the daily streamflow quantity but shetran failed to adequately represent the flow peaks and recessions while swat performed better for simulating the daily total phosphorus load ages is a relatively new model the current version 0 3 0 of ages is continuous in time daily time step and fully distributed in space a detailed explanation of ages is provided in the methodology section the irrigation return flow within a watershed is defined as the excess water that is not evapotranspired or used consumptively and finally returns to the drainage channel in the form of surface or subsurface flow wu et al 2019 garcía garizábal et al 2010 kim et al 2009 gosain et al 2005 the volume and quality of return flow in a watershed varies based on several factors such as landscape topography land use type soil type and irrigation method in the watershed dewandel et al 2007 return flow has a major role in water balance particularly in intensively irrigated watersheds mohan and vijayalakshmi 2009 surface return flow from irrigated agricultural fields is a result of excess precipitation and irrigation and it is considered as a major contributor to non point source pollution zuazo et al 2009 vadas et al 2015 in the stream network several research methods have been proposed for quantifying the return flow from watersheds which include experimental setup and methodology based on water balance models wu et al 2019 the experimental method requires extensive field trials to generate high quality field data that are difficult to carry out in a large scale watershed jafari et al 2012 dewandel et al 2007 therefore the application of physically distributed watershed models is an effective tool to estimate the return flow at different scales based on the water balance simulation using limited data xie and cui 2010 although swat and its predecessors are lumped within sub catchments swat developers recognized its limitations and recently released swat bieger et al 2017 with extended capability to route water explicitly among spatial units a goal of this study is to compare the performances of the commonly used swat 2012 called simply swat from here on and ages models concerning their accuracies of simulating daily discharge at the watershed outlet and to investigate the water balance and return flow for an intensively managed watershed located in a semi arid region the specific objectives are to 1 investigate and compare the capabilities of ages and swat models to estimate the water balance components such as evapotranspiration et surface and groundwater flow soil percolation and interflow lateral flow in swat 2 enhance the understanding of streamflow and nitrate sources and dynamics within each sub catchment based on ages and compare the sub catchment outflow generated with swat 3 quantify and compare the surface interflow and groundwater return flows based on both models and 4 estimate the return flows from the irrigated agricultural systems located in the lower portion of the watershed while several studies have focused on performance comparisons of swat with other lumped semi distributed and fully distributed models model evaluation for an intensively managed and irrigated semi arid watershed in terms of water balance and return flow estimation is novel also this study provides the first direct comparison of swat with ages 2 study area and data 2 1 study area the big dry creek watershed bdcw is a 280 km2 mixed agricultural and suburban watershed located in the vicinity of denver colorado fig 1 a the average annual precipitation in the watershed is 315 mm and most of the precipitation occurs as rainfall distributed throughout the summer season the bdcw is an intensively managed watershed including inputs from three wastewater treatment plants and reservoir discharge water diversion structures and irrigated and non irrigated agricultural fields the land use types in the bdcw can be roughly classified into three major categories the headwater area is rocky flats which consists of grass pastureland in addition the watershed hydrology in the headwater area is significantly influenced by the standley reservoir which supplies water to the downstream farms as well as domestic sector the middle portion of the watershed is predominantly suburban land a mixture of residential commercial and industrial uses and the lower watershed is primarily agricultural land comprised of corn alfalfa winter wheat and pasture for livestock production 2 2 data various spatial and temporal datasets were collected from multiple sources to run swat and ages for the bdcw table 1 these datasets include a digital elevation model dem obtained from national elevation dataset ned provided by the u s geological survey usgs 2020 at a resolution of 10 m b land use data crop data layer for the year 2018 obtained from usda nass 2018 c ssurgo soil data obtained from the natural resources conservation service usda nrcs 2020 d irrigated agricultural field layer data obtained from the colorado decision support system cdss e precipitation and temperature data 2010 2018 obtained from various sources including the national climatic data centre ncdc cdss and colorado agricultural meteorology coagmet supported by the colorado state university f solar radiation relative humidity and wind speed data obtained from iowa environmental mesonet iem and coagmet g streamflow data inlet and outlet obtained from the usgs and h wastewater treatment plant discharges water quantity and quality obtained from the big dry creek watershed association http www bigdrycreek org 3 methods the upland area including rocky flats and standley reservoir is not directly modeled in the study the discharge data downstream of the standley reservoir usgs 06720820 were used as an inlet to the bdcw model the lower bdcw model consists of a spatial area of 186 km2 fig 1b 3 1 soil and water assessment tool swat swat is a continuous time semi distributed and process based hydrological model developed by the u s department of agriculture arnold et al 1998 which has been used extensively for hydrologic and water quality simulation in watersheds ranging from small field scales cibin et al 2012 tasdighi et al 2018 to large river basins veettil and mishra 2016 2018 aliyari et al 2019 and continental scale abbaspour et al 2015 the model has the capability to work based on daily weather input and for smaller time units the dem is used in the arcswat interface preprocessed to delineate a river basin the delineated river basin is divided into sub basins which are further divided into unique land use soil slope spatial units hrus the delineation of hrus is achieved by overlaying the soil land use and slope map of the river basin in general the number of hrus is controlled by adjusting the land use soil and slope threshold her et al 2015 here we adopted the swat default flow direction and accumulation the final model resulted with 16 sub catchments and 1243 hrus the surface runoff in swat can be calculated using the curve number cn method based on soil moisture condition cn i or et cn ii the cn i approach tends to overestimate the surface runoff in shallow soils kannan et al 2007 therefore we used the cn ii method 1 s t s t 1 e 0 e x p c n c o e f s t 1 s m a x r d a y q s u r f where s t is the retention parameter and s t 1 is the retention parameter from previous day e 0 and cncoef are the potential et and plant et curve number coefficients determined by calibration during the beginning of a swat simulation the retention is estimated as s 0 9 s max where s max is calculated as 2 s m a x 25 4 1000 c n 10 where cn is the curve number cn ii based on plant et neitsch et al 2011 tasdighi et al 2018 in this study we used the arcswat version 2012 https swat tamu edu software a detailed description of arcswat 2012 is available in winchell et al 2013 3 2 agricultural ecosystem services ages model ages is a java based fully distributed and continuous watershed model ascough et al 2012 2015 green et al 2014 2015 developed with the object modeling system 3 oms3 environmental framework david et al 2013 ages reflects the routing of water and nutrients in an hru level i e a single hru unit in ages simulates values for surface runoff lateral flow and water quality components with spatially explicit routing among hrus and stream reaches the hydrologic components in ages are primarily adopted from the j2000 krause et al 2006 and j2000 sn fink et al 2007 models the ages model implementation for the bdcw is illustrated in fig 2 domain delineation for the modeled area was performed using the catchment areas delineation cadel tool a web service with browser interface for delineating watershed boundaries sub catchments stream network and hrus with spatial reference and geospatial attribute tables https alm engr colostate edu cb wiki 42641 cadel version 0 1 18 generates input parameter sets for ages and could be adapted to other distributed hydrological models in the future the user specified dem is processed for the topology of flow paths and combined with raster layers of land use soil data and hydrogeology to generate hrus within each sub catchment flow paths may be many to one convergent one to one cascading and one to many divergent flow partitioning among hrus and stream reaches is specified in a routing file here hrus in agricultural areas are delineated to match the boundaries of irrigated fields this method provides capability to apply spatially explicit crop management practices to the irrigated hrus in the developed model for comparison with swat 16 sub catchments were generated in the final ages model whereas the total number of hrus was 1551 finally crop management practices e g rotation were identified by applying land use and agricultural management practices web service lamps kipka et al 2016 a detailed explanation on lamps and crop management practices in the watershed are provided in section 3 6 the current daily version of ages version 0 3 0 generates four inter connected pathways in each hru for simulating the runoff and water quality loads surface runoff lateral interflow from multiple variably saturated soil layers fast discharge from the saturated zone and slower baseflow from the saturated zone a central part of ages is the soil water process component which interacts with most of the other process components including surface and subsurface runoff groundwater storage and flow and canopy et interaction initially ages quantifies the precipitation interception storage for each hru based on the land use type and simulated leaf area infiltration into the soil profile is computed based on the eagleson 1970 equation which is given as 4 i n f i l t r a t i o n m a x s o i l m a x i n f s w 1 θ s o i l k f where the subscript max represents the maximum amount of water intake soilmaxinf is the moisture dependent infiltration parameter during either summer s or winter w season θ s o i l is the saturation of soil layers and k f is the field saturated hydraulic conductivity of the surface layer each soil layer in ages is divided to two compartments 1 medium pore storage mps and 2 large pore storage lps the mps represents the soil water held against gravity in the medium sized pores and lps is soil water in the large sized pores which drain more rapidly and thus act as a primary source of vertical and horizontal outflow the mps and lps in each soil layer of an hru are calculated based on various physical properties e g field capacity porosity and dead capacity more detailed descriptions of ages are available in ascough et al 2012 and green et al 2014 2015 3 3 model calibration and performance evaluation calibrations of ages and swat models were performed by fitting the observed daily streamflow usgs 6720990 located in the lower part of the bdcw nitrate concentration was calibrated for three gauging locations located within the watershed fig 1b at a daily time scale swat was calibrated by comparison with observed bdcw streamflow data using sufi2 sequential uncertainty fitting version 2 optimization algorithm abbaspour 2005 abbaspour et al 2007 based on the latin hypercube sampling sufi2 also supports parameter estimation and sensitivity analysis the sensitivity analysis is performed by using the inbuilt global sensitivity analysis where the sensitivity of parameters is estimated based on t stat and p value sufi2 is capable of narrowing the model parameter range which reduces the overall uncertainty in the calibrated model the overall time period used in our model performance analysis is 2010 2018 in daily time steps the model calibration is performed for 7 years 2012 2018 and independent model testing is performed for the period 2010 and 2011 given the large interannual variability and limited period of record all available data were used for the performance analysis and goodness of fit was evaluated for individual years over the full analysis period subsequently water balance and return flow analysis for ages and swat were performed for the calibration period using the best available data ages was calibrated by comparison with observed bdcw streamflow data using luca let us calibrate a multi objective stepwise and automated hydrologic model calibration procedure hay and umemoto 2006 that uses the shuffled complex evolution sce global search algorithm duan et al 1994 the luca code was ported into the object modeling system oms version 3 5 console which is a java application used to create edit and run luca simulations the oms console also supports parameter editing post run visualization output analysis and the creation of trace files of all parameter sets and objective function values defined below calibration runs were deployed through a luca script file where we specified the observed dataset period of calibration objective function and parameters to calibrate luca requires user specified steps which are performed sequentially through the parameter groups for a specified number of rounds we used the mean value method luca option where the mean of a set of parameter values is adjusted while preserving the distribution of relative input values in this study the parameters related to soil horizon e g saturated soil hydraulic conductivity dead capacity and porosity were calibrated similar to swat daily ages calibration was performed from 2012 to 2018 performance of both models was evaluated for daily and monthly average values based on the following statistics percent bias pbias coefficient of determination r2 nash sutcliffe efficiency nse and kling gupta efficiency kge only kge was used as the objective function for parameter calibration at the daily time step in luca the kge goodness of fit criteria was introduced by gupta et al 2009 as an improvement to nse and garcia et al 2017 identified kge as the best objective function to simulate low flow in combination with a wide range of flow values the kge is estimated as 3 k g e 1 r 1 2 α 1 2 β 1 2 where r is the correlation coefficient between model simulated and observed streamflow β is the ratio of mean simulated and mean observed streamflow and α represents the ratio between standard deviation of simulated and observed flow the model performance and calibrated parameters are explained in section 4 1 the parameters selected for calibration and their ranges were selected based on previous studies aliyari et al 2019 green et al 2015 in the region 3 4 interpolation of precipitation data precipitation is the major driving force of spatially distributed models camici et al 2018 veettil and mishra 2016 2020 in this study we used daily precipitation data from 19 gauges located inside and outside the watershed boundary a key difference between the two models tested is that swat uses uniform precipitation over each sub catchment whereas ages uses uniform precipitation at the hru scale but allows spatial variability among hrus and within sub catchments the interpolation method adopted in swat is the nearest neighbor nn method in this study the nn method included only the 10 precipitation gauges out of 19 available that were closest to the centroid of each sub catchment in contrast ages interpolation method inverse distance weighting idw used all 19 stations we observed that the spatial distribution of precipitation was extremely different when applying these different interpolation methods in each model after initial calibrations of both models swat simulation of streamflow at the outlet was much worse than the ages simulation the annual average precipitation over the basin while applying nn interpolation method in swat was 353 7 mm whereas ages resulted in an annual average precipitation of 375 mm perhaps more important than the average difference the spatio temporal distributions of precipitation differed substantially which played a major role in the model performance thus we used the hru level interpolated data from ages upscaled to sub catchment averages to provide approximately equal spatial distributions and watershed level daily precipitation amounts for both models use of the sub catchment average precipitation based on ages increased the annual average precipitation to 369 4 mm and improved model performance compared with the nn method 3 5 wastewater treatment plant discharge three major wastewater treatment plants wwtps which provide nearly continuous baseflow and n load to the big dry creek are broomfield bf westminster wm and northglenn ng fig 1b fig 3 illustrates the monthly average inflow usgs 6720820 and effluent discharge contributions from these three wwtps the inlet station is located approximately 7 5 km straight line distance downstream of standley reservoir discharge higher inflow to the bdcw from reservoir discharge is observed during the summer season and maximum inflow occurs in june and july in the case of the wwtps the wwtp wm contributed the highest total amount of effluent discharge to the bdcw whereas the wwtp bf has higher contributions during the summer season the wwtp wm focused on reclamation during the summer season and the wwtp bf focused on the winter season with associated reductions in effluent discharge in those seasons historically the effluent discharge from wwtp ng to the bdcw has been infrequent however from 2013 to 2018 northglenn discharged more frequently to the watershed and the effluent discharge was relatively lower than westminster and broomfield wwtp clary 2020 3 6 crop management crop management practices have a significant role in controlling the return flow from irrigation and nonpoint source pollutants in a watershed cibin et al 2012 however no clear records of crop management practice are available for bdcw here the irrigated agricultural field layers were obtained from the colorado decision support system cdss and the crop rotation for all the major crops in the irrigated fields such as alfalfa corn pasture and winter wheat were identified based on lamps lamps was developed to provide crop management and rotation information for a user defined area of interest within the u s based on the annual crop data layers cdl irrigated area maps compiled by usgs https www usgs gov land resources eros droughtstress science modis irrigated agriculture qtscience center objects 5 qt science center objects and the land management and operation database lmod david et al 2014 lamps is available for use to the scientific community and detailed information is available kipka et al 2016 green et al 2018 swat provides options for scheduled and auto irrigation uniyal and dietrich 2019 chen et al 2019 in this study we used the auto irrigation option due to the lack of scheduled irrigation information in the bdcw the auto irrigation module in swat is triggered based on soil water deficit and plant water stress however some studies reported that the auto irrigation function in swat was unable to appropriately represent the actual irrigation amount in a watershed akhavan et al 2010 dechmi et al 2012 chen et al 2019 these studies also document that when the soil water deficit method is used the irrigation event is not suspended even after the harvesting period marek et al 2017 therefore we used the plant water stress based auto irrigation method which is based on a fraction of potential plant growth and the soil field capacity in general cultivated land boundaries do not match with swat generated hrus and this implicit nature of hrus makes realistic irrigation challenging in the swat model pai et al 2012 although we tried to preserve the field boundaries of irrigated fields by overlaying the land use layer and irrigated field layers preserving all the irrigated fields in the bdcw swat model was cumbersome like swat ages applied an automatic deficit irrigation method in ages any time water content in the medium pore storage mps falls below a certain threshold the model will apply irrigation water in this study the total seasonal irrigation water requirement for each crop was obtained from colorado state university extension schneekloth and andales 2017 in swat the auto irrigation application amount in the plant water based method is considerably controlled by the parameter water stress threshold that triggers irrigation auto wstrs the factor ranges from zero to one where values near one indicate the irrigation stress is not limiting the plant growth our initial calibration result yielded a low value of auto wstrs 0 5 producing low amounts of total irrigation input to optimize the swat model results but the total amount of generated irrigation based on a lower auto wstrs was not realistic and much lower than ages generated output neitsch et al 2011 suggested the usual range of the threshold should be higher than 0 9 for generating realistic irrigation in the watershed therefore in this study we changed the value of the threshold to one for generating the maximum amount of irrigation in swat even so the catchment average irrigation generated in swat model was slightly less than ages while applying the same daily maximum irrigation chen et al 2017 meanwhile ages generated the estimated seasonal water requirements for eastern colorado crops e g alfalfa corn winter wheat and hay pasture suggested by schneekloth and andales 2017 therefore we adjusted the irrigation generated in the swat hrus to be comparable with ages hrus in addition to changing the threshold to one we increased the amount of irrigation water applied during each auto irrigation to 23 higher than the ages irrigation rate this helped us to generate an irrigation output in swat nearly equal to ages generated irrigation the final irrigated amount generated in swat was 15 higher than the irrigation generated by unadjusted auto irrigation where the auto wstrs 1 thus the final swat model setup was used to obtain equivalent drivers for model precipitation and irrigation for model intercomparison with ages 3 7 water balance and water yield the water balance analysis elucidates the fundamental partitioning of water between different inputs e g rainfall and snow to a catchment and processes that remove water from the catchment in the form of different components such as surface water flow interflow groundwater flow deep percolation and et daly et al 2019 thompson et al 2017 although considerable effort has been devoted to investigating the catchment behavior mcdonnell et al 2007 peters lidard et al 2017 understanding and quantifying the components of water balance remains a fundamental issue in catchment hydrology due to the complexity in catchment water flow and storage leopold 1997 daly et al 2019 for a fixed input dataset a fully distributed and a semi distributed hydrological model may show significant changes in mean areal water balance components in general it is important to evaluate the diverse components of water balance in a catchment to deal with the water management issues ayivi and jha 2018 in this study we compared the water balance components including et surface runoff interflow or lateral flow groundwater flow and percolation from ages and swat based on the 7 years of daily model simulation in addition we calculated the water yield wyld the aggregate sum of water leaving an hru and entering the stream network during the time step neittsch et al 2011 as the sum of surface water return flow surq interflow or lateral flow latq and groundwater return flow gwq from the shallow aquifer 3 8 quantifying lateral flow and irrigation return flow return flow refers to the amount of water discharging to stream channels reaches in the form of surface interflow and groundwater flow from hrus in the contributing areas after rainfall or irrigation events wu et al 2019 kim et al 2009 the surface water return flow from swat is calculated based on the hru output surq cnt which represents the surface runoff contribution to the stream network during the time step and the lateral or interflow is calculated based on the output latq gen which represents the variably saturated water flowing laterally within the soil profile and enters in to the main channel the groundwater return flow is quantified based on gw q which is the water from the shallow aquifer that enters the channel network neitsch et al 2011 finally the percolation is calculated based on the output perc in swat in the case of ages the surface water return flow for each hru is quantified as the difference between surface runoff outflow minus inflow and the lateral flow for each hru is the difference between interflow outflow minus inflow the groundwater return flow for each hru is the difference between the sum of fast and slow groundwater outflow minus inflow the percolation in ages recharges groundwater storages that flow to the stream reach and or adjacent hrus whereas in swat water that percolates goes to the deep aquifer is considered lost from the system mapes and pricope 2020 in addition we compared the ages and swat generated baseflow derived based on automated baseflow separation and recession analysis techniques developed by arnold et al 1995 using a digital filter based automated base flow separation this method is capable of producing results similar to a graphical separation technique 4 results both the models provided adequate streamflow simulation results at the watershed outlet but ages performed better than swat overall notably ages and swat simulated significantly different patterns of hydrological fluxes within the watershed 4 1 performance of models the hydrograph fig 4 a and b deviation of simulated flow from observed discharge fig 4c and d quantile quantile q q plot showing data for 100 quantiles fig 4e and scatter plot fig 4f show that in general both models replicated the dynamics of daily hydrological fluxes throughout the entire simulation period the daily and monthly model performance statistics table 2 indicated that both models produced very good agreement with observed data and that ages daily nse 0 77 daily kge 0 88 was substantially better than swat daily nse 0 55 daily kge 0 76 at capturing watershed level streamflow responses for instance an increase in r2 of 0 17 indicates that ages explains an additional 17 78 total of the variance between modeled and measured streamflow at the outlet based on the q q plot fig 4e ages and swat performed well during the low flow periods but deviated more from observed data at high flows the most noticeable drawback of both swat and ages is their failure to accurately simulate the high flows in the watershed where most of estimated daily streamflow peaks are higher than the observed values particularly for flows in the range of approximately 10 20 m3 s the yearly performance statistics table 3 also show that ages consistently captured the streamflow response better than swat for years 2010 2011 the percent of missing precipitation data for the model testing years was higher than 45 percent both models performed more poorly during 2010 2011 testing than during the model calibration period but this may be attributed to data quality rather than independent performance evaluation overall 18 parameters table a 1 were optimized for swat streamflow calibration and in the case of ages calibration 33 model parameters were calibrated the list of calibrated parameters of ages and their adjusted values are provided in table a 2 subsequently the model performance is evaluated for nitrate concentration table 4 like the flow simulations ages performed better than swat at all the six water quality gauging stations located in the interior bdcw the goodness of fit statistics for the monitoring location bdc 6 were less than the other locations due to the absence of consistent effluent data from wwtp ng and the possibly the influence of agricultural fields the spatial accuracy of interior sub watersheds in a hydrological model may not be improved by calibrating the watershed variables such as streamflow only at the basin outlet arabi et al 2006 in the present study however the fully distributed ages model performed better than the swat model for simulating daily streamflow table 2 and nitrate concentrations in the bdcw table 4 although both models performed relatively poorly at the monitoring gage bdc 6 see station locations in fig 1b ages was able to represent the nutrient fluxes in the other locations bdc 1 5 to bdc 5 better than swat even at bdc 6 where ages produced relatively lower values of kge nse and r2 the model bias was significantly lower in magnitude for ages 4 5 than swat 16 2 reduced model performance at bdc 6 may be due to borh the lack of proper nutrient inflow data from northglenn wwtp and influences of intensive agricultural management in the lower watershed area which were not captured using generic management practices for all fields ages model skill in representing the water balance in the interior watersheds may contribute to the improved water quality simulation therefore we investigate the patterns of water balance components produced by ages and swat in the bdcw 4 2 water balance components fig 5 a illustrates area weighted average bdcw water balance components from ages and swat simulations the et simulated by ages 511 mm was only 3 4 more than swat 494 mm after adjusting swat input data for precipitation and irrigation to better match the amounts determined using ages without these adjustments i e using default methods and the same raw input data swat drastically underestimated et not shown according to velpuri and senay 2017 and reitz et al 2017 the adjusted results are acceptable for a semi arid region both ages and swat applied a version of the penman monteith method for simulating the et here the et includes evaporation from the plant canopy transpiration soil evaporation and evaporation from depression storages the annual water yield wyld simulated by ages 70 7 mm was slightly less than the final wyld by swat 71 3 mm fig 5a the surface overland flow surq estimated by ages 36 3 mm was comparatively higher than soil interflow latq 22 3 mm and groundwater flow gwq 12 1 mm whereas swat hydrology was driven primarily by surq 54 0 mm followed by gwq 17 0 mm with almost no contribution from latq fig 5b this result is consistent with underprediction of latq in swat reported previously by white et al 2011 and hoang et al 2017 the variation in baseflow contribution quantified by ages and swat models was compared first based on subsurface lateral flow components fig 6 a and b illustrate the daily and monthly discrepancies in baseflow quantified at the watershed outlet by ages and swat compared with the observed baseflow which includes point source inputs from the upper watershed and effluent from three wwtps during most months simulated baseflow was less for swat than ages both models underestimated observed baseflow from october to january the comparison of daily distributions of baseflow for the period 2013 2015 based on the model simulation and observed flow fig 6b indicates that the patterns of simulated baseflow match the observed baseflow maxima the simulated peak baseflow showed a time lag for the time period april 2014 to december 2014 overall ages represented the baseflow better than swat however simulated baseflow in both models was unable to represent the minimum baseflow i e observed baseflow nearly equal to zero fig 6c shows the monthly distributions as boxplots of daily ages simulated baseflow watershed average which was calculated as the sum of interflow and groundwater discharge plus all the inlet flow to the watershed finally we compared the sum of monthly distribution of interflow and groundwater flow quantified based on ages and swat the results indicate that the ages simulated values are substantially higher than the swat simulated values 4 3 spatial streamflow analysis annual average streamflow based on ages and swat simulations for each sub catchment are illustrated in fig 7 ages represents streamflow at a finer watershed scale i e all the tributary stream network within a sub catchment whereas swat lumps streamflow amount to the sub catchment output and represents only the sub catchment output value streamflow magnitude at the sub catchment outlets is highly spatially variable and the flow volume increases from upper to lower watershed areas mostly due to the influence of wwtp discharges because swat generates streamflow only at the sub catchment outlets only those locations are plotted in fig 7 thus simulated spatial patterns within sub catchments can be generated as output of ages and visualized in this manner average simulated streamflow among the 16 sub catchment outlets was slightly higher for ages than swat despite over prediction of the highest flows using ages fig 4e and f simulated average annual outflow was 1 14 m3s 1 for ages and 1 24 m3s 1 for swat versus a measured mean of 1 11 m3s 1 at the watershed outlet 4 4 quantifying spatial patterns of lateral flows using flux variable names from swat fig 8 illustrates the spatial pattern of annual surface runoff surq interflow or lateral flow in the vadose zone latq and groundwater flow gwq for both ages and swat the catchment average of surq simulated by swat is 49 higher than ages and the spatial patterns of simulated surq for differed dramatically between models in the case of ages most hrus in the upper sub catchments produced higher surq than lower sub catchments but swat had higher surface flow for irrigated hrus in the lower catchment area although some swat hrus in the upper catchment showed a higher value of surq most hrus ranged from 30 to 75 mm yr the land use type of upper watershed area is primarily suburban developed with mixed residential and commercial areas and a larger proportion of precipitation leaves these suburban catchments as surface runoff from partially impervious areas in addition the precipitation over the upper sub catchments was higher by approximately 42 than the precipitation falling on lower sub catchments therefore the higher surq simulated by swat in the lower agricultural area is driven by crop management practices whereas surq in ages is controlled by rainfall patterns and developed land in the upper areas of bdcw the number of hrus with higher surq in ages was less than in swat annual average surq simulated by ages was greater than 100 mm for most hrus in the upper watershed compared to swat ages and swat also produced noticeable differences in the central portion of the bdcw which has a mixture of suburban and agricultural land ages simulated lower surq 0 5 mm for most hrus in the central sub catchments whereas swat simulated relatively higher surq 10 30 mm and the irrigated hrus in central sub catchments simulated higher 60 mm surq the annual average interflow latq quantified based on ages and swat differed substantially both in spatial distribution throughout the bdcw fig 8c and d and in average flow fig 5c the interflow simulated with ages varies from zero to more than 100 mm across the hrus of bdcw whereas swat simulated a maximum latq of 5 mm unlike surq the pattern of latq in ages is more highly variable among field scale hrus and more evenly distributed from upper to lower watershed areas in addition the spatial distribution of latq in ages is influenced by the irrigation amount spatial distributions of annual groundwater flow gwq based on ages and swat are illustrated in fig 8e and f respectively groundwater flow in ages is higher in the lower sub catchments whereas swat simulated slightly higher gwq in the upper sub catchments similar to ages the spatial distribution of gwq in swat is highly influenced by the irrigation amount finally we analyzed surq latq and gwq at the hru level for periods with high flow 95th percentile and low flow 5th percentile watershed outlet streamflow conditions the results from both models indicated that the surface runoff interflow and groundwater flows across the hrus of bdcw were negligible during the low flow so these are not shown spatial distributions of surface runoff lateral flow and groundwater flow mm d 1 for each hru averaged over days with high flow are illustrated in fig 9 in agreement with average surq patterns fig 8a ages average high flow period surq was greater for hrus in the upper bdcw fig 9a whereas swat high flow followed a different pattern than average surq fig 8b however the lateral flow produced by swat during the high flow was less than 0 5 mm d 1 for all hrus fig 9d ages generated interflow followed the similar pattern of yearly average interflow fig 9c interestingly the spatial distributions of gwq differ greatly between models fig 9e and f similarities with annual average patterns fig 8e and f are apparent but ages produced higher groundwater flows in the lower watershed during high streamflow periods while having very low groundwater flows in most of the upper watershed unlike surq the average daily flow of the top 5 of gwq accounts for only a small fraction about 1 of average annual gwq so does not dominate the annual gwq patterns because the groundwater flow is more stable less transient or flashy than surq even so periods of high gwq can be caused by high irrigation amounts particularly in the lower bcdw 4 5 evaluating return flow from irrigated agricultural systems the average annual irrigation amounts generated by both models were nearly the same at a catchment level ages 112 mm swat 113 mm and irrigated hrus level ages 382 mm swat 386 mm fig 10 shows boxplots of hru scale variability in average annual return flows from irrigated agricultural fields computed as the sum of surq latq and gwq the tabular statistics of total return flow are also shown in fig 10 to clarify the main differences e g minima medians and inter quartile ranges similar to the watershed scale water balance behavior the average return flow simulated with swat was substantially higher than return flows simulated by ages annual average surq and gwq over the irrigated agricultural fields were 86 4 mm and 28 3 mm from swat compared to 15 3 mm and 12 0 mm from ages conversely annual average latq was 17 6 mm from ages compared to only 0 27 mm from swat different by a factor of 71 5 discussion and conclusion the simulation results for the big dry creek watershed bdcw in colorado usa provide insights into watershed responses in a semi arid region and a direct comparison of a widely used semi distributed model swat and a recently developed fully distributed spatial model ages version 0 3 0 in addition to comparing model performance at the watershed level the aspects of model setup simulated patterns within this mixed use watershed estimates of irrigation return flow and the influence of treated wastewater discharge on baseflow in the bdcw were investigated the inverse distance weighted idw average precipitation inside each of 16 ages sub catchments was used for both models we observed that use of the ages sub catchment average precipitation data improved swat performance substantially compared to direct usage of nearest neighbor precipitation station data provided by arcswat 2012 swat also allows user input precipitation data for each sub catchment so improved weighting methods such as the hru level idw method used in ages could be easily imported to swat and may similarly improve simulation results the crop management in the bdcw was identified based on lamps to provide consistent land use among hrus and crop management practices to the agricultural fields for both ages and swat in addition the crop irrigation in both the models was triggered by automatic irrigation scheduling which works based on a fraction of the soil field capacity however there is a minor difference in ages and swat generated irrigation amount if we apply the same irrigation input amount to both models the seasonal irrigation amounts generated by ages were comparable with field studies conducted by the colorado state university extension department schneekloth and andales 2017 therefore we increased the swat irrigation input amount by 23 such that the adjusted irrigation amounts were nearly same for ages and swat the initial water balance components quantified by ages and swat were substantially different i e before adjusting the precipitation and irrigation amount after adjustments were made to provide comparable inputs for model intercomparison ages average et was only 3 5 higher than the average et computed with swat ages reports et from interception storage depression storage and actual et soil evaporation plant transpiration separately whereas swat reports actual et and plant transpiration separately if the penman monteith method is selected as the potential et method however neitsch et al 2002 recommended using swat impoundment tools its for more accurately estimating the et from depression storage impoundments the present results indicate that swat under predicted latq interflow in the watershed which agrees with previous experience white et al 2011 hoang et al 2017 interflow occurs when the soil moisture content is above field capacity and the lateral transmittivity of soil depends on layer thickness and saturated hydraulic conductivity the low topographic slopes of hrus in bdcw reduced the hydraulic gradient and led to reduced interflow in ages on the other hand the swat assumes that the flat and near stream regions saturate in the initial stage and release more surface runoff therefore the flat nature of watershed landscapes may be a possible reason for reduced subsurface lateral flow and higher surface runoff output in swat in ages infiltration from precipitation and snowmelt is quantified based on the eagleson 1970 equation a majority of the watershed area is comprised of loess soils with relatively high infiltration capacities the combined influences of soil type and flat nature of watershed landscape transfer more water to the soil water compartment for interflow this may be a possible reason for higher amounts of interflow in ages output the return flows from irrigated agricultural fields simulated by swat were generally higher than ages fig 10 for the catchment average for instance the catchment average annual total return flow simulated by swat is 114 mm which is 3 5 times greater than the return flow of 32 mm simulated by ages conversely the interflow contribution from irrigated agricultural fields simulated by swat was negligible which indicates that swat only allocated irrigation water to surface runoff and groundwater discharge typically modelers employ the auto irrigation function within the swat model but there have been concerns whether the model is able to adequately represent the irrigation amount akhavan et al 2010 dechmi et al 2012 chen et al 2017 2019 whereas ages matched observed seasonal irrigation well and partitioned precipitation and irrigation water to surq 19 4 latq 47 8 and gwq 32 8 in addition the spatial range of annual return flows simulated by ages was much higher than swat although actual hru level values over the whole watershed are unknown we expect values ranging from near zero for semi arid rangelands with perennial vegetation and no irrigation to near the annual precipitation amount for impervious areas in the mixed land use watershed thus the range simulated by ages appears to be realistic the baseflow quantified at the watershed outlet fig 6 based on automated baseflow separation and recession analysis techniques indicate less baseflow was simulated using swat than ages also watershed average of monthly latq gwq from ages is significantly higher than swat this result is consistent with previous studies bailey et al 2016 liu et al 2019 which found that swat typically offers better emphasis on surface water process but represents the groundwater process with relatively simple dynamics the model considers two layers of aquifer system in each hru a shallow unconfined aquifer and a deep confined aquifer the water from shallow aquifer could move to deep aquifer while the reverse process is not allowed both aquifers contribute water to streamflow as baseflow based on a linear reservoir approximation by ignoring the distributed parameters such as hydraulic conductivity kim et al 2007 liu et al 2019 with this simplified representation of groundwater flow swat may give inaccurate estimation of groundwater flow in semi arid catchments shao et al 2019 where most of the flow is contributed from the groundwater resources gassman et al 2014 in ages groundwater is comprised of two components partitioned into faster discharge and slower baseflow from the saturated zone unlike swat the contribution of water from the groundwater systems to the streams are based on retention coefficients and simulated calibrated storages in the system thus ages may better emulate the spatio temporal distribution of the groundwater return flow even so both models use simplistic response functions to simulate the groundwater storage dynamics and discharge overall both spatially distributed models are found to be useful for investigating and comparing the water balance components and return flow in the bdcw the realistic simulation of critical hydrological process in a watershed modeling system is crucial for instance overestimation of surface runoff leads to overestimation of sediment yields and surface nitrate and other soluble contaminant yields arnold et al 2014 further it will generate errors in model parameterization related to nutrient transport and leads to unrealistic policy making related to wastewater treatment plants and fertilizer pesticide application this study also illustrates that watershed models may underestimate or overestimate the critical water balance processes within a watershed quantification of these water balance components within watersheds has a major role in improving the water quality simulation in hydrological models and ages performed better than swat for simulating streamflow and nitrate yields in the bdcw we conclude that ages produced more realistic behavior of return flow and water balance components in a semi arid intensively managed watershed the semi distributed swat 2012 results differ dramatically from fully distributed ages results in terms of space time water routing and distributions of surface and subsurface return flows while both models fit watershed scale streamflow and n loads reasonably well at the watershed level the differences are significant in terms of nash sutcliffe efficiency which measures amount of scatter explained by each model ages fit the observed streamflow data better than swat for all simulated years in multi year evaluations on average ages explained 17 more of the variability in daily streamflow than swat based on r2 values and 22 more based on nse 0 77 versus 0 55 finally this study was initiated before dissemination of swat which was not used here beyond the present scope however our conclusions caution against continuing to use semi distributed models like swat 2012 for spatial estimation and these results support the development and testing of more fully distributed models like ages or swat for future applications software and or data availability name of software agricultural ecosystems services ages version 0 3 0 description ages is a component based watershed model built with the of java connection framework jcf and object model systems oms frameworks water is routed explicitly among hydrological response units hrus and stream reaches with topology and routing generated by the catchment areas delineation cadel web tool for each project source language java download site https alm engr colostate edu cb project ages developers timothy r green holm kipka nathan lighthart olaf david jim ascough and others contact address water management and systems research unit usda ars 2150 d centre ave fort collins co 80526 email tim green usda gov declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the big dry creek watershed association https www bigdrycreek org provided helpful information and feedback on the study at colorado state university tyler wible helped identify the management practices of crop rotations and shared data while drs troy bauder and erik wardle provided information on agronomic inputs irrigation and fertilizer rates for the study region the usda is an equal opportunity provider and employer mention of trade names or commercial products is solely for the purpose of providing specific information and does not imply recommendation of endorsement by the usda appendix a table a 1 list of parameters calibrated in the swat model and their adjusted values table a 1 parameter unit description calibrated value lower limit upper limit cncoef bsn plant et curve number coefficient 0 51 0 5 2 cn mgt curve number factor 0 05 0 1 0 1 alpha bf gw days baseflow alpha factor 0 81 0 1 gw delay gw days groundwater delay 0 51 0 60 revapmn gw mm threshold depth of water in shallow aquifer 453 7 450 500 hru slp hru average slope steepness of hrus 0 22 0 5 0 5 epco bsn plant uptake compensation factor 0 82 0 01 1 esco bsn soil evaporation compensation factor 0 78 0 01 1 slsubbsn hru average slope length 0 24 0 2 0 3 ov n hru manning s value for overland flow 0 20 0 1 0 3 sftmp bsn 0c snowfall temperature 0 24 0 2 0 5 smtmp bsn 0c snow melt base temperature 0 14 0 3 0 1 smfmx bsn mm 0c day maximum melt rate for snow during year 0 23 0 2 0 4 canmx hru mm maximum canopy storage 9 60 0 10 ch k1 sub mm hr effective hydraulic conductivity 241 0 300 ch k2 rte mm hr effective hydraulic conductivity in main channel 387 0 500 ch s2 rte average slope of main channel 0 01 0 02 0 05 depimp bsn bsn mm depth to impervious layer for modeling perched water tables 1833 0 6000 table a 2 list of parameters calibrated in the ages model and their adjusted values table a 2 parameter unit description calibrated value lower limit upper limit soiloutlps coefficient for definition of lps outflow 0 33 0 1 soillatvertlps coefficient for distribution of the lps outflow on the lateral and vertical component 13 03 1 30 kdiff layer coefficient used to calculate mps water flux between soil layers 31 33 5 100 t factor temperature factor for snow melt calculation 1 84 0 3 snow trs coefficient used to partition precipitation into snow and rain 0 39 5 1 betaw coefficient used to calculate transpiration in soil layers 21 70 5 25 soilmaxinfsummer mm d 1 coefficient used to calculate maximum infiltration in summer 25 34 0 50 soilmaxinfsnow mm d 1 coefficient used to calculate maximum infiltration for snow covered areas 34 05 0 50 soilmaxperc mm d 1 maximum percolation rate through a soil layer 2 95 0 5 soilmaxinfwinter mm d 1 coefficient used to calculate maximum infiltration in winter 31 23 0 50 g factor soil heat factor for snow melt calculation 3 40 2 5 flowrouteta flood routing coefficient 1 94 0 10 lagsurfacerunoff surface runoff lag factor 1 04 1 10 laginterflow interflow lag factor 1 21 2 5 gwcaprise capillary rise coefficient 0 30 0 001 1 gwrg1fact faster groundwater outflow coefficient 10 62 5 20 gwrg2fact slower groundwater outflow coefficient 62 88 20 80 gwrg1rg2dist rg1 to rg2 gradient distribution coefficient 0 27 0 0 5 rg1 max mm maximum storage capacity faster groundwater storage component 23 22 1 25 rg2 max mm maximum storage capacity slower groundwater storage component 72 44 20 100 geomaxperc mm d 1 maximum percolation rate to groundwater 0 08 0 1 soildiffmpslps coefficient for the diffusion of lps storage in relation to mps 9 85 0 10 soildistmpslps coefficient for distribution of infiltration to the lps and mps soil storages 7 94 0 10 snow trans oc cofficient for temperature dependent fractions precipitation phases 0 99 0 2 5 r factor rain factor for snow melt calculation 1 35 0 3 soilmaxdps mm maximum depression storage capacity 6 23 0 10 geomaxperc mm d 1 maximum percolation rate to groundwater 0 08 0 1 snowcritdens kg m 3 snowpack density beyond which free water is released 0 35 0 0 5 basetemp oc base melting temperature for snow 2 77 3 3 kf0 cm d 1 hydraulic conductivity of surface soil layers variable 0 01 100 deadcapacity dead capacity of soil layers variable 0 01 0 09 fieldcapacity field capacity of soil layers variable 0 2 0 35 aircapacity air capacity porosity of soil layers variable 0 4 0 5 calibration strategy mean initial and calibrated values vary spatially 
25838,spatially distributed process models represent soil water plant nutrient interactions within a watershed we investigated spatial patterns of water balance components and nitrate transport simulated using the fully distributed ages agricultural ecosystems services and the semi distributed swat soil and water assessment tool 2012 models in the big dry creek watershed a mixed agricultural and suburban watershed in semi arid colorado usa we analyzed patterns of hydrological fluxes using daily model outputs for the period 2010 2018 the two models simulated drastically different spatial patterns swat predicted extremely low interflow and routed excess irrigation water to surface runoff and groundwater discharge ages produced realistic estimation of streamflow irrigation return flows and nitrate simulation of less surface runoff and greater interflow and baseflow contributed to improved simulation of nitrate transport in the interior watersheds this study demonstrated the impacts of simulating spatially explicit hydrology that captures interactions among fields and other areas within a managed watershed keywords semi arid hydrology watershed processes wastewater treatment plants irrigation return flow spatial routing 1 introduction changes in land use land management practices and climate variability have significantly altered regional hydrological cycles over the past century mishra and singh 2010 oki and kanae 2006 nijssen et al 2001 vörösmarty et al 2000 thereby affecting freshwater resources at local to regional scales the scientific community has developed several hydrologic simulation models for investigating these compounding challenges on freshwater resources van liew et al 2003 sood and smakhtin 2015 watershed models with various capabilities and degrees of complexity are used to predict or estimate streamflow and nutrient load applicable to sustainable watershed management borah et al 2006 parajuli et al 2009 although a wide variety of hydrological models are available for simulating current and future scenarios model selection is challenging because of model prediction uncertainty associated with input variables e g land use and climate model parameters and scale issues in watershed modeling surfleet et al 2012 however physically distributed models are capable of accurate representation of the spatial distribution of meteorological conditions as well as physical watershed characteristics such as slope soil properties land cover and land use which are not represented well in lumped conceptual models beven 1989 reed et al 2004 el nasr et al 2005 yang et al 2000 another potential benefit of distributed modeling is the ability to produce streamflow predictions at interior ungauged sub catchments khakbaz et al 2012 moreover distributed models are capable of using measured data at small sub catchment spatial units moreda et al 2006 based on the water and nutrient routing over the sub catchment spatial structure within a physically distributed model has been categorized as semi distributed or fully distributed khakbaz et al 2012 biftu and gan 2001 semi distributed models simulate hydrological fluxes at the basin outlet by utilizing sub catchment averaged data and distributed properties such as land use soil type and precipitation lumped into a discrete area pai et al 2012 therefore the smallest spatial units hydrologic response units hrus may not be continuous and there is no routing among them kalcic et al 2015 whereas fully distributed models are capable of routing water and nutrients among the hrus however calibrating watershed variables such as streamflow only at the basin outlet may not improve the spatial accuracy of the hydrologic model in the interior watersheds arabi et al 2006 rathjens et al 2015 therefore we cannot assume that the fully distributed model performs better than semi distributed systems in quantifying hydrological processes in a watershed in the case of fully distributed models considerable computational cost is associated with the development and a large number of model performance evaluations with the observed variables kim et al 2007 vivoni et al 2011 that has not been well addressed in the water resource sector kollat et al 2006 in addition the computational cost increases with the model complexity such as quantification of groundwater elements pulido velazquez et al 2007 and addition of water quality modules in this study we applied a fully distributed model called the agricultural ecosystems services ages model green et al 2014 2015 ascough et al 2015 to an intensively managed suburban and agricultural watershed located in a semi arid region we compare simulation results of ages with the semi distributed swat soil and water assessment tool version 2012 with user interface arcswat 2012 winchell et al 2013 for simulating the water balance return flow and nitrate transport swat has been used for simulating the hydrological fluxes for many different landscapes arnold and fohrer 2005 arabi et al 2006 abbaspour et al 2015 veettil and mishra 2016 2018 aliyari et al 2019 and several studies compared the performance of the swat model with other types of models for instance van liew et al 2003 compared swat with the hydrologic simulation program fortran hspf semi distributed model and observed that swat consistently performed better than hspf for agricultural watersheds under various climatic conditions el nasr et al 2005 investigated the performance of fully distributed mike she models with swat and in this case mike she predicted the streamflow variation over the watershed slightly better than swat a study conducted at catchments in ireland nasr et al 2007 compared the performance of hspf and system hydrologic european transport shetran fully distributed model with swat they found that hspf accurately predicted the daily streamflow quantity but shetran failed to adequately represent the flow peaks and recessions while swat performed better for simulating the daily total phosphorus load ages is a relatively new model the current version 0 3 0 of ages is continuous in time daily time step and fully distributed in space a detailed explanation of ages is provided in the methodology section the irrigation return flow within a watershed is defined as the excess water that is not evapotranspired or used consumptively and finally returns to the drainage channel in the form of surface or subsurface flow wu et al 2019 garcía garizábal et al 2010 kim et al 2009 gosain et al 2005 the volume and quality of return flow in a watershed varies based on several factors such as landscape topography land use type soil type and irrigation method in the watershed dewandel et al 2007 return flow has a major role in water balance particularly in intensively irrigated watersheds mohan and vijayalakshmi 2009 surface return flow from irrigated agricultural fields is a result of excess precipitation and irrigation and it is considered as a major contributor to non point source pollution zuazo et al 2009 vadas et al 2015 in the stream network several research methods have been proposed for quantifying the return flow from watersheds which include experimental setup and methodology based on water balance models wu et al 2019 the experimental method requires extensive field trials to generate high quality field data that are difficult to carry out in a large scale watershed jafari et al 2012 dewandel et al 2007 therefore the application of physically distributed watershed models is an effective tool to estimate the return flow at different scales based on the water balance simulation using limited data xie and cui 2010 although swat and its predecessors are lumped within sub catchments swat developers recognized its limitations and recently released swat bieger et al 2017 with extended capability to route water explicitly among spatial units a goal of this study is to compare the performances of the commonly used swat 2012 called simply swat from here on and ages models concerning their accuracies of simulating daily discharge at the watershed outlet and to investigate the water balance and return flow for an intensively managed watershed located in a semi arid region the specific objectives are to 1 investigate and compare the capabilities of ages and swat models to estimate the water balance components such as evapotranspiration et surface and groundwater flow soil percolation and interflow lateral flow in swat 2 enhance the understanding of streamflow and nitrate sources and dynamics within each sub catchment based on ages and compare the sub catchment outflow generated with swat 3 quantify and compare the surface interflow and groundwater return flows based on both models and 4 estimate the return flows from the irrigated agricultural systems located in the lower portion of the watershed while several studies have focused on performance comparisons of swat with other lumped semi distributed and fully distributed models model evaluation for an intensively managed and irrigated semi arid watershed in terms of water balance and return flow estimation is novel also this study provides the first direct comparison of swat with ages 2 study area and data 2 1 study area the big dry creek watershed bdcw is a 280 km2 mixed agricultural and suburban watershed located in the vicinity of denver colorado fig 1 a the average annual precipitation in the watershed is 315 mm and most of the precipitation occurs as rainfall distributed throughout the summer season the bdcw is an intensively managed watershed including inputs from three wastewater treatment plants and reservoir discharge water diversion structures and irrigated and non irrigated agricultural fields the land use types in the bdcw can be roughly classified into three major categories the headwater area is rocky flats which consists of grass pastureland in addition the watershed hydrology in the headwater area is significantly influenced by the standley reservoir which supplies water to the downstream farms as well as domestic sector the middle portion of the watershed is predominantly suburban land a mixture of residential commercial and industrial uses and the lower watershed is primarily agricultural land comprised of corn alfalfa winter wheat and pasture for livestock production 2 2 data various spatial and temporal datasets were collected from multiple sources to run swat and ages for the bdcw table 1 these datasets include a digital elevation model dem obtained from national elevation dataset ned provided by the u s geological survey usgs 2020 at a resolution of 10 m b land use data crop data layer for the year 2018 obtained from usda nass 2018 c ssurgo soil data obtained from the natural resources conservation service usda nrcs 2020 d irrigated agricultural field layer data obtained from the colorado decision support system cdss e precipitation and temperature data 2010 2018 obtained from various sources including the national climatic data centre ncdc cdss and colorado agricultural meteorology coagmet supported by the colorado state university f solar radiation relative humidity and wind speed data obtained from iowa environmental mesonet iem and coagmet g streamflow data inlet and outlet obtained from the usgs and h wastewater treatment plant discharges water quantity and quality obtained from the big dry creek watershed association http www bigdrycreek org 3 methods the upland area including rocky flats and standley reservoir is not directly modeled in the study the discharge data downstream of the standley reservoir usgs 06720820 were used as an inlet to the bdcw model the lower bdcw model consists of a spatial area of 186 km2 fig 1b 3 1 soil and water assessment tool swat swat is a continuous time semi distributed and process based hydrological model developed by the u s department of agriculture arnold et al 1998 which has been used extensively for hydrologic and water quality simulation in watersheds ranging from small field scales cibin et al 2012 tasdighi et al 2018 to large river basins veettil and mishra 2016 2018 aliyari et al 2019 and continental scale abbaspour et al 2015 the model has the capability to work based on daily weather input and for smaller time units the dem is used in the arcswat interface preprocessed to delineate a river basin the delineated river basin is divided into sub basins which are further divided into unique land use soil slope spatial units hrus the delineation of hrus is achieved by overlaying the soil land use and slope map of the river basin in general the number of hrus is controlled by adjusting the land use soil and slope threshold her et al 2015 here we adopted the swat default flow direction and accumulation the final model resulted with 16 sub catchments and 1243 hrus the surface runoff in swat can be calculated using the curve number cn method based on soil moisture condition cn i or et cn ii the cn i approach tends to overestimate the surface runoff in shallow soils kannan et al 2007 therefore we used the cn ii method 1 s t s t 1 e 0 e x p c n c o e f s t 1 s m a x r d a y q s u r f where s t is the retention parameter and s t 1 is the retention parameter from previous day e 0 and cncoef are the potential et and plant et curve number coefficients determined by calibration during the beginning of a swat simulation the retention is estimated as s 0 9 s max where s max is calculated as 2 s m a x 25 4 1000 c n 10 where cn is the curve number cn ii based on plant et neitsch et al 2011 tasdighi et al 2018 in this study we used the arcswat version 2012 https swat tamu edu software a detailed description of arcswat 2012 is available in winchell et al 2013 3 2 agricultural ecosystem services ages model ages is a java based fully distributed and continuous watershed model ascough et al 2012 2015 green et al 2014 2015 developed with the object modeling system 3 oms3 environmental framework david et al 2013 ages reflects the routing of water and nutrients in an hru level i e a single hru unit in ages simulates values for surface runoff lateral flow and water quality components with spatially explicit routing among hrus and stream reaches the hydrologic components in ages are primarily adopted from the j2000 krause et al 2006 and j2000 sn fink et al 2007 models the ages model implementation for the bdcw is illustrated in fig 2 domain delineation for the modeled area was performed using the catchment areas delineation cadel tool a web service with browser interface for delineating watershed boundaries sub catchments stream network and hrus with spatial reference and geospatial attribute tables https alm engr colostate edu cb wiki 42641 cadel version 0 1 18 generates input parameter sets for ages and could be adapted to other distributed hydrological models in the future the user specified dem is processed for the topology of flow paths and combined with raster layers of land use soil data and hydrogeology to generate hrus within each sub catchment flow paths may be many to one convergent one to one cascading and one to many divergent flow partitioning among hrus and stream reaches is specified in a routing file here hrus in agricultural areas are delineated to match the boundaries of irrigated fields this method provides capability to apply spatially explicit crop management practices to the irrigated hrus in the developed model for comparison with swat 16 sub catchments were generated in the final ages model whereas the total number of hrus was 1551 finally crop management practices e g rotation were identified by applying land use and agricultural management practices web service lamps kipka et al 2016 a detailed explanation on lamps and crop management practices in the watershed are provided in section 3 6 the current daily version of ages version 0 3 0 generates four inter connected pathways in each hru for simulating the runoff and water quality loads surface runoff lateral interflow from multiple variably saturated soil layers fast discharge from the saturated zone and slower baseflow from the saturated zone a central part of ages is the soil water process component which interacts with most of the other process components including surface and subsurface runoff groundwater storage and flow and canopy et interaction initially ages quantifies the precipitation interception storage for each hru based on the land use type and simulated leaf area infiltration into the soil profile is computed based on the eagleson 1970 equation which is given as 4 i n f i l t r a t i o n m a x s o i l m a x i n f s w 1 θ s o i l k f where the subscript max represents the maximum amount of water intake soilmaxinf is the moisture dependent infiltration parameter during either summer s or winter w season θ s o i l is the saturation of soil layers and k f is the field saturated hydraulic conductivity of the surface layer each soil layer in ages is divided to two compartments 1 medium pore storage mps and 2 large pore storage lps the mps represents the soil water held against gravity in the medium sized pores and lps is soil water in the large sized pores which drain more rapidly and thus act as a primary source of vertical and horizontal outflow the mps and lps in each soil layer of an hru are calculated based on various physical properties e g field capacity porosity and dead capacity more detailed descriptions of ages are available in ascough et al 2012 and green et al 2014 2015 3 3 model calibration and performance evaluation calibrations of ages and swat models were performed by fitting the observed daily streamflow usgs 6720990 located in the lower part of the bdcw nitrate concentration was calibrated for three gauging locations located within the watershed fig 1b at a daily time scale swat was calibrated by comparison with observed bdcw streamflow data using sufi2 sequential uncertainty fitting version 2 optimization algorithm abbaspour 2005 abbaspour et al 2007 based on the latin hypercube sampling sufi2 also supports parameter estimation and sensitivity analysis the sensitivity analysis is performed by using the inbuilt global sensitivity analysis where the sensitivity of parameters is estimated based on t stat and p value sufi2 is capable of narrowing the model parameter range which reduces the overall uncertainty in the calibrated model the overall time period used in our model performance analysis is 2010 2018 in daily time steps the model calibration is performed for 7 years 2012 2018 and independent model testing is performed for the period 2010 and 2011 given the large interannual variability and limited period of record all available data were used for the performance analysis and goodness of fit was evaluated for individual years over the full analysis period subsequently water balance and return flow analysis for ages and swat were performed for the calibration period using the best available data ages was calibrated by comparison with observed bdcw streamflow data using luca let us calibrate a multi objective stepwise and automated hydrologic model calibration procedure hay and umemoto 2006 that uses the shuffled complex evolution sce global search algorithm duan et al 1994 the luca code was ported into the object modeling system oms version 3 5 console which is a java application used to create edit and run luca simulations the oms console also supports parameter editing post run visualization output analysis and the creation of trace files of all parameter sets and objective function values defined below calibration runs were deployed through a luca script file where we specified the observed dataset period of calibration objective function and parameters to calibrate luca requires user specified steps which are performed sequentially through the parameter groups for a specified number of rounds we used the mean value method luca option where the mean of a set of parameter values is adjusted while preserving the distribution of relative input values in this study the parameters related to soil horizon e g saturated soil hydraulic conductivity dead capacity and porosity were calibrated similar to swat daily ages calibration was performed from 2012 to 2018 performance of both models was evaluated for daily and monthly average values based on the following statistics percent bias pbias coefficient of determination r2 nash sutcliffe efficiency nse and kling gupta efficiency kge only kge was used as the objective function for parameter calibration at the daily time step in luca the kge goodness of fit criteria was introduced by gupta et al 2009 as an improvement to nse and garcia et al 2017 identified kge as the best objective function to simulate low flow in combination with a wide range of flow values the kge is estimated as 3 k g e 1 r 1 2 α 1 2 β 1 2 where r is the correlation coefficient between model simulated and observed streamflow β is the ratio of mean simulated and mean observed streamflow and α represents the ratio between standard deviation of simulated and observed flow the model performance and calibrated parameters are explained in section 4 1 the parameters selected for calibration and their ranges were selected based on previous studies aliyari et al 2019 green et al 2015 in the region 3 4 interpolation of precipitation data precipitation is the major driving force of spatially distributed models camici et al 2018 veettil and mishra 2016 2020 in this study we used daily precipitation data from 19 gauges located inside and outside the watershed boundary a key difference between the two models tested is that swat uses uniform precipitation over each sub catchment whereas ages uses uniform precipitation at the hru scale but allows spatial variability among hrus and within sub catchments the interpolation method adopted in swat is the nearest neighbor nn method in this study the nn method included only the 10 precipitation gauges out of 19 available that were closest to the centroid of each sub catchment in contrast ages interpolation method inverse distance weighting idw used all 19 stations we observed that the spatial distribution of precipitation was extremely different when applying these different interpolation methods in each model after initial calibrations of both models swat simulation of streamflow at the outlet was much worse than the ages simulation the annual average precipitation over the basin while applying nn interpolation method in swat was 353 7 mm whereas ages resulted in an annual average precipitation of 375 mm perhaps more important than the average difference the spatio temporal distributions of precipitation differed substantially which played a major role in the model performance thus we used the hru level interpolated data from ages upscaled to sub catchment averages to provide approximately equal spatial distributions and watershed level daily precipitation amounts for both models use of the sub catchment average precipitation based on ages increased the annual average precipitation to 369 4 mm and improved model performance compared with the nn method 3 5 wastewater treatment plant discharge three major wastewater treatment plants wwtps which provide nearly continuous baseflow and n load to the big dry creek are broomfield bf westminster wm and northglenn ng fig 1b fig 3 illustrates the monthly average inflow usgs 6720820 and effluent discharge contributions from these three wwtps the inlet station is located approximately 7 5 km straight line distance downstream of standley reservoir discharge higher inflow to the bdcw from reservoir discharge is observed during the summer season and maximum inflow occurs in june and july in the case of the wwtps the wwtp wm contributed the highest total amount of effluent discharge to the bdcw whereas the wwtp bf has higher contributions during the summer season the wwtp wm focused on reclamation during the summer season and the wwtp bf focused on the winter season with associated reductions in effluent discharge in those seasons historically the effluent discharge from wwtp ng to the bdcw has been infrequent however from 2013 to 2018 northglenn discharged more frequently to the watershed and the effluent discharge was relatively lower than westminster and broomfield wwtp clary 2020 3 6 crop management crop management practices have a significant role in controlling the return flow from irrigation and nonpoint source pollutants in a watershed cibin et al 2012 however no clear records of crop management practice are available for bdcw here the irrigated agricultural field layers were obtained from the colorado decision support system cdss and the crop rotation for all the major crops in the irrigated fields such as alfalfa corn pasture and winter wheat were identified based on lamps lamps was developed to provide crop management and rotation information for a user defined area of interest within the u s based on the annual crop data layers cdl irrigated area maps compiled by usgs https www usgs gov land resources eros droughtstress science modis irrigated agriculture qtscience center objects 5 qt science center objects and the land management and operation database lmod david et al 2014 lamps is available for use to the scientific community and detailed information is available kipka et al 2016 green et al 2018 swat provides options for scheduled and auto irrigation uniyal and dietrich 2019 chen et al 2019 in this study we used the auto irrigation option due to the lack of scheduled irrigation information in the bdcw the auto irrigation module in swat is triggered based on soil water deficit and plant water stress however some studies reported that the auto irrigation function in swat was unable to appropriately represent the actual irrigation amount in a watershed akhavan et al 2010 dechmi et al 2012 chen et al 2019 these studies also document that when the soil water deficit method is used the irrigation event is not suspended even after the harvesting period marek et al 2017 therefore we used the plant water stress based auto irrigation method which is based on a fraction of potential plant growth and the soil field capacity in general cultivated land boundaries do not match with swat generated hrus and this implicit nature of hrus makes realistic irrigation challenging in the swat model pai et al 2012 although we tried to preserve the field boundaries of irrigated fields by overlaying the land use layer and irrigated field layers preserving all the irrigated fields in the bdcw swat model was cumbersome like swat ages applied an automatic deficit irrigation method in ages any time water content in the medium pore storage mps falls below a certain threshold the model will apply irrigation water in this study the total seasonal irrigation water requirement for each crop was obtained from colorado state university extension schneekloth and andales 2017 in swat the auto irrigation application amount in the plant water based method is considerably controlled by the parameter water stress threshold that triggers irrigation auto wstrs the factor ranges from zero to one where values near one indicate the irrigation stress is not limiting the plant growth our initial calibration result yielded a low value of auto wstrs 0 5 producing low amounts of total irrigation input to optimize the swat model results but the total amount of generated irrigation based on a lower auto wstrs was not realistic and much lower than ages generated output neitsch et al 2011 suggested the usual range of the threshold should be higher than 0 9 for generating realistic irrigation in the watershed therefore in this study we changed the value of the threshold to one for generating the maximum amount of irrigation in swat even so the catchment average irrigation generated in swat model was slightly less than ages while applying the same daily maximum irrigation chen et al 2017 meanwhile ages generated the estimated seasonal water requirements for eastern colorado crops e g alfalfa corn winter wheat and hay pasture suggested by schneekloth and andales 2017 therefore we adjusted the irrigation generated in the swat hrus to be comparable with ages hrus in addition to changing the threshold to one we increased the amount of irrigation water applied during each auto irrigation to 23 higher than the ages irrigation rate this helped us to generate an irrigation output in swat nearly equal to ages generated irrigation the final irrigated amount generated in swat was 15 higher than the irrigation generated by unadjusted auto irrigation where the auto wstrs 1 thus the final swat model setup was used to obtain equivalent drivers for model precipitation and irrigation for model intercomparison with ages 3 7 water balance and water yield the water balance analysis elucidates the fundamental partitioning of water between different inputs e g rainfall and snow to a catchment and processes that remove water from the catchment in the form of different components such as surface water flow interflow groundwater flow deep percolation and et daly et al 2019 thompson et al 2017 although considerable effort has been devoted to investigating the catchment behavior mcdonnell et al 2007 peters lidard et al 2017 understanding and quantifying the components of water balance remains a fundamental issue in catchment hydrology due to the complexity in catchment water flow and storage leopold 1997 daly et al 2019 for a fixed input dataset a fully distributed and a semi distributed hydrological model may show significant changes in mean areal water balance components in general it is important to evaluate the diverse components of water balance in a catchment to deal with the water management issues ayivi and jha 2018 in this study we compared the water balance components including et surface runoff interflow or lateral flow groundwater flow and percolation from ages and swat based on the 7 years of daily model simulation in addition we calculated the water yield wyld the aggregate sum of water leaving an hru and entering the stream network during the time step neittsch et al 2011 as the sum of surface water return flow surq interflow or lateral flow latq and groundwater return flow gwq from the shallow aquifer 3 8 quantifying lateral flow and irrigation return flow return flow refers to the amount of water discharging to stream channels reaches in the form of surface interflow and groundwater flow from hrus in the contributing areas after rainfall or irrigation events wu et al 2019 kim et al 2009 the surface water return flow from swat is calculated based on the hru output surq cnt which represents the surface runoff contribution to the stream network during the time step and the lateral or interflow is calculated based on the output latq gen which represents the variably saturated water flowing laterally within the soil profile and enters in to the main channel the groundwater return flow is quantified based on gw q which is the water from the shallow aquifer that enters the channel network neitsch et al 2011 finally the percolation is calculated based on the output perc in swat in the case of ages the surface water return flow for each hru is quantified as the difference between surface runoff outflow minus inflow and the lateral flow for each hru is the difference between interflow outflow minus inflow the groundwater return flow for each hru is the difference between the sum of fast and slow groundwater outflow minus inflow the percolation in ages recharges groundwater storages that flow to the stream reach and or adjacent hrus whereas in swat water that percolates goes to the deep aquifer is considered lost from the system mapes and pricope 2020 in addition we compared the ages and swat generated baseflow derived based on automated baseflow separation and recession analysis techniques developed by arnold et al 1995 using a digital filter based automated base flow separation this method is capable of producing results similar to a graphical separation technique 4 results both the models provided adequate streamflow simulation results at the watershed outlet but ages performed better than swat overall notably ages and swat simulated significantly different patterns of hydrological fluxes within the watershed 4 1 performance of models the hydrograph fig 4 a and b deviation of simulated flow from observed discharge fig 4c and d quantile quantile q q plot showing data for 100 quantiles fig 4e and scatter plot fig 4f show that in general both models replicated the dynamics of daily hydrological fluxes throughout the entire simulation period the daily and monthly model performance statistics table 2 indicated that both models produced very good agreement with observed data and that ages daily nse 0 77 daily kge 0 88 was substantially better than swat daily nse 0 55 daily kge 0 76 at capturing watershed level streamflow responses for instance an increase in r2 of 0 17 indicates that ages explains an additional 17 78 total of the variance between modeled and measured streamflow at the outlet based on the q q plot fig 4e ages and swat performed well during the low flow periods but deviated more from observed data at high flows the most noticeable drawback of both swat and ages is their failure to accurately simulate the high flows in the watershed where most of estimated daily streamflow peaks are higher than the observed values particularly for flows in the range of approximately 10 20 m3 s the yearly performance statistics table 3 also show that ages consistently captured the streamflow response better than swat for years 2010 2011 the percent of missing precipitation data for the model testing years was higher than 45 percent both models performed more poorly during 2010 2011 testing than during the model calibration period but this may be attributed to data quality rather than independent performance evaluation overall 18 parameters table a 1 were optimized for swat streamflow calibration and in the case of ages calibration 33 model parameters were calibrated the list of calibrated parameters of ages and their adjusted values are provided in table a 2 subsequently the model performance is evaluated for nitrate concentration table 4 like the flow simulations ages performed better than swat at all the six water quality gauging stations located in the interior bdcw the goodness of fit statistics for the monitoring location bdc 6 were less than the other locations due to the absence of consistent effluent data from wwtp ng and the possibly the influence of agricultural fields the spatial accuracy of interior sub watersheds in a hydrological model may not be improved by calibrating the watershed variables such as streamflow only at the basin outlet arabi et al 2006 in the present study however the fully distributed ages model performed better than the swat model for simulating daily streamflow table 2 and nitrate concentrations in the bdcw table 4 although both models performed relatively poorly at the monitoring gage bdc 6 see station locations in fig 1b ages was able to represent the nutrient fluxes in the other locations bdc 1 5 to bdc 5 better than swat even at bdc 6 where ages produced relatively lower values of kge nse and r2 the model bias was significantly lower in magnitude for ages 4 5 than swat 16 2 reduced model performance at bdc 6 may be due to borh the lack of proper nutrient inflow data from northglenn wwtp and influences of intensive agricultural management in the lower watershed area which were not captured using generic management practices for all fields ages model skill in representing the water balance in the interior watersheds may contribute to the improved water quality simulation therefore we investigate the patterns of water balance components produced by ages and swat in the bdcw 4 2 water balance components fig 5 a illustrates area weighted average bdcw water balance components from ages and swat simulations the et simulated by ages 511 mm was only 3 4 more than swat 494 mm after adjusting swat input data for precipitation and irrigation to better match the amounts determined using ages without these adjustments i e using default methods and the same raw input data swat drastically underestimated et not shown according to velpuri and senay 2017 and reitz et al 2017 the adjusted results are acceptable for a semi arid region both ages and swat applied a version of the penman monteith method for simulating the et here the et includes evaporation from the plant canopy transpiration soil evaporation and evaporation from depression storages the annual water yield wyld simulated by ages 70 7 mm was slightly less than the final wyld by swat 71 3 mm fig 5a the surface overland flow surq estimated by ages 36 3 mm was comparatively higher than soil interflow latq 22 3 mm and groundwater flow gwq 12 1 mm whereas swat hydrology was driven primarily by surq 54 0 mm followed by gwq 17 0 mm with almost no contribution from latq fig 5b this result is consistent with underprediction of latq in swat reported previously by white et al 2011 and hoang et al 2017 the variation in baseflow contribution quantified by ages and swat models was compared first based on subsurface lateral flow components fig 6 a and b illustrate the daily and monthly discrepancies in baseflow quantified at the watershed outlet by ages and swat compared with the observed baseflow which includes point source inputs from the upper watershed and effluent from three wwtps during most months simulated baseflow was less for swat than ages both models underestimated observed baseflow from october to january the comparison of daily distributions of baseflow for the period 2013 2015 based on the model simulation and observed flow fig 6b indicates that the patterns of simulated baseflow match the observed baseflow maxima the simulated peak baseflow showed a time lag for the time period april 2014 to december 2014 overall ages represented the baseflow better than swat however simulated baseflow in both models was unable to represent the minimum baseflow i e observed baseflow nearly equal to zero fig 6c shows the monthly distributions as boxplots of daily ages simulated baseflow watershed average which was calculated as the sum of interflow and groundwater discharge plus all the inlet flow to the watershed finally we compared the sum of monthly distribution of interflow and groundwater flow quantified based on ages and swat the results indicate that the ages simulated values are substantially higher than the swat simulated values 4 3 spatial streamflow analysis annual average streamflow based on ages and swat simulations for each sub catchment are illustrated in fig 7 ages represents streamflow at a finer watershed scale i e all the tributary stream network within a sub catchment whereas swat lumps streamflow amount to the sub catchment output and represents only the sub catchment output value streamflow magnitude at the sub catchment outlets is highly spatially variable and the flow volume increases from upper to lower watershed areas mostly due to the influence of wwtp discharges because swat generates streamflow only at the sub catchment outlets only those locations are plotted in fig 7 thus simulated spatial patterns within sub catchments can be generated as output of ages and visualized in this manner average simulated streamflow among the 16 sub catchment outlets was slightly higher for ages than swat despite over prediction of the highest flows using ages fig 4e and f simulated average annual outflow was 1 14 m3s 1 for ages and 1 24 m3s 1 for swat versus a measured mean of 1 11 m3s 1 at the watershed outlet 4 4 quantifying spatial patterns of lateral flows using flux variable names from swat fig 8 illustrates the spatial pattern of annual surface runoff surq interflow or lateral flow in the vadose zone latq and groundwater flow gwq for both ages and swat the catchment average of surq simulated by swat is 49 higher than ages and the spatial patterns of simulated surq for differed dramatically between models in the case of ages most hrus in the upper sub catchments produced higher surq than lower sub catchments but swat had higher surface flow for irrigated hrus in the lower catchment area although some swat hrus in the upper catchment showed a higher value of surq most hrus ranged from 30 to 75 mm yr the land use type of upper watershed area is primarily suburban developed with mixed residential and commercial areas and a larger proportion of precipitation leaves these suburban catchments as surface runoff from partially impervious areas in addition the precipitation over the upper sub catchments was higher by approximately 42 than the precipitation falling on lower sub catchments therefore the higher surq simulated by swat in the lower agricultural area is driven by crop management practices whereas surq in ages is controlled by rainfall patterns and developed land in the upper areas of bdcw the number of hrus with higher surq in ages was less than in swat annual average surq simulated by ages was greater than 100 mm for most hrus in the upper watershed compared to swat ages and swat also produced noticeable differences in the central portion of the bdcw which has a mixture of suburban and agricultural land ages simulated lower surq 0 5 mm for most hrus in the central sub catchments whereas swat simulated relatively higher surq 10 30 mm and the irrigated hrus in central sub catchments simulated higher 60 mm surq the annual average interflow latq quantified based on ages and swat differed substantially both in spatial distribution throughout the bdcw fig 8c and d and in average flow fig 5c the interflow simulated with ages varies from zero to more than 100 mm across the hrus of bdcw whereas swat simulated a maximum latq of 5 mm unlike surq the pattern of latq in ages is more highly variable among field scale hrus and more evenly distributed from upper to lower watershed areas in addition the spatial distribution of latq in ages is influenced by the irrigation amount spatial distributions of annual groundwater flow gwq based on ages and swat are illustrated in fig 8e and f respectively groundwater flow in ages is higher in the lower sub catchments whereas swat simulated slightly higher gwq in the upper sub catchments similar to ages the spatial distribution of gwq in swat is highly influenced by the irrigation amount finally we analyzed surq latq and gwq at the hru level for periods with high flow 95th percentile and low flow 5th percentile watershed outlet streamflow conditions the results from both models indicated that the surface runoff interflow and groundwater flows across the hrus of bdcw were negligible during the low flow so these are not shown spatial distributions of surface runoff lateral flow and groundwater flow mm d 1 for each hru averaged over days with high flow are illustrated in fig 9 in agreement with average surq patterns fig 8a ages average high flow period surq was greater for hrus in the upper bdcw fig 9a whereas swat high flow followed a different pattern than average surq fig 8b however the lateral flow produced by swat during the high flow was less than 0 5 mm d 1 for all hrus fig 9d ages generated interflow followed the similar pattern of yearly average interflow fig 9c interestingly the spatial distributions of gwq differ greatly between models fig 9e and f similarities with annual average patterns fig 8e and f are apparent but ages produced higher groundwater flows in the lower watershed during high streamflow periods while having very low groundwater flows in most of the upper watershed unlike surq the average daily flow of the top 5 of gwq accounts for only a small fraction about 1 of average annual gwq so does not dominate the annual gwq patterns because the groundwater flow is more stable less transient or flashy than surq even so periods of high gwq can be caused by high irrigation amounts particularly in the lower bcdw 4 5 evaluating return flow from irrigated agricultural systems the average annual irrigation amounts generated by both models were nearly the same at a catchment level ages 112 mm swat 113 mm and irrigated hrus level ages 382 mm swat 386 mm fig 10 shows boxplots of hru scale variability in average annual return flows from irrigated agricultural fields computed as the sum of surq latq and gwq the tabular statistics of total return flow are also shown in fig 10 to clarify the main differences e g minima medians and inter quartile ranges similar to the watershed scale water balance behavior the average return flow simulated with swat was substantially higher than return flows simulated by ages annual average surq and gwq over the irrigated agricultural fields were 86 4 mm and 28 3 mm from swat compared to 15 3 mm and 12 0 mm from ages conversely annual average latq was 17 6 mm from ages compared to only 0 27 mm from swat different by a factor of 71 5 discussion and conclusion the simulation results for the big dry creek watershed bdcw in colorado usa provide insights into watershed responses in a semi arid region and a direct comparison of a widely used semi distributed model swat and a recently developed fully distributed spatial model ages version 0 3 0 in addition to comparing model performance at the watershed level the aspects of model setup simulated patterns within this mixed use watershed estimates of irrigation return flow and the influence of treated wastewater discharge on baseflow in the bdcw were investigated the inverse distance weighted idw average precipitation inside each of 16 ages sub catchments was used for both models we observed that use of the ages sub catchment average precipitation data improved swat performance substantially compared to direct usage of nearest neighbor precipitation station data provided by arcswat 2012 swat also allows user input precipitation data for each sub catchment so improved weighting methods such as the hru level idw method used in ages could be easily imported to swat and may similarly improve simulation results the crop management in the bdcw was identified based on lamps to provide consistent land use among hrus and crop management practices to the agricultural fields for both ages and swat in addition the crop irrigation in both the models was triggered by automatic irrigation scheduling which works based on a fraction of the soil field capacity however there is a minor difference in ages and swat generated irrigation amount if we apply the same irrigation input amount to both models the seasonal irrigation amounts generated by ages were comparable with field studies conducted by the colorado state university extension department schneekloth and andales 2017 therefore we increased the swat irrigation input amount by 23 such that the adjusted irrigation amounts were nearly same for ages and swat the initial water balance components quantified by ages and swat were substantially different i e before adjusting the precipitation and irrigation amount after adjustments were made to provide comparable inputs for model intercomparison ages average et was only 3 5 higher than the average et computed with swat ages reports et from interception storage depression storage and actual et soil evaporation plant transpiration separately whereas swat reports actual et and plant transpiration separately if the penman monteith method is selected as the potential et method however neitsch et al 2002 recommended using swat impoundment tools its for more accurately estimating the et from depression storage impoundments the present results indicate that swat under predicted latq interflow in the watershed which agrees with previous experience white et al 2011 hoang et al 2017 interflow occurs when the soil moisture content is above field capacity and the lateral transmittivity of soil depends on layer thickness and saturated hydraulic conductivity the low topographic slopes of hrus in bdcw reduced the hydraulic gradient and led to reduced interflow in ages on the other hand the swat assumes that the flat and near stream regions saturate in the initial stage and release more surface runoff therefore the flat nature of watershed landscapes may be a possible reason for reduced subsurface lateral flow and higher surface runoff output in swat in ages infiltration from precipitation and snowmelt is quantified based on the eagleson 1970 equation a majority of the watershed area is comprised of loess soils with relatively high infiltration capacities the combined influences of soil type and flat nature of watershed landscape transfer more water to the soil water compartment for interflow this may be a possible reason for higher amounts of interflow in ages output the return flows from irrigated agricultural fields simulated by swat were generally higher than ages fig 10 for the catchment average for instance the catchment average annual total return flow simulated by swat is 114 mm which is 3 5 times greater than the return flow of 32 mm simulated by ages conversely the interflow contribution from irrigated agricultural fields simulated by swat was negligible which indicates that swat only allocated irrigation water to surface runoff and groundwater discharge typically modelers employ the auto irrigation function within the swat model but there have been concerns whether the model is able to adequately represent the irrigation amount akhavan et al 2010 dechmi et al 2012 chen et al 2017 2019 whereas ages matched observed seasonal irrigation well and partitioned precipitation and irrigation water to surq 19 4 latq 47 8 and gwq 32 8 in addition the spatial range of annual return flows simulated by ages was much higher than swat although actual hru level values over the whole watershed are unknown we expect values ranging from near zero for semi arid rangelands with perennial vegetation and no irrigation to near the annual precipitation amount for impervious areas in the mixed land use watershed thus the range simulated by ages appears to be realistic the baseflow quantified at the watershed outlet fig 6 based on automated baseflow separation and recession analysis techniques indicate less baseflow was simulated using swat than ages also watershed average of monthly latq gwq from ages is significantly higher than swat this result is consistent with previous studies bailey et al 2016 liu et al 2019 which found that swat typically offers better emphasis on surface water process but represents the groundwater process with relatively simple dynamics the model considers two layers of aquifer system in each hru a shallow unconfined aquifer and a deep confined aquifer the water from shallow aquifer could move to deep aquifer while the reverse process is not allowed both aquifers contribute water to streamflow as baseflow based on a linear reservoir approximation by ignoring the distributed parameters such as hydraulic conductivity kim et al 2007 liu et al 2019 with this simplified representation of groundwater flow swat may give inaccurate estimation of groundwater flow in semi arid catchments shao et al 2019 where most of the flow is contributed from the groundwater resources gassman et al 2014 in ages groundwater is comprised of two components partitioned into faster discharge and slower baseflow from the saturated zone unlike swat the contribution of water from the groundwater systems to the streams are based on retention coefficients and simulated calibrated storages in the system thus ages may better emulate the spatio temporal distribution of the groundwater return flow even so both models use simplistic response functions to simulate the groundwater storage dynamics and discharge overall both spatially distributed models are found to be useful for investigating and comparing the water balance components and return flow in the bdcw the realistic simulation of critical hydrological process in a watershed modeling system is crucial for instance overestimation of surface runoff leads to overestimation of sediment yields and surface nitrate and other soluble contaminant yields arnold et al 2014 further it will generate errors in model parameterization related to nutrient transport and leads to unrealistic policy making related to wastewater treatment plants and fertilizer pesticide application this study also illustrates that watershed models may underestimate or overestimate the critical water balance processes within a watershed quantification of these water balance components within watersheds has a major role in improving the water quality simulation in hydrological models and ages performed better than swat for simulating streamflow and nitrate yields in the bdcw we conclude that ages produced more realistic behavior of return flow and water balance components in a semi arid intensively managed watershed the semi distributed swat 2012 results differ dramatically from fully distributed ages results in terms of space time water routing and distributions of surface and subsurface return flows while both models fit watershed scale streamflow and n loads reasonably well at the watershed level the differences are significant in terms of nash sutcliffe efficiency which measures amount of scatter explained by each model ages fit the observed streamflow data better than swat for all simulated years in multi year evaluations on average ages explained 17 more of the variability in daily streamflow than swat based on r2 values and 22 more based on nse 0 77 versus 0 55 finally this study was initiated before dissemination of swat which was not used here beyond the present scope however our conclusions caution against continuing to use semi distributed models like swat 2012 for spatial estimation and these results support the development and testing of more fully distributed models like ages or swat for future applications software and or data availability name of software agricultural ecosystems services ages version 0 3 0 description ages is a component based watershed model built with the of java connection framework jcf and object model systems oms frameworks water is routed explicitly among hydrological response units hrus and stream reaches with topology and routing generated by the catchment areas delineation cadel web tool for each project source language java download site https alm engr colostate edu cb project ages developers timothy r green holm kipka nathan lighthart olaf david jim ascough and others contact address water management and systems research unit usda ars 2150 d centre ave fort collins co 80526 email tim green usda gov declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the big dry creek watershed association https www bigdrycreek org provided helpful information and feedback on the study at colorado state university tyler wible helped identify the management practices of crop rotations and shared data while drs troy bauder and erik wardle provided information on agronomic inputs irrigation and fertilizer rates for the study region the usda is an equal opportunity provider and employer mention of trade names or commercial products is solely for the purpose of providing specific information and does not imply recommendation of endorsement by the usda appendix a table a 1 list of parameters calibrated in the swat model and their adjusted values table a 1 parameter unit description calibrated value lower limit upper limit cncoef bsn plant et curve number coefficient 0 51 0 5 2 cn mgt curve number factor 0 05 0 1 0 1 alpha bf gw days baseflow alpha factor 0 81 0 1 gw delay gw days groundwater delay 0 51 0 60 revapmn gw mm threshold depth of water in shallow aquifer 453 7 450 500 hru slp hru average slope steepness of hrus 0 22 0 5 0 5 epco bsn plant uptake compensation factor 0 82 0 01 1 esco bsn soil evaporation compensation factor 0 78 0 01 1 slsubbsn hru average slope length 0 24 0 2 0 3 ov n hru manning s value for overland flow 0 20 0 1 0 3 sftmp bsn 0c snowfall temperature 0 24 0 2 0 5 smtmp bsn 0c snow melt base temperature 0 14 0 3 0 1 smfmx bsn mm 0c day maximum melt rate for snow during year 0 23 0 2 0 4 canmx hru mm maximum canopy storage 9 60 0 10 ch k1 sub mm hr effective hydraulic conductivity 241 0 300 ch k2 rte mm hr effective hydraulic conductivity in main channel 387 0 500 ch s2 rte average slope of main channel 0 01 0 02 0 05 depimp bsn bsn mm depth to impervious layer for modeling perched water tables 1833 0 6000 table a 2 list of parameters calibrated in the ages model and their adjusted values table a 2 parameter unit description calibrated value lower limit upper limit soiloutlps coefficient for definition of lps outflow 0 33 0 1 soillatvertlps coefficient for distribution of the lps outflow on the lateral and vertical component 13 03 1 30 kdiff layer coefficient used to calculate mps water flux between soil layers 31 33 5 100 t factor temperature factor for snow melt calculation 1 84 0 3 snow trs coefficient used to partition precipitation into snow and rain 0 39 5 1 betaw coefficient used to calculate transpiration in soil layers 21 70 5 25 soilmaxinfsummer mm d 1 coefficient used to calculate maximum infiltration in summer 25 34 0 50 soilmaxinfsnow mm d 1 coefficient used to calculate maximum infiltration for snow covered areas 34 05 0 50 soilmaxperc mm d 1 maximum percolation rate through a soil layer 2 95 0 5 soilmaxinfwinter mm d 1 coefficient used to calculate maximum infiltration in winter 31 23 0 50 g factor soil heat factor for snow melt calculation 3 40 2 5 flowrouteta flood routing coefficient 1 94 0 10 lagsurfacerunoff surface runoff lag factor 1 04 1 10 laginterflow interflow lag factor 1 21 2 5 gwcaprise capillary rise coefficient 0 30 0 001 1 gwrg1fact faster groundwater outflow coefficient 10 62 5 20 gwrg2fact slower groundwater outflow coefficient 62 88 20 80 gwrg1rg2dist rg1 to rg2 gradient distribution coefficient 0 27 0 0 5 rg1 max mm maximum storage capacity faster groundwater storage component 23 22 1 25 rg2 max mm maximum storage capacity slower groundwater storage component 72 44 20 100 geomaxperc mm d 1 maximum percolation rate to groundwater 0 08 0 1 soildiffmpslps coefficient for the diffusion of lps storage in relation to mps 9 85 0 10 soildistmpslps coefficient for distribution of infiltration to the lps and mps soil storages 7 94 0 10 snow trans oc cofficient for temperature dependent fractions precipitation phases 0 99 0 2 5 r factor rain factor for snow melt calculation 1 35 0 3 soilmaxdps mm maximum depression storage capacity 6 23 0 10 geomaxperc mm d 1 maximum percolation rate to groundwater 0 08 0 1 snowcritdens kg m 3 snowpack density beyond which free water is released 0 35 0 0 5 basetemp oc base melting temperature for snow 2 77 3 3 kf0 cm d 1 hydraulic conductivity of surface soil layers variable 0 01 100 deadcapacity dead capacity of soil layers variable 0 01 0 09 fieldcapacity field capacity of soil layers variable 0 2 0 35 aircapacity air capacity porosity of soil layers variable 0 4 0 5 calibration strategy mean initial and calibrated values vary spatially 
25839,daily real time nowcasts current conditions and 2 day forecasts of environmental conditions in the chesapeake bay have been continuously available for 4 years the forecasts use a 3 d hydrodynamic biogeochemical model with 1 2 km resolution and 3 d output every 6 h that includes salinity water temperature ph aragonite saturation state alkalinity dissolved oxygen and hypoxic volume visualizations of the forecasts are available through a local institutional website www vims edu hypoxia and the maracoos oceans map portal https oceansmap maracoos org chesapeake bay modifications to real time graphics on the local website are routinely made based on stakeholder input and are formatted for use on a mobile device continuous model input files were developed from daily real time forecast input files for hindcast simulations and efficient evaluation and improvement of the real time model this manuscript describes the setup of the environmental forecasting system how the model accuracy has been improved and the revision of online graphics based on stakeholder feedback keywords modeling forecast chesapeake bay hypoxia dead zone acidification 1 introduction and motivation the chesapeake bay bay fig 1 is the largest most productive and most biologically diverse estuary in the continental united states providing crucial habitat and natural resources for native and migratory species boesch et al 2001 kemp et al 2005 natural economic benefits derived from the bay are estimated to be valued at more than 100 billion annually cbf 2014 the bay supports economically important fisheries with blue crabs striped bass and oysters generating the greatest revenue dewar et al 2009 shellfish aquaculture is also growing rapidly hudson and murray 2016 in addition bay waters enhance coastal property values and support a vital tourist economy including nature based recreation industries klemick et al 2018 the many uses of the bay result in diverse groups of stakeholders interested in both protecting and using the bay however temporally and spatially varying environmental conditions can impact how different stakeholders make daily decisions regarding their usage of the bay s resources for example seasonal hypoxia dissolved oxygen do 2 mg l occurs annually between may and october in the deeper channel of the bay hagy et al 2004 officer et al 1984 even in the absence of direct mortality hypoxia reduces the catch per unit effort of bottom feeding fish and constrains the locations of productive fishing grounds buchheister et al 2013 anglers are seeking ways to receive improved information on temperature salinity and do so they can make informed decisions in near real time additionally both native and cultured oysters are vulnerable to negative effects from coastal acidification beck et al 2009 barton et al 2015 a link between episodes of poor water quality and enhanced oyster mortality has been noted in recent years although the problem is not yet well understood wheeler 2011 munroe 2013 hatchery operators have expressed enthusiasm for web based forecasts of key environmental parameters to help guide their daily decision making real time environmental forecasting systems based on numerical hydrodynamic and biogeochemical water quality models have the potential to provide valuable information to both assist stakeholders in planning their daily activities and help decision makers continuously track environmental conditions in real time for example liveocean forecasts environmental conditions throughout puget sound the coastal ocean and willapa bay liveocean 2020 another example is the chesapeake bay operational forecast system cbofs which is run every 6 h by the national oceanic and atmospheric administration noaa and is used primarily for forecasting water levels for navigation but is also used to evaluate the chance of encountering stinging jellyfish noaa 2020a noaa 2020b other examples of real time forecasting are the ocean circulation ecosystem and hypoxia around hong kong waters system hkust 2020 and various systems in the mediterranean sea tintore et al 2019 mfs 2020 forecasts of the mediterranean sea are used by a variety of stakeholders including port managers for evaluating extreme events tourism operators and recreational users to understand conditions on the water and various users for responding to emergencies e g oil spills tintore et al 2019 this paper describes a real time chesapeake bay environmental forecast system cbefs and discusses recent improvements to the forecast system both in model accuracy and graphical visualizations for stakeholders cbefs has provided daily nowcasts current conditions and 2 day forecasts of environmental conditions throughout the bay since february 2017 with model output and online graphics formatted based on stakeholder requests and continually expanded through time cbefs uses a 1 2 km horizontal grid and provides 6 hourly 3 d output the starting cbefs configuration was based on the well established chesapeake bay regional ocean modeling system chesroms estuarine carbon biogeochemistry ecb model feng et al 2015 however cbefs uses different inputs than the published chesroms ecb setups used in other applications e g da et al 2018 therefore it has been independently evaluated to ensure similar model accuracy to other implementations as well as to other well established models of the bay irby et al 2016 that only run hindcasts simulations of past conditions 2 cbefs implementation and configuration 2 1 hydrodynamic and biogeochemical model implementations cbefs is based on a 3 d chesapeake bay implementation of the open source community regional ocean modeling system chesroms xu et al 2012 hydrodynamic model including 20 vertical levels on a horizontal grid with highest resolution 430 m in the northern bay and roughly 1 km resolution in the middle and southern bay fig 2 the main roms input file with the input parameters is provided in the supplementary information cbefs uses the ecb and simplistic respiration rate srm modules to simulate biogeochemistry with do and only do respectively the average do from the ecb and srm modules is used for graphics and hypoxic volume calculations ecb is a full biogeochemical module that contains inorganic and organic carbon and nitrogen state variables including particulate detritus phytoplankton and zooplankton and dissolved forms nitrate ammonium dissolved inorganic carbon and dissolved organic matter feng et al 2015 irby et al 2018 da et al 2018 in addition inorganic suspended solids do and alkalinity are included as state variables the inclusion of inorganic carbon and alkalinity as state variables is critical to successfully simulating the co2 system and associated acidification metrics ph aragonite saturation state ωar ecb has continually been improved as part of ongoing research st laurent et al 2020 moriarty et al 2021 kim et al 2020 turner et al 2021 following relevant modifications to ecb the ecb computer code parameters or nutrient inputs in cbefs are updated to the current research version to incorporate incremental improvements modifications to the complex ecb computer code are incorporated into the forecast system by creating a new executable based on the best available research version and using that executable in cbefs from that day forward depending on the amount of changes to ecb updating the roms hydrodynamic model code may also be incorporated into the new executable the srm module simulates do using a simplistic approach based on scully 2013 as part of a multiple model intercomparison luettich et al 2013 2017 the srm approach has been shown to simulate do and hypoxic volumes with similar accuracy to mechanistic coupled hydrodynamic biogeochemical models bever et al 2013 irby et al 2016 the initial srm approach based on scully 2013 used a temporally and spatially constant respiration rate however the respiration rate prescribed to simulate summer time hypoxia was too high for simulating winter bottom do in the cbefs implementation of the srm module do is consumed using a prescribed spatially uniform but temporally varying respiration rate that repeats each year the prescribed respiration rate is higher in summer than in winter which better captures the seasonal patterns in bottom do do in the model surface layer is set to saturation based on water temperature and salinity the cbefs standalone hydrodynamic and biogeochemical roms modeling system requires nowcast and forecast boundary conditions input files daily table 1 a technique was developed to utilize the hydrodynamic input files already being created by noaa for cbofs to use as boundary conditions for cbefs thus leveraging work already being conducted operationally by noaa cbofs runs every 6 h and simulates hydrodynamic conditions throughout the bay lanerolle et al 2009 2011 noaa 2020a the input files for cbofs are retrieved from noaa 2020c appended together and reformatted using a combination of shell scripts network common data form netcdf operators and matlab scripts these reformatted files provide the inputs for the hydrodynamic component of cbefs meteorology is from the north american mesoscale nam model emc 2020 tributary freshwater inflow and temperature are based on observed u s geological survey usgs gauge data usgs 2020 with the inflow volumes then scaled to better capture the total terrestrial freshwater inflow to the bay described in section 3 1 1 freshwater inflows for the forecast period of each daily simulation are held constant based on the inflows during the nowcast period tides at the open boundary are derived from the advanced circulation model adcirc luettich et al 1992 and non tidal water levels are from the extratropical storm surge model opc 2019 ocean boundary temperature and salinity are from the global operational real time ocean forecast system rtofs nws 2019 the inputs necessary for the cbefs implementation of ecb are the same as those necessary for the research version referenced above however because cbofs includes only hydrodynamic fields biogeochemical inputs for cbefs must be obtained from other sources riverine concentrations of biogeochemical variables excluding dic and alkalinity for the 13 tributaries included in cbefs are specified based on climatological values derived from the dynamic land ecosystem model dlem tian et al 2015 yang et al 2015a 2015b feng et al 2015 dic and alkalinity riverine inputs are based on st laurent et al 2020 and repeat 2014 for each subsequent year at the ocean boundary climatological values based on da et al 2018 and st laurent et al 2020 are used tributary and ocean boundary do concentrations are set to saturation atmospheric nitrogen deposition is based on da et al 2018 and repeats the last available year 2014 for each subsequent year input parameters for the ecb model are the same as described in st laurent 2020 the roms biology in file with parameter values is provided in the supplemental information 2 2 forecast system configuration cbefs runs in a linux environment and uses the cron software utility to automatically run shell scripts at specific times of the day to completely automate the cbefs workflow fig 3 netcdf operators i e netcdf kitchen sink ncks are used to efficiently modify netcdf input and output files the sed command is used to replace dates in a generic roms text input file so the simulation starts on the correct day matlab is used to further preprocess postprocess model input output files and generate portable network graphics png files for online visualization the cbefs workflow uses linux command line function calls whenever possible because they can be completed without having to request high performance computing hpc time through a job scheduler or use a separate dedicated workstation computer i e minimize the use of matlab and thus can be done more efficiently and reliably using local hpc resources cbefs simulates 3 days nightly including a 1 day nowcast and 2 day forecast the nowcast is a simulation extending through midnight using the best available inputs each successive nowcast restarts from the end of the nowcast for the prior day throughout the day the forecast system retrieves necessary information from a noaa ftp page for model inputs using the wget command at night the information is reformatted into cbefs input files the ecb and srm simulations are run through the high performance computing job scheduler additional post processing of model output is conducted checks are conducted to determine whether the forecast was successful with appropriate notification emails sent automatically via the shell scripts and graphics for online visualization are generated fig 3 following completion of the daily forecast ph and ωar are calculated using co2sys lewis and wallace 1998 as implemented in matlab and appended to the ecb netcdf output files using a netcdf operator graphics designed for online visualization are created from the cbefs netcdf output files via linux shell scripts running matlab scripts image files of the graphics are displayed in real time on the internet through a local institutional website vims 2020 and separated into various pages based on the information conveyed the website and graphics are designed for ease of use on a mobile device and are revised as stakeholders provide feedback on what is most useful and easily interpreted section 4 the mid atlantic regional association coastal ocean observing system maracoos downloads the model output daily with visualization of the forecast output available through the chesapeake bay oceans map webpage maracoos 2020a this webpage allows for viewing each of the vertical levels of model output simple real time model data comparison at discrete locations and comparing temperature and salinity from cbefs to cbofs at discrete locations the vims and maracoos websites are complementary and provide different features for use by stakeholders instantaneous netcdf output files for select cbefs variables are provided publicly through a thematic real time environmental distributed data services thredds data server maracoos 2020b 3 improvement of the real time forecast system model accuracy and refinement of model inputs 3 1 model improvements accurate nowcasts current conditions are critical to accurately forecasting environmental conditions in a real time model continuous input files spanning 2014 through 2017 were generated from the daily nowcast input files and were used to evaluate the forecast system and test potential improvements this allowed for efficient continuous hindcasts to be conducted as if the simulation was being run in the forecast system to improve model accuracy two potential improvements were tested 1 scaling river inflow to better represent total terrestrial freshwater inflow to the bay and 2 scaling wind speed to better match observed wind speeds over the bay both scalings were developed to be relatively simple facilitating incorporation into cbefs it is critical that these do not depend on additional real time data or data and model results co occurring in time because data are not available for the future to adjust forecast inputs in sections 3 1 1 and 3 1 2 these two model improvements are individually discussed and in the following sections sections 3 2 and 3 3 the increased accuracy of these improvements is examined 3 1 1 terrestrial freshwater inflows the usgs terrestrial freshwater inflow gauge data used for model inputs do not capture stream inflows to tributaries below the gauges inflows from smaller streams and overland flow to the bay it was hypothesized that better capturing the total amount of terrestrial freshwater inflow to the bay could improve model accuracy to this end daily averaged terrestrial freshwater inputs from cbofs based on usgs gauges were compared to estimates from dlem that include these other sources of freshwater dlem estimated inflows were available for the 8 primary tributaries of the 13 inflows included in the cbofs input files with the remaining 5 tributaries comprising only about 1 of the tributary freshwater flow to the bay for this comparison all dlem surface runoff was added to the estuarine model at the same locations as was the freshwater inputs from the cbofs corresponding tributary a 2 year overlap period of dlem estimates and usgs inputs spanning 2014 and 2015 was available for the comparison this comparison demonstrated that using only the gauge data considerably underestimated the total terrestrial freshwater inflow to the bay a least squares best fit linear relationship between the dlem estimates and the usgs gauge data was developed for eight tributaries with each relationship indicating the inflow from the gauge data could generally be increased to account for both gauged versus ungauged drainage area fig 4 scaling factors were developed by calculating the inverse of the slope of the linear relationship and constant offsets were determined using the intercept of the linear relationship table 2 the scaling factors were smallest for tributaries with gauge stations near the bay with relatively little shoreline distance versus drainage area such as the susquehanna and potomac rivers the scaling factors were largest for tributaries with gauge stations farther from the bay and relatively large shoreline distance versus drainage area such as the choptank and nanticoke rivers the tributary inflows derived from the cbofs inputs were adjusted based on the scaling factors and offsets to generate inputs for cbefs these scaled inflows were used to examine the effect on model accuracy sections 3 2 and 3 3 and then incorporated into the daily cbefs setup 3 1 2 wind speed gridded wind products often underestimate the wind speed over the waters of chesapeake bay which scully 2013 hypothesized was from not adequately representing the wind speed over water of the chesapeake bay relative to the wind speed over land we hypothesized that scaling the wind speed from nam to more closely match observed wind speeds could improve the accuracy of the model to this end wind speed from the nam gridded input was matched to 14 wind data locations around the bay and relationships between the observed wind speed and nam wind speed were developed for the time period from 2014 through 2017 twelve of the relationships indicated the nam wind speed would better match observed winds if their magnitude was increased scaling factor greater than 1 while the other two located near the upstream end of the tidal potomac river and near the c d canal indicated a decrease in wind speed was required scaling factor less than 1 fig 5 it is interesting to note the scaling factors that are less than one are located in areas with relatively little nearby water area suggesting the scaling factors could be at least partially influenced by differences in wind speed over water relative to over land scaling factors from each of the 14 relationships were interpolated spatially to each of the gridded meteorology input cells for model stability constraints spatially interpolated scaling factors were required to be no larger than 1 15 when adjusting the cbefs inputs because the cbefs model setup does not include wetting and drying cbefs input nam wind speeds were multiplied by the spatially varying scaling factors to examine the effect on model accuracy wind direction was unchanged 3 2 hindcast simulations for evaluating model accuracy hindcast simulations spanning 2014 through 2017 were conducted for four scenarios using 1 the initial cbefs setup based solely on the inputs reformatted from cbofs initial cbefs setup 2 scaled inflows only scaled inflows 3 scaled wind speed only scaled winds and 4 scaled inflows combined with scaled winds scaled inflows and winds model outputs from these four scenarios were compared to observed data to evaluate the model accuracy resulting from each set of inputs target diagram statistical analyses were used to assess model accuracy by comparing to observed bottom salinity bottom temperature and bottom do collected by the long term water quality monitoring program wqmp at 13 locations in the mainstem of the bay irby et al 2016 target diagrams were used to visualize model skill graphically and quantitatively using the standard deviation normalized bias bias n and unbiased root mean squared difference ubrmsd n jolliff et al 2009 hofmann et al 2008 the ubrmsd n is the rmsd after the bias between the modeled and observed values has been removed from the modeled values the normalized rmsd rmsd n mathematically represents the magnitude of the vector addition of the bias n and ubrmsd n and is depicted graphically as the distance to the center of the circle target thus model estimates falling closer to the center of the circle are more accurate and any point falling inside the circle of radius one rmsd n 1 performs better than simply estimating the mean of the observations jolliff et al 2009 hofmann et al 2008 model accuracy was evaluated for each of the 4 years individually and for all 4 years combined the bias and rmsd n were used as general metrics to quantitatively evaluate the relative accuracy of the four model scenarios only the near bottom model to data comparison is presented here because bottom temperature and salinity are often more difficult to accurately model than the surface values and stakeholders are most interested in the bottom do only do from the ecb module was used for evaluating the effects of scaling inflows and wind speed on bottom do the respiration rate in the srm module is calibrated based on the hydrodynamics that result from the specified inputs therefore it was not appropriate to hold the srm respiration rate constant and yet vary the hydrodynamic inputs and evaluate model accuracy 3 3 model accuracy and incorporation into cbefs on average the initial cbefs setup was biased slightly high for bottom salinity and bottom do with minimal bias in bottom temperature table 3 figs 6 and 7a rmsd n values for the initial cbefs setup were similar to those provided in irby et al 2016 for nine different models although irby et al 2016 evaluated different years suggesting the initial cbefs setup had similar accuracy to other models of the chesapeake bay although scaling the inflows generally increasing terrestrial freshwater inflow scaled inflows scenario had little effect on modeled bottom water temperature table 3 fig 6a it did reduce the model bias and rmsd n for bottom salinity however the correlation between modeled and observed salinity remained relatively unchanged relative to the initial cbefs setup table 3 figs 6b and 7 in terms of bottom do scaling the inflows resulted in slightly lower concentrations together with a lower bias and rmsd n relative to the initial cbefs setup table 3 fig 6c overall the rmsd n for bottom salinity and bottom do was the lowest in the scaled inflows scenario scaling the wind speed scaled winds scenario also had little effect on modeled bottom water temperature table 3 fig 6a and reduced the model bias and rmsd n for bottom salinity with the correlation between modeled and observed values relatively unchanged relative to the initial cbefs setup table 3 fig 6b however scaling the wind speed resulted in increased bottom do increased bias and increased rmsd n for bottom do relative to the initial cbefs setup table 3 fig 6c the combination of scaling inflows and wind speed scaled inflows and winds scenario resulted in the lowest bias in modeled bottom temperature yet had little effect on the correlation between modeled and observed values and on the rmsd n table 3 fig 6a the combination of scaling inflows and wind speed resulted in reduced bias and rmsd n in both bottom salinity and bottom do relative to the initial cbefs setup table 3 fig 6b and c the accuracy of the model for simulating nowcast conditions was improved through examining effects of scaling river freshwater inflow and wind speed on bottom salinity bottom temperature and bottom do scaling the inflows alone resulted in the most accurate setup for bottom salinity and bottom do based on rmsd n table 3 the decrease in bottom do bias of 0 71 mg l is likely an ecologically significant improvement in the modeled do management goals and scientific studies of the bay are separated by about 1 mg l do based on the ecology of the bay for example anoxia is classified as 0 0 2 mg l 1 mg l is the management threshold for deep channels during summer 2 mg l is commonly used to designate the upper do limit for hypoxic waters 3 mg l is the management threshold for deep water seasonal fish and shellfish use etc usepa 2017 an improvement of model bias of around 1 mg l is then important both ecologically and in terms of bay management goals an improvement in the salinity bias of 1 45 is likely an ecologically important improvement in the salinity because it may either constrain or increase the area of suitable habitat for fishes depending on the fish species and can affect the water chemistry for shellfish an improvement of 0 17 c in the temperature bias is likely not a notable improvement in modeled temperature but does work toward the goal of continual improvement in the forecast system and bay modeling following this analysis the scaling of the inflows was incorporated into the real time cbefs setup to incorporate this improvement into the forecast system after converting the cbofs input for use in cbefs the nowcast and forecast inflows are scaled based on the scaling described in section 3 1 1 cbefs has been running with scaled inflows since march 2019 the comparison of modeled and observed bottom water temperature bottom salinity and bottom do suggests that the cbefs setup both the initial setup and revised setup with scaled inflows has similar accuracy to the range of hindcast models evaluated by irby et al 2016 rmsd n values from the cbefs model data comparison were within the range of or lower than values presented by irby et al 2016 however the evaluation of different years in this study and irby et al 2016 only allows for a general comparison of model accuracy 4 improvement and revision of graphics based on stakeholder feedback in order to be useful for stakeholders the information provided from cbefs needs to be in a concise and easy to interpret format at the time of publication of this manuscript the primary stakeholders of the forecast system were anglers oyster aquaculturists bay management and scientists stakeholders were engaged through in person focus groups and follow up emails and discussions during various stages of development of cbefs facilitated by outreach specialists at the virginia institute of marine science early feedback from these stakeholders indicated they preferred a webpage format that would be easily accessible and viewed on a mobile device to ensure the nowcast and forecast information could be used while at a dock or on a boat the vims 2020 website is formatted in this way both in terms of the page layouts and resolution of the graphics graphics are initially generated from cbefs and discussed with stakeholders who provide feedback for revising graphics the initial focus of the cbefs website was on bottom do fig 8 but feedback from anglers suggested that based on their experience it would be more useful to know the depth below the water surface at which oxygen concentrations exceeds 3 mg l with this information anglers could focus their efforts on waters with do high enough above 3 mg l for striped bass to be present a minimum do of 3 mg l as suggested by the anglers matches well with fisheries independent sampling that shows striped bass catch per unit effort decreases below 3 5 mg l bucheister et al 2013 vertical profile and map graphics were therefore developed to succinctly visualize the depth to 3 mg l throughout the bay fig 9 profiles provide a detailed view in the vertical at discrete locations while the map view allows the anglers to relocate to an area of the bay where fish will more likely be found these graphics are also informative for visualizing mixing due to infrequent large summer storms before the passing of hurricane isais in august 2020 do less than 3 mg l extended to within 15 20 feet 4 6 6 1 m of the water surface over a large portion of the bay fig 9a and b the large amount of mixing resulting from the storm increased do throughout the bay following the passing of the storm do less than 3 mg l extended to within about 30 feet 9 1 m of the water surface and the spatial extent of the occurrence of do less than 3 mg l was reduced fig 9c and d stakeholders from the chesapeake bay management community also expressed interest in expanding do visualizations to include hypoxic volume the volume of bay water with do less than 2 mg l which can be continuously tracked by cbefs in real time throughout the summer estimating and tracking hypoxic volume in real time can improve understanding of the severity of hypoxia throughout the summer because the data used to estimate hypoxic volume is collected at most once every 2 weeks and is typically not publicly released for several months after collection because of required quality control protocols as such it is not possible to estimate the volume of hypoxic conditions in the bay from the observed data until after those conditions have passed an initial webpage and graphics were created to track hypoxic volume throughout the summer and relate the amount of hypoxia to years past fig 10 at the request of stakeholders and managers graphics were then developed and added to the webpage to show model data comparisons in near real time comparing the model estimated and data estimated hypoxic volume throughout the summer fig 11 to develop the data estimated hypoxic volumes for overlay on the model estimated hypoxic volumes the authors are provided preliminary wqmp data shortly after it is collected and estimate a data based hypoxic volume based on an inverse distance weighted interpolation bever et al 2013 focused salinity graphics are being developed as part of examining the effects of ocean acidification on shellfish and aquaculture in the bay initially ph alkalinity and ωar maps were created for possible use by oyster aquaculture to understand if water conditions would be unsuitable for flow through systems however as a result of several recent wet years in the region the stakeholders also expressed interest in salinity as a result surface and bottom salinity maps focused on specific areas of the bay were added to the vims website and preliminary time series salinity figures were developed for potential inclusion on the website 5 potential future additions and improvements to the forecast system notable areas of future expansion and improvements to the forecast system include real time model data comparisons to high frequency continuous monitoring data real time data assimilation increased duration of the forecasts incorporation of fish habitat models and a higher resolution bay wide model grid or high resolution nested grids over regions of interest to stakeholders real time continuous monitoring water level salinity temperature and dissolved oxygen data in the chesapeake bay are available through various agencies these data could be used to evaluate model accuracy in real time or incorporated into the nowcast portion of each daily model run to potentially improve the accuracy of the forecasts for example the ioos regional association for the pacific northwest nanoos has real time model data comparisons to mooring data at many locations and the maracoos chesapeake bay oceansmap webpage allows for a basic model data comparison at select mooring locations the 2 day duration of the forecasts could be lengthened to provide longer environmental forecasts ross et al 2020 however the lengthening of the duration of the forecasts would necessitate retrieving all the necessary model inputs from the original sources and developing methods to convert those data and model products to what is required by cbefs lengthening the forecasts from 2 days to 5 days is planned but has not yet been conducted lengthening the duration of the forecasts would improve the ability of the forecast to be further utilized by stakeholders by providing more time to understand the upcoming water quality conditions and incorporate the information into their decision making output from numerical models is more and more frequently being used in combination with fish habitat analyses and fish habitat models to estimate favorable habitat for fishes e g bever et al 2016 scales et al 2017 crear et al 2020a 2020b fish habitat models could be incorporated into cbefs to continually estimate favorable habitat locations and track estimates of habitat area or volume through time the probability of encountering harmful algal blooms could also be added to cbefs to help park or beach managers and the public understand the likelihood of encountering harmful algal blooms during water based recreation a higher resolution model grid would better represent the bathymetry throughout the bay and tributaries which based on ye et al 2018 may improve the accuracy of the model while the current cbefs grid is sufficient for anglers in the mainstem of the bay aquaculture stakeholders have requested model output more focused on their individual locations a higher resolution model would facilitate forecasts more focused on smaller areas than the bay wide or tributary wide maps currently provided increasing the horizontal resolution of the model grid by about a factor of 3 in both horizontal directions is being done now but has not yet been incorporated into cbefs 6 conclusions a real time environmental forecast system for the waters of chesapeake bay cbefs was setup using a well established open source model and has been simulating environmental conditions daily since 2017 cbefs simulates 1 day of nowcast followed by 2 days of forecast nightly generates graphics displays the graphics online and makes the model output available in real time through a thredds server online graphics have continually been revised and expanded based on feedback from a diverse group of stakeholders cbefs leverages work already being done operationally by noaa for the creation of daily input files for the forecast system this technique of leveraging previous work to efficiently develop a hydrodynamic and biogeochemical forecast modeling system can be done anywhere that already has a hydrodynamic modeling forecast system even if the hydrodynamic models are different further examining the model accuracy demonstrated that scaling the tributary freshwater inflows to better match the total terrestrial freshwater inflow to the bay improved the accuracy of the forecast system scaling the wind speed based on data over the bay water improved the accuracy of bottom salinity but decreased the accuracy of bottom dissolved oxygen based on this analysis the scaling of terrestrial freshwater inflow was incorporated into the forecast system to improve the accuracy future efforts to improve cbefs will focus on increasing the horizontal resolution lengthening the duration of the forecasts and adding real time model to data comparisons onto the website declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors thank david forrest vims raleigh hood umces and vims w m it for help with various aspects of the initial setup thredds data server and general it support david malmquist vims has been instrumental in helping with the vims cbefs website and annual dead zone reports based on cbefs extension specialists susanna musick and karen hudson vims led stakeholder outreach activities for recreational anglers and aquaculturists respectively the authors acknowledge william mary research computing for providing computational resources and or technical support that have contributed to the results reported within this paper https www wm edu it rc this paper is the result of research funded by noaa s ocean acidification program under award na18oar0170430 and noaa s national center for coastal ocean science under award na16nos4780207 both to the virginia institute of marine science the authors also acknowledge funding from the mid atlantic regional association coastal ocean observing system under award na16nos0120020 this is virginia institute of marine science contribution number 4003 appendix a supplementary data the following are the supplementary data to this article multimedia component 1 multimedia component 1 multimedia component 2 multimedia component 2 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2021 105036 software and data availability documentation and source code for the numerical model used in the forecast system roms are publicly available at www myroms org the cruise based data used in this manuscript are publicly available through the chesapeake bay program online data server at http data chesapeakebay net waterquality model output from the forecast system for select variables is publicly available through maracoos at http data oceansmap com eds thredds catalog eds vims roms catalog html because of continual improvements to the forecast system the model output on the thredds server may not be the product of a single consistent setup 
25839,daily real time nowcasts current conditions and 2 day forecasts of environmental conditions in the chesapeake bay have been continuously available for 4 years the forecasts use a 3 d hydrodynamic biogeochemical model with 1 2 km resolution and 3 d output every 6 h that includes salinity water temperature ph aragonite saturation state alkalinity dissolved oxygen and hypoxic volume visualizations of the forecasts are available through a local institutional website www vims edu hypoxia and the maracoos oceans map portal https oceansmap maracoos org chesapeake bay modifications to real time graphics on the local website are routinely made based on stakeholder input and are formatted for use on a mobile device continuous model input files were developed from daily real time forecast input files for hindcast simulations and efficient evaluation and improvement of the real time model this manuscript describes the setup of the environmental forecasting system how the model accuracy has been improved and the revision of online graphics based on stakeholder feedback keywords modeling forecast chesapeake bay hypoxia dead zone acidification 1 introduction and motivation the chesapeake bay bay fig 1 is the largest most productive and most biologically diverse estuary in the continental united states providing crucial habitat and natural resources for native and migratory species boesch et al 2001 kemp et al 2005 natural economic benefits derived from the bay are estimated to be valued at more than 100 billion annually cbf 2014 the bay supports economically important fisheries with blue crabs striped bass and oysters generating the greatest revenue dewar et al 2009 shellfish aquaculture is also growing rapidly hudson and murray 2016 in addition bay waters enhance coastal property values and support a vital tourist economy including nature based recreation industries klemick et al 2018 the many uses of the bay result in diverse groups of stakeholders interested in both protecting and using the bay however temporally and spatially varying environmental conditions can impact how different stakeholders make daily decisions regarding their usage of the bay s resources for example seasonal hypoxia dissolved oxygen do 2 mg l occurs annually between may and october in the deeper channel of the bay hagy et al 2004 officer et al 1984 even in the absence of direct mortality hypoxia reduces the catch per unit effort of bottom feeding fish and constrains the locations of productive fishing grounds buchheister et al 2013 anglers are seeking ways to receive improved information on temperature salinity and do so they can make informed decisions in near real time additionally both native and cultured oysters are vulnerable to negative effects from coastal acidification beck et al 2009 barton et al 2015 a link between episodes of poor water quality and enhanced oyster mortality has been noted in recent years although the problem is not yet well understood wheeler 2011 munroe 2013 hatchery operators have expressed enthusiasm for web based forecasts of key environmental parameters to help guide their daily decision making real time environmental forecasting systems based on numerical hydrodynamic and biogeochemical water quality models have the potential to provide valuable information to both assist stakeholders in planning their daily activities and help decision makers continuously track environmental conditions in real time for example liveocean forecasts environmental conditions throughout puget sound the coastal ocean and willapa bay liveocean 2020 another example is the chesapeake bay operational forecast system cbofs which is run every 6 h by the national oceanic and atmospheric administration noaa and is used primarily for forecasting water levels for navigation but is also used to evaluate the chance of encountering stinging jellyfish noaa 2020a noaa 2020b other examples of real time forecasting are the ocean circulation ecosystem and hypoxia around hong kong waters system hkust 2020 and various systems in the mediterranean sea tintore et al 2019 mfs 2020 forecasts of the mediterranean sea are used by a variety of stakeholders including port managers for evaluating extreme events tourism operators and recreational users to understand conditions on the water and various users for responding to emergencies e g oil spills tintore et al 2019 this paper describes a real time chesapeake bay environmental forecast system cbefs and discusses recent improvements to the forecast system both in model accuracy and graphical visualizations for stakeholders cbefs has provided daily nowcasts current conditions and 2 day forecasts of environmental conditions throughout the bay since february 2017 with model output and online graphics formatted based on stakeholder requests and continually expanded through time cbefs uses a 1 2 km horizontal grid and provides 6 hourly 3 d output the starting cbefs configuration was based on the well established chesapeake bay regional ocean modeling system chesroms estuarine carbon biogeochemistry ecb model feng et al 2015 however cbefs uses different inputs than the published chesroms ecb setups used in other applications e g da et al 2018 therefore it has been independently evaluated to ensure similar model accuracy to other implementations as well as to other well established models of the bay irby et al 2016 that only run hindcasts simulations of past conditions 2 cbefs implementation and configuration 2 1 hydrodynamic and biogeochemical model implementations cbefs is based on a 3 d chesapeake bay implementation of the open source community regional ocean modeling system chesroms xu et al 2012 hydrodynamic model including 20 vertical levels on a horizontal grid with highest resolution 430 m in the northern bay and roughly 1 km resolution in the middle and southern bay fig 2 the main roms input file with the input parameters is provided in the supplementary information cbefs uses the ecb and simplistic respiration rate srm modules to simulate biogeochemistry with do and only do respectively the average do from the ecb and srm modules is used for graphics and hypoxic volume calculations ecb is a full biogeochemical module that contains inorganic and organic carbon and nitrogen state variables including particulate detritus phytoplankton and zooplankton and dissolved forms nitrate ammonium dissolved inorganic carbon and dissolved organic matter feng et al 2015 irby et al 2018 da et al 2018 in addition inorganic suspended solids do and alkalinity are included as state variables the inclusion of inorganic carbon and alkalinity as state variables is critical to successfully simulating the co2 system and associated acidification metrics ph aragonite saturation state ωar ecb has continually been improved as part of ongoing research st laurent et al 2020 moriarty et al 2021 kim et al 2020 turner et al 2021 following relevant modifications to ecb the ecb computer code parameters or nutrient inputs in cbefs are updated to the current research version to incorporate incremental improvements modifications to the complex ecb computer code are incorporated into the forecast system by creating a new executable based on the best available research version and using that executable in cbefs from that day forward depending on the amount of changes to ecb updating the roms hydrodynamic model code may also be incorporated into the new executable the srm module simulates do using a simplistic approach based on scully 2013 as part of a multiple model intercomparison luettich et al 2013 2017 the srm approach has been shown to simulate do and hypoxic volumes with similar accuracy to mechanistic coupled hydrodynamic biogeochemical models bever et al 2013 irby et al 2016 the initial srm approach based on scully 2013 used a temporally and spatially constant respiration rate however the respiration rate prescribed to simulate summer time hypoxia was too high for simulating winter bottom do in the cbefs implementation of the srm module do is consumed using a prescribed spatially uniform but temporally varying respiration rate that repeats each year the prescribed respiration rate is higher in summer than in winter which better captures the seasonal patterns in bottom do do in the model surface layer is set to saturation based on water temperature and salinity the cbefs standalone hydrodynamic and biogeochemical roms modeling system requires nowcast and forecast boundary conditions input files daily table 1 a technique was developed to utilize the hydrodynamic input files already being created by noaa for cbofs to use as boundary conditions for cbefs thus leveraging work already being conducted operationally by noaa cbofs runs every 6 h and simulates hydrodynamic conditions throughout the bay lanerolle et al 2009 2011 noaa 2020a the input files for cbofs are retrieved from noaa 2020c appended together and reformatted using a combination of shell scripts network common data form netcdf operators and matlab scripts these reformatted files provide the inputs for the hydrodynamic component of cbefs meteorology is from the north american mesoscale nam model emc 2020 tributary freshwater inflow and temperature are based on observed u s geological survey usgs gauge data usgs 2020 with the inflow volumes then scaled to better capture the total terrestrial freshwater inflow to the bay described in section 3 1 1 freshwater inflows for the forecast period of each daily simulation are held constant based on the inflows during the nowcast period tides at the open boundary are derived from the advanced circulation model adcirc luettich et al 1992 and non tidal water levels are from the extratropical storm surge model opc 2019 ocean boundary temperature and salinity are from the global operational real time ocean forecast system rtofs nws 2019 the inputs necessary for the cbefs implementation of ecb are the same as those necessary for the research version referenced above however because cbofs includes only hydrodynamic fields biogeochemical inputs for cbefs must be obtained from other sources riverine concentrations of biogeochemical variables excluding dic and alkalinity for the 13 tributaries included in cbefs are specified based on climatological values derived from the dynamic land ecosystem model dlem tian et al 2015 yang et al 2015a 2015b feng et al 2015 dic and alkalinity riverine inputs are based on st laurent et al 2020 and repeat 2014 for each subsequent year at the ocean boundary climatological values based on da et al 2018 and st laurent et al 2020 are used tributary and ocean boundary do concentrations are set to saturation atmospheric nitrogen deposition is based on da et al 2018 and repeats the last available year 2014 for each subsequent year input parameters for the ecb model are the same as described in st laurent 2020 the roms biology in file with parameter values is provided in the supplemental information 2 2 forecast system configuration cbefs runs in a linux environment and uses the cron software utility to automatically run shell scripts at specific times of the day to completely automate the cbefs workflow fig 3 netcdf operators i e netcdf kitchen sink ncks are used to efficiently modify netcdf input and output files the sed command is used to replace dates in a generic roms text input file so the simulation starts on the correct day matlab is used to further preprocess postprocess model input output files and generate portable network graphics png files for online visualization the cbefs workflow uses linux command line function calls whenever possible because they can be completed without having to request high performance computing hpc time through a job scheduler or use a separate dedicated workstation computer i e minimize the use of matlab and thus can be done more efficiently and reliably using local hpc resources cbefs simulates 3 days nightly including a 1 day nowcast and 2 day forecast the nowcast is a simulation extending through midnight using the best available inputs each successive nowcast restarts from the end of the nowcast for the prior day throughout the day the forecast system retrieves necessary information from a noaa ftp page for model inputs using the wget command at night the information is reformatted into cbefs input files the ecb and srm simulations are run through the high performance computing job scheduler additional post processing of model output is conducted checks are conducted to determine whether the forecast was successful with appropriate notification emails sent automatically via the shell scripts and graphics for online visualization are generated fig 3 following completion of the daily forecast ph and ωar are calculated using co2sys lewis and wallace 1998 as implemented in matlab and appended to the ecb netcdf output files using a netcdf operator graphics designed for online visualization are created from the cbefs netcdf output files via linux shell scripts running matlab scripts image files of the graphics are displayed in real time on the internet through a local institutional website vims 2020 and separated into various pages based on the information conveyed the website and graphics are designed for ease of use on a mobile device and are revised as stakeholders provide feedback on what is most useful and easily interpreted section 4 the mid atlantic regional association coastal ocean observing system maracoos downloads the model output daily with visualization of the forecast output available through the chesapeake bay oceans map webpage maracoos 2020a this webpage allows for viewing each of the vertical levels of model output simple real time model data comparison at discrete locations and comparing temperature and salinity from cbefs to cbofs at discrete locations the vims and maracoos websites are complementary and provide different features for use by stakeholders instantaneous netcdf output files for select cbefs variables are provided publicly through a thematic real time environmental distributed data services thredds data server maracoos 2020b 3 improvement of the real time forecast system model accuracy and refinement of model inputs 3 1 model improvements accurate nowcasts current conditions are critical to accurately forecasting environmental conditions in a real time model continuous input files spanning 2014 through 2017 were generated from the daily nowcast input files and were used to evaluate the forecast system and test potential improvements this allowed for efficient continuous hindcasts to be conducted as if the simulation was being run in the forecast system to improve model accuracy two potential improvements were tested 1 scaling river inflow to better represent total terrestrial freshwater inflow to the bay and 2 scaling wind speed to better match observed wind speeds over the bay both scalings were developed to be relatively simple facilitating incorporation into cbefs it is critical that these do not depend on additional real time data or data and model results co occurring in time because data are not available for the future to adjust forecast inputs in sections 3 1 1 and 3 1 2 these two model improvements are individually discussed and in the following sections sections 3 2 and 3 3 the increased accuracy of these improvements is examined 3 1 1 terrestrial freshwater inflows the usgs terrestrial freshwater inflow gauge data used for model inputs do not capture stream inflows to tributaries below the gauges inflows from smaller streams and overland flow to the bay it was hypothesized that better capturing the total amount of terrestrial freshwater inflow to the bay could improve model accuracy to this end daily averaged terrestrial freshwater inputs from cbofs based on usgs gauges were compared to estimates from dlem that include these other sources of freshwater dlem estimated inflows were available for the 8 primary tributaries of the 13 inflows included in the cbofs input files with the remaining 5 tributaries comprising only about 1 of the tributary freshwater flow to the bay for this comparison all dlem surface runoff was added to the estuarine model at the same locations as was the freshwater inputs from the cbofs corresponding tributary a 2 year overlap period of dlem estimates and usgs inputs spanning 2014 and 2015 was available for the comparison this comparison demonstrated that using only the gauge data considerably underestimated the total terrestrial freshwater inflow to the bay a least squares best fit linear relationship between the dlem estimates and the usgs gauge data was developed for eight tributaries with each relationship indicating the inflow from the gauge data could generally be increased to account for both gauged versus ungauged drainage area fig 4 scaling factors were developed by calculating the inverse of the slope of the linear relationship and constant offsets were determined using the intercept of the linear relationship table 2 the scaling factors were smallest for tributaries with gauge stations near the bay with relatively little shoreline distance versus drainage area such as the susquehanna and potomac rivers the scaling factors were largest for tributaries with gauge stations farther from the bay and relatively large shoreline distance versus drainage area such as the choptank and nanticoke rivers the tributary inflows derived from the cbofs inputs were adjusted based on the scaling factors and offsets to generate inputs for cbefs these scaled inflows were used to examine the effect on model accuracy sections 3 2 and 3 3 and then incorporated into the daily cbefs setup 3 1 2 wind speed gridded wind products often underestimate the wind speed over the waters of chesapeake bay which scully 2013 hypothesized was from not adequately representing the wind speed over water of the chesapeake bay relative to the wind speed over land we hypothesized that scaling the wind speed from nam to more closely match observed wind speeds could improve the accuracy of the model to this end wind speed from the nam gridded input was matched to 14 wind data locations around the bay and relationships between the observed wind speed and nam wind speed were developed for the time period from 2014 through 2017 twelve of the relationships indicated the nam wind speed would better match observed winds if their magnitude was increased scaling factor greater than 1 while the other two located near the upstream end of the tidal potomac river and near the c d canal indicated a decrease in wind speed was required scaling factor less than 1 fig 5 it is interesting to note the scaling factors that are less than one are located in areas with relatively little nearby water area suggesting the scaling factors could be at least partially influenced by differences in wind speed over water relative to over land scaling factors from each of the 14 relationships were interpolated spatially to each of the gridded meteorology input cells for model stability constraints spatially interpolated scaling factors were required to be no larger than 1 15 when adjusting the cbefs inputs because the cbefs model setup does not include wetting and drying cbefs input nam wind speeds were multiplied by the spatially varying scaling factors to examine the effect on model accuracy wind direction was unchanged 3 2 hindcast simulations for evaluating model accuracy hindcast simulations spanning 2014 through 2017 were conducted for four scenarios using 1 the initial cbefs setup based solely on the inputs reformatted from cbofs initial cbefs setup 2 scaled inflows only scaled inflows 3 scaled wind speed only scaled winds and 4 scaled inflows combined with scaled winds scaled inflows and winds model outputs from these four scenarios were compared to observed data to evaluate the model accuracy resulting from each set of inputs target diagram statistical analyses were used to assess model accuracy by comparing to observed bottom salinity bottom temperature and bottom do collected by the long term water quality monitoring program wqmp at 13 locations in the mainstem of the bay irby et al 2016 target diagrams were used to visualize model skill graphically and quantitatively using the standard deviation normalized bias bias n and unbiased root mean squared difference ubrmsd n jolliff et al 2009 hofmann et al 2008 the ubrmsd n is the rmsd after the bias between the modeled and observed values has been removed from the modeled values the normalized rmsd rmsd n mathematically represents the magnitude of the vector addition of the bias n and ubrmsd n and is depicted graphically as the distance to the center of the circle target thus model estimates falling closer to the center of the circle are more accurate and any point falling inside the circle of radius one rmsd n 1 performs better than simply estimating the mean of the observations jolliff et al 2009 hofmann et al 2008 model accuracy was evaluated for each of the 4 years individually and for all 4 years combined the bias and rmsd n were used as general metrics to quantitatively evaluate the relative accuracy of the four model scenarios only the near bottom model to data comparison is presented here because bottom temperature and salinity are often more difficult to accurately model than the surface values and stakeholders are most interested in the bottom do only do from the ecb module was used for evaluating the effects of scaling inflows and wind speed on bottom do the respiration rate in the srm module is calibrated based on the hydrodynamics that result from the specified inputs therefore it was not appropriate to hold the srm respiration rate constant and yet vary the hydrodynamic inputs and evaluate model accuracy 3 3 model accuracy and incorporation into cbefs on average the initial cbefs setup was biased slightly high for bottom salinity and bottom do with minimal bias in bottom temperature table 3 figs 6 and 7a rmsd n values for the initial cbefs setup were similar to those provided in irby et al 2016 for nine different models although irby et al 2016 evaluated different years suggesting the initial cbefs setup had similar accuracy to other models of the chesapeake bay although scaling the inflows generally increasing terrestrial freshwater inflow scaled inflows scenario had little effect on modeled bottom water temperature table 3 fig 6a it did reduce the model bias and rmsd n for bottom salinity however the correlation between modeled and observed salinity remained relatively unchanged relative to the initial cbefs setup table 3 figs 6b and 7 in terms of bottom do scaling the inflows resulted in slightly lower concentrations together with a lower bias and rmsd n relative to the initial cbefs setup table 3 fig 6c overall the rmsd n for bottom salinity and bottom do was the lowest in the scaled inflows scenario scaling the wind speed scaled winds scenario also had little effect on modeled bottom water temperature table 3 fig 6a and reduced the model bias and rmsd n for bottom salinity with the correlation between modeled and observed values relatively unchanged relative to the initial cbefs setup table 3 fig 6b however scaling the wind speed resulted in increased bottom do increased bias and increased rmsd n for bottom do relative to the initial cbefs setup table 3 fig 6c the combination of scaling inflows and wind speed scaled inflows and winds scenario resulted in the lowest bias in modeled bottom temperature yet had little effect on the correlation between modeled and observed values and on the rmsd n table 3 fig 6a the combination of scaling inflows and wind speed resulted in reduced bias and rmsd n in both bottom salinity and bottom do relative to the initial cbefs setup table 3 fig 6b and c the accuracy of the model for simulating nowcast conditions was improved through examining effects of scaling river freshwater inflow and wind speed on bottom salinity bottom temperature and bottom do scaling the inflows alone resulted in the most accurate setup for bottom salinity and bottom do based on rmsd n table 3 the decrease in bottom do bias of 0 71 mg l is likely an ecologically significant improvement in the modeled do management goals and scientific studies of the bay are separated by about 1 mg l do based on the ecology of the bay for example anoxia is classified as 0 0 2 mg l 1 mg l is the management threshold for deep channels during summer 2 mg l is commonly used to designate the upper do limit for hypoxic waters 3 mg l is the management threshold for deep water seasonal fish and shellfish use etc usepa 2017 an improvement of model bias of around 1 mg l is then important both ecologically and in terms of bay management goals an improvement in the salinity bias of 1 45 is likely an ecologically important improvement in the salinity because it may either constrain or increase the area of suitable habitat for fishes depending on the fish species and can affect the water chemistry for shellfish an improvement of 0 17 c in the temperature bias is likely not a notable improvement in modeled temperature but does work toward the goal of continual improvement in the forecast system and bay modeling following this analysis the scaling of the inflows was incorporated into the real time cbefs setup to incorporate this improvement into the forecast system after converting the cbofs input for use in cbefs the nowcast and forecast inflows are scaled based on the scaling described in section 3 1 1 cbefs has been running with scaled inflows since march 2019 the comparison of modeled and observed bottom water temperature bottom salinity and bottom do suggests that the cbefs setup both the initial setup and revised setup with scaled inflows has similar accuracy to the range of hindcast models evaluated by irby et al 2016 rmsd n values from the cbefs model data comparison were within the range of or lower than values presented by irby et al 2016 however the evaluation of different years in this study and irby et al 2016 only allows for a general comparison of model accuracy 4 improvement and revision of graphics based on stakeholder feedback in order to be useful for stakeholders the information provided from cbefs needs to be in a concise and easy to interpret format at the time of publication of this manuscript the primary stakeholders of the forecast system were anglers oyster aquaculturists bay management and scientists stakeholders were engaged through in person focus groups and follow up emails and discussions during various stages of development of cbefs facilitated by outreach specialists at the virginia institute of marine science early feedback from these stakeholders indicated they preferred a webpage format that would be easily accessible and viewed on a mobile device to ensure the nowcast and forecast information could be used while at a dock or on a boat the vims 2020 website is formatted in this way both in terms of the page layouts and resolution of the graphics graphics are initially generated from cbefs and discussed with stakeholders who provide feedback for revising graphics the initial focus of the cbefs website was on bottom do fig 8 but feedback from anglers suggested that based on their experience it would be more useful to know the depth below the water surface at which oxygen concentrations exceeds 3 mg l with this information anglers could focus their efforts on waters with do high enough above 3 mg l for striped bass to be present a minimum do of 3 mg l as suggested by the anglers matches well with fisheries independent sampling that shows striped bass catch per unit effort decreases below 3 5 mg l bucheister et al 2013 vertical profile and map graphics were therefore developed to succinctly visualize the depth to 3 mg l throughout the bay fig 9 profiles provide a detailed view in the vertical at discrete locations while the map view allows the anglers to relocate to an area of the bay where fish will more likely be found these graphics are also informative for visualizing mixing due to infrequent large summer storms before the passing of hurricane isais in august 2020 do less than 3 mg l extended to within 15 20 feet 4 6 6 1 m of the water surface over a large portion of the bay fig 9a and b the large amount of mixing resulting from the storm increased do throughout the bay following the passing of the storm do less than 3 mg l extended to within about 30 feet 9 1 m of the water surface and the spatial extent of the occurrence of do less than 3 mg l was reduced fig 9c and d stakeholders from the chesapeake bay management community also expressed interest in expanding do visualizations to include hypoxic volume the volume of bay water with do less than 2 mg l which can be continuously tracked by cbefs in real time throughout the summer estimating and tracking hypoxic volume in real time can improve understanding of the severity of hypoxia throughout the summer because the data used to estimate hypoxic volume is collected at most once every 2 weeks and is typically not publicly released for several months after collection because of required quality control protocols as such it is not possible to estimate the volume of hypoxic conditions in the bay from the observed data until after those conditions have passed an initial webpage and graphics were created to track hypoxic volume throughout the summer and relate the amount of hypoxia to years past fig 10 at the request of stakeholders and managers graphics were then developed and added to the webpage to show model data comparisons in near real time comparing the model estimated and data estimated hypoxic volume throughout the summer fig 11 to develop the data estimated hypoxic volumes for overlay on the model estimated hypoxic volumes the authors are provided preliminary wqmp data shortly after it is collected and estimate a data based hypoxic volume based on an inverse distance weighted interpolation bever et al 2013 focused salinity graphics are being developed as part of examining the effects of ocean acidification on shellfish and aquaculture in the bay initially ph alkalinity and ωar maps were created for possible use by oyster aquaculture to understand if water conditions would be unsuitable for flow through systems however as a result of several recent wet years in the region the stakeholders also expressed interest in salinity as a result surface and bottom salinity maps focused on specific areas of the bay were added to the vims website and preliminary time series salinity figures were developed for potential inclusion on the website 5 potential future additions and improvements to the forecast system notable areas of future expansion and improvements to the forecast system include real time model data comparisons to high frequency continuous monitoring data real time data assimilation increased duration of the forecasts incorporation of fish habitat models and a higher resolution bay wide model grid or high resolution nested grids over regions of interest to stakeholders real time continuous monitoring water level salinity temperature and dissolved oxygen data in the chesapeake bay are available through various agencies these data could be used to evaluate model accuracy in real time or incorporated into the nowcast portion of each daily model run to potentially improve the accuracy of the forecasts for example the ioos regional association for the pacific northwest nanoos has real time model data comparisons to mooring data at many locations and the maracoos chesapeake bay oceansmap webpage allows for a basic model data comparison at select mooring locations the 2 day duration of the forecasts could be lengthened to provide longer environmental forecasts ross et al 2020 however the lengthening of the duration of the forecasts would necessitate retrieving all the necessary model inputs from the original sources and developing methods to convert those data and model products to what is required by cbefs lengthening the forecasts from 2 days to 5 days is planned but has not yet been conducted lengthening the duration of the forecasts would improve the ability of the forecast to be further utilized by stakeholders by providing more time to understand the upcoming water quality conditions and incorporate the information into their decision making output from numerical models is more and more frequently being used in combination with fish habitat analyses and fish habitat models to estimate favorable habitat for fishes e g bever et al 2016 scales et al 2017 crear et al 2020a 2020b fish habitat models could be incorporated into cbefs to continually estimate favorable habitat locations and track estimates of habitat area or volume through time the probability of encountering harmful algal blooms could also be added to cbefs to help park or beach managers and the public understand the likelihood of encountering harmful algal blooms during water based recreation a higher resolution model grid would better represent the bathymetry throughout the bay and tributaries which based on ye et al 2018 may improve the accuracy of the model while the current cbefs grid is sufficient for anglers in the mainstem of the bay aquaculture stakeholders have requested model output more focused on their individual locations a higher resolution model would facilitate forecasts more focused on smaller areas than the bay wide or tributary wide maps currently provided increasing the horizontal resolution of the model grid by about a factor of 3 in both horizontal directions is being done now but has not yet been incorporated into cbefs 6 conclusions a real time environmental forecast system for the waters of chesapeake bay cbefs was setup using a well established open source model and has been simulating environmental conditions daily since 2017 cbefs simulates 1 day of nowcast followed by 2 days of forecast nightly generates graphics displays the graphics online and makes the model output available in real time through a thredds server online graphics have continually been revised and expanded based on feedback from a diverse group of stakeholders cbefs leverages work already being done operationally by noaa for the creation of daily input files for the forecast system this technique of leveraging previous work to efficiently develop a hydrodynamic and biogeochemical forecast modeling system can be done anywhere that already has a hydrodynamic modeling forecast system even if the hydrodynamic models are different further examining the model accuracy demonstrated that scaling the tributary freshwater inflows to better match the total terrestrial freshwater inflow to the bay improved the accuracy of the forecast system scaling the wind speed based on data over the bay water improved the accuracy of bottom salinity but decreased the accuracy of bottom dissolved oxygen based on this analysis the scaling of terrestrial freshwater inflow was incorporated into the forecast system to improve the accuracy future efforts to improve cbefs will focus on increasing the horizontal resolution lengthening the duration of the forecasts and adding real time model to data comparisons onto the website declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors thank david forrest vims raleigh hood umces and vims w m it for help with various aspects of the initial setup thredds data server and general it support david malmquist vims has been instrumental in helping with the vims cbefs website and annual dead zone reports based on cbefs extension specialists susanna musick and karen hudson vims led stakeholder outreach activities for recreational anglers and aquaculturists respectively the authors acknowledge william mary research computing for providing computational resources and or technical support that have contributed to the results reported within this paper https www wm edu it rc this paper is the result of research funded by noaa s ocean acidification program under award na18oar0170430 and noaa s national center for coastal ocean science under award na16nos4780207 both to the virginia institute of marine science the authors also acknowledge funding from the mid atlantic regional association coastal ocean observing system under award na16nos0120020 this is virginia institute of marine science contribution number 4003 appendix a supplementary data the following are the supplementary data to this article multimedia component 1 multimedia component 1 multimedia component 2 multimedia component 2 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2021 105036 software and data availability documentation and source code for the numerical model used in the forecast system roms are publicly available at www myroms org the cruise based data used in this manuscript are publicly available through the chesapeake bay program online data server at http data chesapeakebay net waterquality model output from the forecast system for select variables is publicly available through maracoos at http data oceansmap com eds thredds catalog eds vims roms catalog html because of continual improvements to the forecast system the model output on the thredds server may not be the product of a single consistent setup 
