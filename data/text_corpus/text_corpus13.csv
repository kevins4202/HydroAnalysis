index,text
65,the design of urban drainage systems often relies on the coupling of optimization algorithms and process based models with the latter informed by design storms however such practice may not yield systems that are robust with respect to a broad array of rainfall conditions to tackle this problem we contribute a novel computational framework characterized by two distinguishing features first we use multiple rainfall events throughout the design process and second we rely on faster emulators instead of process based models to manage the inevitable increase in the computational requirements in particular our framework moves through five steps accounting for the generation of stochastic rainfall events the selection of decision variables via sensitivity analysis emulator identification emulation based optimization and ex post robustness analysis to test our framework we implement it on a 33 km 2 basin in ho chi minh city vietnam and benchmark it against a more traditional approach based on design storms results show that there are untapped opportunities for improving drainage performance without altering investment costs for example we found that a budget of 30 million can yield an overflow reduction of about 85 or 50 depending on whether we rely on stochastic rainfall events or design storms importantly such improvements do not affect the computational requirements owing to the use of emulators the framework is applicable to other basins and could be readily extended to other sources of uncertainty such as land use change or climate change scenarios which are expected to pose additional strains on urban drainage systems keywords stormwater management green infrastructure optimization robustness machine learning data availability data will be made available on request 1 introduction urban floods are complex phenomena whose likelihood and impact are largely driven by rapid urbanization and hydro climatic variability hettiarachchi et al 2018 berndtsson et al 2019 o donnell and thorne 2020 urban sprawls not only concentrate economic activities and assets within flood prone areas but also decrease permeability and lead to loss of floodable urban spaces in turn increasing the likelihood of flood events fletcher et al 2013 berndtsson et al 2019 moreover climate change is altering rainfall characteristics ultimately intensifying extreme rainfall events and increasing flood volumes hosseinzadehtalaei et al 2021 the strain of limiting the detrimental impact of these factors largely falls on urban drainage systems increasingly seen as the combination of traditional physical assets e g pipes storage tanks with green infrastructures that control runoff at its source schmitter et al 2016 kapetas and fenner 2020 joshi et al 2021 as all these infrastructures are deployed or upgraded to be operational for decades careful design is necessary to avoid misallocating investment budgets that may lead to unsatisfactory drainage performance bach et al 2014 in particular it is key to conceive drainage systems whose performance is robust that is they maintain the same level of performance with respect to a broad range of rainfall events as well as other sources of uncertainty deletic et al 2012 sörensen et al 2016 berndtsson et al 2019 ng et al 2020 since the advent of metaheuristic optimization techniques the design of urban drainage systems has typically relied on the coupling between optimization algorithms and process based models wang et al 2018 2019 such as epa s storm water management model swmm rossman 2015 the key advantage of the simulation optimization approach is that it allows accounting for complex storm hyetographs as well as the physical response of the drainage system simulation optimization is therefore regularly used for a variety of tasks from the placement of green infrastructure at the catchment scale damodaram and zechman 2013 giacomoni and joseph 2017 to the optimization of pipes and storage capacities maharjan et al 2009 ogidan and giacomoni 2017 a commonality of these studies is their reliance on one or a few design storms a practice arguably inherited from historical developments in the field of urban drainage burian et al 1999 butler and davies 2000 however recent research efforts suggest that relying on a single critical rainfall event with a specific return period may fail to produce robust decisions for instance ng et al 2020 found that drainage systems designed with respect to a design storm failed to maintain the same level of performance when rainfall intensity duration and temporal distribution deviated from the design storm temporal patterns of rainfall events were also demonstrated to be as important as rainfall volume in influencing flood response hettiarachchi et al 2018 cheng et al 2020 this issue has prompted a rising number of studies in which multiple rainfall scenarios are explicitly considered in the design process yazdi and neyshabouri 2014 yu et al 2017 casal campos et al 2018 ngo et al 2019 notwithstanding these recent progresses more methodological advancements are needed to close the chasm between the need for robust drainage systems and the mathematical modeling tools available to design them a first challenge lies in computational requirements explicitly accounting for multiple rainfall events largely increases the number of simulation runs required during the optimization process thereby demanding massive upgrades to computational budgets a technical pathway is represented by emulation or surrogate modeling an umbrella term for a wide range of methods that develop computationally efficient alternatives to higher fidelity simulation models castelletti et al 2012 razavi et al 2012 widely adopted by the water resources community for an extensive survey see garzón et al 2022 emulators are gaining traction in the field of urban drainage where they have been used to solve computationally demanding tasks such as bayesian calibration or sensitivity and simulation analysis carbajal et al 2017 bermúdez et al 2018 moreno rodenas et al 2018 nagel et al 2020 yet their suitability for robust optimization problems remains largely unexplored yazdi and neyshabouri 2014 second the problem of designing a drainage system often requires us to first determine which infrastructural components should be optimized a task constrained by multiple factors such as budget availability site specific considerations or computational complexity choosing the best possible decision variables may be critical for issues of robustness and yet we are currently lacking automated procedures that can support this choice while dealing with multiple rainfall events finally both aforementioned challenges are exacerbated by the size of the study site at hand designing robust drainage systems over basins larger than a few square kilometers remains an open problem here we contribute a novel computational framework conceived to design drainage systems that are robust with respect to a broad array of rainfall conditions the framework consists of five building blocks stochastic rainfall generation sensitivity analysis to select the decision variables emulator identification emulation based optimization and ex post robustness analysis carried out on an independent test set of rainfall events the framework stems from two modeling considerations first it is best to use multiple rainfall events throughout the design process from the identification of the decision variables to their optimization so as to endow each decision with the information contained in these events second we can battle the inevitable increase in computational requirements through the use of emulators to test our framework we apply it to the nhieu loc thi nghe basin an area of 33 km 2 located in ho chi minh city vietnam and benchmark it against a more traditional simulation optimization approach informed by a single design storm through this analysis we show the benefits of using multiple rainfall events determine the conditions that are most challenging for systems based on design storms and identify opportunities for further improving the performance of our approach 2 case study 2 1 study site the nhieu loc thi nghe nl tn basin is located in the central area of ho chi minh city vietnam fig 1 the basin spans across an area of 33 km2 with land use dominated by residential developments 49 3 of the total area and commercial public and industrial uses domestic wastewater and stormwater are conveyed by the combined sewer system into the nl tn canal and eventually discharged into the saigon river heavily polluted in the 1960s the nl tn canal has since been cleaned up as authorities relocated informal settlements and improved the drainage system even so flood events remain common especially because of intensified rainfall events le et al 2021 as we shall see in section 3 our objective is to reduce the current impact of floods by upgrading a few selected infrastructural components i e pipes and lids low impact developments also known as green infrastructures or suds for sustainable drainage system in our study we simulate the rainfall runoff process and stormwater conveyance with swmm 5 1 rossman 2015 which represents the nl tn basin and its drainage system using 228 sub catchments and 333 conduits 25 of which correspond to the nl tn canal fig 1 swmm was calibrated by comparing observed and simulated water depth along the nl tn canal for a 2 year design storm the calibration exercise gave a root mean square error rmse of 0 02 m and mean absolute percentage error mape of 1 5 for the predicted depths along 26 points of the canal a validation exercise comparing flooded manholes in swmm to observed flooded streets showed reasonable accuracy under visual inspection and a rmse of 0 04 m and mape of 13 4 when 15 locations were compared details of calibration and validation exercises can be found in ho et al 2015 swmm settings including lid set up can be found in the supplementary materials 2 2 rainfall data we obtained a 10 year rainfall time series with hourly resolution from the southern regional hydrometeorological center of vietnam the rainfall data were recorded at the tan son hoa meteorological station fig 1 from 1 jan 2008 to 31 december 2017 the average annual precipitation is 2075 5 mm with the monsoon season from may to october accounting for nearly 80 of the total rainfall volume 3 methods the computational framework consists of five steps illustrated in fig 2 we begin with the stochastic rainfall models with which we generate a set of rainfall events representative of the intensities duration and profiles observed in the nl tn basin next we carry out a sensitivity analysis to select the infrastructural components or decision variables that should be upgraded to improve the drainage system s performance note that the sensitivity analysis is executed across the rainfall events generated in the previous step to limit the computational requirements brought about by the inclusion of multiple rainfall events in the optimization phase we then build an emulator or surrogate model of swmm and use it in the surrogate assisted optimization the optimization seeks pareto efficient solutions that maximize performance measured in terms of reduction of overflow volume and flooded nodes while minimizing investment costs to seek robust solutions during the optimization performance is measured in terms of the expected value metric in which high performance across broad rainfall conditions is desired finally we evaluate the robustness of the solutions so obtained by testing their performance on an independent test set of rainfall events our solutions are benchmarked against those obtained in a more traditional fashion that is by solving a simulation optimization problem with swmm forced by a single design storm 3 1 rainfall analysis we first perform a rainfall analysis to identify and characterize the rainfall conditions that are likely to occur in the nl tn basin using the 10 year hourly rainfall time series we extract a total of 1720 rainfall events each defined as a period of time with at least 0 2 mm of rain and separated from preceding and succeeding events by a gap of at least 4 h the rainfall events are characterized in terms of duration intensity and profile or temporal pattern based on previous work ng et al 2020 we model the marginal distribution of rainfall duration and intensity using a log normal and gamma distribution respectively the dependence structure between the two variables is modeled with a frank copula genest and favre 2007 salvadori and de michele 2007 see supplementary material from these distributions we then sample rainfall events over a 25 year period so as to obtain a wide range of rainfall conditions while the service life of the drainage system may be largely region specific here we use a 25 year period because it is often adopted at these latitudes pub 2011 dsd 2018 by sampling from the distributions we select 259 rainfall events after accounting for rounding differences such that each event has intensity and duration that differ by at least 1 mm h and 1 h respectively the temporal patterns also referred to as profiles of rainfall events are then modeled with huff s method huff 1990 see supplementary material through which we derive four curves describing the distribution of rain over time by combining the 259 stochastic rainfall events with the four temporal patterns we get a total of 1036 rainfall events with varying intensity duration and profile seeking solutions that are robust i e perform equally well against all 1036 rainfall events would be computationally too expensive recall that stochastic rainfall events are used not only during the optimization process but also in the sensitivity analysis that identifies the decision variables fig 2 to reduce the number of rainfall events without compromising the integrity of our analysis we bank on the fact that some rainfall events may lead to similar overflow conditions to explore this opportunity we proceed in two steps first we use swmm to simulate the overflow volume produced by the existing drainage system under the 1036 events fig 3 a then we formulate a clustering problem to identify groups of rainfall events that cause similar overflow conditions specifically each rainfall event is represented by a vector consisting of the logarithm of total overflow volume the total number of flooded nodes and the overflow volume over each of the nodes that are flooded in at least one event each vector component is then normalized into the range 0 1 the problem is solved with k means clustering berkhin 2006 with a value of k equal to eight a value found via trial and error see supplementary materials fig 3 b illustrates the resulting clusters together with eight representative rainfall events labeled opt selected on the basis of their proximity to the centroid of each cluster these representative events are used in the subsequent design process two other rainfall events are sampled from each cluster labeled r1 and r2 forming the test set used to evaluate the robustness of optimized solutions 3 2 sensitivity analysis for a large watershed like the nl tn basin rainfall events can cause overflow conditions in different areas hence designing a robust drainage system will require different infrastructural interventions to identify the decision variables that should be considered for the infrastructural upgrade we resort to sensitivity analysis the initial decision space includes the expansion of any of the 308 pipes excluding the 25 corresponding to the nl tn canal and the implementation of four types of lid i e rainwater harvesting green roofs urban green spaces and pervious pavements within three sub catchments previously identified by ho et al 2015 we thus have a total of 320 potential decision variables with the sensitivity analysis we identify the decision variables or input factors that contribute the most to the reduction of overflow volume across the eight representative rainfall events we use the elementary effect test eet a common choice for sensitivity analysis problems pianosi et al 2016 in eet input factors of the simulation model are perturbed one at a time from multiple points within the input space overall sensitivity is measured by taking the mean of the elementary effects namely the local derivatives of the output with respect to an input a total of r m 1 evaluations is needed where m is the number of factors and r the number of elementary effects in this instance m is equal to 320 while r is set to 100 a value chosen by checking the convergence of the sensitivity estimates this leads to a total of 32 100 models runs a large computational burden that demanded a modification of the eet algorithm we speed up the eet by reducing and partitioning the input space under the assumption that infrastructural interventions have localized effects and are unable to reduce flood in a distant area of this large catchment in particular we first perform a pre processing step that groups adjacent nodes of the drainage network into clusters based on flow conditions during each representative rainfall event this is done using an agglomerative clustering technique legendre and legendre 2012 the resulting drainage network clusters different for each representative rainfall event are reported in the supplementary materials with these node clusters we reduce the input space by selecting clusters based on overflow per node until at least 90 of overflow has been accounted for thereby discarding input factors in remaining clusters with no or minimal overflow we partition the input space by perturbing multiple input factors at a time one from each node cluster attributing overflow changes within each cluster only to the input factor that is perturbed within that cluster by doing so we reduce the number of evaluations needed by reducing m from 320 to the size of the largest node cluster which in our case corresponds to 31 34 81 80 44 31 45 and 44 for the eight rainfall events respectively a marked reduction in the required number of swmm simulations for each rainfall event we finally rank the inputs according to the mean elementary effect selecting the top inputs that are most influential in reducing overflow this yields a total of twelve pipes and eight lids whose specifications are reported in tables 1 and 2 3 3 emulator identification to identify a computationally efficient representation of swmm we rely on a data driven emulation technique based on gaussian processes gp first introduced by carbajal et al 2017 we select this technique because of three reasons first it yields an output time series e g overflow volume at each time step instead of a temporally aggregated output this is particularly advantageous when formulating robust optimization problems since one does not need to identify different emulators when experimenting with different robustness metrics such as the largest or median overflow volume during a given rainfall event herman et al 2015 mcphail et al 2018 second gp can represent nonlinear processes such as overflow conditions caused by surcharge flows in pipes rossman 2015 third carbajal et al 2017 notes that it is advantageous to use data driven emulators when we lack good prior knowledge about the simulator and when the parameter space can be evenly well sampled as in this case study where hundreds of simulations can be computed within reasonable time here the emulator replaces swmm in the optimization step so we need an emulator that takes as input the decision variables i e sewer pipe sizes and lid areas tables 1 and 2 and calculates the overflow volume and number of flooded nodes at each time step of each rainfall event of interest hereafter we represent the emulator input and output with x and y x respectively the emulator is constructed with the following steps carbajal et al 2017 i perform a design of experiment to select n points in the input space denoted by inputs x and run the simulation model swmm for each point each simulation output is a time series of length n of the variables of interest allocate n t r n input output pairs to the training set and n t s t input output pairs to the test set with n t r n n t s t n ii given the output matrix y r n n t r n perform a singular value decomposition svd the goal here is to extract the most significant dynamic features of the system response i e the time varying basis with svd we obtain the orthogonal matrices φ r n n t r n and w r n t r n n t r n plus the non negative diagonal matrix σ r n t r n n t r n the three matrices fulfill the following condition 1 y φ σ w t so y can be decomposed into 2 y φ b where 3 b σ w t and φ are the eigenvectors or principal components of the covariance matrix y y t the columns of φ are the dynamic features or time varying basis of the model response the columns of b are the coefficients of the linear combinations of the features for each training point iii extract only the first q n t r n features φ from φ i e the first q columns since approximation tends to degrade rapidly with the number of principal components φ forms the time varying basis that contains the most significant features of the system response we also obtain the matrix b r q n t r n i e first q rows of b of coefficients where there are q coefficients for each training point iv use gp to map between the inputs x and the coefficients of the features of the output so as to obtain a function of the inputs b f x v finally given any new points in the test set we can now evaluate f x with the gp and predict the output time series using the following expression 4 y x φ f x in our setup we are interested in both time series of overflow volume and number of flooded nodes so we create two instances of the output matrix y each instance is created by concatenating the time series of overflow volume or number of flooded nodes from each of the eight representative rainfall events each concatenated time series has n 996 data points i e the number of rows in y recorded at five minutes interval of the simulation the number of decision variables is equal to 20 a high dimensional space for an emulator identification problem carbajal et al 2017 to determine the emulator s reliability we carry out a thorough design of experiment in which we vary the number of points n in the input space n 50 100 150 200 250 300 400 500 as well as the number q of features of the system response q 1 2 3 4 5 7 10 15 20 25 we then assess the performance of the emulators using the mean bias error mbe root mean square error rmse and kling gupta efficiency kge gupta et al 2009 whose definitions are specified in appendix a mbe and rmse assess the bias and magnitude of error for the aggregated output while kge measures how well the time series is predicted emulator accuracy increases rapidly from n 50 to n 100 but increases marginally beyond that hence we select n 250 as a balance between computational requirements and accuracy improvements are minimal or absent beyond q 7 hence this value is used in the emulator for more details please refer to the supplementary material 3 4 robust optimization in this step we determine the infrastructural upgrades through an emulation based or surrogate assisted optimization specifically we adopt a basic sequential framework similar to that of broad et al 2010 in which we directly replace the simulation model swmm with the emulator and couple it with a multi objective evolutionary algorithm here we use the nondominated sorting genetic algorithm ii nsga ii deb et al 2002 a popular choice in the field of water resources nicklow et al 2010 reed et al 2013 and urban drainage systems beraud et al 2010 damodaram and zechman 2013 di matteo et al 2017 as detailed in section 3 2 the decision variables are the pipe diameters and number of lid units for the components listed in tables 1 and 2 we consider three objective functions the reduction in total overflow volume j w o v e r f l o w the reduction in peak number of flooded nodes j w n o d e both to be maximized and the capital cost j c o s t to be minimized j w o v e r f l o w accounts for the flood extent across multiple rainfall events and is defined as follows 5 j w o v e r f l o w u 1 u w u 1 t 1 t u g 1 t u x f b a s e l i n e u where x is the vector of decision variables u the total number of rainfall events eight in our case t u the total number of time instances 5 min intervals in rainfall event u g 1 t u the overflow volume in the catchment at time t in rainfall event u predicted by the emulator and f b a s e l i n e u the total overflow volume during rainfall event u for the existing drainage system to account for robustness we use the expected value metric which aims to maximize expected performance across a range of rainfall scenarios while other robustness metrics such as regret based metrics or satisficing metrics have been proposed to measure system performance mcphail et al 2018 we want a metric that quantifies performance in all rainfall events hence the expected value becomes a natural choice to find the expected performance across rainfall events we assign a weight variable to each rainfall event the weight is proportional to the probability of occurrence and overflow severity of the rainfall event thus prioritizing solutions that reduce overflow in frequent or severe events we define w u the weight of rainfall event u as 6 w u l c u p r l f b a s e l i n e l l 1 n e p r l f b a s e l i n e l where c u is the set of rainfall events in the cluster containing rainfall event u n e the total number of rainfall events sampled and p r l the probability of occurrence of event l the weight w u is proportional to the total risk of rainfall events within the cluster represented by event u the second objective j w n o d e accounts for the spatial extent of floods it is defined as follows 7 j w n o d e u 1 u w u 1 max t g 2 t u x n b a s e l i n e u where g 2 t u is the number of flooded nodes in the catchment at time t in rainfall event u predicted by the emulator and n b a s e l i n e u the peak number of flooded nodes during rainfall event u for the existing drainage system the reduction in peak flooded nodes is similarly weighted here to account for the expected performance across rainfall events finally j c o s t is the capital cost involved in pipe expansion and lid implementation it can be calculated without an emulator and is defined as follows 8 j c o s t j 1 m p α x j l j 1 x j d j k 1 m l β k a k x m p k where m p and m l are the total number of pipe and lid decision variables respectively α the cost of a pipe in usd per unit length and unit diameter 0 8 mm diameter m length independent of the depth and pipe material but inclusive of excavation cost associated estimated from usepa 1999 l j and d j the length and original diameter of pipe j original depth if pipe j is rectangular β k the cost in usd per unit area of lid k 100 25 100 75 per m 2 of green roof pervious pavement urban green spaces and rainwater harvesting respectively estimated from sample 2013 a k the area of a single unit of lid k and 1 x j d j an indicator function that takes value equal to 1 if the j th pipe is expanded and 0 otherwise note that the assumption of a linear relationship between pipe and lid costs and their parameters may not always be true yet this would only affect the total costs calculated but not the conclusions of the study the goal of the optimization problem is to find the set of nondominated solutions x that minimizes the vector j x where 9 j x j w o v e r f l o w x j w n o d e x j c o s t x for the nsga ii algorithm we set the value of crossover and mutation to 0 9 and 0 1 respectively while population size and number of generations are equal to 200 and 250 the optimization problem is solved with 10 independent random seeds i e restarts of the algorithm so as to account for the randomness in the search process the final set of pareto efficient solutions thus corresponds to the set of pareto efficient solutions identified across all 10 seeds all experiments were run on an intel xeon 2 4 ghz with 96 gb ram running microsoft windows 10 24 cores 3 5 robustness analysis to measure the robustness of the optimized solutions we use the expected value metrics as defined in eqs 5 and 7 there are two differences here first the overflow volume and number of flooded nodes are not predicted by the emulator but are directly obtained via simulation with swmm since much fewer simulation runs are required here than in the optimization step second we simulate the solutions under a different set of rainfall events and compute the metrics under the test set of rainfall events this test set of rainfall events are generated by randomly sampling two other rainfall events from each of the eight rainfall clusters set r1 and r2 note that these events are independent from those used in the optimization process set opt the properties of these events are illustrated in fig 3 b while the overflow conditions they cause in the existing drainage system are reported in table 3 3 6 benchmarking to benchmark the results obtained through the computational framework described above henceforth referred to as r eo for robust emulation optimization we setup a simpler optimization problem where we only consider a single rainfall event under the assumption that solutions optimized for that event will be robust against other rainfall conditions this problem representing common practices in urban drainage design is hereafter referred to as design storm simulation optimization scheme ds so specifically we adopt a single rainfall event i e the 3 h 2 year return period design storm ho et al 2015 in both the sensitivity analysis and optimization step the choice of the design storm is less because of its return period but because of the flood damage it causes the design storm results in 281 756 m 3 of overflow volume and 60 flooded nodes at the peak of the flood this is comparable to the flood damage of the median representative rainfall events used in r eo allowing us to see how solutions obtained from ds so perform when rainfall properties deviate from the design storm in either directions for optimization in ds so we adopt a multi objective simulation optimization scheme in which we couple swmm with the nsga ii algorithm to solve the optimization problem as a result the definition of the three objective functions is revised to include swmm outputs directly and exclude the robustness metric i e the weights that account for expected performance the experimental setup of the nsga ii algorithm is the same for both optimization problems the solutions obtained from ds so are evaluated using the representative rainfall events labeled opt in fig 3 b and also the randomly sampled test sets of rainfall events labeled r1 and r2 in fig 3 b subsequently for comparison purposes to evaluate the search quality of r eo and ds so schemes we adopt three performance metrics commonly used in the field of multi objective optimization reed et al 2013 giuliani et al 2014 these metrics are the hypervolume indicator generational distance and additive ϵ indicator which respectively account for diversity convergence and consistency of the solution set with respect to a reference set such as the true pareto front zitzler et al 2003 when the true pareto front is unknown like in our case the best known solution set found across the optimization schemes is used as the reference set in particular the hypervolume indicator measures the volume of the objective space dominated by a solution set the generational distance measures the average euclidean distance of each point in the solution set to its closest point in the reference set finally the additive ϵ indicator measures the worst case distance in contrast to the average distance between the solution and reference set and is especially sensitive to gaps in the solution set 4 results and discussion we begin by describing the pareto efficient solutions obtained through the r eo scheme section 4 1 then we compare these solutions against those obtained through the design storm simulation optimization scheme ds so in this comparison we account for the value of the objective functions optimization metrics robustness and computational requirements section 4 2 through such multi criteria assessment we thus illustrate the limits that lie in the adoption of design storms 4 1 pareto efficient solutions the ten independent optimization runs of the r eo scheme returned a total of 765 pareto efficient solutions illustrated in fig 4 left panel the solutions exhibit a broad range of costs j c o s t up to 80 million overflow reduction j w o v e r f l o w up to 84 and peak number of flooded nodes reduction j w n o d e up to 42 we also note a strong trade off between costs and the drainage system s performance measured in terms of either j w o v e r f l o w or j w n o d e interestingly there is a kink located in the central part of the front where j w o v e r f l o w and j c o s t are equal to about 80 and 15 million the kink is attributed to the switch in investing in lids instead of pipe expansion see supplementary material this implies that for investments below the 15 million threshold it is possible to obtain major improvements in overflow reduction or number of flooded nodes reduction with marginal cost increases by expanding pipes in multiple locations beyond that threshold additional investments have diminishing returns as performance of lids is highly variable under different rainfall events and is less marked under short intense rainfall typical of a tropical climate schmitter et al 2016 since the r eo scheme is informed by an emulator it is important to re evaluate all solutions with swmm so as to characterize the error brought about by the use of a simpler model during the optimization process this re evaluation exercise yields the pareto front reported in fig 4 right panel the major difference between the two fronts stands in the gap appearing in the front re evaluated with swmm for values of overflow reduction between 51 and 60 upon closer inspection we realize that the solutions responsible for this gap did not expand two of the pipes close to the outlet of the catchment that strongly influence the model response to rainfall events in turn this suggests that an inadequate sampling in this region of the decision space may have caused the emulator to fail to identify the critical pipes responsible for reducing overflow in particular rainfall events causing the prediction error leading to the gap results also indicate that high performance solutions i e overflow reduction larger than 60 maintain consistent performance when re evaluated with swmm for these solutions we found a mean bias error mbe of 5 7 between the two fronts for solutions falling in the other group i e overflow reduction below 51 the bias grows to 15 6 while such bias may still be acceptable in light of other evaluation criteria e g robustness of solutions computational requirements this result indicates that the high dimensionality of the optimization problem has partially prevented the emulator to find low cost solutions that are truly pareto efficient 4 2 benchmarking exercise 4 2 1 objective space the first fundamental step of the benchmarking exercise is the comparison of the pareto fronts obtained by the r eo and ds so schemes for the former we use the front illustrated in fig 4 right panel that is the robust solutions re evaluated with swmm for the latter we gather the 573 solutions obtained through the optimization process and evaluate their performance via simulation with swmm across the eight rainfall events used in the robust optimization the results of this comparison illustrated in fig 5 provide two main messages first solutions from the r eo scheme largely outperform solutions from the ds so scheme when j c o s t is above 10 million this is due to the better selection and optimization of decision variables since the r eo scheme relies on multiple rainfall events in both sensitivity analysis and optimization steps notice that above 10 million the gap between r eo and ds so remains constant since investments are directed to the implementation of lids when cost goes beyond 10 million this means that lids do not contribute to the advantage that the r eo solutions have the optimal pipe configuration attained at the 10 million mark by the r eo solutions is therefore responsible for the gap we see between the two sets of solutions second when j c o s t falls below 10 million solutions from both optimization schemes are comparable naturally one reason for such result is the emulator inaccuracy discussed in section 4 1 yet this also indicates that when the investment budget is limited and the pipe expansion has only a few options it is harder to manage overflow reduction for all different rainfall events since overflow conditions occur at different locations 4 2 2 multi objective optimization metrics the quality of the pareto fronts obtained by the r eo and ds so schemes is further quantified by the three metrics introduced in section 3 6 a good front should be characterized by low values of generational distance and ϵ indicator close to 0 and a high value of the hypervolume indicator close to 1 as shown in table 4 the r eo front outperforms the ds so one with respect to all metrics for the hypervolume indicator ds so scheme has a value that is less than half the value obtained by the r eo scheme this indicates that the r eo front dominates a much larger volume of the objective space which is evident from the distance between the two fronts for values of j c o s t exceeding 10 million fig 5 this also explains the large gap in the value of the ϵ indicator which measures the worst case distance between two fronts on the other hand the average distance between the fronts i e generational distance is smaller because the fronts tend to overlap when j c o s t falls below 10 million in sum the multi objective optimization metrics indicate that the r eo pareto front is characterized by better diversity convergence and consistency 4 2 3 robustness the expected performance of ds so and r eo evaluated under the test set of rainfall events are illustrated in fig 6 while the gap between the two sets of solutions is less obvious than in fig 5 we still see that solutions above 10 million obtained from r eo are more robust against different rainfall conditions as compared to solutions from ds so in fig 7 we compare the performance for all solutions generated by the r eo and ds so schemes for each individual rainfall event in the test set using the cumulative distribution of drainage performance i e overflow reduction and peak number of flooded nodes reduction note that the cumulative distribution here refers to the weights defined in eq 6 and not probability such that rainfall events with larger flood or higher frequency have higher weights each line in the plot represents a solution so a solution has better performance if it lies as far to the left as possible or if it covers a greater area under the line this is also why we see expensive solutions in green blue lying closer to the left for example if a line passes through the point 50 0 6 it can be interpreted as a solution achieving a reduction greater than or equal to 50 for 0 6 in terms of accumulated weights of the stochastic rainfall events what is key here is that the most expensive solutions obtained from the r eo scheme are more robust against a wide range of rainfall characteristics than the expensive solutions from the ds so scheme a point illustrated by the lines in fig 7 lying closer to the left as for the cheaper solutions robustness is comparable across the two schemes as mentioned in section 4 2 1 this result is attributable to the small number of infrastructural upgrades available when dealing with a limited budget while the plots in figs 6 and 7 provide an overview of how solutions perform across multiple rainfall events they do not indicate what types of rainfall events affect robustness neither do they indicate the overall performance of the pareto front to answer this question we calculate the hypervolume indicator corresponding to each individual rainfall event and also for the weighted objectives as shown in table 5 the hypervolume obtained by the r eo scheme is higher for all events with the exception of event 4 which is the event most similar to the design storm as the events are arranged in order of increasing severity of overflow we also observe that solutions obtained from the ds so scheme perform better in rainfall events similar to the design storm e g event 3 and 5 but performance degrades as rainfall characteristics deviates from those of the design storm the ds so solutions perform the worst for event 1 which is the smallest rainfall event as they fail to eliminate the small overflow unlike solutions from the r eo scheme this highlights the importance of considering not just the design storm but also rainfall events with a broad range of intensities duration and profiles in the design of robust urban drainage systems the other performance metrics ϵ indicator and generational distance show similar results and are given in the supplementary material 4 2 4 computational requirements finally we compare the computational requirements of the ds so and r eo schemes evaluated in terms of number of swmm simulation runs required for the various steps of the design problem i e sensitivity analysis emulation and optimization in this comparison we consider a third scheme in which swmm is directly coupled with the nsga ii algorithm to solve the robust optimization problem r so naturally we do not solve such problem due to its high computational requirements but the number of swmm simulations it needs give us a clear understanding of the advantages that lie in the use of emulators as shown in table 6 the three schemes require a similar number of runs for the sensitivity analysis the increase in simulation runs as a result of considering multiple rainfall events in r eo and r so has been overcome by the modification we made to the sensitivity analysis the main computational advantage of the r eo scheme stands in the optimization phase this scheme foregoes swmm during the optimization process so it only needs the model to generate the data needed for the emulator identification 250 runs and evaluate ex post the quality of the solutions 6120 runs a number dependent on number of pareto efficient solutions obtained on the other hand the deterministic simulation optimization scheme ds so requires 500 000 runs and the robust simulation optimization scheme r so 4 000 000 in sum the r eo calls the simulator 12 times less than ds so and 91 times less than r so considering that a single swmm run in the nl tn basin takes about 5 to 10 s this translates to computational cost savings of 600 and 5000 h with respect to ds so and r so respectively for bigger catchments we would thus expect even larger computational cost savings 5 conclusions our work is motivated by the fact that relying on the information provided by design storms may lead to issues of robustness that is the inability of performing consistently under a broad range of rainfall events to resolve this we developed a computational framework that explicitly leverages the information contained in multiple rainfall events throughout the design process in particular that information is used to first select the infrastructural components in need of an upgrade via sensitivity analysis and then determine their design specifications via optimization the inevitable increase in the computational requirements is countered through the aid of a data driven emulator which replaces swmm in the optimization process we hope that our work could encourage the adoption of multiple rainfall events in the design of drainage systems motivating practicing engineers who commonly rely on design storms to shift towards a robust design approach the application of both robust emulation optimization framework and design storm simulation optimization framework on the nhieu loc thi nghe basin reveals the following insights the solutions based on the robust optimization scheme outperform those achieved by relying on the design storm this improvement is quantified by the multi objective optimization metrics measuring diversity convergence and consistency of the pareto fronts as well as the sheer value of the objective functions for example a budget of 30 million yields an overflow reduction of 85 and 50 when relying on stochastic rainfall events and design storm respectively a similar improvement is found in the reduction of number of flooded nodes in other words we can achieve better drainage performance by investing the same budget the largest improvements are found for budgets that exceed 10 million recall that the budget s range is 0 80 million there are two factors explaining this result first the emulator is not particularly accurate in reproducing swmm s outputs in the area of the decision space characterized by limited drainage performance and therefore limited budgets second a minimum investment budget is needed to effectively curb overflow across multiple rainfall events our framework yields urban drainage systems that are more robust than those based on the design storm importantly we found that the performance gap between solutions obtained from the two schemes extends further as the rainfall conditions i e intensity duration and profile deviate from those of the design storm this is true in both directions of deviation when rainfall events are smaller or larger than the design storm emulators are successful in controlling the increase in the computational requirements brought about by the use of multiple rainfall events within the optimization process in fact the use of emulators reduces the number of swmm simulation runs by a factor of about 12 with respect to the scheme based on design storms for our case study and computational resources that translates to about 600 computing hours one research area that deserves further investigation is the accuracy of emulators in particular it is important to develop techniques ensuring that the emulator s error does not excessively increase during the optimization process this could be achieved for example by updating the emulator s parameterization during the optimization process yazdi and neyshabouri 2014 in turn this would require evolution control strategies that balance exploration exploitation and diversification of the optimization process jin 2011 akhtar and shoemaker 2016 to provide greater computational savings it is also worth using emulators in sensitivity analysis as recently explored by borgonovo et al 2012 qian et al 2018 and nagel et al 2020 looking forward it is reasonable to expect that surrogate assisted optimization or data driven approaches in the broader context will gain further traction in urban drainage systems analysis as we move towards tasks requiring large computational budgets mullapudi et al 2020 one such example is the inclusion of other sources of deep uncertainty in the design of drainage systems such as urban development or shifts in hydrological extreme events due to climate change fletcher et al 2013 berndtsson et al 2019 hosseinzadehtalaei et al 2021 overall computational frameworks like this one demonstrate that there are technical pathways for combining data and physics based models e g swmm ultimately balancing computational tractability modeling accuracy and drainage performance credit authorship contribution statement jia yi ng methodology investigation visualization writing original draft samira fazlollahi supervision magali dechesne supervision writing review editing emmanuel soyeux supervision stefano galelli conceptualization supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research was supported by the veolia city modeling centre through singapore economic development board s industrial postgraduate programme project no igipvcmc1601 the authors would also like to acknowledge veolia recherche et innovation veri for their support appendix a the following measures are used to assess the accuracy of the emulators i the kling gupta efficiency kge compares the correlation variability and bias between the predicted time series from emulator and observed time series from simulator gupta et al 2009 it is defined as follows 10 k g e 1 r 1 2 α 1 2 β 1 2 where r is the correlation coefficient α the ratio between standard deviation of predicted and observed values σ p σ o and β the ratio between the mean of predicted and observed values μ p μ o a value of 1 for kge means that the predicted time series matches the observed one perfectly ii the mean bias error mbe captures the bias of prediction which is important when the emulators are used in optimization since a positive bias means that the solutions obtained are not performing as well as expected it is defined as 11 m b e 1 n j 1 n y ˆ x j y x j where y ˆ and y are the emulated and simulated output respectively and n the number of data points in the test set iii the root mean square error rmse rmse captures the magnitude of error and penalizes large deviation more 12 r m s e 1 n j 1 n y ˆ x j y x j 2 appendix b supplementary data supplementary material related to this article can be found online at https doi org 10 1016 j advwatres 2022 104335 appendix b supplementary data the following is the supplementary material related to this article mmc s1 the supplementary material includes additional modelling details swmm rainfall sensitivity analysis and results 
65,the design of urban drainage systems often relies on the coupling of optimization algorithms and process based models with the latter informed by design storms however such practice may not yield systems that are robust with respect to a broad array of rainfall conditions to tackle this problem we contribute a novel computational framework characterized by two distinguishing features first we use multiple rainfall events throughout the design process and second we rely on faster emulators instead of process based models to manage the inevitable increase in the computational requirements in particular our framework moves through five steps accounting for the generation of stochastic rainfall events the selection of decision variables via sensitivity analysis emulator identification emulation based optimization and ex post robustness analysis to test our framework we implement it on a 33 km 2 basin in ho chi minh city vietnam and benchmark it against a more traditional approach based on design storms results show that there are untapped opportunities for improving drainage performance without altering investment costs for example we found that a budget of 30 million can yield an overflow reduction of about 85 or 50 depending on whether we rely on stochastic rainfall events or design storms importantly such improvements do not affect the computational requirements owing to the use of emulators the framework is applicable to other basins and could be readily extended to other sources of uncertainty such as land use change or climate change scenarios which are expected to pose additional strains on urban drainage systems keywords stormwater management green infrastructure optimization robustness machine learning data availability data will be made available on request 1 introduction urban floods are complex phenomena whose likelihood and impact are largely driven by rapid urbanization and hydro climatic variability hettiarachchi et al 2018 berndtsson et al 2019 o donnell and thorne 2020 urban sprawls not only concentrate economic activities and assets within flood prone areas but also decrease permeability and lead to loss of floodable urban spaces in turn increasing the likelihood of flood events fletcher et al 2013 berndtsson et al 2019 moreover climate change is altering rainfall characteristics ultimately intensifying extreme rainfall events and increasing flood volumes hosseinzadehtalaei et al 2021 the strain of limiting the detrimental impact of these factors largely falls on urban drainage systems increasingly seen as the combination of traditional physical assets e g pipes storage tanks with green infrastructures that control runoff at its source schmitter et al 2016 kapetas and fenner 2020 joshi et al 2021 as all these infrastructures are deployed or upgraded to be operational for decades careful design is necessary to avoid misallocating investment budgets that may lead to unsatisfactory drainage performance bach et al 2014 in particular it is key to conceive drainage systems whose performance is robust that is they maintain the same level of performance with respect to a broad range of rainfall events as well as other sources of uncertainty deletic et al 2012 sörensen et al 2016 berndtsson et al 2019 ng et al 2020 since the advent of metaheuristic optimization techniques the design of urban drainage systems has typically relied on the coupling between optimization algorithms and process based models wang et al 2018 2019 such as epa s storm water management model swmm rossman 2015 the key advantage of the simulation optimization approach is that it allows accounting for complex storm hyetographs as well as the physical response of the drainage system simulation optimization is therefore regularly used for a variety of tasks from the placement of green infrastructure at the catchment scale damodaram and zechman 2013 giacomoni and joseph 2017 to the optimization of pipes and storage capacities maharjan et al 2009 ogidan and giacomoni 2017 a commonality of these studies is their reliance on one or a few design storms a practice arguably inherited from historical developments in the field of urban drainage burian et al 1999 butler and davies 2000 however recent research efforts suggest that relying on a single critical rainfall event with a specific return period may fail to produce robust decisions for instance ng et al 2020 found that drainage systems designed with respect to a design storm failed to maintain the same level of performance when rainfall intensity duration and temporal distribution deviated from the design storm temporal patterns of rainfall events were also demonstrated to be as important as rainfall volume in influencing flood response hettiarachchi et al 2018 cheng et al 2020 this issue has prompted a rising number of studies in which multiple rainfall scenarios are explicitly considered in the design process yazdi and neyshabouri 2014 yu et al 2017 casal campos et al 2018 ngo et al 2019 notwithstanding these recent progresses more methodological advancements are needed to close the chasm between the need for robust drainage systems and the mathematical modeling tools available to design them a first challenge lies in computational requirements explicitly accounting for multiple rainfall events largely increases the number of simulation runs required during the optimization process thereby demanding massive upgrades to computational budgets a technical pathway is represented by emulation or surrogate modeling an umbrella term for a wide range of methods that develop computationally efficient alternatives to higher fidelity simulation models castelletti et al 2012 razavi et al 2012 widely adopted by the water resources community for an extensive survey see garzón et al 2022 emulators are gaining traction in the field of urban drainage where they have been used to solve computationally demanding tasks such as bayesian calibration or sensitivity and simulation analysis carbajal et al 2017 bermúdez et al 2018 moreno rodenas et al 2018 nagel et al 2020 yet their suitability for robust optimization problems remains largely unexplored yazdi and neyshabouri 2014 second the problem of designing a drainage system often requires us to first determine which infrastructural components should be optimized a task constrained by multiple factors such as budget availability site specific considerations or computational complexity choosing the best possible decision variables may be critical for issues of robustness and yet we are currently lacking automated procedures that can support this choice while dealing with multiple rainfall events finally both aforementioned challenges are exacerbated by the size of the study site at hand designing robust drainage systems over basins larger than a few square kilometers remains an open problem here we contribute a novel computational framework conceived to design drainage systems that are robust with respect to a broad array of rainfall conditions the framework consists of five building blocks stochastic rainfall generation sensitivity analysis to select the decision variables emulator identification emulation based optimization and ex post robustness analysis carried out on an independent test set of rainfall events the framework stems from two modeling considerations first it is best to use multiple rainfall events throughout the design process from the identification of the decision variables to their optimization so as to endow each decision with the information contained in these events second we can battle the inevitable increase in computational requirements through the use of emulators to test our framework we apply it to the nhieu loc thi nghe basin an area of 33 km 2 located in ho chi minh city vietnam and benchmark it against a more traditional simulation optimization approach informed by a single design storm through this analysis we show the benefits of using multiple rainfall events determine the conditions that are most challenging for systems based on design storms and identify opportunities for further improving the performance of our approach 2 case study 2 1 study site the nhieu loc thi nghe nl tn basin is located in the central area of ho chi minh city vietnam fig 1 the basin spans across an area of 33 km2 with land use dominated by residential developments 49 3 of the total area and commercial public and industrial uses domestic wastewater and stormwater are conveyed by the combined sewer system into the nl tn canal and eventually discharged into the saigon river heavily polluted in the 1960s the nl tn canal has since been cleaned up as authorities relocated informal settlements and improved the drainage system even so flood events remain common especially because of intensified rainfall events le et al 2021 as we shall see in section 3 our objective is to reduce the current impact of floods by upgrading a few selected infrastructural components i e pipes and lids low impact developments also known as green infrastructures or suds for sustainable drainage system in our study we simulate the rainfall runoff process and stormwater conveyance with swmm 5 1 rossman 2015 which represents the nl tn basin and its drainage system using 228 sub catchments and 333 conduits 25 of which correspond to the nl tn canal fig 1 swmm was calibrated by comparing observed and simulated water depth along the nl tn canal for a 2 year design storm the calibration exercise gave a root mean square error rmse of 0 02 m and mean absolute percentage error mape of 1 5 for the predicted depths along 26 points of the canal a validation exercise comparing flooded manholes in swmm to observed flooded streets showed reasonable accuracy under visual inspection and a rmse of 0 04 m and mape of 13 4 when 15 locations were compared details of calibration and validation exercises can be found in ho et al 2015 swmm settings including lid set up can be found in the supplementary materials 2 2 rainfall data we obtained a 10 year rainfall time series with hourly resolution from the southern regional hydrometeorological center of vietnam the rainfall data were recorded at the tan son hoa meteorological station fig 1 from 1 jan 2008 to 31 december 2017 the average annual precipitation is 2075 5 mm with the monsoon season from may to october accounting for nearly 80 of the total rainfall volume 3 methods the computational framework consists of five steps illustrated in fig 2 we begin with the stochastic rainfall models with which we generate a set of rainfall events representative of the intensities duration and profiles observed in the nl tn basin next we carry out a sensitivity analysis to select the infrastructural components or decision variables that should be upgraded to improve the drainage system s performance note that the sensitivity analysis is executed across the rainfall events generated in the previous step to limit the computational requirements brought about by the inclusion of multiple rainfall events in the optimization phase we then build an emulator or surrogate model of swmm and use it in the surrogate assisted optimization the optimization seeks pareto efficient solutions that maximize performance measured in terms of reduction of overflow volume and flooded nodes while minimizing investment costs to seek robust solutions during the optimization performance is measured in terms of the expected value metric in which high performance across broad rainfall conditions is desired finally we evaluate the robustness of the solutions so obtained by testing their performance on an independent test set of rainfall events our solutions are benchmarked against those obtained in a more traditional fashion that is by solving a simulation optimization problem with swmm forced by a single design storm 3 1 rainfall analysis we first perform a rainfall analysis to identify and characterize the rainfall conditions that are likely to occur in the nl tn basin using the 10 year hourly rainfall time series we extract a total of 1720 rainfall events each defined as a period of time with at least 0 2 mm of rain and separated from preceding and succeeding events by a gap of at least 4 h the rainfall events are characterized in terms of duration intensity and profile or temporal pattern based on previous work ng et al 2020 we model the marginal distribution of rainfall duration and intensity using a log normal and gamma distribution respectively the dependence structure between the two variables is modeled with a frank copula genest and favre 2007 salvadori and de michele 2007 see supplementary material from these distributions we then sample rainfall events over a 25 year period so as to obtain a wide range of rainfall conditions while the service life of the drainage system may be largely region specific here we use a 25 year period because it is often adopted at these latitudes pub 2011 dsd 2018 by sampling from the distributions we select 259 rainfall events after accounting for rounding differences such that each event has intensity and duration that differ by at least 1 mm h and 1 h respectively the temporal patterns also referred to as profiles of rainfall events are then modeled with huff s method huff 1990 see supplementary material through which we derive four curves describing the distribution of rain over time by combining the 259 stochastic rainfall events with the four temporal patterns we get a total of 1036 rainfall events with varying intensity duration and profile seeking solutions that are robust i e perform equally well against all 1036 rainfall events would be computationally too expensive recall that stochastic rainfall events are used not only during the optimization process but also in the sensitivity analysis that identifies the decision variables fig 2 to reduce the number of rainfall events without compromising the integrity of our analysis we bank on the fact that some rainfall events may lead to similar overflow conditions to explore this opportunity we proceed in two steps first we use swmm to simulate the overflow volume produced by the existing drainage system under the 1036 events fig 3 a then we formulate a clustering problem to identify groups of rainfall events that cause similar overflow conditions specifically each rainfall event is represented by a vector consisting of the logarithm of total overflow volume the total number of flooded nodes and the overflow volume over each of the nodes that are flooded in at least one event each vector component is then normalized into the range 0 1 the problem is solved with k means clustering berkhin 2006 with a value of k equal to eight a value found via trial and error see supplementary materials fig 3 b illustrates the resulting clusters together with eight representative rainfall events labeled opt selected on the basis of their proximity to the centroid of each cluster these representative events are used in the subsequent design process two other rainfall events are sampled from each cluster labeled r1 and r2 forming the test set used to evaluate the robustness of optimized solutions 3 2 sensitivity analysis for a large watershed like the nl tn basin rainfall events can cause overflow conditions in different areas hence designing a robust drainage system will require different infrastructural interventions to identify the decision variables that should be considered for the infrastructural upgrade we resort to sensitivity analysis the initial decision space includes the expansion of any of the 308 pipes excluding the 25 corresponding to the nl tn canal and the implementation of four types of lid i e rainwater harvesting green roofs urban green spaces and pervious pavements within three sub catchments previously identified by ho et al 2015 we thus have a total of 320 potential decision variables with the sensitivity analysis we identify the decision variables or input factors that contribute the most to the reduction of overflow volume across the eight representative rainfall events we use the elementary effect test eet a common choice for sensitivity analysis problems pianosi et al 2016 in eet input factors of the simulation model are perturbed one at a time from multiple points within the input space overall sensitivity is measured by taking the mean of the elementary effects namely the local derivatives of the output with respect to an input a total of r m 1 evaluations is needed where m is the number of factors and r the number of elementary effects in this instance m is equal to 320 while r is set to 100 a value chosen by checking the convergence of the sensitivity estimates this leads to a total of 32 100 models runs a large computational burden that demanded a modification of the eet algorithm we speed up the eet by reducing and partitioning the input space under the assumption that infrastructural interventions have localized effects and are unable to reduce flood in a distant area of this large catchment in particular we first perform a pre processing step that groups adjacent nodes of the drainage network into clusters based on flow conditions during each representative rainfall event this is done using an agglomerative clustering technique legendre and legendre 2012 the resulting drainage network clusters different for each representative rainfall event are reported in the supplementary materials with these node clusters we reduce the input space by selecting clusters based on overflow per node until at least 90 of overflow has been accounted for thereby discarding input factors in remaining clusters with no or minimal overflow we partition the input space by perturbing multiple input factors at a time one from each node cluster attributing overflow changes within each cluster only to the input factor that is perturbed within that cluster by doing so we reduce the number of evaluations needed by reducing m from 320 to the size of the largest node cluster which in our case corresponds to 31 34 81 80 44 31 45 and 44 for the eight rainfall events respectively a marked reduction in the required number of swmm simulations for each rainfall event we finally rank the inputs according to the mean elementary effect selecting the top inputs that are most influential in reducing overflow this yields a total of twelve pipes and eight lids whose specifications are reported in tables 1 and 2 3 3 emulator identification to identify a computationally efficient representation of swmm we rely on a data driven emulation technique based on gaussian processes gp first introduced by carbajal et al 2017 we select this technique because of three reasons first it yields an output time series e g overflow volume at each time step instead of a temporally aggregated output this is particularly advantageous when formulating robust optimization problems since one does not need to identify different emulators when experimenting with different robustness metrics such as the largest or median overflow volume during a given rainfall event herman et al 2015 mcphail et al 2018 second gp can represent nonlinear processes such as overflow conditions caused by surcharge flows in pipes rossman 2015 third carbajal et al 2017 notes that it is advantageous to use data driven emulators when we lack good prior knowledge about the simulator and when the parameter space can be evenly well sampled as in this case study where hundreds of simulations can be computed within reasonable time here the emulator replaces swmm in the optimization step so we need an emulator that takes as input the decision variables i e sewer pipe sizes and lid areas tables 1 and 2 and calculates the overflow volume and number of flooded nodes at each time step of each rainfall event of interest hereafter we represent the emulator input and output with x and y x respectively the emulator is constructed with the following steps carbajal et al 2017 i perform a design of experiment to select n points in the input space denoted by inputs x and run the simulation model swmm for each point each simulation output is a time series of length n of the variables of interest allocate n t r n input output pairs to the training set and n t s t input output pairs to the test set with n t r n n t s t n ii given the output matrix y r n n t r n perform a singular value decomposition svd the goal here is to extract the most significant dynamic features of the system response i e the time varying basis with svd we obtain the orthogonal matrices φ r n n t r n and w r n t r n n t r n plus the non negative diagonal matrix σ r n t r n n t r n the three matrices fulfill the following condition 1 y φ σ w t so y can be decomposed into 2 y φ b where 3 b σ w t and φ are the eigenvectors or principal components of the covariance matrix y y t the columns of φ are the dynamic features or time varying basis of the model response the columns of b are the coefficients of the linear combinations of the features for each training point iii extract only the first q n t r n features φ from φ i e the first q columns since approximation tends to degrade rapidly with the number of principal components φ forms the time varying basis that contains the most significant features of the system response we also obtain the matrix b r q n t r n i e first q rows of b of coefficients where there are q coefficients for each training point iv use gp to map between the inputs x and the coefficients of the features of the output so as to obtain a function of the inputs b f x v finally given any new points in the test set we can now evaluate f x with the gp and predict the output time series using the following expression 4 y x φ f x in our setup we are interested in both time series of overflow volume and number of flooded nodes so we create two instances of the output matrix y each instance is created by concatenating the time series of overflow volume or number of flooded nodes from each of the eight representative rainfall events each concatenated time series has n 996 data points i e the number of rows in y recorded at five minutes interval of the simulation the number of decision variables is equal to 20 a high dimensional space for an emulator identification problem carbajal et al 2017 to determine the emulator s reliability we carry out a thorough design of experiment in which we vary the number of points n in the input space n 50 100 150 200 250 300 400 500 as well as the number q of features of the system response q 1 2 3 4 5 7 10 15 20 25 we then assess the performance of the emulators using the mean bias error mbe root mean square error rmse and kling gupta efficiency kge gupta et al 2009 whose definitions are specified in appendix a mbe and rmse assess the bias and magnitude of error for the aggregated output while kge measures how well the time series is predicted emulator accuracy increases rapidly from n 50 to n 100 but increases marginally beyond that hence we select n 250 as a balance between computational requirements and accuracy improvements are minimal or absent beyond q 7 hence this value is used in the emulator for more details please refer to the supplementary material 3 4 robust optimization in this step we determine the infrastructural upgrades through an emulation based or surrogate assisted optimization specifically we adopt a basic sequential framework similar to that of broad et al 2010 in which we directly replace the simulation model swmm with the emulator and couple it with a multi objective evolutionary algorithm here we use the nondominated sorting genetic algorithm ii nsga ii deb et al 2002 a popular choice in the field of water resources nicklow et al 2010 reed et al 2013 and urban drainage systems beraud et al 2010 damodaram and zechman 2013 di matteo et al 2017 as detailed in section 3 2 the decision variables are the pipe diameters and number of lid units for the components listed in tables 1 and 2 we consider three objective functions the reduction in total overflow volume j w o v e r f l o w the reduction in peak number of flooded nodes j w n o d e both to be maximized and the capital cost j c o s t to be minimized j w o v e r f l o w accounts for the flood extent across multiple rainfall events and is defined as follows 5 j w o v e r f l o w u 1 u w u 1 t 1 t u g 1 t u x f b a s e l i n e u where x is the vector of decision variables u the total number of rainfall events eight in our case t u the total number of time instances 5 min intervals in rainfall event u g 1 t u the overflow volume in the catchment at time t in rainfall event u predicted by the emulator and f b a s e l i n e u the total overflow volume during rainfall event u for the existing drainage system to account for robustness we use the expected value metric which aims to maximize expected performance across a range of rainfall scenarios while other robustness metrics such as regret based metrics or satisficing metrics have been proposed to measure system performance mcphail et al 2018 we want a metric that quantifies performance in all rainfall events hence the expected value becomes a natural choice to find the expected performance across rainfall events we assign a weight variable to each rainfall event the weight is proportional to the probability of occurrence and overflow severity of the rainfall event thus prioritizing solutions that reduce overflow in frequent or severe events we define w u the weight of rainfall event u as 6 w u l c u p r l f b a s e l i n e l l 1 n e p r l f b a s e l i n e l where c u is the set of rainfall events in the cluster containing rainfall event u n e the total number of rainfall events sampled and p r l the probability of occurrence of event l the weight w u is proportional to the total risk of rainfall events within the cluster represented by event u the second objective j w n o d e accounts for the spatial extent of floods it is defined as follows 7 j w n o d e u 1 u w u 1 max t g 2 t u x n b a s e l i n e u where g 2 t u is the number of flooded nodes in the catchment at time t in rainfall event u predicted by the emulator and n b a s e l i n e u the peak number of flooded nodes during rainfall event u for the existing drainage system the reduction in peak flooded nodes is similarly weighted here to account for the expected performance across rainfall events finally j c o s t is the capital cost involved in pipe expansion and lid implementation it can be calculated without an emulator and is defined as follows 8 j c o s t j 1 m p α x j l j 1 x j d j k 1 m l β k a k x m p k where m p and m l are the total number of pipe and lid decision variables respectively α the cost of a pipe in usd per unit length and unit diameter 0 8 mm diameter m length independent of the depth and pipe material but inclusive of excavation cost associated estimated from usepa 1999 l j and d j the length and original diameter of pipe j original depth if pipe j is rectangular β k the cost in usd per unit area of lid k 100 25 100 75 per m 2 of green roof pervious pavement urban green spaces and rainwater harvesting respectively estimated from sample 2013 a k the area of a single unit of lid k and 1 x j d j an indicator function that takes value equal to 1 if the j th pipe is expanded and 0 otherwise note that the assumption of a linear relationship between pipe and lid costs and their parameters may not always be true yet this would only affect the total costs calculated but not the conclusions of the study the goal of the optimization problem is to find the set of nondominated solutions x that minimizes the vector j x where 9 j x j w o v e r f l o w x j w n o d e x j c o s t x for the nsga ii algorithm we set the value of crossover and mutation to 0 9 and 0 1 respectively while population size and number of generations are equal to 200 and 250 the optimization problem is solved with 10 independent random seeds i e restarts of the algorithm so as to account for the randomness in the search process the final set of pareto efficient solutions thus corresponds to the set of pareto efficient solutions identified across all 10 seeds all experiments were run on an intel xeon 2 4 ghz with 96 gb ram running microsoft windows 10 24 cores 3 5 robustness analysis to measure the robustness of the optimized solutions we use the expected value metrics as defined in eqs 5 and 7 there are two differences here first the overflow volume and number of flooded nodes are not predicted by the emulator but are directly obtained via simulation with swmm since much fewer simulation runs are required here than in the optimization step second we simulate the solutions under a different set of rainfall events and compute the metrics under the test set of rainfall events this test set of rainfall events are generated by randomly sampling two other rainfall events from each of the eight rainfall clusters set r1 and r2 note that these events are independent from those used in the optimization process set opt the properties of these events are illustrated in fig 3 b while the overflow conditions they cause in the existing drainage system are reported in table 3 3 6 benchmarking to benchmark the results obtained through the computational framework described above henceforth referred to as r eo for robust emulation optimization we setup a simpler optimization problem where we only consider a single rainfall event under the assumption that solutions optimized for that event will be robust against other rainfall conditions this problem representing common practices in urban drainage design is hereafter referred to as design storm simulation optimization scheme ds so specifically we adopt a single rainfall event i e the 3 h 2 year return period design storm ho et al 2015 in both the sensitivity analysis and optimization step the choice of the design storm is less because of its return period but because of the flood damage it causes the design storm results in 281 756 m 3 of overflow volume and 60 flooded nodes at the peak of the flood this is comparable to the flood damage of the median representative rainfall events used in r eo allowing us to see how solutions obtained from ds so perform when rainfall properties deviate from the design storm in either directions for optimization in ds so we adopt a multi objective simulation optimization scheme in which we couple swmm with the nsga ii algorithm to solve the optimization problem as a result the definition of the three objective functions is revised to include swmm outputs directly and exclude the robustness metric i e the weights that account for expected performance the experimental setup of the nsga ii algorithm is the same for both optimization problems the solutions obtained from ds so are evaluated using the representative rainfall events labeled opt in fig 3 b and also the randomly sampled test sets of rainfall events labeled r1 and r2 in fig 3 b subsequently for comparison purposes to evaluate the search quality of r eo and ds so schemes we adopt three performance metrics commonly used in the field of multi objective optimization reed et al 2013 giuliani et al 2014 these metrics are the hypervolume indicator generational distance and additive ϵ indicator which respectively account for diversity convergence and consistency of the solution set with respect to a reference set such as the true pareto front zitzler et al 2003 when the true pareto front is unknown like in our case the best known solution set found across the optimization schemes is used as the reference set in particular the hypervolume indicator measures the volume of the objective space dominated by a solution set the generational distance measures the average euclidean distance of each point in the solution set to its closest point in the reference set finally the additive ϵ indicator measures the worst case distance in contrast to the average distance between the solution and reference set and is especially sensitive to gaps in the solution set 4 results and discussion we begin by describing the pareto efficient solutions obtained through the r eo scheme section 4 1 then we compare these solutions against those obtained through the design storm simulation optimization scheme ds so in this comparison we account for the value of the objective functions optimization metrics robustness and computational requirements section 4 2 through such multi criteria assessment we thus illustrate the limits that lie in the adoption of design storms 4 1 pareto efficient solutions the ten independent optimization runs of the r eo scheme returned a total of 765 pareto efficient solutions illustrated in fig 4 left panel the solutions exhibit a broad range of costs j c o s t up to 80 million overflow reduction j w o v e r f l o w up to 84 and peak number of flooded nodes reduction j w n o d e up to 42 we also note a strong trade off between costs and the drainage system s performance measured in terms of either j w o v e r f l o w or j w n o d e interestingly there is a kink located in the central part of the front where j w o v e r f l o w and j c o s t are equal to about 80 and 15 million the kink is attributed to the switch in investing in lids instead of pipe expansion see supplementary material this implies that for investments below the 15 million threshold it is possible to obtain major improvements in overflow reduction or number of flooded nodes reduction with marginal cost increases by expanding pipes in multiple locations beyond that threshold additional investments have diminishing returns as performance of lids is highly variable under different rainfall events and is less marked under short intense rainfall typical of a tropical climate schmitter et al 2016 since the r eo scheme is informed by an emulator it is important to re evaluate all solutions with swmm so as to characterize the error brought about by the use of a simpler model during the optimization process this re evaluation exercise yields the pareto front reported in fig 4 right panel the major difference between the two fronts stands in the gap appearing in the front re evaluated with swmm for values of overflow reduction between 51 and 60 upon closer inspection we realize that the solutions responsible for this gap did not expand two of the pipes close to the outlet of the catchment that strongly influence the model response to rainfall events in turn this suggests that an inadequate sampling in this region of the decision space may have caused the emulator to fail to identify the critical pipes responsible for reducing overflow in particular rainfall events causing the prediction error leading to the gap results also indicate that high performance solutions i e overflow reduction larger than 60 maintain consistent performance when re evaluated with swmm for these solutions we found a mean bias error mbe of 5 7 between the two fronts for solutions falling in the other group i e overflow reduction below 51 the bias grows to 15 6 while such bias may still be acceptable in light of other evaluation criteria e g robustness of solutions computational requirements this result indicates that the high dimensionality of the optimization problem has partially prevented the emulator to find low cost solutions that are truly pareto efficient 4 2 benchmarking exercise 4 2 1 objective space the first fundamental step of the benchmarking exercise is the comparison of the pareto fronts obtained by the r eo and ds so schemes for the former we use the front illustrated in fig 4 right panel that is the robust solutions re evaluated with swmm for the latter we gather the 573 solutions obtained through the optimization process and evaluate their performance via simulation with swmm across the eight rainfall events used in the robust optimization the results of this comparison illustrated in fig 5 provide two main messages first solutions from the r eo scheme largely outperform solutions from the ds so scheme when j c o s t is above 10 million this is due to the better selection and optimization of decision variables since the r eo scheme relies on multiple rainfall events in both sensitivity analysis and optimization steps notice that above 10 million the gap between r eo and ds so remains constant since investments are directed to the implementation of lids when cost goes beyond 10 million this means that lids do not contribute to the advantage that the r eo solutions have the optimal pipe configuration attained at the 10 million mark by the r eo solutions is therefore responsible for the gap we see between the two sets of solutions second when j c o s t falls below 10 million solutions from both optimization schemes are comparable naturally one reason for such result is the emulator inaccuracy discussed in section 4 1 yet this also indicates that when the investment budget is limited and the pipe expansion has only a few options it is harder to manage overflow reduction for all different rainfall events since overflow conditions occur at different locations 4 2 2 multi objective optimization metrics the quality of the pareto fronts obtained by the r eo and ds so schemes is further quantified by the three metrics introduced in section 3 6 a good front should be characterized by low values of generational distance and ϵ indicator close to 0 and a high value of the hypervolume indicator close to 1 as shown in table 4 the r eo front outperforms the ds so one with respect to all metrics for the hypervolume indicator ds so scheme has a value that is less than half the value obtained by the r eo scheme this indicates that the r eo front dominates a much larger volume of the objective space which is evident from the distance between the two fronts for values of j c o s t exceeding 10 million fig 5 this also explains the large gap in the value of the ϵ indicator which measures the worst case distance between two fronts on the other hand the average distance between the fronts i e generational distance is smaller because the fronts tend to overlap when j c o s t falls below 10 million in sum the multi objective optimization metrics indicate that the r eo pareto front is characterized by better diversity convergence and consistency 4 2 3 robustness the expected performance of ds so and r eo evaluated under the test set of rainfall events are illustrated in fig 6 while the gap between the two sets of solutions is less obvious than in fig 5 we still see that solutions above 10 million obtained from r eo are more robust against different rainfall conditions as compared to solutions from ds so in fig 7 we compare the performance for all solutions generated by the r eo and ds so schemes for each individual rainfall event in the test set using the cumulative distribution of drainage performance i e overflow reduction and peak number of flooded nodes reduction note that the cumulative distribution here refers to the weights defined in eq 6 and not probability such that rainfall events with larger flood or higher frequency have higher weights each line in the plot represents a solution so a solution has better performance if it lies as far to the left as possible or if it covers a greater area under the line this is also why we see expensive solutions in green blue lying closer to the left for example if a line passes through the point 50 0 6 it can be interpreted as a solution achieving a reduction greater than or equal to 50 for 0 6 in terms of accumulated weights of the stochastic rainfall events what is key here is that the most expensive solutions obtained from the r eo scheme are more robust against a wide range of rainfall characteristics than the expensive solutions from the ds so scheme a point illustrated by the lines in fig 7 lying closer to the left as for the cheaper solutions robustness is comparable across the two schemes as mentioned in section 4 2 1 this result is attributable to the small number of infrastructural upgrades available when dealing with a limited budget while the plots in figs 6 and 7 provide an overview of how solutions perform across multiple rainfall events they do not indicate what types of rainfall events affect robustness neither do they indicate the overall performance of the pareto front to answer this question we calculate the hypervolume indicator corresponding to each individual rainfall event and also for the weighted objectives as shown in table 5 the hypervolume obtained by the r eo scheme is higher for all events with the exception of event 4 which is the event most similar to the design storm as the events are arranged in order of increasing severity of overflow we also observe that solutions obtained from the ds so scheme perform better in rainfall events similar to the design storm e g event 3 and 5 but performance degrades as rainfall characteristics deviates from those of the design storm the ds so solutions perform the worst for event 1 which is the smallest rainfall event as they fail to eliminate the small overflow unlike solutions from the r eo scheme this highlights the importance of considering not just the design storm but also rainfall events with a broad range of intensities duration and profiles in the design of robust urban drainage systems the other performance metrics ϵ indicator and generational distance show similar results and are given in the supplementary material 4 2 4 computational requirements finally we compare the computational requirements of the ds so and r eo schemes evaluated in terms of number of swmm simulation runs required for the various steps of the design problem i e sensitivity analysis emulation and optimization in this comparison we consider a third scheme in which swmm is directly coupled with the nsga ii algorithm to solve the robust optimization problem r so naturally we do not solve such problem due to its high computational requirements but the number of swmm simulations it needs give us a clear understanding of the advantages that lie in the use of emulators as shown in table 6 the three schemes require a similar number of runs for the sensitivity analysis the increase in simulation runs as a result of considering multiple rainfall events in r eo and r so has been overcome by the modification we made to the sensitivity analysis the main computational advantage of the r eo scheme stands in the optimization phase this scheme foregoes swmm during the optimization process so it only needs the model to generate the data needed for the emulator identification 250 runs and evaluate ex post the quality of the solutions 6120 runs a number dependent on number of pareto efficient solutions obtained on the other hand the deterministic simulation optimization scheme ds so requires 500 000 runs and the robust simulation optimization scheme r so 4 000 000 in sum the r eo calls the simulator 12 times less than ds so and 91 times less than r so considering that a single swmm run in the nl tn basin takes about 5 to 10 s this translates to computational cost savings of 600 and 5000 h with respect to ds so and r so respectively for bigger catchments we would thus expect even larger computational cost savings 5 conclusions our work is motivated by the fact that relying on the information provided by design storms may lead to issues of robustness that is the inability of performing consistently under a broad range of rainfall events to resolve this we developed a computational framework that explicitly leverages the information contained in multiple rainfall events throughout the design process in particular that information is used to first select the infrastructural components in need of an upgrade via sensitivity analysis and then determine their design specifications via optimization the inevitable increase in the computational requirements is countered through the aid of a data driven emulator which replaces swmm in the optimization process we hope that our work could encourage the adoption of multiple rainfall events in the design of drainage systems motivating practicing engineers who commonly rely on design storms to shift towards a robust design approach the application of both robust emulation optimization framework and design storm simulation optimization framework on the nhieu loc thi nghe basin reveals the following insights the solutions based on the robust optimization scheme outperform those achieved by relying on the design storm this improvement is quantified by the multi objective optimization metrics measuring diversity convergence and consistency of the pareto fronts as well as the sheer value of the objective functions for example a budget of 30 million yields an overflow reduction of 85 and 50 when relying on stochastic rainfall events and design storm respectively a similar improvement is found in the reduction of number of flooded nodes in other words we can achieve better drainage performance by investing the same budget the largest improvements are found for budgets that exceed 10 million recall that the budget s range is 0 80 million there are two factors explaining this result first the emulator is not particularly accurate in reproducing swmm s outputs in the area of the decision space characterized by limited drainage performance and therefore limited budgets second a minimum investment budget is needed to effectively curb overflow across multiple rainfall events our framework yields urban drainage systems that are more robust than those based on the design storm importantly we found that the performance gap between solutions obtained from the two schemes extends further as the rainfall conditions i e intensity duration and profile deviate from those of the design storm this is true in both directions of deviation when rainfall events are smaller or larger than the design storm emulators are successful in controlling the increase in the computational requirements brought about by the use of multiple rainfall events within the optimization process in fact the use of emulators reduces the number of swmm simulation runs by a factor of about 12 with respect to the scheme based on design storms for our case study and computational resources that translates to about 600 computing hours one research area that deserves further investigation is the accuracy of emulators in particular it is important to develop techniques ensuring that the emulator s error does not excessively increase during the optimization process this could be achieved for example by updating the emulator s parameterization during the optimization process yazdi and neyshabouri 2014 in turn this would require evolution control strategies that balance exploration exploitation and diversification of the optimization process jin 2011 akhtar and shoemaker 2016 to provide greater computational savings it is also worth using emulators in sensitivity analysis as recently explored by borgonovo et al 2012 qian et al 2018 and nagel et al 2020 looking forward it is reasonable to expect that surrogate assisted optimization or data driven approaches in the broader context will gain further traction in urban drainage systems analysis as we move towards tasks requiring large computational budgets mullapudi et al 2020 one such example is the inclusion of other sources of deep uncertainty in the design of drainage systems such as urban development or shifts in hydrological extreme events due to climate change fletcher et al 2013 berndtsson et al 2019 hosseinzadehtalaei et al 2021 overall computational frameworks like this one demonstrate that there are technical pathways for combining data and physics based models e g swmm ultimately balancing computational tractability modeling accuracy and drainage performance credit authorship contribution statement jia yi ng methodology investigation visualization writing original draft samira fazlollahi supervision magali dechesne supervision writing review editing emmanuel soyeux supervision stefano galelli conceptualization supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research was supported by the veolia city modeling centre through singapore economic development board s industrial postgraduate programme project no igipvcmc1601 the authors would also like to acknowledge veolia recherche et innovation veri for their support appendix a the following measures are used to assess the accuracy of the emulators i the kling gupta efficiency kge compares the correlation variability and bias between the predicted time series from emulator and observed time series from simulator gupta et al 2009 it is defined as follows 10 k g e 1 r 1 2 α 1 2 β 1 2 where r is the correlation coefficient α the ratio between standard deviation of predicted and observed values σ p σ o and β the ratio between the mean of predicted and observed values μ p μ o a value of 1 for kge means that the predicted time series matches the observed one perfectly ii the mean bias error mbe captures the bias of prediction which is important when the emulators are used in optimization since a positive bias means that the solutions obtained are not performing as well as expected it is defined as 11 m b e 1 n j 1 n y ˆ x j y x j where y ˆ and y are the emulated and simulated output respectively and n the number of data points in the test set iii the root mean square error rmse rmse captures the magnitude of error and penalizes large deviation more 12 r m s e 1 n j 1 n y ˆ x j y x j 2 appendix b supplementary data supplementary material related to this article can be found online at https doi org 10 1016 j advwatres 2022 104335 appendix b supplementary data the following is the supplementary material related to this article mmc s1 the supplementary material includes additional modelling details swmm rainfall sensitivity analysis and results 
66,we construct a statistical mechanics for immiscible and incompressible two phase flow in porous media under local steady state conditions based on the jaynes maximum entropy principle a cluster entropy is assigned to our lack of knowledge of and control over the fluid and flow configurations in the pore space as a consequence two new variables describing the flow emerge the agiture which describes the level of agitation of the two fluids and the flow derivative which is conjugate to the saturation agiture and flow derivative are the analogs of temperature and chemical potential in standard thermal statistical mechanics the associated thermodynamics like formalism reveals a number of hitherto unknown relations between the variables that describe the flow including fluctuations the formalism opens for new approaches to characterize porous media with respect to multi phase flow for practical applications replacing the simplistic relative permeability theory while still keeping the number of variables tractable keywords multiphase flow in porous media jaynes statistical mechanics cluster entropy agiture thermodynamic description data availability no data was used for the research described in the article 1 introduction flow in porous media bear 1988 sahimi 2011 blunt 2017 feder et al 2022 is a large field that spans many disciplines from biology and chemistry to soil science geophysics materials science a central problem is to find a theoretical description of immiscible two phase flow in porous media at scales large enough for the pores to be negligible in size often referred to as the continuum or darcy scale this is neither a new problem nor are attempts at solutions new the earliest attempt at solving the problem was that of wyckoff and botset 1936 who regarded the flow of each of the immiscible fluids as one moving in a pore space reduced by the other fluids thus reducing its own ability to move this approach now known as relative permeability theory is today the standard framework used for practical applications there has been no lack of attempts to go beyond this simple theory one of the most advanced attempt to date is thermodynamically constrained averaging theory tcat hassanizadeh and gray 1990 1993a b niessner et al 2011 gray and miller 2014 based on thermodynamically consistent definitions made at the continuum scale based on volume averages of pore scale thermodynamic quantities closure relations are then formulated at the macro scale along the lines of the homogenization approach of whitaker 1986 a key strength of tcat is that all variables are defined in terms of pore scale variables a key disadvantage of tcat is that many averaged variables are produced and many complicated assumptions are needed to derive useful results barenblatt et al 2002 point out that the key assumption in relative permeability theory is that the flow is locally in a steady state even if the flow as a whole is developing this allows the central variables of that theory the relative permeability and the capillary pressure to be functions of the saturation alone they then go on to generalize the theory to flow which is locally in out of equilibrium exploring how the central variables change wang et al 2019 take these ideas further by introducing dynamic length scales due to the mixing zone variations over which the spatial averaging is done another development based on non equilibrium thermodynamics uses euler homogeneity to define the up scaled pressure from this kjelstrup et al derive constitutive equations for the flow while keeping the number of variables down kjelstrup et al 2018 2019 bedeaux and kjelstrup 2022 a challenge here is how to incorporate the structure of the fluid clusters spanning many pores there is also an ongoing effort in constructing a scaled up theory based on geometrical properties or more precisely the minkowski functionals mcclure et al 2018 armstrong et al 2019 mcclure et al there is also a class of theories based on detailed and specific assumptions concerning the physics involved an example is local porosity theory hilfer and besserer 2000 hilfer 2006 a b hilfer and döster 2010 döster et al 2012 another example is the decomposition in prototype flow deprof theory which is a fluid mechanical model combined with non equilibrium statistical mechanics based on a classification scheme of fluid configurations at the pore level valavanides et al 1998 valavanides 2012 2018 recent work hansen et al 2018 roy et al 2020 2022 explores a new approach to immiscible two phase flow in porous media based on the euler homogeneity theorem it provides a transformation from the seepage velocity i e average pore velocity of the more wetting fluid v w and the less wetting fluid v n to another pair of fluid velocities the average seepage velocity of both fluids combined v p and the co moving velocity v m the co moving velocity appears as a result of the euler homogeneity assumption the transformation is reversible knowing the average seepage velocity and the co moving velocity one can determine the seepage velocity of each fluid v p v m v w v n the mapping from the average velocity and the co moving velocity to the seepage velocity of each fluid together with the assumption that the fluids are incompressible constitutes a closed set of equations when supplemented by constitutive equations for the average velocity v p and the co moving velocity v m these two constitutive equations relate the two velocities to the driving forces the pressure and saturation gradients the constitutive equation for the average flow velocity v p relates to recent findings starting with tallakstad et al 2009a b who reported pressure drop proportional to the volumetric flow rate raised to a power 0 54 0 08 in a two dimensional model porous medium using a mixture of a compressible and an incompressible fluid under steady state conditions aursjø et al 2014 found a power law with a somewhat larger exponent using the same model porous medium but with two incompressible fluids similar results have since been observed by a number of groups see sinha et al 2017 gao et al 2020 zhang et al 2021 there has also been a considerable effort to understand these results theoretically and reproduce them numerically tallakstad et al 2009a b grøva and hansen 2011 sinha and hansen 2012 sinha et al 2013 xu and wang 2014 yiotis et al 2019 roy et al 2019 fyhn et al 2021 lanza et al 2022 roy et al cheon et al the constitutive equation for the co moving velocity v m has recently been studied by roy et al 2022 by reverse engineering published relative permeability data and by using a dynamic pore network model it turns out that this constitutive equation has a surprisingly simple form we will return to this further on in this paper we note that these two constitutive laws are based on the collective behavior of both fluids combined it would seem to be an impossible task to disassemble these two collective constitutive equations into one for each fluid however this is precisely what the mapping v p v m v w v n makes possible the theory just described is modeled on thermodynamics as presented by callen 1974 1991 which essentially consists of two ingredients 1 an energy budget i e the gibbs relation and 2 an assumption that the variables describing the energy are euler homogeneous functions in the theory of hansen et al 2018 only the second assumption is used hence the following question may be posed can one complete the analogy between immiscible fluid flow in porous media and thermodynamics finding a positive answer to this question is the aim of this paper the theory we are developing here assumes local steady state flow this corresponds to local equilibrium in thermodynamics by steady state flow we mean that the macroscopic averages characterizing the flow are well defined this does not rule out that fluid clusters move break up and merge at the pore level finding an analogy between thermodynamics and non thermal macroscopic systems is not new edwards and oakeshott in their theory of powders edwards and oakeshott 1989 had the same aim when setting up a theory for static granular media by making the assumption that all packing configurations having the same packing fraction are equally probable thus constructing a microcanonical ensemble with the packing fraction playing the role of energy an analogy with statistical mechanics was made as a result a non thermal pseudo thermodynamics would follow the ensuing theory thus had the same structure as thermodynamics but the variables have nothing to do with thermodynamics only the framework being the same in order to arrive at an analogue to thermodynamics in the present case we take as a starting point the information theoretical statistical mechanics of jaynes 1957 this generalizes the principles of statistical mechanics from being a theory specifically for mechanical systems e g assemblies of molecules to a framework that can be implemented once certain criteria are in place whatever the system in essence the jaynes approach generalizes the laplace principle of insufficient reason quoting jaynes 1957 laplace s principle of insufficient reason was an attempt to supply a criterion of choice in which one said that two events are to be assigned equal probabilities if there is no reason to think otherwise jaynes furthermore builds his approach on shannon s interpretation of entropy as a quantitative measure of what one does not know about a system the less is known the larger the entropy from a set of properties that such a function of ignorance must have shannon managed to construct a unique one fulfilling them shannon 1948 one of these properties was that knowing nothing at all this function would have its maximum when all possible states of the system would be equally probable thus generalizing the laplace principle of insufficient reason jaynes then interprets our knowledge about the system as constraints on our ignorance so that the shannon entropy should be maximized under these constraints constructing a theory along these principles for immiscible two phase flow in porous media leads to a pseudo thermodynamics describing the flow this entails finding powerful relations between the variables describing the flow furthermore it introduces new variables one such new variable is the cluster entropy associated with the shapes of the fluid clusters this allows us to define an agiture essentially measuring the level of agitation of the two fluids we have chosen the name agiture which is a contraction of the two words agitation and temperature to emphasize that it is not a temperature in the usual sense another variable is the flow derivative which is the conjugate of the saturation this variable is an analogue of the chemical potential in ordinary thermodynamics a third new variable is the flow pressure which is conjugate to the porosity furthermore statistical mechanics is more powerful than thermodynamics in that all of thermodynamics may be derived from statistical mechanics but not vice versa this is also the case here for example fluctuations in the macroscopic variables are accessible via statistical mechanics only we review in the next section the euler homogeneity approach of hansen et al 2018 here we describe the system we consider defining central concepts in particular we derive the two way mapping v p v m v w v n and discuss the co moving velocity v m in section 3 we construct the jaynes statistical mechanics for immiscible flow in porous media and from this a pseudo thermodynamics in order to effectuate these ideas in practice we need to define how we measure the relevant variables this means defining averaging procedures which should be done both in space and in time as already pointed out by mcclure et al 2021a b we go as far in this section as to define and exemplify the equivalents of the maxwell relations in ordinary thermodynamics the next section 4 concerns saturation and porosity fluctuations in section 5 we discuss the relation between the agiture flow derivative and the pressure gradient we do this by considering the internal balance in a porous medium having two regions with different matrix properties we end the paper by a discussion and conclusion section here we list a number of questions that remain open 2 review of euler homogeneity approach before we turn to constructing the statistical mechanics we review the euler homogeneity approach to immiscible and incompressible two phase flow in porous media first introduced by hansen et al 2018 2 1 representative elementary area we imagine a porous medium plug as shown in fig 1 it is homogeneous i e the local porosity and permeability fluctuate around well defined averages the sides of the plug are sealed while the two ends remain open we ignore gravity a mixture of two immiscible fluids are injected through the lower end and fluids are drained at the upper end flow into the plug is constant leading to steady state flow inside the plug erpelding et al 2013 due to the sealed sides of the plug the average flow direction is along the symmetry axis of the plug we now imagine a plane cutting though the plug orthogonally to the average flow direction in this plane we choose a point around this point we choose an area a e g bounded by a circle as shown in fig 1 we assume that the area is large enough for averages of variables characterizing the flow are well defined but not larger furthermore we assume the linear size of the area to be larger than any relevant correlation length in the system this defines the representative elementary area rea bear and bachmat 2012 at the chosen point we may do the same at any point in the plane and we may do this at any other such plane 2 2 some definitions the rea has an area a part of this area is covered by the matrix material whereas another part is covered by the pores this latter area a p we will refer to as the transverse pore area the porosity of the rea is then given by 1 ϕ a p a there is a volumetric flow rate through the rea shown in fig 1 q p the seepage velocity of the fluids passing through the rea is then 2 v p q p a p the flow consists of a mixture of two incompressible fluids one being more wetting with respect to the matrix than the other one we will refer to this fluid as the wetting fluid the less wetting fluid we will refer to as the non wetting fluid each of them is associated with a volumetric flow rate q w and q n and we have 3 q p q w q n the transverse pore area of the rea may also be divide into an area associated with the wetting fluid a w and an area associated with the non wetting fluid a n so that 4 a p a w a n we may define a seepage velocity for each of the two fluids 5 v w q w a w 6 v n q n a n we define the saturations of the two fluids passing through the rea as 7 s w a w a p 8 s n a n a p we may now combine these eqs 2 8 to express the average seepage velocity as 9 v p s w v w s n v n we note that could have made these definitions based on the density of the two fluids ρ w and ρ n rather than volumes the porosity ϕ saturations s w and s n and the seepage velocities v p v w and v n are variables that may be associated with the chosen point surrounded by the rea since there for every point in the porous medium one may associate an rea these variables which do not depend on the size or shape of the rea may be seen as continuous fields the variables we have defined should be well defined this is only possible if they not fluctuating too strongly so that it is possible to measure their averages by this we mean that the average does not depend on the number of samplings flooding processes typically generate fractal structures feder et al 2022 there are however length scales associated with the mechanisms controlling these structures måløy et al 2021 and beyond the largest of these length scales they cease to be fractal the same is true for steady state flow which we consider here we expect self averaging to take place beyond these length scales i e the relative strength of the fluctuations with respect to their averages shrinks with increasing size of the system hence we assume the plug and the reas to be large enough for the fluctuations not to dominate that such a combination of sizes is possible to find has recently been investigated by fyhn et al using a dynamic pore network model in the discussion that follows we need to assign another property to the variables beyond being self averaging we need them to be state variables by this we mean that they depend on the flow properties there and then and not the history of the flow erpelding et al 2013 studied this question experimentally and computationally finding that this is indeed so a last aspect to be considered is that of hysteresis there may indeed be hysteresis in the state variables knudsen and hansen 2006 studied immiscible two phase flow under steady state conditions using a dynamic pore network model they found that there are two transitions between two phase flow and single phase flow when the wetting saturation is the control parameter the transition between only the non wetting fluid moving at low saturation to both fluids moving at higher saturation does not show any hysteresis with respect to which way one passes through the transition on the other hand the transition between only the wetting fluid moving at high saturation and both fluids moving at lower saturation does show a strong hysteresis see figure 2 in knudsen and hansen 2006 this hysteresis is probably caused by this transition being equivalent to a first order or a spinodal phase transition it is well known that such transitions in ordinary equilibrium thermodynamics lead to hysteretic behavior in the state variables hysteretic behavior signals that there are regions of parameter space where the macroscopic state variables are multi valued hence the underlying microscopic physics has more than one locally stable mode 2 3 relations between the seepage velocities hansen et al 2018 made the weak assumption that the volumetric flow rate through the rea is a homogeneous function of order one that is if we scale a λ a where λ is a scale factor the volumetric flow rate would scale in the same way i e 10 q p λ a w λ a n λ q p a w a n we have here assumed that a w and a n are independent variables this means that we may change the area a of the rea by changing a w while keeping a n fixed or changing a n while keeping a w fixed this makes a and a p defined in eq 4 dependent variables we refer to hansen et al 2018 for details around this by taking the derivative of eq 10 with respect to λ and then setting λ 1 we find 11 q p a w a n q p a w a n a w q p a n a w a n see section 7 2 in hansen et al 2018 for a step by step demonstration of how these derivatives are done for a capillary fiber bundle model by invoking eqs 2 7 and 8 we find 12 v p q p a p s w q p a w a n s n q p a n a w s w v ˆ w s n v ˆ n where we have defined 13 v ˆ w q p a w a n 14 v ˆ n q p a n a w we will refer to v ˆ w and v ˆ n as the thermodynamic velocities we now change variables from a w a n being independent to s w a p being the independent variables we then have a w s w a p s w a p and a n s w a p 1 s w a p we find 15 a w a n a p s w s n a p s w a p 16 a n a w a p s w s w a p s w a p combining these two expressions with the definitions of the thermodynamic velocities 13 and 14 gives 17 v ˆ w v p s n d v p d s w 18 v ˆ n v p s w d v p d s w where we note that s n v ˆ w v ˆ n and v p are all function of s w and not of a p we combine eqs 9 and 12 19 v p s w v w s n v n s w v ˆ w s n v ˆ n this does not imply that v w v ˆ w and v ˆ n v n rather the most general relation between them is 20 v ˆ w v w v m s n 21 v ˆ n v n v m s w where v m is the co moving velocity hansen et al 2018 roy et al 2020 2022 combining these two expressions with eqs 17 and 18 expresses the physical seepage velocities v w and v n in terms of the average seepage velocity v p and the co moving velocity v m 22 v w v p s n d v p d s w v m 23 v n v p s w d v p d s w v m we may invert eqs 22 and 23 finding 24 v p s w v w s n v n 25 v m s w d v w d s w s n d v n d s w these four equations 22 to 25 constitute a two way mapping v p v m v w v n this means that having constitutive equations for v p and v m makes it possible to derive constitutive equations for v w and v n in other theories such as relative permeability theory only the mapping v w v n v p is given making it impossible to start from a constitutive equation for v p how to measure these variables from experimental data see roy et al 2022 who studied the co moving velocity in detail using relative permeability data from the literature and from analyzing data obtained using a dynamic pore network model they found that the co moving velocity takes the very simple form 26 v m a b d v p d s w where a and b are coefficients dependent on the capillary number it is still an open question as to why it has this simple form we will in the following be able to give a partial answer with these equations the assumption that the two fluids are incompressible and constitutive equations for v p and v m we have a closed set of equations describing the flow 3 statistical mechanics 3 1 fluid configurations in a plug we show in fig 1 the porous plug that we discussed in section 2 1 we will center our discussion on this plug in the following we assume that there is a volumetric flow rate q p passing through the plug under steady state conditions this volumetric flow rate may be split into a wetting and a non wetting volumetric flow rate q w and q n so that q p q w q n we use script characters to distinguish the flow through the entire plug from the flow through an rea we show in fig 2 three planes orthogonal to the symmetry axis of the plug i e orthogonal to the average flow direction we introduce a coordinate z along the symmetry axis of the plug measuring the distance from the plug s lower boundary to any given plane as the sides of the plug are sealed we have that q p is the same through the three orthogonal planes or any other such orthogonal plane the volumetric flow rate q p is a conserved quantity as we move along the z axis on the other hand the volumetric flow rates of each of the two fluids q w and q n are not conserved only their averages over several orthogonal planes will remain constant one may imagine the fluids being layered in the flow direction to realize this we also note that the transverse pore area a p will fluctuate from plane to plane due to fluctuations in the local porosity the transverse area associated with the wetting fluid a w will also fluctuate for two reasons a p fluctuates but more importantly because the fluid clusters fluctuate we pick one of the planes at z z 0 we introduce a two dimensional grid that divides the plane into voxels each voxel is assigned a set of parameters its area its transverse pore area the area covered by the wetting fluid and volumetric flow rate through it the values assigned to the voxels which are coarse grained at the scale of the voxel are the result of physical fluid configurations the respect the underlying hydrodynamics and thermodynamics for example these values may be the values assigned to the nodes in a lattice boltzmann model system or it may be the status of the links in a dynamic pore network model it may also be the status of the pixels in transversal ct scan through a porous plug this information assigned to each voxels in the plane at z 0 at time t we will refer to as the fluid configuration x x z 0 t we now imagine a stack of planes we assume the neighboring planes are a distance d z 0 apart in order to determine the flow configurations in each plane in the stack it is not enough to know it at entry plane of the stack z z 0 the reason for this is that we do not know the cluster structure inside the stack however the configurations in each plane are still measurable if we move through the plug along the z axis where z 0 z z 1 and the plug is long enough we will explore the space of possible configurations x we may do this at a fixed time t hence moving infinitely fast or at a finite speed along the z axis so that time is running we will in both cases explore the space of possible configurations if we choose a given plane and then average over the configurations that pass it we will not be averaging over the matrix structure which will be fixed in the plane however if we imagine an ensemble of plugs each being a realization of the same statistical pore structure we will eventually see all configurations x also in this case this leads us directly to defining a configurational probability density p x we have also in the process sketched out an ergodicity assumption the probability distribution for configurations in a given plane measured over an ensemble of plugs is the same as measuring it along different planes in a given plug time seems to have fallen out of the description time keeps track of the motion of each lagrangian fluid element as we illustrate in fig 2 this is more information than we need all we need is to know the fluid configurations in the planes for this purpose the z axis acts as an effective time axis hence the reference to an equivalent to the ergodic hypothesis which normally is a statement about time averaging vs ensemble averaging since we cannot reconstruct the configurations inside the stack given a knowledge of the configuration at the entry plane at z 0 one may be inclined to reject the idea to interpret the z axis as an effective time direction we point out that the same type of problem is encountered in relativistic mechanics of charged particles in strong fields where the position vs time world lines of the particles are not single valued functions of time feynman 1948 hansen and ravndal 1981 this means that it is not possible to reconstruct the later motion of such particles from knowing their configuration at a given time statistical mechanics constitutes a calculational formalism based on the knowledge of the probability distribution for configurations the jaynes maximum entropy principle provides a recipe for determining the configurational probability density jaynes 1957 central to this principle is the definition of a function that quantitatively measures what we do not know about our system this function is the shannon entropy shannon 1948 we construct it for the present system as 27 σ p l a n e d x p x ln p x where the integral is over all hydrodynamically possible fluid configurations in the plane we focus on the task is to calculate this entropy and from it determine p x we will refer to the entropy defined in eq 27 as the cluster entropy we have chosen the name as it reflects the cluster structure that the fluids are making we emphasize that the cluster entropy is not the thermodynamic entropy defined in other work such as kjelstrup et al 2018 2019 bedeaux and kjelstrup 2022 whereas there is production of thermodynamic entropy in the plug as we are dealing with a driven system there is no production of cluster entropy as we are dealing with steady state flow the fluid states x are not discrete rather they form a continuum hence we use an integral in eq 27 there are mathematical problems related to defining the measure d x is this integral however these difficulties we presume are of the same type encountered in ordinary statistical mechanics we will not delve into these problems here but rather just note their existence and that they have been solved in ordinary statistical mechanics 3 2 rea fluid configurations we have in section 2 1 defined the rea as for the entire plug we may define a configuration x for the rea as a hydrodynamically possible configuration within the area a the configuration in the plane where the rea sits is x hence x is a subset of x we also define the fluid configuration in the rest of the plane that is not part of the rea x r we will refer to this part of the plane as the reservoir hence we have that 28 x x x r a central question is now how independent are the configurations x and x r if they are independent we may focus entirely on the rea configurations x as we may write the configurational probability for the entire plane as 29 p x p x p r x r where p x is the configurational probability for the rea and p r x r is the configurational probability for the reservoir fyhn et al have recently studied the validity of eq 29 in a two dimensional dynamic pore network model by changing the size of the two dimensional plug while keeping the size of the rea fixed they checked whether the statistical distributions of q p and a w were dependent on the size of the plug only a very weak dependency was found which decrease with size it is therefore realistic to assume eq 29 to be valid for large enough plugs and reas we proposed in section 3 1 to view the average flow direction through the plug the z axis as a playing the role of a time axis averaging over time thus corresponds to averaging over a stack of reas as shown in fig 3 when we in the next section refer to averaging it is averaging over this stack we mean we may treat the interactions between the rea and the reservoir in different ways we may remove the rea stack from the plug and treat it as a closed off system this amounts to treating the rea as a plug on its own we may leave it in the original plug allowing it to freely interact with the reservoir we may allow the stack to interact fully with the reservoir but in such a way that the amount of wetting fluid is kept constant it is not possible to implement such constraints experimentally nor computationally but theoretically it is the same goes for the transverse pore area we may keep it constant theoretically but not experimentally or computationally nevertheless we will see examples of such ensembles in the following as they correspond to different control parameters 3 3 jaynes maximum entropy approach following the jaynes recipe we need to maximize the cluster entropy in the rea which is 30 σ d x p x ln p x under the constraints of what we know about the system the probability density p x is defined in eq 29 there are three variables that we measure the volumetric flow rate through the rea q p and the transverse pore area covered by the wetting fluid a w and the transverse pore area a p all three of them are averages over fluctuating quantities when performed as shown in fig 3 i e we average over a stack of reas the average of the volumetric flow rate is 31 d x p x q p x q p where the q p x is associated with fluid configuration x likewise the average wetting area is given by 32 d x p x a w x a w where a w x is the wetting area associated with configuration x the third variable we consider is the average transverse pore area 33 d x p x a p x a p all three variables q p a w and a p are extensive in the area of the rea a the aim now is to determine p x based on the knowledge of these variable averages following jaynes we use the lagrangian multiplier technique we start by constructing the lagrangian which we then will maximize 34 l d x p x ln p x λ 1 d x p x λ q q p d x p x q p x λ w a w d x p x a w x λ a a p d x p x a p x with the aim to determine p x we assume that the three lagrange multipliers λ q λ w and λ a are intensive in the area of the rea a the lagrange multiplier λ on the other hand is extensive in the area a it follows that the cluster entropy σ is extensive in a necessary conditions for maximizing the lagrangian 34 are 35 l p x 0 36 l λ 0 37 l λ q 0 38 l λ w 0 39 l λ a 0 one may ask why not additional information is included here such as the average wetting flow rate q w the answer to this lies in the euler theory hansen et al 2018 there are three independent variables in the problem for which we may fix their averages we choose here q p a w and a p other averages will then follow from the formalism we are about to develop the thermodynamic formalism we therefore are about to develop will then concern the thermodynamic velocities eqs 13 and 14 we will then need the co moving velocity v m to translate the results into the physical velocities eq 35 gives 40 p x e 1 λ e λ q q p x λ w a w x λ a a p x and the normalization condition eq 36 gives 41 e λ 1 d x e λ q q p x λ w a w x λ a a p x z where we have defined the partition function z z λ q λ w λ a we are now in a position to calculate the cluster entropy combining eqs 30 and 40 42 σ p x ln p x ln z λ q λ w λ a λ q q p λ w a w λ a a p we note that 43 q p λ q λ w λ a ln z λ q λ w λ a 44 a w λ q λ w λ a ln z λ w λ q λ a 45 a p λ q λ w λ a ln z λ a λ q λ w these three equations may be solved to give λ q λ w and λ a as functions of the three variables we know q p a w and a p they also make eq 42 a triple legendre transformation changing the control variables λ q q p and λ w a w and λ a a p hence the control variables of the flow entropy are σ σ q p a w a p 46 σ q p a w a p p x ln p x ln z λ q λ w λ a λ q ln z λ q λ w λ a λ w ln z λ w λ q λ a λ a ln z λ a λ q λ w we define a new variable q g q g λ q λ w λ a through the equation 47 z λ q λ w λ a e λ q q g λ q λ w λ a it plays the role corresponding to that of a free energy in ordinary thermodynamics our next step is to invert eq 42 so that q p becomes a function of σ rather the other way round that is we transform σ q p a w a p to q p σ a w a p hence we may write eq 42 or 46 as 48 q g λ q λ w λ a q p σ a w a p σ 1 λ q a w λ w λ q a p λ a λ q where we have also used eq 47 we see that 49 q p σ a w a p σ a w a p 1 λ q hence we note that the following equation which forms part of the right hand side of eq 48 constitutes a legendre transformation 50 q f λ q a w a p q p σ a w a p σ 1 λ q q p σ a w a p σ q p σ a w a p σ a w a p here q f corresponds to another free energy in ordinary thermodynamics we rewrite eq 48 as 51 q g λ q λ w λ a a p λ a λ q q f λ q a w a p a w λ w λ q the left hand side of this equation constitutes a legendre transform 52 q m λ q λ w a p q g λ q λ w λ a a p λ q λ a as we have 53 q g λ q λ w λ a λ a λ q λ q λ w a p hence we have now transformed eq 48 to 54 q m λ q λ w a p q f λ q a w a p a w λ w λ q 3 4 agiture flow derivative and flow pressure let us now define three new intensive variables built from the lagrange multipliers λ q λ w and λ a 55 θ 1 λ q 56 π λ a λ q 57 μ λ w λ q the first one θ by its resemblance to temperature in ordinary statistical mechanics we will name the agiture the unit of the agiture is the same as volumetric flow rate however it is an intensive variable the second one π we will name the flow pressure this variable is the conjugate of the flow area a p 58 π q f θ a w a p a p θ a w q p σ a w a p a p σ a w the unit of π is inverse velocity referring to eq 1 we see that a p is a measure of the porosity ϕ and π is therefore a velocity variable conjugate to the porosity the third variable eq 57 we name the flow derivative we will explain the name in the next section as π its unit is that of a velocity it is the conjugate of the transversal wetting fluid area a w 59 μ q f θ a w a p a w θ a p q p σ a w a p a w σ a p playing a role similar to a chemical potential in ordinary statistical mechanics through eq 7 we see that the flow derivative is the conjugate of the wetting saturation s w 3 5 connection with euler homogeneity approach we need to define one more variable 60 q n σ μ a p q m θ μ a p σ θ μ a p θ where 61 σ θ μ a p q m θ μ a p θ μ a p combining this definition with eqs 50 and 54 gives 62 q n σ μ a p q p σ a w a p a w μ we use the fact that both q n σ μ a p and q p σ a w a p are homogeneous functions of order one in the extensive variables σ a w and a p 63 q n λ σ μ λ a p λ q n σ μ a p 64 q p λ σ λ a w λ a p λ q p σ a w a p we now set λ 1 a p and combine these two expressions with eq 62 finding 65 a p q n σ μ 1 a p q p σ s w 1 a w μ where we also have used eq 7 and we have defined the cluster entropy density 66 σ σ a p we now divide eq 65 by a p noting that 67 q n σ μ 1 v n σ μ 68 q p σ s w 1 v p σ s w i e v n and v p are velocities we recognize v p q p a p from eq 2 as the average seepage velocity of the two fluids eq 65 then takes on the form 69 v n σ μ v p σ s w s w μ let us now go back to eq 59 and use scaling relation 64 to find 70 v p σ s w s w σ μ this expression is the reason why we name μ the flow derivative we now compare these two eqs 69 and 70 to eq 21 which we reproduce here 71 v ˆ n v p s w d v p d s w this equation is one of the central results derived by hansen et al 2018 by comparison we identify 72 v n v ˆ n where the thermodynamic velocity of the non wetting fluid v ˆ n is defined in eq 14 eq 69 may be written 73 v ˆ n σ μ v p σ s w σ μ s w σ μ μ and we have that 74 s w σ μ v ˆ n σ μ μ σ these two equations are our central result it demonstrates that the thermodynamic velocity of the non wetting fluid is the legendre transform of the average seepage velocity with respect to the wetting saturation and that the wetting saturation is minus the derivative of the non wetting thermodynamic velocity with respect to the flow derivative eq 21 was derived based on the volumetric flow rate being a homogeneous function of the first kind in the transverse pore area now we see this equation as a fundamental equation resulting from an underlying statistical mechanics with variables θ σ and μ s w and π ϕ forming conjugate pairs 3 6 partition functions the partition function is given by 75 z θ μ π d x e q p x θ μ a w x θ π a p x θ we may split the integration over states x into an integral over a p and then over all states x that has a given a p 76 z θ μ π e q g θ μ π θ 0 a d a p e π a p θ z θ μ a p where we have defined 77 z θ μ a p d x δ a p x a p e q p x θ μ a w x θ 1 a d x δ ϕ x ϕ e q p x θ μ a w x θ and where δ is the dirac delta function we have used that a ϕ a p see eq 1 we have that 78 z θ μ a p 1 a e q m θ μ a p θ where q m θ μ a p is defined in eq 62 we may now write partition function z θ μ a p in eq 77 as 79 z θ μ a p 0 a p d a w e μ a w θ z θ a w a p where we have defined 80 z θ a w a p d x δ a w x a w δ a p x a p e q p x θ d x a p a δ s w x s w δ ϕ x ϕ e q p x θ which we may write as 81 z θ a w a p 1 a p a e q f θ a w a p θ we may repeat this procedure one more time we rewrite the partition function z θ a w a p eq 80 as 82 z θ a w a p d q p e q p θ z q p a w a p where 83 z q p a w a p d x δ q p x q p δ a w x a w δ a p x a p this microcanonical partition function as q p is the control variable is also the unnormalized density of states with respect to the variables q p a w and a p it demonstrates that all states x with the same q p a w and a p are equally probable this brings us back to our starting point the entropy has its maximum when all states that comply with the constraints 31 32 and 33 are equally probable 3 7 co moving velocity the co moving velocity which is defined in eqs 20 and 21 constitutes the bridge between the seepage velocities eqs 5 and 6 and the thermodynamics velocities eqs 13 and 14 by combining the defining equations for the co moving velocities with the two equations ensuing from the euler scaling assumption for the volumetric flow rate we express the seepage velocity of the two fluid species in terms of the average seepage velocity and the co moving velocity in eqs 22 and 23 combining eq 23 with eq 74 based on statistical mechanics we find a consistent structure 84 v n σ μ v p σ s w σ μ s w σ μ μ v m σ μ when assuming that v n v n σ μ and v m v m σ μ thus we have expressed the physical seepage velocity for the non wetting fluid within the pseudo thermodynamic formalism we are developing the corresponding physical seepage velocity for the wetting fluid may then be found e g by using eq 9 the phenomenological form found by roy et al 2022 eq 26 is consistent with the assumption for v m as eq 26 then takes the form 85 v m σ μ a σ b σ μ with 86 b σ v m σ μ μ σ we note that the dependence of a and b on the capillary number is consistent with the two coefficients depending on the cluster entropy density σ why v m is linear in μ is not known 3 8 maxwell relations we now see that the euler homogeneity approach of hansen et al 2018 was just the tip of an iceberg having anchored the approach in a statistical mechanics we now have access to a rich formalism that parallels thermodynamics for example we find the equivalents of the maxwell relations in ordinary thermodynamics we derive just one in the following we have that 87 q f θ a w a p θ a w a p σ we combine this equation with eq 59 taking the cross derivatives and finding 88 σ a w θ a p μ θ a w a p which may be written as 89 σ s w θ μ θ s w 4 fluctuations and agiture our starting point are eqs 41 and 47 i e 90 q g θ μ π θ ln z θ μ π θ ln d x e q p x θ μ a w x θ π a p x θ this immediately gives 91 q g θ μ π μ θ π 1 z d x a w x e q p x θ μ a w x θ π a p x θ a w taking the derivative a second time with respect to μ gives 92 θ 2 q g θ μ π μ 2 θ π 1 z d x a w 2 x e q p x θ μ a w x θ π a p x θ 1 z d x a w x e q p x θ μ a w x θ π a p x θ 2 a w 2 a w 2 δ a w 2 where we have defined the fluctuations δ a w 2 we now combine eqs 1 and 7 to find 93 a w a a p a a w a p a ϕ s w this allows us to transform eq 92 into 94 δ ϕ s w 2 θ a ϕ s w μ θ π we see that the agiture θ seems proportional to the fluctuations δ ϕ s w 2 however due to the term ϕ s w μ θ π the relation between them is complex we may calculate the porosity fluctuations by taking the partition function z θ μ π eq 75 as starting point we find 95 δ ϕ 2 θ a ϕ π θ μ where 96 δ ϕ 2 1 a 2 a p x 2 a p 2 we note that the porosity field ϕ is a property of the matrix and not the flow hence eq 95 gives a direct link between the agiture θ and the flow pressure π 97 θ a δ ϕ 2 π ϕ θ μ 5 conditions for steady state in a heterogeneous plug we consider in the following the conditions for steady state in a heterogeneous plug we show in fig 4 a plug that is divided into a region a and a region b which have different matrix properties the difference may for example be that the wetting properties of the matrix in region a differ from those of region b the full system which consists of both regions a and b is a closed system we will in the following focus on the four quantities q p a w a p and σ that describe the flow in the plug strictly speaking we should change our notation e g q p q p since we are considering the entire plug however in order to avoid complicating the notation and therefore making the material less accessible we refrain from making the change these four quantities are extensive i e additive this means that we may express them in terms of the two regions a and b we have 98 q p q p a q p b 99 σ σ a σ b 100 a w a w a a w b 101 a p a p a a p b we write q p in terms of the control variables σ a w and a p 102 q p σ a w a p q p a σ a a w a a p a q p b σ b a w b a p b since the total volumetric flow rate is conserved in the plug we must have that fluctuations in it must be zero i e 103 δ q p δ q p a δ q p b 0 the fluctuations in q p a and q p b come from fluctuations in σ a and σ b a w a and a w b and a p a and a p b we express δ q p a and δ q p b in terms of the fluctuations of these variables 104 δ q p a σ a a w a a p a q p a σ a a w a a p a σ a a w a a p a δ σ a q p a σ a a w a a p a a w a σ a a p a δ a w a q p a σ a a w a a p a a p a σ a a w a δ a p a likewise we have 105 δ q p b σ b a w b a p b q p b σ b a w b a p b σ b a w b a p b δ σ b q p b σ b a w b a p b a w b σ b a p b δ a w b q p b σ b a w b a p b a p b σ b a w b δ a p b there is no production of cluster entropy as this entropy is at a maximum however cluster entropy may move between regions a and b hence we have 106 δ σ δ σ a δ σ b 0 furthermore we keep the control variables a w and a p fixed this is of course not possible experimentally however as a theoretical concept it is permissible hence we have that 107 δ a w δ a w a δ a w b 0 108 δ a p δ a p a δ a p b 0 we now combine eqs 103 108 to find 109 δ q p σ a w a p q p a σ a a w a a p a q p b σ b a w b a p b δ σ a q p a a w a σ a a p a q p b a w b σ b a p b δ a w a q p a a p a σ a a w a q p b a p b σ b a w b δ a p a 0 we now assume that the cluster entropy fluctuations δ σ a are independent of the fluctuations in δ a w a and δ a p a this leads to 110 θ a q p a σ a a w a a p a σ a a w a a p a q p b σ b a w b a p b σ b a w b a p b θ b where we have used eqs 49 and 55 if we now furthermore assume that the fluctuations in δ a w a and δ a p a are uncorrelated we find 111 μ a q p a σ a a w a a p a a w a σ a a p a q p b σ b a w b a p b a w b σ b a p b μ b and 112 π a q p a σ a a w a a p a a p a σ a a w a q p b σ b a w b a p b a p b σ b a w b π b these three criteria for steady state flow eqs 110 111 and 112 are analogous to the criteria for two open systems in thermal contact and in equilibrium here the temperature pressure and the chemical potential must be the same it is important to point out the following in ordinary thermodynamics the rule is that the conjugate of a conserved quantity is constant in a heterogeneous system at equilibrium this is e g the argument for the temperature being the same everywhere in the system at equilibrium as the entropy is at a maximum this is the same argument as we have used here which leads to eq 110 however consider two magnets with different magnetic susceptibilities in contact which is placed in a uniform magnetic field h the conjugate of the magnetization m which is the magnetic flux b is not equal in the two magnets in contact b a b b what goes wrong here is that it is not possible to let magnetization fluctuate between the two magnets so that its sum is constant i e δ m a δ m b while simultaneously keeping the total internal energy and the total entropy constant i e δ u δ u a δ u b 0 and δ s δ s a δ s b 0 in our system steady state two phase flow in a porous medium the following question then becomes central is it possible to fulfill δ q p 0 and δ σ 0 and at the same time have δ a w a δ a w b and δ a p a δ a p b the answer to this question is not obvious only experiments or computations on models may provide an answer if the answer is no only eq 110 will be valid and not eqs 111 and 112 6 discussion and conclusion a central problem in the physics of porous media is how to scale up knowledge of the physics at the pore level to the continuum scale often referred to as the darcy scale where the pores are negligible in size the notion of up scaling is of course only meaningful if we know which coarse scale physics we are up scaling to and the traditional relative permeability theory has well known weak points the theory of hansen et al 2018 is a radically different approach to the coarse scale physics this theory is formally similar to some parts of thermodynamics but it is the flow rates and the relations between flow rates that are the central players in its core the theory is based on the volumetric flow rate being an euler homogeneous function in the present paper we have developed a statistical mechanics framework for immiscible incompressible two phase flow in this framework total flow rate plays the same role as energy in ordinary statistical mechanics and local steady state flow plays the role of local thermodynamic equilibrium we have shown that the pseudo thermodynamics that follows from the statistical mechanics framework extends the earlier theory of hansen et al 2018 rendering it a complete pseudo thermodynamics in the spirit of edwards and oakeshot s pseudo thermodynamics for powders edwards and oakeshott 1989 in the same way that ordinary statistical mechanics serves as a tool for calculating macro scale properties from known molecular scale physics the present statistical mechanics links the pore scale hydrodynamic description to a continuum scale physics thus solving the up scaling problem the key link is the partition function z θ μ π defined in eq 41 the integral is over all physical fluid configurations and the physics sits in the measure d x over configurations and pore structure the up scaling from the intermittent flow of fluid clusters through pore space to a description with a small number of continuum scale variables admits an immense level of ignorance this ignorance is reflected in the pseudo thermodynamics as the cluster entropy we call the conjugate variable to this cluster entropy the agiture the agiture measure the level of agitation in the flow typically a high agiture is associated with high flow rates in the same way high temperature is associated with high energies in thermal systems we have not proposed here any technique as to how the agiture θ may be measured or controlled experimentally or computationally the flow pressure π seems also difficult to measure measuring the flow derivative is on the other hand seemingly easier to measure in terms of the average seepage velocity and the saturation it may be written 113 μ v p σ s w s w σ since we are assuming steady state flow the cluster entropy is at a maximum and therefore constant we also note that we have used five different ensembles in this work where control parameters are respectively θ μ π θ μ a p σ μ a p θ a w a p σ a w a p the first of these ensembles is easily realizable experimentally as this describes an rea communicating freely with the rest of the porous medium the second one with a p controlled is feasible e g by using 3d printing techniques to construct the porous medium the two last three ensembles must be seen as theoretical constructs we note however that this is standard procedure in thermodynamics in that one always starts with the gibbs relation which relates variations in the internal energy to variations in the extensive variables irrespective of whether this ensemble is accessible experimentally or not we see that a steady state condition in a heterogeneous porous medium such as that shown in fig 4 is that the agiture is constant throughout the entire system eq 110 on the other hand the two additional equilibrium conditions eqs 111 and 112 hinge on additional assumptions that need to be verified experimentally or computationally in light of the above discussion verifying the validity of eq 111 is the easier one of the three equations the probability to find a flow configuration p x in the rea which is the central to the theory we present here it was emphasized at the beginning of section 3 3 that the fluid configuration x refers to the configuration in the rea not the entire plane cutting through the plug x x x r it is crucial for the theory that p x does not depend on the properties of the entire plug recent numerical work by fyhn et al indicates that this is indeed correct given all these caveats and open question the fact remains that the framework we have presented here opens up for viewing immiscible two phase flow in porous media in a different way than before we have here divided the problem into 1 constructing a framework by which the concepts that are necessary are put in place and 2 connecting these concepts to the underlying fluid dynamics and thermodynamics this paper accomplishes the first goal declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests alex hansen reports financial support was provided by research council of norway alex hansen reports a relationship with research council of norway that includes funding grants acknowledgments the authors thank dick bedeaux carl fredrik berg daan frenkel hursanay fyhn signe kjelstrup marcel moura knut jørgen måløy håkon pedersen subhadeep roy ole torsæter and øivind wilhelmsen for interesting discussions this work was partly supported by the research council of norway through its center of excellence funding scheme project number 262644 
66,we construct a statistical mechanics for immiscible and incompressible two phase flow in porous media under local steady state conditions based on the jaynes maximum entropy principle a cluster entropy is assigned to our lack of knowledge of and control over the fluid and flow configurations in the pore space as a consequence two new variables describing the flow emerge the agiture which describes the level of agitation of the two fluids and the flow derivative which is conjugate to the saturation agiture and flow derivative are the analogs of temperature and chemical potential in standard thermal statistical mechanics the associated thermodynamics like formalism reveals a number of hitherto unknown relations between the variables that describe the flow including fluctuations the formalism opens for new approaches to characterize porous media with respect to multi phase flow for practical applications replacing the simplistic relative permeability theory while still keeping the number of variables tractable keywords multiphase flow in porous media jaynes statistical mechanics cluster entropy agiture thermodynamic description data availability no data was used for the research described in the article 1 introduction flow in porous media bear 1988 sahimi 2011 blunt 2017 feder et al 2022 is a large field that spans many disciplines from biology and chemistry to soil science geophysics materials science a central problem is to find a theoretical description of immiscible two phase flow in porous media at scales large enough for the pores to be negligible in size often referred to as the continuum or darcy scale this is neither a new problem nor are attempts at solutions new the earliest attempt at solving the problem was that of wyckoff and botset 1936 who regarded the flow of each of the immiscible fluids as one moving in a pore space reduced by the other fluids thus reducing its own ability to move this approach now known as relative permeability theory is today the standard framework used for practical applications there has been no lack of attempts to go beyond this simple theory one of the most advanced attempt to date is thermodynamically constrained averaging theory tcat hassanizadeh and gray 1990 1993a b niessner et al 2011 gray and miller 2014 based on thermodynamically consistent definitions made at the continuum scale based on volume averages of pore scale thermodynamic quantities closure relations are then formulated at the macro scale along the lines of the homogenization approach of whitaker 1986 a key strength of tcat is that all variables are defined in terms of pore scale variables a key disadvantage of tcat is that many averaged variables are produced and many complicated assumptions are needed to derive useful results barenblatt et al 2002 point out that the key assumption in relative permeability theory is that the flow is locally in a steady state even if the flow as a whole is developing this allows the central variables of that theory the relative permeability and the capillary pressure to be functions of the saturation alone they then go on to generalize the theory to flow which is locally in out of equilibrium exploring how the central variables change wang et al 2019 take these ideas further by introducing dynamic length scales due to the mixing zone variations over which the spatial averaging is done another development based on non equilibrium thermodynamics uses euler homogeneity to define the up scaled pressure from this kjelstrup et al derive constitutive equations for the flow while keeping the number of variables down kjelstrup et al 2018 2019 bedeaux and kjelstrup 2022 a challenge here is how to incorporate the structure of the fluid clusters spanning many pores there is also an ongoing effort in constructing a scaled up theory based on geometrical properties or more precisely the minkowski functionals mcclure et al 2018 armstrong et al 2019 mcclure et al there is also a class of theories based on detailed and specific assumptions concerning the physics involved an example is local porosity theory hilfer and besserer 2000 hilfer 2006 a b hilfer and döster 2010 döster et al 2012 another example is the decomposition in prototype flow deprof theory which is a fluid mechanical model combined with non equilibrium statistical mechanics based on a classification scheme of fluid configurations at the pore level valavanides et al 1998 valavanides 2012 2018 recent work hansen et al 2018 roy et al 2020 2022 explores a new approach to immiscible two phase flow in porous media based on the euler homogeneity theorem it provides a transformation from the seepage velocity i e average pore velocity of the more wetting fluid v w and the less wetting fluid v n to another pair of fluid velocities the average seepage velocity of both fluids combined v p and the co moving velocity v m the co moving velocity appears as a result of the euler homogeneity assumption the transformation is reversible knowing the average seepage velocity and the co moving velocity one can determine the seepage velocity of each fluid v p v m v w v n the mapping from the average velocity and the co moving velocity to the seepage velocity of each fluid together with the assumption that the fluids are incompressible constitutes a closed set of equations when supplemented by constitutive equations for the average velocity v p and the co moving velocity v m these two constitutive equations relate the two velocities to the driving forces the pressure and saturation gradients the constitutive equation for the average flow velocity v p relates to recent findings starting with tallakstad et al 2009a b who reported pressure drop proportional to the volumetric flow rate raised to a power 0 54 0 08 in a two dimensional model porous medium using a mixture of a compressible and an incompressible fluid under steady state conditions aursjø et al 2014 found a power law with a somewhat larger exponent using the same model porous medium but with two incompressible fluids similar results have since been observed by a number of groups see sinha et al 2017 gao et al 2020 zhang et al 2021 there has also been a considerable effort to understand these results theoretically and reproduce them numerically tallakstad et al 2009a b grøva and hansen 2011 sinha and hansen 2012 sinha et al 2013 xu and wang 2014 yiotis et al 2019 roy et al 2019 fyhn et al 2021 lanza et al 2022 roy et al cheon et al the constitutive equation for the co moving velocity v m has recently been studied by roy et al 2022 by reverse engineering published relative permeability data and by using a dynamic pore network model it turns out that this constitutive equation has a surprisingly simple form we will return to this further on in this paper we note that these two constitutive laws are based on the collective behavior of both fluids combined it would seem to be an impossible task to disassemble these two collective constitutive equations into one for each fluid however this is precisely what the mapping v p v m v w v n makes possible the theory just described is modeled on thermodynamics as presented by callen 1974 1991 which essentially consists of two ingredients 1 an energy budget i e the gibbs relation and 2 an assumption that the variables describing the energy are euler homogeneous functions in the theory of hansen et al 2018 only the second assumption is used hence the following question may be posed can one complete the analogy between immiscible fluid flow in porous media and thermodynamics finding a positive answer to this question is the aim of this paper the theory we are developing here assumes local steady state flow this corresponds to local equilibrium in thermodynamics by steady state flow we mean that the macroscopic averages characterizing the flow are well defined this does not rule out that fluid clusters move break up and merge at the pore level finding an analogy between thermodynamics and non thermal macroscopic systems is not new edwards and oakeshott in their theory of powders edwards and oakeshott 1989 had the same aim when setting up a theory for static granular media by making the assumption that all packing configurations having the same packing fraction are equally probable thus constructing a microcanonical ensemble with the packing fraction playing the role of energy an analogy with statistical mechanics was made as a result a non thermal pseudo thermodynamics would follow the ensuing theory thus had the same structure as thermodynamics but the variables have nothing to do with thermodynamics only the framework being the same in order to arrive at an analogue to thermodynamics in the present case we take as a starting point the information theoretical statistical mechanics of jaynes 1957 this generalizes the principles of statistical mechanics from being a theory specifically for mechanical systems e g assemblies of molecules to a framework that can be implemented once certain criteria are in place whatever the system in essence the jaynes approach generalizes the laplace principle of insufficient reason quoting jaynes 1957 laplace s principle of insufficient reason was an attempt to supply a criterion of choice in which one said that two events are to be assigned equal probabilities if there is no reason to think otherwise jaynes furthermore builds his approach on shannon s interpretation of entropy as a quantitative measure of what one does not know about a system the less is known the larger the entropy from a set of properties that such a function of ignorance must have shannon managed to construct a unique one fulfilling them shannon 1948 one of these properties was that knowing nothing at all this function would have its maximum when all possible states of the system would be equally probable thus generalizing the laplace principle of insufficient reason jaynes then interprets our knowledge about the system as constraints on our ignorance so that the shannon entropy should be maximized under these constraints constructing a theory along these principles for immiscible two phase flow in porous media leads to a pseudo thermodynamics describing the flow this entails finding powerful relations between the variables describing the flow furthermore it introduces new variables one such new variable is the cluster entropy associated with the shapes of the fluid clusters this allows us to define an agiture essentially measuring the level of agitation of the two fluids we have chosen the name agiture which is a contraction of the two words agitation and temperature to emphasize that it is not a temperature in the usual sense another variable is the flow derivative which is the conjugate of the saturation this variable is an analogue of the chemical potential in ordinary thermodynamics a third new variable is the flow pressure which is conjugate to the porosity furthermore statistical mechanics is more powerful than thermodynamics in that all of thermodynamics may be derived from statistical mechanics but not vice versa this is also the case here for example fluctuations in the macroscopic variables are accessible via statistical mechanics only we review in the next section the euler homogeneity approach of hansen et al 2018 here we describe the system we consider defining central concepts in particular we derive the two way mapping v p v m v w v n and discuss the co moving velocity v m in section 3 we construct the jaynes statistical mechanics for immiscible flow in porous media and from this a pseudo thermodynamics in order to effectuate these ideas in practice we need to define how we measure the relevant variables this means defining averaging procedures which should be done both in space and in time as already pointed out by mcclure et al 2021a b we go as far in this section as to define and exemplify the equivalents of the maxwell relations in ordinary thermodynamics the next section 4 concerns saturation and porosity fluctuations in section 5 we discuss the relation between the agiture flow derivative and the pressure gradient we do this by considering the internal balance in a porous medium having two regions with different matrix properties we end the paper by a discussion and conclusion section here we list a number of questions that remain open 2 review of euler homogeneity approach before we turn to constructing the statistical mechanics we review the euler homogeneity approach to immiscible and incompressible two phase flow in porous media first introduced by hansen et al 2018 2 1 representative elementary area we imagine a porous medium plug as shown in fig 1 it is homogeneous i e the local porosity and permeability fluctuate around well defined averages the sides of the plug are sealed while the two ends remain open we ignore gravity a mixture of two immiscible fluids are injected through the lower end and fluids are drained at the upper end flow into the plug is constant leading to steady state flow inside the plug erpelding et al 2013 due to the sealed sides of the plug the average flow direction is along the symmetry axis of the plug we now imagine a plane cutting though the plug orthogonally to the average flow direction in this plane we choose a point around this point we choose an area a e g bounded by a circle as shown in fig 1 we assume that the area is large enough for averages of variables characterizing the flow are well defined but not larger furthermore we assume the linear size of the area to be larger than any relevant correlation length in the system this defines the representative elementary area rea bear and bachmat 2012 at the chosen point we may do the same at any point in the plane and we may do this at any other such plane 2 2 some definitions the rea has an area a part of this area is covered by the matrix material whereas another part is covered by the pores this latter area a p we will refer to as the transverse pore area the porosity of the rea is then given by 1 ϕ a p a there is a volumetric flow rate through the rea shown in fig 1 q p the seepage velocity of the fluids passing through the rea is then 2 v p q p a p the flow consists of a mixture of two incompressible fluids one being more wetting with respect to the matrix than the other one we will refer to this fluid as the wetting fluid the less wetting fluid we will refer to as the non wetting fluid each of them is associated with a volumetric flow rate q w and q n and we have 3 q p q w q n the transverse pore area of the rea may also be divide into an area associated with the wetting fluid a w and an area associated with the non wetting fluid a n so that 4 a p a w a n we may define a seepage velocity for each of the two fluids 5 v w q w a w 6 v n q n a n we define the saturations of the two fluids passing through the rea as 7 s w a w a p 8 s n a n a p we may now combine these eqs 2 8 to express the average seepage velocity as 9 v p s w v w s n v n we note that could have made these definitions based on the density of the two fluids ρ w and ρ n rather than volumes the porosity ϕ saturations s w and s n and the seepage velocities v p v w and v n are variables that may be associated with the chosen point surrounded by the rea since there for every point in the porous medium one may associate an rea these variables which do not depend on the size or shape of the rea may be seen as continuous fields the variables we have defined should be well defined this is only possible if they not fluctuating too strongly so that it is possible to measure their averages by this we mean that the average does not depend on the number of samplings flooding processes typically generate fractal structures feder et al 2022 there are however length scales associated with the mechanisms controlling these structures måløy et al 2021 and beyond the largest of these length scales they cease to be fractal the same is true for steady state flow which we consider here we expect self averaging to take place beyond these length scales i e the relative strength of the fluctuations with respect to their averages shrinks with increasing size of the system hence we assume the plug and the reas to be large enough for the fluctuations not to dominate that such a combination of sizes is possible to find has recently been investigated by fyhn et al using a dynamic pore network model in the discussion that follows we need to assign another property to the variables beyond being self averaging we need them to be state variables by this we mean that they depend on the flow properties there and then and not the history of the flow erpelding et al 2013 studied this question experimentally and computationally finding that this is indeed so a last aspect to be considered is that of hysteresis there may indeed be hysteresis in the state variables knudsen and hansen 2006 studied immiscible two phase flow under steady state conditions using a dynamic pore network model they found that there are two transitions between two phase flow and single phase flow when the wetting saturation is the control parameter the transition between only the non wetting fluid moving at low saturation to both fluids moving at higher saturation does not show any hysteresis with respect to which way one passes through the transition on the other hand the transition between only the wetting fluid moving at high saturation and both fluids moving at lower saturation does show a strong hysteresis see figure 2 in knudsen and hansen 2006 this hysteresis is probably caused by this transition being equivalent to a first order or a spinodal phase transition it is well known that such transitions in ordinary equilibrium thermodynamics lead to hysteretic behavior in the state variables hysteretic behavior signals that there are regions of parameter space where the macroscopic state variables are multi valued hence the underlying microscopic physics has more than one locally stable mode 2 3 relations between the seepage velocities hansen et al 2018 made the weak assumption that the volumetric flow rate through the rea is a homogeneous function of order one that is if we scale a λ a where λ is a scale factor the volumetric flow rate would scale in the same way i e 10 q p λ a w λ a n λ q p a w a n we have here assumed that a w and a n are independent variables this means that we may change the area a of the rea by changing a w while keeping a n fixed or changing a n while keeping a w fixed this makes a and a p defined in eq 4 dependent variables we refer to hansen et al 2018 for details around this by taking the derivative of eq 10 with respect to λ and then setting λ 1 we find 11 q p a w a n q p a w a n a w q p a n a w a n see section 7 2 in hansen et al 2018 for a step by step demonstration of how these derivatives are done for a capillary fiber bundle model by invoking eqs 2 7 and 8 we find 12 v p q p a p s w q p a w a n s n q p a n a w s w v ˆ w s n v ˆ n where we have defined 13 v ˆ w q p a w a n 14 v ˆ n q p a n a w we will refer to v ˆ w and v ˆ n as the thermodynamic velocities we now change variables from a w a n being independent to s w a p being the independent variables we then have a w s w a p s w a p and a n s w a p 1 s w a p we find 15 a w a n a p s w s n a p s w a p 16 a n a w a p s w s w a p s w a p combining these two expressions with the definitions of the thermodynamic velocities 13 and 14 gives 17 v ˆ w v p s n d v p d s w 18 v ˆ n v p s w d v p d s w where we note that s n v ˆ w v ˆ n and v p are all function of s w and not of a p we combine eqs 9 and 12 19 v p s w v w s n v n s w v ˆ w s n v ˆ n this does not imply that v w v ˆ w and v ˆ n v n rather the most general relation between them is 20 v ˆ w v w v m s n 21 v ˆ n v n v m s w where v m is the co moving velocity hansen et al 2018 roy et al 2020 2022 combining these two expressions with eqs 17 and 18 expresses the physical seepage velocities v w and v n in terms of the average seepage velocity v p and the co moving velocity v m 22 v w v p s n d v p d s w v m 23 v n v p s w d v p d s w v m we may invert eqs 22 and 23 finding 24 v p s w v w s n v n 25 v m s w d v w d s w s n d v n d s w these four equations 22 to 25 constitute a two way mapping v p v m v w v n this means that having constitutive equations for v p and v m makes it possible to derive constitutive equations for v w and v n in other theories such as relative permeability theory only the mapping v w v n v p is given making it impossible to start from a constitutive equation for v p how to measure these variables from experimental data see roy et al 2022 who studied the co moving velocity in detail using relative permeability data from the literature and from analyzing data obtained using a dynamic pore network model they found that the co moving velocity takes the very simple form 26 v m a b d v p d s w where a and b are coefficients dependent on the capillary number it is still an open question as to why it has this simple form we will in the following be able to give a partial answer with these equations the assumption that the two fluids are incompressible and constitutive equations for v p and v m we have a closed set of equations describing the flow 3 statistical mechanics 3 1 fluid configurations in a plug we show in fig 1 the porous plug that we discussed in section 2 1 we will center our discussion on this plug in the following we assume that there is a volumetric flow rate q p passing through the plug under steady state conditions this volumetric flow rate may be split into a wetting and a non wetting volumetric flow rate q w and q n so that q p q w q n we use script characters to distinguish the flow through the entire plug from the flow through an rea we show in fig 2 three planes orthogonal to the symmetry axis of the plug i e orthogonal to the average flow direction we introduce a coordinate z along the symmetry axis of the plug measuring the distance from the plug s lower boundary to any given plane as the sides of the plug are sealed we have that q p is the same through the three orthogonal planes or any other such orthogonal plane the volumetric flow rate q p is a conserved quantity as we move along the z axis on the other hand the volumetric flow rates of each of the two fluids q w and q n are not conserved only their averages over several orthogonal planes will remain constant one may imagine the fluids being layered in the flow direction to realize this we also note that the transverse pore area a p will fluctuate from plane to plane due to fluctuations in the local porosity the transverse area associated with the wetting fluid a w will also fluctuate for two reasons a p fluctuates but more importantly because the fluid clusters fluctuate we pick one of the planes at z z 0 we introduce a two dimensional grid that divides the plane into voxels each voxel is assigned a set of parameters its area its transverse pore area the area covered by the wetting fluid and volumetric flow rate through it the values assigned to the voxels which are coarse grained at the scale of the voxel are the result of physical fluid configurations the respect the underlying hydrodynamics and thermodynamics for example these values may be the values assigned to the nodes in a lattice boltzmann model system or it may be the status of the links in a dynamic pore network model it may also be the status of the pixels in transversal ct scan through a porous plug this information assigned to each voxels in the plane at z 0 at time t we will refer to as the fluid configuration x x z 0 t we now imagine a stack of planes we assume the neighboring planes are a distance d z 0 apart in order to determine the flow configurations in each plane in the stack it is not enough to know it at entry plane of the stack z z 0 the reason for this is that we do not know the cluster structure inside the stack however the configurations in each plane are still measurable if we move through the plug along the z axis where z 0 z z 1 and the plug is long enough we will explore the space of possible configurations x we may do this at a fixed time t hence moving infinitely fast or at a finite speed along the z axis so that time is running we will in both cases explore the space of possible configurations if we choose a given plane and then average over the configurations that pass it we will not be averaging over the matrix structure which will be fixed in the plane however if we imagine an ensemble of plugs each being a realization of the same statistical pore structure we will eventually see all configurations x also in this case this leads us directly to defining a configurational probability density p x we have also in the process sketched out an ergodicity assumption the probability distribution for configurations in a given plane measured over an ensemble of plugs is the same as measuring it along different planes in a given plug time seems to have fallen out of the description time keeps track of the motion of each lagrangian fluid element as we illustrate in fig 2 this is more information than we need all we need is to know the fluid configurations in the planes for this purpose the z axis acts as an effective time axis hence the reference to an equivalent to the ergodic hypothesis which normally is a statement about time averaging vs ensemble averaging since we cannot reconstruct the configurations inside the stack given a knowledge of the configuration at the entry plane at z 0 one may be inclined to reject the idea to interpret the z axis as an effective time direction we point out that the same type of problem is encountered in relativistic mechanics of charged particles in strong fields where the position vs time world lines of the particles are not single valued functions of time feynman 1948 hansen and ravndal 1981 this means that it is not possible to reconstruct the later motion of such particles from knowing their configuration at a given time statistical mechanics constitutes a calculational formalism based on the knowledge of the probability distribution for configurations the jaynes maximum entropy principle provides a recipe for determining the configurational probability density jaynes 1957 central to this principle is the definition of a function that quantitatively measures what we do not know about our system this function is the shannon entropy shannon 1948 we construct it for the present system as 27 σ p l a n e d x p x ln p x where the integral is over all hydrodynamically possible fluid configurations in the plane we focus on the task is to calculate this entropy and from it determine p x we will refer to the entropy defined in eq 27 as the cluster entropy we have chosen the name as it reflects the cluster structure that the fluids are making we emphasize that the cluster entropy is not the thermodynamic entropy defined in other work such as kjelstrup et al 2018 2019 bedeaux and kjelstrup 2022 whereas there is production of thermodynamic entropy in the plug as we are dealing with a driven system there is no production of cluster entropy as we are dealing with steady state flow the fluid states x are not discrete rather they form a continuum hence we use an integral in eq 27 there are mathematical problems related to defining the measure d x is this integral however these difficulties we presume are of the same type encountered in ordinary statistical mechanics we will not delve into these problems here but rather just note their existence and that they have been solved in ordinary statistical mechanics 3 2 rea fluid configurations we have in section 2 1 defined the rea as for the entire plug we may define a configuration x for the rea as a hydrodynamically possible configuration within the area a the configuration in the plane where the rea sits is x hence x is a subset of x we also define the fluid configuration in the rest of the plane that is not part of the rea x r we will refer to this part of the plane as the reservoir hence we have that 28 x x x r a central question is now how independent are the configurations x and x r if they are independent we may focus entirely on the rea configurations x as we may write the configurational probability for the entire plane as 29 p x p x p r x r where p x is the configurational probability for the rea and p r x r is the configurational probability for the reservoir fyhn et al have recently studied the validity of eq 29 in a two dimensional dynamic pore network model by changing the size of the two dimensional plug while keeping the size of the rea fixed they checked whether the statistical distributions of q p and a w were dependent on the size of the plug only a very weak dependency was found which decrease with size it is therefore realistic to assume eq 29 to be valid for large enough plugs and reas we proposed in section 3 1 to view the average flow direction through the plug the z axis as a playing the role of a time axis averaging over time thus corresponds to averaging over a stack of reas as shown in fig 3 when we in the next section refer to averaging it is averaging over this stack we mean we may treat the interactions between the rea and the reservoir in different ways we may remove the rea stack from the plug and treat it as a closed off system this amounts to treating the rea as a plug on its own we may leave it in the original plug allowing it to freely interact with the reservoir we may allow the stack to interact fully with the reservoir but in such a way that the amount of wetting fluid is kept constant it is not possible to implement such constraints experimentally nor computationally but theoretically it is the same goes for the transverse pore area we may keep it constant theoretically but not experimentally or computationally nevertheless we will see examples of such ensembles in the following as they correspond to different control parameters 3 3 jaynes maximum entropy approach following the jaynes recipe we need to maximize the cluster entropy in the rea which is 30 σ d x p x ln p x under the constraints of what we know about the system the probability density p x is defined in eq 29 there are three variables that we measure the volumetric flow rate through the rea q p and the transverse pore area covered by the wetting fluid a w and the transverse pore area a p all three of them are averages over fluctuating quantities when performed as shown in fig 3 i e we average over a stack of reas the average of the volumetric flow rate is 31 d x p x q p x q p where the q p x is associated with fluid configuration x likewise the average wetting area is given by 32 d x p x a w x a w where a w x is the wetting area associated with configuration x the third variable we consider is the average transverse pore area 33 d x p x a p x a p all three variables q p a w and a p are extensive in the area of the rea a the aim now is to determine p x based on the knowledge of these variable averages following jaynes we use the lagrangian multiplier technique we start by constructing the lagrangian which we then will maximize 34 l d x p x ln p x λ 1 d x p x λ q q p d x p x q p x λ w a w d x p x a w x λ a a p d x p x a p x with the aim to determine p x we assume that the three lagrange multipliers λ q λ w and λ a are intensive in the area of the rea a the lagrange multiplier λ on the other hand is extensive in the area a it follows that the cluster entropy σ is extensive in a necessary conditions for maximizing the lagrangian 34 are 35 l p x 0 36 l λ 0 37 l λ q 0 38 l λ w 0 39 l λ a 0 one may ask why not additional information is included here such as the average wetting flow rate q w the answer to this lies in the euler theory hansen et al 2018 there are three independent variables in the problem for which we may fix their averages we choose here q p a w and a p other averages will then follow from the formalism we are about to develop the thermodynamic formalism we therefore are about to develop will then concern the thermodynamic velocities eqs 13 and 14 we will then need the co moving velocity v m to translate the results into the physical velocities eq 35 gives 40 p x e 1 λ e λ q q p x λ w a w x λ a a p x and the normalization condition eq 36 gives 41 e λ 1 d x e λ q q p x λ w a w x λ a a p x z where we have defined the partition function z z λ q λ w λ a we are now in a position to calculate the cluster entropy combining eqs 30 and 40 42 σ p x ln p x ln z λ q λ w λ a λ q q p λ w a w λ a a p we note that 43 q p λ q λ w λ a ln z λ q λ w λ a 44 a w λ q λ w λ a ln z λ w λ q λ a 45 a p λ q λ w λ a ln z λ a λ q λ w these three equations may be solved to give λ q λ w and λ a as functions of the three variables we know q p a w and a p they also make eq 42 a triple legendre transformation changing the control variables λ q q p and λ w a w and λ a a p hence the control variables of the flow entropy are σ σ q p a w a p 46 σ q p a w a p p x ln p x ln z λ q λ w λ a λ q ln z λ q λ w λ a λ w ln z λ w λ q λ a λ a ln z λ a λ q λ w we define a new variable q g q g λ q λ w λ a through the equation 47 z λ q λ w λ a e λ q q g λ q λ w λ a it plays the role corresponding to that of a free energy in ordinary thermodynamics our next step is to invert eq 42 so that q p becomes a function of σ rather the other way round that is we transform σ q p a w a p to q p σ a w a p hence we may write eq 42 or 46 as 48 q g λ q λ w λ a q p σ a w a p σ 1 λ q a w λ w λ q a p λ a λ q where we have also used eq 47 we see that 49 q p σ a w a p σ a w a p 1 λ q hence we note that the following equation which forms part of the right hand side of eq 48 constitutes a legendre transformation 50 q f λ q a w a p q p σ a w a p σ 1 λ q q p σ a w a p σ q p σ a w a p σ a w a p here q f corresponds to another free energy in ordinary thermodynamics we rewrite eq 48 as 51 q g λ q λ w λ a a p λ a λ q q f λ q a w a p a w λ w λ q the left hand side of this equation constitutes a legendre transform 52 q m λ q λ w a p q g λ q λ w λ a a p λ q λ a as we have 53 q g λ q λ w λ a λ a λ q λ q λ w a p hence we have now transformed eq 48 to 54 q m λ q λ w a p q f λ q a w a p a w λ w λ q 3 4 agiture flow derivative and flow pressure let us now define three new intensive variables built from the lagrange multipliers λ q λ w and λ a 55 θ 1 λ q 56 π λ a λ q 57 μ λ w λ q the first one θ by its resemblance to temperature in ordinary statistical mechanics we will name the agiture the unit of the agiture is the same as volumetric flow rate however it is an intensive variable the second one π we will name the flow pressure this variable is the conjugate of the flow area a p 58 π q f θ a w a p a p θ a w q p σ a w a p a p σ a w the unit of π is inverse velocity referring to eq 1 we see that a p is a measure of the porosity ϕ and π is therefore a velocity variable conjugate to the porosity the third variable eq 57 we name the flow derivative we will explain the name in the next section as π its unit is that of a velocity it is the conjugate of the transversal wetting fluid area a w 59 μ q f θ a w a p a w θ a p q p σ a w a p a w σ a p playing a role similar to a chemical potential in ordinary statistical mechanics through eq 7 we see that the flow derivative is the conjugate of the wetting saturation s w 3 5 connection with euler homogeneity approach we need to define one more variable 60 q n σ μ a p q m θ μ a p σ θ μ a p θ where 61 σ θ μ a p q m θ μ a p θ μ a p combining this definition with eqs 50 and 54 gives 62 q n σ μ a p q p σ a w a p a w μ we use the fact that both q n σ μ a p and q p σ a w a p are homogeneous functions of order one in the extensive variables σ a w and a p 63 q n λ σ μ λ a p λ q n σ μ a p 64 q p λ σ λ a w λ a p λ q p σ a w a p we now set λ 1 a p and combine these two expressions with eq 62 finding 65 a p q n σ μ 1 a p q p σ s w 1 a w μ where we also have used eq 7 and we have defined the cluster entropy density 66 σ σ a p we now divide eq 65 by a p noting that 67 q n σ μ 1 v n σ μ 68 q p σ s w 1 v p σ s w i e v n and v p are velocities we recognize v p q p a p from eq 2 as the average seepage velocity of the two fluids eq 65 then takes on the form 69 v n σ μ v p σ s w s w μ let us now go back to eq 59 and use scaling relation 64 to find 70 v p σ s w s w σ μ this expression is the reason why we name μ the flow derivative we now compare these two eqs 69 and 70 to eq 21 which we reproduce here 71 v ˆ n v p s w d v p d s w this equation is one of the central results derived by hansen et al 2018 by comparison we identify 72 v n v ˆ n where the thermodynamic velocity of the non wetting fluid v ˆ n is defined in eq 14 eq 69 may be written 73 v ˆ n σ μ v p σ s w σ μ s w σ μ μ and we have that 74 s w σ μ v ˆ n σ μ μ σ these two equations are our central result it demonstrates that the thermodynamic velocity of the non wetting fluid is the legendre transform of the average seepage velocity with respect to the wetting saturation and that the wetting saturation is minus the derivative of the non wetting thermodynamic velocity with respect to the flow derivative eq 21 was derived based on the volumetric flow rate being a homogeneous function of the first kind in the transverse pore area now we see this equation as a fundamental equation resulting from an underlying statistical mechanics with variables θ σ and μ s w and π ϕ forming conjugate pairs 3 6 partition functions the partition function is given by 75 z θ μ π d x e q p x θ μ a w x θ π a p x θ we may split the integration over states x into an integral over a p and then over all states x that has a given a p 76 z θ μ π e q g θ μ π θ 0 a d a p e π a p θ z θ μ a p where we have defined 77 z θ μ a p d x δ a p x a p e q p x θ μ a w x θ 1 a d x δ ϕ x ϕ e q p x θ μ a w x θ and where δ is the dirac delta function we have used that a ϕ a p see eq 1 we have that 78 z θ μ a p 1 a e q m θ μ a p θ where q m θ μ a p is defined in eq 62 we may now write partition function z θ μ a p in eq 77 as 79 z θ μ a p 0 a p d a w e μ a w θ z θ a w a p where we have defined 80 z θ a w a p d x δ a w x a w δ a p x a p e q p x θ d x a p a δ s w x s w δ ϕ x ϕ e q p x θ which we may write as 81 z θ a w a p 1 a p a e q f θ a w a p θ we may repeat this procedure one more time we rewrite the partition function z θ a w a p eq 80 as 82 z θ a w a p d q p e q p θ z q p a w a p where 83 z q p a w a p d x δ q p x q p δ a w x a w δ a p x a p this microcanonical partition function as q p is the control variable is also the unnormalized density of states with respect to the variables q p a w and a p it demonstrates that all states x with the same q p a w and a p are equally probable this brings us back to our starting point the entropy has its maximum when all states that comply with the constraints 31 32 and 33 are equally probable 3 7 co moving velocity the co moving velocity which is defined in eqs 20 and 21 constitutes the bridge between the seepage velocities eqs 5 and 6 and the thermodynamics velocities eqs 13 and 14 by combining the defining equations for the co moving velocities with the two equations ensuing from the euler scaling assumption for the volumetric flow rate we express the seepage velocity of the two fluid species in terms of the average seepage velocity and the co moving velocity in eqs 22 and 23 combining eq 23 with eq 74 based on statistical mechanics we find a consistent structure 84 v n σ μ v p σ s w σ μ s w σ μ μ v m σ μ when assuming that v n v n σ μ and v m v m σ μ thus we have expressed the physical seepage velocity for the non wetting fluid within the pseudo thermodynamic formalism we are developing the corresponding physical seepage velocity for the wetting fluid may then be found e g by using eq 9 the phenomenological form found by roy et al 2022 eq 26 is consistent with the assumption for v m as eq 26 then takes the form 85 v m σ μ a σ b σ μ with 86 b σ v m σ μ μ σ we note that the dependence of a and b on the capillary number is consistent with the two coefficients depending on the cluster entropy density σ why v m is linear in μ is not known 3 8 maxwell relations we now see that the euler homogeneity approach of hansen et al 2018 was just the tip of an iceberg having anchored the approach in a statistical mechanics we now have access to a rich formalism that parallels thermodynamics for example we find the equivalents of the maxwell relations in ordinary thermodynamics we derive just one in the following we have that 87 q f θ a w a p θ a w a p σ we combine this equation with eq 59 taking the cross derivatives and finding 88 σ a w θ a p μ θ a w a p which may be written as 89 σ s w θ μ θ s w 4 fluctuations and agiture our starting point are eqs 41 and 47 i e 90 q g θ μ π θ ln z θ μ π θ ln d x e q p x θ μ a w x θ π a p x θ this immediately gives 91 q g θ μ π μ θ π 1 z d x a w x e q p x θ μ a w x θ π a p x θ a w taking the derivative a second time with respect to μ gives 92 θ 2 q g θ μ π μ 2 θ π 1 z d x a w 2 x e q p x θ μ a w x θ π a p x θ 1 z d x a w x e q p x θ μ a w x θ π a p x θ 2 a w 2 a w 2 δ a w 2 where we have defined the fluctuations δ a w 2 we now combine eqs 1 and 7 to find 93 a w a a p a a w a p a ϕ s w this allows us to transform eq 92 into 94 δ ϕ s w 2 θ a ϕ s w μ θ π we see that the agiture θ seems proportional to the fluctuations δ ϕ s w 2 however due to the term ϕ s w μ θ π the relation between them is complex we may calculate the porosity fluctuations by taking the partition function z θ μ π eq 75 as starting point we find 95 δ ϕ 2 θ a ϕ π θ μ where 96 δ ϕ 2 1 a 2 a p x 2 a p 2 we note that the porosity field ϕ is a property of the matrix and not the flow hence eq 95 gives a direct link between the agiture θ and the flow pressure π 97 θ a δ ϕ 2 π ϕ θ μ 5 conditions for steady state in a heterogeneous plug we consider in the following the conditions for steady state in a heterogeneous plug we show in fig 4 a plug that is divided into a region a and a region b which have different matrix properties the difference may for example be that the wetting properties of the matrix in region a differ from those of region b the full system which consists of both regions a and b is a closed system we will in the following focus on the four quantities q p a w a p and σ that describe the flow in the plug strictly speaking we should change our notation e g q p q p since we are considering the entire plug however in order to avoid complicating the notation and therefore making the material less accessible we refrain from making the change these four quantities are extensive i e additive this means that we may express them in terms of the two regions a and b we have 98 q p q p a q p b 99 σ σ a σ b 100 a w a w a a w b 101 a p a p a a p b we write q p in terms of the control variables σ a w and a p 102 q p σ a w a p q p a σ a a w a a p a q p b σ b a w b a p b since the total volumetric flow rate is conserved in the plug we must have that fluctuations in it must be zero i e 103 δ q p δ q p a δ q p b 0 the fluctuations in q p a and q p b come from fluctuations in σ a and σ b a w a and a w b and a p a and a p b we express δ q p a and δ q p b in terms of the fluctuations of these variables 104 δ q p a σ a a w a a p a q p a σ a a w a a p a σ a a w a a p a δ σ a q p a σ a a w a a p a a w a σ a a p a δ a w a q p a σ a a w a a p a a p a σ a a w a δ a p a likewise we have 105 δ q p b σ b a w b a p b q p b σ b a w b a p b σ b a w b a p b δ σ b q p b σ b a w b a p b a w b σ b a p b δ a w b q p b σ b a w b a p b a p b σ b a w b δ a p b there is no production of cluster entropy as this entropy is at a maximum however cluster entropy may move between regions a and b hence we have 106 δ σ δ σ a δ σ b 0 furthermore we keep the control variables a w and a p fixed this is of course not possible experimentally however as a theoretical concept it is permissible hence we have that 107 δ a w δ a w a δ a w b 0 108 δ a p δ a p a δ a p b 0 we now combine eqs 103 108 to find 109 δ q p σ a w a p q p a σ a a w a a p a q p b σ b a w b a p b δ σ a q p a a w a σ a a p a q p b a w b σ b a p b δ a w a q p a a p a σ a a w a q p b a p b σ b a w b δ a p a 0 we now assume that the cluster entropy fluctuations δ σ a are independent of the fluctuations in δ a w a and δ a p a this leads to 110 θ a q p a σ a a w a a p a σ a a w a a p a q p b σ b a w b a p b σ b a w b a p b θ b where we have used eqs 49 and 55 if we now furthermore assume that the fluctuations in δ a w a and δ a p a are uncorrelated we find 111 μ a q p a σ a a w a a p a a w a σ a a p a q p b σ b a w b a p b a w b σ b a p b μ b and 112 π a q p a σ a a w a a p a a p a σ a a w a q p b σ b a w b a p b a p b σ b a w b π b these three criteria for steady state flow eqs 110 111 and 112 are analogous to the criteria for two open systems in thermal contact and in equilibrium here the temperature pressure and the chemical potential must be the same it is important to point out the following in ordinary thermodynamics the rule is that the conjugate of a conserved quantity is constant in a heterogeneous system at equilibrium this is e g the argument for the temperature being the same everywhere in the system at equilibrium as the entropy is at a maximum this is the same argument as we have used here which leads to eq 110 however consider two magnets with different magnetic susceptibilities in contact which is placed in a uniform magnetic field h the conjugate of the magnetization m which is the magnetic flux b is not equal in the two magnets in contact b a b b what goes wrong here is that it is not possible to let magnetization fluctuate between the two magnets so that its sum is constant i e δ m a δ m b while simultaneously keeping the total internal energy and the total entropy constant i e δ u δ u a δ u b 0 and δ s δ s a δ s b 0 in our system steady state two phase flow in a porous medium the following question then becomes central is it possible to fulfill δ q p 0 and δ σ 0 and at the same time have δ a w a δ a w b and δ a p a δ a p b the answer to this question is not obvious only experiments or computations on models may provide an answer if the answer is no only eq 110 will be valid and not eqs 111 and 112 6 discussion and conclusion a central problem in the physics of porous media is how to scale up knowledge of the physics at the pore level to the continuum scale often referred to as the darcy scale where the pores are negligible in size the notion of up scaling is of course only meaningful if we know which coarse scale physics we are up scaling to and the traditional relative permeability theory has well known weak points the theory of hansen et al 2018 is a radically different approach to the coarse scale physics this theory is formally similar to some parts of thermodynamics but it is the flow rates and the relations between flow rates that are the central players in its core the theory is based on the volumetric flow rate being an euler homogeneous function in the present paper we have developed a statistical mechanics framework for immiscible incompressible two phase flow in this framework total flow rate plays the same role as energy in ordinary statistical mechanics and local steady state flow plays the role of local thermodynamic equilibrium we have shown that the pseudo thermodynamics that follows from the statistical mechanics framework extends the earlier theory of hansen et al 2018 rendering it a complete pseudo thermodynamics in the spirit of edwards and oakeshot s pseudo thermodynamics for powders edwards and oakeshott 1989 in the same way that ordinary statistical mechanics serves as a tool for calculating macro scale properties from known molecular scale physics the present statistical mechanics links the pore scale hydrodynamic description to a continuum scale physics thus solving the up scaling problem the key link is the partition function z θ μ π defined in eq 41 the integral is over all physical fluid configurations and the physics sits in the measure d x over configurations and pore structure the up scaling from the intermittent flow of fluid clusters through pore space to a description with a small number of continuum scale variables admits an immense level of ignorance this ignorance is reflected in the pseudo thermodynamics as the cluster entropy we call the conjugate variable to this cluster entropy the agiture the agiture measure the level of agitation in the flow typically a high agiture is associated with high flow rates in the same way high temperature is associated with high energies in thermal systems we have not proposed here any technique as to how the agiture θ may be measured or controlled experimentally or computationally the flow pressure π seems also difficult to measure measuring the flow derivative is on the other hand seemingly easier to measure in terms of the average seepage velocity and the saturation it may be written 113 μ v p σ s w s w σ since we are assuming steady state flow the cluster entropy is at a maximum and therefore constant we also note that we have used five different ensembles in this work where control parameters are respectively θ μ π θ μ a p σ μ a p θ a w a p σ a w a p the first of these ensembles is easily realizable experimentally as this describes an rea communicating freely with the rest of the porous medium the second one with a p controlled is feasible e g by using 3d printing techniques to construct the porous medium the two last three ensembles must be seen as theoretical constructs we note however that this is standard procedure in thermodynamics in that one always starts with the gibbs relation which relates variations in the internal energy to variations in the extensive variables irrespective of whether this ensemble is accessible experimentally or not we see that a steady state condition in a heterogeneous porous medium such as that shown in fig 4 is that the agiture is constant throughout the entire system eq 110 on the other hand the two additional equilibrium conditions eqs 111 and 112 hinge on additional assumptions that need to be verified experimentally or computationally in light of the above discussion verifying the validity of eq 111 is the easier one of the three equations the probability to find a flow configuration p x in the rea which is the central to the theory we present here it was emphasized at the beginning of section 3 3 that the fluid configuration x refers to the configuration in the rea not the entire plane cutting through the plug x x x r it is crucial for the theory that p x does not depend on the properties of the entire plug recent numerical work by fyhn et al indicates that this is indeed correct given all these caveats and open question the fact remains that the framework we have presented here opens up for viewing immiscible two phase flow in porous media in a different way than before we have here divided the problem into 1 constructing a framework by which the concepts that are necessary are put in place and 2 connecting these concepts to the underlying fluid dynamics and thermodynamics this paper accomplishes the first goal declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests alex hansen reports financial support was provided by research council of norway alex hansen reports a relationship with research council of norway that includes funding grants acknowledgments the authors thank dick bedeaux carl fredrik berg daan frenkel hursanay fyhn signe kjelstrup marcel moura knut jørgen måløy håkon pedersen subhadeep roy ole torsæter and øivind wilhelmsen for interesting discussions this work was partly supported by the research council of norway through its center of excellence funding scheme project number 262644 
67,understanding the mass transfer of co 2 into formation brine both qualitatively and quantitatively is important for improving the security of geologic carbon sequestration in this study quasi dynamic x ray micro computed tomographic mct imaging was used to track the time evolution of supercritical co 2 scco 2 clusters in a sandstone throughout brine injection a cluster matching workflow enabled the identification of depletion merging and snap off of the scco 2 clusters and subsequently the mass transfer coefficient of individual scco 2 clusters was found to range between 3 0 10 5 and 3 5 10 4 mm s the macroscopic average mass transfer coefficient was estimated as 1 4 10 4 mm s for application to geologic carbon sequestration these values give an indication of the range of mass transfer coefficients that may be expected for similar state and flow conditions with the macroscopic average mass transfer coefficient evaluated we back calculated the in situ co 2 concentration field for brine which provides quantitative insight of the distribution of dissolved co 2 in the sample despite slow injection rate ca 10 7 mobilization of small scco 2 clusters was also observed and was attributed to the combined effect of incomplete dissolution of snapped off clusters and the reduction in the fluid fluid interfacial tension ift due to the high local co 2 concentration in brine accompanying scco 2 dissolution this highlights the coupling of dissolution and mobilization processes and demonstrates the need to understand these interlinked dynamics to improve co 2 storage in geological formations keywords dissolution dissolution trapping geologic carbon sequestration x ray micro computed tomography multiphase flow porous media data availability segmented data of the dissolution scans are publicly available via the anu data commons doi https doi org 10 25911 hgam 8n67 1 introduction increasing anthropogenic emission of heat trapping carbon dioxide co2 gas as compared to the pre industrial level is considered the main cause of global warming concerns on how global warming might significantly impact natural and human systems have been raised ipcc 2018 pledges made following the paris agreement and the 2021 united nations climate change conference cop26 aim for the reduction of co2 emissions such that net zero carbon emission is achieved globally by 2050 and global warming is limited to 2 c and ideally 1 5 c as relative to the pre industrial level kelemen et al 2019 these goals are likely to require the development and deployment of methods for co2 capture and storage ccs geologic carbon sequestration works by storing captured and compressed co2 in target geological formations such as saline aquifers metz et al 2005 benson and cole 2008 leung et al 2014 kelemen et al 2019 newell and ilgen 2019 with an estimated capacity of storing 4 000 23 000 gt of co2 de coninck and benson 2014 geologic carbon sequestration in saline aquifers is expected to play a crucial role in mitigating global warming particularly in support of negative emissions technologies and zero carbon industrial processes after the injection of co2 ceases the co2 plume migrates both laterally away from the injection well along the direction of injection and vertically due to buoyancy forces bachu 2008 eventually the plume may spread approximately 10 km in width and 100 m in height bourg et al 2015 as the plume migrates upwards it poses a risk of co2 leakage the likelihood of leakage is greatly reduced with structural trapping where a low permeability cap rock prevents escape of the plume benson and cole 2008 furthermore spontaneous re imbibition of formation brine can disconnect the co2 plume into clusters by pore scale snap off at the trailing edge of the plume causing the co2 to be trapped in the pore space by capillary forces bachu 2008 such capillary trapping resulting from combined effect of the disconnection of the co2 plume and the presence of pore scale capillary forces enhances the security of co2 storage metz et al 2005 benson and cole 2008 macminn et al 2010 krevor et al 2015 krevor et al 2015 reported capillary trapping efficiency of 30 40 of pore volume for numerous rock types along with structural trapping the two trapping mechanisms are responsible for a significant amount of more than 50 of the total trapping contribution in a timescale of several hundreds of years after co2 has been injected metz et al 2005 other than the two trapping mechanisms discussed above that occur shortly after co2 is injected trapped co2 will gradually dissolve into formation brine in a longer timescale of tens to thousands of years iglauer 2011 leslie et al 2021 commonly known as dissolution trapping this mechanism promotes even safer geologic carbon sequestration as dissolved co2 increases brine density and causes co2 rich brine to sink relative to the formation groundwater eliminating the risk of co2 escape due to buoyancy forces peter et al 2022 co2 dissolution also reduces the possibility of residual co2 cluster remobilization due to larger co2 cluster size herring et al 2013 datta et al 2014 iglauer and wülling 2016 higher capillary number ca andrew et al 2014 armstrong et al 2014 datta et al 2014 or higher connectivity of the co2 phase herring et al 2013 2015 schlüter et al 2016 hu et al 2020 on longer timescales of millions of years dissolved co2 may precipitate as carbonate minerals from which the risk of co2 mobilization and leakage is minimal metz et al 2005 ajayi et al 2019 on timescales of hundreds to thousands of years the trapping contribution of dissolution and mineral trapping will gradually overtake the amount contributed by structural and residual trapping reaching approximately 70 on a timescale of 10 000 years metz et al 2005 this highlights the importance of understanding the dissolution of trapped co2 into the formation brine one important parameter for quantitatively understanding the dissolution of co2 into formation brine is the mass transfer coefficient k which can be calculated based on mass balance of the solution miller et al 1990 cussler 2009 1 d m d t ρ d v d t k a c 0 c 1 where d m d t denotes the change in the mass of co2 with time a the interfacial area ifa between the bulk co2 phase and brine c 0 and c 1 the solubility limit and the concentration of co2 in the brine respectively since the presence of porous media restricts fluid flows and reduces the rate of co2 mass transfer through dissolution it is important to measure the in s i t u mass transfer coefficient for co2 dissolution within porous media for actual application to geologic carbon sequestration earlier studies investigating the mass transfer coefficient in porous media have been performed to study the dissolution of non aqueous phase liquids napls for application to groundwater remediation miller et al 1990 powers et al 1992 imhoff et al 1994 due to the opacity of porous media direct optical access of fluid configurations inside the porous media was impossible and the ifa of the dissolving napl was unknown in these studies therefore the mass transfer rate coefficient k was defined as a lumped parameter of k and the ifa through which mass transfer occurred with eq 1 rewritten as 2 ρ d v d t k c 0 c 1 the in situ napl concentration in the sample was determined based on the one dimensional advection dispersion equation bear 2013 imhoff et al 1994 by neglecting dispersion and assuming there was no accumulation of the napl in the control volume 3 ρ ϕ s n t q c x where ρ ϕ s n and q denotes the density of napl porosity of the porous medium saturation of napl and the darcy velocity of the solution respectively c x denotes the change in napl concentration in the solution across some distance x with the concentration of dissolved napl determined from the effluent collected during experiments the k in the sample as a function of x and t could be determined by integrating eq 3 and substituting the resulting c 1 x t into eq 2 however it was reported by miller et al 1990 that k obtained in this way might be sensitive to the concentration of napl dissolved in the effluent where a small increase in the concentration might result in significant increase in the measurements of k at high effluent concentrations more recently with the emergence and rapid development of x ray micro computed tomographic mct imaging in the last two decades visualization of fluid configurations inside the opaque porous media has become possible at the scale of micrometers wildenschild et al 2002 wildenschild and sheppard 2013 cnudde and boone 2013 schlüter et al 2014 gan et al 2020 this nondestructive imaging technique enables the acquisition of in situ fluid configuration within a porous medium and with further data processing microscopic parameters such as porosity fluid saturation and interfacial area can be evaluated culligan et al 2004 2006 costanza robinson et al 2008 brusseau et al 2006 2008 mcdonald et al 2016 jiang et al 2019 the ability to directly measure interfacial area allows the mass transfer coefficient k to be investigated independently as compared to the lumped parameter k for napls schnaar and brusseau 2006 hu et al 2021 and nitrogen gas in porous media patmonoaji et al 2021a b although the solubility of co2 is generally higher compared to napls chang et al 1998 eqs 1 and 3 have also been applied to co2 to investigate k due to the similar mass transfer behavior of the two fluids once trapped in porous media jiang et al 2016 2017 patmonoaji and suekane 2017 patmonoaji et al 2021b in this study we aim to investigate the mass transfer of supercritical co2 scco2 into brine under conditions relevant to geologic carbon sequestration in saline aquifers through mct the time evolution of trapped scco2 clusters during brine injection was tracked and with the measured volume and ifa for the clusters the mass transfer coefficient k was evaluated for the clusters furthermore based on the individual mass transfer coefficients measured for each cluster a method for back calculating the spatial distribution of the co2 concentration field dissolved within the brine phase was developed and implemented for this experiment throughout the text we use scco2 to denote the scco2 phase trapped in porous medium and co2 to denote the dissolved co2 in brine 2 experiment and method 2 1 scco2 dissolution experiment and mct scans dissolution of trapped scco2 bubbles was investigated for an scco2 brine bentheimer sandstone system we chose bentheimer sandstone as the porous medium in our study as this water wet sandstone composed of mainly quartz is considered an ideal model system for studying fluid transport within porous media due to its isotropic and relatively homogeneous structure peksa et al 2015 which also makes it possible to capture the full range of pore scale features in a single representative 3d mct image herring et al 2019 the diameter and the height of the cylindrical core was 12 and 36 mm respectively to mimic the condition of geological carbon sequestration sites that are usually below a depth of 800 m metz et al 2005 benson and cole 2008 the pressure and the temperature for the system was kept at 1250 psi 8 62 mpa and 45 c respectively under which co2 forms a supercritical fluid scco2 for the flow experiments the wetting phase wp that shows a stronger affinity to the rock surface was water the non wetting phase nwp which shows less affinity to the grain surface was scco2 due to the similar x ray attenuation of water and scco2 the water was doped with x ray attenuating potassium iodine ki at concentration of 1 1 m resulting in doped brine that is more x ray attenuating than scco2 prior to injection scco2 was saturated with brine by mixing the two fluids under the working temperature and pressure for 48 h we therefore expect negligible further solubility of brine dissolution into scco2 throughout the experiment after a series of drainage imbibition experiments during which the wp and the nwp were injected separately into the sandstone core in cycles for details of the drainage imbibition experiments and the experimental setup of the subsequent flushing and dissolution experiments the reader is referred to herring et al 2022 scco2 was trapped in the pore space of the sandstone core with the end point scco2 saturation equaled 11 1 for the entire sample to reduce the possibility of scco2 mobilization during the subsequent dissolution experiment an additional imbibition experiment was conducted during which the core was flushed with 20 pore volume pv of co2 saturated brine injected upwards at a relatively high flow rate of 0 388 ml min which was nearly 20 times as fast as the subsequent dissolution experiment the capillary number defined as c a μ u σ with μ and u the viscosity and the velocity of brine respectively and σ the interfacial tension ift between scco2 and brine see table 1 for fluid properties was within the range for cluster mobilization to occur ca listed in table 2 wang et al 2019 therefore after the flushing experiment it was expected that only residually trapped scco2 clusters were left and a high resolution base scan was acquired for the entire core as a reference for subsequent dissolution experiment to mimic background groundwater flow in the aquifers fresh brine without dissolved co2 was injected upwards at a much slower flow rate for the dissolution experiment corresponding to ca of 2 4 10 7 significantly smaller than that for the flushing experiment table 2 therefore it was expected that any depletion of scco2 observed during the dissolution experiment could be attributed to scco2 dissolution 2 2 mct scans and data reconstruction a helical space filling trajectory is utilized for the acquisition of mct data in the national laboratory for x ray micro computed tomography ctlab at the australian national university anu helical scanning allows samples with high aspect ratio to be continuously imaged without the need to stitch together data blocks with helical scanning the tuy sufficiency condition is also satisfied providing a complete set of viewing directions allowing 3d data reconstruction from high cone angle projections tuy 1983 varslot et al 2011 2012 for the space filling trajectory 2d projection images are taken as distinct points that fill the space in a maximally isotropic sampling pattern kingston et al 2016 2018 for the high resolution base scan to maximize the image resolution the mct data was acquired via two stage region of interest imaging roi which uses an overview scan and a region of interest scan the overview scan was firstly acquired with the entire sample and core holder in the x ray field of view at a lower magnification this low resolution scan was followed by the roi scan for which the field of view comprised only an internal portion of the core this results in high magnification artifact free images of the central region of the sample this is possible because the missing edge features are removed from the roi scan using the reference overview scan allowing the roi scan to be reconstructed as if it were full field data maaß et al 2011 the total time taken for the overview and the region of interest scan was 17 h 27 mins and the voxel size for the base scan was 3 92 μ m for the dissolution experiment a total of 34 faster mct scans were taken simultaneously as brine was injected with the space filling trajectory the resultant voxel size equals 19 47 μ m the acquisition time for each scan was approximately 30 mins and the resulting tomographic data represents the average x ray attenuation within each voxel an indicator of material content during each scan the reduced acquisition time for the dissolution experiment makes tracking of the scco2 dissolution process possible scans acquired during the dissolution experiment were then digitally registered mapped to the base scan by aligning pore scale features latham et al 2018 the scanning parameters used for the x ray beam energy was 120 kev and 60 μ a for the reconstruction of mct data into a 3d volume a multi grid iterative image reconstruction method that is preconditioned with a volume space filter was used myers et al 2016 in addition geometric inaccuracies during data acquisition such as mechanical inaccuracy and thermal drift were also corrected by performing multi resolution alignment between simulated re projections and the experimental projections dengler 1989 latham et al 2018 2 3 data processing and scco2 cluster properties with the reconstructed mct data subsequent data processing and analysis were carried out with the anu developed image analysis tool webmango webmango anu edu au sheppard et al 2004 the reconstructed data was cropped into a cylindrical volume with diameter and height equal to 2421 and 4428 voxels 9 50 and 17 37 mm respectively to remove regions containing the core holder confining materials and fluid air outside of the samples and the bottom part of the core where no scco2 was trapped by inspecting the tomographic data for the dissolution scans it was observed that the scco2 phase was highly disconnected i e presented as isolated clusters in the core the mct data also indicates that most of the trapped scco2 has been depleted by the end of the 9th scan therefore we focus on the first nine scans of the dissolution experiment before further data analysis was conducted every voxel in the base scan was assigned with an integer to identify the three physical phases the base scan was first registered to the dry scan i e scan of the dry sandstone core before any fluid flow experiments were conducted for details of the dry scan the reader is referred to herring et al 2022 for the identification of the grain phase to identify the brine and the scco2 phase a converging active contours cac routine sheppard et al 2004 was applied in this method a lower and a higher intensity thresholds were chosen by the user based on the intensity histogram where voxels with grayscale level smaller than the lower threshold were classified as scco2 and voxels with grayscale level higher than the upper threshold were classified as brine voxels with intensity values between the two thresholds were classified as scco2 or brine by the algorithm image processing of the dissolution scans is briefly described herein a detailed example of the segmentation workflow can be found in the supplementary material s2 the dissolution scans were registered to the base scan and re mapped to the base scan voxel size of 3 92 μ m the registered data were firstly segmented into two phases the scco2 phase and a combined brine and grain phase then the solid phase as identified in the original high resolution dry scan was overlaid to produce a three phase segmentation due to image noise and motion artifacts the segmentation algorithm yielded a number of unphysically small scco2 clusters being smaller than the smallest bentheimer pore volume 234 voxels equivalent to sphere of radius 15 0 μ m these clusters were removed by relabeling their voxels as brine this removed an insignificant fraction of scco2 equaling 0 6 of the total scco2 volume in each of the dissolution scans in addition all isolated brine labeled clusters floating within scco2 clusters were relabeled as scco2 since such clusters are also unphysical for the resulting segmented images the porosity of the sample the bulk scco2 saturation in each of the scans and the volume of individual scco2 clusters were determined by counting the number of voxels occupied by the three phases and the clusters the scco2 brine and the scco2 grain ifas for individual scco2 clusters were determined using a three phase extension of the algorithm of ohser and mücklich 2001 that computes unbiased surface area from voxelated data sets 2 4 scco2 clusters matching and calculation of mass transfer coefficient considering the small ca at the order of 10 7 for the dissolution experiment it was initially expected that no mobilization of scco2 clusters would occur and the scco2 clusters would only undergo in situ dissolution to track the change in the volume and the ifa for each scco2 cluster during the imbibition a cluster matching routine was applied in which each scco2 cluster was given a unique label for every two consecutive dissolution scans two criteria were used to determine if two potentially matching clusters should be matched between scans 1 a maximum allowable distance between the clusters centers and 2 a maximum relative difference in cluster volume these values at voxel size of 3 92 μ m were 4 voxels and 99 respectively these values maximized the number of matched clusters the process of cluster matching was repeated until no additional match for the clusters in the earlier scan was found in the later scan with any unmatched clusters in the former scan labeled as completely depleted multiple clusters in the former scan that were matched to an identical cluster in the latter scan were identified as part of a merged cluster similarly multiple clusters in the later scan that were subsequently matched to a single cluster in the earlier scan were identified as part of a snapped off cluster the repetition of the 1 to 1 cluster matching allows 1 to many matching we based our quantitative analysis of scco2 mass transfer by applying eq 1 to each matched cluster independently using the results of cluster matching the ifa and the change in volume determined for each scco2 cluster between every two consecutive scans by rearranging eq 1 the mass transfer coefficient for each cluster that was partially completely depleted can be calculated from 4 k ρ δ v δ t 1 a c 0 c 1 in this study δ t was taken as the time between the midpoint of the two consecutive scans generally 30 mins with δ v and a determined based on the method discussed in section 2 3 under the experimental conditions the solubility limit of scco2 in brine was c 0 41 kg m3 0 95 mol kg sun et al 2021 3 results and discussion examples of virtual slices of grayscale tomograms and the corresponding segmentation data are shown in fig 1 for the base and the dissolution scans although the image resolution was approximately 5 coarser for the dissolution scans as compared to the base scan due to the reduced data acquisition time image registration allowed pore features and scco2 clusters to be well aligned and the cluster matching workflow was able to be performed on the sequence of registered dissolution data sets with cluster volumes determined from the segmented and labeled files the cluster size distribution for the base scan indicates that peak of the distribution of completely depleted scco2 clusters had an equivalent radius assumed sphere of 9 voxels at 3 92 μ m voxel size while for the dissolution scans the peak occurred at 27 voxels comparison of the high and low resolution data sets demonstrated that small clusters present in the base scan were not resolvable in the dissolution scans due to the larger voxel size at a shorter data acquisition time it has also been reported by huang et al 2021 that significant inconsistency in ifa measurements might occur for a fluid fluid sandstone system when imaged at different image resolution therefore for consistency in image resolution and subsequent parameter measurements quantitative data analysis was performed on dissolution scans d1 9 only neglecting the high resolution base scan with the parameter measurements acquired following section 2 3 the sample porosity within the cropped volume was 0 20 this value was consistent for all the dissolution scans as the segmented dissolution data sets were produced via combination with the segmented dry scan as detailed in section 2 3 the initial bulk scco2 saturation of the cropped sample for scan d1 was 11 9 with the number of scco2 clusters equal to 11217 3d visualization generated with drishti limaye 2012 shows that trapped scco2 clusters were not distributed evenly within the cropped sample instead two fingers comprised of scco2 clusters were observed fig 2 we suspect the fingers were formed due to the low permeability layer located at the bottom of the core which induced capillary heterogeneity for details of the low permeability layer the reader is referred to herring et al 2022 the pv for the full sample determined from the segmented dry scan was 0 8 ml table 3 shows the scco2 saturation and the number of scco2 clusters as a function of pv of brine injected the scco2 saturation profile for each dissolution scan is shown in fig 3 consistent with the visualization in fig 2 the saturation profile of d1 demonstrates that throughout the dissolution experiment trapped clusters were concentrated at the upper part of the sample 3 1 matching and time evolution of scco2 clusters examples of the results from cluster matching are shown in figs 4 and 5 the 1 to 1 cluster matching allows the tracking of cluster growth and dissolution between the scans while clusters that were part of a snapped off or merged cluster were also identified through many to 1 and 1 to many matching following repeated application of the algorithm as described in section 2 4 results of scco2 clusters matching are visualized as bubble charts using matlab with data labeled te1 te for time evolution showing the change between scan d1 and the subsequent scan d2 fig 6 these provide an overview of the time evolution of scco2 clusters throughout the dissolution experiment the volume normalized composition of scco2 clusters for each cluster group identified during cluster matching is shown in fig 7 a clusters whose volume changed by less than 10 between consecutive scans are considered stable from fig 7 a some growth in scco2 clusters was identified in te1 indicating possible cluster mobilization and coalescence this was unexpected as the sample was flushed with co2 saturated brine at high ca before the low ca dissolution experiment as discussed in section 2 1 we suspect that mobilization of scco2 clusters can be attributed to an abrupt pressure increase across the core upon initiation of brine pumping for bulk brine pressure recorded during the dissolution experiment see supplementary material s1 the pressure increased at the beginning of scan d1 and remained relatively stable in the later scans d2 9 with maximum deviation of approximately 5 psi 0 03 mpa which we consider to have negligible impact on our study no dissolution of scco2 was evident during the time interval from scan d1 to d2 i e te1 as the overall scco2 saturation was unchanged between these two scans table 3 the lack of dissolution is due to the time delay required for displacement of resident co2 saturated brine from the flushing experiment by the incoming fresh brine however some scco2 clusters must have been displaced from the bottom to the middle of the sample as is shown in the scco2 saturation profile fig 3 which shows d1 having higher scco2 saturation at the bottom and lower saturation in the middle while for d2 the saturation is higher in the middle compared to the bottom 3 2 mass transfer coefficient of scco2 clusters significant dissolution depletion of scco2 occurred in te2 as indicated by the shrinkage of scco2 clusters in the corresponding bubble chart fig 6 b as no growth in scco2 clusters was observed in te2 and the overall saturation decreased table 3 the depletion of scco2 was attributed to scco2 dissolution by brine however it was also observed that many scco2 clusters grew in the subsequent data sets te3 and te4 fig 6 c d indicating that the scco2 dynamics were not dominated solely by dissolution in this part of the experiment therefore in addition to te1 data sets te2 4 were also excluded from quantitative analysis of scco2 dissolution we will further investigate data sets te3 and te4 in section 3 4 no obvious growth in scco2 clusters was observed in te5 8 as is shown in bubble charts fig 6 e h and by the volume fraction of scco2 clusters grown calculated between 0 4 to 3 4 of the total scco2 volume in the corresponding scans fig 7 a the bubble charts also show that a dissolution front of quite uniform thickness was formed in these scans fig 6 e h with the tip of the bulk scco2 phase receding by approximately 500 voxels along the z axis in each of te5 8 fig 8 furthermore the amount of scco2 that was partially or completed depleted is consistent in these scans fig 7 b and we therefore considered that the system reached a dissolution dominated regime in te5 8 and the quantitative analysis of scco2 mass transfer into brine was performed on these data sets following eq 4 since snap off and cluster merging contributed to less than 5 of the scco2 depletion in te5 8 fig 7 b we focus on partially and completely depleted clusters in this study as no measurement of the in situ co2 concentration field c 1 in the vicinity of the scco2 clusters can be directly measured in our experiments to apply eq 4 we make an initial assumption that c 1 0 reducing eq 4 to 5 k ρ δ v δ t 1 a c 0 ρ v 1 v 2 δ t 1 a c 0 where v 1 and v 2 denotes the volume of the depleted cluster in the earlier and later scans respectively considering that residual co2 saturated brine might still be present in the upper regions of the core reflected by the stable region and that the region directly above the dissolution front necessarily has a non zero co2 concentration in brine we did not apply this equation to the stable clusters nor to the partially depleted clusters above the active dissolution front fig 8 after inspecting the bubble charts fig 6 e h and the dissolution front fig 8 the completely depleted scco2 clusters were dissolved between every two consecutive scans in a consistent pattern indicating that the system has reached a dissolution dominated regime therefore we considered that the completely depleted clusters located in the most outer layer of the bulk scco2 phase were in sufficient contact with the incoming fresh brine and the assumption of zero dissolved co2 concentration was applicable for this cluster group another important factor to consider when applying eq 5 is the choice of the time averaged ifa a throughout which mass transfer occurred debates still remain on whether mass transfer occurs through the total ifa of the dissolving compound or if this process occurs mainly through the fluid fluid ifa agaoglu et al 2015 patmonoaji and suekane 2017 in this study since the completely depleted clusters shrank and dissolved in one scan interval of 30 mins even if the cluster interfaces were in contact with the grain at the beginning of the scan interval i e the fluid fluid ifa was less than 100 of the interface at the beginning of the scan as the clusters dissolved and fully depleted brine was able to flow through the crevices and participate in scco2 mass transfer fig 9 therefore we assume that scco2 mass transfer occurred through the total cluster ifa to estimate how the ifa might evolve as a cluster dissolves we plot the total ifa a t versus the volume v for each scco2 cluster a clear power law correlation was apparent for the plots and fitting parameters see table s1 column 1 in the supplementary material assuming that as a cluster dissolves it follows this power law we estimate the time averaged total ifa for each cluster as the total ifa when the cluster volume has reduced by half i e reduced by 1 2 δ v with δ v the volume loss between the two scans the histogram of calculated mass transfer coefficients k for completely depleted clusters in te5 8 is shown in fig 10 a the mass transfer coefficient for individual scco2 clusters ranges between 3 0 10 5 and 3 5 10 4 mm s and peaks at approximately 5 0 10 5 mm s however by inspecting the volume weighted distribution of k fig 10 b the total volume of clusters with k equal to 5 0 10 5 mm s only made up approximately 0 5 of the total volume of the completely depleted clusters this indicates that such calculations are biased by small but numerous clusters that might have been completely depleted in a time interval that was much shorter than δ t resulting in underestimation in k following eq 5 to obtain an average k that is representative of the system while still taking into account the underestimated k from the small clusters we propose an ifa weighted effective macroscopic mass transfer coefficient k calculated following 6 k k i a i a t l a y e r where k i and a i denotes the mass transfer coefficient and the ifa of each completely depleted scco2 clusters in te5 8 and a t l a y e r denotes the sum of the total ifa of these clusters we propose weighting each k by ifa because as discussed above some clusters that dissolved completely will actually have dissolved in less time than the scan duration δ t causing k calculated for these clusters from eq 5 to be an underestimate weighting by ifa reduces the impact of these very small clusters due to their smaller ifa in this study k calculated over the 5891 completely depleted clusters in te5 8 is 1 4 10 4 mm s larger than the peak value of the number weighted histogram in fig 10 a of 5 0 10 5 mm s indicating that the peak was biased by the underestimated k from small clusters while as demonstrated in eq 6 a system averaged mass transfer coefficient for our experiment might still be obtained by weighting individual k by the corresponding total ifa of scco2 cluster the system averaged mass transfer coefficient k obtained in this study is four orders of magnitude smaller than the bulk mass transfer coefficient of 5 4 mm s reported by jiang et al 2016 for scco2 mass transfer into brine in a berea sandstone calculated based on eqs 1 and 3 the discrepancy might be caused by scco2 displacement the authors observed in their study which resulted in overestimation of the amount of scco2 depleted by dissolution and therefore the mass transfer coefficients we also note that the heterogeneous layer presented in the berea core in their study might caused the difference in mass transfer coefficient measurement following the same equations mass transfer coefficients of gaseous co2 gco2 into water brine in a glass bead pack have been reported by jiang et al 2017 at 10 6 10 5 mm s the main values acquired by patmonoaji and suekane 2017 ranges from 10 5 10 4 mm s for a plastic resin bead pack these values are closer to our estimated k however gco2 has a lower solubility limit than scco2 so the values are not directly comparable mass transfer coefficients reported by these previous studies might also be overestimated due to simplifications inherent in modeling a 3d system with a 1d equation eq 3 we provide further analysis of this issue in section 3 3 and in the supplementary material s5 it should be noted that even for a consistent fluid pair e g scco2 and brine the mass transfer coefficient will vary with experimental conditions such as pressure and temperature that would affect fluid properties and solubility and flow rates permeability and tortuosity of different types of porous medium would also affect the in situ fluid configuration and hence the mass transfer coefficient for the investigated system 3 3 back calculation of the co2 concentration fields until now we have assumed zero co2 concentration in the brine surrounding the scco2 clusters that were completely depleted in te5 8 which was justified by choosing clusters within the dissolution front we now extend our analysis to clusters further from the dissolution front where there will be significant co2 dissolved in the brine considering that the total ifa weighted k obtained is a representative mass transfer coefficient for the system the in situ co2 concentration in brine in the vicinity of the scco2 clusters can be back calculated by rearranging eq 4 as 7 c 1 c 0 ρ δ v δ t 1 k a we applied this calculation for the partially dissolved clusters in te5 8 and for all dissolved clusters in te2 4 this is based on the theory that the mass transfer coefficient is a constant for a certain system i e for a cluster in the system doubling the ifa or the concentration difference will double the mass transfer the 1st term in eq 1 and vice versa cussler 2009 for the partially depleted clusters surrounded by brine with non zero co2 concentration c 1 eq 7 can be applied to estimate c 1 with all the other parameters known for the partially depleted clusters as brine flow through thin layers near solid walls is not expected to be as significant as compared to the case for the completely depleted clusters we now assume that the scco2 mass transfer occurred mainly through the fluid fluid ifa for the partially depleted clusters the assumption that the mass transfer occurs through the total ifa was still applied for the completely depleted clusters for the estimation of the time averaged fluid fluid ifa a f another power law fit was applied to the fluid fluid ifa versus volume of the partially depleted scco2 clusters in te5 8 fitting parameters summarized in table s1 column 4 in the supplementary material as cluster mobilization was observed in te2 4 no power law fitting was applied to clusters in these data sets as the correlation between the total fluid fluid ifa and the volume of the clusters might not be representative of cluster dissolution rather the power law fits obtained from te5 8 were applied for both the partially and the completely depleted clusters in te2 4 following a similar argument for estimating the time averaged total ifa as discussed in section 3 2 the time averaged fluid fluid ifa for the mass transfer process in this case was calculated as the value at the midpoint of the cluster shrinkage i e at 1 2 δ v results for the back calculated concentration field normalized by the solubility limit c 0 calculated for both the partially and the completely depleted clusters is shown in fig 11 for data set te2 the concentration field increases from the inlet towards the outlet of the core in the direction of brine injection with the highest concentration field located near the region of stable clusters indicating the by passing of nearly scco2 saturated brine this behavior is in line with the observation that only minimal scco2 dissolution occurred in the stable region it should be noted that cluster mobilization will cause an overestimation of the dissolution caused δ v resulting in an underestimation of the surrounding concentration as defined by eq 7 it should also be noted that there will always exist clusters with negative concentration field as the system averaged k is always smaller than the k calculated for some clusters this resulted in an unavoidable side effect of this method with the mathematically implausible negative co2 concentration field calculated for some clusters located at the lower part of the sample where the clusters were in direct contact with the fresh brine however the back calculated concentration fields still provide informative insight into the in situ co2 concentration in brine within the porous medium sample we have included additional discussion of how different assumptions of ifa for mass transfer will affect the resulting concentration fields in the supplementary material s4 we have also included results of 1d co2 concentration fields calculated based on eq 3 in supplementary material s5 overall it is clear that the 1d eq 3 is not always capable of describing the fluid dynamics in 3d systems in our study the dissolution front was not parallel to the direction of brine injection fig 6 and the 1d co2 concentration fields that eq 3 would predict are not in line with the observations made based on the bubble charts 3 4 mobilization and growth of scco2 clusters apart from te1 unexpected cluster mobilization was also observed in te3 and te4 even though a flushing imbibition experiment was conducted at high ca before the dissolution experiment unlike for te1 the pressure applied across the core remained relatively stable for te3 and te4 for bulk brine pressure recorded during the dissolution experiment see supplementary material s1 indicating that the cause of cluster mobilization in these two scans was different to that for te1 one theoretical cause for the cluster mobilization in these two data sets could be ostwald ripening which occurs as larger bubbles grow at the expense of smaller ones due to the difference in laplace pressure between the bubbles ostwald 1897 leal calderon et al 2007 however results from simulation indicate that the time scale for ostwald ripening is in the order of years de chalendar et al 2018 xu et al 2019 li et al 2020 which is orders of magnitude too long to be relevant here one might also argue that the larger laplace pressure of smaller scco2 bubbles might lead to faster mass transfer of scco2 into brine and eventually result in growth in other clusters due to ostwald ripening however for the bentheimer sandstone at high brine saturation in our study the laplace pressure for the trapped scco2 bubbles is approximately 0 1 mpa herring et al 2017 with the overall pressure of the system equaling 8 62 mpa as discussed in section 2 1 the difference in pressure between the scco2 bubbles and the surrounding brine is only 1 we therefore expect this to have a negligible effect on the concentration of co2 in the brine surrounding these clusters particularly given that solubility is a relatively slowly varying function of pressure koschel et al 2006 therefore the observed cluster mobilization in te3 and te4 cannot be attributed to ostwald ripening histograms of the change in volume of the grown clusters i e the volume gained by the grown clusters are shown in fig 12 for te2 8 along with the histogram of the throat radius equivalent sphere in the sample i e the volume of the sphere within the same radius as each throat from fig 12 the total size grown for the scco2 clusters was small and comparable to the size of the throat radius equivalent sphere indicating that growth could be due to small bubbles mobilized through these throats we hypothesize that small mobilized clusters might have been generated during the snap off of partially depleted clusters with further dissolution the clusters might shrink and eventually be small enough to pass through the neighboring throats see fig s7 in the supplementary material for demonstration of the pore throat network generated for the bentheimer sample in this study a similar displacement pattern of napl clusters was reported by schnaar and brusseau 2006 and was attributed to a decrease in the size of the napl blobs they also note that there is a possible reduction in the ift between the fluid fluid phases caused by the addition of hydroxypropyl β cyclodextrin hpcd in their study in the case of scco2 dissolution into water decrease in the fluid fluid ift has been reported by irfan et al 2018 during the measurement of the ift between scco2 and brine water and was attributed to the high co2 concentration in water near the fluid fluid interface as reported by espinoza and santamarina 2010 therefore apart from decrease in the size of scco2 clusters cluster mobilization observed in the current study might also be attributed to the reduction in the scco2 brine ift due to higher co2 concentration in the surrounding brine compared to the observed significant cluster mobilization in te3 and te4 only minimal cluster mobilization and associated cluster growth was observed in te5 8 figs 6 7 a and 8 although the fluid fluid ift might decrease as scco2 dissolution progressed the diminished cluster mobilization in these data sets indicates the majority of the small clusters generated by snap off of partially depleted clusters were completely dissolved with the incoming fresh brine the mobilization of small clusters in earlier scans might indicate that the brine participated in scco2 depletion was partially saturated by co2 as a result of the mixing of the co2 saturated and the fresh brine below the cropped sample i e below the field of view of data analysis in this study overall we suspect the cluster mobilization is due to the combined effect of 1 small scco2 clusters generated due to the incomplete dissolution of the snapped off partially depleted clusters and 2 the high co2 concentration in nearby brine leading to reduced scco2 brine ift this indicates that co2 dissolution might result in additional mobilization of scco2 clusters which was observed in this study with the ability to image relatively tall samples using helical scanning 4 conclusion in this study we used x ray micro computed tomographic mct imaging to investigate the mass transfer process within a scco2 brine bentheimer sandstone system for application to geologic carbon sequestration both qualitatively and quantitatively the time evolution of scco2 clusters between consecutive scans was tracked at a relatively short time interval of approximately 30 mins through a cluster matching workflow and further data analysis scco2 clusters were classified as partially depleted completely depleted grown stable snapped off or merged this provided qualitative insights of the time evolution of scco2 clusters throughout brine injection with regions of cluster growth brine by passing and cluster depletion being located inside of the sample for the quantitative analysis we focused on completely and partially depleted clusters as these two groups contributed to more than 95 of the scco2 volume lost in this study in scans during which the system was considered to have reached a dissolution dominated regime mct data provided the ability to measure the volume and the total and fluid fluid ifa for each scco2 cluster and cluster matching then enabled the mass transfer coefficient k to be calculated for each scco2 cluster that was completely depleted results indicate that k was underestimated for small clusters as these clusters might have fully dissolved in a shorter period than the time between scans however k obtained for the small clusters still serves as a lower bound for the mass transfer coefficient for these clusters and the system the mass transfer coefficient k calculated for the scco2 clusters assuming mass transfer occurred through the entire cluster ifa ranges between 3 0 10 5 and 3 5 10 4 mm s with a system averaged value of k 1 4 10 4 mm s as mass transfer coefficient is theoretically a constant for certain systems the estimated k could be used to back calculate the co2 concentration field for partially and completely depleted clusters the back calculated concentration field suggests that the concentration field was nearly at saturation near the region of stable clusters where minimal cluster dissolution was observed i e the nearly saturated brine was unable to further dissolve co2 we also compared the observations made based on bubble charts with co2 concentration fields calculated based on the 1d model and we conclude that 1d equations might not always be capable of describing the fluid dynamics when applied for 3d systems with heterogeneous fluid distributions to the best of our knowledge this is the first study that utilized mct to track the time evolution of scco2 clusters for an experiment investigating scco2 dissolution in porous media and calculated the mass transfer coefficient for individual scco2 clusters we also present a methodology to use the system averaged mass transfer coefficient to back calculate the in situ co2 concentration field we expect that k calculated for scco2 clusters and the system averaged k obtained in this study might serve as reference mass transfer coefficient values for the application of geologic carbon sequestration under similar state and flow conditions furthermore it is also expected that the methodology and both the qualitative and quantitative results presented in this study will also be relevant to applications such as groundwater remediation of napls with the helical scanning trajectory utilized at the anu ctlab we were able to image relatively tall samples and observed significant cluster mobilization at certain points during the experiment even though all clusters were capillary trapped prior to the fresh brine injection we observed that the size increase for the clusters that grew was comparable to the size of the sandstone throats and the possible occurrences of cluster mobilization might have been due to the combined effect of incomplete dissolution of snapped off clusters leading to reduced volume and the reduced fluid fluid ift due to the rising co2 concentration in brine our observations indicate that additional mobilization of scco2 clusters might be linked to scco2 dissolution and the coupling of these processes needs to be understood on larger scales to improve the security of geologic carbon sequestration credit authorship contribution statement ruotong huang conceptualization formal analysis methodology writing original draft review editing anna l herring conceptualization investigation supervision writing review editing adrian sheppard resources supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments r h a h and a s acknowledge financial support provided by the australian research council via the arc training centre for multiscale 3d imaging modelling and manufacturing m3d innovation project ic 180100008 a h acknowledges financial support via australian research council arc de180100082 imaged data was scanned at the national laboratory for x ray micro computed tomography ctlab based at the australian national university anu we want to thank levi beeching michael turner mohammad saadatfar lydia knuefing and rob middleton for data acquisition and handling support appendix a supplementary data supplementary material related to this article can be found online at https doi org 10 1016 j advwatres 2022 104338 appendix a supplementary data the following is the supplementary material related to this article mmc s1 
67,understanding the mass transfer of co 2 into formation brine both qualitatively and quantitatively is important for improving the security of geologic carbon sequestration in this study quasi dynamic x ray micro computed tomographic mct imaging was used to track the time evolution of supercritical co 2 scco 2 clusters in a sandstone throughout brine injection a cluster matching workflow enabled the identification of depletion merging and snap off of the scco 2 clusters and subsequently the mass transfer coefficient of individual scco 2 clusters was found to range between 3 0 10 5 and 3 5 10 4 mm s the macroscopic average mass transfer coefficient was estimated as 1 4 10 4 mm s for application to geologic carbon sequestration these values give an indication of the range of mass transfer coefficients that may be expected for similar state and flow conditions with the macroscopic average mass transfer coefficient evaluated we back calculated the in situ co 2 concentration field for brine which provides quantitative insight of the distribution of dissolved co 2 in the sample despite slow injection rate ca 10 7 mobilization of small scco 2 clusters was also observed and was attributed to the combined effect of incomplete dissolution of snapped off clusters and the reduction in the fluid fluid interfacial tension ift due to the high local co 2 concentration in brine accompanying scco 2 dissolution this highlights the coupling of dissolution and mobilization processes and demonstrates the need to understand these interlinked dynamics to improve co 2 storage in geological formations keywords dissolution dissolution trapping geologic carbon sequestration x ray micro computed tomography multiphase flow porous media data availability segmented data of the dissolution scans are publicly available via the anu data commons doi https doi org 10 25911 hgam 8n67 1 introduction increasing anthropogenic emission of heat trapping carbon dioxide co2 gas as compared to the pre industrial level is considered the main cause of global warming concerns on how global warming might significantly impact natural and human systems have been raised ipcc 2018 pledges made following the paris agreement and the 2021 united nations climate change conference cop26 aim for the reduction of co2 emissions such that net zero carbon emission is achieved globally by 2050 and global warming is limited to 2 c and ideally 1 5 c as relative to the pre industrial level kelemen et al 2019 these goals are likely to require the development and deployment of methods for co2 capture and storage ccs geologic carbon sequestration works by storing captured and compressed co2 in target geological formations such as saline aquifers metz et al 2005 benson and cole 2008 leung et al 2014 kelemen et al 2019 newell and ilgen 2019 with an estimated capacity of storing 4 000 23 000 gt of co2 de coninck and benson 2014 geologic carbon sequestration in saline aquifers is expected to play a crucial role in mitigating global warming particularly in support of negative emissions technologies and zero carbon industrial processes after the injection of co2 ceases the co2 plume migrates both laterally away from the injection well along the direction of injection and vertically due to buoyancy forces bachu 2008 eventually the plume may spread approximately 10 km in width and 100 m in height bourg et al 2015 as the plume migrates upwards it poses a risk of co2 leakage the likelihood of leakage is greatly reduced with structural trapping where a low permeability cap rock prevents escape of the plume benson and cole 2008 furthermore spontaneous re imbibition of formation brine can disconnect the co2 plume into clusters by pore scale snap off at the trailing edge of the plume causing the co2 to be trapped in the pore space by capillary forces bachu 2008 such capillary trapping resulting from combined effect of the disconnection of the co2 plume and the presence of pore scale capillary forces enhances the security of co2 storage metz et al 2005 benson and cole 2008 macminn et al 2010 krevor et al 2015 krevor et al 2015 reported capillary trapping efficiency of 30 40 of pore volume for numerous rock types along with structural trapping the two trapping mechanisms are responsible for a significant amount of more than 50 of the total trapping contribution in a timescale of several hundreds of years after co2 has been injected metz et al 2005 other than the two trapping mechanisms discussed above that occur shortly after co2 is injected trapped co2 will gradually dissolve into formation brine in a longer timescale of tens to thousands of years iglauer 2011 leslie et al 2021 commonly known as dissolution trapping this mechanism promotes even safer geologic carbon sequestration as dissolved co2 increases brine density and causes co2 rich brine to sink relative to the formation groundwater eliminating the risk of co2 escape due to buoyancy forces peter et al 2022 co2 dissolution also reduces the possibility of residual co2 cluster remobilization due to larger co2 cluster size herring et al 2013 datta et al 2014 iglauer and wülling 2016 higher capillary number ca andrew et al 2014 armstrong et al 2014 datta et al 2014 or higher connectivity of the co2 phase herring et al 2013 2015 schlüter et al 2016 hu et al 2020 on longer timescales of millions of years dissolved co2 may precipitate as carbonate minerals from which the risk of co2 mobilization and leakage is minimal metz et al 2005 ajayi et al 2019 on timescales of hundreds to thousands of years the trapping contribution of dissolution and mineral trapping will gradually overtake the amount contributed by structural and residual trapping reaching approximately 70 on a timescale of 10 000 years metz et al 2005 this highlights the importance of understanding the dissolution of trapped co2 into the formation brine one important parameter for quantitatively understanding the dissolution of co2 into formation brine is the mass transfer coefficient k which can be calculated based on mass balance of the solution miller et al 1990 cussler 2009 1 d m d t ρ d v d t k a c 0 c 1 where d m d t denotes the change in the mass of co2 with time a the interfacial area ifa between the bulk co2 phase and brine c 0 and c 1 the solubility limit and the concentration of co2 in the brine respectively since the presence of porous media restricts fluid flows and reduces the rate of co2 mass transfer through dissolution it is important to measure the in s i t u mass transfer coefficient for co2 dissolution within porous media for actual application to geologic carbon sequestration earlier studies investigating the mass transfer coefficient in porous media have been performed to study the dissolution of non aqueous phase liquids napls for application to groundwater remediation miller et al 1990 powers et al 1992 imhoff et al 1994 due to the opacity of porous media direct optical access of fluid configurations inside the porous media was impossible and the ifa of the dissolving napl was unknown in these studies therefore the mass transfer rate coefficient k was defined as a lumped parameter of k and the ifa through which mass transfer occurred with eq 1 rewritten as 2 ρ d v d t k c 0 c 1 the in situ napl concentration in the sample was determined based on the one dimensional advection dispersion equation bear 2013 imhoff et al 1994 by neglecting dispersion and assuming there was no accumulation of the napl in the control volume 3 ρ ϕ s n t q c x where ρ ϕ s n and q denotes the density of napl porosity of the porous medium saturation of napl and the darcy velocity of the solution respectively c x denotes the change in napl concentration in the solution across some distance x with the concentration of dissolved napl determined from the effluent collected during experiments the k in the sample as a function of x and t could be determined by integrating eq 3 and substituting the resulting c 1 x t into eq 2 however it was reported by miller et al 1990 that k obtained in this way might be sensitive to the concentration of napl dissolved in the effluent where a small increase in the concentration might result in significant increase in the measurements of k at high effluent concentrations more recently with the emergence and rapid development of x ray micro computed tomographic mct imaging in the last two decades visualization of fluid configurations inside the opaque porous media has become possible at the scale of micrometers wildenschild et al 2002 wildenschild and sheppard 2013 cnudde and boone 2013 schlüter et al 2014 gan et al 2020 this nondestructive imaging technique enables the acquisition of in situ fluid configuration within a porous medium and with further data processing microscopic parameters such as porosity fluid saturation and interfacial area can be evaluated culligan et al 2004 2006 costanza robinson et al 2008 brusseau et al 2006 2008 mcdonald et al 2016 jiang et al 2019 the ability to directly measure interfacial area allows the mass transfer coefficient k to be investigated independently as compared to the lumped parameter k for napls schnaar and brusseau 2006 hu et al 2021 and nitrogen gas in porous media patmonoaji et al 2021a b although the solubility of co2 is generally higher compared to napls chang et al 1998 eqs 1 and 3 have also been applied to co2 to investigate k due to the similar mass transfer behavior of the two fluids once trapped in porous media jiang et al 2016 2017 patmonoaji and suekane 2017 patmonoaji et al 2021b in this study we aim to investigate the mass transfer of supercritical co2 scco2 into brine under conditions relevant to geologic carbon sequestration in saline aquifers through mct the time evolution of trapped scco2 clusters during brine injection was tracked and with the measured volume and ifa for the clusters the mass transfer coefficient k was evaluated for the clusters furthermore based on the individual mass transfer coefficients measured for each cluster a method for back calculating the spatial distribution of the co2 concentration field dissolved within the brine phase was developed and implemented for this experiment throughout the text we use scco2 to denote the scco2 phase trapped in porous medium and co2 to denote the dissolved co2 in brine 2 experiment and method 2 1 scco2 dissolution experiment and mct scans dissolution of trapped scco2 bubbles was investigated for an scco2 brine bentheimer sandstone system we chose bentheimer sandstone as the porous medium in our study as this water wet sandstone composed of mainly quartz is considered an ideal model system for studying fluid transport within porous media due to its isotropic and relatively homogeneous structure peksa et al 2015 which also makes it possible to capture the full range of pore scale features in a single representative 3d mct image herring et al 2019 the diameter and the height of the cylindrical core was 12 and 36 mm respectively to mimic the condition of geological carbon sequestration sites that are usually below a depth of 800 m metz et al 2005 benson and cole 2008 the pressure and the temperature for the system was kept at 1250 psi 8 62 mpa and 45 c respectively under which co2 forms a supercritical fluid scco2 for the flow experiments the wetting phase wp that shows a stronger affinity to the rock surface was water the non wetting phase nwp which shows less affinity to the grain surface was scco2 due to the similar x ray attenuation of water and scco2 the water was doped with x ray attenuating potassium iodine ki at concentration of 1 1 m resulting in doped brine that is more x ray attenuating than scco2 prior to injection scco2 was saturated with brine by mixing the two fluids under the working temperature and pressure for 48 h we therefore expect negligible further solubility of brine dissolution into scco2 throughout the experiment after a series of drainage imbibition experiments during which the wp and the nwp were injected separately into the sandstone core in cycles for details of the drainage imbibition experiments and the experimental setup of the subsequent flushing and dissolution experiments the reader is referred to herring et al 2022 scco2 was trapped in the pore space of the sandstone core with the end point scco2 saturation equaled 11 1 for the entire sample to reduce the possibility of scco2 mobilization during the subsequent dissolution experiment an additional imbibition experiment was conducted during which the core was flushed with 20 pore volume pv of co2 saturated brine injected upwards at a relatively high flow rate of 0 388 ml min which was nearly 20 times as fast as the subsequent dissolution experiment the capillary number defined as c a μ u σ with μ and u the viscosity and the velocity of brine respectively and σ the interfacial tension ift between scco2 and brine see table 1 for fluid properties was within the range for cluster mobilization to occur ca listed in table 2 wang et al 2019 therefore after the flushing experiment it was expected that only residually trapped scco2 clusters were left and a high resolution base scan was acquired for the entire core as a reference for subsequent dissolution experiment to mimic background groundwater flow in the aquifers fresh brine without dissolved co2 was injected upwards at a much slower flow rate for the dissolution experiment corresponding to ca of 2 4 10 7 significantly smaller than that for the flushing experiment table 2 therefore it was expected that any depletion of scco2 observed during the dissolution experiment could be attributed to scco2 dissolution 2 2 mct scans and data reconstruction a helical space filling trajectory is utilized for the acquisition of mct data in the national laboratory for x ray micro computed tomography ctlab at the australian national university anu helical scanning allows samples with high aspect ratio to be continuously imaged without the need to stitch together data blocks with helical scanning the tuy sufficiency condition is also satisfied providing a complete set of viewing directions allowing 3d data reconstruction from high cone angle projections tuy 1983 varslot et al 2011 2012 for the space filling trajectory 2d projection images are taken as distinct points that fill the space in a maximally isotropic sampling pattern kingston et al 2016 2018 for the high resolution base scan to maximize the image resolution the mct data was acquired via two stage region of interest imaging roi which uses an overview scan and a region of interest scan the overview scan was firstly acquired with the entire sample and core holder in the x ray field of view at a lower magnification this low resolution scan was followed by the roi scan for which the field of view comprised only an internal portion of the core this results in high magnification artifact free images of the central region of the sample this is possible because the missing edge features are removed from the roi scan using the reference overview scan allowing the roi scan to be reconstructed as if it were full field data maaß et al 2011 the total time taken for the overview and the region of interest scan was 17 h 27 mins and the voxel size for the base scan was 3 92 μ m for the dissolution experiment a total of 34 faster mct scans were taken simultaneously as brine was injected with the space filling trajectory the resultant voxel size equals 19 47 μ m the acquisition time for each scan was approximately 30 mins and the resulting tomographic data represents the average x ray attenuation within each voxel an indicator of material content during each scan the reduced acquisition time for the dissolution experiment makes tracking of the scco2 dissolution process possible scans acquired during the dissolution experiment were then digitally registered mapped to the base scan by aligning pore scale features latham et al 2018 the scanning parameters used for the x ray beam energy was 120 kev and 60 μ a for the reconstruction of mct data into a 3d volume a multi grid iterative image reconstruction method that is preconditioned with a volume space filter was used myers et al 2016 in addition geometric inaccuracies during data acquisition such as mechanical inaccuracy and thermal drift were also corrected by performing multi resolution alignment between simulated re projections and the experimental projections dengler 1989 latham et al 2018 2 3 data processing and scco2 cluster properties with the reconstructed mct data subsequent data processing and analysis were carried out with the anu developed image analysis tool webmango webmango anu edu au sheppard et al 2004 the reconstructed data was cropped into a cylindrical volume with diameter and height equal to 2421 and 4428 voxels 9 50 and 17 37 mm respectively to remove regions containing the core holder confining materials and fluid air outside of the samples and the bottom part of the core where no scco2 was trapped by inspecting the tomographic data for the dissolution scans it was observed that the scco2 phase was highly disconnected i e presented as isolated clusters in the core the mct data also indicates that most of the trapped scco2 has been depleted by the end of the 9th scan therefore we focus on the first nine scans of the dissolution experiment before further data analysis was conducted every voxel in the base scan was assigned with an integer to identify the three physical phases the base scan was first registered to the dry scan i e scan of the dry sandstone core before any fluid flow experiments were conducted for details of the dry scan the reader is referred to herring et al 2022 for the identification of the grain phase to identify the brine and the scco2 phase a converging active contours cac routine sheppard et al 2004 was applied in this method a lower and a higher intensity thresholds were chosen by the user based on the intensity histogram where voxels with grayscale level smaller than the lower threshold were classified as scco2 and voxels with grayscale level higher than the upper threshold were classified as brine voxels with intensity values between the two thresholds were classified as scco2 or brine by the algorithm image processing of the dissolution scans is briefly described herein a detailed example of the segmentation workflow can be found in the supplementary material s2 the dissolution scans were registered to the base scan and re mapped to the base scan voxel size of 3 92 μ m the registered data were firstly segmented into two phases the scco2 phase and a combined brine and grain phase then the solid phase as identified in the original high resolution dry scan was overlaid to produce a three phase segmentation due to image noise and motion artifacts the segmentation algorithm yielded a number of unphysically small scco2 clusters being smaller than the smallest bentheimer pore volume 234 voxels equivalent to sphere of radius 15 0 μ m these clusters were removed by relabeling their voxels as brine this removed an insignificant fraction of scco2 equaling 0 6 of the total scco2 volume in each of the dissolution scans in addition all isolated brine labeled clusters floating within scco2 clusters were relabeled as scco2 since such clusters are also unphysical for the resulting segmented images the porosity of the sample the bulk scco2 saturation in each of the scans and the volume of individual scco2 clusters were determined by counting the number of voxels occupied by the three phases and the clusters the scco2 brine and the scco2 grain ifas for individual scco2 clusters were determined using a three phase extension of the algorithm of ohser and mücklich 2001 that computes unbiased surface area from voxelated data sets 2 4 scco2 clusters matching and calculation of mass transfer coefficient considering the small ca at the order of 10 7 for the dissolution experiment it was initially expected that no mobilization of scco2 clusters would occur and the scco2 clusters would only undergo in situ dissolution to track the change in the volume and the ifa for each scco2 cluster during the imbibition a cluster matching routine was applied in which each scco2 cluster was given a unique label for every two consecutive dissolution scans two criteria were used to determine if two potentially matching clusters should be matched between scans 1 a maximum allowable distance between the clusters centers and 2 a maximum relative difference in cluster volume these values at voxel size of 3 92 μ m were 4 voxels and 99 respectively these values maximized the number of matched clusters the process of cluster matching was repeated until no additional match for the clusters in the earlier scan was found in the later scan with any unmatched clusters in the former scan labeled as completely depleted multiple clusters in the former scan that were matched to an identical cluster in the latter scan were identified as part of a merged cluster similarly multiple clusters in the later scan that were subsequently matched to a single cluster in the earlier scan were identified as part of a snapped off cluster the repetition of the 1 to 1 cluster matching allows 1 to many matching we based our quantitative analysis of scco2 mass transfer by applying eq 1 to each matched cluster independently using the results of cluster matching the ifa and the change in volume determined for each scco2 cluster between every two consecutive scans by rearranging eq 1 the mass transfer coefficient for each cluster that was partially completely depleted can be calculated from 4 k ρ δ v δ t 1 a c 0 c 1 in this study δ t was taken as the time between the midpoint of the two consecutive scans generally 30 mins with δ v and a determined based on the method discussed in section 2 3 under the experimental conditions the solubility limit of scco2 in brine was c 0 41 kg m3 0 95 mol kg sun et al 2021 3 results and discussion examples of virtual slices of grayscale tomograms and the corresponding segmentation data are shown in fig 1 for the base and the dissolution scans although the image resolution was approximately 5 coarser for the dissolution scans as compared to the base scan due to the reduced data acquisition time image registration allowed pore features and scco2 clusters to be well aligned and the cluster matching workflow was able to be performed on the sequence of registered dissolution data sets with cluster volumes determined from the segmented and labeled files the cluster size distribution for the base scan indicates that peak of the distribution of completely depleted scco2 clusters had an equivalent radius assumed sphere of 9 voxels at 3 92 μ m voxel size while for the dissolution scans the peak occurred at 27 voxels comparison of the high and low resolution data sets demonstrated that small clusters present in the base scan were not resolvable in the dissolution scans due to the larger voxel size at a shorter data acquisition time it has also been reported by huang et al 2021 that significant inconsistency in ifa measurements might occur for a fluid fluid sandstone system when imaged at different image resolution therefore for consistency in image resolution and subsequent parameter measurements quantitative data analysis was performed on dissolution scans d1 9 only neglecting the high resolution base scan with the parameter measurements acquired following section 2 3 the sample porosity within the cropped volume was 0 20 this value was consistent for all the dissolution scans as the segmented dissolution data sets were produced via combination with the segmented dry scan as detailed in section 2 3 the initial bulk scco2 saturation of the cropped sample for scan d1 was 11 9 with the number of scco2 clusters equal to 11217 3d visualization generated with drishti limaye 2012 shows that trapped scco2 clusters were not distributed evenly within the cropped sample instead two fingers comprised of scco2 clusters were observed fig 2 we suspect the fingers were formed due to the low permeability layer located at the bottom of the core which induced capillary heterogeneity for details of the low permeability layer the reader is referred to herring et al 2022 the pv for the full sample determined from the segmented dry scan was 0 8 ml table 3 shows the scco2 saturation and the number of scco2 clusters as a function of pv of brine injected the scco2 saturation profile for each dissolution scan is shown in fig 3 consistent with the visualization in fig 2 the saturation profile of d1 demonstrates that throughout the dissolution experiment trapped clusters were concentrated at the upper part of the sample 3 1 matching and time evolution of scco2 clusters examples of the results from cluster matching are shown in figs 4 and 5 the 1 to 1 cluster matching allows the tracking of cluster growth and dissolution between the scans while clusters that were part of a snapped off or merged cluster were also identified through many to 1 and 1 to many matching following repeated application of the algorithm as described in section 2 4 results of scco2 clusters matching are visualized as bubble charts using matlab with data labeled te1 te for time evolution showing the change between scan d1 and the subsequent scan d2 fig 6 these provide an overview of the time evolution of scco2 clusters throughout the dissolution experiment the volume normalized composition of scco2 clusters for each cluster group identified during cluster matching is shown in fig 7 a clusters whose volume changed by less than 10 between consecutive scans are considered stable from fig 7 a some growth in scco2 clusters was identified in te1 indicating possible cluster mobilization and coalescence this was unexpected as the sample was flushed with co2 saturated brine at high ca before the low ca dissolution experiment as discussed in section 2 1 we suspect that mobilization of scco2 clusters can be attributed to an abrupt pressure increase across the core upon initiation of brine pumping for bulk brine pressure recorded during the dissolution experiment see supplementary material s1 the pressure increased at the beginning of scan d1 and remained relatively stable in the later scans d2 9 with maximum deviation of approximately 5 psi 0 03 mpa which we consider to have negligible impact on our study no dissolution of scco2 was evident during the time interval from scan d1 to d2 i e te1 as the overall scco2 saturation was unchanged between these two scans table 3 the lack of dissolution is due to the time delay required for displacement of resident co2 saturated brine from the flushing experiment by the incoming fresh brine however some scco2 clusters must have been displaced from the bottom to the middle of the sample as is shown in the scco2 saturation profile fig 3 which shows d1 having higher scco2 saturation at the bottom and lower saturation in the middle while for d2 the saturation is higher in the middle compared to the bottom 3 2 mass transfer coefficient of scco2 clusters significant dissolution depletion of scco2 occurred in te2 as indicated by the shrinkage of scco2 clusters in the corresponding bubble chart fig 6 b as no growth in scco2 clusters was observed in te2 and the overall saturation decreased table 3 the depletion of scco2 was attributed to scco2 dissolution by brine however it was also observed that many scco2 clusters grew in the subsequent data sets te3 and te4 fig 6 c d indicating that the scco2 dynamics were not dominated solely by dissolution in this part of the experiment therefore in addition to te1 data sets te2 4 were also excluded from quantitative analysis of scco2 dissolution we will further investigate data sets te3 and te4 in section 3 4 no obvious growth in scco2 clusters was observed in te5 8 as is shown in bubble charts fig 6 e h and by the volume fraction of scco2 clusters grown calculated between 0 4 to 3 4 of the total scco2 volume in the corresponding scans fig 7 a the bubble charts also show that a dissolution front of quite uniform thickness was formed in these scans fig 6 e h with the tip of the bulk scco2 phase receding by approximately 500 voxels along the z axis in each of te5 8 fig 8 furthermore the amount of scco2 that was partially or completed depleted is consistent in these scans fig 7 b and we therefore considered that the system reached a dissolution dominated regime in te5 8 and the quantitative analysis of scco2 mass transfer into brine was performed on these data sets following eq 4 since snap off and cluster merging contributed to less than 5 of the scco2 depletion in te5 8 fig 7 b we focus on partially and completely depleted clusters in this study as no measurement of the in situ co2 concentration field c 1 in the vicinity of the scco2 clusters can be directly measured in our experiments to apply eq 4 we make an initial assumption that c 1 0 reducing eq 4 to 5 k ρ δ v δ t 1 a c 0 ρ v 1 v 2 δ t 1 a c 0 where v 1 and v 2 denotes the volume of the depleted cluster in the earlier and later scans respectively considering that residual co2 saturated brine might still be present in the upper regions of the core reflected by the stable region and that the region directly above the dissolution front necessarily has a non zero co2 concentration in brine we did not apply this equation to the stable clusters nor to the partially depleted clusters above the active dissolution front fig 8 after inspecting the bubble charts fig 6 e h and the dissolution front fig 8 the completely depleted scco2 clusters were dissolved between every two consecutive scans in a consistent pattern indicating that the system has reached a dissolution dominated regime therefore we considered that the completely depleted clusters located in the most outer layer of the bulk scco2 phase were in sufficient contact with the incoming fresh brine and the assumption of zero dissolved co2 concentration was applicable for this cluster group another important factor to consider when applying eq 5 is the choice of the time averaged ifa a throughout which mass transfer occurred debates still remain on whether mass transfer occurs through the total ifa of the dissolving compound or if this process occurs mainly through the fluid fluid ifa agaoglu et al 2015 patmonoaji and suekane 2017 in this study since the completely depleted clusters shrank and dissolved in one scan interval of 30 mins even if the cluster interfaces were in contact with the grain at the beginning of the scan interval i e the fluid fluid ifa was less than 100 of the interface at the beginning of the scan as the clusters dissolved and fully depleted brine was able to flow through the crevices and participate in scco2 mass transfer fig 9 therefore we assume that scco2 mass transfer occurred through the total cluster ifa to estimate how the ifa might evolve as a cluster dissolves we plot the total ifa a t versus the volume v for each scco2 cluster a clear power law correlation was apparent for the plots and fitting parameters see table s1 column 1 in the supplementary material assuming that as a cluster dissolves it follows this power law we estimate the time averaged total ifa for each cluster as the total ifa when the cluster volume has reduced by half i e reduced by 1 2 δ v with δ v the volume loss between the two scans the histogram of calculated mass transfer coefficients k for completely depleted clusters in te5 8 is shown in fig 10 a the mass transfer coefficient for individual scco2 clusters ranges between 3 0 10 5 and 3 5 10 4 mm s and peaks at approximately 5 0 10 5 mm s however by inspecting the volume weighted distribution of k fig 10 b the total volume of clusters with k equal to 5 0 10 5 mm s only made up approximately 0 5 of the total volume of the completely depleted clusters this indicates that such calculations are biased by small but numerous clusters that might have been completely depleted in a time interval that was much shorter than δ t resulting in underestimation in k following eq 5 to obtain an average k that is representative of the system while still taking into account the underestimated k from the small clusters we propose an ifa weighted effective macroscopic mass transfer coefficient k calculated following 6 k k i a i a t l a y e r where k i and a i denotes the mass transfer coefficient and the ifa of each completely depleted scco2 clusters in te5 8 and a t l a y e r denotes the sum of the total ifa of these clusters we propose weighting each k by ifa because as discussed above some clusters that dissolved completely will actually have dissolved in less time than the scan duration δ t causing k calculated for these clusters from eq 5 to be an underestimate weighting by ifa reduces the impact of these very small clusters due to their smaller ifa in this study k calculated over the 5891 completely depleted clusters in te5 8 is 1 4 10 4 mm s larger than the peak value of the number weighted histogram in fig 10 a of 5 0 10 5 mm s indicating that the peak was biased by the underestimated k from small clusters while as demonstrated in eq 6 a system averaged mass transfer coefficient for our experiment might still be obtained by weighting individual k by the corresponding total ifa of scco2 cluster the system averaged mass transfer coefficient k obtained in this study is four orders of magnitude smaller than the bulk mass transfer coefficient of 5 4 mm s reported by jiang et al 2016 for scco2 mass transfer into brine in a berea sandstone calculated based on eqs 1 and 3 the discrepancy might be caused by scco2 displacement the authors observed in their study which resulted in overestimation of the amount of scco2 depleted by dissolution and therefore the mass transfer coefficients we also note that the heterogeneous layer presented in the berea core in their study might caused the difference in mass transfer coefficient measurement following the same equations mass transfer coefficients of gaseous co2 gco2 into water brine in a glass bead pack have been reported by jiang et al 2017 at 10 6 10 5 mm s the main values acquired by patmonoaji and suekane 2017 ranges from 10 5 10 4 mm s for a plastic resin bead pack these values are closer to our estimated k however gco2 has a lower solubility limit than scco2 so the values are not directly comparable mass transfer coefficients reported by these previous studies might also be overestimated due to simplifications inherent in modeling a 3d system with a 1d equation eq 3 we provide further analysis of this issue in section 3 3 and in the supplementary material s5 it should be noted that even for a consistent fluid pair e g scco2 and brine the mass transfer coefficient will vary with experimental conditions such as pressure and temperature that would affect fluid properties and solubility and flow rates permeability and tortuosity of different types of porous medium would also affect the in situ fluid configuration and hence the mass transfer coefficient for the investigated system 3 3 back calculation of the co2 concentration fields until now we have assumed zero co2 concentration in the brine surrounding the scco2 clusters that were completely depleted in te5 8 which was justified by choosing clusters within the dissolution front we now extend our analysis to clusters further from the dissolution front where there will be significant co2 dissolved in the brine considering that the total ifa weighted k obtained is a representative mass transfer coefficient for the system the in situ co2 concentration in brine in the vicinity of the scco2 clusters can be back calculated by rearranging eq 4 as 7 c 1 c 0 ρ δ v δ t 1 k a we applied this calculation for the partially dissolved clusters in te5 8 and for all dissolved clusters in te2 4 this is based on the theory that the mass transfer coefficient is a constant for a certain system i e for a cluster in the system doubling the ifa or the concentration difference will double the mass transfer the 1st term in eq 1 and vice versa cussler 2009 for the partially depleted clusters surrounded by brine with non zero co2 concentration c 1 eq 7 can be applied to estimate c 1 with all the other parameters known for the partially depleted clusters as brine flow through thin layers near solid walls is not expected to be as significant as compared to the case for the completely depleted clusters we now assume that the scco2 mass transfer occurred mainly through the fluid fluid ifa for the partially depleted clusters the assumption that the mass transfer occurs through the total ifa was still applied for the completely depleted clusters for the estimation of the time averaged fluid fluid ifa a f another power law fit was applied to the fluid fluid ifa versus volume of the partially depleted scco2 clusters in te5 8 fitting parameters summarized in table s1 column 4 in the supplementary material as cluster mobilization was observed in te2 4 no power law fitting was applied to clusters in these data sets as the correlation between the total fluid fluid ifa and the volume of the clusters might not be representative of cluster dissolution rather the power law fits obtained from te5 8 were applied for both the partially and the completely depleted clusters in te2 4 following a similar argument for estimating the time averaged total ifa as discussed in section 3 2 the time averaged fluid fluid ifa for the mass transfer process in this case was calculated as the value at the midpoint of the cluster shrinkage i e at 1 2 δ v results for the back calculated concentration field normalized by the solubility limit c 0 calculated for both the partially and the completely depleted clusters is shown in fig 11 for data set te2 the concentration field increases from the inlet towards the outlet of the core in the direction of brine injection with the highest concentration field located near the region of stable clusters indicating the by passing of nearly scco2 saturated brine this behavior is in line with the observation that only minimal scco2 dissolution occurred in the stable region it should be noted that cluster mobilization will cause an overestimation of the dissolution caused δ v resulting in an underestimation of the surrounding concentration as defined by eq 7 it should also be noted that there will always exist clusters with negative concentration field as the system averaged k is always smaller than the k calculated for some clusters this resulted in an unavoidable side effect of this method with the mathematically implausible negative co2 concentration field calculated for some clusters located at the lower part of the sample where the clusters were in direct contact with the fresh brine however the back calculated concentration fields still provide informative insight into the in situ co2 concentration in brine within the porous medium sample we have included additional discussion of how different assumptions of ifa for mass transfer will affect the resulting concentration fields in the supplementary material s4 we have also included results of 1d co2 concentration fields calculated based on eq 3 in supplementary material s5 overall it is clear that the 1d eq 3 is not always capable of describing the fluid dynamics in 3d systems in our study the dissolution front was not parallel to the direction of brine injection fig 6 and the 1d co2 concentration fields that eq 3 would predict are not in line with the observations made based on the bubble charts 3 4 mobilization and growth of scco2 clusters apart from te1 unexpected cluster mobilization was also observed in te3 and te4 even though a flushing imbibition experiment was conducted at high ca before the dissolution experiment unlike for te1 the pressure applied across the core remained relatively stable for te3 and te4 for bulk brine pressure recorded during the dissolution experiment see supplementary material s1 indicating that the cause of cluster mobilization in these two scans was different to that for te1 one theoretical cause for the cluster mobilization in these two data sets could be ostwald ripening which occurs as larger bubbles grow at the expense of smaller ones due to the difference in laplace pressure between the bubbles ostwald 1897 leal calderon et al 2007 however results from simulation indicate that the time scale for ostwald ripening is in the order of years de chalendar et al 2018 xu et al 2019 li et al 2020 which is orders of magnitude too long to be relevant here one might also argue that the larger laplace pressure of smaller scco2 bubbles might lead to faster mass transfer of scco2 into brine and eventually result in growth in other clusters due to ostwald ripening however for the bentheimer sandstone at high brine saturation in our study the laplace pressure for the trapped scco2 bubbles is approximately 0 1 mpa herring et al 2017 with the overall pressure of the system equaling 8 62 mpa as discussed in section 2 1 the difference in pressure between the scco2 bubbles and the surrounding brine is only 1 we therefore expect this to have a negligible effect on the concentration of co2 in the brine surrounding these clusters particularly given that solubility is a relatively slowly varying function of pressure koschel et al 2006 therefore the observed cluster mobilization in te3 and te4 cannot be attributed to ostwald ripening histograms of the change in volume of the grown clusters i e the volume gained by the grown clusters are shown in fig 12 for te2 8 along with the histogram of the throat radius equivalent sphere in the sample i e the volume of the sphere within the same radius as each throat from fig 12 the total size grown for the scco2 clusters was small and comparable to the size of the throat radius equivalent sphere indicating that growth could be due to small bubbles mobilized through these throats we hypothesize that small mobilized clusters might have been generated during the snap off of partially depleted clusters with further dissolution the clusters might shrink and eventually be small enough to pass through the neighboring throats see fig s7 in the supplementary material for demonstration of the pore throat network generated for the bentheimer sample in this study a similar displacement pattern of napl clusters was reported by schnaar and brusseau 2006 and was attributed to a decrease in the size of the napl blobs they also note that there is a possible reduction in the ift between the fluid fluid phases caused by the addition of hydroxypropyl β cyclodextrin hpcd in their study in the case of scco2 dissolution into water decrease in the fluid fluid ift has been reported by irfan et al 2018 during the measurement of the ift between scco2 and brine water and was attributed to the high co2 concentration in water near the fluid fluid interface as reported by espinoza and santamarina 2010 therefore apart from decrease in the size of scco2 clusters cluster mobilization observed in the current study might also be attributed to the reduction in the scco2 brine ift due to higher co2 concentration in the surrounding brine compared to the observed significant cluster mobilization in te3 and te4 only minimal cluster mobilization and associated cluster growth was observed in te5 8 figs 6 7 a and 8 although the fluid fluid ift might decrease as scco2 dissolution progressed the diminished cluster mobilization in these data sets indicates the majority of the small clusters generated by snap off of partially depleted clusters were completely dissolved with the incoming fresh brine the mobilization of small clusters in earlier scans might indicate that the brine participated in scco2 depletion was partially saturated by co2 as a result of the mixing of the co2 saturated and the fresh brine below the cropped sample i e below the field of view of data analysis in this study overall we suspect the cluster mobilization is due to the combined effect of 1 small scco2 clusters generated due to the incomplete dissolution of the snapped off partially depleted clusters and 2 the high co2 concentration in nearby brine leading to reduced scco2 brine ift this indicates that co2 dissolution might result in additional mobilization of scco2 clusters which was observed in this study with the ability to image relatively tall samples using helical scanning 4 conclusion in this study we used x ray micro computed tomographic mct imaging to investigate the mass transfer process within a scco2 brine bentheimer sandstone system for application to geologic carbon sequestration both qualitatively and quantitatively the time evolution of scco2 clusters between consecutive scans was tracked at a relatively short time interval of approximately 30 mins through a cluster matching workflow and further data analysis scco2 clusters were classified as partially depleted completely depleted grown stable snapped off or merged this provided qualitative insights of the time evolution of scco2 clusters throughout brine injection with regions of cluster growth brine by passing and cluster depletion being located inside of the sample for the quantitative analysis we focused on completely and partially depleted clusters as these two groups contributed to more than 95 of the scco2 volume lost in this study in scans during which the system was considered to have reached a dissolution dominated regime mct data provided the ability to measure the volume and the total and fluid fluid ifa for each scco2 cluster and cluster matching then enabled the mass transfer coefficient k to be calculated for each scco2 cluster that was completely depleted results indicate that k was underestimated for small clusters as these clusters might have fully dissolved in a shorter period than the time between scans however k obtained for the small clusters still serves as a lower bound for the mass transfer coefficient for these clusters and the system the mass transfer coefficient k calculated for the scco2 clusters assuming mass transfer occurred through the entire cluster ifa ranges between 3 0 10 5 and 3 5 10 4 mm s with a system averaged value of k 1 4 10 4 mm s as mass transfer coefficient is theoretically a constant for certain systems the estimated k could be used to back calculate the co2 concentration field for partially and completely depleted clusters the back calculated concentration field suggests that the concentration field was nearly at saturation near the region of stable clusters where minimal cluster dissolution was observed i e the nearly saturated brine was unable to further dissolve co2 we also compared the observations made based on bubble charts with co2 concentration fields calculated based on the 1d model and we conclude that 1d equations might not always be capable of describing the fluid dynamics when applied for 3d systems with heterogeneous fluid distributions to the best of our knowledge this is the first study that utilized mct to track the time evolution of scco2 clusters for an experiment investigating scco2 dissolution in porous media and calculated the mass transfer coefficient for individual scco2 clusters we also present a methodology to use the system averaged mass transfer coefficient to back calculate the in situ co2 concentration field we expect that k calculated for scco2 clusters and the system averaged k obtained in this study might serve as reference mass transfer coefficient values for the application of geologic carbon sequestration under similar state and flow conditions furthermore it is also expected that the methodology and both the qualitative and quantitative results presented in this study will also be relevant to applications such as groundwater remediation of napls with the helical scanning trajectory utilized at the anu ctlab we were able to image relatively tall samples and observed significant cluster mobilization at certain points during the experiment even though all clusters were capillary trapped prior to the fresh brine injection we observed that the size increase for the clusters that grew was comparable to the size of the sandstone throats and the possible occurrences of cluster mobilization might have been due to the combined effect of incomplete dissolution of snapped off clusters leading to reduced volume and the reduced fluid fluid ift due to the rising co2 concentration in brine our observations indicate that additional mobilization of scco2 clusters might be linked to scco2 dissolution and the coupling of these processes needs to be understood on larger scales to improve the security of geologic carbon sequestration credit authorship contribution statement ruotong huang conceptualization formal analysis methodology writing original draft review editing anna l herring conceptualization investigation supervision writing review editing adrian sheppard resources supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments r h a h and a s acknowledge financial support provided by the australian research council via the arc training centre for multiscale 3d imaging modelling and manufacturing m3d innovation project ic 180100008 a h acknowledges financial support via australian research council arc de180100082 imaged data was scanned at the national laboratory for x ray micro computed tomography ctlab based at the australian national university anu we want to thank levi beeching michael turner mohammad saadatfar lydia knuefing and rob middleton for data acquisition and handling support appendix a supplementary data supplementary material related to this article can be found online at https doi org 10 1016 j advwatres 2022 104338 appendix a supplementary data the following is the supplementary material related to this article mmc s1 
68,pore scale x ray imaging combined with a steady state flow experiment was used to study the displacement processes during waterflooding in an altered wettability carbonate ketton limestone with more than two orders of magnitude difference in pore size between macropores and microporosity we simultaneously characterized macroscopic and local multiphase flow parameters including relative permeability capillary pressure wettability and fluid occupancy in pores and throats an accurate method was applied for porosity and fluid saturation measurements using greyscale based differential imaging without image segmentation the relative permeability values were corrected by considering the measured saturation profile along the sample length to account for the so called capillary end effect the behaviour of relative permeability and capillary pressure was compared to other measurements in the literature to demonstrate the combined effects of wettability and pore structure typical oil wet behaviour in resolvable macropores was measured from contact angle fluid occupancy and curvature the capillary pressure was negative while the oil relative permeability dropped quickly as oil was drained to low saturation and flowed through connected oil layers brine initially largely flowed through water wet microporosity and then filled the centre of large oil wet pore bodies thus the brine relative permeability remained exceptionally low until brine formed a connected flow path in the macropores leading to a substantial increase in relative permeability overall this work demonstrates that not only wettability but also pore size distribution and microporosity have significant impact on displacement processes keywords multiphase flow bimodal porosity wettability capillary end effect data availability data will be made available on request 1 introduction multiphase flow in porous media is encountered in many natural and industrial processes blunt 2017 such as in soil contamination and remediation parker 1989 bear and cheng 2010 co2 benson and cole 2008 boot handford et al 2014 and h2 zivar et al 2021 storage hydrocarbon recovery gerritsen and durlofsky 2005 as well as gas and water transport in fuel cells niu et al 2007 in these processes understanding the pore scale fluid displacement which depends on pore geometry and wettability is of vital importance in recent years pore scale x ray imaging has been combined with core flooding experiments to study multiphase flow in porous media blunt et al 2013 wildenschild and sheppard 2013 this technique characterizes not only macroscopic multiphase flow parameters relative permeability capillary pressure but also provides insight into the pore by pore fluid distribution and wettability pioneering x ray imaging based work includes calculation of capillary pressure from interfacial curvature armstrong et al 2012 andrew et al 2014b garing et al 2017 measurement of relative permeability including the effect of intermittency gao et al 2017 zou et al 2018a zou et al 2018b gao et al 2019 spurin et al 2021 characterization of wettability by contact angle measurements andrew et al 2014a klise et al 2016 alhammadi et al 2017 alratrout et al 2017 scanziani et al 2017 blunt et al 2019 sun et al 2020 and studies of dynamic displacement phenomena berg et al 2013 andrew et al 2015 pak et al 2015 rücker et al 2019 scanziani et al 2020 the key determinants controlling local and macroscopic behaviour are pore geometry including topology and wettability in particular it is difficult to predict the multiphase flow behaviour in complex rocks with broad pore size distributions arns et al 2005 bultreys et al 2015 pak et al 2016 previous experimental studies with pore scale x ray imaging have mostly been reported on multiphase flow in homogeneous sandstone rocks with unimodal pore size distributions gao et al 2017 lin et al 2018 zou et al 2018a zou et al 2018b lin et al 2019 gao et al 2021 only a few experimental studies exist on more complex rock geometries such as the ones commonly encountered in carbonates gao et al 2019 alhammadi et al 2020 lin et al 2021 here the impact of geometry can be profoundly different notably by the interplay between flow through microporosity with pore radii of less than approximately 1 micron below the resolution of our images and macropores pores larger than a few microns that can be resolved in the images furthermore relative permeability in all these studies has not been thoroughly assessed in terms of measurement uncertainty which is needed for experimental data evaluation and image based calibration and validation of pore scale modelling tools raeini et al 2022 the main aim of this study is to provide new multiphase flow measurements with complex geometry and wettability and to discuss the unique features related to contact angle pore occupancy curvature capillary pressure and relative permeability through comparison with other datasets in the literature we will examine the impact of a bimodal pore size distribution on multiphase flow and displacement in a microporous limestone whose wettability has been altered from a water wet state by bimodal pore size distribution we mean a complete separation of length scales in microporosity and macropores as shown in fig 1 which illustrates at least 2 orders of magnitude difference in pore sizes in ketton limestone moreover we will conduct a rigorous analysis of saturation and relative permeability using new methods that reduce and quantify measurement uncertainty while accounting for inhomogeneities in the saturation profiles we will use a new greyscale based differential imaging method for porosity and saturation calculations without segmentation and demonstrate its accuracy in terms of image resolution 2 material and methods 2 1 rock sample and fluid properties a cylindrical ketton limestone sample of 6 1 mm in diameter with a length of 54 6 mm was used in this study as shown in fig 1 the sample is mainly composed of calcite mineral 99 and has a helium porosity of 0 239 0 008 the absolute permeability of the sample was measured based on darcy s law at three flow rates under single phase brine conditions to be 2 45 0 03 darcy the oil phase was decane that has a density of 730 kg m3 n decane acros organics and a viscosity of 0 838 mpa s provided by pubchem open chemistry database the brine phase was deionised water doped with 25 wt potassium iodide ki with a viscosity of 0 82 0 01 mpa s the 25 wt ki was used as a high contrast dopant to distinguish the brine phase with the other two phases oil and grain details concerning the contrast scans between rock and fluids can be found in appendix a the interfacial tension ift between brine and decane was measured to be 47 05 1 56 mn m at ambient conditions using a rame hart apparatus 590 f4 series based on the pendant drop method andreas et al 1938 stauffer 1965 2 2 experimental methods this study includes three main parts a absolute permeability measurement dry scan and brine saturated scan of the sample b dynamic ageing of the sample through contact with crude oil at high temperature and pressure for wettability alteration and c a steady state two phase flow experiment at low capillary number of 4 1 10 7 with a total flow rate of 0 04 ml min the capillary number ca defined as µq σ where q is the total darcy velocity of the injected fluids σ is the interfacial tension between oil and brine and µ is the average viscosity of both fluids a hassler type x ray transparent flow cell made of carbon fibre epoxy was used for the steady state two phase flow experiments fig 2 brine and decane were injected simultaneously into the sample with controlled flow rates while measuring the pressure differential across the sample by a high accuracy transducer keller pd 33x the pore pressure was controlled by a back pressure regulator equilibar zero flow series which could handle the range of flow rates applied and the effluent of brine and decane was collected at the outlet of the regulator the step by step workflow of this experiment was as follows 1 the sample was put into the viton sleeve and then assembled in the core holder polyether ether ketone peek lines were connected between the core holder within the micro ct scanner and the pumps outside 2 deionized water as the confining fluid was injected and filled the space between the viton sleeve and the carbon fibre sleeve a confining pressure of 2 mpa was applied step by step to squeeze the viton sleeve onto the sample to avoid bypass flow between the sample and the sleeve 3 the dry sample was imaged by four coarser resolution scans for covering the full sample length two high resolution scans in the middle and one high resolution scan near the outlet of the sample the scanning locations are shown in fig 2 the voxel sizes of coarser resolution and high resolution images were 8 91 µm and 3 58 µm respectively the overlap between one scan to the neighbour for both coarser resolution images and high resolution images was approximately 30 in order to stich neighbouring scans together 4 more than 200 pore volumes 25 wt ki brine was injected to displace air in the pore space and ensure the sample was fully saturated by brine after that the pore pressure was set at 1 mpa by the back pressure regulator and the confining pressure was increased to 3 mpa 5 the pressure differential for single phase brine injection was monitored over three flow rates to measure the absolute permeability 2 45 0 03 darcy a reference scan of the sample fully saturated with brine was then acquired 6 the core holder was moved into an oven with a temperature of 80 1 a pore pressure of 5 mpa and confining pressure of 7 mpa were set the ketton sample was maintained at these conditions for 3 days to allow ion equilibration between the solid and brine 7 crude oil was injected into the sample by increasing flow rate from 0 02 ml min to 2 ml min stepwise to reach the irreducible water saturation this is a primary drainage process after that crude oil was injected at a flow rate of 0 001 ml min for a period of 3 weeks this process is called ageing during which the wettability of the sample changes to mimic conditions in the deep subsurface the composition and properties of the crude oil can be found elsewhere selem et al 2021 during ageing the flow direction was reversed half way through to establish a uniform initial brine saturation and homogeneous wettability alteration at the end of ageing decalin was first injected into the sample to displace the crude oil and then decane was injected to displace decalin this was done to avoid asphaltene precipitation 8 after ageing the pore pressure was decreased to 1 mpa and the confining pressure was decreased to 3 mpa the core holder was then isolated by closing the three way valve the core holder was disconnected from the tubing and moved back to the micro ct scanner the pumps were then connected again to the core holder and air was flushed out of the lines through the three way valves to avoid any air entering the system 9 brine and decane were injected simultaneously into the sample at different fractional flows the ratio of the volumetric brine flow rate to the total flow rate of oil and brine fw 0 0 05 0 15 0 3 0 5 0 7 0 95 1 with a constant total flow rate of 0 04 ml min at the last fractional flow point fw 1 the brine flow rate was increased 100 times from 0 04 ml min to 4 ml min this is called a bump flood for over 100 pore volumes to reach the residual oil saturation then brine injection continued at 0 04 ml min to measure the pressure differential when the fractional flow was 1 10 for each fractional flow injection continued for at least 20 h to reach a steady state condition which was indicated by a stable and constant pressure drop for at least 6 h monitored by the differential pressure transducer once steady state was reached x ray images were taken at the same position as described in step 3 without stopping fluid injection to investigate the fluid saturation and configuration in the pore space for the last fractional flow point fw 1 x ray images were taken twice before and after the higher rate bump flood 11 the sample was taken out the core holder and all eight fractional flows were repeated but without the rock sample or imaging to measure the pressure differential in the flow lines a rigorous tubing line pressure validation and uncertainty analysis were conducted see appendices b and c 2 3 imaging methods and processing the images were taken using a zeiss xrm 510 x ray ct scanner with a flat panel detector the x ray energy was 80 kev and the power was 7 w the exposure time was set to 1 60 s and the number of projections for each scan was 3201 to enhance image quality all tomograms were reconstructed into three dimensional images using the zeiss reconstructor software at each fractional flow the four coarser images with 8 91 µm voxel size were normalized to the brine saturated images slice by slice as a reference and stitched to the whole sample as shown in fig 2 the stitched image size was 6 6 50 5 mm3 similarly the overlapping images of two high resolution images in the middle of the sample were also normalized to the brine saturated images and stitched together as shown in fig 2 the stitched image size was 6 6 10 mm3 all images were registered to the brine saturated image with the same position instead of segmentation which has user bias we conducted greyscale based calculations of porosity and saturation without segmentation as proposed by withjack 1988 and applied to a wide range of rock types krevor et al 2012 akbarabadi and piri 2013 vega et al 2014 pini and madonna 2016 we combine greyscale based calculations with differential imaging the solid and brine phases cancel out during differential imaging subtracting the brine saturated image from the dry partially saturated images in this case simpler equations to determine porosity and saturation are used with lower uncertainty raeini et al 2022 see appendix d as for interfacial properties image segmentation which combines differential imaging with interactive thresholding segmentation was then performed to obtain quantitative information such as contact angle fluid occupancy curvature and capillary pressure the segmentation procedure is explained in more detail in appendix e the measurements used for this paper and the corresponding methods image size and voxel size are described in table 1 3 results and discussion we start with the characterization of pore structure in section 3 1 followed by measurement of porosity and fluid saturation by greyscale based differential imaging without segmentation in section 3 2 then we quantify the in situ wettability through the geometric contact angle in section 3 3 this is followed by the analysis of the fluid occupancy in pores and throats in section 3 4 in section 3 5 we present the interfacial curvature analysis including mean curvature and gaussian curvature and the calculation of capillary pressure based on mean curvature finally the relative permeability and implications for recovery are presented in section 3 6 with a discussion of other results in the literature to show how wettability and pore structure control multiphase flow properties this analysis includes a method to account for an arbitrary inhomogeneous saturation profile allowing for the capillary end effect and other heterogeneities present in the system 3 1 characterization of pore structure we extracted network models from the stitched high resolution images with voxel size of 3 58 μm in the middle of the sample 6 6 10 mm3 the maximal ball method was used to divide the segmented macropores into wide regions pores separated by restrictions throats dong and blunt 2009 raeini et al 2017 the pore and throat radii were found from the largest sphere which can fit in the centres of the pores and throats the sub resolution microporosity in rock grains was not considered in the analysis as it cannot be resolved in the images we compared the pore and throat size distributions of ketton carbonate with estaillades carbonate a benchmark microporous carbonate for relative permeability and displacement analysis gao et al 2019 lin et al 2021 in fig 3 later in the paper we will use this information to understand the differences in capillary pressure and relative permeability characteristics for these two rocks ketton has larger resolvable macro pores and throats compared to estaillades in addition we also plotted the number of pores and throats which are not connected this means they are only connected through sub resolution microporosity while estaillades has a large number of isolated pores and throats with zero coordination number for ketton these isolated elements are largely absent 3 2 porosity and saturation measurements based on greyscale images without segmentation the porosity and saturation profiles of the coarser resolution images are compared to those of high resolution images slice by slice at the same location in the middle of the sample and near the downstream end fig 4 the results show that the coarser resolution images match well slice by slice with the high resolution ones which indicates the greyscale based differential imaging method for porosity and saturation computation is accurate even at the coarser image resolution moreover the average porosity obtained from the images 0 236 0 008 agrees to within the uncertainty of the measurements with the helium porosity 0 239 0 008 which again demonstrates the accuracy of our greyscale based differential imaging method the brine saturation profiles across the whole sample for all the fractional flows are shown in fig 5 these profiles are based on the average greyscale values of the whole sample accounting for both brine in the macropores and unresolved microporosity the brine saturation profile for all the fractional flows was heterogenous along the flow direction specifically the brine saturation is lower near the outlet due to the so called capillary end effect there was retention of the preferentially wetting phase oil at the outlet this heterogenous saturation profile affects the analysis of relative permeability we will discuss how to include the effect of a heterogenous saturation profile in section 3 6 3 3 wettability characterization we measured the in situ contact angle distribution fig 6 in macropores using an automated method alratrout et al 2017 the results show that there is a wide range of contact angle both above and below 90 the peak mode values are between 110 and 115 for all fractional flows table 2 shows that the mean values of contact angles are larger than 90 and range from 95 to 115 the mean contact angle increases slightly as the displacement proceeds initially brine will invade the more water wet regions of the pore space with three phase contacts in these regions hence for the lowest fractional flows we observe a significant fraction of contact angles below 90o as displacement proceeds the brine is forced into both smaller and more oil wet regions of the pore space at the end of waterflooding the three phase contact lines now reside in almost exclusively oil wet regions of the pore space with contact angles above 90o 3 4 fluid occupancy in pores and throats by using the extracted pore and throat labels described in section 3 1 we computed the pore occupancy by calculating the fraction of oil filled voxels in the largest sphere at the centre of each pore and throat of the sample 6 6 10 mm3 for all fractional flows we define a pore to be filled if the oil fraction is larger than 50 shown in fig 7 to further test how wettability impacts fluid occupancy the pore occupancy in different sizes of pores and throats of a smaller sample volume 3 58 3 58 3 58 mm3 are quantified in fig 8 the volume weighted fraction of pores and throats whose centres were occupied by brine or oil was computed to determine the fluid occupancy during waterflooding brine preferentially filled the larger pores and throats first while the smaller elements remained oil filled this is consistent with oil wet conditions where brine is the non wetting phase as shown in fig 7 similar behaviour largest pores and throats to be filled with brine first has also been seen in an oil wet estaillades carbonate lin et al 2021 on the other hand we observed brine filling of pores and throats of all size throughout the displacement in a mixed wet bentheimer sandstone lin et al 2019 where smaller pores and throats in water wet regions and larger ones in oil wet regions were preferentially filled with brine 3 5 interfacial curvature and capillary pressure capillary pressure defined as the pressure difference between the oil and brine phases is calculated using the young laplace equation 1 p c p o p w 2 p c 2 σ κ 3 κ 1 2 κ 1 κ 2 where p c is the capillary pressure σ is the interfacial tension κ is the mean curvature of the interface which is the average of the two principal curvatures κ 1 and κ 2 where we define κ 1 κ 2 the curvature was obtained by approximating the smoothed oil brine interface locally by a quadratic form the eigenvalues and eigenvectors of the quadratic form correspond to the principal curvature values and the directions of principal curvature respectively more details about interface extraction and the smoothing process can be found elsewhere lin et al 2018 the smoothed oil brine interfaces for different fractional flows are shown in fig 9 fig 10 shows the curvature distribution of 1 3 million measured curvature values at f w 0 5 the peak of the distribution of the mean curvature is slightly negative indicating a negative capillary pressure and on average oil wet conditions however as with contact angle the pore by pore picture is more complex we separated the mean curvatures into three categories 1 both principal curvatures are positive blue water wet case 2 both negative red oil wet case 3 one value is positive and the other negative green mixed wet case approximately 70 of the interfaces have one positive curvature and one negative curvature giving a negative gaussian curvature fig 11 a and this occurs at all fractional flows this means that most interfaces are saddle shaped this potentially provides good connectivity of both oil and brine through the pore space khanamiri et al 2018 it implies that the two phases can flow over a wide saturation range indicating favourable pore scale displacement efficiency lin et al 2019 alhammadi et al 2020 gao et al 2020 this is an important observation and has been seen previously for both sandstones and carbonates with a range of contact angles both above and below 90o as observed here lin et al 2019 alhammadi et al 2020 gao et al 2020 we describe this condition as mixed wettability alratrout et al 2018 fig 11b shows the capillary pressure based on the measured mean curvature compared with literature data from sandstones and carbonates with different wettability conditions the capillary pressure of ketton carbonate was negative consistent with the mean curvature and decreased with brine saturation as brine was principally the non wetting phase and forced into smaller pores and throats progressively to displace oil we observed a low mean curvature with two approximately equal but opposite principal curvatures in ketton carbonate as shown in fig 10 similar behaviour with a low but slightly negative capillary pressure from menisci with principal curvatures of opposite sign has also been seen in a mixed wet reservoir carbonate alhammadi et al 2020 mixed wet bentheimer sandstone lin et al 2019 and a mixed wet reservoir sandstone gao et al 2020 on the other hand a more distinctly oil wet estaillades carbonate had a lower more negative capillary pressure as a consequence of a stronger wettability alteration leading to larger contact angles lin et al 2021 and differences in the pore and throat size distributions see fig 3 with on average smaller pores than in ketton in the next section we will demonstrate how the combination of pore structure and wettability also affects relative permeability 3 6 relative permeability and implications for recovery 3 6 1 measured relative permeability with correction for saturation heterogeneity darcy s law was used to calculate the steady state relative permeability 4 k r w q w μ w l δ p k 5 k r o q o μ o l δ p k where k rw and k ro are the relative permeabilities of water and oil respectively q is the darcy velocity μ is the fluid viscosity l is the sample length p is the pressure loss over length l which was measured in the oil phase in this work k is the absolute permeability the brine saturation at each fractional flow was measured on the coarser resolution greyscale images for the whole sample as discussed in section 3 2 the brine saturation is heterogenous along the flow direction and tends to be lower near the downstream end traditionally relative permeability in steady state flow is calculated using eqs 4 and 5 assuming that the saturation profile is homogeneous with the same pressure drop in each phase the capillary pressure is constant these assumptions are rarely correct as shown in fig 5 it is possible to account for inhomogeneities in the analysis of core floods through a quantitative assessment of local heterogeneity jackson et al 2018 here we will do this using a simpler approach in our experiment with a long thin core flow is approximately one dimensional a region where locally the saturation of one phase is low will restrict the flow of that phase leading to locally a high pressure gradient the average saturation over the whole core may be significantly higher but the overall pressure drop may be dominated by these low saturation regions the result is that we assign a high pressure drop and hence low relative permeability to a high average saturation there is a tendency to underestimate the relative permeability if we assume a homogeneous saturation profile we have developed a method that automatically accounts for an inhomogeneous saturation profile we assume that there is a unique relative permeability as a function of saturation defined locally in slice averages of the image we find this relative permeability which when the pressure gradient is integrated along the measured saturation profile gives the measured overall pressure drop to within the uncertainty of the measurements see appendices b and c we also account for pressure differences between the phases due to differences in capillary pressure which we have measured see fig 11b and buoyancy the details are provided in appendix f the end result is a corrected relative permeability with a quantified assessment of uncertainty a comparison between the uncorrected assuming a homogeneous saturation profile and corrected relative permeability is shown in fig 12 and table 3 the results indicate that the relative permeability of the oil and brine phases was underestimated by simply using average brine saturation in the k r s w relationship which assumes a uniform saturation profile for the whole sample it can be seen that the water relative permeability is low until a high saturation is reached at the last two fractional flows f w 0 95 and f w 1 the cross over saturation when the two relative permeabilities are equal is above 0 6 which is favourable for oil recovery furthermore the oil drained to a low residual saturation 0 16 at the last two fractional flows the water relative permeability increased sharply and the final water relative permeability is high 0 66 this water relative permeability is not typical oil wet behaviour where invasion percolation occurs in the larger pores and the water relative permeability increases rapidly instead we observe more percolation like mixed wet relative permeability characteristics blunt 2017 this is the result of ketton carbonate distinct bimodal pore size distribution fig 1 and wettability which will be described in detail in the following section 3 6 2 brine connectivity and its impact on water relative permeability fig 13 illustrates the displacement of oil in microporosity and macropores in a small region of the sample at the beginning of waterflooding oil resides in macropores as well as partially invading the microporosity as shown in fig 13 from comparing the brine scan with that taken at f w 0 when waterflooding started from f w 0 to f w 0 05 we observed brine firstly filled the microporosity greyscale values increased which we assume remained water wet we also see forced displacement of oil in an oil wet pore at a negative capillary pressure the water bulges out into the oil the water flows through the microporosity to preferentially fill the larger pores throughout the sample see fig 8 in a percolation like displacement the water relative permeability remains low limited by flow through microporosity until the water in the macropores connects across the pore space the three dimensional volume rendering of the brine phase in macropores is shown in fig 14 different colours indicate different brine clusters and the brine connectivity in the macropores of a smaller volume in the middle of the sample was quantified in table 4 at f w 0 05 the image shows brine filled the large oil wet pores as many discrete clusters the brine clusters were not well connected between the inlet and outlet especially as filling of the restrictions throats between pores is not favoured in oil wet regions the brine flowed through the microporosity which is the reason why the brine relative permeability remained very low as the fractional flow increased from f w 0 05 to f w 0 5 the brine saturation increased slightly by 5 and the connectivity of brine clusters increased gradually but the brine at the outlet remained poorly connected as shown in fig 12 and table 3 the water relative permeability was almost constant as the brine flow was maintained by the microporosity of the ketton limestone with pore sizes of less than 0 1 µm fig 1 from f w 0 5 to f w 0 7 there is a slight increase in brine saturation and connectivity especially at the outlet corresponding to a small rise in the water relative permeability at f w 0 95 a critical point the water relative permeability started to increase sharply as the brine phase formed a connected path at the last point f w 1 the pump flow rate was increased 100 times bump flood and finally the brine invaded small throats and broke through in the macropores thus the brine occupied most of the pore space and consequently was well connected with a high relative permeability of 0 66 fig 14 also illustrates the importance of accounting for saturation heterogeneity we calculate our relative permeabilities based on a slice averaged saturation had we instead used the average saturation of the whole sample where the water was poorly connected near the outlet we would have significantly underestimated the relative permeability as demonstrated in table 3 3 6 3 relative permeability comparison with different carbonates we compared the relative permeability characteristics of ketton carbonate with previously published results on an oil wet estaillades carbonate lin et al 2021 and a mixed wet reservoir carbonate alhammadi et al 2020 fig 15 see fig 11b for a comparison of the capillary pressures of these samples by comparing the pore size distributions of these three carbonates we can see ketton and estaillades have more microporosity than the reservoir carbonate this explains why the initial water saturation in these two samples is higher ketton carbonate is a remarkable example of rock with relatively uniformly distributed microporosity a separation of scales exists between large inter granular pores 10 µm and microporosity 0 1 µm inside the grains see fig 1 bijeljic et al 2018 when the saturation is low below 0 6 brine in the macropores was poorly connected with few large clusters see fig 14 and the relative permeability was exceptionally low 0 01 limited by flow through microporosity once the brine clusters connected through the macropores the relative permeability increased significantly with a high end point water relative permeability of 0 66 as discussed above the displacement is percolation like and the relative permeability has mixed wet characteristics similar behaviour namely a low and almost constant water relative permeability for low and intermediate saturations followed by a rapid rise when the water connects in microporosity is observed in the reservoir carbonate alhammadi et al 2020 however in this case the amount of microporosity was lower with a lower initial water saturation and so the relative permeabilities are shifted to the left and stretched in comparison to ketton in contrast estaillades carbonate has a more complex sub micron pore space with a large range of pore sizes its sub resolution microporosity can allow more flow leading to a more rapid rise in relative permeability with water saturation estaillades carbonate has a significant fraction of macropores that are connected only through sub resolution microporosity fig 3 and it has a much higher initial water saturation and water relative permeability at the beginning of waterflooding the ability of the microporosity to allow significant flow combined with the more oil wet nature of the macropores see the capillary pressures in fig 11b lead to an invasion percolation like displacement and more oil wet relative permeability characteristics lin et al 2021 in summary wettability and pore size distribution and particularly the role of microporosity control the relative permeability characteristics of these carbonates the use of high resolution imaging and analysis allows us to understand and interpret the different behaviour in terms of pore scale displacement processes 4 conclusions we used a suite of experimental and image analysis tools to measure relative permeability and capillary pressure simultaneously on an altered wettability carbonate with distinct bimodal porosity we used a greyscale based differential imaging method which provides accurate porosity and saturation measurements without image segmentation we demonstrated the measured porosity and saturation profile from the coarser resolution images is consistent slice by slice with the high resolution ones which implies the greyscale based differential imaging method is accurate even at voxel sizes of approximately 9 μm the measured relative permeability values were corrected by considering the variation in slice averaged saturation along the flow direction we found both brine and oil relative permeability values were underestimated by simply using average saturation values in the k r s w relationship which assumes a uniform saturation profile in the sample for each fractional flow the resolvable macropores displayed an overall oil wet behaviour measured from contact angle fluid occupancy curvature and capillary pressure on micro ct images the oil brine interfaces had a small negative mean curvature implying a low negative capillary pressure we observed many saddle shape oil brine interfaces with nearly equal but opposite principal curvatures in orthogonal direction this implies that oil and brine phases preserve good connectivity during the experiments ketton limestone wettability and bimodal pore size distribution explain the relative permeability behaviour which is different from other carbonate rocks pore space images show that brine initially flowed through microporosity and was then forced to fill the centre of large oil wet pores the brine clusters were not well connected initially through the macropores and instead the flow was maintained through microporosity the oil relative permeability dropped quickly as oil was drained to low saturation and flowed through connected oil layers the brine flowed through microporosity and its relative permeability remained very low until brine invaded small throats and formed a connected flow path through the macropores at which point the brine relative permeability increased significantly we propose that this experimental and analysis workflow could be used to characterize and interpret displacement behaviour in a range of porous materials credit authorship contribution statement guanglei zhang conceptualization investigation formal analysis writing original draft sajjad foroughi investigation formal analysis ali q raeini investigation formal analysis martin j blunt conceptualization supervision writing review editing branko bijeljic conceptualization supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments we acknowledge totalenergies for providing the financial support to this experiment and for fruitful technical discussions with their digital rock physics team we also thank qingyang lin zhejiang university for sharing image processing scripts branko bijeljic is also very grateful to totalenergies for funding his senior fellowship appendix a contrast scan between rock and fluids contrast scans between rock and fluids were taken before the experiment ketton limestone particles were put into four small glass bottles 7 wt 15 wt 20 wt and 25 wt ki brine was prepared and poured into the bottles then decane was put inside each bottle and well mixed with brine and rock particles quick scans 801 projections were taken for the bottles with rock and fluids by comparing the contrast of the rock oil and brine figs a1 and a2 25 wt ki brine was chosen as the optimum brine salinity for image contrast appendix b tubing pressure validation for single phase flow for a circular tube poiseuille s equation for flow is b1 q π r 4 8 μ δ p l where q is the flow rate r is the tube radius p is the pressure loss over length l μ is the fluid viscosity from darcy s law b2 q k a μ δ p l where a is the tube area πr2 by analogy with darcy s law eq b2 the absolute permeability of a circular tube can be derived from eq b1 b3 k r 2 8 the absolute permeability can be calculated analytically based on eq b3 we know r 0 38 mm and then we can calculate k 1 81 10 8 m 2 we have also experimentally measured absolute permeability by single oil phase flow the tube and fluid properties are as follows μ 0 838 10 3 pa s q 0 4ml min 6 67 10 9m3 s a πr2 3 14 0 382mm2 4 53 10m2 l 2 0m δp 1340 pa based on darcy law the experimentally measured absolute permeability is k q μ l a δ p 1 84 10 8 m 2 the experimentally measured absolute permeability agrees well with the theoretical one derived from the poiseuille s equation this demonstrated our tubing pressure measurement is accurate at least for single phase flow appendix c tubing pressure uncertainty for multiphase flow the measured total pressures tube pressures and associated uncertainties at each fractional flow are shown in table c1 the core pressure which was the difference between total pressure and tube pressure at each fractional flow is used for the relative permeability calculation as the tube pressure was measured after removing the sample from core holder these values may not be the same as the tube pressures when there was rock present therefore there is uncertainty with the tube pressure measurement to properly assess the uncertainties the ratio of the tube pressure and the total pressure was calculated at each fractional flow and the ratio ranges from 0 13 to 0 36 we assume the real tube pressures ranges from 0 13 to 0 36 of total pressures for all fractional flows appendix d greyscale based differential imaging to compute porosity and saturation the porosity can be estimated based on the ct numbers greyscale values of the phases in the dry image d1 c t c t r o c k 1 ϕ c t a i r ϕ d2 ϕ c t c t r o c k c t a i r c t r o c k where ϕ is the porosity c t represents the average ct number of the whole image ct rock and ct air are the representative ct number of solid and air phases respectively similarly fluid saturations can be estimated based on the on the ct numbers of the phases in partially saturated images containing oil and brine and solid d3 c t c t r o c k 1 ϕ c t o ϕ s o c t w ϕ 1 s o d4 s o c t c t r o c k 1 ϕ c t w ϕ c t o c t w ϕ where c t represents the average ct number of the whole image ct rock ct o and ct w are the representative ct number of solid oil and water phases respectively during differential imaging figs d1 and d2 subtracting the brine saturated image from the dry partially saturated images the solid and brine phases cancel out reducing the uncertainty therefore eqs d2 and d4 can be written for the differential images as d5 ϕ c t c t a i r d6 s o c t c t o ϕ one key procedure for differential imaging is greyscale normalization to make sure the greyscale values are consistent for the same phases for the images at every fractional flow to achieve this we normalized all the greyscale images to the brine scan slice by slice by using non microporous rock and the viton sleeve as masks the uncertainty in porosity and saturation were obtained based on variations of greyscale values for different fluids ct air and ct o in eqs d5 and d6 increasing the contrast between brine and oil can lead to lower uncertainty however there is a trade off as doping the brine to be excessively opaque to x rays leads to lower image quality and increased image blur at the boundary between phases 25 ki was selected after conducting contrast scans between rock and fluids see the details in appendix a appendix e greyscale image segmentation greyscale images with a voxel size of 3 58 µm for each fractional flow are illustrated in fig e1 black is oil grey is rock grain solid and white is brine the macropore space and rock phases were segmented firstly from the differential image of dry and brine scans fig d1 the high salinity brine was even brighter than the solid and the differential image helps distinguish solid and macropores macropores can be easily segmented from the rock using the interactive thresholding method without segmenting microporous grains where a complex segmentation method is needed lin et al 2016 the next step was to segment oil in the macropores similarly oil in the macropores was segmented from the differential image between the multiphase scans and the high salinity brine scan fig d2 using the interactive thresholding method based on the greyscale values the segmented oil phase was masked by the solid and the remaining phase was brine the segmented images are shown in fig e2 where the grey is solid with microporosity and the fluids in the macropores were segmented into brine blue and oil red appendix f relative permeability correction method for inhomogeneous saturation profiles in this two phase flow experiment the fluid flow is upward for any fractional flow the multiphase darcy s law for one dimensional vertical flow is f1 q o k k r o μ o p o x ρ o g f2 q w k k r w μ w p w x ρ w g f3 p c p o p w where the subscripts o and w stand for oil and water respectively q is the darcy velocity k is the absolute permeability k r is the relative permeability μ is the viscosity p is the fluid pressure x is the distance along the flow direction ρ is the fluid density g is the gravitational acceleration and p c is the capillary pressure by integrating eqs f1 and f2 between sample length from 0 and l the pressure drop δp across the sample length which was measured in the oil phase is given by f4 δ p δ p o μ o q o k 0 l 1 k r o s w d x ρ o g l f5 δ p δ p o μ w q w k 0 l 1 k r w s w d x ρ w g l p c x 0 p c x l where relative permeability is assumed to be a unique function of saturation k r s w and we assume that the absolute permeability is constant we estimated the initial water saturation s wi and the residual oi saturation s or from the lowest slice averaged saturations of water and oil observed in the experiments we divided the saturation evenly across the saturation range from s wi to 1 s or into eight increments then we described the oil and water relative permeability using eight unknown values at the eight discrete points k ro i and k rw i with i from 1 to 8 for any saturation value we were able to define the relative permeability by linearly interpolating between the eight discrete values as we have obtained the slice by slice saturation profile fig 5 a unique relative permeability as a function of saturation can be defined locally in slice averages of the image and the integral in eqs f4 and f5 can be replaced by linear sums as f6 δ p i μ o q o i k δ x j 1 n 1 k r o s w i j ρ o g l f7 δ p i μ w q w i k δ x j 1 n 1 k r w s w i j ρ w g l p c i x 0 p c i x l where δx is every increment of sample length in the image which is the voxel size j is the slice number of images along the measured saturation profile n is the total number of the slices here i labels the fractional flow we have eight different measured pressure differences in eqs f6 and f7 we account for pressure differences between the phases due to differences in capillary pressure and buoyancy we assume the capillary pressure at the inlet is the same as the values obtained from the high resolution image in the middle of the sample which we have measured see fig 11b whereas the capillary pressure at the outlet is zero due to the capillary end effect we then find the relative permeability which when the pressure gradient is integrated along the measured saturation profile gives the measured overall pressure drop to within the uncertainty of the measurements see appendix c this is an optimization process which leads to a range of possible relative permeability values as presented in the main text 
68,pore scale x ray imaging combined with a steady state flow experiment was used to study the displacement processes during waterflooding in an altered wettability carbonate ketton limestone with more than two orders of magnitude difference in pore size between macropores and microporosity we simultaneously characterized macroscopic and local multiphase flow parameters including relative permeability capillary pressure wettability and fluid occupancy in pores and throats an accurate method was applied for porosity and fluid saturation measurements using greyscale based differential imaging without image segmentation the relative permeability values were corrected by considering the measured saturation profile along the sample length to account for the so called capillary end effect the behaviour of relative permeability and capillary pressure was compared to other measurements in the literature to demonstrate the combined effects of wettability and pore structure typical oil wet behaviour in resolvable macropores was measured from contact angle fluid occupancy and curvature the capillary pressure was negative while the oil relative permeability dropped quickly as oil was drained to low saturation and flowed through connected oil layers brine initially largely flowed through water wet microporosity and then filled the centre of large oil wet pore bodies thus the brine relative permeability remained exceptionally low until brine formed a connected flow path in the macropores leading to a substantial increase in relative permeability overall this work demonstrates that not only wettability but also pore size distribution and microporosity have significant impact on displacement processes keywords multiphase flow bimodal porosity wettability capillary end effect data availability data will be made available on request 1 introduction multiphase flow in porous media is encountered in many natural and industrial processes blunt 2017 such as in soil contamination and remediation parker 1989 bear and cheng 2010 co2 benson and cole 2008 boot handford et al 2014 and h2 zivar et al 2021 storage hydrocarbon recovery gerritsen and durlofsky 2005 as well as gas and water transport in fuel cells niu et al 2007 in these processes understanding the pore scale fluid displacement which depends on pore geometry and wettability is of vital importance in recent years pore scale x ray imaging has been combined with core flooding experiments to study multiphase flow in porous media blunt et al 2013 wildenschild and sheppard 2013 this technique characterizes not only macroscopic multiphase flow parameters relative permeability capillary pressure but also provides insight into the pore by pore fluid distribution and wettability pioneering x ray imaging based work includes calculation of capillary pressure from interfacial curvature armstrong et al 2012 andrew et al 2014b garing et al 2017 measurement of relative permeability including the effect of intermittency gao et al 2017 zou et al 2018a zou et al 2018b gao et al 2019 spurin et al 2021 characterization of wettability by contact angle measurements andrew et al 2014a klise et al 2016 alhammadi et al 2017 alratrout et al 2017 scanziani et al 2017 blunt et al 2019 sun et al 2020 and studies of dynamic displacement phenomena berg et al 2013 andrew et al 2015 pak et al 2015 rücker et al 2019 scanziani et al 2020 the key determinants controlling local and macroscopic behaviour are pore geometry including topology and wettability in particular it is difficult to predict the multiphase flow behaviour in complex rocks with broad pore size distributions arns et al 2005 bultreys et al 2015 pak et al 2016 previous experimental studies with pore scale x ray imaging have mostly been reported on multiphase flow in homogeneous sandstone rocks with unimodal pore size distributions gao et al 2017 lin et al 2018 zou et al 2018a zou et al 2018b lin et al 2019 gao et al 2021 only a few experimental studies exist on more complex rock geometries such as the ones commonly encountered in carbonates gao et al 2019 alhammadi et al 2020 lin et al 2021 here the impact of geometry can be profoundly different notably by the interplay between flow through microporosity with pore radii of less than approximately 1 micron below the resolution of our images and macropores pores larger than a few microns that can be resolved in the images furthermore relative permeability in all these studies has not been thoroughly assessed in terms of measurement uncertainty which is needed for experimental data evaluation and image based calibration and validation of pore scale modelling tools raeini et al 2022 the main aim of this study is to provide new multiphase flow measurements with complex geometry and wettability and to discuss the unique features related to contact angle pore occupancy curvature capillary pressure and relative permeability through comparison with other datasets in the literature we will examine the impact of a bimodal pore size distribution on multiphase flow and displacement in a microporous limestone whose wettability has been altered from a water wet state by bimodal pore size distribution we mean a complete separation of length scales in microporosity and macropores as shown in fig 1 which illustrates at least 2 orders of magnitude difference in pore sizes in ketton limestone moreover we will conduct a rigorous analysis of saturation and relative permeability using new methods that reduce and quantify measurement uncertainty while accounting for inhomogeneities in the saturation profiles we will use a new greyscale based differential imaging method for porosity and saturation calculations without segmentation and demonstrate its accuracy in terms of image resolution 2 material and methods 2 1 rock sample and fluid properties a cylindrical ketton limestone sample of 6 1 mm in diameter with a length of 54 6 mm was used in this study as shown in fig 1 the sample is mainly composed of calcite mineral 99 and has a helium porosity of 0 239 0 008 the absolute permeability of the sample was measured based on darcy s law at three flow rates under single phase brine conditions to be 2 45 0 03 darcy the oil phase was decane that has a density of 730 kg m3 n decane acros organics and a viscosity of 0 838 mpa s provided by pubchem open chemistry database the brine phase was deionised water doped with 25 wt potassium iodide ki with a viscosity of 0 82 0 01 mpa s the 25 wt ki was used as a high contrast dopant to distinguish the brine phase with the other two phases oil and grain details concerning the contrast scans between rock and fluids can be found in appendix a the interfacial tension ift between brine and decane was measured to be 47 05 1 56 mn m at ambient conditions using a rame hart apparatus 590 f4 series based on the pendant drop method andreas et al 1938 stauffer 1965 2 2 experimental methods this study includes three main parts a absolute permeability measurement dry scan and brine saturated scan of the sample b dynamic ageing of the sample through contact with crude oil at high temperature and pressure for wettability alteration and c a steady state two phase flow experiment at low capillary number of 4 1 10 7 with a total flow rate of 0 04 ml min the capillary number ca defined as µq σ where q is the total darcy velocity of the injected fluids σ is the interfacial tension between oil and brine and µ is the average viscosity of both fluids a hassler type x ray transparent flow cell made of carbon fibre epoxy was used for the steady state two phase flow experiments fig 2 brine and decane were injected simultaneously into the sample with controlled flow rates while measuring the pressure differential across the sample by a high accuracy transducer keller pd 33x the pore pressure was controlled by a back pressure regulator equilibar zero flow series which could handle the range of flow rates applied and the effluent of brine and decane was collected at the outlet of the regulator the step by step workflow of this experiment was as follows 1 the sample was put into the viton sleeve and then assembled in the core holder polyether ether ketone peek lines were connected between the core holder within the micro ct scanner and the pumps outside 2 deionized water as the confining fluid was injected and filled the space between the viton sleeve and the carbon fibre sleeve a confining pressure of 2 mpa was applied step by step to squeeze the viton sleeve onto the sample to avoid bypass flow between the sample and the sleeve 3 the dry sample was imaged by four coarser resolution scans for covering the full sample length two high resolution scans in the middle and one high resolution scan near the outlet of the sample the scanning locations are shown in fig 2 the voxel sizes of coarser resolution and high resolution images were 8 91 µm and 3 58 µm respectively the overlap between one scan to the neighbour for both coarser resolution images and high resolution images was approximately 30 in order to stich neighbouring scans together 4 more than 200 pore volumes 25 wt ki brine was injected to displace air in the pore space and ensure the sample was fully saturated by brine after that the pore pressure was set at 1 mpa by the back pressure regulator and the confining pressure was increased to 3 mpa 5 the pressure differential for single phase brine injection was monitored over three flow rates to measure the absolute permeability 2 45 0 03 darcy a reference scan of the sample fully saturated with brine was then acquired 6 the core holder was moved into an oven with a temperature of 80 1 a pore pressure of 5 mpa and confining pressure of 7 mpa were set the ketton sample was maintained at these conditions for 3 days to allow ion equilibration between the solid and brine 7 crude oil was injected into the sample by increasing flow rate from 0 02 ml min to 2 ml min stepwise to reach the irreducible water saturation this is a primary drainage process after that crude oil was injected at a flow rate of 0 001 ml min for a period of 3 weeks this process is called ageing during which the wettability of the sample changes to mimic conditions in the deep subsurface the composition and properties of the crude oil can be found elsewhere selem et al 2021 during ageing the flow direction was reversed half way through to establish a uniform initial brine saturation and homogeneous wettability alteration at the end of ageing decalin was first injected into the sample to displace the crude oil and then decane was injected to displace decalin this was done to avoid asphaltene precipitation 8 after ageing the pore pressure was decreased to 1 mpa and the confining pressure was decreased to 3 mpa the core holder was then isolated by closing the three way valve the core holder was disconnected from the tubing and moved back to the micro ct scanner the pumps were then connected again to the core holder and air was flushed out of the lines through the three way valves to avoid any air entering the system 9 brine and decane were injected simultaneously into the sample at different fractional flows the ratio of the volumetric brine flow rate to the total flow rate of oil and brine fw 0 0 05 0 15 0 3 0 5 0 7 0 95 1 with a constant total flow rate of 0 04 ml min at the last fractional flow point fw 1 the brine flow rate was increased 100 times from 0 04 ml min to 4 ml min this is called a bump flood for over 100 pore volumes to reach the residual oil saturation then brine injection continued at 0 04 ml min to measure the pressure differential when the fractional flow was 1 10 for each fractional flow injection continued for at least 20 h to reach a steady state condition which was indicated by a stable and constant pressure drop for at least 6 h monitored by the differential pressure transducer once steady state was reached x ray images were taken at the same position as described in step 3 without stopping fluid injection to investigate the fluid saturation and configuration in the pore space for the last fractional flow point fw 1 x ray images were taken twice before and after the higher rate bump flood 11 the sample was taken out the core holder and all eight fractional flows were repeated but without the rock sample or imaging to measure the pressure differential in the flow lines a rigorous tubing line pressure validation and uncertainty analysis were conducted see appendices b and c 2 3 imaging methods and processing the images were taken using a zeiss xrm 510 x ray ct scanner with a flat panel detector the x ray energy was 80 kev and the power was 7 w the exposure time was set to 1 60 s and the number of projections for each scan was 3201 to enhance image quality all tomograms were reconstructed into three dimensional images using the zeiss reconstructor software at each fractional flow the four coarser images with 8 91 µm voxel size were normalized to the brine saturated images slice by slice as a reference and stitched to the whole sample as shown in fig 2 the stitched image size was 6 6 50 5 mm3 similarly the overlapping images of two high resolution images in the middle of the sample were also normalized to the brine saturated images and stitched together as shown in fig 2 the stitched image size was 6 6 10 mm3 all images were registered to the brine saturated image with the same position instead of segmentation which has user bias we conducted greyscale based calculations of porosity and saturation without segmentation as proposed by withjack 1988 and applied to a wide range of rock types krevor et al 2012 akbarabadi and piri 2013 vega et al 2014 pini and madonna 2016 we combine greyscale based calculations with differential imaging the solid and brine phases cancel out during differential imaging subtracting the brine saturated image from the dry partially saturated images in this case simpler equations to determine porosity and saturation are used with lower uncertainty raeini et al 2022 see appendix d as for interfacial properties image segmentation which combines differential imaging with interactive thresholding segmentation was then performed to obtain quantitative information such as contact angle fluid occupancy curvature and capillary pressure the segmentation procedure is explained in more detail in appendix e the measurements used for this paper and the corresponding methods image size and voxel size are described in table 1 3 results and discussion we start with the characterization of pore structure in section 3 1 followed by measurement of porosity and fluid saturation by greyscale based differential imaging without segmentation in section 3 2 then we quantify the in situ wettability through the geometric contact angle in section 3 3 this is followed by the analysis of the fluid occupancy in pores and throats in section 3 4 in section 3 5 we present the interfacial curvature analysis including mean curvature and gaussian curvature and the calculation of capillary pressure based on mean curvature finally the relative permeability and implications for recovery are presented in section 3 6 with a discussion of other results in the literature to show how wettability and pore structure control multiphase flow properties this analysis includes a method to account for an arbitrary inhomogeneous saturation profile allowing for the capillary end effect and other heterogeneities present in the system 3 1 characterization of pore structure we extracted network models from the stitched high resolution images with voxel size of 3 58 μm in the middle of the sample 6 6 10 mm3 the maximal ball method was used to divide the segmented macropores into wide regions pores separated by restrictions throats dong and blunt 2009 raeini et al 2017 the pore and throat radii were found from the largest sphere which can fit in the centres of the pores and throats the sub resolution microporosity in rock grains was not considered in the analysis as it cannot be resolved in the images we compared the pore and throat size distributions of ketton carbonate with estaillades carbonate a benchmark microporous carbonate for relative permeability and displacement analysis gao et al 2019 lin et al 2021 in fig 3 later in the paper we will use this information to understand the differences in capillary pressure and relative permeability characteristics for these two rocks ketton has larger resolvable macro pores and throats compared to estaillades in addition we also plotted the number of pores and throats which are not connected this means they are only connected through sub resolution microporosity while estaillades has a large number of isolated pores and throats with zero coordination number for ketton these isolated elements are largely absent 3 2 porosity and saturation measurements based on greyscale images without segmentation the porosity and saturation profiles of the coarser resolution images are compared to those of high resolution images slice by slice at the same location in the middle of the sample and near the downstream end fig 4 the results show that the coarser resolution images match well slice by slice with the high resolution ones which indicates the greyscale based differential imaging method for porosity and saturation computation is accurate even at the coarser image resolution moreover the average porosity obtained from the images 0 236 0 008 agrees to within the uncertainty of the measurements with the helium porosity 0 239 0 008 which again demonstrates the accuracy of our greyscale based differential imaging method the brine saturation profiles across the whole sample for all the fractional flows are shown in fig 5 these profiles are based on the average greyscale values of the whole sample accounting for both brine in the macropores and unresolved microporosity the brine saturation profile for all the fractional flows was heterogenous along the flow direction specifically the brine saturation is lower near the outlet due to the so called capillary end effect there was retention of the preferentially wetting phase oil at the outlet this heterogenous saturation profile affects the analysis of relative permeability we will discuss how to include the effect of a heterogenous saturation profile in section 3 6 3 3 wettability characterization we measured the in situ contact angle distribution fig 6 in macropores using an automated method alratrout et al 2017 the results show that there is a wide range of contact angle both above and below 90 the peak mode values are between 110 and 115 for all fractional flows table 2 shows that the mean values of contact angles are larger than 90 and range from 95 to 115 the mean contact angle increases slightly as the displacement proceeds initially brine will invade the more water wet regions of the pore space with three phase contacts in these regions hence for the lowest fractional flows we observe a significant fraction of contact angles below 90o as displacement proceeds the brine is forced into both smaller and more oil wet regions of the pore space at the end of waterflooding the three phase contact lines now reside in almost exclusively oil wet regions of the pore space with contact angles above 90o 3 4 fluid occupancy in pores and throats by using the extracted pore and throat labels described in section 3 1 we computed the pore occupancy by calculating the fraction of oil filled voxels in the largest sphere at the centre of each pore and throat of the sample 6 6 10 mm3 for all fractional flows we define a pore to be filled if the oil fraction is larger than 50 shown in fig 7 to further test how wettability impacts fluid occupancy the pore occupancy in different sizes of pores and throats of a smaller sample volume 3 58 3 58 3 58 mm3 are quantified in fig 8 the volume weighted fraction of pores and throats whose centres were occupied by brine or oil was computed to determine the fluid occupancy during waterflooding brine preferentially filled the larger pores and throats first while the smaller elements remained oil filled this is consistent with oil wet conditions where brine is the non wetting phase as shown in fig 7 similar behaviour largest pores and throats to be filled with brine first has also been seen in an oil wet estaillades carbonate lin et al 2021 on the other hand we observed brine filling of pores and throats of all size throughout the displacement in a mixed wet bentheimer sandstone lin et al 2019 where smaller pores and throats in water wet regions and larger ones in oil wet regions were preferentially filled with brine 3 5 interfacial curvature and capillary pressure capillary pressure defined as the pressure difference between the oil and brine phases is calculated using the young laplace equation 1 p c p o p w 2 p c 2 σ κ 3 κ 1 2 κ 1 κ 2 where p c is the capillary pressure σ is the interfacial tension κ is the mean curvature of the interface which is the average of the two principal curvatures κ 1 and κ 2 where we define κ 1 κ 2 the curvature was obtained by approximating the smoothed oil brine interface locally by a quadratic form the eigenvalues and eigenvectors of the quadratic form correspond to the principal curvature values and the directions of principal curvature respectively more details about interface extraction and the smoothing process can be found elsewhere lin et al 2018 the smoothed oil brine interfaces for different fractional flows are shown in fig 9 fig 10 shows the curvature distribution of 1 3 million measured curvature values at f w 0 5 the peak of the distribution of the mean curvature is slightly negative indicating a negative capillary pressure and on average oil wet conditions however as with contact angle the pore by pore picture is more complex we separated the mean curvatures into three categories 1 both principal curvatures are positive blue water wet case 2 both negative red oil wet case 3 one value is positive and the other negative green mixed wet case approximately 70 of the interfaces have one positive curvature and one negative curvature giving a negative gaussian curvature fig 11 a and this occurs at all fractional flows this means that most interfaces are saddle shaped this potentially provides good connectivity of both oil and brine through the pore space khanamiri et al 2018 it implies that the two phases can flow over a wide saturation range indicating favourable pore scale displacement efficiency lin et al 2019 alhammadi et al 2020 gao et al 2020 this is an important observation and has been seen previously for both sandstones and carbonates with a range of contact angles both above and below 90o as observed here lin et al 2019 alhammadi et al 2020 gao et al 2020 we describe this condition as mixed wettability alratrout et al 2018 fig 11b shows the capillary pressure based on the measured mean curvature compared with literature data from sandstones and carbonates with different wettability conditions the capillary pressure of ketton carbonate was negative consistent with the mean curvature and decreased with brine saturation as brine was principally the non wetting phase and forced into smaller pores and throats progressively to displace oil we observed a low mean curvature with two approximately equal but opposite principal curvatures in ketton carbonate as shown in fig 10 similar behaviour with a low but slightly negative capillary pressure from menisci with principal curvatures of opposite sign has also been seen in a mixed wet reservoir carbonate alhammadi et al 2020 mixed wet bentheimer sandstone lin et al 2019 and a mixed wet reservoir sandstone gao et al 2020 on the other hand a more distinctly oil wet estaillades carbonate had a lower more negative capillary pressure as a consequence of a stronger wettability alteration leading to larger contact angles lin et al 2021 and differences in the pore and throat size distributions see fig 3 with on average smaller pores than in ketton in the next section we will demonstrate how the combination of pore structure and wettability also affects relative permeability 3 6 relative permeability and implications for recovery 3 6 1 measured relative permeability with correction for saturation heterogeneity darcy s law was used to calculate the steady state relative permeability 4 k r w q w μ w l δ p k 5 k r o q o μ o l δ p k where k rw and k ro are the relative permeabilities of water and oil respectively q is the darcy velocity μ is the fluid viscosity l is the sample length p is the pressure loss over length l which was measured in the oil phase in this work k is the absolute permeability the brine saturation at each fractional flow was measured on the coarser resolution greyscale images for the whole sample as discussed in section 3 2 the brine saturation is heterogenous along the flow direction and tends to be lower near the downstream end traditionally relative permeability in steady state flow is calculated using eqs 4 and 5 assuming that the saturation profile is homogeneous with the same pressure drop in each phase the capillary pressure is constant these assumptions are rarely correct as shown in fig 5 it is possible to account for inhomogeneities in the analysis of core floods through a quantitative assessment of local heterogeneity jackson et al 2018 here we will do this using a simpler approach in our experiment with a long thin core flow is approximately one dimensional a region where locally the saturation of one phase is low will restrict the flow of that phase leading to locally a high pressure gradient the average saturation over the whole core may be significantly higher but the overall pressure drop may be dominated by these low saturation regions the result is that we assign a high pressure drop and hence low relative permeability to a high average saturation there is a tendency to underestimate the relative permeability if we assume a homogeneous saturation profile we have developed a method that automatically accounts for an inhomogeneous saturation profile we assume that there is a unique relative permeability as a function of saturation defined locally in slice averages of the image we find this relative permeability which when the pressure gradient is integrated along the measured saturation profile gives the measured overall pressure drop to within the uncertainty of the measurements see appendices b and c we also account for pressure differences between the phases due to differences in capillary pressure which we have measured see fig 11b and buoyancy the details are provided in appendix f the end result is a corrected relative permeability with a quantified assessment of uncertainty a comparison between the uncorrected assuming a homogeneous saturation profile and corrected relative permeability is shown in fig 12 and table 3 the results indicate that the relative permeability of the oil and brine phases was underestimated by simply using average brine saturation in the k r s w relationship which assumes a uniform saturation profile for the whole sample it can be seen that the water relative permeability is low until a high saturation is reached at the last two fractional flows f w 0 95 and f w 1 the cross over saturation when the two relative permeabilities are equal is above 0 6 which is favourable for oil recovery furthermore the oil drained to a low residual saturation 0 16 at the last two fractional flows the water relative permeability increased sharply and the final water relative permeability is high 0 66 this water relative permeability is not typical oil wet behaviour where invasion percolation occurs in the larger pores and the water relative permeability increases rapidly instead we observe more percolation like mixed wet relative permeability characteristics blunt 2017 this is the result of ketton carbonate distinct bimodal pore size distribution fig 1 and wettability which will be described in detail in the following section 3 6 2 brine connectivity and its impact on water relative permeability fig 13 illustrates the displacement of oil in microporosity and macropores in a small region of the sample at the beginning of waterflooding oil resides in macropores as well as partially invading the microporosity as shown in fig 13 from comparing the brine scan with that taken at f w 0 when waterflooding started from f w 0 to f w 0 05 we observed brine firstly filled the microporosity greyscale values increased which we assume remained water wet we also see forced displacement of oil in an oil wet pore at a negative capillary pressure the water bulges out into the oil the water flows through the microporosity to preferentially fill the larger pores throughout the sample see fig 8 in a percolation like displacement the water relative permeability remains low limited by flow through microporosity until the water in the macropores connects across the pore space the three dimensional volume rendering of the brine phase in macropores is shown in fig 14 different colours indicate different brine clusters and the brine connectivity in the macropores of a smaller volume in the middle of the sample was quantified in table 4 at f w 0 05 the image shows brine filled the large oil wet pores as many discrete clusters the brine clusters were not well connected between the inlet and outlet especially as filling of the restrictions throats between pores is not favoured in oil wet regions the brine flowed through the microporosity which is the reason why the brine relative permeability remained very low as the fractional flow increased from f w 0 05 to f w 0 5 the brine saturation increased slightly by 5 and the connectivity of brine clusters increased gradually but the brine at the outlet remained poorly connected as shown in fig 12 and table 3 the water relative permeability was almost constant as the brine flow was maintained by the microporosity of the ketton limestone with pore sizes of less than 0 1 µm fig 1 from f w 0 5 to f w 0 7 there is a slight increase in brine saturation and connectivity especially at the outlet corresponding to a small rise in the water relative permeability at f w 0 95 a critical point the water relative permeability started to increase sharply as the brine phase formed a connected path at the last point f w 1 the pump flow rate was increased 100 times bump flood and finally the brine invaded small throats and broke through in the macropores thus the brine occupied most of the pore space and consequently was well connected with a high relative permeability of 0 66 fig 14 also illustrates the importance of accounting for saturation heterogeneity we calculate our relative permeabilities based on a slice averaged saturation had we instead used the average saturation of the whole sample where the water was poorly connected near the outlet we would have significantly underestimated the relative permeability as demonstrated in table 3 3 6 3 relative permeability comparison with different carbonates we compared the relative permeability characteristics of ketton carbonate with previously published results on an oil wet estaillades carbonate lin et al 2021 and a mixed wet reservoir carbonate alhammadi et al 2020 fig 15 see fig 11b for a comparison of the capillary pressures of these samples by comparing the pore size distributions of these three carbonates we can see ketton and estaillades have more microporosity than the reservoir carbonate this explains why the initial water saturation in these two samples is higher ketton carbonate is a remarkable example of rock with relatively uniformly distributed microporosity a separation of scales exists between large inter granular pores 10 µm and microporosity 0 1 µm inside the grains see fig 1 bijeljic et al 2018 when the saturation is low below 0 6 brine in the macropores was poorly connected with few large clusters see fig 14 and the relative permeability was exceptionally low 0 01 limited by flow through microporosity once the brine clusters connected through the macropores the relative permeability increased significantly with a high end point water relative permeability of 0 66 as discussed above the displacement is percolation like and the relative permeability has mixed wet characteristics similar behaviour namely a low and almost constant water relative permeability for low and intermediate saturations followed by a rapid rise when the water connects in microporosity is observed in the reservoir carbonate alhammadi et al 2020 however in this case the amount of microporosity was lower with a lower initial water saturation and so the relative permeabilities are shifted to the left and stretched in comparison to ketton in contrast estaillades carbonate has a more complex sub micron pore space with a large range of pore sizes its sub resolution microporosity can allow more flow leading to a more rapid rise in relative permeability with water saturation estaillades carbonate has a significant fraction of macropores that are connected only through sub resolution microporosity fig 3 and it has a much higher initial water saturation and water relative permeability at the beginning of waterflooding the ability of the microporosity to allow significant flow combined with the more oil wet nature of the macropores see the capillary pressures in fig 11b lead to an invasion percolation like displacement and more oil wet relative permeability characteristics lin et al 2021 in summary wettability and pore size distribution and particularly the role of microporosity control the relative permeability characteristics of these carbonates the use of high resolution imaging and analysis allows us to understand and interpret the different behaviour in terms of pore scale displacement processes 4 conclusions we used a suite of experimental and image analysis tools to measure relative permeability and capillary pressure simultaneously on an altered wettability carbonate with distinct bimodal porosity we used a greyscale based differential imaging method which provides accurate porosity and saturation measurements without image segmentation we demonstrated the measured porosity and saturation profile from the coarser resolution images is consistent slice by slice with the high resolution ones which implies the greyscale based differential imaging method is accurate even at voxel sizes of approximately 9 μm the measured relative permeability values were corrected by considering the variation in slice averaged saturation along the flow direction we found both brine and oil relative permeability values were underestimated by simply using average saturation values in the k r s w relationship which assumes a uniform saturation profile in the sample for each fractional flow the resolvable macropores displayed an overall oil wet behaviour measured from contact angle fluid occupancy curvature and capillary pressure on micro ct images the oil brine interfaces had a small negative mean curvature implying a low negative capillary pressure we observed many saddle shape oil brine interfaces with nearly equal but opposite principal curvatures in orthogonal direction this implies that oil and brine phases preserve good connectivity during the experiments ketton limestone wettability and bimodal pore size distribution explain the relative permeability behaviour which is different from other carbonate rocks pore space images show that brine initially flowed through microporosity and was then forced to fill the centre of large oil wet pores the brine clusters were not well connected initially through the macropores and instead the flow was maintained through microporosity the oil relative permeability dropped quickly as oil was drained to low saturation and flowed through connected oil layers the brine flowed through microporosity and its relative permeability remained very low until brine invaded small throats and formed a connected flow path through the macropores at which point the brine relative permeability increased significantly we propose that this experimental and analysis workflow could be used to characterize and interpret displacement behaviour in a range of porous materials credit authorship contribution statement guanglei zhang conceptualization investigation formal analysis writing original draft sajjad foroughi investigation formal analysis ali q raeini investigation formal analysis martin j blunt conceptualization supervision writing review editing branko bijeljic conceptualization supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments we acknowledge totalenergies for providing the financial support to this experiment and for fruitful technical discussions with their digital rock physics team we also thank qingyang lin zhejiang university for sharing image processing scripts branko bijeljic is also very grateful to totalenergies for funding his senior fellowship appendix a contrast scan between rock and fluids contrast scans between rock and fluids were taken before the experiment ketton limestone particles were put into four small glass bottles 7 wt 15 wt 20 wt and 25 wt ki brine was prepared and poured into the bottles then decane was put inside each bottle and well mixed with brine and rock particles quick scans 801 projections were taken for the bottles with rock and fluids by comparing the contrast of the rock oil and brine figs a1 and a2 25 wt ki brine was chosen as the optimum brine salinity for image contrast appendix b tubing pressure validation for single phase flow for a circular tube poiseuille s equation for flow is b1 q π r 4 8 μ δ p l where q is the flow rate r is the tube radius p is the pressure loss over length l μ is the fluid viscosity from darcy s law b2 q k a μ δ p l where a is the tube area πr2 by analogy with darcy s law eq b2 the absolute permeability of a circular tube can be derived from eq b1 b3 k r 2 8 the absolute permeability can be calculated analytically based on eq b3 we know r 0 38 mm and then we can calculate k 1 81 10 8 m 2 we have also experimentally measured absolute permeability by single oil phase flow the tube and fluid properties are as follows μ 0 838 10 3 pa s q 0 4ml min 6 67 10 9m3 s a πr2 3 14 0 382mm2 4 53 10m2 l 2 0m δp 1340 pa based on darcy law the experimentally measured absolute permeability is k q μ l a δ p 1 84 10 8 m 2 the experimentally measured absolute permeability agrees well with the theoretical one derived from the poiseuille s equation this demonstrated our tubing pressure measurement is accurate at least for single phase flow appendix c tubing pressure uncertainty for multiphase flow the measured total pressures tube pressures and associated uncertainties at each fractional flow are shown in table c1 the core pressure which was the difference between total pressure and tube pressure at each fractional flow is used for the relative permeability calculation as the tube pressure was measured after removing the sample from core holder these values may not be the same as the tube pressures when there was rock present therefore there is uncertainty with the tube pressure measurement to properly assess the uncertainties the ratio of the tube pressure and the total pressure was calculated at each fractional flow and the ratio ranges from 0 13 to 0 36 we assume the real tube pressures ranges from 0 13 to 0 36 of total pressures for all fractional flows appendix d greyscale based differential imaging to compute porosity and saturation the porosity can be estimated based on the ct numbers greyscale values of the phases in the dry image d1 c t c t r o c k 1 ϕ c t a i r ϕ d2 ϕ c t c t r o c k c t a i r c t r o c k where ϕ is the porosity c t represents the average ct number of the whole image ct rock and ct air are the representative ct number of solid and air phases respectively similarly fluid saturations can be estimated based on the on the ct numbers of the phases in partially saturated images containing oil and brine and solid d3 c t c t r o c k 1 ϕ c t o ϕ s o c t w ϕ 1 s o d4 s o c t c t r o c k 1 ϕ c t w ϕ c t o c t w ϕ where c t represents the average ct number of the whole image ct rock ct o and ct w are the representative ct number of solid oil and water phases respectively during differential imaging figs d1 and d2 subtracting the brine saturated image from the dry partially saturated images the solid and brine phases cancel out reducing the uncertainty therefore eqs d2 and d4 can be written for the differential images as d5 ϕ c t c t a i r d6 s o c t c t o ϕ one key procedure for differential imaging is greyscale normalization to make sure the greyscale values are consistent for the same phases for the images at every fractional flow to achieve this we normalized all the greyscale images to the brine scan slice by slice by using non microporous rock and the viton sleeve as masks the uncertainty in porosity and saturation were obtained based on variations of greyscale values for different fluids ct air and ct o in eqs d5 and d6 increasing the contrast between brine and oil can lead to lower uncertainty however there is a trade off as doping the brine to be excessively opaque to x rays leads to lower image quality and increased image blur at the boundary between phases 25 ki was selected after conducting contrast scans between rock and fluids see the details in appendix a appendix e greyscale image segmentation greyscale images with a voxel size of 3 58 µm for each fractional flow are illustrated in fig e1 black is oil grey is rock grain solid and white is brine the macropore space and rock phases were segmented firstly from the differential image of dry and brine scans fig d1 the high salinity brine was even brighter than the solid and the differential image helps distinguish solid and macropores macropores can be easily segmented from the rock using the interactive thresholding method without segmenting microporous grains where a complex segmentation method is needed lin et al 2016 the next step was to segment oil in the macropores similarly oil in the macropores was segmented from the differential image between the multiphase scans and the high salinity brine scan fig d2 using the interactive thresholding method based on the greyscale values the segmented oil phase was masked by the solid and the remaining phase was brine the segmented images are shown in fig e2 where the grey is solid with microporosity and the fluids in the macropores were segmented into brine blue and oil red appendix f relative permeability correction method for inhomogeneous saturation profiles in this two phase flow experiment the fluid flow is upward for any fractional flow the multiphase darcy s law for one dimensional vertical flow is f1 q o k k r o μ o p o x ρ o g f2 q w k k r w μ w p w x ρ w g f3 p c p o p w where the subscripts o and w stand for oil and water respectively q is the darcy velocity k is the absolute permeability k r is the relative permeability μ is the viscosity p is the fluid pressure x is the distance along the flow direction ρ is the fluid density g is the gravitational acceleration and p c is the capillary pressure by integrating eqs f1 and f2 between sample length from 0 and l the pressure drop δp across the sample length which was measured in the oil phase is given by f4 δ p δ p o μ o q o k 0 l 1 k r o s w d x ρ o g l f5 δ p δ p o μ w q w k 0 l 1 k r w s w d x ρ w g l p c x 0 p c x l where relative permeability is assumed to be a unique function of saturation k r s w and we assume that the absolute permeability is constant we estimated the initial water saturation s wi and the residual oi saturation s or from the lowest slice averaged saturations of water and oil observed in the experiments we divided the saturation evenly across the saturation range from s wi to 1 s or into eight increments then we described the oil and water relative permeability using eight unknown values at the eight discrete points k ro i and k rw i with i from 1 to 8 for any saturation value we were able to define the relative permeability by linearly interpolating between the eight discrete values as we have obtained the slice by slice saturation profile fig 5 a unique relative permeability as a function of saturation can be defined locally in slice averages of the image and the integral in eqs f4 and f5 can be replaced by linear sums as f6 δ p i μ o q o i k δ x j 1 n 1 k r o s w i j ρ o g l f7 δ p i μ w q w i k δ x j 1 n 1 k r w s w i j ρ w g l p c i x 0 p c i x l where δx is every increment of sample length in the image which is the voxel size j is the slice number of images along the measured saturation profile n is the total number of the slices here i labels the fractional flow we have eight different measured pressure differences in eqs f6 and f7 we account for pressure differences between the phases due to differences in capillary pressure and buoyancy we assume the capillary pressure at the inlet is the same as the values obtained from the high resolution image in the middle of the sample which we have measured see fig 11b whereas the capillary pressure at the outlet is zero due to the capillary end effect we then find the relative permeability which when the pressure gradient is integrated along the measured saturation profile gives the measured overall pressure drop to within the uncertainty of the measurements see appendix c this is an optimization process which leads to a range of possible relative permeability values as presented in the main text 
69,simulation of flow at the pore scale is of paramount importance to characterize the behavior of a fluid in a porous medium the pore scale simulations allow us to investigate pore scale mechanisms governing field scale flow attributes one of the big challenges in the field of pore scale simulation is reliable modeling of the no slip boundary condition which in the lattice boltzmann method is usually defined by the bounce back boundary condition in the present study the effect of the magic parameter value on the simulation results was investigated by considering the inherent error in micro ct images and finally the results were compared with the navier stokes method ones furthermore determining the amplitude of the error due to improper image resolution is one of the challenges in simulating micro ct images which by defining the magic parameter analyzing its behavior and effect on results a proper criterion to estimate the error amplitude of flow characteristics due to the micro ct imaging is presented in this study based on the interpolation between different angles of the boundaries an ideal magic parameter λ 0 21 was presented which can simulate complex geometries with the least error in terms of the accuracy of the bounce back boundary condition it can also be found that for reasonable values of the magic parameter the error amplitude due to the magic parameter is a subset of the imaging error amplitude that is d dct a reasonable value for the magic parameter depends on the number of nodes in the pores but the range 0 01 λ 1 0 is highly reliable and the range 0 01 λ 2 0 is also recommended in networks with a very high number of nodes per unit diameter of the pore at these intervals the magic parameter error is always less than the imaging error moreover by defining the ideal boundary in micro ct images the results of lbm and nse methods are compared the results reveal that the permeability value obtained by the nse method is always slightly less than the value obtained from the lbm in the magic parameter 0 21 under the same conditions however both responses fall within the imaging error range however the lbm results at λ 0 21 were closer to the ideal and median boundary results in micro ct images finally the comparison of the numerical results with the experimental ones illustrated that considering the response that fits the ideal imaging boundary as the most optimal response that can be achieved in the lbm method by choosing λ 0 21 to some extent is a logical and appropriate idea graphical abstract image graphical abstract keywords pore scale modeling pore network microtomography lbm pore scale porous media and magic parameter data availability data will be made available on request nomenclature cs speed of sound m s c lattice streaming speed m s dx dy imaging resolution in x and y direction m ei discrete lattice velocity in i direction fi discrete body force in lbm f i e q equilibrium density distribution function f total body force vector n f distribution function h channel width m j momentum kg m s k permeability m2 m transfer matrix ni number of grids node in pore diameter p pressure n m2 r relative error change s diagonal relaxation matrix u velocity m s wi weighting factor for discrete lattice velocity directions greek symbols δt time step s δ imaging error length m θ channel angle rad λ magic parameter ρ density kg m3 ϑ kinematic viscosity m2 s ω as anti symmetric frequencies ω s symmetric frequencies subscripts eff effective values obtained from simulation ideal ideal values corresponding to ideal image width max maximum imaging values min minimum imaging values o original physical width ϑ q e ε π m moment space components 1 introduction flow simulation in porous media has various applications in oil and gas industries geology simulation of filters implemented in fuel cells and water purification systems farajzadeh et al 2012 bourbiaux and kalaydjian 1990 zhang 2018 zhao et al 2019 lee 2018 zambrano et al 2018 zhou et al 2018 accurate flow simulation is quite challenging while coping with porous media due to the geometrical complexity and this is the reason why various studies avoid considering the geometrical details and implement macro scale simulations precise simulation of flow has a direct impact on every single phenomenon in porous media like mass transfer zhou et al 2015 and heat transfer astanina et al 2018 sheremet et al 2016 furthermore it could determine the macroscopic characteristics of a porous medium such as permeability in the past decades the only way to observe these characteristics was through experimental studies macini et al 2011 huang et al 2010 norouzi et al 2018 this method demands various geology and tissue factors and would be expensive thus several analytical relationships were proposed to determine these properties which only yielded acceptable results under certain conditions such as the carmen kozeny relationship which leads to satisfactory results only for spherical particles whose diameters change in a small range and it is not valid for cases where the particle shape moves away from the spherical state and the particle size distribution varies in a wide range nield and bejan 2013 however advances in imaging have made it possible to use various methods to simulate flow and fluid dynamics in the pore scale there are several ways to visualize the structure of cavities the most important of which are scanning electron microscopy sem chalmers et al 2012 sok et al 2010 krohn and thompson 1986 nuclear magnetic resonance nmr lai et al 2016 fang et al 2019 computed tomography micro ct jing et al 2016 ramandi et al 2016 shah et al 2016 the common feature of these methods is that they can reconstruct the main structure of the cavities without damaging or destructing them zhao et al 2019 after generating the proper geometry of the porous medium it s time to simulate in pore scale there are various procedures to make it happen such as smoothed particle hydrodynamics sph bandara et al 2013 level set method friis et al 2019 percolation models phase field methods alpak et al 2016 pore network models el zehairy et al 2019 direct navier stocks equations simulation dns with finite difference muljadi et al 2016 or finite volume raeini et al 2015 method and lattice boltzmann method alpak et al 2018 are the different manners to simulate flow in pores and determine the macroscopic properties of a porous medium another way to simulate the flow on the pore scale is to use nse equations which is a classic method due to the voxel base being of the micro ct images and alignment of the voxel borders with the main axes of the coordinate system fdm is usually implemented to discretize the single phase equations muljadi et al 2016 lbm is also a relatively new method to solve flows and has recently been used in various applications for instance fredrich et al 2006 deployed real high resolution images from the porous media to calculate stone permeability rama et al 2010 implemented lbm to simulate the flow in the membranes of fuel cells hofmann et al 2016 studied the rate of pressure drop in a channel containing various shaped particles zhou et al 2018 implemented lbm to determine the characteristics of soil containing plant waste biochar amended soil for the first time lbm is much easier to program and is easily parallelized due to the explicitness of equations as opposed to navier stokes equations nse mohamad 2011 also considering the bounce back no slip boundary condition it is applicable to simulate geometries with complex boundaries such as porous media sukop and thorne 2006 finally in the lbm method unlike the classical methods there is the ability to reduce the truncation error and enhance the accuracy of the discretization of equations by adjusting the so called magic parameter krüger et al 2017 the magic parameter is a factor relating two relaxation times symmetry and asymmetry in multi relaxation time lbms the bounce back inherently is a first order boundary condition in which adjusting the magic parameter could increase its accuracy to the second order with a subsequent decrease in the simulation error this would also control the error caused by imaging due to the first order being of the boundaries regenerated in imaging one of the most important challenges of the pore scale simulation is the correct application of the no slip boundary condition this is because of the key role of the walls in pore scale simulation there are also more advanced boundary conditions for the lbm in references fattahi et al 2016 khirevich et al 2015 ginzburg and d humières 2003 owing to the dependency of the magic parameter only on viscosity adjusting the magic parameter in bhatnagar gross krook single relaxation time bgk srt models is not applicable due to their dependency on viscosity if the magic parameter is changed the discretization error would also change therefore to regulate the magic parameter implementing more advanced models such as two relaxation time trt or multi relaxation time mrt is essential khirevich et al 2015 ginzburg and verhaeghe 2008a provided complete trt error and discretization equations and revealed that the velocity slip in the bounce back boundary condition could be modeled by considering an effective width for the channel he showed that the value of this error depends on the magic parameter and calculated the value of this parameter analytically to accurately solve the poiseuille flow in a channel there is also a more comprehensive discussion on the independency of the bounce back model to viscosity in addition to affecting the bounce beck boundary condition the magic parameter affects all equations in the lbm method for example talon et al 2012 illustrated that the magic parameter would impress the integration of velocity to determine the average velocity for the permeability calculation pan et al 2006 used the mrt method to investigate a non viscosity dependent method for the bounce back model khirevich et al 2015 examined the effect of the magic parameter on the bounce back boundary condition and the amount of permeability for an artificial model and compared its results with the analytical ones rao and schaefer 2019 also examined the effect of the magic parameter on different geometries saxena et al 2017 examined and compared different methods lbm fvm etc of flow simulation in the pore scale and investigated different modeling factors such as computational cost required hardware for calculations and the accuracy of results especially the permeability shah et al 2016 analyzed the effect of the size of the voxels on the accuracy of the darcy flow simulation in pore scales and permeability prediction by reducing image quality and compared it with predictions achieved by the pore network method his investigations revealed that in lbm influence of the image resolution is somewhat lower zakirov and galeev 2019 also compared the amount of permeability obtained in the darcy regime and in real samples micro ct based on lbm and nse fdm methods and examined the effect of mesh refinement on the predictive performance of these two methods he noted that the convergence of the nse method with mesh fragmentation is much greater than that of lbm but did not point out that the major changes in lbm results are due to mesh fragmentation of the solid boundary areas and the accuracy of the bounce back boundary condition the error range is due to the non ideal size of the voxels in this study we address the problems and challenges involved in pore scale simulation using the lattice boltzmann method and compare it with the nse method focusing on models produced by micro ct images voxel base samples micro ct images always reconstruct geometry with some error the amplitude of which depends on the resolution of the images and the size of the voxels according to this fact in the present study by considering a simple horizontal and diagonal channel the possible ranges of these errors are quantified and a boundary between this range is defined as the ideal boundary for imaging the effect of the magic parameter on the lbm results is investigated afterward both analytically and numerically and based on that some magic parameters are presented as ideal magic parameters which merge the boundary on the ideal boundary at different channel angles then by averaging and minimizing error the optimal value for the magic parameter is presented at different angles furthermore it was shown that under certain conditions the range of changes in predictions resulting from variations of the magic parameter is always less than the one arising from imaging these achievements were examined on real micro ct samples and based on it one could estimate the imaging error impact on the permeability value finally using these definitions the two methods of nse and lbm have been compared based on micro ct images initially using the same two simple models of horizontal and sloped channels the error caused by these two methods on the hypothetical micro ct images was examined and compared with the ideal boundaries the results were then analyzed in real geometry and it was shown that in the ideal magic parameter the nse result permeability an average velocity is always less than lbm as mentioned before ginzburg and verhaeghe 2008a pan et al 2006 in lbm unlike the classical method it is possible to reduce the value of the truncation error of equations by adjusting the magic parameter the present study reveals how this could affect different parts of the simulation 2 methodology pore scale flow simulations through micro ct images of porous media have been widely used in recent years to determine the macroscopic properties of porous media an image is taken from a porous sample like the one presented in fig 1 which shows a large set of interconnected pores that can be divided into channels with different widths and angles in pore scale simulations prediction errors are caused by both imaging errors and numerical approximations which are depicted schematically in fig 1 the choice of an appropriate width for these channels is the key to minimizing the simulation errors the minimum and maximum errors occur in the channels pores with horizontal borders and with the borders having an angle of 45 degree with the horizontal direction respectively as a result to quantify the possible range of the simulation error images of a horizontal and a 45 degrees channel is used in this work for pore scale simulations the pore geometry is reconstructed using gray images acquired by x ray tomography the resolution of the images controls the errors in capturing the boundary of the pore channels the so called imaging errors to model this error we consider a simple and straight channel like the one presented in fig 2 we aim to find the optimum width for the channel to minimize the related prediction error in its simplest form the optimum width falls in the range of h min h max fig 2 the width that makes the least changes in channel width from micro ct imaging in comparison to the real physical value can be considered as the ideal one obviously this ideal value for channel width is h m i n h m a x 2 also according to the analytical relation between permeability and the channel width defined as k h 2 12 permeability error range is h m i n 2 12 h m a x 2 12 which is different with channel width error range however as mentioned in appendix 1 the ideal value is h i d e a l 2 12 which is exactly coincident to the same channel with ideal width based on the flow field obtained from a numerical simulation in the channel and with the help of the poiseuille relation we can obtain the width equivalent to this velocity field which we define it as the effective width of the channel in the lbm the effective width of the channel depends on the value of the magic parameter λ ginzburg and verhaeghe 2008a as a result this value should be determined so that the effective width is close to the ideal imaging width to generalize the results two images with high and low resolutions that are generated from the x ray computed tomography method have been used the first one is obtained from imperial college london micro ct images and networks 2020 and was analyzed in muljadi s study muljadi et al 2016 by the nse method and which is associated with a bead pack sample secondly a relatively low resolution image was generated to evaluate the effect of the resolution and magic parameter on the performance of the lbm method details of these two images are given in fig 14 and table 1 the results permeability of the two methods with experimental ones have also been compared in fig 17 based on all the above definitions and concepts the steps taken in this study are as follows provide an analytical process to investigate and determine the amplitude of imaging error in direct channels and determine the optimal number of results ideal boundary in this error amplitude obtaining the ideal magic parameter in the lattice boltzmann method by minimizing the difference between the numerical simulation and ideal boundary analytical results in the micro ct image in channels with different angles comparison of numerical simulation results of lbm with nse fdm results considering the effect of magic parameter and imaging error on simulation results comparison of the error amplitude due to the change in the magic parameter in the lattice boltzmann method with the error amplitude of the micro ct images meaning with which values of magic parameter the calculated effective width of the channel is within the allowable imaging boundary range provide a process in the lattice boltzmann method by changing the magic parameter in a specific range and determining the effect of the micro ct image resolution on the quality and amplitude of changes in the pore scale simulation results 2 1 lattice boltzmann equations in the present study the multiple relaxation time mrt model is used in which the main lbm equation is defined based on the mrt collision operator with the force term as follows krüger et al 2017 1 f x e δ t t δ t f x t m 1 s m f e q x t f x t i 1 2 s m f where f is the density distribution function δt is the time step in the lattice scale in lbm in addition to discretized time and space it is essential to discretize the velocity field e is the discrete velocity which for the d3q19 model is defined as krüger et al 2017 2 e c 0 1 1 0 0 0 0 0 0 0 0 0 1 1 0 0 0 1 0 1 1 0 1 1 1 0 0 1 1 0 0 0 1 1 1 1 0 1 1 1 1 1 1 0 0 1 1 0 0 0 1 1 1 1 0 1 1 in which c is the lattice velocity that is considered to be equal to 1 for this model and 3 f i e q ρ u ρ w i 1 e i u c s 2 e i u 2 2 c s 4 u 2 2 c s 2 f presents the body forces and is defined based on the guo model guo et al 2002 silva and semiao 2012 as follows 4 f i w i e i u c s 2 e i u e i c s 4 f in which cs is the sound speed in lattice units and equals to 1 3 f is the body force and ω i is the weighting factor corresponding to each velocity direction given by w0 1 3 w1 6 1 18 w7 18 1 36 krüger et al 2017 ρ and u are the density and macroscopic velocity in the lattice scale respectively that could achieve in terms of distribution function krüger et al 2017 5 ρ i f i 6 u 1 ρ i e i f i f δ t 2 ρ m is an orthogonal matrix that transfers distribution functions to the moment space d humières 2002 s on the other hand is a diagonal matrix which for d3q19 model could be briefly determined as s ωi diag 0 ω e ωε 0 ω q 0 ω q 0 ω q ωϑ ωπ ωϑ ωπ ωϑ ωϑ ωϑ ω m ω m ω m hofmann et al 2016 ginzburg and verhaeghe 2008a 2 2 the magic parameter the numerical discretization error is controlled by introducing the magic parameter in single relaxation time srt collision models the magic parameter could not be controlled with the viscosity and this matter is only available in multi relaxation time models mrt in the two relaxation time model trt the magic parameter is defined as khirevich and patzek 2018 7 λ λ λ 1 ω δ t 1 2 1 ω δ t 1 2 in which ω is obtained from viscosity by ϑ c s 2 1 ω 1 2 δ t and ω is arbitrary and the magic parameter could be controlled while viscosity is varying for the mrt model instead of two frequencies there are multiple ones or multiple corresponding relaxation times which some of them are correlated to each other so that by combination they could generate various magic parameters which every one of them affects the error of the equation with different levels khirevich et al 2015 in the mrt method frequencies are divided into two symmetric and antisymmetric positive and negative groups now the combination of each of the two groups illustrated in fig 3 will generate a magic parameter that would independently affect the simulation error khirevich et al 2015 8 λ j k λ j λ k j e π ε ϑ k q m λ j k λ ϑ λ q λ e λ q λ ε λ q λ π λ q λ ϑ λ m λ e λ m λ ε λ m λ π λ m the above equations represent the groups in fig 3 in which for d3q19 model there are 8 independent magic parameters in the present equation for the mrt model all the magic parameters are assumed identical so that mrt approximately translates to trt pan et al 2006 thereupon in the above equations all the frequencies related to the symmetric part ω s would be set equal to frequency obtained from viscosity as follows krüger et al 2017 9 ω s 1 ϑ c s 2 δ t 1 2 the subscript s represents the frequencies of the symmetric section to keep the value of the magic parameter constant the following relation is used to calculate the frequencies of the anti symmetrical section 10 ω a s 4 2 ω s 4 λ 1 ω s 2 with the help of eq 10 if the viscosity is specified the magic parameter would be determined the superscript as refers to the anti symmetric section and ω as represents all the anti symmetric frequencies 2 3 error analysis by considering the magic parameter as mentioned the magic parameter affects the accuracy of discretization of the lattice boltzmann equation for example λ 1 12 cancels the third order spatial error leading to optimal results for pure advection problems krüger et al 2017 λ 1 6 cancels the fourth order spatial error providing the most accurate results for the pure diffusion equation krüger et al 2017 λ 3 16 results in the boundary wall location implemented via bounce back for the poiseuille flow exactly in the middle between horizontal walls and fluid nodes ginzburg and verhaeghe 2008a λ 1 8 presents accurate permeability in the horizontal channel and eliminates the numerical integration error of velocity to achieve the average velocity talon et al 2012 λ 1 4 provides more stable simulations ginzburg et al 2010 2 3 1 bounce back error so far it has been mentioned that the correct application of velocity location on the bounce back boundary condition plays a key role as far as choosing the right one in the various forms of the solid boundary can transform the bounce back boundary condition from a first order boundary condition to a second order one fig 4 illustrates an overall view of how the magic parameter could affect the accuracy of the bounce back boundary condition in comparison to second order boundary conditions in nse also due to the frequent repetition of the bounce back boundary condition in the physics of flow simulation in the porous media in pore scale reduction of the bounce back error by adjusting the value of λ is much more important than other errors owing to the multiplicity of solid boundaries moreover to conquer this problem it is possible to implement more advanced models of boundary conditions such as libb 1 1 linear interpolation bounce back bouzidi et al 2001 qibb 2 2 quadratic extension lallemand and luo 2003 iebb 3 3 interpolation extrapolation bounce back mei et al 2000 mr 4 4 multi reflection ginzburg and verhaeghe 2008b and cli 5 5 central linear interpolation fattahi et al 2016 ginzburg and verhaeghe 2008b schemes by using these models the boundary of the voxels can be precisely modeled but this does not necessarily produce results closer to reality because the actual boundaries of the sample do not exactly match the boundaries of the voxels and the images produced are always with a slight error this is evident by producing a photograph of the same sample with smaller voxels saxena 2018 see figs 2 and 4 considering the boltzmann equations and with the help of chapman enskog expansion the discretization type of the bounce back boundary condition could be determined in general the discretized equations are dependent on not only velocity but also pressure krüger et al 2017 however ginzburg and verhaeghe 2008a simplified the discretization by considering the poiseuille flow model in a straight horizontal channel as x p f x λ ν 3 y 2 j x y in which jx is the momentum in the channel direction as a result of this simplification relation for discretization of velocity in bounce back boundary is obtained as 11 j x 1 2 y j x c i y 2 3 λ y 2 j x c i y 2 ω i c i y 0 in the bounce back boundary condition it is expected that the location in which the velocity boundary condition is applied would be in the middle of two nods thus assuming dx 1 bounce back would recover second order discretization of stocks equations meaning j x d x 2 y j x 1 2 d x 2 2 y 2 j x 0 only if the second coefficient of momentum derivative 2 3 λ equals to 1 2 d x 2 2 therefore λ is obtained as ginzburg and verhaeghe 2008a 12 λ j k λ j λ k 3 16 when λ 3 16 the location of zero velocity in the horizontal channel would exactly match the middle of the nods which is called the zero velocity mid way bounce back boundary condition however the selection of the other values for the magic parameters would cause a slip in the velocity in a way that if λ 3 16 channel width is less and if λ 3 16 it becomes more than the ideal width ginzburg and verhaeghe 2008a modeled this slip by considering an effective width heff and substituting eq 13 into 11 in boundary nods h 2 1 2 so he achieved the effective width in terms of the magic parameter as shown in eq 19 13 j x y f x x p 2 ν y 2 h e f f 2 14 h e f f 2 h i d e a l 2 16 3 λ 1 by substituting λ 3 16 in eq 14 hideal would equal to heff and assuming channel width has at least two nods then h e f f h 2 0 134 which represents the difference between the effective and ideal boundary δ at one side of the horizontal channel thus the value of the effective width would never be less than hmin in fig 2 ginsburg also expanded the above equations for poiseuille flow in a channel with the desired angle θ considering a new coordinate system x y which makes an angle θ with the horizon the poiseuille relation is written as x p f x λ ν 3 y 2 j x y using chapman enskog expansion the discrete form of no slip bounce back boundary condition is derived ginzburg and verhaeghe 2008a 15 j i 1 2 i j i 3 θ i 2 1 3 θ i 2 λ i 2 j i ω i 0 in the above equation the subscript i represents the direction of each of the cut links and θ c i 1 y represents the velocity direction perpendicular to the channel flow direction same as eq 11 if one would want this relation to recover the no slip bc between two nods with the order of magnitude of two the following relation must be established for the magic parameter ginzburg and verhaeghe 2008a 16 λ j k λ j λ k 3 θ q 2 8 3 θ q 2 1 based on the above equation at any given angle in a particular magic parameter the error value is zero and it is impossible to access them simultaneously furthermore this relationship is valid only for an angle between 0 and 45 but for angles that are more than 45 relations are repeated because an acute angle with grid lines is considered according to this a limit is determined for the magic parameter so that at the angle θ 0 λ 3 16 and at the angle θ π 4 θ 2 1 2 which the magic parameter corresponding to this angle is λ 3 8 the other values are between these two and are in the range 3 16 3 8 therefore to simulate by lbm using the bounce back boundary condition values between this range are suggested however the extent of their effect on the results is not the same which will be investigated in the following context according to ginsburg for channels with different angles eq 14 could be expanded for h eff ginzburg and verhaeghe 2008a 17 h i e f f 2 h i 2 λ λ θ 1 for 45 considering λ 1 2 3 8 and the fact that the cut links are in the vertical direction y h i 2 h 2 2 thus eq 17 would be simplified for 45 channel as 18 h e f f 2 h i d e a l 2 4 3 λ 1 2 comparing these relations with those of horizontal channels it is clear that in each case a specific magic parameter leads to the exact ideal answer however the main point is that as the channel wall goes to 45 the coefficient of the magic parameter and the range of error due to changes in the magic parameter are reduced over a certain range this means that the effect of the magic parameter is not equal and with increasing the angle it decreases so an ideal magic parameter for the combination of the angles could be obtained by integration and interpolation for this purpose consider the vertical cut link in the y direction i e cv in fig 6 the ideal channel width in the direction of this cut link based on the real channel width is h v h c o s θ and the effective width value in this direction also is h e f f v h e f f c o s θ by substituting these two relations in eq 17 19 h e f f 2 h 2 e r λ θ e r λ θ c o s 2 θ 8 3 3 c o s 2 θ 1 λ er λ θ is the error generated in a channel with the desired angle with the mid width fig 5 illustrates the er function value at corresponding angles for λ 1 8 the error is the same for all the angles and equals to 1 3 in the following context the magic parameter that leads to the closest answer to all values is achieved by integration of the error relation over the range 0 pi 4 and by setting it to zero according to eq 20 the optimal magic parameter is obtained as 20 0 π 4 e r λ θ d θ 0 λ 1 8 π 2 1 π 6 1 0 21089 although this value does not lead to optimal estimation for all geometries but in general this value simulates the velocity field in most geometries with the least error among all in average 2 3 2 integration error to calculate mean velocity in permeability using the darcy model permeability tensor components are defined as muljadi et al 2016 21 k i j μ δ p j u i i j 1 2 3 where δpj and u i are pressure gradient in j direction and mean volumetric velocity in i direction respectively u i is defined as muljadi et al 2016 22 u i 1 v t ω u i d ω in which vt is the total volume of the sample including solid matrix and pores dω is a volumetric element in the pore domain to calculate this integration the trapezoidal discrete form is usually used 23 u x k n k j n j i n i u x i j k n i n j n k due to the form of discretization eq 23 especially on the boundaries a significant error is produced in calculating the mean velocity talon et al 2012 demonstrated that the magic parameter could partially control this error to further reduce this error we use higher order interpolations to discrete the integral of eq 22 by using the eq 14 a relation for the effective permeability is derived as talon et al 2012 24 k e f f k i d e a l 2 3 λ 1 12 in the above equation kideal is the exact value of permeability corresponding to the ideal boundary in fig 2 for λ 1 8 the effective permeability keff equals to exact one kideal that is different from the magic parameter which leads to accurate flow simulation hideal in present study relationship for the 45 degree channel is also developed details of the analytical calculations are presented in appendix 2 as 25 k e f f k e x 1 6 λ 1 24 according to the above equation for the 45 degree channel for λ 1 4 keff equals to kex in eqs 24 and 25 substituting a magic parameter that leads to a channel width equal to h and simulates the velocity field precisely would result in an effective permeability that is always less than the exact one this case is caused by the velocity integration error 2 4 effect of voxel size previous equations are in lattice scale therefore by assuming dxl 1 then h r h l d x r which dxr is exactly equal to the voxel size h l and h r are width of the channel in the lattice scale and real scale respectively substituting these into horizontal channel relation i e eq 14 we obtain 26 h e f f 2 h 2 16 3 λ 1 d x r 2 in general err λ θ in eq 19 becomes 27 e r λ θ c o s 2 θ 8 3 3 c o s 2 θ 1 λ d x r 2 the basic idea of this relation is that by varying the resolution one could keep the total error constant with the help of adjusting the magic parameter in the following a concept called relative error range due to the magic parameter will be defined the ratio δ in fig 6 to the size of the voxels dxr is considered as the relative error and the rate of the range of this error to the magic parameter is considered to be the relative error range in the simulation the relative error is defined because it could significantly help in choosing a reliable value magic parameter and appropriate resolution for imaging so based on eq 26 for the horizontal channel 28 r δ λ d x r h d x r 2 16 3 λ 1 h d x r in micro ct images considering section 2 1 and fig 2 the range of this error r for the horizontal channel is always between 1 2 1 2 this is because in the micro ct image from the horizontal channel see fig 2b δ is in the range of dx 2 dx 2 so r is calculated as δ d x range of the error for reconstruction of images could be less more than the ideal width defined in fig 2 as much as half of the voxel size value 1 2 r mi ct 1 2 in eq 28 h d x r ratio represents ni or number of voxels in channel width by defining ni one could obtain relative error r for the magic parameter change fig 7 illustrates above discussion considering various ni values as shown in fig 7 for the magic parameter and reasonable ni values the error value due to the change in the magic parameter is always within the error range due to imaging this means that d λ d c t which d represents the range of the change due to magic parameter and imaging errors considering the case of the horizontal channel and ni 3 for a magic parameter of about 1 5 the relative error is 0 5 and equals to relative imaging error while for ni 6 this value is 2 6 and with the increase of ni to 10 and to the magic parameter 4 1 the error caused by the changes in the magic parameter is less than the error due to imaging fig 7 shows that despite that error is relative to the size of the voxels its value decreases with the increasing number of nodes furthermore another important point that is clear in fig 7 is that for ideal magic parameters for the horizontal channel at different ni values the relative error r always becomes zero therewith for 45 channel based on eq 18 imaging error is obtained in the same way as a horizontal channel as follows 29 r δ λ d x r h d x r 2 4 3 λ 1 2 h d x r however in this case the range of the relative error for the micro ct image is different from the horizontal channel according to fig 2 and is equal to the interval 1 2 2 1 2 2 the horizontal channel interval is smaller however in ni values are similar to the horizontal channel the changes caused by the magic parameter grow larger posterior to the imaging error fig 7b also supports this statement which is again due to the greater slope of the error in the horizontal channel which makes the boundaries in the same direction with the coordinate system horizontal or vertical more critical general for all channel angles according to eq 19 below relation is obtained 30 r δ λ d x r h d x r 2 e r λ θ h d x r in which er λ θ is calculated from the eq 19 however the crucial point is that the upper and lower limits of this error occur for the horizontal channel and 45 another interesting point that can be deduced from the above equations is that based on the rate of change in the results compared to the changes in the magic parameter it can be estimated to some extent what error the reconstructed image has reconstructed this means d λ d c t in which da and dct are the magic parameter and the imaging error range respectively with the help of the average diameter and size of the voxels it is possible to estimate how many nodes are in each pore i e the average ni of the sample finally with the help of fig 8 and the mean ni value it is possible to estimate that to what extent of the magic parameter the ideal boundary would shift by 25 50 and 100 of the upper limit of the relative imaging error in the horizontal and 45 channel that determines the ratio of the maximum relative error due to the selection of the specified magic parameter r λ to the ratio of the maximum imaging error r c t m a x h m a x h i d e a l 2 d x in the fig 2 in this situation α is exactly the ratio of the difference of the maximum imaging boundary and ideal one to the difference of gained boundary by magic parameter and ideal boundary this ratio is denoted by α r λ r c t m a x however in general α x λ x i d e a l x m a x c t x i d e a l in which x could be any parameter including effective width or permeability then considering the values of the magic parameter that causes a 25 error in the horizontal channel and 45 one can be sure that for these values the changes in the results are smaller than the changes caused by the imaging error according to fig 8 when α 1 horizontal channel is more critical and by selecting the value of 1 for the maximum magic parameter in simulation one could make sure that for a channel with at least ni 2 the error range due to the magic parameter is a subset of the imaging error range therefore 1 λ max 2 is recommended for the maximum applicable magic parameter to ensure the accuracy and stability of the solution and λ min 0 01 for the minimum magic parameter in these ranges one could always be confident that the error due to magic parameter selection is less than the imaging error this means that by increasing the magic parameter to 25 or 50 percent error the permeability obtained from it will always be in the range of the effective width derived from the imaging error and by increasing the imaging resolution the results may reach this value as a result using the values obtained with these magic parameters the least percentage of the error created by imaging can be determined and by simulating based on 100 relative error the maximum error can be estimated however in most of the simulations of processes in pore scale with complex pore geometries the effective channel width parameter could not be defined and only permeability is specified because of the integration error its results vary slightly from the ones of effective width therefore according to the obtained results and due to the relationship between the second power of permeability with length the magic parameter is more limited compared to channel width from the permeability perspective just like the effective width the horizontal channel is more critical and for α 1 when the value of the magic parameter is at maximum i e 1 only up to ni 3 the amount of error due to the magic parameter is within the imaging error range which this was less than 2 with the effective width approach this indicates that when calculating the permeability by increasing the magic parameter the maximum error increases significantly faster than the maximum imaging error therefore to ensure that the amplitude of the error due to the magic parameter is smaller than the amplitude of the imaging error an interval of 0 01 λ 1 0 is recommended for the magic parameter and if the value of ni is large the maximum value of the magic parameter can be increased up to 2 details of all these choices can be extracted from fig 8b 3 results and discussion in this section we compare the results achieved from the lbm and nse methods and investigate the effect of the magic parameter and image voxel size on the predicting capability of the lbm method first the capability of the model to simulate the processes in two simple models of horizontal and diagonal channels is discussed then simulations are extended to study the processes in the bead pack and packed sphere samples which their geometry is modeled using x ray computed tomography scans of the physical samples 3 1 comparison of flow in horizontal and sloped channels geometries presented in fig 9 are used to model the flow in the single channels the width of the horizontal and diagonal channels is 1 mm and 1 2 mm respectively poiseuille flow is modeled in the area marked in fig 9 in this example to investigate the effect of the bounce back on the effective width and permeability we have simulated the flow within a length of the channel bounded by two cross sections as the inlet and outlet where a constant pressure is generated over each as seen in fig 10 the red and the blue blocks are considered as the inlet and outlet where the average value of the inlet and outlet pressure density is calculated thereupon the average velocity in the simulation area is calculated and used to calculate the permeability according to the plots presented in figs 10 and 11 it is clear that for the horizontal channel with λ 3 16 and 45 degrees channel with λ 3 8 the values of heff and hideal would be the same the effective channel width deviates from hideal as the magnitude of the magic parameter diverges from the proposed optimal numbers this deviation is also a function of the resolution of the image it is noticeable that according to figs 12 and 13 the difference between hideal and the computed width is always less than dx this means the relative error range due to imaging is often greater than the error range due to deviation of the magic parameter from the optimal value section 2 4 in the nse method the use of the second order boundary condition makes it possible to model the boundaries of the images more realistically for the horizontal channel the imaging boundaries are superimposed on the ideal ones so the effective width of the channel estimated by nse perfectly fits the ideal one in fig 10 the nse results are completely consistent with hideal but in the 45 degree channel the image boundaries do not fit to the ideal boundary this is evident in the fig 11 that unlike the horizontal channel the nse results are far from the ideal boundary and close to hmin for the 45 degreee channel so in this channel the predictions achieved from the nse method are less than those obtained by the lbm method for the case that λ 0 in general since the boundary condition in the nse is of second order wherever the boundaries of imaging fit the ideal boundary this method produces the best results however for the inclined boundary such as the sloped channel where the imaging and the ideal boundary are different the nse method underestimates the magnitude of the effective permeability our results show that by selecting a suitable magic parameter in this example the suitable value is 0 21 the lbm can predict the effective parameters closer to the ideal case even for the inclined channels by selecting the appropriate values for the magical parameter the error is positive in horizontal channels and negative in sloped channels which can neutralize their effect together and produce a response closer to the ideal boundary result yet in the nse method the prediction error associated with the horizontal channel is nearly zero and negative for sloped channels this causes the predictions of the nse method to be always lower than the predictions to be achieved by using either the ideal boundary for the width of the channels or the lbm when the recommended magic parameter is used it also should be considered that the difference in the predicted effective permeability with the ideal one as seen in the figs 11b and 12b is due to the integral error for calculating the average velocity by eqs 22 23 that has been discussed in the section 2 3 2 to eliminate this error in the pore scale simulation we used higher order integration methods in the cost of increasing the complexity of the calculations process 3 2 micro ct model in this section we compare prediction errors associated with the boundary approximation approaches used for modeling the pore structure of the samples from micro ct scans the micro ct scans of two samples namely bead pack high resolution and packed sphere low resolution samples are used as mentioned in sec 2 which its detail is presented in table 1 fig 14 illustrates the micro ct scans of these two models pore flow through the samples was simulated and the pore stream pattern and pressure field are presented in fig 15 3 2 1 bead pack sample a low pressure gradient equal to 1 5 pa m 2 is applied to the samples to ensure that the flow stays in the darcy regime and the pore flow is simulated the permeability value for the bead pack sample predicted by the nse method is equal to 5 65 d in the lbm method the results are examined based on the change of the magic parameter that is chosen to be between 0 01 2 considering this range the permeability changes as shown in fig 16 and also detailed in table 2 and falls in the range of 5 367 d 7 082 d considering the magic parameter within 1 8 3 8 the change interval of the permeability value is reduced to 5 794 d 6 101 d moreover the permeability when the magic parameter λ 0 21 is equal to 5 923d this magic parameter creates the least error in the results in both geometries with the highest probability the predictions with nse are 4 3 less than those achieved by lbm when the ideal value of the magic parameter is used this difference increases as the resolution of the images decrease furthermore in other samples like zakirov s zakirov and galeev 2019 study with λ 3 16 this difference is nearly 35 3 2 2 pack sphere sample this sample is relatively large for pore scale simulation the length of which is 50 mm and is scanned with a resolution of 65 99 μm as illustrated in fig 14 in comparison to the bead pack sample it has been reconstructed with lower resolution and has a lower ni value equal to 5 9 this has been done deliberately to examine the effect of the resolution on simulation results flow through his sample has been experimentally measured by el zehairy et al 2019 and the calculated permeability of the sample is equal to 2279 81 d in the darcy regime as the ratio of pore size grading diameter to voxel size ni dp dx decreases it is expected that the change of the magic parameter has more impact on permeability predictions which is proved by the results presented in fig 17 at λ 0 01 the permeability value was 1645 6d at λ 2 0 it reaches 2588 0 d and at λ 0 21 the permeability value is 1952 0d the maximum deviation of the value from the one achieved by the ideal one is equal to 43 if the magic parameter in the range of 0 01 2 is chosen and it reaches 9 3 if the magic parameter falls in the range of 1 8 3 8 permeability calculated with the ideal magic parameter equal to 0 21 is 14 38 less than the one calculated experimentally it could be caused by imaging or experiment procedure errors however it is highly attractive that experimental permeability is within the permeability range corresponding to 0 01 λ 2 0 interval for the magic parameter in addition to these cases due to the passage of the flow through the sample in the experimental real conditions and the generated momentum a slight change in the structure of the porous medium happened and some very small obstacles from the porous media were eroded therefore the permeability in the experimental results increases slightly which is omitted from the examination due to the difficulty of estimating the impact of this issue as mentioned the permeability value of the packed sphere sample is 1952 d according to the initial estimates the permeability of this sample was expected to be slightly lower based on the flow pattern in this sample channels have been created near the cylinder for the flow to pass and their speed is higher than other points these channels can significantly affect the simulation results if we separate a smaller cube from the center of the sample in such a way that there are no more cylinder boundaries in it the permeability value decreases to 1614 3 which is a significant change this issue is effective both numerically and experimentally to obtain better experimental results in future works more attention should be paid to the formation of these channels which is revealed in the numerical solution and obtained by simulating the velocity field permeability obtained from the nse method is 1795 0d which is in the range of the permeability predicted by lbm using the value of the magic parameter chosen from the range of 0 01 3 16 this value predicted for the permeability is 21 23 less than the experimentally measured permeability the results of both lbm and nse methods are different from the laboratory results but the permeability obtained by the nse method using the low resolution image is less than the lbm results when the magic parameter is set to 0 21 the lbm results are closer to the experimentally measured one this is because of interpolation in the solid boundaries by the deliberate setting of the magic parameter which reduces the prediction error another point in the lbm is that the laboratory results are in the range of the values predicted for the permeability using the values of the magic parameter that vary from 0 01 to 2 0 therefore in the lbm method by changing the magic parameter one can provide a logical range for the permeability value and accordingly can quantify the range of error due to all the computational approximations for calculating the sample properties 3 3 enlarging the mesh in this section the image resolutions are reduced in order to determine the extent of the changes in the predictions associated with the nse and lbm methods obtained with various magic parameters the dimensions of the voxels are doubled in each step of the enlargement and the geometry is divided into a set of 2 2 2 cubes each of which contains 8 voxels if the number of solid voxels in the cube is more than half the total number of voxels it is considered as the solid zone otherwise it is part of the pore zone zakirov and galeev 2019 the resolution is increased up to a level where the porosity of the original sample is preserved in this regard the bead pack sample has been enlarged up to four times the details of which can be seen in three slices in fig 18 fig 19 illustrate that the lbm results for images of different resolution converge to 5 9d as the magic parameter moves toward the ideal value of 0 21 this is a feature of the ideal magic parameter this means using the ideal value for the magic parameter makes it possible to minimize the dependency of the numerical predictions on the image resolution this shows that in geometries where the distribution of the angles of the solid boundaries is uniform in all directions such as the samples made of spherical particles the best value for the ideal magic parameter is 0 21 the results show that the use of appropriate values for the magic parameter makes it possible to achieve reliable predictions with lower resolution images saving computational time it is seen in fig 19 that the nse results for the bead pack sample are always between the lbm results when the magic parameter falls in the range of 0 01 3 16 and nse results decrease with the decrease of the image resolution however in lbm the dependency of the results on the resolution is a function of the magic parameter so for three times enlargement of the voxels the results become independent of the resolution for the magic parameter 0 21 as the voxel size increases the prediction error increases as the magic parameter deviates from the optimum value as discussed in section 2 4 by adjusting the magic parameter it is possible to define the pore channel based on the bounce back boundary condition concept between the narrowest λ 0 01 and widest λ 2 0 pore channels that are technically possible to be defined by images this allows reducing the error that is generated to approximate the solid boundaries using the images although the predictions are functions of the image results in general choosing an inappropriate value for the magic parameters can cause significant errors in the prediction the permeability value in the 0 01 1 0 interval is calculated and presented in table 3 the permeability predicted when λ 0 21 is 20 1 different from the one calculated using the high resolution image for the second third and fourth order of magnification the errors reach 49 6 89 3 and 107 2 respectively in most of the previous studies e g talon et al 2012 ginzburg and verhaeghe 2008a rao and schaefer 2019 it was suggested that the value of the magic parameter should be within the range 1 8 3 8 the proposed range for the magic parameter is dependent on the resolution of the images as our results show that for the second third and fourth order of increase in the voxel size using a magic parameter in the range of 1 8 3 8 leads to 13 3 21 9 and 29 0 error in the prediction of the permeability respectively while using the original images with fine voxel size and the magic parameter in the range 1 8 3 8 predicted permeability will be only 5 2 different from the one predicted using the ideal magic parameter these values indicate the effect of the magic parameter on the reliability of the numerical method for permeability prediction using images with low resolution if one wants to follow the proposed range by talon et al 2012 for magic parameter image resolution for this sample should be reduced up to three times 4 conclusion in the present study the effect of the magic parameter in the lattice boltzmann method lbm was specifically investigated on micro ct images based on voxels to investigate the effects of the magic parameter simpler forms were first investigated by analytical methods and the results were generalized to numerical simulations and more complex geometries therewith considering the inherent error within imaging and the error caused by the magic parameter in the lbm the answers of this method with the navier stokes equations nse method are completely analyzed from the perspective of the type of boundary simulation and the reason for this difference has been identified deduction 1 by defining the minimum and maximum error boundaries based on the voxels obtained from the micro ct images to reconstruct a straight horizontal channel and 45 according to fig 8 the amplitude of the error due to imaging was determined based on the interpolation in this domain the concept of the ideal boundary is determined that this boundary creates the least difference with the results obtained from other members of the micro ct error domain both in terms of effective channel width and in terms of permeability accordingly in the simulation on micro ct images due to the inherent error of geometry the best criterion for increasing the quality of responses is approaching the results equivalent to the ideal boundary deduction 2 the amount of permeability and effective width of channels with different slopes in different magic parameters are equivalent to the results corresponding to the ideal width of the channels these values for horizontal channels and 45 are fully extracted in this study and previous studies however the point is that by distancing from the value of the ideal magic parameter equivalent to channels with different slopes λ 3 16 for the horizontal channel and λ 3 8 for the 45 degree channel the amount of error does not increase uniformly in fact in horizontal channels the error slope due to the magic parameter is much higher than the error slope due to the magic parameter in sloping channels or 45 based on this idea and by averaging between all angles it can be concluded that λ 0 21 in total creates the least error among all modes this means that in complex shapes with different borders and angles this value simulates the correct answer to the problem this value is in the range 3 16 3 8 but closer to 3 16 ideal magic parameter corresponding to the horizontal channel this is since the slope of the line is higher at the horizontal borders deduction 3 by comparing the error amplitude due to the change in the magic parameter with the amplitude of the imaging error it can be obtained that depending on the number of nodes in the width of the pores the amplitude of the magic parameter error is always a subset of the imaging error amplitude for example in the range 0 01 λ 1 0 always and in the range 0 01 λ 2 0 in geometries where the number of voxels per unit length of the cavity is relatively high the amplitude of the magic parameter is a subset of the amplitude of the imaging error d λ dct but for the permeability value due to its special conditions a more stringent range of 0 01 λ 1 0 is recommended for estimating the imaging error range accordingly by changing the magic parameter in these intervals an estimate of the effect of the output image resolution on the results can be obtained in fact it can be estimated that the geometries that were photographed to produce the same micro ct image differ by about a few percent and instead of a certain value provide an interval for permeability which is due to imaging error deduction 4 by simultaneously comparing the permeability and effective width of the lbm with the nse method the nse method models the boundaries of the generated image more properly while based on the ideal boundary definition for micro ct images exact simulation of the boundaries does not necessarily lead to effective results in the horizontal channel the nse results correspond to the ideal imaging boundary but in the 45 degree channel the nse results approach the minimum hmin image boundary fig 2 which reduces the quality of responses on sloping boundaries by the nse method accordingly in composite geometries the permeability of the nse method is always less than the permeability obtained from the lbm method at λ 0 21 and its value is placed somewhere in the permeability interval obtained by the lbm in the range of 0 01 λ 3 16 for the magic parameter finally the comparison of the results obtained from lbm at λ 0 21 and nse with the experimental results show less deviation for the lbm than nse credit authorship contribution statement milad hosseini methodology software validation visualization writing original draft conceptualization majid siavashi conceptualization investigation resources formal analysis data curation writing review editing supervision project administration milad shirbani writing original draft mohaddeseh mousavi nezhad supervision formal analysis writing review editing methodology declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper appendix 1 in fig 2 the effective width error range is dheff hmin hmax and this range for the permeability value is d k e f f h m i n 2 12 h m a x 2 12 the effective width value that causes the least error with other members of the domain is equal to h m i n h m a x 2 which represents the ideal width hideal in fig 2 but due to the non linear permeability relationship finding the permeability that causes the least error with other members of the dkeff domain requires a bit of computation according to fig 20 the amount of total error that the desired boundary hc between hmin and hmax creates is equal to the sum of the areas of the red and blue parts which is considered as st s 1 s 2 in fact hc which minimizes the area of st also gives the best estimate for the permeability value 1 a s t h m i n h c k c k h d h h c h m a x k h k c d h 2 a s t 1 9 h c 3 h c 2 12 h m i n h m a x h m i n 3 h m a x 3 36 3 a d s t d h c 1 3 h c 2 1 6 h c h m i n h m a x by putting d s t d h c 0 the minimum value for st would obtain 4 a h c h m i n h m a x 2 as a result in the case of the non linear form of permeability despite the difference in the amplitude of the permeability error with the effective width the ideal boundary value to obtain the optimal permeability is exactly between the two minimum and maximum widths of the micro ct image as a result the ideal boundaries are perfectly matched in terms of effective channel width and permeability to achieve the minimum error appendix 2 extraction of effective permeability relation for 45 channel talon et al 2012 in their effort for the horizontal channel showed that the exact permeability value is obtained in the magic parameter of 1 8 which is completely different from the magic parameter that correctly estimates the effective channel width λ 3 16 how to integrate velocity to calculate the average velocity in the permeability relation is the main reason for this difference in this section the relationships related to the 45 degree channel are extracted based on eq 21 for permeability 1 b k μ u p x in horizontal channel according to poison relation 2 b u 1 2 μ p x h e f f 2 y 2 d t in which heff is half of the whole channel effective width meaning h e f f h e f f 2 and t is in fact area or volume of the whole domain that the velocity is integrated on substituting eq 2 b in 2 1 3 b k e f f 1 2 1 2 μ p x h e f f 2 y 2 d t this relationship presented is comprehensive and general and could be simplified for different situations therefore for a 45 channel and when the number of nodes in the vertical direction of the channel is odd the value t according to fig 21 b is equal to 2n 1 due to the same condition of the nodes along the integration channel only the nodes in the yellow section in fig 21 are integrated in this area due to the same conditions of red and blue nodes on both sides of the channel symmetry line integration can be done only in red points as a result the above eq 3 b is discretized as follows 4 b k e f f 1 2 2 n 1 h e f f 2 2 i 1 n y i 2 2 n 1 in which y i i 2 and heff based on eq 18 could be calculated so 5 b k e f f 1 8 h i d e a l 2 4 3 λ 1 2 n n 1 12 in the above relation h i d e a l 2 n 1 2 which by substituting and simplifying 6 b k e f f k i d e a l 1 6 λ 1 24 in above k i d e a l h i d e a l 2 12 and when the value of keff becomes equal to kideal only if the residual of the above relation is zero in this case the value of the magic parameter is equal to λ 1 4 which is exactly equal to the magic parameter which leads to better stability in different collision models generated and is equivalent to τ 1 in the bgk method calculations become slightly easier when the number of nodes across the channel width is even as in fig 21a in this case relation 4 b would reform as 7 b k e f f 1 2 2 n h e f f 2 2 i 1 n y i 2 2 n in this situation y i i 1 2 which same as the previous one by substituting heff and simplifying the relation 8 b k e f f k i d e a l 1 6 λ 1 24 which is the same equation as for an odd number of nodes alpak et al 2016 f o alpak b riviere f frank a phase field method for the direct simulation of two phase flows in pore scale media using a non equilibrium wetting boundary condition comput geosci 20 5 2016 881 908 10 1007 s10596 015 9551 2 oct f o alpak b riviere and f frank a phase field method for the direct simulation of two phase flows in pore scale media using a non equilibrium wetting boundary condition comput geosci vol 20 no 5 pp 881 908 oct 2016 doi 10 1007 s10596 015 9551 2 alpak et al 2018 f o alpak f gray n saxena j dietderich r hofmann s berg a distributed parallel multiple relaxation time lattice boltzmann method on general purpose graphics processing units for the rapid and scalable computation of absolute permeability from high resolution 3d micro ct images comput geosci 22 3 2018 815 832 10 1007 s10596 018 9727 7 jun f o alpak f gray n saxena j dietderich r hofmann and s berg a distributed parallel multiple relaxation time lattice boltzmann method on general purpose graphics processing units for the rapid and scalable computation of absolute permeability from high resolution 3d micro ct images comput geosci vol 22 no 3 pp 815 832 jun 2018 doi 10 1007 s10596 018 9727 7 astanina et al 2018 m s astanina m a sheremet h f oztop n abu hamdeh mhd natural convection and entropy generation of ferrofluid in an open trapezoidal cavity partially filled with a porous medium international journal of mechanical sciences 136 2018 493 502 10 1016 j ijmecsci 2018 01 001 feb m s astanina m a sheremet h f oztop and n abu hamdeh mhd natural convection and entropy generation of ferrofluid in an open trapezoidal cavity partially filled with a porous medium international journal of mechanical sciences vol 136 pp 493 502 feb 2018 doi 10 1016 j ijmecsci 2018 01 001 bandara et al 2013 u c bandara a m tartakovsky m oostrom b j palmer j grate c zhang smoothed particle hydrodynamics pore scale simulations of unstable immiscible flow in porous media adv water resour 62 2013 356 369 10 1016 j advwatres 2013 09 014 dec u c bandara a m tartakovsky m oostrom b j palmer j grate and c zhang smoothed particle hydrodynamics pore scale simulations of unstable immiscible flow in porous media adv water resour vol 62 pp 356 369 dec 2013 doi 10 1016 j advwatres 2013 09 014 bourbiaux and kalaydjian 1990 b j bourbiaux f j kalaydjian experimental study of cocurrent and countercurrent flows in natural porous media spe reservoir engineering 5 03 1990 361 368 10 2118 18283 pa aug b j bourbiaux and f j kalaydjian experimental study of cocurrent and countercurrent flows in natural porous media spe reservoir engineering vol 5 no 03 pp 361 368 aug 1990 doi 10 2118 18283 pa bouzidi et al 2001 m bouzidi m firdaouss p lallemand momentum transfer of a boltzmann lattice fluid with boundaries physics of fluids 13 11 2001 3452 3459 10 1063 1 1399290 oct m bouzidi m firdaouss and p lallemand momentum transfer of a boltzmann lattice fluid with boundaries physics of fluids vol 13 no 11 pp 3452 3459 oct 2001 doi 10 1063 1 1399290 chalmers et al jun 2012 g r chalmers r m bustin i m power characterization of gas shale pore systems by porosimetry pycnometry surface area and field emission scanning electron microscopy transmission electron microscopy image analyses examples from the barnett woodford haynesville marcellus and doig unitscharacterization of gas shale pore systems am assoc pet geol bull 96 6 jun 2012 1099 1119 10 1306 10171111052 g r chalmers r m bustin and i m power characterization of gas shale pore systems by porosimetry pycnometry surface area and field emission scanning electron microscopy transmission electron microscopy image analyses examples from the barnett woodford haynesville marcellus and doig unitscharacterization of gas shale pore systems am assoc pet geol bull vol 96 no 6 pp 1099 1119 jun 2012 doi 10 1306 10171111052 d humières 2002 d d humières multiple relaxation time lattice boltzmann models in three dimensions philosophical transactions of the royal society of london series a mathematical physical and engineering sciences 360 1792 2002 437 451 10 1098 rsta 2001 0955 mar d d humières multiple relaxation time lattice boltzmann models in three dimensions philosophical transactions of the royal society of london series a mathematical physical and engineering sciences vol 360 no 1792 pp 437 451 mar 2002 doi 10 1098 rsta 2001 0955 el zehairy et al 2019 a a el zehairy m m nezhad v joekar niasar i guymer n kourra m a williams pore network modelling of non darcy flow through heterogeneous porous media adv water resour 131 2019 103378 10 1016 j advwatres 2019 103378 sep a a el zehairy m m nezhad v joekar niasar i guymer n kourra and m a williams pore network modelling of non darcy flow through heterogeneous porous media adv water resour vol 131 p 103378 sep 2019 doi 10 1016 j advwatres 2019 103378 fang et al 2019 c fang b pan y wang y rao y guo j li pore scale fluid distributions determined by nuclear magnetic resonance spectra of partially saturated sandstonespore scale fluid distributions geophysics 84 3 2019 mr107 mr114 10 1190 geo2018 0286 1 may c fang b pan y wang y rao y guo and j li pore scale fluid distributions determined by nuclear magnetic resonance spectra of partially saturated sandstonespore scale fluid distributions geophysics vol 84 no 3 pp mr107 mr114 may 2019 doi 10 1190 geo2018 0286 1 farajzadeh et al 2012 r farajzadeh a andrianov r krastev g j hirasaki w r rossen foam oil interaction in porous media implications for foam assisted enhanced oil recovery adv colloid interface sci 183 184 2012 1 13 10 1016 j cis 2012 07 002 nov r farajzadeh a andrianov r krastev g j hirasaki and w r rossen foam oil interaction in porous media implications for foam assisted enhanced oil recovery adv colloid interface sci vol 183 184 pp 1 13 nov 2012 doi 10 1016 j cis 2012 07 002 fattahi et al 2016 e fattahi c waluga b wohlmuth u rüde m manhart r helmig lattice boltzmann methods in porous media simulations from laminar to turbulent flow comput fluids 140 2016 247 259 10 1016 j compfluid 2016 10 007 nov e fattahi c waluga b wohlmuth u rüde m manhart and r helmig lattice boltzmann methods in porous media simulations from laminar to turbulent flow comput fluids vol 140 pp 247 259 nov 2016 doi 10 1016 j compfluid 2016 10 007 fredrich et al 2006 j t fredrich a a digiovanni d r noble predicting macroscopic transport properties using microscopic image data journal of geophysical research solid earth 111 b3 2006 10 1029 2005jb003774 mar j t fredrich a a digiovanni and d r noble predicting macroscopic transport properties using microscopic image data journal of geophysical research solid earth vol 111 no b3 mar 2006 doi 10 1029 2005jb003774 friis et al 2019 h a friis j pedersen e jettestuen j o helland m prodanović pore scale level set simulations of capillary controlled displacement with adaptive mesh refinement transp porous med 128 1 2019 123 151 10 1007 s11242 019 01238 6 may h a friis j pedersen e jettestuen j o helland and m prodanović pore scale level set simulations of capillary controlled displacement with adaptive mesh refinement transp porous med vol 128 no 1 pp 123 151 may 2019 doi 10 1007 s11242 019 01238 6 ginzburg and d humières 2003 i ginzburg d d humières multireflection boundary conditions for lattice boltzmann models phys rev e 68 6 2003 066614 10 1103 physreve 68 066614 dec i ginzburg and d d humières multireflection boundary conditions for lattice boltzmann models phys rev e vol 68 no 6 p 066614 dec 2003 doi 10 1103 physreve 68 066614 ginzburg and verhaeghe 2008a i ginzburg f verhaeghe study of simple hydrodynamic solutions with the two relaxation times lattice boltzmann scheme commun comput phys 2008 64 i ginzburg and f verhaeghe study of simple hydrodynamic solutions with the two relaxation times lattice boltzmann scheme commun comput phys p 64 2008 ginzburg and verhaeghe 2008b i ginzburg f verhaeghe two relaxation time lattice boltzmann scheme about parametrization velocity pressure and mixed boundary conditions commun comput phys 2008 53 i ginzburg and f verhaeghe two relaxation time lattice boltzmann scheme about parametrization velocity pressure and mixed boundary conditions commun comput phys p 53 2008 ginzburg et al 2010 i ginzburg d d humières a kuzmin optimal stability of advection diffusion lattice boltzmann models with two relaxation times for positive negative equilibrium j stat phys 139 6 2010 1090 1143 10 1007 s10955 010 9969 9 jun i ginzburg d d humières and a kuzmin optimal stability of advection diffusion lattice boltzmann models with two relaxation times for positive negative equilibrium j stat phys vol 139 no 6 pp 1090 1143 jun 2010 doi 10 1007 s10955 010 9969 9 guo et al 2002 z guo c zheng b shi discrete lattice effects on the forcing term in the lattice boltzmann method phys rev e 65 4 2002 046308 10 1103 physreve 65 046308 apr z guo c zheng and b shi discrete lattice effects on the forcing term in the lattice boltzmann method phys rev e vol 65 no 4 p 046308 apr 2002 doi 10 1103 physreve 65 046308 hofmann et al 2016 s hofmann a bufe g brenner t turek pressure drop study on packings of differently shaped particles in milli structured channels chem eng sci 155 2016 376 385 10 1016 j ces 2016 08 011 nov s hofmann a bufe g brenner and t turek pressure drop study on packings of differently shaped particles in milli structured channels chem eng sci vol 155 pp 376 385 nov 2016 doi 10 1016 j ces 2016 08 011 huang et al 2010 b huang h wu x shu e g burdette laboratory evaluation of permeability and strength of polymer modified pervious concrete construction and building materials 24 5 2010 818 823 10 1016 j conbuildmat 2009 10 025 may b huang h wu x shu and e g burdette laboratory evaluation of permeability and strength of polymer modified pervious concrete construction and building materials vol 24 no 5 pp 818 823 may 2010 doi 10 1016 j conbuildmat 2009 10 025 jing et al 2016 y jing r t armstrong h l ramandi p mostaghimi coal cleat reconstruction using micro computed tomography imaging fuel 181 2016 286 299 10 1016 j fuel 2016 04 127 oct y jing r t armstrong h l ramandi and p mostaghimi coal cleat reconstruction using micro computed tomography imaging fuel vol 181 pp 286 299 oct 2016 doi 10 1016 j fuel 2016 04 127 khirevich and patzek 2018 s khirevich t w patzek behavior of numerical error in pore scale lattice boltzmann simulations with simple bounce back rule analysis and highly accurate extrapolation physics of fluids 30 9 2018 093604 10 1063 1 5042229 sep s khirevich and t w patzek behavior of numerical error in pore scale lattice boltzmann simulations with simple bounce back rule analysis and highly accurate extrapolation physics of fluids vol 30 no 9 p 093604 sep 2018 doi 10 1063 1 5042229 khirevich et al 2015 s khirevich i ginzburg u tallarek coarse and fine grid numerical behavior of mrt trt lattice boltzmann schemes in regular and random sphere packings j comput phys 281 2015 708 742 10 1016 j jcp 2014 10 038 jan s khirevich i ginzburg and u tallarek coarse and fine grid numerical behavior of mrt trt lattice boltzmann schemes in regular and random sphere packings j comput phys vol 281 pp 708 742 jan 2015 doi 10 1016 j jcp 2014 10 038 krüger et al 2017 t krüger h kusumaatmaja a kuzmin o shardt g silva e m viggen the lattice boltzmann method principles and practice 2017 springer international publishing accessed jun 09 2018 online available https www springer com gb book 9783319446479 t krüger h kusumaatmaja a kuzmin o shardt g silva and e m viggen the lattice boltzmann method principles and practice springer international publishing 2017 accessed jun 09 2018 online available https www springer com gb book 9783319446479 krohn and thompson 1986 c e krohn a h thompson fractal sandstone pores automated measurements using scanning electron microscope images phys rev b 33 9 1986 6366 6374 10 1103 physrevb 33 6366 may c e krohn and a h thompson fractal sandstone pores automated measurements using scanning electron microscope images phys rev b vol 33 no 9 pp 6366 6374 may 1986 doi 10 1103 physrevb 33 6366 lai et al 2016 j lai insight into the pore structure of tight sandstones using nmr and hpmi measurements energy fuels 30 12 2016 10200 10214 10 1021 acs energyfuels 6b01982 dec j lai et al insight into the pore structure of tight sandstones using nmr and hpmi measurements energy fuels vol 30 no 12 pp 10200 10214 dec 2016 doi 10 1021 acs energyfuels 6b01982 lallemand and luo 2003 p lallemand l s luo lattice boltzmann method for moving boundaries j comput phys 184 2 2003 406 421 10 1016 s0021 9991 02 00022 0 jan p lallemand and l s luo lattice boltzmann method for moving boundaries j comput phys vol 184 no 2 pp 406 421 jan 2003 doi 10 1016 s0021 9991 02 00022 0 lee 2018 d y lee lattice boltzmann simulations for wall flow dynamics in porous ceramic diesel particulate filters appl surf sci 2018 9 d y lee lattice boltzmann simulations for wall flow dynamics in porous ceramic diesel particulate filters appl surf sci p 9 2018 macini et al 2011 p macini e mesini r viola laboratory measurements of non darcy flow coefficients in natural and artificial unconsolidated porous media journal of petroleum science and engineering 77 3 2011 365 374 10 1016 j petrol 2011 04 016 jun p macini e mesini and r viola laboratory measurements of non darcy flow coefficients in natural and artificial unconsolidated porous media journal of petroleum science and engineering vol 77 no 3 pp 365 374 jun 2011 doi 10 1016 j petrol 2011 04 016 mei et al 2000 r mei w shyy d yu l s luo lattice boltzmann method for 3 d flows with curved boundary j comput phys 161 2 2000 680 699 10 1006 jcph 2000 6522 jul r mei w shyy d yu and l s luo lattice boltzmann method for 3 d flows with curved boundary j comput phys vol 161 no 2 pp 680 699 jul 2000 doi 10 1006 jcph 2000 6522 micro ct images and networks 2020 micro ct images and networks imperial college london http www imperial ac uk engineering departments earth science research research groups perm research pore scale modelling micro ct images and networks accessed nov 29 2020 mohamad 2011 a a mohamad lattice boltzmann method fundamentals and engineering applications with computer codes 2011 springer verlag london accessed jun 09 2018 online available https www springer com us book 9780857294548 a a mohamad lattice boltzmann method fundamentals and engineering applications with computer codes london springer verlag 2011 accessed jun 09 2018 online available https www springer com us book 9780857294548 muljadi et al 2016 b p muljadi m j blunt a q raeini b bijeljic the impact of porous media heterogeneity on non darcy flow behaviour from pore scale simulation adv water resour 95 2016 329 340 10 1016 j advwatres 2015 05 019 sep b p muljadi m j blunt a q raeini and b bijeljic the impact of porous media heterogeneity on non darcy flow behaviour from pore scale simulation adv water resour vol 95 pp 329 340 sep 2016 doi 10 1016 j advwatres 2015 05 019 nield and bejan 2013 d a nield a bejan mechanics of fluid flow through a porous medium convection in porous media 2013 springer new york new york ny 1 29 10 1007 978 1 4614 5541 7 1 d a nield and a bejan mechanics of fluid flow through a porous medium in convection in porous media new york ny springer new york 2013 pp 1 29 doi 10 1007 978 1 4614 5541 7 1 norouzi et al 2018 a m norouzi m siavashi a r soheili m khaliji oskouei experimental investigation of effects of grain size inlet pressure and flow rate of air and argon on pressure drop through a packed bed of granular activated carbon international communications in heat and mass transfer 96 2018 20 26 10 1016 j icheatmasstransfer 2018 05 019 aug a m norouzi m siavashi a r soheili and m khaliji oskouei experimental investigation of effects of grain size inlet pressure and flow rate of air and argon on pressure drop through a packed bed of granular activated carbon international communications in heat and mass transfer vol 96 pp 20 26 aug 2018 doi 10 1016 j icheatmasstransfer 2018 05 019 pan et al 2006 c pan l s luo c t miller an evaluation of lattice boltzmann schemes for porous medium flow simulation comput fluids 35 8 2006 898 909 10 1016 j compfluid 2005 03 008 sep c pan l s luo and c t miller an evaluation of lattice boltzmann schemes for porous medium flow simulation comput fluids vol 35 no 8 pp 898 909 sep 2006 doi 10 1016 j compfluid 2005 03 008 raeini et al 2015 a q raeini b bijeljic m j blunt modelling capillary trapping using finite volume simulation of two phase flow directly on micro ct images adv water resour 83 2015 102 110 10 1016 j advwatres 2015 05 008 sep a q raeini b bijeljic and m j blunt modelling capillary trapping using finite volume simulation of two phase flow directly on micro ct images adv water resour vol 83 pp 102 110 sep 2015 doi 10 1016 j advwatres 2015 05 008 rama et al 2010 p rama an x ray tomography based lattice boltzmann simulation study on gas diffusion layers of polymer electrolyte fuel cells j fuel cell sci technol 7 3 2010 031015 031015 12 10 1115 1 3211096 mar p rama et al an x ray tomography based lattice boltzmann simulation study on gas diffusion layers of polymer electrolyte fuel cells j fuel cell sci technol vol 7 no 3 pp 031015 031015 12 mar 2010 doi 10 1115 1 3211096 ramandi et al 2016 h l ramandi p mostaghimi r t armstrong m saadatfar w v pinczewski porosity and permeability characterization of coal a micro computed tomography study int j coal geol 154 155 2016 57 68 10 1016 j coal 2015 10 001 jan h l ramandi p mostaghimi r t armstrong m saadatfar and w v pinczewski porosity and permeability characterization of coal a micro computed tomography study int j coal geol vol 154 155 pp 57 68 jan 2016 doi 10 1016 j coal 2015 10 001 rao and schaefer 2019 p rao l schaefer lattice boltzmann models for micro tomographic pore spaces comput fluids 193 2019 104294 10 1016 j compfluid 2019 104294 rao p schaefer l 2019 lattice boltzmann models for micro tomographic pore spaces comput fluids 193 104294 doi 10 1016 j compfluid 2019 104294 saxena et al 2017 n saxena and benchmarks for pore scale flow simulated using micro ct images of porous media and digital rocks adv water resour 109 2017 211 235 10 1016 j advwatres 2017 09 007 nov n saxena et al 
69,simulation of flow at the pore scale is of paramount importance to characterize the behavior of a fluid in a porous medium the pore scale simulations allow us to investigate pore scale mechanisms governing field scale flow attributes one of the big challenges in the field of pore scale simulation is reliable modeling of the no slip boundary condition which in the lattice boltzmann method is usually defined by the bounce back boundary condition in the present study the effect of the magic parameter value on the simulation results was investigated by considering the inherent error in micro ct images and finally the results were compared with the navier stokes method ones furthermore determining the amplitude of the error due to improper image resolution is one of the challenges in simulating micro ct images which by defining the magic parameter analyzing its behavior and effect on results a proper criterion to estimate the error amplitude of flow characteristics due to the micro ct imaging is presented in this study based on the interpolation between different angles of the boundaries an ideal magic parameter λ 0 21 was presented which can simulate complex geometries with the least error in terms of the accuracy of the bounce back boundary condition it can also be found that for reasonable values of the magic parameter the error amplitude due to the magic parameter is a subset of the imaging error amplitude that is d dct a reasonable value for the magic parameter depends on the number of nodes in the pores but the range 0 01 λ 1 0 is highly reliable and the range 0 01 λ 2 0 is also recommended in networks with a very high number of nodes per unit diameter of the pore at these intervals the magic parameter error is always less than the imaging error moreover by defining the ideal boundary in micro ct images the results of lbm and nse methods are compared the results reveal that the permeability value obtained by the nse method is always slightly less than the value obtained from the lbm in the magic parameter 0 21 under the same conditions however both responses fall within the imaging error range however the lbm results at λ 0 21 were closer to the ideal and median boundary results in micro ct images finally the comparison of the numerical results with the experimental ones illustrated that considering the response that fits the ideal imaging boundary as the most optimal response that can be achieved in the lbm method by choosing λ 0 21 to some extent is a logical and appropriate idea graphical abstract image graphical abstract keywords pore scale modeling pore network microtomography lbm pore scale porous media and magic parameter data availability data will be made available on request nomenclature cs speed of sound m s c lattice streaming speed m s dx dy imaging resolution in x and y direction m ei discrete lattice velocity in i direction fi discrete body force in lbm f i e q equilibrium density distribution function f total body force vector n f distribution function h channel width m j momentum kg m s k permeability m2 m transfer matrix ni number of grids node in pore diameter p pressure n m2 r relative error change s diagonal relaxation matrix u velocity m s wi weighting factor for discrete lattice velocity directions greek symbols δt time step s δ imaging error length m θ channel angle rad λ magic parameter ρ density kg m3 ϑ kinematic viscosity m2 s ω as anti symmetric frequencies ω s symmetric frequencies subscripts eff effective values obtained from simulation ideal ideal values corresponding to ideal image width max maximum imaging values min minimum imaging values o original physical width ϑ q e ε π m moment space components 1 introduction flow simulation in porous media has various applications in oil and gas industries geology simulation of filters implemented in fuel cells and water purification systems farajzadeh et al 2012 bourbiaux and kalaydjian 1990 zhang 2018 zhao et al 2019 lee 2018 zambrano et al 2018 zhou et al 2018 accurate flow simulation is quite challenging while coping with porous media due to the geometrical complexity and this is the reason why various studies avoid considering the geometrical details and implement macro scale simulations precise simulation of flow has a direct impact on every single phenomenon in porous media like mass transfer zhou et al 2015 and heat transfer astanina et al 2018 sheremet et al 2016 furthermore it could determine the macroscopic characteristics of a porous medium such as permeability in the past decades the only way to observe these characteristics was through experimental studies macini et al 2011 huang et al 2010 norouzi et al 2018 this method demands various geology and tissue factors and would be expensive thus several analytical relationships were proposed to determine these properties which only yielded acceptable results under certain conditions such as the carmen kozeny relationship which leads to satisfactory results only for spherical particles whose diameters change in a small range and it is not valid for cases where the particle shape moves away from the spherical state and the particle size distribution varies in a wide range nield and bejan 2013 however advances in imaging have made it possible to use various methods to simulate flow and fluid dynamics in the pore scale there are several ways to visualize the structure of cavities the most important of which are scanning electron microscopy sem chalmers et al 2012 sok et al 2010 krohn and thompson 1986 nuclear magnetic resonance nmr lai et al 2016 fang et al 2019 computed tomography micro ct jing et al 2016 ramandi et al 2016 shah et al 2016 the common feature of these methods is that they can reconstruct the main structure of the cavities without damaging or destructing them zhao et al 2019 after generating the proper geometry of the porous medium it s time to simulate in pore scale there are various procedures to make it happen such as smoothed particle hydrodynamics sph bandara et al 2013 level set method friis et al 2019 percolation models phase field methods alpak et al 2016 pore network models el zehairy et al 2019 direct navier stocks equations simulation dns with finite difference muljadi et al 2016 or finite volume raeini et al 2015 method and lattice boltzmann method alpak et al 2018 are the different manners to simulate flow in pores and determine the macroscopic properties of a porous medium another way to simulate the flow on the pore scale is to use nse equations which is a classic method due to the voxel base being of the micro ct images and alignment of the voxel borders with the main axes of the coordinate system fdm is usually implemented to discretize the single phase equations muljadi et al 2016 lbm is also a relatively new method to solve flows and has recently been used in various applications for instance fredrich et al 2006 deployed real high resolution images from the porous media to calculate stone permeability rama et al 2010 implemented lbm to simulate the flow in the membranes of fuel cells hofmann et al 2016 studied the rate of pressure drop in a channel containing various shaped particles zhou et al 2018 implemented lbm to determine the characteristics of soil containing plant waste biochar amended soil for the first time lbm is much easier to program and is easily parallelized due to the explicitness of equations as opposed to navier stokes equations nse mohamad 2011 also considering the bounce back no slip boundary condition it is applicable to simulate geometries with complex boundaries such as porous media sukop and thorne 2006 finally in the lbm method unlike the classical methods there is the ability to reduce the truncation error and enhance the accuracy of the discretization of equations by adjusting the so called magic parameter krüger et al 2017 the magic parameter is a factor relating two relaxation times symmetry and asymmetry in multi relaxation time lbms the bounce back inherently is a first order boundary condition in which adjusting the magic parameter could increase its accuracy to the second order with a subsequent decrease in the simulation error this would also control the error caused by imaging due to the first order being of the boundaries regenerated in imaging one of the most important challenges of the pore scale simulation is the correct application of the no slip boundary condition this is because of the key role of the walls in pore scale simulation there are also more advanced boundary conditions for the lbm in references fattahi et al 2016 khirevich et al 2015 ginzburg and d humières 2003 owing to the dependency of the magic parameter only on viscosity adjusting the magic parameter in bhatnagar gross krook single relaxation time bgk srt models is not applicable due to their dependency on viscosity if the magic parameter is changed the discretization error would also change therefore to regulate the magic parameter implementing more advanced models such as two relaxation time trt or multi relaxation time mrt is essential khirevich et al 2015 ginzburg and verhaeghe 2008a provided complete trt error and discretization equations and revealed that the velocity slip in the bounce back boundary condition could be modeled by considering an effective width for the channel he showed that the value of this error depends on the magic parameter and calculated the value of this parameter analytically to accurately solve the poiseuille flow in a channel there is also a more comprehensive discussion on the independency of the bounce back model to viscosity in addition to affecting the bounce beck boundary condition the magic parameter affects all equations in the lbm method for example talon et al 2012 illustrated that the magic parameter would impress the integration of velocity to determine the average velocity for the permeability calculation pan et al 2006 used the mrt method to investigate a non viscosity dependent method for the bounce back model khirevich et al 2015 examined the effect of the magic parameter on the bounce back boundary condition and the amount of permeability for an artificial model and compared its results with the analytical ones rao and schaefer 2019 also examined the effect of the magic parameter on different geometries saxena et al 2017 examined and compared different methods lbm fvm etc of flow simulation in the pore scale and investigated different modeling factors such as computational cost required hardware for calculations and the accuracy of results especially the permeability shah et al 2016 analyzed the effect of the size of the voxels on the accuracy of the darcy flow simulation in pore scales and permeability prediction by reducing image quality and compared it with predictions achieved by the pore network method his investigations revealed that in lbm influence of the image resolution is somewhat lower zakirov and galeev 2019 also compared the amount of permeability obtained in the darcy regime and in real samples micro ct based on lbm and nse fdm methods and examined the effect of mesh refinement on the predictive performance of these two methods he noted that the convergence of the nse method with mesh fragmentation is much greater than that of lbm but did not point out that the major changes in lbm results are due to mesh fragmentation of the solid boundary areas and the accuracy of the bounce back boundary condition the error range is due to the non ideal size of the voxels in this study we address the problems and challenges involved in pore scale simulation using the lattice boltzmann method and compare it with the nse method focusing on models produced by micro ct images voxel base samples micro ct images always reconstruct geometry with some error the amplitude of which depends on the resolution of the images and the size of the voxels according to this fact in the present study by considering a simple horizontal and diagonal channel the possible ranges of these errors are quantified and a boundary between this range is defined as the ideal boundary for imaging the effect of the magic parameter on the lbm results is investigated afterward both analytically and numerically and based on that some magic parameters are presented as ideal magic parameters which merge the boundary on the ideal boundary at different channel angles then by averaging and minimizing error the optimal value for the magic parameter is presented at different angles furthermore it was shown that under certain conditions the range of changes in predictions resulting from variations of the magic parameter is always less than the one arising from imaging these achievements were examined on real micro ct samples and based on it one could estimate the imaging error impact on the permeability value finally using these definitions the two methods of nse and lbm have been compared based on micro ct images initially using the same two simple models of horizontal and sloped channels the error caused by these two methods on the hypothetical micro ct images was examined and compared with the ideal boundaries the results were then analyzed in real geometry and it was shown that in the ideal magic parameter the nse result permeability an average velocity is always less than lbm as mentioned before ginzburg and verhaeghe 2008a pan et al 2006 in lbm unlike the classical method it is possible to reduce the value of the truncation error of equations by adjusting the magic parameter the present study reveals how this could affect different parts of the simulation 2 methodology pore scale flow simulations through micro ct images of porous media have been widely used in recent years to determine the macroscopic properties of porous media an image is taken from a porous sample like the one presented in fig 1 which shows a large set of interconnected pores that can be divided into channels with different widths and angles in pore scale simulations prediction errors are caused by both imaging errors and numerical approximations which are depicted schematically in fig 1 the choice of an appropriate width for these channels is the key to minimizing the simulation errors the minimum and maximum errors occur in the channels pores with horizontal borders and with the borders having an angle of 45 degree with the horizontal direction respectively as a result to quantify the possible range of the simulation error images of a horizontal and a 45 degrees channel is used in this work for pore scale simulations the pore geometry is reconstructed using gray images acquired by x ray tomography the resolution of the images controls the errors in capturing the boundary of the pore channels the so called imaging errors to model this error we consider a simple and straight channel like the one presented in fig 2 we aim to find the optimum width for the channel to minimize the related prediction error in its simplest form the optimum width falls in the range of h min h max fig 2 the width that makes the least changes in channel width from micro ct imaging in comparison to the real physical value can be considered as the ideal one obviously this ideal value for channel width is h m i n h m a x 2 also according to the analytical relation between permeability and the channel width defined as k h 2 12 permeability error range is h m i n 2 12 h m a x 2 12 which is different with channel width error range however as mentioned in appendix 1 the ideal value is h i d e a l 2 12 which is exactly coincident to the same channel with ideal width based on the flow field obtained from a numerical simulation in the channel and with the help of the poiseuille relation we can obtain the width equivalent to this velocity field which we define it as the effective width of the channel in the lbm the effective width of the channel depends on the value of the magic parameter λ ginzburg and verhaeghe 2008a as a result this value should be determined so that the effective width is close to the ideal imaging width to generalize the results two images with high and low resolutions that are generated from the x ray computed tomography method have been used the first one is obtained from imperial college london micro ct images and networks 2020 and was analyzed in muljadi s study muljadi et al 2016 by the nse method and which is associated with a bead pack sample secondly a relatively low resolution image was generated to evaluate the effect of the resolution and magic parameter on the performance of the lbm method details of these two images are given in fig 14 and table 1 the results permeability of the two methods with experimental ones have also been compared in fig 17 based on all the above definitions and concepts the steps taken in this study are as follows provide an analytical process to investigate and determine the amplitude of imaging error in direct channels and determine the optimal number of results ideal boundary in this error amplitude obtaining the ideal magic parameter in the lattice boltzmann method by minimizing the difference between the numerical simulation and ideal boundary analytical results in the micro ct image in channels with different angles comparison of numerical simulation results of lbm with nse fdm results considering the effect of magic parameter and imaging error on simulation results comparison of the error amplitude due to the change in the magic parameter in the lattice boltzmann method with the error amplitude of the micro ct images meaning with which values of magic parameter the calculated effective width of the channel is within the allowable imaging boundary range provide a process in the lattice boltzmann method by changing the magic parameter in a specific range and determining the effect of the micro ct image resolution on the quality and amplitude of changes in the pore scale simulation results 2 1 lattice boltzmann equations in the present study the multiple relaxation time mrt model is used in which the main lbm equation is defined based on the mrt collision operator with the force term as follows krüger et al 2017 1 f x e δ t t δ t f x t m 1 s m f e q x t f x t i 1 2 s m f where f is the density distribution function δt is the time step in the lattice scale in lbm in addition to discretized time and space it is essential to discretize the velocity field e is the discrete velocity which for the d3q19 model is defined as krüger et al 2017 2 e c 0 1 1 0 0 0 0 0 0 0 0 0 1 1 0 0 0 1 0 1 1 0 1 1 1 0 0 1 1 0 0 0 1 1 1 1 0 1 1 1 1 1 1 0 0 1 1 0 0 0 1 1 1 1 0 1 1 in which c is the lattice velocity that is considered to be equal to 1 for this model and 3 f i e q ρ u ρ w i 1 e i u c s 2 e i u 2 2 c s 4 u 2 2 c s 2 f presents the body forces and is defined based on the guo model guo et al 2002 silva and semiao 2012 as follows 4 f i w i e i u c s 2 e i u e i c s 4 f in which cs is the sound speed in lattice units and equals to 1 3 f is the body force and ω i is the weighting factor corresponding to each velocity direction given by w0 1 3 w1 6 1 18 w7 18 1 36 krüger et al 2017 ρ and u are the density and macroscopic velocity in the lattice scale respectively that could achieve in terms of distribution function krüger et al 2017 5 ρ i f i 6 u 1 ρ i e i f i f δ t 2 ρ m is an orthogonal matrix that transfers distribution functions to the moment space d humières 2002 s on the other hand is a diagonal matrix which for d3q19 model could be briefly determined as s ωi diag 0 ω e ωε 0 ω q 0 ω q 0 ω q ωϑ ωπ ωϑ ωπ ωϑ ωϑ ωϑ ω m ω m ω m hofmann et al 2016 ginzburg and verhaeghe 2008a 2 2 the magic parameter the numerical discretization error is controlled by introducing the magic parameter in single relaxation time srt collision models the magic parameter could not be controlled with the viscosity and this matter is only available in multi relaxation time models mrt in the two relaxation time model trt the magic parameter is defined as khirevich and patzek 2018 7 λ λ λ 1 ω δ t 1 2 1 ω δ t 1 2 in which ω is obtained from viscosity by ϑ c s 2 1 ω 1 2 δ t and ω is arbitrary and the magic parameter could be controlled while viscosity is varying for the mrt model instead of two frequencies there are multiple ones or multiple corresponding relaxation times which some of them are correlated to each other so that by combination they could generate various magic parameters which every one of them affects the error of the equation with different levels khirevich et al 2015 in the mrt method frequencies are divided into two symmetric and antisymmetric positive and negative groups now the combination of each of the two groups illustrated in fig 3 will generate a magic parameter that would independently affect the simulation error khirevich et al 2015 8 λ j k λ j λ k j e π ε ϑ k q m λ j k λ ϑ λ q λ e λ q λ ε λ q λ π λ q λ ϑ λ m λ e λ m λ ε λ m λ π λ m the above equations represent the groups in fig 3 in which for d3q19 model there are 8 independent magic parameters in the present equation for the mrt model all the magic parameters are assumed identical so that mrt approximately translates to trt pan et al 2006 thereupon in the above equations all the frequencies related to the symmetric part ω s would be set equal to frequency obtained from viscosity as follows krüger et al 2017 9 ω s 1 ϑ c s 2 δ t 1 2 the subscript s represents the frequencies of the symmetric section to keep the value of the magic parameter constant the following relation is used to calculate the frequencies of the anti symmetrical section 10 ω a s 4 2 ω s 4 λ 1 ω s 2 with the help of eq 10 if the viscosity is specified the magic parameter would be determined the superscript as refers to the anti symmetric section and ω as represents all the anti symmetric frequencies 2 3 error analysis by considering the magic parameter as mentioned the magic parameter affects the accuracy of discretization of the lattice boltzmann equation for example λ 1 12 cancels the third order spatial error leading to optimal results for pure advection problems krüger et al 2017 λ 1 6 cancels the fourth order spatial error providing the most accurate results for the pure diffusion equation krüger et al 2017 λ 3 16 results in the boundary wall location implemented via bounce back for the poiseuille flow exactly in the middle between horizontal walls and fluid nodes ginzburg and verhaeghe 2008a λ 1 8 presents accurate permeability in the horizontal channel and eliminates the numerical integration error of velocity to achieve the average velocity talon et al 2012 λ 1 4 provides more stable simulations ginzburg et al 2010 2 3 1 bounce back error so far it has been mentioned that the correct application of velocity location on the bounce back boundary condition plays a key role as far as choosing the right one in the various forms of the solid boundary can transform the bounce back boundary condition from a first order boundary condition to a second order one fig 4 illustrates an overall view of how the magic parameter could affect the accuracy of the bounce back boundary condition in comparison to second order boundary conditions in nse also due to the frequent repetition of the bounce back boundary condition in the physics of flow simulation in the porous media in pore scale reduction of the bounce back error by adjusting the value of λ is much more important than other errors owing to the multiplicity of solid boundaries moreover to conquer this problem it is possible to implement more advanced models of boundary conditions such as libb 1 1 linear interpolation bounce back bouzidi et al 2001 qibb 2 2 quadratic extension lallemand and luo 2003 iebb 3 3 interpolation extrapolation bounce back mei et al 2000 mr 4 4 multi reflection ginzburg and verhaeghe 2008b and cli 5 5 central linear interpolation fattahi et al 2016 ginzburg and verhaeghe 2008b schemes by using these models the boundary of the voxels can be precisely modeled but this does not necessarily produce results closer to reality because the actual boundaries of the sample do not exactly match the boundaries of the voxels and the images produced are always with a slight error this is evident by producing a photograph of the same sample with smaller voxels saxena 2018 see figs 2 and 4 considering the boltzmann equations and with the help of chapman enskog expansion the discretization type of the bounce back boundary condition could be determined in general the discretized equations are dependent on not only velocity but also pressure krüger et al 2017 however ginzburg and verhaeghe 2008a simplified the discretization by considering the poiseuille flow model in a straight horizontal channel as x p f x λ ν 3 y 2 j x y in which jx is the momentum in the channel direction as a result of this simplification relation for discretization of velocity in bounce back boundary is obtained as 11 j x 1 2 y j x c i y 2 3 λ y 2 j x c i y 2 ω i c i y 0 in the bounce back boundary condition it is expected that the location in which the velocity boundary condition is applied would be in the middle of two nods thus assuming dx 1 bounce back would recover second order discretization of stocks equations meaning j x d x 2 y j x 1 2 d x 2 2 y 2 j x 0 only if the second coefficient of momentum derivative 2 3 λ equals to 1 2 d x 2 2 therefore λ is obtained as ginzburg and verhaeghe 2008a 12 λ j k λ j λ k 3 16 when λ 3 16 the location of zero velocity in the horizontal channel would exactly match the middle of the nods which is called the zero velocity mid way bounce back boundary condition however the selection of the other values for the magic parameters would cause a slip in the velocity in a way that if λ 3 16 channel width is less and if λ 3 16 it becomes more than the ideal width ginzburg and verhaeghe 2008a modeled this slip by considering an effective width heff and substituting eq 13 into 11 in boundary nods h 2 1 2 so he achieved the effective width in terms of the magic parameter as shown in eq 19 13 j x y f x x p 2 ν y 2 h e f f 2 14 h e f f 2 h i d e a l 2 16 3 λ 1 by substituting λ 3 16 in eq 14 hideal would equal to heff and assuming channel width has at least two nods then h e f f h 2 0 134 which represents the difference between the effective and ideal boundary δ at one side of the horizontal channel thus the value of the effective width would never be less than hmin in fig 2 ginsburg also expanded the above equations for poiseuille flow in a channel with the desired angle θ considering a new coordinate system x y which makes an angle θ with the horizon the poiseuille relation is written as x p f x λ ν 3 y 2 j x y using chapman enskog expansion the discrete form of no slip bounce back boundary condition is derived ginzburg and verhaeghe 2008a 15 j i 1 2 i j i 3 θ i 2 1 3 θ i 2 λ i 2 j i ω i 0 in the above equation the subscript i represents the direction of each of the cut links and θ c i 1 y represents the velocity direction perpendicular to the channel flow direction same as eq 11 if one would want this relation to recover the no slip bc between two nods with the order of magnitude of two the following relation must be established for the magic parameter ginzburg and verhaeghe 2008a 16 λ j k λ j λ k 3 θ q 2 8 3 θ q 2 1 based on the above equation at any given angle in a particular magic parameter the error value is zero and it is impossible to access them simultaneously furthermore this relationship is valid only for an angle between 0 and 45 but for angles that are more than 45 relations are repeated because an acute angle with grid lines is considered according to this a limit is determined for the magic parameter so that at the angle θ 0 λ 3 16 and at the angle θ π 4 θ 2 1 2 which the magic parameter corresponding to this angle is λ 3 8 the other values are between these two and are in the range 3 16 3 8 therefore to simulate by lbm using the bounce back boundary condition values between this range are suggested however the extent of their effect on the results is not the same which will be investigated in the following context according to ginsburg for channels with different angles eq 14 could be expanded for h eff ginzburg and verhaeghe 2008a 17 h i e f f 2 h i 2 λ λ θ 1 for 45 considering λ 1 2 3 8 and the fact that the cut links are in the vertical direction y h i 2 h 2 2 thus eq 17 would be simplified for 45 channel as 18 h e f f 2 h i d e a l 2 4 3 λ 1 2 comparing these relations with those of horizontal channels it is clear that in each case a specific magic parameter leads to the exact ideal answer however the main point is that as the channel wall goes to 45 the coefficient of the magic parameter and the range of error due to changes in the magic parameter are reduced over a certain range this means that the effect of the magic parameter is not equal and with increasing the angle it decreases so an ideal magic parameter for the combination of the angles could be obtained by integration and interpolation for this purpose consider the vertical cut link in the y direction i e cv in fig 6 the ideal channel width in the direction of this cut link based on the real channel width is h v h c o s θ and the effective width value in this direction also is h e f f v h e f f c o s θ by substituting these two relations in eq 17 19 h e f f 2 h 2 e r λ θ e r λ θ c o s 2 θ 8 3 3 c o s 2 θ 1 λ er λ θ is the error generated in a channel with the desired angle with the mid width fig 5 illustrates the er function value at corresponding angles for λ 1 8 the error is the same for all the angles and equals to 1 3 in the following context the magic parameter that leads to the closest answer to all values is achieved by integration of the error relation over the range 0 pi 4 and by setting it to zero according to eq 20 the optimal magic parameter is obtained as 20 0 π 4 e r λ θ d θ 0 λ 1 8 π 2 1 π 6 1 0 21089 although this value does not lead to optimal estimation for all geometries but in general this value simulates the velocity field in most geometries with the least error among all in average 2 3 2 integration error to calculate mean velocity in permeability using the darcy model permeability tensor components are defined as muljadi et al 2016 21 k i j μ δ p j u i i j 1 2 3 where δpj and u i are pressure gradient in j direction and mean volumetric velocity in i direction respectively u i is defined as muljadi et al 2016 22 u i 1 v t ω u i d ω in which vt is the total volume of the sample including solid matrix and pores dω is a volumetric element in the pore domain to calculate this integration the trapezoidal discrete form is usually used 23 u x k n k j n j i n i u x i j k n i n j n k due to the form of discretization eq 23 especially on the boundaries a significant error is produced in calculating the mean velocity talon et al 2012 demonstrated that the magic parameter could partially control this error to further reduce this error we use higher order interpolations to discrete the integral of eq 22 by using the eq 14 a relation for the effective permeability is derived as talon et al 2012 24 k e f f k i d e a l 2 3 λ 1 12 in the above equation kideal is the exact value of permeability corresponding to the ideal boundary in fig 2 for λ 1 8 the effective permeability keff equals to exact one kideal that is different from the magic parameter which leads to accurate flow simulation hideal in present study relationship for the 45 degree channel is also developed details of the analytical calculations are presented in appendix 2 as 25 k e f f k e x 1 6 λ 1 24 according to the above equation for the 45 degree channel for λ 1 4 keff equals to kex in eqs 24 and 25 substituting a magic parameter that leads to a channel width equal to h and simulates the velocity field precisely would result in an effective permeability that is always less than the exact one this case is caused by the velocity integration error 2 4 effect of voxel size previous equations are in lattice scale therefore by assuming dxl 1 then h r h l d x r which dxr is exactly equal to the voxel size h l and h r are width of the channel in the lattice scale and real scale respectively substituting these into horizontal channel relation i e eq 14 we obtain 26 h e f f 2 h 2 16 3 λ 1 d x r 2 in general err λ θ in eq 19 becomes 27 e r λ θ c o s 2 θ 8 3 3 c o s 2 θ 1 λ d x r 2 the basic idea of this relation is that by varying the resolution one could keep the total error constant with the help of adjusting the magic parameter in the following a concept called relative error range due to the magic parameter will be defined the ratio δ in fig 6 to the size of the voxels dxr is considered as the relative error and the rate of the range of this error to the magic parameter is considered to be the relative error range in the simulation the relative error is defined because it could significantly help in choosing a reliable value magic parameter and appropriate resolution for imaging so based on eq 26 for the horizontal channel 28 r δ λ d x r h d x r 2 16 3 λ 1 h d x r in micro ct images considering section 2 1 and fig 2 the range of this error r for the horizontal channel is always between 1 2 1 2 this is because in the micro ct image from the horizontal channel see fig 2b δ is in the range of dx 2 dx 2 so r is calculated as δ d x range of the error for reconstruction of images could be less more than the ideal width defined in fig 2 as much as half of the voxel size value 1 2 r mi ct 1 2 in eq 28 h d x r ratio represents ni or number of voxels in channel width by defining ni one could obtain relative error r for the magic parameter change fig 7 illustrates above discussion considering various ni values as shown in fig 7 for the magic parameter and reasonable ni values the error value due to the change in the magic parameter is always within the error range due to imaging this means that d λ d c t which d represents the range of the change due to magic parameter and imaging errors considering the case of the horizontal channel and ni 3 for a magic parameter of about 1 5 the relative error is 0 5 and equals to relative imaging error while for ni 6 this value is 2 6 and with the increase of ni to 10 and to the magic parameter 4 1 the error caused by the changes in the magic parameter is less than the error due to imaging fig 7 shows that despite that error is relative to the size of the voxels its value decreases with the increasing number of nodes furthermore another important point that is clear in fig 7 is that for ideal magic parameters for the horizontal channel at different ni values the relative error r always becomes zero therewith for 45 channel based on eq 18 imaging error is obtained in the same way as a horizontal channel as follows 29 r δ λ d x r h d x r 2 4 3 λ 1 2 h d x r however in this case the range of the relative error for the micro ct image is different from the horizontal channel according to fig 2 and is equal to the interval 1 2 2 1 2 2 the horizontal channel interval is smaller however in ni values are similar to the horizontal channel the changes caused by the magic parameter grow larger posterior to the imaging error fig 7b also supports this statement which is again due to the greater slope of the error in the horizontal channel which makes the boundaries in the same direction with the coordinate system horizontal or vertical more critical general for all channel angles according to eq 19 below relation is obtained 30 r δ λ d x r h d x r 2 e r λ θ h d x r in which er λ θ is calculated from the eq 19 however the crucial point is that the upper and lower limits of this error occur for the horizontal channel and 45 another interesting point that can be deduced from the above equations is that based on the rate of change in the results compared to the changes in the magic parameter it can be estimated to some extent what error the reconstructed image has reconstructed this means d λ d c t in which da and dct are the magic parameter and the imaging error range respectively with the help of the average diameter and size of the voxels it is possible to estimate how many nodes are in each pore i e the average ni of the sample finally with the help of fig 8 and the mean ni value it is possible to estimate that to what extent of the magic parameter the ideal boundary would shift by 25 50 and 100 of the upper limit of the relative imaging error in the horizontal and 45 channel that determines the ratio of the maximum relative error due to the selection of the specified magic parameter r λ to the ratio of the maximum imaging error r c t m a x h m a x h i d e a l 2 d x in the fig 2 in this situation α is exactly the ratio of the difference of the maximum imaging boundary and ideal one to the difference of gained boundary by magic parameter and ideal boundary this ratio is denoted by α r λ r c t m a x however in general α x λ x i d e a l x m a x c t x i d e a l in which x could be any parameter including effective width or permeability then considering the values of the magic parameter that causes a 25 error in the horizontal channel and 45 one can be sure that for these values the changes in the results are smaller than the changes caused by the imaging error according to fig 8 when α 1 horizontal channel is more critical and by selecting the value of 1 for the maximum magic parameter in simulation one could make sure that for a channel with at least ni 2 the error range due to the magic parameter is a subset of the imaging error range therefore 1 λ max 2 is recommended for the maximum applicable magic parameter to ensure the accuracy and stability of the solution and λ min 0 01 for the minimum magic parameter in these ranges one could always be confident that the error due to magic parameter selection is less than the imaging error this means that by increasing the magic parameter to 25 or 50 percent error the permeability obtained from it will always be in the range of the effective width derived from the imaging error and by increasing the imaging resolution the results may reach this value as a result using the values obtained with these magic parameters the least percentage of the error created by imaging can be determined and by simulating based on 100 relative error the maximum error can be estimated however in most of the simulations of processes in pore scale with complex pore geometries the effective channel width parameter could not be defined and only permeability is specified because of the integration error its results vary slightly from the ones of effective width therefore according to the obtained results and due to the relationship between the second power of permeability with length the magic parameter is more limited compared to channel width from the permeability perspective just like the effective width the horizontal channel is more critical and for α 1 when the value of the magic parameter is at maximum i e 1 only up to ni 3 the amount of error due to the magic parameter is within the imaging error range which this was less than 2 with the effective width approach this indicates that when calculating the permeability by increasing the magic parameter the maximum error increases significantly faster than the maximum imaging error therefore to ensure that the amplitude of the error due to the magic parameter is smaller than the amplitude of the imaging error an interval of 0 01 λ 1 0 is recommended for the magic parameter and if the value of ni is large the maximum value of the magic parameter can be increased up to 2 details of all these choices can be extracted from fig 8b 3 results and discussion in this section we compare the results achieved from the lbm and nse methods and investigate the effect of the magic parameter and image voxel size on the predicting capability of the lbm method first the capability of the model to simulate the processes in two simple models of horizontal and diagonal channels is discussed then simulations are extended to study the processes in the bead pack and packed sphere samples which their geometry is modeled using x ray computed tomography scans of the physical samples 3 1 comparison of flow in horizontal and sloped channels geometries presented in fig 9 are used to model the flow in the single channels the width of the horizontal and diagonal channels is 1 mm and 1 2 mm respectively poiseuille flow is modeled in the area marked in fig 9 in this example to investigate the effect of the bounce back on the effective width and permeability we have simulated the flow within a length of the channel bounded by two cross sections as the inlet and outlet where a constant pressure is generated over each as seen in fig 10 the red and the blue blocks are considered as the inlet and outlet where the average value of the inlet and outlet pressure density is calculated thereupon the average velocity in the simulation area is calculated and used to calculate the permeability according to the plots presented in figs 10 and 11 it is clear that for the horizontal channel with λ 3 16 and 45 degrees channel with λ 3 8 the values of heff and hideal would be the same the effective channel width deviates from hideal as the magnitude of the magic parameter diverges from the proposed optimal numbers this deviation is also a function of the resolution of the image it is noticeable that according to figs 12 and 13 the difference between hideal and the computed width is always less than dx this means the relative error range due to imaging is often greater than the error range due to deviation of the magic parameter from the optimal value section 2 4 in the nse method the use of the second order boundary condition makes it possible to model the boundaries of the images more realistically for the horizontal channel the imaging boundaries are superimposed on the ideal ones so the effective width of the channel estimated by nse perfectly fits the ideal one in fig 10 the nse results are completely consistent with hideal but in the 45 degree channel the image boundaries do not fit to the ideal boundary this is evident in the fig 11 that unlike the horizontal channel the nse results are far from the ideal boundary and close to hmin for the 45 degreee channel so in this channel the predictions achieved from the nse method are less than those obtained by the lbm method for the case that λ 0 in general since the boundary condition in the nse is of second order wherever the boundaries of imaging fit the ideal boundary this method produces the best results however for the inclined boundary such as the sloped channel where the imaging and the ideal boundary are different the nse method underestimates the magnitude of the effective permeability our results show that by selecting a suitable magic parameter in this example the suitable value is 0 21 the lbm can predict the effective parameters closer to the ideal case even for the inclined channels by selecting the appropriate values for the magical parameter the error is positive in horizontal channels and negative in sloped channels which can neutralize their effect together and produce a response closer to the ideal boundary result yet in the nse method the prediction error associated with the horizontal channel is nearly zero and negative for sloped channels this causes the predictions of the nse method to be always lower than the predictions to be achieved by using either the ideal boundary for the width of the channels or the lbm when the recommended magic parameter is used it also should be considered that the difference in the predicted effective permeability with the ideal one as seen in the figs 11b and 12b is due to the integral error for calculating the average velocity by eqs 22 23 that has been discussed in the section 2 3 2 to eliminate this error in the pore scale simulation we used higher order integration methods in the cost of increasing the complexity of the calculations process 3 2 micro ct model in this section we compare prediction errors associated with the boundary approximation approaches used for modeling the pore structure of the samples from micro ct scans the micro ct scans of two samples namely bead pack high resolution and packed sphere low resolution samples are used as mentioned in sec 2 which its detail is presented in table 1 fig 14 illustrates the micro ct scans of these two models pore flow through the samples was simulated and the pore stream pattern and pressure field are presented in fig 15 3 2 1 bead pack sample a low pressure gradient equal to 1 5 pa m 2 is applied to the samples to ensure that the flow stays in the darcy regime and the pore flow is simulated the permeability value for the bead pack sample predicted by the nse method is equal to 5 65 d in the lbm method the results are examined based on the change of the magic parameter that is chosen to be between 0 01 2 considering this range the permeability changes as shown in fig 16 and also detailed in table 2 and falls in the range of 5 367 d 7 082 d considering the magic parameter within 1 8 3 8 the change interval of the permeability value is reduced to 5 794 d 6 101 d moreover the permeability when the magic parameter λ 0 21 is equal to 5 923d this magic parameter creates the least error in the results in both geometries with the highest probability the predictions with nse are 4 3 less than those achieved by lbm when the ideal value of the magic parameter is used this difference increases as the resolution of the images decrease furthermore in other samples like zakirov s zakirov and galeev 2019 study with λ 3 16 this difference is nearly 35 3 2 2 pack sphere sample this sample is relatively large for pore scale simulation the length of which is 50 mm and is scanned with a resolution of 65 99 μm as illustrated in fig 14 in comparison to the bead pack sample it has been reconstructed with lower resolution and has a lower ni value equal to 5 9 this has been done deliberately to examine the effect of the resolution on simulation results flow through his sample has been experimentally measured by el zehairy et al 2019 and the calculated permeability of the sample is equal to 2279 81 d in the darcy regime as the ratio of pore size grading diameter to voxel size ni dp dx decreases it is expected that the change of the magic parameter has more impact on permeability predictions which is proved by the results presented in fig 17 at λ 0 01 the permeability value was 1645 6d at λ 2 0 it reaches 2588 0 d and at λ 0 21 the permeability value is 1952 0d the maximum deviation of the value from the one achieved by the ideal one is equal to 43 if the magic parameter in the range of 0 01 2 is chosen and it reaches 9 3 if the magic parameter falls in the range of 1 8 3 8 permeability calculated with the ideal magic parameter equal to 0 21 is 14 38 less than the one calculated experimentally it could be caused by imaging or experiment procedure errors however it is highly attractive that experimental permeability is within the permeability range corresponding to 0 01 λ 2 0 interval for the magic parameter in addition to these cases due to the passage of the flow through the sample in the experimental real conditions and the generated momentum a slight change in the structure of the porous medium happened and some very small obstacles from the porous media were eroded therefore the permeability in the experimental results increases slightly which is omitted from the examination due to the difficulty of estimating the impact of this issue as mentioned the permeability value of the packed sphere sample is 1952 d according to the initial estimates the permeability of this sample was expected to be slightly lower based on the flow pattern in this sample channels have been created near the cylinder for the flow to pass and their speed is higher than other points these channels can significantly affect the simulation results if we separate a smaller cube from the center of the sample in such a way that there are no more cylinder boundaries in it the permeability value decreases to 1614 3 which is a significant change this issue is effective both numerically and experimentally to obtain better experimental results in future works more attention should be paid to the formation of these channels which is revealed in the numerical solution and obtained by simulating the velocity field permeability obtained from the nse method is 1795 0d which is in the range of the permeability predicted by lbm using the value of the magic parameter chosen from the range of 0 01 3 16 this value predicted for the permeability is 21 23 less than the experimentally measured permeability the results of both lbm and nse methods are different from the laboratory results but the permeability obtained by the nse method using the low resolution image is less than the lbm results when the magic parameter is set to 0 21 the lbm results are closer to the experimentally measured one this is because of interpolation in the solid boundaries by the deliberate setting of the magic parameter which reduces the prediction error another point in the lbm is that the laboratory results are in the range of the values predicted for the permeability using the values of the magic parameter that vary from 0 01 to 2 0 therefore in the lbm method by changing the magic parameter one can provide a logical range for the permeability value and accordingly can quantify the range of error due to all the computational approximations for calculating the sample properties 3 3 enlarging the mesh in this section the image resolutions are reduced in order to determine the extent of the changes in the predictions associated with the nse and lbm methods obtained with various magic parameters the dimensions of the voxels are doubled in each step of the enlargement and the geometry is divided into a set of 2 2 2 cubes each of which contains 8 voxels if the number of solid voxels in the cube is more than half the total number of voxels it is considered as the solid zone otherwise it is part of the pore zone zakirov and galeev 2019 the resolution is increased up to a level where the porosity of the original sample is preserved in this regard the bead pack sample has been enlarged up to four times the details of which can be seen in three slices in fig 18 fig 19 illustrate that the lbm results for images of different resolution converge to 5 9d as the magic parameter moves toward the ideal value of 0 21 this is a feature of the ideal magic parameter this means using the ideal value for the magic parameter makes it possible to minimize the dependency of the numerical predictions on the image resolution this shows that in geometries where the distribution of the angles of the solid boundaries is uniform in all directions such as the samples made of spherical particles the best value for the ideal magic parameter is 0 21 the results show that the use of appropriate values for the magic parameter makes it possible to achieve reliable predictions with lower resolution images saving computational time it is seen in fig 19 that the nse results for the bead pack sample are always between the lbm results when the magic parameter falls in the range of 0 01 3 16 and nse results decrease with the decrease of the image resolution however in lbm the dependency of the results on the resolution is a function of the magic parameter so for three times enlargement of the voxels the results become independent of the resolution for the magic parameter 0 21 as the voxel size increases the prediction error increases as the magic parameter deviates from the optimum value as discussed in section 2 4 by adjusting the magic parameter it is possible to define the pore channel based on the bounce back boundary condition concept between the narrowest λ 0 01 and widest λ 2 0 pore channels that are technically possible to be defined by images this allows reducing the error that is generated to approximate the solid boundaries using the images although the predictions are functions of the image results in general choosing an inappropriate value for the magic parameters can cause significant errors in the prediction the permeability value in the 0 01 1 0 interval is calculated and presented in table 3 the permeability predicted when λ 0 21 is 20 1 different from the one calculated using the high resolution image for the second third and fourth order of magnification the errors reach 49 6 89 3 and 107 2 respectively in most of the previous studies e g talon et al 2012 ginzburg and verhaeghe 2008a rao and schaefer 2019 it was suggested that the value of the magic parameter should be within the range 1 8 3 8 the proposed range for the magic parameter is dependent on the resolution of the images as our results show that for the second third and fourth order of increase in the voxel size using a magic parameter in the range of 1 8 3 8 leads to 13 3 21 9 and 29 0 error in the prediction of the permeability respectively while using the original images with fine voxel size and the magic parameter in the range 1 8 3 8 predicted permeability will be only 5 2 different from the one predicted using the ideal magic parameter these values indicate the effect of the magic parameter on the reliability of the numerical method for permeability prediction using images with low resolution if one wants to follow the proposed range by talon et al 2012 for magic parameter image resolution for this sample should be reduced up to three times 4 conclusion in the present study the effect of the magic parameter in the lattice boltzmann method lbm was specifically investigated on micro ct images based on voxels to investigate the effects of the magic parameter simpler forms were first investigated by analytical methods and the results were generalized to numerical simulations and more complex geometries therewith considering the inherent error within imaging and the error caused by the magic parameter in the lbm the answers of this method with the navier stokes equations nse method are completely analyzed from the perspective of the type of boundary simulation and the reason for this difference has been identified deduction 1 by defining the minimum and maximum error boundaries based on the voxels obtained from the micro ct images to reconstruct a straight horizontal channel and 45 according to fig 8 the amplitude of the error due to imaging was determined based on the interpolation in this domain the concept of the ideal boundary is determined that this boundary creates the least difference with the results obtained from other members of the micro ct error domain both in terms of effective channel width and in terms of permeability accordingly in the simulation on micro ct images due to the inherent error of geometry the best criterion for increasing the quality of responses is approaching the results equivalent to the ideal boundary deduction 2 the amount of permeability and effective width of channels with different slopes in different magic parameters are equivalent to the results corresponding to the ideal width of the channels these values for horizontal channels and 45 are fully extracted in this study and previous studies however the point is that by distancing from the value of the ideal magic parameter equivalent to channels with different slopes λ 3 16 for the horizontal channel and λ 3 8 for the 45 degree channel the amount of error does not increase uniformly in fact in horizontal channels the error slope due to the magic parameter is much higher than the error slope due to the magic parameter in sloping channels or 45 based on this idea and by averaging between all angles it can be concluded that λ 0 21 in total creates the least error among all modes this means that in complex shapes with different borders and angles this value simulates the correct answer to the problem this value is in the range 3 16 3 8 but closer to 3 16 ideal magic parameter corresponding to the horizontal channel this is since the slope of the line is higher at the horizontal borders deduction 3 by comparing the error amplitude due to the change in the magic parameter with the amplitude of the imaging error it can be obtained that depending on the number of nodes in the width of the pores the amplitude of the magic parameter error is always a subset of the imaging error amplitude for example in the range 0 01 λ 1 0 always and in the range 0 01 λ 2 0 in geometries where the number of voxels per unit length of the cavity is relatively high the amplitude of the magic parameter is a subset of the amplitude of the imaging error d λ dct but for the permeability value due to its special conditions a more stringent range of 0 01 λ 1 0 is recommended for estimating the imaging error range accordingly by changing the magic parameter in these intervals an estimate of the effect of the output image resolution on the results can be obtained in fact it can be estimated that the geometries that were photographed to produce the same micro ct image differ by about a few percent and instead of a certain value provide an interval for permeability which is due to imaging error deduction 4 by simultaneously comparing the permeability and effective width of the lbm with the nse method the nse method models the boundaries of the generated image more properly while based on the ideal boundary definition for micro ct images exact simulation of the boundaries does not necessarily lead to effective results in the horizontal channel the nse results correspond to the ideal imaging boundary but in the 45 degree channel the nse results approach the minimum hmin image boundary fig 2 which reduces the quality of responses on sloping boundaries by the nse method accordingly in composite geometries the permeability of the nse method is always less than the permeability obtained from the lbm method at λ 0 21 and its value is placed somewhere in the permeability interval obtained by the lbm in the range of 0 01 λ 3 16 for the magic parameter finally the comparison of the results obtained from lbm at λ 0 21 and nse with the experimental results show less deviation for the lbm than nse credit authorship contribution statement milad hosseini methodology software validation visualization writing original draft conceptualization majid siavashi conceptualization investigation resources formal analysis data curation writing review editing supervision project administration milad shirbani writing original draft mohaddeseh mousavi nezhad supervision formal analysis writing review editing methodology declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper appendix 1 in fig 2 the effective width error range is dheff hmin hmax and this range for the permeability value is d k e f f h m i n 2 12 h m a x 2 12 the effective width value that causes the least error with other members of the domain is equal to h m i n h m a x 2 which represents the ideal width hideal in fig 2 but due to the non linear permeability relationship finding the permeability that causes the least error with other members of the dkeff domain requires a bit of computation according to fig 20 the amount of total error that the desired boundary hc between hmin and hmax creates is equal to the sum of the areas of the red and blue parts which is considered as st s 1 s 2 in fact hc which minimizes the area of st also gives the best estimate for the permeability value 1 a s t h m i n h c k c k h d h h c h m a x k h k c d h 2 a s t 1 9 h c 3 h c 2 12 h m i n h m a x h m i n 3 h m a x 3 36 3 a d s t d h c 1 3 h c 2 1 6 h c h m i n h m a x by putting d s t d h c 0 the minimum value for st would obtain 4 a h c h m i n h m a x 2 as a result in the case of the non linear form of permeability despite the difference in the amplitude of the permeability error with the effective width the ideal boundary value to obtain the optimal permeability is exactly between the two minimum and maximum widths of the micro ct image as a result the ideal boundaries are perfectly matched in terms of effective channel width and permeability to achieve the minimum error appendix 2 extraction of effective permeability relation for 45 channel talon et al 2012 in their effort for the horizontal channel showed that the exact permeability value is obtained in the magic parameter of 1 8 which is completely different from the magic parameter that correctly estimates the effective channel width λ 3 16 how to integrate velocity to calculate the average velocity in the permeability relation is the main reason for this difference in this section the relationships related to the 45 degree channel are extracted based on eq 21 for permeability 1 b k μ u p x in horizontal channel according to poison relation 2 b u 1 2 μ p x h e f f 2 y 2 d t in which heff is half of the whole channel effective width meaning h e f f h e f f 2 and t is in fact area or volume of the whole domain that the velocity is integrated on substituting eq 2 b in 2 1 3 b k e f f 1 2 1 2 μ p x h e f f 2 y 2 d t this relationship presented is comprehensive and general and could be simplified for different situations therefore for a 45 channel and when the number of nodes in the vertical direction of the channel is odd the value t according to fig 21 b is equal to 2n 1 due to the same condition of the nodes along the integration channel only the nodes in the yellow section in fig 21 are integrated in this area due to the same conditions of red and blue nodes on both sides of the channel symmetry line integration can be done only in red points as a result the above eq 3 b is discretized as follows 4 b k e f f 1 2 2 n 1 h e f f 2 2 i 1 n y i 2 2 n 1 in which y i i 2 and heff based on eq 18 could be calculated so 5 b k e f f 1 8 h i d e a l 2 4 3 λ 1 2 n n 1 12 in the above relation h i d e a l 2 n 1 2 which by substituting and simplifying 6 b k e f f k i d e a l 1 6 λ 1 24 in above k i d e a l h i d e a l 2 12 and when the value of keff becomes equal to kideal only if the residual of the above relation is zero in this case the value of the magic parameter is equal to λ 1 4 which is exactly equal to the magic parameter which leads to better stability in different collision models generated and is equivalent to τ 1 in the bgk method calculations become slightly easier when the number of nodes across the channel width is even as in fig 21a in this case relation 4 b would reform as 7 b k e f f 1 2 2 n h e f f 2 2 i 1 n y i 2 2 n in this situation y i i 1 2 which same as the previous one by substituting heff and simplifying the relation 8 b k e f f k i d e a l 1 6 λ 1 24 which is the same equation as for an odd number of nodes alpak et al 2016 f o alpak b riviere f frank a phase field method for the direct simulation of two phase flows in pore scale media using a non equilibrium wetting boundary condition comput geosci 20 5 2016 881 908 10 1007 s10596 015 9551 2 oct f o alpak b riviere and f frank a phase field method for the direct simulation of two phase flows in pore scale media using a non equilibrium wetting boundary condition comput geosci vol 20 no 5 pp 881 908 oct 2016 doi 10 1007 s10596 015 9551 2 alpak et al 2018 f o alpak f gray n saxena j dietderich r hofmann s berg a distributed parallel multiple relaxation time lattice boltzmann method on general purpose graphics processing units for the rapid and scalable computation of absolute permeability from high resolution 3d micro ct images comput geosci 22 3 2018 815 832 10 1007 s10596 018 9727 7 jun f o alpak f gray n saxena j dietderich r hofmann and s berg a distributed parallel multiple relaxation time lattice boltzmann method on general purpose graphics processing units for the rapid and scalable computation of absolute permeability from high resolution 3d micro ct images comput geosci vol 22 no 3 pp 815 832 jun 2018 doi 10 1007 s10596 018 9727 7 astanina et al 2018 m s astanina m a sheremet h f oztop n abu hamdeh mhd natural convection and entropy generation of ferrofluid in an open trapezoidal cavity partially filled with a porous medium international journal of mechanical sciences 136 2018 493 502 10 1016 j ijmecsci 2018 01 001 feb m s astanina m a sheremet h f oztop and n abu hamdeh mhd natural convection and entropy generation of ferrofluid in an open trapezoidal cavity partially filled with a porous medium international journal of mechanical sciences vol 136 pp 493 502 feb 2018 doi 10 1016 j ijmecsci 2018 01 001 bandara et al 2013 u c bandara a m tartakovsky m oostrom b j palmer j grate c zhang smoothed particle hydrodynamics pore scale simulations of unstable immiscible flow in porous media adv water resour 62 2013 356 369 10 1016 j advwatres 2013 09 014 dec u c bandara a m tartakovsky m oostrom b j palmer j grate and c zhang smoothed particle hydrodynamics pore scale simulations of unstable immiscible flow in porous media adv water resour vol 62 pp 356 369 dec 2013 doi 10 1016 j advwatres 2013 09 014 bourbiaux and kalaydjian 1990 b j bourbiaux f j kalaydjian experimental study of cocurrent and countercurrent flows in natural porous media spe reservoir engineering 5 03 1990 361 368 10 2118 18283 pa aug b j bourbiaux and f j kalaydjian experimental study of cocurrent and countercurrent flows in natural porous media spe reservoir engineering vol 5 no 03 pp 361 368 aug 1990 doi 10 2118 18283 pa bouzidi et al 2001 m bouzidi m firdaouss p lallemand momentum transfer of a boltzmann lattice fluid with boundaries physics of fluids 13 11 2001 3452 3459 10 1063 1 1399290 oct m bouzidi m firdaouss and p lallemand momentum transfer of a boltzmann lattice fluid with boundaries physics of fluids vol 13 no 11 pp 3452 3459 oct 2001 doi 10 1063 1 1399290 chalmers et al jun 2012 g r chalmers r m bustin i m power characterization of gas shale pore systems by porosimetry pycnometry surface area and field emission scanning electron microscopy transmission electron microscopy image analyses examples from the barnett woodford haynesville marcellus and doig unitscharacterization of gas shale pore systems am assoc pet geol bull 96 6 jun 2012 1099 1119 10 1306 10171111052 g r chalmers r m bustin and i m power characterization of gas shale pore systems by porosimetry pycnometry surface area and field emission scanning electron microscopy transmission electron microscopy image analyses examples from the barnett woodford haynesville marcellus and doig unitscharacterization of gas shale pore systems am assoc pet geol bull vol 96 no 6 pp 1099 1119 jun 2012 doi 10 1306 10171111052 d humières 2002 d d humières multiple relaxation time lattice boltzmann models in three dimensions philosophical transactions of the royal society of london series a mathematical physical and engineering sciences 360 1792 2002 437 451 10 1098 rsta 2001 0955 mar d d humières multiple relaxation time lattice boltzmann models in three dimensions philosophical transactions of the royal society of london series a mathematical physical and engineering sciences vol 360 no 1792 pp 437 451 mar 2002 doi 10 1098 rsta 2001 0955 el zehairy et al 2019 a a el zehairy m m nezhad v joekar niasar i guymer n kourra m a williams pore network modelling of non darcy flow through heterogeneous porous media adv water resour 131 2019 103378 10 1016 j advwatres 2019 103378 sep a a el zehairy m m nezhad v joekar niasar i guymer n kourra and m a williams pore network modelling of non darcy flow through heterogeneous porous media adv water resour vol 131 p 103378 sep 2019 doi 10 1016 j advwatres 2019 103378 fang et al 2019 c fang b pan y wang y rao y guo j li pore scale fluid distributions determined by nuclear magnetic resonance spectra of partially saturated sandstonespore scale fluid distributions geophysics 84 3 2019 mr107 mr114 10 1190 geo2018 0286 1 may c fang b pan y wang y rao y guo and j li pore scale fluid distributions determined by nuclear magnetic resonance spectra of partially saturated sandstonespore scale fluid distributions geophysics vol 84 no 3 pp mr107 mr114 may 2019 doi 10 1190 geo2018 0286 1 farajzadeh et al 2012 r farajzadeh a andrianov r krastev g j hirasaki w r rossen foam oil interaction in porous media implications for foam assisted enhanced oil recovery adv colloid interface sci 183 184 2012 1 13 10 1016 j cis 2012 07 002 nov r farajzadeh a andrianov r krastev g j hirasaki and w r rossen foam oil interaction in porous media implications for foam assisted enhanced oil recovery adv colloid interface sci vol 183 184 pp 1 13 nov 2012 doi 10 1016 j cis 2012 07 002 fattahi et al 2016 e fattahi c waluga b wohlmuth u rüde m manhart r helmig lattice boltzmann methods in porous media simulations from laminar to turbulent flow comput fluids 140 2016 247 259 10 1016 j compfluid 2016 10 007 nov e fattahi c waluga b wohlmuth u rüde m manhart and r helmig lattice boltzmann methods in porous media simulations from laminar to turbulent flow comput fluids vol 140 pp 247 259 nov 2016 doi 10 1016 j compfluid 2016 10 007 fredrich et al 2006 j t fredrich a a digiovanni d r noble predicting macroscopic transport properties using microscopic image data journal of geophysical research solid earth 111 b3 2006 10 1029 2005jb003774 mar j t fredrich a a digiovanni and d r noble predicting macroscopic transport properties using microscopic image data journal of geophysical research solid earth vol 111 no b3 mar 2006 doi 10 1029 2005jb003774 friis et al 2019 h a friis j pedersen e jettestuen j o helland m prodanović pore scale level set simulations of capillary controlled displacement with adaptive mesh refinement transp porous med 128 1 2019 123 151 10 1007 s11242 019 01238 6 may h a friis j pedersen e jettestuen j o helland and m prodanović pore scale level set simulations of capillary controlled displacement with adaptive mesh refinement transp porous med vol 128 no 1 pp 123 151 may 2019 doi 10 1007 s11242 019 01238 6 ginzburg and d humières 2003 i ginzburg d d humières multireflection boundary conditions for lattice boltzmann models phys rev e 68 6 2003 066614 10 1103 physreve 68 066614 dec i ginzburg and d d humières multireflection boundary conditions for lattice boltzmann models phys rev e vol 68 no 6 p 066614 dec 2003 doi 10 1103 physreve 68 066614 ginzburg and verhaeghe 2008a i ginzburg f verhaeghe study of simple hydrodynamic solutions with the two relaxation times lattice boltzmann scheme commun comput phys 2008 64 i ginzburg and f verhaeghe study of simple hydrodynamic solutions with the two relaxation times lattice boltzmann scheme commun comput phys p 64 2008 ginzburg and verhaeghe 2008b i ginzburg f verhaeghe two relaxation time lattice boltzmann scheme about parametrization velocity pressure and mixed boundary conditions commun comput phys 2008 53 i ginzburg and f verhaeghe two relaxation time lattice boltzmann scheme about parametrization velocity pressure and mixed boundary conditions commun comput phys p 53 2008 ginzburg et al 2010 i ginzburg d d humières a kuzmin optimal stability of advection diffusion lattice boltzmann models with two relaxation times for positive negative equilibrium j stat phys 139 6 2010 1090 1143 10 1007 s10955 010 9969 9 jun i ginzburg d d humières and a kuzmin optimal stability of advection diffusion lattice boltzmann models with two relaxation times for positive negative equilibrium j stat phys vol 139 no 6 pp 1090 1143 jun 2010 doi 10 1007 s10955 010 9969 9 guo et al 2002 z guo c zheng b shi discrete lattice effects on the forcing term in the lattice boltzmann method phys rev e 65 4 2002 046308 10 1103 physreve 65 046308 apr z guo c zheng and b shi discrete lattice effects on the forcing term in the lattice boltzmann method phys rev e vol 65 no 4 p 046308 apr 2002 doi 10 1103 physreve 65 046308 hofmann et al 2016 s hofmann a bufe g brenner t turek pressure drop study on packings of differently shaped particles in milli structured channels chem eng sci 155 2016 376 385 10 1016 j ces 2016 08 011 nov s hofmann a bufe g brenner and t turek pressure drop study on packings of differently shaped particles in milli structured channels chem eng sci vol 155 pp 376 385 nov 2016 doi 10 1016 j ces 2016 08 011 huang et al 2010 b huang h wu x shu e g burdette laboratory evaluation of permeability and strength of polymer modified pervious concrete construction and building materials 24 5 2010 818 823 10 1016 j conbuildmat 2009 10 025 may b huang h wu x shu and e g burdette laboratory evaluation of permeability and strength of polymer modified pervious concrete construction and building materials vol 24 no 5 pp 818 823 may 2010 doi 10 1016 j conbuildmat 2009 10 025 jing et al 2016 y jing r t armstrong h l ramandi p mostaghimi coal cleat reconstruction using micro computed tomography imaging fuel 181 2016 286 299 10 1016 j fuel 2016 04 127 oct y jing r t armstrong h l ramandi and p mostaghimi coal cleat reconstruction using micro computed tomography imaging fuel vol 181 pp 286 299 oct 2016 doi 10 1016 j fuel 2016 04 127 khirevich and patzek 2018 s khirevich t w patzek behavior of numerical error in pore scale lattice boltzmann simulations with simple bounce back rule analysis and highly accurate extrapolation physics of fluids 30 9 2018 093604 10 1063 1 5042229 sep s khirevich and t w patzek behavior of numerical error in pore scale lattice boltzmann simulations with simple bounce back rule analysis and highly accurate extrapolation physics of fluids vol 30 no 9 p 093604 sep 2018 doi 10 1063 1 5042229 khirevich et al 2015 s khirevich i ginzburg u tallarek coarse and fine grid numerical behavior of mrt trt lattice boltzmann schemes in regular and random sphere packings j comput phys 281 2015 708 742 10 1016 j jcp 2014 10 038 jan s khirevich i ginzburg and u tallarek coarse and fine grid numerical behavior of mrt trt lattice boltzmann schemes in regular and random sphere packings j comput phys vol 281 pp 708 742 jan 2015 doi 10 1016 j jcp 2014 10 038 krüger et al 2017 t krüger h kusumaatmaja a kuzmin o shardt g silva e m viggen the lattice boltzmann method principles and practice 2017 springer international publishing accessed jun 09 2018 online available https www springer com gb book 9783319446479 t krüger h kusumaatmaja a kuzmin o shardt g silva and e m viggen the lattice boltzmann method principles and practice springer international publishing 2017 accessed jun 09 2018 online available https www springer com gb book 9783319446479 krohn and thompson 1986 c e krohn a h thompson fractal sandstone pores automated measurements using scanning electron microscope images phys rev b 33 9 1986 6366 6374 10 1103 physrevb 33 6366 may c e krohn and a h thompson fractal sandstone pores automated measurements using scanning electron microscope images phys rev b vol 33 no 9 pp 6366 6374 may 1986 doi 10 1103 physrevb 33 6366 lai et al 2016 j lai insight into the pore structure of tight sandstones using nmr and hpmi measurements energy fuels 30 12 2016 10200 10214 10 1021 acs energyfuels 6b01982 dec j lai et al insight into the pore structure of tight sandstones using nmr and hpmi measurements energy fuels vol 30 no 12 pp 10200 10214 dec 2016 doi 10 1021 acs energyfuels 6b01982 lallemand and luo 2003 p lallemand l s luo lattice boltzmann method for moving boundaries j comput phys 184 2 2003 406 421 10 1016 s0021 9991 02 00022 0 jan p lallemand and l s luo lattice boltzmann method for moving boundaries j comput phys vol 184 no 2 pp 406 421 jan 2003 doi 10 1016 s0021 9991 02 00022 0 lee 2018 d y lee lattice boltzmann simulations for wall flow dynamics in porous ceramic diesel particulate filters appl surf sci 2018 9 d y lee lattice boltzmann simulations for wall flow dynamics in porous ceramic diesel particulate filters appl surf sci p 9 2018 macini et al 2011 p macini e mesini r viola laboratory measurements of non darcy flow coefficients in natural and artificial unconsolidated porous media journal of petroleum science and engineering 77 3 2011 365 374 10 1016 j petrol 2011 04 016 jun p macini e mesini and r viola laboratory measurements of non darcy flow coefficients in natural and artificial unconsolidated porous media journal of petroleum science and engineering vol 77 no 3 pp 365 374 jun 2011 doi 10 1016 j petrol 2011 04 016 mei et al 2000 r mei w shyy d yu l s luo lattice boltzmann method for 3 d flows with curved boundary j comput phys 161 2 2000 680 699 10 1006 jcph 2000 6522 jul r mei w shyy d yu and l s luo lattice boltzmann method for 3 d flows with curved boundary j comput phys vol 161 no 2 pp 680 699 jul 2000 doi 10 1006 jcph 2000 6522 micro ct images and networks 2020 micro ct images and networks imperial college london http www imperial ac uk engineering departments earth science research research groups perm research pore scale modelling micro ct images and networks accessed nov 29 2020 mohamad 2011 a a mohamad lattice boltzmann method fundamentals and engineering applications with computer codes 2011 springer verlag london accessed jun 09 2018 online available https www springer com us book 9780857294548 a a mohamad lattice boltzmann method fundamentals and engineering applications with computer codes london springer verlag 2011 accessed jun 09 2018 online available https www springer com us book 9780857294548 muljadi et al 2016 b p muljadi m j blunt a q raeini b bijeljic the impact of porous media heterogeneity on non darcy flow behaviour from pore scale simulation adv water resour 95 2016 329 340 10 1016 j advwatres 2015 05 019 sep b p muljadi m j blunt a q raeini and b bijeljic the impact of porous media heterogeneity on non darcy flow behaviour from pore scale simulation adv water resour vol 95 pp 329 340 sep 2016 doi 10 1016 j advwatres 2015 05 019 nield and bejan 2013 d a nield a bejan mechanics of fluid flow through a porous medium convection in porous media 2013 springer new york new york ny 1 29 10 1007 978 1 4614 5541 7 1 d a nield and a bejan mechanics of fluid flow through a porous medium in convection in porous media new york ny springer new york 2013 pp 1 29 doi 10 1007 978 1 4614 5541 7 1 norouzi et al 2018 a m norouzi m siavashi a r soheili m khaliji oskouei experimental investigation of effects of grain size inlet pressure and flow rate of air and argon on pressure drop through a packed bed of granular activated carbon international communications in heat and mass transfer 96 2018 20 26 10 1016 j icheatmasstransfer 2018 05 019 aug a m norouzi m siavashi a r soheili and m khaliji oskouei experimental investigation of effects of grain size inlet pressure and flow rate of air and argon on pressure drop through a packed bed of granular activated carbon international communications in heat and mass transfer vol 96 pp 20 26 aug 2018 doi 10 1016 j icheatmasstransfer 2018 05 019 pan et al 2006 c pan l s luo c t miller an evaluation of lattice boltzmann schemes for porous medium flow simulation comput fluids 35 8 2006 898 909 10 1016 j compfluid 2005 03 008 sep c pan l s luo and c t miller an evaluation of lattice boltzmann schemes for porous medium flow simulation comput fluids vol 35 no 8 pp 898 909 sep 2006 doi 10 1016 j compfluid 2005 03 008 raeini et al 2015 a q raeini b bijeljic m j blunt modelling capillary trapping using finite volume simulation of two phase flow directly on micro ct images adv water resour 83 2015 102 110 10 1016 j advwatres 2015 05 008 sep a q raeini b bijeljic and m j blunt modelling capillary trapping using finite volume simulation of two phase flow directly on micro ct images adv water resour vol 83 pp 102 110 sep 2015 doi 10 1016 j advwatres 2015 05 008 rama et al 2010 p rama an x ray tomography based lattice boltzmann simulation study on gas diffusion layers of polymer electrolyte fuel cells j fuel cell sci technol 7 3 2010 031015 031015 12 10 1115 1 3211096 mar p rama et al an x ray tomography based lattice boltzmann simulation study on gas diffusion layers of polymer electrolyte fuel cells j fuel cell sci technol vol 7 no 3 pp 031015 031015 12 mar 2010 doi 10 1115 1 3211096 ramandi et al 2016 h l ramandi p mostaghimi r t armstrong m saadatfar w v pinczewski porosity and permeability characterization of coal a micro computed tomography study int j coal geol 154 155 2016 57 68 10 1016 j coal 2015 10 001 jan h l ramandi p mostaghimi r t armstrong m saadatfar and w v pinczewski porosity and permeability characterization of coal a micro computed tomography study int j coal geol vol 154 155 pp 57 68 jan 2016 doi 10 1016 j coal 2015 10 001 rao and schaefer 2019 p rao l schaefer lattice boltzmann models for micro tomographic pore spaces comput fluids 193 2019 104294 10 1016 j compfluid 2019 104294 rao p schaefer l 2019 lattice boltzmann models for micro tomographic pore spaces comput fluids 193 104294 doi 10 1016 j compfluid 2019 104294 saxena et al 2017 n saxena and benchmarks for pore scale flow simulated using micro ct images of porous media and digital rocks adv water resour 109 2017 211 235 10 1016 j advwatres 2017 09 007 nov n saxena et al 
