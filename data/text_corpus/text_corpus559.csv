index,text
2795,sampling stochastic dynamic programming ssdp method is one of the most popular methods in solving reservoir operation models especially in long term operation models however the dimension problems seriously confine the model scale and solving efficiency to increase the solution efficiency of ssdp for multiple reservoir operations a deep neural network ssdp dnn ssdp method is proposed in which dnn ssdp and simulation are combined the solution uses an initial state set obtained using a deterministic model in the first round ssdp run in the ssdp the future values and the decisions are computed using a series of deep neural networks replacing the interpolation algorithms to make it possible to adopt a small scale and irregularly distributed state set then the ssdp run is repeated after the state set is extended according to the simulation results using the obtained operation rule the process is repeated several times until the performance change between two rounds of ssdp run is small enough the scales of the state sets used are much smaller than the commonly used vertically intersecting discretization the proposed method is applied to derive the long term operation rule of the hydropower system on the wu river in southwest china for energy maximization results show that the computing time using the proposed method is only 18 of the common method without considerable accuracy loss keywords hydropower operation ssdp deep neural network data availability the authors do not have permission to share data 1 introduction as one of the most popular methods for reservoir operations stochastic dynamic programming loucks et al 1981 stedinger et al 1984 was widely used to solve hydropower optimization models sdp model explicitly considers stream flow uncertainty in its recursive equation by solving the dynamic programming dp recursive relations adapted to stochastic problems particularly markov decision processes for the temporal and spatial correlations of inflows multiple dimensional joint probability distribution and conditional probability distribution are often used in sdp lei et al 2017 kong et al 2018 exacerbating the problem of dimensionality in solution kelman et al 1990 proposed ssdp in which the inflow characteristics are formulated using samples relieving the dimensional problem caused by inflow correlations for multiple reservoir operations the decisions for all states often the combinations of reservoir levels previous inflows and inflow forecasting values have to be computed in dp based algorithms causing serious dimension problems dobson et al 2019 cote and arsenault 2019 and the solution is very time costing some amended or simplified methods to alleviate dimension problems were studied such as the aggregation disaggregation approaches saad et al 1994 archibald et al 1997 turgeon and charbonneau 1998 stochastic dual dynamic programming sddp pereira and pinto 1985 pereira 1989 marques and tilmant 2013 macian sorribes et al 2017 and simulation optimization methods koutsoyiannis and economou 2003 liu et al 2014 giuliani et al 2016 giuliani et al 2021 reviewed the optimal reservoir control models and methods especially for managing conflicting demands in a changing world even so the multiple reservoir operation models are still hard to be exactly solved to solve the reservoir operation models in accepted time some dimension reduction methods considering model characteristics were proposed to reduce solution space chen et al 2016 proposed a spectral optimization model som which transforms the decision variables from time domain to frequency domain to reduce the dimensionality application in the short term operation of a 10 reservoir system in the columbia river of the united states showed that the method can greatly reduce the number of decision variables to achieve a similar or better performance compared to the conventional optimization model feng et al 2018 introduced an improved poa variant called orthogonal progressive optimality algorithm opoa in which an orthogonal experimental design is used to replace the exhaustive combinatorial evaluation at each poa two stage sub problem the method is applied to a large scale multi reservoir system located on the wu river in china and can remarkably enhance the computing efficiency in different cases he et al 2019 proposed an importance sampling parallel dynamic programming is pdp algorithm in which the importance sampling is first used to construct the state vectors of each period by introducing manhattan distance in the discrete state space then the pdp recursive equation is used to find an improved solution during the iteration the is pdp method is tested to optimize hydropower output for the joint operation of an 11 reservoir system located in the upper yangtze river basin of china result shows the methodology is an attractive alternative for non convex operation of large scale cascade reservoirs shen et al 2021 developed a random sampling rs technique to select representative water level states at each period by considering discrepant weights for different solution ranges and designed a feasible region identification fri method to narrow the search range a large scale hydropower system with 21 plants is presented to verify the validity efficiency and sensitivity of the method the dimension reduction methods are often used in deterministic reservoir operation models while for the stochastic models the curse of dimensionality is much more serious in recent years many artificial intelligence techniques have been used to solve reservoir operation models and become promising alternatives lee et al 2007 demonstrated q learning method in reinforcement learning in the two reservoir geum river system south korea the method is shown to outperform implicit stochastic dynamic programming and sampling stochastic dynamic programming methods castelletti et al 2010 presented a reinforcement learning approach called fitted q iteration which combines the principle of continuous approximation of the value functions with a process of learning off line from experience to design daily cyclostationary operating policies case study of lake como water system italy demonstrated the advantages of the approach in terms of accuracy and computational effectiveness compared to traditional sdp guariso and sangiorgio 2020 proposed two approaches the first solves a deterministic open loop problem and then identifies neural closed loop policies using the classical regression method the second approach direct policy search assumes that the operating rule is represented by an nn the parameters of which are optimized directly by solving the optimal closed loop problem application of the downstream portion of the nile river basin system showed that the first approach performs better in terms of global agricultural deficit and hydropower production xu et al 2021 reported a new deep reinforcement learning drl framework for optimal operation of reservoir systems based on deep q networks dqns which provides a significant advance in understanding the performance of optimal operations artificial intelligence ai techniques were introduced to solve reservoir operation models as a substitute of optimization methods to resolve the curses of dynamic programming powell 2007 and the traditional optimization methods are still of advantages of solution stability and adaptability how to combine artificial intelligence methods and traditional optimization methods to improve the solution efficiency of reservoir operation models needs further research in this paper we attempt to combine ssdp simulation and deep neural network to solve multiple reservoir operation models the solution framework is a series of ssdp using different state sets and the state sets are renewed according to simulation results an initial state set is used to obtain an operation rule and the emerging states in the simulated results are combined to the state set to solve a new operation rule until that the performance of operation rule is not remarkably improved for common ssdp methods the future values and decisions are often computed using interpolation algorithms the accuracy depends on how dense the states are discretized in this paper the future values and decisions are computed using deep neural networks trained using the small state sets hundreds of dnn are used to fit future value functions and make decisions the proposed method is applied to long term operation for expected energy maximization of the wu river hydropower system in china result shows that the computing efficiency is significantly increased 2 studied hydropower operation model the studied hydropower operation model is energy maximization subject to firm power on the whole system shown as eq 1 9 1 max φ f exp t 1 i 1 n p i t h t constraints 2 water balance s i t 1 s i t 3600 h t i i t j 1 u i r u i j t r i t 3 r i t q i t d i t relationship among reservoir storage turbine flow and power generation 4 p i t η i q i t z i s i t z i s i t 1 2 z d i storage bounds 5 s i t s i t s i t maximum power and turbine flow 6 p i t p i t 7 q i t q i t firm power 8 fp i 1 m p i t minimum reservoir release 9 r i t r i t where f is the objective of energy generation in operating horizon φ is a set of operation rule to be optimized and can be formulated as relations of s t r t at all periods s t s 1 t s 2 t s i t s i t reservoir storage of reservoir i at the beginning of period t r t r 1 t r 2 t r i t r i t release decision of station i at period t n is the reservoir number h t is the hour number in period t η m is power generation coefficient of reservoir m z d m is the average downstream level of reservoir m u m is the number of immediate upper stream reservoirs of reservoir m and u m i is the sequence number of the ith immediate upper stream reservoir fp is the system firm power for reservoir i at period t p m t and p m t are the power generation and its upper bound q m t and q m t are the rate of turbine flow and its upper bound s m t s m t s m t are the storage and its lower and upper bounds z m s m t is the reservoir level a function of s m t i m t is the rate of local inflow r m t and r m t are the rates of release flow and its lower constraint d m t is the rate of spill flow 3 framework of hydropower operation using small state sets the studied hydropower operation model is often solved using sdp based methods while the sdp based methods encounters dimension problem the dimension problems in sdp include three aspects the first aspect is that the number of storage states is exponential growth with reservoir number commonly the state space of sdp is discretized using vertical grids equidistant in each dimension which is easier to use interpolation methods to get the future values supposing that the storage of reservoir i is discretized using l i points the total state number is i 1 n l i n is the number of reservoirs at each state the optimal decision has to be computed according to eq 1 for long term regulated reservoirs l i is often larger than 20 to ensure high accuracy so with the increasing reservoir number the computation time rapidly becomes unacceptable and the internal memory of a personal computer is not enough to save the data the second aspect is the inflow scenario of each stage increased fast with reservoir number to describe a joint distribution of inflows in one stage there is at most i 1 n k i scenario k i is the number of the interval number if inflow for reservoir i for the models considering pre inflow or inflow forecasting the scenario number can be squared the third aspect is the exponential growth of discretized decision number for nonconvex problems the global solution at each state can be ensured only by traversing all i 1 n d i decisions d i is the number of discretized decisions of reservoir i ssdp use inflow samples and can avoid discretized joint distribution resolving the second aspect of the dimension problem the recursive function of ssdp for annual cycle monthly hydropower operation model is eq 10 does not consider inflow forecasting or pre inflow dependent sample probabilities 10 max r t f t s t 1 m m 1 m b m t r t s t f m t 1 s t 1 t t 1 m m 1 m b m t r t s t 1 m j 1 m f j 1 s t 1 t t where f t s t the objective of at period t for reservoir storage state vector s t b m t r t s t the benefit function at period t given state s t and release decision vector r t f m t 1 s t 1 future value function of period t for inflow scenario m t period number in a year the constraints include reservoir storage bounds maximum power and minimum release of reservoirs and system firm power minimum release and system firm power constraints are soft constraints without them the optimality conditions of the model are clear zhao et al 2011 to address the two constraints penalty functions are used and the benefit function used in eq 10 is as eq 11 11 b m t r t s t i 1 n p i t h t a max fp i 1 n p i t 0 2 b i 1 n max r i t r i t 0 2 where a and b are penalty coefficients in this paper we focus on reducing the state number for multi reservoir operations the state number can be thousands or more even if a reservoir system can work for more than a hundred years many of the states have never been and will not be visited or approached for example two hydropower reservoirs having total firm power constraint a case may not occur that the lower reservoir is empty while the upper reservoir is full in real operation the discretized points for this kind of storage combinations just indicate low future value regions to avoid ending storage located in them excluding these states may not seriously affect the operation results or only much smaller state sets can still be enough to obtain quasi optimal operation rules following this idea we propose a framework of an iterative solution for quasi optimal operation rules as follows step 1 set i 0 and set j i initial discretized states for each period and the state set is s s i step 2 solve the ssdp model using the state set s s i and get a new operating rule step 3 simulate using the rule for y year data and get y states at each month combine the y states into s s i at each period to obtain a new state set of s s i 1 with j i y states at each period step 4 set i i 1 if a preset convergence condition or a maximum iteration time is reached stop else go back to step 2 in the framework we first select the most useful states and use them to get an operating rule through simulation using the rule many new states far from those selected emerge it means that the preset states are not enough to represent the future value functions and the newly emerged states need to be added in the optimization simulation process is repeated until the state number is enough the space distribution of states is appropriate and the rule and simulation result do not change much in the solution the scale of state sets can be controlled and will not cause serious dimension problem of course the larger and the more complex the problem is the more states in solution are needed 4 obtaining the initial states for hydropower systems that have gone into operation for many years the actual operation process of reservoir storage can be used as part of the initial state set also the results of the deterministic model using long term historical inflow data can also be a part of the initial state set considering the change of operation environment the historical actual operation data may not have reference value so the results of the following deterministic model are used to get the initial state set objective function 12 max g t 1 tt i 1 n p i t h t constraints the constraints including eq 2 9 and the initial and ending storage of eq 13 14 13 s i 1 s i i 14 s i tt 1 s e i where tt is the period number of operation horizon the operation horizon here is long term series of decades with inflow data s i i s e i are the initial and ending storage setting for reservoir i there are many available methods to solve the deterministic model in this paper the discretized differential dynamic programming dddp heidari et al 1971 cheng et al 2014 algorithm is used the dddp algorithm cannot obtain the global solution for the deterministic model while the local optimization is enough to get the initial states the initial and ending storage settings are not important for the operation horizon is long enough to alleviate the influence 5 dnn ssdp eq 10 defines a recursive computation of periodic markov processes in an infinite horizon of which one cycle corresponds to a year and each period is defined as one month the ssdp solution needs to obtain an optimal decision at each state from the last period t to the first period 1 backwards in a year this process is repeated iteratively until decisions converge at all periods and all states at the beginning of each iteration the future value function fvf for period t is replaced by that of period 1 of the last iteration at each stage the fvf is needed for the solution unlike the common vertical grid state distribution in ssdp the state sets we assumed or emerged from simulations are scattered points with irregular positions in space we need a tool to fit the fvfs using the irregular distributed states to replace the interpolation methods for vertical grid states in common ssdp johnson et al 1993 in this paper back propagation deep neural networks are used back propagating procedure was proposed by rumelhart et al 1986 the procedure repeatedly adjusts the weights of the connections in the network so as to minimize a measure of the difference between the actual output vector and the desired output vector the back propagating neural network has been widely used in hydrologic forecasting and reservoir operation area smith and eli 1995 neelakantan and pundarikanthan 2000 chandramouli and raman 2001 in eq 10 there are m fvfs in each period so m dnns are constructed and trained before solving r t for each s t the structure of the dnns used is as fig 1 the dnns have an input layer two hidden layers and an output layer each hidden layer has three nodes in fig 1 setting the input layer is layer 1 the two hidden layer are layer 2 and 3 and the output layer is layer 4 w i j k is the weight of connection of node i of layer k and node j of layer k 1 b i k is the bias of node i of layer k 1 n i k and a i k are input and output of the activation function of node i of layer k 1 the network input xi is the normalized reservoir storage and the output y is the normalized fvf for an inflow sample all the activation functions of f 1 f 2 and f 3 are sigmoid function of a i j 1 1 e n i j at one iteration of the dnn ssdp optimal decisions at all states are obtained backwards from the last period of a year for several times setting f j t 1 f j 1 j 1 m until solution at all states unchanged at each period t the dnns to compute f m t 1 s t 1 m 1 m or f j 1 s t 1 j 1 m are trained first to get optimal weights and bias for error minimization taking all the irregular distributed states as training samples the training is ended if an average error setting or a maximum training time is reached except for some water supply models with concave objective function zhao et al 2012 the reservoir operation model considering power generation water head varying and period total power constraints are nonconcave and may have multiple local solutions liu et al 2011 rouge and tilmant 2016 to avoid the influence of multiple solution and increase solution accuracy the decision of all states are optimized using a two stage algorithm including traversing and search wu et al 2018 in the traversing stage the discretized points near which potential local optima may exist are firstly found the region near the optimal point in traversing stage is obviously promising and the point is added to a vector of initial search points all the discretized decision points with objective function values larger than all neighboring points are also initial search points for each point in the vector a local optimum is found by search to avoid much time consuming using multi dimensional search only the reservoir decision with largest f t s t r i t is changed by step of δ m in one step of search until no better solution found then set δ m δ m 2 and repeat the search for several times until a preset minimum step is reached after the local searches optima near all initial search points in the vector have been found and the best of them is set to be the solution 6 obtain optimal decisions through solving the ssdp model a set of rule is obtained to indicate the releases of reservoirs at states an operation rule is composed of a set of state decision pairs at the irregular discretized states to use the rule to simulation decisions of state besides the discretized ones have to be obtained for the fvfs have been obtained in the simulation procedure the optimal decisions can be solved at each period using the similar method used in rule optimization while it is time costing so another set of dnns is used to get the decisions the dnn structure is the same as fig 1 and the inputs are still normalized reservoir storages and the output is the normalized release of a reservoir there are n dnns to fit optimal decision at each period and totally n t dnns are trained before simulation after simulation y states are obtained for each month and they are added to the old state set following the dnn ssdp framework for too many states in a small region of the state space will not improve the representativeness a new state can be removed if the distance between it and any of the states already exist is shorter than a minimum distance the computing flow chart of dnn ssdp is shown in fig 2 7 case study 7 1 wu river cascaded hydropower system the wu river originates from the eastern edge of the wumeng mountains with two sources in the south and north the sancha river in the south is 322 km long which is the main source of the wu river the liuchong river in the north is 210 km long when the two sources meet it is called wu river the wu river is the largest tributary in the south of the upper reaches of the yangtze river with a total drainage area of 87900 km2 a total length of 1050 km from the origin to the estuary and a drop of 1787 46 m fig 3 shows the position of the studied hydropower system the annual average precipitation in the western part of wu river basin is about 1000 mm 1000 1200 mm in the central part and about 1400 mm in the southeast part the rainy season mostly occurs from may to october wu river is one of the main power sources of the west to east power transmission projects of china the studied cascaded system on wu river is on the main stem in guizhou province including hongjiadu dongfeng suofengying wujiangdu goupitan and silin reservoirs with a total installed capacity of 7195 mw inflow data from year 1953 to 2008 are used in solution and simulation and there are 12 56 networks to be trained in each round of ssdp computation table 1 shows the beneficial storages of hongjiadu and goupitan reservoirs are much large than the other reservoirs and they are main long term regulation reservoirs of the system the regulation abilities of other reservoirs are neglected in this study 7 2 numerical result the dddp ssdp and dnn ssdp are programmed using java language the penalty coefficient a and b in eq 11 are set to be 100 and 1000 respectively to test the proposed method two cascade firm power of 0 mw and 1900 mw are used respectively corresponding to the without firm power and with firm power cases in table 2 when the firm power is 0 mw the dddp is used to solve the deterministic model to obtain 1431twh of total energy then the operation rule is solved using ssdp and dnn ssdp respectively in the ssdp method the state set in one period includes 51 51 storage combinations as shown in fig 4 in the dnn ssdp method the initial state set includes the reservoir storage combinations in the dddp result and also includes the corner points of s 1 t s 2 t s 1 t s 2 t s 1 t s 2 t s 1 t s 2 t so at each period there are 60 storage combinations in the initial state set after obtaining the operation rule using the initial states through dnn ssdp the rule is used to simulate using historical data and 56 new storage combinations are obtained in the second round solution there are 116 states in each period similarly there are 172 states at each period in the third round solution the simulation results changed very little in further rounds of solution so the solution process is stopped in the ssdp run and each round of the dnn ssdp run the optimal decisions are obtained using recursive function eq 10 from period t to 1 for 5 times before convergence the simulated energy values of the operation rules obtained using two methods of ssdp and dnn ssdp are almost the same of 1382twh since there is no firm power constraint and the minimum outflow constraints are easy to be satisfied there is very little influence of penalty term on the fvf surfaces the fvf surfaces are simple and the dnn can accurately fit the simple fvf surfaces using a small state set and the operation result is almost the same as ssdp using a large state set while the solution time of dnn ssdp is only 18 of that of the common ssdp for the three rounds of computation of dnn ssdp there are totally 60 116 172 decisions in one period that need to be computed while for common ssdp there are 2601 decisions the computation time using dnn ssdp to solve decision is estimated to be about 14 of that of the common ssdp the other 4 time is used for network training when the firm power is set to be 1900 mw the computing process is the same as no firm power case black points in fig 5 are the initial states of dnn ssdp including the reservoir storage of the dddp result and four corner points in the wu river cascaded hydropower system the upstream hongjiadu reservoir has carryover year storage and the installed capacity is much smaller than the goupitan reservoir so the cascade firm power is satisfied through the drawing of the hongjiadu reservoir in most periods unless the reservoir level is very low while the reservoir level of goupitan reservoir is kept high unless the cascade firm power cannot be satisfied or there is spill risk in future periods so in fig 5 for months from august to october the reservoir level of the goupitan reservoir is close to the upper bound in most years in the months from january to april the degree of the reservoir level of the goupitan reservoir deviation from the upper bound gradually increases to satisfy cascade firm power and minimum outflow constraint the low values of the goupitan reservoir level in flood season are often to avoid spill in future periods for the hongjiadu reservoir the average reservoir level reaches the highest value in october and keeps decreasing to the next may and then swings from decreasing to increasing using the states in the first round of dnn ssdp an initial operation rule can be obtained table 3 shows the simulation results in each round of dnn ssdp for the model with firm power constraint through simulation using the rule the energy generation in the 56 years is 1378twh the average period shortage of firm power is 74 8 mw and the extreme period shortage is 1243 mw table 3 through including the simulation result into the state set the states added in the second round of dnn ssdp are shown as orange points in fig 5 in dry season months from november to april most of the new states are densely distributed in one area where the storage of the goupitan reservoir is smaller than the initial states while in other months the new states scatter in larger areas it is because that the initial states are not enough to obtain accurate future value surfaces there are some regions where the future value is relatively large and the obtained operation rule tends to lead the reservoir level to the regions in months from august to october some new states are near the upper bound of the reservoir level of hongjiadu reservoir while in the initial states this kind of states is very less for the initial states are obtained using a deterministic model knowing the future inflow the hongjiadu reservoir needs not to refill to a high reservoir level each year to store enough water for future use especially satisfying the cascade firm power while following the operation rule obtained using the stochastic model the hongjiadu reservoir tends to keep a high reservoir level after flood season for more years than in the deterministic model through simulation using the rule obtained in the second round the energy generation in the 56 years is 1377twh the average period shortage of firm power is 24 8 mw and the extreme period shortage is 727 mw table 3 before the third round the red points in fig 5 are added to the state set for the months of january march november and december the new points mainly distribute between the points of initial state points and the state points added in the second round computation tending to supplement the blank area for the months of february and april the new state points mainly distribute in the edge of the old state distributed area tending to extend distributed area during flood months the new state points distribute relatively evenly through simulation using the rule obtained in the third round the energy generation in the 56 years is 1376twh the average period shortage of firm power is 19 2 mw and the extreme period shortage is 690 mw table 3 the energy generation is a little less than and the average shortage is a little larger than those of common ssdp while the extreme period shortage is less than common ssdp the sum of squares of firm power shortage in all period is 3 7 106 for dnn ssdp a little smaller than that of common ssdp 3 9 106 the solution of the common ssdp can be considered to be approximate global optimal the simulation results illustrate that the solving accuracy of the dnn ssdp is very close to common ssdp while the total computation time of dnn ssdp is still about only 18 of that of common ssdp table 4 shows the average absolute value of the relative error of fvfs between two round solutions in table 3 and table 4 the fast convergence of the solution is shown fig 6 and fig 7 show the value surfaces fitted using the states in the last round of dnn ssdp computation and common ssdp respectively the shapes of the value surfaces at each month using the two methods are similar the main difference between the value surfaces is that in dry months the values of dnn ssdp are smaller than common ssdp in the region where both the reservoir levels of hongjiadu and goupitan are close to the lowest values for using dnn ssdp there are very few states in the regions in the initial state set in the simulation results using the first and second round dnn ssdp rules there is almost no new state emerges in the regions the objective value of the both 0 storage states in the corner is the smallest in each month and there are not enough states to lift the surface height like using common ssdp in which the states are vertical discretized in the regions fig 8 shows the total simulated power using dnn ssdp and common ssdp in most periods the simulated total power values are very close to each other using the two methods while in several flood months the total power values using dnn ssdp are significantly larger than using common ssdp it is because the decisions of the two methods have small differences in each period once the differences are continuously negative for several periods the accumulation of the differences results in significant differences in initial reservoir levels in one period and then significantly different decisions in the periods in most circumstances the decision differences offset each other in continuous periods so the total power values in most periods using the two methods are close to each other 8 conclusions and discussions to relieve the curse of dimensionality in solving multiple reservoir operation models simulation optimization artificial intelligence techniques and dimension reduction methods are three important ways in this paper based on ssdp they are combined in one method called dnn ssdp in the method an initial state set is generated using a deterministic model an ssdp model solves the operation model using the initial state set and the fvfs and decision functions of the ssdp are replaced by a series of dnns a simulation method obtains new state sets to be combined with the old ones in next round of ssdp solution from the result of the wu river hydropower system application it can be concluded that 1 the dnns well fit the fvfs and decision functions and make it possible to use irregularly distributed states compared to the vertically intersecting discretization of common ssdp 2 the initial state set is insufficient to reflect the characteristics of fvf and obtain accurate results while the newly obtained states correct the lack of representativeness of the old states 3 the proposed framework can effectively solve the operation model in 18 time of common ssdp 4 for the energy maximization model without and with firm power constraint the performances of dnn ssdp are almost the same or very close to that of common ssdp using artificial intelligence techniques seems to be a new alternative to reservoir operation research this study show that besides completely introducing some ai models or just taking the reservoir operation model as an example of an ai model application combining the advantages of optimization ai and characteristics of the reservoir operation problems is also a promising alternative credit authorship contribution statement xinyu wu conceptualization methodology software validation writing original draft funding acquisition zhiyong chen methodology software writing review editing visualization chuntian cheng resources writing review editing supervision shuai yin software writing review editing formal analysis huaying su resources writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the research work described in this paper is supported by the national nature science foundation of china 52179005 and 91647113 
2795,sampling stochastic dynamic programming ssdp method is one of the most popular methods in solving reservoir operation models especially in long term operation models however the dimension problems seriously confine the model scale and solving efficiency to increase the solution efficiency of ssdp for multiple reservoir operations a deep neural network ssdp dnn ssdp method is proposed in which dnn ssdp and simulation are combined the solution uses an initial state set obtained using a deterministic model in the first round ssdp run in the ssdp the future values and the decisions are computed using a series of deep neural networks replacing the interpolation algorithms to make it possible to adopt a small scale and irregularly distributed state set then the ssdp run is repeated after the state set is extended according to the simulation results using the obtained operation rule the process is repeated several times until the performance change between two rounds of ssdp run is small enough the scales of the state sets used are much smaller than the commonly used vertically intersecting discretization the proposed method is applied to derive the long term operation rule of the hydropower system on the wu river in southwest china for energy maximization results show that the computing time using the proposed method is only 18 of the common method without considerable accuracy loss keywords hydropower operation ssdp deep neural network data availability the authors do not have permission to share data 1 introduction as one of the most popular methods for reservoir operations stochastic dynamic programming loucks et al 1981 stedinger et al 1984 was widely used to solve hydropower optimization models sdp model explicitly considers stream flow uncertainty in its recursive equation by solving the dynamic programming dp recursive relations adapted to stochastic problems particularly markov decision processes for the temporal and spatial correlations of inflows multiple dimensional joint probability distribution and conditional probability distribution are often used in sdp lei et al 2017 kong et al 2018 exacerbating the problem of dimensionality in solution kelman et al 1990 proposed ssdp in which the inflow characteristics are formulated using samples relieving the dimensional problem caused by inflow correlations for multiple reservoir operations the decisions for all states often the combinations of reservoir levels previous inflows and inflow forecasting values have to be computed in dp based algorithms causing serious dimension problems dobson et al 2019 cote and arsenault 2019 and the solution is very time costing some amended or simplified methods to alleviate dimension problems were studied such as the aggregation disaggregation approaches saad et al 1994 archibald et al 1997 turgeon and charbonneau 1998 stochastic dual dynamic programming sddp pereira and pinto 1985 pereira 1989 marques and tilmant 2013 macian sorribes et al 2017 and simulation optimization methods koutsoyiannis and economou 2003 liu et al 2014 giuliani et al 2016 giuliani et al 2021 reviewed the optimal reservoir control models and methods especially for managing conflicting demands in a changing world even so the multiple reservoir operation models are still hard to be exactly solved to solve the reservoir operation models in accepted time some dimension reduction methods considering model characteristics were proposed to reduce solution space chen et al 2016 proposed a spectral optimization model som which transforms the decision variables from time domain to frequency domain to reduce the dimensionality application in the short term operation of a 10 reservoir system in the columbia river of the united states showed that the method can greatly reduce the number of decision variables to achieve a similar or better performance compared to the conventional optimization model feng et al 2018 introduced an improved poa variant called orthogonal progressive optimality algorithm opoa in which an orthogonal experimental design is used to replace the exhaustive combinatorial evaluation at each poa two stage sub problem the method is applied to a large scale multi reservoir system located on the wu river in china and can remarkably enhance the computing efficiency in different cases he et al 2019 proposed an importance sampling parallel dynamic programming is pdp algorithm in which the importance sampling is first used to construct the state vectors of each period by introducing manhattan distance in the discrete state space then the pdp recursive equation is used to find an improved solution during the iteration the is pdp method is tested to optimize hydropower output for the joint operation of an 11 reservoir system located in the upper yangtze river basin of china result shows the methodology is an attractive alternative for non convex operation of large scale cascade reservoirs shen et al 2021 developed a random sampling rs technique to select representative water level states at each period by considering discrepant weights for different solution ranges and designed a feasible region identification fri method to narrow the search range a large scale hydropower system with 21 plants is presented to verify the validity efficiency and sensitivity of the method the dimension reduction methods are often used in deterministic reservoir operation models while for the stochastic models the curse of dimensionality is much more serious in recent years many artificial intelligence techniques have been used to solve reservoir operation models and become promising alternatives lee et al 2007 demonstrated q learning method in reinforcement learning in the two reservoir geum river system south korea the method is shown to outperform implicit stochastic dynamic programming and sampling stochastic dynamic programming methods castelletti et al 2010 presented a reinforcement learning approach called fitted q iteration which combines the principle of continuous approximation of the value functions with a process of learning off line from experience to design daily cyclostationary operating policies case study of lake como water system italy demonstrated the advantages of the approach in terms of accuracy and computational effectiveness compared to traditional sdp guariso and sangiorgio 2020 proposed two approaches the first solves a deterministic open loop problem and then identifies neural closed loop policies using the classical regression method the second approach direct policy search assumes that the operating rule is represented by an nn the parameters of which are optimized directly by solving the optimal closed loop problem application of the downstream portion of the nile river basin system showed that the first approach performs better in terms of global agricultural deficit and hydropower production xu et al 2021 reported a new deep reinforcement learning drl framework for optimal operation of reservoir systems based on deep q networks dqns which provides a significant advance in understanding the performance of optimal operations artificial intelligence ai techniques were introduced to solve reservoir operation models as a substitute of optimization methods to resolve the curses of dynamic programming powell 2007 and the traditional optimization methods are still of advantages of solution stability and adaptability how to combine artificial intelligence methods and traditional optimization methods to improve the solution efficiency of reservoir operation models needs further research in this paper we attempt to combine ssdp simulation and deep neural network to solve multiple reservoir operation models the solution framework is a series of ssdp using different state sets and the state sets are renewed according to simulation results an initial state set is used to obtain an operation rule and the emerging states in the simulated results are combined to the state set to solve a new operation rule until that the performance of operation rule is not remarkably improved for common ssdp methods the future values and decisions are often computed using interpolation algorithms the accuracy depends on how dense the states are discretized in this paper the future values and decisions are computed using deep neural networks trained using the small state sets hundreds of dnn are used to fit future value functions and make decisions the proposed method is applied to long term operation for expected energy maximization of the wu river hydropower system in china result shows that the computing efficiency is significantly increased 2 studied hydropower operation model the studied hydropower operation model is energy maximization subject to firm power on the whole system shown as eq 1 9 1 max φ f exp t 1 i 1 n p i t h t constraints 2 water balance s i t 1 s i t 3600 h t i i t j 1 u i r u i j t r i t 3 r i t q i t d i t relationship among reservoir storage turbine flow and power generation 4 p i t η i q i t z i s i t z i s i t 1 2 z d i storage bounds 5 s i t s i t s i t maximum power and turbine flow 6 p i t p i t 7 q i t q i t firm power 8 fp i 1 m p i t minimum reservoir release 9 r i t r i t where f is the objective of energy generation in operating horizon φ is a set of operation rule to be optimized and can be formulated as relations of s t r t at all periods s t s 1 t s 2 t s i t s i t reservoir storage of reservoir i at the beginning of period t r t r 1 t r 2 t r i t r i t release decision of station i at period t n is the reservoir number h t is the hour number in period t η m is power generation coefficient of reservoir m z d m is the average downstream level of reservoir m u m is the number of immediate upper stream reservoirs of reservoir m and u m i is the sequence number of the ith immediate upper stream reservoir fp is the system firm power for reservoir i at period t p m t and p m t are the power generation and its upper bound q m t and q m t are the rate of turbine flow and its upper bound s m t s m t s m t are the storage and its lower and upper bounds z m s m t is the reservoir level a function of s m t i m t is the rate of local inflow r m t and r m t are the rates of release flow and its lower constraint d m t is the rate of spill flow 3 framework of hydropower operation using small state sets the studied hydropower operation model is often solved using sdp based methods while the sdp based methods encounters dimension problem the dimension problems in sdp include three aspects the first aspect is that the number of storage states is exponential growth with reservoir number commonly the state space of sdp is discretized using vertical grids equidistant in each dimension which is easier to use interpolation methods to get the future values supposing that the storage of reservoir i is discretized using l i points the total state number is i 1 n l i n is the number of reservoirs at each state the optimal decision has to be computed according to eq 1 for long term regulated reservoirs l i is often larger than 20 to ensure high accuracy so with the increasing reservoir number the computation time rapidly becomes unacceptable and the internal memory of a personal computer is not enough to save the data the second aspect is the inflow scenario of each stage increased fast with reservoir number to describe a joint distribution of inflows in one stage there is at most i 1 n k i scenario k i is the number of the interval number if inflow for reservoir i for the models considering pre inflow or inflow forecasting the scenario number can be squared the third aspect is the exponential growth of discretized decision number for nonconvex problems the global solution at each state can be ensured only by traversing all i 1 n d i decisions d i is the number of discretized decisions of reservoir i ssdp use inflow samples and can avoid discretized joint distribution resolving the second aspect of the dimension problem the recursive function of ssdp for annual cycle monthly hydropower operation model is eq 10 does not consider inflow forecasting or pre inflow dependent sample probabilities 10 max r t f t s t 1 m m 1 m b m t r t s t f m t 1 s t 1 t t 1 m m 1 m b m t r t s t 1 m j 1 m f j 1 s t 1 t t where f t s t the objective of at period t for reservoir storage state vector s t b m t r t s t the benefit function at period t given state s t and release decision vector r t f m t 1 s t 1 future value function of period t for inflow scenario m t period number in a year the constraints include reservoir storage bounds maximum power and minimum release of reservoirs and system firm power minimum release and system firm power constraints are soft constraints without them the optimality conditions of the model are clear zhao et al 2011 to address the two constraints penalty functions are used and the benefit function used in eq 10 is as eq 11 11 b m t r t s t i 1 n p i t h t a max fp i 1 n p i t 0 2 b i 1 n max r i t r i t 0 2 where a and b are penalty coefficients in this paper we focus on reducing the state number for multi reservoir operations the state number can be thousands or more even if a reservoir system can work for more than a hundred years many of the states have never been and will not be visited or approached for example two hydropower reservoirs having total firm power constraint a case may not occur that the lower reservoir is empty while the upper reservoir is full in real operation the discretized points for this kind of storage combinations just indicate low future value regions to avoid ending storage located in them excluding these states may not seriously affect the operation results or only much smaller state sets can still be enough to obtain quasi optimal operation rules following this idea we propose a framework of an iterative solution for quasi optimal operation rules as follows step 1 set i 0 and set j i initial discretized states for each period and the state set is s s i step 2 solve the ssdp model using the state set s s i and get a new operating rule step 3 simulate using the rule for y year data and get y states at each month combine the y states into s s i at each period to obtain a new state set of s s i 1 with j i y states at each period step 4 set i i 1 if a preset convergence condition or a maximum iteration time is reached stop else go back to step 2 in the framework we first select the most useful states and use them to get an operating rule through simulation using the rule many new states far from those selected emerge it means that the preset states are not enough to represent the future value functions and the newly emerged states need to be added in the optimization simulation process is repeated until the state number is enough the space distribution of states is appropriate and the rule and simulation result do not change much in the solution the scale of state sets can be controlled and will not cause serious dimension problem of course the larger and the more complex the problem is the more states in solution are needed 4 obtaining the initial states for hydropower systems that have gone into operation for many years the actual operation process of reservoir storage can be used as part of the initial state set also the results of the deterministic model using long term historical inflow data can also be a part of the initial state set considering the change of operation environment the historical actual operation data may not have reference value so the results of the following deterministic model are used to get the initial state set objective function 12 max g t 1 tt i 1 n p i t h t constraints the constraints including eq 2 9 and the initial and ending storage of eq 13 14 13 s i 1 s i i 14 s i tt 1 s e i where tt is the period number of operation horizon the operation horizon here is long term series of decades with inflow data s i i s e i are the initial and ending storage setting for reservoir i there are many available methods to solve the deterministic model in this paper the discretized differential dynamic programming dddp heidari et al 1971 cheng et al 2014 algorithm is used the dddp algorithm cannot obtain the global solution for the deterministic model while the local optimization is enough to get the initial states the initial and ending storage settings are not important for the operation horizon is long enough to alleviate the influence 5 dnn ssdp eq 10 defines a recursive computation of periodic markov processes in an infinite horizon of which one cycle corresponds to a year and each period is defined as one month the ssdp solution needs to obtain an optimal decision at each state from the last period t to the first period 1 backwards in a year this process is repeated iteratively until decisions converge at all periods and all states at the beginning of each iteration the future value function fvf for period t is replaced by that of period 1 of the last iteration at each stage the fvf is needed for the solution unlike the common vertical grid state distribution in ssdp the state sets we assumed or emerged from simulations are scattered points with irregular positions in space we need a tool to fit the fvfs using the irregular distributed states to replace the interpolation methods for vertical grid states in common ssdp johnson et al 1993 in this paper back propagation deep neural networks are used back propagating procedure was proposed by rumelhart et al 1986 the procedure repeatedly adjusts the weights of the connections in the network so as to minimize a measure of the difference between the actual output vector and the desired output vector the back propagating neural network has been widely used in hydrologic forecasting and reservoir operation area smith and eli 1995 neelakantan and pundarikanthan 2000 chandramouli and raman 2001 in eq 10 there are m fvfs in each period so m dnns are constructed and trained before solving r t for each s t the structure of the dnns used is as fig 1 the dnns have an input layer two hidden layers and an output layer each hidden layer has three nodes in fig 1 setting the input layer is layer 1 the two hidden layer are layer 2 and 3 and the output layer is layer 4 w i j k is the weight of connection of node i of layer k and node j of layer k 1 b i k is the bias of node i of layer k 1 n i k and a i k are input and output of the activation function of node i of layer k 1 the network input xi is the normalized reservoir storage and the output y is the normalized fvf for an inflow sample all the activation functions of f 1 f 2 and f 3 are sigmoid function of a i j 1 1 e n i j at one iteration of the dnn ssdp optimal decisions at all states are obtained backwards from the last period of a year for several times setting f j t 1 f j 1 j 1 m until solution at all states unchanged at each period t the dnns to compute f m t 1 s t 1 m 1 m or f j 1 s t 1 j 1 m are trained first to get optimal weights and bias for error minimization taking all the irregular distributed states as training samples the training is ended if an average error setting or a maximum training time is reached except for some water supply models with concave objective function zhao et al 2012 the reservoir operation model considering power generation water head varying and period total power constraints are nonconcave and may have multiple local solutions liu et al 2011 rouge and tilmant 2016 to avoid the influence of multiple solution and increase solution accuracy the decision of all states are optimized using a two stage algorithm including traversing and search wu et al 2018 in the traversing stage the discretized points near which potential local optima may exist are firstly found the region near the optimal point in traversing stage is obviously promising and the point is added to a vector of initial search points all the discretized decision points with objective function values larger than all neighboring points are also initial search points for each point in the vector a local optimum is found by search to avoid much time consuming using multi dimensional search only the reservoir decision with largest f t s t r i t is changed by step of δ m in one step of search until no better solution found then set δ m δ m 2 and repeat the search for several times until a preset minimum step is reached after the local searches optima near all initial search points in the vector have been found and the best of them is set to be the solution 6 obtain optimal decisions through solving the ssdp model a set of rule is obtained to indicate the releases of reservoirs at states an operation rule is composed of a set of state decision pairs at the irregular discretized states to use the rule to simulation decisions of state besides the discretized ones have to be obtained for the fvfs have been obtained in the simulation procedure the optimal decisions can be solved at each period using the similar method used in rule optimization while it is time costing so another set of dnns is used to get the decisions the dnn structure is the same as fig 1 and the inputs are still normalized reservoir storages and the output is the normalized release of a reservoir there are n dnns to fit optimal decision at each period and totally n t dnns are trained before simulation after simulation y states are obtained for each month and they are added to the old state set following the dnn ssdp framework for too many states in a small region of the state space will not improve the representativeness a new state can be removed if the distance between it and any of the states already exist is shorter than a minimum distance the computing flow chart of dnn ssdp is shown in fig 2 7 case study 7 1 wu river cascaded hydropower system the wu river originates from the eastern edge of the wumeng mountains with two sources in the south and north the sancha river in the south is 322 km long which is the main source of the wu river the liuchong river in the north is 210 km long when the two sources meet it is called wu river the wu river is the largest tributary in the south of the upper reaches of the yangtze river with a total drainage area of 87900 km2 a total length of 1050 km from the origin to the estuary and a drop of 1787 46 m fig 3 shows the position of the studied hydropower system the annual average precipitation in the western part of wu river basin is about 1000 mm 1000 1200 mm in the central part and about 1400 mm in the southeast part the rainy season mostly occurs from may to october wu river is one of the main power sources of the west to east power transmission projects of china the studied cascaded system on wu river is on the main stem in guizhou province including hongjiadu dongfeng suofengying wujiangdu goupitan and silin reservoirs with a total installed capacity of 7195 mw inflow data from year 1953 to 2008 are used in solution and simulation and there are 12 56 networks to be trained in each round of ssdp computation table 1 shows the beneficial storages of hongjiadu and goupitan reservoirs are much large than the other reservoirs and they are main long term regulation reservoirs of the system the regulation abilities of other reservoirs are neglected in this study 7 2 numerical result the dddp ssdp and dnn ssdp are programmed using java language the penalty coefficient a and b in eq 11 are set to be 100 and 1000 respectively to test the proposed method two cascade firm power of 0 mw and 1900 mw are used respectively corresponding to the without firm power and with firm power cases in table 2 when the firm power is 0 mw the dddp is used to solve the deterministic model to obtain 1431twh of total energy then the operation rule is solved using ssdp and dnn ssdp respectively in the ssdp method the state set in one period includes 51 51 storage combinations as shown in fig 4 in the dnn ssdp method the initial state set includes the reservoir storage combinations in the dddp result and also includes the corner points of s 1 t s 2 t s 1 t s 2 t s 1 t s 2 t s 1 t s 2 t so at each period there are 60 storage combinations in the initial state set after obtaining the operation rule using the initial states through dnn ssdp the rule is used to simulate using historical data and 56 new storage combinations are obtained in the second round solution there are 116 states in each period similarly there are 172 states at each period in the third round solution the simulation results changed very little in further rounds of solution so the solution process is stopped in the ssdp run and each round of the dnn ssdp run the optimal decisions are obtained using recursive function eq 10 from period t to 1 for 5 times before convergence the simulated energy values of the operation rules obtained using two methods of ssdp and dnn ssdp are almost the same of 1382twh since there is no firm power constraint and the minimum outflow constraints are easy to be satisfied there is very little influence of penalty term on the fvf surfaces the fvf surfaces are simple and the dnn can accurately fit the simple fvf surfaces using a small state set and the operation result is almost the same as ssdp using a large state set while the solution time of dnn ssdp is only 18 of that of the common ssdp for the three rounds of computation of dnn ssdp there are totally 60 116 172 decisions in one period that need to be computed while for common ssdp there are 2601 decisions the computation time using dnn ssdp to solve decision is estimated to be about 14 of that of the common ssdp the other 4 time is used for network training when the firm power is set to be 1900 mw the computing process is the same as no firm power case black points in fig 5 are the initial states of dnn ssdp including the reservoir storage of the dddp result and four corner points in the wu river cascaded hydropower system the upstream hongjiadu reservoir has carryover year storage and the installed capacity is much smaller than the goupitan reservoir so the cascade firm power is satisfied through the drawing of the hongjiadu reservoir in most periods unless the reservoir level is very low while the reservoir level of goupitan reservoir is kept high unless the cascade firm power cannot be satisfied or there is spill risk in future periods so in fig 5 for months from august to october the reservoir level of the goupitan reservoir is close to the upper bound in most years in the months from january to april the degree of the reservoir level of the goupitan reservoir deviation from the upper bound gradually increases to satisfy cascade firm power and minimum outflow constraint the low values of the goupitan reservoir level in flood season are often to avoid spill in future periods for the hongjiadu reservoir the average reservoir level reaches the highest value in october and keeps decreasing to the next may and then swings from decreasing to increasing using the states in the first round of dnn ssdp an initial operation rule can be obtained table 3 shows the simulation results in each round of dnn ssdp for the model with firm power constraint through simulation using the rule the energy generation in the 56 years is 1378twh the average period shortage of firm power is 74 8 mw and the extreme period shortage is 1243 mw table 3 through including the simulation result into the state set the states added in the second round of dnn ssdp are shown as orange points in fig 5 in dry season months from november to april most of the new states are densely distributed in one area where the storage of the goupitan reservoir is smaller than the initial states while in other months the new states scatter in larger areas it is because that the initial states are not enough to obtain accurate future value surfaces there are some regions where the future value is relatively large and the obtained operation rule tends to lead the reservoir level to the regions in months from august to october some new states are near the upper bound of the reservoir level of hongjiadu reservoir while in the initial states this kind of states is very less for the initial states are obtained using a deterministic model knowing the future inflow the hongjiadu reservoir needs not to refill to a high reservoir level each year to store enough water for future use especially satisfying the cascade firm power while following the operation rule obtained using the stochastic model the hongjiadu reservoir tends to keep a high reservoir level after flood season for more years than in the deterministic model through simulation using the rule obtained in the second round the energy generation in the 56 years is 1377twh the average period shortage of firm power is 24 8 mw and the extreme period shortage is 727 mw table 3 before the third round the red points in fig 5 are added to the state set for the months of january march november and december the new points mainly distribute between the points of initial state points and the state points added in the second round computation tending to supplement the blank area for the months of february and april the new state points mainly distribute in the edge of the old state distributed area tending to extend distributed area during flood months the new state points distribute relatively evenly through simulation using the rule obtained in the third round the energy generation in the 56 years is 1376twh the average period shortage of firm power is 19 2 mw and the extreme period shortage is 690 mw table 3 the energy generation is a little less than and the average shortage is a little larger than those of common ssdp while the extreme period shortage is less than common ssdp the sum of squares of firm power shortage in all period is 3 7 106 for dnn ssdp a little smaller than that of common ssdp 3 9 106 the solution of the common ssdp can be considered to be approximate global optimal the simulation results illustrate that the solving accuracy of the dnn ssdp is very close to common ssdp while the total computation time of dnn ssdp is still about only 18 of that of common ssdp table 4 shows the average absolute value of the relative error of fvfs between two round solutions in table 3 and table 4 the fast convergence of the solution is shown fig 6 and fig 7 show the value surfaces fitted using the states in the last round of dnn ssdp computation and common ssdp respectively the shapes of the value surfaces at each month using the two methods are similar the main difference between the value surfaces is that in dry months the values of dnn ssdp are smaller than common ssdp in the region where both the reservoir levels of hongjiadu and goupitan are close to the lowest values for using dnn ssdp there are very few states in the regions in the initial state set in the simulation results using the first and second round dnn ssdp rules there is almost no new state emerges in the regions the objective value of the both 0 storage states in the corner is the smallest in each month and there are not enough states to lift the surface height like using common ssdp in which the states are vertical discretized in the regions fig 8 shows the total simulated power using dnn ssdp and common ssdp in most periods the simulated total power values are very close to each other using the two methods while in several flood months the total power values using dnn ssdp are significantly larger than using common ssdp it is because the decisions of the two methods have small differences in each period once the differences are continuously negative for several periods the accumulation of the differences results in significant differences in initial reservoir levels in one period and then significantly different decisions in the periods in most circumstances the decision differences offset each other in continuous periods so the total power values in most periods using the two methods are close to each other 8 conclusions and discussions to relieve the curse of dimensionality in solving multiple reservoir operation models simulation optimization artificial intelligence techniques and dimension reduction methods are three important ways in this paper based on ssdp they are combined in one method called dnn ssdp in the method an initial state set is generated using a deterministic model an ssdp model solves the operation model using the initial state set and the fvfs and decision functions of the ssdp are replaced by a series of dnns a simulation method obtains new state sets to be combined with the old ones in next round of ssdp solution from the result of the wu river hydropower system application it can be concluded that 1 the dnns well fit the fvfs and decision functions and make it possible to use irregularly distributed states compared to the vertically intersecting discretization of common ssdp 2 the initial state set is insufficient to reflect the characteristics of fvf and obtain accurate results while the newly obtained states correct the lack of representativeness of the old states 3 the proposed framework can effectively solve the operation model in 18 time of common ssdp 4 for the energy maximization model without and with firm power constraint the performances of dnn ssdp are almost the same or very close to that of common ssdp using artificial intelligence techniques seems to be a new alternative to reservoir operation research this study show that besides completely introducing some ai models or just taking the reservoir operation model as an example of an ai model application combining the advantages of optimization ai and characteristics of the reservoir operation problems is also a promising alternative credit authorship contribution statement xinyu wu conceptualization methodology software validation writing original draft funding acquisition zhiyong chen methodology software writing review editing visualization chuntian cheng resources writing review editing supervision shuai yin software writing review editing formal analysis huaying su resources writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the research work described in this paper is supported by the national nature science foundation of china 52179005 and 91647113 
2796,like many other regions in central europe germany experienced sequential summer droughts from 2015 to 2018 as one of the environmental consequences river nitrate concentrations have exhibited significant changes in many catchments however catchment nitrate responses to the changing weather conditions have not yet been mechanistically explored thus a fully distributed process based catchment nitrate model mhm nitrate was used to reveal the causal relations in the bode catchment of which river nitrate concentrations have experienced contrasting trends from upstream to downstream reaches the model was evaluated using data from six gauging stations reflecting different levels of runoff components and their associated nitrate mixing from upstream to downstream results indicated that the mhm nitrate model reproduced dynamics of daily discharge and nitrate concentration well with nash sutcliffe efficiency 0 73 for discharge and kling gupta efficiency 0 50 for nitrate concentration at most stations particularly the spatially contrasting trends of nitrate concentration were successfully captured by the model the decrease of nitrate concentration in the lowland area in drought years 2015 2018 was presumably due to 1 limited terrestrial export loading ca 40 lower than that of normal years 2004 2014 and 2 increased in stream retention efficiency 20 higher in summer within the whole river network from a mechanistic modelling perspective this study provided insights into spatially heterogeneous flow and nitrate dynamics and effects of sequential droughts which shed light on water quality responses to future climate change as droughts are projected to be more frequent keywords drought nitrate mixing catchment hydrology water quality model data availability data will be made available on request 1 introduction central europe recently experienced sequential droughts in 2013 2015 2018 and 2019 hanel et al 2018 hari et al 2020 and droughts are projected to become more frequent and severe in the future hari et al 2020 spinoni et al 2018 in germany mean annual temperature increased by 1 5 c from 1881 to 2018 with ca 0 3 c of that increase occurring from 2014 to 2018 uba 2019 using an ensemble of climate change scenarios huang et al 2015 reported that most rivers in germany will experience more frequent droughts excess nitrogen n input to surface water due to intensive anthropogenic activities e g fertiliser application from arable land wastewater from urban and industrial areas has caused widespread environmental problems in recent decades nitrate turnover processes at the catchment scale are expected to change due to climate change hesse and krysanova 2016 mosley 2015 whitehead et al 2009 especially due to an increase in drought events ballard et al 2019 zwolsman and van bokhoven 2007 the influence of drought on n dynamics has received increasing attention in recent decades e g baldwin et al 2005 lutz et al 2016 mosley 2015 van vliet and zwolsman 2008 whitehead et al 2009 yevenes et al 2018 zwolsman and van bokhoven 2007 previous studies have reported decreasing nitrate concentration in response to drought for example in the meuse river in western europe van vliet and zwolsman 2008 which was attributed to less diffuse input during drought periods during a drought in chile from 2010 to 2015 yevenes et al 2018 found that nitrate concentration did not change in the upstream part of a study catchment but decreased downstream due to differences in discharge regime and nitrate sources from upstream to downstream in line with these findings numerous studies have reported that droughts can have spatiotemporally varying impacts on nitrate transport and transformation processes due to the heterogeneous changes in hydrological processes within catchments e g leitner et al 2020 lintern et al 2018 lutz et al 2016 these studies are generally based on data driven and statistical analyses but conclusions drawn from them are site specific and often do not provide a full understanding of the factors that influence the effects of drought on nitrate dynamics and their spatial heterogeneity thus it is crucial to identify the mechanisms that underlie water quality trends under drought conditions to ensure future water quality and develop effective management strategies furthermore the scientific understanding gained from analysing deterministic trends can help to predict future trends however how sequential droughts influence stream nitrate responses has not yet been mechanistically explored catchment scale hydrological water quality models are an alternative solution to identify the relations between changing weather conditions and changes in nitrate dynamics these models can reproduce catchment nitrate dynamics and stream water concentrations well based on hydrological understanding which can be transferred across catchments or climate conditions jiang et al 2014 wellen et al 2015 process based water quality models are rarely used to investigate spatiotemporal effects of historical droughts on n concentrations at the catchment scale one of the challenges is to adequately represent the catchment spatial heterogeneity and the complexity of nitrate dynamic processes which can become more important during droughts rode et al 2010 wellen et al 2015 the fully distributed hydrological model mhm samaniego et al 2010 introduces flexible multiscale catchment discretization and parameterization techniques the mhm nitrate model was recently developed based on the hydrological mhm platform including advanced descriptions of terrestrial and in stream nitrate processes and consideration of agricultural management yang et al 2018 the model has shown a robust ability to provide reliable detailed information about terrestrial and in stream nitrate dynamics yang et al 2019a yang et al 2019b yang et al 2018 thus the model acts as a promising tool for mechanistic investigation of the impacts of drought on stream nitrate dynamics in this study we applied mhm nitrate to the bode catchment 3200 km2 central germany part of the german tereno observatories the catchment has large hydroclimatic geophysical and landscape gradients and has experienced sequential droughts in recent years 2015 2018 the objectives of the study were to i simulate spatiotemporal nitrate dynamics in a mesoscale catchment with widely differing meteorological and land use characteristics using the mhm nitrate model ii evaluate mhm nitrate s ability to represent recent drought induced trends in nitrate concentration and iii analyse mechanisms that influence spatiotemporally varying river nitrate concentrations under sequential droughts 2 materials and methods 2 1 study area the bode catchment is an intensively monitored and investigated mesoscale catchment in central germany wollschläger et al 2016 fig 1 the catchment includes the harz mountains in the southwest and lowland plains in the northeast elevation of the catchment ranges from 1142 m a s l at the brocken the highest peak of the harz mountains to 70 m a s l in the lowland area along the elevation gradient the catchment has large gradients of meteorological land use soil type and geological characteristics annual mean precipitation varies from more than 1500 mm at the brocken to ca 500 mm in the lowland wollschläger et al 2016 mean annual potential evapotranspiration is around 710 mm in the mountain area while it is about 810 mm in the lowland area mean annual temperature ranges from 5 c on the brocken to 9 5 c in the lowland with a minimum of 0 6 c 1 2 c in january and a maximum of 16 8 c 19 1 c in july in the mountain and lowland area respectively the bode catchment experienced sequential summer droughts from 2015 to 2018 according to the 3 month standardized precipitation evapotranspiration index vicente serrano et al 2010 fig s1 land use in the mountain area is dominated by forest with 10 pasture 8 agriculture and 7 urban areas and lakes the soil type in the harz mountains is dominated by cambisols land use in the lowland area is dominated by agriculture 81 whose main crops are winter wheat winter barley rapeseed and sugar beet forest and pasture cover 7 and 3 respectively and urban areas and small lakes cover the remaining 9 fig 1b chernozems are the main soil type in the lowland area to classify typical landscape nitrate leaching behaviour of agricultural soils five dominant soil classes were identified fig 1c according to the united states department of agriculture classification by combining soil properties and land use types sandy silt loam silty clay loam and loam in the mountain forest area n input is restricted to atmospheric deposition and nitrate export amounts in this area are very low we restricted the soil land use class n balance analysis to agricultural soils then these classes on the soil texture map were intersected with the land use map and the cells in which the area of the dominant soil land use class exceeded 80 of the cell s area were selected consequently the lowland area was classified into classes i iii which represented the dominant loess area silt loam soils riverine area loam soils and highly sandy area sandy soils respectively two representative classes in the mountain area were selected class iv which represented the mountain pasture area silty clay loam soils and class v which represented the mountain arable area sandy soils 2 2 data availability meteorological data were derived from the german weather service dwd including daily precipitation and daily mean temperature from 2000 to 2018 to create the meteorological forcing inputs for the model the dwd observations were spatially interpolated into 1 km 1 km grid data using the kriging method drifted by terrain elevation this method considers the orographic effect on precipitation and temperature by using the elevation as an external variable for the interpolation hundecha and bárdossy 2004 daily potential evapotranspiration data were calculated using the hargreaves and samani 1985 method at the same spatial resolution a terrain elevation model was obtained from the shuttle radar topography mission srtm sensor jarvis et al 2008 the digitized geological map and soil map both at a scale of 1 1 000 000 were obtained from the federal institute for geosciences and natural resources bgr https produktcenter bgr de last accessed 1 june 2020 land cover data were derived from corine land cover 10 ha https gdz bkg bund de index php default open data html last accessed 1 june 2020 these datasets were resampled to a spatial resolution of 100 m 100 m for model simulations data on mineral fertiliser and manure application rates and times as well as crop rotations on arable land were obtained from the model configuration of yang et al 2018 and agricultural authorities https llg sachsen anhalt de llg last accessed 10 april 2020 the total amount of fertiliser mineral fertiliser and manure applied depended on crop type and was assumed to be applied evenly throughout the fertilisation period the resolution of the crop rotation map was set to that of the land use map for technical simplification due to the lack of detailed information point source data were collected from urban wastewater treatment directive uwwtd sites for germany https uwwtd eu germany uwwtps treatment last accessed 10 april 2020 overall 29 wastewater treatment plants wwtps were considered fig 1a the original point source data were available only as annual total n load based on detailed authority data from large wastewater treatment plants outflow values of nh4 were always below 1 0 mg n l mostly below 0 1 mg n l and total no3 ranged between 2 and 12 mg n l higher nh4 n values correspond to higher no3 n values furthermore nh4 is quickly processed to no3 within the streams rahimi et al 2020 thus in our catchment nitrate is the main form of n from wwtps and the daily inputs were obtained by dividing annual total n load by the number of days in that year the percentage of point source n load which was calculated by dividing the annual total n load of the 29 wwtps by the observed annual nitrate n load at the catchment outlet station equalled only 12 of the total n load in the bode catchment during the study period daily discharge at six gauging stations meisdorf hausneindorf wegeleben nienhagen hadmersleben and stassfurt was provided by the state agency for flood protection and water management of saxony anhalt lhw https gldweb dhi wasy com gld portal last accessed 10 april 2020 nitrate concentration was measured twice weekly to twice monthly from 2000 to 2009 by lhw https gldweb dhi wasy com gld portal last accessed 10 april 2020 and daily from 2010 to 2018 by the helmholtz centre for environmental research ufz nitrate concentration observations were missing for 2015 and 2017 2018 at the wegeleben station and discharge observations were missing for 2017 2018 at the nienhagen station fig 1a 2 3 mhm nitrate model description the mhm nitrate model is a grid based catchment nitrate model that balances process complexity and model representation yang et al 2018 nitrate process descriptions come mainly from the hype model lindström et al 2010 with additional considerations of nitrate retention in deep groundwater spatially distributed crop rotations and time varying point source inputs the model includes the following hydrological processes canopy interception snow accumulation and melt evapotranspiration infiltration soil moisture dynamics runoff generation percolation and flood routing along the river network nitrate processes are fully integrated into the hydrological cycling major n inputs include wet atmospheric deposition via precipitation fertiliser and manure application and plant crop residues in each soil layer four n pools are defined i e active solid organic n inactive solid organic n dissolved organic n and dissolved inorganic n along with soil n processes of denitrification plant crop uptake and transformations among the four n pools in stream n transformations include denitrification primary production and mineralization governing equations of n transformations in the soil and the stream can be found in supplementary material text s1 more detailed descriptions of the mhm nitrate model can be found in yang et al 2018 and source code can be found in yang and rode 2020 2 4 model calibration and performance measurements the mhm nitrate model was set at a daily time step from 2000 to 2018 2000 2003 was considered a warm up period we used daily discharge and nitrate concentration data from 2010 to 2014 as calibration data the nitrate concentration data used to validate model predictions included twice weekly to twice monthly grab sampling data for 2004 2009 and daily data for 2015 2018 to minimize the influence of the rappbode reservoir in the upper bode river observed discharge and nitrate concentration at the thale station were used as the input flow and nitrate concentration when setting up the model before calibrating the model sensitivity analysis was performed to identify the most influential parameters using the morris method morris 1991 parameter samples were generated using radial based latin hypercube sampling and 200 trajectories were set to ensure convergence of the sensitivity analysis sensitivity indices absolute mean µ and standard deviation σ of each parameter s elementary effect were calculated using the safe tool sensitivity analysis for everybody pianosi et al 2015 the sensitivity ranking was obtained by plotting µ vs σ for all parameters the more to the right and top of the plot a point is located the more the parameter is influential and interrelated with other parameters respectively the dynamically dimensioned search dds method tolson and shoemaker 2007 was used to calibrate the most influential parameters with 50 000 iterations as the terminal criterion the detailed procedure of parameter sensitivity analysis and calibration can be found in yang et al 2018 the multi objective function for calibration consisted of multi criteria multi site and multi variable functions we selected the nash sutcliffe efficiency nse and the logarithm transformed nse lnnse as objective criteria in which the latter gives more weight to low values the combined nse and lnnse as objective criteria increase the potential to find a robust parameter set for both high flow and low flow in addition six internal gauging stations were considered to calibrate discharge and nitrate concentrations simultaneously with a weight aggregated multi variable function as follows 1 of mutil v m i n w q o f mutil s q w n of mutil s n where of mutil s q and of mutil s n denote multi site objective functions which are the unweighted sum of nse and lnnse across all six gauging stations for discharge and nitrate concentration respectively and w q 0 9 and w n 0 1 denote weights for discharge and nitrate concentration objectives respectively three goodness of fit metrics were used to evaluate model performance nse kling gupta efficiency kge and percentage bias pbias e g gupta et al 2009 moriasi et al 2015 2 5 trend analysis to further validate the mhm nitrate model capability to capture the trend caused by the drought we compared the trend components between observed and simulated discharge and nitrate concentration observed discharge and nitrate concentration time series at the six gauging stations were first aggregated into a monthly time step to minimize effects of different observation frequencies missing values in the observed nitrate time series were interpolated using the kalman smoothing method in the r package imputets version 4 0 2 r core team 2020 each time series y t i e monthly nitrate or discharge was then broken down into trend seasonality and random components using the following equation 2 y t t t s t e t where t t is the trend component s t is the seasonal component and e t is a random component which represents residuals the trend component was determined from a moving average with a symmetric window window size 19 using the stl function cleveland et al 1990 in the r package stats version 4 0 2 which has been successfully used to analyse seasonal and long term nitrate trends stow et al 2014 stow et al 2015 the stl algorithm consists of two iterative loops the inner and outer loops in the inner loop the time series is first de trended t t is extracted and smoothed with a local fitting with weights applied to the points that are fitted then the seasonal component is extracted using a low pass filter in the outer loop the residuals e t is used to create robustness weights for the next round of the inner loop these robustness weights reflect how extreme the residuals are as the outliers in the time series y t result in large residuals the outliers will have small or zero weight cleveland et al 1990 the trends of monthly discharge and nitrate concentration were then normalized using min max normalization the significance of normalized trend components of monthly discharge and nitrate concentration was analysed by using mann kendall trend test which was performed using the mk test function in the r package trend version 1 1 4 3 results 3 1 sensitivity results in this study the mhm nitrate model included 72 parameters 61 for hydrological processes and 11 for nitrate processes simultaneous parameter sensitivity analysis showed that hydrological predictions were the most sensitive fig 2 predictions of runoff were most sensitive to pet1 the terrain aspect correction of potential evapotranspiration sm10 the transfer function used to calculate soil saturated hydraulic conductivity and sm17 used to calculate the fraction of water that infiltrates through soil layers for nitrate submodel the most sensitive parameters were the in stream denitrification rate deni w for the entire bode stream network and two land use parameters deni as and deni s soil denitrification rate in the agricultural and non agricultural areas respectively table 1 in line with the results of yang et al 2018 and cuntz et al 2015 the two most influential parameters for hydrological predictions were pet1 and sm10 generally the larger the associated flux the more influential the parameter became cuntz et al 2015 because pet1 is directly related to evapotranspiration which is the largest flux after precipitation in the water balance equation it was more influential in summer parameter sm10 a multiplier for saturated hydraulic conductivity which influences the infiltration rate became more influential during precipitation and snowmelt the soil moisture related parameter sm17 was influential but it was not for yang et al 2018 which indicates a larger influence of infiltration in the lowland part of the bode catchment than in the selke sub catchment based on the sensitivity analysis the top ten hydrological parameters and top five nitrate parameters were selected for model calibration 3 2 model performance the mhm nitrate model reproduced the observed discharge and nitrate concentration at the six gauging stations reasonably well results for three typical gauging stations meisdorf hausneindorf and stassfurt are shown in this article while those for other stations can be found in the supplementary material these three stations reflect different combinations of dominant land use and weather conditions from the upstream to downstream parts of the bode catchment meisdorf represents a forest dominated area while hausneindorf represents a mixture of forest and agricultural areas ranging from mountains to lowlands in contrast stassfurt represents the whole catchment with a mixture of forest and agricultural areas daily discharge predictions fig 3 and goodness of fit metrics table 2 showed that mhm nitrate captured discharge dynamics well during both calibration 2010 2014 and validation 2004 2009 and 2015 2018 periods lowest nse of 0 76 and 0 73 respectively the model performed worse for the forest area than for the mixture of forest and agricultural areas for example the meisdorf station had the lowest performance during the calibration period kge and pbias of 0 64 and 14 1 respectively and the first validation period 2004 2009 kge and pbias of 0 66 and 17 respectively the model performed best for all stations during the second validation period 2015 2018 lowest nse and kge of 0 83 and 0 91 respectively largest pbias of 1 6 fig 3 table 2 the model represented seasonal dynamics in observed nitrate concentrations well fig 3 nitrate concentrations had similar seasonal patterns as discharge during the study period which reflects their control by hydrological processes in the forest area meisdorf station the model captured long term nitrate concentration dynamics 2004 2018 reasonably well lowest kge of 0 66 and largest pbias of 23 70 table 2 model performance decreased for mixed forest and agricultural areas as indicated by the lowest kge values for nitrate concentrations at the hausneindorf and nienhagen stations 0 21 and 0 11 respectively the model reproduced observed daily nitrate loads well for the meisdorf hausneindorf and stassfurt gauging stations with the lowest coefficient of determination r2 of 0 73 fig s2 the model reproduced observed daily loads better for mixed forest and agricultural areas represented by the hausneindorf and stassfurt stations r2 of 0 83 and 0 85 respectively the lower performance for simulated daily loads in the forest area i e meisdorf station can be explained by underestimating discharge during high flow periods fig 3a which resulted in underestimating daily nitrate loads fig s2a like simulated discharge the daily load was reproduced best during the second validation period 2015 2018 nse ranged from 0 81 to 0 92 and pbias ranged from 2 to 9 6 among the six gauging stations table 2 3 3 discharge and nitrate concentration trends to evaluate further the ability of mhm nitrate to simulate spatiotemporal nitrate dynamics in the bode catchment the trends of monthly mean observed and simulated nitrate concentrations at the three gauging stations were examined the three components of monthly mean observed nitrate concentration showed the influence of trend seasonal and random effects fig s3 the model captured the observed normalized monthly trends of nitrate concentration well fig 4 spearman s correlation coefficient of 0 54 0 83 and 0 82 for meisdorf hausneindorf and stassfurt respectively p 0 01 indicating that the model successfully represented temporal dynamics of nitrate concentration trends at the three gauging stations in addition during 2004 2018 nitrate concentration decreased significantly p 0 05 at hausneindorf but non significant at the meisdorf and stassfurt stations table s1 the trends of monthly mean observed discharge and nitrate concentration were normalized at the meisdorf hausneindorf and stassfurt gauging stations from 2004 to 2018 normalized trends of the monthly mean observed discharge and nitrate concentration were strongly correlated at meisdorf and stassfurt from 2004 to 2018 spearman s correlation coefficient of 0 65 and 0 59 respectively p 0 01 fig 5 which indicates that hydrology influenced nitrate concentration strongly 3 4 spatial heterogenous effects of drought on terrestrial nitrate export the heterogeneous spatial changes in runoff components and thus nitrate concentrations fig s6 resulted in high spatial variability in nitrate load exported from the terrestrial compartment fig 6 the mean annual nitrate load in total runoff showed a spatial pattern that clearly depended on land use fig 6c with the largest nitrate export from lowland agricultural area class i and mountain pasture area class iv ca 7 and 19 kg n ha 1 year 1 respectively fig s7 the mean annual nitrate load in baseflow showed a similar spatial pattern fig 6b vs 6c with a mean of 5 and 6 kg n ha 1 year 1 in classes i and iv respectively in the 2015 2018 drought period the nitrate load in total runoff decreased by a mean of 40 fig 6f mainly due to the decreased nitrate export loads from interflow and baseflow in the lowland area fig 6d e for example nitrate loads in interflow and baseflow decreased by 72 and 77 respectively in class ii but they increased in baseflow by 16 in class iv the increased nitrate load of interflow baseflow and total runoff in the mountain area during the drought period were due to higher nitrate concentration in interflow baseflow and total runoff in these areas fig s6n p 3 5 drought effects on n surplus among soil land use classes to identify the internal processes that influence nitrate dynamics in the bode catchment better soil n sources and sinks for the five soil land use classes were examined for the agriculture dominated lowland classes i iii the n source was mainly fertiliser including mineral fertiliser and mineralized organic manure which decreased slightly by 5 during the drought period compared to the pre drought period table 3 it is noteworthy that the decreased fertiliser is due to different crop rotations during the drought period compared to pre drought period crop uptake was the main n sink 83 90 of the total fertiliser amount in classes i iii and it decreased slightly ca 10 during the drought period compared to the pre drought period soil denitrification which can include denitrification in the upper groundwater when the water table is high decreased considerably in classes ii and iii by 28 and 43 respectively this was likely due to lower soil moisture induced by drought in the lowland which decreased crop uptake and soil denitrification during the drought period terrestrial export also decreased greatly in classes i iii therefore soil n surplus which equals input total fertiliser amount and precipitation deposition minus output crop plant uptake was higher in classes i ii by 4 4 and 3 1 kg n ha 1 y 1 respectively during the drought period than the pre drought period indicating that more n was stored in the soil in the lowland area during the drought period in the mountain area n sources and sinks in classes iv and v responded differently to drought than these of classes i iii table 3 the total amount of fertiliser in classes iv and v remained relatively constant during the drought period class iv had the lowest soil denitrification among the five classes perhaps due to lower total fertiliser amount and lower temperature in mountain pastures in addition soil denitrification and terrestrial export in classes iv and v did not change during the 2015 2018 drought period compared to the 2004 2014 period which indicates that drought had less effect in the mountain area 3 6 drought effects on in stream nitrate retention annual and seasonal mean lateral nitrate loading from terrestrial to streams decreased during the drought period compared to the pre drought period except for the streams upstream of meisdorf table 4 lateral nitrate loading reduced by 41 and 44 in summer and autumn within the whole river network meanwhile in stream retention amount decreased by 20 and 16 respectively plausibly due to smaller stream benthic area and lower nitrate concentrations during the drought period lateral nitrate loading reduced more than that of in stream retention during the drought period and this resulted in a higher in stream retention efficiency table 4 4 discussion 4 1 model performance evaluation the mhm nitrate model reproduced the observed discharge throughout the bode catchment well mean nse of 0 85 and pbias 20 according to guidelines for evaluating the performance of catchment simulations moriasi et al 2015 this accuracy is similar to those of previous simulations of the study area e g mueller et al 2016 nguyen et al 2021 yang et al 2018 comparing the three representative gauging stations the performance at the meisdorf station was relatively low as indicated by lower nse and kge table 1 perhaps due to underestimating peak flow events and the high sensitivity of nse to extreme values e g krause et al 2005 similarly the low kge was likely due to underestimating high flow values in 2010 2013 and 2014 fig 3a the model may have underestimated peak flow events because of the inaccurately measured precipitation and the lower density of meteorological stations specifically daily precipitation is not sufficiently precise to represent a detailed discharge response especially in the headwater of the bode catchment due to high heterogeneity in precipitation where many storm events last only a few hours moreover the spatial coverage of the meteorological stations decreased significantly during the recent period especially in the mountain area of the catchment for example the number of precipitation gauging stations in the selke sub catchment decreased from 16 to only 8 after 2004 yang et al 2018 generally the decrease in detailed precipitation records decreased performance in predicting discharge in the headwater area which is known for its high spatiotemporal variability in precipitation due to the varying elevation therefore the less accurate precipitation inputs from the lower station density could explain the slight underestimate of water balance at meisdorf pbias of 14 and 17 for the calibration and first validation period respectively however the model slightly overestimated the water balance for the hausneindorf station during the first validation period table 2 jiang et al 2014 and winter et al 2021 stated that water from the lower selke river was abstracted to fill pit lakes from 1998 to 2009 at a rate of 3 1 million m3 year 1 which was ca 8 of the mean annual stream flow from 2004 to 2009 although the water balance remained overestimated after considering this abstraction these overestimates occurred mainly during the low flow period and were acceptable when the corresponding runoff depth was considered i e the largest pbias of 15 5 at hausneindorf corresponded to a runoff depth of only 12 8 mm year although nse values were negative at hausneindorf and nienhagen stations during validation periods table 2 due to few extreme values krause et al 2005 moriasi et al 2015 with regard to the kge and pbias values at these two stations the model performance was acceptable the slightly lower performance of mhm nitrate at the hausneindorf and nienhagen stations than at the other stations was likely due to the lack of detailed time series of point sources from urban areas during the low flow period especially in the initial period of operation of the wwtps as they started to function properly only in 2007 yang et al 2018 the high nitrate concentrations during summers before 2007 fig 3b were likely caused by untreated point sources as discussed in yang et al 2018 after 2007 the model captured the dynamics of nitrate concentration well at hausneindorf station in addition some houses mainly summer houses in the selke sub catchment are not connected to the sewage system which may generate additional unknown point sources and can decrease model performance under low flow conditions the lack of detailed spatial cropping information for the entire bode catchment and the need to rely on only rough survey information might introduce additional uncertainty nevertheless mhm nitrate successfully identified decreasing trends in observed nitrate concentrations at the hausneindorf and stassfurt lowland stations figs 3 and 4 the model performance was in line with that of yang et al 2018 in the selke sub catchment and they also confirmed that the simulations based on dds calibration performed similarly good with that of using the dream method the model can represent observed nitrate concentrations well for several reasons first its flexible structure ensures sufficient spatial representation of catchment heterogeneity as well as spatiotemporal variability in meteorological inputs kumar et al 2010 samaniego et al 2010 yang et al 2018 in addition it can adequately represent the diffuse source inputs and turnover i e agricultural practices crop rotation and plant uptake and point source contributions input time series can be added at the real stream locations at the resolution of the input data which increases the model s ability to represent spatial variability in nitrate sources yang et al 2018 selecting an appropriate calibration period under varying conditions e g at nonstationary conditions like the drought is crucial for model training for example during the calibration period 2011 was a wetter year while 2012 was a drier year thus selecting a calibration period that encompasses varying hydrological conditions helps activate all model components this approach agrees with engel et al 2007 who suggested that both calibration and validation periods should have high and low flows to increase a model s robustness together these characteristics helped to identify model parameters better and reliably estimate nitrate contributions from different runoff components which is crucial for representing nitrate concentrations spatiotemporally in the entire bode catchment the most influential nitrate sub model parameter was related to in stream denitrification while in the study of yang et al 2018 which focused more on upstream catchments the most influential parameter was related to soil denitrification this is presumably due to the larger total stream benthic areas for the bode catchment which is in line with yang et al 2019b who found that there is a significant relationship between stream benthic area and in stream denitrification rate reflecting the relative increasing importance of in stream processes with increasing catchment size 4 2 explaining changes in nitrate concentration during drought years recent droughts 2015 2018 in the bode catchment provided an opportunity to investigate the internal processes that influence nitrate dynamics under changing weather conditions at the catchment scale observed nitrate concentration showed a decreasing trend in lowland agricultural areas i e hausneindorf and stassfurt stations but not significant in the mountain forest area i e meisdorf station fig 4 results suggested that the influence of drought on nitrate concentration could be explained by i spatiotemporal differences in hydrological response and ii its associated effects on soil and in stream nitrate processes during the 2015 2018 drought period compared to the 2004 2014 pre drought period seasonal total runoff decreased in the entire bode catchment during the drought period fig s8m p the decrease was larger in the lowland area due to the combined effects of meteorology and soil properties annual precipitation in the 2015 2018 drought period did not differ greatly from that in long term historical records 1971 2000 from dwd when considering the temporal distribution of precipitation however precipitation decreased greatly in winter and spring in the lowland agricultural area during the drought period especially in class ii by 25 and 30 respectively fig s8a b soil moisture decreased continuously in all seasons and was not replenished during the rewetting seasons due to reduced precipitation in the lowland area fig s8i l in addition the modeled soil moisture of the third layer in classes i iii showed a significant decline during drought period fig s9 consequently this process could decrease unsaturated zone storage and groundwater recharge during the drought period this further explains the decrease in mean annual interflow baseflow and total runoff in the lowland area during the 2015 2018 drought period compared to 2004 2014 furthermore the decrease in soil moisture content may have decreased hydrological connectivity between hillslope and streams during the drought period fig s6f h thus increasing the potential for soil profiles to become disconnected from the stream channel and shallow groundwater davis et al 2014 outram et al 2016 in contrast total runoff in the mountain area decreased only slightly during the drought period perhaps due to seasonal precipitation and slightly decreased soil moisture content there fig s8 this result agrees with other studies that reported that flatter and less forested catchments are more vulnerable to long term drought saft et al 2015 the large decrease in nitrate concentration in the lowland area during the drought period represented by the hausneindorf and stassfurt stations fig 4b c was plausible because the decrease in interflow baseflow and total runoff in classes i iii greatly reduced soil nitrate export from interflow and baseflow which are the major source of the terrestrial nitrate export to surface water fig 6d f table 3 this indicates that nitrate became more transport limited in the lowland area during the drought period in addition upstream discharge with low nitrate concentration could dilute downstream nitrate concentration the share of discharge from uplands sum of discharge at thale and meisdorf station to the total discharge at the outlet of the bode catchment increased from 44 3 to 48 8 from the pre drought period to the drought period furthermore drought increased water temperatures and longer stream water residence time in summer could have stimulated in stream uptake and denitrification efficiency table 4 hosen et al 2019 rode et al 2016 therefore the combined effects of terrestrial export load and in stream processes could explain the decrease of in stream nitrate concentrations in lowland areas e g at the hausneindorf and stassfurt stations in fig 4b c in contrast nitrate concentration in the mountain forest dominated area showed a constant pattern during the drought period compared to the pre drought period as reflected by the meisdorf station fig 3a and 4a this pattern could have occurred because the share of discharge from high nitrate concentration agricultural areas and low nitrate concentration forest areas did not change substantially fig 6 and table 3 nitrate source in the mountain forest dominated area comes mainly from patches of agricultural area which decreased slightly during the drought period in class iv table 3 although total runoff increased in the mountain area in winter during the drought period in stream nitrate concentrations were similar to those during the pre drought period fig s8m vs 3a in addition in stream retention in winter was low and did not influence nitrate concentration which indicated that nitrate could be supply limited in the mountain area previous studies have reported a decrease in stream nitrate concentrations during droughts e g van vliet and zwolsman 2008 yevenes et al 2018 they also explained the decrease in nitrate concentration by less diffuse supply based on empirical relations between nitrate concentration and discharge our study confirmed this explanation by simulating a large decrease in soil nitrate export in the lowland area during the drought period fig 6 5 conclusion varying spatial trends in nitrate concentration under drought conditions were observed in the bode catchment in central germany to explain the mechanisms that influence the changes in trends calibrated mhm nitrate model outputs and internal processes were compared between a drought period 2015 2018 and a pre drought period 2004 2014 results indicated that nitrate export from the terrestrial compartment greatly decreased while in stream retention efficiency increased during the drought periods which could result in the decrease of in stream nitrate concentration in the lowland area of the bode catchment in contrast nitrate export and in stream retention efficiency in the upper mountain area of the catchment changed little therefore nitrate concentrations remained relatively constant in the drought and pre drought periods results suggested that during the drought periods nitrate was mainly stored in the soil rather than mobilized or transported especially in the lowland area of the catchment this study assessed the model s ability to represent nitrate concentrations under varying weather conditions which could be used to study the effects of climate change the bode catchment is a typical mesoscale catchment in central europe in which the headwater is a mountain area with high precipitation and the lowland is an agricultural area with relatively low precipitation we expect that catchments with landscape and climate conditions similar to those of the bode catchment i e wet mountain areas and dry lowland areas are highly vulnerable to changing weather conditions this study showed that droughts have heterogeneous spatial effects on hydrology and water quality responses therefore water managers should specifically consider this spatial heterogeneity when managing future droughts credit authorship contribution statement xiangqian zhou conceptualization methodology formal analysis investigation writing original draft seifeddine jomaa data curation supervision writing review editing xiaoqiang yang software validation writing review editing ralf merz supervision investigation writing review editing yanping wang visualization writing review editing michael rode resources supervision investigation writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements x zhou is funded by the chinese scholarship council csc we thank the german weather service dwd federal institute for geosciences and natural resources bgr and state agency for flood protection and water management of saxony anhalt lhw for providing meteorological geological and discharge and water quality data respectively the high frequency nitrate concentration data were provided by the tereno terrestrial environment observatories project data availability statement the model code of mhm nitrate is publicly available at https zenodo org record 3891629 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128615 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2796,like many other regions in central europe germany experienced sequential summer droughts from 2015 to 2018 as one of the environmental consequences river nitrate concentrations have exhibited significant changes in many catchments however catchment nitrate responses to the changing weather conditions have not yet been mechanistically explored thus a fully distributed process based catchment nitrate model mhm nitrate was used to reveal the causal relations in the bode catchment of which river nitrate concentrations have experienced contrasting trends from upstream to downstream reaches the model was evaluated using data from six gauging stations reflecting different levels of runoff components and their associated nitrate mixing from upstream to downstream results indicated that the mhm nitrate model reproduced dynamics of daily discharge and nitrate concentration well with nash sutcliffe efficiency 0 73 for discharge and kling gupta efficiency 0 50 for nitrate concentration at most stations particularly the spatially contrasting trends of nitrate concentration were successfully captured by the model the decrease of nitrate concentration in the lowland area in drought years 2015 2018 was presumably due to 1 limited terrestrial export loading ca 40 lower than that of normal years 2004 2014 and 2 increased in stream retention efficiency 20 higher in summer within the whole river network from a mechanistic modelling perspective this study provided insights into spatially heterogeneous flow and nitrate dynamics and effects of sequential droughts which shed light on water quality responses to future climate change as droughts are projected to be more frequent keywords drought nitrate mixing catchment hydrology water quality model data availability data will be made available on request 1 introduction central europe recently experienced sequential droughts in 2013 2015 2018 and 2019 hanel et al 2018 hari et al 2020 and droughts are projected to become more frequent and severe in the future hari et al 2020 spinoni et al 2018 in germany mean annual temperature increased by 1 5 c from 1881 to 2018 with ca 0 3 c of that increase occurring from 2014 to 2018 uba 2019 using an ensemble of climate change scenarios huang et al 2015 reported that most rivers in germany will experience more frequent droughts excess nitrogen n input to surface water due to intensive anthropogenic activities e g fertiliser application from arable land wastewater from urban and industrial areas has caused widespread environmental problems in recent decades nitrate turnover processes at the catchment scale are expected to change due to climate change hesse and krysanova 2016 mosley 2015 whitehead et al 2009 especially due to an increase in drought events ballard et al 2019 zwolsman and van bokhoven 2007 the influence of drought on n dynamics has received increasing attention in recent decades e g baldwin et al 2005 lutz et al 2016 mosley 2015 van vliet and zwolsman 2008 whitehead et al 2009 yevenes et al 2018 zwolsman and van bokhoven 2007 previous studies have reported decreasing nitrate concentration in response to drought for example in the meuse river in western europe van vliet and zwolsman 2008 which was attributed to less diffuse input during drought periods during a drought in chile from 2010 to 2015 yevenes et al 2018 found that nitrate concentration did not change in the upstream part of a study catchment but decreased downstream due to differences in discharge regime and nitrate sources from upstream to downstream in line with these findings numerous studies have reported that droughts can have spatiotemporally varying impacts on nitrate transport and transformation processes due to the heterogeneous changes in hydrological processes within catchments e g leitner et al 2020 lintern et al 2018 lutz et al 2016 these studies are generally based on data driven and statistical analyses but conclusions drawn from them are site specific and often do not provide a full understanding of the factors that influence the effects of drought on nitrate dynamics and their spatial heterogeneity thus it is crucial to identify the mechanisms that underlie water quality trends under drought conditions to ensure future water quality and develop effective management strategies furthermore the scientific understanding gained from analysing deterministic trends can help to predict future trends however how sequential droughts influence stream nitrate responses has not yet been mechanistically explored catchment scale hydrological water quality models are an alternative solution to identify the relations between changing weather conditions and changes in nitrate dynamics these models can reproduce catchment nitrate dynamics and stream water concentrations well based on hydrological understanding which can be transferred across catchments or climate conditions jiang et al 2014 wellen et al 2015 process based water quality models are rarely used to investigate spatiotemporal effects of historical droughts on n concentrations at the catchment scale one of the challenges is to adequately represent the catchment spatial heterogeneity and the complexity of nitrate dynamic processes which can become more important during droughts rode et al 2010 wellen et al 2015 the fully distributed hydrological model mhm samaniego et al 2010 introduces flexible multiscale catchment discretization and parameterization techniques the mhm nitrate model was recently developed based on the hydrological mhm platform including advanced descriptions of terrestrial and in stream nitrate processes and consideration of agricultural management yang et al 2018 the model has shown a robust ability to provide reliable detailed information about terrestrial and in stream nitrate dynamics yang et al 2019a yang et al 2019b yang et al 2018 thus the model acts as a promising tool for mechanistic investigation of the impacts of drought on stream nitrate dynamics in this study we applied mhm nitrate to the bode catchment 3200 km2 central germany part of the german tereno observatories the catchment has large hydroclimatic geophysical and landscape gradients and has experienced sequential droughts in recent years 2015 2018 the objectives of the study were to i simulate spatiotemporal nitrate dynamics in a mesoscale catchment with widely differing meteorological and land use characteristics using the mhm nitrate model ii evaluate mhm nitrate s ability to represent recent drought induced trends in nitrate concentration and iii analyse mechanisms that influence spatiotemporally varying river nitrate concentrations under sequential droughts 2 materials and methods 2 1 study area the bode catchment is an intensively monitored and investigated mesoscale catchment in central germany wollschläger et al 2016 fig 1 the catchment includes the harz mountains in the southwest and lowland plains in the northeast elevation of the catchment ranges from 1142 m a s l at the brocken the highest peak of the harz mountains to 70 m a s l in the lowland area along the elevation gradient the catchment has large gradients of meteorological land use soil type and geological characteristics annual mean precipitation varies from more than 1500 mm at the brocken to ca 500 mm in the lowland wollschläger et al 2016 mean annual potential evapotranspiration is around 710 mm in the mountain area while it is about 810 mm in the lowland area mean annual temperature ranges from 5 c on the brocken to 9 5 c in the lowland with a minimum of 0 6 c 1 2 c in january and a maximum of 16 8 c 19 1 c in july in the mountain and lowland area respectively the bode catchment experienced sequential summer droughts from 2015 to 2018 according to the 3 month standardized precipitation evapotranspiration index vicente serrano et al 2010 fig s1 land use in the mountain area is dominated by forest with 10 pasture 8 agriculture and 7 urban areas and lakes the soil type in the harz mountains is dominated by cambisols land use in the lowland area is dominated by agriculture 81 whose main crops are winter wheat winter barley rapeseed and sugar beet forest and pasture cover 7 and 3 respectively and urban areas and small lakes cover the remaining 9 fig 1b chernozems are the main soil type in the lowland area to classify typical landscape nitrate leaching behaviour of agricultural soils five dominant soil classes were identified fig 1c according to the united states department of agriculture classification by combining soil properties and land use types sandy silt loam silty clay loam and loam in the mountain forest area n input is restricted to atmospheric deposition and nitrate export amounts in this area are very low we restricted the soil land use class n balance analysis to agricultural soils then these classes on the soil texture map were intersected with the land use map and the cells in which the area of the dominant soil land use class exceeded 80 of the cell s area were selected consequently the lowland area was classified into classes i iii which represented the dominant loess area silt loam soils riverine area loam soils and highly sandy area sandy soils respectively two representative classes in the mountain area were selected class iv which represented the mountain pasture area silty clay loam soils and class v which represented the mountain arable area sandy soils 2 2 data availability meteorological data were derived from the german weather service dwd including daily precipitation and daily mean temperature from 2000 to 2018 to create the meteorological forcing inputs for the model the dwd observations were spatially interpolated into 1 km 1 km grid data using the kriging method drifted by terrain elevation this method considers the orographic effect on precipitation and temperature by using the elevation as an external variable for the interpolation hundecha and bárdossy 2004 daily potential evapotranspiration data were calculated using the hargreaves and samani 1985 method at the same spatial resolution a terrain elevation model was obtained from the shuttle radar topography mission srtm sensor jarvis et al 2008 the digitized geological map and soil map both at a scale of 1 1 000 000 were obtained from the federal institute for geosciences and natural resources bgr https produktcenter bgr de last accessed 1 june 2020 land cover data were derived from corine land cover 10 ha https gdz bkg bund de index php default open data html last accessed 1 june 2020 these datasets were resampled to a spatial resolution of 100 m 100 m for model simulations data on mineral fertiliser and manure application rates and times as well as crop rotations on arable land were obtained from the model configuration of yang et al 2018 and agricultural authorities https llg sachsen anhalt de llg last accessed 10 april 2020 the total amount of fertiliser mineral fertiliser and manure applied depended on crop type and was assumed to be applied evenly throughout the fertilisation period the resolution of the crop rotation map was set to that of the land use map for technical simplification due to the lack of detailed information point source data were collected from urban wastewater treatment directive uwwtd sites for germany https uwwtd eu germany uwwtps treatment last accessed 10 april 2020 overall 29 wastewater treatment plants wwtps were considered fig 1a the original point source data were available only as annual total n load based on detailed authority data from large wastewater treatment plants outflow values of nh4 were always below 1 0 mg n l mostly below 0 1 mg n l and total no3 ranged between 2 and 12 mg n l higher nh4 n values correspond to higher no3 n values furthermore nh4 is quickly processed to no3 within the streams rahimi et al 2020 thus in our catchment nitrate is the main form of n from wwtps and the daily inputs were obtained by dividing annual total n load by the number of days in that year the percentage of point source n load which was calculated by dividing the annual total n load of the 29 wwtps by the observed annual nitrate n load at the catchment outlet station equalled only 12 of the total n load in the bode catchment during the study period daily discharge at six gauging stations meisdorf hausneindorf wegeleben nienhagen hadmersleben and stassfurt was provided by the state agency for flood protection and water management of saxony anhalt lhw https gldweb dhi wasy com gld portal last accessed 10 april 2020 nitrate concentration was measured twice weekly to twice monthly from 2000 to 2009 by lhw https gldweb dhi wasy com gld portal last accessed 10 april 2020 and daily from 2010 to 2018 by the helmholtz centre for environmental research ufz nitrate concentration observations were missing for 2015 and 2017 2018 at the wegeleben station and discharge observations were missing for 2017 2018 at the nienhagen station fig 1a 2 3 mhm nitrate model description the mhm nitrate model is a grid based catchment nitrate model that balances process complexity and model representation yang et al 2018 nitrate process descriptions come mainly from the hype model lindström et al 2010 with additional considerations of nitrate retention in deep groundwater spatially distributed crop rotations and time varying point source inputs the model includes the following hydrological processes canopy interception snow accumulation and melt evapotranspiration infiltration soil moisture dynamics runoff generation percolation and flood routing along the river network nitrate processes are fully integrated into the hydrological cycling major n inputs include wet atmospheric deposition via precipitation fertiliser and manure application and plant crop residues in each soil layer four n pools are defined i e active solid organic n inactive solid organic n dissolved organic n and dissolved inorganic n along with soil n processes of denitrification plant crop uptake and transformations among the four n pools in stream n transformations include denitrification primary production and mineralization governing equations of n transformations in the soil and the stream can be found in supplementary material text s1 more detailed descriptions of the mhm nitrate model can be found in yang et al 2018 and source code can be found in yang and rode 2020 2 4 model calibration and performance measurements the mhm nitrate model was set at a daily time step from 2000 to 2018 2000 2003 was considered a warm up period we used daily discharge and nitrate concentration data from 2010 to 2014 as calibration data the nitrate concentration data used to validate model predictions included twice weekly to twice monthly grab sampling data for 2004 2009 and daily data for 2015 2018 to minimize the influence of the rappbode reservoir in the upper bode river observed discharge and nitrate concentration at the thale station were used as the input flow and nitrate concentration when setting up the model before calibrating the model sensitivity analysis was performed to identify the most influential parameters using the morris method morris 1991 parameter samples were generated using radial based latin hypercube sampling and 200 trajectories were set to ensure convergence of the sensitivity analysis sensitivity indices absolute mean µ and standard deviation σ of each parameter s elementary effect were calculated using the safe tool sensitivity analysis for everybody pianosi et al 2015 the sensitivity ranking was obtained by plotting µ vs σ for all parameters the more to the right and top of the plot a point is located the more the parameter is influential and interrelated with other parameters respectively the dynamically dimensioned search dds method tolson and shoemaker 2007 was used to calibrate the most influential parameters with 50 000 iterations as the terminal criterion the detailed procedure of parameter sensitivity analysis and calibration can be found in yang et al 2018 the multi objective function for calibration consisted of multi criteria multi site and multi variable functions we selected the nash sutcliffe efficiency nse and the logarithm transformed nse lnnse as objective criteria in which the latter gives more weight to low values the combined nse and lnnse as objective criteria increase the potential to find a robust parameter set for both high flow and low flow in addition six internal gauging stations were considered to calibrate discharge and nitrate concentrations simultaneously with a weight aggregated multi variable function as follows 1 of mutil v m i n w q o f mutil s q w n of mutil s n where of mutil s q and of mutil s n denote multi site objective functions which are the unweighted sum of nse and lnnse across all six gauging stations for discharge and nitrate concentration respectively and w q 0 9 and w n 0 1 denote weights for discharge and nitrate concentration objectives respectively three goodness of fit metrics were used to evaluate model performance nse kling gupta efficiency kge and percentage bias pbias e g gupta et al 2009 moriasi et al 2015 2 5 trend analysis to further validate the mhm nitrate model capability to capture the trend caused by the drought we compared the trend components between observed and simulated discharge and nitrate concentration observed discharge and nitrate concentration time series at the six gauging stations were first aggregated into a monthly time step to minimize effects of different observation frequencies missing values in the observed nitrate time series were interpolated using the kalman smoothing method in the r package imputets version 4 0 2 r core team 2020 each time series y t i e monthly nitrate or discharge was then broken down into trend seasonality and random components using the following equation 2 y t t t s t e t where t t is the trend component s t is the seasonal component and e t is a random component which represents residuals the trend component was determined from a moving average with a symmetric window window size 19 using the stl function cleveland et al 1990 in the r package stats version 4 0 2 which has been successfully used to analyse seasonal and long term nitrate trends stow et al 2014 stow et al 2015 the stl algorithm consists of two iterative loops the inner and outer loops in the inner loop the time series is first de trended t t is extracted and smoothed with a local fitting with weights applied to the points that are fitted then the seasonal component is extracted using a low pass filter in the outer loop the residuals e t is used to create robustness weights for the next round of the inner loop these robustness weights reflect how extreme the residuals are as the outliers in the time series y t result in large residuals the outliers will have small or zero weight cleveland et al 1990 the trends of monthly discharge and nitrate concentration were then normalized using min max normalization the significance of normalized trend components of monthly discharge and nitrate concentration was analysed by using mann kendall trend test which was performed using the mk test function in the r package trend version 1 1 4 3 results 3 1 sensitivity results in this study the mhm nitrate model included 72 parameters 61 for hydrological processes and 11 for nitrate processes simultaneous parameter sensitivity analysis showed that hydrological predictions were the most sensitive fig 2 predictions of runoff were most sensitive to pet1 the terrain aspect correction of potential evapotranspiration sm10 the transfer function used to calculate soil saturated hydraulic conductivity and sm17 used to calculate the fraction of water that infiltrates through soil layers for nitrate submodel the most sensitive parameters were the in stream denitrification rate deni w for the entire bode stream network and two land use parameters deni as and deni s soil denitrification rate in the agricultural and non agricultural areas respectively table 1 in line with the results of yang et al 2018 and cuntz et al 2015 the two most influential parameters for hydrological predictions were pet1 and sm10 generally the larger the associated flux the more influential the parameter became cuntz et al 2015 because pet1 is directly related to evapotranspiration which is the largest flux after precipitation in the water balance equation it was more influential in summer parameter sm10 a multiplier for saturated hydraulic conductivity which influences the infiltration rate became more influential during precipitation and snowmelt the soil moisture related parameter sm17 was influential but it was not for yang et al 2018 which indicates a larger influence of infiltration in the lowland part of the bode catchment than in the selke sub catchment based on the sensitivity analysis the top ten hydrological parameters and top five nitrate parameters were selected for model calibration 3 2 model performance the mhm nitrate model reproduced the observed discharge and nitrate concentration at the six gauging stations reasonably well results for three typical gauging stations meisdorf hausneindorf and stassfurt are shown in this article while those for other stations can be found in the supplementary material these three stations reflect different combinations of dominant land use and weather conditions from the upstream to downstream parts of the bode catchment meisdorf represents a forest dominated area while hausneindorf represents a mixture of forest and agricultural areas ranging from mountains to lowlands in contrast stassfurt represents the whole catchment with a mixture of forest and agricultural areas daily discharge predictions fig 3 and goodness of fit metrics table 2 showed that mhm nitrate captured discharge dynamics well during both calibration 2010 2014 and validation 2004 2009 and 2015 2018 periods lowest nse of 0 76 and 0 73 respectively the model performed worse for the forest area than for the mixture of forest and agricultural areas for example the meisdorf station had the lowest performance during the calibration period kge and pbias of 0 64 and 14 1 respectively and the first validation period 2004 2009 kge and pbias of 0 66 and 17 respectively the model performed best for all stations during the second validation period 2015 2018 lowest nse and kge of 0 83 and 0 91 respectively largest pbias of 1 6 fig 3 table 2 the model represented seasonal dynamics in observed nitrate concentrations well fig 3 nitrate concentrations had similar seasonal patterns as discharge during the study period which reflects their control by hydrological processes in the forest area meisdorf station the model captured long term nitrate concentration dynamics 2004 2018 reasonably well lowest kge of 0 66 and largest pbias of 23 70 table 2 model performance decreased for mixed forest and agricultural areas as indicated by the lowest kge values for nitrate concentrations at the hausneindorf and nienhagen stations 0 21 and 0 11 respectively the model reproduced observed daily nitrate loads well for the meisdorf hausneindorf and stassfurt gauging stations with the lowest coefficient of determination r2 of 0 73 fig s2 the model reproduced observed daily loads better for mixed forest and agricultural areas represented by the hausneindorf and stassfurt stations r2 of 0 83 and 0 85 respectively the lower performance for simulated daily loads in the forest area i e meisdorf station can be explained by underestimating discharge during high flow periods fig 3a which resulted in underestimating daily nitrate loads fig s2a like simulated discharge the daily load was reproduced best during the second validation period 2015 2018 nse ranged from 0 81 to 0 92 and pbias ranged from 2 to 9 6 among the six gauging stations table 2 3 3 discharge and nitrate concentration trends to evaluate further the ability of mhm nitrate to simulate spatiotemporal nitrate dynamics in the bode catchment the trends of monthly mean observed and simulated nitrate concentrations at the three gauging stations were examined the three components of monthly mean observed nitrate concentration showed the influence of trend seasonal and random effects fig s3 the model captured the observed normalized monthly trends of nitrate concentration well fig 4 spearman s correlation coefficient of 0 54 0 83 and 0 82 for meisdorf hausneindorf and stassfurt respectively p 0 01 indicating that the model successfully represented temporal dynamics of nitrate concentration trends at the three gauging stations in addition during 2004 2018 nitrate concentration decreased significantly p 0 05 at hausneindorf but non significant at the meisdorf and stassfurt stations table s1 the trends of monthly mean observed discharge and nitrate concentration were normalized at the meisdorf hausneindorf and stassfurt gauging stations from 2004 to 2018 normalized trends of the monthly mean observed discharge and nitrate concentration were strongly correlated at meisdorf and stassfurt from 2004 to 2018 spearman s correlation coefficient of 0 65 and 0 59 respectively p 0 01 fig 5 which indicates that hydrology influenced nitrate concentration strongly 3 4 spatial heterogenous effects of drought on terrestrial nitrate export the heterogeneous spatial changes in runoff components and thus nitrate concentrations fig s6 resulted in high spatial variability in nitrate load exported from the terrestrial compartment fig 6 the mean annual nitrate load in total runoff showed a spatial pattern that clearly depended on land use fig 6c with the largest nitrate export from lowland agricultural area class i and mountain pasture area class iv ca 7 and 19 kg n ha 1 year 1 respectively fig s7 the mean annual nitrate load in baseflow showed a similar spatial pattern fig 6b vs 6c with a mean of 5 and 6 kg n ha 1 year 1 in classes i and iv respectively in the 2015 2018 drought period the nitrate load in total runoff decreased by a mean of 40 fig 6f mainly due to the decreased nitrate export loads from interflow and baseflow in the lowland area fig 6d e for example nitrate loads in interflow and baseflow decreased by 72 and 77 respectively in class ii but they increased in baseflow by 16 in class iv the increased nitrate load of interflow baseflow and total runoff in the mountain area during the drought period were due to higher nitrate concentration in interflow baseflow and total runoff in these areas fig s6n p 3 5 drought effects on n surplus among soil land use classes to identify the internal processes that influence nitrate dynamics in the bode catchment better soil n sources and sinks for the five soil land use classes were examined for the agriculture dominated lowland classes i iii the n source was mainly fertiliser including mineral fertiliser and mineralized organic manure which decreased slightly by 5 during the drought period compared to the pre drought period table 3 it is noteworthy that the decreased fertiliser is due to different crop rotations during the drought period compared to pre drought period crop uptake was the main n sink 83 90 of the total fertiliser amount in classes i iii and it decreased slightly ca 10 during the drought period compared to the pre drought period soil denitrification which can include denitrification in the upper groundwater when the water table is high decreased considerably in classes ii and iii by 28 and 43 respectively this was likely due to lower soil moisture induced by drought in the lowland which decreased crop uptake and soil denitrification during the drought period terrestrial export also decreased greatly in classes i iii therefore soil n surplus which equals input total fertiliser amount and precipitation deposition minus output crop plant uptake was higher in classes i ii by 4 4 and 3 1 kg n ha 1 y 1 respectively during the drought period than the pre drought period indicating that more n was stored in the soil in the lowland area during the drought period in the mountain area n sources and sinks in classes iv and v responded differently to drought than these of classes i iii table 3 the total amount of fertiliser in classes iv and v remained relatively constant during the drought period class iv had the lowest soil denitrification among the five classes perhaps due to lower total fertiliser amount and lower temperature in mountain pastures in addition soil denitrification and terrestrial export in classes iv and v did not change during the 2015 2018 drought period compared to the 2004 2014 period which indicates that drought had less effect in the mountain area 3 6 drought effects on in stream nitrate retention annual and seasonal mean lateral nitrate loading from terrestrial to streams decreased during the drought period compared to the pre drought period except for the streams upstream of meisdorf table 4 lateral nitrate loading reduced by 41 and 44 in summer and autumn within the whole river network meanwhile in stream retention amount decreased by 20 and 16 respectively plausibly due to smaller stream benthic area and lower nitrate concentrations during the drought period lateral nitrate loading reduced more than that of in stream retention during the drought period and this resulted in a higher in stream retention efficiency table 4 4 discussion 4 1 model performance evaluation the mhm nitrate model reproduced the observed discharge throughout the bode catchment well mean nse of 0 85 and pbias 20 according to guidelines for evaluating the performance of catchment simulations moriasi et al 2015 this accuracy is similar to those of previous simulations of the study area e g mueller et al 2016 nguyen et al 2021 yang et al 2018 comparing the three representative gauging stations the performance at the meisdorf station was relatively low as indicated by lower nse and kge table 1 perhaps due to underestimating peak flow events and the high sensitivity of nse to extreme values e g krause et al 2005 similarly the low kge was likely due to underestimating high flow values in 2010 2013 and 2014 fig 3a the model may have underestimated peak flow events because of the inaccurately measured precipitation and the lower density of meteorological stations specifically daily precipitation is not sufficiently precise to represent a detailed discharge response especially in the headwater of the bode catchment due to high heterogeneity in precipitation where many storm events last only a few hours moreover the spatial coverage of the meteorological stations decreased significantly during the recent period especially in the mountain area of the catchment for example the number of precipitation gauging stations in the selke sub catchment decreased from 16 to only 8 after 2004 yang et al 2018 generally the decrease in detailed precipitation records decreased performance in predicting discharge in the headwater area which is known for its high spatiotemporal variability in precipitation due to the varying elevation therefore the less accurate precipitation inputs from the lower station density could explain the slight underestimate of water balance at meisdorf pbias of 14 and 17 for the calibration and first validation period respectively however the model slightly overestimated the water balance for the hausneindorf station during the first validation period table 2 jiang et al 2014 and winter et al 2021 stated that water from the lower selke river was abstracted to fill pit lakes from 1998 to 2009 at a rate of 3 1 million m3 year 1 which was ca 8 of the mean annual stream flow from 2004 to 2009 although the water balance remained overestimated after considering this abstraction these overestimates occurred mainly during the low flow period and were acceptable when the corresponding runoff depth was considered i e the largest pbias of 15 5 at hausneindorf corresponded to a runoff depth of only 12 8 mm year although nse values were negative at hausneindorf and nienhagen stations during validation periods table 2 due to few extreme values krause et al 2005 moriasi et al 2015 with regard to the kge and pbias values at these two stations the model performance was acceptable the slightly lower performance of mhm nitrate at the hausneindorf and nienhagen stations than at the other stations was likely due to the lack of detailed time series of point sources from urban areas during the low flow period especially in the initial period of operation of the wwtps as they started to function properly only in 2007 yang et al 2018 the high nitrate concentrations during summers before 2007 fig 3b were likely caused by untreated point sources as discussed in yang et al 2018 after 2007 the model captured the dynamics of nitrate concentration well at hausneindorf station in addition some houses mainly summer houses in the selke sub catchment are not connected to the sewage system which may generate additional unknown point sources and can decrease model performance under low flow conditions the lack of detailed spatial cropping information for the entire bode catchment and the need to rely on only rough survey information might introduce additional uncertainty nevertheless mhm nitrate successfully identified decreasing trends in observed nitrate concentrations at the hausneindorf and stassfurt lowland stations figs 3 and 4 the model performance was in line with that of yang et al 2018 in the selke sub catchment and they also confirmed that the simulations based on dds calibration performed similarly good with that of using the dream method the model can represent observed nitrate concentrations well for several reasons first its flexible structure ensures sufficient spatial representation of catchment heterogeneity as well as spatiotemporal variability in meteorological inputs kumar et al 2010 samaniego et al 2010 yang et al 2018 in addition it can adequately represent the diffuse source inputs and turnover i e agricultural practices crop rotation and plant uptake and point source contributions input time series can be added at the real stream locations at the resolution of the input data which increases the model s ability to represent spatial variability in nitrate sources yang et al 2018 selecting an appropriate calibration period under varying conditions e g at nonstationary conditions like the drought is crucial for model training for example during the calibration period 2011 was a wetter year while 2012 was a drier year thus selecting a calibration period that encompasses varying hydrological conditions helps activate all model components this approach agrees with engel et al 2007 who suggested that both calibration and validation periods should have high and low flows to increase a model s robustness together these characteristics helped to identify model parameters better and reliably estimate nitrate contributions from different runoff components which is crucial for representing nitrate concentrations spatiotemporally in the entire bode catchment the most influential nitrate sub model parameter was related to in stream denitrification while in the study of yang et al 2018 which focused more on upstream catchments the most influential parameter was related to soil denitrification this is presumably due to the larger total stream benthic areas for the bode catchment which is in line with yang et al 2019b who found that there is a significant relationship between stream benthic area and in stream denitrification rate reflecting the relative increasing importance of in stream processes with increasing catchment size 4 2 explaining changes in nitrate concentration during drought years recent droughts 2015 2018 in the bode catchment provided an opportunity to investigate the internal processes that influence nitrate dynamics under changing weather conditions at the catchment scale observed nitrate concentration showed a decreasing trend in lowland agricultural areas i e hausneindorf and stassfurt stations but not significant in the mountain forest area i e meisdorf station fig 4 results suggested that the influence of drought on nitrate concentration could be explained by i spatiotemporal differences in hydrological response and ii its associated effects on soil and in stream nitrate processes during the 2015 2018 drought period compared to the 2004 2014 pre drought period seasonal total runoff decreased in the entire bode catchment during the drought period fig s8m p the decrease was larger in the lowland area due to the combined effects of meteorology and soil properties annual precipitation in the 2015 2018 drought period did not differ greatly from that in long term historical records 1971 2000 from dwd when considering the temporal distribution of precipitation however precipitation decreased greatly in winter and spring in the lowland agricultural area during the drought period especially in class ii by 25 and 30 respectively fig s8a b soil moisture decreased continuously in all seasons and was not replenished during the rewetting seasons due to reduced precipitation in the lowland area fig s8i l in addition the modeled soil moisture of the third layer in classes i iii showed a significant decline during drought period fig s9 consequently this process could decrease unsaturated zone storage and groundwater recharge during the drought period this further explains the decrease in mean annual interflow baseflow and total runoff in the lowland area during the 2015 2018 drought period compared to 2004 2014 furthermore the decrease in soil moisture content may have decreased hydrological connectivity between hillslope and streams during the drought period fig s6f h thus increasing the potential for soil profiles to become disconnected from the stream channel and shallow groundwater davis et al 2014 outram et al 2016 in contrast total runoff in the mountain area decreased only slightly during the drought period perhaps due to seasonal precipitation and slightly decreased soil moisture content there fig s8 this result agrees with other studies that reported that flatter and less forested catchments are more vulnerable to long term drought saft et al 2015 the large decrease in nitrate concentration in the lowland area during the drought period represented by the hausneindorf and stassfurt stations fig 4b c was plausible because the decrease in interflow baseflow and total runoff in classes i iii greatly reduced soil nitrate export from interflow and baseflow which are the major source of the terrestrial nitrate export to surface water fig 6d f table 3 this indicates that nitrate became more transport limited in the lowland area during the drought period in addition upstream discharge with low nitrate concentration could dilute downstream nitrate concentration the share of discharge from uplands sum of discharge at thale and meisdorf station to the total discharge at the outlet of the bode catchment increased from 44 3 to 48 8 from the pre drought period to the drought period furthermore drought increased water temperatures and longer stream water residence time in summer could have stimulated in stream uptake and denitrification efficiency table 4 hosen et al 2019 rode et al 2016 therefore the combined effects of terrestrial export load and in stream processes could explain the decrease of in stream nitrate concentrations in lowland areas e g at the hausneindorf and stassfurt stations in fig 4b c in contrast nitrate concentration in the mountain forest dominated area showed a constant pattern during the drought period compared to the pre drought period as reflected by the meisdorf station fig 3a and 4a this pattern could have occurred because the share of discharge from high nitrate concentration agricultural areas and low nitrate concentration forest areas did not change substantially fig 6 and table 3 nitrate source in the mountain forest dominated area comes mainly from patches of agricultural area which decreased slightly during the drought period in class iv table 3 although total runoff increased in the mountain area in winter during the drought period in stream nitrate concentrations were similar to those during the pre drought period fig s8m vs 3a in addition in stream retention in winter was low and did not influence nitrate concentration which indicated that nitrate could be supply limited in the mountain area previous studies have reported a decrease in stream nitrate concentrations during droughts e g van vliet and zwolsman 2008 yevenes et al 2018 they also explained the decrease in nitrate concentration by less diffuse supply based on empirical relations between nitrate concentration and discharge our study confirmed this explanation by simulating a large decrease in soil nitrate export in the lowland area during the drought period fig 6 5 conclusion varying spatial trends in nitrate concentration under drought conditions were observed in the bode catchment in central germany to explain the mechanisms that influence the changes in trends calibrated mhm nitrate model outputs and internal processes were compared between a drought period 2015 2018 and a pre drought period 2004 2014 results indicated that nitrate export from the terrestrial compartment greatly decreased while in stream retention efficiency increased during the drought periods which could result in the decrease of in stream nitrate concentration in the lowland area of the bode catchment in contrast nitrate export and in stream retention efficiency in the upper mountain area of the catchment changed little therefore nitrate concentrations remained relatively constant in the drought and pre drought periods results suggested that during the drought periods nitrate was mainly stored in the soil rather than mobilized or transported especially in the lowland area of the catchment this study assessed the model s ability to represent nitrate concentrations under varying weather conditions which could be used to study the effects of climate change the bode catchment is a typical mesoscale catchment in central europe in which the headwater is a mountain area with high precipitation and the lowland is an agricultural area with relatively low precipitation we expect that catchments with landscape and climate conditions similar to those of the bode catchment i e wet mountain areas and dry lowland areas are highly vulnerable to changing weather conditions this study showed that droughts have heterogeneous spatial effects on hydrology and water quality responses therefore water managers should specifically consider this spatial heterogeneity when managing future droughts credit authorship contribution statement xiangqian zhou conceptualization methodology formal analysis investigation writing original draft seifeddine jomaa data curation supervision writing review editing xiaoqiang yang software validation writing review editing ralf merz supervision investigation writing review editing yanping wang visualization writing review editing michael rode resources supervision investigation writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements x zhou is funded by the chinese scholarship council csc we thank the german weather service dwd federal institute for geosciences and natural resources bgr and state agency for flood protection and water management of saxony anhalt lhw for providing meteorological geological and discharge and water quality data respectively the high frequency nitrate concentration data were provided by the tereno terrestrial environment observatories project data availability statement the model code of mhm nitrate is publicly available at https zenodo org record 3891629 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128615 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2797,rain on snow ros events can greatly affect the snow process and cause severe snowmelt related hazards it is important to monitor the spatiotemporal distribution of ros events over the ungauged high mountain asia hma this study investigated the spatiotemporal variability of ros events over the hma and its potential influencing factors from 1981 to 2020 based on stand alone noah mp land surface model simulations forced by hourly harv2 reanalysis dataset the results demonstrated that ros activity occurred more frequently in the higher elevation 2500 4000 m and 5500 6000 m a s l regions of the tianshan mountains pamir eastern hindu kush himalayas and the western hengduan shan with an annual maximum ros frequency exceeding 15 days and a maximum intensity reaching 40 mm concentrated in spring and summer ros frequency experienced a significant decrease in the high elevation 3000 4500 m a s l regions of the eastern hindu kush west himalaya and western hengduan shan with a rate exceeding 1 5 days decade the decrease in ros frequency could be explained by a shifting of precipitation type from snowfall to rain driven by dramatic warming and resulting in a decline in snowfall and shortened snow cover persistence particularly in spring and summer on the contrary significantly increasing trend mainly prevailed in the high elevation 5000 6000 m a s l regions of transhimalaya and east himalaya exceeding 0 9 days decade the attribution of the increased ros frequency was related to the significant increase in summer precipitation over the inner tibetan plateau along with an absolute increase in snowfall which was beneficial to snow accumulation with frequent transition of the precipitation phase the above outcomes improve our understanding of ros events and highlight the importance of ros in extreme snowmelt events and water resources management under a warming climate keywords rain on snow noah mp snow depth snow water equivalent high mountain asia data availability the data that has been used is confidential 1 introduction the phenomenon of the liquid precipitation occurring on a preexisting snowpack is called the rain on snow ros events mccabe et al 2007 pall et al 2019 ros greatly impacts hydrological processes surface energy balance geomorphology and the ecosystem kelsey et al 2021 merz et al 2021 rennert et al 2009 stimberis and rubin 2011 the fallen rain could accelerate snowmelt by increasing the snow layer s liquid water content reducing the snow surface albedo enhancing energy absorption and exacerbating the metamorphism dou et al 2021 würzer et al 2017 the extreme snow ablation events driven by ros are usually associated with natural hazards such as widespread flooding snow avalanches landslides and dam failures ding et al 2021 hock et al 2019 huang et al 2022 leading to huge economic losses intense ros events with a severe soil erosion process impact the redistribution of sediments and organic debris and reshape the river landscape li and fang 2016 the percolating rain may refreeze within the snowpack or bare land and then form ice layers that depress the thermal exchange between the soil and atmosphere putkonen and roe 2003 westermann et al 2011 in addition the ice layers affect the vegetation growth and inhibit the wildlife feeding descamps et al 2017 rennert et al 2009 therefore it is necessary and meaningful to investigate the spatiotemporal variability of ros under a global warming context ros mainly occurs in high latitude or higher elevation mountainous regions during late autumn and early spring worldwide bieniek et al 2018 mccabe et al 2007 musselman et al 2018 numerous studies focused on the variability of ros frequency and intensity rain and snowmelt snowmelt process welty and zeng 2021 hydrological juras et al 2021 liu et al 2021b and ecological descamps et al 2017 impacts and future projections under different climate scenarios mooney and lee 2022 mooney and li 2021 since the ros event is a multivariate hydrometeorological phenomenon accurate precipitation phase information and snow dataset snow depth sd and snow water equivalent swe are therefore prerequisites for ros discrimination although the in situ monitoring could effectively reveal the detailed physical processes of ros events and the interactions between various elements at the small watershed scale juras et al 2021 trubilowicz and moore 2017 the meteorological network in mountainous areas is sparse and lacks continuous swe and precipitation phase observations ding et al 2014 dong 2018 in addition rain gauges always undercatch the snowfall due to the wind impacts and instrumental observation errors yang et al 2005 and the accuracy of large scale monitoring in the complex terrain depends on the number of meteorological stations and its representativeness dozier et al 2016 ros could be automatically derived using a combination of passive microwave temperature data at 19 and 37 ghz and optical remote sensing snow products pan et al 2018 but that is limited by the retrieval algorithm spatial resolution 12 5 25 km underlying surface and physical properties of the snowpack dai et al 2012 pulliainen et al 2020 resulting in relatively poor performance of ros in mountainous areas the outputs from the reanalysis datasets are suitable for ros research at global and continental scales but have limited ability to describe the precipitation and snow processes in complex terrain areas mortimer et al 2020 orsolini et al 2019 the snow physical module implemented in land surface and hydrological models could effectively capture mountainous snow dynamic wrzesien et al 2019 these models can use precipitation forcing with finer less than 10 km spatial resolution produced by the reginal climate models dynamical downscaling over complex topographic region and became a common method to investigate ros events in poorly gauged areas bieniek et al 2018 il jeong and sushama 2018 however there is still large uncertainty in ros simulations using land surface models over mountainous region due to uncertainties related to the accuracy of the forcing data model structure and multi parameter calibration girotto et al 2020 terzago et al 2020 the high mountain asia hma is the third largest cryosphere on earth and plays a great role in the global water cycle and climate system having the function of both the ecological barrier and water tower of asia kraaijenbrink et al 2021 yao et al 2022 the warming trend over the hma has reached 0 35 c decade during the past decades yao et al 2019 which is about twice the global average warming rate resulting in more precipitation transition from snowfall to rain dong and ming 2022 meanwhile the shortened snow cover durations the glaciers retreat the permafrost degradation and the frequent cryospheric disasters are reported ding et al 2021 although the snowfall precipitation ratio experienced a significant decline leading to wide decrease in the annual snowfall the winter snowfall in part regions of the tianshan mountains ts yang et al 2022 pamir and tibetan plateau tp de kok et al 2020 deng et al 2017 showed an augmentation due to more water vapor originating from the strengthened westerly circulation yao et al 2022 in addition the annual maximum snow storage remained relatively stable liu et al 2021a yang et al 2021 but the snow cover and swe significantly decreased in spring and autumn in the mid elevation regions smith and bookhagen 2018 the variation of snowfall and snow exhibited a significant seasonality and spatial heterogeneity under a warming climate dong and ming 2022 liu et al 2021a above changes in precipitation phase and snow will inevitably cause changes in the ros frequency and intensity over the hma thereby affecting the snow ablation processes and runoff recharge and exacerbating the risk of snow melting disasters and water supply khanal et al 2021 kraaijenbrink et al 2021 however the spatial extent of ros events and their temporal variation are still not investigated in depth over the hma due to the sparse in situ observation network this study aims to aggregate ros characteristics and their spatiotemporal variations over the hma using the outputs from the offline noah mp land surface model simulation forced by the high asia refined analysis version 2 harv2 hourly reanalysis data from 1981 to 2020 therefore the objectives of this study are 1 to assess the snow performance in noah mp offline simulation 2 to derive the ros events and investigate the spatiotemporal distribution of ros frequency and intensity and 3 to analyze the limiting drivers of ros variations this is the first attempt to investigate the pattern of ros characteristics and its variations in the entire hma the results could provide a scientific basis for snowmelt water management and could be used for further downstream application dealing with disaster prevention and the mitigation of the snowmelt related disasters in the hma under climate change 2 data and methods 2 1 study area the hma is called the third pole of the world fig 1 including the tibetan plateau tp and its surrounding the himalayas mountains karakoram mountains hindu kush mountains and tianshan mountains ts covering 100 000 km2 of glacier coverage yao et al 2019 and 163 km3 of snow storage liu et al 2021a many rivers e g the yangze river indus river tarim river brahmaputra river and syr darya river are recharged by the mountainous glaciers snow meltwater and provide basic water sources for the surrounding 2 billion people yao et al 2022 the primary moisture sources of the hma originate from winter westerlies and summer monsoon which have a significant impact on regional snow and glaciers balance you et al 2020b the westerlies provide abundant winter snowfall for the northern and western hma while the southern and eastern hma receive a considerable summer snowfall as the region is influenced by the indian monsoon from june to september additionally the eastern asia monsoon has only a limited impact on the snowfall in the eastern edges of the hma lai et al 2021 yao et al 2012 2 2 datasets acquisition and processing 2 2 1 validation dataset the daily in situ meteorological dataset including daily temperature precipitation 1981 2018 and sd 1981 2015 from 159 stations over the hma were obtained from the china meteorological administration cma daily meteorological datasets in china version 3 0 which has been subject to a firm quality control procedure before release feng et al 2004 since the meteorological network of daily swe observation is scarce the daily automatic sd and swe observations from the tianshan station for snow cover and avalanche research tssar and yakou station che et al 2019 were used to validate the model performance in the ts and tp respectively more detailed information about these stations is shown in fig 1 and table 1 in addition the monthly snow cover fraction scf from the moderate resolution imaging spectroradiometer satellite modis product mod10cm version 6 acquired from national snow and ice data center nsidc was regridded using the bilinear interpolation method to a 10 km spatial resolution and compared with the noah mp snow cover fraction simulation accurate snowfall data is important for the evaluation of snow related simulation since the daily snowfall measurement is unavailable in cma after 1979 a hyperbolic tangent function was used to estimate in situ snowfall and then used for the evaluation of snowfall forcing data according to dai 2008 the conditional frequencies of snow f could be calculated as follow 1 f a tanh b t s c d where parameters a b c and d are estimated by a least square fitting observation in the hma as 49 02 0 4321 2 47 and 1 respectively li et al 2020 daily snowfall amount is equal to daily precipitation multiply conditional frequencies of snow f the determinate coefficient r2 of the annual snowfall amount reached 0 96 based on above method li et al 2020 2 2 2 reanalysis dataset the harv2 dataset was generated by two way double nested domains outer domain 30 km and inner domain 10 km dynamic downscaling simulation wang et al 2020b which was performed using the weather research and forecasting model wrf version 4 1 coupled to noah land surface model lsm over the hma from january 1980 to december 2020 the hourly fifth generation ecmwf atmospheric reanalysis era5 data was used as the forcing data and the sd from the japanese 55 year reanalysis jra55 was applied to bias correct the initial sd of era5 due to its large overestimation over the tp orsolini et al 2019 compared with the har and no sd bias correction simulation the harv2 has a better performance in air temperature at 2 m t2 simulation by reducing cold bias wang et al 2020b the performance of snow simulation in lsm heavily depends on the accuracy of forcing data especially precipitation and temperature li et al 2021b terzago et al 2020 overall the daily and monthly t2 monthly precipitation and snowfall of harv2 showed high accuracy in the hma fig 2 however it still has a significant wet and cold bias compared with in situ observations both precipitation and snowfall of harv2 exhibited a wetting bias over the hma fig 3 a and 3b especially in the south and east tibet and hengduan shan regions only a few stations around the ts and himalaya mountains showed an underestimation the detailed parameterizations were described in wang et al 2020b the hourly precipitation snowfall t2 specific humidity zonal wind component at 10 m u10 wind vertical wind component at 10 m v10 wind surface pressure downward longwave radiation and downward shortwave radiation from 1980 01 01 to 2020 12 31 obtained from harv2 https data klima tu berlin de were used as forcing for the noah mp offline simulation 2 3 noah mp descriptions and parameterizations configuration the noah mp model is an enhanced version of noah land surface model that incorporates the multiple improved parameterization options for each of the land surface processes and their combinations niu et al 2011 noah mp has been effectively applied to snow climate and hydrology modeling through its physical representations of a separate vegetation canopy layer and three layer snowpack processes as well as multiple physics options for snow related processes he et al 2021 niu et al 2011 the partition between the rainfall or snowfall scheme is based on surface temperature considering the humidity effect a three layer snow structure could effectively represent the processes of snow destructive melt metamorphism and snowpack compaction the canopy snow interception model considers the snowfall interception and throughfall processes with the effect of phase change temperature and wind niu and yang 2004 a semi tile scheme with the stream radiative transfer approximation scheme is used to calculate canopy radiation interaction and account for the canopy gap probability for the vegetation shading and scattering both the snow albedo schemes canadian land surface scheme class verseghy 1991 and biosphere atmosphere transfer scheme bats dickinson et al 1993 could account for the albedo decay due to snow aging the snow cover fraction scf is determined by snow density snow depth and tunable snow cover parameters according to the land cover niu and yang 2007 considering i the large computational demand of high spatial resolution less than10 km over the hma for a long period 30 years and ii the fact that the performance of the daily scf simulation was not improved significantly in the tibetan plateau when using offline noah mp simulation forced by the interpolated precipitation from 10 km to a higher resolution with topographically adjusted air temperature jiang et al 2020 in this study offline simulation 10 km is conducted using noah mp model coupled with the high resolution land data assimilation system hrldas v4 3 and forced by hourly harv2 data from 1980 01 01 to 2020 12 31 covering the entire hma according to the previous spin up evaluation noah mp requires a long time to reach soil state equilibrium chen et al 2014 jiang et al 2020 therefore 1980 harv2 data was chosen for spin up and repeated run ten times before initialization and the 39 hydrological years from september to august from 1981 09 01 to 2020 08 31 were retained for analysis since the higher accuracy of land cover and remoted sensing vegetation parameters could reduce the bias in the snow interception and energy exchange simulation yang et al 2020a the european space agency esa climate change initiative project s land cover product cci lc at 2000 cci lc 2000 https www esa landcover cci org with the modis leaf area index lai with maximum vegetation fraction was chosen as the basis static data in this study the detailed parameterization configurations are described in table 2 2 4 ros definition there is no unified definition of ros events globally in this study we focused on the daily ros events which have the potential to cause flood disasters in the hma region due to very limited hydro climatic observations in the hma especially when the ros driven flooding events occurred we used in this study the ros definition that was applied in the circumpolar arctic norway pall et al 2019 putkonen et al 2009 the daily ros events in a given grid from noah mp model outputs were defined as daily rainfall 5 mm swe 3 mm and daily scf 25 for masking relatively small ros events the cold climate and similar surface land covers shorter plant types and the large proportions of permafrost snow cover and glaciers covering are present in both the hma and the circumpolar arctic regions grosse 2018 lara et al 2022 yao et al 2022 you et al 2021 meanwhile both regions experienced a significant intensification in cryospheric melt and frequent cryospheric hazards accompanied by a close warming level ding et al 2021 yao et al 2019 compared with a minimum threshold of 3 mm and a harsher rain threshold of 10 mm in the circumpolar arctic regions cohen et al 2015 juras et al 2021 rain 5 mm is the intermediate threshold prone to triggering flooding when involving ros events pall et al 2019 the daily sum of rain and snowmelt per grid was called ros intensity rosintensity 2 5 trend analysis and evaluation method the sen slope method sen 1968 and mann kendall m k trend test kendall 1975 mann 1945 were used to estimate the trend slope of climate variables and detect their significant levels respectively the in situ data and remotely sensed data were used to assess the harv2 dataset and outputs from noah mp model the nearest grid cells of precipitation t2 snowfall harv2 sd and swe noah mp values were compared with the in situ observations on different time scales in addition noah mp scf and values averaged over the entire hma were compared with modis products the statistical metrics including the correlation coefficient r mean bias mb and root mean square error rmse were used to quantify the performance of the above variables 2 r i 1 n sim i s i m mean obs i o b s mean i 1 n sim i s i m mean 2 i 1 n obs i o b s mean 2 3 mb 1 n i 1 n s i m i o b s i 4 rmse 1 n i 1 n s i m i o b s i 2 where n is the total number of observed or simulated data sim i and obs i are the simulated and observed values at timestep i respectively and sim mean and obs mean are the mean of the simulated and observed values respectively 3 results 3 1 data validation the performance of the snow simulations in noah mp is shown in figs 4 6 generally the daily sd simulations averaged over all stations in noah mp exhibited high accuracy r 0 8 over the hma fig 4a additionally an overall overestimation was still found the high r values over 0 6 of sd simulations were mainly observed in the surrounding of the ts especially in the east ts and ili valley fig 4b in contrast the low r values below 0 4 concentrated on the tibet plateau primarily located in the south and east tibet and hengduan shan regions the mb of sd simulation showed an opposite pattern in tianshan and the tp a widespread underestimated sd value was found in the ts but the overestimation prevailed in the tp fig 4c both the daily sd and swe simulations exhibited high accuracy in the tssar station fig 5a but an underestimation was also seen as in the above sd simulations in the ts fig 4b in contrast although the sd and swe simulations showed a relatively high performance in the yakou station fig 5b a mismatch in the peak shape of sd and swe values was found compared with in situ observations particularly the sd simulation during 2014 2015 the monthly scf from noah mp estimation over the hma was evaluated using the modis scf products from september 2000 to august 2020 fig 6 overall the monthly scf demonstrated high accuracy in noah mp estimation over the hma fig 6a but a significant overestimation was also seen during the cold season the annual mean scf in noah mp showed a similar pattern to the modis observation and its snow covered probability was overall larger than that in modis observation especially over the tp fig 6b and 6c in addition an enlargement of the high scf exceeding 70 area was observed in the high mountain regions 3 2 spatial variability of rain snow and snowmelt variations of the ros related variables days rain 5 mm days swe 3 mm and snowmelt amount at different time scales and their elevation distribution were displayed in figs 7 and 8 the annual days with rain 5 mm experienced a widespread significant augmentation in each elevation band over the hma fig 7a and fig 8a but the significant decrease was mainly seen in the west himalaya west hengduan shan and part regions of the east ts compared with other seasons fig 7d and m variations of days rain 5 mm during spring and summer dominated the annual decreased or increased changes respectively fig 7g and j except for the northern inner tibet and southern east kunlun the annual days swe 3 mm showed a consistently significant decline over the entire region and each elevation band fig 7b and fig 8b especially location with elevation in 2500 3500 m above sea level a s l in addition the variation in spring contributed to the most annual decrease compared to other seasons fig 7e h k and n similar to the pattern of days swe 3 mm the annual snowmelt showed a widespread decrease over the hma and mainly occurred at elevation bands ranging from 2500 to 4000 m a s l fig 7c and fig 8c the significantly decreased values were mainly seen in ts west himalaya karakoram and western hengduan shan in contrast the significantly increased values were mainly found in the inner tibet and southern east kunlun especially at elevations 5000 6000 m a s l the variation of snowmelt in spring and summer contributed to the most annual changes fig 7f i l and o 3 3 climatology and trend of ros events the spatial patterns of ros frequency and its elevation bands distribution at different time scales were displayed in fig 9 a e and 10a e respectively ros events occurred most frequently in the higher elevation regions of the ts pamir eastern hindu kush himalaya and the intersection of south and east tibet western hengduan shan and east himalaya fig 9a whose elevation bands mainly varied from 2500 to 4000 m and 5500 6000 m a s l fig 10 a and maximum values reached 15 days in a year in contrast few or no ros events were seen in the tp for seasonal scales fig 9b 7e the spring and summer ros contributed to the most annual ros counts specifically spring ros events concentrated in the higher elevation regions of the west ts hissar alay eastern hindu kush west himalaya and the intersection of south and east tibet western hengduan shan and east himalaya and summer ros events were mainly found in the higher elevation regions of the west ts hissar alay himalaya and the intersection of the south and east tibet western hengduan shan and east himalaya it was noted that the elevation bands with the most ros counts in spring 2500 4000 m a s l were significantly lower than that in summer 5500 6000 m a s l fig 10c and d the trend of ros frequency at different time scales was shown in fig 9f j the annual ros frequency experienced a widespread decline over the hma except for the part regions in the intersection of the inner tibet central himalaya and east himalaya fig 9f a significantly decreased value was mainly seen in the higher elevation regions of the eastern hindu kush west himalaya and western hengduan shan with a decreasing rate exceeding 1 5 days decade in contrast a significant augmentation concentrated in the transhimalaya and east himalaya with an increasing rate exceeding 0 9 days decade the elevation bands with the ros frequency changes illustrated that the most dramatic decrease occurred in the elevation between 3000 and 4500 m a s l fig 10f while the increased ros frequency was mainly located at elevations from 1000 to 1500 m and 5000 6000 m a s l compared with winter and autumn changes in ros frequency during the spring and summer dominated its annual variations fig 9g j specifically a significant decrease in ros frequency prevailed in the west himalaya western central himalaya and western hengduan shan in spring and ts pamir west himalaya and western hengduan shan in summer fig 9h and j the significantly increased values were mainly found in the intersection of the inner tibet central himalaya and east himalaya in summer the spatiotemporal distribution of ros intensity was presented in fig 11 generally it showed large annual mean and maximum ros intensity values in the higher elevation regions of the ts and surrounding edges of the southern tp but small values on the lower elevation of the tp fig 11a and c the mean ros intensity values exceeded 25 mm in the higher elevation regions of the ts pamir and the eastern hindu kush himalaya southern inner tibet and western hengduan shan whose maximum ros intensity values reached 40 mm correspondingly in particular the maximum ros intensity in the west himalaya and western hengduan shan even exceeded 100 mm in addition the large annual mean and maximum ros mainly occurred at the elevation bands ranging from 1500 to 3500 m a s l fig 10g and h changes in the annual mean and maximum ros intensity exhibited a mixed pattern over the hma fig 11b and d and no significant changes were seen in most regions during the past decades notably the expansion of the annual mean and maximum ros intensity concentrated in the inner tibet especially in the transhimalaya with a widespread significant increase 4 discussions 4 1 factors influencing the ros activity the interaction of local orographic features and large scale atmospheric circulation greatly affects the spatial pattern of ros activity in different seasons cohen et al 2015 pall et al 2019 specifically the mountainous areas with a long snow persistence and frequent occurrence of precipitation phase transition are closely related to ros events a large proportion of precipitation occurs as snowfall in the high elevation regions and the mid latitude westerly jet brings about abundant winter snowfall over the windward slope of western tp and ts yang et al 2022 yao et al 2012 while a considerable summer snowfall over the southern and eastern hma is dominated by indian monsoon lai et al 2021 above conditions were beneficial to abundant snow storage peak swe 1 m and distinct mixed rain snowfall periods in the ts pamir hindu kush the western himalaya and western hengduan shan dong and ming 2022 liu et al 2021a which was consistent with the pattern of intense ros activity particularly elevation bands with most ros counts in 2500 4000 m and 5500 6000 m a s l during the spring and summer respectively figs 9 and 10 in addition the timing of seasonal peak swe volume in the hma was found in the middle spring and the elevational distribution of maximum swe storage occurred at mid elevations around 3 500 m a s l liu et al 2021a however the magnitudes of swe storage in the summer became significantly smaller than that in the spring along with the rapidly rising temperature and only a few high elevation regions above 5000 m a s l have enough hydrothermal conditions for ros occurrence dong and ming 2022 which may be responsible for the difference in elevation band of most ros counts in the spring and summer changes in ros events are susceptible to the variability of precipitation phase snow cover and surface air temperature mccabe et al 2007 the relations between temperature and the phase transition temperature zone of precipitation determine the specific precipitation phase deng et al 2017 kapnick and delworth 2013 the annual days with daily temperature t2 0 c showed a significant and consistent increase fig 12 a especially in the elevation from 2000 to 2500 m a s l fig 13 a the decrease in snow depth and snow cover was closely associated with the pattern of elevation dependent warming guo et al 2021 you et al 2020a previous studies demonstrated that this warming trend concentrated in the spring snow rain transition season yang et al 2022 moreover the phase transition temperature zone of precipitation with the maximum snowfall over the hma varies from 1 and 2 c deng et al 2017 yang et al 2020b the annual snowfall precipitation ratio experienced a widely decrease over the hma except for part regions of elevation over 6000 m a s l fig 12b and 13b resulting in a decrease in annual snowfall in the most areas of the hma except for the inner tibet and southern east kunlun fig 12c correspondingly the widespread reduction in annual days swe 3 mm was seen over the hma the wetting trend was reported in previous studies over the hma and days of rain 5 mm also showed a significant augmentation which was attributed to a shift of snowfall to rain in a warm climate dong and ming 2022 it is worth noting that a significant decrease in annual days rain 5 mm was found near the west himalaya and western hengduan shan fig 10a which are associated with the variability of low pressure systems over the indian subcontinent dong et al 2017 it would also help to explain why the annual ros frequency experienced a significant decline in the higher elevation regions of the eastern hindu kush west himalaya and western hengduan shan fig 7 whereas it is highly correlated with decreases in swe and days rain 5 mm suggesting that both the increased temperatures and decreased precipitation caused the ros decline however if more snowfall occurred when the snowfall precipitation ratio decreased it contributed to a significant increase in annual snowfall over the southern east kunlun inner tibet and east himalaya it caused a longer snow cover persistence and a substantial expansion in ros frequency in the intersection of the inner tibet central himalaya and east himalaya in a warmer season previous studies argued that a frequent ros event would occur more commonly due to more snowfall shifts to rain in a warming climate hock et al 2019 a similar phenomenon was also found in the mountains of norway pall et al 2019 indeed the variation of ros partly depended on the absolute variation of rain and snowfall amount from the increased precipitation the increase in rainfall intensity and snow amount may explain why the annual mean and maximum ros intensity increased over inner tibet additionally the augmentation of snowmelt amount over these regions also confirmed it fig 7 a positive phase of atlantic multidecadal oscillation amo since the mid 1990s weakened the subtropical westerly jet stream and enhanced the anomalous cyclone over the western inner tibet which led to trapping water vapor over the inner tibet and more water vapor originated from the arabian sea sun et al 2020 accordingly an increase in summer precipitation was found over the inner tibet since the mid 1990s a significant summer snowfall augmentation longer snow cover duration and more snowmelt amount were also seen in the transhimalaya due to surface air temperature below freezing temperature in the high elevation regions of the inner tibet conversely the strengthened westerlies and orographic effects increased winter snowfall and maximum swe over the pamir and ts yang et al 2022 yao et al 2012 nevertheless the dramatic rising temperature in a short time caused a decrease in snow cover duration along with a small swe associated with a transformation of the precipitation phase which contributed to a reduction in ros intensity over most regions 4 2 limitations and uncertainties ros uncertainties in this study could be attributed to the accuracy of the forcing dataset and snow simulation in noah mp and the thresholds for defining ros events although the harv2 exhibited a high accuracy in monthly precipitation and daily temperature the wide overestimation of precipitation and snowfall along with severe cold bias was seen over ts and tp especially in the high elevation regions wang et al 2020b the relatively coarse spatial resolution 10 km in the original wrf dynamical downscaling simulation which could smooth the mesoscale topography over complex terrain and benefit to transport more moisture from the low elevation regions to high elevation regions wang et al 2020c aggravating the dry bias and wet bias in the low elevation regions and the high elevation regions respectively convection permitting modeling with appropriate orographic drag parameterization could effectively reduce precipitation bias in complex terrain wang et al 2020c zhou et al 2021 however the scarcity of in situ observations in high elevation regions especially over the 5000 m a s l and the accuracy of forcing data and model simulation is still unknown in addition the wind induced undercatch of snowfall in precipitation gauges may exaggerate the wetting bias but a previous study demonstrated that the morrison cloud microphysics schemes produced more snowfall in the wrf simulation orr et al 2017 the wet bias of precipitation and cold bias of temperature were directly responsible for the overestimation of sd and scf in the high elevation regions and the underestimation of sd near the ts gao et al 2020 li et al 2021a the uncertainty of the default scf scheme and snow albedo scheme in the noah mp model caused a relatively poor snow performance and cold bias in the thin snow regions especially in tp jiang et al 2020 wang et al 2020a above uncertainties may contribute to a colder temperature lower snowmelt rate and longer snow cover duration resulting in a ros overestimation over the thin snow regions in contrast an underestimated precipitation and swe in the low elevation regions may cause shorter snow cover durations consequently an underestimated frequency of ros events in addition the effects of irrigation aerosol and impurity on snowpack were not considered in both wrf downscaling simulation and later noah mp offline simulations which have been proven to increase the regional snowfall and intense snowmelt rate de kok et al 2020 kang et al 2020 sarangi et al 2020 respectively indeed the high humidity and latent energy environment in a maritime climate region were beneficial to more frequent ros events which were caused by warming the falling precipitation through condensation harpold and brooks 2018 thus neglecting these sources of uncertainties may also contribute to the underestimated ros events in the snowmelt period and crop growing season the lateral flow related processes in the snowpack especially in the ice layers were not characterized in the noah mp which may lead to underestimating the snowmelt rate during the early period and overestimating the rosintensity paquotte and baraer 2022 the thresholds for defining ros events according to pall et al 2019 were not revised over the hma due to a lack of hydrological data to evaluate and choose the suitable swe and rain thresholds for snowmelt flooding compared with a harsh threshold e g swe 10 mm d 1 rain 10 mm d 1 and snowmelt snowmelt rain 20 d 1 musselman et al 2018 and a lax threshold e g swe 1 mm d 1 rain 1 mm d 1 and snowmelt 0 mm d 1 il jeong and sushama 2018 over north america thresholds in this study may mask the small ros events which have a great impact on foraging animals rain 3 mm d 1 rennert et al 2009 and insufficiently characterize the extreme ros related flooding rain 25 mm d 1 huang et al 2022 which may cause the overestimated numbers of ros driven snowmelt flooding events 5 conclusions this study investigated the spatiotemporal variability of the rain on snow events across the high mountain asia and its influencing factors from 1981 to 2020 based on the stand alone noah mp land surface model simulations forced by hourly harv2 reanalysis data the following major findings can be summarized in this study 1 the rain on snow activity occurred more frequently in the higher elevation 2500 4000 m and 5500 6000 m a s l regions of the tianshan mountains pamir eastern hindu kush himalayas and the western hengduan shan with an annual maximum rain on snow frequency exceeding 15 days and a maximum intensity reaching 40 mm concentrated in spring and summer in contrast few or no rain on snow events were seen in the tibetan plateau 2 the rain on snow in the higher elevation 3000 4500 m a s l regions of the eastern hindu kush west himalaya and western hengduan shan experienced a significant decrease with a rate exceeding 1 5 days decade the consistent increase in air temperature caused more precipitation to shift from snowfall to rain and reduced the snowfall amount resulting in a shorter snow cover persistence accordingly decreasing the frequency of rain on snow events particularly in spring and summer 3 a significant augmentation mainly prevailed in the high elevation 5000 6000 m a s l regions of transhimalaya and east himalaya exceeding 0 9 days decade despite a decrease in snowfall precipitation ratio the significant increase in summer precipitation over the inner tibetan plateau and an absolute increase in snowfall were beneficial to the snow accumulation and augmentation of rain on snow events the ipcc figured out that the ros events will be gradually active from low mid elevation regions to high elevation regions in a consistently warming projection hock et al 2019 under this transition the specific variability of ros characteristics and their potential impacts should need more attention in different warming scenarios meanwhile the hma has the largest glacier mass storage after the polar regions yao et al 2022 and intense ros events may affect the glacier mass balance by modifying the properties i e albedo density of the snowpack and increasing the number of ice layers sobota et al 2020 the noah mp is still using a simplified scheme that could not represent the evolution of glacier mass and extent eidhammer et al 2021 simulation using glacier mass balance gradient model with convection permitting regional climate model provides the potential and practical approach to quantify the influence of ros event on glacier mass balance and snow characteristics eidhammer et al 2021 a suitable threshold of ros events definition with flooding potential in the hma should be revised according to the response of runoff to rain snowpack dynamics during the ros events occurrence in a typical catchment additionally the hydrological models will be considered to analyze the induced mechanism of ros driven snowmelt flooding and quantify its runoff contribution to individual ros event at a river catchment in further work credit authorship contribution statement tao yang methodology software writing original draft qian li writing review editing rafiq hamdi writing review editing xi chen supervision qiang zou funding acquisition resources fengqi cui visualization philippe de maeyer supervision lanhai li project administration writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was supported by the strategic priority research program of chinese academy of sciences grant no xda23090303 the projects of the second tibetan plateau scientific expedition and research program step grant no 2019qzkk0902 the project of applications for network security and informatization cas grant no cas wx2021sf 010604 the cas light of west china program grant no xbzg zdsys 202104 the national cryosphere desert data center grant no 2021kf02 the national natural science foundation of china grant no 42001061 and the china postdoctoral science foundation grant no 2021m703132 
2797,rain on snow ros events can greatly affect the snow process and cause severe snowmelt related hazards it is important to monitor the spatiotemporal distribution of ros events over the ungauged high mountain asia hma this study investigated the spatiotemporal variability of ros events over the hma and its potential influencing factors from 1981 to 2020 based on stand alone noah mp land surface model simulations forced by hourly harv2 reanalysis dataset the results demonstrated that ros activity occurred more frequently in the higher elevation 2500 4000 m and 5500 6000 m a s l regions of the tianshan mountains pamir eastern hindu kush himalayas and the western hengduan shan with an annual maximum ros frequency exceeding 15 days and a maximum intensity reaching 40 mm concentrated in spring and summer ros frequency experienced a significant decrease in the high elevation 3000 4500 m a s l regions of the eastern hindu kush west himalaya and western hengduan shan with a rate exceeding 1 5 days decade the decrease in ros frequency could be explained by a shifting of precipitation type from snowfall to rain driven by dramatic warming and resulting in a decline in snowfall and shortened snow cover persistence particularly in spring and summer on the contrary significantly increasing trend mainly prevailed in the high elevation 5000 6000 m a s l regions of transhimalaya and east himalaya exceeding 0 9 days decade the attribution of the increased ros frequency was related to the significant increase in summer precipitation over the inner tibetan plateau along with an absolute increase in snowfall which was beneficial to snow accumulation with frequent transition of the precipitation phase the above outcomes improve our understanding of ros events and highlight the importance of ros in extreme snowmelt events and water resources management under a warming climate keywords rain on snow noah mp snow depth snow water equivalent high mountain asia data availability the data that has been used is confidential 1 introduction the phenomenon of the liquid precipitation occurring on a preexisting snowpack is called the rain on snow ros events mccabe et al 2007 pall et al 2019 ros greatly impacts hydrological processes surface energy balance geomorphology and the ecosystem kelsey et al 2021 merz et al 2021 rennert et al 2009 stimberis and rubin 2011 the fallen rain could accelerate snowmelt by increasing the snow layer s liquid water content reducing the snow surface albedo enhancing energy absorption and exacerbating the metamorphism dou et al 2021 würzer et al 2017 the extreme snow ablation events driven by ros are usually associated with natural hazards such as widespread flooding snow avalanches landslides and dam failures ding et al 2021 hock et al 2019 huang et al 2022 leading to huge economic losses intense ros events with a severe soil erosion process impact the redistribution of sediments and organic debris and reshape the river landscape li and fang 2016 the percolating rain may refreeze within the snowpack or bare land and then form ice layers that depress the thermal exchange between the soil and atmosphere putkonen and roe 2003 westermann et al 2011 in addition the ice layers affect the vegetation growth and inhibit the wildlife feeding descamps et al 2017 rennert et al 2009 therefore it is necessary and meaningful to investigate the spatiotemporal variability of ros under a global warming context ros mainly occurs in high latitude or higher elevation mountainous regions during late autumn and early spring worldwide bieniek et al 2018 mccabe et al 2007 musselman et al 2018 numerous studies focused on the variability of ros frequency and intensity rain and snowmelt snowmelt process welty and zeng 2021 hydrological juras et al 2021 liu et al 2021b and ecological descamps et al 2017 impacts and future projections under different climate scenarios mooney and lee 2022 mooney and li 2021 since the ros event is a multivariate hydrometeorological phenomenon accurate precipitation phase information and snow dataset snow depth sd and snow water equivalent swe are therefore prerequisites for ros discrimination although the in situ monitoring could effectively reveal the detailed physical processes of ros events and the interactions between various elements at the small watershed scale juras et al 2021 trubilowicz and moore 2017 the meteorological network in mountainous areas is sparse and lacks continuous swe and precipitation phase observations ding et al 2014 dong 2018 in addition rain gauges always undercatch the snowfall due to the wind impacts and instrumental observation errors yang et al 2005 and the accuracy of large scale monitoring in the complex terrain depends on the number of meteorological stations and its representativeness dozier et al 2016 ros could be automatically derived using a combination of passive microwave temperature data at 19 and 37 ghz and optical remote sensing snow products pan et al 2018 but that is limited by the retrieval algorithm spatial resolution 12 5 25 km underlying surface and physical properties of the snowpack dai et al 2012 pulliainen et al 2020 resulting in relatively poor performance of ros in mountainous areas the outputs from the reanalysis datasets are suitable for ros research at global and continental scales but have limited ability to describe the precipitation and snow processes in complex terrain areas mortimer et al 2020 orsolini et al 2019 the snow physical module implemented in land surface and hydrological models could effectively capture mountainous snow dynamic wrzesien et al 2019 these models can use precipitation forcing with finer less than 10 km spatial resolution produced by the reginal climate models dynamical downscaling over complex topographic region and became a common method to investigate ros events in poorly gauged areas bieniek et al 2018 il jeong and sushama 2018 however there is still large uncertainty in ros simulations using land surface models over mountainous region due to uncertainties related to the accuracy of the forcing data model structure and multi parameter calibration girotto et al 2020 terzago et al 2020 the high mountain asia hma is the third largest cryosphere on earth and plays a great role in the global water cycle and climate system having the function of both the ecological barrier and water tower of asia kraaijenbrink et al 2021 yao et al 2022 the warming trend over the hma has reached 0 35 c decade during the past decades yao et al 2019 which is about twice the global average warming rate resulting in more precipitation transition from snowfall to rain dong and ming 2022 meanwhile the shortened snow cover durations the glaciers retreat the permafrost degradation and the frequent cryospheric disasters are reported ding et al 2021 although the snowfall precipitation ratio experienced a significant decline leading to wide decrease in the annual snowfall the winter snowfall in part regions of the tianshan mountains ts yang et al 2022 pamir and tibetan plateau tp de kok et al 2020 deng et al 2017 showed an augmentation due to more water vapor originating from the strengthened westerly circulation yao et al 2022 in addition the annual maximum snow storage remained relatively stable liu et al 2021a yang et al 2021 but the snow cover and swe significantly decreased in spring and autumn in the mid elevation regions smith and bookhagen 2018 the variation of snowfall and snow exhibited a significant seasonality and spatial heterogeneity under a warming climate dong and ming 2022 liu et al 2021a above changes in precipitation phase and snow will inevitably cause changes in the ros frequency and intensity over the hma thereby affecting the snow ablation processes and runoff recharge and exacerbating the risk of snow melting disasters and water supply khanal et al 2021 kraaijenbrink et al 2021 however the spatial extent of ros events and their temporal variation are still not investigated in depth over the hma due to the sparse in situ observation network this study aims to aggregate ros characteristics and their spatiotemporal variations over the hma using the outputs from the offline noah mp land surface model simulation forced by the high asia refined analysis version 2 harv2 hourly reanalysis data from 1981 to 2020 therefore the objectives of this study are 1 to assess the snow performance in noah mp offline simulation 2 to derive the ros events and investigate the spatiotemporal distribution of ros frequency and intensity and 3 to analyze the limiting drivers of ros variations this is the first attempt to investigate the pattern of ros characteristics and its variations in the entire hma the results could provide a scientific basis for snowmelt water management and could be used for further downstream application dealing with disaster prevention and the mitigation of the snowmelt related disasters in the hma under climate change 2 data and methods 2 1 study area the hma is called the third pole of the world fig 1 including the tibetan plateau tp and its surrounding the himalayas mountains karakoram mountains hindu kush mountains and tianshan mountains ts covering 100 000 km2 of glacier coverage yao et al 2019 and 163 km3 of snow storage liu et al 2021a many rivers e g the yangze river indus river tarim river brahmaputra river and syr darya river are recharged by the mountainous glaciers snow meltwater and provide basic water sources for the surrounding 2 billion people yao et al 2022 the primary moisture sources of the hma originate from winter westerlies and summer monsoon which have a significant impact on regional snow and glaciers balance you et al 2020b the westerlies provide abundant winter snowfall for the northern and western hma while the southern and eastern hma receive a considerable summer snowfall as the region is influenced by the indian monsoon from june to september additionally the eastern asia monsoon has only a limited impact on the snowfall in the eastern edges of the hma lai et al 2021 yao et al 2012 2 2 datasets acquisition and processing 2 2 1 validation dataset the daily in situ meteorological dataset including daily temperature precipitation 1981 2018 and sd 1981 2015 from 159 stations over the hma were obtained from the china meteorological administration cma daily meteorological datasets in china version 3 0 which has been subject to a firm quality control procedure before release feng et al 2004 since the meteorological network of daily swe observation is scarce the daily automatic sd and swe observations from the tianshan station for snow cover and avalanche research tssar and yakou station che et al 2019 were used to validate the model performance in the ts and tp respectively more detailed information about these stations is shown in fig 1 and table 1 in addition the monthly snow cover fraction scf from the moderate resolution imaging spectroradiometer satellite modis product mod10cm version 6 acquired from national snow and ice data center nsidc was regridded using the bilinear interpolation method to a 10 km spatial resolution and compared with the noah mp snow cover fraction simulation accurate snowfall data is important for the evaluation of snow related simulation since the daily snowfall measurement is unavailable in cma after 1979 a hyperbolic tangent function was used to estimate in situ snowfall and then used for the evaluation of snowfall forcing data according to dai 2008 the conditional frequencies of snow f could be calculated as follow 1 f a tanh b t s c d where parameters a b c and d are estimated by a least square fitting observation in the hma as 49 02 0 4321 2 47 and 1 respectively li et al 2020 daily snowfall amount is equal to daily precipitation multiply conditional frequencies of snow f the determinate coefficient r2 of the annual snowfall amount reached 0 96 based on above method li et al 2020 2 2 2 reanalysis dataset the harv2 dataset was generated by two way double nested domains outer domain 30 km and inner domain 10 km dynamic downscaling simulation wang et al 2020b which was performed using the weather research and forecasting model wrf version 4 1 coupled to noah land surface model lsm over the hma from january 1980 to december 2020 the hourly fifth generation ecmwf atmospheric reanalysis era5 data was used as the forcing data and the sd from the japanese 55 year reanalysis jra55 was applied to bias correct the initial sd of era5 due to its large overestimation over the tp orsolini et al 2019 compared with the har and no sd bias correction simulation the harv2 has a better performance in air temperature at 2 m t2 simulation by reducing cold bias wang et al 2020b the performance of snow simulation in lsm heavily depends on the accuracy of forcing data especially precipitation and temperature li et al 2021b terzago et al 2020 overall the daily and monthly t2 monthly precipitation and snowfall of harv2 showed high accuracy in the hma fig 2 however it still has a significant wet and cold bias compared with in situ observations both precipitation and snowfall of harv2 exhibited a wetting bias over the hma fig 3 a and 3b especially in the south and east tibet and hengduan shan regions only a few stations around the ts and himalaya mountains showed an underestimation the detailed parameterizations were described in wang et al 2020b the hourly precipitation snowfall t2 specific humidity zonal wind component at 10 m u10 wind vertical wind component at 10 m v10 wind surface pressure downward longwave radiation and downward shortwave radiation from 1980 01 01 to 2020 12 31 obtained from harv2 https data klima tu berlin de were used as forcing for the noah mp offline simulation 2 3 noah mp descriptions and parameterizations configuration the noah mp model is an enhanced version of noah land surface model that incorporates the multiple improved parameterization options for each of the land surface processes and their combinations niu et al 2011 noah mp has been effectively applied to snow climate and hydrology modeling through its physical representations of a separate vegetation canopy layer and three layer snowpack processes as well as multiple physics options for snow related processes he et al 2021 niu et al 2011 the partition between the rainfall or snowfall scheme is based on surface temperature considering the humidity effect a three layer snow structure could effectively represent the processes of snow destructive melt metamorphism and snowpack compaction the canopy snow interception model considers the snowfall interception and throughfall processes with the effect of phase change temperature and wind niu and yang 2004 a semi tile scheme with the stream radiative transfer approximation scheme is used to calculate canopy radiation interaction and account for the canopy gap probability for the vegetation shading and scattering both the snow albedo schemes canadian land surface scheme class verseghy 1991 and biosphere atmosphere transfer scheme bats dickinson et al 1993 could account for the albedo decay due to snow aging the snow cover fraction scf is determined by snow density snow depth and tunable snow cover parameters according to the land cover niu and yang 2007 considering i the large computational demand of high spatial resolution less than10 km over the hma for a long period 30 years and ii the fact that the performance of the daily scf simulation was not improved significantly in the tibetan plateau when using offline noah mp simulation forced by the interpolated precipitation from 10 km to a higher resolution with topographically adjusted air temperature jiang et al 2020 in this study offline simulation 10 km is conducted using noah mp model coupled with the high resolution land data assimilation system hrldas v4 3 and forced by hourly harv2 data from 1980 01 01 to 2020 12 31 covering the entire hma according to the previous spin up evaluation noah mp requires a long time to reach soil state equilibrium chen et al 2014 jiang et al 2020 therefore 1980 harv2 data was chosen for spin up and repeated run ten times before initialization and the 39 hydrological years from september to august from 1981 09 01 to 2020 08 31 were retained for analysis since the higher accuracy of land cover and remoted sensing vegetation parameters could reduce the bias in the snow interception and energy exchange simulation yang et al 2020a the european space agency esa climate change initiative project s land cover product cci lc at 2000 cci lc 2000 https www esa landcover cci org with the modis leaf area index lai with maximum vegetation fraction was chosen as the basis static data in this study the detailed parameterization configurations are described in table 2 2 4 ros definition there is no unified definition of ros events globally in this study we focused on the daily ros events which have the potential to cause flood disasters in the hma region due to very limited hydro climatic observations in the hma especially when the ros driven flooding events occurred we used in this study the ros definition that was applied in the circumpolar arctic norway pall et al 2019 putkonen et al 2009 the daily ros events in a given grid from noah mp model outputs were defined as daily rainfall 5 mm swe 3 mm and daily scf 25 for masking relatively small ros events the cold climate and similar surface land covers shorter plant types and the large proportions of permafrost snow cover and glaciers covering are present in both the hma and the circumpolar arctic regions grosse 2018 lara et al 2022 yao et al 2022 you et al 2021 meanwhile both regions experienced a significant intensification in cryospheric melt and frequent cryospheric hazards accompanied by a close warming level ding et al 2021 yao et al 2019 compared with a minimum threshold of 3 mm and a harsher rain threshold of 10 mm in the circumpolar arctic regions cohen et al 2015 juras et al 2021 rain 5 mm is the intermediate threshold prone to triggering flooding when involving ros events pall et al 2019 the daily sum of rain and snowmelt per grid was called ros intensity rosintensity 2 5 trend analysis and evaluation method the sen slope method sen 1968 and mann kendall m k trend test kendall 1975 mann 1945 were used to estimate the trend slope of climate variables and detect their significant levels respectively the in situ data and remotely sensed data were used to assess the harv2 dataset and outputs from noah mp model the nearest grid cells of precipitation t2 snowfall harv2 sd and swe noah mp values were compared with the in situ observations on different time scales in addition noah mp scf and values averaged over the entire hma were compared with modis products the statistical metrics including the correlation coefficient r mean bias mb and root mean square error rmse were used to quantify the performance of the above variables 2 r i 1 n sim i s i m mean obs i o b s mean i 1 n sim i s i m mean 2 i 1 n obs i o b s mean 2 3 mb 1 n i 1 n s i m i o b s i 4 rmse 1 n i 1 n s i m i o b s i 2 where n is the total number of observed or simulated data sim i and obs i are the simulated and observed values at timestep i respectively and sim mean and obs mean are the mean of the simulated and observed values respectively 3 results 3 1 data validation the performance of the snow simulations in noah mp is shown in figs 4 6 generally the daily sd simulations averaged over all stations in noah mp exhibited high accuracy r 0 8 over the hma fig 4a additionally an overall overestimation was still found the high r values over 0 6 of sd simulations were mainly observed in the surrounding of the ts especially in the east ts and ili valley fig 4b in contrast the low r values below 0 4 concentrated on the tibet plateau primarily located in the south and east tibet and hengduan shan regions the mb of sd simulation showed an opposite pattern in tianshan and the tp a widespread underestimated sd value was found in the ts but the overestimation prevailed in the tp fig 4c both the daily sd and swe simulations exhibited high accuracy in the tssar station fig 5a but an underestimation was also seen as in the above sd simulations in the ts fig 4b in contrast although the sd and swe simulations showed a relatively high performance in the yakou station fig 5b a mismatch in the peak shape of sd and swe values was found compared with in situ observations particularly the sd simulation during 2014 2015 the monthly scf from noah mp estimation over the hma was evaluated using the modis scf products from september 2000 to august 2020 fig 6 overall the monthly scf demonstrated high accuracy in noah mp estimation over the hma fig 6a but a significant overestimation was also seen during the cold season the annual mean scf in noah mp showed a similar pattern to the modis observation and its snow covered probability was overall larger than that in modis observation especially over the tp fig 6b and 6c in addition an enlargement of the high scf exceeding 70 area was observed in the high mountain regions 3 2 spatial variability of rain snow and snowmelt variations of the ros related variables days rain 5 mm days swe 3 mm and snowmelt amount at different time scales and their elevation distribution were displayed in figs 7 and 8 the annual days with rain 5 mm experienced a widespread significant augmentation in each elevation band over the hma fig 7a and fig 8a but the significant decrease was mainly seen in the west himalaya west hengduan shan and part regions of the east ts compared with other seasons fig 7d and m variations of days rain 5 mm during spring and summer dominated the annual decreased or increased changes respectively fig 7g and j except for the northern inner tibet and southern east kunlun the annual days swe 3 mm showed a consistently significant decline over the entire region and each elevation band fig 7b and fig 8b especially location with elevation in 2500 3500 m above sea level a s l in addition the variation in spring contributed to the most annual decrease compared to other seasons fig 7e h k and n similar to the pattern of days swe 3 mm the annual snowmelt showed a widespread decrease over the hma and mainly occurred at elevation bands ranging from 2500 to 4000 m a s l fig 7c and fig 8c the significantly decreased values were mainly seen in ts west himalaya karakoram and western hengduan shan in contrast the significantly increased values were mainly found in the inner tibet and southern east kunlun especially at elevations 5000 6000 m a s l the variation of snowmelt in spring and summer contributed to the most annual changes fig 7f i l and o 3 3 climatology and trend of ros events the spatial patterns of ros frequency and its elevation bands distribution at different time scales were displayed in fig 9 a e and 10a e respectively ros events occurred most frequently in the higher elevation regions of the ts pamir eastern hindu kush himalaya and the intersection of south and east tibet western hengduan shan and east himalaya fig 9a whose elevation bands mainly varied from 2500 to 4000 m and 5500 6000 m a s l fig 10 a and maximum values reached 15 days in a year in contrast few or no ros events were seen in the tp for seasonal scales fig 9b 7e the spring and summer ros contributed to the most annual ros counts specifically spring ros events concentrated in the higher elevation regions of the west ts hissar alay eastern hindu kush west himalaya and the intersection of south and east tibet western hengduan shan and east himalaya and summer ros events were mainly found in the higher elevation regions of the west ts hissar alay himalaya and the intersection of the south and east tibet western hengduan shan and east himalaya it was noted that the elevation bands with the most ros counts in spring 2500 4000 m a s l were significantly lower than that in summer 5500 6000 m a s l fig 10c and d the trend of ros frequency at different time scales was shown in fig 9f j the annual ros frequency experienced a widespread decline over the hma except for the part regions in the intersection of the inner tibet central himalaya and east himalaya fig 9f a significantly decreased value was mainly seen in the higher elevation regions of the eastern hindu kush west himalaya and western hengduan shan with a decreasing rate exceeding 1 5 days decade in contrast a significant augmentation concentrated in the transhimalaya and east himalaya with an increasing rate exceeding 0 9 days decade the elevation bands with the ros frequency changes illustrated that the most dramatic decrease occurred in the elevation between 3000 and 4500 m a s l fig 10f while the increased ros frequency was mainly located at elevations from 1000 to 1500 m and 5000 6000 m a s l compared with winter and autumn changes in ros frequency during the spring and summer dominated its annual variations fig 9g j specifically a significant decrease in ros frequency prevailed in the west himalaya western central himalaya and western hengduan shan in spring and ts pamir west himalaya and western hengduan shan in summer fig 9h and j the significantly increased values were mainly found in the intersection of the inner tibet central himalaya and east himalaya in summer the spatiotemporal distribution of ros intensity was presented in fig 11 generally it showed large annual mean and maximum ros intensity values in the higher elevation regions of the ts and surrounding edges of the southern tp but small values on the lower elevation of the tp fig 11a and c the mean ros intensity values exceeded 25 mm in the higher elevation regions of the ts pamir and the eastern hindu kush himalaya southern inner tibet and western hengduan shan whose maximum ros intensity values reached 40 mm correspondingly in particular the maximum ros intensity in the west himalaya and western hengduan shan even exceeded 100 mm in addition the large annual mean and maximum ros mainly occurred at the elevation bands ranging from 1500 to 3500 m a s l fig 10g and h changes in the annual mean and maximum ros intensity exhibited a mixed pattern over the hma fig 11b and d and no significant changes were seen in most regions during the past decades notably the expansion of the annual mean and maximum ros intensity concentrated in the inner tibet especially in the transhimalaya with a widespread significant increase 4 discussions 4 1 factors influencing the ros activity the interaction of local orographic features and large scale atmospheric circulation greatly affects the spatial pattern of ros activity in different seasons cohen et al 2015 pall et al 2019 specifically the mountainous areas with a long snow persistence and frequent occurrence of precipitation phase transition are closely related to ros events a large proportion of precipitation occurs as snowfall in the high elevation regions and the mid latitude westerly jet brings about abundant winter snowfall over the windward slope of western tp and ts yang et al 2022 yao et al 2012 while a considerable summer snowfall over the southern and eastern hma is dominated by indian monsoon lai et al 2021 above conditions were beneficial to abundant snow storage peak swe 1 m and distinct mixed rain snowfall periods in the ts pamir hindu kush the western himalaya and western hengduan shan dong and ming 2022 liu et al 2021a which was consistent with the pattern of intense ros activity particularly elevation bands with most ros counts in 2500 4000 m and 5500 6000 m a s l during the spring and summer respectively figs 9 and 10 in addition the timing of seasonal peak swe volume in the hma was found in the middle spring and the elevational distribution of maximum swe storage occurred at mid elevations around 3 500 m a s l liu et al 2021a however the magnitudes of swe storage in the summer became significantly smaller than that in the spring along with the rapidly rising temperature and only a few high elevation regions above 5000 m a s l have enough hydrothermal conditions for ros occurrence dong and ming 2022 which may be responsible for the difference in elevation band of most ros counts in the spring and summer changes in ros events are susceptible to the variability of precipitation phase snow cover and surface air temperature mccabe et al 2007 the relations between temperature and the phase transition temperature zone of precipitation determine the specific precipitation phase deng et al 2017 kapnick and delworth 2013 the annual days with daily temperature t2 0 c showed a significant and consistent increase fig 12 a especially in the elevation from 2000 to 2500 m a s l fig 13 a the decrease in snow depth and snow cover was closely associated with the pattern of elevation dependent warming guo et al 2021 you et al 2020a previous studies demonstrated that this warming trend concentrated in the spring snow rain transition season yang et al 2022 moreover the phase transition temperature zone of precipitation with the maximum snowfall over the hma varies from 1 and 2 c deng et al 2017 yang et al 2020b the annual snowfall precipitation ratio experienced a widely decrease over the hma except for part regions of elevation over 6000 m a s l fig 12b and 13b resulting in a decrease in annual snowfall in the most areas of the hma except for the inner tibet and southern east kunlun fig 12c correspondingly the widespread reduction in annual days swe 3 mm was seen over the hma the wetting trend was reported in previous studies over the hma and days of rain 5 mm also showed a significant augmentation which was attributed to a shift of snowfall to rain in a warm climate dong and ming 2022 it is worth noting that a significant decrease in annual days rain 5 mm was found near the west himalaya and western hengduan shan fig 10a which are associated with the variability of low pressure systems over the indian subcontinent dong et al 2017 it would also help to explain why the annual ros frequency experienced a significant decline in the higher elevation regions of the eastern hindu kush west himalaya and western hengduan shan fig 7 whereas it is highly correlated with decreases in swe and days rain 5 mm suggesting that both the increased temperatures and decreased precipitation caused the ros decline however if more snowfall occurred when the snowfall precipitation ratio decreased it contributed to a significant increase in annual snowfall over the southern east kunlun inner tibet and east himalaya it caused a longer snow cover persistence and a substantial expansion in ros frequency in the intersection of the inner tibet central himalaya and east himalaya in a warmer season previous studies argued that a frequent ros event would occur more commonly due to more snowfall shifts to rain in a warming climate hock et al 2019 a similar phenomenon was also found in the mountains of norway pall et al 2019 indeed the variation of ros partly depended on the absolute variation of rain and snowfall amount from the increased precipitation the increase in rainfall intensity and snow amount may explain why the annual mean and maximum ros intensity increased over inner tibet additionally the augmentation of snowmelt amount over these regions also confirmed it fig 7 a positive phase of atlantic multidecadal oscillation amo since the mid 1990s weakened the subtropical westerly jet stream and enhanced the anomalous cyclone over the western inner tibet which led to trapping water vapor over the inner tibet and more water vapor originated from the arabian sea sun et al 2020 accordingly an increase in summer precipitation was found over the inner tibet since the mid 1990s a significant summer snowfall augmentation longer snow cover duration and more snowmelt amount were also seen in the transhimalaya due to surface air temperature below freezing temperature in the high elevation regions of the inner tibet conversely the strengthened westerlies and orographic effects increased winter snowfall and maximum swe over the pamir and ts yang et al 2022 yao et al 2012 nevertheless the dramatic rising temperature in a short time caused a decrease in snow cover duration along with a small swe associated with a transformation of the precipitation phase which contributed to a reduction in ros intensity over most regions 4 2 limitations and uncertainties ros uncertainties in this study could be attributed to the accuracy of the forcing dataset and snow simulation in noah mp and the thresholds for defining ros events although the harv2 exhibited a high accuracy in monthly precipitation and daily temperature the wide overestimation of precipitation and snowfall along with severe cold bias was seen over ts and tp especially in the high elevation regions wang et al 2020b the relatively coarse spatial resolution 10 km in the original wrf dynamical downscaling simulation which could smooth the mesoscale topography over complex terrain and benefit to transport more moisture from the low elevation regions to high elevation regions wang et al 2020c aggravating the dry bias and wet bias in the low elevation regions and the high elevation regions respectively convection permitting modeling with appropriate orographic drag parameterization could effectively reduce precipitation bias in complex terrain wang et al 2020c zhou et al 2021 however the scarcity of in situ observations in high elevation regions especially over the 5000 m a s l and the accuracy of forcing data and model simulation is still unknown in addition the wind induced undercatch of snowfall in precipitation gauges may exaggerate the wetting bias but a previous study demonstrated that the morrison cloud microphysics schemes produced more snowfall in the wrf simulation orr et al 2017 the wet bias of precipitation and cold bias of temperature were directly responsible for the overestimation of sd and scf in the high elevation regions and the underestimation of sd near the ts gao et al 2020 li et al 2021a the uncertainty of the default scf scheme and snow albedo scheme in the noah mp model caused a relatively poor snow performance and cold bias in the thin snow regions especially in tp jiang et al 2020 wang et al 2020a above uncertainties may contribute to a colder temperature lower snowmelt rate and longer snow cover duration resulting in a ros overestimation over the thin snow regions in contrast an underestimated precipitation and swe in the low elevation regions may cause shorter snow cover durations consequently an underestimated frequency of ros events in addition the effects of irrigation aerosol and impurity on snowpack were not considered in both wrf downscaling simulation and later noah mp offline simulations which have been proven to increase the regional snowfall and intense snowmelt rate de kok et al 2020 kang et al 2020 sarangi et al 2020 respectively indeed the high humidity and latent energy environment in a maritime climate region were beneficial to more frequent ros events which were caused by warming the falling precipitation through condensation harpold and brooks 2018 thus neglecting these sources of uncertainties may also contribute to the underestimated ros events in the snowmelt period and crop growing season the lateral flow related processes in the snowpack especially in the ice layers were not characterized in the noah mp which may lead to underestimating the snowmelt rate during the early period and overestimating the rosintensity paquotte and baraer 2022 the thresholds for defining ros events according to pall et al 2019 were not revised over the hma due to a lack of hydrological data to evaluate and choose the suitable swe and rain thresholds for snowmelt flooding compared with a harsh threshold e g swe 10 mm d 1 rain 10 mm d 1 and snowmelt snowmelt rain 20 d 1 musselman et al 2018 and a lax threshold e g swe 1 mm d 1 rain 1 mm d 1 and snowmelt 0 mm d 1 il jeong and sushama 2018 over north america thresholds in this study may mask the small ros events which have a great impact on foraging animals rain 3 mm d 1 rennert et al 2009 and insufficiently characterize the extreme ros related flooding rain 25 mm d 1 huang et al 2022 which may cause the overestimated numbers of ros driven snowmelt flooding events 5 conclusions this study investigated the spatiotemporal variability of the rain on snow events across the high mountain asia and its influencing factors from 1981 to 2020 based on the stand alone noah mp land surface model simulations forced by hourly harv2 reanalysis data the following major findings can be summarized in this study 1 the rain on snow activity occurred more frequently in the higher elevation 2500 4000 m and 5500 6000 m a s l regions of the tianshan mountains pamir eastern hindu kush himalayas and the western hengduan shan with an annual maximum rain on snow frequency exceeding 15 days and a maximum intensity reaching 40 mm concentrated in spring and summer in contrast few or no rain on snow events were seen in the tibetan plateau 2 the rain on snow in the higher elevation 3000 4500 m a s l regions of the eastern hindu kush west himalaya and western hengduan shan experienced a significant decrease with a rate exceeding 1 5 days decade the consistent increase in air temperature caused more precipitation to shift from snowfall to rain and reduced the snowfall amount resulting in a shorter snow cover persistence accordingly decreasing the frequency of rain on snow events particularly in spring and summer 3 a significant augmentation mainly prevailed in the high elevation 5000 6000 m a s l regions of transhimalaya and east himalaya exceeding 0 9 days decade despite a decrease in snowfall precipitation ratio the significant increase in summer precipitation over the inner tibetan plateau and an absolute increase in snowfall were beneficial to the snow accumulation and augmentation of rain on snow events the ipcc figured out that the ros events will be gradually active from low mid elevation regions to high elevation regions in a consistently warming projection hock et al 2019 under this transition the specific variability of ros characteristics and their potential impacts should need more attention in different warming scenarios meanwhile the hma has the largest glacier mass storage after the polar regions yao et al 2022 and intense ros events may affect the glacier mass balance by modifying the properties i e albedo density of the snowpack and increasing the number of ice layers sobota et al 2020 the noah mp is still using a simplified scheme that could not represent the evolution of glacier mass and extent eidhammer et al 2021 simulation using glacier mass balance gradient model with convection permitting regional climate model provides the potential and practical approach to quantify the influence of ros event on glacier mass balance and snow characteristics eidhammer et al 2021 a suitable threshold of ros events definition with flooding potential in the hma should be revised according to the response of runoff to rain snowpack dynamics during the ros events occurrence in a typical catchment additionally the hydrological models will be considered to analyze the induced mechanism of ros driven snowmelt flooding and quantify its runoff contribution to individual ros event at a river catchment in further work credit authorship contribution statement tao yang methodology software writing original draft qian li writing review editing rafiq hamdi writing review editing xi chen supervision qiang zou funding acquisition resources fengqi cui visualization philippe de maeyer supervision lanhai li project administration writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was supported by the strategic priority research program of chinese academy of sciences grant no xda23090303 the projects of the second tibetan plateau scientific expedition and research program step grant no 2019qzkk0902 the project of applications for network security and informatization cas grant no cas wx2021sf 010604 the cas light of west china program grant no xbzg zdsys 202104 the national cryosphere desert data center grant no 2021kf02 the national natural science foundation of china grant no 42001061 and the china postdoctoral science foundation grant no 2021m703132 
2798,deep learning has been widely used in hydrological prediction such as monthly streamflow and its performance is usually dependent on the abundance of training data even though the interest in using predictors from multiple data sources e g streamflow observations local meteorological data and large scale climate indexes to train deep learning models for monthly streamflow prediction is growing these predictors are usually selected from historical periods such approaches have limitations that the non stationary future climate information is not included in the deep learning models climate models can provide non stationary climate information for the future period which may be useful for monthly streamflow prediction therefore the objectives of this study are to 1 investigate the added value of using predictors derived from global climate models gcms for monthly streamflow prediction based on a state of the art deep learning model and 2 propose a framework for integrating heterogeneous data sources for monthly streamflow prediction the framework consists of five integral components data collection predictor combination predictor selection model construction and results evaluation in this study a hybrid deep learning model combining convolutional neural network and gated recurrent unit was applied for six hydrological stations from mainstream and six stations from tributaries of the yangtze river historical hydroclimate data and gcm hindcasts from 1982 to 2010 are used in monthly streamflow forecasts hindcasts are retrospective forecasts for many variables in the past ideally conducted using the same model used for real time forecasts the results show that gcm hindcasts are useful predictors to improve the prediction accuracy for monthly streamflow predictions especially for the 1 and 3 month lead times combining gcm hindcasts with either historical meteorological data or historical streamflow observations and meteorological data as predictors generally provides the best predictive performance in addition using large scale climate indexes as ancillary information is able to improve the predictive performance at a lead time of 6 months for lead times of 1 3 and 6 months the kling gupta efficiency kge and the mean relative error mre metrics calculated based on the best performing predictor combinations are satisfactory for hydrological stations in both mainstream and tributaries with the median kge being higher than 0 85 and 0 62 and the median mre being approximately 20 and 40 respectively suggesting the monthly streamflow predictions are better for mainstream than for tributaries overall results show that 1 the inclusion of predicted information from gcms can improve the performance for monthly streamflow prediction and 2 the way of combining various heterogeneous data sources is crucial keywords monthly streamflow prediction deep learning global climate model heterogeneous data sources data availability the following data and code that support the findings of this study are available from the corresponding author upon reasonable request 1 all data used in this study 2 the code of the deep learning model 1 introduction accurate and reliable monthly streamflow prediction provides useful information for decision makers to formulate seasonal plans for regulating power generation water supply and ecological dispatch guo et al 2011 liu et al 2015 meng et al 2019 both process based models and data driven models ddms have been applied to predict monthly streamflows for various lead times although process based models help in clarifying the hydrological mechanisms their applicability and accuracy heavily depend on the quality of monthly meteorological predictions crochemore et al 2016 however the monthly meteorological prediction from climate models is usually less reliable for hydrological applications especially for longer lead times e g longer than 3 months lopez et al 2021 ma et al 2018 mo and lyon 2015 in addition the process based hydrological models usually suffer from multiple uncertainties originating from input data model structures and parameter sets especially in the non stationary conditions biondi and de luca 2013 lee et al 2012 differing from process based models ddms are trained to find the mapping relationships between predictors and the observed streamflow predictand their performances are usually reasonable for a watershed where historical data is abundant ren et al 2021 yang et al 2017 although the structure of ddms can be complicated the application is often simple and flexible slater et al 2019 wu and chau 2010 recent studies show that deep learning dl models outperform other data driven models in predicting monthly streamflow for example compared with the commonly used data driven statistical models such as autoregressive model ar auto regressive integrated moving average arima classification and regression trees carts erdal and karakurt 2013 kisi 2004 valipour et al 2013 one main advantage of dl is its capability in mapping complex nonlinear input output relationships tennant et al 2020 furthermore differing from shallow machine learning models with one or limited hidden layers to perform feature transformations such as neural networks nns sharma and tiwari 2009 wu and chau 2010 extreme learning machine elm niu et al 2019 and support vector regression svr sudheer et al 2014 adnan et al 2020 feng et al 2020b dl usually contains much more layers of processing units for learning the complex and high level representations of mass data alizadeh et al 2021 cheng et al 2020 herbert et al 2021 wang et al 2018 thus dl models have been widely used in recent years zhang et al 2018 zhao et al 2021 zhu et al 2020 however the existing dl models are usually trained by climate and hydrological information from historical periods e g ni et al 2020 yang et al 2017 which do not consider non stationary climate information from a future period the frequently used predictors include streamflow observations local meteorological data and or large scale climate indexes chu et al 2020 herbert et al 2021 ni et al 2020 ren et al 2020 yang et al 2017 the lack of future climate information may result in biased hydrological predictions especially in the condition of rapid climate change numerical forecasting models such as global climate models gcms are usually used to provide non stationary climate information for various lead times as they simulate the physical mechanisms of atmospheric circulations for future periods merryfield et al 2013 saha et al 2014 the ability of gcms in predicting precipitation temperature and other climate variables has been evaluated in numerous studies becker et al 2014 ma et al 2016 wang 2014 zhao et al 2019 more importantly the predicted climate variables have been used as inputs of process based hydrological models for streamflow predictions shrestha et al 2015 sikder et al 2016 slater et al 2019 thober et al 2015 yuan et al 2013 however to our knowledge the use of gcm predicted variables in deep learning models for non stationary monthly streamflow prediction has never been investigated accordingly the first goal of this study is to investigate the added value of including gcm predicted variables in a deep learning model for non stationary monthly streamflow prediction moreover the way of combining different data sources in monthly streamflow prediction is explored and tested by proposing a new framework of integrating multiple heterogeneous data sources the paper is structured as follows section 2 introduces the monthly streamflow prediction framework and its five integral components section 3 describes the study area and datasets section 4 presents the results and discussion and section 5 makes a brief conclusion 2 methodology the framework for monthly streamflow prediction consists of five integral components or steps fig 1 the first step is data collection four types of data sources are considered i e streamflow observations local meteorological data large scale climate indexes and gcm predicted variables precipitation and temperature to test the framework gcm hindcasts are used instead of gcm predicted variables the previous studies usually choose one source or a combination of two sources relying on industry experience or rules of thumb chu et al 2020 herbert et al 2021 ni et al 2020 ren et al 2020 yang et al 2017 but this framework combines all these data sources especially including gcm predicted variables the second step is the predictors combination there are fifteen combinations table 1 among which four combinations for one data source six for two types sources four for three types and one for four types specifically a4 is the case of using only gcm hindcasts while a1 a2 and a3 are cases of using only a single historical data source b3 b5 and b6 combine gcm hindcasts with a1 a2 and a3 respectively b2 b1 and b4 combine two types of historical data sources c2 c3 and c4 combine gcm hindcasts with b2 b1 and b4 c1 combines three types of historical data sources and d1 combines c1 with gcm hindcasts the third fourth and fifth steps are predictors selection prediction model construction and predictive performance evaluation the detailed procedures for these three steps are presented in section 2 1 section 2 2 and section 2 3 below 2 1 lasso regression model generally input variable selection approaches can be divided into three categories filter wrapper and embedded methods in filter methods statistical measures such as mutual information and linear pearson correlation are applied to assign a score to each variable according to its correlation with the target and thereafter variables with the highest scores are selected the filter methods examine each variable independently and hence have low complexity and high generalization however they ignore the combined effect of a selected subset of variables and thus may select redundant variables from highly correlated datasets the wrapper methods such as support vector machines decision tree and extreme learning machines yield nested subsets of variables based on the performance of the learning model the use of wrapper approaches is computational expensive although their performances are usually superior to filter methods the embedded methods take advantage of both filter and wrapper methods which perform variable selection during the process of training thus they are more accurate than filter methods and less computationally intensive than wrapper methods least absolute shrinkage and selection operator lasso an embedded variable selection model proposed by tibshirani 1996 was used in this study to select suitable predictors for monthly streamflow prediction lasso has three main advantages over other methods chu et al 2020 huebner et al 2015 first it can efficiently extract important variables from complex and high dimensional data sets to avoid the problem of over fitting second it can handle multicollinearity between variables to improve predictive performance third it is a computation efficient model that provides automatic variable selection the main steps of using the lasso regression model are presented as follows step 1 to eliminate the effects of dimensional difference and improve the convergence speed of the model the covariate vectors predictors and the response vector predictand are normalized step 2 a multivariate linear regression model is established between covariate vectors x x 1 x 2 x j x n in which x j x 1 j x 2 j x mj and the response vector y y 1 y 2 y m t which can be expressed as 1 y α β 1 x 1 β 2 x 2 β n x n where α denotes the constant parameter n denotes the number of covariate vectors to be selected and β denotes the estimated coefficients step 3 lasso produces a sparse solution by adding the penalty function to the regression equation the objective function of lasso can be expressed as 2 min i 1 m y i β 0 j 1 n x ij β j λ j 1 n β j where xij represents the jth covariate vector yi represents the ith value in the response vector m denotes the dimension of the response vector n denotes the number of covariate vectors β denotes the estimated coefficients and λ denotes the regularization parameter the regularization parameter λ controls the amount of shrinkage as λ increases some estimated coefficients become zero and thus their corresponding variables are removed from the model in this study the regularization parameter λ of the lasso regression model was estimated by the 10 fold cross validation method combined with the lassolarscv algorithm efron et al 2004 osborne et al 2000 2 2 hybrid cnn gru model a hybrid deep learning model combining convolutional neural network and gated recurrent unit i e cnn gru was used as the prediction model the topology of the cnn gru model is outlined in fig 2 there are five main components in the cnn gru model 1 two cnn layers are placed to process the input data sequence for feature extraction 2 a flatten layer is placed to process the extracted features from the max pooling layer into the format required by the gru layer 3 two gru layers are used for thoroughly learning the complex temporal dependencies 4 two fully connected layers are placed at the end of the model to perform nonlinear transformations 5 a dropout layer is put between fully connected layers to mitigate over fitting and to improve the generalization capability of the model more information about the cnn based and gru based individual learners is given as follows 1 convolution neural network cnn cnn is one of the most widely used deep feedforward neural networks lecun et al 1989 in recent years one dimensional 1 d cnn has received widespread attention due to its outstanding capability to handle complex sequence data and do automatic feature extraction ha and choi 2016 thus the 1 d cnn was used in this study for streamflow prediction specifically two convolution layers were placed after the input layer to extract high level representations from original input data within the stack of convolution layers max pooling layers were placed intermittently the convolution layer consists of several convolution kernels that convert input data into feature maps the max pooling layer down samples the neighboring values in feature maps thus reducing variability in the hidden activations and parameter dimensions 2 gated recurrent unit gru the recurrent neural networks rnns are prevailing deep learning methods for time series prediction kumar et al 2004 however the traditional rnns cannot deal with long term temporal dependencies and thus face the problem of vanishing and exploding gradients gers et al 2000 as a particular type of rnns the gru overcomes the problem of the traditional rnns by introducing a memory unit concept consisting of two gate structures i e reset gate and update gate cho et al 2014 moreover as a simplified version of lstm the gru maintains superior performance in handling highly nonlinear sequence data while requiring much less training time gao et al 2020 the complex dependencies are thoroughly learned by the examination of two effective gates in gru specifically the reset gate determines the amount of previous information to forget while the update gate determines the amount of previous information to be carried over to the current state the forward pass of the gru cell is presented as follows reset gate 3 r t σ w r h t 1 x t b r update gate 4 z t σ w z h t 1 x t b z current candidate cell state 5 c t tanh w c x t w c r t h t 1 b c new state of the memory cell 6 c t 1 z t c t 1 z t c t external state 7 h t c t where xt is the input of the memory cell at moment t w r wz and wc are the weights matrices br bz and bc are the bias vectors is the product of vector elements and σ and tanh is the sigmoid and tanh activation function 2 3 model evaluation metrics two metrics including the kling gupta efficiency kge gupta et al 2009 and mean relative error mre were used to evaluate the predictive performance of monthly streamflow predictions kge ranges from to 1 and the larger value is equivalent to the better model performance while the value of mre is expected to be closer to zero for better predictions these two metrics can be computed as 8 kge 1 ρ 1 2 β 1 2 γ 1 2 9 mre i q si q oi q oi 100 where ρ is the linear pearson correlation coefficient between observed and simulated data β is the ratio of the means of simulated to observed data and γ is the ratio of the standard deviation of simulated to observed data in eq 9 i represents the number of time steps and q represents the runoff time series the subscript o and s are abbreviations of observed and simulated streamflow time series 3 study area and datasets 3 1 study area the performance of monthly streamflow prediction was tested over 12 major hydrological stations in the yangtze river basin yrb table 2 six of which are located at the mainstream and the others are located at the six largest tributaries including the min river the wu river the jialing river the han river the dongting lake and the poyang lake the yangtze river is the largest river in eurasia with a length of more than 6 300 km and acatchment areaof approximately 1 8 106 km2 fig 3 the yrb plays a crucial role in china s society and economy due to its dense population and high level of gross domestic product gdp with the rapid development of economy in recent decades there is an increasing need for water related stakeholders to effectively manage water resources 3 2 datasets this study used four types of data sources three of which are historical data and one is gcm predicted climate variables 3 2 1 historical data 1 daily streamflow data for 12 hydrological stations were obtained from the national hydrological yearbook of the yrb all historical data covers the period of 1981 2010 without missing values daily streamflow time series were aggregated to monthly data 2 daily meteorological data were obtained from the china meteorological data network http data cma cn where a high resolution 0 5 0 5 gridded dataset consisting of daily precipitation maximum and minimum air temperatures spanning the period of 1961 2016 is provided this dataset has been subjected to strictly quality checking zhao et al 2014 zhao and zhu 2015 and the period of 1981 2010 was used in this study in addition daily meteorological data were aggregated to monthly values and monthly meteorological data for each sub watershed were calculated by averaging all grid points within the sub watershed and surround 3 monthly large scale climate indexes including 88 atmospheric circulation indices 26 sea surface temperature sst indices and 16 other indices were obtained from the national climate center of the china meteorological administration https cmdp ncc cma net monitoring cn index 130 php the dataset is updated every month dating back to 1951 the period of 1981 2010 was selected in this study 3 2 2 climate model hindcasts climate model hindcasts were obtained from eight north american multi model ensemble nmme gcms all eight gcms are made publicly available with the spatial resolution of 1 1 on latitude and longitude detailed information of these gcms is listed in table 3 gcm data used in this study include monthly precipitation maximum and minimum air temperatures even though other climate variables are also included in each gcm the use of precipitation and air temperature is more straightforward for streamflow prediction each gcm consists of multiple members however only ensemble mean was used as candidate predictor since previous studies christiansen 2018 rougier 2016 have shown that the multi member ensemble mean outperforms any single integration forecast in addition gcm data were regridded to match the observed meteorological data using the bilinear interpolation and the mean values were calculated for each sub watershed by averaging all grid points within the sub watershed and surround 3 2 3 model inputs and pre processing the time lag effect of streamflow observations meteorological data and climate indexes on predicted monthly streamflow was taken into account lag times of 6 12 18 and 24 months were used as shown in fig s1 all historical data covers the period of 1981 2010 all climate model hindcasts cover the period of 1983 2010 in order to evaluate the proposed model for monthly stramflow predictions the model should be test at the historical period therefore we use some data in the historical period to represent that in the future period in other words some data in the historical period are used to train the model while some independent data in the historical period are used to test the model performance 1 3 and 6 month ahead streamflow predictions were conducted for all selected hydrological stations for example this study firstly assumes that streamflow in january 1983 is unknown lead times of 1 3 and 6 months mean that prediction for january 1983 is issued at the beginning of january 1983 november 1982 and august 1982 respectively historical observations in or before december 1982 october 1982 and july 1982 and gcm hindcasts in january 1983 are used as model inputs to make the 1 3 and 6 months ahead forecasts respectively as shown in fig 2 historical data sequences box colored red yellow and blue represents streamflow observations local meteorological data and large scale climate indexes respectively are transformed into multiple fixed length sequences by using an overlapping sliding window the window takes one step forward each time to recombine the collected data where m denotes the length of the training set and t represents the window size in this study the window size t was set to 6 12 18 and 24 months corresponding to four types of lag times the figure depicts model inputs for the case of 1 month ahead prediction the number of historical candidate predictors is 1 3 130 t the number is 1 3 130 t 2 and 1 3 130 t 5 for lead times of 3 and 6 months respectively in this study identical k fold cross validation approach was used to train the dl model with k value equals to 28 in other words the results for each single year as the testing year were obtained by the dl model trained without the testing year for example the streamflow data in 1983 is temporarily held out for testing and the prediction model is trained with the data from 1984 to 2010 after that another year e g 1984 is selected as the testing year and the same model training procedure is carried out until all years of data have been used as the testing set in theory the deep learning would be more adequately trained through leave one month out cross validation procedure however this is very computational expensive and even unaffordable by personal computers since 12 times of workload are required adopting a leave one year out testing strategy is a compromise solution to overcome the sample size limitations and lower the computational cost 4 results and discussion 4 1 the role of gcm hindcasts on a deep learning model two metrics of kge and mre are illustrated in figs 4 6 respectively for monthly streamflow predictions with lead times of 1 3 and 6 months kge and mre values for all hydrological stations can be found in tables s1 s12 in the supplementary information results for hydrological stations in the mainstream and tributaries of the yangtze river were analyzed separately the results show that the deep learning model generally performs better when including gcm hindcasts as predictors for monthly streamflow prediction fig 4 most combinations show a modest increase of 0 01 0 05 and 0 05 0 10 in kge for hydrological stations in the mainstream and tributaries respectively the largest improvements are found for b3 a combination of streamflow observations and gcm hindcasts the reduction of mre is also apparent for b3 see fig 4b1 and b2 specifically compared with only using historical streamflow observations with a 6 month lag time as predictors a1 the introduction of gcm hindcasts b3 reduces the median mre from 26 7 to 21 7 for hydrological stations in the mainstream for stations in the tributaries the median mre is reduced from 42 7 to 34 3 as shown in fig 5a1 b1 and fig 6a1 b1 the introduction of gcm hindcasts has larger benefits when using historical data with a 6 month lag time than using historical data with lag times of 12 18 and 24 months gcm hindcasts to some extent compensate for the lack of sufficient representation of useful information when using historical data with shorter lag times moreover the combinations of gcm hindcasts and one historical data source b3 b5 and b6 perform better than using a single historical data source a1 a2 and a3 see fig 6a2 and b2 overall although gcm hindcasts themselves a4 cannot produce satisfactory predictive performance they generally improve the predictive performance when used in combination with historical meteorological data b5 or with historical meteorological data and streamflow observations c3 4 2 the influence of predictor combinations on predictive performance for 1 month ahead prediction the kge score in fig 4a1 shows that predictions of b5 c4 and d1 using a 6 month lag time tend to outperform other predictor combinations with median kge being larger than 0 89 however there is no clear difference in the predictive performance for combination c3 at any lag time using only gcm hindcasts as predictors a4 generally shows the worst performance kge 0 76 further indicating that gcm hindcasts should be combined with other predictors for monthly streamflow prediction fig 4a2 shows that the cases of using b3 b5 c3 c4 and d1 as predictors show the best performance with median kge varying from 0 68 to 0 70 in fig 4b1 the median mre value is the lowest when using c3 as predictors followed by b1 b5 and a2 with the corresponding values being 18 3 19 2 19 3 and 19 6 when using a 24 month lag time in fig 4b2 combination b3 produces the lowest mre value of approximately 34 5 generally the mre value does not decrease uniformly with longer lag times and is somewhat erratic for 3 month ahead prediction b5 and c3 using 12 and 24 month lag times produce the highest kge value of approximately 0 85 fig 5a1 while using a1 and a4 as predictors shows the worst performance fig 5a2 the median kge values of the rest predictor combinations when using 12 18 and 24 month lag times range between 0 58 and 0 62 the choice of lag times has more influence on predictive performance than the choice of predictor combinations especially for hydrological stations in the tributaries fig 5b1 and b2 this may be due to the elaborate relationships between lagged climate indices and hydrological elements for 6 month ahead prediction the median kge values of all combinations are similar fig 6a1 and a2 but the a3 b2 b4 b6 c1 c2 c4 and d1 driven predictions slightly outperform other predictor combinations when using 12 18 and 24 month lag times this means that the large scale climate indexes are useful in improving the predictive performance at the lead time of 6 months the median mre values of various combinations also do not show a clear difference fig 6b1 and b2 in addition a2 with an 18 month lag produces the lowest mre value of 20 5 fig 6b1 a2 with a 12 month lag and c3 with a 24 month lag have the lowest mre value of 39 7 and 39 5 respectively fig 6b2 overall the predictive performance assessment suggests that the proposed cnn gru model using any of the 15 combinations as predictors performs reasonably well with the kge value greater than 0 70 for all hydrological stations in the mainstream of the yangtze river for lead times up to 3 months in addition when appropriate predictor combinations are selected e g a combination of gcm hindcasts historical meteorological data and streamflow observations the predictive performance is even better with the median kge being higher than 0 85 and the median mre being close to 20 for lead times of 1 3 and 6 months even for the six hydrological stations in tributaries the median kge is higher than 0 60 for lead times up to 6 months in some studies only a short lag time was used for model inputs for example the lag time for model inputs was only set up to 2 months in yang et al 2017 while they recommended investigating the optimal latency of large scale climate indexes when conducting monthly streamflow prediction considering longer lag times in our study tend to produce better prediction accuracy when only using previous streamflow observations as predictors however it does not necessarily produce better results in the case of using other combinations as predictors the choice of lag times has a moderate impact on predictive performance this finding is similar to that of cheng et al 2020 where they found that the length of time lag exerts great impacts on model predictive performance at monthly scale therefore taking various lag times of historical data into consideration is recommended 4 3 different predictive performance among hydrological stations the predicted monthly hydrographs using gcm hindcasts historical meteorological data and streamflow observations i e c3 as predictors are shown in fig 7 for 12 hydrological stations the figure illustrates that the accuracy of streamflow prediction is highly dependent on hydrological stations for stations 1 7 the cnn gru model predicted hydrographs exhibit a good overall match to observed hydrographs for lead times up to 6 months in addition the prediction model performs slightly better for 1 month ahead prediction for stations 8 12 the prediction model always underestimates the high flows in addition the predictive performance decreases as lead time increases take station 10 i e huangzhuang station as an example the high flows around 1983 1984 2003 and 2005 are consistently underestimated two large peak flows that happened around 2007 and 2010 are well captured by 1 month ahead prediction whereas the prediction results from the other two lead times remain underestimated overall better prediction accuracy is observed on hydrological stations in the mainstream than those in the tributaries of the yangtze river in terms of the evaluation metrics calculated based on the combination c3 as seen in figs 4 6 for stations in the mainstream the kge values range between 0 84 and 0 91 0 79 and 0 87 and 0 79 and 0 87 and the mre values range between 16 4 and 29 0 18 1 and 31 7 and 18 5 and 31 9 for lead times of 1 3 and 6 month respectively for stations in the tributaries the kge values range between 0 65 and 0 91 0 39 and 0 90 and 0 36 and 0 87 and the mre values range between 17 4 and 43 0 18 9 and 48 1 and 17 9 and 49 8 for lead times of 1 3 and 6 month respectively in order to explain the difference in predictive performance among hydrological stations the partial auto correlation function pacf and the average mutual information ami metrics were used for the estimation of temporal correlations in monthly streamflow series the ami measures the general dependence linear or nonlinear relationship of hydrologic time series whereas the pacf shows the dependence from the perspective of linearity fig 8 displays the pacf and ami from lag 0 to lag 25 months from these curves it is observed that the absolute values of the first and second order pacf are large for stations 1 7 ranging between 0 73 and 0 78 and between 0 37 and 0 54 respectively however when the time lag t is two months the pacf of stations 8 12 is within the boundary of the 95 confidence interval illustrated by the black dashed line this means that the pacf values are not significant at the lag of 2 correspondingly better prediction accuracy is observed on stations 1 7 than stations 8 12 the ami values of stations 1 9 appear like a cosine wave the wave crests appear at lags of 6 12 18 and 24 the first order ami is large for stations 2 7 however the ami values are lower than 0 3 after the first lag month for stations 10 and 12 the worst predictive performance for stations 10 huangzhuang and 12 meigang can be partially explained by the lowest ami values from lag 1 to lag 25 months and low first and second order pacf values low auto correlations of monthly streamflow series in these two basins indicate limited baseflow contributions and weak surface groundwater connections feng et al 2020a in other words the surface water in these two basins is usually caused by random rainfall events with short durations and large magnitudes which is difficult to be predicted in contrast the prediction model performs the best in station 7 gaochang which is located at the upper stream of the yangtze river for this basin human activities are not important in streamflow formation as indicated by the highest temporal correlations however in some tributaries stations 8 12 the streamflow was subjected to intense human activities for example the soil and water conservation project implemented since 1989 affected the streamflow characteristics of the jialing river station 8 gao et al 2010 shao et al 2021a shao et al 2021b wu et al 2012 the full operation of the wujiangdu reservoir since 1984 decreased the downstream sediment load and streamflow for the wu river station 9 wei et al 2014 the danjiangkou reservoir located in the middle reaches of the han river has large impacts on annual distribution of streamflow in the downstream region station 10 song et al 2018 li et al 2020 hydrologic regimes in dongting and poyang lakes stations 11 and 12 were significantly altered since the impoundment of the three gorges reservoir in 2003 zhou et al 2019 besides for the poyang lake basin the increase in vegetation coverage since 1980s might also affect the streamflow characteristics fan et al 2018 for these river basins the streamflows are also difficult to be predicted 4 4 limitations and future work many studies have indicated that climate change and human activities would inevitably lead to the non stationarity of streamflow time series zhang and lu 2009 jiang et al 2019 which make the prediction of streamflow become increasingly difficult although the climate non stationarity was implicitly considered by our modeling approach by using gcm data for the future period the influence of human activities on the changes of streamflows is not considered to further improve the prediction performance various predictors relevant to human activities may need to be included as inputs of the prediction model these predictors consist of upstream reservoirs inflow outflow and water level normalized difference vegetation index ndvi and agricultural industrial and domestic water withdrawal for monthly streamflow prediction in china these predictors can be obtained from multiple sources for example china s multi period land use land cover remote sensing monitoring data set cnlucc can be downloaded from the resources and environment science and data center https www resdc cn agriculture industrial and domestic water withdrawal data at the 0 5 0 5 grid scale can be derived from the isimip2b project https data isimip org search more information about how to generate monthly ndvi and sectoral water withdrawal data can be found in szilagyi et al 1998 and ma et al 2020 respectively additionally one potential downside of the deep learning model is its requirement for a massive amount of training data samples shokri et al 2015 yu et al 2022 therefore dividing the monthly streamflow data into twelve groups and train them independently may not adequately train the deep learning model however human activities have different effects at the monthly scale which result in various changes in streamflow regimes between different months it is also unreasonable to apply the same model to different months to partly solve this problem we suggest first using various predictor combinations that merge different human related factors to train deep learning models and then select the optimal model for each month according to the predictive performance in the training period to better reveal the mechanism of model performance when using various predictor combinations for different tributaries the relationships among large scale climate indexes local meteorological features and watershed hydrology should be thoroughly investigated large scale climate indexes usually have direct impacts on local meteorological features and indirect impacts on local hydrology however their relationships are complicated which are hard to distinguish even though satisfactory prediction results are achieved in our study some questions remain 1 what are the relationships among monthly streamflow precipitation temperature and climate indexes and 2 how do the large scale climate indexes influence local meteorological features and hydrology future studies are suggested to investigate the interactions of certain correlated model inputs and their impacts on local hydrology continued effort in the development of interpretive deep leaning is also encouraged combining the physically based hydrological model and the deep learning model could help us shed light to the mechanisms and design better prediction models besides due to the computational load for gridded data over the yangtze river basin only mean areal data were used in this study the use of distributed spatial data may further improve the model performance which can be investigated in future studies for smaller river basins 5 conclusion this study investigated the role of gcm predicted variables hindcasts were used to test the framework on monthly streamflow prediction when using the deep learning model and the influence of predictor combinations on predictive performance streamflow observations local meteorological data large scale climate indexes and predicted climate variables from 8 nmme gcms were used as predictors a state of the art deep learning model namely cnn gru was adopted for 1 3 and 6 month ahead streamflow predictions over twelve hydrological stations in the yrb the following conclusions can be drawn 1 gcm precipitation and temperature are useful predictors in monthly streamflow predictions especially for 1 and 3 month lead times the inclusion of gcm hindcasts generally produces the best predictive performance when used in combination with historical meteorological data or with historical meteorological data and streamflow observations 2 including large scale climate indexes is useful in improving the predictive performance when gcm hindcasts are no longer accurate at a lead time of 6 months 3 the proposed cnn gru based framework is promising in monthly streamflow prediction the statistics obtained by the best performing predictor combinations are satisfactory for lead times up to 6 months for 12 stations in the yangtze river with the median kge being higher than 0 80 and the median mre being lower than 28 4 prediction model performance is highly dependent on hydrological stations temporal correlations in monthly streamflow series can partially explain the varation of predictive performance over different stations in the case of yangtze river better prediction accuracy is observed on hydrological stations in the mainstream than those in the tributaries specifically for stations in the mainstream the median kge values range between 0 85 and 0 89 and the median mre values from 18 3 to 20 5 for lead times of 1 3 and 6 month for stations in the tributaries the median kge values range between 0 62 and 0 70 and the median mre values from 34 3 to 39 5 for different lead times credit authorship contribution statement wenxin xu methodology software formal analysis investigation visualization writing original draft jie chen conceptualization data curation funding acquisition supervision writing review editing xunchang j zhang validation writing review editing supervision lihua xiong resources writing review editing hua chen resources writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was partially supported by the natural science foundation of china grant no 52079093 the hubei provincial natural science foundation of china grant no 2020cfa100 and the overseas expertise introduction project for discipline innovation 111 project funded by the ministry of education and state administration of foreign experts affairs p r china grant no b18037 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128599 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2798,deep learning has been widely used in hydrological prediction such as monthly streamflow and its performance is usually dependent on the abundance of training data even though the interest in using predictors from multiple data sources e g streamflow observations local meteorological data and large scale climate indexes to train deep learning models for monthly streamflow prediction is growing these predictors are usually selected from historical periods such approaches have limitations that the non stationary future climate information is not included in the deep learning models climate models can provide non stationary climate information for the future period which may be useful for monthly streamflow prediction therefore the objectives of this study are to 1 investigate the added value of using predictors derived from global climate models gcms for monthly streamflow prediction based on a state of the art deep learning model and 2 propose a framework for integrating heterogeneous data sources for monthly streamflow prediction the framework consists of five integral components data collection predictor combination predictor selection model construction and results evaluation in this study a hybrid deep learning model combining convolutional neural network and gated recurrent unit was applied for six hydrological stations from mainstream and six stations from tributaries of the yangtze river historical hydroclimate data and gcm hindcasts from 1982 to 2010 are used in monthly streamflow forecasts hindcasts are retrospective forecasts for many variables in the past ideally conducted using the same model used for real time forecasts the results show that gcm hindcasts are useful predictors to improve the prediction accuracy for monthly streamflow predictions especially for the 1 and 3 month lead times combining gcm hindcasts with either historical meteorological data or historical streamflow observations and meteorological data as predictors generally provides the best predictive performance in addition using large scale climate indexes as ancillary information is able to improve the predictive performance at a lead time of 6 months for lead times of 1 3 and 6 months the kling gupta efficiency kge and the mean relative error mre metrics calculated based on the best performing predictor combinations are satisfactory for hydrological stations in both mainstream and tributaries with the median kge being higher than 0 85 and 0 62 and the median mre being approximately 20 and 40 respectively suggesting the monthly streamflow predictions are better for mainstream than for tributaries overall results show that 1 the inclusion of predicted information from gcms can improve the performance for monthly streamflow prediction and 2 the way of combining various heterogeneous data sources is crucial keywords monthly streamflow prediction deep learning global climate model heterogeneous data sources data availability the following data and code that support the findings of this study are available from the corresponding author upon reasonable request 1 all data used in this study 2 the code of the deep learning model 1 introduction accurate and reliable monthly streamflow prediction provides useful information for decision makers to formulate seasonal plans for regulating power generation water supply and ecological dispatch guo et al 2011 liu et al 2015 meng et al 2019 both process based models and data driven models ddms have been applied to predict monthly streamflows for various lead times although process based models help in clarifying the hydrological mechanisms their applicability and accuracy heavily depend on the quality of monthly meteorological predictions crochemore et al 2016 however the monthly meteorological prediction from climate models is usually less reliable for hydrological applications especially for longer lead times e g longer than 3 months lopez et al 2021 ma et al 2018 mo and lyon 2015 in addition the process based hydrological models usually suffer from multiple uncertainties originating from input data model structures and parameter sets especially in the non stationary conditions biondi and de luca 2013 lee et al 2012 differing from process based models ddms are trained to find the mapping relationships between predictors and the observed streamflow predictand their performances are usually reasonable for a watershed where historical data is abundant ren et al 2021 yang et al 2017 although the structure of ddms can be complicated the application is often simple and flexible slater et al 2019 wu and chau 2010 recent studies show that deep learning dl models outperform other data driven models in predicting monthly streamflow for example compared with the commonly used data driven statistical models such as autoregressive model ar auto regressive integrated moving average arima classification and regression trees carts erdal and karakurt 2013 kisi 2004 valipour et al 2013 one main advantage of dl is its capability in mapping complex nonlinear input output relationships tennant et al 2020 furthermore differing from shallow machine learning models with one or limited hidden layers to perform feature transformations such as neural networks nns sharma and tiwari 2009 wu and chau 2010 extreme learning machine elm niu et al 2019 and support vector regression svr sudheer et al 2014 adnan et al 2020 feng et al 2020b dl usually contains much more layers of processing units for learning the complex and high level representations of mass data alizadeh et al 2021 cheng et al 2020 herbert et al 2021 wang et al 2018 thus dl models have been widely used in recent years zhang et al 2018 zhao et al 2021 zhu et al 2020 however the existing dl models are usually trained by climate and hydrological information from historical periods e g ni et al 2020 yang et al 2017 which do not consider non stationary climate information from a future period the frequently used predictors include streamflow observations local meteorological data and or large scale climate indexes chu et al 2020 herbert et al 2021 ni et al 2020 ren et al 2020 yang et al 2017 the lack of future climate information may result in biased hydrological predictions especially in the condition of rapid climate change numerical forecasting models such as global climate models gcms are usually used to provide non stationary climate information for various lead times as they simulate the physical mechanisms of atmospheric circulations for future periods merryfield et al 2013 saha et al 2014 the ability of gcms in predicting precipitation temperature and other climate variables has been evaluated in numerous studies becker et al 2014 ma et al 2016 wang 2014 zhao et al 2019 more importantly the predicted climate variables have been used as inputs of process based hydrological models for streamflow predictions shrestha et al 2015 sikder et al 2016 slater et al 2019 thober et al 2015 yuan et al 2013 however to our knowledge the use of gcm predicted variables in deep learning models for non stationary monthly streamflow prediction has never been investigated accordingly the first goal of this study is to investigate the added value of including gcm predicted variables in a deep learning model for non stationary monthly streamflow prediction moreover the way of combining different data sources in monthly streamflow prediction is explored and tested by proposing a new framework of integrating multiple heterogeneous data sources the paper is structured as follows section 2 introduces the monthly streamflow prediction framework and its five integral components section 3 describes the study area and datasets section 4 presents the results and discussion and section 5 makes a brief conclusion 2 methodology the framework for monthly streamflow prediction consists of five integral components or steps fig 1 the first step is data collection four types of data sources are considered i e streamflow observations local meteorological data large scale climate indexes and gcm predicted variables precipitation and temperature to test the framework gcm hindcasts are used instead of gcm predicted variables the previous studies usually choose one source or a combination of two sources relying on industry experience or rules of thumb chu et al 2020 herbert et al 2021 ni et al 2020 ren et al 2020 yang et al 2017 but this framework combines all these data sources especially including gcm predicted variables the second step is the predictors combination there are fifteen combinations table 1 among which four combinations for one data source six for two types sources four for three types and one for four types specifically a4 is the case of using only gcm hindcasts while a1 a2 and a3 are cases of using only a single historical data source b3 b5 and b6 combine gcm hindcasts with a1 a2 and a3 respectively b2 b1 and b4 combine two types of historical data sources c2 c3 and c4 combine gcm hindcasts with b2 b1 and b4 c1 combines three types of historical data sources and d1 combines c1 with gcm hindcasts the third fourth and fifth steps are predictors selection prediction model construction and predictive performance evaluation the detailed procedures for these three steps are presented in section 2 1 section 2 2 and section 2 3 below 2 1 lasso regression model generally input variable selection approaches can be divided into three categories filter wrapper and embedded methods in filter methods statistical measures such as mutual information and linear pearson correlation are applied to assign a score to each variable according to its correlation with the target and thereafter variables with the highest scores are selected the filter methods examine each variable independently and hence have low complexity and high generalization however they ignore the combined effect of a selected subset of variables and thus may select redundant variables from highly correlated datasets the wrapper methods such as support vector machines decision tree and extreme learning machines yield nested subsets of variables based on the performance of the learning model the use of wrapper approaches is computational expensive although their performances are usually superior to filter methods the embedded methods take advantage of both filter and wrapper methods which perform variable selection during the process of training thus they are more accurate than filter methods and less computationally intensive than wrapper methods least absolute shrinkage and selection operator lasso an embedded variable selection model proposed by tibshirani 1996 was used in this study to select suitable predictors for monthly streamflow prediction lasso has three main advantages over other methods chu et al 2020 huebner et al 2015 first it can efficiently extract important variables from complex and high dimensional data sets to avoid the problem of over fitting second it can handle multicollinearity between variables to improve predictive performance third it is a computation efficient model that provides automatic variable selection the main steps of using the lasso regression model are presented as follows step 1 to eliminate the effects of dimensional difference and improve the convergence speed of the model the covariate vectors predictors and the response vector predictand are normalized step 2 a multivariate linear regression model is established between covariate vectors x x 1 x 2 x j x n in which x j x 1 j x 2 j x mj and the response vector y y 1 y 2 y m t which can be expressed as 1 y α β 1 x 1 β 2 x 2 β n x n where α denotes the constant parameter n denotes the number of covariate vectors to be selected and β denotes the estimated coefficients step 3 lasso produces a sparse solution by adding the penalty function to the regression equation the objective function of lasso can be expressed as 2 min i 1 m y i β 0 j 1 n x ij β j λ j 1 n β j where xij represents the jth covariate vector yi represents the ith value in the response vector m denotes the dimension of the response vector n denotes the number of covariate vectors β denotes the estimated coefficients and λ denotes the regularization parameter the regularization parameter λ controls the amount of shrinkage as λ increases some estimated coefficients become zero and thus their corresponding variables are removed from the model in this study the regularization parameter λ of the lasso regression model was estimated by the 10 fold cross validation method combined with the lassolarscv algorithm efron et al 2004 osborne et al 2000 2 2 hybrid cnn gru model a hybrid deep learning model combining convolutional neural network and gated recurrent unit i e cnn gru was used as the prediction model the topology of the cnn gru model is outlined in fig 2 there are five main components in the cnn gru model 1 two cnn layers are placed to process the input data sequence for feature extraction 2 a flatten layer is placed to process the extracted features from the max pooling layer into the format required by the gru layer 3 two gru layers are used for thoroughly learning the complex temporal dependencies 4 two fully connected layers are placed at the end of the model to perform nonlinear transformations 5 a dropout layer is put between fully connected layers to mitigate over fitting and to improve the generalization capability of the model more information about the cnn based and gru based individual learners is given as follows 1 convolution neural network cnn cnn is one of the most widely used deep feedforward neural networks lecun et al 1989 in recent years one dimensional 1 d cnn has received widespread attention due to its outstanding capability to handle complex sequence data and do automatic feature extraction ha and choi 2016 thus the 1 d cnn was used in this study for streamflow prediction specifically two convolution layers were placed after the input layer to extract high level representations from original input data within the stack of convolution layers max pooling layers were placed intermittently the convolution layer consists of several convolution kernels that convert input data into feature maps the max pooling layer down samples the neighboring values in feature maps thus reducing variability in the hidden activations and parameter dimensions 2 gated recurrent unit gru the recurrent neural networks rnns are prevailing deep learning methods for time series prediction kumar et al 2004 however the traditional rnns cannot deal with long term temporal dependencies and thus face the problem of vanishing and exploding gradients gers et al 2000 as a particular type of rnns the gru overcomes the problem of the traditional rnns by introducing a memory unit concept consisting of two gate structures i e reset gate and update gate cho et al 2014 moreover as a simplified version of lstm the gru maintains superior performance in handling highly nonlinear sequence data while requiring much less training time gao et al 2020 the complex dependencies are thoroughly learned by the examination of two effective gates in gru specifically the reset gate determines the amount of previous information to forget while the update gate determines the amount of previous information to be carried over to the current state the forward pass of the gru cell is presented as follows reset gate 3 r t σ w r h t 1 x t b r update gate 4 z t σ w z h t 1 x t b z current candidate cell state 5 c t tanh w c x t w c r t h t 1 b c new state of the memory cell 6 c t 1 z t c t 1 z t c t external state 7 h t c t where xt is the input of the memory cell at moment t w r wz and wc are the weights matrices br bz and bc are the bias vectors is the product of vector elements and σ and tanh is the sigmoid and tanh activation function 2 3 model evaluation metrics two metrics including the kling gupta efficiency kge gupta et al 2009 and mean relative error mre were used to evaluate the predictive performance of monthly streamflow predictions kge ranges from to 1 and the larger value is equivalent to the better model performance while the value of mre is expected to be closer to zero for better predictions these two metrics can be computed as 8 kge 1 ρ 1 2 β 1 2 γ 1 2 9 mre i q si q oi q oi 100 where ρ is the linear pearson correlation coefficient between observed and simulated data β is the ratio of the means of simulated to observed data and γ is the ratio of the standard deviation of simulated to observed data in eq 9 i represents the number of time steps and q represents the runoff time series the subscript o and s are abbreviations of observed and simulated streamflow time series 3 study area and datasets 3 1 study area the performance of monthly streamflow prediction was tested over 12 major hydrological stations in the yangtze river basin yrb table 2 six of which are located at the mainstream and the others are located at the six largest tributaries including the min river the wu river the jialing river the han river the dongting lake and the poyang lake the yangtze river is the largest river in eurasia with a length of more than 6 300 km and acatchment areaof approximately 1 8 106 km2 fig 3 the yrb plays a crucial role in china s society and economy due to its dense population and high level of gross domestic product gdp with the rapid development of economy in recent decades there is an increasing need for water related stakeholders to effectively manage water resources 3 2 datasets this study used four types of data sources three of which are historical data and one is gcm predicted climate variables 3 2 1 historical data 1 daily streamflow data for 12 hydrological stations were obtained from the national hydrological yearbook of the yrb all historical data covers the period of 1981 2010 without missing values daily streamflow time series were aggregated to monthly data 2 daily meteorological data were obtained from the china meteorological data network http data cma cn where a high resolution 0 5 0 5 gridded dataset consisting of daily precipitation maximum and minimum air temperatures spanning the period of 1961 2016 is provided this dataset has been subjected to strictly quality checking zhao et al 2014 zhao and zhu 2015 and the period of 1981 2010 was used in this study in addition daily meteorological data were aggregated to monthly values and monthly meteorological data for each sub watershed were calculated by averaging all grid points within the sub watershed and surround 3 monthly large scale climate indexes including 88 atmospheric circulation indices 26 sea surface temperature sst indices and 16 other indices were obtained from the national climate center of the china meteorological administration https cmdp ncc cma net monitoring cn index 130 php the dataset is updated every month dating back to 1951 the period of 1981 2010 was selected in this study 3 2 2 climate model hindcasts climate model hindcasts were obtained from eight north american multi model ensemble nmme gcms all eight gcms are made publicly available with the spatial resolution of 1 1 on latitude and longitude detailed information of these gcms is listed in table 3 gcm data used in this study include monthly precipitation maximum and minimum air temperatures even though other climate variables are also included in each gcm the use of precipitation and air temperature is more straightforward for streamflow prediction each gcm consists of multiple members however only ensemble mean was used as candidate predictor since previous studies christiansen 2018 rougier 2016 have shown that the multi member ensemble mean outperforms any single integration forecast in addition gcm data were regridded to match the observed meteorological data using the bilinear interpolation and the mean values were calculated for each sub watershed by averaging all grid points within the sub watershed and surround 3 2 3 model inputs and pre processing the time lag effect of streamflow observations meteorological data and climate indexes on predicted monthly streamflow was taken into account lag times of 6 12 18 and 24 months were used as shown in fig s1 all historical data covers the period of 1981 2010 all climate model hindcasts cover the period of 1983 2010 in order to evaluate the proposed model for monthly stramflow predictions the model should be test at the historical period therefore we use some data in the historical period to represent that in the future period in other words some data in the historical period are used to train the model while some independent data in the historical period are used to test the model performance 1 3 and 6 month ahead streamflow predictions were conducted for all selected hydrological stations for example this study firstly assumes that streamflow in january 1983 is unknown lead times of 1 3 and 6 months mean that prediction for january 1983 is issued at the beginning of january 1983 november 1982 and august 1982 respectively historical observations in or before december 1982 october 1982 and july 1982 and gcm hindcasts in january 1983 are used as model inputs to make the 1 3 and 6 months ahead forecasts respectively as shown in fig 2 historical data sequences box colored red yellow and blue represents streamflow observations local meteorological data and large scale climate indexes respectively are transformed into multiple fixed length sequences by using an overlapping sliding window the window takes one step forward each time to recombine the collected data where m denotes the length of the training set and t represents the window size in this study the window size t was set to 6 12 18 and 24 months corresponding to four types of lag times the figure depicts model inputs for the case of 1 month ahead prediction the number of historical candidate predictors is 1 3 130 t the number is 1 3 130 t 2 and 1 3 130 t 5 for lead times of 3 and 6 months respectively in this study identical k fold cross validation approach was used to train the dl model with k value equals to 28 in other words the results for each single year as the testing year were obtained by the dl model trained without the testing year for example the streamflow data in 1983 is temporarily held out for testing and the prediction model is trained with the data from 1984 to 2010 after that another year e g 1984 is selected as the testing year and the same model training procedure is carried out until all years of data have been used as the testing set in theory the deep learning would be more adequately trained through leave one month out cross validation procedure however this is very computational expensive and even unaffordable by personal computers since 12 times of workload are required adopting a leave one year out testing strategy is a compromise solution to overcome the sample size limitations and lower the computational cost 4 results and discussion 4 1 the role of gcm hindcasts on a deep learning model two metrics of kge and mre are illustrated in figs 4 6 respectively for monthly streamflow predictions with lead times of 1 3 and 6 months kge and mre values for all hydrological stations can be found in tables s1 s12 in the supplementary information results for hydrological stations in the mainstream and tributaries of the yangtze river were analyzed separately the results show that the deep learning model generally performs better when including gcm hindcasts as predictors for monthly streamflow prediction fig 4 most combinations show a modest increase of 0 01 0 05 and 0 05 0 10 in kge for hydrological stations in the mainstream and tributaries respectively the largest improvements are found for b3 a combination of streamflow observations and gcm hindcasts the reduction of mre is also apparent for b3 see fig 4b1 and b2 specifically compared with only using historical streamflow observations with a 6 month lag time as predictors a1 the introduction of gcm hindcasts b3 reduces the median mre from 26 7 to 21 7 for hydrological stations in the mainstream for stations in the tributaries the median mre is reduced from 42 7 to 34 3 as shown in fig 5a1 b1 and fig 6a1 b1 the introduction of gcm hindcasts has larger benefits when using historical data with a 6 month lag time than using historical data with lag times of 12 18 and 24 months gcm hindcasts to some extent compensate for the lack of sufficient representation of useful information when using historical data with shorter lag times moreover the combinations of gcm hindcasts and one historical data source b3 b5 and b6 perform better than using a single historical data source a1 a2 and a3 see fig 6a2 and b2 overall although gcm hindcasts themselves a4 cannot produce satisfactory predictive performance they generally improve the predictive performance when used in combination with historical meteorological data b5 or with historical meteorological data and streamflow observations c3 4 2 the influence of predictor combinations on predictive performance for 1 month ahead prediction the kge score in fig 4a1 shows that predictions of b5 c4 and d1 using a 6 month lag time tend to outperform other predictor combinations with median kge being larger than 0 89 however there is no clear difference in the predictive performance for combination c3 at any lag time using only gcm hindcasts as predictors a4 generally shows the worst performance kge 0 76 further indicating that gcm hindcasts should be combined with other predictors for monthly streamflow prediction fig 4a2 shows that the cases of using b3 b5 c3 c4 and d1 as predictors show the best performance with median kge varying from 0 68 to 0 70 in fig 4b1 the median mre value is the lowest when using c3 as predictors followed by b1 b5 and a2 with the corresponding values being 18 3 19 2 19 3 and 19 6 when using a 24 month lag time in fig 4b2 combination b3 produces the lowest mre value of approximately 34 5 generally the mre value does not decrease uniformly with longer lag times and is somewhat erratic for 3 month ahead prediction b5 and c3 using 12 and 24 month lag times produce the highest kge value of approximately 0 85 fig 5a1 while using a1 and a4 as predictors shows the worst performance fig 5a2 the median kge values of the rest predictor combinations when using 12 18 and 24 month lag times range between 0 58 and 0 62 the choice of lag times has more influence on predictive performance than the choice of predictor combinations especially for hydrological stations in the tributaries fig 5b1 and b2 this may be due to the elaborate relationships between lagged climate indices and hydrological elements for 6 month ahead prediction the median kge values of all combinations are similar fig 6a1 and a2 but the a3 b2 b4 b6 c1 c2 c4 and d1 driven predictions slightly outperform other predictor combinations when using 12 18 and 24 month lag times this means that the large scale climate indexes are useful in improving the predictive performance at the lead time of 6 months the median mre values of various combinations also do not show a clear difference fig 6b1 and b2 in addition a2 with an 18 month lag produces the lowest mre value of 20 5 fig 6b1 a2 with a 12 month lag and c3 with a 24 month lag have the lowest mre value of 39 7 and 39 5 respectively fig 6b2 overall the predictive performance assessment suggests that the proposed cnn gru model using any of the 15 combinations as predictors performs reasonably well with the kge value greater than 0 70 for all hydrological stations in the mainstream of the yangtze river for lead times up to 3 months in addition when appropriate predictor combinations are selected e g a combination of gcm hindcasts historical meteorological data and streamflow observations the predictive performance is even better with the median kge being higher than 0 85 and the median mre being close to 20 for lead times of 1 3 and 6 months even for the six hydrological stations in tributaries the median kge is higher than 0 60 for lead times up to 6 months in some studies only a short lag time was used for model inputs for example the lag time for model inputs was only set up to 2 months in yang et al 2017 while they recommended investigating the optimal latency of large scale climate indexes when conducting monthly streamflow prediction considering longer lag times in our study tend to produce better prediction accuracy when only using previous streamflow observations as predictors however it does not necessarily produce better results in the case of using other combinations as predictors the choice of lag times has a moderate impact on predictive performance this finding is similar to that of cheng et al 2020 where they found that the length of time lag exerts great impacts on model predictive performance at monthly scale therefore taking various lag times of historical data into consideration is recommended 4 3 different predictive performance among hydrological stations the predicted monthly hydrographs using gcm hindcasts historical meteorological data and streamflow observations i e c3 as predictors are shown in fig 7 for 12 hydrological stations the figure illustrates that the accuracy of streamflow prediction is highly dependent on hydrological stations for stations 1 7 the cnn gru model predicted hydrographs exhibit a good overall match to observed hydrographs for lead times up to 6 months in addition the prediction model performs slightly better for 1 month ahead prediction for stations 8 12 the prediction model always underestimates the high flows in addition the predictive performance decreases as lead time increases take station 10 i e huangzhuang station as an example the high flows around 1983 1984 2003 and 2005 are consistently underestimated two large peak flows that happened around 2007 and 2010 are well captured by 1 month ahead prediction whereas the prediction results from the other two lead times remain underestimated overall better prediction accuracy is observed on hydrological stations in the mainstream than those in the tributaries of the yangtze river in terms of the evaluation metrics calculated based on the combination c3 as seen in figs 4 6 for stations in the mainstream the kge values range between 0 84 and 0 91 0 79 and 0 87 and 0 79 and 0 87 and the mre values range between 16 4 and 29 0 18 1 and 31 7 and 18 5 and 31 9 for lead times of 1 3 and 6 month respectively for stations in the tributaries the kge values range between 0 65 and 0 91 0 39 and 0 90 and 0 36 and 0 87 and the mre values range between 17 4 and 43 0 18 9 and 48 1 and 17 9 and 49 8 for lead times of 1 3 and 6 month respectively in order to explain the difference in predictive performance among hydrological stations the partial auto correlation function pacf and the average mutual information ami metrics were used for the estimation of temporal correlations in monthly streamflow series the ami measures the general dependence linear or nonlinear relationship of hydrologic time series whereas the pacf shows the dependence from the perspective of linearity fig 8 displays the pacf and ami from lag 0 to lag 25 months from these curves it is observed that the absolute values of the first and second order pacf are large for stations 1 7 ranging between 0 73 and 0 78 and between 0 37 and 0 54 respectively however when the time lag t is two months the pacf of stations 8 12 is within the boundary of the 95 confidence interval illustrated by the black dashed line this means that the pacf values are not significant at the lag of 2 correspondingly better prediction accuracy is observed on stations 1 7 than stations 8 12 the ami values of stations 1 9 appear like a cosine wave the wave crests appear at lags of 6 12 18 and 24 the first order ami is large for stations 2 7 however the ami values are lower than 0 3 after the first lag month for stations 10 and 12 the worst predictive performance for stations 10 huangzhuang and 12 meigang can be partially explained by the lowest ami values from lag 1 to lag 25 months and low first and second order pacf values low auto correlations of monthly streamflow series in these two basins indicate limited baseflow contributions and weak surface groundwater connections feng et al 2020a in other words the surface water in these two basins is usually caused by random rainfall events with short durations and large magnitudes which is difficult to be predicted in contrast the prediction model performs the best in station 7 gaochang which is located at the upper stream of the yangtze river for this basin human activities are not important in streamflow formation as indicated by the highest temporal correlations however in some tributaries stations 8 12 the streamflow was subjected to intense human activities for example the soil and water conservation project implemented since 1989 affected the streamflow characteristics of the jialing river station 8 gao et al 2010 shao et al 2021a shao et al 2021b wu et al 2012 the full operation of the wujiangdu reservoir since 1984 decreased the downstream sediment load and streamflow for the wu river station 9 wei et al 2014 the danjiangkou reservoir located in the middle reaches of the han river has large impacts on annual distribution of streamflow in the downstream region station 10 song et al 2018 li et al 2020 hydrologic regimes in dongting and poyang lakes stations 11 and 12 were significantly altered since the impoundment of the three gorges reservoir in 2003 zhou et al 2019 besides for the poyang lake basin the increase in vegetation coverage since 1980s might also affect the streamflow characteristics fan et al 2018 for these river basins the streamflows are also difficult to be predicted 4 4 limitations and future work many studies have indicated that climate change and human activities would inevitably lead to the non stationarity of streamflow time series zhang and lu 2009 jiang et al 2019 which make the prediction of streamflow become increasingly difficult although the climate non stationarity was implicitly considered by our modeling approach by using gcm data for the future period the influence of human activities on the changes of streamflows is not considered to further improve the prediction performance various predictors relevant to human activities may need to be included as inputs of the prediction model these predictors consist of upstream reservoirs inflow outflow and water level normalized difference vegetation index ndvi and agricultural industrial and domestic water withdrawal for monthly streamflow prediction in china these predictors can be obtained from multiple sources for example china s multi period land use land cover remote sensing monitoring data set cnlucc can be downloaded from the resources and environment science and data center https www resdc cn agriculture industrial and domestic water withdrawal data at the 0 5 0 5 grid scale can be derived from the isimip2b project https data isimip org search more information about how to generate monthly ndvi and sectoral water withdrawal data can be found in szilagyi et al 1998 and ma et al 2020 respectively additionally one potential downside of the deep learning model is its requirement for a massive amount of training data samples shokri et al 2015 yu et al 2022 therefore dividing the monthly streamflow data into twelve groups and train them independently may not adequately train the deep learning model however human activities have different effects at the monthly scale which result in various changes in streamflow regimes between different months it is also unreasonable to apply the same model to different months to partly solve this problem we suggest first using various predictor combinations that merge different human related factors to train deep learning models and then select the optimal model for each month according to the predictive performance in the training period to better reveal the mechanism of model performance when using various predictor combinations for different tributaries the relationships among large scale climate indexes local meteorological features and watershed hydrology should be thoroughly investigated large scale climate indexes usually have direct impacts on local meteorological features and indirect impacts on local hydrology however their relationships are complicated which are hard to distinguish even though satisfactory prediction results are achieved in our study some questions remain 1 what are the relationships among monthly streamflow precipitation temperature and climate indexes and 2 how do the large scale climate indexes influence local meteorological features and hydrology future studies are suggested to investigate the interactions of certain correlated model inputs and their impacts on local hydrology continued effort in the development of interpretive deep leaning is also encouraged combining the physically based hydrological model and the deep learning model could help us shed light to the mechanisms and design better prediction models besides due to the computational load for gridded data over the yangtze river basin only mean areal data were used in this study the use of distributed spatial data may further improve the model performance which can be investigated in future studies for smaller river basins 5 conclusion this study investigated the role of gcm predicted variables hindcasts were used to test the framework on monthly streamflow prediction when using the deep learning model and the influence of predictor combinations on predictive performance streamflow observations local meteorological data large scale climate indexes and predicted climate variables from 8 nmme gcms were used as predictors a state of the art deep learning model namely cnn gru was adopted for 1 3 and 6 month ahead streamflow predictions over twelve hydrological stations in the yrb the following conclusions can be drawn 1 gcm precipitation and temperature are useful predictors in monthly streamflow predictions especially for 1 and 3 month lead times the inclusion of gcm hindcasts generally produces the best predictive performance when used in combination with historical meteorological data or with historical meteorological data and streamflow observations 2 including large scale climate indexes is useful in improving the predictive performance when gcm hindcasts are no longer accurate at a lead time of 6 months 3 the proposed cnn gru based framework is promising in monthly streamflow prediction the statistics obtained by the best performing predictor combinations are satisfactory for lead times up to 6 months for 12 stations in the yangtze river with the median kge being higher than 0 80 and the median mre being lower than 28 4 prediction model performance is highly dependent on hydrological stations temporal correlations in monthly streamflow series can partially explain the varation of predictive performance over different stations in the case of yangtze river better prediction accuracy is observed on hydrological stations in the mainstream than those in the tributaries specifically for stations in the mainstream the median kge values range between 0 85 and 0 89 and the median mre values from 18 3 to 20 5 for lead times of 1 3 and 6 month for stations in the tributaries the median kge values range between 0 62 and 0 70 and the median mre values from 34 3 to 39 5 for different lead times credit authorship contribution statement wenxin xu methodology software formal analysis investigation visualization writing original draft jie chen conceptualization data curation funding acquisition supervision writing review editing xunchang j zhang validation writing review editing supervision lihua xiong resources writing review editing hua chen resources writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was partially supported by the natural science foundation of china grant no 52079093 the hubei provincial natural science foundation of china grant no 2020cfa100 and the overseas expertise introduction project for discipline innovation 111 project funded by the ministry of education and state administration of foreign experts affairs p r china grant no b18037 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128599 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2799,flood prediction in ungauged catchments is usually conducted by hydrological models that are parameterized based on nearby and similar gauged catchments as an alternative to this process based modelling deep learning dl models have demonstrated their ability for prediction in ungauged catchments pub with high efficiency catchment characteristics the number of gauged catchments and their level of hydroclimatic heterogeneity in the training dataset used for model regionalization can directly affect the model s performance here we study the generalization ability of a dl model to these factors by applying an encoder decoder long short term memory neural network for a 6 hour lead time runoff prediction in 35 mountainous catchments in china by varying the available number of catchments and model settings with different training datasets namely local regional and pub models we evaluated the generalization ability of our model we found that both quantity i e number of gauged catchments available and heterogeneity of the training dataset used for the dl model are important for improving model performance in the pub context due to a data synergy effect the assessment of the sensitivity to catchment characteristics showed that the model performance is mainly correlated to the local hydro climatic conditions the more arid the region the more likely it is to have a poor model performance for prediction in ungauged catchments the results suggest that the regional ed lstm model is a promising method to predict streamflow from rainfall inputs in pub and outline the need for preparing a representative training dataset keywords flood prediction ungauged catchments deep learning lstm data availability the code of encoder decoder lstm modeling is available through github https github com yikuizh edlstm flood prediction rainfall and runoff data from ground stations in china that were used for this study are not freely available for academic or commercial use contact sr for further details 1 introduction accurate and computationally efficient hydrological models are necessary for streamflow prediction to issue timely warnings for flash floods moore et al 2005 physics based hydrological models are the most robust models that can be used for this purpose they simulate physical processes in the rainfall runoff transformation with parameters that represent soil land surface and climate properties that need to be optimized for each geographic location with observations but most catchments worldwide lack hydrological monitoring data and are considered ungauged guo et al 2021 meaning that direct calibration of catchment parameters in these catchments is not possible for this reason the problem of prediction in ungauged basins pub has received considerable attention in the hydrological community sivapalan et al 2003 one solution to the calibration of hydrological models for catchments without available data utilizes the concept of parameter regionalization the idea is to use parameters calibrated in gauged catchments to predict the model parameters in a target ungauged catchment blöschl and sivapalan 1995 similarity based and regression based methods are widely used for model regionalization oudin et al 2008 for example beck et al 2016 proposed a scheme for the regionalization of model parameters at the global scale based on a similarity approach by selecting 10 gauged catchments with the most similar characteristics as donors for parameter transfer however the question of how to identify the selection criteria for choosing the optimal donor catchments remains a challenge that restricts the wide application of this method ragettli et al 2017 applied the classification and regression tree cart method to explore parameter transferability in the full space of catchment descriptors for the hydrological model and showed that this method can be an effective tool for identifying similarity among catchments however it is model dependent and relies on manually identifying the similarity and then transferring the parameter set from a series of pre defined hydrological models an alternative solution to parameterized hydrological models for streamflow simulation in ungauged catchments is the use of data driven deep learning dl models these models can be directly trained with inputs from meteorological and catchment characteristic data to simulate streamflow without using a physical hydrological model to pre define their similarity for example kratzert et al 2019 evaluated the ability of a long short term memory lstm model for the regionalization of over 500 catchments in the usa they concluded that data driven models had a strong capacity to learn non linear climate runoff relationships and to achieve model regionalization without identifying pre defined criteria for similar donor catchments the catchment characteristics e g topography land use and the climatic training dataset are the two most important factors that affect the model regionalization and the setup of a physical hydrological model in ungauged catchments teutschbein et al 2018 gong et al 2021 while the performance of hydrological models in ungauged catchments is sensitive to these two factors there are only a few studies that evaluated the generalization ability of data driven dl models for example potdar et al 2021 predicted flood peak discharge in ungauged catchments based on the gradient boosted trees model xgboost and found that catchment geomorphologic attributes have a higher impact on the prediction skill than climatologic attributes gauch et al 2021 studied the sensitivity of the prediction skill of the lstm model for daily streamflow in the usa to additional training samples and showed that it is not enough to train data driven models on a few gauged catchments but one should strive to use as many catchments as possible fang et al 2022 proposed a concept of data synergy pointing out that to achieve higher predictive performance a representative dataset with large but heterogeneous training samples i e different characteristics of catchments is needed however the generalization of dl models to the pub problem with respect to the representativeness of the training dataset and catchment characteristics has not been studied thoroughly yet this study aims to evaluate the generalization ability of a dl model to predict floods in ungauged catchments considering the above factors for this purpose an encoder decoder lstm ed lstm neural network was applied to set up a forecast model for a 6 hour lead time streamflow prediction in 35 mountain catchments in china three model setups i a local model for each catchment ii a regional model and iii regional pub models which differ in the choice of training and testing catchments were applied their performances were compared to the cart regionalization method to evaluate the ability of the dl model to predict streamflow in the ungauged catchments ragettli et al 2017 the analysis of the generalization ability of the pub models concerning the training dataset and catchment characteristics was conducted by comparing the three model setups the main purpose is to provide recommendations on the importance of preparing representative training datasets in the context of pub with dl methods we aim to answer the question of how ed lstm models and other rainfall runoff dl based models may be used for event based flood forecasting and which data requirements have to be present to provide reasonably accurate predictions in ungauged basins 2 data and models 2 1 study area the study focuses on 35 mountainous catchments table s1 located in ten chinese provinces fig 1 the catchments were classified as northern catchments 17 and southern catchments 18 based on the traditional geographical south north division of china which is called the huai river qin mountain line this line approximates the 0 c january isotherm and the 800 mm isohyet zhao et al 2015 mean annual precipitation in the north is on average 57 lower than in the south and mean annual air temperatures are on average 6 c lower the catchment areas range from 14 to 1693 km2 whereas the mean catchment size is 278 km2 hourly hydrological and meteorological data are available from stream and rain gauges located within or in close vicinity to the catchments fig 1 in addition the county weather stations record daily maximum and minimum 2 meter air temperature on average 11 years of data are available per catchment with 1 to 7 storm events occurring per year between april and october we consider storm events as days with total precipitation greater than 5 mm d 1 following the definition by ragettli et al 2017 each of the catchments is characterized by several static variables kratzert et al 2019 describing their climatic vegetation soil and topographical properties table s3 2 2 long short term memory lstm network lstm networks are a type of recurrent neural network that can learn time dependencies in time series data hochreiter and schmidhuber 1997 it has cell and hidden states which can account for the long short term memory effects therefore it is a good choice for modeling time series of runoff as it can account for a range of time dependent delays like seasonality and natural annual variability cycles long term months to years and the immediate rainfall runoff response short term minutes to hours equations 1 to 6 provide the mathematical formulation of the lstm at each time step f t σ w f x t u f h t 1 b f 1 i t σ w i x t u i h t 1 b i 2 c t tanh w g x t u g h t 1 b g 3 o t σ w o x t u o h t 1 b o 4 c t f t c t 1 i t c t 5 h t o t tanh c t 6 where f t i t c t o t and h t represent the forget gate input gate cell state output gate and hidden state at each time step respectively w u and b are the weights and bias term of the neural network the σ sigmoid function and tanh are two activation functions and x t are the inputs the lstm cell has three gates maintaining and adjusting its cell state and hidden state fig 2 including a forget gate eq 1 an input gate eq 2 and an output gate eq 4 each gate has a sigmoid function that adds non linearity to the linear combination of the input x t and hidden state from last time step h t 1 eqs 3 and 5 represent how much input and last hidden state is contributed to the cell state c t finally the output h t of the current time step is calculated from the output gate and cell state shown in eq 6 cell state and hidden state are then passed to the next time step the encoder decoder ed fig 2 structure has been used in the field of sequence to sequence prediction problems especially for language translation cho et al 2014 the encoder and decoder enable the model to operate on different input and output time steps the ed lstm model consists of two lstm networks in both the encoder and the decoder parts the application of the ed structure in lstms can efficiently improve the performance of ahead time prediction in the field of hydrology since the existence of the encoding and decoding architecture can eliminate the restriction on the length of input and output sequences kao et al 2020 in this case the input and output sequences do not necessarily have the same time steps the input and output can be flexible to embed different types of input data for example catchment static variables and rainfall time series can be used as input to the model at the same time unlike the basic lstm structure the encoder layer only outputs the hidden state from the last cell then it is copied as input for each lstm cell in the decoder layer it contains information collected from the input sequence at each time step thus it could be effective to use this structure to improve long term dependencies for longer time step prediction than in the regular lstm in this study five additional dense layers were set after the lstm decoder layer for better decoding of the sequence output at each time step 3 experiment setup 3 1 input data composition the ed lstm model experiments described in the next section require dynamic and static inputs the dynamic input data includes the following climate variables i hourly precipitation ii hourly streamflow and iii maximum minimum 2 m daily air temperature the dynamic inputs were divided into an observation phase and a prediction phase fig 3 the first phase includes 24 hour precipitation temperature and streamflow data computed from the hourly observed data before the prediction phase the second phase contains the 6 hour precipitation and temperature as driving data for the streamflow forecast also previously observed streamflow was used as the dynamic input because it is known to improve forecast e g song et al 2020 daily maximum and minimum temperature data are used to better account for snow induced streamflow processes e g xiang et al 2020 we reduced the number of static catchment attributes from a total of 27 table s2 to 14 table s3 using a principal component pc analysis preserving only the uncorrelated attributes that represent best the natural clusters in each category of catchment characteristics singh et al 2014 the absolute pc scores table s4 of each selected attribute were taken to represent the uncorrelated patterns rather than the individual catchment characteristics ragettli et al 2017 3 2 numerical experiments three different ed lstm numerical experiments were set up i local models i e a unique ed lstm setup for each of the catchments ii a regional model simulating all catchments at once and iii regional pub models models that include both gauged and ungauged catchments in different combinations in the first experiment ed lstm models were trained and tested on individual catchments without using data from other catchments in total 35 local models were set up only the dynamic variables were applied as input data and no static variables were involved in this setup preliminary tests were conducted on the catchment with the longest training samples to select the optimal ed lstm model hyperparameters in the second experiment we set up a regional model namely one model for all catchments this ed lstm model was trained and tested using an ensemble of events from all catchments together the regional model was applied with both the dynamic and static variables as inputs kratzert et al 2018 demonstrated that the lstm model can perform better with a regional model setting than with a setup for individual catchments as in the first experiment as more data is available for model training i e additional rainfall runoff interactions are available for the lstm to learn from this experiment aims to find out how much can the flood warning prediction ability benefit from a large training dataset in the last experiment the regional ed lstm setup was applied for prediction in the context of ungauged catchments pub models we conducted two tests here first to explore the ed lstm generalization ability to the number of gauged catchments used in the training and second to the characteristics of the catchment to explore the first question we followed a similar setup as for the regional model however we trained the model with fewer catchments using the k fold validation strategy which enables us to test the model performance on unseen catchments in the training process the k fold validation is commonly used for model parameter selection e g chang et al 2015 but here we used it as a tool for an out of sample prediction the 35 catchments were split randomly into k groups namely folds of approximately equal size catchments from k 1 groups were used to train the model and then the model was tested on the remaining single group of catchments as ungauged catchments this procedure is repeated k times so that out of sample predictions are made available to all catchments kratzert et al 2019 as the catchments are heterogeneous the number of valid training samples varies at first 10 fold validation was adopted to train 10 models with the same model structure and each model was applied for the prediction in three ungauged catchments this means that the training process was repeated 10 times with different 32 catchments to cover all catchments pub1 table s4 to evaluate the generalization ability of the pub modeling to the catchment characteristics such as climate and topography k means clustering methods were applied for classifying and grouping the catchments based on the 27 catchment static variables listed in table s2 including climatic topographic vegetation and catchment drainage properties based on the silhouette scores fig s1 we found that five clusters are required to group the catchments by their attributes we averaged the model performance based on each cluster fang et al 2022 hypothesized that dl based models will have a better prediction skill in the context of pub if a regional model is not trained on a relatively small and hydrologically homogenous dataset e g few catchments but sharing similar hydrological characteristics but rather on a larger and heterogeneous sample e g multiple catchments with varying characteristics to test this effect additional experiments were conducted the pub model was applied to each of the 5 clusters to create a new pub model for the smaller sub regions represented by the clusters the leave one out scheme was used so each sub regional pub model was trained on n 1 catchments and tested on a specific catchment the pub model was then applied to either the north 17 catchments in dry and cold climate or the south 18 wet and warm catchments to examine the effects of regionalization performance on the sample size e g gong et al 2021 the pub experiment was iterated for a different number of catchments in training ranging from 18 to 30 based on fold numbers from 2 to 10 pub2 to pub6 table s4 as a reference for the quality of the ed lstm model predictions in the pub mode we used simulations for the 35 catchments by the prms hydrological model presented in ragettli et al 2017 note that ragettli et al 2017 used two cart methods to emulate parameter regionalization in ungauged catchments however we used only the results of their classification tree as our reference as the other cart method resulted in a very similar model performance the training strategy of the ed lstm model was as follows in the first step we determined the hyperparameters e g learning rate batch size cell numbers based on a grid search the hydrometeorological dataset was divided into training validation and testing sets 50 25 and 25 respectively using the local model afterward the dataset was split into training and testing sets for training the local and regional experiments 75 and 25 respectively for the pub models all data in gauged catchments were used for training while the events in ungauged catchments were used for testing all ed lstm models had 256 memory cells in both the encoder and decoder layer with a dropout rate of 0 4 based on the results of the hyperparameter grid search there were 128 64 32 16 and 1 cells in the five dense layers after the lstm layer and the optimal batch size was 32 3 3 evaluation metrics the evaluation of the model performance aimed to i assess the capacity of the model to reproduce an overall streamflow fit at the event scale and ii evaluate its ability to correctly identify streamflow extremes i e the peak flow which is important for flood warning the nash sutcliffe efficiency nse nash and sutcliffe 1970 metric was used to assess the overall streamflow fit 7 nse 1 sim t obs t 2 obs t obs m 2 where sim and obs are the predicted and observed streamflow t indicates a given time step and m refers to the mean nse ranges from infinity to 1 with 1 being a perfect match nse values larger than 0 5 can be considered as a satisfying prediction capacity while the value of 0 signifies that the prediction is as good as the mean of the observations moriasi et al 2007 flood frequency analysis was used for the quantification of flood warning performance the cumulative distribution function of the generalized extreme value distribution was applied to estimate the return periods of the observed and simulated hourly streamflow peaks see ragettli et al 2017 for example for each storm event we determined if the maximum hourly streamflow exceeded a reference flood quantile of a given return period we consider the 2 year return period to represent common high streamflow and the 10 year return period to represent a severe flood we identified three cases for flood prediction performance following javelle et al 2016 i hit h when both simulated and observed streamflow exceeded the flow threshold corresponding to a certain return period indicating high flow ii miss m when the simulated streamflow was below the threshold and failed to agree with the high flow detected by observations and iii false alert fa when the simulated streamflow indicated a high flow but the observed streamflow did not see the contingency table in table s5 moreover to assess the temporal accuracy of reproducing the peak flow a 2 hour condition was added to the evaluation which means that if the simulated peak flow had a 2 hour shift compared to the observed peak the prediction was also identified as a miss three contingency scores were computed for evaluating the flood warning ability i the probability of detection pod eq 8 which is the fraction of correct event predictions hits in all observed high flow events ii the success rate sr eq 9 which is the fraction of hits in the total number of all high flow event predictions iii and the critical success index csi eq 10 which is the fraction of hits in the total number of event predictions plus the number of missed observations 8 pod h h m 9 sr h h f a 10 csi h h m f a 4 results 4 1 evaluation of the model performance first we compared the nse values between the observed and predicted streamflow in the three experiments fig 4 we qualitatively divided the nse values into three performance groups poor nse 0 average 0 nse 0 5 and above average nse 0 5 the training of local models resulted in 14 catchments with above average nse values and 12 catchments with poor nse values while in the regional model most catchments resulted in an above average performance and only three catchments had poor performance fig 4a evaluating the performance of the pub models in the north and south areas separately fig 4b and c it becomes apparent that the models have better prediction ability in southern catchments with a considerably higher number of models with good performance 4 on average in the northern catchments in comparison to 12 on average in the southern ones compared to ragettli et al 2017 s results the pub model performed better than the cart based method in the northern catchments as 2 1 catchments resulted in above average performance and 5 9 catchments in poor performance for the pub cart based model fig 4a and b in southern catchments the performance distribution of the two methods is nearly identical fig 4c the results of the contingency scores evaluating the flood warning performance are presented in table 1 for the 2 year return period events the regional and the pub models had the best performances equally for detecting streamflow peaks pod values of 0 85 sr values of 0 82 and csi values of 0 72 considering all catchments for prediction in ungauged catchments pub models outperform the cart based regionalization methods by 12 on the probability of detection considering all catchments similarly pub models have a better success rate and critical success index in comparison to the cart based regionalization for the 10 year return period events all models contingency scores decreased by at least 10 in line with the 2 year return period predictions the regional and pub models showed the best performance pod of 0 7 considering all catchments again the performance of the pub models was 10 higher than cart based methods the pub model achieved the best performance for sr and csi scores instead of being equal to the regional model results indicate that the model detection performances were affected by the climate as in wetter climate i e the southern catchments better prediction abilities were observed than in the drier regions i e the northern catchments the generalization ability increases with the prediction of higher streamflow from an order of 8 difference between the southern and northern catchments for the 2 year return period to 30 for the 10 year return period exception is pub 10 year return period 4 2 generalization ability to different training dataset fig 5 shows the overall performance of pub models that were trained on different sub regions the homogeneous similar climate dataset did not improve but rather impair the pub model performance fig 5a while the median nse value of the model trained on southern catchments was similar to the result trained on the global dataset around 0 5 for the northern sub region the model performance was significantly worse than the result when trained on all catchments this is even more evident when the models are trained based on the climate clusters fig 5b where the overall performance has decreased significantly compared to the median nse when the models are trained on the entire dataset for clusters 1 and 3 the median has dropped significantly from around 0 35 to 0 1 and 0 7 respectively in addition the variation of the models nse skill i e the box plots increases in all models trained on the cluster based homogenous datasets in comparison to the training with the entire region datasets with negative lower quartile and lower whisker nse values reaching 1 for clusters 1 3 and 4 the model generalization ability to the number of catchments used for training is presented in fig s4 the median nse of pub models did not vary notably for models trained on 32 to 24 catchments but when the number of catchments used in the training dataset was below 18 the median nse declined from 0 3 to only 0 15 fig sa and this decline trend is consistent for even smaller number of catchments in contrast to the nse results the pod scores of the pub models do not degrade with the decreasing number of training catchments and all pub models demonstrate good flood warning capability with median pod scores higher than 0 8 fig s4b however model performance at an individual catchment may not always be improved when trained on a large dataset as shown in fig 6 four performance categories can be distinguished i performance is similar for all models e g yimen catchment ii poor performance in the local model but satisfactory in others e g shangliu catchment iii poor performance in the pub model but satisfactory in others e g pei river and iv random performance variation with model setup e g qigu catchment most of the catchments 12 fall into category ii performance followed by 10 catchments with category i performance but still 8 catchments fall into category iii while 5 resulted in category iv with a poorer performance even though they were trained using a larger dataset 4 3 generalization ability to catchment characteristics the classification of the 35 catchments into five classes based on the k means clustering method is presented in fig 7 a of the northern catchments 11 81 were grouped into cluster 5 the southern catchments were classified into clusters 2 to 4 catchments from the southwest were mostly clustered in cluster 2 while catchments from the southeast region were grouped in cluster 4 the catchments in cluster 1 and cluster 3 are mainly located in central china in henan province the five clusters represent different climatological and hydrological conditions table 2 cluster 5 climate is arid to semi arid with a ratio of annual potential evapotranspiration to precipitation pet p lower than 1 moreover the catchments in cluster 5 are mainly located in high mountain areas in northern latitudes fig 7a and thus are also colder on average compared to catchments in other clusters the catchments in cluster 3 are located in lower flatter and warmer areas the topography attributes of cluster 4 are similar to cluster 3 however the latter is more humid the catchments in cluster 2 are located in high elevation warm and humid areas and are located in southwest china fig 7a the climatic and topographical characteristics of the catchments in cluster 1 are intermediate of the clusters and the three catchments associated with this cluster are found in central china fig 7a the models are sensitive to the catchment characteristics as the model performances vary between clusters the nse scores of the clustered catchments in the pub model in clusters 2 and 4 both above 0 5 are the highest among the five clusters while cluster 5 has the lowest median nse with 0 23 table 2 and fig 7b a declining trend in nse values is also observed from south to north fig 7b the pod scores however show no remarkable differences in flood warning capability between clusters with the highest value of 0 91 in cluster 4 and the lowest values of 0 76 in clusters 2 and 5 table 2 a negative correlation was found between pet p used as climate proxy and nse fig 8 a indicating that the dl model is more likely to perform well in wetter areas however such a relationship cannot be observed between pod scores and pet p fig 8b no correlations of either nse or pod were found with topographic attributes for example neither nse nor pod shows a clear correlation with the h gradient used as a proxy for topographic steepness fig 8c and d 5 discussion 5 1 use of the ed lstm in the pub context the pub model using the regional ed lstm structure showed a higher skill in predicting high streamflow than the conceptual hydrological model fig 4 and table 1 even in catchments with poor prediction performance i e nse 0 5 where the streamflow is not perfectly simulated by the ed lstm model decent performances for flood warning were obtained i e high pod values it is further evident in the results that the pub model is not sensitive to the number of training catchments and always keeps a good flood warning skill fig s5 this implies that while the deep learning models do not always learn the streamflow dynamic i e the time series as a whole well they can still extrapolate the extreme streamflow events this is further seen when plotting the correlation between nse and pod fig s2 it also implies that there is a high similarity in the intense observed rainfall between the catchments which triggers flood peaks of similar magnitude there may be a potential to use deep learning for flood prediction in ungauged catchments even if the number of gauged catchments is small in other words the ed lstm appears to be a reliable flood warning model in ungauged catchments since it does not require successfully capturing the entire event hydrograph and the timing of the peak but rather solely forecasting the magnitude of the peak given a similar size of training data the prediction ability of an lstm model is often much better than physics based models kratzert et al 2018 frame et al 2022 while the physically based regionalization method selects and transfers the optimal parameter set from a gauged catchment to an ungauged catchment yang et al 2018 more flexibility is found with the ed lstm pub approach as the model adapts to different dynamic patterns rather than be limited to a fixed set of parameters obtained from a donor catchment these processes of the proposed approach are spontaneous and do not require the identification of any criteria for selecting donor catchments resulting in a potentially better performance of the ed lstm in pub predictions for example here we obtained pod values of above 0 8 and 0 7 for the prediction of high streamflow at 2 and 10 year return periods table 1 while in previous studies using various physically based methods but for different locations climates and time scales obtained values lower than 0 48 2 year return period france javelle et al 2016 0 61 2 year return period 6 catchments in france and italy norbiato et al 2008 and 0 38 10 year return period pakistan kim et al 2018 we conclude that the proposed ed lstm pub model can be considered an applicable tool for issuing fast and reasonably accurate flood warnings in ungauged catchments 5 2 model sensitivity to the training dataset we found that the overall pub model performance is better when training under a larger and more climate heterogeneous dataset rather than using a smaller and regional focused i e climate homogenous dataset as implied from the slight performance decrease comparing the south north based pub models fig 5a and the meaningful performance decline of the cluster based pub models fig 5b and fig s4 since the characteristics of the catchments in the different clusters vary significantly the models trained solely on the data from the catchments in each of the single clusters are not able to generalize well when applied to catchments from clusters with other characteristics this behavior is expected and is in line with the hypothesis proposed by fang et al 2022 that in the context of pub the dl models can still benefit from the data synergy effect provided by the modest diversity in the training data a more heterogeneous dataset may increase the probability of covering the relevant conditions for a new catchment to increase the representativeness of various rainfall runoff processes the sensitivity of the ed lstm model to simulate a time series of streamflow concerning the number of training events or catchments is non linear but with a positive correlation for nse scores as shown in fig 5 and fig s4 the decrease in the ed lstm nse performance with decreasing number of catchments used for the training fig s4 can be potentially explained by the fact that catchments that are not well represented by the training dataset are more sensitive to the change in training dataset size this is evident in the results as the upper quartile the well represented catchments in pub1 pub2 and pub3 remain the same while the lower quartile drops significantly fig s4 the results suggest that both quantity and diversity of the training dataset for dl models are equally important for improving pub model performance we stress that future applications of machine learning models in pub context should ensure a representative dataset with a sufficiently large number of training samples and catchments to properly include the impacts emerging from catchment characteristics on overall pub model performance however some of our results challenge the hypothesis that dl models performance is not compromised by additional information for streamflow simulation even when they appear to have different hydroclimatic conditions fang et al 2022 the performances of several catchments especially for those with sufficiently representative training data were also decreasing fig 6 from local to the pub model a possible explanation is the lack of data on the pseudo ungauged catchments when conducting out of sample prediction it means that the hydrological responses in these catchments are unique and the enlarged dataset still fundamentally lacks critical inputs so in the pub context the prediction results were much poorer than the performance of the local model meanwhile the performance decrease also happens between local and regional models due to the addition of some poorly performing catchments without sufficiently representative training data which have irregular hydrological responses in comparison to the well performing catchments to the enlarged dataset this even happens in a single catchment for example the flood hydrographs measured in the xinghe catchment show strong non stationaries whereas for similar rainfall intensities the resulting flood waves are very different which finally results in a very low prediction skill even for a local model the diverse hydrological behaviors in this case can impair the learning this drop in performance of some catchments in the regionalization of lstm models is also reported and discussed by kratzert et al 2019 and hashemi et al 2021 however we did not quantify to what extent the heterogeneity may harm the model performance in this study such analyses are left for further research nevertheless when adding new data the drop in performance of the well performed catchments is minor compared to the benefits of increasing the performance of those poorly represented catchments 5 3 model sensitivity to the catchment characteristics previous studies have found that the prediction of streamflow in ungauged catchments tends to be better in humid areas for either physics based or data driven models ragettli et al 2017 kratzert et al 2018 feng et al 2020 lees et al 2021 and we confirm this finding with our results e g the nse pet p relation fig 8 and table 1 there is a physical explanation for this finding in dry regions runoff generation is more likely to occur due to infiltration excess soil infiltration capacity has large spatial variability in 35 catchments so different soil saturation states can result in different streamflow magnitude and timing for the same rainfall intensity this can explain the variability in streamflow responses within one catchment for example the xinghe catchment described in section 5 2 hence it is likely that streamflow simulation in dry pub areas can be improved if the machine learning model is trained to learn the interaction between rainfall and streamflow with a larger sample of different rainfall streamflow soil moisture conditions alternatively deep learning models can be improved to simulate runoff infiltration excess by introducing physical laws as discussed in the next section we found that the model performance is only sensitive to climatic variables and not to topographic variables fig 8 when considering nse as model evaluation metrics this is in agreement with the statement of addor et al 2018 and stein et al 2021 who concluded that streamflow behavior across regions is most strongly influenced by climate attributes for flood prediction in ungauged catchments our findings thus support the need to incorporate more dynamic and static climatic variables that can increase the representativeness of the dataset when setting regional machine learning models for flood warnings 5 4 limitations and future development the analyses we conducted are limited by the small number of events that were available for the model training and evaluation for example we used the 10 year return period as the representative of a high streamflow event but in 11 of the catchments the number of events is not sufficient to estimate the 10 year return period with high accuracy another limitation is that the models were trained by event based data if continuous streamflow data is available and used instead the model can potentially learn better the hydrological patterns such as the streamflow seasonality and event antecedent soil moisture conditions which has the potential to improve predictions in dry climates see the previous section a complete observation time series covering 5 to 10 years would likely be sufficient to represent the non stationary behind the hydrological dynamics o et al 2020 but it was not available to us for this study extending the data for the training of the models will result in a better prediction but will not change the main conclusions of this work namely the outperformance of dl models in comparison to a physics based hydrological model in predicting floods in general and in the context of ungauged catchments in particular the results of our experiments imply that it is essential to focus on developing model structures that can be adaptable also in dry regions this can be done by incorporating governing equations or physical constraints into hydrological machine learning models an example is the development of the mass conserved dl model that incorporates conservation law into the loss function hoedt et al 2021 another alternative is the development of physically informed hybrid models that embed the hydrological dynamics into the recurrent neural network architecture e g jiang et al 2020 these types of models can better capture the interaction between soil rainfall evaporation and streamflow and be more readily generalized beyond the regimes covered with the training data khandelwal et al 2020 future applications of dl models in the field of hydrology should be combined with such hydrological knowledge and physics 6 conclusions we applied the encoder decoder lstm model to predict rainfall runoff events and flood peaks in ungauged catchments the model outperformed conventional hydrological model regionalization methods the most considerable improvement in the model predictive ability was observed in the poorly represented catchments by evaluating the generalization ability i e the applicability of the model across many catchments and conditions we found that the performance of the ed lstm model was not only sensitive to the number of samples used for the training of the model but also the representativeness climate heterogeneity level of the dataset also the dl regional model still suffers from issues of model adaptability although the ed lstm model reliably predicts the occurrence of rare events also in arid regions it is more likely to have a poor model performance for predicting streamflow in arid catchments than in humid catchments surprisingly we discovered that the catchment topographic attributes such as elevation and gradient did not improve the model performance when added as static variables in the model setup we conclude that compared to conventional methods the regional ed lstm model is a promising method for hydrological modeling in ungauged catchments and our results could be an important reference for further studies of dl based hydrological modeling with a rather limited amount of data to set a representative training dataset declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the training of the ed lstm models was done on google colab a free online platform for deep learning study courtesy of google np acknowledges the support of the swiss national science foundation snsf grant 194649 rainfall and floods in future cities appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128577 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2799,flood prediction in ungauged catchments is usually conducted by hydrological models that are parameterized based on nearby and similar gauged catchments as an alternative to this process based modelling deep learning dl models have demonstrated their ability for prediction in ungauged catchments pub with high efficiency catchment characteristics the number of gauged catchments and their level of hydroclimatic heterogeneity in the training dataset used for model regionalization can directly affect the model s performance here we study the generalization ability of a dl model to these factors by applying an encoder decoder long short term memory neural network for a 6 hour lead time runoff prediction in 35 mountainous catchments in china by varying the available number of catchments and model settings with different training datasets namely local regional and pub models we evaluated the generalization ability of our model we found that both quantity i e number of gauged catchments available and heterogeneity of the training dataset used for the dl model are important for improving model performance in the pub context due to a data synergy effect the assessment of the sensitivity to catchment characteristics showed that the model performance is mainly correlated to the local hydro climatic conditions the more arid the region the more likely it is to have a poor model performance for prediction in ungauged catchments the results suggest that the regional ed lstm model is a promising method to predict streamflow from rainfall inputs in pub and outline the need for preparing a representative training dataset keywords flood prediction ungauged catchments deep learning lstm data availability the code of encoder decoder lstm modeling is available through github https github com yikuizh edlstm flood prediction rainfall and runoff data from ground stations in china that were used for this study are not freely available for academic or commercial use contact sr for further details 1 introduction accurate and computationally efficient hydrological models are necessary for streamflow prediction to issue timely warnings for flash floods moore et al 2005 physics based hydrological models are the most robust models that can be used for this purpose they simulate physical processes in the rainfall runoff transformation with parameters that represent soil land surface and climate properties that need to be optimized for each geographic location with observations but most catchments worldwide lack hydrological monitoring data and are considered ungauged guo et al 2021 meaning that direct calibration of catchment parameters in these catchments is not possible for this reason the problem of prediction in ungauged basins pub has received considerable attention in the hydrological community sivapalan et al 2003 one solution to the calibration of hydrological models for catchments without available data utilizes the concept of parameter regionalization the idea is to use parameters calibrated in gauged catchments to predict the model parameters in a target ungauged catchment blöschl and sivapalan 1995 similarity based and regression based methods are widely used for model regionalization oudin et al 2008 for example beck et al 2016 proposed a scheme for the regionalization of model parameters at the global scale based on a similarity approach by selecting 10 gauged catchments with the most similar characteristics as donors for parameter transfer however the question of how to identify the selection criteria for choosing the optimal donor catchments remains a challenge that restricts the wide application of this method ragettli et al 2017 applied the classification and regression tree cart method to explore parameter transferability in the full space of catchment descriptors for the hydrological model and showed that this method can be an effective tool for identifying similarity among catchments however it is model dependent and relies on manually identifying the similarity and then transferring the parameter set from a series of pre defined hydrological models an alternative solution to parameterized hydrological models for streamflow simulation in ungauged catchments is the use of data driven deep learning dl models these models can be directly trained with inputs from meteorological and catchment characteristic data to simulate streamflow without using a physical hydrological model to pre define their similarity for example kratzert et al 2019 evaluated the ability of a long short term memory lstm model for the regionalization of over 500 catchments in the usa they concluded that data driven models had a strong capacity to learn non linear climate runoff relationships and to achieve model regionalization without identifying pre defined criteria for similar donor catchments the catchment characteristics e g topography land use and the climatic training dataset are the two most important factors that affect the model regionalization and the setup of a physical hydrological model in ungauged catchments teutschbein et al 2018 gong et al 2021 while the performance of hydrological models in ungauged catchments is sensitive to these two factors there are only a few studies that evaluated the generalization ability of data driven dl models for example potdar et al 2021 predicted flood peak discharge in ungauged catchments based on the gradient boosted trees model xgboost and found that catchment geomorphologic attributes have a higher impact on the prediction skill than climatologic attributes gauch et al 2021 studied the sensitivity of the prediction skill of the lstm model for daily streamflow in the usa to additional training samples and showed that it is not enough to train data driven models on a few gauged catchments but one should strive to use as many catchments as possible fang et al 2022 proposed a concept of data synergy pointing out that to achieve higher predictive performance a representative dataset with large but heterogeneous training samples i e different characteristics of catchments is needed however the generalization of dl models to the pub problem with respect to the representativeness of the training dataset and catchment characteristics has not been studied thoroughly yet this study aims to evaluate the generalization ability of a dl model to predict floods in ungauged catchments considering the above factors for this purpose an encoder decoder lstm ed lstm neural network was applied to set up a forecast model for a 6 hour lead time streamflow prediction in 35 mountain catchments in china three model setups i a local model for each catchment ii a regional model and iii regional pub models which differ in the choice of training and testing catchments were applied their performances were compared to the cart regionalization method to evaluate the ability of the dl model to predict streamflow in the ungauged catchments ragettli et al 2017 the analysis of the generalization ability of the pub models concerning the training dataset and catchment characteristics was conducted by comparing the three model setups the main purpose is to provide recommendations on the importance of preparing representative training datasets in the context of pub with dl methods we aim to answer the question of how ed lstm models and other rainfall runoff dl based models may be used for event based flood forecasting and which data requirements have to be present to provide reasonably accurate predictions in ungauged basins 2 data and models 2 1 study area the study focuses on 35 mountainous catchments table s1 located in ten chinese provinces fig 1 the catchments were classified as northern catchments 17 and southern catchments 18 based on the traditional geographical south north division of china which is called the huai river qin mountain line this line approximates the 0 c january isotherm and the 800 mm isohyet zhao et al 2015 mean annual precipitation in the north is on average 57 lower than in the south and mean annual air temperatures are on average 6 c lower the catchment areas range from 14 to 1693 km2 whereas the mean catchment size is 278 km2 hourly hydrological and meteorological data are available from stream and rain gauges located within or in close vicinity to the catchments fig 1 in addition the county weather stations record daily maximum and minimum 2 meter air temperature on average 11 years of data are available per catchment with 1 to 7 storm events occurring per year between april and october we consider storm events as days with total precipitation greater than 5 mm d 1 following the definition by ragettli et al 2017 each of the catchments is characterized by several static variables kratzert et al 2019 describing their climatic vegetation soil and topographical properties table s3 2 2 long short term memory lstm network lstm networks are a type of recurrent neural network that can learn time dependencies in time series data hochreiter and schmidhuber 1997 it has cell and hidden states which can account for the long short term memory effects therefore it is a good choice for modeling time series of runoff as it can account for a range of time dependent delays like seasonality and natural annual variability cycles long term months to years and the immediate rainfall runoff response short term minutes to hours equations 1 to 6 provide the mathematical formulation of the lstm at each time step f t σ w f x t u f h t 1 b f 1 i t σ w i x t u i h t 1 b i 2 c t tanh w g x t u g h t 1 b g 3 o t σ w o x t u o h t 1 b o 4 c t f t c t 1 i t c t 5 h t o t tanh c t 6 where f t i t c t o t and h t represent the forget gate input gate cell state output gate and hidden state at each time step respectively w u and b are the weights and bias term of the neural network the σ sigmoid function and tanh are two activation functions and x t are the inputs the lstm cell has three gates maintaining and adjusting its cell state and hidden state fig 2 including a forget gate eq 1 an input gate eq 2 and an output gate eq 4 each gate has a sigmoid function that adds non linearity to the linear combination of the input x t and hidden state from last time step h t 1 eqs 3 and 5 represent how much input and last hidden state is contributed to the cell state c t finally the output h t of the current time step is calculated from the output gate and cell state shown in eq 6 cell state and hidden state are then passed to the next time step the encoder decoder ed fig 2 structure has been used in the field of sequence to sequence prediction problems especially for language translation cho et al 2014 the encoder and decoder enable the model to operate on different input and output time steps the ed lstm model consists of two lstm networks in both the encoder and the decoder parts the application of the ed structure in lstms can efficiently improve the performance of ahead time prediction in the field of hydrology since the existence of the encoding and decoding architecture can eliminate the restriction on the length of input and output sequences kao et al 2020 in this case the input and output sequences do not necessarily have the same time steps the input and output can be flexible to embed different types of input data for example catchment static variables and rainfall time series can be used as input to the model at the same time unlike the basic lstm structure the encoder layer only outputs the hidden state from the last cell then it is copied as input for each lstm cell in the decoder layer it contains information collected from the input sequence at each time step thus it could be effective to use this structure to improve long term dependencies for longer time step prediction than in the regular lstm in this study five additional dense layers were set after the lstm decoder layer for better decoding of the sequence output at each time step 3 experiment setup 3 1 input data composition the ed lstm model experiments described in the next section require dynamic and static inputs the dynamic input data includes the following climate variables i hourly precipitation ii hourly streamflow and iii maximum minimum 2 m daily air temperature the dynamic inputs were divided into an observation phase and a prediction phase fig 3 the first phase includes 24 hour precipitation temperature and streamflow data computed from the hourly observed data before the prediction phase the second phase contains the 6 hour precipitation and temperature as driving data for the streamflow forecast also previously observed streamflow was used as the dynamic input because it is known to improve forecast e g song et al 2020 daily maximum and minimum temperature data are used to better account for snow induced streamflow processes e g xiang et al 2020 we reduced the number of static catchment attributes from a total of 27 table s2 to 14 table s3 using a principal component pc analysis preserving only the uncorrelated attributes that represent best the natural clusters in each category of catchment characteristics singh et al 2014 the absolute pc scores table s4 of each selected attribute were taken to represent the uncorrelated patterns rather than the individual catchment characteristics ragettli et al 2017 3 2 numerical experiments three different ed lstm numerical experiments were set up i local models i e a unique ed lstm setup for each of the catchments ii a regional model simulating all catchments at once and iii regional pub models models that include both gauged and ungauged catchments in different combinations in the first experiment ed lstm models were trained and tested on individual catchments without using data from other catchments in total 35 local models were set up only the dynamic variables were applied as input data and no static variables were involved in this setup preliminary tests were conducted on the catchment with the longest training samples to select the optimal ed lstm model hyperparameters in the second experiment we set up a regional model namely one model for all catchments this ed lstm model was trained and tested using an ensemble of events from all catchments together the regional model was applied with both the dynamic and static variables as inputs kratzert et al 2018 demonstrated that the lstm model can perform better with a regional model setting than with a setup for individual catchments as in the first experiment as more data is available for model training i e additional rainfall runoff interactions are available for the lstm to learn from this experiment aims to find out how much can the flood warning prediction ability benefit from a large training dataset in the last experiment the regional ed lstm setup was applied for prediction in the context of ungauged catchments pub models we conducted two tests here first to explore the ed lstm generalization ability to the number of gauged catchments used in the training and second to the characteristics of the catchment to explore the first question we followed a similar setup as for the regional model however we trained the model with fewer catchments using the k fold validation strategy which enables us to test the model performance on unseen catchments in the training process the k fold validation is commonly used for model parameter selection e g chang et al 2015 but here we used it as a tool for an out of sample prediction the 35 catchments were split randomly into k groups namely folds of approximately equal size catchments from k 1 groups were used to train the model and then the model was tested on the remaining single group of catchments as ungauged catchments this procedure is repeated k times so that out of sample predictions are made available to all catchments kratzert et al 2019 as the catchments are heterogeneous the number of valid training samples varies at first 10 fold validation was adopted to train 10 models with the same model structure and each model was applied for the prediction in three ungauged catchments this means that the training process was repeated 10 times with different 32 catchments to cover all catchments pub1 table s4 to evaluate the generalization ability of the pub modeling to the catchment characteristics such as climate and topography k means clustering methods were applied for classifying and grouping the catchments based on the 27 catchment static variables listed in table s2 including climatic topographic vegetation and catchment drainage properties based on the silhouette scores fig s1 we found that five clusters are required to group the catchments by their attributes we averaged the model performance based on each cluster fang et al 2022 hypothesized that dl based models will have a better prediction skill in the context of pub if a regional model is not trained on a relatively small and hydrologically homogenous dataset e g few catchments but sharing similar hydrological characteristics but rather on a larger and heterogeneous sample e g multiple catchments with varying characteristics to test this effect additional experiments were conducted the pub model was applied to each of the 5 clusters to create a new pub model for the smaller sub regions represented by the clusters the leave one out scheme was used so each sub regional pub model was trained on n 1 catchments and tested on a specific catchment the pub model was then applied to either the north 17 catchments in dry and cold climate or the south 18 wet and warm catchments to examine the effects of regionalization performance on the sample size e g gong et al 2021 the pub experiment was iterated for a different number of catchments in training ranging from 18 to 30 based on fold numbers from 2 to 10 pub2 to pub6 table s4 as a reference for the quality of the ed lstm model predictions in the pub mode we used simulations for the 35 catchments by the prms hydrological model presented in ragettli et al 2017 note that ragettli et al 2017 used two cart methods to emulate parameter regionalization in ungauged catchments however we used only the results of their classification tree as our reference as the other cart method resulted in a very similar model performance the training strategy of the ed lstm model was as follows in the first step we determined the hyperparameters e g learning rate batch size cell numbers based on a grid search the hydrometeorological dataset was divided into training validation and testing sets 50 25 and 25 respectively using the local model afterward the dataset was split into training and testing sets for training the local and regional experiments 75 and 25 respectively for the pub models all data in gauged catchments were used for training while the events in ungauged catchments were used for testing all ed lstm models had 256 memory cells in both the encoder and decoder layer with a dropout rate of 0 4 based on the results of the hyperparameter grid search there were 128 64 32 16 and 1 cells in the five dense layers after the lstm layer and the optimal batch size was 32 3 3 evaluation metrics the evaluation of the model performance aimed to i assess the capacity of the model to reproduce an overall streamflow fit at the event scale and ii evaluate its ability to correctly identify streamflow extremes i e the peak flow which is important for flood warning the nash sutcliffe efficiency nse nash and sutcliffe 1970 metric was used to assess the overall streamflow fit 7 nse 1 sim t obs t 2 obs t obs m 2 where sim and obs are the predicted and observed streamflow t indicates a given time step and m refers to the mean nse ranges from infinity to 1 with 1 being a perfect match nse values larger than 0 5 can be considered as a satisfying prediction capacity while the value of 0 signifies that the prediction is as good as the mean of the observations moriasi et al 2007 flood frequency analysis was used for the quantification of flood warning performance the cumulative distribution function of the generalized extreme value distribution was applied to estimate the return periods of the observed and simulated hourly streamflow peaks see ragettli et al 2017 for example for each storm event we determined if the maximum hourly streamflow exceeded a reference flood quantile of a given return period we consider the 2 year return period to represent common high streamflow and the 10 year return period to represent a severe flood we identified three cases for flood prediction performance following javelle et al 2016 i hit h when both simulated and observed streamflow exceeded the flow threshold corresponding to a certain return period indicating high flow ii miss m when the simulated streamflow was below the threshold and failed to agree with the high flow detected by observations and iii false alert fa when the simulated streamflow indicated a high flow but the observed streamflow did not see the contingency table in table s5 moreover to assess the temporal accuracy of reproducing the peak flow a 2 hour condition was added to the evaluation which means that if the simulated peak flow had a 2 hour shift compared to the observed peak the prediction was also identified as a miss three contingency scores were computed for evaluating the flood warning ability i the probability of detection pod eq 8 which is the fraction of correct event predictions hits in all observed high flow events ii the success rate sr eq 9 which is the fraction of hits in the total number of all high flow event predictions iii and the critical success index csi eq 10 which is the fraction of hits in the total number of event predictions plus the number of missed observations 8 pod h h m 9 sr h h f a 10 csi h h m f a 4 results 4 1 evaluation of the model performance first we compared the nse values between the observed and predicted streamflow in the three experiments fig 4 we qualitatively divided the nse values into three performance groups poor nse 0 average 0 nse 0 5 and above average nse 0 5 the training of local models resulted in 14 catchments with above average nse values and 12 catchments with poor nse values while in the regional model most catchments resulted in an above average performance and only three catchments had poor performance fig 4a evaluating the performance of the pub models in the north and south areas separately fig 4b and c it becomes apparent that the models have better prediction ability in southern catchments with a considerably higher number of models with good performance 4 on average in the northern catchments in comparison to 12 on average in the southern ones compared to ragettli et al 2017 s results the pub model performed better than the cart based method in the northern catchments as 2 1 catchments resulted in above average performance and 5 9 catchments in poor performance for the pub cart based model fig 4a and b in southern catchments the performance distribution of the two methods is nearly identical fig 4c the results of the contingency scores evaluating the flood warning performance are presented in table 1 for the 2 year return period events the regional and the pub models had the best performances equally for detecting streamflow peaks pod values of 0 85 sr values of 0 82 and csi values of 0 72 considering all catchments for prediction in ungauged catchments pub models outperform the cart based regionalization methods by 12 on the probability of detection considering all catchments similarly pub models have a better success rate and critical success index in comparison to the cart based regionalization for the 10 year return period events all models contingency scores decreased by at least 10 in line with the 2 year return period predictions the regional and pub models showed the best performance pod of 0 7 considering all catchments again the performance of the pub models was 10 higher than cart based methods the pub model achieved the best performance for sr and csi scores instead of being equal to the regional model results indicate that the model detection performances were affected by the climate as in wetter climate i e the southern catchments better prediction abilities were observed than in the drier regions i e the northern catchments the generalization ability increases with the prediction of higher streamflow from an order of 8 difference between the southern and northern catchments for the 2 year return period to 30 for the 10 year return period exception is pub 10 year return period 4 2 generalization ability to different training dataset fig 5 shows the overall performance of pub models that were trained on different sub regions the homogeneous similar climate dataset did not improve but rather impair the pub model performance fig 5a while the median nse value of the model trained on southern catchments was similar to the result trained on the global dataset around 0 5 for the northern sub region the model performance was significantly worse than the result when trained on all catchments this is even more evident when the models are trained based on the climate clusters fig 5b where the overall performance has decreased significantly compared to the median nse when the models are trained on the entire dataset for clusters 1 and 3 the median has dropped significantly from around 0 35 to 0 1 and 0 7 respectively in addition the variation of the models nse skill i e the box plots increases in all models trained on the cluster based homogenous datasets in comparison to the training with the entire region datasets with negative lower quartile and lower whisker nse values reaching 1 for clusters 1 3 and 4 the model generalization ability to the number of catchments used for training is presented in fig s4 the median nse of pub models did not vary notably for models trained on 32 to 24 catchments but when the number of catchments used in the training dataset was below 18 the median nse declined from 0 3 to only 0 15 fig sa and this decline trend is consistent for even smaller number of catchments in contrast to the nse results the pod scores of the pub models do not degrade with the decreasing number of training catchments and all pub models demonstrate good flood warning capability with median pod scores higher than 0 8 fig s4b however model performance at an individual catchment may not always be improved when trained on a large dataset as shown in fig 6 four performance categories can be distinguished i performance is similar for all models e g yimen catchment ii poor performance in the local model but satisfactory in others e g shangliu catchment iii poor performance in the pub model but satisfactory in others e g pei river and iv random performance variation with model setup e g qigu catchment most of the catchments 12 fall into category ii performance followed by 10 catchments with category i performance but still 8 catchments fall into category iii while 5 resulted in category iv with a poorer performance even though they were trained using a larger dataset 4 3 generalization ability to catchment characteristics the classification of the 35 catchments into five classes based on the k means clustering method is presented in fig 7 a of the northern catchments 11 81 were grouped into cluster 5 the southern catchments were classified into clusters 2 to 4 catchments from the southwest were mostly clustered in cluster 2 while catchments from the southeast region were grouped in cluster 4 the catchments in cluster 1 and cluster 3 are mainly located in central china in henan province the five clusters represent different climatological and hydrological conditions table 2 cluster 5 climate is arid to semi arid with a ratio of annual potential evapotranspiration to precipitation pet p lower than 1 moreover the catchments in cluster 5 are mainly located in high mountain areas in northern latitudes fig 7a and thus are also colder on average compared to catchments in other clusters the catchments in cluster 3 are located in lower flatter and warmer areas the topography attributes of cluster 4 are similar to cluster 3 however the latter is more humid the catchments in cluster 2 are located in high elevation warm and humid areas and are located in southwest china fig 7a the climatic and topographical characteristics of the catchments in cluster 1 are intermediate of the clusters and the three catchments associated with this cluster are found in central china fig 7a the models are sensitive to the catchment characteristics as the model performances vary between clusters the nse scores of the clustered catchments in the pub model in clusters 2 and 4 both above 0 5 are the highest among the five clusters while cluster 5 has the lowest median nse with 0 23 table 2 and fig 7b a declining trend in nse values is also observed from south to north fig 7b the pod scores however show no remarkable differences in flood warning capability between clusters with the highest value of 0 91 in cluster 4 and the lowest values of 0 76 in clusters 2 and 5 table 2 a negative correlation was found between pet p used as climate proxy and nse fig 8 a indicating that the dl model is more likely to perform well in wetter areas however such a relationship cannot be observed between pod scores and pet p fig 8b no correlations of either nse or pod were found with topographic attributes for example neither nse nor pod shows a clear correlation with the h gradient used as a proxy for topographic steepness fig 8c and d 5 discussion 5 1 use of the ed lstm in the pub context the pub model using the regional ed lstm structure showed a higher skill in predicting high streamflow than the conceptual hydrological model fig 4 and table 1 even in catchments with poor prediction performance i e nse 0 5 where the streamflow is not perfectly simulated by the ed lstm model decent performances for flood warning were obtained i e high pod values it is further evident in the results that the pub model is not sensitive to the number of training catchments and always keeps a good flood warning skill fig s5 this implies that while the deep learning models do not always learn the streamflow dynamic i e the time series as a whole well they can still extrapolate the extreme streamflow events this is further seen when plotting the correlation between nse and pod fig s2 it also implies that there is a high similarity in the intense observed rainfall between the catchments which triggers flood peaks of similar magnitude there may be a potential to use deep learning for flood prediction in ungauged catchments even if the number of gauged catchments is small in other words the ed lstm appears to be a reliable flood warning model in ungauged catchments since it does not require successfully capturing the entire event hydrograph and the timing of the peak but rather solely forecasting the magnitude of the peak given a similar size of training data the prediction ability of an lstm model is often much better than physics based models kratzert et al 2018 frame et al 2022 while the physically based regionalization method selects and transfers the optimal parameter set from a gauged catchment to an ungauged catchment yang et al 2018 more flexibility is found with the ed lstm pub approach as the model adapts to different dynamic patterns rather than be limited to a fixed set of parameters obtained from a donor catchment these processes of the proposed approach are spontaneous and do not require the identification of any criteria for selecting donor catchments resulting in a potentially better performance of the ed lstm in pub predictions for example here we obtained pod values of above 0 8 and 0 7 for the prediction of high streamflow at 2 and 10 year return periods table 1 while in previous studies using various physically based methods but for different locations climates and time scales obtained values lower than 0 48 2 year return period france javelle et al 2016 0 61 2 year return period 6 catchments in france and italy norbiato et al 2008 and 0 38 10 year return period pakistan kim et al 2018 we conclude that the proposed ed lstm pub model can be considered an applicable tool for issuing fast and reasonably accurate flood warnings in ungauged catchments 5 2 model sensitivity to the training dataset we found that the overall pub model performance is better when training under a larger and more climate heterogeneous dataset rather than using a smaller and regional focused i e climate homogenous dataset as implied from the slight performance decrease comparing the south north based pub models fig 5a and the meaningful performance decline of the cluster based pub models fig 5b and fig s4 since the characteristics of the catchments in the different clusters vary significantly the models trained solely on the data from the catchments in each of the single clusters are not able to generalize well when applied to catchments from clusters with other characteristics this behavior is expected and is in line with the hypothesis proposed by fang et al 2022 that in the context of pub the dl models can still benefit from the data synergy effect provided by the modest diversity in the training data a more heterogeneous dataset may increase the probability of covering the relevant conditions for a new catchment to increase the representativeness of various rainfall runoff processes the sensitivity of the ed lstm model to simulate a time series of streamflow concerning the number of training events or catchments is non linear but with a positive correlation for nse scores as shown in fig 5 and fig s4 the decrease in the ed lstm nse performance with decreasing number of catchments used for the training fig s4 can be potentially explained by the fact that catchments that are not well represented by the training dataset are more sensitive to the change in training dataset size this is evident in the results as the upper quartile the well represented catchments in pub1 pub2 and pub3 remain the same while the lower quartile drops significantly fig s4 the results suggest that both quantity and diversity of the training dataset for dl models are equally important for improving pub model performance we stress that future applications of machine learning models in pub context should ensure a representative dataset with a sufficiently large number of training samples and catchments to properly include the impacts emerging from catchment characteristics on overall pub model performance however some of our results challenge the hypothesis that dl models performance is not compromised by additional information for streamflow simulation even when they appear to have different hydroclimatic conditions fang et al 2022 the performances of several catchments especially for those with sufficiently representative training data were also decreasing fig 6 from local to the pub model a possible explanation is the lack of data on the pseudo ungauged catchments when conducting out of sample prediction it means that the hydrological responses in these catchments are unique and the enlarged dataset still fundamentally lacks critical inputs so in the pub context the prediction results were much poorer than the performance of the local model meanwhile the performance decrease also happens between local and regional models due to the addition of some poorly performing catchments without sufficiently representative training data which have irregular hydrological responses in comparison to the well performing catchments to the enlarged dataset this even happens in a single catchment for example the flood hydrographs measured in the xinghe catchment show strong non stationaries whereas for similar rainfall intensities the resulting flood waves are very different which finally results in a very low prediction skill even for a local model the diverse hydrological behaviors in this case can impair the learning this drop in performance of some catchments in the regionalization of lstm models is also reported and discussed by kratzert et al 2019 and hashemi et al 2021 however we did not quantify to what extent the heterogeneity may harm the model performance in this study such analyses are left for further research nevertheless when adding new data the drop in performance of the well performed catchments is minor compared to the benefits of increasing the performance of those poorly represented catchments 5 3 model sensitivity to the catchment characteristics previous studies have found that the prediction of streamflow in ungauged catchments tends to be better in humid areas for either physics based or data driven models ragettli et al 2017 kratzert et al 2018 feng et al 2020 lees et al 2021 and we confirm this finding with our results e g the nse pet p relation fig 8 and table 1 there is a physical explanation for this finding in dry regions runoff generation is more likely to occur due to infiltration excess soil infiltration capacity has large spatial variability in 35 catchments so different soil saturation states can result in different streamflow magnitude and timing for the same rainfall intensity this can explain the variability in streamflow responses within one catchment for example the xinghe catchment described in section 5 2 hence it is likely that streamflow simulation in dry pub areas can be improved if the machine learning model is trained to learn the interaction between rainfall and streamflow with a larger sample of different rainfall streamflow soil moisture conditions alternatively deep learning models can be improved to simulate runoff infiltration excess by introducing physical laws as discussed in the next section we found that the model performance is only sensitive to climatic variables and not to topographic variables fig 8 when considering nse as model evaluation metrics this is in agreement with the statement of addor et al 2018 and stein et al 2021 who concluded that streamflow behavior across regions is most strongly influenced by climate attributes for flood prediction in ungauged catchments our findings thus support the need to incorporate more dynamic and static climatic variables that can increase the representativeness of the dataset when setting regional machine learning models for flood warnings 5 4 limitations and future development the analyses we conducted are limited by the small number of events that were available for the model training and evaluation for example we used the 10 year return period as the representative of a high streamflow event but in 11 of the catchments the number of events is not sufficient to estimate the 10 year return period with high accuracy another limitation is that the models were trained by event based data if continuous streamflow data is available and used instead the model can potentially learn better the hydrological patterns such as the streamflow seasonality and event antecedent soil moisture conditions which has the potential to improve predictions in dry climates see the previous section a complete observation time series covering 5 to 10 years would likely be sufficient to represent the non stationary behind the hydrological dynamics o et al 2020 but it was not available to us for this study extending the data for the training of the models will result in a better prediction but will not change the main conclusions of this work namely the outperformance of dl models in comparison to a physics based hydrological model in predicting floods in general and in the context of ungauged catchments in particular the results of our experiments imply that it is essential to focus on developing model structures that can be adaptable also in dry regions this can be done by incorporating governing equations or physical constraints into hydrological machine learning models an example is the development of the mass conserved dl model that incorporates conservation law into the loss function hoedt et al 2021 another alternative is the development of physically informed hybrid models that embed the hydrological dynamics into the recurrent neural network architecture e g jiang et al 2020 these types of models can better capture the interaction between soil rainfall evaporation and streamflow and be more readily generalized beyond the regimes covered with the training data khandelwal et al 2020 future applications of dl models in the field of hydrology should be combined with such hydrological knowledge and physics 6 conclusions we applied the encoder decoder lstm model to predict rainfall runoff events and flood peaks in ungauged catchments the model outperformed conventional hydrological model regionalization methods the most considerable improvement in the model predictive ability was observed in the poorly represented catchments by evaluating the generalization ability i e the applicability of the model across many catchments and conditions we found that the performance of the ed lstm model was not only sensitive to the number of samples used for the training of the model but also the representativeness climate heterogeneity level of the dataset also the dl regional model still suffers from issues of model adaptability although the ed lstm model reliably predicts the occurrence of rare events also in arid regions it is more likely to have a poor model performance for predicting streamflow in arid catchments than in humid catchments surprisingly we discovered that the catchment topographic attributes such as elevation and gradient did not improve the model performance when added as static variables in the model setup we conclude that compared to conventional methods the regional ed lstm model is a promising method for hydrological modeling in ungauged catchments and our results could be an important reference for further studies of dl based hydrological modeling with a rather limited amount of data to set a representative training dataset declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the training of the ed lstm models was done on google colab a free online platform for deep learning study courtesy of google np acknowledges the support of the swiss national science foundation snsf grant 194649 rainfall and floods in future cities appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128577 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
