index,text
840,multiphase flow is a critical process in a wide range of applications including oil and gas recovery carbon sequestration and contaminant remediation numerical simulation of multiphase flow requires solving of a large sparse linear system resulting from the discretization of the partial differential equations modeling the flow in the case of multiphase multicomponent flow with miscible effect this is a very challenging task the problem becomes even more difficult if phase transitions are taken into account a new approach to handle phase transitions is to formulate the system as a nonlinear complementarity problem ncp unlike in the primary variable switching technique the set of primary variables in this approach is fixed even when there is phase transition not only does this improve the robustness of the nonlinear solver it opens up the possibility to use multigrid methods to solve the resulting linear system the disadvantage of the complementarity approach however is that when a phase disappears the linear system has the structure of a saddle point problem and becomes indefinite and current algebraic multigrid amg algorithms cannot be applied directly in this study we explore the effectiveness of a new multilevel strategy based on the multigrid reduction technique to deal with problems of this type we demonstrate the effectiveness of the method through numerical results for the case of two phase two component flow with phase appearance disappearance we also show that the strategy is efficient and scales optimally with problem size keywords algebraic multigrid preconditioning compositional two phase flow phase transitions nonlinear complementarity problem 1 introduction modeling multiphase flow in porous media is a challenging task given the complex physics involved the flow is described by a set of nonlinear and strongly coupled partial differential equations pdes with algebraic constraints these equations are usually solved with fully implicit method which requires solving large scale non symmetric and ill conditioned linear systems the problem becomes even more difficult if we take into account phase transitions when phase transitions occur the pdes can become degenerate and that makes the resulting linear system indefinite krylov subspace methods such as the generalized residual method gmres saad and schultz 1986 can be applied to solve these systems however these methods by themselves generally converge slowly and they must be appropriately preconditioned to accelerate convergence the incomplete lu ilu factorization is a popular approach as a preconditoner due to its simplicity and generality however as simulations cover larger and larger domains and are deployed over high performance parallel architectures there is an apparent need for robust solvers that scale and the use of standard single level ilu methods becomes less favorable previously most of the research has focused on finding new formulations which can deal with phase transitions some approaches include primary variable switching pvs forsyth et al 1995 wu and forsyth 2001 negative saturation abadpour and panfilov 2009 and finding a set of persistent primary variables bourgeat et al 2009 marchand et al 2012 neumann et al 2013 recently a new approach has been developed for handling the phase transitions by formulating the system of equations as a nonlinear complementarity problem ncp ben gharbia and jaffré 2014 lauser et al 2011 marchand and knabner 2014 unlike the pvs approach the advantage of the ncp approach is that the set of primary variables is consistent through out the simulation and no primary variable switching is needed not only is this approach more robust and efficient it also presents an opportunity to use scalable linear solvers such as algebraic multigrid amg in this work we focus on developing a new amg preconditioner based on multigrid reduction mgr for gmres to solve the linear system resulting from the discretization of the continuous problem mgr technique has been around for many years ries and trottenberg 1979 ries et al 1983 it can be considered as a generalization of the multi stage preconditioner in a standard multigrid framework a closed form of the error propagator can be derived for the mgr approach and this enables us to study the effect of different multigrid components on the convergence of the linear solver in addition the mgr framework has been shown to be an efficient preconditioner for different types of pdes such as the reservoir simulation and it has also been applied with varying degree of success to the time dimension falgout et al 2014 we consider a two phase two component system with phase transitions as our model problem we describe this model in details in section 2 classical approach to simulate two phase two component is well posed if two primary variables are chosen in advance for example one can choose one phase pressure and one phase saturation or one phase pressure and one component concentration this set of variables remains fixed in the case of phase appearance disappearance if we know in advance what phase will appear and disappear during the simulation then a constrained pressure residual cpr preconditioning approach dawson et al 1997 qiao et al 2017 wallis et al 1985 can be employed to obtain a semi elliptic pressure equation the pressure equation is solved with a multi level method such as amg or multiscale cusini et al 2015 and followed by a relaxation step with ilu for the global linear system although this approach has been shown to be very effective for some real world examples cusini et al 2015 it could be less robust in cases with strong capillarity effect bui et al 2017 due to the fact that the cpr approach uses ilu in the smoothing step it may not scale as well as a block factorization approach bui et al 2017 the goal of this paper is to develop a new multigrid algorithm that is both robust efficient and also general to accommodate various formulations of compositional multiphase flow in particular we show that under appropriate assumptions our multigrid reduction method is equivalent to the cpr amg and block factorization approaches the rest of this paper is organized as follows in section 3 we describe the fully implicit discretization we briefly review the mgr framework in section 4 and explain our new mgr algorithm in section 5 in section 6 several numerical tests are studied for the robustness and scalability of the new algorithm some conclusion remarks as well as future work are presented in section 7 2 problem statement 2 1 governing equations we consider a simplified two phase two component model with phase transitions similar to that presented in bourgeat et al 2013 this model provides a simple example that demonstrates the capability of the nonlinear complementarity constraint approach to handle phase appearance and disappearance the flow consists of gas and liquid phases and the components are hydrogen and water we make the following simplifications 1 water does not vaporize so the gas phase contains only hydrogen and 2 the amount of hydrogen dissolved into the liquid phase is small for a complete set of assumptions we refer to bourgeat et al 2009 for the two components the mass conservation equations read 1 ϕ ρ l w s l t ρ l w q l j l h 0 2 ϕ ρ l h s l ρ g h s g t ρ l h q l ρ g h q g j l h 0 where the subscripts l g denote the liquid and gas phases and the superscripts w h denote the water and hydrogen components respectively ϕ is the porosity sα q α are the saturation and velocity of phase α respectively ρ l h is the dissolved hydrogen mass concentration in the liquid phase and j l h is the diffusion flux of hydrogen in the liquid phase the darcy s velocity q α follows the darcy muskat law 3 q α k λ α p α ρ α g α l g where k is the absolute permeability λα pα and ρα are the mobility pressure and density of phase α and g is the gravitational acceleration the mobility λα of phase α is defined as the ratio between the phase relative permeability krα and the phase viscosity μα λ α k r α μ α using fick s law the diffusion flux of hydrogen in liquid j l h in eqs 1 and 2 can be expressed as 4 j l h ϕ s l d l h ρ l h where d l h is hydrogen molecular diffusion coefficient in liquid since we assume incompressibility of the liquid phase the mass density of the water component in the liquid phase is constant i e ρ l w ρ w s t d to capture capillarity effect the jump in the pressure at the interface of the two phases is modeled by the relation 5 p g p l p c s l where pc is the capillary pressure additionally we have the constraints 6 s l s g 1 to close the model we also need a set of equations for the thermodynamic equilibrium neglecting water vapor and assuming low solubility of hydrogen in the liquid phase henry s law can be used to connect the gas pressure pg and the dissolved hydrogen mass concentration in liquid ρ l h 7 ρ l h c h p g where c h h m h ρ w s t d m h m w h is the henry s law constant and mi i w h are the molar mass of the ith component again since we ignore water vapor in the gas phase the ideal gas law reads 8 ρ g h ρ g c v p g where cv is a constant and c v m h r t t is the temperature and r the ideal gas constant 2 2 nonlinear complementarity problem to handle phase transitions we introduce the following nonlinear complementarity constraint problem 9 c h p g ρ l h 0 1 s l 0 1 s l c h p g ρ l h 0 equivalently we can rewrite the above equation using the min function as in ben gharbia and jaffré 2014 lauser et al 2011 10 min 1 s l c h p g ρ l h 0 although one can use other types of complementarity functions the min function is convenient because of its piece wise linearity with respect to the variable sl and ρ h l which simplifies the computation of the jacobian in each nonlinear iteration when the gas phase is not present we have c h p g ρ l h 0 since ρ l h 0 and eq 10 reduces to 1 s l 0 when the gas phase appears 1 s l 0 and the constraint equation is governed by henry s law in eq 7 2 3 relative permeability curves in this paper we use two different models for relative permeability terms power law 11 k r l s l e 2 k r g 1 s l e 2 12 s l e s l s l r 1 s l r s g r van genuchten law van genuchten 1980 13 k r l s l e 1 1 s l e 1 m m 2 14 k r g 1 s l e 1 s l e 1 m 2 m 15 m 1 1 n where sle is the effective liquid saturation and slr sgr 0 1 are the residual saturations of the liquid and gas phase respectively 2 4 capillary pressure we employ two models for capillary pressure linear model 16 p c p r 1 s l e van genuchten model van genuchten 1980 17 p c p r s l e 1 m 1 1 n where pr is the entry pressure notice that the function pc sl in the van genuchten model is only defined for sl 0 1 and p c is unbounded near 0 and 1 thus it is necessary to modify the model to limit the growth of p c and extend it for s l r since the value of sl can become larger than 1 or less than 0 during the nonlinear iteration we used a regularization as presented in marchand and knabner 2014 with parameter ϵ 10 5 2 5 primary variables there are many ways to choose a set of primary variables depending on the problem formulation and applications in our model example a convenient choice is the liquid saturation liquid pressure and the concentration of hydrogen in the liquid phase we have our solution vector u p l s l ρ l h unlike in other methods such as primary variable switching in the ncp approach the choice of primary variable is fixed throughout the simulation this is an important feature for success of our multilevel algorithm discussed in section 5 3 solution algorithm in this paper we consider solving the coupled system consisting of eqs 1 2 and 9 fully implicitly we use a cell centered finite volume method for spatial discretization as it is a natural way to preserve the mass conservation property of the balance eqs 1 and 2 in addition it can deal with the case of discontinuous permeability coefficients and it is relatively straightforward to implement for the time domain we employ the backward euler method to avoid the cfl stability restriction of the time step 3 1 semi smooth newton s method we want to solve the system r u h u 0 from the pdes θ u min f g 0 from the constraints in which f and g are discrete functions of 1 s l and c g p g ρ l h respectively and r u is the residual function a straightforward approach for solving nonlinear systems of equations is the newton s method which requires solution of a linear system at each iteration k 18 r u u u k δ u r u k this method requires that the jacobian r u is defined everywhere in the case of ncp formulation the constraints θ are only differentiable almost everywhere and we will need to consider a semi smooth newton s method instead the procedure for the semi smooth newton s method is similar to that for newton s method except that we substitute the derivative θ with a member of the subdifferential θ when the function θ is non differentiable let f r n r n be a locally lipschitz continuous function and df be the set where f is differentiable the b subdifferential of f at x is defined as the set b f x g r n n x k d f with x k x f x k g below is the algorithm for the semi smooth newton s method as described in ben gharbia and jaffré 2014 for our two phase two component model the active set ak corresponds to the set of last rows where the gas phase is present the general semi smooth newton s method converges locally superlinearly for semi smooth functions and quadraticly for strongly semi smooth functions definitions of semi smooth and strongly semi smooth are given in qi and sun 1999 and a complete treatment of the semi smooth newton s method with active set strategy is presented in hintermüller et al 2002 the linear system resulting from taking the subdifferential r u is often very difficult to solve using iterative methods and preconditioning is critical for rapid convergence of krylov subspace methods such as gmres in the next section we discuss the linear system arising from the semi smooth newton s method and give a detailed description of the solution algorithms we will use to solve this system 3 2 linear system assuming that each physical variable is ordered lexicograhpically then each nonlinear iteration entails the solution of a discrete version of a block linear system of the form 19 a 11 a 12 a 13 a 21 a 22 a 23 a 31 a 32 a 33 u 1 u 2 u 3 f 1 f 2 f 3 in which the matrices in the first two rows are the discretized version of the linearized operators from the pdes let δ p l δ s l δ ρ l h be the updates for pressure saturation and hydrogen density at each nonlinear step using taylor expansion and keeping only the linear terms we have a 11 ρ l w k λ l δ p l a 12 ϕ t ρ l w δ s l ρ l w k λ l p l δ s l ϕ d l h ρ l h δ s l a 13 ϕ s l d l h δ ρ l h a 21 ϕ t s g c g δ p l ρ l h k λ l δ p l ρ g h k λ g δ p l c g k λ g p g δ p l a 22 ϕ t ρ l h ρ g h δ s l ρ l h k λ l p l δ s l ρ g h k λ g p g δ s l c g p c k λ g p g δ s l ρ g h k λ g p c δ s l ρ g h k λ g p c δ s l ϕ d l h ρ l h δ s l a 23 ϕ t s l δ x l h ϕ s l d l h δ ρ l h all the coefficients in the above equations are evaluated at the linearization point p l s l ρ l h from these operators we can make some important observations the global matrix is non symmetric and indefinite the block a 11 has the structure of a discrete purely elliptic problem for pressure the coupling block a 12 has the structure of a discrete first order hyperbolic problem in the liquid phase saturation the coupling block a 21 has the structure of a discrete parabolic problem in the wetting phase pressure the block a 22 has the structure of a discrete parabolic convection diffusion problem for saturation when capillary pressure is a non constant function of the saturation when capillary pressure is zero or a constant p c 0 and there is no diffusion term the block has the form of a hyperbolic problem the entries of the blocks with respect to the dissolved hydrogen mass density a 13 a 23 are small with respect to the diagonal block a 11 and only play a significant role in the regions where the gas phase does not exist these observations will help us motivate the development of our new method in the next section besides the blocks associated with the pdes we also need to consider those in last row of the matrix in eq 19 which are derived from the discrete version of the complementarity constraint equation 9 when the gas phase does not exist we have a 31 0 a 32 δ s l a 33 0 and when the gas phase is present these blocks become a 31 h δ s l a 32 h p c δ s l a 33 m h ρ l w m w δ x l h in matrix form the blocks a 31 a 32 and a 33 are diagonal matrices since the constraints are local again because a phase can disappear the block a 33 is not guaranteed to be non singular in fact when this happens the rows corresponding to the cells where a phase disappears have zero diagonal values thus we can split the last row into two separate sets the set with zeros on the diagonal of a 33 and its complement rewriting the matrix a using this splitting we have 20 a a 11 a 12 a 13 a 14 a 21 a 22 a 23 a 24 c 31 c 32 c 33 0 c 41 c 42 0 0 let n be the number of elements in the mesh and m be the number of cells in which the gas phase is present then the size of the matrix a is 3n 3n the blocks aij i 1 2 j 1 2 have the size of n n the pressure hydrogen mass concentration a 13 a 14 and saturation hydrogen mass concentration a 23 a 24 coupling blocks have the size of n m and n n m respectively the hydrogen mass concentration pressure c 31 c 41 and hydrogen mass concentration saturation c 32 c 42 constraint blocks have the size of m n and n m n respectively the block c 33 is a diagonal matrix of size m m which contains only non zero diagonal values of a 33 the 0 block on the diagonal has the size of n m n m since a has zeros on its diagonal it is clear that we cannot use classical amg algorithms to solve this system in the past since much of the focus was to find a formulation that can take into account all the complex physics involved in simulating compositional multiphase flow with miscibility and phase transitions there has not been a lot of work in designing optimal preconditioners for this type of linear system recently there have been some development of algebraic multigrid preconditioners such as two stage preconditioning stueben et al 2007 wang et al 2017 and block factorization bui et al 2017 for immiscible two phase flow yet these methods have not been applied successfully to the problems considered here the most popular and robust method is still using the incomplete factorization ilu of the global matrix a as a preconditioner to gmres in this work we seek to develop a new algebraic multigrid preconditioner based on multigrid reduction for the linear system arising in the semi smooth newton s method 4 multigrid reduction the idea of multigrid reduction mgr has been around for a long time tracing back to the work of ries and trottenberg 1979 and ries et al 1983 recently it has gained more attention through the work on multigrid reduction in time by falgout et al 2014 in this section we summarize the approach for the case of two level reduction given a matrix a we have the c f splitting 21 a a f f a f c a c f a c c i f f 0 a c f a f f 1 i c c a f f 0 0 s i f f a f f 1 a f c 0 i c c where icc and iff are identity matrices and s a c c a c f a f f 1 a f c is the schur complement we can define the ideal interpolation and restriction operators by 22 p a f f 1 a f c i c c r a c f a f f 1 i c c additionally define the injection operator as q i f f 0 t then since a f f q t a q and s r a p it is simple to derive that a 1 p r a p 1 r q q t a q 1 q t and 23 0 i a 1 a i p r a p 1 r a q q t a q 1 q t a 24 i p r a p 1 r a i q q t a q 1 q t a 25 i q q t a q 1 q t a i p r a p 1 r a where the equivalence occurs since r a q q t a p 0 this identity defines the two level multigrid method with the ideal petrov galerkin coarse grid operator rap and the f relaxation q q t a q 1 q t eq 23 is the additive mgr identity and eqs 24 and 25 are multiplicative identities with pre smoothing and post smoothing however constructing ideal interpolation and restriction operators is impractical and we need to approximate these operators in practice mgr methods replace ideal restriction and prolongation with approximations r and p respectively where 26 p w p i c c r w r i c c there are many ways to construct the restriction r and interpolation p operators here we have only experimented with two options 27 w r 0 w p d f f 1 a f c and 28 w r a c f d f f 1 w p d f f 1 a f c where d f f d i a g a f f the f relaxation in eqs 24 and 25 is also generally replaced with a more efficient method and often extended to all unknowns not just f points we can solve with block jacobi block gauss seidel ilu or amg the coarse grid operator a c r a p could also be considered as an approximation to the schur complement there are many proposed approximations to schur complement including several based on multigrid ideas bank and smith 1999 chow and vassilevski 2003 reusken 1996 1999 rusten and winther 1992 wagner et al 1997 the physics based approximation for the schur complement are of interest general settings there are lots literatures for saddle point problems benzi and wathen 2008 elman et al 2006 2008 sloan 1986 another interesting direction is based on the work on block factorized sparse approximate inverse block fsai preconditioners in ferronato et al 2014 in the context of mgr the block fsai could be used to construct good approximation to the restriction and interpolation operators in general we define the mgr operator in either pre smoothing or post smoothing form by 29 i m m g r 1 a i p m c 1 r a i m f 1 a 30 i m m g r 1 a i m f 1 a i p m c 1 r a where m c 1 r a p 1 is the coarse grid correction and m f 1 is the smoother the two grid solve consists of an f relaxation followed by a coarse grid correction can be presented as follows the appeal of the mgr approach is that it provides a flexible framework for choosing the coarse fine grids the interpolation and restriction operators and the solver for the coarse fine grids for example if one chooses to extend the f points to all unknowns rather than the complement of the c points w p 0 w r 0 for the interpolation and restriction operators and ilu0 and amg for the f relaxation and coarse grid solve respectively then the mgr method is equivalent to the cpr amg approach the block factorization method in bui et al 2017 is another variant of the mgr approach which uses the c points for the pressure and f points for the saturation unknowns and w r a c f d f f 1 w p 0 another advantage of the mgr approach is that it is an algebraic method and unlike geometric multigrid it can be used as a black box solver for general geometries and grid types 5 mgr for the two phase two component model again we need to solve the linear system a u f in which the matrix a is given in eq 20 the first step of multigrid reduction aims to eliminate the third row corresponding to the constraints in the cells where all the phases exist thus we have the following splitting 31 a a 11 a 12 a 13 a 14 a 21 a 22 a 23 a 24 c 31 c 32 c 33 0 c 41 c 42 0 0 c c f c note that the last column indicates the c f splitting we use for this case the schur complement after the reduction step reads 32 s 1 r a p a 11 a 12 a 14 a 21 a 22 a 24 c 41 c 42 0 a 13 a 23 0 c 33 1 c 31 c 32 0 33 a 11 a 13 c 33 1 c 31 a 12 a 13 c 33 1 c 32 a 14 a 21 a 23 c 33 1 c 31 a 22 a 23 c 33 1 c 32 a 24 c 41 c 42 0 again the operators r and p come from eqs 27 and 28 note that this reduction step is exact since c 33 is a diagonal matrix however we have not eliminated the zero diagonal values after the first reduction step next we eliminate the saturation block with the following c f splitting 34 s 1 s 11 s 12 a 14 s 21 s 22 a 24 c 41 c 42 0 c f c the schur complement also the coarse grid for the second level of multigrid reduction reads 35 s 2 r s 1 p s 11 a 14 c 41 0 s 12 c 42 s 22 1 s 21 a 24 36 s 11 s 12 s 22 1 s 21 a 14 s 12 s 22 1 a 24 c 41 c 42 s 22 1 s 21 c 42 s 22 1 a 24 where s 22 1 is some approximation of s 22 1 to compute r and p from eq 26 in the f relaxation step the action of the saturation block s 22 1 is achieved by one v cycle of amg in the equation above the presence of the constraints in the matrix s 2 makes it non elliptic and therefore we cannot solve it using amg although it no longer has zeros on the diagonal the final reduction step is employed to eliminate these constraints by putting them as f points 37 s 2 s 11 2 s 12 2 s 21 2 s 22 2 c f 38 s 3 r s 2 p s 11 2 s 12 2 s 22 2 1 s 21 2 the schur complement at the last level s 3 can be solved using amg a schema of a multi level reduction approach is illustrated in fig 1 at each level we reduce one or more variables until we obtain the variable associated with the elliptic operator which is the pressure variable in our case this means that in fig 1 u 1 pl figs 2 and 3 6 numerical experiments in this section we perform numerical experiments to show the efficiency of the multigrid reduction approach hereinafter referred as hypremgr in solving the linear equations arising in various flow scenarios the algorithm is implemented as a part of hypre falgout et al 2006 falgout and yang 2002 for all amg solve steps we use boomeramg henson and yang 2000 also included in hypre the two phase two component flow using the ncp approach is implemented in amanzi a parallel open source multi physics c code developed as a part of the ascem project ascem 2009 although amanzi was first designed for simulation of subsurface flow and reactive transport its modular framework and concept of process kernels coon et al 2014 allow new physics to be added relatively easily for other applications the simulator employed in this work is one such example amanzi works on a variety of platforms from laptops to supercomputers it also leverages several popular packages for mesh infrastructure and solvers through a unified input file again due to the presence of zeros on the diagonal of the generalized jacobian matrix a we cannot use current amg solvers such as hypre s boomeramg and trillinos ml for our problem even when we eliminate the zeros on the diagonal of a to obtain a smaller system using hypre s boomeramg and trilinos ml for system as a preconditioner gmres still fails to converge within 400 iterations we also exclude ilut variants also implemented in euclid and trillinos as they are not robust for the problems considered in this work thus in all of our experiments we compare hypremgr with the ilu k method from euclid which is also a part of hypre ilu k is used sequentially for all the examples we experiment with different levels of fill k and report the results for the minimum k that is sufficient for gmres to converge within 400 iterations throughout the simulation in each test case we also try ilu2 see konshin et al 2015 which is a two parameter modification of ilut designed for nonsymmetric saddle point problems and find its performance comparable to that of ilu k presented in this section with appropriate thresholds however it is not clear how to choose the optimal parameters of ilu2 for the problems presented here since they are dependent on the characteristics of the problem i e advection dominated or diffusion dominated and also on the mesh size due to these complexities and the challenges integrating the solver with our simulator we do not report the results here gmres is provided within amanzi for simplicity we employ structured cartesian grids for the test cases but we can also use unstructured k orthogonal grids for parallel results the test cases are run on syrah a cray system with 5184 intel xeon e5 2670 cores at the lawrence livermore national laboratory computing center amanzi and other libraries are compiled with openmpi 1 6 5 and gcc 4 9 2 the total time is measured in seconds this section has four parts in the first part we show the results for an unsaturated flow problem with no phase appearance disappearance in the second part we report the results for the saturated flow problem in which the gas phase appears by injection and then disappears after the injection is stopped these two test cases were originally presented in the momas gas benchmark project bourgeat et al 2013 the third example includes a three dimensional problem with parameters generally used in reservoir simulation in the last part we examine the scalability of the multigrid reduction approach unless specified otherwise for all of the simulations presented here the convergence tolerance for semi smooth newton s method is f x 10 5 and the linear tolerance for gmres is j δ u k f u k 10 12 f u k which is the default in amanzi for amg solves we use the default parameters in boomeramg the coarsening strategy is the parallel cleary luby jones plassman cljp coarsening cleary et al 1998 the interpolation method is the classical interpolation defined in ruge and stueben 1986 and the smoother is the forward hybrid gauss seidel sor scheme the number of v cycle steps is set to 1 6 1 unsaturated flow this test shows a two dimensional case in which the water and gas system is initially out of equilibrium and then evolves towards equilibrium there is no flow in and out of the domain and there is no phase appearance disappearance the detailed set up of the experiment is described below for boundary conditions we impose no flow condition on the boundary of the whole domain denoting ψ w ρ l w k λ l p l j l h and ψ h ρ l h k λ l p l ρ h h k λ g p g j l h we have ψ k ν 0 k w h on γ initial conditions are uniformly constant on each sub domain ω1 and ω2 p l p l 1 and p g p g 1 on ω1 p l p l 2 p l 1 and p g p g 2 p g 1 on ω2 for capillary pressure we use the van genuchten model with p r 2 10 6 pa n 1 54 s l r 0 01 and s g r 0 the rest of the parameter values are shown in tables 1 and 2 we run 5 time steps of size d t 10 seconds the results are summarized in table 3 ns denotes the number of nonlinear iterations ls the number of linear iterations and ls ns the average number of linear iterations per nonlinear iterations in this experiment because there is no phase disappearance appearance the diagonal of the jacobian does not have any zero and ilu 0 can be used as a preconditioner with respect to hypremgr we apply two levels of reduction for this problem one for the constraints with nonzero diagonal values and one for the saturation block the approximations for the restriction and interpolation operators from eq 27 are used in this case as the liquid saturation does not go to zero the effect of capillary pressure is small and that makes the system more advection dominated thus we do not need use amg to solve for the saturation correction in the f relaxation step here we found that using three gauss seidel smoothing steps is sufficient except for the finest grid where amg with a two level v 3 3 cycle is used for the coarse grid a single amg v 2 2 cycle is applied for all the mesh sizes table 3 indicates that our new algorithm is more efficient both in terms of run time and number of iterations it also exhibits near optimal scaling with respect to mesh size hypremgr is faster across all the meshes both in terms of the run time and average number of linear iterations for the mesh size of 800 40 hypremgr is twice faster in terms of run time and takes less than a fifth of the number of iterations of ilu 0 for the largest mesh of 1600 80 ilu 0 is very inefficient and hypremgr is about 7 times faster than ilu 0 in terms of run time and number of iterations 6 2 saturated flow with phase appearance this test is devoted to describing gas phase appearance produced by injecting pure hydrogen in a two dimensional homogeneous porous domain ω which was initially 100 saturated by pure water the porous domain is a rectangle of size 200m 20m with three types of boundaries γin on the left side is the inflow boundary γout on the right side is the outflow boundary and γimp at the top and bottom is the impervious boundary there is no source terms inside the boundary and the boundary conditions are as follows no flux on γ imp 39 ψ w ν 0 and ψ h ν 0 injection of hydrogen on the inlet γin 40 ψ w ν 0 and ψ h ν 5 57 10 6 k g m 2 y e a r fixed liquid saturation and pressure on the outlet 41 p l 10 6 p a s l 1 ρ l h 0 initial conditions are uniform throughout the domain corresponding to a stationary state of saturated liquid and no hydrogen injection 42 p l 10 6 p a s l 1 ρ l h 0 the rest of the physical parameters are given in bourgeat et al 2013 for the capillary pressure model we experimented two scenarios 1 power laws for relative permeabilities as in equation 11 in conjunction with the linear capillary pressure model and 2 van genuchten for both relative permeabilities and capillary pressure model in the first case the entry pressure is p r 2 10 6 pa and in the second case we use p r 2 10 6 pa n 1 49 in both cases the residual saturations are s g r 0 and s l r 0 4 we run the simulation for 100 time steps of fixed size d t 5000 years fig 4 shows the infiltration of hydrogen after 5 105 years for the second scenario and the performance of the preconditioners is reported in table 4 as we can see in fig 4 the left side of the core is infiltrated with hydrogen while the right side is still fully saturated with water we also plot the gas saturation and the pressures in the first cell over time in fig 5 although we do not have the exact numbers for comparison a visual inspection indicates that our simulation results match well with those in bourgeat et al 2013 marchand and knabner 2014 and neumann et al 2013 regarding the setup of hypremgr in this case we use three levels of reduction with the restriction and interpolation operators in equation 28 for the first level which we need to eliminate the constraints with non zero diagonal values a single jacobi iteration used for the f relaxation for the subsequent levels we apply a single amg v 1 1 cycle for the aff solve the coarse grid correction is also solved with one amg v 2 2 cycle with regard to ilu k we experiment with different levels of fill and find that ilu 0 ilu 1 etc would fail to converge for some time step and ilu 5 is needed for convergence throughout the simulation for the nonlinear van genuchten model the new approach requires about 34 fewer number of iterations and about 17 less time than ilu 5 for mesh size of 200 10 as shown in table 4 the advantage of this approach is much clearer as the problem gets larger see table 5 in this case hypremgr takes fewer than half the number of iterations of ilu 5 and requires 40 less time even though the average number of iterations does grow in the case of hypremgr it is much less than the rate of ilu 5 also we suspect that the mesh may not be large enough for the method to show mesh independence similarly the new approach outperforms ilu 5 in both number of iterations and run time for the linear model 6 3 three dimensional case with phase transition the domain is a box of dimensions 100m 100m 100m we use a homogeneous permeability field of k 10 14 m 2 which is typical for fresh sandstone see bear 1972 that is prevalent in reservoir simulation the domain is saturated with water and pure hydrogen is injected into the domain through the boundary of a corner at the bottom the outlet is set at the opposite corner the injection rate is 3 5 57 kg m2 year we run 1 time step of size d t 1 825 days for the relative permeabilities and capillary pressure models we use the van genuchten model with the same parameters as the example presented in section 6 3 the results are shown in table 6 since this is a case with phase appearance disappearance we use the same setup as in the second example section 6 2 for hypremgr from table 6 the new approach is about 40 faster in terms of run time and takes fewer than half the number of iterations of ilu 5 for the mesh size of 203 for the larger mesh size of 403 it is twice faster in terms of run time and it takes four times fewer the number of iterations of ilu 5 the result indicates that the advantage of hypremgr clearer as the problem gets larger although similar to the result in the previous example there is an increase in the number of iterations for hypremgr in the case of the larger mesh but again the problem is not large enough for us to see the mesh independence result in fact we show that this is exactly the case in the next section and even though the results are not presented here we note that hypremgr also outperforms ilu 5 both in run time and number of iterations for the linear model of capillary pressure 6 4 scaling results for the scalability study we use the same problem setup as in the three dimensional example in section 6 3 the only difference is in the mesh size for a strong scaling study we fix the mesh at 803 about 1 5 million unknowns and run the simulation on 8 to 128 cores each time doubling the number of cores for weak scaling we start with a mesh of 403 and then refine the mesh in all directions up to 3203 so the largest problem has about 100 million unknowns we run the problem with 2 16 128 and 1024 cores respectively the initial time step is d t 0 125 day and the final time of the simulation is 10 days except for the case of the largest mesh which we stop the simulation at 3 days as we reach the memory limit of the machine the results in fig 6 shows that hypremgr achieves promising results scaling well up to 64 cores although it is not quite optimal from 64 to 128 cores however there run time actually increases this is due to the problem size on each processor getting small about 12 000 unknowns for 128 cores and as a consequence the computation to communication ratio decreases and that makes the method less efficient for weak scaling the performance of hypremgr is independent of the mesh size as the problem size gets larger 8 times for each refinement level the number of linear iterations per nonlinear iterations does not grow significantly about 14 19 and 12 percent for 16 128 and 1024 cores respectively the average number of linear iterations also seems to approach a limit which demonstrates optimal multigrid performance regarding run time we measure both the setup phase and the solve phase of the algorithm since the setup phase requires expensive matrix matrix multiplications the total time needed to solve a linear system grows a little faster than the number of iterations yet hypremgr still achieves near optimal scalability fig 7 focuses on the time of the linear solve splitting into the setup and solution phases it is clear that solve phase achieves optimal scalability as the time needed to iterate to convergence stays nearly constant for mesh sizes 803 1603 and 3203 in contrast the setup phase which includes constructing r and p computing the coarse grids using the matrix matrix product rap and all the amg setup for the coarse grid as well as the f relaxation does not scale very well this is likely an implementation problem and it can be improved in the future in terms of memory storage like amg methods the mgr approach requires the storage of the restriction interpolation and coarse grid operators at every level however in addition to these operators the mgr approach also needs to store the aff matrices at the levels which scalar amg is used for the f relaxation step when aggressive coarsening is performed in standard amg methods the size of the coarse grid can be significantly reduced after the first level with mgr the size of the matrix is reduced by at most a third since the reduction is dictated by the block structure of the system rather than the heuristics used in amg 7 conclusion we have presented a preconditioning strategy for solving the linear systems that arise from the solution of multiphase multicomponent porous media flow with phase transitions to account for the phase transitions the problem is formulated as a nonlinear complementarity problem and solved using the semi smooth newton technique the proposed preconditioner is based on the multigrid reduction technique which generalizes traditional two stage preconditioners in a natural multigrid framework in this work we extend a previously developed two grid strategy to a multilevel reduction strategy that accounts for the transitions in the phases of the primary variables we have demonstrated the performance of the preconditioner on classic benchmark problems presented in the literature and show the parallel efficiency of the linear solver on large scale problems the numerical results indicate optimal scalability and robust performance of the mgr preconditioner which is important for real field simulations we observed that depending on the properties of the capillary pressure model used a different solver could be used for the f relaxation phase of the preconditioner when the model is convection dominated a simple relaxation scheme is sufficient for f relaxation however when the model is diffusion dominated relaxation alone is not sufficient and a more robust solver is required for f relaxation in our experiments we used amg for such problems however this may be excessive and in some cases inefficient for applications with phase transitions the fronts along which the transitions occur can be small compared to the entire domain as a result using the same strategy for f relaxation at these intermediate solves can be inefficient since communication dominates computation at this point allowing different strategies to be employed as dictated by the physics can be a more efficient strategy for example using a single level relaxation strategy instead of a multilevel v cycle technique could be more appropriate we are exploring this idea in addition to aggressive coarsening strategies to improve parallel efficiency future applications of interest for the mgr solver include applications with multiple phases poromechanics and applications with fractures and thermal properties the mgr framework is general enough to handle these applications as a black box solver and can also serve as a basis for building good physics based preconditioners however more work may be required to improve solver performance for these complex applications we are exploring new strategies for building interpolation and restriction operators so that the final coarse grid system is a good approximation to a pressure system or has elliptic m matrix properties that is amenable to solution by amg we are also considering incorporating structure information within a semi structured framework to develop a robust solver that can effectively handle grid anisotropy for complex geometries 
840,multiphase flow is a critical process in a wide range of applications including oil and gas recovery carbon sequestration and contaminant remediation numerical simulation of multiphase flow requires solving of a large sparse linear system resulting from the discretization of the partial differential equations modeling the flow in the case of multiphase multicomponent flow with miscible effect this is a very challenging task the problem becomes even more difficult if phase transitions are taken into account a new approach to handle phase transitions is to formulate the system as a nonlinear complementarity problem ncp unlike in the primary variable switching technique the set of primary variables in this approach is fixed even when there is phase transition not only does this improve the robustness of the nonlinear solver it opens up the possibility to use multigrid methods to solve the resulting linear system the disadvantage of the complementarity approach however is that when a phase disappears the linear system has the structure of a saddle point problem and becomes indefinite and current algebraic multigrid amg algorithms cannot be applied directly in this study we explore the effectiveness of a new multilevel strategy based on the multigrid reduction technique to deal with problems of this type we demonstrate the effectiveness of the method through numerical results for the case of two phase two component flow with phase appearance disappearance we also show that the strategy is efficient and scales optimally with problem size keywords algebraic multigrid preconditioning compositional two phase flow phase transitions nonlinear complementarity problem 1 introduction modeling multiphase flow in porous media is a challenging task given the complex physics involved the flow is described by a set of nonlinear and strongly coupled partial differential equations pdes with algebraic constraints these equations are usually solved with fully implicit method which requires solving large scale non symmetric and ill conditioned linear systems the problem becomes even more difficult if we take into account phase transitions when phase transitions occur the pdes can become degenerate and that makes the resulting linear system indefinite krylov subspace methods such as the generalized residual method gmres saad and schultz 1986 can be applied to solve these systems however these methods by themselves generally converge slowly and they must be appropriately preconditioned to accelerate convergence the incomplete lu ilu factorization is a popular approach as a preconditoner due to its simplicity and generality however as simulations cover larger and larger domains and are deployed over high performance parallel architectures there is an apparent need for robust solvers that scale and the use of standard single level ilu methods becomes less favorable previously most of the research has focused on finding new formulations which can deal with phase transitions some approaches include primary variable switching pvs forsyth et al 1995 wu and forsyth 2001 negative saturation abadpour and panfilov 2009 and finding a set of persistent primary variables bourgeat et al 2009 marchand et al 2012 neumann et al 2013 recently a new approach has been developed for handling the phase transitions by formulating the system of equations as a nonlinear complementarity problem ncp ben gharbia and jaffré 2014 lauser et al 2011 marchand and knabner 2014 unlike the pvs approach the advantage of the ncp approach is that the set of primary variables is consistent through out the simulation and no primary variable switching is needed not only is this approach more robust and efficient it also presents an opportunity to use scalable linear solvers such as algebraic multigrid amg in this work we focus on developing a new amg preconditioner based on multigrid reduction mgr for gmres to solve the linear system resulting from the discretization of the continuous problem mgr technique has been around for many years ries and trottenberg 1979 ries et al 1983 it can be considered as a generalization of the multi stage preconditioner in a standard multigrid framework a closed form of the error propagator can be derived for the mgr approach and this enables us to study the effect of different multigrid components on the convergence of the linear solver in addition the mgr framework has been shown to be an efficient preconditioner for different types of pdes such as the reservoir simulation and it has also been applied with varying degree of success to the time dimension falgout et al 2014 we consider a two phase two component system with phase transitions as our model problem we describe this model in details in section 2 classical approach to simulate two phase two component is well posed if two primary variables are chosen in advance for example one can choose one phase pressure and one phase saturation or one phase pressure and one component concentration this set of variables remains fixed in the case of phase appearance disappearance if we know in advance what phase will appear and disappear during the simulation then a constrained pressure residual cpr preconditioning approach dawson et al 1997 qiao et al 2017 wallis et al 1985 can be employed to obtain a semi elliptic pressure equation the pressure equation is solved with a multi level method such as amg or multiscale cusini et al 2015 and followed by a relaxation step with ilu for the global linear system although this approach has been shown to be very effective for some real world examples cusini et al 2015 it could be less robust in cases with strong capillarity effect bui et al 2017 due to the fact that the cpr approach uses ilu in the smoothing step it may not scale as well as a block factorization approach bui et al 2017 the goal of this paper is to develop a new multigrid algorithm that is both robust efficient and also general to accommodate various formulations of compositional multiphase flow in particular we show that under appropriate assumptions our multigrid reduction method is equivalent to the cpr amg and block factorization approaches the rest of this paper is organized as follows in section 3 we describe the fully implicit discretization we briefly review the mgr framework in section 4 and explain our new mgr algorithm in section 5 in section 6 several numerical tests are studied for the robustness and scalability of the new algorithm some conclusion remarks as well as future work are presented in section 7 2 problem statement 2 1 governing equations we consider a simplified two phase two component model with phase transitions similar to that presented in bourgeat et al 2013 this model provides a simple example that demonstrates the capability of the nonlinear complementarity constraint approach to handle phase appearance and disappearance the flow consists of gas and liquid phases and the components are hydrogen and water we make the following simplifications 1 water does not vaporize so the gas phase contains only hydrogen and 2 the amount of hydrogen dissolved into the liquid phase is small for a complete set of assumptions we refer to bourgeat et al 2009 for the two components the mass conservation equations read 1 ϕ ρ l w s l t ρ l w q l j l h 0 2 ϕ ρ l h s l ρ g h s g t ρ l h q l ρ g h q g j l h 0 where the subscripts l g denote the liquid and gas phases and the superscripts w h denote the water and hydrogen components respectively ϕ is the porosity sα q α are the saturation and velocity of phase α respectively ρ l h is the dissolved hydrogen mass concentration in the liquid phase and j l h is the diffusion flux of hydrogen in the liquid phase the darcy s velocity q α follows the darcy muskat law 3 q α k λ α p α ρ α g α l g where k is the absolute permeability λα pα and ρα are the mobility pressure and density of phase α and g is the gravitational acceleration the mobility λα of phase α is defined as the ratio between the phase relative permeability krα and the phase viscosity μα λ α k r α μ α using fick s law the diffusion flux of hydrogen in liquid j l h in eqs 1 and 2 can be expressed as 4 j l h ϕ s l d l h ρ l h where d l h is hydrogen molecular diffusion coefficient in liquid since we assume incompressibility of the liquid phase the mass density of the water component in the liquid phase is constant i e ρ l w ρ w s t d to capture capillarity effect the jump in the pressure at the interface of the two phases is modeled by the relation 5 p g p l p c s l where pc is the capillary pressure additionally we have the constraints 6 s l s g 1 to close the model we also need a set of equations for the thermodynamic equilibrium neglecting water vapor and assuming low solubility of hydrogen in the liquid phase henry s law can be used to connect the gas pressure pg and the dissolved hydrogen mass concentration in liquid ρ l h 7 ρ l h c h p g where c h h m h ρ w s t d m h m w h is the henry s law constant and mi i w h are the molar mass of the ith component again since we ignore water vapor in the gas phase the ideal gas law reads 8 ρ g h ρ g c v p g where cv is a constant and c v m h r t t is the temperature and r the ideal gas constant 2 2 nonlinear complementarity problem to handle phase transitions we introduce the following nonlinear complementarity constraint problem 9 c h p g ρ l h 0 1 s l 0 1 s l c h p g ρ l h 0 equivalently we can rewrite the above equation using the min function as in ben gharbia and jaffré 2014 lauser et al 2011 10 min 1 s l c h p g ρ l h 0 although one can use other types of complementarity functions the min function is convenient because of its piece wise linearity with respect to the variable sl and ρ h l which simplifies the computation of the jacobian in each nonlinear iteration when the gas phase is not present we have c h p g ρ l h 0 since ρ l h 0 and eq 10 reduces to 1 s l 0 when the gas phase appears 1 s l 0 and the constraint equation is governed by henry s law in eq 7 2 3 relative permeability curves in this paper we use two different models for relative permeability terms power law 11 k r l s l e 2 k r g 1 s l e 2 12 s l e s l s l r 1 s l r s g r van genuchten law van genuchten 1980 13 k r l s l e 1 1 s l e 1 m m 2 14 k r g 1 s l e 1 s l e 1 m 2 m 15 m 1 1 n where sle is the effective liquid saturation and slr sgr 0 1 are the residual saturations of the liquid and gas phase respectively 2 4 capillary pressure we employ two models for capillary pressure linear model 16 p c p r 1 s l e van genuchten model van genuchten 1980 17 p c p r s l e 1 m 1 1 n where pr is the entry pressure notice that the function pc sl in the van genuchten model is only defined for sl 0 1 and p c is unbounded near 0 and 1 thus it is necessary to modify the model to limit the growth of p c and extend it for s l r since the value of sl can become larger than 1 or less than 0 during the nonlinear iteration we used a regularization as presented in marchand and knabner 2014 with parameter ϵ 10 5 2 5 primary variables there are many ways to choose a set of primary variables depending on the problem formulation and applications in our model example a convenient choice is the liquid saturation liquid pressure and the concentration of hydrogen in the liquid phase we have our solution vector u p l s l ρ l h unlike in other methods such as primary variable switching in the ncp approach the choice of primary variable is fixed throughout the simulation this is an important feature for success of our multilevel algorithm discussed in section 5 3 solution algorithm in this paper we consider solving the coupled system consisting of eqs 1 2 and 9 fully implicitly we use a cell centered finite volume method for spatial discretization as it is a natural way to preserve the mass conservation property of the balance eqs 1 and 2 in addition it can deal with the case of discontinuous permeability coefficients and it is relatively straightforward to implement for the time domain we employ the backward euler method to avoid the cfl stability restriction of the time step 3 1 semi smooth newton s method we want to solve the system r u h u 0 from the pdes θ u min f g 0 from the constraints in which f and g are discrete functions of 1 s l and c g p g ρ l h respectively and r u is the residual function a straightforward approach for solving nonlinear systems of equations is the newton s method which requires solution of a linear system at each iteration k 18 r u u u k δ u r u k this method requires that the jacobian r u is defined everywhere in the case of ncp formulation the constraints θ are only differentiable almost everywhere and we will need to consider a semi smooth newton s method instead the procedure for the semi smooth newton s method is similar to that for newton s method except that we substitute the derivative θ with a member of the subdifferential θ when the function θ is non differentiable let f r n r n be a locally lipschitz continuous function and df be the set where f is differentiable the b subdifferential of f at x is defined as the set b f x g r n n x k d f with x k x f x k g below is the algorithm for the semi smooth newton s method as described in ben gharbia and jaffré 2014 for our two phase two component model the active set ak corresponds to the set of last rows where the gas phase is present the general semi smooth newton s method converges locally superlinearly for semi smooth functions and quadraticly for strongly semi smooth functions definitions of semi smooth and strongly semi smooth are given in qi and sun 1999 and a complete treatment of the semi smooth newton s method with active set strategy is presented in hintermüller et al 2002 the linear system resulting from taking the subdifferential r u is often very difficult to solve using iterative methods and preconditioning is critical for rapid convergence of krylov subspace methods such as gmres in the next section we discuss the linear system arising from the semi smooth newton s method and give a detailed description of the solution algorithms we will use to solve this system 3 2 linear system assuming that each physical variable is ordered lexicograhpically then each nonlinear iteration entails the solution of a discrete version of a block linear system of the form 19 a 11 a 12 a 13 a 21 a 22 a 23 a 31 a 32 a 33 u 1 u 2 u 3 f 1 f 2 f 3 in which the matrices in the first two rows are the discretized version of the linearized operators from the pdes let δ p l δ s l δ ρ l h be the updates for pressure saturation and hydrogen density at each nonlinear step using taylor expansion and keeping only the linear terms we have a 11 ρ l w k λ l δ p l a 12 ϕ t ρ l w δ s l ρ l w k λ l p l δ s l ϕ d l h ρ l h δ s l a 13 ϕ s l d l h δ ρ l h a 21 ϕ t s g c g δ p l ρ l h k λ l δ p l ρ g h k λ g δ p l c g k λ g p g δ p l a 22 ϕ t ρ l h ρ g h δ s l ρ l h k λ l p l δ s l ρ g h k λ g p g δ s l c g p c k λ g p g δ s l ρ g h k λ g p c δ s l ρ g h k λ g p c δ s l ϕ d l h ρ l h δ s l a 23 ϕ t s l δ x l h ϕ s l d l h δ ρ l h all the coefficients in the above equations are evaluated at the linearization point p l s l ρ l h from these operators we can make some important observations the global matrix is non symmetric and indefinite the block a 11 has the structure of a discrete purely elliptic problem for pressure the coupling block a 12 has the structure of a discrete first order hyperbolic problem in the liquid phase saturation the coupling block a 21 has the structure of a discrete parabolic problem in the wetting phase pressure the block a 22 has the structure of a discrete parabolic convection diffusion problem for saturation when capillary pressure is a non constant function of the saturation when capillary pressure is zero or a constant p c 0 and there is no diffusion term the block has the form of a hyperbolic problem the entries of the blocks with respect to the dissolved hydrogen mass density a 13 a 23 are small with respect to the diagonal block a 11 and only play a significant role in the regions where the gas phase does not exist these observations will help us motivate the development of our new method in the next section besides the blocks associated with the pdes we also need to consider those in last row of the matrix in eq 19 which are derived from the discrete version of the complementarity constraint equation 9 when the gas phase does not exist we have a 31 0 a 32 δ s l a 33 0 and when the gas phase is present these blocks become a 31 h δ s l a 32 h p c δ s l a 33 m h ρ l w m w δ x l h in matrix form the blocks a 31 a 32 and a 33 are diagonal matrices since the constraints are local again because a phase can disappear the block a 33 is not guaranteed to be non singular in fact when this happens the rows corresponding to the cells where a phase disappears have zero diagonal values thus we can split the last row into two separate sets the set with zeros on the diagonal of a 33 and its complement rewriting the matrix a using this splitting we have 20 a a 11 a 12 a 13 a 14 a 21 a 22 a 23 a 24 c 31 c 32 c 33 0 c 41 c 42 0 0 let n be the number of elements in the mesh and m be the number of cells in which the gas phase is present then the size of the matrix a is 3n 3n the blocks aij i 1 2 j 1 2 have the size of n n the pressure hydrogen mass concentration a 13 a 14 and saturation hydrogen mass concentration a 23 a 24 coupling blocks have the size of n m and n n m respectively the hydrogen mass concentration pressure c 31 c 41 and hydrogen mass concentration saturation c 32 c 42 constraint blocks have the size of m n and n m n respectively the block c 33 is a diagonal matrix of size m m which contains only non zero diagonal values of a 33 the 0 block on the diagonal has the size of n m n m since a has zeros on its diagonal it is clear that we cannot use classical amg algorithms to solve this system in the past since much of the focus was to find a formulation that can take into account all the complex physics involved in simulating compositional multiphase flow with miscibility and phase transitions there has not been a lot of work in designing optimal preconditioners for this type of linear system recently there have been some development of algebraic multigrid preconditioners such as two stage preconditioning stueben et al 2007 wang et al 2017 and block factorization bui et al 2017 for immiscible two phase flow yet these methods have not been applied successfully to the problems considered here the most popular and robust method is still using the incomplete factorization ilu of the global matrix a as a preconditioner to gmres in this work we seek to develop a new algebraic multigrid preconditioner based on multigrid reduction for the linear system arising in the semi smooth newton s method 4 multigrid reduction the idea of multigrid reduction mgr has been around for a long time tracing back to the work of ries and trottenberg 1979 and ries et al 1983 recently it has gained more attention through the work on multigrid reduction in time by falgout et al 2014 in this section we summarize the approach for the case of two level reduction given a matrix a we have the c f splitting 21 a a f f a f c a c f a c c i f f 0 a c f a f f 1 i c c a f f 0 0 s i f f a f f 1 a f c 0 i c c where icc and iff are identity matrices and s a c c a c f a f f 1 a f c is the schur complement we can define the ideal interpolation and restriction operators by 22 p a f f 1 a f c i c c r a c f a f f 1 i c c additionally define the injection operator as q i f f 0 t then since a f f q t a q and s r a p it is simple to derive that a 1 p r a p 1 r q q t a q 1 q t and 23 0 i a 1 a i p r a p 1 r a q q t a q 1 q t a 24 i p r a p 1 r a i q q t a q 1 q t a 25 i q q t a q 1 q t a i p r a p 1 r a where the equivalence occurs since r a q q t a p 0 this identity defines the two level multigrid method with the ideal petrov galerkin coarse grid operator rap and the f relaxation q q t a q 1 q t eq 23 is the additive mgr identity and eqs 24 and 25 are multiplicative identities with pre smoothing and post smoothing however constructing ideal interpolation and restriction operators is impractical and we need to approximate these operators in practice mgr methods replace ideal restriction and prolongation with approximations r and p respectively where 26 p w p i c c r w r i c c there are many ways to construct the restriction r and interpolation p operators here we have only experimented with two options 27 w r 0 w p d f f 1 a f c and 28 w r a c f d f f 1 w p d f f 1 a f c where d f f d i a g a f f the f relaxation in eqs 24 and 25 is also generally replaced with a more efficient method and often extended to all unknowns not just f points we can solve with block jacobi block gauss seidel ilu or amg the coarse grid operator a c r a p could also be considered as an approximation to the schur complement there are many proposed approximations to schur complement including several based on multigrid ideas bank and smith 1999 chow and vassilevski 2003 reusken 1996 1999 rusten and winther 1992 wagner et al 1997 the physics based approximation for the schur complement are of interest general settings there are lots literatures for saddle point problems benzi and wathen 2008 elman et al 2006 2008 sloan 1986 another interesting direction is based on the work on block factorized sparse approximate inverse block fsai preconditioners in ferronato et al 2014 in the context of mgr the block fsai could be used to construct good approximation to the restriction and interpolation operators in general we define the mgr operator in either pre smoothing or post smoothing form by 29 i m m g r 1 a i p m c 1 r a i m f 1 a 30 i m m g r 1 a i m f 1 a i p m c 1 r a where m c 1 r a p 1 is the coarse grid correction and m f 1 is the smoother the two grid solve consists of an f relaxation followed by a coarse grid correction can be presented as follows the appeal of the mgr approach is that it provides a flexible framework for choosing the coarse fine grids the interpolation and restriction operators and the solver for the coarse fine grids for example if one chooses to extend the f points to all unknowns rather than the complement of the c points w p 0 w r 0 for the interpolation and restriction operators and ilu0 and amg for the f relaxation and coarse grid solve respectively then the mgr method is equivalent to the cpr amg approach the block factorization method in bui et al 2017 is another variant of the mgr approach which uses the c points for the pressure and f points for the saturation unknowns and w r a c f d f f 1 w p 0 another advantage of the mgr approach is that it is an algebraic method and unlike geometric multigrid it can be used as a black box solver for general geometries and grid types 5 mgr for the two phase two component model again we need to solve the linear system a u f in which the matrix a is given in eq 20 the first step of multigrid reduction aims to eliminate the third row corresponding to the constraints in the cells where all the phases exist thus we have the following splitting 31 a a 11 a 12 a 13 a 14 a 21 a 22 a 23 a 24 c 31 c 32 c 33 0 c 41 c 42 0 0 c c f c note that the last column indicates the c f splitting we use for this case the schur complement after the reduction step reads 32 s 1 r a p a 11 a 12 a 14 a 21 a 22 a 24 c 41 c 42 0 a 13 a 23 0 c 33 1 c 31 c 32 0 33 a 11 a 13 c 33 1 c 31 a 12 a 13 c 33 1 c 32 a 14 a 21 a 23 c 33 1 c 31 a 22 a 23 c 33 1 c 32 a 24 c 41 c 42 0 again the operators r and p come from eqs 27 and 28 note that this reduction step is exact since c 33 is a diagonal matrix however we have not eliminated the zero diagonal values after the first reduction step next we eliminate the saturation block with the following c f splitting 34 s 1 s 11 s 12 a 14 s 21 s 22 a 24 c 41 c 42 0 c f c the schur complement also the coarse grid for the second level of multigrid reduction reads 35 s 2 r s 1 p s 11 a 14 c 41 0 s 12 c 42 s 22 1 s 21 a 24 36 s 11 s 12 s 22 1 s 21 a 14 s 12 s 22 1 a 24 c 41 c 42 s 22 1 s 21 c 42 s 22 1 a 24 where s 22 1 is some approximation of s 22 1 to compute r and p from eq 26 in the f relaxation step the action of the saturation block s 22 1 is achieved by one v cycle of amg in the equation above the presence of the constraints in the matrix s 2 makes it non elliptic and therefore we cannot solve it using amg although it no longer has zeros on the diagonal the final reduction step is employed to eliminate these constraints by putting them as f points 37 s 2 s 11 2 s 12 2 s 21 2 s 22 2 c f 38 s 3 r s 2 p s 11 2 s 12 2 s 22 2 1 s 21 2 the schur complement at the last level s 3 can be solved using amg a schema of a multi level reduction approach is illustrated in fig 1 at each level we reduce one or more variables until we obtain the variable associated with the elliptic operator which is the pressure variable in our case this means that in fig 1 u 1 pl figs 2 and 3 6 numerical experiments in this section we perform numerical experiments to show the efficiency of the multigrid reduction approach hereinafter referred as hypremgr in solving the linear equations arising in various flow scenarios the algorithm is implemented as a part of hypre falgout et al 2006 falgout and yang 2002 for all amg solve steps we use boomeramg henson and yang 2000 also included in hypre the two phase two component flow using the ncp approach is implemented in amanzi a parallel open source multi physics c code developed as a part of the ascem project ascem 2009 although amanzi was first designed for simulation of subsurface flow and reactive transport its modular framework and concept of process kernels coon et al 2014 allow new physics to be added relatively easily for other applications the simulator employed in this work is one such example amanzi works on a variety of platforms from laptops to supercomputers it also leverages several popular packages for mesh infrastructure and solvers through a unified input file again due to the presence of zeros on the diagonal of the generalized jacobian matrix a we cannot use current amg solvers such as hypre s boomeramg and trillinos ml for our problem even when we eliminate the zeros on the diagonal of a to obtain a smaller system using hypre s boomeramg and trilinos ml for system as a preconditioner gmres still fails to converge within 400 iterations we also exclude ilut variants also implemented in euclid and trillinos as they are not robust for the problems considered in this work thus in all of our experiments we compare hypremgr with the ilu k method from euclid which is also a part of hypre ilu k is used sequentially for all the examples we experiment with different levels of fill k and report the results for the minimum k that is sufficient for gmres to converge within 400 iterations throughout the simulation in each test case we also try ilu2 see konshin et al 2015 which is a two parameter modification of ilut designed for nonsymmetric saddle point problems and find its performance comparable to that of ilu k presented in this section with appropriate thresholds however it is not clear how to choose the optimal parameters of ilu2 for the problems presented here since they are dependent on the characteristics of the problem i e advection dominated or diffusion dominated and also on the mesh size due to these complexities and the challenges integrating the solver with our simulator we do not report the results here gmres is provided within amanzi for simplicity we employ structured cartesian grids for the test cases but we can also use unstructured k orthogonal grids for parallel results the test cases are run on syrah a cray system with 5184 intel xeon e5 2670 cores at the lawrence livermore national laboratory computing center amanzi and other libraries are compiled with openmpi 1 6 5 and gcc 4 9 2 the total time is measured in seconds this section has four parts in the first part we show the results for an unsaturated flow problem with no phase appearance disappearance in the second part we report the results for the saturated flow problem in which the gas phase appears by injection and then disappears after the injection is stopped these two test cases were originally presented in the momas gas benchmark project bourgeat et al 2013 the third example includes a three dimensional problem with parameters generally used in reservoir simulation in the last part we examine the scalability of the multigrid reduction approach unless specified otherwise for all of the simulations presented here the convergence tolerance for semi smooth newton s method is f x 10 5 and the linear tolerance for gmres is j δ u k f u k 10 12 f u k which is the default in amanzi for amg solves we use the default parameters in boomeramg the coarsening strategy is the parallel cleary luby jones plassman cljp coarsening cleary et al 1998 the interpolation method is the classical interpolation defined in ruge and stueben 1986 and the smoother is the forward hybrid gauss seidel sor scheme the number of v cycle steps is set to 1 6 1 unsaturated flow this test shows a two dimensional case in which the water and gas system is initially out of equilibrium and then evolves towards equilibrium there is no flow in and out of the domain and there is no phase appearance disappearance the detailed set up of the experiment is described below for boundary conditions we impose no flow condition on the boundary of the whole domain denoting ψ w ρ l w k λ l p l j l h and ψ h ρ l h k λ l p l ρ h h k λ g p g j l h we have ψ k ν 0 k w h on γ initial conditions are uniformly constant on each sub domain ω1 and ω2 p l p l 1 and p g p g 1 on ω1 p l p l 2 p l 1 and p g p g 2 p g 1 on ω2 for capillary pressure we use the van genuchten model with p r 2 10 6 pa n 1 54 s l r 0 01 and s g r 0 the rest of the parameter values are shown in tables 1 and 2 we run 5 time steps of size d t 10 seconds the results are summarized in table 3 ns denotes the number of nonlinear iterations ls the number of linear iterations and ls ns the average number of linear iterations per nonlinear iterations in this experiment because there is no phase disappearance appearance the diagonal of the jacobian does not have any zero and ilu 0 can be used as a preconditioner with respect to hypremgr we apply two levels of reduction for this problem one for the constraints with nonzero diagonal values and one for the saturation block the approximations for the restriction and interpolation operators from eq 27 are used in this case as the liquid saturation does not go to zero the effect of capillary pressure is small and that makes the system more advection dominated thus we do not need use amg to solve for the saturation correction in the f relaxation step here we found that using three gauss seidel smoothing steps is sufficient except for the finest grid where amg with a two level v 3 3 cycle is used for the coarse grid a single amg v 2 2 cycle is applied for all the mesh sizes table 3 indicates that our new algorithm is more efficient both in terms of run time and number of iterations it also exhibits near optimal scaling with respect to mesh size hypremgr is faster across all the meshes both in terms of the run time and average number of linear iterations for the mesh size of 800 40 hypremgr is twice faster in terms of run time and takes less than a fifth of the number of iterations of ilu 0 for the largest mesh of 1600 80 ilu 0 is very inefficient and hypremgr is about 7 times faster than ilu 0 in terms of run time and number of iterations 6 2 saturated flow with phase appearance this test is devoted to describing gas phase appearance produced by injecting pure hydrogen in a two dimensional homogeneous porous domain ω which was initially 100 saturated by pure water the porous domain is a rectangle of size 200m 20m with three types of boundaries γin on the left side is the inflow boundary γout on the right side is the outflow boundary and γimp at the top and bottom is the impervious boundary there is no source terms inside the boundary and the boundary conditions are as follows no flux on γ imp 39 ψ w ν 0 and ψ h ν 0 injection of hydrogen on the inlet γin 40 ψ w ν 0 and ψ h ν 5 57 10 6 k g m 2 y e a r fixed liquid saturation and pressure on the outlet 41 p l 10 6 p a s l 1 ρ l h 0 initial conditions are uniform throughout the domain corresponding to a stationary state of saturated liquid and no hydrogen injection 42 p l 10 6 p a s l 1 ρ l h 0 the rest of the physical parameters are given in bourgeat et al 2013 for the capillary pressure model we experimented two scenarios 1 power laws for relative permeabilities as in equation 11 in conjunction with the linear capillary pressure model and 2 van genuchten for both relative permeabilities and capillary pressure model in the first case the entry pressure is p r 2 10 6 pa and in the second case we use p r 2 10 6 pa n 1 49 in both cases the residual saturations are s g r 0 and s l r 0 4 we run the simulation for 100 time steps of fixed size d t 5000 years fig 4 shows the infiltration of hydrogen after 5 105 years for the second scenario and the performance of the preconditioners is reported in table 4 as we can see in fig 4 the left side of the core is infiltrated with hydrogen while the right side is still fully saturated with water we also plot the gas saturation and the pressures in the first cell over time in fig 5 although we do not have the exact numbers for comparison a visual inspection indicates that our simulation results match well with those in bourgeat et al 2013 marchand and knabner 2014 and neumann et al 2013 regarding the setup of hypremgr in this case we use three levels of reduction with the restriction and interpolation operators in equation 28 for the first level which we need to eliminate the constraints with non zero diagonal values a single jacobi iteration used for the f relaxation for the subsequent levels we apply a single amg v 1 1 cycle for the aff solve the coarse grid correction is also solved with one amg v 2 2 cycle with regard to ilu k we experiment with different levels of fill and find that ilu 0 ilu 1 etc would fail to converge for some time step and ilu 5 is needed for convergence throughout the simulation for the nonlinear van genuchten model the new approach requires about 34 fewer number of iterations and about 17 less time than ilu 5 for mesh size of 200 10 as shown in table 4 the advantage of this approach is much clearer as the problem gets larger see table 5 in this case hypremgr takes fewer than half the number of iterations of ilu 5 and requires 40 less time even though the average number of iterations does grow in the case of hypremgr it is much less than the rate of ilu 5 also we suspect that the mesh may not be large enough for the method to show mesh independence similarly the new approach outperforms ilu 5 in both number of iterations and run time for the linear model 6 3 three dimensional case with phase transition the domain is a box of dimensions 100m 100m 100m we use a homogeneous permeability field of k 10 14 m 2 which is typical for fresh sandstone see bear 1972 that is prevalent in reservoir simulation the domain is saturated with water and pure hydrogen is injected into the domain through the boundary of a corner at the bottom the outlet is set at the opposite corner the injection rate is 3 5 57 kg m2 year we run 1 time step of size d t 1 825 days for the relative permeabilities and capillary pressure models we use the van genuchten model with the same parameters as the example presented in section 6 3 the results are shown in table 6 since this is a case with phase appearance disappearance we use the same setup as in the second example section 6 2 for hypremgr from table 6 the new approach is about 40 faster in terms of run time and takes fewer than half the number of iterations of ilu 5 for the mesh size of 203 for the larger mesh size of 403 it is twice faster in terms of run time and it takes four times fewer the number of iterations of ilu 5 the result indicates that the advantage of hypremgr clearer as the problem gets larger although similar to the result in the previous example there is an increase in the number of iterations for hypremgr in the case of the larger mesh but again the problem is not large enough for us to see the mesh independence result in fact we show that this is exactly the case in the next section and even though the results are not presented here we note that hypremgr also outperforms ilu 5 both in run time and number of iterations for the linear model of capillary pressure 6 4 scaling results for the scalability study we use the same problem setup as in the three dimensional example in section 6 3 the only difference is in the mesh size for a strong scaling study we fix the mesh at 803 about 1 5 million unknowns and run the simulation on 8 to 128 cores each time doubling the number of cores for weak scaling we start with a mesh of 403 and then refine the mesh in all directions up to 3203 so the largest problem has about 100 million unknowns we run the problem with 2 16 128 and 1024 cores respectively the initial time step is d t 0 125 day and the final time of the simulation is 10 days except for the case of the largest mesh which we stop the simulation at 3 days as we reach the memory limit of the machine the results in fig 6 shows that hypremgr achieves promising results scaling well up to 64 cores although it is not quite optimal from 64 to 128 cores however there run time actually increases this is due to the problem size on each processor getting small about 12 000 unknowns for 128 cores and as a consequence the computation to communication ratio decreases and that makes the method less efficient for weak scaling the performance of hypremgr is independent of the mesh size as the problem size gets larger 8 times for each refinement level the number of linear iterations per nonlinear iterations does not grow significantly about 14 19 and 12 percent for 16 128 and 1024 cores respectively the average number of linear iterations also seems to approach a limit which demonstrates optimal multigrid performance regarding run time we measure both the setup phase and the solve phase of the algorithm since the setup phase requires expensive matrix matrix multiplications the total time needed to solve a linear system grows a little faster than the number of iterations yet hypremgr still achieves near optimal scalability fig 7 focuses on the time of the linear solve splitting into the setup and solution phases it is clear that solve phase achieves optimal scalability as the time needed to iterate to convergence stays nearly constant for mesh sizes 803 1603 and 3203 in contrast the setup phase which includes constructing r and p computing the coarse grids using the matrix matrix product rap and all the amg setup for the coarse grid as well as the f relaxation does not scale very well this is likely an implementation problem and it can be improved in the future in terms of memory storage like amg methods the mgr approach requires the storage of the restriction interpolation and coarse grid operators at every level however in addition to these operators the mgr approach also needs to store the aff matrices at the levels which scalar amg is used for the f relaxation step when aggressive coarsening is performed in standard amg methods the size of the coarse grid can be significantly reduced after the first level with mgr the size of the matrix is reduced by at most a third since the reduction is dictated by the block structure of the system rather than the heuristics used in amg 7 conclusion we have presented a preconditioning strategy for solving the linear systems that arise from the solution of multiphase multicomponent porous media flow with phase transitions to account for the phase transitions the problem is formulated as a nonlinear complementarity problem and solved using the semi smooth newton technique the proposed preconditioner is based on the multigrid reduction technique which generalizes traditional two stage preconditioners in a natural multigrid framework in this work we extend a previously developed two grid strategy to a multilevel reduction strategy that accounts for the transitions in the phases of the primary variables we have demonstrated the performance of the preconditioner on classic benchmark problems presented in the literature and show the parallel efficiency of the linear solver on large scale problems the numerical results indicate optimal scalability and robust performance of the mgr preconditioner which is important for real field simulations we observed that depending on the properties of the capillary pressure model used a different solver could be used for the f relaxation phase of the preconditioner when the model is convection dominated a simple relaxation scheme is sufficient for f relaxation however when the model is diffusion dominated relaxation alone is not sufficient and a more robust solver is required for f relaxation in our experiments we used amg for such problems however this may be excessive and in some cases inefficient for applications with phase transitions the fronts along which the transitions occur can be small compared to the entire domain as a result using the same strategy for f relaxation at these intermediate solves can be inefficient since communication dominates computation at this point allowing different strategies to be employed as dictated by the physics can be a more efficient strategy for example using a single level relaxation strategy instead of a multilevel v cycle technique could be more appropriate we are exploring this idea in addition to aggressive coarsening strategies to improve parallel efficiency future applications of interest for the mgr solver include applications with multiple phases poromechanics and applications with fractures and thermal properties the mgr framework is general enough to handle these applications as a black box solver and can also serve as a basis for building good physics based preconditioners however more work may be required to improve solver performance for these complex applications we are exploring new strategies for building interpolation and restriction operators so that the final coarse grid system is a good approximation to a pressure system or has elliptic m matrix properties that is amenable to solution by amg we are also considering incorporating structure information within a semi structured framework to develop a robust solver that can effectively handle grid anisotropy for complex geometries 
841,this work presents an efficient reservoir simulation framework for multicomponent multiphase compressible flow based on the cubic plus association cpa equation of state eos cpa is an accurate eos for mixtures that contain non polar hydrocarbons self associating polar water and cross associating molecules like methane ethane unsaturated hydrocarbons co2 and h2s while cpa is accurate its mathematical formulation is highly non linear resulting in excessive computational costs that have made the eos unfeasible for large scale reservoir simulations this work presents algorithms that overcome these bottlenecks and achieve an efficiency comparable to the much simpler cubic eos approach the main applications that require such accurate phase behavior modeling are 1 the study of methane leakage from high pressure production wells and its potential impact on groundwater resources 2 modeling of geological co2 sequestration in brine aquifers when one is interested in more than the co2 and h2o components e g methane other light hydrocarbons and various tracers and 3 enhanced oil recovery by co2 injection in reservoirs that have previously been waterflooded or contain connate water we present numerical examples of all those scenarios extensive validation of the cpa eos with experimental data and analyses of the efficiency of our proposed numerical schemes the accuracy efficiency and robustness of the presented phase split computations pave the way to more widespread adoption of cpa in reservoir simulators keywords cubic plus association equation of state carbon sequestration methane leakage co2 enhanced oil recovery gravitational fingering phase behavior 1 introduction a broad range of subsurface processes involve an aqueous phase e g formation brine disposed waste water or injected water in hydrocarbon recovery and one or more non aqueous phases lnapl dnapl hydrocarbon gas or oil injected carbon dioxide or nitrogen etc in many applications the aqueous phase can be approximated as incompressible and immiscible for example in the production from hydrocarbon reservoirs that involve formation brine or injected water as a displacement fluid as well as oil and gas either injected or already in place the mass transfer between oil and gas phases and the compressibility of gas are generally far more important than compressibility or compositional effects of the aqueous phase in such applications the properties of water or brine can be described by simple correlations and compositional effects are only considered for the non aqueous phases in other applications though the phase behavior of the aqueous phase is critical perhaps the most notable example is carbon dioxide co2 sequestration in deep saline aquifers if co2 is to be injected without production of brine ideally at high rates and if the aquifer is confined then the storage capacity is largely determined by the compressibility of brine and the porous media itself two other compositional effects are equally important first the dissolution of co2 into brine reduces the pressure build up from injection and improves the storage permanence of sequestered co2 solubility trapping this is because dissolved co2 is less prone than gas to leak through weak spots in the cap rock such as abandoned wells faults or natural and induced fractures second co2 dissolution leads to volume swelling of the aqueous phase which also affects the pressure response on longer time scales chemical reactions within the aqueous phase are also important and are sensitive to brine compositions the aforementioned processes are well known but numerical simulations of co2 sequestration often rely on simplified assumptions such as incompressible water linear relations for the brine density as a function of solute co2 composition and empirical correlations like henry s law for the co2 dissolution in water these limiting assumptions are reasonable when only two components e g h2o and co2 are considered and when such correlations are fitted to experimental data for the same temperature and pressure ranges as in an aquifer however for problems that involve more than two components the phase behavior becomes considerably more non linear and the above assumptions are violated both injected co2 and the initial formation often also contain hydrocarbons as an example in the large volume co2 sequestration pilot project near cranfield mississippi hovorka et al 2013 the injected gas was reported to contain between 2 and 5 of methane c1 and the aquifer brine was nearly saturated with c1 under such conditions solubility trapping of co2 becomes competitive with c1 hosseini et al 2013 2012 first methane exsolves and forms a bank around the displacement front behind which co2 can further dissolve and ultimately saturate the brine the methane enriched gas bank has very different properties than the initial supercritical co2 fluid already in this simple example of two phases co2 rich gas and aqueous and three components h2o co2 c1 correlations like henry s law break down because the solubility of co2 in water for instance also depends on the concentration of c1 more broadly these types of applications may also consider other resident hydrocarbon species as well as natural e g noble gasses darrah et al 2014 and introduced tracer species to accurately model the fractionation of multiple species across phases as well as the associated non linear changes in phase properties one has to adopt an equation of state eos and strictly enforce local thermodynamic equilibrium several eos have been proposed to model mixtures of water hydrocarbons and other components like co2 and nitrogen firoozabadi et al 1988 considered both the schmidt wenzel eos schmidt and wenzel 1980 and the peng robinson eos peng and robinson 1976a but with different binary interaction coefficients bic between water and dissolved components in the aqueous phase which are temperature dependent and in a gas phase constant bic the widely used saft chapman et al 1989 family of eos also accounts for association behavior and other approaches have been presented by e g economou and tsonopoulos 1997 kontogeorgis and folas 2010 the cubic plus association cpa eos li and firoozabadi 2009 has been shown to accurately describe the phase behavior of multiphase mixtures containing hydrocarbons and self associating polar molecules like water li and firoozabadi 2009 or asphaltenes li and firoozabadi 2010a 2010b nasrabadi et al 2016 this eos was further improved by treating methane ethane unsaturated hydrocarbons co2 and h2s as pseudo associating components self association is due to direct hydrogen bonding between h2o molecules cross association between water and co2 and h2s molecules is caused by the latter s permanent polar moments while cross association with hydrocarbons is caused by a temporary polar moment induced by the presence of h2o molecules the inclusion of cross association through perturbation theory considerably improves predictions for the non aqueous phase at high pressures two advantages over other eos like saft are that 1 cpa has very few adjustable parameters and 2 in the absence of polar molecules like water cpa reduces to the well known accurate and computationally efficient cubic peng robinson eos in the original cpa eos kontogeorgis et al 1996 the physical interactions were modeled by the cubic soave redlich kwong srk eos soave 1972 the main concepts of phase split calculations with the cpa eos are described in li and firoozabadi 2009 and firoozabadi 2016 however those works consider a stand alone implementation of the cpa eos in which computational efficiency was not the main focus the cpa eos is highly non linear and a naive implementation in a full fledged reservoir simulator results in as much as a three orders of magnitude increase in computational cost over the pr eos the objective of this work is therefore to develop and analyze numerical algorithms for cpa of comparable efficiency to simulators based on a cubic eos in an earlier attempt to adopt cpa for efficient three phase flow simulations moortgat et al 2012 we only allowed co2 to dissolve into water and neglected both evaporation of water and all interphase mass exchange of hydrocarbon species with the aqueous phase this approach improved simulations of e g pure co2 sequestration but could not capture complexities related to the presence of methane tracers or other components in this work we relax these limiting assumptions and allow all species to transfer between all three phases the thermodynamic framework is developed in section 2 and its performance is presented in terms of accuracy and efficiency in section 3 2 phase behavior of water gas oil mixtures with cpa eos phase behavior with cpa is implemented in an isothermal compressible multicomponent multiphase flow simulator that uses higher order finite element methods for both flow and transport moortgat and firoozabadi 2016 moortgat et al 2012 2011 specifically flow and transport are decoupled by a standard implicit pressure explicit composition impec scheme that uses a fractional flow formulation for total fluxes and has overall compositions as the primary variable in the transport update phase stability and phase split computations are performed after pressures fluxes and overall compositions have been updated the algorithms presented in this work can be coupled to other flow and transport schemes that use finite difference volume or element methods 2 1 compressibility factor of the cpa eos all thermodynamic functions of a fluid can be derived from an eos the eos for hydrocarbon gas α g and oil α o and aqueous α w phases can be written in the deceptively simple form of 1 p α v α z α n α r t or p α z α c α r t α g o w with the temperature t universal gas constant r and for each phase α the pressure pα volume vα number of moles nα or molar density cα all the complexities of non ideal phase behavior are captured in the compressibility factor zα which for the cpa eos can be expressed as li and firoozabadi 2009 2 z α z α z α b α a α z α z α 2 2 b α z α b α 2 3 1 b α b α 8 z α 3 b α b α 4 z α i 1 n c x α i j 1 2 η ij χ α ij 1 the first line eq 2 is the peng robinson eos which is widely used in petroleum engineering to describe the phase behavior of non associating hydrocarbon fluids the non ideal behavior in pr eos stems from the temperature dependent physical van der waals interactions between molecules represented by aα and the temperature independent finite volume occupied by molecules represented by bα which cannot be neglected at typical reservoir pressures aα and bα are derived from the ai and bi for pure components and the binary interaction coefficients bic kij through van der waals mixing rules firoozabadi 2016 4 a i j 1 k i j a i a j 5 a α i 1 n c j 1 n c x α i x α j a i j 6 b α i 1 n c x α i b i eq 3 describes the associating behavior related to hydrogen bonding in mixtures that contain both polar molecules that self associate and pseudo associating molecules that cross associate with water but not with each other only one species is assumed to self associate which in this work is water but can also represent a heavy asphaltene pseudocomponent li and firoozabadi 2010a 2010b association is between opposite pairs of hydrogen bond donor sites j 1 and hydrogen bond acceptor sites j 2 we consider mixtures of nc pseudo components labeled by the index i in which each phase α has a phase molar composition of x α i the number of donor or acceptor sites j of each species i is denoted by ηij with η i j 0 for all non association species i while the fraction of sites j on species i in phase α that are free i e not occupied by hydrogen bonds are given by χ α ij the expressions for χ α ij are complex in the most general case but can be simplified by two assumptions that have been proven to be highly accurate when water and not e g asphaltenes is the self associating component li and firoozabadi 2009 these assumptions are that each self or cross associating molecule i has two donor and two acceptor sites η i 1 η i 2 2 and that the bonding between donor and acceptor sites is symmetric such that χ α i χ α i 1 χ α i 2 with those assumptions the site fractions can be computed from 7 χ α w z α z α 2 i 1 n c x α i χ α i δ α w i 8 χ α i z α z α 2 x α w χ α w δ α w i in which δ α w i represents the self and cross association strengths respectively 9 δ α w w 8 z α 2 b α 8 z α b α 4 z α 3 κ p α rt exp ϵ k b t 1 10 δ α w i s i δ α w w i w in which si is a cross association parameter between water and species i and ϵ and κ are energy and volume parameters respectively of the self association of water given by 11 ϵ k b 1738 4 k 12 κ 1 8015 10 3 l mole with kb the boltzmann constant eq 2 without the association terms in eq 3 is a cubic equation for z which can be solved analytically the physical solution can be determined by the sign and the condition that z b because b represents the tightest possible packing state of the molecules 2 1 1 fast solution scheme for compressibility factors from cpa eos finding the roots of eqs 2 and 3 accounts for the main complexity and associated numerical cost of phase behavior computations with the cpa eos eqs 2 and 3 are coupled non linearly to eqs 7 and 8 and eqs 9 and 10 the fractions χ α w and χ α i each depend on each other as well as on zα and cannot be simplified e g by a separation of variables even the number of roots cannot be determined a priori this means that the set of eqs 2 8 has to be solved together by an iterative numerical scheme li and firoozabadi 2009 developed a multidimensional bisection method which can be applied over a broad range for zα e g bα zα 5 and is guaranteed to find all the roots when multiple roots are found we select the one that corresponds to the minimum gibbs free energy while robust this approach is extremely computationally inefficient the objective therefore is to develop a numerical scheme with an efficiency comparable to a simpler cubic eos we make one further assumption and only consider one cross associating component labeled by i c e g co2 for carbon sequestration in saline aquifers c1 for methane leakage into groundwater or h2s complications in waterflooding hydrocarbon reservoirs under these assumptions and with χ α i 1 for all i w and i c we solve 13 g 1 z α z α z α b α a α z α z α 2 2 b α z α b α 2 2 1 b α b α 8 z α 3 b α b α 4 z α x α w χ α w 1 x α c χ α c 1 0 14 g 2 χ α w z α z α 2 x α w χ α w δ α w w 2 x α c χ α c δ α w c 0 15 g 3 χ α c z α z α 2 x α w χ α w δ α w c 0 an obvious choice is the quadratically converging newton raphson nr method define the vectors z z α χ α w χ α c and g g 1 g 2 g 3 and the jacobian 16 j g 1 z α g 1 χ α w g 1 χ α c g 2 z α g 2 χ α w g 2 χ α c g 3 z α g 3 χ α w g 3 χ α c given an initial guess z m z for m 0 we can iteratively improve our solution as 17 z m 1 z m j z m 1 g z m until j 1 g is smaller than a tolerance which we set to 10 10 this approach is more efficient than the scheme in moortgat et al 2012 and nasrabadi et al 2016 in which nr was only applied to zα while χ α w and χ α c were updated for each iteration of zα through linearly converging but easier to implement successive substitution iterations ssi the nr method is well established but its efficiency and robustness depend critically on whether a good initial guess z is available neither the range of z nor the number of roots can be rigorously established a priori and a nr scheme can either diverge or converge to an unphysical solution a combination of a few bisection steps followed by the faster converging nr method is also not desirable a large number of multidimensional bisection cuts may be necessary to guarantee selection of the true range of zα χ α w and χ α c within which the physical solution lies in moortgat et al 2012 we only allowed co2 dissolution in water and no evaporation or dissolution of water into gas or oil phases under those conditions zα is close to that of pure water which is close to bα but this is not true for a gaseous or oleic phase that contains water in nasrabadi et al 2016 the self associating asphaltene molecules were negligible in the gas phase a pr eos initial guess for zα was effective in combination with a finite difference approximation of the derivatives in eq 16 for water containing mixtures though the molar fraction of water in the gas phase can be high and zα from the pr eos is not a good initial guess for the compressibility factor we propose two solutions the first is an obvious benefit of reservoir simulations for each grid cell that contained water at a previous time step we store the values of all z α and use those as an initial guess for the next time step this is the best initial guess because we consider an explicit forward euler time step update with a cfl condition on the time step coats 2003 courant et al 1928 which implies that compositions and pressures do not change dramatically within one time step with these initial guesses eq 17 almost always 99 converges in only a few time steps as verified in the numerical experiments if the aforementioned initial guesses are not available or in the rare cases that nr diverges we could fall back to the bisection method initial guesses are also not available in phase stability analyses which essentially evaluate changes in gibbs free energy for certain test compositions that are very different from the actual compositions in the reservoir as discussed in section 2 5 most stability analyses can be avoided by clever use of information from the previous time step nevertheless relying on the bisection method to compute zα even in the relatively few cases described above still results in an inefficient scheme for those cases it is worth correlating a number of flash computations of zα for mixtures of the initial fluid in place with the injection fluid and for a range of pressures the goal is to provide an initial guess for phase compressibility factors and χ α w and χ α c but without a phase identification because this is not known during phase stability and phase split iterations for mixtures in which co2 or c1 are the cross associating components nr nearly always succeeds by trying the following initial guesses until a converged solution is found 1 z α 1 2281 b α 0 0017 χ α w min 1 0 143 log x α w 0 1358 and χ α c 0 2232 x α w 0 9918 2 z α 0 1245 x α w 0 1505 with χ α w and χ α c as before 3 if x α w 0 5 then we use z α 1 2281 b α 0 0017 χ α w 0 1225 and χ α c 0 775 if x α w 0 5 we use z α 1 3841 b α 0 061 χ α w 0 1318 b α 2 0 1397 b α 0 8946 and χ α c 0 999 trying multiple different initial guesses for the nr scheme is still considerably faster than a single bisection loop other correlations for z could be added as well we find that with this approach the bisection method can often be avoided altogether in favor of the fast nr scheme if for any condition the nr scheme does not converge bisection can still be used to guarantee robustness of the phase behavior computations note also that in the iterative phase stability and phase split algorithms only the first iteration requires an initial guess subsequent iterations use z values from the previous iteration as initial guesses as a final improvement in efficiency note that the jacobian in eq 16 is a 3 3 matrix this matrix can be readily inverted and the derivatives in j 1 can be computed analytically and implemented explicitly rather than performing the matrix inversion in each nr iteration in reservoir simulations initial guesses from the previous time step are available in most cases and the nr method converges in two or three iterations around a displacement front when values from the previous time step are not available the correlated initial guesses can be used and nr may require a few more iterations 5 for a full simulation our algorithm to compute the cpa compressibility factors achieves comparable computational efficiency as a much simpler cubic eos see numerical experiments 2 2 phase split computations local thermodynamic equilibrium is satisfied when the chemical potential or equivalently the fugacity f α i of each component i is the same in all the phases that are in equilibrium 18 f g i f o i f w i i 1 n c which can also be expressed in terms of fugacity coefficients φ α i f α i x α i p as 19 φ g i x g i φ o i x o i φ w i x w i i 1 n c or in terms of the logarithm of equilibrium ratios k g i x g i x w i and k o i x o i x w i 20 g g i ln k g i ln φ w i ln φ g i 0 i 1 n c 21 g o i ln k o i ln φ w i ln φ o i 0 i 1 n c the last formulation is more robust than one in terms of the ki themselves which can vary over 20 orders of magnitude the notation g α i will be used in a nr solution method below the fugacity coefficients of the cpa eos are given by 22 ln φ α i ln z α b α b i b α b α z α b α a α z α z α 2 2 b α z α b α 2 a α 2 2 b α 2 j 1 n c x α j a ij a α b i b α ln z α 1 2 b α z α 1 2 b α 4 ln χ α i 4 b i 10 z α b α z α b α 8 z α b α 4 z α x α w χ α w 1 x α c χ α c 1 i 1 n c we denote the molar fraction of each phase by βα and overall molar fractions of component i by zi the phase fractions and compositions satisfy the constraints 23 i 1 n c z i i 1 n c x g i i 1 n c x o i i 1 n c x w i α β α 1 24 z i α β α x α i i 1 n c which can be expressed in our chosen 2 n c 1 primal thermodynamic variables k g i k o i βg and βo in the following two rachford rice rr equations 25 r r g i 1 n c z i k g i 1 1 β g k g i 1 β o k o i 1 0 26 r r o i 1 n c z i k o i 1 1 β g k g i 1 β o k o i 1 0 together with eqs 20 and 21 this form a closed system of 2 n c 1 equations once k g i k o i βg and βo and β w 1 β g β o are known the phase compositions follow from 27 x g i k g i x w i i 1 n c 28 x o i k o i x w i i 1 n c 29 x w i z i 1 β g k g i 1 β o k o i 1 i 1 n c the above formulation is for a three phase flash if one phase is absent only one of the relations eqs 20 and 21 and one of eqs 25 and 26 is solved with β α 0 for the absent phase if the aqueous phase is absent one of the other two phases is chosen as the reference in fact phase identification is only done after the phase split is completed and is based on both the molecular weight and the molar fraction of the heaviest component in each phase for the mixtures considered in this work in practice the aqueous phase is only absent when there is no water component in that case we switch to the simpler pr eos flash 2 3 efficient solution scheme for two and three phase flash with cpa eos phase split computations are based on the so called p t flash meaning that for a fixed pressure temperature and overall composition zi we compute phase compositions x α i and phase molar fractions βα alternative v t flash formulations in terms of a fixed volume and temperature have been developed as well mikyška and firoozabadi 2011 because the phase split relations are highly non linear iterative solution methods have to be used the efficiency and robustness of these methods rely critically on good initial guesses in this case for βα and k α i the most successful guesses are again from the previous time step alternative choices are discussed below when initial guesses for both βα and k α i are available the first step in the phase split computation is to solve the rr equations by the nr method with fixed k α i the required derivatives of eqs 25 and 26 are straightforward if no βα are provided the rr equations are solved by a two dimensional bisection method haugen et al 2011 li and firoozabadi 2012b the bisection method is robust and always converges for βα but it is very slow and should be avoided when possible see section 2 5 2 3 1 successive substitution iterations ssi the most straightforward phase split algorithm for the three phase flash with cpa eos uses ssi in the following loop see also firoozabadi 2016 1 solve rr equations with either nr or bisection method for all but the first iteration nr is used with the βα from the previous iteration as initial guess 2 for each phase compute aα bα and j 1 n c x α j a i j in eq 22 aij and bi are not phase or composition dependent and are not updated inside the ssi loop 3 for each phase compute zα in the first iteration the guesses for zα χ α w and χ α c discussed in section 2 1 1 are used subsequent iterations use values from the previous iteration as a guess for the simultaneous nr update of zα χ α w and χ α c 4 with the updated aα bα j 1 n c x α j a i j zα χ α w and χ α c compute the logarithm of fugacity coefficients from eq 22 and ln k α i from eqs 20 and 21 5 compute error it is important to check convergence of both ln k α i and βα to a tolerance which we set to ϵ err 10 10 we found that even small errors in βα can result in negative total compressibilities which in turn cause artificial pressure oscillations if the iterations have converged exit the loop otherwise return to step 1 the ssi method is robust and generally converges even for poor initial guesses but the convergence rate is linear and may require many iterations particularly near critical points several acceleration schemes have been proposed but li and firoozabadi 2012a and moortgat et al 2012 found that such acceleration may come at the cost of robustness in this work we do consider the simple geometric aitken δ 2 scheme which takes advantage of the fact that k α i n 1 k α i n becomes nearly constant after a few iterations when it does subsequent iterations can be accelerated by following every three ssi iterations with n 1 2 3 by one iteration of the form 30 ln k α i 4 ln k α i 3 ln k α i 3 ln k α i 2 2 ln k α i 3 2 ln k α i 2 ln k α i 1 for problems far from the critical point when only of the order of 10 ssi iterations are required on average the aitken δ 2 acceleration is not effective but when 20 or more iterations are required the scheme can reduce the iterations by 25 40 2 3 2 newton raphson nr to achieve quadratic convergence a nr scheme can be used we define the 2 n c 1 length vectors g g g i g o i r r g r r o from eqs 20 21 and 25 and 26 and the solution vector x ln k g i ln k g o β g β o starting from an initial guess for x the solution is refined in iterations m by 31 x m 1 x m j x m 1 g x m but now with the 2 n c 1 2 n c 1 jacobian 32 j g g i ln k g j g g i ln k o j g g i β g g g i β o g o i ln k g j g o i ln k o j g o i β g g o i β o r r g ln k g j r r g ln k o j r r g β g r r g β o r r o ln k g j r r o ln k o j r r o β g r r o β o for the two phase case say aqueous and gas we have g g g i r r g x ln k g i β g and a n c 1 n c 1 jacobian 33 j g g i ln k g j g g i β g r r g ln k g j r r g β g we only present the derivatives in eq 33 because the expressions in eq 32 are similar the biggest nc nc block is given by with δ i j 1 for i j and δ i j 0 for i j 34 g g i ln k g j δ i j ln φ w i x w j x w j ln k g j ln φ g i x g j x g j ln k g j i 1 n c j 1 n c 1 g g i ln k g n c 1 i 1 n c 35 x w j ln k g j z j β g k g j 1 β g k g j 1 2 j 1 n c 1 36 x g j ln k g j k g j x w j ln k g j x g j j 1 n c 1 the derivatives of eq 20 with respect to the phase molar fraction are given by 37 g g i β g j 1 n c 1 ln φ g i x g j x g j β g ln φ w i x w j x w j β g i 1 n c 38 x w j β g x w j ln k g j k g j 1 β g k g j j 1 n c 1 39 x g j β g k g j x w j β g j 1 n c 1 the derivatives of the rr relations are more straightforward 40 r r g ln k g j z j k g j 1 β g k g j 1 2 41 r r g β g j 1 n c z j k g j 1 2 1 β g k g j 1 2 the terms ln φ α i x α j are quite complicated for the cpa eos the derivation is similar to the one provided in the appendices of nasrabadi et al 2016 for asphaltene containing mixtures except for the different number of association sites in each model ηij in eq 3 the full nr phase split loop is similar to the one presented for ssi 1 compute aα bα and j 1 n c x α j a i j for each phase 2 compute zα χ α w and χ α c for each phase 3 compute ln φ α i and ln φ α i x α j for each phase 4 construct matrix eqs 32 or 33 phase state determined by stability analyses 5 solve eq 31 for ln k α i and βα using a gaussian elimination scheme 6 either return to step 1 or exit when results have converged to errors ϵ err 10 10 phase fractions and compositions are finally derived from eqs 27 29 2 3 3 adaptive combined ssi nr scheme one may be tempted to use the fast converging nr scheme directly e g when good initial guesses from the previous time step are available however experimentation shows that this approach often diverges or requires too many costly nr iterations a more efficient approach is to first perform a number of ssi iterations to improve the initial guess before switching to nr which will then converge in only a few iterations ssi iterations continue until a switch criterion for the error ϵ err ϵ switch is reached followed by nr iterations until ϵ err 10 10 in some cases nr will still diverge when that occurs ssi iterations are continued from the saved state before switching to nr conversely if the initial guess is very good only a single ssi iteration may be required before switching to nr we propose an efficient approach that adaptively sets the switching criterion the average number of ssi and nr iterations n ssi and n nr respectively for the computational domain is saved at every time step and after every nt time steps the efficiency is evaluated if n ssi is small e g n ssi 3 and n nr 2 ϵswitch is reduced by 20 if n ssi is large and n nr is still reasonable e g 4 ϵswitch is increased by 20 to keep the scheme robust ϵswitch has a maximum of 10 3 we allow ϵswitch to reduce to 10 10 which means that only ssi is used each nr iteration is considerably more computationally expensive than a single ssi iteration for n ssi 10 it is often more efficient to simply use ssi see numerical experiments 2 3 4 initial guesses when k α i and βα values are available from a previous time step a phase split computation is attempted directly without a phase stability analysis with such guesses the ssi nr scheme in section 2 3 3 nearly always converges with only a few iterations if a three phase initial guess two sets of k α i and βα was available the phase split is complete if the ssi nr scheme converges with a two phase guess from the previous time step we test the phase stability of the two phase solution if it is unstable we perform the three phase split but still avoid one stability analysis and save computational time on the initial two phase split if no initial guesses are available from a previous time step a stability analysis may need to be performed first more on this in section 2 5 the converged equilibrium ratios from this analysis k i stab 1 ph are usually the best initial guess for the subsequent two phase split if this guess fails the wilson correlation k i w wilson 1969 and its inverse are attempted successively one of these guesses always converges after the first stability analysis the two phase split is performed with k i 2 ph as its output the stability of this state is tested and when the system is unstable and forms a three phase mixture the stability analysis also provides k i stab 2 ph many initial guesses can be tried for the three phase split computation two sets of k α i values are needed which are labeled as k 1 i and k 2 i without phase identification the guesses for k 1 i are given in the following order until the ssi nr phase split converges 1 k i 2 ph and k i 2 ph 1 2 k i stab 1 ph and k i stab 1 ph 1 3 k i w and k i w 1 4 k i w 1 3 and k i w 1 3 5 k i stab 2 ph and k i stab 2 ph 1 and for k 2 i as 1 k i stab 2 ph and k i stab 2 ph 1 2 k i 2 ph and k i 2 ph 1 3 k i stab 1 ph and k i stab 1 ph 1 4 k i w and k i w 1 5 k i w 1 3 and k i w 1 3 the first guess appears to be sufficient in most cases no cases were found in which none of this set of guesses was good enough to obtain a converged three phase flash result 2 4 derived fluid properties in reservoir simulator unlike stand alone phase behavior software a reservoir simulator that solves the three phase flow and transport equations requires several more derived fluid phase properties the molecular weight wα molar cα and mass ρα densities and molar volumes vα follow from 42 w α i 1 n c x α i w i 43 c α p z α rt i 1 n c x α i s i 44 ρ α w α c α 45 v α β α c α α β α c α 1 where wi and si are respectively the molecular weights and the volume translation parameters of the pure pseudo components the cpa eos inherits the property of the pr eos that it can accurately predict the phase stability and phase split behavior compositions and phase fractions but that an empirical correction si may be required to obtain accurate densities si is obtained from matching experimental data viscosities μα for hydrocarbon phases are determined by a corresponding states model christensen and pedersen 2006 for the aqueous phase we currently adopt a correlation that only depends on temperature moortgat et al 2012 the most computationally expensive fluid property calculations in addition to the phase split itself are the total compressibilities and partial molar volumes of the mixture the expressions can be obtained from appendices a d in nasrabadi et al 2016 by adjusting the number of association sites from those for asphaltenes to those for water as the self associating component the computation of these properties involves n c 1 matrix inversions for matrices of dimension nc nc for say a 10 component mixture this may require as much computational cost as the phase split itself these computations are also considerably more expensive than in our prior cpa simulator moortgat et al 2012 in which water was neglected in the hydrocarbon phases and only co2 dissolution in the aqueous phase was considered on the other hand the matrices are not as ill conditioned as in the equivalent computations for asphaltene containing mixtures nasrabadi et al 2016 2 5 additional algorithmic improvements phase stability analyses are known to be computationally expensive especially in three phase flow but in reservoir simulations there are multiple ways in which stability analyses can be avoided for all but a few grid cells the most obvious example is injection into a reservoir that is saturated with single phase fluid such as gas injection into an oil reservoir or a brine aquifer unless fluid is also extracted at a higher rate than the injection rate the formation pressures can generally only increase in some cases mixing of gas and oil species can result in volume shrinkage of the oil phase also because an explicit numerical scheme is used for the transport update the displacement front does not travel by more than one grid cell in one time step for these two reasons if a grid cell and all its neighbors were in single phase at the previous time step that same grid cell will remain in single phase at the current time step and its phase stability does not need to be tested similarly if gas is injected in a reservoir that is initially saturated with oil and water in equilibrium then 1 if a grid cell and all its neighbors were a two phase mixture at the previous time step that grid cell will remain so in the next time step and 2 initial guesses k α i are always available after the first time step the two phase split still needs to be performed because phase compositions may change with small pressure changes in other scenarios reservoir fluid is produced without injection e g in gravity depletion from oil reservoirs in that case a potential phase change is not caused by compositional changes but by the dropping pressure when production is started in a single phase oil reservoir with wells completed in the bottom the pressure will first drop below the bubble point pressure pbp in the top of the reservoir pbp can be computed before any reservoir simulations and phase split computations can be skipped for any grid cell while p pbp even if p pbp is not known only one or a few phase stability tests can be performed at each time step in the top row of grid cells to determine when a two phase grid cell first appears once the top of the domain has dropped below pbp a two phase front propagates downwards for which stability analyses have to be performed however once a grid cell is in two phase phase split guesses from the previous time step are again available to avoid the stability analyses by essentially tracking phase transition fronts caused by either fluid injection or pressure drops the stability tests can generally be avoided in over 95 of the phase split computations as such the phase stability analyses do not add significant computational cost while still improving the robustness of the overall scheme when sufficiently good initial guess for phase split computations are not available a final efficiency gain can be achieved in the computation of phase fractions βα when no initial guess for βα is available from a previous time step a bisection algorithm is typically used in the first iteration of the phase split computation li and firoozabadi 2012a in problems involving water and hydrocarbon phases though βw for the aqueous phase is always close to the overall molar fraction z h 2 o of h2o because the aqueous phase has low solubilities of hydrocarbon species and co2 when no other initial guess is available a value of β w 1 01 z h 2 o with a nr scheme converges in all examples considered in this work 3 numerical experiments the following numerical experiments consider two dimensional meshes with relatively few grid cells such that the phase behavior computations require the majority of the computational cost 90 the applications are chosen to illustrate key features of the phase behavior and cpa algorithms in the context of co2 sequestration stray methane gas leakage and enhanced oil recovery more detailed three dimensional analyses of the former two physical processes are presented elsewhere moortgat et al 2018 soltanian et al 2018 3 1 experimental validation for co2 h2o and c1 h2o mixtures few experimental data are available for the phase behavior of mixtures of multicomponent hydrocarbons self associating water and cross associating co2 or c1 over a range of temperatures pressures and overall compositions of the mixtures fortunately there are ample data in the literature for co2 h2o and c1 h2o mixtures which are important for a wide range of hydrogeology applications notably the study of methane leakage into groundwater resources and co2 storage in aquifers fig 1 compares our cpa eos predictions to nearly 350 experimental data points obtained by several independent experiments in the literature over a wide range of temperatures and pressures for c1 h2o mixtures we match experimental data from 14 to 690 bar and temperatures from 25 to 238 c culberson and mcketta 1951 olds et al 1942 the figure provides both the water evaporation into the methane rich gas phase fig 1a and methane solubility in water fig 1b the following temperature dependent correlations are used for the h2o c1 bic k 12 and cross association factor s 2 in terms of the reduced temperature t c t k 190 k 46 k 12 0 1095 t c 3 0 9462 t c 2 2 9125 t c 2 6407 47 s 2 0 035 t c 3 0 1832 t c 2 0 3429 t c 0 2229 for co2 h2o we match data from 3 to 709 bar and 31 to 204 c the h2o co2 bic k 12 and cross association factor s 2 are correlated with respect to t c t k 304 k as 48 k 12 0 5994 t c 0 5088 49 s 2 0 0529 t c 2 0 0404 t c 0 0693 fig 1c and e show the h2o fraction in the co2 rich gas phase and fig 1d and f the co2 solubility in water the agreement between the cpa eos and experimental data is excellent over the full range of conditions for both c1 and co2 as the cross associating component when the above correlations are used the eos description has no other adjustable parameters and is highly predictive given that the solubility of heavier than methane hydrocarbons in water is extremely low we expect the eos to also perform well for multicomponent mixtures of water co2 or methane and other hydrocarbons additional experimental validation for up to 4 component mixtures is provided in li and firoozabadi 2009 note that the pr eos without self and cross association terms can predict the water compositions in non aqueous phases reasonably well but it significantly underestimates the solubility of co2 and hydrocarbons in the aqueous phase peng and robinson 1980 alternative approaches have been proposed that use different sets of binary interactions coefficients for the aqueous and non aqueous phases firoozabadi et al 1988 michel et al 1989 peng and robinson 1976b søreide and whitson 1992 while this method can be tuned to match experimental data for binary mixtures and is computationally efficient it is purely empirical is inconsistent in the near critical region and has not been thoroughly validated for multicomponent mixtures and in phase stability analyses similarly modifications of the empirical henry s law are successful in match binary data spycher et al 2003 but may be less reliable in guaranteeing local thermodynamic equilibrium for multicomponent mixtures now that we have confidence in the accuracy of the cpa eos we proceed to numerical experiments to assess the efficiency and robustness of the eos in reservoir simulations 3 2 efficiency of cpa reservoir simulation scheme and comparison to pr eos this example demonstrates the effectiveness of the cpa phase split algorithms developed in this work and compares to reservoir simulations with the pr eos problems that involve gas water and oil are often both gravitationally and viscously unstable and small changes in phase properties result in profoundly different flow such complexities are modeled in the next examples but to allow a more straightforward comparison between cpa and pr simulation we first consider a set up that is relatively simple in terms of fluid flow specifically we model a typical quarter five spot pattern for a horizontal 100 m 100 m domain on a fine mesh with 100 100 grid cells gas is injected at a constant rate of 5 pore volume pv per year from one corner and outflow is at a constant pressure of 320 bar from the diagonally opposite corner the uniform permeability porosity and temperature are 1 darcy 20 and 125 c for simplicity we consider quadratic relative permeabilities with unit end points to make phase velocities less sensitive to compositional variations for cpa versus pr we assume constant viscosities of 0 029 cp for gas and 0 22 cp for water three scenarios are simulated in the first pure co2 is injected and the domain is initially saturated with pure h2o without a residual water saturation s r w 0 co2 can displace all the water although the adverse mobility ratio of 7 6 results in an unstable displacement front the second scenario considers the same two component problem but with s r w 40 the third also has s r w 40 but involves a three component system the injection gas is 95 mol co2 and 5 methane c1 and the formation water has 0 15 mol dissolved methane the correlations from the previous example are used to determine the cross association parameter 0 0743 and bic of co2 0 276 in cpa the same bic is used in the pr eos for consistency and a bic of 0 15 is used for c1 in both models both cpa and pr otherwise depend only on critical properties of the pure components and no further tuning is performed with these parameters for co2 h2o mixtures the h2o solubility in the gas phase for a 50 mol 50 mol mixture is similar for cpa 3 38 and pr 3 77 but the solubility of co2 in the aqueous phase is different by an order of magnitude between cpa 2 69 and pr 0 24 fig 2 shows simulation results for all three scenarios after gas injection of 22 pv referred to as 22 pvi in the first case with s r w 0 the displacement is most efficient and the flow is the least sensitive to compositional variations partly because fixed gas and water viscosities are used cpa and pr simulations provide fairly similar predictions as soon as srw 0 though the differences become more pronounced in all cases high water saturations remain behind the gas front because of the adverse mobility ratio but obviously those saturations are highest for s r w 40 behind the displacement front water is saturated with dissolved co2 while the molar fraction of co2 in water is constant for a two component two phase mixture the total amount or volume of dissolved co2 scales with the water saturation when larger volumes of injected co2 dissolve in immobile residual water the gas front propagates slower because pr predicts a lower co2 solubility than cpa with the parameters considered the gas front is significantly more advanced after 22 pvi another observation from fig 2 is that in compositional multiphase flow residual saturations are somewhat meaningless relative permeabilities enforce that water is immobile below s r w 40 however when co2 dissolves in water the aqueous phase volume may swell above s w 40 which remobilizes some of the water more importantly water evaporates into the co2 rich gas phase and is carried away by the gas when multiple local pore volumes e g a grid cell pv of gas flow through a grid cell eventually all the water may evaporate which is indeed what is shown in fig 2 within about a 15 m radius from the injection well these processes are common in compositional gas oil systems as well thermodynamically a two component two phase system is unique because the composition in each phase is independent of phase fractions or saturation in the third scenario we consider co2 h2o and methane c1 for which phase compositions in two phase mixtures depend non linearly on phase amounts the solubility of co2 and c1 in water also depend on each other s compositions such that correlations like henry s law do not apply the same phase viscosities are used such that the displacement fronts for pure co2 and the co2 c1 gas are similar illustrated by the co2 and sg profiles in fig 2 what is interesting about this scenario is the competitive dissolution and exsolution of co2 and c1 when co2 rich gas mixes with c1 enriched water c1 tends to evaporate more while co2 takes its place dissolving in the aqueous phase as a result the residual water is stripped of its initial c1 and saturated with co2 while the gas phase has a bank of very high methane concentrations that is pushed ahead of the injection gas this process has been studied analytically hosseini et al 2012 and was observed directly during the cranfield ms large volume co2 storage pilot test which has nearby ongoing co2 eor operations hosseini et al 2013 soltanian et al 2018 the same process is also common in enhanced oil recovery eor by co2 injection in oil reservoirs moortgat et al 2011 table 1 lists the statistics of the phase split computations with either cpa or pr of a full simulation for the most complicated scenario with co2 c1 and h2o by tracking the displacement front phase stability analyses are only performed around the front and in less than 2 of cases single phase grid cells are mostly identified by neighboring grid cells which avoids a phase stability analysis in 60 70 of cases behind the displacement front initial guesses are available from the previous time step for equilibrium ratios k α i phase fractions βα and also for zα χ a w and χ a c this avoids phase stability analyses in 28 38 of cases and results in faster convergence of the phase split computations when initial guesses are available the phase split computations essentially always converge in only a few steps the failure rate is 10 6 and 10 5 for cpa and pr respectively this is a critical factor in the efficiency of explicit schemes for transport time steps are small but phase split computations per time step are extremely efficient implicit schemes allow larger time steps but this results in poorer initial guesses for the phase split computations as discussed in section 2 5 βα can always be computed with nr using either the value from the previous time step or a guess based on the current overall molar fraction of h2o the latter was only implemented for cpa and the pr simulation required a negligible number of bisection calculations for βα finally when only a few ssi iterations are required it is not worth switching to nr because each nr iteration requires considerably more computational time than a single ssi iteration this is particularly true for cpa which involves more complicated derivatives in the nr jacobian getting to the more important differences between cpa and pr simulations the former required about 40 more ssi iterations in the phase split computations than pr this is not surprising given that both zα and the fugacities are considerably more non linear in cpa than in pr see eqs 2 3 and 22 similarly the few phase stability analyses may require more initial guesses and more iterations in cpa than in pr together this is reflected in table 1 by the fact that cpa required twice as many zα calculations as pr remember that these zα calculations are the main complexity of cpa and generally make reservoir simulation schemes computationally impractical due to their computational cost however the nr scheme proposed in section 2 1 1 always converges even more interesting our nr scheme for the highly non linear zα in cpa required only 2 iterations on average whereas the zα from the cubic pr which has an analytical solution required 4 iterations the cumulative outcome is that the cpa simulations required only 16 more computational time than pr simulations which is quite remarkable given the complexity of the cpa eos and this is the main achievement of this work as a final and important note the main purpose of this example is to demonstrate that the algorithms proposed in this work allow simulations with the accurate cpa eos at a computational efficiency that is comparable to the widely used pr eos we acknowledge that pr can be tuned in different ways to obtain more accurate results than those shown in fig 2 as discussed in the previous example 3 3 co2 sequestration in aquifer with gravity fingering in two phase flow injection of co2 in deep water aquifers is a promising technology to mitigate anthropogenic greenhouse gas emissions when usually supercritical co2 dissolves in water it exhibits interesting and non intuitive phase behavior it increases the aqueous density and swells its volume the former even though the density increases is typically only about one percent make a stratification of co2 rich gas in the top and water below gravitationally unstable this triggers gravitational instabilities or fingering that mix dissolved co2 throughout the aquifer on advective time scales which can be fast for high permeability formations gravity fingering in the context of geological co2 sequestration has been simulated by innumerable authors but most detailed studies only consider the single phase aqueous phase with suitable boundary conditions in a rectangular domain fu et al 2013 moortgat 2016 pau et al 2010 pruess and zhang 2008 riaz et al 2006 soltanian et al 2016b 2017 phase behavior is often approximated by linear correlations of the aqueous phase density in terms of dissolved co2 concentration and henry s law for the solubility spycher et al 2003 in this example we demonstrate the robustness and efficiency of reservoir simulations with the accurate cpa eos for this highly non linear problem we consider a cross section of an aquifer that is 200 m wide and 25 m thick on a fine 632 79 grid i e δ x δ y 32 cm but with an added upward slope and a structural trap as illustrated in fig 3 co2 is injected at 5 pv yr from a perforated vertical well along the left boundary the top and bottom boundaries are considered impermeable and outflow is allowed across the right boundary at a constant pressure temperature pressure relative permeability and porosity are as in the previous example s r w 40 a random perturbation of 7 is added to the permeability to guarantee triggering of the fingering although this is not necessary for the higher order finite element methods used in this work shahraeeni et al 2015 fig 3 shows the interesting features that develop light 578 kg m3 co2 rich gas segregates to the top of the domain and accumulates in the structural trap a non trivial moving interface develops across which co2 dissolution takes place which increases the water density by 0 7 for the high permeability considered 1 darcy gravitational instabilities are triggered early on and after one year we already see pronounced fingers develop because the gas flows from left to right fingers develop first from the left and are therefore larger at any given time than those on the right which were triggered later after three years fingers have already reached the bottom of this relatively thin aquifer the thickness is similar to the cranfield co2 storage aquifer another feature that develops is co2 saturated brine that sinks to the bottom right at the injection well and essentially forms a large finger in the first simulation we simply inject pure co2 into pure water in the second similar to the previous example we consider water that is nearly methane saturated and inject a 95 5 mol mixture of co2 and c1 the fingering dynamics are not affected significantly but interestingly the fingers are actually depleted in methane as compared to the initial aqueous phase similar to the discussion in the previous example as discussed in the previous example the standard pr eos peng and robinson 1980 significantly underpredicts the co2 dissolution in water and thus the associated local density increase simulations of this problem with the pr eos without using different bic for the aqueous and gaseous phases do not show any gravitational fingering when cpa eos is used but without accounting for the cross association between h2o and co2 the co2 and c1 solubility is also reduced to 0 07 mol fingers still develops but later and to a lower extent fig 3 this demonstrates the importance of considering cross association when modeling problems that are sensitive to the compositions in the aqueous phase such as gravitational instabilities the statistics of the phase split computations with cpa are similar to the previous example less than 2 stability analyses were required 99 9999 of flash computations converged with an initial guess from the previous time step and these computations required on average six ssi iterations all zα computations converged with a nr method in two iterations on average the total cpu time was 424 mins 3 4 groundwater contamination risk from methane well leakage when natural gas is produced from deep formations such as black shales or coal bed seams there is a risk that a well or its casing may become compromised at some depth this would cause a source of methane leakage and due to the high pressures typically involved the leakage rate can be high methane is considerably lighter than water and is therefore expected to buoyantly rise towards the surface potentially contaminating groundwater on the way because of this strong buoyancy surface and groundwater tests of methane leakages are usually only required and performed in a relatively small radius around producing wells however several field studies suggest that methane may travel much farther from a leaky well in the subsurface darrah et al 2014 jackson et al 2013 vengosh et al 2014 a detailed study of methane leakage into groundwater is beyond the scope of this work a more thorough analysis was recently presented in moortgat et al 2018 but in this example we show how consistent with recent experimental observations cahill et al 2017 realistic subsurface heterogeneity indeed causes significant lateral spreading to this end we consider the highly detailed history matched static model of the fluvial depositional features in the cranfield formation which has a highly channelized permeability field hosseini et al 2013 we extract a two dimensional vertical cross section with the same dimensions as in the previous example but with fewer grid cells in the horizontal direction 79 128 to be consistent with the static model in hosseini et al 2013 and soltanian et al 2016a the formation description has eight operational facies with permeabilities that range from tight shale like structures of 0 08 md to sandstone type facies with high permeabilities of 500 md we assume that on the left boundary there is a well that is producing methane from some deeper target but that is leaking into our domain at a rate of 5 pv yr or 30 m2 per day at surface conditions leakage is only into the more permeable layers and not into the shale features as indicated by the ellipses in fig 4 which also illustrates the permeability field initially the domain is saturated with water and methane is the cross associating component in this example for simplicity all other parameters are the same as in the previous example the layering of the fluvial deposits results in a very low effective vertical permeability as a result vertical buoyant flow is strongly suppressed it takes more than a year for methane to reach the top of this 25 m thick domain and it only does so over 100 m away from the leaky well at low concentrations fig 4 even after three years most of the methane exits the domain laterally through the right boundary which is 200 m away from the leak under such conditions methane may appear in groundwater and at the surface far away from its initial deep subsurface source the statistics of the cpa phase split computations are comparable to those in the previous two examples but with even higher efficiency the average number of ssi iterations for this simulation was only 3 and no bisection methods were used for zα and βα the total cpu time was 25 min 3 5 enhanced oil recovery by co2 injection after water flooding in this final example we consider double displacement of a 6 component oil i e first by water flooding and then by co2 injection both at 5 pv yr relative permeabilities are as in the previous examples but we consider 60 and 0 residual oil saturations to water and gas respectively in other words water flooding leaves 60 of the oil behind and co2 is injected to recover this residual oil we simulate seven years of water flooding 35 pvi followed by six years of co2 injection a total of 65 pvi in 13 years the domain dimensions are as in the previous examples but on a mesh with 200 50 grid cells the oil pseudo components and their critical properties are from the supplemental information in amooie et al 2017 but the initial composition is 5 54 15 7 9 and 10 for co2 and the 5 hydrocarbon species with a residue of c 11 the temperature and initial pressure at the bottom are 127 c and 483 bar at this condition the viscosities of the initial oil water and injected pure co2 are 0 17 cp 0 22 cp and 0 06 cp and the phase densities not tuned to data are 574 kg m3 962 kg m3 and 683 kg m3 this already suggests interesting potential flow behavior water flooding should be viscously stable while co2 injection may be prone to viscous instabilities additionally because the supercritical co2 is denser than the initial oil in place but lighter than water injection from the top should also be gravitationally unstable the purpose of this example is not to devise the optimal oil recovery strategy i e co2 injection from the bottom but rather to construct the most complicated flow and phase behavior conditions to stress test the robustness of the cpa phase behavior calculations we therefore inject co2 from the top such that the front is both viscously and gravitationally unstable by assuming a high permeability of 500 md with porosity again 20 fingering will be more pronounced fig 5 first shows the water saturations after two and seven years due to the relatively high permeability water is gravitationally segregated in the bottom of the domain which results in an effective sweep note that the oil saturation 1 s w near the injection well drops below its residual value due to species exchange with the aqueous phase which could not be modeled with our earlier simplified cpa model moortgat et al 2012 during co2 injection we see very complex flow patterns as expected overall co2 c1 and c 11 compositions are shown after 13 years six years of co2 injection dense co2 segregates below the lighter oil but is subsequently stably stratified on top of the even denser water because no residual water saturations were considered both oil and water are displaced towards the producer methane again forms a bank that is pushed ahead of the highest co2 concentrations at the same time species exchange of methane from the oil with co2 results in co2 c1 mixtures that are lighter than the supercritical co2 this triggers buoyantly rising plumes upwards gravitational fingering that are clearly visible in both the co2 and c1 compositions in the bottom left the immobile remaining oil is depleted of methane because it dissolved into the aqueous phase during water flooding and was subsequently transported away the cpa phase behavior computations were as efficient and robust in this h2o plus 6 component co2 oil mixture as in the previous examples the average number of ssi iterations was five and the fraction of stability 2 and phase split calculations with initial guesses 64 and their failure rate 10 5 were essentially the same the nr solution for zα did fail a few times but at a negligible fraction of 10 7 in which cases the bisection method found the correct solution due to the higher cost of three phase split calculations the total cpu time was 512 min this example demonstrates that the methods presented in this work are not only accurate and fast but also robust i e do not result in diverging phase split results for typical multicomponent multiphase petroleum engineering applications 4 conclusions the cubic plus association cpa equation of state with additional terms that describe cross association has been demonstrated to accurately predict the phase behavior of mixtures that contain polar molecules like water and asphaltenes and cross associating molecules like co2 methane h2s and hydrocarbons moreover the cpa eos has a strong foundation in thermodynamics however the expressions for the compressibility factor z in terms of which the eos is formulated are considerably more non linear than the cubic eos that are commonly used in reservoir simulations three non linearly dependent equations are required for z χ a w χ a c and even the number of roots can not be determined a priori in prior work moortgat et al 2012 we proposed a simplified cpa phase behavior package which only considered the dissolution of a cross associating co2 component into the aqueous phase but which did not allow for the solubility of any hydrocarbon species nor the evaporation or dissolution of h2o in hydrocarbon phases gas and oil this is a computationally efficient approach that is sufficient for many applications e g the modeling of geological co2 sequestration when only co2 and h2o species are considered or various enhanced oil and gas recovery scenarios in which dissolution into the aqueous phase can be neglected in this work we implement a fully compositional three phase phase behavior model in which all species can transfer between all phases taking into account their potential self and cross associating behavior the excessive computational cost that is involved in stand alone phase behavior packages is resolved by a number of efficient algorithms in reservoir simulations billions of phase split computations have to be performed but the advantage is that more prior information is available clever use of spatial from neighboring grid cells and temporal from previous time steps information allows one to avoid most of the demanding computations and also speeds up the remaining iterative schemes in addition by carefully studying phase envelopes and their associated phase properties such as compressibility factors zα allow the parameterization of good initial guesses when insufficient temporal or spatial context is available together the solutions presented in this work allow the use of quadratically converging newton raphson schemes for all the non linear equations involved in the cpa computations and avoid the expensive multidimensional bisection methods used in earlier stand alone cpa implementations the result is a three phase multicomponent reservoir simulator based on the cpa eos which is as fast as one based on a cubic eos such as pr despite the considerably higher degree of non linearity in cpa five numerical experiments demonstrate the powerful features of this approach the first example shows the excellent match of cpa predictions with several hundred laboratory data points for the mutual solubilities of water with co2 and c1 over a wide range of temperatures and pressures from 3 to 709 bar and from 25 to 238 c the second example considers several examples of co2 and c1 injection into aquifers provides the statistics of the cpa eos calculations and demonstrates that we achieve almost the same computational efficiency within 16 as with a much simpler pr eos simulator the third and fourth examples illustrate the robustness of the proposed schemes by simulating challenging problems involving gravitational instabilities during carbon sequestration and methane leakage through a highly heterogeneous fluvial formation finally we considered a multicomponent double displacement problem in which is oil is first recovered by a traditional water flood from the bottom followed by enhanced oil recovery by co2 injection from the top the suite of these examples validate the accuracy computational efficiency and robustness of our schemes for the range of applications for which they are intended these algorithms should facilitate the more wide spread adoptions of cpa in reservoir simulators that intend to model both hydrocarbon and aqueous phases acknowledgements we greatly appreciate the helpful suggestions by zhidong li in implementing the cpa eos in the context of a reservoir simulator 
841,this work presents an efficient reservoir simulation framework for multicomponent multiphase compressible flow based on the cubic plus association cpa equation of state eos cpa is an accurate eos for mixtures that contain non polar hydrocarbons self associating polar water and cross associating molecules like methane ethane unsaturated hydrocarbons co2 and h2s while cpa is accurate its mathematical formulation is highly non linear resulting in excessive computational costs that have made the eos unfeasible for large scale reservoir simulations this work presents algorithms that overcome these bottlenecks and achieve an efficiency comparable to the much simpler cubic eos approach the main applications that require such accurate phase behavior modeling are 1 the study of methane leakage from high pressure production wells and its potential impact on groundwater resources 2 modeling of geological co2 sequestration in brine aquifers when one is interested in more than the co2 and h2o components e g methane other light hydrocarbons and various tracers and 3 enhanced oil recovery by co2 injection in reservoirs that have previously been waterflooded or contain connate water we present numerical examples of all those scenarios extensive validation of the cpa eos with experimental data and analyses of the efficiency of our proposed numerical schemes the accuracy efficiency and robustness of the presented phase split computations pave the way to more widespread adoption of cpa in reservoir simulators keywords cubic plus association equation of state carbon sequestration methane leakage co2 enhanced oil recovery gravitational fingering phase behavior 1 introduction a broad range of subsurface processes involve an aqueous phase e g formation brine disposed waste water or injected water in hydrocarbon recovery and one or more non aqueous phases lnapl dnapl hydrocarbon gas or oil injected carbon dioxide or nitrogen etc in many applications the aqueous phase can be approximated as incompressible and immiscible for example in the production from hydrocarbon reservoirs that involve formation brine or injected water as a displacement fluid as well as oil and gas either injected or already in place the mass transfer between oil and gas phases and the compressibility of gas are generally far more important than compressibility or compositional effects of the aqueous phase in such applications the properties of water or brine can be described by simple correlations and compositional effects are only considered for the non aqueous phases in other applications though the phase behavior of the aqueous phase is critical perhaps the most notable example is carbon dioxide co2 sequestration in deep saline aquifers if co2 is to be injected without production of brine ideally at high rates and if the aquifer is confined then the storage capacity is largely determined by the compressibility of brine and the porous media itself two other compositional effects are equally important first the dissolution of co2 into brine reduces the pressure build up from injection and improves the storage permanence of sequestered co2 solubility trapping this is because dissolved co2 is less prone than gas to leak through weak spots in the cap rock such as abandoned wells faults or natural and induced fractures second co2 dissolution leads to volume swelling of the aqueous phase which also affects the pressure response on longer time scales chemical reactions within the aqueous phase are also important and are sensitive to brine compositions the aforementioned processes are well known but numerical simulations of co2 sequestration often rely on simplified assumptions such as incompressible water linear relations for the brine density as a function of solute co2 composition and empirical correlations like henry s law for the co2 dissolution in water these limiting assumptions are reasonable when only two components e g h2o and co2 are considered and when such correlations are fitted to experimental data for the same temperature and pressure ranges as in an aquifer however for problems that involve more than two components the phase behavior becomes considerably more non linear and the above assumptions are violated both injected co2 and the initial formation often also contain hydrocarbons as an example in the large volume co2 sequestration pilot project near cranfield mississippi hovorka et al 2013 the injected gas was reported to contain between 2 and 5 of methane c1 and the aquifer brine was nearly saturated with c1 under such conditions solubility trapping of co2 becomes competitive with c1 hosseini et al 2013 2012 first methane exsolves and forms a bank around the displacement front behind which co2 can further dissolve and ultimately saturate the brine the methane enriched gas bank has very different properties than the initial supercritical co2 fluid already in this simple example of two phases co2 rich gas and aqueous and three components h2o co2 c1 correlations like henry s law break down because the solubility of co2 in water for instance also depends on the concentration of c1 more broadly these types of applications may also consider other resident hydrocarbon species as well as natural e g noble gasses darrah et al 2014 and introduced tracer species to accurately model the fractionation of multiple species across phases as well as the associated non linear changes in phase properties one has to adopt an equation of state eos and strictly enforce local thermodynamic equilibrium several eos have been proposed to model mixtures of water hydrocarbons and other components like co2 and nitrogen firoozabadi et al 1988 considered both the schmidt wenzel eos schmidt and wenzel 1980 and the peng robinson eos peng and robinson 1976a but with different binary interaction coefficients bic between water and dissolved components in the aqueous phase which are temperature dependent and in a gas phase constant bic the widely used saft chapman et al 1989 family of eos also accounts for association behavior and other approaches have been presented by e g economou and tsonopoulos 1997 kontogeorgis and folas 2010 the cubic plus association cpa eos li and firoozabadi 2009 has been shown to accurately describe the phase behavior of multiphase mixtures containing hydrocarbons and self associating polar molecules like water li and firoozabadi 2009 or asphaltenes li and firoozabadi 2010a 2010b nasrabadi et al 2016 this eos was further improved by treating methane ethane unsaturated hydrocarbons co2 and h2s as pseudo associating components self association is due to direct hydrogen bonding between h2o molecules cross association between water and co2 and h2s molecules is caused by the latter s permanent polar moments while cross association with hydrocarbons is caused by a temporary polar moment induced by the presence of h2o molecules the inclusion of cross association through perturbation theory considerably improves predictions for the non aqueous phase at high pressures two advantages over other eos like saft are that 1 cpa has very few adjustable parameters and 2 in the absence of polar molecules like water cpa reduces to the well known accurate and computationally efficient cubic peng robinson eos in the original cpa eos kontogeorgis et al 1996 the physical interactions were modeled by the cubic soave redlich kwong srk eos soave 1972 the main concepts of phase split calculations with the cpa eos are described in li and firoozabadi 2009 and firoozabadi 2016 however those works consider a stand alone implementation of the cpa eos in which computational efficiency was not the main focus the cpa eos is highly non linear and a naive implementation in a full fledged reservoir simulator results in as much as a three orders of magnitude increase in computational cost over the pr eos the objective of this work is therefore to develop and analyze numerical algorithms for cpa of comparable efficiency to simulators based on a cubic eos in an earlier attempt to adopt cpa for efficient three phase flow simulations moortgat et al 2012 we only allowed co2 to dissolve into water and neglected both evaporation of water and all interphase mass exchange of hydrocarbon species with the aqueous phase this approach improved simulations of e g pure co2 sequestration but could not capture complexities related to the presence of methane tracers or other components in this work we relax these limiting assumptions and allow all species to transfer between all three phases the thermodynamic framework is developed in section 2 and its performance is presented in terms of accuracy and efficiency in section 3 2 phase behavior of water gas oil mixtures with cpa eos phase behavior with cpa is implemented in an isothermal compressible multicomponent multiphase flow simulator that uses higher order finite element methods for both flow and transport moortgat and firoozabadi 2016 moortgat et al 2012 2011 specifically flow and transport are decoupled by a standard implicit pressure explicit composition impec scheme that uses a fractional flow formulation for total fluxes and has overall compositions as the primary variable in the transport update phase stability and phase split computations are performed after pressures fluxes and overall compositions have been updated the algorithms presented in this work can be coupled to other flow and transport schemes that use finite difference volume or element methods 2 1 compressibility factor of the cpa eos all thermodynamic functions of a fluid can be derived from an eos the eos for hydrocarbon gas α g and oil α o and aqueous α w phases can be written in the deceptively simple form of 1 p α v α z α n α r t or p α z α c α r t α g o w with the temperature t universal gas constant r and for each phase α the pressure pα volume vα number of moles nα or molar density cα all the complexities of non ideal phase behavior are captured in the compressibility factor zα which for the cpa eos can be expressed as li and firoozabadi 2009 2 z α z α z α b α a α z α z α 2 2 b α z α b α 2 3 1 b α b α 8 z α 3 b α b α 4 z α i 1 n c x α i j 1 2 η ij χ α ij 1 the first line eq 2 is the peng robinson eos which is widely used in petroleum engineering to describe the phase behavior of non associating hydrocarbon fluids the non ideal behavior in pr eos stems from the temperature dependent physical van der waals interactions between molecules represented by aα and the temperature independent finite volume occupied by molecules represented by bα which cannot be neglected at typical reservoir pressures aα and bα are derived from the ai and bi for pure components and the binary interaction coefficients bic kij through van der waals mixing rules firoozabadi 2016 4 a i j 1 k i j a i a j 5 a α i 1 n c j 1 n c x α i x α j a i j 6 b α i 1 n c x α i b i eq 3 describes the associating behavior related to hydrogen bonding in mixtures that contain both polar molecules that self associate and pseudo associating molecules that cross associate with water but not with each other only one species is assumed to self associate which in this work is water but can also represent a heavy asphaltene pseudocomponent li and firoozabadi 2010a 2010b association is between opposite pairs of hydrogen bond donor sites j 1 and hydrogen bond acceptor sites j 2 we consider mixtures of nc pseudo components labeled by the index i in which each phase α has a phase molar composition of x α i the number of donor or acceptor sites j of each species i is denoted by ηij with η i j 0 for all non association species i while the fraction of sites j on species i in phase α that are free i e not occupied by hydrogen bonds are given by χ α ij the expressions for χ α ij are complex in the most general case but can be simplified by two assumptions that have been proven to be highly accurate when water and not e g asphaltenes is the self associating component li and firoozabadi 2009 these assumptions are that each self or cross associating molecule i has two donor and two acceptor sites η i 1 η i 2 2 and that the bonding between donor and acceptor sites is symmetric such that χ α i χ α i 1 χ α i 2 with those assumptions the site fractions can be computed from 7 χ α w z α z α 2 i 1 n c x α i χ α i δ α w i 8 χ α i z α z α 2 x α w χ α w δ α w i in which δ α w i represents the self and cross association strengths respectively 9 δ α w w 8 z α 2 b α 8 z α b α 4 z α 3 κ p α rt exp ϵ k b t 1 10 δ α w i s i δ α w w i w in which si is a cross association parameter between water and species i and ϵ and κ are energy and volume parameters respectively of the self association of water given by 11 ϵ k b 1738 4 k 12 κ 1 8015 10 3 l mole with kb the boltzmann constant eq 2 without the association terms in eq 3 is a cubic equation for z which can be solved analytically the physical solution can be determined by the sign and the condition that z b because b represents the tightest possible packing state of the molecules 2 1 1 fast solution scheme for compressibility factors from cpa eos finding the roots of eqs 2 and 3 accounts for the main complexity and associated numerical cost of phase behavior computations with the cpa eos eqs 2 and 3 are coupled non linearly to eqs 7 and 8 and eqs 9 and 10 the fractions χ α w and χ α i each depend on each other as well as on zα and cannot be simplified e g by a separation of variables even the number of roots cannot be determined a priori this means that the set of eqs 2 8 has to be solved together by an iterative numerical scheme li and firoozabadi 2009 developed a multidimensional bisection method which can be applied over a broad range for zα e g bα zα 5 and is guaranteed to find all the roots when multiple roots are found we select the one that corresponds to the minimum gibbs free energy while robust this approach is extremely computationally inefficient the objective therefore is to develop a numerical scheme with an efficiency comparable to a simpler cubic eos we make one further assumption and only consider one cross associating component labeled by i c e g co2 for carbon sequestration in saline aquifers c1 for methane leakage into groundwater or h2s complications in waterflooding hydrocarbon reservoirs under these assumptions and with χ α i 1 for all i w and i c we solve 13 g 1 z α z α z α b α a α z α z α 2 2 b α z α b α 2 2 1 b α b α 8 z α 3 b α b α 4 z α x α w χ α w 1 x α c χ α c 1 0 14 g 2 χ α w z α z α 2 x α w χ α w δ α w w 2 x α c χ α c δ α w c 0 15 g 3 χ α c z α z α 2 x α w χ α w δ α w c 0 an obvious choice is the quadratically converging newton raphson nr method define the vectors z z α χ α w χ α c and g g 1 g 2 g 3 and the jacobian 16 j g 1 z α g 1 χ α w g 1 χ α c g 2 z α g 2 χ α w g 2 χ α c g 3 z α g 3 χ α w g 3 χ α c given an initial guess z m z for m 0 we can iteratively improve our solution as 17 z m 1 z m j z m 1 g z m until j 1 g is smaller than a tolerance which we set to 10 10 this approach is more efficient than the scheme in moortgat et al 2012 and nasrabadi et al 2016 in which nr was only applied to zα while χ α w and χ α c were updated for each iteration of zα through linearly converging but easier to implement successive substitution iterations ssi the nr method is well established but its efficiency and robustness depend critically on whether a good initial guess z is available neither the range of z nor the number of roots can be rigorously established a priori and a nr scheme can either diverge or converge to an unphysical solution a combination of a few bisection steps followed by the faster converging nr method is also not desirable a large number of multidimensional bisection cuts may be necessary to guarantee selection of the true range of zα χ α w and χ α c within which the physical solution lies in moortgat et al 2012 we only allowed co2 dissolution in water and no evaporation or dissolution of water into gas or oil phases under those conditions zα is close to that of pure water which is close to bα but this is not true for a gaseous or oleic phase that contains water in nasrabadi et al 2016 the self associating asphaltene molecules were negligible in the gas phase a pr eos initial guess for zα was effective in combination with a finite difference approximation of the derivatives in eq 16 for water containing mixtures though the molar fraction of water in the gas phase can be high and zα from the pr eos is not a good initial guess for the compressibility factor we propose two solutions the first is an obvious benefit of reservoir simulations for each grid cell that contained water at a previous time step we store the values of all z α and use those as an initial guess for the next time step this is the best initial guess because we consider an explicit forward euler time step update with a cfl condition on the time step coats 2003 courant et al 1928 which implies that compositions and pressures do not change dramatically within one time step with these initial guesses eq 17 almost always 99 converges in only a few time steps as verified in the numerical experiments if the aforementioned initial guesses are not available or in the rare cases that nr diverges we could fall back to the bisection method initial guesses are also not available in phase stability analyses which essentially evaluate changes in gibbs free energy for certain test compositions that are very different from the actual compositions in the reservoir as discussed in section 2 5 most stability analyses can be avoided by clever use of information from the previous time step nevertheless relying on the bisection method to compute zα even in the relatively few cases described above still results in an inefficient scheme for those cases it is worth correlating a number of flash computations of zα for mixtures of the initial fluid in place with the injection fluid and for a range of pressures the goal is to provide an initial guess for phase compressibility factors and χ α w and χ α c but without a phase identification because this is not known during phase stability and phase split iterations for mixtures in which co2 or c1 are the cross associating components nr nearly always succeeds by trying the following initial guesses until a converged solution is found 1 z α 1 2281 b α 0 0017 χ α w min 1 0 143 log x α w 0 1358 and χ α c 0 2232 x α w 0 9918 2 z α 0 1245 x α w 0 1505 with χ α w and χ α c as before 3 if x α w 0 5 then we use z α 1 2281 b α 0 0017 χ α w 0 1225 and χ α c 0 775 if x α w 0 5 we use z α 1 3841 b α 0 061 χ α w 0 1318 b α 2 0 1397 b α 0 8946 and χ α c 0 999 trying multiple different initial guesses for the nr scheme is still considerably faster than a single bisection loop other correlations for z could be added as well we find that with this approach the bisection method can often be avoided altogether in favor of the fast nr scheme if for any condition the nr scheme does not converge bisection can still be used to guarantee robustness of the phase behavior computations note also that in the iterative phase stability and phase split algorithms only the first iteration requires an initial guess subsequent iterations use z values from the previous iteration as initial guesses as a final improvement in efficiency note that the jacobian in eq 16 is a 3 3 matrix this matrix can be readily inverted and the derivatives in j 1 can be computed analytically and implemented explicitly rather than performing the matrix inversion in each nr iteration in reservoir simulations initial guesses from the previous time step are available in most cases and the nr method converges in two or three iterations around a displacement front when values from the previous time step are not available the correlated initial guesses can be used and nr may require a few more iterations 5 for a full simulation our algorithm to compute the cpa compressibility factors achieves comparable computational efficiency as a much simpler cubic eos see numerical experiments 2 2 phase split computations local thermodynamic equilibrium is satisfied when the chemical potential or equivalently the fugacity f α i of each component i is the same in all the phases that are in equilibrium 18 f g i f o i f w i i 1 n c which can also be expressed in terms of fugacity coefficients φ α i f α i x α i p as 19 φ g i x g i φ o i x o i φ w i x w i i 1 n c or in terms of the logarithm of equilibrium ratios k g i x g i x w i and k o i x o i x w i 20 g g i ln k g i ln φ w i ln φ g i 0 i 1 n c 21 g o i ln k o i ln φ w i ln φ o i 0 i 1 n c the last formulation is more robust than one in terms of the ki themselves which can vary over 20 orders of magnitude the notation g α i will be used in a nr solution method below the fugacity coefficients of the cpa eos are given by 22 ln φ α i ln z α b α b i b α b α z α b α a α z α z α 2 2 b α z α b α 2 a α 2 2 b α 2 j 1 n c x α j a ij a α b i b α ln z α 1 2 b α z α 1 2 b α 4 ln χ α i 4 b i 10 z α b α z α b α 8 z α b α 4 z α x α w χ α w 1 x α c χ α c 1 i 1 n c we denote the molar fraction of each phase by βα and overall molar fractions of component i by zi the phase fractions and compositions satisfy the constraints 23 i 1 n c z i i 1 n c x g i i 1 n c x o i i 1 n c x w i α β α 1 24 z i α β α x α i i 1 n c which can be expressed in our chosen 2 n c 1 primal thermodynamic variables k g i k o i βg and βo in the following two rachford rice rr equations 25 r r g i 1 n c z i k g i 1 1 β g k g i 1 β o k o i 1 0 26 r r o i 1 n c z i k o i 1 1 β g k g i 1 β o k o i 1 0 together with eqs 20 and 21 this form a closed system of 2 n c 1 equations once k g i k o i βg and βo and β w 1 β g β o are known the phase compositions follow from 27 x g i k g i x w i i 1 n c 28 x o i k o i x w i i 1 n c 29 x w i z i 1 β g k g i 1 β o k o i 1 i 1 n c the above formulation is for a three phase flash if one phase is absent only one of the relations eqs 20 and 21 and one of eqs 25 and 26 is solved with β α 0 for the absent phase if the aqueous phase is absent one of the other two phases is chosen as the reference in fact phase identification is only done after the phase split is completed and is based on both the molecular weight and the molar fraction of the heaviest component in each phase for the mixtures considered in this work in practice the aqueous phase is only absent when there is no water component in that case we switch to the simpler pr eos flash 2 3 efficient solution scheme for two and three phase flash with cpa eos phase split computations are based on the so called p t flash meaning that for a fixed pressure temperature and overall composition zi we compute phase compositions x α i and phase molar fractions βα alternative v t flash formulations in terms of a fixed volume and temperature have been developed as well mikyška and firoozabadi 2011 because the phase split relations are highly non linear iterative solution methods have to be used the efficiency and robustness of these methods rely critically on good initial guesses in this case for βα and k α i the most successful guesses are again from the previous time step alternative choices are discussed below when initial guesses for both βα and k α i are available the first step in the phase split computation is to solve the rr equations by the nr method with fixed k α i the required derivatives of eqs 25 and 26 are straightforward if no βα are provided the rr equations are solved by a two dimensional bisection method haugen et al 2011 li and firoozabadi 2012b the bisection method is robust and always converges for βα but it is very slow and should be avoided when possible see section 2 5 2 3 1 successive substitution iterations ssi the most straightforward phase split algorithm for the three phase flash with cpa eos uses ssi in the following loop see also firoozabadi 2016 1 solve rr equations with either nr or bisection method for all but the first iteration nr is used with the βα from the previous iteration as initial guess 2 for each phase compute aα bα and j 1 n c x α j a i j in eq 22 aij and bi are not phase or composition dependent and are not updated inside the ssi loop 3 for each phase compute zα in the first iteration the guesses for zα χ α w and χ α c discussed in section 2 1 1 are used subsequent iterations use values from the previous iteration as a guess for the simultaneous nr update of zα χ α w and χ α c 4 with the updated aα bα j 1 n c x α j a i j zα χ α w and χ α c compute the logarithm of fugacity coefficients from eq 22 and ln k α i from eqs 20 and 21 5 compute error it is important to check convergence of both ln k α i and βα to a tolerance which we set to ϵ err 10 10 we found that even small errors in βα can result in negative total compressibilities which in turn cause artificial pressure oscillations if the iterations have converged exit the loop otherwise return to step 1 the ssi method is robust and generally converges even for poor initial guesses but the convergence rate is linear and may require many iterations particularly near critical points several acceleration schemes have been proposed but li and firoozabadi 2012a and moortgat et al 2012 found that such acceleration may come at the cost of robustness in this work we do consider the simple geometric aitken δ 2 scheme which takes advantage of the fact that k α i n 1 k α i n becomes nearly constant after a few iterations when it does subsequent iterations can be accelerated by following every three ssi iterations with n 1 2 3 by one iteration of the form 30 ln k α i 4 ln k α i 3 ln k α i 3 ln k α i 2 2 ln k α i 3 2 ln k α i 2 ln k α i 1 for problems far from the critical point when only of the order of 10 ssi iterations are required on average the aitken δ 2 acceleration is not effective but when 20 or more iterations are required the scheme can reduce the iterations by 25 40 2 3 2 newton raphson nr to achieve quadratic convergence a nr scheme can be used we define the 2 n c 1 length vectors g g g i g o i r r g r r o from eqs 20 21 and 25 and 26 and the solution vector x ln k g i ln k g o β g β o starting from an initial guess for x the solution is refined in iterations m by 31 x m 1 x m j x m 1 g x m but now with the 2 n c 1 2 n c 1 jacobian 32 j g g i ln k g j g g i ln k o j g g i β g g g i β o g o i ln k g j g o i ln k o j g o i β g g o i β o r r g ln k g j r r g ln k o j r r g β g r r g β o r r o ln k g j r r o ln k o j r r o β g r r o β o for the two phase case say aqueous and gas we have g g g i r r g x ln k g i β g and a n c 1 n c 1 jacobian 33 j g g i ln k g j g g i β g r r g ln k g j r r g β g we only present the derivatives in eq 33 because the expressions in eq 32 are similar the biggest nc nc block is given by with δ i j 1 for i j and δ i j 0 for i j 34 g g i ln k g j δ i j ln φ w i x w j x w j ln k g j ln φ g i x g j x g j ln k g j i 1 n c j 1 n c 1 g g i ln k g n c 1 i 1 n c 35 x w j ln k g j z j β g k g j 1 β g k g j 1 2 j 1 n c 1 36 x g j ln k g j k g j x w j ln k g j x g j j 1 n c 1 the derivatives of eq 20 with respect to the phase molar fraction are given by 37 g g i β g j 1 n c 1 ln φ g i x g j x g j β g ln φ w i x w j x w j β g i 1 n c 38 x w j β g x w j ln k g j k g j 1 β g k g j j 1 n c 1 39 x g j β g k g j x w j β g j 1 n c 1 the derivatives of the rr relations are more straightforward 40 r r g ln k g j z j k g j 1 β g k g j 1 2 41 r r g β g j 1 n c z j k g j 1 2 1 β g k g j 1 2 the terms ln φ α i x α j are quite complicated for the cpa eos the derivation is similar to the one provided in the appendices of nasrabadi et al 2016 for asphaltene containing mixtures except for the different number of association sites in each model ηij in eq 3 the full nr phase split loop is similar to the one presented for ssi 1 compute aα bα and j 1 n c x α j a i j for each phase 2 compute zα χ α w and χ α c for each phase 3 compute ln φ α i and ln φ α i x α j for each phase 4 construct matrix eqs 32 or 33 phase state determined by stability analyses 5 solve eq 31 for ln k α i and βα using a gaussian elimination scheme 6 either return to step 1 or exit when results have converged to errors ϵ err 10 10 phase fractions and compositions are finally derived from eqs 27 29 2 3 3 adaptive combined ssi nr scheme one may be tempted to use the fast converging nr scheme directly e g when good initial guesses from the previous time step are available however experimentation shows that this approach often diverges or requires too many costly nr iterations a more efficient approach is to first perform a number of ssi iterations to improve the initial guess before switching to nr which will then converge in only a few iterations ssi iterations continue until a switch criterion for the error ϵ err ϵ switch is reached followed by nr iterations until ϵ err 10 10 in some cases nr will still diverge when that occurs ssi iterations are continued from the saved state before switching to nr conversely if the initial guess is very good only a single ssi iteration may be required before switching to nr we propose an efficient approach that adaptively sets the switching criterion the average number of ssi and nr iterations n ssi and n nr respectively for the computational domain is saved at every time step and after every nt time steps the efficiency is evaluated if n ssi is small e g n ssi 3 and n nr 2 ϵswitch is reduced by 20 if n ssi is large and n nr is still reasonable e g 4 ϵswitch is increased by 20 to keep the scheme robust ϵswitch has a maximum of 10 3 we allow ϵswitch to reduce to 10 10 which means that only ssi is used each nr iteration is considerably more computationally expensive than a single ssi iteration for n ssi 10 it is often more efficient to simply use ssi see numerical experiments 2 3 4 initial guesses when k α i and βα values are available from a previous time step a phase split computation is attempted directly without a phase stability analysis with such guesses the ssi nr scheme in section 2 3 3 nearly always converges with only a few iterations if a three phase initial guess two sets of k α i and βα was available the phase split is complete if the ssi nr scheme converges with a two phase guess from the previous time step we test the phase stability of the two phase solution if it is unstable we perform the three phase split but still avoid one stability analysis and save computational time on the initial two phase split if no initial guesses are available from a previous time step a stability analysis may need to be performed first more on this in section 2 5 the converged equilibrium ratios from this analysis k i stab 1 ph are usually the best initial guess for the subsequent two phase split if this guess fails the wilson correlation k i w wilson 1969 and its inverse are attempted successively one of these guesses always converges after the first stability analysis the two phase split is performed with k i 2 ph as its output the stability of this state is tested and when the system is unstable and forms a three phase mixture the stability analysis also provides k i stab 2 ph many initial guesses can be tried for the three phase split computation two sets of k α i values are needed which are labeled as k 1 i and k 2 i without phase identification the guesses for k 1 i are given in the following order until the ssi nr phase split converges 1 k i 2 ph and k i 2 ph 1 2 k i stab 1 ph and k i stab 1 ph 1 3 k i w and k i w 1 4 k i w 1 3 and k i w 1 3 5 k i stab 2 ph and k i stab 2 ph 1 and for k 2 i as 1 k i stab 2 ph and k i stab 2 ph 1 2 k i 2 ph and k i 2 ph 1 3 k i stab 1 ph and k i stab 1 ph 1 4 k i w and k i w 1 5 k i w 1 3 and k i w 1 3 the first guess appears to be sufficient in most cases no cases were found in which none of this set of guesses was good enough to obtain a converged three phase flash result 2 4 derived fluid properties in reservoir simulator unlike stand alone phase behavior software a reservoir simulator that solves the three phase flow and transport equations requires several more derived fluid phase properties the molecular weight wα molar cα and mass ρα densities and molar volumes vα follow from 42 w α i 1 n c x α i w i 43 c α p z α rt i 1 n c x α i s i 44 ρ α w α c α 45 v α β α c α α β α c α 1 where wi and si are respectively the molecular weights and the volume translation parameters of the pure pseudo components the cpa eos inherits the property of the pr eos that it can accurately predict the phase stability and phase split behavior compositions and phase fractions but that an empirical correction si may be required to obtain accurate densities si is obtained from matching experimental data viscosities μα for hydrocarbon phases are determined by a corresponding states model christensen and pedersen 2006 for the aqueous phase we currently adopt a correlation that only depends on temperature moortgat et al 2012 the most computationally expensive fluid property calculations in addition to the phase split itself are the total compressibilities and partial molar volumes of the mixture the expressions can be obtained from appendices a d in nasrabadi et al 2016 by adjusting the number of association sites from those for asphaltenes to those for water as the self associating component the computation of these properties involves n c 1 matrix inversions for matrices of dimension nc nc for say a 10 component mixture this may require as much computational cost as the phase split itself these computations are also considerably more expensive than in our prior cpa simulator moortgat et al 2012 in which water was neglected in the hydrocarbon phases and only co2 dissolution in the aqueous phase was considered on the other hand the matrices are not as ill conditioned as in the equivalent computations for asphaltene containing mixtures nasrabadi et al 2016 2 5 additional algorithmic improvements phase stability analyses are known to be computationally expensive especially in three phase flow but in reservoir simulations there are multiple ways in which stability analyses can be avoided for all but a few grid cells the most obvious example is injection into a reservoir that is saturated with single phase fluid such as gas injection into an oil reservoir or a brine aquifer unless fluid is also extracted at a higher rate than the injection rate the formation pressures can generally only increase in some cases mixing of gas and oil species can result in volume shrinkage of the oil phase also because an explicit numerical scheme is used for the transport update the displacement front does not travel by more than one grid cell in one time step for these two reasons if a grid cell and all its neighbors were in single phase at the previous time step that same grid cell will remain in single phase at the current time step and its phase stability does not need to be tested similarly if gas is injected in a reservoir that is initially saturated with oil and water in equilibrium then 1 if a grid cell and all its neighbors were a two phase mixture at the previous time step that grid cell will remain so in the next time step and 2 initial guesses k α i are always available after the first time step the two phase split still needs to be performed because phase compositions may change with small pressure changes in other scenarios reservoir fluid is produced without injection e g in gravity depletion from oil reservoirs in that case a potential phase change is not caused by compositional changes but by the dropping pressure when production is started in a single phase oil reservoir with wells completed in the bottom the pressure will first drop below the bubble point pressure pbp in the top of the reservoir pbp can be computed before any reservoir simulations and phase split computations can be skipped for any grid cell while p pbp even if p pbp is not known only one or a few phase stability tests can be performed at each time step in the top row of grid cells to determine when a two phase grid cell first appears once the top of the domain has dropped below pbp a two phase front propagates downwards for which stability analyses have to be performed however once a grid cell is in two phase phase split guesses from the previous time step are again available to avoid the stability analyses by essentially tracking phase transition fronts caused by either fluid injection or pressure drops the stability tests can generally be avoided in over 95 of the phase split computations as such the phase stability analyses do not add significant computational cost while still improving the robustness of the overall scheme when sufficiently good initial guess for phase split computations are not available a final efficiency gain can be achieved in the computation of phase fractions βα when no initial guess for βα is available from a previous time step a bisection algorithm is typically used in the first iteration of the phase split computation li and firoozabadi 2012a in problems involving water and hydrocarbon phases though βw for the aqueous phase is always close to the overall molar fraction z h 2 o of h2o because the aqueous phase has low solubilities of hydrocarbon species and co2 when no other initial guess is available a value of β w 1 01 z h 2 o with a nr scheme converges in all examples considered in this work 3 numerical experiments the following numerical experiments consider two dimensional meshes with relatively few grid cells such that the phase behavior computations require the majority of the computational cost 90 the applications are chosen to illustrate key features of the phase behavior and cpa algorithms in the context of co2 sequestration stray methane gas leakage and enhanced oil recovery more detailed three dimensional analyses of the former two physical processes are presented elsewhere moortgat et al 2018 soltanian et al 2018 3 1 experimental validation for co2 h2o and c1 h2o mixtures few experimental data are available for the phase behavior of mixtures of multicomponent hydrocarbons self associating water and cross associating co2 or c1 over a range of temperatures pressures and overall compositions of the mixtures fortunately there are ample data in the literature for co2 h2o and c1 h2o mixtures which are important for a wide range of hydrogeology applications notably the study of methane leakage into groundwater resources and co2 storage in aquifers fig 1 compares our cpa eos predictions to nearly 350 experimental data points obtained by several independent experiments in the literature over a wide range of temperatures and pressures for c1 h2o mixtures we match experimental data from 14 to 690 bar and temperatures from 25 to 238 c culberson and mcketta 1951 olds et al 1942 the figure provides both the water evaporation into the methane rich gas phase fig 1a and methane solubility in water fig 1b the following temperature dependent correlations are used for the h2o c1 bic k 12 and cross association factor s 2 in terms of the reduced temperature t c t k 190 k 46 k 12 0 1095 t c 3 0 9462 t c 2 2 9125 t c 2 6407 47 s 2 0 035 t c 3 0 1832 t c 2 0 3429 t c 0 2229 for co2 h2o we match data from 3 to 709 bar and 31 to 204 c the h2o co2 bic k 12 and cross association factor s 2 are correlated with respect to t c t k 304 k as 48 k 12 0 5994 t c 0 5088 49 s 2 0 0529 t c 2 0 0404 t c 0 0693 fig 1c and e show the h2o fraction in the co2 rich gas phase and fig 1d and f the co2 solubility in water the agreement between the cpa eos and experimental data is excellent over the full range of conditions for both c1 and co2 as the cross associating component when the above correlations are used the eos description has no other adjustable parameters and is highly predictive given that the solubility of heavier than methane hydrocarbons in water is extremely low we expect the eos to also perform well for multicomponent mixtures of water co2 or methane and other hydrocarbons additional experimental validation for up to 4 component mixtures is provided in li and firoozabadi 2009 note that the pr eos without self and cross association terms can predict the water compositions in non aqueous phases reasonably well but it significantly underestimates the solubility of co2 and hydrocarbons in the aqueous phase peng and robinson 1980 alternative approaches have been proposed that use different sets of binary interactions coefficients for the aqueous and non aqueous phases firoozabadi et al 1988 michel et al 1989 peng and robinson 1976b søreide and whitson 1992 while this method can be tuned to match experimental data for binary mixtures and is computationally efficient it is purely empirical is inconsistent in the near critical region and has not been thoroughly validated for multicomponent mixtures and in phase stability analyses similarly modifications of the empirical henry s law are successful in match binary data spycher et al 2003 but may be less reliable in guaranteeing local thermodynamic equilibrium for multicomponent mixtures now that we have confidence in the accuracy of the cpa eos we proceed to numerical experiments to assess the efficiency and robustness of the eos in reservoir simulations 3 2 efficiency of cpa reservoir simulation scheme and comparison to pr eos this example demonstrates the effectiveness of the cpa phase split algorithms developed in this work and compares to reservoir simulations with the pr eos problems that involve gas water and oil are often both gravitationally and viscously unstable and small changes in phase properties result in profoundly different flow such complexities are modeled in the next examples but to allow a more straightforward comparison between cpa and pr simulation we first consider a set up that is relatively simple in terms of fluid flow specifically we model a typical quarter five spot pattern for a horizontal 100 m 100 m domain on a fine mesh with 100 100 grid cells gas is injected at a constant rate of 5 pore volume pv per year from one corner and outflow is at a constant pressure of 320 bar from the diagonally opposite corner the uniform permeability porosity and temperature are 1 darcy 20 and 125 c for simplicity we consider quadratic relative permeabilities with unit end points to make phase velocities less sensitive to compositional variations for cpa versus pr we assume constant viscosities of 0 029 cp for gas and 0 22 cp for water three scenarios are simulated in the first pure co2 is injected and the domain is initially saturated with pure h2o without a residual water saturation s r w 0 co2 can displace all the water although the adverse mobility ratio of 7 6 results in an unstable displacement front the second scenario considers the same two component problem but with s r w 40 the third also has s r w 40 but involves a three component system the injection gas is 95 mol co2 and 5 methane c1 and the formation water has 0 15 mol dissolved methane the correlations from the previous example are used to determine the cross association parameter 0 0743 and bic of co2 0 276 in cpa the same bic is used in the pr eos for consistency and a bic of 0 15 is used for c1 in both models both cpa and pr otherwise depend only on critical properties of the pure components and no further tuning is performed with these parameters for co2 h2o mixtures the h2o solubility in the gas phase for a 50 mol 50 mol mixture is similar for cpa 3 38 and pr 3 77 but the solubility of co2 in the aqueous phase is different by an order of magnitude between cpa 2 69 and pr 0 24 fig 2 shows simulation results for all three scenarios after gas injection of 22 pv referred to as 22 pvi in the first case with s r w 0 the displacement is most efficient and the flow is the least sensitive to compositional variations partly because fixed gas and water viscosities are used cpa and pr simulations provide fairly similar predictions as soon as srw 0 though the differences become more pronounced in all cases high water saturations remain behind the gas front because of the adverse mobility ratio but obviously those saturations are highest for s r w 40 behind the displacement front water is saturated with dissolved co2 while the molar fraction of co2 in water is constant for a two component two phase mixture the total amount or volume of dissolved co2 scales with the water saturation when larger volumes of injected co2 dissolve in immobile residual water the gas front propagates slower because pr predicts a lower co2 solubility than cpa with the parameters considered the gas front is significantly more advanced after 22 pvi another observation from fig 2 is that in compositional multiphase flow residual saturations are somewhat meaningless relative permeabilities enforce that water is immobile below s r w 40 however when co2 dissolves in water the aqueous phase volume may swell above s w 40 which remobilizes some of the water more importantly water evaporates into the co2 rich gas phase and is carried away by the gas when multiple local pore volumes e g a grid cell pv of gas flow through a grid cell eventually all the water may evaporate which is indeed what is shown in fig 2 within about a 15 m radius from the injection well these processes are common in compositional gas oil systems as well thermodynamically a two component two phase system is unique because the composition in each phase is independent of phase fractions or saturation in the third scenario we consider co2 h2o and methane c1 for which phase compositions in two phase mixtures depend non linearly on phase amounts the solubility of co2 and c1 in water also depend on each other s compositions such that correlations like henry s law do not apply the same phase viscosities are used such that the displacement fronts for pure co2 and the co2 c1 gas are similar illustrated by the co2 and sg profiles in fig 2 what is interesting about this scenario is the competitive dissolution and exsolution of co2 and c1 when co2 rich gas mixes with c1 enriched water c1 tends to evaporate more while co2 takes its place dissolving in the aqueous phase as a result the residual water is stripped of its initial c1 and saturated with co2 while the gas phase has a bank of very high methane concentrations that is pushed ahead of the injection gas this process has been studied analytically hosseini et al 2012 and was observed directly during the cranfield ms large volume co2 storage pilot test which has nearby ongoing co2 eor operations hosseini et al 2013 soltanian et al 2018 the same process is also common in enhanced oil recovery eor by co2 injection in oil reservoirs moortgat et al 2011 table 1 lists the statistics of the phase split computations with either cpa or pr of a full simulation for the most complicated scenario with co2 c1 and h2o by tracking the displacement front phase stability analyses are only performed around the front and in less than 2 of cases single phase grid cells are mostly identified by neighboring grid cells which avoids a phase stability analysis in 60 70 of cases behind the displacement front initial guesses are available from the previous time step for equilibrium ratios k α i phase fractions βα and also for zα χ a w and χ a c this avoids phase stability analyses in 28 38 of cases and results in faster convergence of the phase split computations when initial guesses are available the phase split computations essentially always converge in only a few steps the failure rate is 10 6 and 10 5 for cpa and pr respectively this is a critical factor in the efficiency of explicit schemes for transport time steps are small but phase split computations per time step are extremely efficient implicit schemes allow larger time steps but this results in poorer initial guesses for the phase split computations as discussed in section 2 5 βα can always be computed with nr using either the value from the previous time step or a guess based on the current overall molar fraction of h2o the latter was only implemented for cpa and the pr simulation required a negligible number of bisection calculations for βα finally when only a few ssi iterations are required it is not worth switching to nr because each nr iteration requires considerably more computational time than a single ssi iteration this is particularly true for cpa which involves more complicated derivatives in the nr jacobian getting to the more important differences between cpa and pr simulations the former required about 40 more ssi iterations in the phase split computations than pr this is not surprising given that both zα and the fugacities are considerably more non linear in cpa than in pr see eqs 2 3 and 22 similarly the few phase stability analyses may require more initial guesses and more iterations in cpa than in pr together this is reflected in table 1 by the fact that cpa required twice as many zα calculations as pr remember that these zα calculations are the main complexity of cpa and generally make reservoir simulation schemes computationally impractical due to their computational cost however the nr scheme proposed in section 2 1 1 always converges even more interesting our nr scheme for the highly non linear zα in cpa required only 2 iterations on average whereas the zα from the cubic pr which has an analytical solution required 4 iterations the cumulative outcome is that the cpa simulations required only 16 more computational time than pr simulations which is quite remarkable given the complexity of the cpa eos and this is the main achievement of this work as a final and important note the main purpose of this example is to demonstrate that the algorithms proposed in this work allow simulations with the accurate cpa eos at a computational efficiency that is comparable to the widely used pr eos we acknowledge that pr can be tuned in different ways to obtain more accurate results than those shown in fig 2 as discussed in the previous example 3 3 co2 sequestration in aquifer with gravity fingering in two phase flow injection of co2 in deep water aquifers is a promising technology to mitigate anthropogenic greenhouse gas emissions when usually supercritical co2 dissolves in water it exhibits interesting and non intuitive phase behavior it increases the aqueous density and swells its volume the former even though the density increases is typically only about one percent make a stratification of co2 rich gas in the top and water below gravitationally unstable this triggers gravitational instabilities or fingering that mix dissolved co2 throughout the aquifer on advective time scales which can be fast for high permeability formations gravity fingering in the context of geological co2 sequestration has been simulated by innumerable authors but most detailed studies only consider the single phase aqueous phase with suitable boundary conditions in a rectangular domain fu et al 2013 moortgat 2016 pau et al 2010 pruess and zhang 2008 riaz et al 2006 soltanian et al 2016b 2017 phase behavior is often approximated by linear correlations of the aqueous phase density in terms of dissolved co2 concentration and henry s law for the solubility spycher et al 2003 in this example we demonstrate the robustness and efficiency of reservoir simulations with the accurate cpa eos for this highly non linear problem we consider a cross section of an aquifer that is 200 m wide and 25 m thick on a fine 632 79 grid i e δ x δ y 32 cm but with an added upward slope and a structural trap as illustrated in fig 3 co2 is injected at 5 pv yr from a perforated vertical well along the left boundary the top and bottom boundaries are considered impermeable and outflow is allowed across the right boundary at a constant pressure temperature pressure relative permeability and porosity are as in the previous example s r w 40 a random perturbation of 7 is added to the permeability to guarantee triggering of the fingering although this is not necessary for the higher order finite element methods used in this work shahraeeni et al 2015 fig 3 shows the interesting features that develop light 578 kg m3 co2 rich gas segregates to the top of the domain and accumulates in the structural trap a non trivial moving interface develops across which co2 dissolution takes place which increases the water density by 0 7 for the high permeability considered 1 darcy gravitational instabilities are triggered early on and after one year we already see pronounced fingers develop because the gas flows from left to right fingers develop first from the left and are therefore larger at any given time than those on the right which were triggered later after three years fingers have already reached the bottom of this relatively thin aquifer the thickness is similar to the cranfield co2 storage aquifer another feature that develops is co2 saturated brine that sinks to the bottom right at the injection well and essentially forms a large finger in the first simulation we simply inject pure co2 into pure water in the second similar to the previous example we consider water that is nearly methane saturated and inject a 95 5 mol mixture of co2 and c1 the fingering dynamics are not affected significantly but interestingly the fingers are actually depleted in methane as compared to the initial aqueous phase similar to the discussion in the previous example as discussed in the previous example the standard pr eos peng and robinson 1980 significantly underpredicts the co2 dissolution in water and thus the associated local density increase simulations of this problem with the pr eos without using different bic for the aqueous and gaseous phases do not show any gravitational fingering when cpa eos is used but without accounting for the cross association between h2o and co2 the co2 and c1 solubility is also reduced to 0 07 mol fingers still develops but later and to a lower extent fig 3 this demonstrates the importance of considering cross association when modeling problems that are sensitive to the compositions in the aqueous phase such as gravitational instabilities the statistics of the phase split computations with cpa are similar to the previous example less than 2 stability analyses were required 99 9999 of flash computations converged with an initial guess from the previous time step and these computations required on average six ssi iterations all zα computations converged with a nr method in two iterations on average the total cpu time was 424 mins 3 4 groundwater contamination risk from methane well leakage when natural gas is produced from deep formations such as black shales or coal bed seams there is a risk that a well or its casing may become compromised at some depth this would cause a source of methane leakage and due to the high pressures typically involved the leakage rate can be high methane is considerably lighter than water and is therefore expected to buoyantly rise towards the surface potentially contaminating groundwater on the way because of this strong buoyancy surface and groundwater tests of methane leakages are usually only required and performed in a relatively small radius around producing wells however several field studies suggest that methane may travel much farther from a leaky well in the subsurface darrah et al 2014 jackson et al 2013 vengosh et al 2014 a detailed study of methane leakage into groundwater is beyond the scope of this work a more thorough analysis was recently presented in moortgat et al 2018 but in this example we show how consistent with recent experimental observations cahill et al 2017 realistic subsurface heterogeneity indeed causes significant lateral spreading to this end we consider the highly detailed history matched static model of the fluvial depositional features in the cranfield formation which has a highly channelized permeability field hosseini et al 2013 we extract a two dimensional vertical cross section with the same dimensions as in the previous example but with fewer grid cells in the horizontal direction 79 128 to be consistent with the static model in hosseini et al 2013 and soltanian et al 2016a the formation description has eight operational facies with permeabilities that range from tight shale like structures of 0 08 md to sandstone type facies with high permeabilities of 500 md we assume that on the left boundary there is a well that is producing methane from some deeper target but that is leaking into our domain at a rate of 5 pv yr or 30 m2 per day at surface conditions leakage is only into the more permeable layers and not into the shale features as indicated by the ellipses in fig 4 which also illustrates the permeability field initially the domain is saturated with water and methane is the cross associating component in this example for simplicity all other parameters are the same as in the previous example the layering of the fluvial deposits results in a very low effective vertical permeability as a result vertical buoyant flow is strongly suppressed it takes more than a year for methane to reach the top of this 25 m thick domain and it only does so over 100 m away from the leaky well at low concentrations fig 4 even after three years most of the methane exits the domain laterally through the right boundary which is 200 m away from the leak under such conditions methane may appear in groundwater and at the surface far away from its initial deep subsurface source the statistics of the cpa phase split computations are comparable to those in the previous two examples but with even higher efficiency the average number of ssi iterations for this simulation was only 3 and no bisection methods were used for zα and βα the total cpu time was 25 min 3 5 enhanced oil recovery by co2 injection after water flooding in this final example we consider double displacement of a 6 component oil i e first by water flooding and then by co2 injection both at 5 pv yr relative permeabilities are as in the previous examples but we consider 60 and 0 residual oil saturations to water and gas respectively in other words water flooding leaves 60 of the oil behind and co2 is injected to recover this residual oil we simulate seven years of water flooding 35 pvi followed by six years of co2 injection a total of 65 pvi in 13 years the domain dimensions are as in the previous examples but on a mesh with 200 50 grid cells the oil pseudo components and their critical properties are from the supplemental information in amooie et al 2017 but the initial composition is 5 54 15 7 9 and 10 for co2 and the 5 hydrocarbon species with a residue of c 11 the temperature and initial pressure at the bottom are 127 c and 483 bar at this condition the viscosities of the initial oil water and injected pure co2 are 0 17 cp 0 22 cp and 0 06 cp and the phase densities not tuned to data are 574 kg m3 962 kg m3 and 683 kg m3 this already suggests interesting potential flow behavior water flooding should be viscously stable while co2 injection may be prone to viscous instabilities additionally because the supercritical co2 is denser than the initial oil in place but lighter than water injection from the top should also be gravitationally unstable the purpose of this example is not to devise the optimal oil recovery strategy i e co2 injection from the bottom but rather to construct the most complicated flow and phase behavior conditions to stress test the robustness of the cpa phase behavior calculations we therefore inject co2 from the top such that the front is both viscously and gravitationally unstable by assuming a high permeability of 500 md with porosity again 20 fingering will be more pronounced fig 5 first shows the water saturations after two and seven years due to the relatively high permeability water is gravitationally segregated in the bottom of the domain which results in an effective sweep note that the oil saturation 1 s w near the injection well drops below its residual value due to species exchange with the aqueous phase which could not be modeled with our earlier simplified cpa model moortgat et al 2012 during co2 injection we see very complex flow patterns as expected overall co2 c1 and c 11 compositions are shown after 13 years six years of co2 injection dense co2 segregates below the lighter oil but is subsequently stably stratified on top of the even denser water because no residual water saturations were considered both oil and water are displaced towards the producer methane again forms a bank that is pushed ahead of the highest co2 concentrations at the same time species exchange of methane from the oil with co2 results in co2 c1 mixtures that are lighter than the supercritical co2 this triggers buoyantly rising plumes upwards gravitational fingering that are clearly visible in both the co2 and c1 compositions in the bottom left the immobile remaining oil is depleted of methane because it dissolved into the aqueous phase during water flooding and was subsequently transported away the cpa phase behavior computations were as efficient and robust in this h2o plus 6 component co2 oil mixture as in the previous examples the average number of ssi iterations was five and the fraction of stability 2 and phase split calculations with initial guesses 64 and their failure rate 10 5 were essentially the same the nr solution for zα did fail a few times but at a negligible fraction of 10 7 in which cases the bisection method found the correct solution due to the higher cost of three phase split calculations the total cpu time was 512 min this example demonstrates that the methods presented in this work are not only accurate and fast but also robust i e do not result in diverging phase split results for typical multicomponent multiphase petroleum engineering applications 4 conclusions the cubic plus association cpa equation of state with additional terms that describe cross association has been demonstrated to accurately predict the phase behavior of mixtures that contain polar molecules like water and asphaltenes and cross associating molecules like co2 methane h2s and hydrocarbons moreover the cpa eos has a strong foundation in thermodynamics however the expressions for the compressibility factor z in terms of which the eos is formulated are considerably more non linear than the cubic eos that are commonly used in reservoir simulations three non linearly dependent equations are required for z χ a w χ a c and even the number of roots can not be determined a priori in prior work moortgat et al 2012 we proposed a simplified cpa phase behavior package which only considered the dissolution of a cross associating co2 component into the aqueous phase but which did not allow for the solubility of any hydrocarbon species nor the evaporation or dissolution of h2o in hydrocarbon phases gas and oil this is a computationally efficient approach that is sufficient for many applications e g the modeling of geological co2 sequestration when only co2 and h2o species are considered or various enhanced oil and gas recovery scenarios in which dissolution into the aqueous phase can be neglected in this work we implement a fully compositional three phase phase behavior model in which all species can transfer between all phases taking into account their potential self and cross associating behavior the excessive computational cost that is involved in stand alone phase behavior packages is resolved by a number of efficient algorithms in reservoir simulations billions of phase split computations have to be performed but the advantage is that more prior information is available clever use of spatial from neighboring grid cells and temporal from previous time steps information allows one to avoid most of the demanding computations and also speeds up the remaining iterative schemes in addition by carefully studying phase envelopes and their associated phase properties such as compressibility factors zα allow the parameterization of good initial guesses when insufficient temporal or spatial context is available together the solutions presented in this work allow the use of quadratically converging newton raphson schemes for all the non linear equations involved in the cpa computations and avoid the expensive multidimensional bisection methods used in earlier stand alone cpa implementations the result is a three phase multicomponent reservoir simulator based on the cpa eos which is as fast as one based on a cubic eos such as pr despite the considerably higher degree of non linearity in cpa five numerical experiments demonstrate the powerful features of this approach the first example shows the excellent match of cpa predictions with several hundred laboratory data points for the mutual solubilities of water with co2 and c1 over a wide range of temperatures and pressures from 3 to 709 bar and from 25 to 238 c the second example considers several examples of co2 and c1 injection into aquifers provides the statistics of the cpa eos calculations and demonstrates that we achieve almost the same computational efficiency within 16 as with a much simpler pr eos simulator the third and fourth examples illustrate the robustness of the proposed schemes by simulating challenging problems involving gravitational instabilities during carbon sequestration and methane leakage through a highly heterogeneous fluvial formation finally we considered a multicomponent double displacement problem in which is oil is first recovered by a traditional water flood from the bottom followed by enhanced oil recovery by co2 injection from the top the suite of these examples validate the accuracy computational efficiency and robustness of our schemes for the range of applications for which they are intended these algorithms should facilitate the more wide spread adoptions of cpa in reservoir simulators that intend to model both hydrocarbon and aqueous phases acknowledgements we greatly appreciate the helpful suggestions by zhidong li in implementing the cpa eos in the context of a reservoir simulator 
842,the high order numerical solution of the non linear shallow water equations is susceptible to gibbs oscillations in the proximity of strong gradients in this paper we tackle this issue by presenting a shock capturing model based on the numerical residual of the solution via numerical tests we demonstrate that the model removes the spurious oscillations in the proximity of strong wave fronts while preserving their strength furthermore for coarse grids it prevents energy from building up at small wave numbers when applied to the continuity equation to stabilize the water surface the addition of the shock capturing scheme does not affect mass conservation we found that our model improves the continuous and discontinuous galerkin solutions alike in the proximity of sharp fronts propagating on wet surfaces in the presence of wet dry interfaces however the model needs to be enhanced with the addition of an inundation scheme which however we do not address in this paper keywords shallow water equations element based galerkin methods dynamic artificial diffusion de aliasing high order methods unified continuous discontinuous galerkin large eddy simulation 1 introduction the shallow water equations sw de saint venant 1871 are a common d 1 approximation to the d dimensional navier stokes equations to model incompressible free surface flows due to the ability of high order galerkin methods to keep dissipation and dispersion errors low ainsworth et al 2006 and their flexibility with arbitrary geometries and hp adaptivity these methods are proving their mettle for solving the shallow water equations in the modeling of non linear waves in different geophysical flows chun and eskilsson 2016 dawson and aizinger 2005 eskilsson 2011 gerhard et al 2015 giraldo 2001 giraldo et al 2002 giraldo and restelli 2010 hendricks et al 2016 iskandarani et al 1995 kärnä et al 2011 kesserwani and liang 2012a 2012b kubatko et al 2006 li et al 2018 ma 1993 marras et al 2015 nair et al 2007 taylor et al 1997 xing et al 2010 one important property that high order galerkin methods offer and that makes them attractive over their low order counterparts is given by their natural strong scaling properties on massively parallel computers abdi et al 2016 gandham et al 2015 müller et al 2016 nevertheless the high order solution of non linear wave problems via high order methods is susceptible to unphysical gibbs oscillations that form in the proximity of strong gradients such as propagating bores filters like vandeven s 1991 and boyd s 1996 and different types of artificial viscosities are the most common tools to handle this problem for continuous and discontinuous galerkin cg dg methods however filtering may not be sufficient as the flow strengthens and the wave sharpness intensifies for this reason previous studies have stabilized the galerkin solution to the shallow water equations in a variety of ways for example the lilly smagorinsky eddy viscosity model lilly 1962 smagorinsky 1963 was utilized in phan van et al 2014 and rakowsky et al 2013 to preserve numerical stability without compromising the overall quality of the solution to account for sub grid scale effects artificial viscosity was utilized in the dg model described in gourgue et al 2009 to improve their inviscid simulations recently in pasquetti et al 2015 the high order spectral element solution of the one dimensional shallow water equations was stabilized via the entropy viscosity method artificial viscosity limiters and filters for the modal dg solution of sw were recently compared in michoski et al 2016 concluding that a dynamically adaptive viscosity may be the most effective means of regularization at higher orders building on some of the insights from the studies cited above and on the findings of some authors of this paper to solve non linear hyperbolic equations in the context of atmospheric modeling marras et al 2015 section 5 we propose a parameter free shock capturing scheme to detect the presence of spurious modes in the proximity of strong gradients the model that we propose we will often refer to it as dyn sgs to indicate its dynamic sub grid scale nature was first defined in nazarov and hoffman 2013 for the linear finite element solution of compressible flows with shock waves it was applied to stabilize high order galerkin methods in the context of stratified low mach number atmospheric flows by some of the authors in marras et al 2015 it was recently used successfully to remove oscillations from the dg solution of nonlinear acoustic waves in kelly et al 2017 dyn sgs is based on the idea of scale splitting where the flow scales are split into resolvable and unresolvable for a given computational grid the unresolved scales are parameterized via the subgrid scale sgs model at hand it must be borne in mind throughout the manuscript that dyn sgs unlike the sub grid scale models designed for les that are built from physical reasoning is merely a numerical tool meant to remove the spurious oscillations from the solution of nonlinear wave equations and does not have a priori a physical meaning among its characteristics being parameter free and dynamically adaptive as a function of the solution residuals are possibly the most attractive ones furthermore this model is independent of the underlying numerical approximation which makes it naturally applicable to cg and dg alike as well as to finite elements finite volumes and finite differences 2 governing equations let ω r d be a fixed domain of space dimension d with boundary γ and cartesian coordinates x x in 1d and x x y in 2d in both cases we will use z to identify the direction of gravity which is orthogonal to x and points downward let t r identify time given ω and t we define the velocity vector u t x whose one and two dimensional components are respectively u and u v we also define the total water surface h t x h s t x h b x where hs t x is the water depth and hb x the bathymetry based on these definitions the shallow water equations with artificial viscosity are written as 1a h t h u δ μ s g s h s 1b h u t h u u g 2 h 2 h b 2 i g h s h b i h s μ s g s u where g 9 81 m s 2 is the magnitude of the acceleration of gravity i is the d d identity matrix and μsgs is the dynamic viscosity coefficient to be defined shortly in 1a δ defines whether viscosity is turned on δ 1 or off δ 0 in the continuity equation the shallow water equations above contain no physical viscosity or a chézy manning formulation to model bottom friction we do this on purpose because we are interested in evaluating the effect of dyn sgs on the numerical solution without being affected by the presence of physical dissipation 3 space and time discretization the numerical model used in this paper is the two dimensional version of the numa model described in kelly and giraldo 2012 and abdi and giraldo 2016 where the equations are approximated via high order continuous and discontinuous spectral elements on quadrilateral elements throughout the paper we will use the acronyms sem and cg for spectral elements and continuous galerkin respectively and dg for discontinuous galerkin the solution is advanced in time using a fully implicit runge kutta scheme see section 3 2 3 1 spectral element and discontinuous galerkin approximations we point the reader to giraldo et al 2002 and kopera and giraldo 2014 for details of the discretization nonetheless we introduce the notation that we adopt in this paper to solve the shallow water equations by element based galerkin methods on a domain ω we proceed by defining the weak form of 1 that we first recast in compact notation as 2 q t f q s q where q h h u t is the transposed array of the solution variables and f and s are the flux and source terms in the case of spectral elements the space discretization yields the semi discrete matrix problem 3 q t d t f q s q where for the global mass and differentiation matrices m and d we have that d m 1 d we obtain the global matrices from their element wise counterparts m e and d e e stands for element by direct stiffness summation which maps the local degrees of freedom of an element ω e h to the corresponding global degrees of freedom in ωh and adds the element values in the global system by construction m is diagonal assuming inexact integration with an obvious advantage if explicit time integration is used in the discontinuous galerkin approximation the problem at hand is solved only locally and the flux integral that stems from the integration by parts must be discretized as well because the current continuous discontinuous galerkin implementation is unified we are effectively constructing flux integrals to build the boundary conditions for cg as well as dg the element wise counterpart of the matrix problem 3 is then written as 4 q e t m γ e t f q e d e t f q e s q e where we obtain m γ e m e 1 m γ e from the element boundary matrix m γ e and the element mass matrix m e out of various possible choices for the definition of the numerical flux f q in eq 4 we adopted the rusanov flux we chose rusanov for simplicity and efficiency during the code development we compared hll hllc and rusanov for high order approximations rusanov is often associated with over dissipation however at 4th order or greater we observed indiscernible differences as reported in appendix a the laplace operator of viscosity is approximated using the symmetric interior penalty method the reader is referred to arnold 1982 for details on its definition 3 2 time integration eq 3 is integrated in time by a fully implicit runge kutta scheme that corresponds to the implicit part of the implicit explicit scheme used in giraldo et al 2013 see also butcher and chartier 1999 the method coefficients in standard a a i j b c tableaux form are the following 5 0 0 2 2 1 1 2 1 1 2 1 2 2 1 2 2 1 1 2 1 4 1 2 2 1 2 2 1 1 2 c a b scheme 5 is a three stage second order explicit first stage singly diagonally implicit runge kutta esdirk scheme this scheme has desirable accuracy and stability properties i all stages are second order accurate ii it is stiffly accurate and l stable and iii it is strong stability preserving gottlieb et al 2001 with coefficient of 2 these properties allow us to take large time steps with high accuracy as well as alleviate the instability issues associated with sharp solution gradients gottlieb et al 2001 the two dimensional test presented later in this paper demonstrated to be the most demanding in terms of stability constraints method 5 allows us to gain up to one order of magnitude in terms of maximum admissible advective courant number when compared to an explicit method explicit part of ark3 kennedy and carpenter 2003 in particular the explicit four stage runge kutta solution of the solitary wave against one isolated obstacle described in section 5 5preserved stability for up to courant 0 21 using both cg and dg approximations although we were not able to use arbitrarily large time steps with the esdirk with the current implementation we will address this issue in a future work we resolved the same problem at courant 1 8 schemes with a subset of these properties are employed by kärnä et al 2011 and shown to be robust in this context computationally at each of the two implicit stages we have to solve a nonlinear equation g q i 0 where q i are the stage values i 2 3 and g is a linear combination of stage slopes with coefficients given in 5 we do so by using newton iterations with a stopping criterion based on the relative decrease in the residual that is stop at iteration k if g q k i g q 0 i t o l n at each newton iteration we have to solve a linear system j q k i q k 1 i g q k 1 i where j is the jacobian matrix of g q i we approximate the jacobian using directional finite differences and iterate with the generalized minimal residual gmres method which is effectively a jacobian free newton krylov method knoll and keyes 2004 the gmres stopping criterion is also based on the relative residual the first stage is explicit and equal to the last stage of the previous step effectively making it a two stage method which saves some computational time 4 the shock capturing scheme there are different ways to derive the viscous model described by eq 1 from the inviscid shallow water equations similarly to our previous work on the large eddy simulation of stratified atmospheric flows marras et al 2015 the current model builds on the separation of scales between grid resolved indicated as f x for any quantity f x and unresolved sub grid the unresolved scales are modeled via the shock capturing scheme at the core of this paper dyn sgs given an element ωe of order n and with side lengths δx δy of comparable size we define the following characteristic length 6 δ min δ x δ y n 1 the value of δ sets the size of the smallest resolvable scales in the same way as cut off filters do in large eddy simulation models the application of scale separation in the continuity equation 1a results in the presence of an additional term on the right hand side which is the artificial viscosity term that appears in eq 1 it is often debated whether artificial viscosity should be added to the continuity equation gerbeau and perthame 2001 guermond and popov 2014 pasquetti et al 2015 should the discrete viscous operator not be conservative artificial viscosity must not be added to the continuity equation however by relying on spectral elements with integration by parts of the second order diffusion operator the discrete viscous operator is conservative as shown in guba et al 2014 the numerical demonstration of the conservation properties of the current approximation can be also found in our previous work marras et al 2015 for the euler equations to get a sense of how necessary a stabilized continuity equation may be we will show the results in section 5 5 scale separation in the momentum equation yields a new equation that includes the gradient of the quantity 7 τ s g s h μ s g s u the coefficient μsgs is defined element wise and is given as 8 μ s g s max 0 0 min μ max ω e μ res ω e where 9 μ res ω e δ 2 max r h ω e h h ω r h u ω e h u h u ω and 10 μ max ω e 0 5 δ u g h s ω e in 9 10 indicates the spatially averaged value of the quantity at hand over the global domain ω the norms ω at the denominator are used to preserve the physical dimension of the resulting equation and r h and r h u are the residuals of the inviscid governing equations at each time step the residuals are known and given by 11a r h h t h u 11b r h u h u t h u u g 2 h 2 h b 2 i g h s h b i the residuals make the artificial viscosity mathematically consistent which means that the residual based viscosity vanishes when the residual is zero the quantity u g h s in 10 is the maximum wave speed we would like to emphasize the necessity for the physically correct dimensions of the viscosity coefficient this is an important issue that is seldom accounted for in the design of artificial viscosity methods for stabilization purposes as underlined in marras et al 2015 the most important aspect of dyn sgs for high order solutions is its ability to prevent spurious oscillations without the necessity of additional slope limiters and as much as possible low pass filters this fact is even more important when we rely on dg to solve the shallow water equations on wet dry surfaces as pointed out in kesserwani and liang 2011 an improper and unnecessary use of the limiter coincidentally may even destroy the conservative properties of the dg predictions rather than improving them in this paper we concentrate on using dyn sgs to remove spurious oscillations in the proximity of the propagating bores and see how much we can rely on it without depending on auxiliary filters and limiting mechanisms this model is based on a second order laplacian operator it is hence not expensive and does not add additional burden in parallel 5 numerical tests we verify the correctness of our model through a set of one and two dimensional tests the code is designed to run in two dimensional mode only for this reason the one dimensional tests are set up with one element and periodic boundaries in the second dimension we begin the set of tests by verifying that dyn sgs preserves the well balanced properties of the solution of a lake at rest over a submerged hump this test is meant to identify whether dyn sgs impacts the hydrostatic balance when the lake should remain at rest at all times in 1d we start by verifying the hydrostatic balance of a lake at rest over a hump we continue with the solution of the steady state flow over a hump that triggers a shock followed by the test of a moving shock triggered by a dam break on a wet surface also known as sod s tube problem in the literature of gas dynamics and finally the problem of an oscillating lake in a parabolic bowl in 2d we analyze a test that includes all of the features of the previous 1d tests but add the complexity of the multidimensional interaction of moving wave fronts 5 1 well balanced lake at rest over a submerged hump to assess the effect of the dyn sgs on the well balanced property of the shallow water solver we follow test 3 1 1 of delestre et al 2013 and simulate a lake at rest over a hump the velocity should remain zero as time progresses the one dimensional domain measures 25 m in length the bathymetry is given analytically by h b x 0 2 0 05 x 10 2 if 8 x 12 m 0 otherwise in fig 1 we show the spatial distribution of momentum obtained with cg and dg the solution is hydrostatically balanced and does not degrade as time progresses as visible from the almost flat time series of u that ranges between o 1 10 15 and o 1 10 14 in fig 2 this result confirms that the proposed de aliasing scheme does not act when the solution is exact we can then proceed with those tests that involve steady state and transient flows 5 2 steady state transcritical flow over a hump the steady flow over a hump has been often used as a benchmark for shallow water solvers since goutal and maurel 1997 vázquez cendón 1999 the domain and bathymetry are the same as in the previous test however we fixed the value of 18 m 2 s 1 to the incoming flux at the left boundary and a 0 33 m water depth in outflow we initialized a zero velocity field with initially uniform water depth of 0 33 m these conditions are such that the flow develops a hydraulic jump in the immediate proximity of the hump downslope in the cases where the numerical solution preserved stability the flow reached steady state within a few time steps nevertheless to make sure that the solution preserved stability at all times we executed all tests to a final time t f 1500 s which is far beyond the initial transitory behavior during the first few seconds for direct comparison against the exact and numerical solutions presented in delestre et al 2013 using 500 computational cells we subdivided the domain into 125 elements of order 4 giving an effective resolution δ x 0 05 m we plot the stabilized and non stabilized water surface solutions for the cg and dg approximations in fig 3 where the exact solution obtained with swashes delestre et al 2013 is superimposed on the numerical ones as expected the non stabilized cg solution explodes almost immediately during the first few time steps the strong discontinuity triggers oscillations that propagate across the entire domain the same behavior occurs with and without either a low pass spectral filter or a slope limiter the problem is immediately mitigated by the addition of dyn sgs the dg solution on the other hand loses stability only in the case when neither the limiter nor dyn sgs are used the unstable dg solution is not shown when the limiter is activated stability is recovered although the possibly incorrect tuning of it deteriorates the solution accuracy as is visible from the curve tagged as dg limiter in the figure unlike dyn sgs which is an integral part of the governing equations the limiter is a post processing tool applied at the end of every time step if dyn sgs has cured any instabilities along the simulation the limiter will have no effect on the solution unless possible under and overshoots not previously removed by diffusion are still present this explains why the solutions tagged as dg sgs limiter and dg sgs no filter no limiter show no discernible differences we quantify the absolute error of water surface with respect to the exact solution in fig 4 fig 5 shows that the velocity field oscillations are cured by dyn sgs similarly to the ones of the water surface it is visible from figs 5 and6 that the momentum specific discharge is steady throughout the domain see caviedes voullième and kesserwani 2015 and is not affected by dyn sgs this is in spite of the very small and localized oscillation of the dg solution in the close proximity to the shock 5 3 dam break we study the problem of a dam breaking on a wet surface stoker 1957 in the 1d domain ω x 5 5 m with solid boundaries this particular problem does not involve a wet dry surface and hence allows us to only rely on dyn sgs for stabilization purposes for this reason this test is useful to isolate the action of dyn sgs alone in the proximity of strong fronts this special case of a riemann problem gives rise to the propagation of a rarefaction wave depression that moves leftward towards the deep water and a shock wave bore that moves rightward into a shallow water region given the water depths hl and hr on the left and right of the dam initially centered at x 0 0 m the initial water level of the problem is given by h x 0 h l 3 m if x x 0 h r 1 m if x x 0 whereas velocity is zero everywhere the exact solution to this problem can be computed with the method of characteristics see e g toro 2001 it is given in delestre et al 2013 as 12 h x t h l if x x a t 4 9 g g h l x 2 t 2 if x a t x x b t c m 2 g if x b t x x c t h r if x x c t where x a t x 0 t g h l x b t x 0 t g h l 3 c m x c t x 0 t 2 c m 2 g h l c m c m 2 g h r and c m 4 2585 m s 1 fig 7 shows the exact and numerical solutions at t 0 1 s and t 0 5 s the numerical solutions are computed using cg and dg with and without artificial viscosity neither computation uses filters or limiters so that we can isolate the effects of dyn sgs on the solution without dyn sgs the cg solution loses stability almost immediately in the case of dg the gibbs oscillations triggered by the moving bore propagate upstream as the front moves these modes are removed by including dyn sgs to the mass and momentum equations in the case of momentum figs 8 and 9 show the stabilizing effect of the dynamic viscosity because we added artificial viscosity to the continuity equation we verify that the model did not violate mass conservation as we mentioned in the introduction the use of diffusion in the continuity equation is often an issue of disagreement among researchers we demonstrated in marras et al 2015 that mass can be conserved for the euler equations when dyn sgs is applied in fig 10 we plot the evolution of the relative mass loss for the dam break problem the relative mass loss is defined as 13 m t loss x h x t h x t 0 d x x h x t 0 d x in the figure we observe that mass loss is minimal when dg is used although it is small and lies in the proximity of machine precision conservation worsens for cg this finding agrees with kopera and giraldo 2015 although it was proved in that paper that cg and dg should be equally conservative to avoid compounding roundoff errors in the computation of mass error we use a pairwise summation algorithm to add up mass contributions from all grid points kopera and giraldo 2015 in a regular sum operation we add a big number of contributions one by one which eventually results in adding a relatively small number to a big partial sum in other words the sum s a 1 a 2 a n consists of s a 1 a 2 followed by s s a 3 and so on to s s a n for a large number of these summations the partial sum s eventually becomes much larger than the contributions ai which hence lead to important roundoff errors in the pairwise summation algorithm we add two similar numbers at a time and then recursively add the partial results in the same fashion the computation of s is split into s 1 a 1 a 2 s 2 a 3 a 4 s n 2 a n 1 a n and then recursively the partial sums are added in the same way to form the total sum s with this approach we always add numbers of similar magnitudes which significantly reduces roundoff errors this algorithm is key if incorporated within algorithms that are expected to conserve mass up to machine precision 5 4 1d parabolic bowl to measure the convergence rate of the model we compare the computed solutions against the analytic solution of the flow in a one dimensional parabolic bowl gallardo et al 2007 thacker 1981 the parabolic topography is defined as 14 h b x h 0 1 a 2 x 2 0 5 where h 0 2 m and a 1 in ω x 1 1 m the initial velocity is u 0 m s 1 and the water surface begins to oscillate due to gravity only the solution is computed using 16 32 64 and 128 elements of order 4 figs 11 13 show these solutions obtained with and without dyn sgs for cg and dg the contribution of the artificial viscosity is evident at all resolutions by looking at the detailed views in the figures in the low resolution momentum plots bottom left and right in fig 14 spurious peaks are evident in the regions x 0 5 and x 0 5 this is happening within partially dry elements the velocity in such elements is forced to zero only on the dry nodes as the grid is refined the non stabilized solutions behave sufficiently well in spite of minor oscillations that are immediately removed by the addition of viscosity it is evident that the dg solution outperforms the cg solution in all cases in terms of stable water surface and momentum see momentum in fig 14 far from the wet dry front we note that dynamic viscosity is not always sufficient to stabilize the wet dry interface and that we still have to apply the limiter by xing et al 2010 when the mean mass value becomes negative here we do not analyze the ramifications of our joint usage of dynamic viscosity and a limiter in detail we leave this question for future research although we do not investigate advanced inundation schemes in this paper to be able to solve this problem we add a relatively small layer of water with zero velocity in the regions that should be dry it is evident from the detailed plot in the right column of fig 13 that this approach is not behaving correctly it does negatively affect the wet region in the proximity of the front we limit ourselves to underline the need for a better and robust approach to wetting and drying we will need to address the interaction of dyn sgs with the inundation scheme of choice and we will do so in a future study to quantify the difference between the stabilized and non stabilized solutions we plot the normalized l 2 error norms in fig 15 in the figure we notice that the slope of the stabilized cg solution is greater than its non stabilized counterpart although the same does not occur in the case of dg by observing that both cg and dg seem to require artificial viscosity for a better solution as discussed above we require further analysis on this point to find a possible reason for this behavior we leave this for a future paper where we are planning on analyzing the effect of different inundation schemes as well 5 5 2d solitary wave run up and run down on a circular island a solitary wave run up on a circular island was studied in briggs et al 1995 in this example the initial wave is modeled via the following analytic definition by synolakis 1987 15 η x 0 a h 0 sech 2 γ x x c where a 0 064 m is the wave amplitude x c 2 5 m h 0 0 32 m is the initial still water level and 16 γ 3 a 4 h 0 the island is a cone given as 17 h b 0 93 1 r r c if r r c where r x x c 2 y y c 2 r c 3 6 m and is centered at x c y c 12 5 15 m the cone is mounted on a flat bathymetry the fluid is confined within four solid walls to understand how the proposed adaptive viscosity and numerical approximation depend on the grid we ran the simulation at the four resolutions δx 0 05 0 10 0 20 0 40 m fig 16 shows that the stabilized dg solution is converging to the same solution and the main features of the interacting waves are reproduced almost equally across the four grids certainly the 0 40 m grid spacing is the most dissipative although it is encouraging to see how the important features resolved at 5 cm are still well represented on the coarsest grid the same observation applies to the cg solution plot not shown the instantaneous perspective views of the non stabilized and stabilized cg 4th order solutions of the water surface are plotted in fig 17 at t 42 s in 42 s the wave has crossed the domain back and forth several times in spite of this the stabilized and non stabilized fronts appear to be in the same positions the de aliasing approach by means of dyn sgs removed the high frequency gibbs modes without affecting the dispersion of the wave fronts this result is better visualized in the 1d projection of the solution on the plane y 0 plotted in figs 18 and 19 the spurious modes that characterize the water surface in the proximity of the sharpest wave front are fully removed by dyn sgs without noticeably weakening the front sharpness this result agrees with the application of dyn sgs to non linear wave problems with strong discontinuities as previously shown in marras et al 2015 figs 16 and 17 for the solution of the burgers equation by construction the jump conditions in the numerical flux rusanov hll etc offers an inherent dissipation to dg in the same way that it does to finite volume approximations in simple words the jump terms constitute viscous terms that strengthen as the size of the discontinuity increases this effect is visible in fig 19 the non stabilized dg solution shows no oscillations except for at most some minimal under and over shoots this implies that the numerical residual of the dg approximation is so small that the effect of the shock capturing model reduces to a minimum value this explains why the inviscid and viscous dg solutions look similar because there is no flux computation in the case of continuous spectral elements and because there are no other operations that would contribute to numerical diffusion unless an explicit diffusion term is added via supg vms dyn sgs etc cg does not have the inherent stabilization that dg has in fig 20 we compare the non stabilized against the stabilized cg solutions for velocity we show the same comparison for dg in fig 21 unlike for the case of the water surface for both cg and dg we notice a great difference between the stabilized and non stabilized solutions however this is not telling us anything about the correctness of the solution since this two dimensional problem is non linear has multiple interacting waves and does not have an analytic solution for the velocity field on the contrary what we can tell is that the effect of dyn sgs on the cg solution is consistent with its effect on the dg solution the stabilized cg and dg solutions plotted in the right plots of figs 20 and 21 show similar wave fronts this is indicative of a correct implementation of the unified cg dg framework this important result is telling us that although h is well behaved with dg aliasing could be affecting momentum while sgs is de aliasing the solution this is only a conjecture but aliasing will occur if we do not filter over integrate or stabilize theoretically two numerical methods of equal accuracy should produce identical results under the constraint of zero numerical error this is not practically true and small dispersion errors may be still expected as long as they are sufficiently small this test is meant to demonstrate that dyn sgs does not damp the solution as time evolves this test ran for 50 s which is an important requirement for dissipation based stabilization methods we show the instantaneous energy spectra of the stabilized and non stabilized cg and dg solutions at t 50 s in fig 22 the difference between the cg and dg curves is striking the viscous and inviscid dg spectra overlap almost fully and show approximately the same decay across the entire spectrum from a 5 3 slope in the inertial sub range to a 3 slope in the dissipation wave numbers refer to boffetta and ecke 2012 for a review on two dimensional flows and their energetics this is only true as long as the resolution is not too coarse especially so in the case of cg at very coarse resolutions δx 0 4 m neither cg or dg can avoid energy from building up in the highest modes unless artificial viscosity is used the inherent viscosity of dg is no longer sufficient to prevent this as already mentioned this is telling us that we need de aliasing and dyn sgs will do this without affecting the energy cascade or the convergence rates we stated above that μsgs is only active where the equation residuals i e gradients are important in the case of water waves this occurs in the proximity of the wave fronts in fig 23 we plot μsgs to show its spatial structure and its evolution between t 0 and t 50 s this plot shows how viscosity is equally zero away from the fronts and only activates where really necessary it may not be so obvious to achieve this by using an artificial viscosity that is not residual based to provide a visual correlation between μsgs and the wave features in fig 24 we plot the stabilized spectral element solution of the water surface at a grid resolution δx 0 05 m 6 conclusions we presented a shock capturing scheme or dynamic sub grid scale artificial viscosity that we call dyn sgs to stabilize the high order numerical solution of the shallow water equations via continuous and discontinuous spectral elements cg dg by numerical examples we demonstrated that this model removes the gibbs oscillations that form in the proximity of sharp wave fronts while preserving their strength this is possible because of the residual based definition of the dynamic viscosity coefficient for coarse grids it prevents energy from building up at small wave numbers this aspect is important to preserve numerical stability of tsunami simulations over large domains discretized with coarse grids the model has no user tunable parameter which is of great advantage when the model is to be used by an external user when applied to the continuity equation mass conservation is not affected this shock capturing model works especially well for bores propagating on wet surfaces but is often not sufficient to stabilize velocity at the wet dry interfaces where a thin layer of water still had to be added and in some cases supported by additional limiting further work on the interaction between shock capturing limiters and riemann solvers needs to be done we did not address it in this study as it requires a thorough analysis of its own it is important to underline that the natural built in viscosity of dg may be large enough that the contribution of dyn sgs is at times irrelevant when this happens the dynamic viscosity detects it from the residual and hence limits its own strength nevertheless we have shown that it is often the case that the inherent dg viscosity alone cannot prevent instabilities from forming and propagating even if the solution does not break as it would do in the case of cg it still requires the support of dyn sgs for de aliasing a stable solution does not mean an accurate solution although the results show that dg is superior to cg we show results for both methods because many researchers use cg and it is not yet clear which method is superior in terms of robustness and efficiency see abdi et al 2017 for more on these aspects acknowledgments the authors would like to acknowledge the contribution of haley lane who implemented the one dimensional version of the wetting and drying algorithm used in this work the authors would also like to acknowledge karoline hood who tested the correctness of the implicit solver in her nps master s thesis hood 2016 the authors are also thankful to prof fringer and dr rogers for discussions regarding coastal flows and to stephen r guimond for providing his functions to compute the energy spectra fxg acknowledges the support of the onr computational mathematics program and fxg and emc acknowledge the support of afosr computational mathematics appendix a choice of the riemann solver rusanov hll or hllc in the selection of the riemann solver we stated across the paper that we chose the rusanov flux for simplicity in this appendix we show that for high order elements 4th or greater the choice is not consequential rusanov hllo for hll original and hllc for hll contact see toro 1999 for details can be used interchangeably for problems with strong gradients to give the same solution as expected the results are slightly different nonetheless the effect of rusanov hllo and hllc on the solutions are comparable and neither one of them negatively affects the diffusion or dispersion of the moving front of all rusanov is the simplest and hence the most popular although we acknowledge the need for a proper comparison across a wider range of approximation orders especially so in the case of approximation orders lower than four we leave it for a future study we tested the three solvers on the dam break problem fig 25 and on the steady state transcritical flow over a c 0 bathymetry fig 26 for both tests the results demonstrate that rusanov is indeed as precise as hll and hllc for the high order solution of the shallow water equations 
842,the high order numerical solution of the non linear shallow water equations is susceptible to gibbs oscillations in the proximity of strong gradients in this paper we tackle this issue by presenting a shock capturing model based on the numerical residual of the solution via numerical tests we demonstrate that the model removes the spurious oscillations in the proximity of strong wave fronts while preserving their strength furthermore for coarse grids it prevents energy from building up at small wave numbers when applied to the continuity equation to stabilize the water surface the addition of the shock capturing scheme does not affect mass conservation we found that our model improves the continuous and discontinuous galerkin solutions alike in the proximity of sharp fronts propagating on wet surfaces in the presence of wet dry interfaces however the model needs to be enhanced with the addition of an inundation scheme which however we do not address in this paper keywords shallow water equations element based galerkin methods dynamic artificial diffusion de aliasing high order methods unified continuous discontinuous galerkin large eddy simulation 1 introduction the shallow water equations sw de saint venant 1871 are a common d 1 approximation to the d dimensional navier stokes equations to model incompressible free surface flows due to the ability of high order galerkin methods to keep dissipation and dispersion errors low ainsworth et al 2006 and their flexibility with arbitrary geometries and hp adaptivity these methods are proving their mettle for solving the shallow water equations in the modeling of non linear waves in different geophysical flows chun and eskilsson 2016 dawson and aizinger 2005 eskilsson 2011 gerhard et al 2015 giraldo 2001 giraldo et al 2002 giraldo and restelli 2010 hendricks et al 2016 iskandarani et al 1995 kärnä et al 2011 kesserwani and liang 2012a 2012b kubatko et al 2006 li et al 2018 ma 1993 marras et al 2015 nair et al 2007 taylor et al 1997 xing et al 2010 one important property that high order galerkin methods offer and that makes them attractive over their low order counterparts is given by their natural strong scaling properties on massively parallel computers abdi et al 2016 gandham et al 2015 müller et al 2016 nevertheless the high order solution of non linear wave problems via high order methods is susceptible to unphysical gibbs oscillations that form in the proximity of strong gradients such as propagating bores filters like vandeven s 1991 and boyd s 1996 and different types of artificial viscosities are the most common tools to handle this problem for continuous and discontinuous galerkin cg dg methods however filtering may not be sufficient as the flow strengthens and the wave sharpness intensifies for this reason previous studies have stabilized the galerkin solution to the shallow water equations in a variety of ways for example the lilly smagorinsky eddy viscosity model lilly 1962 smagorinsky 1963 was utilized in phan van et al 2014 and rakowsky et al 2013 to preserve numerical stability without compromising the overall quality of the solution to account for sub grid scale effects artificial viscosity was utilized in the dg model described in gourgue et al 2009 to improve their inviscid simulations recently in pasquetti et al 2015 the high order spectral element solution of the one dimensional shallow water equations was stabilized via the entropy viscosity method artificial viscosity limiters and filters for the modal dg solution of sw were recently compared in michoski et al 2016 concluding that a dynamically adaptive viscosity may be the most effective means of regularization at higher orders building on some of the insights from the studies cited above and on the findings of some authors of this paper to solve non linear hyperbolic equations in the context of atmospheric modeling marras et al 2015 section 5 we propose a parameter free shock capturing scheme to detect the presence of spurious modes in the proximity of strong gradients the model that we propose we will often refer to it as dyn sgs to indicate its dynamic sub grid scale nature was first defined in nazarov and hoffman 2013 for the linear finite element solution of compressible flows with shock waves it was applied to stabilize high order galerkin methods in the context of stratified low mach number atmospheric flows by some of the authors in marras et al 2015 it was recently used successfully to remove oscillations from the dg solution of nonlinear acoustic waves in kelly et al 2017 dyn sgs is based on the idea of scale splitting where the flow scales are split into resolvable and unresolvable for a given computational grid the unresolved scales are parameterized via the subgrid scale sgs model at hand it must be borne in mind throughout the manuscript that dyn sgs unlike the sub grid scale models designed for les that are built from physical reasoning is merely a numerical tool meant to remove the spurious oscillations from the solution of nonlinear wave equations and does not have a priori a physical meaning among its characteristics being parameter free and dynamically adaptive as a function of the solution residuals are possibly the most attractive ones furthermore this model is independent of the underlying numerical approximation which makes it naturally applicable to cg and dg alike as well as to finite elements finite volumes and finite differences 2 governing equations let ω r d be a fixed domain of space dimension d with boundary γ and cartesian coordinates x x in 1d and x x y in 2d in both cases we will use z to identify the direction of gravity which is orthogonal to x and points downward let t r identify time given ω and t we define the velocity vector u t x whose one and two dimensional components are respectively u and u v we also define the total water surface h t x h s t x h b x where hs t x is the water depth and hb x the bathymetry based on these definitions the shallow water equations with artificial viscosity are written as 1a h t h u δ μ s g s h s 1b h u t h u u g 2 h 2 h b 2 i g h s h b i h s μ s g s u where g 9 81 m s 2 is the magnitude of the acceleration of gravity i is the d d identity matrix and μsgs is the dynamic viscosity coefficient to be defined shortly in 1a δ defines whether viscosity is turned on δ 1 or off δ 0 in the continuity equation the shallow water equations above contain no physical viscosity or a chézy manning formulation to model bottom friction we do this on purpose because we are interested in evaluating the effect of dyn sgs on the numerical solution without being affected by the presence of physical dissipation 3 space and time discretization the numerical model used in this paper is the two dimensional version of the numa model described in kelly and giraldo 2012 and abdi and giraldo 2016 where the equations are approximated via high order continuous and discontinuous spectral elements on quadrilateral elements throughout the paper we will use the acronyms sem and cg for spectral elements and continuous galerkin respectively and dg for discontinuous galerkin the solution is advanced in time using a fully implicit runge kutta scheme see section 3 2 3 1 spectral element and discontinuous galerkin approximations we point the reader to giraldo et al 2002 and kopera and giraldo 2014 for details of the discretization nonetheless we introduce the notation that we adopt in this paper to solve the shallow water equations by element based galerkin methods on a domain ω we proceed by defining the weak form of 1 that we first recast in compact notation as 2 q t f q s q where q h h u t is the transposed array of the solution variables and f and s are the flux and source terms in the case of spectral elements the space discretization yields the semi discrete matrix problem 3 q t d t f q s q where for the global mass and differentiation matrices m and d we have that d m 1 d we obtain the global matrices from their element wise counterparts m e and d e e stands for element by direct stiffness summation which maps the local degrees of freedom of an element ω e h to the corresponding global degrees of freedom in ωh and adds the element values in the global system by construction m is diagonal assuming inexact integration with an obvious advantage if explicit time integration is used in the discontinuous galerkin approximation the problem at hand is solved only locally and the flux integral that stems from the integration by parts must be discretized as well because the current continuous discontinuous galerkin implementation is unified we are effectively constructing flux integrals to build the boundary conditions for cg as well as dg the element wise counterpart of the matrix problem 3 is then written as 4 q e t m γ e t f q e d e t f q e s q e where we obtain m γ e m e 1 m γ e from the element boundary matrix m γ e and the element mass matrix m e out of various possible choices for the definition of the numerical flux f q in eq 4 we adopted the rusanov flux we chose rusanov for simplicity and efficiency during the code development we compared hll hllc and rusanov for high order approximations rusanov is often associated with over dissipation however at 4th order or greater we observed indiscernible differences as reported in appendix a the laplace operator of viscosity is approximated using the symmetric interior penalty method the reader is referred to arnold 1982 for details on its definition 3 2 time integration eq 3 is integrated in time by a fully implicit runge kutta scheme that corresponds to the implicit part of the implicit explicit scheme used in giraldo et al 2013 see also butcher and chartier 1999 the method coefficients in standard a a i j b c tableaux form are the following 5 0 0 2 2 1 1 2 1 1 2 1 2 2 1 2 2 1 1 2 1 4 1 2 2 1 2 2 1 1 2 c a b scheme 5 is a three stage second order explicit first stage singly diagonally implicit runge kutta esdirk scheme this scheme has desirable accuracy and stability properties i all stages are second order accurate ii it is stiffly accurate and l stable and iii it is strong stability preserving gottlieb et al 2001 with coefficient of 2 these properties allow us to take large time steps with high accuracy as well as alleviate the instability issues associated with sharp solution gradients gottlieb et al 2001 the two dimensional test presented later in this paper demonstrated to be the most demanding in terms of stability constraints method 5 allows us to gain up to one order of magnitude in terms of maximum admissible advective courant number when compared to an explicit method explicit part of ark3 kennedy and carpenter 2003 in particular the explicit four stage runge kutta solution of the solitary wave against one isolated obstacle described in section 5 5preserved stability for up to courant 0 21 using both cg and dg approximations although we were not able to use arbitrarily large time steps with the esdirk with the current implementation we will address this issue in a future work we resolved the same problem at courant 1 8 schemes with a subset of these properties are employed by kärnä et al 2011 and shown to be robust in this context computationally at each of the two implicit stages we have to solve a nonlinear equation g q i 0 where q i are the stage values i 2 3 and g is a linear combination of stage slopes with coefficients given in 5 we do so by using newton iterations with a stopping criterion based on the relative decrease in the residual that is stop at iteration k if g q k i g q 0 i t o l n at each newton iteration we have to solve a linear system j q k i q k 1 i g q k 1 i where j is the jacobian matrix of g q i we approximate the jacobian using directional finite differences and iterate with the generalized minimal residual gmres method which is effectively a jacobian free newton krylov method knoll and keyes 2004 the gmres stopping criterion is also based on the relative residual the first stage is explicit and equal to the last stage of the previous step effectively making it a two stage method which saves some computational time 4 the shock capturing scheme there are different ways to derive the viscous model described by eq 1 from the inviscid shallow water equations similarly to our previous work on the large eddy simulation of stratified atmospheric flows marras et al 2015 the current model builds on the separation of scales between grid resolved indicated as f x for any quantity f x and unresolved sub grid the unresolved scales are modeled via the shock capturing scheme at the core of this paper dyn sgs given an element ωe of order n and with side lengths δx δy of comparable size we define the following characteristic length 6 δ min δ x δ y n 1 the value of δ sets the size of the smallest resolvable scales in the same way as cut off filters do in large eddy simulation models the application of scale separation in the continuity equation 1a results in the presence of an additional term on the right hand side which is the artificial viscosity term that appears in eq 1 it is often debated whether artificial viscosity should be added to the continuity equation gerbeau and perthame 2001 guermond and popov 2014 pasquetti et al 2015 should the discrete viscous operator not be conservative artificial viscosity must not be added to the continuity equation however by relying on spectral elements with integration by parts of the second order diffusion operator the discrete viscous operator is conservative as shown in guba et al 2014 the numerical demonstration of the conservation properties of the current approximation can be also found in our previous work marras et al 2015 for the euler equations to get a sense of how necessary a stabilized continuity equation may be we will show the results in section 5 5 scale separation in the momentum equation yields a new equation that includes the gradient of the quantity 7 τ s g s h μ s g s u the coefficient μsgs is defined element wise and is given as 8 μ s g s max 0 0 min μ max ω e μ res ω e where 9 μ res ω e δ 2 max r h ω e h h ω r h u ω e h u h u ω and 10 μ max ω e 0 5 δ u g h s ω e in 9 10 indicates the spatially averaged value of the quantity at hand over the global domain ω the norms ω at the denominator are used to preserve the physical dimension of the resulting equation and r h and r h u are the residuals of the inviscid governing equations at each time step the residuals are known and given by 11a r h h t h u 11b r h u h u t h u u g 2 h 2 h b 2 i g h s h b i the residuals make the artificial viscosity mathematically consistent which means that the residual based viscosity vanishes when the residual is zero the quantity u g h s in 10 is the maximum wave speed we would like to emphasize the necessity for the physically correct dimensions of the viscosity coefficient this is an important issue that is seldom accounted for in the design of artificial viscosity methods for stabilization purposes as underlined in marras et al 2015 the most important aspect of dyn sgs for high order solutions is its ability to prevent spurious oscillations without the necessity of additional slope limiters and as much as possible low pass filters this fact is even more important when we rely on dg to solve the shallow water equations on wet dry surfaces as pointed out in kesserwani and liang 2011 an improper and unnecessary use of the limiter coincidentally may even destroy the conservative properties of the dg predictions rather than improving them in this paper we concentrate on using dyn sgs to remove spurious oscillations in the proximity of the propagating bores and see how much we can rely on it without depending on auxiliary filters and limiting mechanisms this model is based on a second order laplacian operator it is hence not expensive and does not add additional burden in parallel 5 numerical tests we verify the correctness of our model through a set of one and two dimensional tests the code is designed to run in two dimensional mode only for this reason the one dimensional tests are set up with one element and periodic boundaries in the second dimension we begin the set of tests by verifying that dyn sgs preserves the well balanced properties of the solution of a lake at rest over a submerged hump this test is meant to identify whether dyn sgs impacts the hydrostatic balance when the lake should remain at rest at all times in 1d we start by verifying the hydrostatic balance of a lake at rest over a hump we continue with the solution of the steady state flow over a hump that triggers a shock followed by the test of a moving shock triggered by a dam break on a wet surface also known as sod s tube problem in the literature of gas dynamics and finally the problem of an oscillating lake in a parabolic bowl in 2d we analyze a test that includes all of the features of the previous 1d tests but add the complexity of the multidimensional interaction of moving wave fronts 5 1 well balanced lake at rest over a submerged hump to assess the effect of the dyn sgs on the well balanced property of the shallow water solver we follow test 3 1 1 of delestre et al 2013 and simulate a lake at rest over a hump the velocity should remain zero as time progresses the one dimensional domain measures 25 m in length the bathymetry is given analytically by h b x 0 2 0 05 x 10 2 if 8 x 12 m 0 otherwise in fig 1 we show the spatial distribution of momentum obtained with cg and dg the solution is hydrostatically balanced and does not degrade as time progresses as visible from the almost flat time series of u that ranges between o 1 10 15 and o 1 10 14 in fig 2 this result confirms that the proposed de aliasing scheme does not act when the solution is exact we can then proceed with those tests that involve steady state and transient flows 5 2 steady state transcritical flow over a hump the steady flow over a hump has been often used as a benchmark for shallow water solvers since goutal and maurel 1997 vázquez cendón 1999 the domain and bathymetry are the same as in the previous test however we fixed the value of 18 m 2 s 1 to the incoming flux at the left boundary and a 0 33 m water depth in outflow we initialized a zero velocity field with initially uniform water depth of 0 33 m these conditions are such that the flow develops a hydraulic jump in the immediate proximity of the hump downslope in the cases where the numerical solution preserved stability the flow reached steady state within a few time steps nevertheless to make sure that the solution preserved stability at all times we executed all tests to a final time t f 1500 s which is far beyond the initial transitory behavior during the first few seconds for direct comparison against the exact and numerical solutions presented in delestre et al 2013 using 500 computational cells we subdivided the domain into 125 elements of order 4 giving an effective resolution δ x 0 05 m we plot the stabilized and non stabilized water surface solutions for the cg and dg approximations in fig 3 where the exact solution obtained with swashes delestre et al 2013 is superimposed on the numerical ones as expected the non stabilized cg solution explodes almost immediately during the first few time steps the strong discontinuity triggers oscillations that propagate across the entire domain the same behavior occurs with and without either a low pass spectral filter or a slope limiter the problem is immediately mitigated by the addition of dyn sgs the dg solution on the other hand loses stability only in the case when neither the limiter nor dyn sgs are used the unstable dg solution is not shown when the limiter is activated stability is recovered although the possibly incorrect tuning of it deteriorates the solution accuracy as is visible from the curve tagged as dg limiter in the figure unlike dyn sgs which is an integral part of the governing equations the limiter is a post processing tool applied at the end of every time step if dyn sgs has cured any instabilities along the simulation the limiter will have no effect on the solution unless possible under and overshoots not previously removed by diffusion are still present this explains why the solutions tagged as dg sgs limiter and dg sgs no filter no limiter show no discernible differences we quantify the absolute error of water surface with respect to the exact solution in fig 4 fig 5 shows that the velocity field oscillations are cured by dyn sgs similarly to the ones of the water surface it is visible from figs 5 and6 that the momentum specific discharge is steady throughout the domain see caviedes voullième and kesserwani 2015 and is not affected by dyn sgs this is in spite of the very small and localized oscillation of the dg solution in the close proximity to the shock 5 3 dam break we study the problem of a dam breaking on a wet surface stoker 1957 in the 1d domain ω x 5 5 m with solid boundaries this particular problem does not involve a wet dry surface and hence allows us to only rely on dyn sgs for stabilization purposes for this reason this test is useful to isolate the action of dyn sgs alone in the proximity of strong fronts this special case of a riemann problem gives rise to the propagation of a rarefaction wave depression that moves leftward towards the deep water and a shock wave bore that moves rightward into a shallow water region given the water depths hl and hr on the left and right of the dam initially centered at x 0 0 m the initial water level of the problem is given by h x 0 h l 3 m if x x 0 h r 1 m if x x 0 whereas velocity is zero everywhere the exact solution to this problem can be computed with the method of characteristics see e g toro 2001 it is given in delestre et al 2013 as 12 h x t h l if x x a t 4 9 g g h l x 2 t 2 if x a t x x b t c m 2 g if x b t x x c t h r if x x c t where x a t x 0 t g h l x b t x 0 t g h l 3 c m x c t x 0 t 2 c m 2 g h l c m c m 2 g h r and c m 4 2585 m s 1 fig 7 shows the exact and numerical solutions at t 0 1 s and t 0 5 s the numerical solutions are computed using cg and dg with and without artificial viscosity neither computation uses filters or limiters so that we can isolate the effects of dyn sgs on the solution without dyn sgs the cg solution loses stability almost immediately in the case of dg the gibbs oscillations triggered by the moving bore propagate upstream as the front moves these modes are removed by including dyn sgs to the mass and momentum equations in the case of momentum figs 8 and 9 show the stabilizing effect of the dynamic viscosity because we added artificial viscosity to the continuity equation we verify that the model did not violate mass conservation as we mentioned in the introduction the use of diffusion in the continuity equation is often an issue of disagreement among researchers we demonstrated in marras et al 2015 that mass can be conserved for the euler equations when dyn sgs is applied in fig 10 we plot the evolution of the relative mass loss for the dam break problem the relative mass loss is defined as 13 m t loss x h x t h x t 0 d x x h x t 0 d x in the figure we observe that mass loss is minimal when dg is used although it is small and lies in the proximity of machine precision conservation worsens for cg this finding agrees with kopera and giraldo 2015 although it was proved in that paper that cg and dg should be equally conservative to avoid compounding roundoff errors in the computation of mass error we use a pairwise summation algorithm to add up mass contributions from all grid points kopera and giraldo 2015 in a regular sum operation we add a big number of contributions one by one which eventually results in adding a relatively small number to a big partial sum in other words the sum s a 1 a 2 a n consists of s a 1 a 2 followed by s s a 3 and so on to s s a n for a large number of these summations the partial sum s eventually becomes much larger than the contributions ai which hence lead to important roundoff errors in the pairwise summation algorithm we add two similar numbers at a time and then recursively add the partial results in the same fashion the computation of s is split into s 1 a 1 a 2 s 2 a 3 a 4 s n 2 a n 1 a n and then recursively the partial sums are added in the same way to form the total sum s with this approach we always add numbers of similar magnitudes which significantly reduces roundoff errors this algorithm is key if incorporated within algorithms that are expected to conserve mass up to machine precision 5 4 1d parabolic bowl to measure the convergence rate of the model we compare the computed solutions against the analytic solution of the flow in a one dimensional parabolic bowl gallardo et al 2007 thacker 1981 the parabolic topography is defined as 14 h b x h 0 1 a 2 x 2 0 5 where h 0 2 m and a 1 in ω x 1 1 m the initial velocity is u 0 m s 1 and the water surface begins to oscillate due to gravity only the solution is computed using 16 32 64 and 128 elements of order 4 figs 11 13 show these solutions obtained with and without dyn sgs for cg and dg the contribution of the artificial viscosity is evident at all resolutions by looking at the detailed views in the figures in the low resolution momentum plots bottom left and right in fig 14 spurious peaks are evident in the regions x 0 5 and x 0 5 this is happening within partially dry elements the velocity in such elements is forced to zero only on the dry nodes as the grid is refined the non stabilized solutions behave sufficiently well in spite of minor oscillations that are immediately removed by the addition of viscosity it is evident that the dg solution outperforms the cg solution in all cases in terms of stable water surface and momentum see momentum in fig 14 far from the wet dry front we note that dynamic viscosity is not always sufficient to stabilize the wet dry interface and that we still have to apply the limiter by xing et al 2010 when the mean mass value becomes negative here we do not analyze the ramifications of our joint usage of dynamic viscosity and a limiter in detail we leave this question for future research although we do not investigate advanced inundation schemes in this paper to be able to solve this problem we add a relatively small layer of water with zero velocity in the regions that should be dry it is evident from the detailed plot in the right column of fig 13 that this approach is not behaving correctly it does negatively affect the wet region in the proximity of the front we limit ourselves to underline the need for a better and robust approach to wetting and drying we will need to address the interaction of dyn sgs with the inundation scheme of choice and we will do so in a future study to quantify the difference between the stabilized and non stabilized solutions we plot the normalized l 2 error norms in fig 15 in the figure we notice that the slope of the stabilized cg solution is greater than its non stabilized counterpart although the same does not occur in the case of dg by observing that both cg and dg seem to require artificial viscosity for a better solution as discussed above we require further analysis on this point to find a possible reason for this behavior we leave this for a future paper where we are planning on analyzing the effect of different inundation schemes as well 5 5 2d solitary wave run up and run down on a circular island a solitary wave run up on a circular island was studied in briggs et al 1995 in this example the initial wave is modeled via the following analytic definition by synolakis 1987 15 η x 0 a h 0 sech 2 γ x x c where a 0 064 m is the wave amplitude x c 2 5 m h 0 0 32 m is the initial still water level and 16 γ 3 a 4 h 0 the island is a cone given as 17 h b 0 93 1 r r c if r r c where r x x c 2 y y c 2 r c 3 6 m and is centered at x c y c 12 5 15 m the cone is mounted on a flat bathymetry the fluid is confined within four solid walls to understand how the proposed adaptive viscosity and numerical approximation depend on the grid we ran the simulation at the four resolutions δx 0 05 0 10 0 20 0 40 m fig 16 shows that the stabilized dg solution is converging to the same solution and the main features of the interacting waves are reproduced almost equally across the four grids certainly the 0 40 m grid spacing is the most dissipative although it is encouraging to see how the important features resolved at 5 cm are still well represented on the coarsest grid the same observation applies to the cg solution plot not shown the instantaneous perspective views of the non stabilized and stabilized cg 4th order solutions of the water surface are plotted in fig 17 at t 42 s in 42 s the wave has crossed the domain back and forth several times in spite of this the stabilized and non stabilized fronts appear to be in the same positions the de aliasing approach by means of dyn sgs removed the high frequency gibbs modes without affecting the dispersion of the wave fronts this result is better visualized in the 1d projection of the solution on the plane y 0 plotted in figs 18 and 19 the spurious modes that characterize the water surface in the proximity of the sharpest wave front are fully removed by dyn sgs without noticeably weakening the front sharpness this result agrees with the application of dyn sgs to non linear wave problems with strong discontinuities as previously shown in marras et al 2015 figs 16 and 17 for the solution of the burgers equation by construction the jump conditions in the numerical flux rusanov hll etc offers an inherent dissipation to dg in the same way that it does to finite volume approximations in simple words the jump terms constitute viscous terms that strengthen as the size of the discontinuity increases this effect is visible in fig 19 the non stabilized dg solution shows no oscillations except for at most some minimal under and over shoots this implies that the numerical residual of the dg approximation is so small that the effect of the shock capturing model reduces to a minimum value this explains why the inviscid and viscous dg solutions look similar because there is no flux computation in the case of continuous spectral elements and because there are no other operations that would contribute to numerical diffusion unless an explicit diffusion term is added via supg vms dyn sgs etc cg does not have the inherent stabilization that dg has in fig 20 we compare the non stabilized against the stabilized cg solutions for velocity we show the same comparison for dg in fig 21 unlike for the case of the water surface for both cg and dg we notice a great difference between the stabilized and non stabilized solutions however this is not telling us anything about the correctness of the solution since this two dimensional problem is non linear has multiple interacting waves and does not have an analytic solution for the velocity field on the contrary what we can tell is that the effect of dyn sgs on the cg solution is consistent with its effect on the dg solution the stabilized cg and dg solutions plotted in the right plots of figs 20 and 21 show similar wave fronts this is indicative of a correct implementation of the unified cg dg framework this important result is telling us that although h is well behaved with dg aliasing could be affecting momentum while sgs is de aliasing the solution this is only a conjecture but aliasing will occur if we do not filter over integrate or stabilize theoretically two numerical methods of equal accuracy should produce identical results under the constraint of zero numerical error this is not practically true and small dispersion errors may be still expected as long as they are sufficiently small this test is meant to demonstrate that dyn sgs does not damp the solution as time evolves this test ran for 50 s which is an important requirement for dissipation based stabilization methods we show the instantaneous energy spectra of the stabilized and non stabilized cg and dg solutions at t 50 s in fig 22 the difference between the cg and dg curves is striking the viscous and inviscid dg spectra overlap almost fully and show approximately the same decay across the entire spectrum from a 5 3 slope in the inertial sub range to a 3 slope in the dissipation wave numbers refer to boffetta and ecke 2012 for a review on two dimensional flows and their energetics this is only true as long as the resolution is not too coarse especially so in the case of cg at very coarse resolutions δx 0 4 m neither cg or dg can avoid energy from building up in the highest modes unless artificial viscosity is used the inherent viscosity of dg is no longer sufficient to prevent this as already mentioned this is telling us that we need de aliasing and dyn sgs will do this without affecting the energy cascade or the convergence rates we stated above that μsgs is only active where the equation residuals i e gradients are important in the case of water waves this occurs in the proximity of the wave fronts in fig 23 we plot μsgs to show its spatial structure and its evolution between t 0 and t 50 s this plot shows how viscosity is equally zero away from the fronts and only activates where really necessary it may not be so obvious to achieve this by using an artificial viscosity that is not residual based to provide a visual correlation between μsgs and the wave features in fig 24 we plot the stabilized spectral element solution of the water surface at a grid resolution δx 0 05 m 6 conclusions we presented a shock capturing scheme or dynamic sub grid scale artificial viscosity that we call dyn sgs to stabilize the high order numerical solution of the shallow water equations via continuous and discontinuous spectral elements cg dg by numerical examples we demonstrated that this model removes the gibbs oscillations that form in the proximity of sharp wave fronts while preserving their strength this is possible because of the residual based definition of the dynamic viscosity coefficient for coarse grids it prevents energy from building up at small wave numbers this aspect is important to preserve numerical stability of tsunami simulations over large domains discretized with coarse grids the model has no user tunable parameter which is of great advantage when the model is to be used by an external user when applied to the continuity equation mass conservation is not affected this shock capturing model works especially well for bores propagating on wet surfaces but is often not sufficient to stabilize velocity at the wet dry interfaces where a thin layer of water still had to be added and in some cases supported by additional limiting further work on the interaction between shock capturing limiters and riemann solvers needs to be done we did not address it in this study as it requires a thorough analysis of its own it is important to underline that the natural built in viscosity of dg may be large enough that the contribution of dyn sgs is at times irrelevant when this happens the dynamic viscosity detects it from the residual and hence limits its own strength nevertheless we have shown that it is often the case that the inherent dg viscosity alone cannot prevent instabilities from forming and propagating even if the solution does not break as it would do in the case of cg it still requires the support of dyn sgs for de aliasing a stable solution does not mean an accurate solution although the results show that dg is superior to cg we show results for both methods because many researchers use cg and it is not yet clear which method is superior in terms of robustness and efficiency see abdi et al 2017 for more on these aspects acknowledgments the authors would like to acknowledge the contribution of haley lane who implemented the one dimensional version of the wetting and drying algorithm used in this work the authors would also like to acknowledge karoline hood who tested the correctness of the implicit solver in her nps master s thesis hood 2016 the authors are also thankful to prof fringer and dr rogers for discussions regarding coastal flows and to stephen r guimond for providing his functions to compute the energy spectra fxg acknowledges the support of the onr computational mathematics program and fxg and emc acknowledge the support of afosr computational mathematics appendix a choice of the riemann solver rusanov hll or hllc in the selection of the riemann solver we stated across the paper that we chose the rusanov flux for simplicity in this appendix we show that for high order elements 4th or greater the choice is not consequential rusanov hllo for hll original and hllc for hll contact see toro 1999 for details can be used interchangeably for problems with strong gradients to give the same solution as expected the results are slightly different nonetheless the effect of rusanov hllo and hllc on the solutions are comparable and neither one of them negatively affects the diffusion or dispersion of the moving front of all rusanov is the simplest and hence the most popular although we acknowledge the need for a proper comparison across a wider range of approximation orders especially so in the case of approximation orders lower than four we leave it for a future study we tested the three solvers on the dam break problem fig 25 and on the steady state transcritical flow over a c 0 bathymetry fig 26 for both tests the results demonstrate that rusanov is indeed as precise as hll and hllc for the high order solution of the shallow water equations 
843,headwater stream networks expand and contract in response to changes in stream discharge the changes in the extent of the stream network are also controlled by geologic or geomorphic setting some reaches go dry even under relatively wet conditions other reaches remain flowing under relatively dry conditions while such patterns are well recognized we currently lack tools to predict the extent of the stream network and the times and locations where the network is dry within large river networks here we develop a perceptual model of the river corridor in a headwater mountainous catchment translate this into a reduced complexity mechanistic model and implement the model to examine connectivity and network extent over an entire water year our model agreed reasonably well with our observations showing that the extent and connectivity of the river network was most sensitive to hydrologic forcing under the lowest discharges qgauge 1 l s 1 that at intermediate discharges 1 l s 1 qgauge 10 l s 1 the extent of the network changed dramatically with changes in discharge and that under wet conditions qgauge 10 l s 1 the extent of the network was relatively insensitive to hydrologic forcing and was instead determined by the network topology we do not expect that the specific thresholds observed in this study would be transferable to other catchments with different geology topology or hydrologic forcing however we expect that the general pattern should be robust the dominant controls will shift from hydrologic forcing to geologic setting as discharge increases furthermore our method is readily transferable as the model can be applied with minimal data requirements a single stream gauge a digital terrain model and estimates of hydrogeologic properties to estimate flow duration or connectivity along the river corridor in unstudied catchments as the available information increases the model could be better calibrated to match site specific observations of network extent locations of dry reaches or solute break through curves as demonstrated in this study based on the low initial data requirements and ability to later tune the model to a specific site we suggest example applications of this parsimonious model that may prove useful to both researchers and managers keywords river corridor hyporheic solute tracer riparian network stream 1 introduction the emerging river corridor perspective considers the surface stream hyporheic zone riparian zone hillslope and aquifer as a continuum exchanging water solutes energy and materials across a range of spatial and temporal scales e g harvey and gooseff 2015 empirical studies have addressed dynamic connectivity along the river corridor at the network scale e g godsey and kirchner 2014 gregory and walling 1968 costigan et al 2016 while others have documented the changes in ecosystem services and functions that result from connectivity in the riparian corridor boulton et al 1998 brunke and gonser 1997 krause et al 2011 merill and tonjes 2014 us epa 2015 however despite empirical advances we lack an accurate framework to predict the temporal dynamics of hydrologic connectivity along the river corridor thus an overarching objective of this study is to predict spatial and temporal patterns of hydrologic connectivity along the river corridor at the network scale to achieve this objective we synthesize our understanding of how hydrologic forcing and geologic setting interact to control dynamic exchange processes in the river corridor convert that understanding into a numerical model simulating the dominant processes in the river corridor and implement the model at the network scale using readily available data as a result we derive and calibrate a mechanistic representation of dynamic hydrologic connectivity along the river corridor hydrologic connectivity between the river corridor and its catchment along the length of the river corridor results from the geologic setting interacting with hydrologic forcing ward et al 2012 2014 2016 the geologic setting is static at the time scales of interest here and includes the geologic constraint of the valley e g d angelo et al 1993 stanford and ward 1993 ward et al 2012 2016 wondzell 2006 wright et al 2005 channel and streambed morphology kasahara and wondzell 2003 see also review by boano et al 2014 and multi scale heterogeneity in hydraulic conductivity of the valley floor sediment e g packman and salehin 2003 ryan et al 2004 salehin et al 2004 sawyer and cardenas 2009 vaux 1968 ward et al 2011 hydrologic forcing includes the lateral inflows to the valley bottom from either hillslope sources or from deeper groundwater and stream discharge all of which vary with time and can thus lead to highly dynamic changes in connectivity in mountain streams the steep valley walls constrain the river corridor such that the entire valley bottom stream hyporheic zone riparian zone often can be collectively considered the river corridor interactions between hydrologic forcing and geologic setting give rise to river corridor exchange across a wide range of spatial and temporal scales driven by mechanisms including after kaser et al 2009 turnover exchange e g elliott and brooks 1997a 1997b packman and brooks 2001 diffusion of turbulent momentum into the streambed e g malzone et al 2016 packman and bencala 2000 hydrostatically driven exchange e g gooseff et al 2006 harvey and bencala 1993 kasahara and wondzell 2003 and hydrodynamic pumping into the streambed and banks e g elliott and brooks 1997a 1997b wörman et al 2002 most studies examining exchange processes either assess one or just a small number of potential controls and most commonly within a short reach during baseflow conditions rarely are multiple controls studied over larger spatial and temporal scales consequently the influence of individual factors are well understood at small spatial scales but substantial challenges remain in aggregating the effects of multiple factors within a very long reach or an entire network the critical scales at which resources are managed and predictions are desired ward 2015 harvey and gooseff 2015 the most widely applied strategy to translate process understanding in the river corridor to the reach or network scale uses reduced complexity modeling bencala and walters 1983 first developed their transient storage model which was fit to solute breakthrough curves to estimate advection dispersion and transient storage at the reach scale this reduced complexity modeling strategy eschewed the extensive parameterization required for distributed hydrologic models but provided a mechanistic interpretation of processes that was absent from fully empirical models while the transient storage model has been applied as a basis for understanding both short reaches and whole networks fernald et al 2001 schmadel et al 2014 stewart et al 2011 the model formulation is not able to simulate the dominant processes of mountain systems where down valley subsurface flow is important castro and hornberger 1991 kennedy et al 1984 ward et al 2016 additionally the transient storage model was never intended to represent dynamic network expansion and contraction nor to accommodate spatially intermittent flows a second approach to upscaling river corridor exchange uses empirical relationships between catchment topology and river corridor processes based on field experiments covino et al 2011 mallard et al 2014 or model experiments gomez velez et al 2015 gomez velez and harvey 2014 kiel and cardenas 2014 these empirical approaches are readily implemented based on observable metrics e g drainage area stream discharge sinuosity streambed grain size however empirical approaches are site specific in nature with limited transferability across geologic settings and even to differing flow conditions studies based on model experiments assume the model processes simulated at one scale are the dominant processes across the continuum of nested scales of exchange in the river corridor third distributed or top down hydrologic models build upon generalized knowledge representing river corridor processes spanning spatial and temporal scales frei et al 2009 yu et al 2016 a key strength of distributed models is their ability to represent heterogeneity which may be important to determining intermittent connections between streams and their aquifers fleckenstein et al 2006 however distributed models require extensive parameterization and calibration limiting their ability to be rapidly applied on the landscape while each of the existing approaches have been successful in advancing our understanding of specific mechanisms at a given spatial or temporal scale these approaches all have limited ability to represent river corridor exchange in a way that is mechanistic fully dynamic and representative of the dominant processes within the network therefore we suggest that a new predictive framework is needed one that provides a mechanistic understanding of hydrologic connectivity along the river corridor reflects the hydrologic dynamics that lead to time variable connectivity and would be readily transferable and scalable with modest data requirements we propose a dominant process approach similar to grayson and blöschl 2000 this approach recognizes that reduced complexity models will necessarily omit some processes in favor of representing those which are considered most important in a catchment smith et al 2013 as such we limit the over parameterization of distributed models and avoid their problems with non unique solutions e g beven 2006 bredehoeft and konikow 1993 cardenas and zlotnik 2003 oreskes et al 1994 poeter 2007 wondzell et al 2009a here we closely follow the approach of smith et al 2013 in identifying dominant processes based on our experience in the field developing a perceptual model to explain our observations and then implementing this perceptual model as a reduced complexity model that simulates hydrologic processes at the scale of the river network our primary objective is to predict spatial patterns and temporal dynamics of hydrologic connectivity along the river corridor at reach to network scales i e 100s of meters and longer a secondary objective is to develop an approach that is transferable scalable easily applied based on limited data requirements and is flexible enough that increased data collection could be used to improve and refine the model at sites of interest while costigan et al 2016 proposed a model of general meteorologic geologic and land cover trends that would be related to frequency of intermittency their conceptual model does not address the dynamic transitions that occur between flow states instead focusing on long term trends specifically we seek to answer the question how do geologic setting and hydrologic forcing combine to result in dynamic connectivity along the river corridor we hypothesize that geologic setting will be dominant during all baseflow conditions regardless of the actual discharge magnitude i e during steady high moderate and low discharge conditions void of precipitation conversely we hypothesize that network expansion and contraction will be dominated by hydrologic inputs to the system during highly dynamic periods such as storm event responses that will cause rapid expansion and contraction of the network independently of the structure of the valley bottom to test these hypotheses we develop a reduced complexity model in the spirit of the dominant process approach the model is calibrated at scales of 100s of meters to a well documented solute tracer study and observed dry streambed locations and validated based on stream stage observations at the field site using these results we assess the dynamic interactions of hydrologic forcing and geologic setting noting the places and times where each control is dominant 2 background model development 2 1 site description the perceptual model presented here is based on extensive study of headwater mountain catchments in the western cascades oregon usa specifically the h j andrews experimental forest this site was selected based on the body of research documenting process dynamics in the river corridor of a mountain stream furthermore this site fits the geologic factors that costigan et al 2016 associate with increased intermittency including relatively large grain sizes steep riffle morphology impermeable lithology and small drainage areas in a highly dissected catchment this steep geologically confined mountain stream network is also complimentary to recent efforts to model connectivity in low gradient alluvial systems gomez velez et al 2015 gomez velez and harvey 2014 kiel and cardenas 2014 due to the high confinement of the valley bottom the river corridor in this system is functionally equivalent to the valley bottom which includes the stream hyporheic zone and riparian zone within the h j andrews experimental forest we selected the highly studied watershed 1 ws01 as a study location because the dynamics of river corridor exchange have been studied in greater detail than other sites fig 1 briefly this headwater catchment drains about 96 ha at the outlet stream gauge basin elevations range from 432 to 1010 m a m s l the catchment is highly dissected with steep valley walls and hillslopes forming v shaped valleys that are rapidly downcutting through oligocene and lower miocene aged volcanic bedrock the longitudinal slope of the valley floor averages 11 9 voltz et al 2013 in places the stream flows on exposed bedrock but along most of its length the valley bottom is covered in poorly sorted colluvium much of which was emplaced as landslide and debris flow deposits the depth of the colluvium ranges from 0 to at least 1 74 m the deepest penetration achieved during installation of riparian monitoring wells wondzell 2006 precipitation data were collected at the nearby h j andrews primary meteorological station about 0 5 km n of the gauge elevation 430 m a m s l further physical description of the h j andrews experimental forest and ws01 are available in a host of related publications dyrness 1969 swanson and james 1975 swanson and jones 2002 voltz et al 2013 ward et al 2016 wondzell 2006 wondzell et al 2009b 2 2 perceptual model of the river corridor in mountain streams we developed a perceptual model that explains dynamic expansion and contraction of the active channel network a perceptual model is a qualitative representation of the dominant hydrologic processes operating at a given field site integrating the processes that are known to be important based on field observations numerical simulations and a field based understanding of the system mcglynn et al 2002 1999 sivapalan 2003 wagener et al 2007 thus the model presented below is qualitative in nature but synthesizes the observations of the site in a cohesive framework this model is akin to a hypothesis explaining the interactions between geologic and hydrologic controls in the river corridor and is based on our current understanding developed over several decades of field studies at the site burt and mcdonnell 2015 fig 2 a the perceptual model posits that the river corridor can be described as two parallel interacting domains that transport water and solutes in the down valley direction via surface flows through the stream channel and via subsurface flows through the valley bottom ward et al 2016 this builds directly from bencala et al s 2011 notion that streams are dynamic expressions of the local groundwater system and is well aligned with the perceptual models of godsey and kirchner 2014 and whiting and godsey 2016 subsurface transport in the down valley direction is known to be an important mechanism in higher gradient stream networks castro and hornberger 1991 jackman et al 1984 kennedy et al 1984 several studies have found relatively constant transport in the subsurface attributing this primarily to an unchanging geologic setting e g hydraulic conductivity field major roughness elements bedrock constraints and valley width and a down valley hydraulic gradient set by topography voltz et al 2013 ward et al 2012 2014 2016 wondzell 2006 wondzell and swanson 1996 the primary mechanism of river corridor exchange in mountain streams is expected to be driven by hydrostatic pressure gradients wondzell and gooseff 2014 schmadel et al 2017 the down valley subsurface discharge is functionally controlled by down valley capacity or the ability of the subsurface to transmit water through saturated porous media in parallel the surface stream flow represents only the excess of down valley discharge that cannot be accommodated by the down valley capacity thus in stream discharge and transport can be highly dynamic in response to the stream while transport in the saturated subsurface remains relatively constant while subsurface down valley discharge is relatively constant in time it is spatially variable due to changes in the down valley capacity of the subsurface caused by changes in valley width colluvium depth slope or heterogeneity in hydraulic conductivity the concept of spatially contiguous down valley discharge is supported by the observed long term storage of ward et al 2013a in ws01 their study found significant mass losses from stream solute tracer studies concluding that the mass entered flowpaths that traveled down valley but remained in the subsurface additionally these flowpaths could not have been losses to a deeper groundwater aquifer because the river corridor is ultimately confined by intact bedrock inputs of hillslope water to the valley bottom can affect the extent of long term storage and these inputs vary in both space and time spatially inputs from the hillslopes to the river corridor are assumed to vary in proportion with the contributing upslope accumulated area uaa after jencso et al 2009 and corson rikert et al 2016 past studies in nearby catchments concluded that topography controls the transport of water from hillslopes to valley bottoms e g mcguire et al 2005 discharge in the valley varies in time and impacts river corridor exchange during storm events ward et al 2013a seasonal baseflow recession ward et al 2012 2016 and diurnal fluctuations driven by evapotranspiration from riparian zones and perhaps the lower hillslopes schmadel et al 2016 2017 voltz et al 2013 wondzell et al 2010 2007 the upper reaches of the main stem and south branch have surface flow during the winter and spring but portions of them are frequently dry during the summer months fig 1 we generally have not observed surface flow from convergent areas lateral to the main stem or south branch i e those areas identified as minor tributaries in fig 1 amatya et al 2016 the colluvium accumulated within these areas is generally too deep and porous for the relatively small drainage areas to support surface flow however there are weakly developed channels 10 30 cm wide that suggest surface flow does occur during major storms in two specific conditions 1 below bedrock outcrops where soils are quite shallow forcing flow to the surface and 2 high in the north east corner of the watershed where deep seated earthflows have created a drainage network around multiple small slumps where water may flow at the surface for much of the year these areas are notable in that surface flow may occur with very small uaa but they are always discontinuous to the channel network from which they are far removed 50 m from the simulated channel network because of that we do not consider them further in this study finally both evapotranspiration from and direct precipitation to the valley bottom and stream are omitted given the small plan view area of these landscape elements relative to the hillslopes 2 3 development of a mathematical model the dominant processes in the perceptual model were translated into a numerical model fig 2b subsequent sections describe the development of the surface and subsurface hydraulics and the solute transport components of the model which are formulated for one dimensional 1 d segments of the valley bottom with boundary conditions at the upstream end of each simulated segment 2 3 1 hydraulic model open channel flow was simulated using the continuity equation and kinematic wave routing 1 d a d t d q s t r d x q u p d x q d o w n d x 0 where t is time s x is the spatial coordinate along the valley bottom m a is the stream cross sectional area m2 qstr is the stream discharge m3 s 1 and qup and qdown represent gross up and downwelling flux m3 s 1 respectively net up or downwelling flux qnet m3 s 1 is qnet qup qdown we formulated the model using the gross exchanges to more accurately reflect the associated fluxes of solute after payn et al 2009 lateral inflows enter the model in the subsurface domain and represent either upwelling of valley bottom groundwater unlikely in our case of bedrock constraint but the term could be used for this flux in other settings or lateral inputs of hillslope water and influence the stream via the qup and qdown terms thus a term describing lateral inflows occurs only in the continuity equation applied to the subsurface domain eq 3 this formulation requires that lateral inflows to the simulated network do not consist of channelized overland flow if that were the case the simulated network should be expanded to include explicit simulation of any channelized flow at the surface we relate discharge and channel geometry using manning s equation 2 q s t r 1 n a 5 3 p 2 3 s s t r e a m 1 2 where n is manning s roughness coefficient unitless sstream is the down valley slope along the stream channel m m 1 the constant value of 1 in the numerator has associated units of m1 3 s 1 and p is the wetted perimeter m we approximate the stream geometry as a rectangular channel thus a by and p b 2y where b is the channel width m and y is the depth of flow in the surface channel m in the subsurface we solve the continuity equation for water as 3 d a s d t d q s u b d x q u p d x q d o w n d x q l a t d x 0 where as is the cross sectional area of the saturated portion of the subsurface m2 qsub is the down valley subsurface discharge m3 s 1 and qlat represents lateral inflows from the hillslopes into the valley bottom m3 s 1 defined as the unit inflow per drainage area qlat multiplied by the difference between uaa at the up and downstream ends of the segment all lateral inflows to the simulated network are assumed to occur in the subsurface surface streams can initiate and combine at junctions if the down valley discharge in a tributary exceeds down valley capacity qsub cap m3 s 1 darcy s law is used to calculate qsub as a function of valley width bvalley m depth of subsurface flow ysub m hydraulic conductivity k m s 1 porosity θ unitless and valley slope svalley m m 1 4 q s u b b v a l l e y y s u b k θ s v a l l e y we assume the slope of the valley bottom is a good approximation of the down valley hydraulic gradient ward et al 2016 2013b wondzell 2011 the maximum capacity of the subsurface to transport water in the down valley direction down valley capacity qsub cap occurs when ysub t where t is the thickness of the valley bottom colluvium m colluvium dimensions are related to geometry as as bvalleyysub total down valley discharge qdv m3 s 1 is the sum of surface and subsurface discharges 5 q d v q s t r q s u b 2 3 2 solute transport model we solve for conservative solute mass in the surface using a volumetrically averaged mass balance for the stream 6 d v c d t q i n c i n q s t r c q u p c s q d o w n c where qin is the stream discharge from the upstream valley segment m3 s 1 cin is the stream solute concentration from the upstream valley segment g m 3 c is the stream solute concentration g m 3 and cs is solute concentration in the subsurface g m 3 the volume of water in the surface domain v m3 is calculated as 7 v s i n u o s i t y d x b y where sinuosity is the sinuosity of the stream calculated as the along stream distance in each segment divided by the length of the segment m m 1 for solute transport in the subsurface we use a similar formulation 8 d v s c s d t q s u b i n c s i n q s u b c s q u p c s q d o w n c q l a t c l a t where qsub in is the subsurface discharge from the upstream valley segment m3 s 1 cs in is the subsurface solute concentration from the upstream valley segment g m 3 clat is the concentration of lateral inflows from the hillslopes to the river corridor g m 3 and vs is the volume of water in the subsurface domain m3 calculated as the volume of void space filled with water 9 v s a s θ d x for this formulation we assume that all pore space is connected for transport of water and solutes and that the subsurface domain is well mixed within each spatial discretization 2 4 model implementation 2 4 1 model solution for interior and downstream segments the model equations presented above allow for spatially variable dynamic activation of surface flow and continuity in space given the total down valley flow and the amount that can be accommodated via the subsurface we simulated transport through the river corridor at the network scale for water year 2016 1 october 2015 through 30 september 2016 the model equations are implemented as a finite difference numerical solution along the river corridor discretized using a 5 m segment length up and downwelling fluxes qup and qdown are calculated at each model segment on the basis of two logical operators which operate to first assign all flow to the subsurface domain and then assign any flow exceeding qsub cap into the surface domain channel water balance studies in mountain streams note that gross exchange of water between streams and their subsurface often exceeds net exchange covino et al 2011 payn et al 2009 ward et al 2013b to represent the gross up and downwelling exchanges in the water balance we define the parameter qsubgrid m3 s 1 to increase exchanges of water between surface and subsurface domains within each model segment for net up or downwelling between the surface and subsurface domains three possible behaviors exist first for cases when the flow entering a model segment is greater than the down valley capacity i e qsub in qlat qsub cap net upwelling of the excess subsurface discharge is implemented 10 q d o w n q s u b g r i d 11 q u p q s u b i n q l a t q s u b c a p q s u b g r i d second for cases where the down valley capacity is larger than the inflows to the subsurface domain net downwelling is required to ensure the full down valley capacity is met before surface flow activates net downwelling is predicted for cases when qsub in qlat qsub cap if the subsurface can accommodate the total down valley discharge i e qin qsub in qlat qsub cap all of the down valley discharge is assigned to the subsurface resulting in a dry streambed exchange discharges are then 12 q d o w n q i n q s u b g r i d 13 q u p q s u b g r i d finally for cases of net downwelling i e qsub in qlat qsub cap where the subsurface cannot accommodate all of the down valley discharge i e qin qsub in qlat qsub cap stream discharge will occur vertical exchanges are then 14 q d o w n q s u b c a p q s u b i n q l a t q s u b g r i d 15 q u p q s u b g r i d in this implementation the down valley capacity of the subsurface is always filled before the stream channel activates 2 4 2 boundary conditions and initial conditions for all model segments initial conditions of qdv x t 0 c x t 0 and cs x t 0 are specified the logical tests described above are used to partition qdv x t 0 into qstr and qsub fractions at t 0 at the head of each channel fig 1 main stem south branch and all minor tributaries specified boundary conditions of qdv x xn t c x xn t and cs x xn t are required where xn is the upstream most or nth segment we specify c x xn t cs x xn t 0 and qdv x xn t based on area proportional discharge assigned from the gauge this specification means that lateral inflows from the hillslope to the valley bottom are all synchronized in time to the stream gauge and does not allow for heterogeneity in hillslope responses to precipitation input these simplifications are necessary to balance the desire for reduced complexity with the representation of processes occurring in the landscape for segments whose upstream end is the confluence of two tributaries the discharge is defined as the sum of the outflows from the two upstream segments the concentration is defined by conservative mixing of the two upstream tributaries with the time variable boundary conditions established the model equations are solved using a forward in time backward in space solution scheme which is computationally efficient and allows for an explicit solution of the model equations we implement adaptive time stepping allowing timesteps to grow or shrink by a factor of 4 depending on hydrologic and solute dynamics timesteps are limited in growth to constrain changes in discharge or concentration to less than 1 in a given timestep with minimum and maximum timesteps of 1 and 3600 s respectively 2 5 model limitations implementation of the perceptual model as a reduced complexity model necessarily simplifies the processes in the river corridor to represent dynamics at reach to network scales first this simplification does not capture the smaller scale flow paths that are associated with individual channel unit features smaller than 5 m in length instead the 1 d representation of the valley bottom focuses on larger scale down valley flow and in our model varies only in response to changes in valley width and longitudinal gradient as a result the spatial distributions of exchange fluxes or flowing status are not expected to have a high fidelity at representing individual features but are expected to be representative at reach and longer scales see section 3 4 for reach scale metrics therefore we consider it inappropriate to expect performance to match small scale patterns of intermittent flow that may develop because of individual features that are smaller than the spatial resolution of the model second the solute transport routine represents only advective processes along the stream with numerical solutions introducing a small amount of numerical dispersion the addition of longitudinal dispersion transient storage or sorption desorption dynamics e g after bencala and walters 1983 runkel 1998 would likely improve the representation of solute transport it is important to note however that we do simulate advective exchange between the surface and subsurface but at spatial scales larger than 5 m we also allow specification of surface subsurface exchange occurring at scales smaller than 5 m using the term qsubgrid but this term is treated as a constant across the entire network and thus cannot represent spatial variation in exchange processes driven by channel unit features smaller than the resolution of the model collectively surface subsurface exchange is commonly considered to be an important component of transient storage by contrast fine scale transient storage in the surface channel i e in pools and eddies is not simulated in our model because we expect surface subsurface exchange to dominate at the scales we are simulating representing in channel transient storage longitudinal dispersion and sorption desorption would come at a computational cost further several of these processes are likely sensitive to channel unit scale features that cannot be extracted from typical airborne lidar data so including these processes in the model would likely require much more detailed data on stream topography third the assumption that all pore water is well mixed and equally connected is limiting we acknowledge that the subsurface domain is likely not completely mixed over short timescales e g ward et al 2012 pores are recognized to range from fully connected to functionally disconnected from advective transport e g dual domain representations of porous media this simplification also omits heterogeneity in the hydraulic conductivity which has been shown to be an additional control on interactions between streams and their aquifers e g fleckenstein et al 2006 in cases where the subsurface domain is not well mixed this assumption causes the exchanged mass to mix with a larger volume of water the result is a slower equilibration between the stream and subsurface i e concentrations in the subsurface rise and flush more slowly than would occur in a system that was not well mixed we do not consider these processes to be sufficiently important to be included in the perceptual model outlined above and are thus not represented in the numerical model but acknowledge these processes may be important at other sites finally the numerical model simplifies all hillslope hydrology as 1 instantaneously synchronized with discharge observed at the gauge and 2 discharge is proportionally distributed on the basis of upslope accumulated areas both are oversimplifications of catchment hydrology and hydraulics and are areas for potential future improvement 3 methods the model derived above can be implemented using only a digital terrain model a single stream gauge at the outlet of the catchment and estimates of hydrogeologic properties the highest uncertainty will likely come in the estimation of a representative hydraulic conductivity because this parameter is expected to span orders of magnitude we suggest initial estimates based on any available data grain size distributions or modest field campaigns e g falling head tests in temporary piezometers or shallow wells could be used to better constrain this model parameter these modest data requirements are a key contribution of this relatively simple model again we emphasize that reduced complexity models are constructed to represent dominant mechanisms and interactions in a system of interest acknowledging that this comes at the expense of representing complexity and heterogeneity of some processes in the system in the following sections we detail how the model is parameterized using available data from our field site 3 1 model parameters specified for the study site implementing the model derived above requires analysis of stream valley and catchment topography to identify the drainage network the valley floors and the hillslope area contributing to each model segment we used a modified version of the topotoolbox schwanghart and kuhn 2010 schwanghart and scherler 2014 to analyze the 1 m lidar digital terrain model available for ws01 we selected a spatial discretization of 5 m segments along the river corridor briefly we applied the multidirectional flow routing algorithm seibert and mcglynn 2007 based on visual observations at the field site under high discharge conditions we defined a threshold of 3 ha for channel initiation i e all points where drainage area 3 ha are simulated as part of the river corridor we selected the threshold of 3 ha because we seldom observe channelized flow in locations draining this small of an area as a result the upper extent of each simulated tributary should have no overland flow and the model equations are used to predict the flow initiation point along each headwater we measured the valley width at 30 locations measuring from the stream centerline to the valley wall along a line perpendicular to the longitudinal axis of the valley break point visually identified in the field after jencso et al 2009 our topographic analysis showed that the floodplain margin between hillslope and valley bottom was approximated using an elevation 1 5 m above the streambed provided the best fit between widths extracted from the digital elevation model dem and our field observations using that threshold we discretized the stream network into 5 m segments and for each segment we extracted valley widths left and right sides valley slope stream channel slope and stream channel sinuosity we also calculated the lateral uaa along each side of the valley using topotoolbox schwanghart and kuhn 2010 schwanghart and scherler 2014 inflows to the valley bottom qlat m3 s 1 were calculated using an area weighted flow based on the ws01 gauge station for each segment the total lateral inflows were calculated as 16 q l a t δ u a a q g a u g e u a a g a u g e where δuaa is the change in uaa along the stream centerline in each model segment ha qgauge is the discharge at the ws01 stream gauge m3 s 1 and uaagauge is the uaa at the stream gauge about 96 ha the topographic analysis and area weighted assignment of lateral inflows are identical to recent work in the catchment corson rikert et al 2016 the gauge discharge data are used as published by the h j andrews experimental forest a summary of the specified or calibrated parameters are provided in table 1 3 2 model calibration recognizing the model limitations we define two calibration targets that represent reach scale behaviors to demonstrate reasonable representation of system processes 1 reach scale solute transport and 2 reach scale fraction of dry streambed these calibration targets will generate reach averaged best fit model parameters rather than spatially variable distributions closely following the approach of other reduced complexity models of headwater streams e g bencala and walters 1983 first we calibrated the model parameters t k and qsubgrid using a break through curve from a solute tracer injection from 2 august 2010 see voltz et al 2013 ward et al 2016 for details we simulated the tracer injection and compared observed versus simulated concentrations of tracer at two locations immediately downstream of the injection where complete mixing was assumed 166 m upstream of the ws01 gauge and at the ws01 gauge station itself we varied t from zero observed at bedrock outcrops to a maximum depth of 4 m this greatly exceeds the maximum penetration depth of 1 74 m observed when installing wells and thus allows for uncertainty between the refusal depth and impermeable bedrock this difference may represent for example a zone of weathered bedrock below the colluvium but still bounded by impermeable unweathered bedrock below we varied k across the range of values observed by kasahara and wondzell 2003 in ws01 and a nearby headwater catchment spanning 4 3 10 6 6 1 10 4 m s 1 finally qsubgrid was varied from 1 10 6 to 1 10 2 m3 s 1 based on observations at the field site for comparison ward et al 2013a found average gross stream to subsurface exchanges of about 3 5 10 3 m3 s 1 per 5 m of valley distance range 0 1 6 10 2 m3 s 1 median 2 7 10 3 m3 s 1 during a storm event using reach scale solute tracer studies thus the range spans nearly the complete observation set with a lower bound of 10 6 m3 s 1 rather than zero this first model calibration step was performed by uniformly sampling the distributions of k t and qsubgrid and varying the parameters jointly increasing resolution around the best fit parameters more than 1100 simulations were performed overall model fit was evaluated based on minimizing root mean square error rmse between the observed tracer breakthrough curve and simulations we selected minimizing rmse because this is analogous to the residual sum of squared errors used to evaluate model fits in inverse modeling of stream solute tracers e g runkel 1998 ward et al 2017 next we calibrated the model by comparing the observed versus simulated total length of dry streambed in the reach of stream between the gauge and the confluence of the main stem and south branch fig 1 the model formulation allows for computation of extremely small surface flows that would not be visually differentiated from a damp streambed or flow fully through the armored cobble layer on the bed in the field e g values of qstr 1 10 4 m3 s 1 these simulated discharges are numerically non zero but functionally non observable in the field thus we require a threshold to differentiate observably flowing from dry segments in the model output qlim we select the target of total reach scale dry streambed in acknowledgement that the reduced complexity model is not intended to represent small scale features nor their spatial distributions that would be observed in the field but instead to capture representative behavior for reaches 100s of meters and longer this target is also comparable to reasonably available field data for a site with limited characterization where available information may be based on visual inspection or personal knowledge that will typify applications lacking detailed site investigations e g anecdotal about 20 of the streambed is dry in late august on 25 may 2016 21 june 2016 04 july 2016 and 13 august 2016 we walked from the gauging station to the main confluence recording the locations of dry streambed at sub meter resolution using the specified parameters table 1 and those calibrated for the solute tracer k t qsubgrid we assessed the accuracy of dry streambed predictions to select an appropriate value of the discharge threshold to define surface flow qlim to maximize accuracy of predicting the total dry length observed in the study reach this calibration step tested more than 10 000 values for qlim and selected the value that minimize the error in predicted dry streambed length along the observed reach 3 3 model validation to validate the model we compared the flowing status predicted by the reduced complexity model with a similar dataset generated by combining a detailed survey with measured changes in stream stage in the reach spanning 95 626 m upstream of the gauging station we surveyed the elevation of the streambed and stream water surface at 1 0 m horizontal resolution and 0 01 m vertical resolution during conditions with qgauge ranging from 5 8 to 6 7 l s 1 fifteen pressure transducers were installed along the surveyed reach recording data every 15 minutes from 1 october 2015 to 2 september 2016 all loggers were installed in shallow wells to ensure they remained submerged all season even if water levels dropped below the streambed we constructed a spatially continuous water surface by calculating changes in the water surface elevation at each of the 15 sensors and then interpolating these changes to every model segment for each timestep this exactly follows the procedures described by schmadel et al 2017 we then extracted the stream stage relative to the streambed for each 5 m segment within the surveyed reach and assigned a status of not flowing for segments containing no surface flow partially flowing for segments with both surface flow and dry streambed and fully flowing for segments with active surface flow along the entire length of the segment we assess reduced complexity model performance by tabulating the frequency of correct predictions of flowing times and locations where constructed profiles and model results both indicate fully flowing status and correct predictions of not flowing times and locations where constructed profiles indicate either partially or not flowing status and the model predicts no flow we elect to include partially flowing status from the profiles as equal to not flowing status in the reduced complexity model because we expect the low discharges in a partially flowing segment would be below the calibrated qlim value 3 4 evaluation of model results spatial and temporal trends in connectivity model results were used to evaluate nine metrics describing the hydrologic connectivity for each river corridor segment we tabulated 1 the flowing status i e surface flow or no surface flow 2 subsurface discharge and 3 surface discharge every 10 minutes throughout the 1 year simulation period based on this information and the network topology we also tabulated 4 whether the surface flow was contiguous to the outlet i e if there was an unbroken connection of surface flow between a segment and the outlet using these metrics we next calculated 5 the total flowing length of the surface stream network 6 the total contiguous length of the surface stream network and 7 the drainage density flowing stream network length per catchment area for the flowing network after completion of the entire 1 y simulation we calculated 8 the probability of surface flow and 9 the probability of contiguous flow for each segment by dividing the number of timesteps with surface or contiguous flow by the total number of timesteps 4 results 4 1 model calibration validation overall the calibrated model predicted the tracer breakthrough curve observed in august 2010 with an rmse of 12 4 μs cm 1 after calibration we also assessed model predictions using r 2 0 86 comparing time series observations to calibrated model predictions mean arrival time for the in stream solute tracer timeseries observed 75 6 h modeled 66 3 h coefficient of variation for the in stream solute tracer timeseries observed 0 72 modeled 0 70 and skewness for the in stream solute tracer timeseries observed 1 13 modeled 0 66 based on the high r2 and low errors for mean arrival time and coefficient of variation we interpret that advection of the input tracer signal and its longitudinal spread are being accurately represented by the model the disparity in skewness corresponds to the acknowledged limitations of the solute transport model wherein only the advective transport processes are being considered the observed late time low concentration tails of the in stream timeseries which drive larger positive values of skewness are not being well fit by the reduced complexity model is expected given that longitudinal dispersion and in channel transient storage are not simulated next we used observations of dry streambeds to estimate qlim we did not observe any dry streambed during the may and june 2016 surveys in july 2016 we observed a total of 3 5 m of dry streambed at 5 locations range 0 5 1 m in dry length in august 2016 we observed 106 1 m of dry streambed across 26 separate locations range 0 4 26 9 m mean 4 1 m median 1 0 m at the time of the august 2016 observations the stream discharges in the model segments within the surveyed stream reach 0 m 650 m from the stream gauge ranged from 0 18 to 0 45 l s 1 however because our field observations recorded some of these segments as dry qlim must be greater than 0 18 l s 1 i e discharges of less than qlim were not observable as surface flow in the field furthermore because discharge at the gauge was measured between 0 32 and 0 45 l s 1 during the same period this also implies that qlim must be less than 0 32 l s 1 we searched possible values for qlim in this range at a resolution of 0 001 l s 1 comparable to the resolution of the gauge when the v notch weir is installed during the summer low flow period the best agreement for total dry streambed length in the segment spanning 0 759 m was found for qlim 0 221 l s 1 which results in a simulated 14 2 of the total length in dry streambed conditions compared to 13 9 observed in the field using this value of qlim the may and june 2016 simulation periods accurately predict 100 of the observed conditions in the field fig s1 for july 2016 we observed about 0 5 of the streambed to be dry less than the length of one model segment and the reduced complexity model predicts all segments flowing fully fig s1 while the simulated length of dry channel was similar to that observed at the reach scale the agreement in the spatial location of dry segments was quite poor we expected considerable disagreement between the model and the observations over short distances where small scale channel morphology like wedges of sediment accumulated above in channel logs would lead to local increases in sediment thickness or create variable deposition environments leading to substantial variability in saturated hydraulic conductivity as expected the model did not simulate many of the short dry segments we observed but it also simulated a long dry section between 600 and 750 m above the stream gauge whereas we observed large dry segments between 150 and 300 m the lack of agreement suggests that spatial patterning is being controlled by factors other than channel unit scale variations in morphology certainly large logs transported in debris flows can form large log jams with depositions several meters thick that extend more than 100 m upstream from the log jam we used a constant thickness of 0 75 m resulting from model calibration in a short tracer injection reach near the bottom of the watershed penetration depths of 41 wells located within that reach show that the sediment thickness averages only 1 m and in early summer with qgauge 34 l s 1 the saturated thickness averages 0 48 m it is likely that sediment thickness at other locations would be substantially deeper or shallower than the best fit reach scale value that was calibrated using a constant thickness would lead to the model simulating dry channels in locations where the actual sediment was thinner than 0 75 m or wet channels in locations where the actual sediment is thicker than 0 75 m note that qsub cap is relatively constant from 750 m down to the mouth of the watershed whereas uaa and q both nearly double over this distance thus small overestimates of sediment thickness at the top of this reach would readily result in the model simulating a dry channel where one may not be observed conversely limiting sediment thickness to only 0 75 m lower in the reach where discharge is much higher would make it unlikely that the model would simulate a dry segment finally we compared the predictions of the stream status flowing or dry to water surface profiles interpolated from 15 pressure transducers located in the lower 650 m of the main stem channel in total we compared 99 model segments spanning 32 443 timesteps that comprise approximately 3 2 million points figs s2 and s3 overall the reduced complexity model correctly predicted about 2 6 million flowing conditions about 81 9 of all points figs s2 and s3 and 434 576 dry streambed conditions about 13 5 of all points figs s2 and s3 the reduced complexity model incorrectly predicted 145 886 points about 4 5 of all points figs s2 and s3 based on more than 95 agreement between the model predictions and validation data we are encouraged to interpret the model as a reasonable description of the dynamics in the system overall model performance is generally strongest under higher discharge conditions one key limitation of the model is the spatial resolution limits the simulation of segments that are partially flowing while the network scale metrics are reasonably predicted the spatial organization is generally not well predicted by the model figs s1 s3 because of the assumed spatial homogeneity of model parameters the model could be further tuned by making t and k spatially variable however collecting spatially explicit data on sediment depth in the valley floor throughout the stream network would be a daunting task but more importantly adding substantial complexity to the model just to improve the model fit runs counter to the modeling philosophy that guides this effort that is to develop a highly transferable model that can be parameterized using readily available data to simulate dominant hydrological processes within a large stream network we recognize that this simple model is far from perfect still we argue that it represents the dominant hydrologic processes operating along the length of the stream network in this watershed 4 2 spatial trends in network scale hydrologic connectivity the study network is comprised of 2825 m of stream channel 3 ha channel initiation threshold equivalent to a channel density of 2 9 km 2 valley topography topology slope and sediment characteristics result in an average down valley capacity qsub cap of 4 6 10 2 l s 1 range 1 2 10 3 3 7 10 1 l s 1 median 3 7 10 2 l s 1 fig 3 a since network average values were used for t k and θ this variation reflects the spatial variability in down valley slopes and valley bottom widths in along the river corridor the probability of surface flow peaks at about 99 3 at the outlet of ws01 fig 3c the probability of surface flow decreases approximately linearly with distance to 93 0 at the confluence of the south branch and main stem the probability of surface flow decreases abruptly above the confluence in both branches due to the step decrease in tributary uaa fig 3b in both branches probability of surface flow remains at or about 70 to a distance of about 1100 m upstream from the outlet about 330 m upstream of the confluence sharp changes in the probability of surface flow occur at locations where an increase in qsub cap accommodates the entire down valley flow more frequently for example the main stem at 1150 m or the south branch near 1260 m fig 3c overall the probability of surface flow is lower in the upper main stem upper south branch and the minor tributaries compared to the lower main stem below the confluence this is due to the lower uaa in the upper basin fig 3b the probability of surface flow throughout the network that is contiguous to the outlet is lower than the probability of surface flow in all cases indicating periods of time that dry locations along the valley break the contiguity of the network fig 3d the nearly perfectly horizontal portions of the probabilities across the plot e g x 850 1100 m along the south branch fig 3d are caused by a downstream segment controlling the extent of contiguity up the branch although upstream segments are regularly flowing they are prevented from becoming contiguous by a small location of sufficient down valley capacity to prevent a contiguous surface connection from forming 4 3 temporal trends in network scale hydrologic connectivity throughout water year 2016 the length of the flowing network averaged about 1661 m range 0 to 2350 m median 1810 m fig 4 b drainage density based on the flowing length averaged 1 73 km 2 range 0 2 45 km 2 median 1 89 km 2 during the highest discharge conditions the flowing channel network expands greatly but small sections of dry streambed persist at some locations along the channel so only small increases in the contiguous length are simulated callout 2 in fig 4a and b because of this the fraction of contiguously flowing network decreases during the highest flow events callout 2 in fig 4c under the lowest discharge conditions the fraction of flowing length that is contiguous occasionally reaches a value of 1 0 i e entirely contiguous because only the downstream most segments are predicted to have surface flow e g callout 4 in fig 4b 4c the length of network contiguous to the outlet averaged 1282 m range 0 1570 m median 1520 m fig 4b the contiguous network represents an average and maximum of 45 and 64 respectively of the river corridor length the contiguous drainage density averaged 1 34 km km 2 range 0 1 64 km km 2 median 1 59 km km 2 throughout the water year the contiguous network represented an average of 76 of the flowing network i e 24 of flowing segments were not contiguous to the outlet fig 4c the fraction of the flowing network that was contiguous ranged from 0 8 to 100 across the year with a median value of 77 5 4 4 spatial and temporal trends in hydrologic connectivity seasonal storm and diurnal dynamics spatial patterns of surficial flow and contiguity are highly dynamic fig 5 animation of water year 2016 in supplemental video in many cases a small number of short segments of dry streambed separate significant fractions of flowing streams from the outlet fig 5 which is consistent with our field observations even in the highest discharge conditions many of the minor tributaries do not generate surface flow fig 5 second column during the lowest discharge conditions the subsurface transmits a majority of discharge in all but the downstream most reaches e g fig 5 fourth column under the highest discharge conditions the channel network expands significantly e g fig 6 b callout 1 the newly activated surficial flows may persist for several days or several months e g fig 6b callout 2 horizontal band of discharge about 1320 m upstream of the outlet still these locations are upstream of a persistently dry segment and never contribute to the contiguous length of the network causing the gap between flowing and contiguous length fig 4b at locations of tributaries there is a clear step change in discharge due to the step change in uaa at the confluence of the main stem and south branch visible as changes in color in the vertical direction fig 6b callout 3 fig 6c at 1100 m upstream of outlet for gauge discharges greater than about 1 l s 1 the spatial extent of the network is relatively constant extending to about 1120 m along the main stem fig 6b and to 1000 1250 m along the south branch fig 6c for gauge discharges less than about 1 l s 1 the south branch is mostly dry whereas the main stem especially the lower 750 m becomes temporally dynamic with large oscillations in the length of flowing channel significant contraction is observed during the lowest flow periods fig 6b callout 4 the first small storm of fall 2016 13 7 mm of rainfall from 2 september to 7 september 2016 causes rapid network expansion visible as a nearly vertical line fig 6b callout 5 the most frequent expansions and contractions of the channel network occur at the times when evapotranspiration driven fluctuations in qdv voltz et al 2013 wondzell et al 2010 2007 cause qdv to fluctuate near qsub cap the threshold for surface flow fig 7 in these cases the flowing length and contiguous length can vary by hundreds of meters on a daily basis fig 7b which is confirmed by our field observations in locations where the stream remains flowing we observe strong diurnal variations in discharge visible as vertical bands in fig 7c a small storm delivered about 38 6 mm of rainfall between the 7th and 12th of july 2016 fig 7a this rainfall caused a simulated expansion of more than 50 of the flowing from about 900 to 1650 m and contiguous from about 800 to 1300 m lengths of the channel network for a period of just 48 h fig 7b within four days the discharge again reached a level where qdv and qsub cap were matched reinitiating the daily oscillations in the flowing and contiguous channel lengths over the last half of july baseflow recession continues so that qsub cap exceeded qdv for longer and longer periods of each day and over more and more of the length of the upper main stem so that most channel segments were dry most of the time fig 7c this recession continues until all of the diurnal maximum discharge can be fully accommodated in the subsurface at which point the channel remains dry until a storm in early september provides sufficient water to the catchment to reinitiate flow in the upper main stem fig 6a and b 5 discussion 5 1 network expansion contraction and connectivity reflect interactions of hydrologic forcing and geologic setting based on the simulated water year we posit a systematic gradient from hydrologic to geologic control dominance as discharge decreases in the catchment this finding agrees with empirical relationships developed by godsey and kirchner 2014 extending it to consideration through the full range of discharge conditions in the simulated water year the flowing length and contiguous length span relatively narrow ranges through the wet season october 2015 july 2016 despite qgauge varying across three orders of magnitude fig 4a b flowing length is about 1800 m for qgauge 8 l s 1 increasingly to about 2350 m for qgauge 1085 l s 1 for qgauge 8 l s 1 contiguous length is nearly constant at about 1475 m fig 8 a under these high discharge conditions the most important factors controlling the extent of the stream network are related to overall wet conditions the hillslopes are contributing water to the valley bottom throughout the catchment and the valley bottom is saturated i e ysub t thus new rainstorms simply increase delivery of water from the hillslopes to the river corridor which is then transferred to the stream channel because qdv already exceeds qsub cap further spatial variation in qsub cap caused by variation in valley floor width bsub and longitudinal gradient svalley is small relative to qdv thus the network extent is relatively insensitive to hydrologic dynamics the network responds dynamically to storm events under moderate flow conditions 1 qgauge 8 l s 1 fig 8a under these moderate conditions qdv is near qsub cap thus precipitation delivers water to the catchment increases qdv and temporarily extends the upper end of the flowing network as a result both the flowing and contiguous lengths are highly variable in this range of discharges the variability in flowing length is primarily associated with the transient activation of locations draining less than 10 ha fig 8b thus 10 ha uaa is an apparent threshold for the initiation of surface flow the probability of surface flow or contiguous flow increases rapidly as uaa increases from zero to this 10 ha threshold locations draining more than 10 ha have surface flow more than 70 of the year the rapid expansion of the flowing and contiguous network in response to storm events under moderate flow conditions demonstrates the importance of interacting geologic setting and hydrologic forcing under these conditions under any given hydrologic condition the upper extent of the drainage network reflects locations where enough drainage area is accumulated for qdv to exceed qsub cap however uaa is not accumulated uniformly with distance along the stream network rather it shows sharp jumps at tributary junctions and especially at the confluence between the south branch and main stem these tributary junctions then create sharp discontinuities in the relation between discharge and both flowing and contiguous channel lengths fig 8a thus the watershed topology the arrangement of hillslope contributing areas and tributary locations emerges as a dominant control defining the locations and relative fluxes of water into the river corridor as also found in mountain stream networks by jencso et al 2009 the changes in qsub cap due to valley morphology grow in importance as qdv and qsub cap become closer in magnitude i e qdv qsub cap this is readily seen in the model simulations at very low discharge conditions qgauge 1 l s 1 fig 8a during these low discharge conditions the river corridor becomes highly sensitive to hydrologic forcing as such even the relatively small diurnal fluctuations in qdv fig 7 cause extensive network expansion and contraction at locations where the valley widens qsub cap increases and the stream network dries where the valley narrows qsub cap decreases and flow is reinitiated thus geologic factors determining valley width and slope controls the network expansion and contraction in our model in cases where heterogeneous k is considered the variation of k across orders of magnitude may be the dominant control under these conditions the storage of water in the catchment and its release as baseflow become important controls on when and where surface flow will emerge importantly there is likely a condition of extremely low discharges in which this sensitivity would disappear because minor changes in down valley discharge could be fully transported in the subsurface without activating the surface network i e when qdv qsub cap while the thresholds described above are specific to our study site the general transition to increasing importance of geologic controls under low discharges adds a dynamic context to the perceptual model we posed in section 2 we expect that the perceptual model and the systematic transitions described above will be consistent across mountain stream networks while the specific discharge and area thresholds will vary depending upon for example flow generation processes from the hillslopes the general behavior is consistent with the relationships already described in the literature godsey and kirchner 2014 still this study contributes a dynamic perspective on the activation of the flowing stream network including variation in space the geologic controls we use slope valley width and depth hydraulic conductivity to estimate down valley capacity are not included in costigan et al s 2016 framework which is framed to more broadly identify the types of landscapes in which intermittent flow may occur instead our work highlights spatial variation in specific process controls and their manifestation as patterns of stream intermittency 5 2 a critical comparison of transferability and limitations of river corridor modeling approaches to date assessment and prediction of hydrologic connectivity in the river corridor can be grouped into three main approaches table 2 empirical upscaling distributed modeling and reduced complexity modeling first empirical studies use on the ground observation or instrumentation to directly measure hydrologic connectivity at scales ranging from reaches covino et al 2011 mallard et al 2014 zimmer and mcglynn 2017 to entire networks godsey and kirchner 2014 jensen et al 2017 measurements are regressed against hydrologic or geologic parameters e g stream discharge upslope accumulated area and used to estimate processes along the entire river corridor relatively few empirical studies have been published because they are field intensive requiring substantial commitments of people s time to conduct field campaigns additionally empirical relationships are not readily transferable to other locations with different geologic settings catchment topologies and hydrologic forcing still these empirical studies directly observe the processes of interest recent work by arismendi et al 2017 demonstrates the potential for advanced statistical techniques e g hidden markov models as another strategy for upscaling empirical findings other researchers have used a similar upscaling approach but replaced direct empirical observations with simulation results from mechanistic models in these efforts data from numerical studies are regressed against geologic or hydrologic characteristics with regressions used to describe hydrologic processes as a function of readily observable properties of the landscape e g kiel and cardenas 2014 the major strength of these approaches is their rapid scaling to the stream network and ability to consider a variety of independent variables which thereby enables upscaling of small scale processes to entire stream networks gomez velez et al 2015 gomez velez and harvey 2014 kiel and cardenas 2014 these efforts assume that the processes of interest can be reasonably predicted from some measure of landscape form but do not account for feedbacks that may occur among smaller scale processes nor limitations due to the larger scale context of the process stonedahl et al 2013 2010 schmadel et al 2017 to date these studies lack any dynamic processes fully distributed top down hydrologic models can represent dynamic spatially explicit exchanges in the river corridor frei et al 2009 wondzell et al 2009a yu et al 2016 models in this class can represent processes across a suite of interacting spatial and temporal scales however these models are limited by the number of parameters required to inform the processes being simulated as a result non unique parameters prevent the identification of a single best solution e g beven 1993 2006 beven and binley 1992 such models suffer from over parameterization and a lack of the necessary data to parameterize the natural world at all relevant scales for all of the processes that are represented the reduced complexity model derived and applied in this study is concerned with mechanistic representation of the hydrologic processes perceived to be dominant in the river corridor as such the model only includes the most dominant processes identified in the perceptual model obviously many processes cannot be included ones that are not considered dominant at our scale of interest or for the purposes for which the model was conceived and constructed one clear example in this study is the parameterization of channel unit scale exchange in our model we simplify exchange at scales smaller than the 5 m valley discretization into the sum of the net up or downwelling exchange flux and the qsubgrid terms although channel unit scale exchange has been extensively studied see review by boano et al 2014 it is not a dominant mechanism for prediction of network expansion and contraction at the scales considered here still future improvements could add sub discretization exchange parameterized by metrics derived from topography e g streambed concavity anderson et al 2005 or based on empirical relationships derived for bedforms and individual features e g gomez velez et al 2015 these processes would need to be included if the model were applied to predict reactive transport particularly where exchanges with short timescales are the most important for reactive processes likewise improved representation of heterogeneity in the valley colluvium thickness t and hydraulic conductivity k would likely improve the ability of the model to reflect site specific patterns in intermittency fleckenstein et al 2006 the model also greatly simplifies hillslope valley floor stream connectivity we assumed that lateral inflows would proportional to uaa and implicitly assume that these inflows will be instantaneously synchronized with qgauge several existing studies consider spatial and temporal variability in hillslope discharge to valley bottoms e g jencso et al 2009 smith et al 2013 and could potentially be integrated to improve the representation of those inputs we elected not to parameterize these processes nor the many others that are omitted or simplified because they would increase data needs and are not considered dominant processes in our perceptual model of network expansion and contraction of course processes not included in the perceptual model may be incorrectly omitted in this case iterative advances of hypotheses field observations and mechanistic models are important to correct these deficiencies 5 3 potential applications for assessment of connectivity in the river corridor although the fine scales of field and laboratory studies are best suited to identifying the fundamental physical and biological processes that understanding must be successfully linked to cumulative effects at watershed to regional and continental scales harvey and gooseff 2015 improved understanding of dynamic hydrologic connectivity along the river corridor is increasingly of interest to water resource researchers and managers in the u s e g department of defense environmental protection agency 2014 in the wake of the rapanos v u s 2006 decision new tools are needed to quantify connectivity along river networks and thus provide both a scientific and legal basis for river corridor management for example caruso 2015 proposes the development of connectivity indices based on statistical descriptors of discharge topology and topography but lacks any mechanistic predictive power and requires extensive data collection at each point to be evaluated in contrast this study represents an advance in the application of hydrologic science to inform river corridor management the relatively low data needs enable this framework to be transferable and readily implemented to assess connectivity along the river corridor as with any model an initial implementation based on uncalibrated parameter estimates would provide only a preliminary assessment of connectivity site specific parameterization calibration and validation would be required to use this model as the sole basis for management efforts in the pacific northwestern united states the management of the river corridor increasingly depends upon understanding channel network expansion and contraction one critical location in the river corridor is the perennial initiation point or perennial flow initiation point defined as the farthest upslope location with flow during summer low flow conditions jaeger et al 2007 current practices attempt to construct empirical models to predict the locations of the perennial initiation points as a function of drainage area lithology land use and other readily identifiable independent variables e g jaeger et al 2007 clark et al 2008 wood et al 2009 comparisons among empirical predictions reduced complexity model predictions and distributed model predictions of intermittency will help develop an improved basis for management in unobserved locations we envision two immediate applications of the reduced complexity model presented here first the model could be used to design field studies initial model analyses could use feasible ranges of parameters e g hydraulic conductivity sediment thickness to determine key locations that appear to control the potential expansion contraction and changes in connectivity along the river corridor similarly sensitivity analyses could be used to identify the parameters with the greatest influence on model projections these results could then be used to plan field campaigns that would improve estimates of key parameters or identify the places and times when observations of intermittency or network extent may be most important this approach could help make the most efficient use of limited resources that might be available for field work second the model could be used as the basis of heuristic studies scaling up processes from reaches to entire networks indeed the strategy of scaling reduced complexity models to large networks even in cases when acceptable validation data are not readily available is emerging as an important area of research in the river corridor e g gomez velez et al 2015 current models do not include parametrization for mountain streams this framework could form the basis of an upscaling strategy for high gradient river networks 6 conclusions the overall objective of this study was to predict dynamic hydrologic connectivity along the river corridor to achieve this objective we selected a well studied headwater catchment to develop a perceptual model of river corridor exchange building on this perceptual model we next developed a reduced complexity mechanistic model to predict the dynamic hydrologic connectivity along the river corridor the model developed may be of broad interest for hydrologists and water resource managers working in mountain river networks while this study was designed to calibrate the reduced complexity model by leveraging detailed site specific observations we emphasize that the model was developed with potential transferability in mind the reduced complexity model has modest data requirements stream discharge catchment topography reasonable estimates of hydrogeologic parameters to generate an initial prediction at the river network scale calibration using site specific observations of discharge intermittency and or solute tracer studies can be implemented to refine predictions at sites of interest as we demonstrate here the framework is mechanistic based on a state of the science understanding of the river corridor in a mechanistic way and is capable of simulating both hydrodynamics and solute transport additionally the model is dynamic enabling the simulation of network expansion and contraction we expect the perceptual model detailed in this study is transferable to other mountain stream networks where streams reflect down valley discharge in excess of the down valley capacity importantly the reach scale success of this approach also highlights the role that heterogeneity in valley slope and width controls along network connectivity variation in bedrock topography hydraulic conductivity and individual morphologic features result in a more complex pattern of connectivity that was captured by this model figs s1 s3 this result highlights the need for future study of these processes as controls on intermittency of stream flows in this study we asked how geologic setting interacts with hydrologic forcing to produce spatial and temporal patterns of connectivity along the river corridor we expected geologic controls to dominate periods of steady flow and hydrologic controls to be important only during highly dynamic periods e g storm event responses instead we found that geologic setting controls network dynamics during relatively low discharge conditions and that the spatial patterns of lateral inflows arising from storage and release of water from hillslopes are dominant during relatively wet periods in contrast connectivity in the river corridor is highly sensitive to hydrologic dynamics under the lowest flow conditions acknowledgments data and facilities were provided by the h j andrews experimental forest research program funded by the national science foundation s nsf s long term ecological research program deb 1440409 us forest service pacific northwest research station and oregon state university wondzell was supported by nsf grant no ear 1417603 ward was supported by nsf grant no ear 1652293 tools for solute tracer time series analyses and spatial data processing were developed by ward and others with support provided in part by nsf grant nos ear 1505309 and ear 1331906 ward was also supported by the indiana university office of the vice provost for research and the indiana water resources research center this research was also supported in part by lilly endowment inc through its support for the indiana university iu pervasive technology institute and in part by the indiana metacyt initiative the indiana metacyt initiative at iu is also supported in part by lilly endowment inc any opinions findings and conclusions or recommendations expressed in this material are those of the authors and do not necessarily reflect the views of the national science foundation u s forest service or indiana university precipitation discharge and topographic data are available from the h j andrews experimental forest data catalog http andrewsforest oregonstate edu topographic survey and in stream specific conductance data are available upon request to the corresponding author the authors declare no conflicts of interest supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2018 01 018 appendix supplementary materials image application 1 image application 2 video 
843,headwater stream networks expand and contract in response to changes in stream discharge the changes in the extent of the stream network are also controlled by geologic or geomorphic setting some reaches go dry even under relatively wet conditions other reaches remain flowing under relatively dry conditions while such patterns are well recognized we currently lack tools to predict the extent of the stream network and the times and locations where the network is dry within large river networks here we develop a perceptual model of the river corridor in a headwater mountainous catchment translate this into a reduced complexity mechanistic model and implement the model to examine connectivity and network extent over an entire water year our model agreed reasonably well with our observations showing that the extent and connectivity of the river network was most sensitive to hydrologic forcing under the lowest discharges qgauge 1 l s 1 that at intermediate discharges 1 l s 1 qgauge 10 l s 1 the extent of the network changed dramatically with changes in discharge and that under wet conditions qgauge 10 l s 1 the extent of the network was relatively insensitive to hydrologic forcing and was instead determined by the network topology we do not expect that the specific thresholds observed in this study would be transferable to other catchments with different geology topology or hydrologic forcing however we expect that the general pattern should be robust the dominant controls will shift from hydrologic forcing to geologic setting as discharge increases furthermore our method is readily transferable as the model can be applied with minimal data requirements a single stream gauge a digital terrain model and estimates of hydrogeologic properties to estimate flow duration or connectivity along the river corridor in unstudied catchments as the available information increases the model could be better calibrated to match site specific observations of network extent locations of dry reaches or solute break through curves as demonstrated in this study based on the low initial data requirements and ability to later tune the model to a specific site we suggest example applications of this parsimonious model that may prove useful to both researchers and managers keywords river corridor hyporheic solute tracer riparian network stream 1 introduction the emerging river corridor perspective considers the surface stream hyporheic zone riparian zone hillslope and aquifer as a continuum exchanging water solutes energy and materials across a range of spatial and temporal scales e g harvey and gooseff 2015 empirical studies have addressed dynamic connectivity along the river corridor at the network scale e g godsey and kirchner 2014 gregory and walling 1968 costigan et al 2016 while others have documented the changes in ecosystem services and functions that result from connectivity in the riparian corridor boulton et al 1998 brunke and gonser 1997 krause et al 2011 merill and tonjes 2014 us epa 2015 however despite empirical advances we lack an accurate framework to predict the temporal dynamics of hydrologic connectivity along the river corridor thus an overarching objective of this study is to predict spatial and temporal patterns of hydrologic connectivity along the river corridor at the network scale to achieve this objective we synthesize our understanding of how hydrologic forcing and geologic setting interact to control dynamic exchange processes in the river corridor convert that understanding into a numerical model simulating the dominant processes in the river corridor and implement the model at the network scale using readily available data as a result we derive and calibrate a mechanistic representation of dynamic hydrologic connectivity along the river corridor hydrologic connectivity between the river corridor and its catchment along the length of the river corridor results from the geologic setting interacting with hydrologic forcing ward et al 2012 2014 2016 the geologic setting is static at the time scales of interest here and includes the geologic constraint of the valley e g d angelo et al 1993 stanford and ward 1993 ward et al 2012 2016 wondzell 2006 wright et al 2005 channel and streambed morphology kasahara and wondzell 2003 see also review by boano et al 2014 and multi scale heterogeneity in hydraulic conductivity of the valley floor sediment e g packman and salehin 2003 ryan et al 2004 salehin et al 2004 sawyer and cardenas 2009 vaux 1968 ward et al 2011 hydrologic forcing includes the lateral inflows to the valley bottom from either hillslope sources or from deeper groundwater and stream discharge all of which vary with time and can thus lead to highly dynamic changes in connectivity in mountain streams the steep valley walls constrain the river corridor such that the entire valley bottom stream hyporheic zone riparian zone often can be collectively considered the river corridor interactions between hydrologic forcing and geologic setting give rise to river corridor exchange across a wide range of spatial and temporal scales driven by mechanisms including after kaser et al 2009 turnover exchange e g elliott and brooks 1997a 1997b packman and brooks 2001 diffusion of turbulent momentum into the streambed e g malzone et al 2016 packman and bencala 2000 hydrostatically driven exchange e g gooseff et al 2006 harvey and bencala 1993 kasahara and wondzell 2003 and hydrodynamic pumping into the streambed and banks e g elliott and brooks 1997a 1997b wörman et al 2002 most studies examining exchange processes either assess one or just a small number of potential controls and most commonly within a short reach during baseflow conditions rarely are multiple controls studied over larger spatial and temporal scales consequently the influence of individual factors are well understood at small spatial scales but substantial challenges remain in aggregating the effects of multiple factors within a very long reach or an entire network the critical scales at which resources are managed and predictions are desired ward 2015 harvey and gooseff 2015 the most widely applied strategy to translate process understanding in the river corridor to the reach or network scale uses reduced complexity modeling bencala and walters 1983 first developed their transient storage model which was fit to solute breakthrough curves to estimate advection dispersion and transient storage at the reach scale this reduced complexity modeling strategy eschewed the extensive parameterization required for distributed hydrologic models but provided a mechanistic interpretation of processes that was absent from fully empirical models while the transient storage model has been applied as a basis for understanding both short reaches and whole networks fernald et al 2001 schmadel et al 2014 stewart et al 2011 the model formulation is not able to simulate the dominant processes of mountain systems where down valley subsurface flow is important castro and hornberger 1991 kennedy et al 1984 ward et al 2016 additionally the transient storage model was never intended to represent dynamic network expansion and contraction nor to accommodate spatially intermittent flows a second approach to upscaling river corridor exchange uses empirical relationships between catchment topology and river corridor processes based on field experiments covino et al 2011 mallard et al 2014 or model experiments gomez velez et al 2015 gomez velez and harvey 2014 kiel and cardenas 2014 these empirical approaches are readily implemented based on observable metrics e g drainage area stream discharge sinuosity streambed grain size however empirical approaches are site specific in nature with limited transferability across geologic settings and even to differing flow conditions studies based on model experiments assume the model processes simulated at one scale are the dominant processes across the continuum of nested scales of exchange in the river corridor third distributed or top down hydrologic models build upon generalized knowledge representing river corridor processes spanning spatial and temporal scales frei et al 2009 yu et al 2016 a key strength of distributed models is their ability to represent heterogeneity which may be important to determining intermittent connections between streams and their aquifers fleckenstein et al 2006 however distributed models require extensive parameterization and calibration limiting their ability to be rapidly applied on the landscape while each of the existing approaches have been successful in advancing our understanding of specific mechanisms at a given spatial or temporal scale these approaches all have limited ability to represent river corridor exchange in a way that is mechanistic fully dynamic and representative of the dominant processes within the network therefore we suggest that a new predictive framework is needed one that provides a mechanistic understanding of hydrologic connectivity along the river corridor reflects the hydrologic dynamics that lead to time variable connectivity and would be readily transferable and scalable with modest data requirements we propose a dominant process approach similar to grayson and blöschl 2000 this approach recognizes that reduced complexity models will necessarily omit some processes in favor of representing those which are considered most important in a catchment smith et al 2013 as such we limit the over parameterization of distributed models and avoid their problems with non unique solutions e g beven 2006 bredehoeft and konikow 1993 cardenas and zlotnik 2003 oreskes et al 1994 poeter 2007 wondzell et al 2009a here we closely follow the approach of smith et al 2013 in identifying dominant processes based on our experience in the field developing a perceptual model to explain our observations and then implementing this perceptual model as a reduced complexity model that simulates hydrologic processes at the scale of the river network our primary objective is to predict spatial patterns and temporal dynamics of hydrologic connectivity along the river corridor at reach to network scales i e 100s of meters and longer a secondary objective is to develop an approach that is transferable scalable easily applied based on limited data requirements and is flexible enough that increased data collection could be used to improve and refine the model at sites of interest while costigan et al 2016 proposed a model of general meteorologic geologic and land cover trends that would be related to frequency of intermittency their conceptual model does not address the dynamic transitions that occur between flow states instead focusing on long term trends specifically we seek to answer the question how do geologic setting and hydrologic forcing combine to result in dynamic connectivity along the river corridor we hypothesize that geologic setting will be dominant during all baseflow conditions regardless of the actual discharge magnitude i e during steady high moderate and low discharge conditions void of precipitation conversely we hypothesize that network expansion and contraction will be dominated by hydrologic inputs to the system during highly dynamic periods such as storm event responses that will cause rapid expansion and contraction of the network independently of the structure of the valley bottom to test these hypotheses we develop a reduced complexity model in the spirit of the dominant process approach the model is calibrated at scales of 100s of meters to a well documented solute tracer study and observed dry streambed locations and validated based on stream stage observations at the field site using these results we assess the dynamic interactions of hydrologic forcing and geologic setting noting the places and times where each control is dominant 2 background model development 2 1 site description the perceptual model presented here is based on extensive study of headwater mountain catchments in the western cascades oregon usa specifically the h j andrews experimental forest this site was selected based on the body of research documenting process dynamics in the river corridor of a mountain stream furthermore this site fits the geologic factors that costigan et al 2016 associate with increased intermittency including relatively large grain sizes steep riffle morphology impermeable lithology and small drainage areas in a highly dissected catchment this steep geologically confined mountain stream network is also complimentary to recent efforts to model connectivity in low gradient alluvial systems gomez velez et al 2015 gomez velez and harvey 2014 kiel and cardenas 2014 due to the high confinement of the valley bottom the river corridor in this system is functionally equivalent to the valley bottom which includes the stream hyporheic zone and riparian zone within the h j andrews experimental forest we selected the highly studied watershed 1 ws01 as a study location because the dynamics of river corridor exchange have been studied in greater detail than other sites fig 1 briefly this headwater catchment drains about 96 ha at the outlet stream gauge basin elevations range from 432 to 1010 m a m s l the catchment is highly dissected with steep valley walls and hillslopes forming v shaped valleys that are rapidly downcutting through oligocene and lower miocene aged volcanic bedrock the longitudinal slope of the valley floor averages 11 9 voltz et al 2013 in places the stream flows on exposed bedrock but along most of its length the valley bottom is covered in poorly sorted colluvium much of which was emplaced as landslide and debris flow deposits the depth of the colluvium ranges from 0 to at least 1 74 m the deepest penetration achieved during installation of riparian monitoring wells wondzell 2006 precipitation data were collected at the nearby h j andrews primary meteorological station about 0 5 km n of the gauge elevation 430 m a m s l further physical description of the h j andrews experimental forest and ws01 are available in a host of related publications dyrness 1969 swanson and james 1975 swanson and jones 2002 voltz et al 2013 ward et al 2016 wondzell 2006 wondzell et al 2009b 2 2 perceptual model of the river corridor in mountain streams we developed a perceptual model that explains dynamic expansion and contraction of the active channel network a perceptual model is a qualitative representation of the dominant hydrologic processes operating at a given field site integrating the processes that are known to be important based on field observations numerical simulations and a field based understanding of the system mcglynn et al 2002 1999 sivapalan 2003 wagener et al 2007 thus the model presented below is qualitative in nature but synthesizes the observations of the site in a cohesive framework this model is akin to a hypothesis explaining the interactions between geologic and hydrologic controls in the river corridor and is based on our current understanding developed over several decades of field studies at the site burt and mcdonnell 2015 fig 2 a the perceptual model posits that the river corridor can be described as two parallel interacting domains that transport water and solutes in the down valley direction via surface flows through the stream channel and via subsurface flows through the valley bottom ward et al 2016 this builds directly from bencala et al s 2011 notion that streams are dynamic expressions of the local groundwater system and is well aligned with the perceptual models of godsey and kirchner 2014 and whiting and godsey 2016 subsurface transport in the down valley direction is known to be an important mechanism in higher gradient stream networks castro and hornberger 1991 jackman et al 1984 kennedy et al 1984 several studies have found relatively constant transport in the subsurface attributing this primarily to an unchanging geologic setting e g hydraulic conductivity field major roughness elements bedrock constraints and valley width and a down valley hydraulic gradient set by topography voltz et al 2013 ward et al 2012 2014 2016 wondzell 2006 wondzell and swanson 1996 the primary mechanism of river corridor exchange in mountain streams is expected to be driven by hydrostatic pressure gradients wondzell and gooseff 2014 schmadel et al 2017 the down valley subsurface discharge is functionally controlled by down valley capacity or the ability of the subsurface to transmit water through saturated porous media in parallel the surface stream flow represents only the excess of down valley discharge that cannot be accommodated by the down valley capacity thus in stream discharge and transport can be highly dynamic in response to the stream while transport in the saturated subsurface remains relatively constant while subsurface down valley discharge is relatively constant in time it is spatially variable due to changes in the down valley capacity of the subsurface caused by changes in valley width colluvium depth slope or heterogeneity in hydraulic conductivity the concept of spatially contiguous down valley discharge is supported by the observed long term storage of ward et al 2013a in ws01 their study found significant mass losses from stream solute tracer studies concluding that the mass entered flowpaths that traveled down valley but remained in the subsurface additionally these flowpaths could not have been losses to a deeper groundwater aquifer because the river corridor is ultimately confined by intact bedrock inputs of hillslope water to the valley bottom can affect the extent of long term storage and these inputs vary in both space and time spatially inputs from the hillslopes to the river corridor are assumed to vary in proportion with the contributing upslope accumulated area uaa after jencso et al 2009 and corson rikert et al 2016 past studies in nearby catchments concluded that topography controls the transport of water from hillslopes to valley bottoms e g mcguire et al 2005 discharge in the valley varies in time and impacts river corridor exchange during storm events ward et al 2013a seasonal baseflow recession ward et al 2012 2016 and diurnal fluctuations driven by evapotranspiration from riparian zones and perhaps the lower hillslopes schmadel et al 2016 2017 voltz et al 2013 wondzell et al 2010 2007 the upper reaches of the main stem and south branch have surface flow during the winter and spring but portions of them are frequently dry during the summer months fig 1 we generally have not observed surface flow from convergent areas lateral to the main stem or south branch i e those areas identified as minor tributaries in fig 1 amatya et al 2016 the colluvium accumulated within these areas is generally too deep and porous for the relatively small drainage areas to support surface flow however there are weakly developed channels 10 30 cm wide that suggest surface flow does occur during major storms in two specific conditions 1 below bedrock outcrops where soils are quite shallow forcing flow to the surface and 2 high in the north east corner of the watershed where deep seated earthflows have created a drainage network around multiple small slumps where water may flow at the surface for much of the year these areas are notable in that surface flow may occur with very small uaa but they are always discontinuous to the channel network from which they are far removed 50 m from the simulated channel network because of that we do not consider them further in this study finally both evapotranspiration from and direct precipitation to the valley bottom and stream are omitted given the small plan view area of these landscape elements relative to the hillslopes 2 3 development of a mathematical model the dominant processes in the perceptual model were translated into a numerical model fig 2b subsequent sections describe the development of the surface and subsurface hydraulics and the solute transport components of the model which are formulated for one dimensional 1 d segments of the valley bottom with boundary conditions at the upstream end of each simulated segment 2 3 1 hydraulic model open channel flow was simulated using the continuity equation and kinematic wave routing 1 d a d t d q s t r d x q u p d x q d o w n d x 0 where t is time s x is the spatial coordinate along the valley bottom m a is the stream cross sectional area m2 qstr is the stream discharge m3 s 1 and qup and qdown represent gross up and downwelling flux m3 s 1 respectively net up or downwelling flux qnet m3 s 1 is qnet qup qdown we formulated the model using the gross exchanges to more accurately reflect the associated fluxes of solute after payn et al 2009 lateral inflows enter the model in the subsurface domain and represent either upwelling of valley bottom groundwater unlikely in our case of bedrock constraint but the term could be used for this flux in other settings or lateral inputs of hillslope water and influence the stream via the qup and qdown terms thus a term describing lateral inflows occurs only in the continuity equation applied to the subsurface domain eq 3 this formulation requires that lateral inflows to the simulated network do not consist of channelized overland flow if that were the case the simulated network should be expanded to include explicit simulation of any channelized flow at the surface we relate discharge and channel geometry using manning s equation 2 q s t r 1 n a 5 3 p 2 3 s s t r e a m 1 2 where n is manning s roughness coefficient unitless sstream is the down valley slope along the stream channel m m 1 the constant value of 1 in the numerator has associated units of m1 3 s 1 and p is the wetted perimeter m we approximate the stream geometry as a rectangular channel thus a by and p b 2y where b is the channel width m and y is the depth of flow in the surface channel m in the subsurface we solve the continuity equation for water as 3 d a s d t d q s u b d x q u p d x q d o w n d x q l a t d x 0 where as is the cross sectional area of the saturated portion of the subsurface m2 qsub is the down valley subsurface discharge m3 s 1 and qlat represents lateral inflows from the hillslopes into the valley bottom m3 s 1 defined as the unit inflow per drainage area qlat multiplied by the difference between uaa at the up and downstream ends of the segment all lateral inflows to the simulated network are assumed to occur in the subsurface surface streams can initiate and combine at junctions if the down valley discharge in a tributary exceeds down valley capacity qsub cap m3 s 1 darcy s law is used to calculate qsub as a function of valley width bvalley m depth of subsurface flow ysub m hydraulic conductivity k m s 1 porosity θ unitless and valley slope svalley m m 1 4 q s u b b v a l l e y y s u b k θ s v a l l e y we assume the slope of the valley bottom is a good approximation of the down valley hydraulic gradient ward et al 2016 2013b wondzell 2011 the maximum capacity of the subsurface to transport water in the down valley direction down valley capacity qsub cap occurs when ysub t where t is the thickness of the valley bottom colluvium m colluvium dimensions are related to geometry as as bvalleyysub total down valley discharge qdv m3 s 1 is the sum of surface and subsurface discharges 5 q d v q s t r q s u b 2 3 2 solute transport model we solve for conservative solute mass in the surface using a volumetrically averaged mass balance for the stream 6 d v c d t q i n c i n q s t r c q u p c s q d o w n c where qin is the stream discharge from the upstream valley segment m3 s 1 cin is the stream solute concentration from the upstream valley segment g m 3 c is the stream solute concentration g m 3 and cs is solute concentration in the subsurface g m 3 the volume of water in the surface domain v m3 is calculated as 7 v s i n u o s i t y d x b y where sinuosity is the sinuosity of the stream calculated as the along stream distance in each segment divided by the length of the segment m m 1 for solute transport in the subsurface we use a similar formulation 8 d v s c s d t q s u b i n c s i n q s u b c s q u p c s q d o w n c q l a t c l a t where qsub in is the subsurface discharge from the upstream valley segment m3 s 1 cs in is the subsurface solute concentration from the upstream valley segment g m 3 clat is the concentration of lateral inflows from the hillslopes to the river corridor g m 3 and vs is the volume of water in the subsurface domain m3 calculated as the volume of void space filled with water 9 v s a s θ d x for this formulation we assume that all pore space is connected for transport of water and solutes and that the subsurface domain is well mixed within each spatial discretization 2 4 model implementation 2 4 1 model solution for interior and downstream segments the model equations presented above allow for spatially variable dynamic activation of surface flow and continuity in space given the total down valley flow and the amount that can be accommodated via the subsurface we simulated transport through the river corridor at the network scale for water year 2016 1 october 2015 through 30 september 2016 the model equations are implemented as a finite difference numerical solution along the river corridor discretized using a 5 m segment length up and downwelling fluxes qup and qdown are calculated at each model segment on the basis of two logical operators which operate to first assign all flow to the subsurface domain and then assign any flow exceeding qsub cap into the surface domain channel water balance studies in mountain streams note that gross exchange of water between streams and their subsurface often exceeds net exchange covino et al 2011 payn et al 2009 ward et al 2013b to represent the gross up and downwelling exchanges in the water balance we define the parameter qsubgrid m3 s 1 to increase exchanges of water between surface and subsurface domains within each model segment for net up or downwelling between the surface and subsurface domains three possible behaviors exist first for cases when the flow entering a model segment is greater than the down valley capacity i e qsub in qlat qsub cap net upwelling of the excess subsurface discharge is implemented 10 q d o w n q s u b g r i d 11 q u p q s u b i n q l a t q s u b c a p q s u b g r i d second for cases where the down valley capacity is larger than the inflows to the subsurface domain net downwelling is required to ensure the full down valley capacity is met before surface flow activates net downwelling is predicted for cases when qsub in qlat qsub cap if the subsurface can accommodate the total down valley discharge i e qin qsub in qlat qsub cap all of the down valley discharge is assigned to the subsurface resulting in a dry streambed exchange discharges are then 12 q d o w n q i n q s u b g r i d 13 q u p q s u b g r i d finally for cases of net downwelling i e qsub in qlat qsub cap where the subsurface cannot accommodate all of the down valley discharge i e qin qsub in qlat qsub cap stream discharge will occur vertical exchanges are then 14 q d o w n q s u b c a p q s u b i n q l a t q s u b g r i d 15 q u p q s u b g r i d in this implementation the down valley capacity of the subsurface is always filled before the stream channel activates 2 4 2 boundary conditions and initial conditions for all model segments initial conditions of qdv x t 0 c x t 0 and cs x t 0 are specified the logical tests described above are used to partition qdv x t 0 into qstr and qsub fractions at t 0 at the head of each channel fig 1 main stem south branch and all minor tributaries specified boundary conditions of qdv x xn t c x xn t and cs x xn t are required where xn is the upstream most or nth segment we specify c x xn t cs x xn t 0 and qdv x xn t based on area proportional discharge assigned from the gauge this specification means that lateral inflows from the hillslope to the valley bottom are all synchronized in time to the stream gauge and does not allow for heterogeneity in hillslope responses to precipitation input these simplifications are necessary to balance the desire for reduced complexity with the representation of processes occurring in the landscape for segments whose upstream end is the confluence of two tributaries the discharge is defined as the sum of the outflows from the two upstream segments the concentration is defined by conservative mixing of the two upstream tributaries with the time variable boundary conditions established the model equations are solved using a forward in time backward in space solution scheme which is computationally efficient and allows for an explicit solution of the model equations we implement adaptive time stepping allowing timesteps to grow or shrink by a factor of 4 depending on hydrologic and solute dynamics timesteps are limited in growth to constrain changes in discharge or concentration to less than 1 in a given timestep with minimum and maximum timesteps of 1 and 3600 s respectively 2 5 model limitations implementation of the perceptual model as a reduced complexity model necessarily simplifies the processes in the river corridor to represent dynamics at reach to network scales first this simplification does not capture the smaller scale flow paths that are associated with individual channel unit features smaller than 5 m in length instead the 1 d representation of the valley bottom focuses on larger scale down valley flow and in our model varies only in response to changes in valley width and longitudinal gradient as a result the spatial distributions of exchange fluxes or flowing status are not expected to have a high fidelity at representing individual features but are expected to be representative at reach and longer scales see section 3 4 for reach scale metrics therefore we consider it inappropriate to expect performance to match small scale patterns of intermittent flow that may develop because of individual features that are smaller than the spatial resolution of the model second the solute transport routine represents only advective processes along the stream with numerical solutions introducing a small amount of numerical dispersion the addition of longitudinal dispersion transient storage or sorption desorption dynamics e g after bencala and walters 1983 runkel 1998 would likely improve the representation of solute transport it is important to note however that we do simulate advective exchange between the surface and subsurface but at spatial scales larger than 5 m we also allow specification of surface subsurface exchange occurring at scales smaller than 5 m using the term qsubgrid but this term is treated as a constant across the entire network and thus cannot represent spatial variation in exchange processes driven by channel unit features smaller than the resolution of the model collectively surface subsurface exchange is commonly considered to be an important component of transient storage by contrast fine scale transient storage in the surface channel i e in pools and eddies is not simulated in our model because we expect surface subsurface exchange to dominate at the scales we are simulating representing in channel transient storage longitudinal dispersion and sorption desorption would come at a computational cost further several of these processes are likely sensitive to channel unit scale features that cannot be extracted from typical airborne lidar data so including these processes in the model would likely require much more detailed data on stream topography third the assumption that all pore water is well mixed and equally connected is limiting we acknowledge that the subsurface domain is likely not completely mixed over short timescales e g ward et al 2012 pores are recognized to range from fully connected to functionally disconnected from advective transport e g dual domain representations of porous media this simplification also omits heterogeneity in the hydraulic conductivity which has been shown to be an additional control on interactions between streams and their aquifers e g fleckenstein et al 2006 in cases where the subsurface domain is not well mixed this assumption causes the exchanged mass to mix with a larger volume of water the result is a slower equilibration between the stream and subsurface i e concentrations in the subsurface rise and flush more slowly than would occur in a system that was not well mixed we do not consider these processes to be sufficiently important to be included in the perceptual model outlined above and are thus not represented in the numerical model but acknowledge these processes may be important at other sites finally the numerical model simplifies all hillslope hydrology as 1 instantaneously synchronized with discharge observed at the gauge and 2 discharge is proportionally distributed on the basis of upslope accumulated areas both are oversimplifications of catchment hydrology and hydraulics and are areas for potential future improvement 3 methods the model derived above can be implemented using only a digital terrain model a single stream gauge at the outlet of the catchment and estimates of hydrogeologic properties the highest uncertainty will likely come in the estimation of a representative hydraulic conductivity because this parameter is expected to span orders of magnitude we suggest initial estimates based on any available data grain size distributions or modest field campaigns e g falling head tests in temporary piezometers or shallow wells could be used to better constrain this model parameter these modest data requirements are a key contribution of this relatively simple model again we emphasize that reduced complexity models are constructed to represent dominant mechanisms and interactions in a system of interest acknowledging that this comes at the expense of representing complexity and heterogeneity of some processes in the system in the following sections we detail how the model is parameterized using available data from our field site 3 1 model parameters specified for the study site implementing the model derived above requires analysis of stream valley and catchment topography to identify the drainage network the valley floors and the hillslope area contributing to each model segment we used a modified version of the topotoolbox schwanghart and kuhn 2010 schwanghart and scherler 2014 to analyze the 1 m lidar digital terrain model available for ws01 we selected a spatial discretization of 5 m segments along the river corridor briefly we applied the multidirectional flow routing algorithm seibert and mcglynn 2007 based on visual observations at the field site under high discharge conditions we defined a threshold of 3 ha for channel initiation i e all points where drainage area 3 ha are simulated as part of the river corridor we selected the threshold of 3 ha because we seldom observe channelized flow in locations draining this small of an area as a result the upper extent of each simulated tributary should have no overland flow and the model equations are used to predict the flow initiation point along each headwater we measured the valley width at 30 locations measuring from the stream centerline to the valley wall along a line perpendicular to the longitudinal axis of the valley break point visually identified in the field after jencso et al 2009 our topographic analysis showed that the floodplain margin between hillslope and valley bottom was approximated using an elevation 1 5 m above the streambed provided the best fit between widths extracted from the digital elevation model dem and our field observations using that threshold we discretized the stream network into 5 m segments and for each segment we extracted valley widths left and right sides valley slope stream channel slope and stream channel sinuosity we also calculated the lateral uaa along each side of the valley using topotoolbox schwanghart and kuhn 2010 schwanghart and scherler 2014 inflows to the valley bottom qlat m3 s 1 were calculated using an area weighted flow based on the ws01 gauge station for each segment the total lateral inflows were calculated as 16 q l a t δ u a a q g a u g e u a a g a u g e where δuaa is the change in uaa along the stream centerline in each model segment ha qgauge is the discharge at the ws01 stream gauge m3 s 1 and uaagauge is the uaa at the stream gauge about 96 ha the topographic analysis and area weighted assignment of lateral inflows are identical to recent work in the catchment corson rikert et al 2016 the gauge discharge data are used as published by the h j andrews experimental forest a summary of the specified or calibrated parameters are provided in table 1 3 2 model calibration recognizing the model limitations we define two calibration targets that represent reach scale behaviors to demonstrate reasonable representation of system processes 1 reach scale solute transport and 2 reach scale fraction of dry streambed these calibration targets will generate reach averaged best fit model parameters rather than spatially variable distributions closely following the approach of other reduced complexity models of headwater streams e g bencala and walters 1983 first we calibrated the model parameters t k and qsubgrid using a break through curve from a solute tracer injection from 2 august 2010 see voltz et al 2013 ward et al 2016 for details we simulated the tracer injection and compared observed versus simulated concentrations of tracer at two locations immediately downstream of the injection where complete mixing was assumed 166 m upstream of the ws01 gauge and at the ws01 gauge station itself we varied t from zero observed at bedrock outcrops to a maximum depth of 4 m this greatly exceeds the maximum penetration depth of 1 74 m observed when installing wells and thus allows for uncertainty between the refusal depth and impermeable bedrock this difference may represent for example a zone of weathered bedrock below the colluvium but still bounded by impermeable unweathered bedrock below we varied k across the range of values observed by kasahara and wondzell 2003 in ws01 and a nearby headwater catchment spanning 4 3 10 6 6 1 10 4 m s 1 finally qsubgrid was varied from 1 10 6 to 1 10 2 m3 s 1 based on observations at the field site for comparison ward et al 2013a found average gross stream to subsurface exchanges of about 3 5 10 3 m3 s 1 per 5 m of valley distance range 0 1 6 10 2 m3 s 1 median 2 7 10 3 m3 s 1 during a storm event using reach scale solute tracer studies thus the range spans nearly the complete observation set with a lower bound of 10 6 m3 s 1 rather than zero this first model calibration step was performed by uniformly sampling the distributions of k t and qsubgrid and varying the parameters jointly increasing resolution around the best fit parameters more than 1100 simulations were performed overall model fit was evaluated based on minimizing root mean square error rmse between the observed tracer breakthrough curve and simulations we selected minimizing rmse because this is analogous to the residual sum of squared errors used to evaluate model fits in inverse modeling of stream solute tracers e g runkel 1998 ward et al 2017 next we calibrated the model by comparing the observed versus simulated total length of dry streambed in the reach of stream between the gauge and the confluence of the main stem and south branch fig 1 the model formulation allows for computation of extremely small surface flows that would not be visually differentiated from a damp streambed or flow fully through the armored cobble layer on the bed in the field e g values of qstr 1 10 4 m3 s 1 these simulated discharges are numerically non zero but functionally non observable in the field thus we require a threshold to differentiate observably flowing from dry segments in the model output qlim we select the target of total reach scale dry streambed in acknowledgement that the reduced complexity model is not intended to represent small scale features nor their spatial distributions that would be observed in the field but instead to capture representative behavior for reaches 100s of meters and longer this target is also comparable to reasonably available field data for a site with limited characterization where available information may be based on visual inspection or personal knowledge that will typify applications lacking detailed site investigations e g anecdotal about 20 of the streambed is dry in late august on 25 may 2016 21 june 2016 04 july 2016 and 13 august 2016 we walked from the gauging station to the main confluence recording the locations of dry streambed at sub meter resolution using the specified parameters table 1 and those calibrated for the solute tracer k t qsubgrid we assessed the accuracy of dry streambed predictions to select an appropriate value of the discharge threshold to define surface flow qlim to maximize accuracy of predicting the total dry length observed in the study reach this calibration step tested more than 10 000 values for qlim and selected the value that minimize the error in predicted dry streambed length along the observed reach 3 3 model validation to validate the model we compared the flowing status predicted by the reduced complexity model with a similar dataset generated by combining a detailed survey with measured changes in stream stage in the reach spanning 95 626 m upstream of the gauging station we surveyed the elevation of the streambed and stream water surface at 1 0 m horizontal resolution and 0 01 m vertical resolution during conditions with qgauge ranging from 5 8 to 6 7 l s 1 fifteen pressure transducers were installed along the surveyed reach recording data every 15 minutes from 1 october 2015 to 2 september 2016 all loggers were installed in shallow wells to ensure they remained submerged all season even if water levels dropped below the streambed we constructed a spatially continuous water surface by calculating changes in the water surface elevation at each of the 15 sensors and then interpolating these changes to every model segment for each timestep this exactly follows the procedures described by schmadel et al 2017 we then extracted the stream stage relative to the streambed for each 5 m segment within the surveyed reach and assigned a status of not flowing for segments containing no surface flow partially flowing for segments with both surface flow and dry streambed and fully flowing for segments with active surface flow along the entire length of the segment we assess reduced complexity model performance by tabulating the frequency of correct predictions of flowing times and locations where constructed profiles and model results both indicate fully flowing status and correct predictions of not flowing times and locations where constructed profiles indicate either partially or not flowing status and the model predicts no flow we elect to include partially flowing status from the profiles as equal to not flowing status in the reduced complexity model because we expect the low discharges in a partially flowing segment would be below the calibrated qlim value 3 4 evaluation of model results spatial and temporal trends in connectivity model results were used to evaluate nine metrics describing the hydrologic connectivity for each river corridor segment we tabulated 1 the flowing status i e surface flow or no surface flow 2 subsurface discharge and 3 surface discharge every 10 minutes throughout the 1 year simulation period based on this information and the network topology we also tabulated 4 whether the surface flow was contiguous to the outlet i e if there was an unbroken connection of surface flow between a segment and the outlet using these metrics we next calculated 5 the total flowing length of the surface stream network 6 the total contiguous length of the surface stream network and 7 the drainage density flowing stream network length per catchment area for the flowing network after completion of the entire 1 y simulation we calculated 8 the probability of surface flow and 9 the probability of contiguous flow for each segment by dividing the number of timesteps with surface or contiguous flow by the total number of timesteps 4 results 4 1 model calibration validation overall the calibrated model predicted the tracer breakthrough curve observed in august 2010 with an rmse of 12 4 μs cm 1 after calibration we also assessed model predictions using r 2 0 86 comparing time series observations to calibrated model predictions mean arrival time for the in stream solute tracer timeseries observed 75 6 h modeled 66 3 h coefficient of variation for the in stream solute tracer timeseries observed 0 72 modeled 0 70 and skewness for the in stream solute tracer timeseries observed 1 13 modeled 0 66 based on the high r2 and low errors for mean arrival time and coefficient of variation we interpret that advection of the input tracer signal and its longitudinal spread are being accurately represented by the model the disparity in skewness corresponds to the acknowledged limitations of the solute transport model wherein only the advective transport processes are being considered the observed late time low concentration tails of the in stream timeseries which drive larger positive values of skewness are not being well fit by the reduced complexity model is expected given that longitudinal dispersion and in channel transient storage are not simulated next we used observations of dry streambeds to estimate qlim we did not observe any dry streambed during the may and june 2016 surveys in july 2016 we observed a total of 3 5 m of dry streambed at 5 locations range 0 5 1 m in dry length in august 2016 we observed 106 1 m of dry streambed across 26 separate locations range 0 4 26 9 m mean 4 1 m median 1 0 m at the time of the august 2016 observations the stream discharges in the model segments within the surveyed stream reach 0 m 650 m from the stream gauge ranged from 0 18 to 0 45 l s 1 however because our field observations recorded some of these segments as dry qlim must be greater than 0 18 l s 1 i e discharges of less than qlim were not observable as surface flow in the field furthermore because discharge at the gauge was measured between 0 32 and 0 45 l s 1 during the same period this also implies that qlim must be less than 0 32 l s 1 we searched possible values for qlim in this range at a resolution of 0 001 l s 1 comparable to the resolution of the gauge when the v notch weir is installed during the summer low flow period the best agreement for total dry streambed length in the segment spanning 0 759 m was found for qlim 0 221 l s 1 which results in a simulated 14 2 of the total length in dry streambed conditions compared to 13 9 observed in the field using this value of qlim the may and june 2016 simulation periods accurately predict 100 of the observed conditions in the field fig s1 for july 2016 we observed about 0 5 of the streambed to be dry less than the length of one model segment and the reduced complexity model predicts all segments flowing fully fig s1 while the simulated length of dry channel was similar to that observed at the reach scale the agreement in the spatial location of dry segments was quite poor we expected considerable disagreement between the model and the observations over short distances where small scale channel morphology like wedges of sediment accumulated above in channel logs would lead to local increases in sediment thickness or create variable deposition environments leading to substantial variability in saturated hydraulic conductivity as expected the model did not simulate many of the short dry segments we observed but it also simulated a long dry section between 600 and 750 m above the stream gauge whereas we observed large dry segments between 150 and 300 m the lack of agreement suggests that spatial patterning is being controlled by factors other than channel unit scale variations in morphology certainly large logs transported in debris flows can form large log jams with depositions several meters thick that extend more than 100 m upstream from the log jam we used a constant thickness of 0 75 m resulting from model calibration in a short tracer injection reach near the bottom of the watershed penetration depths of 41 wells located within that reach show that the sediment thickness averages only 1 m and in early summer with qgauge 34 l s 1 the saturated thickness averages 0 48 m it is likely that sediment thickness at other locations would be substantially deeper or shallower than the best fit reach scale value that was calibrated using a constant thickness would lead to the model simulating dry channels in locations where the actual sediment was thinner than 0 75 m or wet channels in locations where the actual sediment is thicker than 0 75 m note that qsub cap is relatively constant from 750 m down to the mouth of the watershed whereas uaa and q both nearly double over this distance thus small overestimates of sediment thickness at the top of this reach would readily result in the model simulating a dry channel where one may not be observed conversely limiting sediment thickness to only 0 75 m lower in the reach where discharge is much higher would make it unlikely that the model would simulate a dry segment finally we compared the predictions of the stream status flowing or dry to water surface profiles interpolated from 15 pressure transducers located in the lower 650 m of the main stem channel in total we compared 99 model segments spanning 32 443 timesteps that comprise approximately 3 2 million points figs s2 and s3 overall the reduced complexity model correctly predicted about 2 6 million flowing conditions about 81 9 of all points figs s2 and s3 and 434 576 dry streambed conditions about 13 5 of all points figs s2 and s3 the reduced complexity model incorrectly predicted 145 886 points about 4 5 of all points figs s2 and s3 based on more than 95 agreement between the model predictions and validation data we are encouraged to interpret the model as a reasonable description of the dynamics in the system overall model performance is generally strongest under higher discharge conditions one key limitation of the model is the spatial resolution limits the simulation of segments that are partially flowing while the network scale metrics are reasonably predicted the spatial organization is generally not well predicted by the model figs s1 s3 because of the assumed spatial homogeneity of model parameters the model could be further tuned by making t and k spatially variable however collecting spatially explicit data on sediment depth in the valley floor throughout the stream network would be a daunting task but more importantly adding substantial complexity to the model just to improve the model fit runs counter to the modeling philosophy that guides this effort that is to develop a highly transferable model that can be parameterized using readily available data to simulate dominant hydrological processes within a large stream network we recognize that this simple model is far from perfect still we argue that it represents the dominant hydrologic processes operating along the length of the stream network in this watershed 4 2 spatial trends in network scale hydrologic connectivity the study network is comprised of 2825 m of stream channel 3 ha channel initiation threshold equivalent to a channel density of 2 9 km 2 valley topography topology slope and sediment characteristics result in an average down valley capacity qsub cap of 4 6 10 2 l s 1 range 1 2 10 3 3 7 10 1 l s 1 median 3 7 10 2 l s 1 fig 3 a since network average values were used for t k and θ this variation reflects the spatial variability in down valley slopes and valley bottom widths in along the river corridor the probability of surface flow peaks at about 99 3 at the outlet of ws01 fig 3c the probability of surface flow decreases approximately linearly with distance to 93 0 at the confluence of the south branch and main stem the probability of surface flow decreases abruptly above the confluence in both branches due to the step decrease in tributary uaa fig 3b in both branches probability of surface flow remains at or about 70 to a distance of about 1100 m upstream from the outlet about 330 m upstream of the confluence sharp changes in the probability of surface flow occur at locations where an increase in qsub cap accommodates the entire down valley flow more frequently for example the main stem at 1150 m or the south branch near 1260 m fig 3c overall the probability of surface flow is lower in the upper main stem upper south branch and the minor tributaries compared to the lower main stem below the confluence this is due to the lower uaa in the upper basin fig 3b the probability of surface flow throughout the network that is contiguous to the outlet is lower than the probability of surface flow in all cases indicating periods of time that dry locations along the valley break the contiguity of the network fig 3d the nearly perfectly horizontal portions of the probabilities across the plot e g x 850 1100 m along the south branch fig 3d are caused by a downstream segment controlling the extent of contiguity up the branch although upstream segments are regularly flowing they are prevented from becoming contiguous by a small location of sufficient down valley capacity to prevent a contiguous surface connection from forming 4 3 temporal trends in network scale hydrologic connectivity throughout water year 2016 the length of the flowing network averaged about 1661 m range 0 to 2350 m median 1810 m fig 4 b drainage density based on the flowing length averaged 1 73 km 2 range 0 2 45 km 2 median 1 89 km 2 during the highest discharge conditions the flowing channel network expands greatly but small sections of dry streambed persist at some locations along the channel so only small increases in the contiguous length are simulated callout 2 in fig 4a and b because of this the fraction of contiguously flowing network decreases during the highest flow events callout 2 in fig 4c under the lowest discharge conditions the fraction of flowing length that is contiguous occasionally reaches a value of 1 0 i e entirely contiguous because only the downstream most segments are predicted to have surface flow e g callout 4 in fig 4b 4c the length of network contiguous to the outlet averaged 1282 m range 0 1570 m median 1520 m fig 4b the contiguous network represents an average and maximum of 45 and 64 respectively of the river corridor length the contiguous drainage density averaged 1 34 km km 2 range 0 1 64 km km 2 median 1 59 km km 2 throughout the water year the contiguous network represented an average of 76 of the flowing network i e 24 of flowing segments were not contiguous to the outlet fig 4c the fraction of the flowing network that was contiguous ranged from 0 8 to 100 across the year with a median value of 77 5 4 4 spatial and temporal trends in hydrologic connectivity seasonal storm and diurnal dynamics spatial patterns of surficial flow and contiguity are highly dynamic fig 5 animation of water year 2016 in supplemental video in many cases a small number of short segments of dry streambed separate significant fractions of flowing streams from the outlet fig 5 which is consistent with our field observations even in the highest discharge conditions many of the minor tributaries do not generate surface flow fig 5 second column during the lowest discharge conditions the subsurface transmits a majority of discharge in all but the downstream most reaches e g fig 5 fourth column under the highest discharge conditions the channel network expands significantly e g fig 6 b callout 1 the newly activated surficial flows may persist for several days or several months e g fig 6b callout 2 horizontal band of discharge about 1320 m upstream of the outlet still these locations are upstream of a persistently dry segment and never contribute to the contiguous length of the network causing the gap between flowing and contiguous length fig 4b at locations of tributaries there is a clear step change in discharge due to the step change in uaa at the confluence of the main stem and south branch visible as changes in color in the vertical direction fig 6b callout 3 fig 6c at 1100 m upstream of outlet for gauge discharges greater than about 1 l s 1 the spatial extent of the network is relatively constant extending to about 1120 m along the main stem fig 6b and to 1000 1250 m along the south branch fig 6c for gauge discharges less than about 1 l s 1 the south branch is mostly dry whereas the main stem especially the lower 750 m becomes temporally dynamic with large oscillations in the length of flowing channel significant contraction is observed during the lowest flow periods fig 6b callout 4 the first small storm of fall 2016 13 7 mm of rainfall from 2 september to 7 september 2016 causes rapid network expansion visible as a nearly vertical line fig 6b callout 5 the most frequent expansions and contractions of the channel network occur at the times when evapotranspiration driven fluctuations in qdv voltz et al 2013 wondzell et al 2010 2007 cause qdv to fluctuate near qsub cap the threshold for surface flow fig 7 in these cases the flowing length and contiguous length can vary by hundreds of meters on a daily basis fig 7b which is confirmed by our field observations in locations where the stream remains flowing we observe strong diurnal variations in discharge visible as vertical bands in fig 7c a small storm delivered about 38 6 mm of rainfall between the 7th and 12th of july 2016 fig 7a this rainfall caused a simulated expansion of more than 50 of the flowing from about 900 to 1650 m and contiguous from about 800 to 1300 m lengths of the channel network for a period of just 48 h fig 7b within four days the discharge again reached a level where qdv and qsub cap were matched reinitiating the daily oscillations in the flowing and contiguous channel lengths over the last half of july baseflow recession continues so that qsub cap exceeded qdv for longer and longer periods of each day and over more and more of the length of the upper main stem so that most channel segments were dry most of the time fig 7c this recession continues until all of the diurnal maximum discharge can be fully accommodated in the subsurface at which point the channel remains dry until a storm in early september provides sufficient water to the catchment to reinitiate flow in the upper main stem fig 6a and b 5 discussion 5 1 network expansion contraction and connectivity reflect interactions of hydrologic forcing and geologic setting based on the simulated water year we posit a systematic gradient from hydrologic to geologic control dominance as discharge decreases in the catchment this finding agrees with empirical relationships developed by godsey and kirchner 2014 extending it to consideration through the full range of discharge conditions in the simulated water year the flowing length and contiguous length span relatively narrow ranges through the wet season october 2015 july 2016 despite qgauge varying across three orders of magnitude fig 4a b flowing length is about 1800 m for qgauge 8 l s 1 increasingly to about 2350 m for qgauge 1085 l s 1 for qgauge 8 l s 1 contiguous length is nearly constant at about 1475 m fig 8 a under these high discharge conditions the most important factors controlling the extent of the stream network are related to overall wet conditions the hillslopes are contributing water to the valley bottom throughout the catchment and the valley bottom is saturated i e ysub t thus new rainstorms simply increase delivery of water from the hillslopes to the river corridor which is then transferred to the stream channel because qdv already exceeds qsub cap further spatial variation in qsub cap caused by variation in valley floor width bsub and longitudinal gradient svalley is small relative to qdv thus the network extent is relatively insensitive to hydrologic dynamics the network responds dynamically to storm events under moderate flow conditions 1 qgauge 8 l s 1 fig 8a under these moderate conditions qdv is near qsub cap thus precipitation delivers water to the catchment increases qdv and temporarily extends the upper end of the flowing network as a result both the flowing and contiguous lengths are highly variable in this range of discharges the variability in flowing length is primarily associated with the transient activation of locations draining less than 10 ha fig 8b thus 10 ha uaa is an apparent threshold for the initiation of surface flow the probability of surface flow or contiguous flow increases rapidly as uaa increases from zero to this 10 ha threshold locations draining more than 10 ha have surface flow more than 70 of the year the rapid expansion of the flowing and contiguous network in response to storm events under moderate flow conditions demonstrates the importance of interacting geologic setting and hydrologic forcing under these conditions under any given hydrologic condition the upper extent of the drainage network reflects locations where enough drainage area is accumulated for qdv to exceed qsub cap however uaa is not accumulated uniformly with distance along the stream network rather it shows sharp jumps at tributary junctions and especially at the confluence between the south branch and main stem these tributary junctions then create sharp discontinuities in the relation between discharge and both flowing and contiguous channel lengths fig 8a thus the watershed topology the arrangement of hillslope contributing areas and tributary locations emerges as a dominant control defining the locations and relative fluxes of water into the river corridor as also found in mountain stream networks by jencso et al 2009 the changes in qsub cap due to valley morphology grow in importance as qdv and qsub cap become closer in magnitude i e qdv qsub cap this is readily seen in the model simulations at very low discharge conditions qgauge 1 l s 1 fig 8a during these low discharge conditions the river corridor becomes highly sensitive to hydrologic forcing as such even the relatively small diurnal fluctuations in qdv fig 7 cause extensive network expansion and contraction at locations where the valley widens qsub cap increases and the stream network dries where the valley narrows qsub cap decreases and flow is reinitiated thus geologic factors determining valley width and slope controls the network expansion and contraction in our model in cases where heterogeneous k is considered the variation of k across orders of magnitude may be the dominant control under these conditions the storage of water in the catchment and its release as baseflow become important controls on when and where surface flow will emerge importantly there is likely a condition of extremely low discharges in which this sensitivity would disappear because minor changes in down valley discharge could be fully transported in the subsurface without activating the surface network i e when qdv qsub cap while the thresholds described above are specific to our study site the general transition to increasing importance of geologic controls under low discharges adds a dynamic context to the perceptual model we posed in section 2 we expect that the perceptual model and the systematic transitions described above will be consistent across mountain stream networks while the specific discharge and area thresholds will vary depending upon for example flow generation processes from the hillslopes the general behavior is consistent with the relationships already described in the literature godsey and kirchner 2014 still this study contributes a dynamic perspective on the activation of the flowing stream network including variation in space the geologic controls we use slope valley width and depth hydraulic conductivity to estimate down valley capacity are not included in costigan et al s 2016 framework which is framed to more broadly identify the types of landscapes in which intermittent flow may occur instead our work highlights spatial variation in specific process controls and their manifestation as patterns of stream intermittency 5 2 a critical comparison of transferability and limitations of river corridor modeling approaches to date assessment and prediction of hydrologic connectivity in the river corridor can be grouped into three main approaches table 2 empirical upscaling distributed modeling and reduced complexity modeling first empirical studies use on the ground observation or instrumentation to directly measure hydrologic connectivity at scales ranging from reaches covino et al 2011 mallard et al 2014 zimmer and mcglynn 2017 to entire networks godsey and kirchner 2014 jensen et al 2017 measurements are regressed against hydrologic or geologic parameters e g stream discharge upslope accumulated area and used to estimate processes along the entire river corridor relatively few empirical studies have been published because they are field intensive requiring substantial commitments of people s time to conduct field campaigns additionally empirical relationships are not readily transferable to other locations with different geologic settings catchment topologies and hydrologic forcing still these empirical studies directly observe the processes of interest recent work by arismendi et al 2017 demonstrates the potential for advanced statistical techniques e g hidden markov models as another strategy for upscaling empirical findings other researchers have used a similar upscaling approach but replaced direct empirical observations with simulation results from mechanistic models in these efforts data from numerical studies are regressed against geologic or hydrologic characteristics with regressions used to describe hydrologic processes as a function of readily observable properties of the landscape e g kiel and cardenas 2014 the major strength of these approaches is their rapid scaling to the stream network and ability to consider a variety of independent variables which thereby enables upscaling of small scale processes to entire stream networks gomez velez et al 2015 gomez velez and harvey 2014 kiel and cardenas 2014 these efforts assume that the processes of interest can be reasonably predicted from some measure of landscape form but do not account for feedbacks that may occur among smaller scale processes nor limitations due to the larger scale context of the process stonedahl et al 2013 2010 schmadel et al 2017 to date these studies lack any dynamic processes fully distributed top down hydrologic models can represent dynamic spatially explicit exchanges in the river corridor frei et al 2009 wondzell et al 2009a yu et al 2016 models in this class can represent processes across a suite of interacting spatial and temporal scales however these models are limited by the number of parameters required to inform the processes being simulated as a result non unique parameters prevent the identification of a single best solution e g beven 1993 2006 beven and binley 1992 such models suffer from over parameterization and a lack of the necessary data to parameterize the natural world at all relevant scales for all of the processes that are represented the reduced complexity model derived and applied in this study is concerned with mechanistic representation of the hydrologic processes perceived to be dominant in the river corridor as such the model only includes the most dominant processes identified in the perceptual model obviously many processes cannot be included ones that are not considered dominant at our scale of interest or for the purposes for which the model was conceived and constructed one clear example in this study is the parameterization of channel unit scale exchange in our model we simplify exchange at scales smaller than the 5 m valley discretization into the sum of the net up or downwelling exchange flux and the qsubgrid terms although channel unit scale exchange has been extensively studied see review by boano et al 2014 it is not a dominant mechanism for prediction of network expansion and contraction at the scales considered here still future improvements could add sub discretization exchange parameterized by metrics derived from topography e g streambed concavity anderson et al 2005 or based on empirical relationships derived for bedforms and individual features e g gomez velez et al 2015 these processes would need to be included if the model were applied to predict reactive transport particularly where exchanges with short timescales are the most important for reactive processes likewise improved representation of heterogeneity in the valley colluvium thickness t and hydraulic conductivity k would likely improve the ability of the model to reflect site specific patterns in intermittency fleckenstein et al 2006 the model also greatly simplifies hillslope valley floor stream connectivity we assumed that lateral inflows would proportional to uaa and implicitly assume that these inflows will be instantaneously synchronized with qgauge several existing studies consider spatial and temporal variability in hillslope discharge to valley bottoms e g jencso et al 2009 smith et al 2013 and could potentially be integrated to improve the representation of those inputs we elected not to parameterize these processes nor the many others that are omitted or simplified because they would increase data needs and are not considered dominant processes in our perceptual model of network expansion and contraction of course processes not included in the perceptual model may be incorrectly omitted in this case iterative advances of hypotheses field observations and mechanistic models are important to correct these deficiencies 5 3 potential applications for assessment of connectivity in the river corridor although the fine scales of field and laboratory studies are best suited to identifying the fundamental physical and biological processes that understanding must be successfully linked to cumulative effects at watershed to regional and continental scales harvey and gooseff 2015 improved understanding of dynamic hydrologic connectivity along the river corridor is increasingly of interest to water resource researchers and managers in the u s e g department of defense environmental protection agency 2014 in the wake of the rapanos v u s 2006 decision new tools are needed to quantify connectivity along river networks and thus provide both a scientific and legal basis for river corridor management for example caruso 2015 proposes the development of connectivity indices based on statistical descriptors of discharge topology and topography but lacks any mechanistic predictive power and requires extensive data collection at each point to be evaluated in contrast this study represents an advance in the application of hydrologic science to inform river corridor management the relatively low data needs enable this framework to be transferable and readily implemented to assess connectivity along the river corridor as with any model an initial implementation based on uncalibrated parameter estimates would provide only a preliminary assessment of connectivity site specific parameterization calibration and validation would be required to use this model as the sole basis for management efforts in the pacific northwestern united states the management of the river corridor increasingly depends upon understanding channel network expansion and contraction one critical location in the river corridor is the perennial initiation point or perennial flow initiation point defined as the farthest upslope location with flow during summer low flow conditions jaeger et al 2007 current practices attempt to construct empirical models to predict the locations of the perennial initiation points as a function of drainage area lithology land use and other readily identifiable independent variables e g jaeger et al 2007 clark et al 2008 wood et al 2009 comparisons among empirical predictions reduced complexity model predictions and distributed model predictions of intermittency will help develop an improved basis for management in unobserved locations we envision two immediate applications of the reduced complexity model presented here first the model could be used to design field studies initial model analyses could use feasible ranges of parameters e g hydraulic conductivity sediment thickness to determine key locations that appear to control the potential expansion contraction and changes in connectivity along the river corridor similarly sensitivity analyses could be used to identify the parameters with the greatest influence on model projections these results could then be used to plan field campaigns that would improve estimates of key parameters or identify the places and times when observations of intermittency or network extent may be most important this approach could help make the most efficient use of limited resources that might be available for field work second the model could be used as the basis of heuristic studies scaling up processes from reaches to entire networks indeed the strategy of scaling reduced complexity models to large networks even in cases when acceptable validation data are not readily available is emerging as an important area of research in the river corridor e g gomez velez et al 2015 current models do not include parametrization for mountain streams this framework could form the basis of an upscaling strategy for high gradient river networks 6 conclusions the overall objective of this study was to predict dynamic hydrologic connectivity along the river corridor to achieve this objective we selected a well studied headwater catchment to develop a perceptual model of river corridor exchange building on this perceptual model we next developed a reduced complexity mechanistic model to predict the dynamic hydrologic connectivity along the river corridor the model developed may be of broad interest for hydrologists and water resource managers working in mountain river networks while this study was designed to calibrate the reduced complexity model by leveraging detailed site specific observations we emphasize that the model was developed with potential transferability in mind the reduced complexity model has modest data requirements stream discharge catchment topography reasonable estimates of hydrogeologic parameters to generate an initial prediction at the river network scale calibration using site specific observations of discharge intermittency and or solute tracer studies can be implemented to refine predictions at sites of interest as we demonstrate here the framework is mechanistic based on a state of the science understanding of the river corridor in a mechanistic way and is capable of simulating both hydrodynamics and solute transport additionally the model is dynamic enabling the simulation of network expansion and contraction we expect the perceptual model detailed in this study is transferable to other mountain stream networks where streams reflect down valley discharge in excess of the down valley capacity importantly the reach scale success of this approach also highlights the role that heterogeneity in valley slope and width controls along network connectivity variation in bedrock topography hydraulic conductivity and individual morphologic features result in a more complex pattern of connectivity that was captured by this model figs s1 s3 this result highlights the need for future study of these processes as controls on intermittency of stream flows in this study we asked how geologic setting interacts with hydrologic forcing to produce spatial and temporal patterns of connectivity along the river corridor we expected geologic controls to dominate periods of steady flow and hydrologic controls to be important only during highly dynamic periods e g storm event responses instead we found that geologic setting controls network dynamics during relatively low discharge conditions and that the spatial patterns of lateral inflows arising from storage and release of water from hillslopes are dominant during relatively wet periods in contrast connectivity in the river corridor is highly sensitive to hydrologic dynamics under the lowest flow conditions acknowledgments data and facilities were provided by the h j andrews experimental forest research program funded by the national science foundation s nsf s long term ecological research program deb 1440409 us forest service pacific northwest research station and oregon state university wondzell was supported by nsf grant no ear 1417603 ward was supported by nsf grant no ear 1652293 tools for solute tracer time series analyses and spatial data processing were developed by ward and others with support provided in part by nsf grant nos ear 1505309 and ear 1331906 ward was also supported by the indiana university office of the vice provost for research and the indiana water resources research center this research was also supported in part by lilly endowment inc through its support for the indiana university iu pervasive technology institute and in part by the indiana metacyt initiative the indiana metacyt initiative at iu is also supported in part by lilly endowment inc any opinions findings and conclusions or recommendations expressed in this material are those of the authors and do not necessarily reflect the views of the national science foundation u s forest service or indiana university precipitation discharge and topographic data are available from the h j andrews experimental forest data catalog http andrewsforest oregonstate edu topographic survey and in stream specific conductance data are available upon request to the corresponding author the authors declare no conflicts of interest supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2018 01 018 appendix supplementary materials image application 1 image application 2 video 
844,the porous shallow water equations are commonly used to evaluate the propagation of flooding waves in the urban environment these equations may exhibit not only classic shocks rarefactions and contact discontinuities as in the ordinary two dimensional shallow water equations but also special discontinuities at abrupt porosity jumps in this paper an appropriate parameterization of the stationary weak solutions of one dimensional porous shallow water equations supplies the inner structure of the porosity jumps the exact solution of the corresponding dam break problem is presented and six different wave configurations are individuated proving that the solution exists and it is unique for given initial conditions and geometric characteristics these results can be used as a benchmark in order to validate one and two dimensional numerical models for the solution of the porous shallow water equations in addition it is presented a novel finite volume scheme where the porosity jumps are taken into account by means of a variables reconstruction approach the dam break results supplied by this numerical scheme are compared with the exact dam break results showing the promising capabilities of this numerical approach finally the advantages of the novel porosity jump definition are shown by comparison with other definitions available in the literature demonstrating its advantages and the issues raising in real world applications are discussed keywords urban flooding porous shallow water equations dam break problem exact solution numerical model variables reconstruction 1 introduction the two dimensional shallow water equations are widely used to model urban flooding events buildings and other types of solid obstacles must be taken into account because the flood wave celerity propagation guinot 2012 the mechanism of energy dissipation cosenza et al 2006 guinot et al 2017 pianese and barbiero 2003 the distribution of flow depth and flow velocity bazin et al 2017 larocque et al 2013 soares frazão and zech 2008 testa et al 2007 velickovic et al 2017 are all characteristics that depend on the building density shape and alignment in order to take into account the obstacles the classic procedure for the solution of the shallow water equations consists in excluding the buildings from the computational domain in this case the obstacles are represented by holes of the computational mesh and the corresponding solid walls are simulated by imposing reflective boundary conditions along the hole perimeter building hole method in the nomenclature by schubert et al 2008 an alternative to this procedure is considering the buildings as topographic features of the computational domain in this case a digital surface model dsm is obtained by adding the height of the buildings to the bare earth digital terrain model and the shallow water equations are subsequently solved using the dsm as bed elevation topographic input building block method in schubert et al 2008 these methodologies are time consuming because very refined computational grids are required to accurately represent the urban geometry and the street details kim et al 2015 in order to reduce the computational burden two different approaches have been proposed in the first class of models porosity models following the nomenclature by velickovic et al 2017 the solid obstacles are implicitly taken into account by the mathematical model in analogy with the equations of the single phase flow in porous media whitaker 1999 the porous shallow water equations are obtained by averaging the classic shallow water equations on a representative elementary volume containing the fluid phase and the obstacles defina 2000 guinot 2012 guinot and soares frazão 2006 in the single porosity sp models the fraction of the unit surface area that is not occupied by obstacles is denoted with the porosity parameter ϕ guinot and soares frazão 2006 in the isotropic multiple porosity mp models guinot 2012 the total porosity ϕ is the sum of ϕs and ϕm where ϕs is the fraction of the unit surface area that may be occupied by stagnant water and ϕm is the fraction of the unit surface area that may be occupied by moving water once that the mathematical model is defined in differential form an appropriate numerical method can be used to approximate the problem solution the second approach sub grid models in the nomenclature by velickovic et al 2017 uses coarse computational grids where the gaps between buildings are intersected by grid sides schubert and sanders 2012 while the street details and other topographic features are taken into account by means of sub gridding numerical procedures in each computational cell the cell based porosity ϕ ω represents the fraction of the computational cell that is not occupied by buildings while the edge based porosity ϕ γ represents the fraction of the cell edge that is not occupied by obstacles sanders et al 2008 the shallow water equations are subsequently solved using the finite volume method guinot et al 2017 özgen et al 2016 sanders et al 2008 schubert and sanders 2012 where a riemann solver is used to evaluate the mass and momentum fluxes through the cell edges the two dimensional sp shallow water equations benkhaldoun et al 2015 ferrari et al 2017 guinot and soares frazão 2006 velickovic et al 2017 can be written in the following vector form 1 ϕ u t ϕ f u x ϕ g u y h x ϕ u z x h y ϕ u z y s x y ϕ u in eq 1 the symbols are defined as follows x and y are the space variables and t is the time variable u h h u h v t is the vector of the conserved variables for unitary porosity where t denotes the matrix transpose h is the fluid depth u and v are the components of the depth averaged velocity along the x and y axes respectively f u h u p h u 2 h u v t and g u h v h u v p h v 2 t are the vectors of the fluxes along the x and y axes corresponding to unitary porosity respectively p 0 5gh 2 is the hydrostatic thrust acting on the unitary width and corresponding to unitary porosity g is the gravity acceleration z z φ t is the vector of the bed elevation z x y and the porosity ϕ x y s x y ϕ u ϕ g h 0 s x s y t is the vector of the source terms where sx and sy are representative of the forces such as bed friction and sub grid obstacles drag that are exerted by the solid boundaries on the flow along x and y respectively finally the matrices h x and h y are defined as 2 h x ϕ u 0 0 ϕ g h p 0 0 h y ϕ u 0 0 0 0 ϕ g h p the system of eq 1 whose eigen structure is discussed in ferrari et al 2017 is non linear hyperbolic and invariant under a reference rotation benkhaldoun et al 2015 guinot and soares frazão 2006 the last property allows the mathematical study of the discontinuous solutions associated to the system of eq 1 and of the corresponding numerical approximation in a one dimensional framework without loss of generality in particular the conclusions valid for the one dimensional approach can be easily extended to a two dimensional framework godlewski and raviart 1996 the non linearity of eq 1 implies that classic flow discontinuities such as moving bores can be generated even if the initial conditions together with the bed elevation and the porosity distribution are smoothly variable from a mathematical point of view the classic moving discontinuities are autonomous because the rankine hugoniot condition is sufficient to connect the states at the two sides of the discontinuity lefloch 2002 and no description of their inner structure is required nonetheless the porosity itself can be discontinuous for instance at the boundary between built up and undeveloped areas and this induces an additional class of standing discontinuities in this case the non conservative products p ϕ x and p ϕ y appearing in eq 1 have no clear mathematical meaning because they represent the product of a heaviside step by a dirac delta at geometric discontinuities such as porosity jumps an internal boundary condition must be prescribed in order to define the non conservative products and solve the eq 1 following the theory by dal maso et al 1995 the non conservative products can be regularized by defining the microscopic structure of the jump external knowledge such as experimental results cozzolino et al 2014a or other physical considerations cozzolino et al 2011 2015 2016 can be used to accomplish this task in order to define the non conservative product guinot and soares frazão 2006 took advantage of the formal similarity between the one dimensional porous shallow water equations and the one dimensional shallow water equations in variable width rectangular channels they assumed that the porosity discontinuity is equivalent to a channel width discontinuity where the pressure distribution on the transversal walls is hydrostatic successively numerous authors petaccia et al 2010 finaud guyot et al 2010 guinot 2012 velickovic et al 2017 ferrari et al 2017 incorporated the same porosity discontinuity definition in their models using a different approach castro et al 2007 and ostapenko 2012 assumed energy conservation through the geometric discontinuity in ion et al 2016 the non conservative product was defined assuming that the flow depth and the porosity were linearly variable through the discontinuity despite the abundance of porosity discontinuity definitions no methodical analysis of the corresponding riemann problem solutions has been conducted in particular there is a need to understand if the geometric discontinuity definitions that are available in the literature are physically congruent and if they lead to unique solutions in the remainder of the paper it will be demonstrated that the response to both questions is negative and a novel definition of internal boundary condition in the porous shallow water equations will be given the dam break problem is a particular case of riemann problem where the fluid is initially at rest and it is frequently used as a benchmark for shallow water numerical schemes guinot and soares frazão 2006 supplied the exact solution of the dam break problem in the case of abrupt porosity reduction using their porosity jump definition ostapenko 2012 used the energy conservation condition and showed that there are ranges of the initial conditions for which the solution of the corresponding dam break problem does not exist in order to solve this issue ostapenko 2012 introduced a class of solutions with energy loss through the discontinuity but uniqueness of the solution was lost kovyrkina and ostapenko 2013 demonstrated that in the case of channel contraction or equivalently porosity reduction the dam break solution exists and it is unique if a given fraction of the upstream energy is lost through the geometric discontinuity ion et al 2016 supplied an example of dam break problem solution under the assumption that the porosity and the flow depth varied linearly through the porosity discontinuity ferrari et al 2017 gave some example of riemann problem solution at porosity discontinuities basing their solutions on the jump definition by guinot and soares frazão 2006 but did not study the general characteristics of the problem from the literature available it is clear that the structure of the problem solution greatly depends on the non conservative product definition but a systematic investigation of these solutions has never been accomplished for this reason the dam break solution corresponding to the novel definition of internal boundary condition will be discussed in the present paper showing that six different wave configurations are possible despite the simplicity of the initial conditions and demonstrating the existence and uniqueness of the problem solution for all the values of the initial flow depth and porosity jump many authors have tackled the numerical solution of the porous shallow water equations guinot and soares frazão 2006 incorporated their definition of standing discontinuity into a finite volume numerical model whose results compared well with their exact solution of the dam break problem for the case of porosity reduction successively petaccia et al 2010 finaud guyot et al 2010 guinot 2012 and velickovic et al 2017 followed the same numerical path castro et al 2007 constructed a class of finite volume schemes for the one dimensional shallow water equations in variable width rectangular channels assuming the condition of energy conservation at width discontinuities their method generalized hydrostatic reconstruction took into account the effect of non conservative products through the geometric discontinuities by means of an appropriate reconstruction of the variables the finite volume models by benkhaldoun et al 2015 cea and vázquez cendón 2010 and wang and geng 2013 solved the porous shallow water equations by constructing roe schemes for the calculation of fluxes at the interfaces between cells in these schemes the roe linearizations did not take into account the inner structure of the porosity discontinuity mohamed 2014 constructed a two stages rusanov scheme where the non conservative product originated by the porosity variability was discretized in order to ensure the equilibrium for the water at rest solution but not for general equilibria ion et al 2016 constructed an energetically stable upwind scheme where no information about the definition of the standing wave was incorporated their numerical results showed that this introduces an incongruence between the numerical and the exact dam break problem solution ferrari et al 2017 considered a well balanced augmented roe solver which incorporated the porosity discontinuity definition by guinot and soares frazão 2006 showing a good matching between numerical and exact riemann problem solutions all the cited numerical models are based on one of the porosity definitions available in literature which are proven inconsistent from the preceding discussion it is clear that a better understanding of discontinuous solutions in sp models is required in addition there is a need to construct numerical schemes that incorporate this mathematical characterization these are precisely the objects of the present work the organization of the paper is as follows in section 2 a novel definition of the geometric discontinuity in porous shallow water equations is given and the solution of the corresponding dam break problem is discussed in section 3 a finite volume method that incorporates the novel definition of porosity discontinuity is presented and the corresponding numerical results are compared with those supplied by the variables reconstruction method by castro et al 2007 in section 4 the novel discontinuity definition is compared with existing definitions from the literature finally the paper is closed by a conclusions section 2 exact solution of the dam break problem in the literature the mathematical study of fast transients at geometric discontinuities is usually conducted by excluding the friction and the drag source terms alcrudo and benkhaldoun 2001 cozzolino et al 2014a cozzolino et al 2017 ferrari et al 2017 guinot 2012 guinot and soares frazão 2006 ostapenko 2012 because their effects are negligible in the vicinity of the initial discontinuity during a small time interval after t 0 conversely the effect of the bed slope terms is often included into the riemann problem by considering an abrupt bed elevation change the riemann problem at the bed step leads to more than twenty different solution configurations alcrudo and benkhaldoun 2001 and the structure of the riemann problem solution is expected to be even more complicated if the bed step and the porosity discontinuity are jointly considered in order to focus the attention on the inner structure of the standing discontinuities originated by abrupt porosity variations only all the source terms appearing in eq 1 are neglected and the bed is assumed horizontal considering a one dimensional framework with null transverse velocity the system of eq 1 reduces to 3 ϕ u t ϕ f u x h u ϕ x 0 where u h h u t and f u h u p h u 2 t are the reduced vectors of conserved variables and fluxes respectively while h u 0 p t is a vector which takes into account the forces exerted by the porosity variability along the x axis it is noteworthy that the eq 3 formally coincide with the shallow water equations in channels with rectangular section and variable width ϕ castro et al 2007 ostapenko 2012 and this reinterpretation will be of use in the remainder of the paper following this analogy the scalar quantity fhu u p hu 2 is the total thrust acting on the unitary width cross section the eigen structure of the system of eq 3 is discussed in castro et al 2007 and ferrari et al 2017 in the riemann problem the system of eq 3 is solved with initial conditions 4 u x 0 u l x 0 u r x 0 ϕ x ϕ l x 0 ϕ r x 0 where u l h l h l u l t and u r h r h r u r t the presence of a fixed porosity discontinuity induces solutions that are characterized by a standing flow discontinuity in x 0 the symbols u 1 h 1 h 1 u 1 t and u 2 h 2 h 2 u 2 t are used to indicate the solution of the riemann problem immediately to the left and to the right of the discontinuity for t 0 notably the classic rankine hugoniot condition is not valid through the standing porosity discontinuity because the non conservative products are active for this reason the inner structure of the discontinuity is made explicit by specifying two scalar functions γ h s u 1 u 2 and γϕ s u 1 u 2 that allow generalizing the rankine hugoniot condition dal maso et al 1995 as 5 ϕ r f u 2 ϕ l f u 1 0 0 1 g 2 γ h s u 1 u 2 2 γ ϕ s s ϕ l ϕ r d s 0 in eq 5 the functions γ h s u 1 u 2 and γϕ s ϕ l ϕ r are appropriate parameterizations of the variables h and ϕ through the discontinuity respectively these functions must satisfy some regularity assumption dal maso et al 1995 together with the conditions γ h 0 u 1 u 2 h 1 γ h 1 u 1 u 2 h 2 γϕ 0 ϕ l ϕ r ϕ l and γϕ 1 ϕ l ϕ r ϕ r in the following the symbol sw is used to indicate the standing wave discontinuity defined by eq 5 independent of the parameterization chosen the first of the two scalar equations supplied by eq 5 is ϕ r h 1 u 1 ϕ l h 2 u 2 this scalar equation corresponds to the invariance of the discharge per unit width through the discontinuity and characterizes the stationary solutions of eq 3 for this reason it is assumed the following definition 1 appropriate parameterizations of stationary weak solutions of eq 3 supply the inner structure of the sw that is used in the regularization of eq 5 the component γϕ s ϕl ϕr of the regularizing path is strictly monotonic with respect to s this definition implies that the energy is invariant through the geometric discontinuity only in the case that γ h s u 1 u 2 is smooth conversely an energy loss mechanism is automatically introduced by a standing hydraulic jump when the supercritical flow becomes subcritical through the porosity discontinuity for this reason the sw of definition 1 differs from those introduced in castro et al 2007 guinot and soares frazão 2006 ion et al 2016 ostapenko 2012 notably the monotonicity of γϕ s ϕ l ϕ r implies that critical flow conditions are possible only to the left γϕ s 0 or to the right γϕ s 0 of the geometric discontinuity this assumption makes the structure of the dam break problem very different from that presented in cozzolino et al 2017 where a channel with non monotonically variable geometric parameter is considered the initial conditions of eq 4 imply that the porosity is uniform in the regions x 0 and x 0 where the eq 3 reduces to the homogeneous one dimensional shallow water equations 6 u t f u x 0 because ϕ x 0 two genuinely non linear characteristic fields are associated to the eq 6 and the corresponding non linear waves may be either rarefactions or shocks the eigenvalues associated to the first and second characteristic field are λ 1 u u g h and λ 2 u u g h respectively the symbols si u ref s i b u r e f and ri u ref are used to denote the loci of the states u connected to the reference state u ref by a direct shock a backward shock or a rarefaction respectively that are contained into the ith characteristic field of the classic shallow water equations in addition to these waves the symbol cd u ref is used to indicate the curve of the states u having the same discharge per unit porosity and per unit width of the reference state u ref the mathematical representation of these curves in the plane h u is described in appendix a the dam breaks considered in the following sub sections are special riemann problems where ul ur 0 m s for the sake of conciseness only the initial conditions with hl hr 0 are considered and this implies that the flow moves from left to right for t 0 the solutions corresponding to the case 0 hl hr are obtained by reversing the x axis 2 1 solution configurations for sudden porosity increase ϕr ϕl in the case of sudden porosity increase four different solution configurations from w1 to w4 are possible with reference to the flow depth h an example solution for each of these configurations is represented in fig 1 a b c d and it is obtained at time t 5 s using the data contained in table 1 in fig 2 a b c d the exact solutions are reported with reference to the discharge per unit width ϕhu the numerical values of the intermediate states for the initial conditions of table 1 are reported in table 2 while the corresponding wave edge positions from left to right at time t 5 s are reported in table 3 the solution configuration w3 presented here is new while the solution configurations w1 w2 and w4 were introduced in ostapenko 2012 all the solution configurations from w1 to w4 will be presented here to discuss the global characteristics existence uniqueness fields of existence of the dam break corresponding to the novel sw definition 1 before describing the exact solution configurations it is useful to define the special states u 1 0 u 1 0 h 1 0 u 1 0 t u 2 0 u 2 0 h 2 0 u 2 0 t u 2 0 h 2 0 h 2 0 u 2 0 t and u a c h a c h a c u a c t the state u 1 0 is the state on r 1 u l characterised by critical flow conditions the state u 2 0 is defined as the supercritical state at the exit of the porosity discontinuity that is connected by the conditions of energy and discharge conservation to the state u 1 0 at the inlet the subcritical state u 2 0 is connected to u 2 0 by means of a standing hydraulic jump finally u ac is the subcritical state at the exit of the porosity discontinuity that is connected by the conditions of energy and discharge conservation to the state u 1 0 at the inlet 2 1 1 solution configurations w1 and w2 in the configuration w1 figs 1a and 2a the sw consists of the conditions of energy and discharge invariance with flow accelerating from the critical state u 1 to the supercritical state u 2 the corresponding pattern is represented in short in table 4 with the sketch notation introduced by alcrudo and benkhaldoun 2001 the symbol u i w u j means that the left hand state u i is connected to the right hand state u j by means of the generic wave w in the case of w1 the sketch notation is interpreted from left to right as follows a u l is connected to u 1 by means of a rarefaction contained in the first characteristic field b u 1 is connected to u 2 by means of sw c u 2 is connected to u 3 by means of a rarefaction contained in the first characteristic field d u 3 is connected to u r by means of a shock contained in the second characteristic field by definition the critical state u 1 coincides with the state u 1 0 while the supercritical state u 2 coincides with the state u 2 0 finally the state u 3 is found at the intersection of the curves r 1 u 2 0 and s 2 b u r the corresponding graphical construction is presented in fig 3 a and it is evident that the configuration w1 is valid only if h 3 h 2 0 in the configuration w2 figs 1b and 2b the states u 1 and u 2 coincide with the corresponding states of w1 but now the state u 2 is connected to the state u 3 by means of a shock contained into the first characteristic field the corresponding wave pattern is presented in table 4 the graphical construction used to determine the state u 3 is represented in fig 3b and it differs from that of fig 3a because u 3 is now found at the intersection of the curves s 1 u 2 0 and s 2 b u r by definition the state u 2 0 is individuated through the intersection of the curves c d u 2 0 and s 1 u 2 0 it follows that the construction presented for the configuration w2 is valid if h 2 0 h 3 h 2 0 because this condition ensures that the shock between the states u 2 and u 3 is able to exit from the initial discontinuity at x 0 in the configurations w1 and w2 the state u 1 at the porosity discontinuity is characterized by λ1 u 1 0 and then λ1 u 1 coincides with the celerity of the sw for this reason resonant conditions are established 2 1 2 solution configuration w3 in the solution configuration w3 figs 1c and 2c the internal structure of sw is composite and the flow through the porosity transition is transcritical given the coefficient ϑ i 0 1 the regularizing path consists of two reaches as follows a a smooth accelerating flow corresponding to s 0 ϑ i connects the inlet critical state u u 1 0 to a hydraulic jump in s ϑ i b a smooth decelerating flow corresponding to s ϑ i 1 connects the hydraulic jump to the outlet subcritical state u 2 the formal analogy between eq 3 and one dimensional shallow water equations in variable width rectangular channels helps to show that this sw is stable because the hydraulic jump is stable in expanding channels even if the friction is absent akers and bokhove 2008 the wave pattern corresponding to the solution configuration w3 is denoted in short in table 4 and again the critical state u 1 is found as made for configurations w1 and w2 in order to find the state u 2 it is useful to consider the locus of the admissible subcritical states at the exit of the porosity transition that can be connected by the condition of discharge invariance to the critical state u 1 this locus coincides with the arc of the curve c d u 2 0 between the states u 2 0 ϑ i 1 and u ac ϑ i 0 it is deduced that u 2 is found at the intersection of the curves c d u 2 0 and s 2 b u r subject to the condition that h 2 0 h 2 h a c because the discharge per unit width and unit porosity q 2 h 2 u 2 corresponding to the state u 2 coincides with that of the states u 2 0 u 2 0 and u ac the corresponding graphical construction is represented in fig 3c note that a resonant regime is established in the configuration w3 because λ1 u 1 0 2 1 3 solution configuration w4 in the solution configuration w4 figs 1d and 2d sw connects the subcritical states u 1 and u 2 by means of the conditions of energy and discharge invariance the corresponding solution wave pattern coincides with that of the configuration w3 table 4 to find the solution of the dam break problem for the configuration w4 it is useful to define the curve as u l as the locus of the admissible non supercritical states at the exit of the porosity transition that are connected by the conditions of discharge and energy invariance to the subcritical states of the curve r 1 u l in the case of sudden porosity increase direct calculations show that the curveas u l is represented in the h u plane by a strictly decreasing curve whose extremes are the subcritical states u ac and u l see fig 3d once that as u l is defined the state u 2 is found at the intersection of as u l and s 2 b u r the graphical construction used to find u 2 is represented in fig 3d and it is valid if hac h 2 hl correspondingly the state u 1 is the state of r 1 u l that satisfies the condition ϕ r h 1 u 1 ϕ l h 2 u 2 2 2 solution configurations for sudden porosity decrease ϕr ϕl in the case of sudden porosity decrease two different solution configurations namely c1 and c2 are possible an example solution for these configurations is represented in figs 1 e f and 2 e f and it is obtained for time t 5 s using the data contained in table 1 the numerical values of the intermediate states for the initial conditions of table 1 are reported in table 2 while the corresponding wave edge positions from left to right at time t 5 s are reported in table 3 these solutions coincide with those presented in ostapenko 2012 but they are succinctly presented here in order to discuss the global characteristics of the dam break solutions 2 2 1 solution configuration c1 the state u 1 must be subcritical because the energy corresponding to the critical state lying on the curve r 1 u l is not sufficient to make the flow pass through the porosity reduction in the solution configuration c1 figs 1e and 2e sw connects the subcritical state u 1 to the critical state u 2 by means of the conditions of energy and discharge invariance and the flow is chocked the corresponding wave pattern coincides with that of the configuration w1 see table 4 recalling the definition of the curve as u l direct calculations show that the left extreme u ac of as u l is critical in the case ϕr ϕl and then u 2 u ac the state u 3 is found at the intersection of the curves r 1 u ac and s 2 b u r while the state u 1 is the state of r 1 u l that ensures the discharge conservation through the porosity discontinuity the configuration c1 is possible for h 3 hac and the corresponding graphical construction is represented in fig 4 a notably a resonant regime is established in the solution configuration c1 because λ1 u 2 0 2 2 2 solution configuration c2 in the solution configuration c2 figs 1b and 2b the flow is smooth through the width transition and the wave sw connects the subcritical states u 1 and u 2 by means of the conditions of energy and discharge invariance the corresponding wave pattern coincides with that of configurations w3 and w4 see table 4 once that the curve as u l is defined the state u 2 is found at the intersection of as u l and s 2 b u r finally the state u 1 is the state of r 1 u l which ensures the discharge invariance through the geometric discontinuity the graphical construction used to find u 2 is represented in fig 4b and it is valid if hac h 2 hl 2 3 global characteristics of the solution 2 3 1 existence and uniqueness in the case of sudden porosity increase the solution of the dam break problem is determined by the intersection between the curve s 2 b u r and one of the following curves the curve r 1 u 2 0 configuration w1 construction of fig 3a the reach of the curve s 1 u 2 0 between the states u 2 0 and u 2 0 configuration w2 fig 3b the reach of the curve c d u 2 0 between the states u 2 0 and u ac configuration w3 fig 3c and the curve as u l configuration w4 fig 3d the union of these curves constitutes the solution locus sl u l which is represented in the plane h h l u g h l of the fig 5 a for the case ϕr ϕl 1 5 in the plane h h l u g h l the curves s 2 b u r and sl u l are strictly increasing and strictly decreasing respectively it is easy to see that their intersection exists and it is unique for given values of hr hl 0 1 and ϕr ϕl 1 proving that the solution of the dam break problem exists and it is unique in the case of sudden porosity decrease the solution is determined by the intersection between the curve s 2 b u r and the curve r 1 u ac configuration c1 construction of fig 4a or the curveas u l configuration c2 fig 4b the corresponding solution locus sl u l is represented in the plane h h l u g h l of the fig 5b for the case ϕr ϕl 0 5 again arguments analogous to those used in the case of sudden porosity increase lead to the conclusion that the intersection between the curves sl u l and s 2 b u r exists and it is unique for given values of hr hl 0 1 and ϕr ϕl 0 1 for increasing values of the ratio hr hl the curves of the family s 2 b u r exhibit increasing slope and shift rightwards in the h h l u g h l plane while the intersection point with sl u l moves along the solution locus itself let α β and γ be the values of the ratio hr hl for which the intersection between s 2 b u r and sl u l coincides with the states u 2 0 u 2 0 and u ac respectively when ϕr ϕl 1 in a similar manner let δ be the value of the ratio hr hl for which the intersection between s 2 b u r and sl u l coincides with the state u ac when ϕr ϕl 0 1 the corresponding curves α α ϕ r ϕ l β β ϕ r ϕ l γ γ ϕ r ϕ l and δ δ ϕ r ϕ l are represented in fig 6 the regions of the plane hr hl ϕr ϕl bounded by these curves represent the non overlapping fields of existence of the solution configurations 2 3 2 limit condition between w3 and w4 in the solution configuration w4 the subcritical state u 2 is connected to the state u 1 by means of the conditions of energy and discharge invariance this is not true in the solution configuration w3 where the subcritical state u 2 is connected to the state u 1 by means of the condition of discharge invariance only for this reason a criterion able to distinguish between the two configurations is needed in practical calculations at sudden porosity increases the solution configurations w3 and w4 are characterised as follows in the solution configuration w3 the subcritical state u 2 satisfies the inequalities f h u u 2 0 f h u u 2 f h u u a c in the solution configuration w4 the subcritical state u 2 satisfies the inequalities fhu u ac fhu u 2 fhu u l this is evident from fig 7 where the dimensionless total thrust λ f h u u 0 5 g h l 2 is plotted for all the states u sl u l between u 2 0 and u l with reference to the case ϕr ϕl 1 5 these inequalities will be of use for the construction of the numerical method presented in the remainder of the paper 3 finite volume numerical modelling in standard first order finite volume schemes the quantities used for the calculation of the fluxes at the interfaces coincide with the cell averaged values of the conserved variables this is in contrast with the need of enforcing the equilibrium solution when geometric discontinuities such as bed steps or porosity jumps are present in the flow field a successful strategy is based on a modification of the variables used for the calculation of conservative fluxes and non conservative products such a strategy which is inspired by audusse et al 2004 has been used to approximate the solution of the shallow water equations with bottom discontinuities caleffi and valiani 2009 castro et al 2007 cozzolino et al 2011 noelle et al 2007 thanh 2013 castro et al 2007 have extended the same approach to the case of the one dimensional shallow water equations with variable width where the energy invariance is enforced at width transitions two first order well balanced finite volume schemes for the approximate solution of eq 3 with reconstruction of the variables at the interfaces are described in the following subsection in the first scheme which coincides with that by castro et al 2007 the variables reconstruction is based on the energy and discharge invariance through the porosity discontinuity in the second scheme the inner structure of the sw at the porosity discontinuities is taken into account explicitly because stationary weak solutions of eq 3 are used to supply the information required for the variables reconstruction procedure the ability of the schemes to reproduce the dam break solutions is subsequently tested 3 1 algorithms description consider the solution of the system of eq 3 where the initial conditions u x 0 u 0 x and the porosity distribution ϕ x are specified the one dimensional physical domain is partitioned into non overlapping cells c i x i 1 2 x i 1 2 whose length δ x x i 1 2 x i 1 2 is assumed uniform for the sake of simplicity let 7 ϕ i 1 δ x c i ϕ x d x u i n h i n h i n u i n t 1 ϕ i δ x c i ϕ x u x t n d x be the cell averaged values of the porosity ϕ and the vector u at the time level tn nδt respectively the solution is advanced from the time level tn to the time level tn 1 by means of the following first order finite volume scheme 8 ϕ i u i n 1 ϕ i u i n δ t δ x ϕ i 1 2 g u i 1 2 u i 1 2 ϕ i 1 2 g u i 1 2 u i 1 2 δ t δ x s i 1 2 s i 1 2 where 9 s i 1 2 ϕ i f u i 1 2 r ϕ i 1 2 f u i 1 2 s i 1 2 ϕ i 1 2 f u i 1 2 ϕ i f u i 1 2 r in eq 8 the vector g u u is the numerical flux corresponding to an approximate or exact riemann solver for the homogeneous shallow water equations of eq 6 in particular g u u must be congruent in the sense that g u u f u in the present case the hlle riemann solver is used where the extreme celerities are approximated as in cozzolino et al 2014b but different choices are possible the comparison with the eq 5 shows that the term s i 1 2 defined by eq 9 represents the contribution to the cell ci of the non conservative product h u ϕ x through the interface x i 1 2 similarly the term s i 1 2 is the contribution to the cell ci of the non conservative product through the interface x i 1 2 at the interface i 1 2 between the cells i and i 1 the variables ϕ i 1 2 u i 1 2 u i 1 2 u i 1 2 r and u i 1 2 r are reconstructed in order to satisfy the generalized rankine hugoniot condition defined by eq 5 after an appropriate choice of the regularizing path note that the reconstructed variables u i 1 2 and u i 1 2 are used to calculate both numerical fluxes and interface non conservative products while the reconstructed variables u i 1 2 r and u i 1 2 r are used only for the non conservative products calculation to the best of writers knowledge the additional reconstructed variables u i 1 2 r and u i 1 2 r are presented here for the first time because the existing reconstruction methods audusse et al 2004 caleffi and valiani 2009 castro et al 2007 cozzolino et al 2011 noelle et al 2007 and thanh 2013 simply reduce to the case u i 1 2 r u i n and u i 1 2 r u i 1 n after this premise the reconstruction technique by castro et al 2007 and a novel reconstruction technique presented in this work are described in the following 3 1 1 reconstruction technique by castro et al 2007 when the flow through the geometric discontinuity is smooth the sw of eq 5 reduces to the conditions of discharge and energy invariance if the state u h h u t with the porosity ϕ is connected to the reference state u r e f h r e f h r e f u r e f t with porosity ϕref the conditions of energy and discharge invariance reduce to the following system 10 h ϕ r e f h r e f u r e f 2 2 g ϕ h 2 h r e f u r e f 2 2 g u ϕ r e f h r e f u r e f ϕ h let ω f 27 f 2 2 f 2 3 be a function of the froude number f u u g h if ϕ u ref and ϕref are given the formulas by valiani and caleffi 2008 can be used to solve the first of eq 10 with respect to h under the condition ϕ ϕmin where ϕ min ϕ r e f ω f u r e f when ϕ ϕmin two distinct solutions are possible one for subcritical u corresponding to f 2 u 1 and the other for supercritical u characterized by f 2 u 1 respectively the supercritical solution is taken if f 2 u ref 1 otherwise the subcritical solution is chosen when ϕ ϕmin the uniquely admissible solution u corresponds to critical conditions f 2 u 1 once the flow depth is known the flow velocity u can be calculated using the second of eq 10 after this premise the reconstruction technique by castro et al 2007 is described with reference to the interface i 1 2 between cells ci and ci 1 case a ϕ i ϕ i 1 simply take ϕ i 1 2 ϕ i u i 1 2 u i n u i 1 2 u i 1 n u i 1 2 r u i n and u i 1 2 r u i 1 n case b ϕ i ϕ i 1 the quantity ϕ min ϕ i 1 ω f u i 1 n is calculated case b1 ϕmin ϕ i ϕ i 1 set ϕ i 1 2 ϕ i the state u i 1 2 is the solution of eq 10 where ϕ ϕ i 1 2 ϕ ref ϕ i 1 and u r e f u i 1 n after this set u i 1 2 u i n u i 1 2 r u i n and u i 1 2 r u i 1 n case b2 ϕ i ϕmin ϕ i 1 set ϕ i 1 2 ϕ min and calculate u i 1 2 as in the case b1 the state u i 1 2 is the solution of eq 10 where ϕ ϕ i 1 2 ϕ ref ϕ i and u r e f u i n finally set u i 1 2 r u i n and u i 1 2 r u i 1 n case c ϕ i ϕ i 1 the case b is simply mirrored it is evident that in the case of the reconstruction technique by castro et al 2007 the quantities u i 1 2 r and u i 1 2 r coincide with u i n and u i 1 n respectively 3 1 2 novel reconstruction technique the novel reconstruction technique aims at detecting the cases where u i 1 2 r and u i 1 2 r differ from u i n and u i 1 n respectively because a rarefaction wave is attached to the sw with porosity increase resonant conditions of solution configurations w1 w2 and w3 in particular it is assumed here that the state u i n is connected to the critical state u i 1 2 r by means of the wave r 1 u i n when the following three conditions are met 1 the fluid is flowing through a porosity increase ui 0 u i 1 0 ϕ i ϕ i 1 2 the energy of the reference state u r e f u i 1 n corresponding to the reference porosity ϕ ref ϕ i 1 is not sufficient to reconstruct the flow state u i 1 2 corresponding to the porosity ϕ i case b2 of the approach by castro et al 2007 3 the state u i n is subcritical if all these conditions are satisfied and the state u i 1 n is supercritical the configurations w1 or w2 are assumed in this case the invariance of discharge and energy are applied through the porosity discontinuity when the state u i 1 n is subcritical a criterion based on the total thrust is used to detect the correct solution configuration the conditions of discharge and energy invariance are imposed in the case w4 while the condition of discharge invariance only is used in the case w3 one of the ingredients of the novel reconstruction technique is the evaluation of the flow state u h h u t that is characterized by discharge per unit width hu qref and total thrust fhu u fref this task is accomplished by solving the system 11 g h 2 2 q r e f 2 h f r e f u q r e f h if fref f min where f min 3 2 g q r e f 4 3 the eq 11 has no solution if fref f min the formulas contained in valiani and caleffi 2008 can be used to solve the first of eq 11 with respect to h when fref f min two distinct solutions are possible one for subcritical u f 2 u 1 and the other for supercritical u f 2 u 1 respectively when fref f min the uniquely admissible solution u is critical f 2 u 1 once that h is known the second of eq 11 is used to evaluate the flow velocity u in the novel reconstruction technique the case b2 by castro et al 2007 is reformulated as follows case b2 ϕ i ϕmin ϕ i 1 evaluate the set of conditions ct ui 0 u i 1 0 f 2 u i n 1 case b2 1 one or more conditions of the set ct are not satisfied do as in the case b2 of the reconstruction technique by castro et al 2007 case b2 2 all the conditions of the set ct are satisfied evaluate the critical state u 1 0 lying on the rarefaction curve r 1 u i n and set ϕ i 1 2 ϕ i 1 calculate both supercritical solution u 2 0 and subcritical solution u ac of the eq 10 where ϕ ϕ i 1 2 ϕ ref ϕ i and u r e f u 1 0 after this set u i 1 2 r u 1 0 u i 1 2 r u i 1 n and u i 1 2 u i 1 n evaluate f 2 u i 1 n case b 2 2 1 f 2 u i 1 n 1 set u i 1 2 u 2 0 case b 2 2 2 f 2 u i 1 n 1 evaluate the total thrusts f h u u 2 0 fhu u ac and f h u u i 1 n if f h u u 2 0 f h u u i 1 n set u i 1 2 u 2 0 if f h u u a c f h u u i 1 n set u i 1 2 u a c if f h u u 2 0 f h u u i 1 n f h u u a c set f r e f f h u u i 1 n and q r e f h 1 0 u 1 0 ϕ i ϕ i 1 2 and let the state u i 1 2 be the subcritical solution of eq 11 3 1 3 remarks note that the similarities between the novel reconstruction technique and the reconstruction technique by thanh 2013 are superficial because the case of energy loss hydraulic jump through the porosity discontinuity and the additional reconstructed states u i 1 2 r and u i 1 2 r are not taken into account in thanh 2013 it is important to observe that the proposed variables reconstruction procedure ensures that the energy of the reconstructed states is not greater than the energy of the cell averaged states in the case u i 1 2 r u 1 0 resonant conditions it is immediate to show that e u i 1 2 r e u i n h i n f u i n 1 2 3 e u i n for f u i n 0 1 where e u is the specific energy corresponding to the generic state u in the case u i 1 2 r u i n that is largely more frequent e u i 1 2 r e u i n is obtained interestingly the reconstruction u i 1 2 r u i n is obtained when stationary flow conditions are attained in the vicinity of the discontinuity and resonant conditions are then excluded in other words the energy invariance between cell averaged and reconstructed variables is preserved in steady flow conditions as expected 3 2 dam break tests the dam break test cases of table 1 are simulated by means of the numerical scheme of eqs 7 9 in each numerical test a closed gate is located at the centre x 0 m of a horizontal frictionless channel l 100 m long where the upstream and downstream boundary conditions consist of reflective walls the channel is initially filled with water at rest h x 0 hl for x 0 h x 0 hr for x 0 and u x 0 0 everywhere and the instantaneous removal of the gate causes the formation of a dam break phenomenon in the first set of tests the variables are reconstructed following the procedure by castro et al 2007 the tests are then repeated using the novel reconstruction technique proposed in the present paper for the sake of simplicity the constant values δx 0 2 m and δt 0 01 s are taken in all the cases the dam break results supplied by the two numerical procedures are compared with the exact solution in fig 8 flow depth h and fig 9 discharge per unit width ϕhu from the inspection of the two figures it is clear that the numerical results are very close to the corresponding exact solutions but some difference between the performances of the variables reconstruction procedures can be inferred as explained in the following in fig 8a the flow depth results are plotted for the solution configuration w1 it is evident that both the numerical procedures are able to capture the rarefaction at the left of the gate and the sw at the right of the gate the numerical diffusion causes the merging of the state u 3 with the rarefaction and the advancing shock more interestingly the classic variables reconstruction by castro et al 2007 generates a spurious wave between the supercritical state u 2 and the rarefaction wave downstream this additional wave is present also in fig 9 a where the corresponding discharges are plotted in figs 8b and 9b the results corresponding to the solution configuration w2 are plotted in this case the effects of the numerical diffusion are less evident because the strength of the faster shock at the right of the gate is increased with respect to the case of the solution configuration w1 from the comparison between the numerical results supplied by the two reconstruction procedures it is clear that the classic reconstruction by castro et al 2007 is slightly less efficient in capturing the position of the slower shock to the right of the gate in fig 8c the flow depth results are plotted for the solution configuration w3 the inspection of this panel seems to suggest that the results supplied by the two reconstruction procedures coincide actually this is not the case as it is evident from fig 9c the classic reconstruction by castro et al 2007 is not able to detect the existence of the hydraulic jump located through the discontinuity and this fact induces an inconsistency between the flux and the source term discretisations the corresponding momentum imbalance is detected as a spike in the discharge plot of fig 9c dashed line conversely the novel reconstruction procedure ensures the balance between fluxes and geometric terms through the porosity discontinuity and this is evident because the corresponding discharge plot continuous line is smooth in the vicinity of x 0 m the numerical results supplied by the two reconstruction procedures for the solution configurations w4 c1 and c2 are represented in figs 8 and 9 d e f the comparison between the numerical results and the exact solution shows that both reconstruction procedures behave nicely when the flow remains subcritical through the porosity discontinuity 4 discussion in this section the novel porosity discontinuity definition is compared with other definitions available in the literature castro et al 2007 guinot and soares frazão 2006 ion et al 2016 and ostapenko 2012 showing its advantages in addition the integral porosity numerical schemes by sanders et al 2008 and guinot et al 2017 are rewritten in the framework of eq 8 for further comparison finally the practical issues related to the application of the numerical approach introduced in the present paper are discussed 4 1 the sw definitions by castro et al 2007 and ostapenko 2012 castro et al 2007 assumed the condition of energy invariance for the definition of the sw but did not solve the corresponding dam break problem later ostapenko 2012 made the same assumption and showed that the solution of the dam break problem with ϕr ϕl is incomplete to overcome this difficulty he introduced the following additional sw definition ostapenko 2012 the flow conditions are critical at the discontinuity inlet and subcritical or critical at the outlet while a fraction of the energy upstream is lost through the discontinuity by means of an unspecified energy loss mechanism the solution locus corresponding to the definitions by ostapenko 2012 is plotted in fig 10 for the case ϕr ϕl 1 5 it differs from that contained in fig 5a for the presence of the additional reach u c u 2 0 which lies along c d u 2 0 in the same fashion of the reach u 2 0 u ac the state u c is the critical state lying on the curve c d u 2 0 and for this reason it corresponds to a condition of minimal energy this implies that the energy loss through the porosity discontinuity is increased along the curve c d u 2 0 moving from the state u ac to the state u c the inspection of the figure shows that the sw definition by ostapenko 2012 leads to multiple solutions because there is a range of hr hl values for which two alternative flow conditions are possible unfortunately ostapenko 2012 did not suggest a physically consistent criterion that was able to pick the relevant solution between the two alternatives readdressing the modeler to laboratory experiences to be accomplished case by case the arguments used in the present paper to establish the solution configuration w3 imply that the energy loss mechanism along the reach u 2 0 u ac is the hydraulic jump for this reason an additional energy loss mechanism such as friction must be invoked to explain the increase of energy loss along the reach u c u 2 0 nonetheless friction losses are absent along the other reaches of the solution locus and this makes the model inconsistent the model inconsistency the lack of uniqueness of the solution and the lack of a criterion for the choice of the physically congruent solution are major defects of the discontinuity formulation by ostapenko 2012 in the present work the consistency between the sw with energy invariance and the sw with energy loss is guaranteed by definition 1 because the energy loss mechanism is specified by the stationary solutions of eq 3 more importantly there is no need to resort to any disambiguation criterion for all these reasons the definition 1 should be preferred over the sw definition by castro et al 2007 and ostapenko 2012 the definition of the sw discontinuities as stationary weak solutions of eq 3 the proof of existence and uniqueness of the dam break problem for each possible initial condition as well as the plot of the solution fields of existence fig 6 are all novel results with respect to those contained in castro et al 2007 ostapenko 2012 4 2 the sw definition by guinot and soares frazão 2006 in guinot and soares frazão 2006 the sw of eq 5 is defined as 12 ϕ l h 1 u 1 ϕ r h 2 u 2 min ϕ l ϕ r g h 1 2 2 ϕ l h 1 u 1 2 min ϕ l ϕ r g h 2 2 2 ϕ r h 2 u 2 2 although the eq 12 is exact in the case of water at rest u 1 u 2 0 m s and h 1 h 2 it can lead to physical inconsistencies when the fluid velocity is not null in order to shed light on this issue consider the following example 1 a dam break problem is given with the following initial conditions hl 1 m ϕl 0 2 hr 0 9 m ϕr 0 6 after the dam removal the movement of the fluid from left to right is started by a rarefaction wave that moves upstream and by a shock wave that moves downstream submerged subcritical flow is expected through the discontinuity because hr is very close to hl recalling that the states u 1 and u 2 at the two sides of the porosity discontinuity are connected by the sw definition of eq 12 with ϕl ϕr the solution of the dam break problem is equivalent to the solution of the following non linear system 13 u 1 2 g h l 2 g h 1 ϕ l h 1 u 1 ϕ r h 2 u 2 ϕ l g h 1 2 2 ϕ l h 1 u 1 2 ϕ l g h 2 2 2 ϕ r h 2 u 2 2 u 2 h 2 h r g 2 1 h 2 1 h r the calculations supply the values h 1 0 921 m u 1 0 252 m s h 2 0 925 m and u 2 0 0836 m s showing that the flow moves from the left to the right the corresponding froude numbers are f u 1 0 0838 and f u 2 0 0277 and this confirms that the flow through the discontinuity is subcritical the specific energy values associated to the states u 1 and u 2 are e u 1 0 924 m and e u 2 0 926 m respectively this implies that the solution has no physical meaning because the flow energy increases through the sw the example 1 shows that there are initial conditions for which the dam break has no physical solution when the eq 12 is used for the definition of the sw interestingly the example is characterized by subcritical flow through the porosity discontinuity and it is possible to demonstrate the following proposition proposition 1 the sw of eq 12 cannot connect the subcritical state u 1 to the subcritical state u 2 through a sudden porosity increase because this implies an unphysical increase of energy proof the proof is contained in appendix b from proposition 1 and example 1 it is clear that the use of the eq 12 has a number of consequences the discontinuity definition of eq 12 is incongruent from a physical point of view because it may violate a fundamental physical constraint the numerical models equipped with the sw of eq 12 may supply numerical solutions that violate a fundamental physical constraint unphysical solutions during transients are not originated by pathological or exotic classes of initial conditions because this is what always happens in dam break problems with hr close to hl see example 1 in particular unphysical solutions may arise when the flow is close to the rest the unphysical creation of energy at discontinuities may affect the calibration of the dissipative effects introduced by bed roughness and building drag coefficients in conclusion the sw definition of eq 12 by guinot and soares frazão 2006 is problematic from both physical and computational points of view and the definitions that ensure no increase of energy through the discontinuity should be preferred in the literature the discontinuity definition by guinot and soares frazão 2006 has been extensively adopted for the numerical solution of the sp shallow water equations ferrari et al 2017 finaud guyot et al 2010 petaccia et al 2010 and velickovic et al 2017 all these numerical models inherit from eq 12 the unphysical production of energy at sudden porosity increase when the flow is subcritical the same observation applies to the mp models by guinot 2012 where the non conservative products are defined using eq 12 4 3 the sw definition by ion et al 2016 in ion et al 2016 the canonical family of straight lines is used to parameterize the flow depth and the porosity through the porosity discontinuity 14 γ h s u 1 u 2 h 1 s h 2 h 1 γ ϕ s ϕ l ϕ r ϕ l s ϕ l ϕ r s 0 1 this leads to the following generalized rankine hugoniot condition 15 ϕ l h 1 u 1 ϕ r h 2 u 2 ϕ l g h 1 2 2 ϕ l h 1 u 1 2 ϕ r ϕ l g h 2 2 h 1 h 2 h 1 2 6 ϕ r g h 2 2 2 ϕ r h 2 u 2 2 although the canonical family of straight lines is widely used for the definition of non conservative products dal maso et al 1995 it can lead to physical incongruences as it is evident in the following example 2 the sw definition of eq 15 is adopted and a dam break problem with the following initial conditions is considered hl 1 m ϕl 0 8 hr 0 9 m ϕr 0 4 the third of eq 13 is substituted with the second of eq 15 and the calculations supply the values h 1 0 967 m u 1 0 105 m s f u 1 0 0642 h 2 0 966 m u 2 0 211 m s and f u 2 0 0687 it is evident that the water flows from left to right as expected but the flow energy increases through the sw because e u 1 e u 2 0 00019 m this implies that the solution has no physical meaning from example 2 it is clear that the sw definition of eq 15 cannot be recommended in general 4 4 the closure model in sanders et al 2008 and guinot et al 2017 the integral porosity ip model by sanders et al 2008 and the dual integral porosity dip model by guinot et al 2017 are written in integral form under the assumption that the cell based porosity ϕ ω differs from the edge based porosity ϕ γ in particular physical arguments guinot et al 2017 based on the propagation celerity of small disturbances show that the construction of the ip and dip computational meshes should satisfy the condition ϕ ω ϕ γ in the present sub section the ip and dip models are considered in a one dimensional setting for the sake of simplicity and the additional following assumptions are made the bed is horizontal the building drag and the bed friction are negligible and the interface momentum dissipation mechanism introduced in guinot et al 2017 is absent in this case the ip and dip models can be rewritten as 16 ϕ ω i u i n 1 ϕ ω i u i n δ t δ x ϕ γ i 1 2 g u i 1 2 u i 1 2 ϕ γ i 1 2 g u i 1 2 u i 1 2 δ t δ x s i 1 2 s i 1 2 where ϕω i is the cell based porosity in the ith control volume ϕ γ i 1 2 is the edge based porosity on the interface between the control volumes i and i 1 and the geometric term contributions are defined as 17 s i 1 2 ϕ ω i ϕ γ i 1 2 0 0 5 g h i 2 t s i 1 2 ϕ γ i 1 2 ϕ ω i 0 0 5 g h i 2 t in order to define the edge variables u i 1 2 and u i 1 2 at the two sides of the interface between the control volumes i and i 1 a closure model is required guinot et al 2017 in the ip model by sanders et al 2008 the positions u i 1 2 u i and u i 1 2 u i 1 are made but the in cell mass conservation principle in stationary flow conditions is violated in fact the position by sanders et al 2008 does not satisfy the equation 18 ϕ γ i 1 2 h i 1 2 u i 1 2 ϕ ω i h i u i ϕ γ i 1 2 h i 1 2 u i 1 2 ϕ ω i 1 h i 1 u i 1 in the dip model by guinot et al 2017 the in cell mass conservation is restored by means of the eq 18 and the additional positions h i 1 2 h i and h i 1 2 h i 1 are made but the in cell energy invariance principle is not preserved in steady flow conditions in fact it is easy to verify that 19 e u i 1 2 h i ϕ ω i ϕ γ i 1 2 2 u i 2 2 g e u i n and the inequality follows because the wave congruence condition guinot et al 2017 prescribes that ϕ γ i 1 2 min ϕ ω i ϕ ω i 1 the creation of energy between the cell based variables and the edge based variables in steady flow conditions is ruled by the closure model only and not by a physical mechanism the comparison between eqs 8 and 16 shows that the choice of a closure model in the ip and dip models is equivalent to the choice of an appropriate variable reconstruction connecting the cell averaged variables with the edge variables it seems clear that the ip and the dip models could benefit from adopting a procedure of interface variables reconstruction and geometric terms calculation based on the definition of the sw as a stationary solution of eq 3 this approach could rule out unphysical energy creation in stationary flow conditions allowing a more accurate calibration of bed and building drag terms sanders et al 2008 guinot et al 2017 and of interface momentum dissipation terms guinot et al 2017 to this aim it is observed that the riemann problem at the interface between cells i and i 1 with ϕ γ i 1 2 min ϕ ω i ϕ ω i 1 is analogous to the riemann problem in rectangular channels with obstructions and constrictions bridge piles venturi flumes thanks to the formal analogy between the one dimensional sp shallow water equations and the shallow water equations in channels with rectangular section the exact solution of the corresponding dam break problems is discussed in cozzolino et al 2017 and the results presented in that paper could constitute a guide for future development 4 5 application to real world problems and further developments real world problems require the ability of coping with the bed elevation variability terms the bed friction and the building drag source terms and the two dimensional nature of the original equations the practical issues related to the application of the exact and numerical approaches introduced in the present paper and the corresponding future developments are outlined in the present sub section 4 5 1 bed elevation term in finite volume schemes the conserved variables and the geometric input are usually represented as cell averaged quantities and this approach automatically induces a discontinuity of flow variables depth and velocity and geometric variables bed elevation and porosity at the interface between cells for this reason the approaches based on the solution of a riemann problem that includes bed elevation and porosity discontinuities are common in the literature guinot and soares frazão 2006 finaud guyot et al 2010 ferrari et al 2017 in the present paper it has been shown that the dam break problem at porosity discontinuities exhibits physically consistent solutions in the case that the stationary weak solutions of eq 3 are used to define the generalized rankine hugoniot of eq 5 as shown in the preceding section this result supports a numerical scheme where the numerical computation of flux and non conservative products relies on a variable reconstruction approach that makes use of the corresponding sw definition the addition of the bed elevation variability term in eq 3 leads to 20 ϕ u t ϕ f u x h ϕ u z x 0 where 21 h ϕ u 0 0 ϕ g h p the eq 20 is formally similar to eq 3 and admits a numerical discretization in the form of eq 8 in the case of bed elevation variations the stationary weak solutions of eq 20 could be used to supply a sw definition at porosity and bed elevation discontinuities and the same sw definition could be used to reconstruct the variables for the numerical computation of flux and non conservative products this approach which is not trivial because the two geometric non conservative products interact non linearly will be the subject of future research 4 5 2 generalization to the two dimensional case let the two dimensional computational domain be decomposed in adjacent and non superposing convex polygons finite volumes if ω i is the area of the finite volume ci it is possible to consider the cell averaged values 22 z i z i ϕ i t 1 ω i c i z x y d x d y u i n h i n h i n u i n h i n v i n t 1 ϕ i ω i c i ϕ x y u x y t n d x d y of the geometric characteristics bed elevation and porosity and of the conserved variables if the variables reconstruction approach is extended to the two dimensional case the frictionless part of eq 1 admits the following explicit first order finite volume discretization godlewski and raviart 1996 guinot and soares frazão 2006 23 ϕ i u i n 1 ϕ i u i n δ t ω i j n i γ i j ϕ i j φ u i j u i j n i j δ t ω i j n i s i j in eq 23 the symbols have the following meaning n i is the set of indices j such that cj is a neighbor of ci γij is the length of the edge eij between ci and cj n ij is the normal to the edge eij orientated from ci to cj u i j and u i j are the values of the variable u that are reconstructed to the left and to the right of eij respectively ϕij is the value of ϕ reconstructed on eij φ u v n ij is a riemann flux corresponding to the two dimensional homogeneous shallow water equations such that φ u v n ij φ v u n ij and φ u u n ij k u n ij with k u n i j f u g u n i j s ij is the contribution to the cell ci of the geometric non conservative products through the edge eij in order to be congruent with the variables reconstruction procedure the vector s ij can be calculated as 24 s i j γ i j ϕ i j k u i j n i j ϕ i k u i n n i j the study of an appropriate variables reconstruction procedure in a two dimensional framework is not a trivial task and also this point deserves additional research efforts 4 5 3 bed friction and building drag source terms the bed friction and the building drag source term are different in nature with respect to the bed elevation and the porosity variability terms and a two step time splitting procedure can be adopted guinot and soares frazão 2006 sanders et al 2008 guinot et al 2017 as follows during the first time step the frictionless part of eq 1 is solved by means of eq 23 successively the conserved variables are updated by means of the implicit second time step where the source term s x y ϕ u only is taken into account 5 conclusions the complete characterization of the dam break problem at porosity jumps in one dimensional porous shallow water equations has been provided in this paper under the assumption that the porosity discontinuity inner structure is described by an appropriate parameterization of the stationary weak solutions of the one dimensional porous shallow water equations the graphic construction needed to solve the dam break problem has been supplied for each of the six possible wave configurations connecting the initial left and right states the inspection of the geometric constructions shows that the solution of the dam break problem always exists and it is unique and it is completely determined by the initial conditions and by the porosity jump among the others the solution configuration w3 is very interesting because the presence of a hydraulic jump through the geometric discontinuity causes a local energy loss and existing numerical methods for the approximate solution of the porous shallow water equations are not able to capture this feature a novel variables reconstruction technique which can be used in finite volume schemes for the approximate solution of the one dimensional porous shallow water equations has been proposed this approach takes into account the inner structure of the porosity jumps detecting the cases where the flow energy is dissipated through the geometric discontinuity the dam break results supplied by a finite volume numerical scheme equipped with the novel variables reconstruction approach have been compared with the exact dam break solutions showing the promising capabilities of the method in particular it has been shown that the wave structure of the dam break problem is captured in a variety of circumstances and that the momentum balance is enforced also in the case that a hydraulic jump is present through the geometric discontinuity at the present the proposed numerical approach is not able to take into account the cases of variable bed elevation and additional research efforts are required to cope with real world problems finally the novel porosity discontinuity definition has been compared with others existing in the literature and its advantages have been demonstrated in particular it has been shown that the standing wave definitions that assume hydrostatic pressure distribution at the geometric discontinuity may lead to unphysical increases of energy through the jump this is what happens also in the case that the canonical family of straight lines is adopted for the regularization of non conservative products through the porosity discontinuities in addition jump definitions based on the energy and mass invariance are incomplete and must be complemented with an appropriate energy loss mechanism in order to ensure that the dam break problem solution exists for each possible initial condition the additional analysis of integral porosity and dual integral porosity models in a one dimensional framework has shown that the relationship existing between edge based and cell based computational variables is similar to those existing between cell averaged variables and reconstructed interface variables in the proposed finite volume models this suggests that the ip and dip models could be equipped with a variables reconstruction approach similar to that discussed in the present paper the future research will be devoted to include the effects of bed elevation variations which influence the inner structure of the geometric discontinuity and the corresponding variables reconstruction technique and the generalization of the numerical algorithm to two dimensional cases acknowledgements the writers want to acknowledge prof d odorico prof guinot and an additional anonymous reviewer for their constructive suggestions which greatly contributed to improve the paper this research was partially funded by the university of naples parthenope through the funding programs sostegno alla ricerca individuale 2015 2017 and ricerca competitiva triennio 2016 2018 appendix a elementary curves of the classic one dimensional shallow water equations in the h u plane a parameterization of the direct shocks si u ref and of the backward shocks s i b u r e f contained in the i th characteristic field of the classic one dimensional shallow water equations is a 1 s i u r e f s i b u r e f u u r e f h h r e f g 2 1 h 1 h r e f where the sign is used for i 1 while the sign is used for i 2 similarly a parameterization of the direct rarefactions ri u ref is a 2 r i u r e f u u r e f 2 g h r e f g h where the sign is used for i 1 and the sign is used for i 2 finally a parameterization of the curve cd u ref is a 3 c d u r e f u q r e f h where qref hrefuref appendix b proof of proposition 1 it is assumed that the flow is from left to right u 1 0 u 2 0 and that ϕl ϕr if the condition of energy conservation is added to the system of eq 12 it is possible to find the flow conditions that satisfy the sw of eq 12 and that are characterized by energy conservation through the porosity discontinuity the augmented system b 1 ϕ l h 1 u 1 ϕ r h 2 u 2 ϕ l g h 1 2 2 ϕ l h 1 u 1 2 ϕ l g h 2 2 2 ϕ r h 2 u 2 2 h 1 u 1 2 2 g h 2 u 2 2 2 g can be rewritten as b 2 f 1 β η 3 2 f 2 1 2 f 1 2 η 2 2 β η 2 f 2 2 1 f 1 2 2 η 1 f 2 2 2 where β ϕr ϕl 1 and η h 2 h 1 while f 1 f u 1 and f 2 f u 2 are the froude numbers to the left and to the right of the discontinuity respectively some algebra supplies the solution b 3 η 3 β 1 β 1 9 β 1 2 β f 1 η 1 2 η 2 β 2 η 2 β 2 1 f 2 f 1 β η 3 2 direct calculations show that the sign minus in the first of eq b 3 corresponds to subcritical conditions upstream f 1 1 and supercritical conditions downstream f 2 1 while the sign plus corresponds to supercritical conditions upstream f 1 1 and subcritical conditions downstream f 2 1 this proves that the energy cannot be conserved if the flow remains subcritical through a sudden porosity increase when the definition by guinot and soares frazão 2006 is used having in mind that energy is increased through the discontinuity in the example 1 a continuity argument proves that all the subcritical flows must increment their energy through a sudden porosity increase when the sw of eq 12 is used 
844,the porous shallow water equations are commonly used to evaluate the propagation of flooding waves in the urban environment these equations may exhibit not only classic shocks rarefactions and contact discontinuities as in the ordinary two dimensional shallow water equations but also special discontinuities at abrupt porosity jumps in this paper an appropriate parameterization of the stationary weak solutions of one dimensional porous shallow water equations supplies the inner structure of the porosity jumps the exact solution of the corresponding dam break problem is presented and six different wave configurations are individuated proving that the solution exists and it is unique for given initial conditions and geometric characteristics these results can be used as a benchmark in order to validate one and two dimensional numerical models for the solution of the porous shallow water equations in addition it is presented a novel finite volume scheme where the porosity jumps are taken into account by means of a variables reconstruction approach the dam break results supplied by this numerical scheme are compared with the exact dam break results showing the promising capabilities of this numerical approach finally the advantages of the novel porosity jump definition are shown by comparison with other definitions available in the literature demonstrating its advantages and the issues raising in real world applications are discussed keywords urban flooding porous shallow water equations dam break problem exact solution numerical model variables reconstruction 1 introduction the two dimensional shallow water equations are widely used to model urban flooding events buildings and other types of solid obstacles must be taken into account because the flood wave celerity propagation guinot 2012 the mechanism of energy dissipation cosenza et al 2006 guinot et al 2017 pianese and barbiero 2003 the distribution of flow depth and flow velocity bazin et al 2017 larocque et al 2013 soares frazão and zech 2008 testa et al 2007 velickovic et al 2017 are all characteristics that depend on the building density shape and alignment in order to take into account the obstacles the classic procedure for the solution of the shallow water equations consists in excluding the buildings from the computational domain in this case the obstacles are represented by holes of the computational mesh and the corresponding solid walls are simulated by imposing reflective boundary conditions along the hole perimeter building hole method in the nomenclature by schubert et al 2008 an alternative to this procedure is considering the buildings as topographic features of the computational domain in this case a digital surface model dsm is obtained by adding the height of the buildings to the bare earth digital terrain model and the shallow water equations are subsequently solved using the dsm as bed elevation topographic input building block method in schubert et al 2008 these methodologies are time consuming because very refined computational grids are required to accurately represent the urban geometry and the street details kim et al 2015 in order to reduce the computational burden two different approaches have been proposed in the first class of models porosity models following the nomenclature by velickovic et al 2017 the solid obstacles are implicitly taken into account by the mathematical model in analogy with the equations of the single phase flow in porous media whitaker 1999 the porous shallow water equations are obtained by averaging the classic shallow water equations on a representative elementary volume containing the fluid phase and the obstacles defina 2000 guinot 2012 guinot and soares frazão 2006 in the single porosity sp models the fraction of the unit surface area that is not occupied by obstacles is denoted with the porosity parameter ϕ guinot and soares frazão 2006 in the isotropic multiple porosity mp models guinot 2012 the total porosity ϕ is the sum of ϕs and ϕm where ϕs is the fraction of the unit surface area that may be occupied by stagnant water and ϕm is the fraction of the unit surface area that may be occupied by moving water once that the mathematical model is defined in differential form an appropriate numerical method can be used to approximate the problem solution the second approach sub grid models in the nomenclature by velickovic et al 2017 uses coarse computational grids where the gaps between buildings are intersected by grid sides schubert and sanders 2012 while the street details and other topographic features are taken into account by means of sub gridding numerical procedures in each computational cell the cell based porosity ϕ ω represents the fraction of the computational cell that is not occupied by buildings while the edge based porosity ϕ γ represents the fraction of the cell edge that is not occupied by obstacles sanders et al 2008 the shallow water equations are subsequently solved using the finite volume method guinot et al 2017 özgen et al 2016 sanders et al 2008 schubert and sanders 2012 where a riemann solver is used to evaluate the mass and momentum fluxes through the cell edges the two dimensional sp shallow water equations benkhaldoun et al 2015 ferrari et al 2017 guinot and soares frazão 2006 velickovic et al 2017 can be written in the following vector form 1 ϕ u t ϕ f u x ϕ g u y h x ϕ u z x h y ϕ u z y s x y ϕ u in eq 1 the symbols are defined as follows x and y are the space variables and t is the time variable u h h u h v t is the vector of the conserved variables for unitary porosity where t denotes the matrix transpose h is the fluid depth u and v are the components of the depth averaged velocity along the x and y axes respectively f u h u p h u 2 h u v t and g u h v h u v p h v 2 t are the vectors of the fluxes along the x and y axes corresponding to unitary porosity respectively p 0 5gh 2 is the hydrostatic thrust acting on the unitary width and corresponding to unitary porosity g is the gravity acceleration z z φ t is the vector of the bed elevation z x y and the porosity ϕ x y s x y ϕ u ϕ g h 0 s x s y t is the vector of the source terms where sx and sy are representative of the forces such as bed friction and sub grid obstacles drag that are exerted by the solid boundaries on the flow along x and y respectively finally the matrices h x and h y are defined as 2 h x ϕ u 0 0 ϕ g h p 0 0 h y ϕ u 0 0 0 0 ϕ g h p the system of eq 1 whose eigen structure is discussed in ferrari et al 2017 is non linear hyperbolic and invariant under a reference rotation benkhaldoun et al 2015 guinot and soares frazão 2006 the last property allows the mathematical study of the discontinuous solutions associated to the system of eq 1 and of the corresponding numerical approximation in a one dimensional framework without loss of generality in particular the conclusions valid for the one dimensional approach can be easily extended to a two dimensional framework godlewski and raviart 1996 the non linearity of eq 1 implies that classic flow discontinuities such as moving bores can be generated even if the initial conditions together with the bed elevation and the porosity distribution are smoothly variable from a mathematical point of view the classic moving discontinuities are autonomous because the rankine hugoniot condition is sufficient to connect the states at the two sides of the discontinuity lefloch 2002 and no description of their inner structure is required nonetheless the porosity itself can be discontinuous for instance at the boundary between built up and undeveloped areas and this induces an additional class of standing discontinuities in this case the non conservative products p ϕ x and p ϕ y appearing in eq 1 have no clear mathematical meaning because they represent the product of a heaviside step by a dirac delta at geometric discontinuities such as porosity jumps an internal boundary condition must be prescribed in order to define the non conservative products and solve the eq 1 following the theory by dal maso et al 1995 the non conservative products can be regularized by defining the microscopic structure of the jump external knowledge such as experimental results cozzolino et al 2014a or other physical considerations cozzolino et al 2011 2015 2016 can be used to accomplish this task in order to define the non conservative product guinot and soares frazão 2006 took advantage of the formal similarity between the one dimensional porous shallow water equations and the one dimensional shallow water equations in variable width rectangular channels they assumed that the porosity discontinuity is equivalent to a channel width discontinuity where the pressure distribution on the transversal walls is hydrostatic successively numerous authors petaccia et al 2010 finaud guyot et al 2010 guinot 2012 velickovic et al 2017 ferrari et al 2017 incorporated the same porosity discontinuity definition in their models using a different approach castro et al 2007 and ostapenko 2012 assumed energy conservation through the geometric discontinuity in ion et al 2016 the non conservative product was defined assuming that the flow depth and the porosity were linearly variable through the discontinuity despite the abundance of porosity discontinuity definitions no methodical analysis of the corresponding riemann problem solutions has been conducted in particular there is a need to understand if the geometric discontinuity definitions that are available in the literature are physically congruent and if they lead to unique solutions in the remainder of the paper it will be demonstrated that the response to both questions is negative and a novel definition of internal boundary condition in the porous shallow water equations will be given the dam break problem is a particular case of riemann problem where the fluid is initially at rest and it is frequently used as a benchmark for shallow water numerical schemes guinot and soares frazão 2006 supplied the exact solution of the dam break problem in the case of abrupt porosity reduction using their porosity jump definition ostapenko 2012 used the energy conservation condition and showed that there are ranges of the initial conditions for which the solution of the corresponding dam break problem does not exist in order to solve this issue ostapenko 2012 introduced a class of solutions with energy loss through the discontinuity but uniqueness of the solution was lost kovyrkina and ostapenko 2013 demonstrated that in the case of channel contraction or equivalently porosity reduction the dam break solution exists and it is unique if a given fraction of the upstream energy is lost through the geometric discontinuity ion et al 2016 supplied an example of dam break problem solution under the assumption that the porosity and the flow depth varied linearly through the porosity discontinuity ferrari et al 2017 gave some example of riemann problem solution at porosity discontinuities basing their solutions on the jump definition by guinot and soares frazão 2006 but did not study the general characteristics of the problem from the literature available it is clear that the structure of the problem solution greatly depends on the non conservative product definition but a systematic investigation of these solutions has never been accomplished for this reason the dam break solution corresponding to the novel definition of internal boundary condition will be discussed in the present paper showing that six different wave configurations are possible despite the simplicity of the initial conditions and demonstrating the existence and uniqueness of the problem solution for all the values of the initial flow depth and porosity jump many authors have tackled the numerical solution of the porous shallow water equations guinot and soares frazão 2006 incorporated their definition of standing discontinuity into a finite volume numerical model whose results compared well with their exact solution of the dam break problem for the case of porosity reduction successively petaccia et al 2010 finaud guyot et al 2010 guinot 2012 and velickovic et al 2017 followed the same numerical path castro et al 2007 constructed a class of finite volume schemes for the one dimensional shallow water equations in variable width rectangular channels assuming the condition of energy conservation at width discontinuities their method generalized hydrostatic reconstruction took into account the effect of non conservative products through the geometric discontinuities by means of an appropriate reconstruction of the variables the finite volume models by benkhaldoun et al 2015 cea and vázquez cendón 2010 and wang and geng 2013 solved the porous shallow water equations by constructing roe schemes for the calculation of fluxes at the interfaces between cells in these schemes the roe linearizations did not take into account the inner structure of the porosity discontinuity mohamed 2014 constructed a two stages rusanov scheme where the non conservative product originated by the porosity variability was discretized in order to ensure the equilibrium for the water at rest solution but not for general equilibria ion et al 2016 constructed an energetically stable upwind scheme where no information about the definition of the standing wave was incorporated their numerical results showed that this introduces an incongruence between the numerical and the exact dam break problem solution ferrari et al 2017 considered a well balanced augmented roe solver which incorporated the porosity discontinuity definition by guinot and soares frazão 2006 showing a good matching between numerical and exact riemann problem solutions all the cited numerical models are based on one of the porosity definitions available in literature which are proven inconsistent from the preceding discussion it is clear that a better understanding of discontinuous solutions in sp models is required in addition there is a need to construct numerical schemes that incorporate this mathematical characterization these are precisely the objects of the present work the organization of the paper is as follows in section 2 a novel definition of the geometric discontinuity in porous shallow water equations is given and the solution of the corresponding dam break problem is discussed in section 3 a finite volume method that incorporates the novel definition of porosity discontinuity is presented and the corresponding numerical results are compared with those supplied by the variables reconstruction method by castro et al 2007 in section 4 the novel discontinuity definition is compared with existing definitions from the literature finally the paper is closed by a conclusions section 2 exact solution of the dam break problem in the literature the mathematical study of fast transients at geometric discontinuities is usually conducted by excluding the friction and the drag source terms alcrudo and benkhaldoun 2001 cozzolino et al 2014a cozzolino et al 2017 ferrari et al 2017 guinot 2012 guinot and soares frazão 2006 ostapenko 2012 because their effects are negligible in the vicinity of the initial discontinuity during a small time interval after t 0 conversely the effect of the bed slope terms is often included into the riemann problem by considering an abrupt bed elevation change the riemann problem at the bed step leads to more than twenty different solution configurations alcrudo and benkhaldoun 2001 and the structure of the riemann problem solution is expected to be even more complicated if the bed step and the porosity discontinuity are jointly considered in order to focus the attention on the inner structure of the standing discontinuities originated by abrupt porosity variations only all the source terms appearing in eq 1 are neglected and the bed is assumed horizontal considering a one dimensional framework with null transverse velocity the system of eq 1 reduces to 3 ϕ u t ϕ f u x h u ϕ x 0 where u h h u t and f u h u p h u 2 t are the reduced vectors of conserved variables and fluxes respectively while h u 0 p t is a vector which takes into account the forces exerted by the porosity variability along the x axis it is noteworthy that the eq 3 formally coincide with the shallow water equations in channels with rectangular section and variable width ϕ castro et al 2007 ostapenko 2012 and this reinterpretation will be of use in the remainder of the paper following this analogy the scalar quantity fhu u p hu 2 is the total thrust acting on the unitary width cross section the eigen structure of the system of eq 3 is discussed in castro et al 2007 and ferrari et al 2017 in the riemann problem the system of eq 3 is solved with initial conditions 4 u x 0 u l x 0 u r x 0 ϕ x ϕ l x 0 ϕ r x 0 where u l h l h l u l t and u r h r h r u r t the presence of a fixed porosity discontinuity induces solutions that are characterized by a standing flow discontinuity in x 0 the symbols u 1 h 1 h 1 u 1 t and u 2 h 2 h 2 u 2 t are used to indicate the solution of the riemann problem immediately to the left and to the right of the discontinuity for t 0 notably the classic rankine hugoniot condition is not valid through the standing porosity discontinuity because the non conservative products are active for this reason the inner structure of the discontinuity is made explicit by specifying two scalar functions γ h s u 1 u 2 and γϕ s u 1 u 2 that allow generalizing the rankine hugoniot condition dal maso et al 1995 as 5 ϕ r f u 2 ϕ l f u 1 0 0 1 g 2 γ h s u 1 u 2 2 γ ϕ s s ϕ l ϕ r d s 0 in eq 5 the functions γ h s u 1 u 2 and γϕ s ϕ l ϕ r are appropriate parameterizations of the variables h and ϕ through the discontinuity respectively these functions must satisfy some regularity assumption dal maso et al 1995 together with the conditions γ h 0 u 1 u 2 h 1 γ h 1 u 1 u 2 h 2 γϕ 0 ϕ l ϕ r ϕ l and γϕ 1 ϕ l ϕ r ϕ r in the following the symbol sw is used to indicate the standing wave discontinuity defined by eq 5 independent of the parameterization chosen the first of the two scalar equations supplied by eq 5 is ϕ r h 1 u 1 ϕ l h 2 u 2 this scalar equation corresponds to the invariance of the discharge per unit width through the discontinuity and characterizes the stationary solutions of eq 3 for this reason it is assumed the following definition 1 appropriate parameterizations of stationary weak solutions of eq 3 supply the inner structure of the sw that is used in the regularization of eq 5 the component γϕ s ϕl ϕr of the regularizing path is strictly monotonic with respect to s this definition implies that the energy is invariant through the geometric discontinuity only in the case that γ h s u 1 u 2 is smooth conversely an energy loss mechanism is automatically introduced by a standing hydraulic jump when the supercritical flow becomes subcritical through the porosity discontinuity for this reason the sw of definition 1 differs from those introduced in castro et al 2007 guinot and soares frazão 2006 ion et al 2016 ostapenko 2012 notably the monotonicity of γϕ s ϕ l ϕ r implies that critical flow conditions are possible only to the left γϕ s 0 or to the right γϕ s 0 of the geometric discontinuity this assumption makes the structure of the dam break problem very different from that presented in cozzolino et al 2017 where a channel with non monotonically variable geometric parameter is considered the initial conditions of eq 4 imply that the porosity is uniform in the regions x 0 and x 0 where the eq 3 reduces to the homogeneous one dimensional shallow water equations 6 u t f u x 0 because ϕ x 0 two genuinely non linear characteristic fields are associated to the eq 6 and the corresponding non linear waves may be either rarefactions or shocks the eigenvalues associated to the first and second characteristic field are λ 1 u u g h and λ 2 u u g h respectively the symbols si u ref s i b u r e f and ri u ref are used to denote the loci of the states u connected to the reference state u ref by a direct shock a backward shock or a rarefaction respectively that are contained into the ith characteristic field of the classic shallow water equations in addition to these waves the symbol cd u ref is used to indicate the curve of the states u having the same discharge per unit porosity and per unit width of the reference state u ref the mathematical representation of these curves in the plane h u is described in appendix a the dam breaks considered in the following sub sections are special riemann problems where ul ur 0 m s for the sake of conciseness only the initial conditions with hl hr 0 are considered and this implies that the flow moves from left to right for t 0 the solutions corresponding to the case 0 hl hr are obtained by reversing the x axis 2 1 solution configurations for sudden porosity increase ϕr ϕl in the case of sudden porosity increase four different solution configurations from w1 to w4 are possible with reference to the flow depth h an example solution for each of these configurations is represented in fig 1 a b c d and it is obtained at time t 5 s using the data contained in table 1 in fig 2 a b c d the exact solutions are reported with reference to the discharge per unit width ϕhu the numerical values of the intermediate states for the initial conditions of table 1 are reported in table 2 while the corresponding wave edge positions from left to right at time t 5 s are reported in table 3 the solution configuration w3 presented here is new while the solution configurations w1 w2 and w4 were introduced in ostapenko 2012 all the solution configurations from w1 to w4 will be presented here to discuss the global characteristics existence uniqueness fields of existence of the dam break corresponding to the novel sw definition 1 before describing the exact solution configurations it is useful to define the special states u 1 0 u 1 0 h 1 0 u 1 0 t u 2 0 u 2 0 h 2 0 u 2 0 t u 2 0 h 2 0 h 2 0 u 2 0 t and u a c h a c h a c u a c t the state u 1 0 is the state on r 1 u l characterised by critical flow conditions the state u 2 0 is defined as the supercritical state at the exit of the porosity discontinuity that is connected by the conditions of energy and discharge conservation to the state u 1 0 at the inlet the subcritical state u 2 0 is connected to u 2 0 by means of a standing hydraulic jump finally u ac is the subcritical state at the exit of the porosity discontinuity that is connected by the conditions of energy and discharge conservation to the state u 1 0 at the inlet 2 1 1 solution configurations w1 and w2 in the configuration w1 figs 1a and 2a the sw consists of the conditions of energy and discharge invariance with flow accelerating from the critical state u 1 to the supercritical state u 2 the corresponding pattern is represented in short in table 4 with the sketch notation introduced by alcrudo and benkhaldoun 2001 the symbol u i w u j means that the left hand state u i is connected to the right hand state u j by means of the generic wave w in the case of w1 the sketch notation is interpreted from left to right as follows a u l is connected to u 1 by means of a rarefaction contained in the first characteristic field b u 1 is connected to u 2 by means of sw c u 2 is connected to u 3 by means of a rarefaction contained in the first characteristic field d u 3 is connected to u r by means of a shock contained in the second characteristic field by definition the critical state u 1 coincides with the state u 1 0 while the supercritical state u 2 coincides with the state u 2 0 finally the state u 3 is found at the intersection of the curves r 1 u 2 0 and s 2 b u r the corresponding graphical construction is presented in fig 3 a and it is evident that the configuration w1 is valid only if h 3 h 2 0 in the configuration w2 figs 1b and 2b the states u 1 and u 2 coincide with the corresponding states of w1 but now the state u 2 is connected to the state u 3 by means of a shock contained into the first characteristic field the corresponding wave pattern is presented in table 4 the graphical construction used to determine the state u 3 is represented in fig 3b and it differs from that of fig 3a because u 3 is now found at the intersection of the curves s 1 u 2 0 and s 2 b u r by definition the state u 2 0 is individuated through the intersection of the curves c d u 2 0 and s 1 u 2 0 it follows that the construction presented for the configuration w2 is valid if h 2 0 h 3 h 2 0 because this condition ensures that the shock between the states u 2 and u 3 is able to exit from the initial discontinuity at x 0 in the configurations w1 and w2 the state u 1 at the porosity discontinuity is characterized by λ1 u 1 0 and then λ1 u 1 coincides with the celerity of the sw for this reason resonant conditions are established 2 1 2 solution configuration w3 in the solution configuration w3 figs 1c and 2c the internal structure of sw is composite and the flow through the porosity transition is transcritical given the coefficient ϑ i 0 1 the regularizing path consists of two reaches as follows a a smooth accelerating flow corresponding to s 0 ϑ i connects the inlet critical state u u 1 0 to a hydraulic jump in s ϑ i b a smooth decelerating flow corresponding to s ϑ i 1 connects the hydraulic jump to the outlet subcritical state u 2 the formal analogy between eq 3 and one dimensional shallow water equations in variable width rectangular channels helps to show that this sw is stable because the hydraulic jump is stable in expanding channels even if the friction is absent akers and bokhove 2008 the wave pattern corresponding to the solution configuration w3 is denoted in short in table 4 and again the critical state u 1 is found as made for configurations w1 and w2 in order to find the state u 2 it is useful to consider the locus of the admissible subcritical states at the exit of the porosity transition that can be connected by the condition of discharge invariance to the critical state u 1 this locus coincides with the arc of the curve c d u 2 0 between the states u 2 0 ϑ i 1 and u ac ϑ i 0 it is deduced that u 2 is found at the intersection of the curves c d u 2 0 and s 2 b u r subject to the condition that h 2 0 h 2 h a c because the discharge per unit width and unit porosity q 2 h 2 u 2 corresponding to the state u 2 coincides with that of the states u 2 0 u 2 0 and u ac the corresponding graphical construction is represented in fig 3c note that a resonant regime is established in the configuration w3 because λ1 u 1 0 2 1 3 solution configuration w4 in the solution configuration w4 figs 1d and 2d sw connects the subcritical states u 1 and u 2 by means of the conditions of energy and discharge invariance the corresponding solution wave pattern coincides with that of the configuration w3 table 4 to find the solution of the dam break problem for the configuration w4 it is useful to define the curve as u l as the locus of the admissible non supercritical states at the exit of the porosity transition that are connected by the conditions of discharge and energy invariance to the subcritical states of the curve r 1 u l in the case of sudden porosity increase direct calculations show that the curveas u l is represented in the h u plane by a strictly decreasing curve whose extremes are the subcritical states u ac and u l see fig 3d once that as u l is defined the state u 2 is found at the intersection of as u l and s 2 b u r the graphical construction used to find u 2 is represented in fig 3d and it is valid if hac h 2 hl correspondingly the state u 1 is the state of r 1 u l that satisfies the condition ϕ r h 1 u 1 ϕ l h 2 u 2 2 2 solution configurations for sudden porosity decrease ϕr ϕl in the case of sudden porosity decrease two different solution configurations namely c1 and c2 are possible an example solution for these configurations is represented in figs 1 e f and 2 e f and it is obtained for time t 5 s using the data contained in table 1 the numerical values of the intermediate states for the initial conditions of table 1 are reported in table 2 while the corresponding wave edge positions from left to right at time t 5 s are reported in table 3 these solutions coincide with those presented in ostapenko 2012 but they are succinctly presented here in order to discuss the global characteristics of the dam break solutions 2 2 1 solution configuration c1 the state u 1 must be subcritical because the energy corresponding to the critical state lying on the curve r 1 u l is not sufficient to make the flow pass through the porosity reduction in the solution configuration c1 figs 1e and 2e sw connects the subcritical state u 1 to the critical state u 2 by means of the conditions of energy and discharge invariance and the flow is chocked the corresponding wave pattern coincides with that of the configuration w1 see table 4 recalling the definition of the curve as u l direct calculations show that the left extreme u ac of as u l is critical in the case ϕr ϕl and then u 2 u ac the state u 3 is found at the intersection of the curves r 1 u ac and s 2 b u r while the state u 1 is the state of r 1 u l that ensures the discharge conservation through the porosity discontinuity the configuration c1 is possible for h 3 hac and the corresponding graphical construction is represented in fig 4 a notably a resonant regime is established in the solution configuration c1 because λ1 u 2 0 2 2 2 solution configuration c2 in the solution configuration c2 figs 1b and 2b the flow is smooth through the width transition and the wave sw connects the subcritical states u 1 and u 2 by means of the conditions of energy and discharge invariance the corresponding wave pattern coincides with that of configurations w3 and w4 see table 4 once that the curve as u l is defined the state u 2 is found at the intersection of as u l and s 2 b u r finally the state u 1 is the state of r 1 u l which ensures the discharge invariance through the geometric discontinuity the graphical construction used to find u 2 is represented in fig 4b and it is valid if hac h 2 hl 2 3 global characteristics of the solution 2 3 1 existence and uniqueness in the case of sudden porosity increase the solution of the dam break problem is determined by the intersection between the curve s 2 b u r and one of the following curves the curve r 1 u 2 0 configuration w1 construction of fig 3a the reach of the curve s 1 u 2 0 between the states u 2 0 and u 2 0 configuration w2 fig 3b the reach of the curve c d u 2 0 between the states u 2 0 and u ac configuration w3 fig 3c and the curve as u l configuration w4 fig 3d the union of these curves constitutes the solution locus sl u l which is represented in the plane h h l u g h l of the fig 5 a for the case ϕr ϕl 1 5 in the plane h h l u g h l the curves s 2 b u r and sl u l are strictly increasing and strictly decreasing respectively it is easy to see that their intersection exists and it is unique for given values of hr hl 0 1 and ϕr ϕl 1 proving that the solution of the dam break problem exists and it is unique in the case of sudden porosity decrease the solution is determined by the intersection between the curve s 2 b u r and the curve r 1 u ac configuration c1 construction of fig 4a or the curveas u l configuration c2 fig 4b the corresponding solution locus sl u l is represented in the plane h h l u g h l of the fig 5b for the case ϕr ϕl 0 5 again arguments analogous to those used in the case of sudden porosity increase lead to the conclusion that the intersection between the curves sl u l and s 2 b u r exists and it is unique for given values of hr hl 0 1 and ϕr ϕl 0 1 for increasing values of the ratio hr hl the curves of the family s 2 b u r exhibit increasing slope and shift rightwards in the h h l u g h l plane while the intersection point with sl u l moves along the solution locus itself let α β and γ be the values of the ratio hr hl for which the intersection between s 2 b u r and sl u l coincides with the states u 2 0 u 2 0 and u ac respectively when ϕr ϕl 1 in a similar manner let δ be the value of the ratio hr hl for which the intersection between s 2 b u r and sl u l coincides with the state u ac when ϕr ϕl 0 1 the corresponding curves α α ϕ r ϕ l β β ϕ r ϕ l γ γ ϕ r ϕ l and δ δ ϕ r ϕ l are represented in fig 6 the regions of the plane hr hl ϕr ϕl bounded by these curves represent the non overlapping fields of existence of the solution configurations 2 3 2 limit condition between w3 and w4 in the solution configuration w4 the subcritical state u 2 is connected to the state u 1 by means of the conditions of energy and discharge invariance this is not true in the solution configuration w3 where the subcritical state u 2 is connected to the state u 1 by means of the condition of discharge invariance only for this reason a criterion able to distinguish between the two configurations is needed in practical calculations at sudden porosity increases the solution configurations w3 and w4 are characterised as follows in the solution configuration w3 the subcritical state u 2 satisfies the inequalities f h u u 2 0 f h u u 2 f h u u a c in the solution configuration w4 the subcritical state u 2 satisfies the inequalities fhu u ac fhu u 2 fhu u l this is evident from fig 7 where the dimensionless total thrust λ f h u u 0 5 g h l 2 is plotted for all the states u sl u l between u 2 0 and u l with reference to the case ϕr ϕl 1 5 these inequalities will be of use for the construction of the numerical method presented in the remainder of the paper 3 finite volume numerical modelling in standard first order finite volume schemes the quantities used for the calculation of the fluxes at the interfaces coincide with the cell averaged values of the conserved variables this is in contrast with the need of enforcing the equilibrium solution when geometric discontinuities such as bed steps or porosity jumps are present in the flow field a successful strategy is based on a modification of the variables used for the calculation of conservative fluxes and non conservative products such a strategy which is inspired by audusse et al 2004 has been used to approximate the solution of the shallow water equations with bottom discontinuities caleffi and valiani 2009 castro et al 2007 cozzolino et al 2011 noelle et al 2007 thanh 2013 castro et al 2007 have extended the same approach to the case of the one dimensional shallow water equations with variable width where the energy invariance is enforced at width transitions two first order well balanced finite volume schemes for the approximate solution of eq 3 with reconstruction of the variables at the interfaces are described in the following subsection in the first scheme which coincides with that by castro et al 2007 the variables reconstruction is based on the energy and discharge invariance through the porosity discontinuity in the second scheme the inner structure of the sw at the porosity discontinuities is taken into account explicitly because stationary weak solutions of eq 3 are used to supply the information required for the variables reconstruction procedure the ability of the schemes to reproduce the dam break solutions is subsequently tested 3 1 algorithms description consider the solution of the system of eq 3 where the initial conditions u x 0 u 0 x and the porosity distribution ϕ x are specified the one dimensional physical domain is partitioned into non overlapping cells c i x i 1 2 x i 1 2 whose length δ x x i 1 2 x i 1 2 is assumed uniform for the sake of simplicity let 7 ϕ i 1 δ x c i ϕ x d x u i n h i n h i n u i n t 1 ϕ i δ x c i ϕ x u x t n d x be the cell averaged values of the porosity ϕ and the vector u at the time level tn nδt respectively the solution is advanced from the time level tn to the time level tn 1 by means of the following first order finite volume scheme 8 ϕ i u i n 1 ϕ i u i n δ t δ x ϕ i 1 2 g u i 1 2 u i 1 2 ϕ i 1 2 g u i 1 2 u i 1 2 δ t δ x s i 1 2 s i 1 2 where 9 s i 1 2 ϕ i f u i 1 2 r ϕ i 1 2 f u i 1 2 s i 1 2 ϕ i 1 2 f u i 1 2 ϕ i f u i 1 2 r in eq 8 the vector g u u is the numerical flux corresponding to an approximate or exact riemann solver for the homogeneous shallow water equations of eq 6 in particular g u u must be congruent in the sense that g u u f u in the present case the hlle riemann solver is used where the extreme celerities are approximated as in cozzolino et al 2014b but different choices are possible the comparison with the eq 5 shows that the term s i 1 2 defined by eq 9 represents the contribution to the cell ci of the non conservative product h u ϕ x through the interface x i 1 2 similarly the term s i 1 2 is the contribution to the cell ci of the non conservative product through the interface x i 1 2 at the interface i 1 2 between the cells i and i 1 the variables ϕ i 1 2 u i 1 2 u i 1 2 u i 1 2 r and u i 1 2 r are reconstructed in order to satisfy the generalized rankine hugoniot condition defined by eq 5 after an appropriate choice of the regularizing path note that the reconstructed variables u i 1 2 and u i 1 2 are used to calculate both numerical fluxes and interface non conservative products while the reconstructed variables u i 1 2 r and u i 1 2 r are used only for the non conservative products calculation to the best of writers knowledge the additional reconstructed variables u i 1 2 r and u i 1 2 r are presented here for the first time because the existing reconstruction methods audusse et al 2004 caleffi and valiani 2009 castro et al 2007 cozzolino et al 2011 noelle et al 2007 and thanh 2013 simply reduce to the case u i 1 2 r u i n and u i 1 2 r u i 1 n after this premise the reconstruction technique by castro et al 2007 and a novel reconstruction technique presented in this work are described in the following 3 1 1 reconstruction technique by castro et al 2007 when the flow through the geometric discontinuity is smooth the sw of eq 5 reduces to the conditions of discharge and energy invariance if the state u h h u t with the porosity ϕ is connected to the reference state u r e f h r e f h r e f u r e f t with porosity ϕref the conditions of energy and discharge invariance reduce to the following system 10 h ϕ r e f h r e f u r e f 2 2 g ϕ h 2 h r e f u r e f 2 2 g u ϕ r e f h r e f u r e f ϕ h let ω f 27 f 2 2 f 2 3 be a function of the froude number f u u g h if ϕ u ref and ϕref are given the formulas by valiani and caleffi 2008 can be used to solve the first of eq 10 with respect to h under the condition ϕ ϕmin where ϕ min ϕ r e f ω f u r e f when ϕ ϕmin two distinct solutions are possible one for subcritical u corresponding to f 2 u 1 and the other for supercritical u characterized by f 2 u 1 respectively the supercritical solution is taken if f 2 u ref 1 otherwise the subcritical solution is chosen when ϕ ϕmin the uniquely admissible solution u corresponds to critical conditions f 2 u 1 once the flow depth is known the flow velocity u can be calculated using the second of eq 10 after this premise the reconstruction technique by castro et al 2007 is described with reference to the interface i 1 2 between cells ci and ci 1 case a ϕ i ϕ i 1 simply take ϕ i 1 2 ϕ i u i 1 2 u i n u i 1 2 u i 1 n u i 1 2 r u i n and u i 1 2 r u i 1 n case b ϕ i ϕ i 1 the quantity ϕ min ϕ i 1 ω f u i 1 n is calculated case b1 ϕmin ϕ i ϕ i 1 set ϕ i 1 2 ϕ i the state u i 1 2 is the solution of eq 10 where ϕ ϕ i 1 2 ϕ ref ϕ i 1 and u r e f u i 1 n after this set u i 1 2 u i n u i 1 2 r u i n and u i 1 2 r u i 1 n case b2 ϕ i ϕmin ϕ i 1 set ϕ i 1 2 ϕ min and calculate u i 1 2 as in the case b1 the state u i 1 2 is the solution of eq 10 where ϕ ϕ i 1 2 ϕ ref ϕ i and u r e f u i n finally set u i 1 2 r u i n and u i 1 2 r u i 1 n case c ϕ i ϕ i 1 the case b is simply mirrored it is evident that in the case of the reconstruction technique by castro et al 2007 the quantities u i 1 2 r and u i 1 2 r coincide with u i n and u i 1 n respectively 3 1 2 novel reconstruction technique the novel reconstruction technique aims at detecting the cases where u i 1 2 r and u i 1 2 r differ from u i n and u i 1 n respectively because a rarefaction wave is attached to the sw with porosity increase resonant conditions of solution configurations w1 w2 and w3 in particular it is assumed here that the state u i n is connected to the critical state u i 1 2 r by means of the wave r 1 u i n when the following three conditions are met 1 the fluid is flowing through a porosity increase ui 0 u i 1 0 ϕ i ϕ i 1 2 the energy of the reference state u r e f u i 1 n corresponding to the reference porosity ϕ ref ϕ i 1 is not sufficient to reconstruct the flow state u i 1 2 corresponding to the porosity ϕ i case b2 of the approach by castro et al 2007 3 the state u i n is subcritical if all these conditions are satisfied and the state u i 1 n is supercritical the configurations w1 or w2 are assumed in this case the invariance of discharge and energy are applied through the porosity discontinuity when the state u i 1 n is subcritical a criterion based on the total thrust is used to detect the correct solution configuration the conditions of discharge and energy invariance are imposed in the case w4 while the condition of discharge invariance only is used in the case w3 one of the ingredients of the novel reconstruction technique is the evaluation of the flow state u h h u t that is characterized by discharge per unit width hu qref and total thrust fhu u fref this task is accomplished by solving the system 11 g h 2 2 q r e f 2 h f r e f u q r e f h if fref f min where f min 3 2 g q r e f 4 3 the eq 11 has no solution if fref f min the formulas contained in valiani and caleffi 2008 can be used to solve the first of eq 11 with respect to h when fref f min two distinct solutions are possible one for subcritical u f 2 u 1 and the other for supercritical u f 2 u 1 respectively when fref f min the uniquely admissible solution u is critical f 2 u 1 once that h is known the second of eq 11 is used to evaluate the flow velocity u in the novel reconstruction technique the case b2 by castro et al 2007 is reformulated as follows case b2 ϕ i ϕmin ϕ i 1 evaluate the set of conditions ct ui 0 u i 1 0 f 2 u i n 1 case b2 1 one or more conditions of the set ct are not satisfied do as in the case b2 of the reconstruction technique by castro et al 2007 case b2 2 all the conditions of the set ct are satisfied evaluate the critical state u 1 0 lying on the rarefaction curve r 1 u i n and set ϕ i 1 2 ϕ i 1 calculate both supercritical solution u 2 0 and subcritical solution u ac of the eq 10 where ϕ ϕ i 1 2 ϕ ref ϕ i and u r e f u 1 0 after this set u i 1 2 r u 1 0 u i 1 2 r u i 1 n and u i 1 2 u i 1 n evaluate f 2 u i 1 n case b 2 2 1 f 2 u i 1 n 1 set u i 1 2 u 2 0 case b 2 2 2 f 2 u i 1 n 1 evaluate the total thrusts f h u u 2 0 fhu u ac and f h u u i 1 n if f h u u 2 0 f h u u i 1 n set u i 1 2 u 2 0 if f h u u a c f h u u i 1 n set u i 1 2 u a c if f h u u 2 0 f h u u i 1 n f h u u a c set f r e f f h u u i 1 n and q r e f h 1 0 u 1 0 ϕ i ϕ i 1 2 and let the state u i 1 2 be the subcritical solution of eq 11 3 1 3 remarks note that the similarities between the novel reconstruction technique and the reconstruction technique by thanh 2013 are superficial because the case of energy loss hydraulic jump through the porosity discontinuity and the additional reconstructed states u i 1 2 r and u i 1 2 r are not taken into account in thanh 2013 it is important to observe that the proposed variables reconstruction procedure ensures that the energy of the reconstructed states is not greater than the energy of the cell averaged states in the case u i 1 2 r u 1 0 resonant conditions it is immediate to show that e u i 1 2 r e u i n h i n f u i n 1 2 3 e u i n for f u i n 0 1 where e u is the specific energy corresponding to the generic state u in the case u i 1 2 r u i n that is largely more frequent e u i 1 2 r e u i n is obtained interestingly the reconstruction u i 1 2 r u i n is obtained when stationary flow conditions are attained in the vicinity of the discontinuity and resonant conditions are then excluded in other words the energy invariance between cell averaged and reconstructed variables is preserved in steady flow conditions as expected 3 2 dam break tests the dam break test cases of table 1 are simulated by means of the numerical scheme of eqs 7 9 in each numerical test a closed gate is located at the centre x 0 m of a horizontal frictionless channel l 100 m long where the upstream and downstream boundary conditions consist of reflective walls the channel is initially filled with water at rest h x 0 hl for x 0 h x 0 hr for x 0 and u x 0 0 everywhere and the instantaneous removal of the gate causes the formation of a dam break phenomenon in the first set of tests the variables are reconstructed following the procedure by castro et al 2007 the tests are then repeated using the novel reconstruction technique proposed in the present paper for the sake of simplicity the constant values δx 0 2 m and δt 0 01 s are taken in all the cases the dam break results supplied by the two numerical procedures are compared with the exact solution in fig 8 flow depth h and fig 9 discharge per unit width ϕhu from the inspection of the two figures it is clear that the numerical results are very close to the corresponding exact solutions but some difference between the performances of the variables reconstruction procedures can be inferred as explained in the following in fig 8a the flow depth results are plotted for the solution configuration w1 it is evident that both the numerical procedures are able to capture the rarefaction at the left of the gate and the sw at the right of the gate the numerical diffusion causes the merging of the state u 3 with the rarefaction and the advancing shock more interestingly the classic variables reconstruction by castro et al 2007 generates a spurious wave between the supercritical state u 2 and the rarefaction wave downstream this additional wave is present also in fig 9 a where the corresponding discharges are plotted in figs 8b and 9b the results corresponding to the solution configuration w2 are plotted in this case the effects of the numerical diffusion are less evident because the strength of the faster shock at the right of the gate is increased with respect to the case of the solution configuration w1 from the comparison between the numerical results supplied by the two reconstruction procedures it is clear that the classic reconstruction by castro et al 2007 is slightly less efficient in capturing the position of the slower shock to the right of the gate in fig 8c the flow depth results are plotted for the solution configuration w3 the inspection of this panel seems to suggest that the results supplied by the two reconstruction procedures coincide actually this is not the case as it is evident from fig 9c the classic reconstruction by castro et al 2007 is not able to detect the existence of the hydraulic jump located through the discontinuity and this fact induces an inconsistency between the flux and the source term discretisations the corresponding momentum imbalance is detected as a spike in the discharge plot of fig 9c dashed line conversely the novel reconstruction procedure ensures the balance between fluxes and geometric terms through the porosity discontinuity and this is evident because the corresponding discharge plot continuous line is smooth in the vicinity of x 0 m the numerical results supplied by the two reconstruction procedures for the solution configurations w4 c1 and c2 are represented in figs 8 and 9 d e f the comparison between the numerical results and the exact solution shows that both reconstruction procedures behave nicely when the flow remains subcritical through the porosity discontinuity 4 discussion in this section the novel porosity discontinuity definition is compared with other definitions available in the literature castro et al 2007 guinot and soares frazão 2006 ion et al 2016 and ostapenko 2012 showing its advantages in addition the integral porosity numerical schemes by sanders et al 2008 and guinot et al 2017 are rewritten in the framework of eq 8 for further comparison finally the practical issues related to the application of the numerical approach introduced in the present paper are discussed 4 1 the sw definitions by castro et al 2007 and ostapenko 2012 castro et al 2007 assumed the condition of energy invariance for the definition of the sw but did not solve the corresponding dam break problem later ostapenko 2012 made the same assumption and showed that the solution of the dam break problem with ϕr ϕl is incomplete to overcome this difficulty he introduced the following additional sw definition ostapenko 2012 the flow conditions are critical at the discontinuity inlet and subcritical or critical at the outlet while a fraction of the energy upstream is lost through the discontinuity by means of an unspecified energy loss mechanism the solution locus corresponding to the definitions by ostapenko 2012 is plotted in fig 10 for the case ϕr ϕl 1 5 it differs from that contained in fig 5a for the presence of the additional reach u c u 2 0 which lies along c d u 2 0 in the same fashion of the reach u 2 0 u ac the state u c is the critical state lying on the curve c d u 2 0 and for this reason it corresponds to a condition of minimal energy this implies that the energy loss through the porosity discontinuity is increased along the curve c d u 2 0 moving from the state u ac to the state u c the inspection of the figure shows that the sw definition by ostapenko 2012 leads to multiple solutions because there is a range of hr hl values for which two alternative flow conditions are possible unfortunately ostapenko 2012 did not suggest a physically consistent criterion that was able to pick the relevant solution between the two alternatives readdressing the modeler to laboratory experiences to be accomplished case by case the arguments used in the present paper to establish the solution configuration w3 imply that the energy loss mechanism along the reach u 2 0 u ac is the hydraulic jump for this reason an additional energy loss mechanism such as friction must be invoked to explain the increase of energy loss along the reach u c u 2 0 nonetheless friction losses are absent along the other reaches of the solution locus and this makes the model inconsistent the model inconsistency the lack of uniqueness of the solution and the lack of a criterion for the choice of the physically congruent solution are major defects of the discontinuity formulation by ostapenko 2012 in the present work the consistency between the sw with energy invariance and the sw with energy loss is guaranteed by definition 1 because the energy loss mechanism is specified by the stationary solutions of eq 3 more importantly there is no need to resort to any disambiguation criterion for all these reasons the definition 1 should be preferred over the sw definition by castro et al 2007 and ostapenko 2012 the definition of the sw discontinuities as stationary weak solutions of eq 3 the proof of existence and uniqueness of the dam break problem for each possible initial condition as well as the plot of the solution fields of existence fig 6 are all novel results with respect to those contained in castro et al 2007 ostapenko 2012 4 2 the sw definition by guinot and soares frazão 2006 in guinot and soares frazão 2006 the sw of eq 5 is defined as 12 ϕ l h 1 u 1 ϕ r h 2 u 2 min ϕ l ϕ r g h 1 2 2 ϕ l h 1 u 1 2 min ϕ l ϕ r g h 2 2 2 ϕ r h 2 u 2 2 although the eq 12 is exact in the case of water at rest u 1 u 2 0 m s and h 1 h 2 it can lead to physical inconsistencies when the fluid velocity is not null in order to shed light on this issue consider the following example 1 a dam break problem is given with the following initial conditions hl 1 m ϕl 0 2 hr 0 9 m ϕr 0 6 after the dam removal the movement of the fluid from left to right is started by a rarefaction wave that moves upstream and by a shock wave that moves downstream submerged subcritical flow is expected through the discontinuity because hr is very close to hl recalling that the states u 1 and u 2 at the two sides of the porosity discontinuity are connected by the sw definition of eq 12 with ϕl ϕr the solution of the dam break problem is equivalent to the solution of the following non linear system 13 u 1 2 g h l 2 g h 1 ϕ l h 1 u 1 ϕ r h 2 u 2 ϕ l g h 1 2 2 ϕ l h 1 u 1 2 ϕ l g h 2 2 2 ϕ r h 2 u 2 2 u 2 h 2 h r g 2 1 h 2 1 h r the calculations supply the values h 1 0 921 m u 1 0 252 m s h 2 0 925 m and u 2 0 0836 m s showing that the flow moves from the left to the right the corresponding froude numbers are f u 1 0 0838 and f u 2 0 0277 and this confirms that the flow through the discontinuity is subcritical the specific energy values associated to the states u 1 and u 2 are e u 1 0 924 m and e u 2 0 926 m respectively this implies that the solution has no physical meaning because the flow energy increases through the sw the example 1 shows that there are initial conditions for which the dam break has no physical solution when the eq 12 is used for the definition of the sw interestingly the example is characterized by subcritical flow through the porosity discontinuity and it is possible to demonstrate the following proposition proposition 1 the sw of eq 12 cannot connect the subcritical state u 1 to the subcritical state u 2 through a sudden porosity increase because this implies an unphysical increase of energy proof the proof is contained in appendix b from proposition 1 and example 1 it is clear that the use of the eq 12 has a number of consequences the discontinuity definition of eq 12 is incongruent from a physical point of view because it may violate a fundamental physical constraint the numerical models equipped with the sw of eq 12 may supply numerical solutions that violate a fundamental physical constraint unphysical solutions during transients are not originated by pathological or exotic classes of initial conditions because this is what always happens in dam break problems with hr close to hl see example 1 in particular unphysical solutions may arise when the flow is close to the rest the unphysical creation of energy at discontinuities may affect the calibration of the dissipative effects introduced by bed roughness and building drag coefficients in conclusion the sw definition of eq 12 by guinot and soares frazão 2006 is problematic from both physical and computational points of view and the definitions that ensure no increase of energy through the discontinuity should be preferred in the literature the discontinuity definition by guinot and soares frazão 2006 has been extensively adopted for the numerical solution of the sp shallow water equations ferrari et al 2017 finaud guyot et al 2010 petaccia et al 2010 and velickovic et al 2017 all these numerical models inherit from eq 12 the unphysical production of energy at sudden porosity increase when the flow is subcritical the same observation applies to the mp models by guinot 2012 where the non conservative products are defined using eq 12 4 3 the sw definition by ion et al 2016 in ion et al 2016 the canonical family of straight lines is used to parameterize the flow depth and the porosity through the porosity discontinuity 14 γ h s u 1 u 2 h 1 s h 2 h 1 γ ϕ s ϕ l ϕ r ϕ l s ϕ l ϕ r s 0 1 this leads to the following generalized rankine hugoniot condition 15 ϕ l h 1 u 1 ϕ r h 2 u 2 ϕ l g h 1 2 2 ϕ l h 1 u 1 2 ϕ r ϕ l g h 2 2 h 1 h 2 h 1 2 6 ϕ r g h 2 2 2 ϕ r h 2 u 2 2 although the canonical family of straight lines is widely used for the definition of non conservative products dal maso et al 1995 it can lead to physical incongruences as it is evident in the following example 2 the sw definition of eq 15 is adopted and a dam break problem with the following initial conditions is considered hl 1 m ϕl 0 8 hr 0 9 m ϕr 0 4 the third of eq 13 is substituted with the second of eq 15 and the calculations supply the values h 1 0 967 m u 1 0 105 m s f u 1 0 0642 h 2 0 966 m u 2 0 211 m s and f u 2 0 0687 it is evident that the water flows from left to right as expected but the flow energy increases through the sw because e u 1 e u 2 0 00019 m this implies that the solution has no physical meaning from example 2 it is clear that the sw definition of eq 15 cannot be recommended in general 4 4 the closure model in sanders et al 2008 and guinot et al 2017 the integral porosity ip model by sanders et al 2008 and the dual integral porosity dip model by guinot et al 2017 are written in integral form under the assumption that the cell based porosity ϕ ω differs from the edge based porosity ϕ γ in particular physical arguments guinot et al 2017 based on the propagation celerity of small disturbances show that the construction of the ip and dip computational meshes should satisfy the condition ϕ ω ϕ γ in the present sub section the ip and dip models are considered in a one dimensional setting for the sake of simplicity and the additional following assumptions are made the bed is horizontal the building drag and the bed friction are negligible and the interface momentum dissipation mechanism introduced in guinot et al 2017 is absent in this case the ip and dip models can be rewritten as 16 ϕ ω i u i n 1 ϕ ω i u i n δ t δ x ϕ γ i 1 2 g u i 1 2 u i 1 2 ϕ γ i 1 2 g u i 1 2 u i 1 2 δ t δ x s i 1 2 s i 1 2 where ϕω i is the cell based porosity in the ith control volume ϕ γ i 1 2 is the edge based porosity on the interface between the control volumes i and i 1 and the geometric term contributions are defined as 17 s i 1 2 ϕ ω i ϕ γ i 1 2 0 0 5 g h i 2 t s i 1 2 ϕ γ i 1 2 ϕ ω i 0 0 5 g h i 2 t in order to define the edge variables u i 1 2 and u i 1 2 at the two sides of the interface between the control volumes i and i 1 a closure model is required guinot et al 2017 in the ip model by sanders et al 2008 the positions u i 1 2 u i and u i 1 2 u i 1 are made but the in cell mass conservation principle in stationary flow conditions is violated in fact the position by sanders et al 2008 does not satisfy the equation 18 ϕ γ i 1 2 h i 1 2 u i 1 2 ϕ ω i h i u i ϕ γ i 1 2 h i 1 2 u i 1 2 ϕ ω i 1 h i 1 u i 1 in the dip model by guinot et al 2017 the in cell mass conservation is restored by means of the eq 18 and the additional positions h i 1 2 h i and h i 1 2 h i 1 are made but the in cell energy invariance principle is not preserved in steady flow conditions in fact it is easy to verify that 19 e u i 1 2 h i ϕ ω i ϕ γ i 1 2 2 u i 2 2 g e u i n and the inequality follows because the wave congruence condition guinot et al 2017 prescribes that ϕ γ i 1 2 min ϕ ω i ϕ ω i 1 the creation of energy between the cell based variables and the edge based variables in steady flow conditions is ruled by the closure model only and not by a physical mechanism the comparison between eqs 8 and 16 shows that the choice of a closure model in the ip and dip models is equivalent to the choice of an appropriate variable reconstruction connecting the cell averaged variables with the edge variables it seems clear that the ip and the dip models could benefit from adopting a procedure of interface variables reconstruction and geometric terms calculation based on the definition of the sw as a stationary solution of eq 3 this approach could rule out unphysical energy creation in stationary flow conditions allowing a more accurate calibration of bed and building drag terms sanders et al 2008 guinot et al 2017 and of interface momentum dissipation terms guinot et al 2017 to this aim it is observed that the riemann problem at the interface between cells i and i 1 with ϕ γ i 1 2 min ϕ ω i ϕ ω i 1 is analogous to the riemann problem in rectangular channels with obstructions and constrictions bridge piles venturi flumes thanks to the formal analogy between the one dimensional sp shallow water equations and the shallow water equations in channels with rectangular section the exact solution of the corresponding dam break problems is discussed in cozzolino et al 2017 and the results presented in that paper could constitute a guide for future development 4 5 application to real world problems and further developments real world problems require the ability of coping with the bed elevation variability terms the bed friction and the building drag source terms and the two dimensional nature of the original equations the practical issues related to the application of the exact and numerical approaches introduced in the present paper and the corresponding future developments are outlined in the present sub section 4 5 1 bed elevation term in finite volume schemes the conserved variables and the geometric input are usually represented as cell averaged quantities and this approach automatically induces a discontinuity of flow variables depth and velocity and geometric variables bed elevation and porosity at the interface between cells for this reason the approaches based on the solution of a riemann problem that includes bed elevation and porosity discontinuities are common in the literature guinot and soares frazão 2006 finaud guyot et al 2010 ferrari et al 2017 in the present paper it has been shown that the dam break problem at porosity discontinuities exhibits physically consistent solutions in the case that the stationary weak solutions of eq 3 are used to define the generalized rankine hugoniot of eq 5 as shown in the preceding section this result supports a numerical scheme where the numerical computation of flux and non conservative products relies on a variable reconstruction approach that makes use of the corresponding sw definition the addition of the bed elevation variability term in eq 3 leads to 20 ϕ u t ϕ f u x h ϕ u z x 0 where 21 h ϕ u 0 0 ϕ g h p the eq 20 is formally similar to eq 3 and admits a numerical discretization in the form of eq 8 in the case of bed elevation variations the stationary weak solutions of eq 20 could be used to supply a sw definition at porosity and bed elevation discontinuities and the same sw definition could be used to reconstruct the variables for the numerical computation of flux and non conservative products this approach which is not trivial because the two geometric non conservative products interact non linearly will be the subject of future research 4 5 2 generalization to the two dimensional case let the two dimensional computational domain be decomposed in adjacent and non superposing convex polygons finite volumes if ω i is the area of the finite volume ci it is possible to consider the cell averaged values 22 z i z i ϕ i t 1 ω i c i z x y d x d y u i n h i n h i n u i n h i n v i n t 1 ϕ i ω i c i ϕ x y u x y t n d x d y of the geometric characteristics bed elevation and porosity and of the conserved variables if the variables reconstruction approach is extended to the two dimensional case the frictionless part of eq 1 admits the following explicit first order finite volume discretization godlewski and raviart 1996 guinot and soares frazão 2006 23 ϕ i u i n 1 ϕ i u i n δ t ω i j n i γ i j ϕ i j φ u i j u i j n i j δ t ω i j n i s i j in eq 23 the symbols have the following meaning n i is the set of indices j such that cj is a neighbor of ci γij is the length of the edge eij between ci and cj n ij is the normal to the edge eij orientated from ci to cj u i j and u i j are the values of the variable u that are reconstructed to the left and to the right of eij respectively ϕij is the value of ϕ reconstructed on eij φ u v n ij is a riemann flux corresponding to the two dimensional homogeneous shallow water equations such that φ u v n ij φ v u n ij and φ u u n ij k u n ij with k u n i j f u g u n i j s ij is the contribution to the cell ci of the geometric non conservative products through the edge eij in order to be congruent with the variables reconstruction procedure the vector s ij can be calculated as 24 s i j γ i j ϕ i j k u i j n i j ϕ i k u i n n i j the study of an appropriate variables reconstruction procedure in a two dimensional framework is not a trivial task and also this point deserves additional research efforts 4 5 3 bed friction and building drag source terms the bed friction and the building drag source term are different in nature with respect to the bed elevation and the porosity variability terms and a two step time splitting procedure can be adopted guinot and soares frazão 2006 sanders et al 2008 guinot et al 2017 as follows during the first time step the frictionless part of eq 1 is solved by means of eq 23 successively the conserved variables are updated by means of the implicit second time step where the source term s x y ϕ u only is taken into account 5 conclusions the complete characterization of the dam break problem at porosity jumps in one dimensional porous shallow water equations has been provided in this paper under the assumption that the porosity discontinuity inner structure is described by an appropriate parameterization of the stationary weak solutions of the one dimensional porous shallow water equations the graphic construction needed to solve the dam break problem has been supplied for each of the six possible wave configurations connecting the initial left and right states the inspection of the geometric constructions shows that the solution of the dam break problem always exists and it is unique and it is completely determined by the initial conditions and by the porosity jump among the others the solution configuration w3 is very interesting because the presence of a hydraulic jump through the geometric discontinuity causes a local energy loss and existing numerical methods for the approximate solution of the porous shallow water equations are not able to capture this feature a novel variables reconstruction technique which can be used in finite volume schemes for the approximate solution of the one dimensional porous shallow water equations has been proposed this approach takes into account the inner structure of the porosity jumps detecting the cases where the flow energy is dissipated through the geometric discontinuity the dam break results supplied by a finite volume numerical scheme equipped with the novel variables reconstruction approach have been compared with the exact dam break solutions showing the promising capabilities of the method in particular it has been shown that the wave structure of the dam break problem is captured in a variety of circumstances and that the momentum balance is enforced also in the case that a hydraulic jump is present through the geometric discontinuity at the present the proposed numerical approach is not able to take into account the cases of variable bed elevation and additional research efforts are required to cope with real world problems finally the novel porosity discontinuity definition has been compared with others existing in the literature and its advantages have been demonstrated in particular it has been shown that the standing wave definitions that assume hydrostatic pressure distribution at the geometric discontinuity may lead to unphysical increases of energy through the jump this is what happens also in the case that the canonical family of straight lines is adopted for the regularization of non conservative products through the porosity discontinuities in addition jump definitions based on the energy and mass invariance are incomplete and must be complemented with an appropriate energy loss mechanism in order to ensure that the dam break problem solution exists for each possible initial condition the additional analysis of integral porosity and dual integral porosity models in a one dimensional framework has shown that the relationship existing between edge based and cell based computational variables is similar to those existing between cell averaged variables and reconstructed interface variables in the proposed finite volume models this suggests that the ip and dip models could be equipped with a variables reconstruction approach similar to that discussed in the present paper the future research will be devoted to include the effects of bed elevation variations which influence the inner structure of the geometric discontinuity and the corresponding variables reconstruction technique and the generalization of the numerical algorithm to two dimensional cases acknowledgements the writers want to acknowledge prof d odorico prof guinot and an additional anonymous reviewer for their constructive suggestions which greatly contributed to improve the paper this research was partially funded by the university of naples parthenope through the funding programs sostegno alla ricerca individuale 2015 2017 and ricerca competitiva triennio 2016 2018 appendix a elementary curves of the classic one dimensional shallow water equations in the h u plane a parameterization of the direct shocks si u ref and of the backward shocks s i b u r e f contained in the i th characteristic field of the classic one dimensional shallow water equations is a 1 s i u r e f s i b u r e f u u r e f h h r e f g 2 1 h 1 h r e f where the sign is used for i 1 while the sign is used for i 2 similarly a parameterization of the direct rarefactions ri u ref is a 2 r i u r e f u u r e f 2 g h r e f g h where the sign is used for i 1 and the sign is used for i 2 finally a parameterization of the curve cd u ref is a 3 c d u r e f u q r e f h where qref hrefuref appendix b proof of proposition 1 it is assumed that the flow is from left to right u 1 0 u 2 0 and that ϕl ϕr if the condition of energy conservation is added to the system of eq 12 it is possible to find the flow conditions that satisfy the sw of eq 12 and that are characterized by energy conservation through the porosity discontinuity the augmented system b 1 ϕ l h 1 u 1 ϕ r h 2 u 2 ϕ l g h 1 2 2 ϕ l h 1 u 1 2 ϕ l g h 2 2 2 ϕ r h 2 u 2 2 h 1 u 1 2 2 g h 2 u 2 2 2 g can be rewritten as b 2 f 1 β η 3 2 f 2 1 2 f 1 2 η 2 2 β η 2 f 2 2 1 f 1 2 2 η 1 f 2 2 2 where β ϕr ϕl 1 and η h 2 h 1 while f 1 f u 1 and f 2 f u 2 are the froude numbers to the left and to the right of the discontinuity respectively some algebra supplies the solution b 3 η 3 β 1 β 1 9 β 1 2 β f 1 η 1 2 η 2 β 2 η 2 β 2 1 f 2 f 1 β η 3 2 direct calculations show that the sign minus in the first of eq b 3 corresponds to subcritical conditions upstream f 1 1 and supercritical conditions downstream f 2 1 while the sign plus corresponds to supercritical conditions upstream f 1 1 and subcritical conditions downstream f 2 1 this proves that the energy cannot be conserved if the flow remains subcritical through a sudden porosity increase when the definition by guinot and soares frazão 2006 is used having in mind that energy is increased through the discontinuity in the example 1 a continuity argument proves that all the subcritical flows must increment their energy through a sudden porosity increase when the sw of eq 12 is used 
