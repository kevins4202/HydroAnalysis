index,text
25945,in shanxi province china groundwater is a major problem and exploration of groundwater potential zones gwpzs is a great necessity this paper contributed to integrate rs gis to delineate gwpz and applied fuzzy ahp method in a single platform the main objective includes delineation gwpzs with rs and geo environmental factors using fuzzy ahp method fuzzy ahp method was employed to calculate weight of factors rs gis was used to create maps and discover groundwater availability gwpzs were classified in five separate classes results indicated that 13 26 27 02 26 35 23 64 and 9 71 area classified as very good good moderate poor and very poor gwpzs the validated analytical results revealed 82 5 12 3 3 5 and 1 7 existing water wells exhibited in very good good moderate and poor very poor gwpzs this indicates fuzzy ahp model generated findings were in very good agreement with ground truth data this rs gis based fuzzy ahp method is proficient and efficient in identification and delineation of gwpzs graphical abstract image 1 keywords remote sensing gis fuzzy ahp groundwater northern china 1 background 1 1 introduction groundwater is a key resource of natural water and varies geographically and temporally it plays an important role in preserving the ecological balance environmental stability human well being and economic development arefin 2020 ipcc 2001 owing to the growing population enlarged irrigated cultivated area and economic development the use of and demand for groundwater has increased continuously with very little or no consideration of the importance of groundwater environmental balance nhamo et al 2020 zhang et al 2019 globally approximately 36 42 and 27 of the overall groundwater extraction are used for household agricultural and industrial purposes respectively patra et al 2018 groundwater is one of the key sources of water for arid semi arid areas of northern china as in it is also used by 70 of the population for drinking and in the dry regions in china including shanxi province over 40 of the available groundwater is used to irrigate farmland yin et al 2018 in addition owing to increasing socio economic growth groundwater demand in this region has also increased in recent years regretfully the shortage of groundwater has created a threat to the local inhabitants of this province huq et al 2018a zhu et al 2017 therefore the identification and assessment of critical parameters are necessary for predicting groundwater potential patra et al 2018 in addition demand for freshwater has increased worldwide since the last century because of industrial expansion and rapid population growth arefin 2020 zhang et al 2019 gwpz delineation is needed for sustainable groundwater usage in china shanxi province is situated in one of the driest areas known as a water shortage area zhu et al 2017 therefore identifying the presence of groundwater is the most important issue for authorities ordinary groundwater identification and delineation techniques include drilling geological hydrogeological and geophysical methods as well as field surveys this requires extensive labor for activities such as exploration which is costly in terms of time money and resources and requires the participation of experts achu et al 2020 arefin 2020 m m et al 2020 nhamo et al 2020 shao et al 2019a however the use of modern technologies such as geographic information systems gis and remote sensing rs is less expensive more responsive and more convenient the incorporation of rs and gis is a paradigm shift for groundwater research which supports the evaluation monitoring and preservation of groundwater resources silwal and pathak 2018 these tools can be useful in the exploration of groundwater mapping furthermore rs apart from its usefulness in the selection of potential areas of groundwater exploration also provides inputs for estimating groundwater resources integrating rs and gis into the mapping of groundwater potentiality enables the storage manipulation and analysis of data in different forms and magnitudes abijith et al 2020 ahmad et al 2020 shao and cai 2018 shao et al 2018 siddi raju et al 2019 yin et al 2018 these data layers exhibit a common coordinate system which can be exploited to create thematic maps within the entire study area oikonomidis et al 2015 several estimation methods have been employed to evaluate a gwpz such as multifactor analysis chen et al 2010 single factor analysis xin feng et al 2012 fuzzy clustering ahmad et al 2020 gis information fusion siddi raju et al 2019 brittle rock proportion singaraja et al 2015 and fuzzy ahp indices pinto et al 2017 in the current study the analytic hierarchy process ahp saaty 1990 fuzzy model zadeh 1965 and rs gis methods are used to delineate gwpz in addition seven factors including geomorphology slope ndvi drainage density rainfall lulc and soil type were used to identify the gwpzs ahp is a strong decision making method with various factors mohammadi behzad et al 2018 pinto et al 2017 the combination of gis and ahp could be described as a mechanism for modifying and organizing geographical details and weight mumtaz et al 2019 in traditional set theory an object either fits or does not fit into a set consequently there is no partial membership which prevents certain concepts with transitional membership from being modeled the multi criteria decision analysis mcda is recognized as a significant tool to formalize and address the environmental challenges and decision making steele et al 2009 the general objective of mcda is for determining an option from several existing preferences different spatial challenges have raised for gis mcda the mcda methods have been applied to some hydrological indicators to predict spatial potential areas for groundwater resources for example adiat et al 2012 explored the fitness of gis mcda as a spatial estimate tool for groundwater potential zones in kedah and perlis states malaysia they also examined the coherence effect of criteria on the effectiveness of mcda as a prediction tool and introduced that gis mcda method is efficient to produce proper and consistent prediction however singh et al 2017 evaluated rainwater harvesting potential and worthy locations of it and simulated recharge structures applying gis mcda in canal command of eastern india additionally murthy and mamo 2009 identified gwpzs in moyale teltele sub basin south ethiopia using mcda method moreover ajibade et al 2019 delineated the suitable zones for solid waste disposal as well as management with integration of gis and mcda in akure ondo state nigeria however fuzzy set theory can solve this problem zadeh 1965 this theory has been revised and improved by multiple researchers to simplify its use cagman et al 2011 liu and pedrycz 2009 in shanxi province china there are numerous studies on groundwater that have been performed for example zhang et al 2012 applied step by step logistic regression with some environmental explanatory parameters and rs data to construct a 2d geospatial model that predicts the regions of high as risk potential in shanxi province zhang et al 2013 also used a statistical model to forecast the high as risk area in this region results show that approximately 3000 km2 of the province were at a high risk of as concentration above 50 mg l 1 additionally the assessment of groundwater geochemistry was performed by hu et al 2013 and tang et al 2013 using geochemical processes to control fluoride mobility and iodine rich groundwater in this region moreover in a recent investigation huq et al 2018a in this region found that the acceleration and release of as in the groundwater of datong basin in shanxi province are determined by the responsible controlling factors much effort has been undertaken in the study of the groundwater system in shanxi province based on hydrology geochemistry and hydrogeochemistry however no investigations have been conducted to detect or delineate the potential groundwater zone in this province therefore the aims of the study are the following 1 to propose a methodology to identify and delineate different gwpzs based on several groundwater potential factors using integrated rs gis techniques with fuzzy ahp to ensure the conservation sustainability and management of groundwater resources in shanxi province china 2 to analyze the relationship between each contributing factor for groundwater and 3 to conduct a model validation and sensitivity analysis to determine the most important factors influencing the detection of possible groundwater zones the scientific contribution of this paper is integration of rs gis for gwpz and combined application of fuzzy ahp method in addition it presents an analysis of gwpz mapping with the integration of rs gis to develop a supplemental or modifying method for delineating groundwater moreover the efficiency of gwpz mapping was validated through the use of ground truth data existing wells in this region 1 2 applications of rs and gis in groundwater mapping the explanatory satellite data development since 1990s offers unexampled opportunities for supporting and improving water resource management it is applied to understand sub surface water environment todd and mays 1980 using satellite data in groundwater problems might support to general scientific tendency toward a big picture view for the groundwater issues toth 1963 hypothesized groundwater flow systems in various scales depending on topographic factors toth s topographically derived flow model proposed that rs may be much effective to predict groundwater flows because it presents more scope to detect groundwater satellite based sensors are presently capable to make direct as well as indirect measurements of almost all elements of hydrological cycle jasmin and mallikarjuna 2011 these sensors are thus able to provide critical data for supporting of water resources management previously satellite data could not be used for groundwater study because groundwater is located inside the earth radar from the air and satellites as well as radiometers can typically penetrate only a few centimeters below the earth s surface jasmin and mallikarjuna 2011 nevertheless groundwater indicators obtained from remote sensing provide fundamental data however traditional substitutes are not accessible recently satellite data have been used to retrieve groundwater head levels fluctuations of groundwater concentration heat characteristics and subsidence data abijith et al 2020 ma et al 2020 satellite technology is analyzed in terms of its capacity to estimate groundwater potentiality availability and flow satellite data table 1 required if ancillary research is to be conducted can be used to explore the behavior of groundwater from the surface furthermore rs data are most advantageous when integrated with a quantitative model gis and ground truth data mohammadi behzad et al 2018 integration of rs gis for groundwater is a paradigm shift in groundwater research that helps for assessing observing and conserving of groundwater resource the set of rs gis tools are useful to research in groundwater resource management mahmoud and alazba 2016 in addition these show a significant relationship in extensive groundwater resource study and management recent progresses of rs gis exhibit a vital tool to explore groundwater shao et al 2019a satellite based rs systems provide comprehensive correct unbiased and readily accessible data regarding location scope as well as progressive of changes the effective application of rs for lineaments has identified as powerful tool thought it is associated to faults and cracking in hard rock jasmin and mallikarjuna 2011 however rs gis technologies are efficient to handle and manage a large and multifaceted database for groundwater research the high quality rs data and integration of corresponding thematic maps in a sophisticated gis environment confirm and increase to predict groundwater potential location accurately achu et al 2020 the integration of rs and groundwater flow projections is an easy approach to identifying the boundary of a lake river reservoir seepage area or drainage or evapotranspiration zone rs data are also suitable in the preparation of a respective thematic map s assignment of proper weights and convergence in an advanced gis environment this guarantees and improves the accuracy of forecasting the location and groundwater capabilities of promising areas abijith et al 2020 shao et al 2019b silwal and pathak 2018 the combination of rs and gis is a vital data source for producing hydrogeological maps including the use of rs in the management of water resources hydrogeological modeling and mapping the identification and tracking of salinization impacted zones biomass determination land use and crop classification selection and environmental protection and monitoring achu et al 2020 arefin 2020 mahmoud and alazba 2016 the nature of groundwater is progressive therefore the incorporation of rs data with gis is very useful for identifying gwpzs mahmoud and alazba 2016 satellite data offer fast and accurate guidelines as well as information on diversified factors that control groundwater occurrence and movement directly and or indirectly jasmin and mallikarjuna 2011 additionally gis provides an eminent work environment for the efficient handling of comprehensive and sophisticated spatial temporal data patra et al 2018 rs is a suitable tool for regions in which geological hydrogeological and field data are inadequate or missing yousif et al 2018 many existing studies mahmoud and alazba 2016 mohammadi behzad et al 2018 oikonomidis et al 2015 pinto et al 2017 shao et al 2019b siddi raju et al 2019 yousif et al 2018 have extensively employed rs with gis techniques to assess the gwpz 2 study area description 2 1 location and climate shanxi province in northern china is situated in the east asian monsoon zone characterized by an arid and semi arid climate mountains such as heng mountain zhu mountain wutai mountain zhoushan mountain taihang mountain taiyue mountain and zhongtiao mountain constitute the boundaries of the entire province and the topography slopes down from northwest to southeast fig 1 it is situated between 34 34 n and 40 44 n latitude and 110 14 e and 114 33 e longitude and covers approximately 1 567 000 km2 zhu et al 2017 it also exhibits a typical semi arid and arid climate the average yearly rainfall is between 358 and 621 mm the evaporation is approximately 1000 mm and 60 of the annual precipitation occurs in july and august the annual air temperature of the area is between 4 2 and 14 2 c with an average temperature of 6 5 c li et al 2017 su et al 2016 2 2 geological features the eastern western and northern parts of the study location contain bedrock outcrops the bedrock predominantly originates from the archean gneiss and the basalt of the wutai group of southern part the archean gneiss of the sanggan family and sinian limestone of the northern area and the cambrian ordovician limestone and carboniferous permian jurassic sandstones and shale of the west the gneiss and basalt of the hengshan segment of the archean are to the east the hengshan mountains comprise primarily the neoarchaean hengshan complex composed of migmatite tonalite granodiorite and granite gneiss along with pegmatite granite and mafic lenses the lower paleozoic from both the cambrian and ordovician containing deposits of limestone is found in the guancen mountains the honshu ranges belong to the permian era and hence existed before the cretaceous clastic rocks li et al 2017 the cretaceous clastic rocks include shale sandstone and coal in the northern region of shanxi early middle pleistocene basalt and new tertiary lateral soils were uncovered by the late middle and early tertiary pleistocene basalt the sediments from the cenozoic era varied from shallow deep in the range of 50 2500 m generally grain size of sedimentary rock declines from the edge to the center sediments covering the middle part of the study region are a diverse series of lateral sandy loam soils silts discontinuous alluvial pluvial sands alluvial lacustrine sandy loam layers lacustrine soils and natural matter enriched and silk clays zhu et al 2017 therefore sediments in this region are typically favorable toward humic materials such as plants and algae analysis of mollusk fossils as well as micro fossil ostracoda fossil sculptures identified four main stratigraphic units fig 2 of quaternary sediments q1 q4 in this area 1 stratigraphic unit of early pliocene developed in the static hydrodynamic environments from the extension of a paleo lake it comprises a sequence of sediments from soft clay to clay with a grayish and gray green color the depth of such a sedimentary chain is usually higher than 200 m 2 before the middle pliocene stratigraphic unit the sedimentary sequence varies from 20 to 30 m with a composition of grayish yellow silt as well as silty clay the top section of this sequence is formed with fine medium sand 3 before the middle pleistocene stratigraphic unit the sequence of this unit is distinguished by a gray and grayish yellow fine sand as well as a silty fine sand the deposition setting is characterized by the interchange of the lakeside with the shallow lake resulting in regular changes in the lake level and corresponding hydrodynamic state typically the depth of this unit ranges between 30 and 50 m 4 late pleistocene to holocene stratigraphic unit lithologies include gray green to greyish yellow fine sand deep gray clay and silt the deposition condition is affected with regular changes in the level of the lake and its hydrodynamic environment the thickness of this unit is roughly 30 m 2 3 hydrological conditions there are more than 1000 large and small rivers in the shanxi province predominantly seasonal rivers with a wide seasonal fluctuation in the water flow there are five large rivers in this province covering more than 10 000 km2 namely the fenhe and qinhe rivers in the yellow river basin and the sanggan zhanghe and hutuo rivers in the haihe river basin zhu et al 2017 these rivers are the primary surface water source and system of this region however the upstream reservoir which has developed as a primary source of irrigation for agriculture has significantly changed the conditions of the rivers two types of regular and extensive irrigation operations are held in march and september every year soil salinization is recognized as an important problem in this area li et al 2017 studies of rs techniques have shown that nearly 25 30 of the entire basin is covered with saline soil the aquifer materials of the shanxi province are composed mainly of alluvial pluvial sand from the middle to late pleistocene quaternary groundwater systems are usually found in lacustrine alluvial lacustrine and alluvial pluvial aquifers the first group depth between 5 and 50 m is known as the upper group whereas the middle aquifers are 5 150 m deep and the lower aquifers have depths greater than 150 m zhang et al 2013 the runoff of non perennial water from the river and the return flow of irrigation are the recharge sources for groundwater in this region the entire quaternary groundwater system shows a complex hydrogeological structure and can be characterized into three classes unrestricted semi restricted and restricted aquifers vertically infiltrating precipitous water lateral penetrating groundwater at the front of the mountains which usually originates from the bedrock the leaking of river water and irrigation runoff replenishes the upper aquifer whereas discharge occurs mainly through evapotranspiration and artificial extraction deep aquifers are recharged by adjacent bedrock aquifers as well as top unrestricted and semi restricted aquifers and are discharged mostly by artificial abstraction hu et al 2013 recharging the system of shallow aquifers is limited as a result of dry climatic conditions this occurs particularly around the edges where the outcropping sediments are more porous owing to the weak hydraulic gradient throughout the shanxi region and the availability of fine grained poorly porous sediments in the low lying center of the area in this region groundwater typically flows from the northwest to the southeast in the middle and from the front of the mountain to the central parts of the area groundwater flow is normally slow and mainly occurs in the deep aquifers 3 materials and methods 3 1 identifying factors influencing groundwater potentiality numerous causes affect the distribution and renewal of groundwater the groundwater situation of any specific region can differ significantly owing to the different factors that affect the occurrence and recharge of groundwater huq et al 2018b mahmoud and alazba 2016 these factors are usually measured at various scales and are represented in maps due to variance in scales factor maps are created at equal scales for multifactor decision making that categorizes the factor maps in suitable classes the suitable classes then serve as the source for consistent mapmaking with all included factors in the present study seven factors were chosen for gwpz mapping the factors are presented in form of seven thematic layers specifically geomorphology slope rainfall normalized difference vegetation index ndvi drainage density land use land cover lulc classification and soil type all these factors are interdependent and are considered as a single factor for classifying the gwpz to select the most important factors four assumptions were made that are most influential in increasing the groundwater potentiality 1 increasing groundwater recharge rate of precipitation penetration 2 high penetrability of soils and rocks geological and lithological units 3 higher drainage density and 4 flat slopes 3 2 rs satellite data to prepare groundwater potential zones in this study rs satellite data were employed to create thematic maps layers of several factors that influence groundwater potentiality over the study region groundwater recharge is a process in which water tables are recharged through the injection of water from an unsaturated zone to a saturated zone satellite data from the shuttle radar topography project are used to retrieve information regarding the slope and drainage density distribution in shanxi province structural components typically slope and drainage density play a significant role in the storage of groundwater in which they serve as a conduit to groundwater high drainage density zones are suitable for high surface runoff but not for infiltration the gentle slope regions 5 are favorable for water infiltration lulc is obtained from processed landsat 8 satellite data ndvi is prepared based on spot vegetation and moderate resolution imaging spectroradiometry data geomorphology soil and rainfall data are extracted from the china geomorphology atlas and china soil type and rainfall observation data respectively afterwards thematic layers were produced from the application of original factors to the rs dataset and gis as the dataset contained diverse features such as spatial resolution protection and format therefore all the datasets were transformed into guaranteed equal features converted to a grid format and re projected with a wgs 84 system 3 3 determining factor weights multi criteria decision making mcdm is a key tool for water resources management that includes structure and rigor in the decision making an mcdm technique such as the analytic hierarchy method ahp is a systematic and scientifically established method for studying qualitative measures ahp provides a platform for comparing parameters in pairs at each layer in a hierarchy structure and can assess the comparative standard coefficient weights with alternative schemes additionally fuzzy logic generally offers an easy technique for drawing definite conclusions from uncertainty and inaccurate information balezentiene et al 2013 moreover the ahp method of mcdm has been commonly used in the past few decades in different studies and has been employed successfully in gwpz mapping however despite the universality of ahp it is often criticized owing to its manner of handling inherently ambiguous and imprecise mapping data moreover the mcdm ahp technique has been applied in arid as well as semi arid regions for groundwater potential mapping in several areas of the world ajibade et al 2019 however in none of these techniques was fuzzy set theory integrated into mcdm as in fuzzy ahp the integration of fuzzy ahp may lead to improvement in the accuracy of groundwater potential mapping owing to the flexibility of the functions of fuzzy membership on this basis the current study uses the combined rs gis method along with fuzzy ahp to develop thematic data layers to delineate gwpz in shanxi province china 3 3 1 ahp model the criteria weights were determined by employing pairwise ranking with the rank sum method of ahp ahp was originally developed by saaty 1990 and is often known as the saaty method coyle 2004 it is an organized template and technique that assists the user with handling complicated decisions it helps decision makers to identify the best possible ways to understand the problems encountered however the strength of the model is evaluated by the consistency ratio cr which has three basic principles decomposition relative judgment and priority synthesis it is based on pairwise comparisons concerning the element at the next upper hierarchical level i e among variables and indicators the ratings of the features are denoted as numerical values with the comparison matrix based on this the relative weights of all aspects can be calculated by the priority level in the hierarchy the comparative importance of factors in the pairwise matrix was determined by applying the saaty rating scale a pairwise comparison approach was adopted to calculate the relative importance of the factor table 2 reveals the saaty pairwise rating scale numeric values 1 9 are allocated on the basis of the significance of the factors coyle 2004 in this study seven thematic maps and their respective features are given appropriate relative weights from 1 to 9 through the saaty rating scale table 2 there is no typical method for the pairwise comparison however assuming that geomorphology is determined to be absolutely more significant owing to its important effect on groundwater the weight for geomorphology was assigned as 9 there were seven factors those influence gwpz first it is important to provide an initial matrix for pairwise comparison between variables as every variable is as important by itself then it considered that rainfall to be a very much more important factor in terms of groundwater recharge then drain density so 7 was assigned rainfall and 5 for drain density due to lulc and ndvi has less influence on groundwater the weights are defined as 3 and 2 respectively similarly it was measured that geomorphology is absolutely more important to impact on groundwater the value of 9 was assigned for geomorphology for soil and slope 8 and 6 were assigned because they considered as intermediate values for gwpz this study similarly judges and provides values for the other factors based on the influence toward the groundwater potentiality table 2 shows the weight assignment criteria of other factors thematic maps 3 3 2 fuzzy logic model the fuzzy model is proposed by zadeh 1965 it is the modeling and simulation technique for complex systems in spatial planning it is generally used when decisions are made to execute the spatial objects of a map as the set members however with the fuzzy set model the membership value of a particular object denotes the level of membership function zadeh 1965 the triangular fuzzy number tfn m is exhibited in fig 3 the primary function of the fuzzy model is to make the data ambiguous mathematics as well as programming functions are acceptable for application in the fuzzy model for gwpz mapping the fuzzy model permits the concept of incomplete location membership and considers the various groups in this theoretical background the fuzzy membership function fmf is assigned to analyze the spatial variation and patterns that lead to the establishment of fuzzy borders for all potential zones in this study fmfs for each possible zone are attributed to the variance as their trend evolved from fuzzy boundaries and five different factors were weighted with each factor weight representing separate evaluations in fuzzy language table 3 for instance the medium level is expressed as 3 5 5 and 7 in fmf 3 3 3 wt assignments and normalization the purpose of ahp is to account for expert knowledge however ahp cannot rely solely on human decisions therefore the integration of fuzzy analysis and ahp fuzzy ahp was established to solve fuzzy hierarchical problems in this study the fuzzy ahp technique is applied to fuzzify the hierarchical analysis with fuzzy numbers and is applied to pairwise comparisons to evaluate fuzzy weights to assess the weights of selected criteria by fuzzy ahp the following steps were considered stage i pairwise comparison matrix was developed employing all of the criteria in a hierarchical system philological principles were used for pairwise evaluations and in all conditions one of the two parameters were more relevant judgment matrices a can be established by pairwise comparison by ahp as 1 a a 11 a 21 a n 1 a 12 a 22 a n 2 a 1 n a 2 n a n n a 1 a 1 a 2 a 1 a n a 1 a 1 a 2 a 2 a 2 a n a 2 a 1 a n a 2 a n a n a n where a n denotes the nth indicator element with a i j as the judgment matrix element traditional ahp performs a clear determination and is accompanied by uncertainty therefore it is unable to reflect human thinking effectively fuzzy logic is an advanced logical method developed based on the conventional ahp process in the normalization method the matrix element is expressed by tfn tfn can avoid ambiguity inaccuracy and uncertainty to compare the results of the two techniques weights were adopted using the same saaty rating system the numbers 1 2 1 3 2 2 5 2 3 7 2 4 9 2 and 5 were used for the fuzzy scaling ratios representing the strength of one component over the other with interim values rather than crisp numbers 2 a i j l m u l a i a j u where l m u are the minimum potential value moderate probable value and maximum possible value respectively a i j the decision matrix element in equation 1 step ii calculation of normalized weight 3 w n g m n 1 n f g m n where g m is the geometric average of the ith line of the decision matrices which is calculated as 4 g m a 1 n a 2 n a n n f n f the weight is normalized and the subjective weight is eliminated by the feature vector method in addition the consistency of normalized values was tested by calculating the cr of the subject variables and their categories the cr of a matrix demonstrates the level of consistency in comparison with a randomly created matrix the consistency ratio of the matrix table 4 was 0 0077 which is considered as an acceptable consistency saaty 1990 step iii the accuracy of pairwise comparisons was calculated through the consistency index ci however the consistency of judgements was checked by calculating the cr the cr controls the balance in which weights are assigned although the weights are allocated through field experience they should neither be overestimated nor under estimated but rather be as exact as possible the acceptable cr level is 0 10 the equation for cr is 5 c r consistency index ci random index ri the consistency index ci for a matrix is calculated by the following equation 6 c i λ max n n 1 where λ max is the maximum value weight of opm and n is the number of criteria the random index ri table table 5 created by coyle indicates the sum of the ri value in which the upper row is on the order value of n of that of a random matrix and the lower row corresponds to the consistency index for random decisions 3 3 4 spatial model for delineation of gwpz the multi factor decision making structure is created by calculating the selected factors of gwpzs the model produces a gwpz map by combining consistent thematic layers with weighted overlaid gis data in the weighted overlap study both raster and vector data were equally applied all the factors were combined assigning a weight based on the importance of each attribute in the accumulated results in addition a weighted linear combination wlc of factors was then employed to create the gwpz map finally the gwpz map was produced in the gis platform with the wlc of the separate criteria layers the methodology of gwpz desalination and the integration of rs gis and fuzzy ahp technique is shown in fig 4 it shows that the first step involved generating the thematic layers including geomorphology slope ndvi drainage density rainfall lulc and soil type in second step fuzzy ahp applied to assign weights of the factors afterword the thematic layers were integrated with overlay method in gis environment finally the gwpz map generated with validation and sensitivity analysis a raster calculator in arcgis was applied to the overlaid thematic maps the groundwater probability index was calculated as 7 gwpz i 1 n j 1 m w i x j where gwpz is the map of groundwater potential zone w i denotes the normalized weight of the i th thematic variable table 6 x j indicates the normalized weight of the jth class of the variable table 4 n reveals the total number of variables and m is the total number of classes of a variable 3 4 sensitivity analysis through sensitivity analysis the impact of input criteria on the model output efficiency was assessed and the influence of the adaptation of parameters factors was validated the influence of the data on the weighted values as well as the weights allocated to each factor was validated with sensitivity analysis equation 8 was applied to measure the effectiveness of each weight 8 effective weight theme w theme s gwpi 100 where w is the weight and s is the scale value of the factors assigned to each grid gwpi indicates the groundwater potential index as computed from equation 8 4 results and discussion 4 1 development of thematic maps in the current study rs satellite data are used to produce seven thematic parameters layers that affect groundwater potentiality in shanxi province china the thematic maps from geo environmental data were deriving from conventional data maps and rs data and created in fixed spatial scaling of selected factors thus it does not denote individual characteristics of inhabitants the layers are geomorphology slope ndvi drainage density rainfall lulc and soil type however the thematic maps layers used to classify gwpz vary across the study area and the selection of assigned weights of the features classes of the maps layers is arbitrary table 6 the classes along with their respective ratings and the normalized weights of every factor are displayed in table 6 4 1 1 slope slope difference has a crucial function in the replenishment of groundwater and delineation of gwpzs sites with flatter or lower slopes are good indicators of groundwater potential zones since they provide more excellent rates of water renewal compared with regions of higher slope mumtaz et al 2019 nayyer et al 2019 slope is a vital factor impacting the retention of water and amount of infiltrated precipitation it is primarily responsible for erosion surface runoff and the transport of material water penetration capability is a property of slope i e maximum penetration occurs when the slope is at a minimum and the inverse is true as well patra et al 2018 sarker et al 2020a highly elevated mountainous regions with elevated slope values are considered to exhibit a high flow of water with inadequate infiltration systems in contrast flat regions with low slopes can hold rainwater with increased high groundwater recharge capacity however to create a slope map the most critical step is to develop the digital elevation model dem a dem with 500 m resolution is extracted from the srtm data and is used to produce the slope map the slope was derived from the dem through the arcgis slope function on the slope map the slopes are classified into four broad groups fig 5 a the elevation of the shanxi province ranges from 193 to 3004 m fig 1 the sloping map varies from 0 to 41 86 and is divided into four categories 0 0 03 0 03 0 07 0 077 0 13 0 1 as seen in fig 5a the category with the minimum slope is assigned the highest weight owing to low runoff and extensive infiltration in contrast the class with maximum slope is given the lowest weight because of the likelihood of a poor groundwater supply agarwal and garg 2016 consequently areas with a lower degree of slope are considered suitable for groundwater potentiality whereas areas with a higher degree of slope are considered as unsuitable for groundwater potentiality areas of 0 0 03 approximately flat fall into the excellent group owing to flat topography because the flat terrain shows a comparatively high penetration ratio and typically very good gwp region areas with slopes of 0 03 0 07 gently sloping are assumed to be worthy as a groundwater potential zone owing to gently undulating topography and little surface runoff sites with a slope of 0 077 0 13 steep to steep slope correspond to relatively mild to minimum runoff and are thus classified as moderate gwp areas areas with slopes of 0 13 very steep are considered as having weak gwp zones owing to the gradual and relatively high runoff and low infiltration rate 4 1 2 geomorphology geomorphology has an important function concerning the presence of groundwater the geomorphological map supports the classification of the form of geomorphic structures different formations and basal geology for providing an overview of the process structures materials and geological controls of the groundwater context patra et al 2018 it has a significant effect on the occurrence storage and recharging of water across the subsurface of the earth nevertheless data from the china geomorphology collection 1 1 million were used to generate the geomorphological map shanxi province is dominated by plains platforms hills and mountain ranges fig 5b the plain is primarily in the shape of a basin in shanxi the province consists of the plain 20 17 plains 21 23 hills 21 60 and mountains 37 00 groundwater storage is believed to be very feasible in platforms as most contain gentle hills broad catchment areas and water resistant convex lenses there is a substantial amount of good top layer containing lagging water hence a high weight was allocated to platforms hills mostly consist of hard rock mass with a concentration of soil and a lack of necessary groundwater holes and caves thus low weight was assigned to hills groundwater in the mountain areas is also a source of interstitial water in the tertiary loose coarse grained rocks in this case the potentiality for groundwater availability is moderate good 4 1 3 drainage network density the density of the drainage system is directly related to the natural infiltration of the soil it is also the most relevant parameter for hydrogeological study the drainage system and density provide significant indication of the hydrogeological features of a region it depends on the climate penetration efficiency lithology vegetation intensity relief roughness and drainage intensity index mahmoud and alazba 2016 sarker et al 2020c areas with high surface run off demonstrate reduced groundwater potentiality owing to a low recharge ratio caused by elevated drainage density a drainage density map is extracted from dem fig 1 and the drainage intensity is produced applying the density analysis tool of arcgis fig 5c the drainage density is defined by the closeness of the spacing between stream channels the drainage density of a basin is the total length of the river network divided by the basin area calculated by equation 9 9 d n d l a where d n d is the density of the drainage network l is the total length of the streams and a denotes the area the drainage density varies from 0 to 0 234 km km2 and the drainage density is categorized into four classes 0 0 032 km km2 very good 0 032 0 069 km km2 good 0 069 0 111 km km2 moderate and 0 111 0 234 km km2 poor it is inversely proportional to the terrain perviousness therefore areas with a low drainage intensity are strong indicators of water retention zones high drainage intensity influences high runoff and indicates low groundwater likelihood higher weights are assigned to a poor drainage intensity region that develops a porous surface with greater infiltration and reduced surface runoff agarwal and garg 2016 sarker et al 2020b very good drainage intensity is identified in the middle part of shanxi most of the study area is influenced by low drainage quality less porous rock results in less rainwater infiltration a low drainage intensity region provokes greater infiltration as well as reduced surface runoff relative to the high drainage intensity area this demonstrates that high drainage density zones are not a fit for the gwp zones owing to the high surface runoff achu et al 2020 adnan et al 2020 huq et al 2020 mohammadi behzad et al 2018 mumtaz et al 2019 yin et al 2018 4 1 4 rainfall the aquifers and groundwater are generally recharged by the effective rainfall the level of rainfall is useful in assessing the volume of the groundwater reservoir based on the ground properties e g lithology geology and hydro geomorphology elevated rainfall is related to strong groundwater potentiality chen 2019 minh et al 2019 rainfall is an essential part of the water cycle and a leading contributor to groundwater recharge the rate and spatial temporal distribution of rainwater have a significant impact on hydrology as well as hydrogeological conditions meanwhile precipitation intensity and the combination of different favorable circumstances contribute to gwpz detection there is a strong possibility of additional groundwater in the event of high amounts of rain in contrast if the rainfall is low then the groundwater potentiality is less rainfall differs not only temporally but also spatially therefore it is essential for determining the impact of rainfall in identifying gwpz geographic distribution of the mean annual precipitation map is developed by the inverse distance weighting projection technique in the arcgis environment rainfall data were derived from the precipitation spatial interpolation data set of 108 national meteorological stations from the shanxi province shanxi is located in the tropical monsoon climate and rain occurs mostly in the summer attributable to oceanic influence the total yearly rainfall in the shanxi region is 380 645 mm in which the eastern and southern parts of the province experience the greatest volume of rain the precipitation map is divided into four classes 430 mm 21 95 430 480 mm 51 07 480 540 mm 18 20 and 540 mm 8 77 fig 5d a class with a higher rainfall rate is assigned the highest weight correlated to an increased groundwater recharge rate and high gwp whereas a lower rainfall rate is assigned a smaller weight 4 1 5 soil type the soil plays a notable role in the percolation and infiltration of surface water into the aquifers consequently soil quality is crucial in the amount of recharge water infiltration into the subsurface ahmad et al 2020 the infiltration and soil porosity of water primarily depend on the soil texture then the texture promotes the delineation of the gwpz infiltration is mostly responsive to soil porosity and surface runoff less penetrable soil leads to surface runoff enabling less infiltration whereas porous soil contributes to increased water recharge siddi raju et al 2019 the soil map is created based on the data of 1 1 million soil maps of china the study region is defined by four primary soil types as seen in fig 6 a namely silty clay 47 63 silty clay loam 35 53 loam 14 41 and sandy loam 2 44 based on the soil condition and penetration rate different weights were assigned to each soil unit sandy loam has a thicker soil base lighter soil texture and higher soil nutrient quality meanwhile it covers a small area extremely suitable for groundwater storage consequently it was assigned the maximum weight loam is commonly spread in various areas of the world with a relatively scattered distribution the transition border of other neighboring soil types is apparent accounting for 47 63 of the shanxi province loam is found to be very good for groundwater storage and constitutes coarse particles with less clay material high water porosity and drought susceptibility mumtaz et al 2019 silty clay loam is dissolved by seepage water and afterwards flows to the lower layer thus the organic matter quality of the leached soil is relatively high owing to its high content of clay it is considered to be moderately suitable for groundwater storage the soil type exhibiting the worst water permeability is silty clay which is mainly distributed along the northwest of shanxi province 4 1 6 land use land cover lulc change has become one of the leading human induced functions influencing the occurrence as well as recharge of groundwater resources lulc has an important influence on the occurrence and renewal of groundwater in terrains a specific factor such as lulc was then investigated to address human intervention with groundwater agricultural development can also enhance groundwater restoration chen et al 2019 mumtaz et al 2019 meanwhile lulc changes could alter recharge rates which could have negative implications for groundwater quality particularly in arid and semi arid areas such as shanxi they are a major factor influencing the recharging cycle of groundwater because of the impact on evapotranspiration drainage and recharging of the groundwater system fig 6b displays the lulc map which was prepared from the landsat 8 remote sensing images the lulc map is classified into six categories forest 28 11884 cultivated 38 25239 grassland 29 15446 water 1 00244 barren land 0 09443 and urban 3 377426 cultivated land constitutes the largest lulc and the smallest lulc is occupied by barren land water bodies cultivated and barren fields are strong sources of groundwater storage because agricultural land enables further water absorption owing to the pore spaces in the soil meanwhile the development of land decreases the penetration of water into the soil owing to a lack of porous surfaces therefore water penetration is decreased in the high impervious surface urban areas thus the weight is lower for urban areas since settlement areas are deemed as less important however the highest weight was assigned to water bodies cultivated land and bare land whereas the lowest weights were assigned to grassland urban areas and forests as defined in the gwpz table 6 4 1 7 normalized difference vegetation index the ndvi is based on the proportion of photosynthetically absorbed radiation an ndvi zero value denotes no green plants and a value of approximately 1 0 8 0 9 describes the maximum possible intensity of green vegetation fig 6c shows the ndvi of the study area ndvi is measured based on per pixel and considers the standardized variation of red and near infrared nir bands of an image equation 10 10 n d v i nir red nir red the biophysical analysis of ndvi is an element of consumed photosynthetically activated radiation ndvi is an aspect that is an indirect factor of groundwater potentiality since high vegetation cover is often demonstrated in areas in which shallow groundwater is available consequently a higher weight is associated with a higher ndvi value table 7 the ndvi value in the shanxi region is classified into four classes 0 5 0 5 0 65 0 65 0 8 0 8 these four groups cover 11 43 24 83 37 67 and 26 07 respectively of the study area the existence of underlying rock elevation and vegetation cover often affect penetration and surface runoff distinct or elevated bedrock optimizes runoff in addition areas of higher altitude and shallow vegetation cover or deforestation rapidly increases runoff 4 2 groundwater potential zoning van laarhoven and pedrycz introduced the concept of fuzzy logic in ahp utilizing the advantages of both fuzzy and ahp techniques over the past few decades fuzzy ahp has become the most commonly recognized multi criteria decision making approach for numerous types of study such as groundwater quality evaluation minh et al 2019 landslides mallick et al 2018 ecosystem and environmental vulnerability li et al 2009 groundwater susceptibility nadiri et al 2017 and water quality extraction azimi et al 2018 the capability of the proposed gis induced fuzzy ahp model of this study has also made its application more practical and useful the spatial ranges of the gwp zones were defined based on the empirical consideration of seven thematic layers in the model various spatial investigation tools were applied to address spatial difficulties in the definition of possible groundwater potential zones potential groundwater areas for the study region demarcated by the synthesis of several factors including geomorphology slope rainfall ndvi drainage density lulc and soil type were used with rs gis methods the analytical results of this study highlight the weighted overlap analysis method employing gis based fuzzy ahp methodology the most powerful technique for analyzing potential groundwater areas the delineation of possible groundwater regions was performed in a group or cluster and the interpreted layers were developed applying weighted overlay classification with the spatial analyst method in arcgis in the province of shanxi china conducting groundwater potential research is needed owing to the occurrence of industrial and agricultural development the gwpz map of shanxi province fig 7 shows five separate groups zones illustrating very good good moderate poor and very poor groundwater probability zones in the region usually very good and good gwpz are associated with significant groundwater levels which are calculated by different factors areas with flat gentle hill porous and unconsolidated terrains are the most appropriate for groundwater conservation the region covered by the very good gwpz is roughly 207 784 2 km2 13 26 the very good gwpz of the study region covers the southwestern portion the good gwpz is distributed across the study area representing 27 02 423 403 4 km2 of the total area however most of the good gwpz is identified in the central and northern regions the moderate gwpz contains mostly concentrated scattered patches and is uniformly spread throughout the area it occupies a region of 412 904 5 km2 which is roughly 26 35 of the entire area representing the largest gwpz area among all classes however the western and middle parts of shanxi fall under poor as well as very poor gwpz occupying an area of approximately 370 438 8 km2 23 64 and 152 155 7 km2 9 71 respectively because of its elevated slope with adverse geological pleistocene period deposition as well as geomorphological lateritic pediplain conditions this region is included under poor and very poor gwpz usually poor and very poor gwpz have weak discharge ratios volume time relative to good and moderate gwpzs the significance this study provides a comprehensive basis for planning sustainable groundwater strategies as well as management in shanxi province the findings show key implications to design sustainable groundwater strategy as the methodology implemented in the study is emerged from reasonable conditions with generic nature this general approach of gwpz delineation is supposed for ensuring sustainable management of aquifer development the gwpz approach particularly underlines to promote groundwater conservation application of appropriate scientific plan regulating domestic as well as industrial water preservation practices leading to sustainable groundwater strategies it may helpful for the long term groundwater evolution practices in study area moreover appropriate groundwater evolution plan implementation could lead for the better storage as well as groundwater management considering quality and quantity 4 3 model validation gwpz maps to verify the accuracy of the logic based fuzzy ahp model the findings derived from the proposed model are compared with 57 existing water well locations with the gwpz map water well locations were obtained from the distribution of regional groundwater testing stations http www cigem cgs gov cn of shanxi province china and the data from these locations were used in groundwater evolution study strongly supporting geological hazard mitigation and the conservation of the geological environment these locations offer appropriate facilities for critical national policy initiatives such as natural resource management the utilization and security of water supplies and the development of sustainable civilizations however the deepest drilling depth was 291 509 m the validation of the methodology relies on associating existing groundwater wells with the gwpz map applying proximity analytical tools in arcgis the locations of the wells were also plotted on the subsequent gwpz map using arcgis the findings revealed that 82 5 47 wells and 12 3 7 wells of the total water wells are associated with very good and good gwp regions respectively whereas 3 5 2 wells belongs to moderate and 1 7 1 well corresponds to poor and very poor areas fig 7 this suggests that the model generated gwpzs were consistent with ground truth data i e water well data as well as most of the active wells are located in very good and good zones of the gwpz map this illustrates the ability of rs and gis technologies to delineate gwpzs which might help locate the appropriate locations to extract groundwater these validation findings demonstrate that the database as well as methods applied to build gwpz models for probable groundwater areas through the analysis of the fitness of parameters and comparative significant weights of the factors have produced accurate results 4 4 results of sensitivity analysis statistical analysis exhibited in table 7 derivative from equation 8 indicates a significant variance in the selected factors this is mostly attributed to the existence of a floodplain as well as mature floodplain areas with the main river systems developed during holocene period this terrain flat and gentle slope porous unconsolidated is fit to store groundwater this can demonstrate that farmland is perfect for groundwater recharge ndvi impacts evapotranspiration surface drainage and groundwater renewal which has an important effect on gwpz detection the gwpz often tends to be sensitive to the impacts of geomorphology slope rainfall drainage intensity and soil quality this may be due to the considerable statistical weights allocated to all the factors additionally high average ndvi values the drainage network and slope indicate that the confining layers significantly influence the gwpz lulc drainage rate slope geomorphology soil composition and precipitation all lead to differences in sensitivity their mean values are 0 81 0 77 0 76 0 69 0 67 and 0 72 respectively the gwpz approach of this study could be applied for assessing potential groundwater zones in semi arid region as well as other areas over the globe for instance if the purpose is to delineate gwpz then on the basis of the geo environmental situation of the given areas a new gwpz approach might be generated afterwards the new gwpz approach can be compared with the baseline of the proposed gwpz approach moreover contributing factors variables and indicators of the selection technique and weighing process can be modified to meet the requirements of a specified region 5 conclusions definitively delineating the gwpz using rs gis is difficult however a specific scientific and systematic method utilizing the fuzzy ahp model and rs gis technique have been successfully used to define and generate gwpz maps in shanxi province china except the application of direct field data of groundwater reservation and flow however the findings of this study indicate that incorporating the fuzzy ahp model with the rs gis technique is a useful tool for groundwater potential zone mapping this method offers accurate quantitative information of groundwater resources in a cost effective manner relative to traditional invasive methods in this study seven factors thematic layers geomorphology slope runoff ndvi drainage depth lulc and soil types with various weights were incorporated into the model to produce the final gwpz map each factor was categorized into several classes features that closely regulate groundwater potentiality the ahp and fuzzy models were then applied to assign weights to each factor and standardize ratings the gwpz map was constructed by the normalized values with the kriging feature interpolation method the expected groundwater potential areas were classified into five groups from very good to very poor according to the gwpz map of the entire province in this study 207 784 2 km2 13 26 was categorized as a very good groundwater potential area 423 403 4 km2 27 02 corresponded to good groundwater potential area and the remaining 412 904 5 km2 26 35 370 438 8 km2 23 64 and 152 155 7 km2 9 71 were in the moderate poor and very poor categories however alluvial deposits have the highest potential for groundwater very good and good gwpz strongly show that alluvial plains have excellent groundwater capacity this study indicates that most of the parts of the province exhibit good to moderate potential for groundwater the excellent groundwater possibility zone is situated in the southwest and central parts of shanxi resulting from the distribution of sedimentary plains and gentle slopes with high penetration capacity the findings of this study indicate that most of the areas with suitable gradients and rainfall patterns have high groundwater potentiality moreover the gwpz was compared with existing wells and the fuzzy ahp model and the gis rs methodology was found to be basically in good agreement with the field data thus its validity was accepted in addition sensitivity analysis was conducted to better understand the function of each factor in depth sensitivity analysis revealed that ndvi and lulc had a noteworthy effect on the changes in gwpz evaluation the method introduced in this study should be verified by performing assessments of groundwater well discharge depth data and step down drilling of wells at different locations in the watershed to determine the different groundwater well yields in the different gwpzs in this way sustainable groundwater zones could be identified however the groundwater potential model is sensitive in assignment of weights of the factors parameters and their associated classes features as the weight distribution method is somewhat arbitrary future research could examine the additional factors variables that influence the identification of new gwpzs directly or indirectly the gwpz map provided by this approach can be used as an introductory guide for local authorities and water policymakers in the selection of appropriate drilling locations for new wells the significance of this study is the establishment of a basic foundation to effectively formulate a plan for managing groundwater in shanxi province china the identification of zones where aquifers are formed may assist in balancing extraction as well as facilitating the sustainable development of groundwater supplies and provide scope for further research in groundwater extraction the flexibility logical conditions and generic nature of the method can proceed with or without changes in the weights of the specified factors therefore this method can be implemented in different regions in china as well as all over the world declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study is supported with the national key r d plan on strategic international scientific and technological innovation cooperation of special project under grant 2016yfe0202300 the national natural science foundation of china under grants 41890820 41771452 and 41771454 the natural science fund of hubei province in china under grant 2018cfa007 natural science foundation of inner mongolia autonomous region project no 2019ms04017 scientific research project of colleges and universities in inner mongolia autonomous region project no njzy20277 and the state key laboratory of information engineering in surveying mapping and remote sensing special research funding 
25945,in shanxi province china groundwater is a major problem and exploration of groundwater potential zones gwpzs is a great necessity this paper contributed to integrate rs gis to delineate gwpz and applied fuzzy ahp method in a single platform the main objective includes delineation gwpzs with rs and geo environmental factors using fuzzy ahp method fuzzy ahp method was employed to calculate weight of factors rs gis was used to create maps and discover groundwater availability gwpzs were classified in five separate classes results indicated that 13 26 27 02 26 35 23 64 and 9 71 area classified as very good good moderate poor and very poor gwpzs the validated analytical results revealed 82 5 12 3 3 5 and 1 7 existing water wells exhibited in very good good moderate and poor very poor gwpzs this indicates fuzzy ahp model generated findings were in very good agreement with ground truth data this rs gis based fuzzy ahp method is proficient and efficient in identification and delineation of gwpzs graphical abstract image 1 keywords remote sensing gis fuzzy ahp groundwater northern china 1 background 1 1 introduction groundwater is a key resource of natural water and varies geographically and temporally it plays an important role in preserving the ecological balance environmental stability human well being and economic development arefin 2020 ipcc 2001 owing to the growing population enlarged irrigated cultivated area and economic development the use of and demand for groundwater has increased continuously with very little or no consideration of the importance of groundwater environmental balance nhamo et al 2020 zhang et al 2019 globally approximately 36 42 and 27 of the overall groundwater extraction are used for household agricultural and industrial purposes respectively patra et al 2018 groundwater is one of the key sources of water for arid semi arid areas of northern china as in it is also used by 70 of the population for drinking and in the dry regions in china including shanxi province over 40 of the available groundwater is used to irrigate farmland yin et al 2018 in addition owing to increasing socio economic growth groundwater demand in this region has also increased in recent years regretfully the shortage of groundwater has created a threat to the local inhabitants of this province huq et al 2018a zhu et al 2017 therefore the identification and assessment of critical parameters are necessary for predicting groundwater potential patra et al 2018 in addition demand for freshwater has increased worldwide since the last century because of industrial expansion and rapid population growth arefin 2020 zhang et al 2019 gwpz delineation is needed for sustainable groundwater usage in china shanxi province is situated in one of the driest areas known as a water shortage area zhu et al 2017 therefore identifying the presence of groundwater is the most important issue for authorities ordinary groundwater identification and delineation techniques include drilling geological hydrogeological and geophysical methods as well as field surveys this requires extensive labor for activities such as exploration which is costly in terms of time money and resources and requires the participation of experts achu et al 2020 arefin 2020 m m et al 2020 nhamo et al 2020 shao et al 2019a however the use of modern technologies such as geographic information systems gis and remote sensing rs is less expensive more responsive and more convenient the incorporation of rs and gis is a paradigm shift for groundwater research which supports the evaluation monitoring and preservation of groundwater resources silwal and pathak 2018 these tools can be useful in the exploration of groundwater mapping furthermore rs apart from its usefulness in the selection of potential areas of groundwater exploration also provides inputs for estimating groundwater resources integrating rs and gis into the mapping of groundwater potentiality enables the storage manipulation and analysis of data in different forms and magnitudes abijith et al 2020 ahmad et al 2020 shao and cai 2018 shao et al 2018 siddi raju et al 2019 yin et al 2018 these data layers exhibit a common coordinate system which can be exploited to create thematic maps within the entire study area oikonomidis et al 2015 several estimation methods have been employed to evaluate a gwpz such as multifactor analysis chen et al 2010 single factor analysis xin feng et al 2012 fuzzy clustering ahmad et al 2020 gis information fusion siddi raju et al 2019 brittle rock proportion singaraja et al 2015 and fuzzy ahp indices pinto et al 2017 in the current study the analytic hierarchy process ahp saaty 1990 fuzzy model zadeh 1965 and rs gis methods are used to delineate gwpz in addition seven factors including geomorphology slope ndvi drainage density rainfall lulc and soil type were used to identify the gwpzs ahp is a strong decision making method with various factors mohammadi behzad et al 2018 pinto et al 2017 the combination of gis and ahp could be described as a mechanism for modifying and organizing geographical details and weight mumtaz et al 2019 in traditional set theory an object either fits or does not fit into a set consequently there is no partial membership which prevents certain concepts with transitional membership from being modeled the multi criteria decision analysis mcda is recognized as a significant tool to formalize and address the environmental challenges and decision making steele et al 2009 the general objective of mcda is for determining an option from several existing preferences different spatial challenges have raised for gis mcda the mcda methods have been applied to some hydrological indicators to predict spatial potential areas for groundwater resources for example adiat et al 2012 explored the fitness of gis mcda as a spatial estimate tool for groundwater potential zones in kedah and perlis states malaysia they also examined the coherence effect of criteria on the effectiveness of mcda as a prediction tool and introduced that gis mcda method is efficient to produce proper and consistent prediction however singh et al 2017 evaluated rainwater harvesting potential and worthy locations of it and simulated recharge structures applying gis mcda in canal command of eastern india additionally murthy and mamo 2009 identified gwpzs in moyale teltele sub basin south ethiopia using mcda method moreover ajibade et al 2019 delineated the suitable zones for solid waste disposal as well as management with integration of gis and mcda in akure ondo state nigeria however fuzzy set theory can solve this problem zadeh 1965 this theory has been revised and improved by multiple researchers to simplify its use cagman et al 2011 liu and pedrycz 2009 in shanxi province china there are numerous studies on groundwater that have been performed for example zhang et al 2012 applied step by step logistic regression with some environmental explanatory parameters and rs data to construct a 2d geospatial model that predicts the regions of high as risk potential in shanxi province zhang et al 2013 also used a statistical model to forecast the high as risk area in this region results show that approximately 3000 km2 of the province were at a high risk of as concentration above 50 mg l 1 additionally the assessment of groundwater geochemistry was performed by hu et al 2013 and tang et al 2013 using geochemical processes to control fluoride mobility and iodine rich groundwater in this region moreover in a recent investigation huq et al 2018a in this region found that the acceleration and release of as in the groundwater of datong basin in shanxi province are determined by the responsible controlling factors much effort has been undertaken in the study of the groundwater system in shanxi province based on hydrology geochemistry and hydrogeochemistry however no investigations have been conducted to detect or delineate the potential groundwater zone in this province therefore the aims of the study are the following 1 to propose a methodology to identify and delineate different gwpzs based on several groundwater potential factors using integrated rs gis techniques with fuzzy ahp to ensure the conservation sustainability and management of groundwater resources in shanxi province china 2 to analyze the relationship between each contributing factor for groundwater and 3 to conduct a model validation and sensitivity analysis to determine the most important factors influencing the detection of possible groundwater zones the scientific contribution of this paper is integration of rs gis for gwpz and combined application of fuzzy ahp method in addition it presents an analysis of gwpz mapping with the integration of rs gis to develop a supplemental or modifying method for delineating groundwater moreover the efficiency of gwpz mapping was validated through the use of ground truth data existing wells in this region 1 2 applications of rs and gis in groundwater mapping the explanatory satellite data development since 1990s offers unexampled opportunities for supporting and improving water resource management it is applied to understand sub surface water environment todd and mays 1980 using satellite data in groundwater problems might support to general scientific tendency toward a big picture view for the groundwater issues toth 1963 hypothesized groundwater flow systems in various scales depending on topographic factors toth s topographically derived flow model proposed that rs may be much effective to predict groundwater flows because it presents more scope to detect groundwater satellite based sensors are presently capable to make direct as well as indirect measurements of almost all elements of hydrological cycle jasmin and mallikarjuna 2011 these sensors are thus able to provide critical data for supporting of water resources management previously satellite data could not be used for groundwater study because groundwater is located inside the earth radar from the air and satellites as well as radiometers can typically penetrate only a few centimeters below the earth s surface jasmin and mallikarjuna 2011 nevertheless groundwater indicators obtained from remote sensing provide fundamental data however traditional substitutes are not accessible recently satellite data have been used to retrieve groundwater head levels fluctuations of groundwater concentration heat characteristics and subsidence data abijith et al 2020 ma et al 2020 satellite technology is analyzed in terms of its capacity to estimate groundwater potentiality availability and flow satellite data table 1 required if ancillary research is to be conducted can be used to explore the behavior of groundwater from the surface furthermore rs data are most advantageous when integrated with a quantitative model gis and ground truth data mohammadi behzad et al 2018 integration of rs gis for groundwater is a paradigm shift in groundwater research that helps for assessing observing and conserving of groundwater resource the set of rs gis tools are useful to research in groundwater resource management mahmoud and alazba 2016 in addition these show a significant relationship in extensive groundwater resource study and management recent progresses of rs gis exhibit a vital tool to explore groundwater shao et al 2019a satellite based rs systems provide comprehensive correct unbiased and readily accessible data regarding location scope as well as progressive of changes the effective application of rs for lineaments has identified as powerful tool thought it is associated to faults and cracking in hard rock jasmin and mallikarjuna 2011 however rs gis technologies are efficient to handle and manage a large and multifaceted database for groundwater research the high quality rs data and integration of corresponding thematic maps in a sophisticated gis environment confirm and increase to predict groundwater potential location accurately achu et al 2020 the integration of rs and groundwater flow projections is an easy approach to identifying the boundary of a lake river reservoir seepage area or drainage or evapotranspiration zone rs data are also suitable in the preparation of a respective thematic map s assignment of proper weights and convergence in an advanced gis environment this guarantees and improves the accuracy of forecasting the location and groundwater capabilities of promising areas abijith et al 2020 shao et al 2019b silwal and pathak 2018 the combination of rs and gis is a vital data source for producing hydrogeological maps including the use of rs in the management of water resources hydrogeological modeling and mapping the identification and tracking of salinization impacted zones biomass determination land use and crop classification selection and environmental protection and monitoring achu et al 2020 arefin 2020 mahmoud and alazba 2016 the nature of groundwater is progressive therefore the incorporation of rs data with gis is very useful for identifying gwpzs mahmoud and alazba 2016 satellite data offer fast and accurate guidelines as well as information on diversified factors that control groundwater occurrence and movement directly and or indirectly jasmin and mallikarjuna 2011 additionally gis provides an eminent work environment for the efficient handling of comprehensive and sophisticated spatial temporal data patra et al 2018 rs is a suitable tool for regions in which geological hydrogeological and field data are inadequate or missing yousif et al 2018 many existing studies mahmoud and alazba 2016 mohammadi behzad et al 2018 oikonomidis et al 2015 pinto et al 2017 shao et al 2019b siddi raju et al 2019 yousif et al 2018 have extensively employed rs with gis techniques to assess the gwpz 2 study area description 2 1 location and climate shanxi province in northern china is situated in the east asian monsoon zone characterized by an arid and semi arid climate mountains such as heng mountain zhu mountain wutai mountain zhoushan mountain taihang mountain taiyue mountain and zhongtiao mountain constitute the boundaries of the entire province and the topography slopes down from northwest to southeast fig 1 it is situated between 34 34 n and 40 44 n latitude and 110 14 e and 114 33 e longitude and covers approximately 1 567 000 km2 zhu et al 2017 it also exhibits a typical semi arid and arid climate the average yearly rainfall is between 358 and 621 mm the evaporation is approximately 1000 mm and 60 of the annual precipitation occurs in july and august the annual air temperature of the area is between 4 2 and 14 2 c with an average temperature of 6 5 c li et al 2017 su et al 2016 2 2 geological features the eastern western and northern parts of the study location contain bedrock outcrops the bedrock predominantly originates from the archean gneiss and the basalt of the wutai group of southern part the archean gneiss of the sanggan family and sinian limestone of the northern area and the cambrian ordovician limestone and carboniferous permian jurassic sandstones and shale of the west the gneiss and basalt of the hengshan segment of the archean are to the east the hengshan mountains comprise primarily the neoarchaean hengshan complex composed of migmatite tonalite granodiorite and granite gneiss along with pegmatite granite and mafic lenses the lower paleozoic from both the cambrian and ordovician containing deposits of limestone is found in the guancen mountains the honshu ranges belong to the permian era and hence existed before the cretaceous clastic rocks li et al 2017 the cretaceous clastic rocks include shale sandstone and coal in the northern region of shanxi early middle pleistocene basalt and new tertiary lateral soils were uncovered by the late middle and early tertiary pleistocene basalt the sediments from the cenozoic era varied from shallow deep in the range of 50 2500 m generally grain size of sedimentary rock declines from the edge to the center sediments covering the middle part of the study region are a diverse series of lateral sandy loam soils silts discontinuous alluvial pluvial sands alluvial lacustrine sandy loam layers lacustrine soils and natural matter enriched and silk clays zhu et al 2017 therefore sediments in this region are typically favorable toward humic materials such as plants and algae analysis of mollusk fossils as well as micro fossil ostracoda fossil sculptures identified four main stratigraphic units fig 2 of quaternary sediments q1 q4 in this area 1 stratigraphic unit of early pliocene developed in the static hydrodynamic environments from the extension of a paleo lake it comprises a sequence of sediments from soft clay to clay with a grayish and gray green color the depth of such a sedimentary chain is usually higher than 200 m 2 before the middle pliocene stratigraphic unit the sedimentary sequence varies from 20 to 30 m with a composition of grayish yellow silt as well as silty clay the top section of this sequence is formed with fine medium sand 3 before the middle pleistocene stratigraphic unit the sequence of this unit is distinguished by a gray and grayish yellow fine sand as well as a silty fine sand the deposition setting is characterized by the interchange of the lakeside with the shallow lake resulting in regular changes in the lake level and corresponding hydrodynamic state typically the depth of this unit ranges between 30 and 50 m 4 late pleistocene to holocene stratigraphic unit lithologies include gray green to greyish yellow fine sand deep gray clay and silt the deposition condition is affected with regular changes in the level of the lake and its hydrodynamic environment the thickness of this unit is roughly 30 m 2 3 hydrological conditions there are more than 1000 large and small rivers in the shanxi province predominantly seasonal rivers with a wide seasonal fluctuation in the water flow there are five large rivers in this province covering more than 10 000 km2 namely the fenhe and qinhe rivers in the yellow river basin and the sanggan zhanghe and hutuo rivers in the haihe river basin zhu et al 2017 these rivers are the primary surface water source and system of this region however the upstream reservoir which has developed as a primary source of irrigation for agriculture has significantly changed the conditions of the rivers two types of regular and extensive irrigation operations are held in march and september every year soil salinization is recognized as an important problem in this area li et al 2017 studies of rs techniques have shown that nearly 25 30 of the entire basin is covered with saline soil the aquifer materials of the shanxi province are composed mainly of alluvial pluvial sand from the middle to late pleistocene quaternary groundwater systems are usually found in lacustrine alluvial lacustrine and alluvial pluvial aquifers the first group depth between 5 and 50 m is known as the upper group whereas the middle aquifers are 5 150 m deep and the lower aquifers have depths greater than 150 m zhang et al 2013 the runoff of non perennial water from the river and the return flow of irrigation are the recharge sources for groundwater in this region the entire quaternary groundwater system shows a complex hydrogeological structure and can be characterized into three classes unrestricted semi restricted and restricted aquifers vertically infiltrating precipitous water lateral penetrating groundwater at the front of the mountains which usually originates from the bedrock the leaking of river water and irrigation runoff replenishes the upper aquifer whereas discharge occurs mainly through evapotranspiration and artificial extraction deep aquifers are recharged by adjacent bedrock aquifers as well as top unrestricted and semi restricted aquifers and are discharged mostly by artificial abstraction hu et al 2013 recharging the system of shallow aquifers is limited as a result of dry climatic conditions this occurs particularly around the edges where the outcropping sediments are more porous owing to the weak hydraulic gradient throughout the shanxi region and the availability of fine grained poorly porous sediments in the low lying center of the area in this region groundwater typically flows from the northwest to the southeast in the middle and from the front of the mountain to the central parts of the area groundwater flow is normally slow and mainly occurs in the deep aquifers 3 materials and methods 3 1 identifying factors influencing groundwater potentiality numerous causes affect the distribution and renewal of groundwater the groundwater situation of any specific region can differ significantly owing to the different factors that affect the occurrence and recharge of groundwater huq et al 2018b mahmoud and alazba 2016 these factors are usually measured at various scales and are represented in maps due to variance in scales factor maps are created at equal scales for multifactor decision making that categorizes the factor maps in suitable classes the suitable classes then serve as the source for consistent mapmaking with all included factors in the present study seven factors were chosen for gwpz mapping the factors are presented in form of seven thematic layers specifically geomorphology slope rainfall normalized difference vegetation index ndvi drainage density land use land cover lulc classification and soil type all these factors are interdependent and are considered as a single factor for classifying the gwpz to select the most important factors four assumptions were made that are most influential in increasing the groundwater potentiality 1 increasing groundwater recharge rate of precipitation penetration 2 high penetrability of soils and rocks geological and lithological units 3 higher drainage density and 4 flat slopes 3 2 rs satellite data to prepare groundwater potential zones in this study rs satellite data were employed to create thematic maps layers of several factors that influence groundwater potentiality over the study region groundwater recharge is a process in which water tables are recharged through the injection of water from an unsaturated zone to a saturated zone satellite data from the shuttle radar topography project are used to retrieve information regarding the slope and drainage density distribution in shanxi province structural components typically slope and drainage density play a significant role in the storage of groundwater in which they serve as a conduit to groundwater high drainage density zones are suitable for high surface runoff but not for infiltration the gentle slope regions 5 are favorable for water infiltration lulc is obtained from processed landsat 8 satellite data ndvi is prepared based on spot vegetation and moderate resolution imaging spectroradiometry data geomorphology soil and rainfall data are extracted from the china geomorphology atlas and china soil type and rainfall observation data respectively afterwards thematic layers were produced from the application of original factors to the rs dataset and gis as the dataset contained diverse features such as spatial resolution protection and format therefore all the datasets were transformed into guaranteed equal features converted to a grid format and re projected with a wgs 84 system 3 3 determining factor weights multi criteria decision making mcdm is a key tool for water resources management that includes structure and rigor in the decision making an mcdm technique such as the analytic hierarchy method ahp is a systematic and scientifically established method for studying qualitative measures ahp provides a platform for comparing parameters in pairs at each layer in a hierarchy structure and can assess the comparative standard coefficient weights with alternative schemes additionally fuzzy logic generally offers an easy technique for drawing definite conclusions from uncertainty and inaccurate information balezentiene et al 2013 moreover the ahp method of mcdm has been commonly used in the past few decades in different studies and has been employed successfully in gwpz mapping however despite the universality of ahp it is often criticized owing to its manner of handling inherently ambiguous and imprecise mapping data moreover the mcdm ahp technique has been applied in arid as well as semi arid regions for groundwater potential mapping in several areas of the world ajibade et al 2019 however in none of these techniques was fuzzy set theory integrated into mcdm as in fuzzy ahp the integration of fuzzy ahp may lead to improvement in the accuracy of groundwater potential mapping owing to the flexibility of the functions of fuzzy membership on this basis the current study uses the combined rs gis method along with fuzzy ahp to develop thematic data layers to delineate gwpz in shanxi province china 3 3 1 ahp model the criteria weights were determined by employing pairwise ranking with the rank sum method of ahp ahp was originally developed by saaty 1990 and is often known as the saaty method coyle 2004 it is an organized template and technique that assists the user with handling complicated decisions it helps decision makers to identify the best possible ways to understand the problems encountered however the strength of the model is evaluated by the consistency ratio cr which has three basic principles decomposition relative judgment and priority synthesis it is based on pairwise comparisons concerning the element at the next upper hierarchical level i e among variables and indicators the ratings of the features are denoted as numerical values with the comparison matrix based on this the relative weights of all aspects can be calculated by the priority level in the hierarchy the comparative importance of factors in the pairwise matrix was determined by applying the saaty rating scale a pairwise comparison approach was adopted to calculate the relative importance of the factor table 2 reveals the saaty pairwise rating scale numeric values 1 9 are allocated on the basis of the significance of the factors coyle 2004 in this study seven thematic maps and their respective features are given appropriate relative weights from 1 to 9 through the saaty rating scale table 2 there is no typical method for the pairwise comparison however assuming that geomorphology is determined to be absolutely more significant owing to its important effect on groundwater the weight for geomorphology was assigned as 9 there were seven factors those influence gwpz first it is important to provide an initial matrix for pairwise comparison between variables as every variable is as important by itself then it considered that rainfall to be a very much more important factor in terms of groundwater recharge then drain density so 7 was assigned rainfall and 5 for drain density due to lulc and ndvi has less influence on groundwater the weights are defined as 3 and 2 respectively similarly it was measured that geomorphology is absolutely more important to impact on groundwater the value of 9 was assigned for geomorphology for soil and slope 8 and 6 were assigned because they considered as intermediate values for gwpz this study similarly judges and provides values for the other factors based on the influence toward the groundwater potentiality table 2 shows the weight assignment criteria of other factors thematic maps 3 3 2 fuzzy logic model the fuzzy model is proposed by zadeh 1965 it is the modeling and simulation technique for complex systems in spatial planning it is generally used when decisions are made to execute the spatial objects of a map as the set members however with the fuzzy set model the membership value of a particular object denotes the level of membership function zadeh 1965 the triangular fuzzy number tfn m is exhibited in fig 3 the primary function of the fuzzy model is to make the data ambiguous mathematics as well as programming functions are acceptable for application in the fuzzy model for gwpz mapping the fuzzy model permits the concept of incomplete location membership and considers the various groups in this theoretical background the fuzzy membership function fmf is assigned to analyze the spatial variation and patterns that lead to the establishment of fuzzy borders for all potential zones in this study fmfs for each possible zone are attributed to the variance as their trend evolved from fuzzy boundaries and five different factors were weighted with each factor weight representing separate evaluations in fuzzy language table 3 for instance the medium level is expressed as 3 5 5 and 7 in fmf 3 3 3 wt assignments and normalization the purpose of ahp is to account for expert knowledge however ahp cannot rely solely on human decisions therefore the integration of fuzzy analysis and ahp fuzzy ahp was established to solve fuzzy hierarchical problems in this study the fuzzy ahp technique is applied to fuzzify the hierarchical analysis with fuzzy numbers and is applied to pairwise comparisons to evaluate fuzzy weights to assess the weights of selected criteria by fuzzy ahp the following steps were considered stage i pairwise comparison matrix was developed employing all of the criteria in a hierarchical system philological principles were used for pairwise evaluations and in all conditions one of the two parameters were more relevant judgment matrices a can be established by pairwise comparison by ahp as 1 a a 11 a 21 a n 1 a 12 a 22 a n 2 a 1 n a 2 n a n n a 1 a 1 a 2 a 1 a n a 1 a 1 a 2 a 2 a 2 a n a 2 a 1 a n a 2 a n a n a n where a n denotes the nth indicator element with a i j as the judgment matrix element traditional ahp performs a clear determination and is accompanied by uncertainty therefore it is unable to reflect human thinking effectively fuzzy logic is an advanced logical method developed based on the conventional ahp process in the normalization method the matrix element is expressed by tfn tfn can avoid ambiguity inaccuracy and uncertainty to compare the results of the two techniques weights were adopted using the same saaty rating system the numbers 1 2 1 3 2 2 5 2 3 7 2 4 9 2 and 5 were used for the fuzzy scaling ratios representing the strength of one component over the other with interim values rather than crisp numbers 2 a i j l m u l a i a j u where l m u are the minimum potential value moderate probable value and maximum possible value respectively a i j the decision matrix element in equation 1 step ii calculation of normalized weight 3 w n g m n 1 n f g m n where g m is the geometric average of the ith line of the decision matrices which is calculated as 4 g m a 1 n a 2 n a n n f n f the weight is normalized and the subjective weight is eliminated by the feature vector method in addition the consistency of normalized values was tested by calculating the cr of the subject variables and their categories the cr of a matrix demonstrates the level of consistency in comparison with a randomly created matrix the consistency ratio of the matrix table 4 was 0 0077 which is considered as an acceptable consistency saaty 1990 step iii the accuracy of pairwise comparisons was calculated through the consistency index ci however the consistency of judgements was checked by calculating the cr the cr controls the balance in which weights are assigned although the weights are allocated through field experience they should neither be overestimated nor under estimated but rather be as exact as possible the acceptable cr level is 0 10 the equation for cr is 5 c r consistency index ci random index ri the consistency index ci for a matrix is calculated by the following equation 6 c i λ max n n 1 where λ max is the maximum value weight of opm and n is the number of criteria the random index ri table table 5 created by coyle indicates the sum of the ri value in which the upper row is on the order value of n of that of a random matrix and the lower row corresponds to the consistency index for random decisions 3 3 4 spatial model for delineation of gwpz the multi factor decision making structure is created by calculating the selected factors of gwpzs the model produces a gwpz map by combining consistent thematic layers with weighted overlaid gis data in the weighted overlap study both raster and vector data were equally applied all the factors were combined assigning a weight based on the importance of each attribute in the accumulated results in addition a weighted linear combination wlc of factors was then employed to create the gwpz map finally the gwpz map was produced in the gis platform with the wlc of the separate criteria layers the methodology of gwpz desalination and the integration of rs gis and fuzzy ahp technique is shown in fig 4 it shows that the first step involved generating the thematic layers including geomorphology slope ndvi drainage density rainfall lulc and soil type in second step fuzzy ahp applied to assign weights of the factors afterword the thematic layers were integrated with overlay method in gis environment finally the gwpz map generated with validation and sensitivity analysis a raster calculator in arcgis was applied to the overlaid thematic maps the groundwater probability index was calculated as 7 gwpz i 1 n j 1 m w i x j where gwpz is the map of groundwater potential zone w i denotes the normalized weight of the i th thematic variable table 6 x j indicates the normalized weight of the jth class of the variable table 4 n reveals the total number of variables and m is the total number of classes of a variable 3 4 sensitivity analysis through sensitivity analysis the impact of input criteria on the model output efficiency was assessed and the influence of the adaptation of parameters factors was validated the influence of the data on the weighted values as well as the weights allocated to each factor was validated with sensitivity analysis equation 8 was applied to measure the effectiveness of each weight 8 effective weight theme w theme s gwpi 100 where w is the weight and s is the scale value of the factors assigned to each grid gwpi indicates the groundwater potential index as computed from equation 8 4 results and discussion 4 1 development of thematic maps in the current study rs satellite data are used to produce seven thematic parameters layers that affect groundwater potentiality in shanxi province china the thematic maps from geo environmental data were deriving from conventional data maps and rs data and created in fixed spatial scaling of selected factors thus it does not denote individual characteristics of inhabitants the layers are geomorphology slope ndvi drainage density rainfall lulc and soil type however the thematic maps layers used to classify gwpz vary across the study area and the selection of assigned weights of the features classes of the maps layers is arbitrary table 6 the classes along with their respective ratings and the normalized weights of every factor are displayed in table 6 4 1 1 slope slope difference has a crucial function in the replenishment of groundwater and delineation of gwpzs sites with flatter or lower slopes are good indicators of groundwater potential zones since they provide more excellent rates of water renewal compared with regions of higher slope mumtaz et al 2019 nayyer et al 2019 slope is a vital factor impacting the retention of water and amount of infiltrated precipitation it is primarily responsible for erosion surface runoff and the transport of material water penetration capability is a property of slope i e maximum penetration occurs when the slope is at a minimum and the inverse is true as well patra et al 2018 sarker et al 2020a highly elevated mountainous regions with elevated slope values are considered to exhibit a high flow of water with inadequate infiltration systems in contrast flat regions with low slopes can hold rainwater with increased high groundwater recharge capacity however to create a slope map the most critical step is to develop the digital elevation model dem a dem with 500 m resolution is extracted from the srtm data and is used to produce the slope map the slope was derived from the dem through the arcgis slope function on the slope map the slopes are classified into four broad groups fig 5 a the elevation of the shanxi province ranges from 193 to 3004 m fig 1 the sloping map varies from 0 to 41 86 and is divided into four categories 0 0 03 0 03 0 07 0 077 0 13 0 1 as seen in fig 5a the category with the minimum slope is assigned the highest weight owing to low runoff and extensive infiltration in contrast the class with maximum slope is given the lowest weight because of the likelihood of a poor groundwater supply agarwal and garg 2016 consequently areas with a lower degree of slope are considered suitable for groundwater potentiality whereas areas with a higher degree of slope are considered as unsuitable for groundwater potentiality areas of 0 0 03 approximately flat fall into the excellent group owing to flat topography because the flat terrain shows a comparatively high penetration ratio and typically very good gwp region areas with slopes of 0 03 0 07 gently sloping are assumed to be worthy as a groundwater potential zone owing to gently undulating topography and little surface runoff sites with a slope of 0 077 0 13 steep to steep slope correspond to relatively mild to minimum runoff and are thus classified as moderate gwp areas areas with slopes of 0 13 very steep are considered as having weak gwp zones owing to the gradual and relatively high runoff and low infiltration rate 4 1 2 geomorphology geomorphology has an important function concerning the presence of groundwater the geomorphological map supports the classification of the form of geomorphic structures different formations and basal geology for providing an overview of the process structures materials and geological controls of the groundwater context patra et al 2018 it has a significant effect on the occurrence storage and recharging of water across the subsurface of the earth nevertheless data from the china geomorphology collection 1 1 million were used to generate the geomorphological map shanxi province is dominated by plains platforms hills and mountain ranges fig 5b the plain is primarily in the shape of a basin in shanxi the province consists of the plain 20 17 plains 21 23 hills 21 60 and mountains 37 00 groundwater storage is believed to be very feasible in platforms as most contain gentle hills broad catchment areas and water resistant convex lenses there is a substantial amount of good top layer containing lagging water hence a high weight was allocated to platforms hills mostly consist of hard rock mass with a concentration of soil and a lack of necessary groundwater holes and caves thus low weight was assigned to hills groundwater in the mountain areas is also a source of interstitial water in the tertiary loose coarse grained rocks in this case the potentiality for groundwater availability is moderate good 4 1 3 drainage network density the density of the drainage system is directly related to the natural infiltration of the soil it is also the most relevant parameter for hydrogeological study the drainage system and density provide significant indication of the hydrogeological features of a region it depends on the climate penetration efficiency lithology vegetation intensity relief roughness and drainage intensity index mahmoud and alazba 2016 sarker et al 2020c areas with high surface run off demonstrate reduced groundwater potentiality owing to a low recharge ratio caused by elevated drainage density a drainage density map is extracted from dem fig 1 and the drainage intensity is produced applying the density analysis tool of arcgis fig 5c the drainage density is defined by the closeness of the spacing between stream channels the drainage density of a basin is the total length of the river network divided by the basin area calculated by equation 9 9 d n d l a where d n d is the density of the drainage network l is the total length of the streams and a denotes the area the drainage density varies from 0 to 0 234 km km2 and the drainage density is categorized into four classes 0 0 032 km km2 very good 0 032 0 069 km km2 good 0 069 0 111 km km2 moderate and 0 111 0 234 km km2 poor it is inversely proportional to the terrain perviousness therefore areas with a low drainage intensity are strong indicators of water retention zones high drainage intensity influences high runoff and indicates low groundwater likelihood higher weights are assigned to a poor drainage intensity region that develops a porous surface with greater infiltration and reduced surface runoff agarwal and garg 2016 sarker et al 2020b very good drainage intensity is identified in the middle part of shanxi most of the study area is influenced by low drainage quality less porous rock results in less rainwater infiltration a low drainage intensity region provokes greater infiltration as well as reduced surface runoff relative to the high drainage intensity area this demonstrates that high drainage density zones are not a fit for the gwp zones owing to the high surface runoff achu et al 2020 adnan et al 2020 huq et al 2020 mohammadi behzad et al 2018 mumtaz et al 2019 yin et al 2018 4 1 4 rainfall the aquifers and groundwater are generally recharged by the effective rainfall the level of rainfall is useful in assessing the volume of the groundwater reservoir based on the ground properties e g lithology geology and hydro geomorphology elevated rainfall is related to strong groundwater potentiality chen 2019 minh et al 2019 rainfall is an essential part of the water cycle and a leading contributor to groundwater recharge the rate and spatial temporal distribution of rainwater have a significant impact on hydrology as well as hydrogeological conditions meanwhile precipitation intensity and the combination of different favorable circumstances contribute to gwpz detection there is a strong possibility of additional groundwater in the event of high amounts of rain in contrast if the rainfall is low then the groundwater potentiality is less rainfall differs not only temporally but also spatially therefore it is essential for determining the impact of rainfall in identifying gwpz geographic distribution of the mean annual precipitation map is developed by the inverse distance weighting projection technique in the arcgis environment rainfall data were derived from the precipitation spatial interpolation data set of 108 national meteorological stations from the shanxi province shanxi is located in the tropical monsoon climate and rain occurs mostly in the summer attributable to oceanic influence the total yearly rainfall in the shanxi region is 380 645 mm in which the eastern and southern parts of the province experience the greatest volume of rain the precipitation map is divided into four classes 430 mm 21 95 430 480 mm 51 07 480 540 mm 18 20 and 540 mm 8 77 fig 5d a class with a higher rainfall rate is assigned the highest weight correlated to an increased groundwater recharge rate and high gwp whereas a lower rainfall rate is assigned a smaller weight 4 1 5 soil type the soil plays a notable role in the percolation and infiltration of surface water into the aquifers consequently soil quality is crucial in the amount of recharge water infiltration into the subsurface ahmad et al 2020 the infiltration and soil porosity of water primarily depend on the soil texture then the texture promotes the delineation of the gwpz infiltration is mostly responsive to soil porosity and surface runoff less penetrable soil leads to surface runoff enabling less infiltration whereas porous soil contributes to increased water recharge siddi raju et al 2019 the soil map is created based on the data of 1 1 million soil maps of china the study region is defined by four primary soil types as seen in fig 6 a namely silty clay 47 63 silty clay loam 35 53 loam 14 41 and sandy loam 2 44 based on the soil condition and penetration rate different weights were assigned to each soil unit sandy loam has a thicker soil base lighter soil texture and higher soil nutrient quality meanwhile it covers a small area extremely suitable for groundwater storage consequently it was assigned the maximum weight loam is commonly spread in various areas of the world with a relatively scattered distribution the transition border of other neighboring soil types is apparent accounting for 47 63 of the shanxi province loam is found to be very good for groundwater storage and constitutes coarse particles with less clay material high water porosity and drought susceptibility mumtaz et al 2019 silty clay loam is dissolved by seepage water and afterwards flows to the lower layer thus the organic matter quality of the leached soil is relatively high owing to its high content of clay it is considered to be moderately suitable for groundwater storage the soil type exhibiting the worst water permeability is silty clay which is mainly distributed along the northwest of shanxi province 4 1 6 land use land cover lulc change has become one of the leading human induced functions influencing the occurrence as well as recharge of groundwater resources lulc has an important influence on the occurrence and renewal of groundwater in terrains a specific factor such as lulc was then investigated to address human intervention with groundwater agricultural development can also enhance groundwater restoration chen et al 2019 mumtaz et al 2019 meanwhile lulc changes could alter recharge rates which could have negative implications for groundwater quality particularly in arid and semi arid areas such as shanxi they are a major factor influencing the recharging cycle of groundwater because of the impact on evapotranspiration drainage and recharging of the groundwater system fig 6b displays the lulc map which was prepared from the landsat 8 remote sensing images the lulc map is classified into six categories forest 28 11884 cultivated 38 25239 grassland 29 15446 water 1 00244 barren land 0 09443 and urban 3 377426 cultivated land constitutes the largest lulc and the smallest lulc is occupied by barren land water bodies cultivated and barren fields are strong sources of groundwater storage because agricultural land enables further water absorption owing to the pore spaces in the soil meanwhile the development of land decreases the penetration of water into the soil owing to a lack of porous surfaces therefore water penetration is decreased in the high impervious surface urban areas thus the weight is lower for urban areas since settlement areas are deemed as less important however the highest weight was assigned to water bodies cultivated land and bare land whereas the lowest weights were assigned to grassland urban areas and forests as defined in the gwpz table 6 4 1 7 normalized difference vegetation index the ndvi is based on the proportion of photosynthetically absorbed radiation an ndvi zero value denotes no green plants and a value of approximately 1 0 8 0 9 describes the maximum possible intensity of green vegetation fig 6c shows the ndvi of the study area ndvi is measured based on per pixel and considers the standardized variation of red and near infrared nir bands of an image equation 10 10 n d v i nir red nir red the biophysical analysis of ndvi is an element of consumed photosynthetically activated radiation ndvi is an aspect that is an indirect factor of groundwater potentiality since high vegetation cover is often demonstrated in areas in which shallow groundwater is available consequently a higher weight is associated with a higher ndvi value table 7 the ndvi value in the shanxi region is classified into four classes 0 5 0 5 0 65 0 65 0 8 0 8 these four groups cover 11 43 24 83 37 67 and 26 07 respectively of the study area the existence of underlying rock elevation and vegetation cover often affect penetration and surface runoff distinct or elevated bedrock optimizes runoff in addition areas of higher altitude and shallow vegetation cover or deforestation rapidly increases runoff 4 2 groundwater potential zoning van laarhoven and pedrycz introduced the concept of fuzzy logic in ahp utilizing the advantages of both fuzzy and ahp techniques over the past few decades fuzzy ahp has become the most commonly recognized multi criteria decision making approach for numerous types of study such as groundwater quality evaluation minh et al 2019 landslides mallick et al 2018 ecosystem and environmental vulnerability li et al 2009 groundwater susceptibility nadiri et al 2017 and water quality extraction azimi et al 2018 the capability of the proposed gis induced fuzzy ahp model of this study has also made its application more practical and useful the spatial ranges of the gwp zones were defined based on the empirical consideration of seven thematic layers in the model various spatial investigation tools were applied to address spatial difficulties in the definition of possible groundwater potential zones potential groundwater areas for the study region demarcated by the synthesis of several factors including geomorphology slope rainfall ndvi drainage density lulc and soil type were used with rs gis methods the analytical results of this study highlight the weighted overlap analysis method employing gis based fuzzy ahp methodology the most powerful technique for analyzing potential groundwater areas the delineation of possible groundwater regions was performed in a group or cluster and the interpreted layers were developed applying weighted overlay classification with the spatial analyst method in arcgis in the province of shanxi china conducting groundwater potential research is needed owing to the occurrence of industrial and agricultural development the gwpz map of shanxi province fig 7 shows five separate groups zones illustrating very good good moderate poor and very poor groundwater probability zones in the region usually very good and good gwpz are associated with significant groundwater levels which are calculated by different factors areas with flat gentle hill porous and unconsolidated terrains are the most appropriate for groundwater conservation the region covered by the very good gwpz is roughly 207 784 2 km2 13 26 the very good gwpz of the study region covers the southwestern portion the good gwpz is distributed across the study area representing 27 02 423 403 4 km2 of the total area however most of the good gwpz is identified in the central and northern regions the moderate gwpz contains mostly concentrated scattered patches and is uniformly spread throughout the area it occupies a region of 412 904 5 km2 which is roughly 26 35 of the entire area representing the largest gwpz area among all classes however the western and middle parts of shanxi fall under poor as well as very poor gwpz occupying an area of approximately 370 438 8 km2 23 64 and 152 155 7 km2 9 71 respectively because of its elevated slope with adverse geological pleistocene period deposition as well as geomorphological lateritic pediplain conditions this region is included under poor and very poor gwpz usually poor and very poor gwpz have weak discharge ratios volume time relative to good and moderate gwpzs the significance this study provides a comprehensive basis for planning sustainable groundwater strategies as well as management in shanxi province the findings show key implications to design sustainable groundwater strategy as the methodology implemented in the study is emerged from reasonable conditions with generic nature this general approach of gwpz delineation is supposed for ensuring sustainable management of aquifer development the gwpz approach particularly underlines to promote groundwater conservation application of appropriate scientific plan regulating domestic as well as industrial water preservation practices leading to sustainable groundwater strategies it may helpful for the long term groundwater evolution practices in study area moreover appropriate groundwater evolution plan implementation could lead for the better storage as well as groundwater management considering quality and quantity 4 3 model validation gwpz maps to verify the accuracy of the logic based fuzzy ahp model the findings derived from the proposed model are compared with 57 existing water well locations with the gwpz map water well locations were obtained from the distribution of regional groundwater testing stations http www cigem cgs gov cn of shanxi province china and the data from these locations were used in groundwater evolution study strongly supporting geological hazard mitigation and the conservation of the geological environment these locations offer appropriate facilities for critical national policy initiatives such as natural resource management the utilization and security of water supplies and the development of sustainable civilizations however the deepest drilling depth was 291 509 m the validation of the methodology relies on associating existing groundwater wells with the gwpz map applying proximity analytical tools in arcgis the locations of the wells were also plotted on the subsequent gwpz map using arcgis the findings revealed that 82 5 47 wells and 12 3 7 wells of the total water wells are associated with very good and good gwp regions respectively whereas 3 5 2 wells belongs to moderate and 1 7 1 well corresponds to poor and very poor areas fig 7 this suggests that the model generated gwpzs were consistent with ground truth data i e water well data as well as most of the active wells are located in very good and good zones of the gwpz map this illustrates the ability of rs and gis technologies to delineate gwpzs which might help locate the appropriate locations to extract groundwater these validation findings demonstrate that the database as well as methods applied to build gwpz models for probable groundwater areas through the analysis of the fitness of parameters and comparative significant weights of the factors have produced accurate results 4 4 results of sensitivity analysis statistical analysis exhibited in table 7 derivative from equation 8 indicates a significant variance in the selected factors this is mostly attributed to the existence of a floodplain as well as mature floodplain areas with the main river systems developed during holocene period this terrain flat and gentle slope porous unconsolidated is fit to store groundwater this can demonstrate that farmland is perfect for groundwater recharge ndvi impacts evapotranspiration surface drainage and groundwater renewal which has an important effect on gwpz detection the gwpz often tends to be sensitive to the impacts of geomorphology slope rainfall drainage intensity and soil quality this may be due to the considerable statistical weights allocated to all the factors additionally high average ndvi values the drainage network and slope indicate that the confining layers significantly influence the gwpz lulc drainage rate slope geomorphology soil composition and precipitation all lead to differences in sensitivity their mean values are 0 81 0 77 0 76 0 69 0 67 and 0 72 respectively the gwpz approach of this study could be applied for assessing potential groundwater zones in semi arid region as well as other areas over the globe for instance if the purpose is to delineate gwpz then on the basis of the geo environmental situation of the given areas a new gwpz approach might be generated afterwards the new gwpz approach can be compared with the baseline of the proposed gwpz approach moreover contributing factors variables and indicators of the selection technique and weighing process can be modified to meet the requirements of a specified region 5 conclusions definitively delineating the gwpz using rs gis is difficult however a specific scientific and systematic method utilizing the fuzzy ahp model and rs gis technique have been successfully used to define and generate gwpz maps in shanxi province china except the application of direct field data of groundwater reservation and flow however the findings of this study indicate that incorporating the fuzzy ahp model with the rs gis technique is a useful tool for groundwater potential zone mapping this method offers accurate quantitative information of groundwater resources in a cost effective manner relative to traditional invasive methods in this study seven factors thematic layers geomorphology slope runoff ndvi drainage depth lulc and soil types with various weights were incorporated into the model to produce the final gwpz map each factor was categorized into several classes features that closely regulate groundwater potentiality the ahp and fuzzy models were then applied to assign weights to each factor and standardize ratings the gwpz map was constructed by the normalized values with the kriging feature interpolation method the expected groundwater potential areas were classified into five groups from very good to very poor according to the gwpz map of the entire province in this study 207 784 2 km2 13 26 was categorized as a very good groundwater potential area 423 403 4 km2 27 02 corresponded to good groundwater potential area and the remaining 412 904 5 km2 26 35 370 438 8 km2 23 64 and 152 155 7 km2 9 71 were in the moderate poor and very poor categories however alluvial deposits have the highest potential for groundwater very good and good gwpz strongly show that alluvial plains have excellent groundwater capacity this study indicates that most of the parts of the province exhibit good to moderate potential for groundwater the excellent groundwater possibility zone is situated in the southwest and central parts of shanxi resulting from the distribution of sedimentary plains and gentle slopes with high penetration capacity the findings of this study indicate that most of the areas with suitable gradients and rainfall patterns have high groundwater potentiality moreover the gwpz was compared with existing wells and the fuzzy ahp model and the gis rs methodology was found to be basically in good agreement with the field data thus its validity was accepted in addition sensitivity analysis was conducted to better understand the function of each factor in depth sensitivity analysis revealed that ndvi and lulc had a noteworthy effect on the changes in gwpz evaluation the method introduced in this study should be verified by performing assessments of groundwater well discharge depth data and step down drilling of wells at different locations in the watershed to determine the different groundwater well yields in the different gwpzs in this way sustainable groundwater zones could be identified however the groundwater potential model is sensitive in assignment of weights of the factors parameters and their associated classes features as the weight distribution method is somewhat arbitrary future research could examine the additional factors variables that influence the identification of new gwpzs directly or indirectly the gwpz map provided by this approach can be used as an introductory guide for local authorities and water policymakers in the selection of appropriate drilling locations for new wells the significance of this study is the establishment of a basic foundation to effectively formulate a plan for managing groundwater in shanxi province china the identification of zones where aquifers are formed may assist in balancing extraction as well as facilitating the sustainable development of groundwater supplies and provide scope for further research in groundwater extraction the flexibility logical conditions and generic nature of the method can proceed with or without changes in the weights of the specified factors therefore this method can be implemented in different regions in china as well as all over the world declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study is supported with the national key r d plan on strategic international scientific and technological innovation cooperation of special project under grant 2016yfe0202300 the national natural science foundation of china under grants 41890820 41771452 and 41771454 the natural science fund of hubei province in china under grant 2018cfa007 natural science foundation of inner mongolia autonomous region project no 2019ms04017 scientific research project of colleges and universities in inner mongolia autonomous region project no njzy20277 and the state key laboratory of information engineering in surveying mapping and remote sensing special research funding 
25946,agroecosystem modelling has increasingly focused on the integration of soil biogeochemical processes and crop growth however few models are available that offer high computing efficiencies for region scale simulations integrated decision support tools and a structure that allows for easy extension this paper introduces a new modelling tool to fill this gap the gdndc gridded dndc system for gridded agro biogeochemical simulations based on the established denitrification and decomposition dndc model version 95 its main advancements include i implementation of parallel computation to significantly reduce computation time across multiple scales ii a built in parameter optimization algorithm to improve the predictive accuracy and iii several decision support tools we demonstrate each of these for county level maize growth simulations in liaoning province china and reveal the potential of this new modelling tool to guide both long term policy decisions regarding optimal fertilizer application and near term crop yield forecasting for reactive decisions required in times of drought keywords gdndc parallel computation parameter optimization optimal fertilization decision support 1 introduction in past decades the expansion of irrigation area and fertilizer use for agriculture has significantly improved global food production especially under drought and nutrient depleted conditions schultz et al 2005 stewart et al 2005 yu et al 2018 more food has to be produced sustainably to meet the demand of growing population by the middle of this century godfray et al 2010 however surplus nutrients from cropland including nitrogen n and phosphorous p have led to severe environmental problems in both the hydrosphere and atmosphere cordell et al 2009 yu et al 2019 for example the loadings of n and p from cropland into surrounding water systems rivers lakes and coastal ocean can result in eutrophication paerl et al 2011 in addition greenhouse gas ghg emissions from agriculture such as nitrous oxide n2o and methane ch4 gas emissions from rice cultivation can contribute to global climate change cai et al 1997 on top of excessive inputs into the surrounding environment agriculture can also detrimentally remove resources from the surrounding environment excessive extraction of water for agricultural irrigation has been observed to contribute to groundwater depletion in some regions e g the north china plain and northern india famiglietti 2014 it is therefore of great importance to improve our fertilization practices and irrigation management to minimize environmental impacts while maintaining food production for the population growth tilman 1999 field experiments provide important information about the relationship between crop growth and environmental factors e g climate and soil properties experiments which investigate various management interventions e g fertilization irrigation and tillage at different phenological stages can test the response of crop development and evaluate the effectiveness of different options geerts et al 2008 gao et al 2012 such controlling experiments have become popular tools for determining the optimal management of both fertilization and irrigation in the long term to minimize the environmental impacts for many important crop species including rice maize wheat soybean etc further increasingly advanced approaches including global positioning system gps wireless sensor networks and unmanned aerial vehicles uav have been utilized to provide accurate monitoring of field locations crop growth conditions and soil properties zhang et al 2002 wang et al 2006 gómez candón et al 2014 such approaches facilitate the collection of large amounts of data at a high spatial temporal resolution thus the integration of both these advanced technological approaches and field experiments can lead to the development of improved real time management strategies many of these experimental and technological approaches are most beneficial at the local scale with high costs associated with labor and equipment as well as the need for specialized skills which have prevented the wide use of such approaches over regional scales zhang and kovacs 2012 simply upscaling local data to a regional level is not often possible or advised due to the significant heterogeneity in soil and crop conditions thus leading to a high amount of uncertainty in the resulting data in addition without long term or good quality historical data these approaches are limited in their predictive performances especially during the meteorological extremes e g extreme drought a solution to these issues can be found by using process based crop models which are developed through a combination of mathematical equations describing the interaction between crop growth soil nutrient dynamics and agricultural management rauff and bello 2015 for example global gridded crop models ggcms can be used to project the yield potential under climate change at regional or global scales rosenzweig et al 2014 other models e g aquacrop wofost denitrification and decomposition dndc are widely applied for deficit irrigation optimal fertilization schemes and estimation of ghg emissions miao et al 2006 garcía vila et al 2009 uzoma et al 2015 with field experiments or monitoring providing observed facts for model calibration models can be used to upscale the results and offer timely information about regional conditions driven by reliable input database e g climate forecast or reanalysis crop models can also be used to predict the potential crop growth under different scenarios and calculate the long term climate risk for better agricultural management huang et al 2018 though originally developed and validated at field scale process based crop biogeochemical models are becoming more popular in regional scale simulations holzworth et al 2015 yu et al 2019 used the dndc model to quantify the provincial level n discharge from cropland in china and evaluated the contribution of optimal fertilization to water quality at the global scale liu et al 2016 analyzed the response of wheat yield to rising temperature at a 0 5 spatial resolution based on the simulations of seven crop models elliott et al 2014 projected the global water limitation to maize soybean wheat and rice productivity under climate change by combining 16 global hydrological and crop models and then assessed the adaptation potential by irrigation improvement overall regional simulations using process based models have been proven as a powerful approach in predicting the effects of climate change on crop productivity and the response of agroecosystems to different management practices deryng et al 2011 zhao et al 2013 drewniak et al 2015 müller et al 2015 bowles et al 2018 as such these models have the potential to play an important role in policy making regarding food security climate change mitigation and environmental protection the utilization of these models continues to expand due in part to the many agricultural modelling systems or software providing user friendly tools for various applications gerber et al 2008 yu et al 2014 capalbo et al 2017 han et al 2017 rurinda et al 2020 however there are still several key challenges i computing efficiency prohibits the use of models in regional simulation with very high resolution i e global scale simulations with 0 1 grid cells over decadal time periods the traditional approach where the computation proceeds grid cell by grid cell is time intensive some crop models e g pasim apsim adopt high performance computing hpc technology to accelerate the model run time by using parallel computing where independent grid cells are processed at once across multiple cpus vital et al 2013 zhao et al 2013 for integrated modelling systems buahin et al 2019 cloned each component in a water temperature model and designed a parallel execution framework to achieve high computing efficiency however most crop models e g wofost aquacrop and more complex biogeochemical models e g dndc daycent do not have open access parallel versions compatible with different operating environments ii there are few agricultural modelling systems available for users with all necessary components to perform a complete end to end simulation from model calibration to scenario prediction and finally optimal management assessment most studies only focus on one aspect such parameter optimization iizumi et al 2009 abbaspour 2013 drought prediction yu et al 2014 improved practices for ecosystem service chen et al 2016 and water quality kaini et al 2012 however it is a difficult and time consuming process for users to perform these tasks independently with different software packages or source codes something that could be changed by using a coupled system iii the structure of most modelling systems does not easily allow for further extension even when using the same original model code base researchers will develop the model in different directions relevant to their own research interests for example based on the dssat model han et al 2017 developed the camdt software to provide the seasonal forecast of crop growth and adaptation of managements while nguyen et al 2017 applied the ant colony algorithm to optimize the irrigation and fertilization schedules although each application makes a novel contribution combining both approaches could lead to even greater insights however such integration would be time consuming due to the disparate approaches methods and software used in each study even with very powerful processing systems such integration would remain complex therefore a flexible structure is critical for the sustainable development of agricultural modelling system this paper seeks to address these challenges by developing an integrated modelling system entitled gridded denitrification and decomposition gdndc this is based on the established dndc model which is a nitrogen based biogeochemical model for agroecological processes li et al 1992 it models crop growth soil water dynamics soil carbon and nitrogen cycles under different management practices with widespread use across ghg emission estimation li et al 2001 yield prediction yu et al 2014 huang et al 2018 and n leaching qiu et al 2011 yu et al 2019 at regional scales using the dndc model as the emulator for agro biogeochemical processes we aim to i present a new structure for agricultural modelling systems by introducing a central coupler to integrate existing and potential future modules ii enable parallel simulations with mpi message passing interface protocol to increase computing efficiency for simulating tasks with high computational expenses iii couple a number of additional modules to the model including a parameter optimization module using sce ua algorithm duan et al 1992 a tool for scenario based drought prediction and risk analysis of yield and finally an optimal fertilization estimator for decision support in section 2 of this paper we introduce the newly developed structure of gdndc which now mainly depends on the dispatch of the coupler in section 3 we describe the detailed methods used in different modules including parallel running parameter optimization optimal fertilization estimate drought scenarios settings and risk calculation in section 4 case studies for regional scale applications are presented to illustrate the whole workflow for using gdndc finally we discuss potential improvements and summarize the characteristics of our system in section 5 and 6 2 framework of the gdndc system 2 1 overview of the gdndc system the current version of gdndc system is developed using c with only standard libraries normally compilable for most common compilers invoked across the whole program the system is compatible with different operating systems windows and linux and hardware environment pc and cluster similar to dndc 95 users of gdndc are able to perform both field scale simulations and regional scale simulations in regional scale simulations users can split their study regions e g state nation globe into a larger number of grid cells at a defined spatial resolution from 0 01 to 0 5 according to the corresponding resolution of input data e g soil map climate data the temporal scale is also defined by users from one month to over 100 years compared with dndc 95 the parallel computing mode has been developed for regional scale simulation to accelerate the computing efficiency in addition to this development we have coupled several additional modules in this system in which users can use for predicting crop yield and the risk under drought events as well as proposing improved n fertilization schemes to protect water quality the structure of gdndc enables convenient extension for other applications see section 2 3 and 2 4 2 2 modules in the gdndc system the gdndc system consists of five modules see fig 1 b 1 coupler module the coupler works as the trunk of gdndc system to couple other modules together initially it recognizes the input settings from modelling tasks with different goals and begins to initializes the corresponding modules throughout the simulation process the coupler collects the outputs and delivers relevant information between working modules further detail is explained in section 2 3 2 dndc module this module is responsible for the calculation of all biogeochemical processes from the dndc model this only includes the original process based parts of the dndc95 version with the rest such as the input output i o integrated into the i o module it therefore makes it a pure emulator in this system 3 i o module the i o module reads the settings of a modelling task and input database and writes the outputs to be exported the detailed description of the i o files is presented in table 1 4 parameter optimization module this module uses an optimization algorithm to determine the optimal parameters to reduce the discrepancy between model outputs and corresponding observation data users can improve the predictive capacity for targeted outputs given the spatial heterogeneity at regional scales we explain the mathematical background of this module in section 3 2 5 decision support modules it includes the optimal fertilization scenario prediction and risk analysis modules they are developed to realize the estimation of optimal fertilization schemes scenario based prediction and yield loss analysis respectively the methods used in gdndc to realize these functions are shown in sections 3 3 3 5 2 3 module coupling while different modules can be directly coupled into the dndc source code to extend the corresponding functions see fig 1a following such an approach has a number of disadvantages firstly as the source code is bounded together the program becomes increasingly complicated as such further modification can become challenging if previous alterations not be documented properly and developers fail to remember how modules are coupled together secondly to extend the code a developer requires a deep understanding of almost every process in the system in order to make their required changes without compromising the wider code base an inherently complicated and time consuming task finally for models like dndc with many users across the world incorporating all of the valuable contributions into one single codebase is not a trivial task on the other hand for earth system models e g community earth system model cesm with several complex components e g land surface model atmosphere model and ocean model a coupler is used as the trunk of the system to communicate with all the other components the outputs of a certain component are firstly delivered to the coupler which then will send the required information in suitable format to initialize and activate another component such a structure keeps all process based components independent from each other and able to run in parallel or further developed in isolation while the coupler is primarily used for information exchange between them following this we added a simple coupler as the kernel to coordinate the processes among different modules in gdndc the general structure of gdndc is presented in fig 1b in the gdndc system the coupler consists of four main components mode control data stream task manager and timer see descriptions in table 2 in the general workflow of this system the i o module is first called by the coupler to read the setting file see table 1 all the information is packed as a structure and delivered into coupler then in the coupler mode control recognizes which computing mode serial or parallel is used the timer calculates the time nodes to read write data while task manager initializes dndc and other modules following these steps the modelling process starts for every individual day within the simulated time period the timer checks if the system needs to update the input data e g parameter climate and management practices from the input database if so i o will be called again to read the corresponding data table 1 1 2 and it transmits the data into data stream then the data will be handled by data stream and delivered to dndc to activate and enable the modelling process after completing the calculation for one day model outputs e g aboveground biomass soil moisture leaching n2o emission amongst others are collected in data stream for inputs into other targeted modules 1 for parameter optimization model outputs are transported from data stream to parameter optimization module and then compared with observation data then new parameter sets can be updated and passed to data stream and then to dndc module for the next iteration of the simulation 2 for estimating the optimal fertilization strategy the optimal fertilization module generates different levels of fertilizer application and different kinds of fertilization methods these combinations are transported into data stream and used to replace the fertilization scheme data stream delivers the new management information to dndc module to test the performance of new fertilization schemes 3 for scenario based prediction timer provides the time information to scenario prediction module in which the future climatic scenarios are generated and then used to update the climatic information in data stream afterwards the climate scenarios are transported to dndc which enables the yield modelling 4 for yield loss estimation risk analysis module receives the simulated yield values in different irrigation and fertilization levels and then calculates the corresponding return period of yield loss at different spatial scales 2 4 advantages over the dndc the structure of the gdnc based on the coordinating coupler shows a number of advantages over dndc 95 for maintenance and expansibility purposes these include i in the regional simulation mode in dndc 95 the model reads all input data at the start of the simulation and proceeds to perform all numerical calculation from start to finish for long term simulation the management settings e g fertilizer level in each year are kept constant which does not reflect reality if users want to update their simulation with new data available they instead have to start the simulation from the beginning year every time whereas in the gdndc system the i o process is an independent module controlled by the coupler which in turn enables the dynamic update of new management information for each year of simulation whilst reloading key state variables e g soil moisture n c pools from the previous timestep ii all the other modules only exchange information with the coupler keeping the program clear and understandable for efficient maintenance developers can focus on the single module of interest and do not need to consider others thus enabling the parallel development of gdndc from users across different specialties iii the opportunity for developing custom modules and enhancing existing modules in gdndc will strengthen its power as an agricultural modelling system for example in the i o module developers can couple numerical climate models e g weather research and forecasting model wrf to provide short term climate predictions for the dndc module similarly different algorithms can be supplemented into the parameter optimization module modifying the data exchange interface in coupler would allow lots of other models e g agent based water quality and economic models to be integrated as additional modules to extend the application of gdndc 3 methodology 3 1 parallel computing across the components of the gdndc system the dndc model has the greatest computational expenses as it runs at an hourly resolution and includes lots of numerical calculation for soil dynamics therefore by enabling the dndc model to run in parallel will greatly reduce the simulation run time we develop two options for users the serial mode and parallel mode in the serial mode a multiple of grid cells e g regular 0 05 grids or irregular administrative grids are allocated with one single process the computation of certain grid only starts after the completion of the previous one see fig 2 a this mode is recommended for field scale simulations and debugging whereas in parallel mode a number of processes user defined within cluster s capacity can be initialized simultaneously using mpi protocol all the grid cells are matched to these processes uniformly and each process can independently perform its calculations in parallel see fig 2b users can expect significant improvements in the efficiency of regional scale simulations 3 2 parameter optimization in gdndc we couple the global optimization algorithm sce ua to automatically calibrate the model performance and obtain the optimal parameter sets sce ua is a global optimization method to solve nonlinear problems in high dimension space by combining deterministic and probabilistic approaches in this algorithm multiple complexes are initialized with their points randomly sampled from the search space the downhill simplex algorithm nelder and mead 1965 is applied for evolving each complex independently in the direction of global improvement meanwhile these complexes are periodically shuffled and all the points are reassigned to avoid the search getting trapped in local optima for detailed mathematical processes see duan et al 1992 duan et al 1994 it enables the search progress to converge towards the global optimum with high efficiency sce ua was initially developed for the hydrological models sorooshian et al 1993 duan et al 1994 yang et al 2008 and later became popular for crop models and biogeochemical models ueyama et al 2016 jin et al 2018 cui and wang 2019 for consistency with the wider gdndc system the fortran version of the sce ua source code was translated into c before being adopted as a module in table 3 eight crop related parameters which are sensitive in the modelling of water and nitrogen dynamics are listed these parameters include i maxy for the theoretical rate of daily n uptake and model s response to n supply ii tdd for the phenological process iii wd for the theoretical rate of daily water uptake and model s response to drought iv g cn l cn g fra and l fra for the biomass accumulation and allocation in different organs and v vary for the influence of technology improvement e g breeding the relevant input file see table 1 1 4 is designed for users to select any combination of these eight parameters for optimization while other parameters adopt default values from the regional database the algorithm minimizes the rmse root mean squared error as the objective function 1 obj rmse 1 n i 1 n y ˆ i y i 2 min where y i ˆ and y i are the predicted and observed variables e g yield soil moisture at the ith time step respectively by running the optimization module the dndc model will be called iteratively with a set of parameters from sce ua after each iteration model outputs are fed back to the coupler and then used for deriving a new set of parameters to minimize the objective function in eqn 1 the optimization process stops when it reaches user defined convergence standard or maximum iteration 3 3 optimal fertilization the optimal fertilization module determines the minimum fertilizer application required to maintain targeted yield levels while minimizing the environmental costs including n2o emission and n leaching compared with the n dimension search for optimal parameters in section 3 2 the 1 dimension search for optimal fertilizer amount is much less demanding we adopt the method of bisection with the workflow given in fig 3 in the first step the system simulates the yield level using the current fertilization level see table 1 1 5 and sets it as the target the range of optimal fertilizer amount is set between 0 and current level by using the method of bisection the module compares the targeted yield with the simulated yield using the mid range of the fertilizer by this approach the fertilizer range is narrowed down until an optimal fertilizer amount is obtained the default maximum number of iterations is set to 15 as this guarantees a final precision of 0 1 kg n ha 3 4 scenario based yield prediction given the uncertainties involved in a regional climate projection the gdndc system adopts climatic scenarios from a historical database to drive the prediction of crop growth particularly under drought conditions following yu et al 2014 and huang et al 2018 we assumed the climatic forcing from a given time up until harvest follows one of three scenarios 1 ideal scenario the water deficit for crop growth ceases immediately after the current day the water demand is thus fully met until the harvest with this setting the potential yield loss can be derived 2 drought continuing scenario a period without rain e g 3 days 10 days following the current timestep of interest can be specified in table 1 1 6 after this period the climate returns to the ideal condition so the potential yield loss for the following drought can be estimated 3 historic scenario the climatic data in typical year in history including historical wet medium and dry year are used to drive the simulation of yield the yield losses under representative climate conditions can provide useful information to compare the severity of a current drought to others in recorded history 3 5 risk analysis based on the dynamic update of yield predictions in section 3 4 the corresponding return period of yield loss can be estimated to demonstrate the impacts of droughts the return period often used to quantify the severity of natural disasters including floods hirabayashi et al 2013 droughts kwon and lall 2016 and wind storms della marta et al 2009 is calculated as the inverse of the frequency of a certain event it therefore represents the average recurrence interval of that particular event for example a 50 year drought implies that a drought event with equal severity has a 2 probability to occur in any year or simply put it could be expected to occur every 50 years on average the gdndc system follows three steps to quantify the agricultural drought return period firstly with the optimal parameters in section 3 2 the model runs a long term yield simulation over the past 50 years using historical climate data and current management practices e g irrigation and fertilization the yield outputs over a 50 year timespan for each grid cell constitutes the baseline yield database secondly in this system the gev generalized extreme value distribution see eqn 2 is adopted as the default probability distribution curve for yield yu et al 2014 for each grid cell the baseline yield records are used to estimate the optimal parameters k μ and σ such that 2 f x e x p 1 k x μ σ 1 k k 0 exp exp x μ σ k 0 where f x is the cumulative probability function k μ and σ are the shape location and scale parameters of gev distribution respectively and x is the simulated yield or yield loss in this case finally after determining distribution parameters for each grid cell we can calculate the value of f x i with the predicted yield x i driven by the ith climate scenario e g drought continues 10 day without rain as described in section 3 4 the return period is then computed as t x i 1 f x i 4 regional scale demonstration 4 1 gridded modelling in parallel mode in this section we demonstrate the regional simulation performed for the liaoning province china to illustrate the computing efficiency of the new parallel mode developed in gdndc 30 counties in this region are randomly selected to model the annual maize yield during 1996 2008 with each county as an independent grid the whole numerical experiment is based on the intel i7 8700 3 20 ghz cpu cluster to compare parallel and serial mode run times we run the model eight times for the serial mode and for each of the parallel modes with 2 3 4 5 and 6 mpi processes the numerical experiment in fig 4 explicitly demonstrates the significant improvement in the computation efficiency with the increase of mpi processes the variations between each of the eight repeats are negligible therefore the running time is expected to be greatly shortened with enough computing resources especially for large scale or global scale simulation with thousands of grid cells the enhanced computing capacity further ensures the effective performance of some other functions including parameter optimization and uncertainty analysis which requires much more computation the theoretical running time computed as the average running time for one process i e serial mode divided by the number of processes is also presented in fig 4 we find in fig 4 that the run time in reality practical running time is slightly longer than the theoretical running time we attribute the extra time to the computational requirements for communication between different processes this could be increased further in a large cluster if the allocated nodes are physically far from each other however it is not significant considering the overall time 4 2 parameter optimization module for maize yield prediction to demonstrate the improvement in predictive accuracy by incorporating the sce ua algorithm into the gdndc we carry out two model runs over the all 42 counties with maize plantation in liaoning province for the time period 1998 2008 the first simulation adopts the default values from the regional database for each crop related input parameter the second simulation instead uses the sce ua algorithm to optimize all eight parameters as given in table 3 over a maximum of 1000 iterations results are presented at both the county level and aggregated together to form a provisional level estimation in fig 5 bias correction methods have not been applied to the simulated results as a post process although doing so would be expected to improve the accuracy of the yield produced by the model especially when using default parameters we present the original outputs here as our system is also designed for water or n related simulations and any post processing to yield outputs will cause a mass imbalance of the system when continuing model simulations for other applications by comparing the county level simulated yields with observed statistical records in fig 5a and c we can find the parameter optimization approach effectively enhanced the r2 from 0 505 to 0 706 while reducing the rmse from 1836 kg ha to 1347 kg ha the number of outliers distant from the 1 1 line also decreases by using the optimal parameters similarly for the province level aggregation fig 5b and d the yield simulations using parameter optimization also correspond better to the observations particularly in the recorded drought years 2000 and 2006 4 3 return period of yield loss in droughts to demonstrate the risk analysis module gdndc is used to simulate annual maize yields over 42 counties in liaoning province across a 50 year period from 1961 to 2010 the optimal parameters obtained in section 4 2 are used to drive the model while the ideal maximum grain biomass is set to the 2008 level both the county level outputs and province level aggregation are used to derive the parameters of the gev distribution section 3 5 the province level return period of maize yield in this region is shown in fig 6 the most significant drought across the simulation time period was observed in 2000 with a recurrence interval of nearly 60 years this is consistent with reality given the extreme summer drought that occurred across liaoning that year the droughts of the 1960 s are estimated with around 15 year return periods consistent with the conclusions of yu et al 2018 who acknowledged that besides the natural drought conditions socioeconomic factors also played an important role in the food deficit during that period taking the 2000 drought we demonstrate the workflow of the scenario based dynamic yield prediction assuming the drought period started july 1st approximately the beginning of the productive stage for maize growth we adopt observed climate data up until this date from july 1st onwards different climatic scenarios are generated according to the scenarios listed in section 3 4 such that simulation can proceed until harvest in fig 7 the drought induced yield losses and corresponding return periods under different scenarios are shown we calculate the yield loss as followed 3 y l o s s i y i d e a l y i y i d e a l 100 where y loss i is the relative yield loss under ith scenario including the drought continuing scenarios and typical year scenarios y ideal is the simulated yield under the ideal scenario without any water deficit since the current day and y i is the simulated yield under ith scenario we find the drought induced yield loss as well as the corresponding return period increases with the assumed length of drought the next 10 20 days is the critical period for hazard mitigation during which drought conditions are likely to cause further losses from 15 at current stage to 30 20 days later which makes the magnitude of yield loss equal to the driest level in history after 20 days no further yield losses are observed since irreversible damage has been generated in the first 20 days special attention should be paid to the western and northern areas of this province given the areas seem to be more sensitive to drought conditions and therefore potentially more yield loss such dynamic maps for yield prediction are able to provide useful information and forecasts for decision makers 4 4 improved nitrogen use efficiency by optimal fertilization here the annual optimal fertilizer amounts from 2000 to 2008 are derived by gdndc for the maize plantation of the 42 counties in liaoning we set the fertilization level of this region in 2008 227 kg n ha synthetic fertilizer and 20 kg n ha manure as the baseline for maize production and then calculate the minimal fertilizer amount which can still maintain the production while increase the nitrogen use efficiency nue the calculation of nue is defined as followed 4 nue n y i e l d n f e r n d e p n m a n n f i x where n yield n fer n dep n man and n fix refer to the nitrogen in yield fertilizer deposition manure and biological fixation respectively in fig 8 we show the long term annual average of i the fertilizer reduction rate by optimal fertilization compared with baseline level and ii the nue at both the baseline and optimal levels it reveals the over fertilization still exists in liaoning and a 14 reduction of n fertilizer application can be achieved without lowering the production level the west and north counties in liaoning have a relatively lower rate of fertilizer reduction because more n is required to maintain the higher maize yield compared with the counties in the east besides the nues at county level are also improved significantly by optimal fertilization table 4 the averaged nue in liaoning increases from 0 19 to 0 42 by optimizing fertilizer application therefore it is expected to effectively save monetary and energy costs associated with fertilizer application whilst improving the regional environment by reducing the surplus n load to groundwater and surface water although the nue values vary annually due to meteorological factors e g heavy precipitation and runoff gdndc has the advantage of being able to compute the optimal fertilizer amount year by year based on the climatic and management conditions 5 discussion dndc model has been widely used for the regional scale simulation for agro biogeochemical dynamics in the past decade while improvements have been made to the scientific processes of the model its serial computing mode limits its application for modelling tasks with high computational demand at the same time the general structure has been maintained in its original form originally intended for field scale applications it combined i o processes biogeochemical processes and some other functions for decision support which makes the whole program difficult to understand researchers who are not familiar with the detailed processes in this model must invest significant time familiarizing themselves with it before embedding their contributions into the source code subsequently many unique versions with the same underlying model have been developed as it is not possible for the current structure to integrate all modifications by different individuals it leads to issues with version control and is not sustainable for dndc s development the coupler developed in gdndc is to substitute the previous structure and coordinate the cooperation between different modules as the process based module dndc and application modules e g optimal fertilization are all independent from each other both the developing efficiency and maintenance of different versions could be significantly improved apart from its basic use for biogeochemical modelling a more integrated system can be achieved in the future for hazard prediction and resource management by coupling other modules e g regional climate model and agent based model in a similar way the compatibility for both the serial mode and parallel mode is achieved in gdndc unlike the previous work by huang et al 2018 which parallelized the dndc in a unique supercomputer platform the mpi method used in gdndc is more compatible in universal computing environments including pc and large hpc clusters now users of this model are able to choose between serial mode for debugging or small scale simulation or using parallel modes to accelerate the computation for regional scale modelling furthermore gpu based accelerating approaches have the potential to further speed up the calculation of these processes across multiple soil layers however this has not been coupled to gdndc given the heavy reliance on specific hardware and therefore compatibility usability the modules parameter optimization and scenario prediction are integrated in gdndc to improve the modelling accuracy and quantify future potential yield loss respectively as crop n uptake is one of the most important components for both the crop growth dynamic and soil n balance the optimization in the current version of gdndc only focuses on these parameters which are sensitive to crop growth further development could be made by adding other parameters if more accurate simulations are required for ghg emission n leaching or soil organic carbon compared with the single objective optimization multi objective optimization could not only improve the predictive accuracy of multiple metrics of model simulations but also contribute to more complex management goals when users have to consider yield productivity soil quality and environmental effects simultaneously relevant algorithms like nsga ii deb et al 2002 and moea d zhang and li 2007 are targeted additions to the system further development is also focused on a data assimilation module as the predictive bias can still accumulate in the long term running even when adopting optimal parameters this module will utilize real time satellite data e g modis lai to correct the model state variables additionally considering the uncertainty of the climatic scenarios derived from historical datasets the online data extraction for climate observations and forecast will also be supplemented into the following version a method of bisection is used in the algorithm to derive the minimal n fertilizer amount while maintaining the production level with this approach an optimal nitrogen use can be obtained with the overall environmental cost considered however users may consider the term optimal fertilization to have a broader scope than the minimal fertilizer use defined in gdndc as a result the module will be enhanced over time to incorporate additional targets based on the practical demand in the future for the risk analysis module the return period metric provides a readily useable and understandable metric for local governments seeking to mitigate the impacts of drought others e g huang et al 2018 and gaupp et al 2017 have used a copula function to derive the joint probability of yield losses among multiple region thus far it has not been included in gdndc because of the dependence on both the distribution curve and copula function and therefore the information is not always easily translated for dissemination to the public and policy makers gdndc system integrates different modules together to provide useful information for decision support compared with other agricultural modelling system concentrating on a specific application gdndc system connects the whole workflow from parameter optimization to drought prediction optimal management strategy and risk analysis it provides convenience to users with different backgrounds as they do not need to switch between software or applications to achieve their desired results meanwhile the new structure of gdndc presented in this research creates a user friendly environment for joint collaboration among the community of dndc users it does not require expertise across the whole system before developers can start to develop their own modules unlike some agricultural modelling systems which may be maintained by a professional team or stop seeing further support development after completion of project we believe gdndc is suitably structured to allow widespread international collaboration and development and advance the science of agricultural systems modelling 6 conclusion in this research we presented the new gdndc system based on crop dndc95 for regional simulation on agro biogeochemical processes the original structure of this model is substituted with the new framework and a coupler as its kernel to coordinate the interaction between different modules we believe that the gdndc system can significantly improve the efficiency of development for both the scientific and practical purposes among different developers and contribute to the version control of this model users can run simulations in both serial and parallel modes which are embedded into gdndc of which the significant benefits of parallelization have been demonstrated in addition several modular functions including parameter optimization scenario prediction optimal fertilization and risk analysis which are all frequently applied by third party software in research or practical application are now integrated into gdndc by default with application to liaoning province we demonstrate the effectiveness of gdndc in providing useful information about crop yield prediction drought hazard assessment and fertilization guidance while further improvements for gdndc are in progress to integrate further state of the art techniques and data products we have demonstrated that the new gdndc in its current form still enhances the accessibility and convenience for users from different sectors overall the gdndc is in a position to now provide timely and trustworthy simulation outputs and forecasts that stakeholders including researchers farmers policy makers and insurance companies need for both long term decision making to reduce the agricultural sectors effects on the environment and advise reactive decisions in times of severe drought to minimize yield loss declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements x h acknowledges support from the project climate smart use of norwegian organic soils myr 2017 2022 funded by the research council of norway decision no 281109 thanks go to anonymous reviewers and editor for their constructive suggestions to improve this research this paper is dedicated to prof changsheng li who developed the dndc model and inspired our research appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104807 
25946,agroecosystem modelling has increasingly focused on the integration of soil biogeochemical processes and crop growth however few models are available that offer high computing efficiencies for region scale simulations integrated decision support tools and a structure that allows for easy extension this paper introduces a new modelling tool to fill this gap the gdndc gridded dndc system for gridded agro biogeochemical simulations based on the established denitrification and decomposition dndc model version 95 its main advancements include i implementation of parallel computation to significantly reduce computation time across multiple scales ii a built in parameter optimization algorithm to improve the predictive accuracy and iii several decision support tools we demonstrate each of these for county level maize growth simulations in liaoning province china and reveal the potential of this new modelling tool to guide both long term policy decisions regarding optimal fertilizer application and near term crop yield forecasting for reactive decisions required in times of drought keywords gdndc parallel computation parameter optimization optimal fertilization decision support 1 introduction in past decades the expansion of irrigation area and fertilizer use for agriculture has significantly improved global food production especially under drought and nutrient depleted conditions schultz et al 2005 stewart et al 2005 yu et al 2018 more food has to be produced sustainably to meet the demand of growing population by the middle of this century godfray et al 2010 however surplus nutrients from cropland including nitrogen n and phosphorous p have led to severe environmental problems in both the hydrosphere and atmosphere cordell et al 2009 yu et al 2019 for example the loadings of n and p from cropland into surrounding water systems rivers lakes and coastal ocean can result in eutrophication paerl et al 2011 in addition greenhouse gas ghg emissions from agriculture such as nitrous oxide n2o and methane ch4 gas emissions from rice cultivation can contribute to global climate change cai et al 1997 on top of excessive inputs into the surrounding environment agriculture can also detrimentally remove resources from the surrounding environment excessive extraction of water for agricultural irrigation has been observed to contribute to groundwater depletion in some regions e g the north china plain and northern india famiglietti 2014 it is therefore of great importance to improve our fertilization practices and irrigation management to minimize environmental impacts while maintaining food production for the population growth tilman 1999 field experiments provide important information about the relationship between crop growth and environmental factors e g climate and soil properties experiments which investigate various management interventions e g fertilization irrigation and tillage at different phenological stages can test the response of crop development and evaluate the effectiveness of different options geerts et al 2008 gao et al 2012 such controlling experiments have become popular tools for determining the optimal management of both fertilization and irrigation in the long term to minimize the environmental impacts for many important crop species including rice maize wheat soybean etc further increasingly advanced approaches including global positioning system gps wireless sensor networks and unmanned aerial vehicles uav have been utilized to provide accurate monitoring of field locations crop growth conditions and soil properties zhang et al 2002 wang et al 2006 gómez candón et al 2014 such approaches facilitate the collection of large amounts of data at a high spatial temporal resolution thus the integration of both these advanced technological approaches and field experiments can lead to the development of improved real time management strategies many of these experimental and technological approaches are most beneficial at the local scale with high costs associated with labor and equipment as well as the need for specialized skills which have prevented the wide use of such approaches over regional scales zhang and kovacs 2012 simply upscaling local data to a regional level is not often possible or advised due to the significant heterogeneity in soil and crop conditions thus leading to a high amount of uncertainty in the resulting data in addition without long term or good quality historical data these approaches are limited in their predictive performances especially during the meteorological extremes e g extreme drought a solution to these issues can be found by using process based crop models which are developed through a combination of mathematical equations describing the interaction between crop growth soil nutrient dynamics and agricultural management rauff and bello 2015 for example global gridded crop models ggcms can be used to project the yield potential under climate change at regional or global scales rosenzweig et al 2014 other models e g aquacrop wofost denitrification and decomposition dndc are widely applied for deficit irrigation optimal fertilization schemes and estimation of ghg emissions miao et al 2006 garcía vila et al 2009 uzoma et al 2015 with field experiments or monitoring providing observed facts for model calibration models can be used to upscale the results and offer timely information about regional conditions driven by reliable input database e g climate forecast or reanalysis crop models can also be used to predict the potential crop growth under different scenarios and calculate the long term climate risk for better agricultural management huang et al 2018 though originally developed and validated at field scale process based crop biogeochemical models are becoming more popular in regional scale simulations holzworth et al 2015 yu et al 2019 used the dndc model to quantify the provincial level n discharge from cropland in china and evaluated the contribution of optimal fertilization to water quality at the global scale liu et al 2016 analyzed the response of wheat yield to rising temperature at a 0 5 spatial resolution based on the simulations of seven crop models elliott et al 2014 projected the global water limitation to maize soybean wheat and rice productivity under climate change by combining 16 global hydrological and crop models and then assessed the adaptation potential by irrigation improvement overall regional simulations using process based models have been proven as a powerful approach in predicting the effects of climate change on crop productivity and the response of agroecosystems to different management practices deryng et al 2011 zhao et al 2013 drewniak et al 2015 müller et al 2015 bowles et al 2018 as such these models have the potential to play an important role in policy making regarding food security climate change mitigation and environmental protection the utilization of these models continues to expand due in part to the many agricultural modelling systems or software providing user friendly tools for various applications gerber et al 2008 yu et al 2014 capalbo et al 2017 han et al 2017 rurinda et al 2020 however there are still several key challenges i computing efficiency prohibits the use of models in regional simulation with very high resolution i e global scale simulations with 0 1 grid cells over decadal time periods the traditional approach where the computation proceeds grid cell by grid cell is time intensive some crop models e g pasim apsim adopt high performance computing hpc technology to accelerate the model run time by using parallel computing where independent grid cells are processed at once across multiple cpus vital et al 2013 zhao et al 2013 for integrated modelling systems buahin et al 2019 cloned each component in a water temperature model and designed a parallel execution framework to achieve high computing efficiency however most crop models e g wofost aquacrop and more complex biogeochemical models e g dndc daycent do not have open access parallel versions compatible with different operating environments ii there are few agricultural modelling systems available for users with all necessary components to perform a complete end to end simulation from model calibration to scenario prediction and finally optimal management assessment most studies only focus on one aspect such parameter optimization iizumi et al 2009 abbaspour 2013 drought prediction yu et al 2014 improved practices for ecosystem service chen et al 2016 and water quality kaini et al 2012 however it is a difficult and time consuming process for users to perform these tasks independently with different software packages or source codes something that could be changed by using a coupled system iii the structure of most modelling systems does not easily allow for further extension even when using the same original model code base researchers will develop the model in different directions relevant to their own research interests for example based on the dssat model han et al 2017 developed the camdt software to provide the seasonal forecast of crop growth and adaptation of managements while nguyen et al 2017 applied the ant colony algorithm to optimize the irrigation and fertilization schedules although each application makes a novel contribution combining both approaches could lead to even greater insights however such integration would be time consuming due to the disparate approaches methods and software used in each study even with very powerful processing systems such integration would remain complex therefore a flexible structure is critical for the sustainable development of agricultural modelling system this paper seeks to address these challenges by developing an integrated modelling system entitled gridded denitrification and decomposition gdndc this is based on the established dndc model which is a nitrogen based biogeochemical model for agroecological processes li et al 1992 it models crop growth soil water dynamics soil carbon and nitrogen cycles under different management practices with widespread use across ghg emission estimation li et al 2001 yield prediction yu et al 2014 huang et al 2018 and n leaching qiu et al 2011 yu et al 2019 at regional scales using the dndc model as the emulator for agro biogeochemical processes we aim to i present a new structure for agricultural modelling systems by introducing a central coupler to integrate existing and potential future modules ii enable parallel simulations with mpi message passing interface protocol to increase computing efficiency for simulating tasks with high computational expenses iii couple a number of additional modules to the model including a parameter optimization module using sce ua algorithm duan et al 1992 a tool for scenario based drought prediction and risk analysis of yield and finally an optimal fertilization estimator for decision support in section 2 of this paper we introduce the newly developed structure of gdndc which now mainly depends on the dispatch of the coupler in section 3 we describe the detailed methods used in different modules including parallel running parameter optimization optimal fertilization estimate drought scenarios settings and risk calculation in section 4 case studies for regional scale applications are presented to illustrate the whole workflow for using gdndc finally we discuss potential improvements and summarize the characteristics of our system in section 5 and 6 2 framework of the gdndc system 2 1 overview of the gdndc system the current version of gdndc system is developed using c with only standard libraries normally compilable for most common compilers invoked across the whole program the system is compatible with different operating systems windows and linux and hardware environment pc and cluster similar to dndc 95 users of gdndc are able to perform both field scale simulations and regional scale simulations in regional scale simulations users can split their study regions e g state nation globe into a larger number of grid cells at a defined spatial resolution from 0 01 to 0 5 according to the corresponding resolution of input data e g soil map climate data the temporal scale is also defined by users from one month to over 100 years compared with dndc 95 the parallel computing mode has been developed for regional scale simulation to accelerate the computing efficiency in addition to this development we have coupled several additional modules in this system in which users can use for predicting crop yield and the risk under drought events as well as proposing improved n fertilization schemes to protect water quality the structure of gdndc enables convenient extension for other applications see section 2 3 and 2 4 2 2 modules in the gdndc system the gdndc system consists of five modules see fig 1 b 1 coupler module the coupler works as the trunk of gdndc system to couple other modules together initially it recognizes the input settings from modelling tasks with different goals and begins to initializes the corresponding modules throughout the simulation process the coupler collects the outputs and delivers relevant information between working modules further detail is explained in section 2 3 2 dndc module this module is responsible for the calculation of all biogeochemical processes from the dndc model this only includes the original process based parts of the dndc95 version with the rest such as the input output i o integrated into the i o module it therefore makes it a pure emulator in this system 3 i o module the i o module reads the settings of a modelling task and input database and writes the outputs to be exported the detailed description of the i o files is presented in table 1 4 parameter optimization module this module uses an optimization algorithm to determine the optimal parameters to reduce the discrepancy between model outputs and corresponding observation data users can improve the predictive capacity for targeted outputs given the spatial heterogeneity at regional scales we explain the mathematical background of this module in section 3 2 5 decision support modules it includes the optimal fertilization scenario prediction and risk analysis modules they are developed to realize the estimation of optimal fertilization schemes scenario based prediction and yield loss analysis respectively the methods used in gdndc to realize these functions are shown in sections 3 3 3 5 2 3 module coupling while different modules can be directly coupled into the dndc source code to extend the corresponding functions see fig 1a following such an approach has a number of disadvantages firstly as the source code is bounded together the program becomes increasingly complicated as such further modification can become challenging if previous alterations not be documented properly and developers fail to remember how modules are coupled together secondly to extend the code a developer requires a deep understanding of almost every process in the system in order to make their required changes without compromising the wider code base an inherently complicated and time consuming task finally for models like dndc with many users across the world incorporating all of the valuable contributions into one single codebase is not a trivial task on the other hand for earth system models e g community earth system model cesm with several complex components e g land surface model atmosphere model and ocean model a coupler is used as the trunk of the system to communicate with all the other components the outputs of a certain component are firstly delivered to the coupler which then will send the required information in suitable format to initialize and activate another component such a structure keeps all process based components independent from each other and able to run in parallel or further developed in isolation while the coupler is primarily used for information exchange between them following this we added a simple coupler as the kernel to coordinate the processes among different modules in gdndc the general structure of gdndc is presented in fig 1b in the gdndc system the coupler consists of four main components mode control data stream task manager and timer see descriptions in table 2 in the general workflow of this system the i o module is first called by the coupler to read the setting file see table 1 all the information is packed as a structure and delivered into coupler then in the coupler mode control recognizes which computing mode serial or parallel is used the timer calculates the time nodes to read write data while task manager initializes dndc and other modules following these steps the modelling process starts for every individual day within the simulated time period the timer checks if the system needs to update the input data e g parameter climate and management practices from the input database if so i o will be called again to read the corresponding data table 1 1 2 and it transmits the data into data stream then the data will be handled by data stream and delivered to dndc to activate and enable the modelling process after completing the calculation for one day model outputs e g aboveground biomass soil moisture leaching n2o emission amongst others are collected in data stream for inputs into other targeted modules 1 for parameter optimization model outputs are transported from data stream to parameter optimization module and then compared with observation data then new parameter sets can be updated and passed to data stream and then to dndc module for the next iteration of the simulation 2 for estimating the optimal fertilization strategy the optimal fertilization module generates different levels of fertilizer application and different kinds of fertilization methods these combinations are transported into data stream and used to replace the fertilization scheme data stream delivers the new management information to dndc module to test the performance of new fertilization schemes 3 for scenario based prediction timer provides the time information to scenario prediction module in which the future climatic scenarios are generated and then used to update the climatic information in data stream afterwards the climate scenarios are transported to dndc which enables the yield modelling 4 for yield loss estimation risk analysis module receives the simulated yield values in different irrigation and fertilization levels and then calculates the corresponding return period of yield loss at different spatial scales 2 4 advantages over the dndc the structure of the gdnc based on the coordinating coupler shows a number of advantages over dndc 95 for maintenance and expansibility purposes these include i in the regional simulation mode in dndc 95 the model reads all input data at the start of the simulation and proceeds to perform all numerical calculation from start to finish for long term simulation the management settings e g fertilizer level in each year are kept constant which does not reflect reality if users want to update their simulation with new data available they instead have to start the simulation from the beginning year every time whereas in the gdndc system the i o process is an independent module controlled by the coupler which in turn enables the dynamic update of new management information for each year of simulation whilst reloading key state variables e g soil moisture n c pools from the previous timestep ii all the other modules only exchange information with the coupler keeping the program clear and understandable for efficient maintenance developers can focus on the single module of interest and do not need to consider others thus enabling the parallel development of gdndc from users across different specialties iii the opportunity for developing custom modules and enhancing existing modules in gdndc will strengthen its power as an agricultural modelling system for example in the i o module developers can couple numerical climate models e g weather research and forecasting model wrf to provide short term climate predictions for the dndc module similarly different algorithms can be supplemented into the parameter optimization module modifying the data exchange interface in coupler would allow lots of other models e g agent based water quality and economic models to be integrated as additional modules to extend the application of gdndc 3 methodology 3 1 parallel computing across the components of the gdndc system the dndc model has the greatest computational expenses as it runs at an hourly resolution and includes lots of numerical calculation for soil dynamics therefore by enabling the dndc model to run in parallel will greatly reduce the simulation run time we develop two options for users the serial mode and parallel mode in the serial mode a multiple of grid cells e g regular 0 05 grids or irregular administrative grids are allocated with one single process the computation of certain grid only starts after the completion of the previous one see fig 2 a this mode is recommended for field scale simulations and debugging whereas in parallel mode a number of processes user defined within cluster s capacity can be initialized simultaneously using mpi protocol all the grid cells are matched to these processes uniformly and each process can independently perform its calculations in parallel see fig 2b users can expect significant improvements in the efficiency of regional scale simulations 3 2 parameter optimization in gdndc we couple the global optimization algorithm sce ua to automatically calibrate the model performance and obtain the optimal parameter sets sce ua is a global optimization method to solve nonlinear problems in high dimension space by combining deterministic and probabilistic approaches in this algorithm multiple complexes are initialized with their points randomly sampled from the search space the downhill simplex algorithm nelder and mead 1965 is applied for evolving each complex independently in the direction of global improvement meanwhile these complexes are periodically shuffled and all the points are reassigned to avoid the search getting trapped in local optima for detailed mathematical processes see duan et al 1992 duan et al 1994 it enables the search progress to converge towards the global optimum with high efficiency sce ua was initially developed for the hydrological models sorooshian et al 1993 duan et al 1994 yang et al 2008 and later became popular for crop models and biogeochemical models ueyama et al 2016 jin et al 2018 cui and wang 2019 for consistency with the wider gdndc system the fortran version of the sce ua source code was translated into c before being adopted as a module in table 3 eight crop related parameters which are sensitive in the modelling of water and nitrogen dynamics are listed these parameters include i maxy for the theoretical rate of daily n uptake and model s response to n supply ii tdd for the phenological process iii wd for the theoretical rate of daily water uptake and model s response to drought iv g cn l cn g fra and l fra for the biomass accumulation and allocation in different organs and v vary for the influence of technology improvement e g breeding the relevant input file see table 1 1 4 is designed for users to select any combination of these eight parameters for optimization while other parameters adopt default values from the regional database the algorithm minimizes the rmse root mean squared error as the objective function 1 obj rmse 1 n i 1 n y ˆ i y i 2 min where y i ˆ and y i are the predicted and observed variables e g yield soil moisture at the ith time step respectively by running the optimization module the dndc model will be called iteratively with a set of parameters from sce ua after each iteration model outputs are fed back to the coupler and then used for deriving a new set of parameters to minimize the objective function in eqn 1 the optimization process stops when it reaches user defined convergence standard or maximum iteration 3 3 optimal fertilization the optimal fertilization module determines the minimum fertilizer application required to maintain targeted yield levels while minimizing the environmental costs including n2o emission and n leaching compared with the n dimension search for optimal parameters in section 3 2 the 1 dimension search for optimal fertilizer amount is much less demanding we adopt the method of bisection with the workflow given in fig 3 in the first step the system simulates the yield level using the current fertilization level see table 1 1 5 and sets it as the target the range of optimal fertilizer amount is set between 0 and current level by using the method of bisection the module compares the targeted yield with the simulated yield using the mid range of the fertilizer by this approach the fertilizer range is narrowed down until an optimal fertilizer amount is obtained the default maximum number of iterations is set to 15 as this guarantees a final precision of 0 1 kg n ha 3 4 scenario based yield prediction given the uncertainties involved in a regional climate projection the gdndc system adopts climatic scenarios from a historical database to drive the prediction of crop growth particularly under drought conditions following yu et al 2014 and huang et al 2018 we assumed the climatic forcing from a given time up until harvest follows one of three scenarios 1 ideal scenario the water deficit for crop growth ceases immediately after the current day the water demand is thus fully met until the harvest with this setting the potential yield loss can be derived 2 drought continuing scenario a period without rain e g 3 days 10 days following the current timestep of interest can be specified in table 1 1 6 after this period the climate returns to the ideal condition so the potential yield loss for the following drought can be estimated 3 historic scenario the climatic data in typical year in history including historical wet medium and dry year are used to drive the simulation of yield the yield losses under representative climate conditions can provide useful information to compare the severity of a current drought to others in recorded history 3 5 risk analysis based on the dynamic update of yield predictions in section 3 4 the corresponding return period of yield loss can be estimated to demonstrate the impacts of droughts the return period often used to quantify the severity of natural disasters including floods hirabayashi et al 2013 droughts kwon and lall 2016 and wind storms della marta et al 2009 is calculated as the inverse of the frequency of a certain event it therefore represents the average recurrence interval of that particular event for example a 50 year drought implies that a drought event with equal severity has a 2 probability to occur in any year or simply put it could be expected to occur every 50 years on average the gdndc system follows three steps to quantify the agricultural drought return period firstly with the optimal parameters in section 3 2 the model runs a long term yield simulation over the past 50 years using historical climate data and current management practices e g irrigation and fertilization the yield outputs over a 50 year timespan for each grid cell constitutes the baseline yield database secondly in this system the gev generalized extreme value distribution see eqn 2 is adopted as the default probability distribution curve for yield yu et al 2014 for each grid cell the baseline yield records are used to estimate the optimal parameters k μ and σ such that 2 f x e x p 1 k x μ σ 1 k k 0 exp exp x μ σ k 0 where f x is the cumulative probability function k μ and σ are the shape location and scale parameters of gev distribution respectively and x is the simulated yield or yield loss in this case finally after determining distribution parameters for each grid cell we can calculate the value of f x i with the predicted yield x i driven by the ith climate scenario e g drought continues 10 day without rain as described in section 3 4 the return period is then computed as t x i 1 f x i 4 regional scale demonstration 4 1 gridded modelling in parallel mode in this section we demonstrate the regional simulation performed for the liaoning province china to illustrate the computing efficiency of the new parallel mode developed in gdndc 30 counties in this region are randomly selected to model the annual maize yield during 1996 2008 with each county as an independent grid the whole numerical experiment is based on the intel i7 8700 3 20 ghz cpu cluster to compare parallel and serial mode run times we run the model eight times for the serial mode and for each of the parallel modes with 2 3 4 5 and 6 mpi processes the numerical experiment in fig 4 explicitly demonstrates the significant improvement in the computation efficiency with the increase of mpi processes the variations between each of the eight repeats are negligible therefore the running time is expected to be greatly shortened with enough computing resources especially for large scale or global scale simulation with thousands of grid cells the enhanced computing capacity further ensures the effective performance of some other functions including parameter optimization and uncertainty analysis which requires much more computation the theoretical running time computed as the average running time for one process i e serial mode divided by the number of processes is also presented in fig 4 we find in fig 4 that the run time in reality practical running time is slightly longer than the theoretical running time we attribute the extra time to the computational requirements for communication between different processes this could be increased further in a large cluster if the allocated nodes are physically far from each other however it is not significant considering the overall time 4 2 parameter optimization module for maize yield prediction to demonstrate the improvement in predictive accuracy by incorporating the sce ua algorithm into the gdndc we carry out two model runs over the all 42 counties with maize plantation in liaoning province for the time period 1998 2008 the first simulation adopts the default values from the regional database for each crop related input parameter the second simulation instead uses the sce ua algorithm to optimize all eight parameters as given in table 3 over a maximum of 1000 iterations results are presented at both the county level and aggregated together to form a provisional level estimation in fig 5 bias correction methods have not been applied to the simulated results as a post process although doing so would be expected to improve the accuracy of the yield produced by the model especially when using default parameters we present the original outputs here as our system is also designed for water or n related simulations and any post processing to yield outputs will cause a mass imbalance of the system when continuing model simulations for other applications by comparing the county level simulated yields with observed statistical records in fig 5a and c we can find the parameter optimization approach effectively enhanced the r2 from 0 505 to 0 706 while reducing the rmse from 1836 kg ha to 1347 kg ha the number of outliers distant from the 1 1 line also decreases by using the optimal parameters similarly for the province level aggregation fig 5b and d the yield simulations using parameter optimization also correspond better to the observations particularly in the recorded drought years 2000 and 2006 4 3 return period of yield loss in droughts to demonstrate the risk analysis module gdndc is used to simulate annual maize yields over 42 counties in liaoning province across a 50 year period from 1961 to 2010 the optimal parameters obtained in section 4 2 are used to drive the model while the ideal maximum grain biomass is set to the 2008 level both the county level outputs and province level aggregation are used to derive the parameters of the gev distribution section 3 5 the province level return period of maize yield in this region is shown in fig 6 the most significant drought across the simulation time period was observed in 2000 with a recurrence interval of nearly 60 years this is consistent with reality given the extreme summer drought that occurred across liaoning that year the droughts of the 1960 s are estimated with around 15 year return periods consistent with the conclusions of yu et al 2018 who acknowledged that besides the natural drought conditions socioeconomic factors also played an important role in the food deficit during that period taking the 2000 drought we demonstrate the workflow of the scenario based dynamic yield prediction assuming the drought period started july 1st approximately the beginning of the productive stage for maize growth we adopt observed climate data up until this date from july 1st onwards different climatic scenarios are generated according to the scenarios listed in section 3 4 such that simulation can proceed until harvest in fig 7 the drought induced yield losses and corresponding return periods under different scenarios are shown we calculate the yield loss as followed 3 y l o s s i y i d e a l y i y i d e a l 100 where y loss i is the relative yield loss under ith scenario including the drought continuing scenarios and typical year scenarios y ideal is the simulated yield under the ideal scenario without any water deficit since the current day and y i is the simulated yield under ith scenario we find the drought induced yield loss as well as the corresponding return period increases with the assumed length of drought the next 10 20 days is the critical period for hazard mitigation during which drought conditions are likely to cause further losses from 15 at current stage to 30 20 days later which makes the magnitude of yield loss equal to the driest level in history after 20 days no further yield losses are observed since irreversible damage has been generated in the first 20 days special attention should be paid to the western and northern areas of this province given the areas seem to be more sensitive to drought conditions and therefore potentially more yield loss such dynamic maps for yield prediction are able to provide useful information and forecasts for decision makers 4 4 improved nitrogen use efficiency by optimal fertilization here the annual optimal fertilizer amounts from 2000 to 2008 are derived by gdndc for the maize plantation of the 42 counties in liaoning we set the fertilization level of this region in 2008 227 kg n ha synthetic fertilizer and 20 kg n ha manure as the baseline for maize production and then calculate the minimal fertilizer amount which can still maintain the production while increase the nitrogen use efficiency nue the calculation of nue is defined as followed 4 nue n y i e l d n f e r n d e p n m a n n f i x where n yield n fer n dep n man and n fix refer to the nitrogen in yield fertilizer deposition manure and biological fixation respectively in fig 8 we show the long term annual average of i the fertilizer reduction rate by optimal fertilization compared with baseline level and ii the nue at both the baseline and optimal levels it reveals the over fertilization still exists in liaoning and a 14 reduction of n fertilizer application can be achieved without lowering the production level the west and north counties in liaoning have a relatively lower rate of fertilizer reduction because more n is required to maintain the higher maize yield compared with the counties in the east besides the nues at county level are also improved significantly by optimal fertilization table 4 the averaged nue in liaoning increases from 0 19 to 0 42 by optimizing fertilizer application therefore it is expected to effectively save monetary and energy costs associated with fertilizer application whilst improving the regional environment by reducing the surplus n load to groundwater and surface water although the nue values vary annually due to meteorological factors e g heavy precipitation and runoff gdndc has the advantage of being able to compute the optimal fertilizer amount year by year based on the climatic and management conditions 5 discussion dndc model has been widely used for the regional scale simulation for agro biogeochemical dynamics in the past decade while improvements have been made to the scientific processes of the model its serial computing mode limits its application for modelling tasks with high computational demand at the same time the general structure has been maintained in its original form originally intended for field scale applications it combined i o processes biogeochemical processes and some other functions for decision support which makes the whole program difficult to understand researchers who are not familiar with the detailed processes in this model must invest significant time familiarizing themselves with it before embedding their contributions into the source code subsequently many unique versions with the same underlying model have been developed as it is not possible for the current structure to integrate all modifications by different individuals it leads to issues with version control and is not sustainable for dndc s development the coupler developed in gdndc is to substitute the previous structure and coordinate the cooperation between different modules as the process based module dndc and application modules e g optimal fertilization are all independent from each other both the developing efficiency and maintenance of different versions could be significantly improved apart from its basic use for biogeochemical modelling a more integrated system can be achieved in the future for hazard prediction and resource management by coupling other modules e g regional climate model and agent based model in a similar way the compatibility for both the serial mode and parallel mode is achieved in gdndc unlike the previous work by huang et al 2018 which parallelized the dndc in a unique supercomputer platform the mpi method used in gdndc is more compatible in universal computing environments including pc and large hpc clusters now users of this model are able to choose between serial mode for debugging or small scale simulation or using parallel modes to accelerate the computation for regional scale modelling furthermore gpu based accelerating approaches have the potential to further speed up the calculation of these processes across multiple soil layers however this has not been coupled to gdndc given the heavy reliance on specific hardware and therefore compatibility usability the modules parameter optimization and scenario prediction are integrated in gdndc to improve the modelling accuracy and quantify future potential yield loss respectively as crop n uptake is one of the most important components for both the crop growth dynamic and soil n balance the optimization in the current version of gdndc only focuses on these parameters which are sensitive to crop growth further development could be made by adding other parameters if more accurate simulations are required for ghg emission n leaching or soil organic carbon compared with the single objective optimization multi objective optimization could not only improve the predictive accuracy of multiple metrics of model simulations but also contribute to more complex management goals when users have to consider yield productivity soil quality and environmental effects simultaneously relevant algorithms like nsga ii deb et al 2002 and moea d zhang and li 2007 are targeted additions to the system further development is also focused on a data assimilation module as the predictive bias can still accumulate in the long term running even when adopting optimal parameters this module will utilize real time satellite data e g modis lai to correct the model state variables additionally considering the uncertainty of the climatic scenarios derived from historical datasets the online data extraction for climate observations and forecast will also be supplemented into the following version a method of bisection is used in the algorithm to derive the minimal n fertilizer amount while maintaining the production level with this approach an optimal nitrogen use can be obtained with the overall environmental cost considered however users may consider the term optimal fertilization to have a broader scope than the minimal fertilizer use defined in gdndc as a result the module will be enhanced over time to incorporate additional targets based on the practical demand in the future for the risk analysis module the return period metric provides a readily useable and understandable metric for local governments seeking to mitigate the impacts of drought others e g huang et al 2018 and gaupp et al 2017 have used a copula function to derive the joint probability of yield losses among multiple region thus far it has not been included in gdndc because of the dependence on both the distribution curve and copula function and therefore the information is not always easily translated for dissemination to the public and policy makers gdndc system integrates different modules together to provide useful information for decision support compared with other agricultural modelling system concentrating on a specific application gdndc system connects the whole workflow from parameter optimization to drought prediction optimal management strategy and risk analysis it provides convenience to users with different backgrounds as they do not need to switch between software or applications to achieve their desired results meanwhile the new structure of gdndc presented in this research creates a user friendly environment for joint collaboration among the community of dndc users it does not require expertise across the whole system before developers can start to develop their own modules unlike some agricultural modelling systems which may be maintained by a professional team or stop seeing further support development after completion of project we believe gdndc is suitably structured to allow widespread international collaboration and development and advance the science of agricultural systems modelling 6 conclusion in this research we presented the new gdndc system based on crop dndc95 for regional simulation on agro biogeochemical processes the original structure of this model is substituted with the new framework and a coupler as its kernel to coordinate the interaction between different modules we believe that the gdndc system can significantly improve the efficiency of development for both the scientific and practical purposes among different developers and contribute to the version control of this model users can run simulations in both serial and parallel modes which are embedded into gdndc of which the significant benefits of parallelization have been demonstrated in addition several modular functions including parameter optimization scenario prediction optimal fertilization and risk analysis which are all frequently applied by third party software in research or practical application are now integrated into gdndc by default with application to liaoning province we demonstrate the effectiveness of gdndc in providing useful information about crop yield prediction drought hazard assessment and fertilization guidance while further improvements for gdndc are in progress to integrate further state of the art techniques and data products we have demonstrated that the new gdndc in its current form still enhances the accessibility and convenience for users from different sectors overall the gdndc is in a position to now provide timely and trustworthy simulation outputs and forecasts that stakeholders including researchers farmers policy makers and insurance companies need for both long term decision making to reduce the agricultural sectors effects on the environment and advise reactive decisions in times of severe drought to minimize yield loss declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements x h acknowledges support from the project climate smart use of norwegian organic soils myr 2017 2022 funded by the research council of norway decision no 281109 thanks go to anonymous reviewers and editor for their constructive suggestions to improve this research this paper is dedicated to prof changsheng li who developed the dndc model and inspired our research appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104807 
25947,a graphical user interface gui is regularly used to support model applications in catchment hydrological modelling software a gui is generally user friendly for novice users but opens sources of irreproducible research we illustrate that none of the 10 soil and water assessment tool swat models over the upper blue nile can easily be reproduced scripted workflows provide the ability to reproduce model set ups but they may be less user friendly especially to novice users we present a software swat aw that promotes reproducible swat model studies while remaining user friendly for both novice and expert users swat aw uses a configuration file to create models that are compatible with gui we applied the workflow to the blue nile catchment and show that it yields the same results the swat gui we conclude that such user friendly scripted workflows enhance reproducibility transparency and reusability of hydrological models the software is publicly available at https github com vub hydr swatplus aw keywords swat reproducibility hydrology modelling workflows 1 introduction the scientific method relies on the ability of scientists to reproduce each other s published results so they can build upon prior knowledge begley and ioannidis 2015 marcus 2015 recently the reproducibility of science has come under scrutiny marcus 2015 it has been discovered that a large proportion of scientific research is not reproducible vasilevsky et al 2013 mcnutt 2014 in their survey involving researchers from biology chemistry earth and environment medicine physics and engineering and other fields baker and penny 2016 reported that more than 70 of the researchers that tried to reproduce another scientist s experiment failed in the experiment research groups at amgen corporation were able to reproduce only 11 of the academic research on haematology and oncology begley and ellis 2012 vasilevsky et al 2013 in many other cases major conclusions have not been confirmed even when repeated by the same investigators begley and ioannidis 2015 a more troubling source of irreproducible research is scientific fraud and misconduct scientific fraud is where researchers tamper with the model to get the results that they are looking for just like other scientific fields the catchment modelling community suffers from reproducibility issues hutton et al 2016 in response crout et al 2008 have detailed good modelling practice which adds on ten iterative steps in development and evaluation of environmental models proposed by jakeman et al 2006 the guidelines presented in these papers help boost provenance and reproducibility in modelling studies as such current publication practices in catchment studies should enable reproducibility shu et al 2012 but there are a number of sources of irreproducibility in the model creation process this is mainly because there are many adjustments made during a catchment model setup to tailor the model to a specific context furthermore some catchment modelling exercises also use some bits of code during the model setup phase which in many cases are not made available hutton et al 2016 and are too specific for that exercise while some catchment modellers take time to report specific details of their model setup other technical information is still not included the above causes of irreproducible research point to lack of transparency in reporting as the overall cause of irreproducible research in catchment modelling crout et al 2008 also list the lack of transparency as one of the barriers to reproducible studies refsgaard and henriksen 2004 point out that without transparency modelling projects can be difficult to audit and without a considerable effort it is hardly possible to reconstruct repeat and reproduce the modelling process and its results the problem is illustrated when evaluating the reporting in peer reviewed journals of several studies using swat for catchment modelling of the upper blue nile catchment for each of the studies the availability of the information that is necessary to reproduce the study is shown in table 1 lacking any of this information makes it very difficult if not impossible to reproduce the swat models results leonard and duffy 2016 emphasise the value of workflows in capturing all steps for reproducibility and provenance furthermore crout et al 2008 encourage modellers to embrace the use of automated methodologies to support transparency and understanding of results automating the model creation workflow stores all settings and data which if made available solves the lack of transparency on model creation catchment modelling can thus benefit from using fully automated workflows for the entire model setup process however one needs at least basic programming skills to use automated workflows in addition introducing automated workflows to catchment modelling typically replaces a graphical user interface gui which often allows direct manipulation of the models and is also more intuitive for a novice user nielsen et al 2017 pointed out that guis assist in bridging the expertise gap experienced by potential new model users however when chen and zhang 2007 compared the advantages and disadvantages of both guis and text based user interfaces tuis which most workflows use they concluded that the tui offers more benefits to expert users than to novice users we argue that an ideal workflow for catchment model setup should care for both the novice and the expert this study aims at promoting reproducibility and transparency of swat for both novice and expert users by presenting a software swat automatic workflow swat aw for setting up the soil and water assessment tool swat the innovative element is that the software is interoperable with several guis used to setup swat models a user can start in swat guis which gives more support to the novice users and transfer the model to the swat aw we elaborate on how the software improves reproducibility of swat model by summarising model configuration into a single configuration file config py we show that the configuration file alone is sufficient to allow reproducible swat models as it transparently stores all model settings 2 present modelling procedure for swat the soil and water assessment tool swat arnold et al 2012 is one of the most widely used catchment model software it is a deterministic time continuous semi distributed hydrological model software developed for application at catchment scale swat has been applied to many case studies in different parts of the world e g ricci et al 2018 perra et al 2018 aouissi et al 2018 shen et al 2015 bieger et al 2013 swat is based on the concept of hydrologic response units hrus hrus are areas with a unique combination of soil land use slope and sub catchment at which calculations take place results are routed through a stream network that is often derived from the dem to the outlet swat arnold et al 2018 is a completely restructured version of swat swat uses the same equations as swat while offering more flexibility in model configuration to the user swat introduces land scape units lsus to discretise subbasins further and allow separation of upland processes from wetlands during model setup subbasins are delineated based on stream thresholds while lsus are delineated based on channel threshold as described in the user manual https swatplus gitbook io docs user qswat decision tables have also been introduced in swat to schedule activities that are only carried out when specified conditions are met decision tables in swat can be used to specify land use manage ment and reservoir management swat also introduces connection files which allow users to connect objects within the model easily currently the only interfaces for setting up a swat model are qswat quantum gis qgis based interface and swat editor apart from input data preparation the model application procedure can be described based on the steps presented in the gui fig 1 steps 1 through 3 are performed using the qswat software in qgis whereas steps 4 and 5 are performed using swat editor 3 new workflow for swat the swat automatic workflow swat aw we created a software where we automate the procedure to set up a swat model from a given dataset and settings selected by the user in a single file we refer to as config file we implemented the software using a python based scripting environment python is a simple programming language system with extensive library support for programming in general snyder 2007 being an interpreted and a high level programming language users can easily add functions that they need to the software a list of dependencies for the swat aw is specified in the user manual available from the swat aw repository https github com vub hydr swatplus aw swat aw takes the directory where it is executed as an argument and uses the config file available in the directory to setup the swat model which is saved in the same directory as the config file s the model can be opened in the guis that are available to set up swat model swat aw also can retrieve data from an already existing model and create a config file that reproduces the model from which the config file is created the software is described in detail below 3 1 preparing model setup environment 3 1 1 software requirements the workflow has been tested on windows 10 where it uses python 3 7 and on linux ubuntu 20 04 running where it uses python 3 8 users need to install the 64 bit version of qgis v3 10 and swat aw using the installer from the repository 3 1 2 input data the input data is prepared in the same way as input that is used in the gui however it is placed in a predefined directory structure within the directory named data within the directory where swat aw is run fig 2 the organization of the input data files is further described in the user manual available from the repository 3 1 3 the config file config py the workflow requires user options which are specified through the config file appendix 8 1 the config file is a python file where the user enters model configuration settings using text editing programs such as notepad it is placed in the same directory as the data directory the following information must be entered into the config file to set up a new model 1 project name 2 file names a raster maps dem land use soil b shapefiles outlet c lookup tables and usersoil land use soil the lookup tables are used to cross reference the raster map values to the values contained in the swat reference databases the usersoil is one of the files imported into reference databases into the file that contains soil properties and is used to derive soil parameters for the model being setup 3 project options a watershed delineation thresholds b output snap threshold c hru filter methods and thresholds d water routing methods e potential evapotranspiration calculation methods if there is information on reservoir management and land use management for the model being set up this information can be entered in the config file and swat aw will use this information during the model setup otherwise default management practices will be applied the workflow allows the user to retrieve input data and a config file from an existing model setup that was created in qswat and swat editor or using swat aw data and config file are retrieved if the model 2 config option is set to true in this case the model should already be present in the directory where the config file is located swat aw also has an option to keep a log for troubleshooting later or just for keeping a record during model setup 3 2 software code structure before starting the swat aw the user should populate the config file and the data directory the user can start the software by opening command prompt or powershell in the current directory typing swatplus aw and pressing enter running this command sets up the python environment for working with qgis application programming interface api pyqgis which is necessary to run the main steps 1 through 6 fig 3 it is also possible to run only a specific step without running all the steps the swatplus api command is used with a step option as an argument to run only one step e g swatplus api prepare project the available step options include prepare project delineate watershed create hrus setup editor project import weather configure model options setup management write files run swatplus make figures and calibrate details for each step are discussed below 3 2 1 prepare project the project preparation stage is performed depending on whether the model 2 config option in the config file is set to true or false if model 2 config is set to true project preparation is not carried out otherwise swat aw will prepare the qgis project structure for the swat model application this stage includes the following steps i creation of the default directory structure for a swat application the name of the parent directory bears the name of the project specified in the config file fig 4 ii set up of databases two databases are set up one is swatplus datasets sqlite which contains default parameters for the swat model swat aw also creates the sqlite project database bearing the project name the project database at a later stage stores hru data the scripted workflow also imports landuse lookup soil lookup and usersoil tables into the database the names of the tables are acquired from the config file iii transfer of gis input data swat aw integrates input raster and shapefiles from the data directory into the project directory structure under watershed fig 4 iv creation of a qgis project file the file bears the project name which is acquired from the config file swat aw also stores information on watershed delineation and hru creation into the qgis project file so that qswat can read it later when the user opens the project in the gui this file is saved in the project name directory fig 4 after the project preparation stage all files are in place but there is still the need to delineate the watershed and create hrus before swat editor functions can be performed on the project watershed delineation and hru creation are done in step 3 3 2 2 create config file this step is only performed if the model 2 config variable in the config file is set to true as seen in fig 3 if this step is performed it means step 1 was not performed swat aw will look for swat models in the directory where it is launched if any of the found models is listed in the config file it will extract a raster files and shapefiles from the project name watershed directory within the project directory structure fig 4 b lookup tables usersoil table and model options from the project database c weather data from the model in the case that the model listed in the config file was not found or that there was no config file in the directory the user is requested to select from the list of available models at the end of this stage a data directory is created and populated by the data retrieved from the model while model configuration information is saved in the config file 3 2 3 create hrus the aim of this stage is to generate unique combinations of four layers namely landscape units lsus sub divisions of sub basins soils land use and slope classes however by the time the swat aw reaches this stage the landscape units layer and the slope classes layer does not exist yet therefore the first step at this stage is watershed delineation in order to create sub basins and landscape units watershed delineation involves the use of the dem to calculate a flow direction and a flow accumulation map stream and channel thresholds are applied to the flow accumulation map to derive stream and channel networks respectively stream outlets are created in the stream network wherever two streams meet and additional outlets are acquired from the outlets shapefile listed in the config file the watershed is delineated by drawing a water divide around the pixels that contribute to the main outlet in the same way sub basins are delineated by drawing a water divide around pixels that contribute to each stream outlet while lsus are delineated using channel outlets it is important to note that the channel threshold must be equal to or smaller than the stream threshold in addition the complexity of the generated networks depends on the magnitudes of the stream and channels thresholds the smaller the thresholds the higher the complexity next the slope class map is created this map is derived from the dem using the slope classes specified in the config file upon creating the slope map all the four layers necessary for creating hrus become available the four layers that are required to define hru s are overlaid and unique combinations of the layers are identified and are referred to as potential hrus these potential hrus are filtered using methods and thresholds specified in the config file to form the final hrus the final hrus are finally saved in the project database 3 2 4 edit inputs and run at this stage swat aw creates and saves a swat editor project for compatibility with the swat editor gui weather information is then imported from the data directory and model options are configured in the project database the swat executable does not read directly from the databases ascii files containing all information about the model setup are written to the txtinout directory in the directory structure specified in fig 4 from where the executable runs depending on whether calibrated parameters are provided the swat aw will apply the parameters before attempting to run the model the workflow finally runs the model using the executable type specified in the config file 1 do not run if this option is used the model is not run 2 release the release executable runs faster but it does not provide information for troubleshooting errors 3 debug the debug version runs slow but it provides information for troubleshooting errors if they occur 3 2 5 run calibration and make figures calibration is performed only if the calibrate option in the config file is set to true calibration is simply based on the best performing parameter set from a sample generated using latin hypercube sampling described by mckay et al 1979 the user can specify the sample size and also the number of processes in the config file to run calibration in parallel a calibration configuration file is also specified in the config file and it stores settings for performing the calibration including calibration periods parameter ranges and observation file names observation data is obtained from the observations directory within the data directory fig 2 the swat aw finally creates maps for different variables extracted from the model results if the make figures option is set to true these maps are saved in figures directory within the default directory fig 4 4 application of the workflow 4 1 study area we tested the workflow by applying it to the blue nile catchment the blue nile river is one of two major tributaries of the nile river it begins from lake tana in ethiopia and joins the white nile at khartoum sudan fig 5 and covers a total area of 330 000 km2 ali et al 2014 elevation above sea level varies from about 3000 m in the ethiopian highlands to approximately 400 m at khartoum the annual rainfall ranges from 900 mm to 2200 mm in the upper part ali et al 2014 while the lower part receives about 135 mm on average mahmoud et al 2014 the catchment s large portions of natural forests have rapidly been transformed to farmland due to population increase ali et al 2014 agriculture heavily depends on irrigation utilizing water from shallow wells close to rivers or surface water owing to low rainfall especially on the sudanese part of the catchment groundwater recharge is limited in the catchment and most of the water in the catchment is lost through evapotranspiration which amounts to 955 mm on average annually according to wapor fao 2018 macalister et al 2013 reported annual groundwater recharge below 50 mm year in the arid plain of sudan and up to 400 mm year in the highland areas of ethiopia 4 2 available data the scripts used to process data used for the application of the workflow can be found at https github com vub hydr 2020 chawanda etal ems and the prepared data is available from https doi org 10 4211 hs 0890b3a954bf423db7d5b08f122b5436 digital elevation model a 300 300 m 2 resolution dem was obtained by re sampling downloaded dem from the shutter radar topography mission farr et al 2007 this data can be downloaded from http srtm csi cgiar org soil map a 300 300 m 2 resolution soil map of africa was prepared from the food and agriculture organization fao digital soil map of the world dsmw presented in fao geonetwork fao et al 2009 usersoil soil properties and soil lookup tables for the dsmw dataset were obtained from mapwindow swat database the dsmw dataset can be downloaded from http www fao org geonetwork srv en resources get id 14116 fname dsmw zip access private and mapwindow swat is freely available from the swat website https swat tamu edu software mwswat land use map the land use map was obtained from the european space agency esa climate change initiative land cover defourny et al 2017 for 2009 and had a resolution of 300 300 m 2 the land cover map can be downloaded from http maps elie ucl ac be cci viewer download php weather data the earth2observe wfdei and era interim data merged and bias corrected for isimip ewembi lange 2016 dataset was used in the study the original dataset includes records of precipitation kg m 2 s 1 minimum and maximum temperatures k solar radiation w m 2 wind speed and relative humidity at a daily time step and with a spatial resolution of 0 5 this data was prepared in the format for use with swat the units were converted from kg m 2 s 1 to mm day for precipitation k to o c for minimum and maximum temperatures and from w m 2 to mjm 2 d 1 for solar radiation units for windspeed ms 1 and relative humidity did not require conversion 4 3 methodology to test the program we first built the blue nile catchment model using the qswat and swat editor guis fig 6 the settings and options for the model which were picked just for testing purposes are shown in table 2 we built another model using swat aw fig 6 b with the same settings in table 2 we organised input data into the directory structure shown in fig 2 the settings for the model setup were entered into a config file and we ran swat aw to setup the swat model this model was compared with the one created using the guis both models are accessible through hydroshare chawanda 2020 we then analysed the mass balance in the catchment for each model setup we also compared flow results from two model setups against each other using nash sutcliffe efficiency nse and root mean square error rmse moriasi et al 2007 lastly we generated the config file from the model made using the guis and compared it to the config file used to set up the swat aw model fig 7 4 4 results both models had 209 lsus and 1329 hrus comparing flow time series from the two models yielded an nse value of 1 00 and an rmse of 0 00 these values indicate that there is a perfect fit between the hydrograph from the swat aw and the hydrograph from the gui we also compared the water balance components from both model setups the resulting water balance components were identical and either method in setting up the model yields exactly the same results the config file used for the swat aw setup appendix 8 2 had the same settings as the one derived from the gui model setup appendix 8 3 demonstrating that indeed swat users can derive config files for their model setups and share them to promote transparency and reproducibility of their work furthermore swat aw prepares and organises the input that was used to create the model into the folder structure shown in fig 2 so that the data can be used without further processing sharing the data makes sure that others can reproduce models without worrying about the preparation of swat input dataset it is also possible to open the project created by the workflow in the gui which allows visualisation and adaptation if necessary however it is easier to change settings in the workflow as the user then only needs to edit the config file to change the desired setting and run swatplus aw if the user changes the config file they can choose to run swat aw from a specific point without having to start from the beginning on the other hand using the gui requires the user to go through the delineate watershed and create hru windows afterwards swat editor would still have to be used again to input weather data and write the ascii files from which the swat executable reads 5 discussion in this study we present a new python based software to manage workflows for setting up swat models keeping all model configuration settings in one file the config file users can share the config file to allow others to run the workflow to recreate models we have shown that the results obtained through the workflow are identical to those obtained through the guis thus users are assured that if they use the workflow to create config files and share data their models will fully be reproducible swat aw allows the retrieval of a config file and data from a model created in the guis this provides beginners with an opportunity to set up their model in the guis and obtain a config file and prepared dataset that reproduces their model thus both beginners and expert users can ensure reproducible models using the workflow sharing the config file note that sharing the config file is not the same as sharing the qgis project file this is because in the swat aw software the qgis project file is a derivative of the config file and apart from the user unfriendly format for text in the xml file it does not have all configuration information contained in the config file such as routing methods infiltration method and et calculation method not only does swat aw promote reproducibility for swat models but also transparency the configuration of each swat model needs to be communicated clearly for people who need to build upon previous works however table 1 indicates that researchers cannot build on previous modelling studies in the area due to incomplete model configuration information while models may be configured based on the purpose of the study or the data that is available the number of models in table 1 built for the same area may also indicate lack of confidence in the existing models upon which to build new work with the emergence of model sharing platforms such as swatshare rajib et al 2016 and hydroshare horsburgh et al 2016 morsy et al 2017 config files and datasets can be published with an assigned unique persistent identifier such as doi the unique identifier can be used for reference in published papers which then provides an easy and transparent way of sharing modelling settings and options used in the publication we encourage the swat users to generate config files and publish to hydroshare to boost provenance and make it easy for others to audit and reproduce their work this will enhance progress in model studies as researchers gain trust in previous studies in the area one of the major advantages swat aw is that users will be able to script runs users can script model runs using different config files and create models with varying configurations for example using this approach users can vary parameters in a given range or distribution and generate stochastic results for quantification of hydrological model uncertainty at present model configurations for different hydrological models cannot be changed as easily as changing values in a config file since the user would have to build each model setup in the gui thus we need scripted workflows across different hydrological modelling software to save time and effort when testing different configurations of a model swat aw allows to reproduce simulations when the simple calibration mechanism that is incorporated in the workflow is used nevertheless swat aw can be useful even if another algorithm outside the software such as ipeat yen et al 2019 have been used for calibration in that case users must include the calibrated parameters in the workflow to reproduce the final calibrated model results scripted workflows also provide many opportunities in enhancing the modelling process if deployed on cloud computing cc systems and high performance computing hpc facilities these facilities overcome storage and computational power limitations that many users face during modelling especially users working on large scale hydrological modelling taking advantage of cc and hpc datasets can be kept on the facilities and users around the world would just provide a config file and data if not available online to create new or reproduce old models user friendly workflows such as the one presented in this paper enable both novice users and experts to take advantage of the cc and hpc facilities without losing compatibility with guis which may be used for visualising model structure and results there are features that can improve the workflow for instance better calibration mechanisms can be added to improve calibration results however being open source and written in python 3 7 users can easily adapt modules to include the features they need it is worth pointing out that while it may not be practical to adapt swat aw to other hydrological modelling software swat aw highlights the key elements that similar software should have interoperability with guis and a comprehensive config file and provides open source building blocks to set up similar environments for other models 6 conclusions lack of reproducibility of catchment models as reported in scientific research is an important issue which is largely due to the lack of information in reporting as demonstrated in table 1 this paper tackles this issue by providing a software to manage workflows that summarizes all user settings in a single config file attaching this file as supplementary information provides enough information to allow for reproducible model results hence the tool will support good modelling practices for model based research furthermore sharing data along with the config file makes the model accessible to other researchers what enables further research in areas where data is difficult to find in addition swat aw also allows reusing the same model with slightly different settings for instance when a user scripts runs using a range of parameters for obtaining stochastic model results the innovative element is that the workflow is fully interoperable with the gui a model produced by the workflow can be opened and adapted by the gui while a model built by a gui can be converted to a data set and config file that reproduces the model built in the gui our software can thus be used by swat users with different backgrounds and scripting skills declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement we thank the vlir uos belgium joint project for the financial support project code tz2019joi022a105 project title global open water academic network appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104812 
25947,a graphical user interface gui is regularly used to support model applications in catchment hydrological modelling software a gui is generally user friendly for novice users but opens sources of irreproducible research we illustrate that none of the 10 soil and water assessment tool swat models over the upper blue nile can easily be reproduced scripted workflows provide the ability to reproduce model set ups but they may be less user friendly especially to novice users we present a software swat aw that promotes reproducible swat model studies while remaining user friendly for both novice and expert users swat aw uses a configuration file to create models that are compatible with gui we applied the workflow to the blue nile catchment and show that it yields the same results the swat gui we conclude that such user friendly scripted workflows enhance reproducibility transparency and reusability of hydrological models the software is publicly available at https github com vub hydr swatplus aw keywords swat reproducibility hydrology modelling workflows 1 introduction the scientific method relies on the ability of scientists to reproduce each other s published results so they can build upon prior knowledge begley and ioannidis 2015 marcus 2015 recently the reproducibility of science has come under scrutiny marcus 2015 it has been discovered that a large proportion of scientific research is not reproducible vasilevsky et al 2013 mcnutt 2014 in their survey involving researchers from biology chemistry earth and environment medicine physics and engineering and other fields baker and penny 2016 reported that more than 70 of the researchers that tried to reproduce another scientist s experiment failed in the experiment research groups at amgen corporation were able to reproduce only 11 of the academic research on haematology and oncology begley and ellis 2012 vasilevsky et al 2013 in many other cases major conclusions have not been confirmed even when repeated by the same investigators begley and ioannidis 2015 a more troubling source of irreproducible research is scientific fraud and misconduct scientific fraud is where researchers tamper with the model to get the results that they are looking for just like other scientific fields the catchment modelling community suffers from reproducibility issues hutton et al 2016 in response crout et al 2008 have detailed good modelling practice which adds on ten iterative steps in development and evaluation of environmental models proposed by jakeman et al 2006 the guidelines presented in these papers help boost provenance and reproducibility in modelling studies as such current publication practices in catchment studies should enable reproducibility shu et al 2012 but there are a number of sources of irreproducibility in the model creation process this is mainly because there are many adjustments made during a catchment model setup to tailor the model to a specific context furthermore some catchment modelling exercises also use some bits of code during the model setup phase which in many cases are not made available hutton et al 2016 and are too specific for that exercise while some catchment modellers take time to report specific details of their model setup other technical information is still not included the above causes of irreproducible research point to lack of transparency in reporting as the overall cause of irreproducible research in catchment modelling crout et al 2008 also list the lack of transparency as one of the barriers to reproducible studies refsgaard and henriksen 2004 point out that without transparency modelling projects can be difficult to audit and without a considerable effort it is hardly possible to reconstruct repeat and reproduce the modelling process and its results the problem is illustrated when evaluating the reporting in peer reviewed journals of several studies using swat for catchment modelling of the upper blue nile catchment for each of the studies the availability of the information that is necessary to reproduce the study is shown in table 1 lacking any of this information makes it very difficult if not impossible to reproduce the swat models results leonard and duffy 2016 emphasise the value of workflows in capturing all steps for reproducibility and provenance furthermore crout et al 2008 encourage modellers to embrace the use of automated methodologies to support transparency and understanding of results automating the model creation workflow stores all settings and data which if made available solves the lack of transparency on model creation catchment modelling can thus benefit from using fully automated workflows for the entire model setup process however one needs at least basic programming skills to use automated workflows in addition introducing automated workflows to catchment modelling typically replaces a graphical user interface gui which often allows direct manipulation of the models and is also more intuitive for a novice user nielsen et al 2017 pointed out that guis assist in bridging the expertise gap experienced by potential new model users however when chen and zhang 2007 compared the advantages and disadvantages of both guis and text based user interfaces tuis which most workflows use they concluded that the tui offers more benefits to expert users than to novice users we argue that an ideal workflow for catchment model setup should care for both the novice and the expert this study aims at promoting reproducibility and transparency of swat for both novice and expert users by presenting a software swat automatic workflow swat aw for setting up the soil and water assessment tool swat the innovative element is that the software is interoperable with several guis used to setup swat models a user can start in swat guis which gives more support to the novice users and transfer the model to the swat aw we elaborate on how the software improves reproducibility of swat model by summarising model configuration into a single configuration file config py we show that the configuration file alone is sufficient to allow reproducible swat models as it transparently stores all model settings 2 present modelling procedure for swat the soil and water assessment tool swat arnold et al 2012 is one of the most widely used catchment model software it is a deterministic time continuous semi distributed hydrological model software developed for application at catchment scale swat has been applied to many case studies in different parts of the world e g ricci et al 2018 perra et al 2018 aouissi et al 2018 shen et al 2015 bieger et al 2013 swat is based on the concept of hydrologic response units hrus hrus are areas with a unique combination of soil land use slope and sub catchment at which calculations take place results are routed through a stream network that is often derived from the dem to the outlet swat arnold et al 2018 is a completely restructured version of swat swat uses the same equations as swat while offering more flexibility in model configuration to the user swat introduces land scape units lsus to discretise subbasins further and allow separation of upland processes from wetlands during model setup subbasins are delineated based on stream thresholds while lsus are delineated based on channel threshold as described in the user manual https swatplus gitbook io docs user qswat decision tables have also been introduced in swat to schedule activities that are only carried out when specified conditions are met decision tables in swat can be used to specify land use manage ment and reservoir management swat also introduces connection files which allow users to connect objects within the model easily currently the only interfaces for setting up a swat model are qswat quantum gis qgis based interface and swat editor apart from input data preparation the model application procedure can be described based on the steps presented in the gui fig 1 steps 1 through 3 are performed using the qswat software in qgis whereas steps 4 and 5 are performed using swat editor 3 new workflow for swat the swat automatic workflow swat aw we created a software where we automate the procedure to set up a swat model from a given dataset and settings selected by the user in a single file we refer to as config file we implemented the software using a python based scripting environment python is a simple programming language system with extensive library support for programming in general snyder 2007 being an interpreted and a high level programming language users can easily add functions that they need to the software a list of dependencies for the swat aw is specified in the user manual available from the swat aw repository https github com vub hydr swatplus aw swat aw takes the directory where it is executed as an argument and uses the config file available in the directory to setup the swat model which is saved in the same directory as the config file s the model can be opened in the guis that are available to set up swat model swat aw also can retrieve data from an already existing model and create a config file that reproduces the model from which the config file is created the software is described in detail below 3 1 preparing model setup environment 3 1 1 software requirements the workflow has been tested on windows 10 where it uses python 3 7 and on linux ubuntu 20 04 running where it uses python 3 8 users need to install the 64 bit version of qgis v3 10 and swat aw using the installer from the repository 3 1 2 input data the input data is prepared in the same way as input that is used in the gui however it is placed in a predefined directory structure within the directory named data within the directory where swat aw is run fig 2 the organization of the input data files is further described in the user manual available from the repository 3 1 3 the config file config py the workflow requires user options which are specified through the config file appendix 8 1 the config file is a python file where the user enters model configuration settings using text editing programs such as notepad it is placed in the same directory as the data directory the following information must be entered into the config file to set up a new model 1 project name 2 file names a raster maps dem land use soil b shapefiles outlet c lookup tables and usersoil land use soil the lookup tables are used to cross reference the raster map values to the values contained in the swat reference databases the usersoil is one of the files imported into reference databases into the file that contains soil properties and is used to derive soil parameters for the model being setup 3 project options a watershed delineation thresholds b output snap threshold c hru filter methods and thresholds d water routing methods e potential evapotranspiration calculation methods if there is information on reservoir management and land use management for the model being set up this information can be entered in the config file and swat aw will use this information during the model setup otherwise default management practices will be applied the workflow allows the user to retrieve input data and a config file from an existing model setup that was created in qswat and swat editor or using swat aw data and config file are retrieved if the model 2 config option is set to true in this case the model should already be present in the directory where the config file is located swat aw also has an option to keep a log for troubleshooting later or just for keeping a record during model setup 3 2 software code structure before starting the swat aw the user should populate the config file and the data directory the user can start the software by opening command prompt or powershell in the current directory typing swatplus aw and pressing enter running this command sets up the python environment for working with qgis application programming interface api pyqgis which is necessary to run the main steps 1 through 6 fig 3 it is also possible to run only a specific step without running all the steps the swatplus api command is used with a step option as an argument to run only one step e g swatplus api prepare project the available step options include prepare project delineate watershed create hrus setup editor project import weather configure model options setup management write files run swatplus make figures and calibrate details for each step are discussed below 3 2 1 prepare project the project preparation stage is performed depending on whether the model 2 config option in the config file is set to true or false if model 2 config is set to true project preparation is not carried out otherwise swat aw will prepare the qgis project structure for the swat model application this stage includes the following steps i creation of the default directory structure for a swat application the name of the parent directory bears the name of the project specified in the config file fig 4 ii set up of databases two databases are set up one is swatplus datasets sqlite which contains default parameters for the swat model swat aw also creates the sqlite project database bearing the project name the project database at a later stage stores hru data the scripted workflow also imports landuse lookup soil lookup and usersoil tables into the database the names of the tables are acquired from the config file iii transfer of gis input data swat aw integrates input raster and shapefiles from the data directory into the project directory structure under watershed fig 4 iv creation of a qgis project file the file bears the project name which is acquired from the config file swat aw also stores information on watershed delineation and hru creation into the qgis project file so that qswat can read it later when the user opens the project in the gui this file is saved in the project name directory fig 4 after the project preparation stage all files are in place but there is still the need to delineate the watershed and create hrus before swat editor functions can be performed on the project watershed delineation and hru creation are done in step 3 3 2 2 create config file this step is only performed if the model 2 config variable in the config file is set to true as seen in fig 3 if this step is performed it means step 1 was not performed swat aw will look for swat models in the directory where it is launched if any of the found models is listed in the config file it will extract a raster files and shapefiles from the project name watershed directory within the project directory structure fig 4 b lookup tables usersoil table and model options from the project database c weather data from the model in the case that the model listed in the config file was not found or that there was no config file in the directory the user is requested to select from the list of available models at the end of this stage a data directory is created and populated by the data retrieved from the model while model configuration information is saved in the config file 3 2 3 create hrus the aim of this stage is to generate unique combinations of four layers namely landscape units lsus sub divisions of sub basins soils land use and slope classes however by the time the swat aw reaches this stage the landscape units layer and the slope classes layer does not exist yet therefore the first step at this stage is watershed delineation in order to create sub basins and landscape units watershed delineation involves the use of the dem to calculate a flow direction and a flow accumulation map stream and channel thresholds are applied to the flow accumulation map to derive stream and channel networks respectively stream outlets are created in the stream network wherever two streams meet and additional outlets are acquired from the outlets shapefile listed in the config file the watershed is delineated by drawing a water divide around the pixels that contribute to the main outlet in the same way sub basins are delineated by drawing a water divide around pixels that contribute to each stream outlet while lsus are delineated using channel outlets it is important to note that the channel threshold must be equal to or smaller than the stream threshold in addition the complexity of the generated networks depends on the magnitudes of the stream and channels thresholds the smaller the thresholds the higher the complexity next the slope class map is created this map is derived from the dem using the slope classes specified in the config file upon creating the slope map all the four layers necessary for creating hrus become available the four layers that are required to define hru s are overlaid and unique combinations of the layers are identified and are referred to as potential hrus these potential hrus are filtered using methods and thresholds specified in the config file to form the final hrus the final hrus are finally saved in the project database 3 2 4 edit inputs and run at this stage swat aw creates and saves a swat editor project for compatibility with the swat editor gui weather information is then imported from the data directory and model options are configured in the project database the swat executable does not read directly from the databases ascii files containing all information about the model setup are written to the txtinout directory in the directory structure specified in fig 4 from where the executable runs depending on whether calibrated parameters are provided the swat aw will apply the parameters before attempting to run the model the workflow finally runs the model using the executable type specified in the config file 1 do not run if this option is used the model is not run 2 release the release executable runs faster but it does not provide information for troubleshooting errors 3 debug the debug version runs slow but it provides information for troubleshooting errors if they occur 3 2 5 run calibration and make figures calibration is performed only if the calibrate option in the config file is set to true calibration is simply based on the best performing parameter set from a sample generated using latin hypercube sampling described by mckay et al 1979 the user can specify the sample size and also the number of processes in the config file to run calibration in parallel a calibration configuration file is also specified in the config file and it stores settings for performing the calibration including calibration periods parameter ranges and observation file names observation data is obtained from the observations directory within the data directory fig 2 the swat aw finally creates maps for different variables extracted from the model results if the make figures option is set to true these maps are saved in figures directory within the default directory fig 4 4 application of the workflow 4 1 study area we tested the workflow by applying it to the blue nile catchment the blue nile river is one of two major tributaries of the nile river it begins from lake tana in ethiopia and joins the white nile at khartoum sudan fig 5 and covers a total area of 330 000 km2 ali et al 2014 elevation above sea level varies from about 3000 m in the ethiopian highlands to approximately 400 m at khartoum the annual rainfall ranges from 900 mm to 2200 mm in the upper part ali et al 2014 while the lower part receives about 135 mm on average mahmoud et al 2014 the catchment s large portions of natural forests have rapidly been transformed to farmland due to population increase ali et al 2014 agriculture heavily depends on irrigation utilizing water from shallow wells close to rivers or surface water owing to low rainfall especially on the sudanese part of the catchment groundwater recharge is limited in the catchment and most of the water in the catchment is lost through evapotranspiration which amounts to 955 mm on average annually according to wapor fao 2018 macalister et al 2013 reported annual groundwater recharge below 50 mm year in the arid plain of sudan and up to 400 mm year in the highland areas of ethiopia 4 2 available data the scripts used to process data used for the application of the workflow can be found at https github com vub hydr 2020 chawanda etal ems and the prepared data is available from https doi org 10 4211 hs 0890b3a954bf423db7d5b08f122b5436 digital elevation model a 300 300 m 2 resolution dem was obtained by re sampling downloaded dem from the shutter radar topography mission farr et al 2007 this data can be downloaded from http srtm csi cgiar org soil map a 300 300 m 2 resolution soil map of africa was prepared from the food and agriculture organization fao digital soil map of the world dsmw presented in fao geonetwork fao et al 2009 usersoil soil properties and soil lookup tables for the dsmw dataset were obtained from mapwindow swat database the dsmw dataset can be downloaded from http www fao org geonetwork srv en resources get id 14116 fname dsmw zip access private and mapwindow swat is freely available from the swat website https swat tamu edu software mwswat land use map the land use map was obtained from the european space agency esa climate change initiative land cover defourny et al 2017 for 2009 and had a resolution of 300 300 m 2 the land cover map can be downloaded from http maps elie ucl ac be cci viewer download php weather data the earth2observe wfdei and era interim data merged and bias corrected for isimip ewembi lange 2016 dataset was used in the study the original dataset includes records of precipitation kg m 2 s 1 minimum and maximum temperatures k solar radiation w m 2 wind speed and relative humidity at a daily time step and with a spatial resolution of 0 5 this data was prepared in the format for use with swat the units were converted from kg m 2 s 1 to mm day for precipitation k to o c for minimum and maximum temperatures and from w m 2 to mjm 2 d 1 for solar radiation units for windspeed ms 1 and relative humidity did not require conversion 4 3 methodology to test the program we first built the blue nile catchment model using the qswat and swat editor guis fig 6 the settings and options for the model which were picked just for testing purposes are shown in table 2 we built another model using swat aw fig 6 b with the same settings in table 2 we organised input data into the directory structure shown in fig 2 the settings for the model setup were entered into a config file and we ran swat aw to setup the swat model this model was compared with the one created using the guis both models are accessible through hydroshare chawanda 2020 we then analysed the mass balance in the catchment for each model setup we also compared flow results from two model setups against each other using nash sutcliffe efficiency nse and root mean square error rmse moriasi et al 2007 lastly we generated the config file from the model made using the guis and compared it to the config file used to set up the swat aw model fig 7 4 4 results both models had 209 lsus and 1329 hrus comparing flow time series from the two models yielded an nse value of 1 00 and an rmse of 0 00 these values indicate that there is a perfect fit between the hydrograph from the swat aw and the hydrograph from the gui we also compared the water balance components from both model setups the resulting water balance components were identical and either method in setting up the model yields exactly the same results the config file used for the swat aw setup appendix 8 2 had the same settings as the one derived from the gui model setup appendix 8 3 demonstrating that indeed swat users can derive config files for their model setups and share them to promote transparency and reproducibility of their work furthermore swat aw prepares and organises the input that was used to create the model into the folder structure shown in fig 2 so that the data can be used without further processing sharing the data makes sure that others can reproduce models without worrying about the preparation of swat input dataset it is also possible to open the project created by the workflow in the gui which allows visualisation and adaptation if necessary however it is easier to change settings in the workflow as the user then only needs to edit the config file to change the desired setting and run swatplus aw if the user changes the config file they can choose to run swat aw from a specific point without having to start from the beginning on the other hand using the gui requires the user to go through the delineate watershed and create hru windows afterwards swat editor would still have to be used again to input weather data and write the ascii files from which the swat executable reads 5 discussion in this study we present a new python based software to manage workflows for setting up swat models keeping all model configuration settings in one file the config file users can share the config file to allow others to run the workflow to recreate models we have shown that the results obtained through the workflow are identical to those obtained through the guis thus users are assured that if they use the workflow to create config files and share data their models will fully be reproducible swat aw allows the retrieval of a config file and data from a model created in the guis this provides beginners with an opportunity to set up their model in the guis and obtain a config file and prepared dataset that reproduces their model thus both beginners and expert users can ensure reproducible models using the workflow sharing the config file note that sharing the config file is not the same as sharing the qgis project file this is because in the swat aw software the qgis project file is a derivative of the config file and apart from the user unfriendly format for text in the xml file it does not have all configuration information contained in the config file such as routing methods infiltration method and et calculation method not only does swat aw promote reproducibility for swat models but also transparency the configuration of each swat model needs to be communicated clearly for people who need to build upon previous works however table 1 indicates that researchers cannot build on previous modelling studies in the area due to incomplete model configuration information while models may be configured based on the purpose of the study or the data that is available the number of models in table 1 built for the same area may also indicate lack of confidence in the existing models upon which to build new work with the emergence of model sharing platforms such as swatshare rajib et al 2016 and hydroshare horsburgh et al 2016 morsy et al 2017 config files and datasets can be published with an assigned unique persistent identifier such as doi the unique identifier can be used for reference in published papers which then provides an easy and transparent way of sharing modelling settings and options used in the publication we encourage the swat users to generate config files and publish to hydroshare to boost provenance and make it easy for others to audit and reproduce their work this will enhance progress in model studies as researchers gain trust in previous studies in the area one of the major advantages swat aw is that users will be able to script runs users can script model runs using different config files and create models with varying configurations for example using this approach users can vary parameters in a given range or distribution and generate stochastic results for quantification of hydrological model uncertainty at present model configurations for different hydrological models cannot be changed as easily as changing values in a config file since the user would have to build each model setup in the gui thus we need scripted workflows across different hydrological modelling software to save time and effort when testing different configurations of a model swat aw allows to reproduce simulations when the simple calibration mechanism that is incorporated in the workflow is used nevertheless swat aw can be useful even if another algorithm outside the software such as ipeat yen et al 2019 have been used for calibration in that case users must include the calibrated parameters in the workflow to reproduce the final calibrated model results scripted workflows also provide many opportunities in enhancing the modelling process if deployed on cloud computing cc systems and high performance computing hpc facilities these facilities overcome storage and computational power limitations that many users face during modelling especially users working on large scale hydrological modelling taking advantage of cc and hpc datasets can be kept on the facilities and users around the world would just provide a config file and data if not available online to create new or reproduce old models user friendly workflows such as the one presented in this paper enable both novice users and experts to take advantage of the cc and hpc facilities without losing compatibility with guis which may be used for visualising model structure and results there are features that can improve the workflow for instance better calibration mechanisms can be added to improve calibration results however being open source and written in python 3 7 users can easily adapt modules to include the features they need it is worth pointing out that while it may not be practical to adapt swat aw to other hydrological modelling software swat aw highlights the key elements that similar software should have interoperability with guis and a comprehensive config file and provides open source building blocks to set up similar environments for other models 6 conclusions lack of reproducibility of catchment models as reported in scientific research is an important issue which is largely due to the lack of information in reporting as demonstrated in table 1 this paper tackles this issue by providing a software to manage workflows that summarizes all user settings in a single config file attaching this file as supplementary information provides enough information to allow for reproducible model results hence the tool will support good modelling practices for model based research furthermore sharing data along with the config file makes the model accessible to other researchers what enables further research in areas where data is difficult to find in addition swat aw also allows reusing the same model with slightly different settings for instance when a user scripts runs using a range of parameters for obtaining stochastic model results the innovative element is that the workflow is fully interoperable with the gui a model produced by the workflow can be opened and adapted by the gui while a model built by a gui can be converted to a data set and config file that reproduces the model built in the gui our software can thus be used by swat users with different backgrounds and scripting skills declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement we thank the vlir uos belgium joint project for the financial support project code tz2019joi022a105 project title global open water academic network appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104812 
25948,being able to replicate research results is the hallmark of science replication of research findings using computational models should in principle be possible in this manuscript we assess code sharing and model documentation practices of 7500 publications about individual based and agent based models the code availability increased over the years up to 18 in 2018 model documentation does not include all the elements that could improve the transparency of the models such as mathematical equations flow charts and pseudocode we find that articles with equations and flow charts being cited more among other model papers probably because the model documentation is more transparent the practices of code sharing improve slowly over time partly due to the emergence of more public repositories and archives and code availability requirements by journals and sponsors however a significant change in norms and habits need to happen before computational modeling becomes a reproducible science keywords reuse open science replicability agent based modeling individual based modeling 1 introduction isaac newton famously wrote if i have seen further it is by standing on the shoulders of giants which emphasized an essential component of science namely the accumulation of knowledge by reusing and improving knowledge built up by others ideally scholars will document and share the methods used to come to the insights they report in academic publications although sharing of methodological details can be now done at a much lower effort than in newton s era due to widely available digital technologies there remains a significant lack of sharing of computational models there have also been broader concerns raised about the reproducibility of computational sciences barnes 2010 peng 2011 hutton et al 2016 for starters authors do not share their source code in the majority of publications collberg and proebsting 2016 janssen 2017 even if source code is provided it is not always a given that it can be compiled and executed due to changing dependencies or that the published results can be exactly reproduced a computational model s dependencies are the system packages and libraries that a researcher s code rely on which often continue to evolve in ways such that future versions are backwards incompatible causing errors in compilation or execution or worse affecting the outputs of a model bogart et al 2015 in this article we analyze a dataset of 7500 articles on individual and agent based models an earlier version of this catalog examined 2300 publications and found that just 10 of these publications on agent based models provided information about the source code used to generate the results janssen 2017 we have now extended this database to agent based and individual based models covering 7500 publications among more than 1500 academic journals the new version goes beyond the documentation of code sharing practices in publications as we now contact authors to request that they share their code the database includes metadata on where code is being made available and how the model was documented authors are sent an email and can provide feedback and update the database with metadata about where the model code can be currently found whether it is the original implementation or a replication even if the model code was not available in the original publication in the rest of the paper we describe the database and the methodology to add select relevant articles and add metadata we also present findings of an analysis of this dataset subsequently we discuss the next steps of the development and use of the database 2 methodology for more than a decade we have been involved in creating an archive where scholars can easily deposit computational model code and documentation and make them accessible to others rollins et al 2014 the comses model library has more than 780 publicly available models with over 40 000 downloads a year but we are cognizant that building a tool does not mean that people will use it with that in mind we began to investigate the practice of model code sharing in academic publications we focus on agent based and individual based models a subset of computational models because of our expertise in this domain the goal was to map the code sharing practices and contact authors to increase the availability of code of published models another primary goal of this database is to develop an ecosystem of references to publications and model code that enable scholars to easily find relevant models and model code and build on existing work instead of reinventing the wheel we have designed it to be open access so that anyone interested can easily find information about previously published models and we also allow users to provide feedback and improve the content we have bootstrapped the contents of this database by manually inspecting the publications on agent based and individual based models and entering categorical metadata on model code availability and documentation for these publications there are many places and formats in which model code can be shared an appendix of a journal article an author s personal or institutional webpage a github repository or a digital repository like the comses net model library publications often mention that code is available upon request which we do not include in our analysis since the code is not being made publicly available other researchers have also found that such requests are typically not honored stodden et al 2018 sharing code on a personal or institutional website or as an appendix of a journal is a good start but it is not a good long term solution we believe that the only acceptable long term solution is for model code to be documented and archived in a citable trusted digital repository that adheres to the force11 software citation principles smith et al 2016 deposited model code should receive a permanent identifier e g a digital object identifier doi that should be used as a software citation in publications that reference the given model this permanent identifier should resolve to a durable web landing page with descriptive metadata and links to files corresponding to the exact version of the computational model that produced the results claimed in the publication publishing code in a github repository and referencing the github repository as a citation is not an acceptable solution as it does not make clear which version of the code in the repository was actually used for the publication and github repositories do not provide any guarantees of permanence and can be deleted by their owner at will that said github repositories can be integrated with a trusted digital repository like zenodo 2020 to create a citable software archive trusted digital repositories provide guarantees for digital permanence and have backup and contingency plans for migrating content should the repository cease operations lin et al 2020 after creating a database of model publications and links to model code we contacted authors to inform them about best practices on archival of model code fig 1 we also asked them to check the metadata of their publication s in our database and requested that they provide us with information on the availability of their model code if it was one of the about 85 of publications that were tagged as having not made their code available i e links to the model code were not explicitly referenced within the publication or the links were dead this database is currently live and new publications continue to be added by using keyword searches and user recommendations https catalog comses net our team verifies user submissions for relevance to ensure that user submitted publications are appropriate and adds their metadata to this living dataset users can also explore the searchable database and visualize basic trends 3 creating the database to seed the initial version of this database with relevant publications and high quality metadata including citation references to other publications we made use of the isi web of science we used the search term agent based model and individual based model several times to build our database with the last update on august 31 2019 the terms agent based model and individual based models could be used in the title abstract or keywords all publications were evaluated to verify that it was about an agent based or individual based model reviews conference abstracts analytical models or presented conceptual models were discarded this resulted in 7500 publications that report on a model and results of model simulations for each publication we checked whether the model code was made available if so we tested whether the url was still available classified the kind of model code sharing used and stored the url types of model sharing we distinguish include archives e g the comses model library zenodo open science framework web based version control repositories e g github bitbucket sourceforge journal personal or organizational e g dropbox google drive a personal or institutional webpage and framework websites e g the netlogo modeling commons cormas we rely on the information we found in the publication and we recognize that the model code may have been published online but not mentioned in the article or can be provided by authors upon request this is one of the reasons we contact the authors in the latter steps of our workflow after we determined whether the model publication provided access to the model code we recorded which programming platform or language was used and which external sponsors funded the research finally we used the classification from müller et al 2014 to record how the model was described in the main article and appendixes narrative how was the model description organized did it use a standard protocol called overview design details odd grimm et al 2006 2020 or did it use a non prescriptive narrative visualized relationships how were the relationships visualized did it include flow charts a unified modeling language uml diagram or provide an explicit depiction of an ontology that describes entities and their structural interrelationships code and formal description how were the algorithmic procedures documented did the authors provide the source code did they describe the model in pseudocode or use mathematical equations to describe parts of the model one benefit of using the isi web of science is the inclusion of references for each article this information was included in our database and as such we will be able to perform citation and network analysis of the database 4 results we present the basic statistics of the current version of the database containing 7500 publications on individual and agent based models those articles were published in more than 1500 journals which demonstrate the breadth of the application of this type of modeling but also the fragmentation of the field fig 2 shows the number of publications in our database for the date of publication in fig 2 we also show the fraction of publications of which code is available from the whole database we have 840 publications for which code is available 11 2 of all articles the increasing fraction of papers where code is available and the rapid increase of the absolute number of publications a year demonstrate the exponential growth of the number of models for which code is available table 1 lists the most popular journals in the database see also appendix 1 for additional descriptive statistics those include a substantial number of ecology journals that report on findings from individual based models and complexity related journals where the use of individual based and agent based modeling is a standard method there is a substantial variation in the percentage of papers that share their model code the journal of artificial societies and social simulation an open access journal that recommends sharing model code has the highest level with 45 meanwhile physica a does not provide any details on model code and relies on mathematical descriptions of their models being sufficient for replication all publications describe in one way or another the model for which they report computational results using the classification from müller et al 2014 we try to get an overview of how models are described in the publications note that we did not evaluate how well the model was described as such an exercise would be beyond the scope of our efforts table 2 shows that mathematical descriptions and flow charts are popular ways to describe a model since we distinguish 9 5 of all publications which use the odd protocol of grimm et al 2006 and additional odd variations and those who do not use the odd protocol we provided in table 2 information on potential differences if scholars use the odd protocol they are more likely to use flow charts and pseudocode and more likely to share the code those correlations do not imply causation of using more ways to describe models and to share model code as they may relate to the attributes of scholars adopting the odd protocol moreover we found that many publications which use the odd protocol in name did not provide a detailed description of the model which is acknowledged by grimm et al 2020 as one of the challenges of the adoption for the odd protocol although all publications report simulation results the majority of the publications do not mention which modeling platform or programming language was used for their study from 42 9 of the articles which provided information table 3 lists the most popular modeling languages it is no surprise that netlogo and repast are popular platforms since they are specifically targeted for individual based and agent based modeling general modeling languages such as r and matlab are also used frequently due to the wide application in modeling communities basic programming languages like c and java are frequently mentioned but this is an underrepresentation for example a java model using repast libraries might be listed as a repast model based on the references in the article what might be interesting from table 3 is the prominence of python which is not used in a prominent abm modeling platform yet and it s a high percentage of code sharing perhaps this reflects the new generation of modelers who adopt new languages and different practices of code sharing furthermore it is notable that there are a substantial number of individual based and agent based models implemented in fortran whether an article mentions which platform or language is used for the implementation of the simulation model is a predictor of the kind of model description that is given table 4 those who do not mention what software is used to implement the model rely on mathematical descriptions in contrast more diverse ways of describing the model are used when the implementation software is mentioned a possible explanation in differences in model descriptions are differences in awareness of the importance of sharing details of the model implementation leading to the published results better journal policies could improve the quality of model documentation and code sharing stodden et al 2018 58 9 of the publications mention one or more external sponsors that provided financial support for the research leading to the publication increasingly funding agencies require data from the research being made available publicly after the research findings are published there might be differences in enforcement of compliance but in general the level of code availability is very low table 5 code is not always seen as research data and might be overlooked in data availability guidelines where do authors deposit their code as reported in their article table 6 demonstrates that there is a wide variety of where the model code is archived using public archives is the golden standard and 236 articles 3 1 of the database archives their code in permanent archives comses is the most commonly used archived which is not surprising as this archive has targeted this user group 172 articles have been archived in repositories especially github which provides public access but might not be permanent and it might not be obvious which version is used for the publication 261 articles have model code included as an appendix whether it is a code file or a print of the model code frequently those appendixes are publicly available but not always 142 articles have their code being stored on their personal websites or even dropbox links those model code depositions are in danger to become missing in the coming years since they are not sustainable solutions finally 30 articles have their model code is available in a library maintained by one of the platforms fig 3 shows the fraction of the publications storing the code in different locations we see a rapid increase in archives and repositories in recent years these are much preferred to the alternatives but we still see a stable share of publications storing their code as appendices of journals and personal websites we now look at the 7500 articles from a network perspective the links refer to references of one publication to another publication using the forceatlas2 algorithm in the gephi software we visualized the network of publications jacomy et al 2014 this visualization of the network is to uses a modularity algorithm to find groups of nodes that are more connected with each other than others blondel et al 2008 fig 4 shows the nodes of the 10 biggest clusters looking at the topics of the publications in the clusters that are cited most we identify a topic for each of the clusters we see that the top of the network is dominated by ecology oriented models and economics at the bottom of the network there is also a large medicine application cluster at the left of the network as a final step in the analysis we ask whether the way scholars document their models and share their code affects whether their model is used a common question we get on our efforts to document code sharing is whether model papers who share their code get cited more there are many reasons papers get cited so it would be remarkable if code sharing will have a significant impact with our current database we have we cannot test whether there is an increase of general citations due to code sharing however we can evaluate whether there are characteristics for publications in the database which explain why they have more citations by other model papers we are aware that a citation does not mean a reuse of the model or an endorsement of the quality of the model in the cited publication in order to evaluate whether there is any effect of citation by other model papers within the database we performed a linear regression to explain the number of citations as a function of various factors and we find that it is the way the model is described not the code availability that impacts the number of citations table 7 this is in line with the milkowski et al 2018 since the rapid increase in the number of papers in recent years as well as the fraction of publication for which model code is available we have to be careful with this analysis it takes some time for publications to gain citations due to the slow nature of publications hence the year of publication is the best predictor for the number of citations beyond that better documentation is a good predictor in a few years this analysis should be repeated if a larger number of model publications are available with years of model code availability doing such an analysis might focus on a specific field such as ecological modeling since there are different citation cultures among different fields of study in such a future analysis in a specific field an a control variable might be included for the reputation or impact factor of the journal where the article is published 5 discussion results published from computational science should in principle be reproducible and the code should be available to be reused and built on unfortunately this is not what is happening we looked at the practice of documenting agent based and individual based models and how code is made available we see an increase in the fraction of publications for which code is available about 18 in 2018 this is a promising trend but since in many cases those models are available on a personal website or as an appendix to the journal article only available for subscribers current availability does not mean availability in the long run only about 3 of the model publications in recent years archive their model in public archives where the focus is on the preservation of the code in the longer term the importance of proper documentation and code availability is illustrated during the covid 19 pandemic squazzoni et al 2020 barton et al 2020 a large number of several projections of the covid 19 crisis are difficult to put into context since there is no transparency about the underlying assumptions since policymakers are primarily guided in their decision making in the covid 19 crisis by model results the lack of practicing model transparency is disappointing some scholars may argue that this extra level of archiving and documenting is too much of extra work and if models would be useful their code will become available somehow many articles indeed mention that code is available upon request to the authors since the fall of 2019 we started sending out emails to corresponding authors to request code used in their publications and all corresponding authors in our database an email has been send to in this email we provide information on our project best practices on model archiving and list which publications are in our database and whether we have been able to locate the model code or not appendix 2 for less than 1 of the emails we received a response some responses included urls where code is currently available and other responses indicated that the author no longer had access to the code increasing use of empirical data of human subjects to make empirical grounded agent based models could be a concern for sharing model code on models of human social dynamics however sharing processed data about human subjects is a common practice in the social science yoon and kim 2017 there are ethical and moral objections raised to share data in the social sciences and alternative policies for data sharing are part of the debate mauthner and parry 2013 tenopir et al 2015 there is not one policy that may work for all types of data or code what can we to do to improve to model documentation and code availability so we can build on the work of others there is no lack of technical solutions such as public archives journals and sponsors also start to improve their requirements but those requirements could be more precise about code availability at comses net we have created an open code badge that various journals have begun to adopt to signal best practices and provide durable links to model code https www comses net resources open code badge although we see some positive trends in the fraction of code availability in publications the transition towards a desirable level of practice will be a long term process it requires a change in norms and habits in fact research on adoption of data sharing in the social sciences suggest that personal motivations and perceived normative pressure are more critical in the data sharing behavior than availability of repositories or pressures from funding agencies and journals kim and adler 2015 the new generation of scholars using computational models must be trained in the tools available to derive best practices besides code sharing and documentation this should include containerization e g docker which can preserve software dependencies to be able to reproduce computational results in the longer term this could be integrated with education by letting students work in groups and build on existing model code available in sum there is a slow process of improvement in code availability in the field of agent based and individual based models still more concerted action is needed to improve the adoption of best practices this could be done by enforcement of best practices by journals and sponsors and by making this topic a common topic in modeling graduate courses and beyond data availability the data from the 7500 articles explored in this article are available at https osf io y2vs3 view only c0ec40bd9de54e1b88e1438656fb84f0 declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to thank rachael gokool yee yang hsieh juan rodriguez and christy contreras for entering metadata for christine nguyen and dhuvil patel for software development and cindy huang for contacting corresponding authors we acknowledge financial support for this work from the national science foundation grant numbers 0909394 and 1210856 appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104873 
25948,being able to replicate research results is the hallmark of science replication of research findings using computational models should in principle be possible in this manuscript we assess code sharing and model documentation practices of 7500 publications about individual based and agent based models the code availability increased over the years up to 18 in 2018 model documentation does not include all the elements that could improve the transparency of the models such as mathematical equations flow charts and pseudocode we find that articles with equations and flow charts being cited more among other model papers probably because the model documentation is more transparent the practices of code sharing improve slowly over time partly due to the emergence of more public repositories and archives and code availability requirements by journals and sponsors however a significant change in norms and habits need to happen before computational modeling becomes a reproducible science keywords reuse open science replicability agent based modeling individual based modeling 1 introduction isaac newton famously wrote if i have seen further it is by standing on the shoulders of giants which emphasized an essential component of science namely the accumulation of knowledge by reusing and improving knowledge built up by others ideally scholars will document and share the methods used to come to the insights they report in academic publications although sharing of methodological details can be now done at a much lower effort than in newton s era due to widely available digital technologies there remains a significant lack of sharing of computational models there have also been broader concerns raised about the reproducibility of computational sciences barnes 2010 peng 2011 hutton et al 2016 for starters authors do not share their source code in the majority of publications collberg and proebsting 2016 janssen 2017 even if source code is provided it is not always a given that it can be compiled and executed due to changing dependencies or that the published results can be exactly reproduced a computational model s dependencies are the system packages and libraries that a researcher s code rely on which often continue to evolve in ways such that future versions are backwards incompatible causing errors in compilation or execution or worse affecting the outputs of a model bogart et al 2015 in this article we analyze a dataset of 7500 articles on individual and agent based models an earlier version of this catalog examined 2300 publications and found that just 10 of these publications on agent based models provided information about the source code used to generate the results janssen 2017 we have now extended this database to agent based and individual based models covering 7500 publications among more than 1500 academic journals the new version goes beyond the documentation of code sharing practices in publications as we now contact authors to request that they share their code the database includes metadata on where code is being made available and how the model was documented authors are sent an email and can provide feedback and update the database with metadata about where the model code can be currently found whether it is the original implementation or a replication even if the model code was not available in the original publication in the rest of the paper we describe the database and the methodology to add select relevant articles and add metadata we also present findings of an analysis of this dataset subsequently we discuss the next steps of the development and use of the database 2 methodology for more than a decade we have been involved in creating an archive where scholars can easily deposit computational model code and documentation and make them accessible to others rollins et al 2014 the comses model library has more than 780 publicly available models with over 40 000 downloads a year but we are cognizant that building a tool does not mean that people will use it with that in mind we began to investigate the practice of model code sharing in academic publications we focus on agent based and individual based models a subset of computational models because of our expertise in this domain the goal was to map the code sharing practices and contact authors to increase the availability of code of published models another primary goal of this database is to develop an ecosystem of references to publications and model code that enable scholars to easily find relevant models and model code and build on existing work instead of reinventing the wheel we have designed it to be open access so that anyone interested can easily find information about previously published models and we also allow users to provide feedback and improve the content we have bootstrapped the contents of this database by manually inspecting the publications on agent based and individual based models and entering categorical metadata on model code availability and documentation for these publications there are many places and formats in which model code can be shared an appendix of a journal article an author s personal or institutional webpage a github repository or a digital repository like the comses net model library publications often mention that code is available upon request which we do not include in our analysis since the code is not being made publicly available other researchers have also found that such requests are typically not honored stodden et al 2018 sharing code on a personal or institutional website or as an appendix of a journal is a good start but it is not a good long term solution we believe that the only acceptable long term solution is for model code to be documented and archived in a citable trusted digital repository that adheres to the force11 software citation principles smith et al 2016 deposited model code should receive a permanent identifier e g a digital object identifier doi that should be used as a software citation in publications that reference the given model this permanent identifier should resolve to a durable web landing page with descriptive metadata and links to files corresponding to the exact version of the computational model that produced the results claimed in the publication publishing code in a github repository and referencing the github repository as a citation is not an acceptable solution as it does not make clear which version of the code in the repository was actually used for the publication and github repositories do not provide any guarantees of permanence and can be deleted by their owner at will that said github repositories can be integrated with a trusted digital repository like zenodo 2020 to create a citable software archive trusted digital repositories provide guarantees for digital permanence and have backup and contingency plans for migrating content should the repository cease operations lin et al 2020 after creating a database of model publications and links to model code we contacted authors to inform them about best practices on archival of model code fig 1 we also asked them to check the metadata of their publication s in our database and requested that they provide us with information on the availability of their model code if it was one of the about 85 of publications that were tagged as having not made their code available i e links to the model code were not explicitly referenced within the publication or the links were dead this database is currently live and new publications continue to be added by using keyword searches and user recommendations https catalog comses net our team verifies user submissions for relevance to ensure that user submitted publications are appropriate and adds their metadata to this living dataset users can also explore the searchable database and visualize basic trends 3 creating the database to seed the initial version of this database with relevant publications and high quality metadata including citation references to other publications we made use of the isi web of science we used the search term agent based model and individual based model several times to build our database with the last update on august 31 2019 the terms agent based model and individual based models could be used in the title abstract or keywords all publications were evaluated to verify that it was about an agent based or individual based model reviews conference abstracts analytical models or presented conceptual models were discarded this resulted in 7500 publications that report on a model and results of model simulations for each publication we checked whether the model code was made available if so we tested whether the url was still available classified the kind of model code sharing used and stored the url types of model sharing we distinguish include archives e g the comses model library zenodo open science framework web based version control repositories e g github bitbucket sourceforge journal personal or organizational e g dropbox google drive a personal or institutional webpage and framework websites e g the netlogo modeling commons cormas we rely on the information we found in the publication and we recognize that the model code may have been published online but not mentioned in the article or can be provided by authors upon request this is one of the reasons we contact the authors in the latter steps of our workflow after we determined whether the model publication provided access to the model code we recorded which programming platform or language was used and which external sponsors funded the research finally we used the classification from müller et al 2014 to record how the model was described in the main article and appendixes narrative how was the model description organized did it use a standard protocol called overview design details odd grimm et al 2006 2020 or did it use a non prescriptive narrative visualized relationships how were the relationships visualized did it include flow charts a unified modeling language uml diagram or provide an explicit depiction of an ontology that describes entities and their structural interrelationships code and formal description how were the algorithmic procedures documented did the authors provide the source code did they describe the model in pseudocode or use mathematical equations to describe parts of the model one benefit of using the isi web of science is the inclusion of references for each article this information was included in our database and as such we will be able to perform citation and network analysis of the database 4 results we present the basic statistics of the current version of the database containing 7500 publications on individual and agent based models those articles were published in more than 1500 journals which demonstrate the breadth of the application of this type of modeling but also the fragmentation of the field fig 2 shows the number of publications in our database for the date of publication in fig 2 we also show the fraction of publications of which code is available from the whole database we have 840 publications for which code is available 11 2 of all articles the increasing fraction of papers where code is available and the rapid increase of the absolute number of publications a year demonstrate the exponential growth of the number of models for which code is available table 1 lists the most popular journals in the database see also appendix 1 for additional descriptive statistics those include a substantial number of ecology journals that report on findings from individual based models and complexity related journals where the use of individual based and agent based modeling is a standard method there is a substantial variation in the percentage of papers that share their model code the journal of artificial societies and social simulation an open access journal that recommends sharing model code has the highest level with 45 meanwhile physica a does not provide any details on model code and relies on mathematical descriptions of their models being sufficient for replication all publications describe in one way or another the model for which they report computational results using the classification from müller et al 2014 we try to get an overview of how models are described in the publications note that we did not evaluate how well the model was described as such an exercise would be beyond the scope of our efforts table 2 shows that mathematical descriptions and flow charts are popular ways to describe a model since we distinguish 9 5 of all publications which use the odd protocol of grimm et al 2006 and additional odd variations and those who do not use the odd protocol we provided in table 2 information on potential differences if scholars use the odd protocol they are more likely to use flow charts and pseudocode and more likely to share the code those correlations do not imply causation of using more ways to describe models and to share model code as they may relate to the attributes of scholars adopting the odd protocol moreover we found that many publications which use the odd protocol in name did not provide a detailed description of the model which is acknowledged by grimm et al 2020 as one of the challenges of the adoption for the odd protocol although all publications report simulation results the majority of the publications do not mention which modeling platform or programming language was used for their study from 42 9 of the articles which provided information table 3 lists the most popular modeling languages it is no surprise that netlogo and repast are popular platforms since they are specifically targeted for individual based and agent based modeling general modeling languages such as r and matlab are also used frequently due to the wide application in modeling communities basic programming languages like c and java are frequently mentioned but this is an underrepresentation for example a java model using repast libraries might be listed as a repast model based on the references in the article what might be interesting from table 3 is the prominence of python which is not used in a prominent abm modeling platform yet and it s a high percentage of code sharing perhaps this reflects the new generation of modelers who adopt new languages and different practices of code sharing furthermore it is notable that there are a substantial number of individual based and agent based models implemented in fortran whether an article mentions which platform or language is used for the implementation of the simulation model is a predictor of the kind of model description that is given table 4 those who do not mention what software is used to implement the model rely on mathematical descriptions in contrast more diverse ways of describing the model are used when the implementation software is mentioned a possible explanation in differences in model descriptions are differences in awareness of the importance of sharing details of the model implementation leading to the published results better journal policies could improve the quality of model documentation and code sharing stodden et al 2018 58 9 of the publications mention one or more external sponsors that provided financial support for the research leading to the publication increasingly funding agencies require data from the research being made available publicly after the research findings are published there might be differences in enforcement of compliance but in general the level of code availability is very low table 5 code is not always seen as research data and might be overlooked in data availability guidelines where do authors deposit their code as reported in their article table 6 demonstrates that there is a wide variety of where the model code is archived using public archives is the golden standard and 236 articles 3 1 of the database archives their code in permanent archives comses is the most commonly used archived which is not surprising as this archive has targeted this user group 172 articles have been archived in repositories especially github which provides public access but might not be permanent and it might not be obvious which version is used for the publication 261 articles have model code included as an appendix whether it is a code file or a print of the model code frequently those appendixes are publicly available but not always 142 articles have their code being stored on their personal websites or even dropbox links those model code depositions are in danger to become missing in the coming years since they are not sustainable solutions finally 30 articles have their model code is available in a library maintained by one of the platforms fig 3 shows the fraction of the publications storing the code in different locations we see a rapid increase in archives and repositories in recent years these are much preferred to the alternatives but we still see a stable share of publications storing their code as appendices of journals and personal websites we now look at the 7500 articles from a network perspective the links refer to references of one publication to another publication using the forceatlas2 algorithm in the gephi software we visualized the network of publications jacomy et al 2014 this visualization of the network is to uses a modularity algorithm to find groups of nodes that are more connected with each other than others blondel et al 2008 fig 4 shows the nodes of the 10 biggest clusters looking at the topics of the publications in the clusters that are cited most we identify a topic for each of the clusters we see that the top of the network is dominated by ecology oriented models and economics at the bottom of the network there is also a large medicine application cluster at the left of the network as a final step in the analysis we ask whether the way scholars document their models and share their code affects whether their model is used a common question we get on our efforts to document code sharing is whether model papers who share their code get cited more there are many reasons papers get cited so it would be remarkable if code sharing will have a significant impact with our current database we have we cannot test whether there is an increase of general citations due to code sharing however we can evaluate whether there are characteristics for publications in the database which explain why they have more citations by other model papers we are aware that a citation does not mean a reuse of the model or an endorsement of the quality of the model in the cited publication in order to evaluate whether there is any effect of citation by other model papers within the database we performed a linear regression to explain the number of citations as a function of various factors and we find that it is the way the model is described not the code availability that impacts the number of citations table 7 this is in line with the milkowski et al 2018 since the rapid increase in the number of papers in recent years as well as the fraction of publication for which model code is available we have to be careful with this analysis it takes some time for publications to gain citations due to the slow nature of publications hence the year of publication is the best predictor for the number of citations beyond that better documentation is a good predictor in a few years this analysis should be repeated if a larger number of model publications are available with years of model code availability doing such an analysis might focus on a specific field such as ecological modeling since there are different citation cultures among different fields of study in such a future analysis in a specific field an a control variable might be included for the reputation or impact factor of the journal where the article is published 5 discussion results published from computational science should in principle be reproducible and the code should be available to be reused and built on unfortunately this is not what is happening we looked at the practice of documenting agent based and individual based models and how code is made available we see an increase in the fraction of publications for which code is available about 18 in 2018 this is a promising trend but since in many cases those models are available on a personal website or as an appendix to the journal article only available for subscribers current availability does not mean availability in the long run only about 3 of the model publications in recent years archive their model in public archives where the focus is on the preservation of the code in the longer term the importance of proper documentation and code availability is illustrated during the covid 19 pandemic squazzoni et al 2020 barton et al 2020 a large number of several projections of the covid 19 crisis are difficult to put into context since there is no transparency about the underlying assumptions since policymakers are primarily guided in their decision making in the covid 19 crisis by model results the lack of practicing model transparency is disappointing some scholars may argue that this extra level of archiving and documenting is too much of extra work and if models would be useful their code will become available somehow many articles indeed mention that code is available upon request to the authors since the fall of 2019 we started sending out emails to corresponding authors to request code used in their publications and all corresponding authors in our database an email has been send to in this email we provide information on our project best practices on model archiving and list which publications are in our database and whether we have been able to locate the model code or not appendix 2 for less than 1 of the emails we received a response some responses included urls where code is currently available and other responses indicated that the author no longer had access to the code increasing use of empirical data of human subjects to make empirical grounded agent based models could be a concern for sharing model code on models of human social dynamics however sharing processed data about human subjects is a common practice in the social science yoon and kim 2017 there are ethical and moral objections raised to share data in the social sciences and alternative policies for data sharing are part of the debate mauthner and parry 2013 tenopir et al 2015 there is not one policy that may work for all types of data or code what can we to do to improve to model documentation and code availability so we can build on the work of others there is no lack of technical solutions such as public archives journals and sponsors also start to improve their requirements but those requirements could be more precise about code availability at comses net we have created an open code badge that various journals have begun to adopt to signal best practices and provide durable links to model code https www comses net resources open code badge although we see some positive trends in the fraction of code availability in publications the transition towards a desirable level of practice will be a long term process it requires a change in norms and habits in fact research on adoption of data sharing in the social sciences suggest that personal motivations and perceived normative pressure are more critical in the data sharing behavior than availability of repositories or pressures from funding agencies and journals kim and adler 2015 the new generation of scholars using computational models must be trained in the tools available to derive best practices besides code sharing and documentation this should include containerization e g docker which can preserve software dependencies to be able to reproduce computational results in the longer term this could be integrated with education by letting students work in groups and build on existing model code available in sum there is a slow process of improvement in code availability in the field of agent based and individual based models still more concerted action is needed to improve the adoption of best practices this could be done by enforcement of best practices by journals and sponsors and by making this topic a common topic in modeling graduate courses and beyond data availability the data from the 7500 articles explored in this article are available at https osf io y2vs3 view only c0ec40bd9de54e1b88e1438656fb84f0 declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to thank rachael gokool yee yang hsieh juan rodriguez and christy contreras for entering metadata for christine nguyen and dhuvil patel for software development and cindy huang for contacting corresponding authors we acknowledge financial support for this work from the national science foundation grant numbers 0909394 and 1210856 appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104873 
25949,the management of water resources among competing uses presents a complex technical and policy challenge integrated hydro economic models capable of simulating the hydrologic system in irrigated and non irrigated regions including the response of farmers to hydrologic constraints and economic and policy incentives provide a framework to understand biophysical and socioeconomic implications of changing water availability we present a transformative hydro economic model of agricultural production driven by multi sensor satellite observations outputs from regional climate models and socioeconomic data our approach overcomes the limitations of current decision support systems for agricultural water management and provides policymakers and natural resource managers with satellite data driven state wide operational models capable of anticipating how farmers allocate water land and other resources when confronted with new climate patterns policy rules or market signals the model can also quantify how farming decisions affect agricultural water supplies we demonstrate the model through an application in the state of montana keywords hydro economic models positive mathematical programming data assimilation decision support systems 1 introduction many productive agricultural regions in the world are characterized by highly variable inter annual precipitation groundwater supplies and stream flows this variability is increasing and expected to continue in an upward trend as climate changes groisman and easterling 1994 easterling et al 2000 mccabe and clark 2005 mote 2006 long et al 2013 correspondingly more frequent and intense droughts and more severe storm and runoff events will present new challenges for water managers harou et al 2006 gorelick and zheng 2015 as opportunities to develop new water supplies decline managers will need to improve the efficiency of the existing sources to satisfy growing demands us army corps of engineers and us army corps of engineers 2012 agriculture has a long history of adapting to variability in local conditions mccarl 2015 rose 2015 evidence to date suggests that farmers have met these challenges by changing their water allocations crop mix and land use practices schneider et al 2000 bryant et al 2000 menzel et al 2006 however little is known about how farmer adaptation alters natural hydrologic systems impacts water users downstream and how policy instruments encourage or impede adaptation white et al 2011 regional resource managers rely on modeling tools to inform decision making including hydro economic models that simulate the balance between the regional water supply system and anticipated demands from agricultural producers under a range of scenarios hydro economic models are integrated tools that incorporate the realities of water management systems including variable spatial impacts and dynamic demands influenced by economic and policy drivers harou et al 2009 these types of models have been a subject of research since the late 1990s pulido velazquez et al ward and lynch 1996 cai et al 2003 ward et al 2006 cai et al 2008 brouwer and hofkes 2008 medellín azuara et al 2011 elbakidze et al 2012 2018 and are one of the most promising tools for future integrated water management the research applications of these models capture the spatial and temporal inter dependency between water supply and demand in a hydro economic system in operational water management applications however they often do not incorporate these internal feedback mechanisms another limitation of current operational water management models is that they typically neglect the spatially explicit and dynamic nature of human actions often assuming that the behavior of one farmer does not affect the choices of other farmers downstream however upstream decision making is likely to influence the availability of water for downstream uses and the ability of downstream farmers to adapt to climate change maneta et al 2009a b adaptive behavior and spatially dynamic processes are rarely simulated because they are difficult to represent in models aerts et al 2018 wens et al 2019 an efficient way to achieve this is to incorporate human behavior into hydro economic models using a constrained optimization approach with farmer response functions calibrated to reflect previously observed decisions this optimization approach is followed by models calibrated using the positive mathematical programming pmp method howitt 1995 models calibrated using pmp have been widely applied to understand and optimize agricultural water allocation and for policy analysis maneta et al 2009b medellín azuara et al 2008 torres et al 2011 ghosh et al 2014 kahil et al 2015 heckelei et al 2012 graveline and merel 2014 connell buck et al 2011 medellín azuara et al 2011 us bureau of reclamation 2011 department of water resources 2009 cobourn and crescenti 2011 and can represent farmer behavior at a fraction of the complexity and computational requirements of other popular alternative approaches such as statistical econometric or agent based models wurster et al 2020 ng et al 2011 weersink et al 2002 an additional advantage of this approach is that the calibrated hydro economic models are more amenable to coupling with physically based models that represent the distributed regional hydrologic system this coupling is key to tracing the effects of farmer adaptation on natural systems over space and time pmp is a well established method of calibrating hydro economic models but its predictive capability hinges on the quality and quantity of the data that it uses to reflect observed farmer behavior the popularity of programming methods in operational hydro economic models has to some extent been limited by the availability of high quality data for calibration which is often derived from survey data collected on producer behavior due to the relatively high cost of administering surveys data collection efforts necessary to calibrate and refine hydro economic models are often focused on specific watersheds limiting the transferability and utility of these models among other problems if a surveyed sample of farmers or the specific year of the survey are not representative of a broader set of producers and long term conditions the calibration may have a bias toward a spatially and temporally narrow set of farm conditions an opportunity to overcome this limitation is to use satellite based remote sensing observations of agricultural activity spanning multiple years of recorded data the increased availability of high spatial resolution remotely sensed time series data allows for classification of crop types and land allocation trends usda nass 2015 retrieval of vegetation productivity information including for specific crops he et al 2018 mu et al 2009 and estimation of vegetation water use he et al 2019 zhang et al 2010 allen et al 2007 at a finer spatial and temporal scale and across a broader geographic scope than has been possible to date using survey instruments although remotely sensed data are subject to greater noise than survey data remote sensing retrievals of agricultural activity provide continuous annual observations over a long period of time and over large geographic extents stochastic recursive data assimilation methods provide a cost effective opportunity to estimate model parameters using uncertain but abundant remotely sensed observations of land and water allocated to crops maneta and howitt 2014 in this paper we present and demonstrate a hydro economic modeling framework that can be calibrated and applied over large regions by using recent advances in remote sensing and data assimilation methods to enable automatic model updates and calibration refinements this recursive and stochastic process is of interest because 1 it permits calibration of model parameters with frequent but noisy observations from satellite based remote sensors that are available free of charge at global extents this advance eliminates the cost of conducting expensive field surveys typically used for calibration and it avoids biases introduced in calibration if producer surveys do not adequately represent regional practices 2 the process permits refinement of model parameterization when new information becomes available without conducting a full batch retrospective calibration with the entire historical dataset 3 in addition the need to permanently store the historical dataset is eliminated 4 this process blends information from old and new observations with the option of emphasizing the most recent measurements making the model parameterization more relevant for current conditions 5 last the process provides an automatic assessment of prediction uncertainty thus avoiding the false sense of precision given by deterministic models these innovations overcome current limitations of hydro economic models and allow for the development of new insights into how farmers behave under resource and policy constraints herein we demonstrate the implementation of the hydro economic model and define its accuracy for hydrologic and agricultural systems in the state of montana these systems span a representative range of conditions in the western u s including extensive dryland agriculture that is particularly vulnerable to climate variability 2 model description 2 1 general approach our modeling package links an aggregated economic model of agricultural production operating at a seasonal scale to a hydrologic model that simulates rainfall runoff processes and water redistribution and availability in the regional streamflow network at daily time scales the hydrologic model provides physical constraints on water availability and propagates the hydrologic impacts of agricultural activity and decision making to downstream users the linked model is embedded in a stochastic data assimilation framework that facilitates adjustment of the economic model parameters when remote sensing observations of crop mix land use allocation yield evapotranspiration and other ancillary and hydrometric information become available fig 1 once the model is calibrated it can be used to simulate climatic and policy scenarios and make spatially explicit predictions of the impacts of these scenarios on land and water allocation crop yields the opportunity cost of water and on the hydrologic system the data assimilation framework allows us to use observations with high uncertainty typical of remote sensing observations and incorporate this observational uncertainty in the probability distributions of economic model parameters when the model is used for scenario analysis parameter uncertainty is propagated to produce the probability distribution of the model predictions currently only parameters and outputs from the economic component are treated as stochastic variables for computational reasons the hydrologic component and all hydroclimatic inputs to the economic component are deterministic 2 2 economic model of agriculture and farmer behavior the backbone of the economic component is a nonlinear constrained optimization model calibrated to capture observed producer behavior using the pmp method howitt 1995 the pmp approach is grounded in the assumption that producers allocate resources in our case land and water to maximize their net revenues subject to resource constraints 1 max x l a n d i x w a t e r i n e t i p i π i x l a n d i x w a t e r i μ i β l a n d i β w a t e r i ρ i δ i c l a n d i x l a n d i c w a t e r i x w a t e r i subject to i x l a n d i l λ l i x w a t e r i w λ w x l a n d i x w a t e r i 0 where n e t is net revenue defined as revenue less the costs of land and water use the index i 1 i represents crops x l a n d i x w a t e r i represent land and water resource inputs for crop i respectively p i is the price received for crop i π i is a production function that maps resource inputs to total production of crop i and c l a n d i c w a t e r i are the unit costs associated with land and water use to produce crop i the parameters μ β ρ δ are production function parameters calibrated using pmp the constraints in eq 1 state that the total land and water used for all crops in the region must be less than or equal to the total land l and water w available for cultivation and that resource allocation has to be non negative note that total water available for cultivation refers to irrigation water not precipitation the total land and water available for cultivation may be constrained by physical limits e g streamflow or by policy or other institutional constraints e g water rights or reservoir storage release policies consistent with the recent economic literature on pmp mérel et al 2011 we define the production function in eq 1 using a generalized constant elasticity of substitution ces functional form 2 π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i x p r e c i p i ρ i δ i ρ i a limitation of previous research in this area is that it has differentiated the production function in eq 2 for irrigated and non irrigated crops requiring independent calibration of each function e g maneta et al 2009b in this study we streamline calibration by incorporating a production function that can handle irrigated and non irrigated cases to do so we separate the total amount of water available to support crop growth into an exogenous component provided by natural sources like precipitation x p r e c i p i not controlled by the farmer and an endogenous component provided by supplemental irrigation x w a t e r i controlled by the farmer precipitation therefore acts as an offset to the total irrigation water applied to a crop and is not subject to the water availability constraint this formulation also allows us to differentiate the costs of providing water for crop production which differ depending on whether a year has relatively wet or dry conditions 2 3 hydrologic component the hydrologic component provides water availability constraints to agricultural production precipitation is transformed into runoff using a gridded version of the hydrologiska byråns vattenbalansavdelning hbv model bergstrom and forsman 1973 bergstrom 1995 lindström et al 1997 when runoff reaches the channel it is routed through the stream network using the muskingum cunge method cunge 1969 the hbv model and the muskingum cunge method are well known in the field of hydrology and because of their parsimonious nature reliability robustness and performance they have been widely applied in many regions of the world for hydrologic response analysis under climate change and drought driessen et al 2010 menzel and bürger 2002 hbv is a precipitation runoff model originally developed to assist in flood forecasting in sweden bergstrom and forsman 1973 the hydrologic system is conceptualized as a cascade of four compartments snowpack soil upper groundwater zone and lower groundwater zone in each of the hydrologic response units hrus in which the user may divide the region appendix a water outputs from the soil and groundwater compartments of each hru are transformed into runoff by convolution with a triangular unit hydrograph we implemented this particular application as a partially gridded version of the original model the model uses gridded raster daily precipitation and maximum and minimum daily air temperature to produce the aggregated spatially averaged runoff response of the different subcatchments composing the study area water ponded on the surface of pixel p at time t available for infiltration and for the generation of runoff represents the integration of water input rates from snowmelt m e l t p t rainfall r a i n p t and supplemental irrigation p p j t i r r if pixel p is in the set of pixels designated to be irrigated from water source j 3 p o n d p t p o n d p t 1 m e l t p t r a i n p t p p j t i r r δ t δ s m p t infiltration described in appendix a increases the water storage in the soil δ s m p t at pixel p and is aggregated over all pixels p within subcatchment l when water stored in the soil moisture compartment of subcatchment l reaches a threshold the excess water generates output or percolates to the groundwater compartment outputs from the soil and groundwater compartments produce the integrated response of the subcatchment a comprehensive description of our particular implementation of the model is provided in appendix a in total the hydrologic model tracks four internal states in each of the subcatchments snow water equivalent soil water storage water storage in the upper groundwater compartment and water storage in the deep water compartment the model has 12 parameters that can be potentially tuned details of the model structure and implementation are provided in appendix a the runoff response of each subcatchment becomes lateral water contributions into the stream reach contained in the subcatchment lateral runoff and inflows from upstream subcatchments are routed through the river network using the muskingum cunge model the muskingum model uses a two parameter constitutive equation to relate storage s in a reach to its inflows q i n and outflows q o u t s k e q i n 1 e q o u t where k and e are the two function parameters this constitutive relationship permits a mass balance equation for the reach as a function of streamflows and parameters the muskingum cunge method uses this relationship to develop a finite difference approximation of the 1d diffusion equation 4 q j t 1 k j 1 e j 0 5 δ t q j 1 t 1 k j e j 0 5 δ t q j t k j 1 e j 0 5 δ t q j 1 t k j e j 0 5 δ t q j t 1 q j i t 1 i r r k j 1 e j 0 5 δ t full details on the muskingum cunge algorithm and its implementation are provided in appendix a 2 4 model coupling the hydrologic component of the model operates deterministically at daily time steps and at variable spatial resolutions defined by the size of the hrus on the other hand the economic component operates stochastically at seasonal time steps and at spatial resolutions defined by counties districts or regions that may or may not be coincident with the hrus to couple the two components relevant information generated by one component needs to be adapted and spatially and temporally aggregated or disaggregated to match the resolution of the receiving component as described in this section at the beginning of each simulated year the economic component is run for each economic unit within the domain and the simulated probabilistic ensembles of land x l a n d i and irrigation water x w a t e r i allocated to each crop i for the growing season are determined the ensemble average of seasonal water allocations e x w a t e r i are temporally and spatially disaggregated and combined with information on irrigation and conveyance efficiencies to obtain expected daily diversion volumes from the hydrologic network and pixel level water application rates the temporal disaggregation of simulated seasonal water allocation for each crop i e x w a t e r i to daily water diversion rates from its source node j in the hydrologic network is achieved by redistributing the seasonal water allocation to daily amounts over the growing season according to a fractional weight coefficient ω i t 1 that reflects the growth stage of the crop at a given day 7 q j i t 1 i r r e x w a t e r i ω i t 1 i e f f i where 8 ω i t 1 k c i t 1 t k c i t 1 where q j i t 1 i r r is the water volume diverted for irrigation from river node j for crop i at day t 1 i e f f i is an irrigation and conveyance efficiency factor for crop i and ω i t 1 is a weight factor that represents the fraction of the total crop water requirement that correspond to day t 1 factor ω i t 1 is a function of crop coefficients k c that vary through the season from plant emergence to termination and reflect crop water requirements at a given stage relative to the water requirement of a fully developed reference crop we use crop coefficients and growth curve charts recommended by the u s bureau of reclamation for the pacific northwest region agrimet program 1 1 https www usbr gov pn agrimet cropcurves crop curves html computed daily diverted volumes enter the hydrologic model through eq 4 daily diverted water from each source node q j i t 1 i r r is subsequently spatially disaggregated and distributed to pixels identified as irrigated agriculture within the economic unit supplied by the diversion node application rates in each irrigated pixel are obtained by dividing daily diverted volumes by the irrigated area in the economic unit 9 p p j t 1 i r r i q j i t 1 i r r n p δ x 2 where p p j t i r r is the supplemental irrigation applied at time t on pixel p from the set of pixels classified as irrigated agriculture within the economic unit associated with diversion point j n p is the total number of pixels classified as irrigated agriculture within the economic units and δ x 2 is the pixel area computed daily water application rates p i r r enter the hydrologic model as supplemental irrigation in eq 3 since the model spatial resolution is typically too coarse to resolve individual crops irrigation is applied uniformly over all pixels p designed as irrigated crops within the corresponding economic unit 3 calibration of the economic component 3 1 positive mathematical programming the pmp approach assumes that farmers allocate limited land and water resources with the objective of maximizing net revenues and thus past observations of land and water use by crop x l a n d i x w a t e r i are solutions to the problem in eq 1 during calibration eq 1 is modified to constrain the maximization problem to the observed levels of land and water allocation 10 max x l a n d i x w a t e r i n e t i p i π i x l a n d i x w a t e r i μ i β l a n d i β w a t e r i ρ i δ i c l a n d i x l a n d i c w a t e r i x w a t e r i subject to i x l a n d i l λ f s l x l a n d i x l a n d i λ l a n d i x w a t e r i x w a t e r i λ w a t e r i x l a n d i x w a t e r i 0 eq 10 contains seven parameters per crop five production function parameters μ i β i l a n d β i w a t e r ρ i δ i and two lagrange multipliers associated with the observed land and water use constraints λ i l a n d λ i w a t e r for a total of 7 unknown parameters to be calibrated based on observed decision making an additional parameter λ f s l 0 associated with the land resource constraint also needs to be calibrated this parameter represents the shadow value for the total amount of land available for crop production the pmp methodology builds the system of optimality conditions associated with eq 10 however instead of solving the maximization problem to find optimal land and water resource allocation the method fixes these at the observed allocation levels and solves the system of optimality conditions for the model parameters in essence the pmp methodology finds the parameters that produce a response surface net revenue function that is maximum at the observed resource allocation levels x l a n d i x w a t e r i eq 10 is differentiable and traditionally solved using nonlinear programming methods necessary and sufficient optimality conditions are given by the first order derivatives of eq 10 with respect to x l a n d i and x w a t e r i the karush kuhn tucker conditions to enforce constraints and a few additional constraints to ensure the solution to the maximization problem exists and is unique a programming solution embedding the optimality conditions for eq 10 proposed by mérel et al 2011 and used in this study is provided in appendix b additionally we follow the calibration condition for λ f s l proposed by garnache et al 2017 based on minimizing squared deviations between modeled expenditures on inputs and expenditures implied by the observed use of inputs this deterministic program of optimality conditions can be arranged such as the observed quantities are grouped on the left hand side l h s and the quantities that depend on model parameters functions of model parameters are grouped on the right hand side r h s 11 p i π i π w i c l a n d i λ l a n d i λ f s l x l a n d i p i π i δ i p i π i π w i c w a t e r i λ w a t e r i x w a t e r i η i δ i 1 δ i 1 b i δ i 1 δ i i b i δ i 1 δ i σ i b i π w i δ i δ i π w i b i x l a n d i 2 p i π i π w i δ i β w a t e r i x w a t e r i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i i 0 i 2 x l a n d i p i π i m π w i m i 0 i 2 c l a n d i λ f s l x l a n d i 2 2 x l a n d i p i π i δ i 1 l h s β l a n d i β w a t e r i r h s during calibration the standard pmp solves this nonlinear program for the model parameters using a standard root finding algorithm 3 2 stochastic recursive parameter estimation in the stochastic approach we embed eq 11 within a stochastic data assimilation framework that permits the recursive calibration of the model parameters while taking into account the impact of observational errors the basic idea of the algorithm is to generate an ensemble of l h s quantities any time new observations are available by drawing samples from the probability distribution of the observations this l h s ensemble is compared with an ensemble of r h s quantities the ensemble of r h s quantities is generated by running the r h s functions using random samples from a model parameter distribution the difference between l h s and r h s is called the innovation and is a diagnostic of optimality over time as more observations are used the data assimilation algorithm adjusts updates the model parameter distribution to values that result in an innovation ensemble with mean zero this condition indicates that the parameter distribution satisfies the optimality conditions in the stochastic sense the key in this process is the parameter update algorithm which is presented in section 3 2 4 a schematic overview of the algorithm is shown in fig 2 maneta and howitt 2014 describe a discrete monte carlo recursive bayesian estimator that permits to update the parameters as new observations become available at time k in our application time k represents a year because observations of agricultural activity are available yearly the proposed methodology has three important advantages 1 its probabilistic nature permits to integrate noisy observations in the parameter estimation process making possible the use of remote sensing retrievals of agricultural activity for model calibration 2 it provides a posterior parameter distribution that reflects the quality of the information used for calibration and 3 it integrates new and old information when new observations are available without having to store or retrieve the old history of observations the equations of the estimator are based on the ensemble kalman filter enkf evensen 1994 where the probability distribution of parameters inputs and observations are represented by a monte carlo sample the exception is parameter ρ i a function of σ i which controls the elasticity of substitution between land and water this parameter is fixed at a value ρ i σ i 1 σ i with σ i values typically in the range of 0 1 0 6 which represents limited substitution between these two resources the reason for fixing this parameter is that elasticity of substitution has been found to be insensitive to aggregated observations and requires more detailed experimental data for its identification therefore our approach stochastically tracks seven parameters six parameters that need to be calibrated for each crop and one unit level resource constraint parameter λ f s l specifically the probability distribution of the model parameters θ μ β l a n d β w a t e r δ λ l a n d λ w a t e r λ f s l is represented by a random ensemble of m members m 1 m of θ except for λ f s l the unit level parameter each bold parameter in the θ set is an array with rows representing parameter values for each crop grown in a given economic unit e g county irrigation district and each column is an individual member of the ensemble the parameters of the generalized ces production function must satisfy the following constraints μ 0 β l a n d 0 β w a t e r 0 0 δ 1 and λ f s l 0 the parameters λ l a n d and λ w a t e r are unrestricted a positive value for the λ parameters reflects an unobserved cost associated with the use of an input whereas a negative value reflects an unobserved benefit as described by mérel et al 2014 3 2 1 prior parameter distribution parameter forecasts to set the filter equations we treat model parameters as if they were the system states of the standard enkf the evolution of parameters forecasts from period k to k 1 periods when observations become available typically yearly is produced by adding a random perturbation to each member of the ensemble the addition of artificial noise to each ensemble member to simulate time dynamics results in an overdispersed ensemble that overestimates the parameter variance west 1993 this is because the intrinsic variance of the ensemble is compounded by the noise added to each member to perform the random walk liu and west 1993 show that this can be corrected by using perturbations that are proportional to the ensemble variance by a number h slightly smaller than one and shrinking the ensemble toward its mean by a factor a 1 h for a given crop i the dynamics of members of the parameter ensemble with shrinkage is 12 β l a n d i k 1 m β w a t e r i k 1 m μ i k 1 m δ i k 1 m λ l a n d i k 1 m λ w a t e r i k 1 m λ f s l k 1 m θ i k 1 m a 0 0 μ i k m δ i k m λ l a n d i k m λ w a t e r i k m λ f s l k m 1 a 0 0 e μ i k e δ i k e λ l a n d i k e λ w a t e r i k e λ f s l k ζ i k β l a n d ζ i k β w a t e r ζ i k μ ζ i k δ ζ i k λ l a n d ζ i k λ w a t e r ζ k λ f s l ζ i k β l a n d b a i β l a n d k b i β l a n d k ζ i k β w a t e r b a i β w a t e r k b i β w a t e r k ζ i k μ n 0 h 2 v μ i k v μ k ζ i k δ n 0 h 2 v δ i k v δ k ζ i k λ l a n d n 0 h 2 v λ l a n d i k v λ l a n d k ζ i k λ w a t e r n 0 h 2 v λ w a t e r i k v λ w a t e r k ζ k λ f s l n 0 h 2 v λ f s l k v λ f s l k where superscript m over a parameter indicates it is the mth ensemble member at the time indicated by the subscript k and superscript indicates the parameter is corrected posterior after data assimilation at time k see below a and h are the shrinkage and variance smoothing parameters respectively e is the expectation operator of the parameter ensemble i e ensemble average for the given parameter and crop operator v is the parameter ensemble variance and v is a parameter level background variance that represents the parameter forecast processes noise v k and h are important tuning parameter that permits to control filter divergence and collapse parameters μ δ λ l a n d λ w a t e r and λ f s l are sampled using normally distributed noise however the β parameters are bound to values in the range 0 1 to sample the distribution of these parameters at k 1 we used a beta distribution with two shape parameters a ˆ b ˆ centered at each ensemble member the parameters that center the distribution at each member are determined using the method of moments from the mean and the variance of each individual ensemble member 13 a ˆ i β β i m β i m 1 β i m v β i k v β k 1 b ˆ i β 1 β i m a ˆ i β i where v β m is the variance of the ensemble v β k is the parameter background variance process noise and β i m is the mean of the kernel locations and 14 β i m a β i k m 1 a e β i k 3 2 2 generation of the observation l h s ensemble uncertainty in remote sensing observations of agricultural activity land and water allocations crop yield and yield elasticity as well as uncertainty in additional ancillary information crop supply elasticity crop price cost of operating land and cost of water obtained at time k 1 is represented by an ensemble with m observations of replicates obtained by sampling from a normal distribution centered at the observation 15 x l a n d i k 1 m x l a n d i ν l a n d i k 1 m ν l a n d i k 1 m n 0 r k 1 x l a n d x w a t e r i k 1 m x w a t e r i ν w a t e r i k 1 m ν w a t e r i k 1 m n 0 r k 1 x w a t e r π w i k 1 m π w i k 1 ν π w i k 1 m ν π w i k 1 m n 0 r k 1 π w π i k 1 m π i k 1 ν π i k 1 m ν π i k 1 m n 0 r k 1 π η i k 1 m η i k 1 ν η i k 1 m ν η i k 1 m n 0 r k 1 η p i k 1 m p i k 1 ν p i k 1 m ν p i k 1 m n 0 r k 1 p c l a n d i k 1 m c l a n d i ν c l a n d i k 1 m ν c l a n d i k 1 m n 0 r k 1 c l a n d c w a t e r i k 1 m c w a t e r i ν c w a t e r i k 1 m ν c w a t e r i k 1 m n 0 r k 1 c w a t e r where x l a n d i m x w a t e r i m π w i π w i and η i are observations of land and water used by crops elasticity of production to water inputs crop production and elasticity of production to crop prices respectively observations are scaled into a dimensionless quantity see section 3 3 using these observation replicates individual l h s i ensemble members of the stochastic system of optimality conditions are produced 16 l h s i k 1 m p i m π i m π w i m 1 p i m π i m π w i m 2 η i m 3 π w i m 4 π i m 5 i 0 i 2 x l a n d i m p i m π i m π w i m 6 1 7 0 8 0 9 k 1 where the first two elements are part of the calculation of the marginal costs of production the next two elements are observations of production elasticity to crop price and crop water use crop evapotranspiration as retrieved by remote sensing algorithms respectively the fifth element is the observations of crop production and the last three elements are the left hand side of three constraints to facilitate sampling β parameters such as β l a n d i β w a t e r i 1 β i 0 since all inputs are normalized the β parameters represent the fraction of production shared by the corresponding input the constraints on the β parameters form a convex sum of inputs that ensure that the production function outputs are always within the range of historical observations 3 2 3 generation of the model prediction r h s ensemble the r h s θ k 1 ensemble is a function of model parameters θ i k 1 using parameter and input replicates the right hand side equations are used to producean ensemble of model prediction counterparts to the observations in l h s i k 1 17 r h s θ i k 1 m c l a n d i m λ l a n d i m λ f s l m x l a n d i m p i m π i m δ i m 1 c w a t e r i m λ w a t e r i m x w a t e r i m 2 δ i m 1 δ i m 1 b i δ i m 1 δ i m i b i δ i m 1 δ i m σ i m b i π w i m δ i m δ i m π w i m b i x l a n d i m 2 p i m π i m 3 δ i m β w a t e r i m x w a t e r i m ρ i β l a n d i m x l a n d i m ρ i β w a t e r i m x w a t e r i m ρ i 4 μ i m β l a n d i m x l a n d i m ρ i β w a t e r i m x w a t e r i m ρ i δ i m ρ i 5 i 0 i 2 c l a n d i m λ f s l m x l a n d i m 2 2 x l a n d i m p i m π i m δ i m 6 β l a n d i m β w a t e r i m 7 β l a n d i m β l a n d i m 8 β w a t e r i m β w a t e r i m 9 k 1 the first two elements of l h s i m and r h s i m represent the difference between marginal costs of production and marginal revenues with respect to land and water marginal costs and marginal revenues are equal at the optimal point the next two elements of r h s i k 1 m are model predictions of production elasticity to crop price and production elasticity to crop water use respectively the fifth element is the observation of crop production the last three elements of l h s i m and r h s i m are constraints to facilitate sampling β parameters within the unit simplex such as 1 β l a n d i β w a t e r i β i 0 the last two constraints are the non negativity conditions non negative β samples only occur if the difference between the sample and its absolute is zero which is the condition expressed by the last two equations 3 2 4 assimilation equations posterior parameter distribution assimilation of new observations obtained at time k 1 to correct each member m of the parameter ensemble is achieved using the update equations of the enkf 18 θ i k 1 m θ i k 1 m k k 1 l h s i k 1 m r h s θ i k 1 m k k 1 c k 1 θ r h s c k 1 l h s c k 1 r h s 1 where θ i k 1 m is the corrected posterior mth member of the model parameters k k 1 is the kalman gain matrix that corrects the parameter trajectories l h s i k 1 m is the mth member of the ensemble of replicates of the left hand side of the system of optimality conditions which holds observation and other derived quantities r h s θ i k 1 m is the mth member of the ensemble of replicates of the right hand side of the optimality conditions which is a function of model parameters and holds predictions of the l h s c k 1 θ l h s is the cross covariance between the parameter ensemble and the rhs ensemble c k 1 l h s is the covariance of the lhs ensemble and c k 1 r h s is the covariance of the rhs ensemble the quantity between brackets in the top equation of 18 is the innovation and holds the model prediction errors a property of kalman filters is that when they are properly tuned the ensemble of parameters produce a sequence of innovations that is normally distributed with zero mean since lhs and rhs represent the left and right hand sides of the optimality conditions eq 18 is in effect solving the maximization problem posed in eq 1 the variance of the innovation is the total variance of the process associated with observation and parameter uncertainty 3 3 scaling observations and inputs if the β parameters are considered dimensionless share quantities the constant elasticity of substitution production function specified in eq 2 is dimensionally inconsistent and its results are not interpretable in terms of processes unless inputs are scaled and transformed to dimensionless quantities for a particular season the information needed to correct the model parameters for an economic unit include observations of land x l a n d i o b s ha and water x w a t e r i o b s mm ha 1 used by crop i crop price p i o b s t 1 the typical cost of cultivating crop i per unit of land c l a n d o b s ha 1 the cost of applying a unit of water including fees transportation application costs etc c w a t e r o b s mmha average crop yield over the economic unit y i o b s t ha 1 the elasticity of production to water π w i o b s dimensionless and the elasticity of production to crop prices η i o b s dimensionless the dimensionless observed quantities used in the data assimilation and parameter correction process are obtained by applying the following transformations 19 x l a n d i x l a n d i o b s x l a n d i r e f x w a t e r i x w a t e r i o b s e t i r e f x l a n d i r e f x p r e c i p i x p r e c i p i e s t e t i r e f π i y i o b s x l a n d i o b s y i r e f x l a n d i r e f p i p i o b s p i r e f c l a n d i c l a n d i o b s p i r e f y i r e f c w a t e r i c w a t e r i o b s e t i r e f p i r e f y i r e f where y i o b s is the mean observed yield in the economic unit kg ha x p r e c i p i e s t is the estimated or expected crop water use from natural water sources e g from precipitation in mm and x l a n d i r e f in ha e t i r e f in mm p i r e f in k g 1 and y i r e f in 1 are long term mean land used water price and yield observations used as reference scaling quantities for crop i note that the observed cost of water per unit volume c w a t e r i o b s only applies to artificial irrigation but is normalized using total crop evapotranspiration e t i r e f because it is what is retrieved by remote sensing products this normalization works because c w a t e r i o b s is constant regardless of the water volume used by crops and e t i r e f just serves the role of a normalization factor production elasticity to water and prices measures how responsive crop production is to used water and crop prices and is defined as a percent change in production over a percent change in used water or crop price defining π i o b s y i o b s x l a n d i o b s elasticities can be calculated from observations as 20 π w i δ π i o b s π i o b s δ x w a t e r i o b s x w a t e r i o b s d log π i o b s d log x w a t e r i o b s 21 η i δ π i o b s π i o b s δ p i o b s p i o b s d log π i o b s d log p i o b s elasticities are typically considered constant over a period of time and they can be obtained as the least squares regression slope between the logarithm of production and the logarithm of water used or the logarithm of crop prices over the considered period we calculate the production elasticity to water π w i in our study area empirically using 20 we constructed our crop specific supply elasticity using results from a series of previous studies summarized in table a1 appendix c in addition we supplemented published supply elasticity estimates with our own calculation from 21 applied using annual county level production and price statistics for the state of montana our empirical supply elasticity estimates were heuristically combined with published values based on the temporal recency and geographical proximity of the studies and based on expert judgment 3 4 economic component at simulation time the posterior parameter distribution obtained after the most recent assimilation step k is used in the production and cost functions of the net revenue eq 1 for each member in the parameter and input ensemble the maximization problem is solved this time for land and water allocation under any simulation scenario represented by an ensemble of crop prices production costs and land and water constraints 22 max x l a n d i m x w a t e r i m 0 n e t m i p i m π i m x l a n d i m x w a t e r i m x p r e c i p i m μ i k m β l a n d i k m β w a t e r i k m ρ i δ i k m c l a n d i m λ l a n d i k m λ f s l k m x l a n d i m c w a t e r i m λ w a t e r i k m x w a t e r i m subject to i x l a n d i m l m λ l a n d m i x w a t e r i m w m λ w a t e r m maximization of eq 22 for each member m of the parameter and input ensembles generate a result ensemble that represents the probability distribution of land and water allocated to each crop i as well as an ensemble of the lagrange multipliers λ l a n d m and λ w a t e r m associated with total land l and water w resource constraints imposed by physical availability or policy lagrange multipliers represent the opportunity cost associated with not having an additional unit of land or water and therefore can be interpreted as a metric of the value of land and water additionally solving eq 22 also produces the probability distribution of estimated crop production and of the probability distribution of production elasticity of supply and production elasticity of water inputs 4 application to montana we demonstrate the application of the model at regional scales in the state of montana located in the intermountain pacific northwest of the united states inset of fig 3 the study region extends beyond the boundaries of the state to include the headwaters of basins that drain into the state covering an area of 464 800 km 2 the state has a longitudinal topographic and climatic gradient from the steep and relatively wet rocky mountain western region toward the flatter and significantly drier eastern portions of the state which are part of the us northern great plains region the us continental divide runs roughly north to south along the west quarter of the state about 25 of montana drains to the pacific ocean clark fork river as part of the greater columbia river basin and the remainder of the state headwaters of the missouri river basin drains to the gulf of mexico annual precipitation inputs range from over 1000 mm in the mountain regions of the west and gradually decline to about 200 mm in eastern montana the western part of the state also shows less continentality with relatively warmer temperatures in the winter and cooler temperatures in the summer than the eastern portion of the state other than the ecosystem the largest water user in the state is agriculture agriculture is also the leading industry in the state despite its economic importance agriculture is poorly diversified and dominated in terms of production and planted area by alfalfa wheat and barley montana is a major producer of wheat and barley in the us and contributes to the country s food security irrigation is common along streams and in the western parts of the state however rainfed production is dominant and very vulnerable to drought in the drier central and eastern parts of the state irrigated area has been growing substantially in the state in recent decades and has contributed to increasing production and reduction in economic risk surface water is the primary source for irrigation including within irrigation districts and so far significant groundwater depletion due to agricultural extraction is only limited to a few localized watersheds whitlock et al 2017 4 1 implementation of hydrologic component the representation of the hydrologic system in the study region is shown in fig 3 the figure shows the representative elementary watersheds rews that compose the domain the nodes that define their outlets and the links stream reaches that connect them we used the gtopo30 digital elevation model dem produced by the usgs at 1 km resolution to determine the regional drainage network and partition the domain into rews using gis procedures we used the location of active national water information system streamflow gauges as the initial set of nodes to partition the landscape into rews and then further densified the network with additional nodes until we achieved sufficient spatial detail the densification was done by allocating nodes in pixels having contributing areas larger than a specified threshold the minimum contributing area for a rew was selected such that the total number and sizes of rews was considered adequate to resolve the spatial variability of streamflows the final domain contains over 300 rews with typical sizes around 1400 km 2 each rew in the domain has one stream reach with a from node and to node attribute that identify the upstream and downstream node of the reach this information is used to build the network topology and a node adjacency matrix that is used in the water routing algorithm described in appendix a water diversions occur at 56 selected river nodes one for each economic unit county included in the simulation we ran the model with daily gridded precipitation maximum and minimum air temperatures at a 4 km resolution automatically retrieved as netcdf files from the gridmet dataset abatzoglou 2013 temperatures are used internally by the model to calculate reference crop evapotranspiration using the hargreaves method george h hargreaves and zohrab a samani 1985 4 1 1 calibration of hydrologic component the hydrologic model parameters were calibrated manually against streamflow observations at gauged river nodes and against snow water equivalent observations from the snotel network all parameters of the hbv rainfall runoff model and muskingum cunge routing model were adjusted and shared between rews grouped according to their physiographical mean elevation mean slope area shape factor and land use characteristics fraction of the rew under forest cover and under agriculture using a standard k means classification method in total we calibrated seven groups of parameters corresponding to seven groups of rews 4 2 implementation of economic component although remote sensing can retrieve information about land and water allocation at field scales the specification of the economic component of our model is designed to simulate the aggregated economic behavior of producers in a region not the behavior of individual farmers the economic units considered in this implementation are aggregated at the county level thus we represent the agricultural system in montana using 56 economic units counties each of them retrieving water from the stream network at one designated diversion node although the economic activity is represented in aggregated form intra county agroeconomic heterogeneity is to some extent implicitly captured in the distribution of model predictions for each county 4 2 1 recursive calibration of the economic component information necessary to update the model parameters include land allocated to each crop total water used by each crop and total crop production this information is available every year from remote sensing products at 30 m spatial resolution and then aggregated at county scales in addition information on crop prices approximated variable unit costs of cultivating land and cost of applying water are also required table 1 crop price information and an approximation of production costs were obtained from annual surveys published by the us department of agriculture national agricultural statistics service usda nass at the state scale quickstats http quickstats nass usda gov crop coefficients to determine crop development stage were obtained from tables published by the agrimet network for crops grown in the us pacific northwest https www usbr gov pn agrimet cropcurves crop curves html annual variations in crop mix and area are obtained from the usda cropland data layer cdl usda nass 2015 published by the usda nass the cdl provides a satellite based remotely sensed annual crop specific land cover classification that resolves the type and location of the major summer crops in the conterminous us the cdl is available since 2003 for the conterminous us at 30 m spatial resolution since the unit of analysis of the economic component is the county we calculated total allocated land in each county for the main crops grown in montana alfalfa barley durum wheat spring wheat winter wheat maize and peas from 2009 to 2018 uncertainty in land allocation retrievals were estimated by scaling the average pixel level classification uncertainty standard deviation of each crop by the number of pixels allocated to the crop in the county fig 4 a shows an example of the cdl and the annual variations in allocated area for alfalfa barley spring wheat and winter wheat in two counties observations of crop production and yield defined as the ratio of production to area planted were obtained using a satellite driven light use efficiency model to estimate gross primary production gpp over croplands at 30 m resolution and 8 day time step the high spatial and temporal resolution necessary to delineate cropland vegetation growth was achieved by using a ndvi dataset that blended landsat 5 7 reflectance and terra modis reflectance crop yields each year were obtained by accumulating gpp over the growing season and applying a crop specific harvest index to convert primary production to yields he et al 2018 gives a full description and validation of this remote sensing product we calculated county scale annual crop production by multiplying crop yield times the area allocated to the crop in each county uncertainty in the county scale production estimates was obtained by scaling the spatial standard deviation of yields by the area planted fig 4c shows an example of the 30 m remotely sensed retrieved yield map and the annual variation of alfalfa barley spring wheat and winter wheat production from 2009 to 2018 in two counties crop water use was estimated by adapting an operational global et product nasa mod16a2 mu et al 2011 to better represent cropland et our adaptation of the mod16a2 product uses finer scale meteorological inputs from the gridmet product abatzoglou 2013 and the same refined 30 m resolution ndvi dataset used in the estimation of production the model parameters were also recalibrated for broadleaf crops and for cereal crops a complete description of the adaptation of mod16a2 et product for agricultural applications of the conterminous us is given by he et al 2019 annual variations in county scale crop specific water use volumes were calculated by accumulating pixel scale et over the growing season and at the county scale for each crop uncertainty in the county scale water use estimates was obtained by scaling the spatial standard deviation of crop et by the area planted fig 4b shows an example of the 30 m remotely sensed retrieved crop et map and the annual variation of total water volumes used by alfalfa barley spring wheat and winter wheat production from 2009 to 2018 in two counties note that crop water use includes both evapotranspiration from precipitation and from supplemental irrigation 4 3 analysis methods for this analysis we set the ensemble size m 300 to stabilize model parameters and start with correct optimal values at the beginning of the analysis period we first spun up the data assimilation process by repeatedly assimilating observations from 2008 first year in our data record until the posterior distribution of the model parameters converged we tuned the filter by manually adjusting the variance smoothing parameter h and the background parameter ensemble variance v k until the parameter ensemble resulted in land allocation prediction distributions that approximated the assumed distribution of land allocation observations in 2008 we found good results assuming v β l a n d k v β w a t e r k v δ k and v μ k were 0 01 of the square of their respective ensemble means we found v λ w a t e r k v λ l a n d k and v λ f s l k to be very sensitive to errors and required a smaller variance of about 0 0001 of the square of their respective ensemble means we also prescribed h 0 97 and a 0 94 low level of parameter smoothing after the spin up was complete e g parameters converged to their optimal or near optimal values from their arbitrary initial values we used the resulting model parameters to verify that they correctly reproduce the observed land and water allocations used to calibrate them after this verification we started the data assimilation process by sequentially ingesting observations from 2008 to 2016 observations from 2017 to 2018 were available but not ingested and used to verify the ability of the model to predict out of sample years we focused model verification and analysis mostly on predictions of land and water allocation since it is one of the most novel aspect of the modeling system however we also demonstrated the value added by the hydrologic component by identifying the net impact of agricultural water diversions in 2017 in the discussion section we provide a qualitative evaluation of the spatial impacts of agricultural water use 5 results 5 1 calibration and verification parameter spin up the results of the parameter spin up showed that for most counties the parameters could be accurately inferred from the assimilated observations an example for beaverhead county a county with a large extent of land allocated to agriculture and also first county alphabetically is shown in fig 5 results for all counties are presented in appendix a available online the ensemble was initiated before the spin up with an arbitrary mean and a large spread initial coefficient of variation of the ensemble was prescribed at 100 and the ensembles typically converged to a steady state distribution with within five to eight assimilation cycles fig 6 show the dynamics of the ensemble of innovations residual between eq 16 and eq 17 for the parameter evolution of beaverhead county shown in fig 5 the figure shows that the innovation quickly approaches zero which indicates that the parameter ensembles converge to a solution that satisfied the optimality conditions of the positive mathematical program eq b 2 the algorithm works because components 1 and 2 in eq 16 represent the marginal revenues with respect to land and water allocation and components 1 and 2 of eq 17 represent the respective marginal costs when the ensemble of differences between l h s i and r h s i is centered about zero the methodology is effectively solving the first order conditions of the net revenue maximization problem which is the core of the calibration algorithm online appendix b shows the evolution of the innovation ensembles associated with the parameter spin ups in all counties in the state of montana an inspection of this appendix shows that all innovations reliably have zero mean and a steady variance which are diagnostics of the correct performance and tuning of the filter the ensemble of parameters obtained at the end of the spin up cycle was used to predict the land and water allocation for the 2008 baseline the model was able predict mean land and water allocations in each county with satisfactory accuracy as summarized in table 2 the correlation coefficient between county wise simulated and observed land allocation is higher than 0 98 and the relative bias of the estimation is typically less than 0 06 6 a comparison between the predicted probability distributions of land and water allocation and observed allocations provides a direct evaluation of the model predictive skills for individual counties and also illustrates how parameter uncertainty translates into uncertainty in the predictions of resource allocation fig 7 shows the simulated probability distribution of land allocated to the crops grown in beaverhead county along with the observations the assumed uncertainty in the observed land allocation was used to tune the background variance of the parameters and provide additional confidence that the filter is correctly tuned online appendix c shows the simulated land allocation for all crops and counties in general for all counties and crops the predictive distributions are well centered around the observation and have a variance that approximate the assumed observational error comparison between observed and modeled water allocation for irrigation is less straightforward because water allocation per crop and county is not directly observed remote sensing et observations only provide total crop water use which integrates water from natural precipitation and from supplemental irrigation however the simulation scenarios require that the expected amount of water from natural sources used by crops natural et is specified subtracting this specified natural et amount from the total observed crop water use gives us an estimate of the amount of crop water use supplemented by irrigation this estimate served as the observation of supplemental irrigation used to evaluate the model simulation of water allocation fig 8 shows the case of beaverhead county figures for water allocation in all counties in the state are provided in online appendix d similar to the simulation of land use the simulation of water allocation per crop and county is also centered around the observations bracketing them in most cases within the high probability region of predictions 5 2 dynamics of the parameter ensemble using the parameter distributions obtained at the end of the spin up period as a starting point we assimilated remote sensing observations from 2009 through 2016 fig 9 shows the dynamics of the parameter ensembles for beaverhead county over the eight years of data assimilation note that the y axis has been re scaled with respect to that of fig 5 to better represent the ensemble spread figures for all counties are available in online appendix e in general parameters β l a n d and β w a t e r showed very high stability and very little dispersion over time with very small drifts in their mean value to a lesser degree parameter δ also presented relatively high stability but higher ensemble dispersion on the other hand λ l a n d λ w a t e r and the μ parameters showed large ensemble dispersion and high sensitivity to variations in the input observations the evolution of the parameters sometimes exhibited drifts over the data assimilation period e g parameter μ for spring wheat in fig 9 sudden realignments after a specific year e g the case of λ l a n d λ w a t e r for winter wheat and λ f s l in year 2010 or fluctuations about a long term mean without a clear trend e g parameter μ for winter wheat in fig 9 the dynamics of the innovation associated with the parameter ensembles in fig 9 were in general tightly centered around zero for most components reflecting the performance of the filter fig 10 the filter maintained most of the parameters at optimal values for operational use throughout the assimilation period components 1 and 2 of the innovation showed the highest variance but not significant biases the most significant departures of the ensemble from zero where for winter wheat but these were only transient although fig 10 represents the case for one county beaverhead county component 2 of the innovation was often the one that exhibited the largest amount of bias and variance over all counties see appendix f this component of the innovation is controlled by parameter λ w a t e r i which is one of the most sensitive parameters of the model and is key to correctly reproduce the correct allocation of water fig 11 and fig 12 show the state wide interannual variability of modeled land allocation and mean annual crop water use generated by running the model using the parameter ensemble obtained at the end of the assimilation period the figure shows time series obtained by averaging results over all counties during the 2008 2016 calibration period relative prediction biases and relative root mean square error statistics are given in table 3 the model captures the magnitude of the observed land allocation to each crop type and the share of land that is irrigated and non irrigated although some biases are apparent also especially in the case of alfalfa the model exhibits larger interannual variability than the observations fig 11a a small high bias and higher variability in modeled mean water use is also apparent fig 12 and table 3 the whiskers and shaded area in these figures are the interquartile range of the county level observations and predictions respectively and give us information of their spatial inter county variability in general the inter quartile range of observations and predictions is similar in the case of crop allocation fig 11 indicating that the model approximates the spatial distribution of the observations the simulations of crop water use fig 12 underestimate the observed spatial variability despite the biases the simulations clearly discriminate the crops that are prioritized by farmers and to simulate a spatial distribution that is on par with the predictions this is further shown in the next section which focuses on the simulation of two out of sample years 5 3 simulation of years 2017 and 2018 table 4 shows the relative bias and root mean square relative error rmsre of the mean predicted vs observed crop acreage and water allocation over all counties in montana for years 2017 and 2018 for these simulations the model was run with the parameter distribution obtained at the end of the 2008 2016 assimilation period year 2017 is associated with the abnormal conditions generated by the severe flash drought that affected the us northern plains in the summer of 2017 he et al 2019 kimball et al 2019 despite of this the results for the two simulated years are qualitatively very similar and therefore we only present and discuss the predictions for year 2017 the discussion of the results from 2017 also apply to the simulations of year 2018 the model satisfactorily reproduced the county scale distribution of cropping patterns fig 13 alfalfa is grown in all counties and the model predictions capture well the spatial distribution of land allocation for this crop fig 13 rows 1 and 2 note that the area planted with non irrigated alfalfa tends to be larger in the eastern third of the state because that region is characterized by large properties and extensive ranching this distribution is well captured in the model predictions on the other hand irrigated alfalfa is more common in the southern and southwest portions of the state in counties close to the border with wyoming and in the upstream end of the gallatin yellowstone and missouri rivers this is also correctly captured by the model also remarkable is the ability of the model to identify the regions in the state that specialize in small grain production the model correctly identifies the counties in the west and north west central region of montana that allocate the most land to irrigated and non irrigated barley fig 13 rows 3 and 4 it also identifies very well the swath of counties in the north and north east portions of the state that allocate the most land to grow spring wheat and winter wheat fig 13 rows 5 and 6 the spatial distribution of relative errors show some complex spatial patterns but in general relative errors in simulated area allocated to a crop are largest in counties where observations of area planted with a given crop are small because relative errors are normalized by these observations this causes the summary statistics presented in table 4 to be skewed by very large errors in a small number of counties this is particularly evident in the statistics of land allocated to irrigated barley and irrigated spring wheat where simulated land allocation tends to underestimate observations negative relative errors represented by blue colors in fig 13 but table 4 reports a large positive relative bias the extent of land allocated to irrigated crops is of course an indication of the agricultural water demands in general agricultural water use is higher in counties that are closer to the river headwaters counties in the headwaters of the missouri river and upstream tributaries jefferson madison and gallatin rivers see fig 3 in the southwestern quadrant of the state as well as counties in the upper course of the yellowstone river in south central montana have some of the highest agricultural water consumption in the state putting a significant amount of strain on the water supplies this agricultural water consumption pattern is clearly represented in the simulated total agricultural applications per county fig 14 the model underestimated the total agricultural water use in all counties negative relative errors however the relative underestimations are in general modest large relative errors in the predictions often occur in counties with relatively low observed supplemental irrigation counties with high agricultural water use are expected to have the largest impacts on the hydrologic system a strength of hydro economic model is that it tracks the hydrologic impacts of agricultural activity the spatial and temporal net effects of agricultural diversions on streamflows are shown in fig 15 insets in fig 15a show simulated streamflows with and without the effects of water diversions for year 2017 in four nodes of the river network and the simulated water diversion rates from these nodes during the growing season the standard profile of water diversion rates in all nodes followed the water demands associated with the progression of crops during the growing season water withdrawals start on the prescribed planting date of each crop which for most crops is around may 15 increase as crops grow to full coverage and finally taper down as crops mature before the prescribed harvesting date in late august the impacts of water withdrawals on streamflows starts during the spring freshet when streamflows are high but it is typically maximal in late june or early august during low summer flows when water diversions decline at the end of the summer the model simulates the recovery of streamflows the spatially distributed nature of the hydrologic model naturally simulates the downstream impacts of agricultural activity for instance the inset associated with the easternmost node in fig 15a is not a diversion node so there are no agricultural water withdrawals from this location however water diverted upstream still reduces the natural flows in late spring and summer to appreciate better the spatial extent of streamflow drawdowns we produced a visualization of the total net impact of agriculture on the hydrologic network in 2017 fig 15b the net impact δ streamflow was produced by calculating the total annual water volume difference between natural flows and flows under agricultural withdrawals unsurprisingly the most impacted river reaches are those that supply water to counties with high agricultural water applications such as those in the headwaters of the missouri river c f fig 14 however the impact of water diversion often extends far downstream affecting counties where agricultural water demands are low 6 discussion the implementation of the economic component of our hydro economic model uses the stochastic and recursive data assimilation framework based on the ensemble kalman filter proposed by maneta and howitt maneta and howitt 2014 however the new implementation adopts the form of the optimality conditions for calibration proposed by mérel et al 2011 and garnache et al 2017 the implementation of the positive mathematical programming methods proposed by these authors has two major advantages over the standard implementation used by maneta and howitt 2014 one advantage is that it eliminates the need to solve an initial linear constrained optimization problem to identify the unknown lagrange multipliers associated with land and water constraints howitt 1995 another important advantage is that it does not require a quadratic or exponential specification of the land cost function used in the standard implementation to provide the response function with the correct curvature howitt 1995 howitt et al 2012a our analysis demonstrates that information on land use crop evapotranspiration and crop production from existing and newer satellite based remote sensing products contain sufficient information to calibrate the hydro economic model presented here it also shows that the recursive data assimilation methodology is effective for filtering out observation noise and identifying the correct model parameters within a relatively small number of assimilation cycles furthermore the recursive updating nature of the filtering algorithm is ideal for model applications in non stationary systems because it adapts the model calibration to the realities of the regional agriculture variations in the model parameters over time may be indicative of changes in the economic behavior of farmers triggered by external factors that may not be directly or easily detectable from satellite based remote sensing information e g soil fertility or due to shifting farmer perception or management practices for instance the recursive calibration for beaverhead county fig 9 shows that parameter δ which represents the production returns to scale may be slowly increasing over time for nonirrigated alfalfa while remaining relatively stable for other crops values less than unity for this parameter indicate that crop production will increase exponentially less than a given increase in land and water allocated to this crop decreasing returns to scale reflect agricultural realities like the likelihood that crops expand to land of lessening quality or the diminishing returns of additional water applications when crops are irrigated near their optimal level upward trends of this parameter signal technical or management improvements over our study period that increase productivity returns from land and water inputs on the other hand parameter m u which is a factor that represents the efficiency of the production system seemed to decline for irrigated and non irrigated spring wheat declines in this factor indicate loss of county production in these crops that cannot be explained by a reduction in the amount of land and water allocated to these crops for instance if may signal loss of soil fertility or declines in other inputs not explicitly included in the model note that the sensitivity of the model parameters to new observations is dependent on the value of a in the parameter blending eq 13 this a factor was prescribed at a value of 0 94 for this analysis which provides a low level of smoothing and results in model parameter more responsive to new information lower values of a decrease the calibration sensitivity to new observations an important characteristic of economic models of agricultural production calibrated using the pmp methodology is that there is no need to know with precision the production costs because the calibration algorithm approximates unknown or unspecified production costs by adjusting the λ l a n d i and λ w a t e r i in our implementation of the optimality conditions negative λ i values for land or water indicate that there are unobserved benefits associated with these inputs which is to say that the observed production costs c l a n d i and c w a t e r i are overestimated conversely a positive λ i l value means that the observed production costs are under estimated in general and in the case of beaverhead county fig 9 irrigated crops typically have a negative value for λ w a t e r i while positive values are more common in non irrigated crops the capacity to estimate the value of λ w a t e r i is an important characteristic of the calibration method however this parameter is often the most unstable during the data assimilation process and probably one of the largest sources of uncertainty in model predictions as diagnosed by biases in component 2 of the innovation fig 10 errors in the identification of this parameter may be the largest source of bias in the predictions of water and land allocation for years 2017 and 2018 we found during our data assimilation experiments not presented in this study that the parameter ensembles are very sensitive to the uncertainty in some specific observations especially observations of yield elasticity π w and supply elasticity η if the noise to signal ratio in the observations was too high the ensemble of model parameters converged to a biased solution even if the observation errors were unbiased and this is one contributor to the prediction biases kanellopoulos et al 2010 did similar forecast experiments using two variants of the positive mathematical programming method and reported model prediction sensitivities to the supply elasticity parameters and biases in model forecasts commonly hydro economic models of agricultural production that are calibrated using any standard variation of the pmp methodology are verified by reproducing the same baseline observations used for calibration model predictions under conditions different from those of the baseline are rarely verified with actual observations before the model is used in the simulation of design scenarios graveline 2016 this is because the empirical nature of the positive mathematical programming method limits the application of models calibrated using this methodology to conditions that are not too different from those of the calibration our results show that the model has forecasting skill even under the unusual flash drought conditions of 2017 and can correctly reproduce the spatial patterns of land and water allocation at county scales albeit with some biases further research is necessary to understand the range of conditions under which the model still provides valid forecasts a major strength of our model is its ability to track the hydrologic impact of producer behavior in this demonstration we assumed that farmers can divert up to the maximum water diversions estimated over the calibration period we did not explicitly incorporate water rights and other institutional or technological constraints that may limit agricultural water diversions in some parts of the state these constraints however can partially be included by imposing a tighter limit on the total water available for irrigation the results showed that the hydrologic impacts of agricultural activity are maximal in early and mid august right before crops mature and water diversions start to decline this is also the period of lowest natural flows therefore agricultural water diversions can exacerbate ecological stress in streams during years of low summer flows however the simulations also show that the temporal impacts of diversions are circumscribed to the irrigation season and streamflows recover quickly after diversions cease due to contributions from the substantial groundwater available in many of montana s watersheds the simulations also show that diversions also have an extensive spatial impact and their impact propagates downstream from counties where irrigation is most prevalent such as these at the headwaters of the missouri gallatin and yellowstone rivers this pattern is correctly captured by the model however downstream impacts do not propagate unabated and the recovery of streams is clearly visible in some reaches downstream of diversion nodes fig 15 the recovery is caused by groundwater inflows into streams which are known to be a key contributor to the resilience of riverine ecosystems in the region groundwater is not yet extensively used as a source of water for irrigation in the region and this may be the reason why the impacts of agricultural diversions are limited in space and in time conjunctive management of surface and groundwater may therefore be desirable to maintain the strength and resilience of montana s rivers the results from the hydrologic component presented earlier are only meant to illustrate the capabilities of the coupled model and to provide a general view of the hydrologic impacts of agricultural activity in the region but some model limitations need to be taken into account when interpreting modeled streamflows for instance this model demonstration assumed 70 efficiency in the water conveyance system and the irrigation technology for all counties and does not take into account water right limits although the assumption of constant irrigation efficiency is common e g elbakidze et al 2012 this parameter varies between counties and years and can have an important impact on the actual timing of streamflows and on the total volume of diverted water model refinements to improve the representation of these efficiencies are of major interest for state water managers and are underway another limitation of the current hydrologic component is that it does not yet include the effects of water impoundments artificial storage in dams and reservoirs and their release rules can have a large impact on the regional streamflow dynamics and provide additional resiliency by buffering and redistributing the spring freshet over a longer period this model improvement is also a current priority 7 conclusions herein we describe the implementation of a hydro economic model composed of a stochastic economic model of agricultural production and a deterministic rainfall runoff and streamflow routing model that explicitly represents the spatial configuration of the regional water distribution network the spatially explicit nature of the hydrologic model allows for tracking hydrologic impacts of producer activity the economic component is designed to be continuously calibrated using remote sensing observations of land use crop evapotranspiration and crop production the calibration method is based on an implementation of the pmp methodology within a data assimilation framework that permits recursive update of the model parameters when new remote sensing information becomes available this new formulation of the calibration methodology eliminates some of the limitations that have previously hindered the use of hydro economic models to inform agricultural water management over large regions and temporal extents annual to multidecadal specifically the model was designed to eliminate the need for expensive field surveys reduce the problem of overfitting parameters to specific conditions of surveyed farms and years and reduce the false sense of precision that is associated with fully deterministic models we recognize the deterministic treatment of the hydrologic component as a current limitation of our modeling system a stochastic hydrologic component is desirable to control the impact of hydroclimatic uncertainty on model predictions further work is necessary to make the modeling system fully stochastic without impairing it with an excessive computational burden we demonstrate the usefulness of the model in analyzing water use and agricultural production in the state of montana we show that satellite based remote sensing retrievals of crop mix land use allocations water allocation and crop yield and other ancillary information freely available online contained sufficient information to correctly identify the parameters of the economic module an interesting aspect of the recursive nature of the data assimilation methodology is that it allows analysis of the dynamics of the parameter ensembles over time which may reveal trends in agronomic and environmental processes and in other factors that drive decision making and are hard to observe directly such as declines in land fertility existence of hidden production costs etc we calibrated the model with nine years of observations 2008 2016 and effectively reproduced the observed levels of resource allocation of the 2008 baseline year used to spin up the parameters the model also correctly predicted the spatial patterns of land and water allocation for years 2017 and 2018 finally we showed how the model can trace the effect of producer decision making on the regional hydrologic system this innovation could be an important tool to better understand how producer behavior affects water availability in the future and how agricultural water use at county scales propagates through the hydrologic system to impact downstream users the analysis of the time and propagation of streamflow drawdowns induced by agricultural water use may also help identify regions that are at higher risk of water shortage during droughts the model was designed to address a number of essential questions related to understanding the vulnerability of agriculture to water shortage and the environmental impacts associated with agricultural development and on farm adaptation in particular we specifically built this model to address how farmers will reallocate land and water to mitigate loss of revenues under future climate projections and a range of water policy scenarios for instance the model can simulate the reaction and impact of water access restrictions i e calls on senior water rights potential changes in water delivery pricing and or of the effect of reducing farm operation costs through government incentives and subsidies simulated results can inform future policy options that promote agricultural adaptation and a more efficient use of the regional water resources software availability the python modeling package presented in this work is available free of charge through the bitbucket repository https bitbucket org umthydromodeling dawuap git version 0 1beta the data assimilation water use and agricultural productivity dawuap package was developed by marco maneta marco maneta umontana edu and was made publicly available in april 2020 the package is written in pure python version 3 7 and has been tested within the anaconda python environment on linux and mac osx operating systems declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work has been supported by the united states department of agriculture usda nifa research grant 2016 67026 25067 and by the nasa epscor program research grant 80nssc18m0025 appendix a hydrologic model the hydrologic system is simulated using a rainfall runoff model coupled to a routing component that simulates streamflows in the regional stream network we adapted the hbv model bergstrom 1995 bergstrom and forsman 1973 to simulate subcatchment scale hydrologic processes snowmelt evapotranspiration infiltration and to transform precipitation into runoff and streamflow runoff that reaches the channel is routed through the stream network using the muskingum cunge routing algorithm chow and mays 1988 in this appendix we provide here a description of the implementation of the algorithms appendix a 1 rainfall runoff component the hvb model bergstrom 1995 bergstrom and forsman 1973 is implemented as a mixture of gridded and vector based operations to leverage the distributed nature of raster meteorological datasets while simultaneously taking advantage of the reduced computational burden of operating over polygons that aggregate runoff production over uniform hydrologic response units hrus snowpack accumulation and melt and soil processes are calculated over the uniform raster grid imposed by the meteorological inputs precipitation air temperature and potential evapotranspiration in the next two paragraphs subscript i indicates that the variable or parameter is spatially distributed and is represented at grid point i superscript t indicates that the variable is dynamic and its value is represented at time step t variables with no script or superscript indicate that the variable is spatially constant or time invariant precipitation and snowpack processes precipitation is partitioned between snowfall and rainfall using minimum and maximum daily air temperatures and a critical temperature threshold t c that determines the snow rain transition a 1 s n o w p t p p t t m a x p t t c p p p t t c p t m i n p t t m a x p t t m i n p t t m i n p t t c p t m a x p t 0 t m i n p t t c p a 2 r a i n i t p i t s n o w i t where p is precipitation mm d t m a x and t m i n are maximum and minimum air temperature c r a i n is liquid precipitation and s n o w is snowfall at pixel p during time step t mm d snowfall during day t contributes to the snow water equivalent s w e mm of the snowpack a 3 s w e p t s w e p t 1 s n o w p t δ t the snowpack melt process is simulated using a degree day factor model occurs when average air temperature exceeds an air temperature threshold t m a 4 m e l t p t d d f p t a v p t t m p for t a v p t t m p where m e l t is the amount of water output from the snowpack mm d 1 t a v is average air temperature over the time step c and d d f is the degree day factor mm d 1 c 1 an empirical parameter that represents the snowmelt rate per degree of air temperature above t m any melt form the snowpack during time t is subtracted from the snowpack storage s w e and added to the amount of water ponded in the surface a 6 p o n d p t p o n d p t 1 m e l t p t r a i n p t δ t a 7 s w e p t s w e p t m e l t p t δ t where p o n d mm is liquid water available on the surface to infiltrate or produce runoff soil processes recharge into the soil system occurs when liquid water ponding the surface infiltrates into the soil ponded water that is not infiltrated increases the topsoil compartment that generates fast runoff the fraction of ponded water that infiltrates into the soil is an exponential function of the relative water storage in the soil a 8 δ s m p t p o n d p t 1 s m p t f c p t β where s m mm is the amount of water in the soil compartment f c mm is the maximum amount of water soil can hold before water starts percolating to the groundwater system and b e t a dimensionless is an empirical parameter simultaneously actual evapotranspiration a e t mm d 1 reduces the amount of water storage in the soil and is also controlled by the degree of saturation of the soil ratio of s m to f c a 10 a e t p t p e t p t s m p t f c p l p p l where p e t is potential evapotranspiration mm d 1 and l is an empirical dimensionless parameter infiltration and actual evapotranspiration control the dynamics of water storage in the soil and amount of surface water that generates fast runoff a 12 s m p t s m p t δ s m p t a e t p t δ t a 13 o v l p t p o n d p t δ s m p t where o v l mm is water that recharges the upper near surface runoff generating compartment percolation and runoff generation excess water in the topsoil and in two groundwater compartments generate outflow that represent fast and intermediate runoff and baseflow these processes are implemented at the hru level for this calculations about overland flow generation and soil moisture performed at the grid level are averaged over subwatersheds representing hrus spatial arithmetic averaging soil water storage over all grid cells p contained within a given hru j is represented using angle brackets the mass balance and percolation of water from the soil upper to the soil lower zone is implemented as a 14 r e c h j t o v l p t j m a x s m p t f c p 0 j a 15 s u z j t s u z j t 1 r e c h j t p o n d j t q 0 j t δ t q 1 j δ t p e r c j a 16 s l z j t s l z j t 1 p e r c j q 2 j δ t r e c h mm is water storage in the near surface compartment that generates fast runoff s u z mm is the storage in the upper groundwater compartment and s l z mm is water storage in the lower deeper groundwater compartment in hru j at time step t q 0 q 1 and q 2 mm d 1 are specific runoff rates from the soil surface and the upper and lower soil zones a 17 q 0 j t m a x s u z j h l 1 j 1 c k 0 j 0 a 18 q 1 j t s u z j 1 c k 1 j a 19 q 2 j t s l z j 1 c k 2 j a 20 q a l l j t q 0 j t q 1 j t q 2 j t where h l 1 mm is an empirical water storage threshold the triggers the generation of fast runoff and c k 0 c 10 c k 2 d are empirical parameters representing the characteristic drainage time of each of the compartments total outflow from hru j on day t is distributed over time to produce the catchment response by convoluting the output of hru j by triangular standard unit hydrograph with base m b a s e a 21 q j t τ 1 m b a s e q a l l j t τ 1 u τ a 22 u τ 4 m b a s e 2 τ if 0 τ m b a s e 2 4 m b a s e 2 τ 4 m b a s e if m b a s e 2 τ m b a s e where u is a triangular hydrograph of area 1 and a base m b a s e d representing the hydrograph duration appendix a 2 routing component the response at the end of each h r u is routed through the stream network using the muskingum cunge routing model in this model the storage in each stream reach j is given by the following discharge storage equation a 23 s j t k e q i n 1 e q o u t which has parameters k d and e dimensionless controlling respectively the celerity and dispersion of the wave routed through the channel substituting this relationship in a finite difference form of the continuity equation s j t 1 s j t δ t q i n q o u t for a multi reach system with lateral inflows injected upstream of reach draining h r u j at average constant rate through time step t q j t 1 yields a 24 q j t 1 k j 1 e j 0 5 δ t q j 1 t 1 k j e j 0 5 δ t a 25 q j t k j 1 e j 0 5 δ t q j 1 t k j e j 0 5 δ t a 26 q j t 1 k j 1 e j 0 5 δ t each of the h r u s contains one reach with an upstream and a downstream node streamflows for each of the j 1 j reaches are integrated over time using a first order explicit finite difference scheme the system of j equations can be assembled as a linear system of the form a 27 a q t 1 b where q t 1 is the vector of unknown streamflows at time t 1 for each of the j reaches of the network that is solved each time step matrices a add b are functions of the model parameters and streamflows at timestep t a 28 a a φ b t a 29 b d φ c t q t i a q t 1 where φ is a j x j sparse connectivity 0 1 matrix where the elements indicate if two pairs of nodes are connected flow direction is from nodes in the rows to nodes in the columns rows representing the upstream node of h r u s that drain an outlet node exit the domain have all zero elements finally a 30 a i k k e d t 0 5 a 31 b i k e d t 0 5 a 32 c i k k e d t 0 5 a 33 d i k e d t 0 5 where i is the identity matrix of order j k and e are column vectors holding parameters k and e for each of the n reaches in the network the operator denotes the schur elementwise product between two vectors the solution of a 27 becomes unstable if δ t 2 k j 1 e j to ensure robust and stable solution an adaptive time stepping scheme was implemented in this scheme the default time step is reduced by an integer fraction until the stability condition is satisfied in all reaches appendix b economic model here we briefly outline the economic optimization program using the standard positive mathematical programming pmp following howitt 1995 mérel et al 2011 and garnache et al 2017 the economic program is implemented in two step in the first step parameters for the economic model are calibrated such that the program mimics the observed land and water use decisions in the second step the model simulates farmer s land use and water use responses given these model parameters along with other exogenous factors such as availability of supplemental irrigation water the following subsections briefly outline the calibration and the simulation process at each simulation time appendix b 1 calibration the fundamental aspect of our economic program is that farmers allocate resources with the objective of maximizing net revenues where the revenue function follows a generalized constant elasticity of substitution ces functional form b 1 max x l a n d i x w a t e r i p i i μ i β l a n d i x l a n d i ρ i β w a t e r i x p r e c i p i x w a t e r i ρ i δ i ρ i c l a n d i λ l a n d i x l a n d i c w a t e r i λ w a t e r i x w a t e r i subject to i x l a n d i l λ l a n d i x w a t e r i w λ w a t e r x l a n d i x w a t e r i 0 where i 1 i indexes crops l l a n d w a t e r indexes land and water inputs we differentiate water inputs into an exogenous component x p r e c i p i which captures water provided by natural sources like precipitation and an endogenous component x w a t e r i which captures supplemental irrigation water provision total water application will be the summation of the two i e x w a t e r i x p r e c i p i x w a t e r i the unknown parameters in equation b 1 are μ i β i l ρ i δ i λ i l λ 1 and the known values are η i exogenous supply elasticity for crop i change in supply over change in crop price π i observed crop production for crop i x l a n d i observed land allocation for crop i x w a t e r i observed et total for crop i y i w reference yield elasticity with respect to water for crop i change in production over change in total et σ i elasticity of substitution for crop i p i unit price of crop i c i l per unit input costs of production for crop i input l l total arable land w total amount of supplemental irrigation water available given the above maximization problem the unknown parameters can be calibrated via positive mathematical programming using the following set of calibration equations b 2 ρ i σ i 1 σ i for i 1 i η i δ i 1 δ i 1 b i δ i 1 δ i j b j δ j 1 δ j σ j b j y j w δ j δ j y j w for i 1 i where b i x l a n d i 2 p i π i π i w δ i β w a t e r i x w a t e r i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i for i 1 i β l a n d i β w a t e r i 1 for i 1 i π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i for i 1 i λ 1 i p i π i δ i y i w c l a n d i x l a n d i x l a n d i i x l a n d i 2 p i π i δ i y i w c l a n d i λ l a n d i λ 1 x l a n d i for i 1 i p i π i y i w c w a t e r i λ w a t e r i x w a t e r i for i 1 appendix b 2 simulation after calibrating the model parameters the optimization framework can now be used to analyze how farmer behaviors will change given changes in exogenous environmental and economic factors including water availability crop prices and production costs the simulation problem is given by the following maximization problem b 3 max x l a n d i x w a t e r i i p i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i c l a n d i λ l a n d i x l a n d i c w a t e r i λ w a t e r i x w a t e r i subject to i x l a n d i l λ l a n d i x w a t e r i w λ w a t e r and x w a t e r i 0 ξ i where the unknown values are x l a n d i x w a t e r i the land and water inputs for crop i π i the total production for crop i and λ l a n d λ w a t e r ξ the lagrangian multipliers the known values include μ i β i l ρ i δ i λ i l model parameters determined from the calibration equations p i c i l x p r e c i p i l w crop prices per unit production costs water from natural sources total arable land and total supplemental irrigation water same as in the calibration equation b 1 the simulation equations to solve the above maximization problem are given by b 4 p i δ i π i β l a n d i x l a n d i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i c l a n d i λ l a n d i λ 1 x l a n d i for i 1 i p i δ i π i β w a t e r i x w a t e r i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i c w a t e r i λ w a t e r i λ 2 ξ i x w a t e r i for i 1 i π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i for i 1 i i x l a n d i l for i 1 i i x w a t e r i w for i 1 i the simulation model will be able to recover farmers land and water use choices x l a n d i and x w a t e r i under the new set of exogenous conditions the model will also be able to recover shadow values with respect to land and water inputs λ l a n d and λ w a t e r note that this system of equations requires that the water constraint is binding if the water constraint is non binding complementary slackness conditions need to be built to allow for the case in which λ w a t e r 0 appendix c appendix tables table a1 supply elasticity estimates table a1 authors journal region elasticity alfalfa howitt et al 2012b env mod softw california 0 44 knapp working paper california 0 61 author s calculation 0 141 barley antle and capalbo 2001 am j ag econ northern plains 0 35 authors calculation 0 408 dropped maize hendricks et al 2014 am j ag econ iowa illinois indiana 0 40 short run hendricks et al 2014 am j ag econ iowa illinois indiana 0 29 long run arnade and kelch 2007 am j ag econ iowa 0 2 lin and dismukes 2007 rev ag econ north central region 0 17 linear model lin and dismukes 2007 rev ag econ north central region 0 35 acreage share model miao et al 2016 am j ag econ united states 0 68 chavas and holt 1990 am j ag econ north central region 0 15 howitt et al 2012b env mod softw california 0 55 chembezi and womack 1992 j ag applied econ united states 0 1 lee and helmberger 1985 am j ag econ united states 0 05 houck and gallagher 1976 am j ag econ united states 0 24 lower bound houck and gallagher 1976 am j ag econ united states 0 76 upper bound authors calculation a 0 762 wheat antle and capalbo 2001 am j ag econ northern plains 0 36 winter wheat antle and capalbo 2001 am j ag econ northern plains 0 14 spring wheat burt and worthington 1988 j ag res econ great plains 1 5 howitt et al 2012b environ model softw california 0 36 oehmke and yao 1990 am j ag econ us 0 4 sullivan et al 1989 usda report us 0 5 authors calculation 0 368 winter wheat authors calculation 0 409 spring wheat a we empirically calculate the supply elasticity using 22 with annual county level production and price statistics in the state of montana provided by the usda appendix b supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix b supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104836 
25949,the management of water resources among competing uses presents a complex technical and policy challenge integrated hydro economic models capable of simulating the hydrologic system in irrigated and non irrigated regions including the response of farmers to hydrologic constraints and economic and policy incentives provide a framework to understand biophysical and socioeconomic implications of changing water availability we present a transformative hydro economic model of agricultural production driven by multi sensor satellite observations outputs from regional climate models and socioeconomic data our approach overcomes the limitations of current decision support systems for agricultural water management and provides policymakers and natural resource managers with satellite data driven state wide operational models capable of anticipating how farmers allocate water land and other resources when confronted with new climate patterns policy rules or market signals the model can also quantify how farming decisions affect agricultural water supplies we demonstrate the model through an application in the state of montana keywords hydro economic models positive mathematical programming data assimilation decision support systems 1 introduction many productive agricultural regions in the world are characterized by highly variable inter annual precipitation groundwater supplies and stream flows this variability is increasing and expected to continue in an upward trend as climate changes groisman and easterling 1994 easterling et al 2000 mccabe and clark 2005 mote 2006 long et al 2013 correspondingly more frequent and intense droughts and more severe storm and runoff events will present new challenges for water managers harou et al 2006 gorelick and zheng 2015 as opportunities to develop new water supplies decline managers will need to improve the efficiency of the existing sources to satisfy growing demands us army corps of engineers and us army corps of engineers 2012 agriculture has a long history of adapting to variability in local conditions mccarl 2015 rose 2015 evidence to date suggests that farmers have met these challenges by changing their water allocations crop mix and land use practices schneider et al 2000 bryant et al 2000 menzel et al 2006 however little is known about how farmer adaptation alters natural hydrologic systems impacts water users downstream and how policy instruments encourage or impede adaptation white et al 2011 regional resource managers rely on modeling tools to inform decision making including hydro economic models that simulate the balance between the regional water supply system and anticipated demands from agricultural producers under a range of scenarios hydro economic models are integrated tools that incorporate the realities of water management systems including variable spatial impacts and dynamic demands influenced by economic and policy drivers harou et al 2009 these types of models have been a subject of research since the late 1990s pulido velazquez et al ward and lynch 1996 cai et al 2003 ward et al 2006 cai et al 2008 brouwer and hofkes 2008 medellín azuara et al 2011 elbakidze et al 2012 2018 and are one of the most promising tools for future integrated water management the research applications of these models capture the spatial and temporal inter dependency between water supply and demand in a hydro economic system in operational water management applications however they often do not incorporate these internal feedback mechanisms another limitation of current operational water management models is that they typically neglect the spatially explicit and dynamic nature of human actions often assuming that the behavior of one farmer does not affect the choices of other farmers downstream however upstream decision making is likely to influence the availability of water for downstream uses and the ability of downstream farmers to adapt to climate change maneta et al 2009a b adaptive behavior and spatially dynamic processes are rarely simulated because they are difficult to represent in models aerts et al 2018 wens et al 2019 an efficient way to achieve this is to incorporate human behavior into hydro economic models using a constrained optimization approach with farmer response functions calibrated to reflect previously observed decisions this optimization approach is followed by models calibrated using the positive mathematical programming pmp method howitt 1995 models calibrated using pmp have been widely applied to understand and optimize agricultural water allocation and for policy analysis maneta et al 2009b medellín azuara et al 2008 torres et al 2011 ghosh et al 2014 kahil et al 2015 heckelei et al 2012 graveline and merel 2014 connell buck et al 2011 medellín azuara et al 2011 us bureau of reclamation 2011 department of water resources 2009 cobourn and crescenti 2011 and can represent farmer behavior at a fraction of the complexity and computational requirements of other popular alternative approaches such as statistical econometric or agent based models wurster et al 2020 ng et al 2011 weersink et al 2002 an additional advantage of this approach is that the calibrated hydro economic models are more amenable to coupling with physically based models that represent the distributed regional hydrologic system this coupling is key to tracing the effects of farmer adaptation on natural systems over space and time pmp is a well established method of calibrating hydro economic models but its predictive capability hinges on the quality and quantity of the data that it uses to reflect observed farmer behavior the popularity of programming methods in operational hydro economic models has to some extent been limited by the availability of high quality data for calibration which is often derived from survey data collected on producer behavior due to the relatively high cost of administering surveys data collection efforts necessary to calibrate and refine hydro economic models are often focused on specific watersheds limiting the transferability and utility of these models among other problems if a surveyed sample of farmers or the specific year of the survey are not representative of a broader set of producers and long term conditions the calibration may have a bias toward a spatially and temporally narrow set of farm conditions an opportunity to overcome this limitation is to use satellite based remote sensing observations of agricultural activity spanning multiple years of recorded data the increased availability of high spatial resolution remotely sensed time series data allows for classification of crop types and land allocation trends usda nass 2015 retrieval of vegetation productivity information including for specific crops he et al 2018 mu et al 2009 and estimation of vegetation water use he et al 2019 zhang et al 2010 allen et al 2007 at a finer spatial and temporal scale and across a broader geographic scope than has been possible to date using survey instruments although remotely sensed data are subject to greater noise than survey data remote sensing retrievals of agricultural activity provide continuous annual observations over a long period of time and over large geographic extents stochastic recursive data assimilation methods provide a cost effective opportunity to estimate model parameters using uncertain but abundant remotely sensed observations of land and water allocated to crops maneta and howitt 2014 in this paper we present and demonstrate a hydro economic modeling framework that can be calibrated and applied over large regions by using recent advances in remote sensing and data assimilation methods to enable automatic model updates and calibration refinements this recursive and stochastic process is of interest because 1 it permits calibration of model parameters with frequent but noisy observations from satellite based remote sensors that are available free of charge at global extents this advance eliminates the cost of conducting expensive field surveys typically used for calibration and it avoids biases introduced in calibration if producer surveys do not adequately represent regional practices 2 the process permits refinement of model parameterization when new information becomes available without conducting a full batch retrospective calibration with the entire historical dataset 3 in addition the need to permanently store the historical dataset is eliminated 4 this process blends information from old and new observations with the option of emphasizing the most recent measurements making the model parameterization more relevant for current conditions 5 last the process provides an automatic assessment of prediction uncertainty thus avoiding the false sense of precision given by deterministic models these innovations overcome current limitations of hydro economic models and allow for the development of new insights into how farmers behave under resource and policy constraints herein we demonstrate the implementation of the hydro economic model and define its accuracy for hydrologic and agricultural systems in the state of montana these systems span a representative range of conditions in the western u s including extensive dryland agriculture that is particularly vulnerable to climate variability 2 model description 2 1 general approach our modeling package links an aggregated economic model of agricultural production operating at a seasonal scale to a hydrologic model that simulates rainfall runoff processes and water redistribution and availability in the regional streamflow network at daily time scales the hydrologic model provides physical constraints on water availability and propagates the hydrologic impacts of agricultural activity and decision making to downstream users the linked model is embedded in a stochastic data assimilation framework that facilitates adjustment of the economic model parameters when remote sensing observations of crop mix land use allocation yield evapotranspiration and other ancillary and hydrometric information become available fig 1 once the model is calibrated it can be used to simulate climatic and policy scenarios and make spatially explicit predictions of the impacts of these scenarios on land and water allocation crop yields the opportunity cost of water and on the hydrologic system the data assimilation framework allows us to use observations with high uncertainty typical of remote sensing observations and incorporate this observational uncertainty in the probability distributions of economic model parameters when the model is used for scenario analysis parameter uncertainty is propagated to produce the probability distribution of the model predictions currently only parameters and outputs from the economic component are treated as stochastic variables for computational reasons the hydrologic component and all hydroclimatic inputs to the economic component are deterministic 2 2 economic model of agriculture and farmer behavior the backbone of the economic component is a nonlinear constrained optimization model calibrated to capture observed producer behavior using the pmp method howitt 1995 the pmp approach is grounded in the assumption that producers allocate resources in our case land and water to maximize their net revenues subject to resource constraints 1 max x l a n d i x w a t e r i n e t i p i π i x l a n d i x w a t e r i μ i β l a n d i β w a t e r i ρ i δ i c l a n d i x l a n d i c w a t e r i x w a t e r i subject to i x l a n d i l λ l i x w a t e r i w λ w x l a n d i x w a t e r i 0 where n e t is net revenue defined as revenue less the costs of land and water use the index i 1 i represents crops x l a n d i x w a t e r i represent land and water resource inputs for crop i respectively p i is the price received for crop i π i is a production function that maps resource inputs to total production of crop i and c l a n d i c w a t e r i are the unit costs associated with land and water use to produce crop i the parameters μ β ρ δ are production function parameters calibrated using pmp the constraints in eq 1 state that the total land and water used for all crops in the region must be less than or equal to the total land l and water w available for cultivation and that resource allocation has to be non negative note that total water available for cultivation refers to irrigation water not precipitation the total land and water available for cultivation may be constrained by physical limits e g streamflow or by policy or other institutional constraints e g water rights or reservoir storage release policies consistent with the recent economic literature on pmp mérel et al 2011 we define the production function in eq 1 using a generalized constant elasticity of substitution ces functional form 2 π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i x p r e c i p i ρ i δ i ρ i a limitation of previous research in this area is that it has differentiated the production function in eq 2 for irrigated and non irrigated crops requiring independent calibration of each function e g maneta et al 2009b in this study we streamline calibration by incorporating a production function that can handle irrigated and non irrigated cases to do so we separate the total amount of water available to support crop growth into an exogenous component provided by natural sources like precipitation x p r e c i p i not controlled by the farmer and an endogenous component provided by supplemental irrigation x w a t e r i controlled by the farmer precipitation therefore acts as an offset to the total irrigation water applied to a crop and is not subject to the water availability constraint this formulation also allows us to differentiate the costs of providing water for crop production which differ depending on whether a year has relatively wet or dry conditions 2 3 hydrologic component the hydrologic component provides water availability constraints to agricultural production precipitation is transformed into runoff using a gridded version of the hydrologiska byråns vattenbalansavdelning hbv model bergstrom and forsman 1973 bergstrom 1995 lindström et al 1997 when runoff reaches the channel it is routed through the stream network using the muskingum cunge method cunge 1969 the hbv model and the muskingum cunge method are well known in the field of hydrology and because of their parsimonious nature reliability robustness and performance they have been widely applied in many regions of the world for hydrologic response analysis under climate change and drought driessen et al 2010 menzel and bürger 2002 hbv is a precipitation runoff model originally developed to assist in flood forecasting in sweden bergstrom and forsman 1973 the hydrologic system is conceptualized as a cascade of four compartments snowpack soil upper groundwater zone and lower groundwater zone in each of the hydrologic response units hrus in which the user may divide the region appendix a water outputs from the soil and groundwater compartments of each hru are transformed into runoff by convolution with a triangular unit hydrograph we implemented this particular application as a partially gridded version of the original model the model uses gridded raster daily precipitation and maximum and minimum daily air temperature to produce the aggregated spatially averaged runoff response of the different subcatchments composing the study area water ponded on the surface of pixel p at time t available for infiltration and for the generation of runoff represents the integration of water input rates from snowmelt m e l t p t rainfall r a i n p t and supplemental irrigation p p j t i r r if pixel p is in the set of pixels designated to be irrigated from water source j 3 p o n d p t p o n d p t 1 m e l t p t r a i n p t p p j t i r r δ t δ s m p t infiltration described in appendix a increases the water storage in the soil δ s m p t at pixel p and is aggregated over all pixels p within subcatchment l when water stored in the soil moisture compartment of subcatchment l reaches a threshold the excess water generates output or percolates to the groundwater compartment outputs from the soil and groundwater compartments produce the integrated response of the subcatchment a comprehensive description of our particular implementation of the model is provided in appendix a in total the hydrologic model tracks four internal states in each of the subcatchments snow water equivalent soil water storage water storage in the upper groundwater compartment and water storage in the deep water compartment the model has 12 parameters that can be potentially tuned details of the model structure and implementation are provided in appendix a the runoff response of each subcatchment becomes lateral water contributions into the stream reach contained in the subcatchment lateral runoff and inflows from upstream subcatchments are routed through the river network using the muskingum cunge model the muskingum model uses a two parameter constitutive equation to relate storage s in a reach to its inflows q i n and outflows q o u t s k e q i n 1 e q o u t where k and e are the two function parameters this constitutive relationship permits a mass balance equation for the reach as a function of streamflows and parameters the muskingum cunge method uses this relationship to develop a finite difference approximation of the 1d diffusion equation 4 q j t 1 k j 1 e j 0 5 δ t q j 1 t 1 k j e j 0 5 δ t q j t k j 1 e j 0 5 δ t q j 1 t k j e j 0 5 δ t q j t 1 q j i t 1 i r r k j 1 e j 0 5 δ t full details on the muskingum cunge algorithm and its implementation are provided in appendix a 2 4 model coupling the hydrologic component of the model operates deterministically at daily time steps and at variable spatial resolutions defined by the size of the hrus on the other hand the economic component operates stochastically at seasonal time steps and at spatial resolutions defined by counties districts or regions that may or may not be coincident with the hrus to couple the two components relevant information generated by one component needs to be adapted and spatially and temporally aggregated or disaggregated to match the resolution of the receiving component as described in this section at the beginning of each simulated year the economic component is run for each economic unit within the domain and the simulated probabilistic ensembles of land x l a n d i and irrigation water x w a t e r i allocated to each crop i for the growing season are determined the ensemble average of seasonal water allocations e x w a t e r i are temporally and spatially disaggregated and combined with information on irrigation and conveyance efficiencies to obtain expected daily diversion volumes from the hydrologic network and pixel level water application rates the temporal disaggregation of simulated seasonal water allocation for each crop i e x w a t e r i to daily water diversion rates from its source node j in the hydrologic network is achieved by redistributing the seasonal water allocation to daily amounts over the growing season according to a fractional weight coefficient ω i t 1 that reflects the growth stage of the crop at a given day 7 q j i t 1 i r r e x w a t e r i ω i t 1 i e f f i where 8 ω i t 1 k c i t 1 t k c i t 1 where q j i t 1 i r r is the water volume diverted for irrigation from river node j for crop i at day t 1 i e f f i is an irrigation and conveyance efficiency factor for crop i and ω i t 1 is a weight factor that represents the fraction of the total crop water requirement that correspond to day t 1 factor ω i t 1 is a function of crop coefficients k c that vary through the season from plant emergence to termination and reflect crop water requirements at a given stage relative to the water requirement of a fully developed reference crop we use crop coefficients and growth curve charts recommended by the u s bureau of reclamation for the pacific northwest region agrimet program 1 1 https www usbr gov pn agrimet cropcurves crop curves html computed daily diverted volumes enter the hydrologic model through eq 4 daily diverted water from each source node q j i t 1 i r r is subsequently spatially disaggregated and distributed to pixels identified as irrigated agriculture within the economic unit supplied by the diversion node application rates in each irrigated pixel are obtained by dividing daily diverted volumes by the irrigated area in the economic unit 9 p p j t 1 i r r i q j i t 1 i r r n p δ x 2 where p p j t i r r is the supplemental irrigation applied at time t on pixel p from the set of pixels classified as irrigated agriculture within the economic unit associated with diversion point j n p is the total number of pixels classified as irrigated agriculture within the economic units and δ x 2 is the pixel area computed daily water application rates p i r r enter the hydrologic model as supplemental irrigation in eq 3 since the model spatial resolution is typically too coarse to resolve individual crops irrigation is applied uniformly over all pixels p designed as irrigated crops within the corresponding economic unit 3 calibration of the economic component 3 1 positive mathematical programming the pmp approach assumes that farmers allocate limited land and water resources with the objective of maximizing net revenues and thus past observations of land and water use by crop x l a n d i x w a t e r i are solutions to the problem in eq 1 during calibration eq 1 is modified to constrain the maximization problem to the observed levels of land and water allocation 10 max x l a n d i x w a t e r i n e t i p i π i x l a n d i x w a t e r i μ i β l a n d i β w a t e r i ρ i δ i c l a n d i x l a n d i c w a t e r i x w a t e r i subject to i x l a n d i l λ f s l x l a n d i x l a n d i λ l a n d i x w a t e r i x w a t e r i λ w a t e r i x l a n d i x w a t e r i 0 eq 10 contains seven parameters per crop five production function parameters μ i β i l a n d β i w a t e r ρ i δ i and two lagrange multipliers associated with the observed land and water use constraints λ i l a n d λ i w a t e r for a total of 7 unknown parameters to be calibrated based on observed decision making an additional parameter λ f s l 0 associated with the land resource constraint also needs to be calibrated this parameter represents the shadow value for the total amount of land available for crop production the pmp methodology builds the system of optimality conditions associated with eq 10 however instead of solving the maximization problem to find optimal land and water resource allocation the method fixes these at the observed allocation levels and solves the system of optimality conditions for the model parameters in essence the pmp methodology finds the parameters that produce a response surface net revenue function that is maximum at the observed resource allocation levels x l a n d i x w a t e r i eq 10 is differentiable and traditionally solved using nonlinear programming methods necessary and sufficient optimality conditions are given by the first order derivatives of eq 10 with respect to x l a n d i and x w a t e r i the karush kuhn tucker conditions to enforce constraints and a few additional constraints to ensure the solution to the maximization problem exists and is unique a programming solution embedding the optimality conditions for eq 10 proposed by mérel et al 2011 and used in this study is provided in appendix b additionally we follow the calibration condition for λ f s l proposed by garnache et al 2017 based on minimizing squared deviations between modeled expenditures on inputs and expenditures implied by the observed use of inputs this deterministic program of optimality conditions can be arranged such as the observed quantities are grouped on the left hand side l h s and the quantities that depend on model parameters functions of model parameters are grouped on the right hand side r h s 11 p i π i π w i c l a n d i λ l a n d i λ f s l x l a n d i p i π i δ i p i π i π w i c w a t e r i λ w a t e r i x w a t e r i η i δ i 1 δ i 1 b i δ i 1 δ i i b i δ i 1 δ i σ i b i π w i δ i δ i π w i b i x l a n d i 2 p i π i π w i δ i β w a t e r i x w a t e r i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i i 0 i 2 x l a n d i p i π i m π w i m i 0 i 2 c l a n d i λ f s l x l a n d i 2 2 x l a n d i p i π i δ i 1 l h s β l a n d i β w a t e r i r h s during calibration the standard pmp solves this nonlinear program for the model parameters using a standard root finding algorithm 3 2 stochastic recursive parameter estimation in the stochastic approach we embed eq 11 within a stochastic data assimilation framework that permits the recursive calibration of the model parameters while taking into account the impact of observational errors the basic idea of the algorithm is to generate an ensemble of l h s quantities any time new observations are available by drawing samples from the probability distribution of the observations this l h s ensemble is compared with an ensemble of r h s quantities the ensemble of r h s quantities is generated by running the r h s functions using random samples from a model parameter distribution the difference between l h s and r h s is called the innovation and is a diagnostic of optimality over time as more observations are used the data assimilation algorithm adjusts updates the model parameter distribution to values that result in an innovation ensemble with mean zero this condition indicates that the parameter distribution satisfies the optimality conditions in the stochastic sense the key in this process is the parameter update algorithm which is presented in section 3 2 4 a schematic overview of the algorithm is shown in fig 2 maneta and howitt 2014 describe a discrete monte carlo recursive bayesian estimator that permits to update the parameters as new observations become available at time k in our application time k represents a year because observations of agricultural activity are available yearly the proposed methodology has three important advantages 1 its probabilistic nature permits to integrate noisy observations in the parameter estimation process making possible the use of remote sensing retrievals of agricultural activity for model calibration 2 it provides a posterior parameter distribution that reflects the quality of the information used for calibration and 3 it integrates new and old information when new observations are available without having to store or retrieve the old history of observations the equations of the estimator are based on the ensemble kalman filter enkf evensen 1994 where the probability distribution of parameters inputs and observations are represented by a monte carlo sample the exception is parameter ρ i a function of σ i which controls the elasticity of substitution between land and water this parameter is fixed at a value ρ i σ i 1 σ i with σ i values typically in the range of 0 1 0 6 which represents limited substitution between these two resources the reason for fixing this parameter is that elasticity of substitution has been found to be insensitive to aggregated observations and requires more detailed experimental data for its identification therefore our approach stochastically tracks seven parameters six parameters that need to be calibrated for each crop and one unit level resource constraint parameter λ f s l specifically the probability distribution of the model parameters θ μ β l a n d β w a t e r δ λ l a n d λ w a t e r λ f s l is represented by a random ensemble of m members m 1 m of θ except for λ f s l the unit level parameter each bold parameter in the θ set is an array with rows representing parameter values for each crop grown in a given economic unit e g county irrigation district and each column is an individual member of the ensemble the parameters of the generalized ces production function must satisfy the following constraints μ 0 β l a n d 0 β w a t e r 0 0 δ 1 and λ f s l 0 the parameters λ l a n d and λ w a t e r are unrestricted a positive value for the λ parameters reflects an unobserved cost associated with the use of an input whereas a negative value reflects an unobserved benefit as described by mérel et al 2014 3 2 1 prior parameter distribution parameter forecasts to set the filter equations we treat model parameters as if they were the system states of the standard enkf the evolution of parameters forecasts from period k to k 1 periods when observations become available typically yearly is produced by adding a random perturbation to each member of the ensemble the addition of artificial noise to each ensemble member to simulate time dynamics results in an overdispersed ensemble that overestimates the parameter variance west 1993 this is because the intrinsic variance of the ensemble is compounded by the noise added to each member to perform the random walk liu and west 1993 show that this can be corrected by using perturbations that are proportional to the ensemble variance by a number h slightly smaller than one and shrinking the ensemble toward its mean by a factor a 1 h for a given crop i the dynamics of members of the parameter ensemble with shrinkage is 12 β l a n d i k 1 m β w a t e r i k 1 m μ i k 1 m δ i k 1 m λ l a n d i k 1 m λ w a t e r i k 1 m λ f s l k 1 m θ i k 1 m a 0 0 μ i k m δ i k m λ l a n d i k m λ w a t e r i k m λ f s l k m 1 a 0 0 e μ i k e δ i k e λ l a n d i k e λ w a t e r i k e λ f s l k ζ i k β l a n d ζ i k β w a t e r ζ i k μ ζ i k δ ζ i k λ l a n d ζ i k λ w a t e r ζ k λ f s l ζ i k β l a n d b a i β l a n d k b i β l a n d k ζ i k β w a t e r b a i β w a t e r k b i β w a t e r k ζ i k μ n 0 h 2 v μ i k v μ k ζ i k δ n 0 h 2 v δ i k v δ k ζ i k λ l a n d n 0 h 2 v λ l a n d i k v λ l a n d k ζ i k λ w a t e r n 0 h 2 v λ w a t e r i k v λ w a t e r k ζ k λ f s l n 0 h 2 v λ f s l k v λ f s l k where superscript m over a parameter indicates it is the mth ensemble member at the time indicated by the subscript k and superscript indicates the parameter is corrected posterior after data assimilation at time k see below a and h are the shrinkage and variance smoothing parameters respectively e is the expectation operator of the parameter ensemble i e ensemble average for the given parameter and crop operator v is the parameter ensemble variance and v is a parameter level background variance that represents the parameter forecast processes noise v k and h are important tuning parameter that permits to control filter divergence and collapse parameters μ δ λ l a n d λ w a t e r and λ f s l are sampled using normally distributed noise however the β parameters are bound to values in the range 0 1 to sample the distribution of these parameters at k 1 we used a beta distribution with two shape parameters a ˆ b ˆ centered at each ensemble member the parameters that center the distribution at each member are determined using the method of moments from the mean and the variance of each individual ensemble member 13 a ˆ i β β i m β i m 1 β i m v β i k v β k 1 b ˆ i β 1 β i m a ˆ i β i where v β m is the variance of the ensemble v β k is the parameter background variance process noise and β i m is the mean of the kernel locations and 14 β i m a β i k m 1 a e β i k 3 2 2 generation of the observation l h s ensemble uncertainty in remote sensing observations of agricultural activity land and water allocations crop yield and yield elasticity as well as uncertainty in additional ancillary information crop supply elasticity crop price cost of operating land and cost of water obtained at time k 1 is represented by an ensemble with m observations of replicates obtained by sampling from a normal distribution centered at the observation 15 x l a n d i k 1 m x l a n d i ν l a n d i k 1 m ν l a n d i k 1 m n 0 r k 1 x l a n d x w a t e r i k 1 m x w a t e r i ν w a t e r i k 1 m ν w a t e r i k 1 m n 0 r k 1 x w a t e r π w i k 1 m π w i k 1 ν π w i k 1 m ν π w i k 1 m n 0 r k 1 π w π i k 1 m π i k 1 ν π i k 1 m ν π i k 1 m n 0 r k 1 π η i k 1 m η i k 1 ν η i k 1 m ν η i k 1 m n 0 r k 1 η p i k 1 m p i k 1 ν p i k 1 m ν p i k 1 m n 0 r k 1 p c l a n d i k 1 m c l a n d i ν c l a n d i k 1 m ν c l a n d i k 1 m n 0 r k 1 c l a n d c w a t e r i k 1 m c w a t e r i ν c w a t e r i k 1 m ν c w a t e r i k 1 m n 0 r k 1 c w a t e r where x l a n d i m x w a t e r i m π w i π w i and η i are observations of land and water used by crops elasticity of production to water inputs crop production and elasticity of production to crop prices respectively observations are scaled into a dimensionless quantity see section 3 3 using these observation replicates individual l h s i ensemble members of the stochastic system of optimality conditions are produced 16 l h s i k 1 m p i m π i m π w i m 1 p i m π i m π w i m 2 η i m 3 π w i m 4 π i m 5 i 0 i 2 x l a n d i m p i m π i m π w i m 6 1 7 0 8 0 9 k 1 where the first two elements are part of the calculation of the marginal costs of production the next two elements are observations of production elasticity to crop price and crop water use crop evapotranspiration as retrieved by remote sensing algorithms respectively the fifth element is the observations of crop production and the last three elements are the left hand side of three constraints to facilitate sampling β parameters such as β l a n d i β w a t e r i 1 β i 0 since all inputs are normalized the β parameters represent the fraction of production shared by the corresponding input the constraints on the β parameters form a convex sum of inputs that ensure that the production function outputs are always within the range of historical observations 3 2 3 generation of the model prediction r h s ensemble the r h s θ k 1 ensemble is a function of model parameters θ i k 1 using parameter and input replicates the right hand side equations are used to producean ensemble of model prediction counterparts to the observations in l h s i k 1 17 r h s θ i k 1 m c l a n d i m λ l a n d i m λ f s l m x l a n d i m p i m π i m δ i m 1 c w a t e r i m λ w a t e r i m x w a t e r i m 2 δ i m 1 δ i m 1 b i δ i m 1 δ i m i b i δ i m 1 δ i m σ i m b i π w i m δ i m δ i m π w i m b i x l a n d i m 2 p i m π i m 3 δ i m β w a t e r i m x w a t e r i m ρ i β l a n d i m x l a n d i m ρ i β w a t e r i m x w a t e r i m ρ i 4 μ i m β l a n d i m x l a n d i m ρ i β w a t e r i m x w a t e r i m ρ i δ i m ρ i 5 i 0 i 2 c l a n d i m λ f s l m x l a n d i m 2 2 x l a n d i m p i m π i m δ i m 6 β l a n d i m β w a t e r i m 7 β l a n d i m β l a n d i m 8 β w a t e r i m β w a t e r i m 9 k 1 the first two elements of l h s i m and r h s i m represent the difference between marginal costs of production and marginal revenues with respect to land and water marginal costs and marginal revenues are equal at the optimal point the next two elements of r h s i k 1 m are model predictions of production elasticity to crop price and production elasticity to crop water use respectively the fifth element is the observation of crop production the last three elements of l h s i m and r h s i m are constraints to facilitate sampling β parameters within the unit simplex such as 1 β l a n d i β w a t e r i β i 0 the last two constraints are the non negativity conditions non negative β samples only occur if the difference between the sample and its absolute is zero which is the condition expressed by the last two equations 3 2 4 assimilation equations posterior parameter distribution assimilation of new observations obtained at time k 1 to correct each member m of the parameter ensemble is achieved using the update equations of the enkf 18 θ i k 1 m θ i k 1 m k k 1 l h s i k 1 m r h s θ i k 1 m k k 1 c k 1 θ r h s c k 1 l h s c k 1 r h s 1 where θ i k 1 m is the corrected posterior mth member of the model parameters k k 1 is the kalman gain matrix that corrects the parameter trajectories l h s i k 1 m is the mth member of the ensemble of replicates of the left hand side of the system of optimality conditions which holds observation and other derived quantities r h s θ i k 1 m is the mth member of the ensemble of replicates of the right hand side of the optimality conditions which is a function of model parameters and holds predictions of the l h s c k 1 θ l h s is the cross covariance between the parameter ensemble and the rhs ensemble c k 1 l h s is the covariance of the lhs ensemble and c k 1 r h s is the covariance of the rhs ensemble the quantity between brackets in the top equation of 18 is the innovation and holds the model prediction errors a property of kalman filters is that when they are properly tuned the ensemble of parameters produce a sequence of innovations that is normally distributed with zero mean since lhs and rhs represent the left and right hand sides of the optimality conditions eq 18 is in effect solving the maximization problem posed in eq 1 the variance of the innovation is the total variance of the process associated with observation and parameter uncertainty 3 3 scaling observations and inputs if the β parameters are considered dimensionless share quantities the constant elasticity of substitution production function specified in eq 2 is dimensionally inconsistent and its results are not interpretable in terms of processes unless inputs are scaled and transformed to dimensionless quantities for a particular season the information needed to correct the model parameters for an economic unit include observations of land x l a n d i o b s ha and water x w a t e r i o b s mm ha 1 used by crop i crop price p i o b s t 1 the typical cost of cultivating crop i per unit of land c l a n d o b s ha 1 the cost of applying a unit of water including fees transportation application costs etc c w a t e r o b s mmha average crop yield over the economic unit y i o b s t ha 1 the elasticity of production to water π w i o b s dimensionless and the elasticity of production to crop prices η i o b s dimensionless the dimensionless observed quantities used in the data assimilation and parameter correction process are obtained by applying the following transformations 19 x l a n d i x l a n d i o b s x l a n d i r e f x w a t e r i x w a t e r i o b s e t i r e f x l a n d i r e f x p r e c i p i x p r e c i p i e s t e t i r e f π i y i o b s x l a n d i o b s y i r e f x l a n d i r e f p i p i o b s p i r e f c l a n d i c l a n d i o b s p i r e f y i r e f c w a t e r i c w a t e r i o b s e t i r e f p i r e f y i r e f where y i o b s is the mean observed yield in the economic unit kg ha x p r e c i p i e s t is the estimated or expected crop water use from natural water sources e g from precipitation in mm and x l a n d i r e f in ha e t i r e f in mm p i r e f in k g 1 and y i r e f in 1 are long term mean land used water price and yield observations used as reference scaling quantities for crop i note that the observed cost of water per unit volume c w a t e r i o b s only applies to artificial irrigation but is normalized using total crop evapotranspiration e t i r e f because it is what is retrieved by remote sensing products this normalization works because c w a t e r i o b s is constant regardless of the water volume used by crops and e t i r e f just serves the role of a normalization factor production elasticity to water and prices measures how responsive crop production is to used water and crop prices and is defined as a percent change in production over a percent change in used water or crop price defining π i o b s y i o b s x l a n d i o b s elasticities can be calculated from observations as 20 π w i δ π i o b s π i o b s δ x w a t e r i o b s x w a t e r i o b s d log π i o b s d log x w a t e r i o b s 21 η i δ π i o b s π i o b s δ p i o b s p i o b s d log π i o b s d log p i o b s elasticities are typically considered constant over a period of time and they can be obtained as the least squares regression slope between the logarithm of production and the logarithm of water used or the logarithm of crop prices over the considered period we calculate the production elasticity to water π w i in our study area empirically using 20 we constructed our crop specific supply elasticity using results from a series of previous studies summarized in table a1 appendix c in addition we supplemented published supply elasticity estimates with our own calculation from 21 applied using annual county level production and price statistics for the state of montana our empirical supply elasticity estimates were heuristically combined with published values based on the temporal recency and geographical proximity of the studies and based on expert judgment 3 4 economic component at simulation time the posterior parameter distribution obtained after the most recent assimilation step k is used in the production and cost functions of the net revenue eq 1 for each member in the parameter and input ensemble the maximization problem is solved this time for land and water allocation under any simulation scenario represented by an ensemble of crop prices production costs and land and water constraints 22 max x l a n d i m x w a t e r i m 0 n e t m i p i m π i m x l a n d i m x w a t e r i m x p r e c i p i m μ i k m β l a n d i k m β w a t e r i k m ρ i δ i k m c l a n d i m λ l a n d i k m λ f s l k m x l a n d i m c w a t e r i m λ w a t e r i k m x w a t e r i m subject to i x l a n d i m l m λ l a n d m i x w a t e r i m w m λ w a t e r m maximization of eq 22 for each member m of the parameter and input ensembles generate a result ensemble that represents the probability distribution of land and water allocated to each crop i as well as an ensemble of the lagrange multipliers λ l a n d m and λ w a t e r m associated with total land l and water w resource constraints imposed by physical availability or policy lagrange multipliers represent the opportunity cost associated with not having an additional unit of land or water and therefore can be interpreted as a metric of the value of land and water additionally solving eq 22 also produces the probability distribution of estimated crop production and of the probability distribution of production elasticity of supply and production elasticity of water inputs 4 application to montana we demonstrate the application of the model at regional scales in the state of montana located in the intermountain pacific northwest of the united states inset of fig 3 the study region extends beyond the boundaries of the state to include the headwaters of basins that drain into the state covering an area of 464 800 km 2 the state has a longitudinal topographic and climatic gradient from the steep and relatively wet rocky mountain western region toward the flatter and significantly drier eastern portions of the state which are part of the us northern great plains region the us continental divide runs roughly north to south along the west quarter of the state about 25 of montana drains to the pacific ocean clark fork river as part of the greater columbia river basin and the remainder of the state headwaters of the missouri river basin drains to the gulf of mexico annual precipitation inputs range from over 1000 mm in the mountain regions of the west and gradually decline to about 200 mm in eastern montana the western part of the state also shows less continentality with relatively warmer temperatures in the winter and cooler temperatures in the summer than the eastern portion of the state other than the ecosystem the largest water user in the state is agriculture agriculture is also the leading industry in the state despite its economic importance agriculture is poorly diversified and dominated in terms of production and planted area by alfalfa wheat and barley montana is a major producer of wheat and barley in the us and contributes to the country s food security irrigation is common along streams and in the western parts of the state however rainfed production is dominant and very vulnerable to drought in the drier central and eastern parts of the state irrigated area has been growing substantially in the state in recent decades and has contributed to increasing production and reduction in economic risk surface water is the primary source for irrigation including within irrigation districts and so far significant groundwater depletion due to agricultural extraction is only limited to a few localized watersheds whitlock et al 2017 4 1 implementation of hydrologic component the representation of the hydrologic system in the study region is shown in fig 3 the figure shows the representative elementary watersheds rews that compose the domain the nodes that define their outlets and the links stream reaches that connect them we used the gtopo30 digital elevation model dem produced by the usgs at 1 km resolution to determine the regional drainage network and partition the domain into rews using gis procedures we used the location of active national water information system streamflow gauges as the initial set of nodes to partition the landscape into rews and then further densified the network with additional nodes until we achieved sufficient spatial detail the densification was done by allocating nodes in pixels having contributing areas larger than a specified threshold the minimum contributing area for a rew was selected such that the total number and sizes of rews was considered adequate to resolve the spatial variability of streamflows the final domain contains over 300 rews with typical sizes around 1400 km 2 each rew in the domain has one stream reach with a from node and to node attribute that identify the upstream and downstream node of the reach this information is used to build the network topology and a node adjacency matrix that is used in the water routing algorithm described in appendix a water diversions occur at 56 selected river nodes one for each economic unit county included in the simulation we ran the model with daily gridded precipitation maximum and minimum air temperatures at a 4 km resolution automatically retrieved as netcdf files from the gridmet dataset abatzoglou 2013 temperatures are used internally by the model to calculate reference crop evapotranspiration using the hargreaves method george h hargreaves and zohrab a samani 1985 4 1 1 calibration of hydrologic component the hydrologic model parameters were calibrated manually against streamflow observations at gauged river nodes and against snow water equivalent observations from the snotel network all parameters of the hbv rainfall runoff model and muskingum cunge routing model were adjusted and shared between rews grouped according to their physiographical mean elevation mean slope area shape factor and land use characteristics fraction of the rew under forest cover and under agriculture using a standard k means classification method in total we calibrated seven groups of parameters corresponding to seven groups of rews 4 2 implementation of economic component although remote sensing can retrieve information about land and water allocation at field scales the specification of the economic component of our model is designed to simulate the aggregated economic behavior of producers in a region not the behavior of individual farmers the economic units considered in this implementation are aggregated at the county level thus we represent the agricultural system in montana using 56 economic units counties each of them retrieving water from the stream network at one designated diversion node although the economic activity is represented in aggregated form intra county agroeconomic heterogeneity is to some extent implicitly captured in the distribution of model predictions for each county 4 2 1 recursive calibration of the economic component information necessary to update the model parameters include land allocated to each crop total water used by each crop and total crop production this information is available every year from remote sensing products at 30 m spatial resolution and then aggregated at county scales in addition information on crop prices approximated variable unit costs of cultivating land and cost of applying water are also required table 1 crop price information and an approximation of production costs were obtained from annual surveys published by the us department of agriculture national agricultural statistics service usda nass at the state scale quickstats http quickstats nass usda gov crop coefficients to determine crop development stage were obtained from tables published by the agrimet network for crops grown in the us pacific northwest https www usbr gov pn agrimet cropcurves crop curves html annual variations in crop mix and area are obtained from the usda cropland data layer cdl usda nass 2015 published by the usda nass the cdl provides a satellite based remotely sensed annual crop specific land cover classification that resolves the type and location of the major summer crops in the conterminous us the cdl is available since 2003 for the conterminous us at 30 m spatial resolution since the unit of analysis of the economic component is the county we calculated total allocated land in each county for the main crops grown in montana alfalfa barley durum wheat spring wheat winter wheat maize and peas from 2009 to 2018 uncertainty in land allocation retrievals were estimated by scaling the average pixel level classification uncertainty standard deviation of each crop by the number of pixels allocated to the crop in the county fig 4 a shows an example of the cdl and the annual variations in allocated area for alfalfa barley spring wheat and winter wheat in two counties observations of crop production and yield defined as the ratio of production to area planted were obtained using a satellite driven light use efficiency model to estimate gross primary production gpp over croplands at 30 m resolution and 8 day time step the high spatial and temporal resolution necessary to delineate cropland vegetation growth was achieved by using a ndvi dataset that blended landsat 5 7 reflectance and terra modis reflectance crop yields each year were obtained by accumulating gpp over the growing season and applying a crop specific harvest index to convert primary production to yields he et al 2018 gives a full description and validation of this remote sensing product we calculated county scale annual crop production by multiplying crop yield times the area allocated to the crop in each county uncertainty in the county scale production estimates was obtained by scaling the spatial standard deviation of yields by the area planted fig 4c shows an example of the 30 m remotely sensed retrieved yield map and the annual variation of alfalfa barley spring wheat and winter wheat production from 2009 to 2018 in two counties crop water use was estimated by adapting an operational global et product nasa mod16a2 mu et al 2011 to better represent cropland et our adaptation of the mod16a2 product uses finer scale meteorological inputs from the gridmet product abatzoglou 2013 and the same refined 30 m resolution ndvi dataset used in the estimation of production the model parameters were also recalibrated for broadleaf crops and for cereal crops a complete description of the adaptation of mod16a2 et product for agricultural applications of the conterminous us is given by he et al 2019 annual variations in county scale crop specific water use volumes were calculated by accumulating pixel scale et over the growing season and at the county scale for each crop uncertainty in the county scale water use estimates was obtained by scaling the spatial standard deviation of crop et by the area planted fig 4b shows an example of the 30 m remotely sensed retrieved crop et map and the annual variation of total water volumes used by alfalfa barley spring wheat and winter wheat production from 2009 to 2018 in two counties note that crop water use includes both evapotranspiration from precipitation and from supplemental irrigation 4 3 analysis methods for this analysis we set the ensemble size m 300 to stabilize model parameters and start with correct optimal values at the beginning of the analysis period we first spun up the data assimilation process by repeatedly assimilating observations from 2008 first year in our data record until the posterior distribution of the model parameters converged we tuned the filter by manually adjusting the variance smoothing parameter h and the background parameter ensemble variance v k until the parameter ensemble resulted in land allocation prediction distributions that approximated the assumed distribution of land allocation observations in 2008 we found good results assuming v β l a n d k v β w a t e r k v δ k and v μ k were 0 01 of the square of their respective ensemble means we found v λ w a t e r k v λ l a n d k and v λ f s l k to be very sensitive to errors and required a smaller variance of about 0 0001 of the square of their respective ensemble means we also prescribed h 0 97 and a 0 94 low level of parameter smoothing after the spin up was complete e g parameters converged to their optimal or near optimal values from their arbitrary initial values we used the resulting model parameters to verify that they correctly reproduce the observed land and water allocations used to calibrate them after this verification we started the data assimilation process by sequentially ingesting observations from 2008 to 2016 observations from 2017 to 2018 were available but not ingested and used to verify the ability of the model to predict out of sample years we focused model verification and analysis mostly on predictions of land and water allocation since it is one of the most novel aspect of the modeling system however we also demonstrated the value added by the hydrologic component by identifying the net impact of agricultural water diversions in 2017 in the discussion section we provide a qualitative evaluation of the spatial impacts of agricultural water use 5 results 5 1 calibration and verification parameter spin up the results of the parameter spin up showed that for most counties the parameters could be accurately inferred from the assimilated observations an example for beaverhead county a county with a large extent of land allocated to agriculture and also first county alphabetically is shown in fig 5 results for all counties are presented in appendix a available online the ensemble was initiated before the spin up with an arbitrary mean and a large spread initial coefficient of variation of the ensemble was prescribed at 100 and the ensembles typically converged to a steady state distribution with within five to eight assimilation cycles fig 6 show the dynamics of the ensemble of innovations residual between eq 16 and eq 17 for the parameter evolution of beaverhead county shown in fig 5 the figure shows that the innovation quickly approaches zero which indicates that the parameter ensembles converge to a solution that satisfied the optimality conditions of the positive mathematical program eq b 2 the algorithm works because components 1 and 2 in eq 16 represent the marginal revenues with respect to land and water allocation and components 1 and 2 of eq 17 represent the respective marginal costs when the ensemble of differences between l h s i and r h s i is centered about zero the methodology is effectively solving the first order conditions of the net revenue maximization problem which is the core of the calibration algorithm online appendix b shows the evolution of the innovation ensembles associated with the parameter spin ups in all counties in the state of montana an inspection of this appendix shows that all innovations reliably have zero mean and a steady variance which are diagnostics of the correct performance and tuning of the filter the ensemble of parameters obtained at the end of the spin up cycle was used to predict the land and water allocation for the 2008 baseline the model was able predict mean land and water allocations in each county with satisfactory accuracy as summarized in table 2 the correlation coefficient between county wise simulated and observed land allocation is higher than 0 98 and the relative bias of the estimation is typically less than 0 06 6 a comparison between the predicted probability distributions of land and water allocation and observed allocations provides a direct evaluation of the model predictive skills for individual counties and also illustrates how parameter uncertainty translates into uncertainty in the predictions of resource allocation fig 7 shows the simulated probability distribution of land allocated to the crops grown in beaverhead county along with the observations the assumed uncertainty in the observed land allocation was used to tune the background variance of the parameters and provide additional confidence that the filter is correctly tuned online appendix c shows the simulated land allocation for all crops and counties in general for all counties and crops the predictive distributions are well centered around the observation and have a variance that approximate the assumed observational error comparison between observed and modeled water allocation for irrigation is less straightforward because water allocation per crop and county is not directly observed remote sensing et observations only provide total crop water use which integrates water from natural precipitation and from supplemental irrigation however the simulation scenarios require that the expected amount of water from natural sources used by crops natural et is specified subtracting this specified natural et amount from the total observed crop water use gives us an estimate of the amount of crop water use supplemented by irrigation this estimate served as the observation of supplemental irrigation used to evaluate the model simulation of water allocation fig 8 shows the case of beaverhead county figures for water allocation in all counties in the state are provided in online appendix d similar to the simulation of land use the simulation of water allocation per crop and county is also centered around the observations bracketing them in most cases within the high probability region of predictions 5 2 dynamics of the parameter ensemble using the parameter distributions obtained at the end of the spin up period as a starting point we assimilated remote sensing observations from 2009 through 2016 fig 9 shows the dynamics of the parameter ensembles for beaverhead county over the eight years of data assimilation note that the y axis has been re scaled with respect to that of fig 5 to better represent the ensemble spread figures for all counties are available in online appendix e in general parameters β l a n d and β w a t e r showed very high stability and very little dispersion over time with very small drifts in their mean value to a lesser degree parameter δ also presented relatively high stability but higher ensemble dispersion on the other hand λ l a n d λ w a t e r and the μ parameters showed large ensemble dispersion and high sensitivity to variations in the input observations the evolution of the parameters sometimes exhibited drifts over the data assimilation period e g parameter μ for spring wheat in fig 9 sudden realignments after a specific year e g the case of λ l a n d λ w a t e r for winter wheat and λ f s l in year 2010 or fluctuations about a long term mean without a clear trend e g parameter μ for winter wheat in fig 9 the dynamics of the innovation associated with the parameter ensembles in fig 9 were in general tightly centered around zero for most components reflecting the performance of the filter fig 10 the filter maintained most of the parameters at optimal values for operational use throughout the assimilation period components 1 and 2 of the innovation showed the highest variance but not significant biases the most significant departures of the ensemble from zero where for winter wheat but these were only transient although fig 10 represents the case for one county beaverhead county component 2 of the innovation was often the one that exhibited the largest amount of bias and variance over all counties see appendix f this component of the innovation is controlled by parameter λ w a t e r i which is one of the most sensitive parameters of the model and is key to correctly reproduce the correct allocation of water fig 11 and fig 12 show the state wide interannual variability of modeled land allocation and mean annual crop water use generated by running the model using the parameter ensemble obtained at the end of the assimilation period the figure shows time series obtained by averaging results over all counties during the 2008 2016 calibration period relative prediction biases and relative root mean square error statistics are given in table 3 the model captures the magnitude of the observed land allocation to each crop type and the share of land that is irrigated and non irrigated although some biases are apparent also especially in the case of alfalfa the model exhibits larger interannual variability than the observations fig 11a a small high bias and higher variability in modeled mean water use is also apparent fig 12 and table 3 the whiskers and shaded area in these figures are the interquartile range of the county level observations and predictions respectively and give us information of their spatial inter county variability in general the inter quartile range of observations and predictions is similar in the case of crop allocation fig 11 indicating that the model approximates the spatial distribution of the observations the simulations of crop water use fig 12 underestimate the observed spatial variability despite the biases the simulations clearly discriminate the crops that are prioritized by farmers and to simulate a spatial distribution that is on par with the predictions this is further shown in the next section which focuses on the simulation of two out of sample years 5 3 simulation of years 2017 and 2018 table 4 shows the relative bias and root mean square relative error rmsre of the mean predicted vs observed crop acreage and water allocation over all counties in montana for years 2017 and 2018 for these simulations the model was run with the parameter distribution obtained at the end of the 2008 2016 assimilation period year 2017 is associated with the abnormal conditions generated by the severe flash drought that affected the us northern plains in the summer of 2017 he et al 2019 kimball et al 2019 despite of this the results for the two simulated years are qualitatively very similar and therefore we only present and discuss the predictions for year 2017 the discussion of the results from 2017 also apply to the simulations of year 2018 the model satisfactorily reproduced the county scale distribution of cropping patterns fig 13 alfalfa is grown in all counties and the model predictions capture well the spatial distribution of land allocation for this crop fig 13 rows 1 and 2 note that the area planted with non irrigated alfalfa tends to be larger in the eastern third of the state because that region is characterized by large properties and extensive ranching this distribution is well captured in the model predictions on the other hand irrigated alfalfa is more common in the southern and southwest portions of the state in counties close to the border with wyoming and in the upstream end of the gallatin yellowstone and missouri rivers this is also correctly captured by the model also remarkable is the ability of the model to identify the regions in the state that specialize in small grain production the model correctly identifies the counties in the west and north west central region of montana that allocate the most land to irrigated and non irrigated barley fig 13 rows 3 and 4 it also identifies very well the swath of counties in the north and north east portions of the state that allocate the most land to grow spring wheat and winter wheat fig 13 rows 5 and 6 the spatial distribution of relative errors show some complex spatial patterns but in general relative errors in simulated area allocated to a crop are largest in counties where observations of area planted with a given crop are small because relative errors are normalized by these observations this causes the summary statistics presented in table 4 to be skewed by very large errors in a small number of counties this is particularly evident in the statistics of land allocated to irrigated barley and irrigated spring wheat where simulated land allocation tends to underestimate observations negative relative errors represented by blue colors in fig 13 but table 4 reports a large positive relative bias the extent of land allocated to irrigated crops is of course an indication of the agricultural water demands in general agricultural water use is higher in counties that are closer to the river headwaters counties in the headwaters of the missouri river and upstream tributaries jefferson madison and gallatin rivers see fig 3 in the southwestern quadrant of the state as well as counties in the upper course of the yellowstone river in south central montana have some of the highest agricultural water consumption in the state putting a significant amount of strain on the water supplies this agricultural water consumption pattern is clearly represented in the simulated total agricultural applications per county fig 14 the model underestimated the total agricultural water use in all counties negative relative errors however the relative underestimations are in general modest large relative errors in the predictions often occur in counties with relatively low observed supplemental irrigation counties with high agricultural water use are expected to have the largest impacts on the hydrologic system a strength of hydro economic model is that it tracks the hydrologic impacts of agricultural activity the spatial and temporal net effects of agricultural diversions on streamflows are shown in fig 15 insets in fig 15a show simulated streamflows with and without the effects of water diversions for year 2017 in four nodes of the river network and the simulated water diversion rates from these nodes during the growing season the standard profile of water diversion rates in all nodes followed the water demands associated with the progression of crops during the growing season water withdrawals start on the prescribed planting date of each crop which for most crops is around may 15 increase as crops grow to full coverage and finally taper down as crops mature before the prescribed harvesting date in late august the impacts of water withdrawals on streamflows starts during the spring freshet when streamflows are high but it is typically maximal in late june or early august during low summer flows when water diversions decline at the end of the summer the model simulates the recovery of streamflows the spatially distributed nature of the hydrologic model naturally simulates the downstream impacts of agricultural activity for instance the inset associated with the easternmost node in fig 15a is not a diversion node so there are no agricultural water withdrawals from this location however water diverted upstream still reduces the natural flows in late spring and summer to appreciate better the spatial extent of streamflow drawdowns we produced a visualization of the total net impact of agriculture on the hydrologic network in 2017 fig 15b the net impact δ streamflow was produced by calculating the total annual water volume difference between natural flows and flows under agricultural withdrawals unsurprisingly the most impacted river reaches are those that supply water to counties with high agricultural water applications such as those in the headwaters of the missouri river c f fig 14 however the impact of water diversion often extends far downstream affecting counties where agricultural water demands are low 6 discussion the implementation of the economic component of our hydro economic model uses the stochastic and recursive data assimilation framework based on the ensemble kalman filter proposed by maneta and howitt maneta and howitt 2014 however the new implementation adopts the form of the optimality conditions for calibration proposed by mérel et al 2011 and garnache et al 2017 the implementation of the positive mathematical programming methods proposed by these authors has two major advantages over the standard implementation used by maneta and howitt 2014 one advantage is that it eliminates the need to solve an initial linear constrained optimization problem to identify the unknown lagrange multipliers associated with land and water constraints howitt 1995 another important advantage is that it does not require a quadratic or exponential specification of the land cost function used in the standard implementation to provide the response function with the correct curvature howitt 1995 howitt et al 2012a our analysis demonstrates that information on land use crop evapotranspiration and crop production from existing and newer satellite based remote sensing products contain sufficient information to calibrate the hydro economic model presented here it also shows that the recursive data assimilation methodology is effective for filtering out observation noise and identifying the correct model parameters within a relatively small number of assimilation cycles furthermore the recursive updating nature of the filtering algorithm is ideal for model applications in non stationary systems because it adapts the model calibration to the realities of the regional agriculture variations in the model parameters over time may be indicative of changes in the economic behavior of farmers triggered by external factors that may not be directly or easily detectable from satellite based remote sensing information e g soil fertility or due to shifting farmer perception or management practices for instance the recursive calibration for beaverhead county fig 9 shows that parameter δ which represents the production returns to scale may be slowly increasing over time for nonirrigated alfalfa while remaining relatively stable for other crops values less than unity for this parameter indicate that crop production will increase exponentially less than a given increase in land and water allocated to this crop decreasing returns to scale reflect agricultural realities like the likelihood that crops expand to land of lessening quality or the diminishing returns of additional water applications when crops are irrigated near their optimal level upward trends of this parameter signal technical or management improvements over our study period that increase productivity returns from land and water inputs on the other hand parameter m u which is a factor that represents the efficiency of the production system seemed to decline for irrigated and non irrigated spring wheat declines in this factor indicate loss of county production in these crops that cannot be explained by a reduction in the amount of land and water allocated to these crops for instance if may signal loss of soil fertility or declines in other inputs not explicitly included in the model note that the sensitivity of the model parameters to new observations is dependent on the value of a in the parameter blending eq 13 this a factor was prescribed at a value of 0 94 for this analysis which provides a low level of smoothing and results in model parameter more responsive to new information lower values of a decrease the calibration sensitivity to new observations an important characteristic of economic models of agricultural production calibrated using the pmp methodology is that there is no need to know with precision the production costs because the calibration algorithm approximates unknown or unspecified production costs by adjusting the λ l a n d i and λ w a t e r i in our implementation of the optimality conditions negative λ i values for land or water indicate that there are unobserved benefits associated with these inputs which is to say that the observed production costs c l a n d i and c w a t e r i are overestimated conversely a positive λ i l value means that the observed production costs are under estimated in general and in the case of beaverhead county fig 9 irrigated crops typically have a negative value for λ w a t e r i while positive values are more common in non irrigated crops the capacity to estimate the value of λ w a t e r i is an important characteristic of the calibration method however this parameter is often the most unstable during the data assimilation process and probably one of the largest sources of uncertainty in model predictions as diagnosed by biases in component 2 of the innovation fig 10 errors in the identification of this parameter may be the largest source of bias in the predictions of water and land allocation for years 2017 and 2018 we found during our data assimilation experiments not presented in this study that the parameter ensembles are very sensitive to the uncertainty in some specific observations especially observations of yield elasticity π w and supply elasticity η if the noise to signal ratio in the observations was too high the ensemble of model parameters converged to a biased solution even if the observation errors were unbiased and this is one contributor to the prediction biases kanellopoulos et al 2010 did similar forecast experiments using two variants of the positive mathematical programming method and reported model prediction sensitivities to the supply elasticity parameters and biases in model forecasts commonly hydro economic models of agricultural production that are calibrated using any standard variation of the pmp methodology are verified by reproducing the same baseline observations used for calibration model predictions under conditions different from those of the baseline are rarely verified with actual observations before the model is used in the simulation of design scenarios graveline 2016 this is because the empirical nature of the positive mathematical programming method limits the application of models calibrated using this methodology to conditions that are not too different from those of the calibration our results show that the model has forecasting skill even under the unusual flash drought conditions of 2017 and can correctly reproduce the spatial patterns of land and water allocation at county scales albeit with some biases further research is necessary to understand the range of conditions under which the model still provides valid forecasts a major strength of our model is its ability to track the hydrologic impact of producer behavior in this demonstration we assumed that farmers can divert up to the maximum water diversions estimated over the calibration period we did not explicitly incorporate water rights and other institutional or technological constraints that may limit agricultural water diversions in some parts of the state these constraints however can partially be included by imposing a tighter limit on the total water available for irrigation the results showed that the hydrologic impacts of agricultural activity are maximal in early and mid august right before crops mature and water diversions start to decline this is also the period of lowest natural flows therefore agricultural water diversions can exacerbate ecological stress in streams during years of low summer flows however the simulations also show that the temporal impacts of diversions are circumscribed to the irrigation season and streamflows recover quickly after diversions cease due to contributions from the substantial groundwater available in many of montana s watersheds the simulations also show that diversions also have an extensive spatial impact and their impact propagates downstream from counties where irrigation is most prevalent such as these at the headwaters of the missouri gallatin and yellowstone rivers this pattern is correctly captured by the model however downstream impacts do not propagate unabated and the recovery of streams is clearly visible in some reaches downstream of diversion nodes fig 15 the recovery is caused by groundwater inflows into streams which are known to be a key contributor to the resilience of riverine ecosystems in the region groundwater is not yet extensively used as a source of water for irrigation in the region and this may be the reason why the impacts of agricultural diversions are limited in space and in time conjunctive management of surface and groundwater may therefore be desirable to maintain the strength and resilience of montana s rivers the results from the hydrologic component presented earlier are only meant to illustrate the capabilities of the coupled model and to provide a general view of the hydrologic impacts of agricultural activity in the region but some model limitations need to be taken into account when interpreting modeled streamflows for instance this model demonstration assumed 70 efficiency in the water conveyance system and the irrigation technology for all counties and does not take into account water right limits although the assumption of constant irrigation efficiency is common e g elbakidze et al 2012 this parameter varies between counties and years and can have an important impact on the actual timing of streamflows and on the total volume of diverted water model refinements to improve the representation of these efficiencies are of major interest for state water managers and are underway another limitation of the current hydrologic component is that it does not yet include the effects of water impoundments artificial storage in dams and reservoirs and their release rules can have a large impact on the regional streamflow dynamics and provide additional resiliency by buffering and redistributing the spring freshet over a longer period this model improvement is also a current priority 7 conclusions herein we describe the implementation of a hydro economic model composed of a stochastic economic model of agricultural production and a deterministic rainfall runoff and streamflow routing model that explicitly represents the spatial configuration of the regional water distribution network the spatially explicit nature of the hydrologic model allows for tracking hydrologic impacts of producer activity the economic component is designed to be continuously calibrated using remote sensing observations of land use crop evapotranspiration and crop production the calibration method is based on an implementation of the pmp methodology within a data assimilation framework that permits recursive update of the model parameters when new remote sensing information becomes available this new formulation of the calibration methodology eliminates some of the limitations that have previously hindered the use of hydro economic models to inform agricultural water management over large regions and temporal extents annual to multidecadal specifically the model was designed to eliminate the need for expensive field surveys reduce the problem of overfitting parameters to specific conditions of surveyed farms and years and reduce the false sense of precision that is associated with fully deterministic models we recognize the deterministic treatment of the hydrologic component as a current limitation of our modeling system a stochastic hydrologic component is desirable to control the impact of hydroclimatic uncertainty on model predictions further work is necessary to make the modeling system fully stochastic without impairing it with an excessive computational burden we demonstrate the usefulness of the model in analyzing water use and agricultural production in the state of montana we show that satellite based remote sensing retrievals of crop mix land use allocations water allocation and crop yield and other ancillary information freely available online contained sufficient information to correctly identify the parameters of the economic module an interesting aspect of the recursive nature of the data assimilation methodology is that it allows analysis of the dynamics of the parameter ensembles over time which may reveal trends in agronomic and environmental processes and in other factors that drive decision making and are hard to observe directly such as declines in land fertility existence of hidden production costs etc we calibrated the model with nine years of observations 2008 2016 and effectively reproduced the observed levels of resource allocation of the 2008 baseline year used to spin up the parameters the model also correctly predicted the spatial patterns of land and water allocation for years 2017 and 2018 finally we showed how the model can trace the effect of producer decision making on the regional hydrologic system this innovation could be an important tool to better understand how producer behavior affects water availability in the future and how agricultural water use at county scales propagates through the hydrologic system to impact downstream users the analysis of the time and propagation of streamflow drawdowns induced by agricultural water use may also help identify regions that are at higher risk of water shortage during droughts the model was designed to address a number of essential questions related to understanding the vulnerability of agriculture to water shortage and the environmental impacts associated with agricultural development and on farm adaptation in particular we specifically built this model to address how farmers will reallocate land and water to mitigate loss of revenues under future climate projections and a range of water policy scenarios for instance the model can simulate the reaction and impact of water access restrictions i e calls on senior water rights potential changes in water delivery pricing and or of the effect of reducing farm operation costs through government incentives and subsidies simulated results can inform future policy options that promote agricultural adaptation and a more efficient use of the regional water resources software availability the python modeling package presented in this work is available free of charge through the bitbucket repository https bitbucket org umthydromodeling dawuap git version 0 1beta the data assimilation water use and agricultural productivity dawuap package was developed by marco maneta marco maneta umontana edu and was made publicly available in april 2020 the package is written in pure python version 3 7 and has been tested within the anaconda python environment on linux and mac osx operating systems declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work has been supported by the united states department of agriculture usda nifa research grant 2016 67026 25067 and by the nasa epscor program research grant 80nssc18m0025 appendix a hydrologic model the hydrologic system is simulated using a rainfall runoff model coupled to a routing component that simulates streamflows in the regional stream network we adapted the hbv model bergstrom 1995 bergstrom and forsman 1973 to simulate subcatchment scale hydrologic processes snowmelt evapotranspiration infiltration and to transform precipitation into runoff and streamflow runoff that reaches the channel is routed through the stream network using the muskingum cunge routing algorithm chow and mays 1988 in this appendix we provide here a description of the implementation of the algorithms appendix a 1 rainfall runoff component the hvb model bergstrom 1995 bergstrom and forsman 1973 is implemented as a mixture of gridded and vector based operations to leverage the distributed nature of raster meteorological datasets while simultaneously taking advantage of the reduced computational burden of operating over polygons that aggregate runoff production over uniform hydrologic response units hrus snowpack accumulation and melt and soil processes are calculated over the uniform raster grid imposed by the meteorological inputs precipitation air temperature and potential evapotranspiration in the next two paragraphs subscript i indicates that the variable or parameter is spatially distributed and is represented at grid point i superscript t indicates that the variable is dynamic and its value is represented at time step t variables with no script or superscript indicate that the variable is spatially constant or time invariant precipitation and snowpack processes precipitation is partitioned between snowfall and rainfall using minimum and maximum daily air temperatures and a critical temperature threshold t c that determines the snow rain transition a 1 s n o w p t p p t t m a x p t t c p p p t t c p t m i n p t t m a x p t t m i n p t t m i n p t t c p t m a x p t 0 t m i n p t t c p a 2 r a i n i t p i t s n o w i t where p is precipitation mm d t m a x and t m i n are maximum and minimum air temperature c r a i n is liquid precipitation and s n o w is snowfall at pixel p during time step t mm d snowfall during day t contributes to the snow water equivalent s w e mm of the snowpack a 3 s w e p t s w e p t 1 s n o w p t δ t the snowpack melt process is simulated using a degree day factor model occurs when average air temperature exceeds an air temperature threshold t m a 4 m e l t p t d d f p t a v p t t m p for t a v p t t m p where m e l t is the amount of water output from the snowpack mm d 1 t a v is average air temperature over the time step c and d d f is the degree day factor mm d 1 c 1 an empirical parameter that represents the snowmelt rate per degree of air temperature above t m any melt form the snowpack during time t is subtracted from the snowpack storage s w e and added to the amount of water ponded in the surface a 6 p o n d p t p o n d p t 1 m e l t p t r a i n p t δ t a 7 s w e p t s w e p t m e l t p t δ t where p o n d mm is liquid water available on the surface to infiltrate or produce runoff soil processes recharge into the soil system occurs when liquid water ponding the surface infiltrates into the soil ponded water that is not infiltrated increases the topsoil compartment that generates fast runoff the fraction of ponded water that infiltrates into the soil is an exponential function of the relative water storage in the soil a 8 δ s m p t p o n d p t 1 s m p t f c p t β where s m mm is the amount of water in the soil compartment f c mm is the maximum amount of water soil can hold before water starts percolating to the groundwater system and b e t a dimensionless is an empirical parameter simultaneously actual evapotranspiration a e t mm d 1 reduces the amount of water storage in the soil and is also controlled by the degree of saturation of the soil ratio of s m to f c a 10 a e t p t p e t p t s m p t f c p l p p l where p e t is potential evapotranspiration mm d 1 and l is an empirical dimensionless parameter infiltration and actual evapotranspiration control the dynamics of water storage in the soil and amount of surface water that generates fast runoff a 12 s m p t s m p t δ s m p t a e t p t δ t a 13 o v l p t p o n d p t δ s m p t where o v l mm is water that recharges the upper near surface runoff generating compartment percolation and runoff generation excess water in the topsoil and in two groundwater compartments generate outflow that represent fast and intermediate runoff and baseflow these processes are implemented at the hru level for this calculations about overland flow generation and soil moisture performed at the grid level are averaged over subwatersheds representing hrus spatial arithmetic averaging soil water storage over all grid cells p contained within a given hru j is represented using angle brackets the mass balance and percolation of water from the soil upper to the soil lower zone is implemented as a 14 r e c h j t o v l p t j m a x s m p t f c p 0 j a 15 s u z j t s u z j t 1 r e c h j t p o n d j t q 0 j t δ t q 1 j δ t p e r c j a 16 s l z j t s l z j t 1 p e r c j q 2 j δ t r e c h mm is water storage in the near surface compartment that generates fast runoff s u z mm is the storage in the upper groundwater compartment and s l z mm is water storage in the lower deeper groundwater compartment in hru j at time step t q 0 q 1 and q 2 mm d 1 are specific runoff rates from the soil surface and the upper and lower soil zones a 17 q 0 j t m a x s u z j h l 1 j 1 c k 0 j 0 a 18 q 1 j t s u z j 1 c k 1 j a 19 q 2 j t s l z j 1 c k 2 j a 20 q a l l j t q 0 j t q 1 j t q 2 j t where h l 1 mm is an empirical water storage threshold the triggers the generation of fast runoff and c k 0 c 10 c k 2 d are empirical parameters representing the characteristic drainage time of each of the compartments total outflow from hru j on day t is distributed over time to produce the catchment response by convoluting the output of hru j by triangular standard unit hydrograph with base m b a s e a 21 q j t τ 1 m b a s e q a l l j t τ 1 u τ a 22 u τ 4 m b a s e 2 τ if 0 τ m b a s e 2 4 m b a s e 2 τ 4 m b a s e if m b a s e 2 τ m b a s e where u is a triangular hydrograph of area 1 and a base m b a s e d representing the hydrograph duration appendix a 2 routing component the response at the end of each h r u is routed through the stream network using the muskingum cunge routing model in this model the storage in each stream reach j is given by the following discharge storage equation a 23 s j t k e q i n 1 e q o u t which has parameters k d and e dimensionless controlling respectively the celerity and dispersion of the wave routed through the channel substituting this relationship in a finite difference form of the continuity equation s j t 1 s j t δ t q i n q o u t for a multi reach system with lateral inflows injected upstream of reach draining h r u j at average constant rate through time step t q j t 1 yields a 24 q j t 1 k j 1 e j 0 5 δ t q j 1 t 1 k j e j 0 5 δ t a 25 q j t k j 1 e j 0 5 δ t q j 1 t k j e j 0 5 δ t a 26 q j t 1 k j 1 e j 0 5 δ t each of the h r u s contains one reach with an upstream and a downstream node streamflows for each of the j 1 j reaches are integrated over time using a first order explicit finite difference scheme the system of j equations can be assembled as a linear system of the form a 27 a q t 1 b where q t 1 is the vector of unknown streamflows at time t 1 for each of the j reaches of the network that is solved each time step matrices a add b are functions of the model parameters and streamflows at timestep t a 28 a a φ b t a 29 b d φ c t q t i a q t 1 where φ is a j x j sparse connectivity 0 1 matrix where the elements indicate if two pairs of nodes are connected flow direction is from nodes in the rows to nodes in the columns rows representing the upstream node of h r u s that drain an outlet node exit the domain have all zero elements finally a 30 a i k k e d t 0 5 a 31 b i k e d t 0 5 a 32 c i k k e d t 0 5 a 33 d i k e d t 0 5 where i is the identity matrix of order j k and e are column vectors holding parameters k and e for each of the n reaches in the network the operator denotes the schur elementwise product between two vectors the solution of a 27 becomes unstable if δ t 2 k j 1 e j to ensure robust and stable solution an adaptive time stepping scheme was implemented in this scheme the default time step is reduced by an integer fraction until the stability condition is satisfied in all reaches appendix b economic model here we briefly outline the economic optimization program using the standard positive mathematical programming pmp following howitt 1995 mérel et al 2011 and garnache et al 2017 the economic program is implemented in two step in the first step parameters for the economic model are calibrated such that the program mimics the observed land and water use decisions in the second step the model simulates farmer s land use and water use responses given these model parameters along with other exogenous factors such as availability of supplemental irrigation water the following subsections briefly outline the calibration and the simulation process at each simulation time appendix b 1 calibration the fundamental aspect of our economic program is that farmers allocate resources with the objective of maximizing net revenues where the revenue function follows a generalized constant elasticity of substitution ces functional form b 1 max x l a n d i x w a t e r i p i i μ i β l a n d i x l a n d i ρ i β w a t e r i x p r e c i p i x w a t e r i ρ i δ i ρ i c l a n d i λ l a n d i x l a n d i c w a t e r i λ w a t e r i x w a t e r i subject to i x l a n d i l λ l a n d i x w a t e r i w λ w a t e r x l a n d i x w a t e r i 0 where i 1 i indexes crops l l a n d w a t e r indexes land and water inputs we differentiate water inputs into an exogenous component x p r e c i p i which captures water provided by natural sources like precipitation and an endogenous component x w a t e r i which captures supplemental irrigation water provision total water application will be the summation of the two i e x w a t e r i x p r e c i p i x w a t e r i the unknown parameters in equation b 1 are μ i β i l ρ i δ i λ i l λ 1 and the known values are η i exogenous supply elasticity for crop i change in supply over change in crop price π i observed crop production for crop i x l a n d i observed land allocation for crop i x w a t e r i observed et total for crop i y i w reference yield elasticity with respect to water for crop i change in production over change in total et σ i elasticity of substitution for crop i p i unit price of crop i c i l per unit input costs of production for crop i input l l total arable land w total amount of supplemental irrigation water available given the above maximization problem the unknown parameters can be calibrated via positive mathematical programming using the following set of calibration equations b 2 ρ i σ i 1 σ i for i 1 i η i δ i 1 δ i 1 b i δ i 1 δ i j b j δ j 1 δ j σ j b j y j w δ j δ j y j w for i 1 i where b i x l a n d i 2 p i π i π i w δ i β w a t e r i x w a t e r i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i for i 1 i β l a n d i β w a t e r i 1 for i 1 i π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i for i 1 i λ 1 i p i π i δ i y i w c l a n d i x l a n d i x l a n d i i x l a n d i 2 p i π i δ i y i w c l a n d i λ l a n d i λ 1 x l a n d i for i 1 i p i π i y i w c w a t e r i λ w a t e r i x w a t e r i for i 1 appendix b 2 simulation after calibrating the model parameters the optimization framework can now be used to analyze how farmer behaviors will change given changes in exogenous environmental and economic factors including water availability crop prices and production costs the simulation problem is given by the following maximization problem b 3 max x l a n d i x w a t e r i i p i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i c l a n d i λ l a n d i x l a n d i c w a t e r i λ w a t e r i x w a t e r i subject to i x l a n d i l λ l a n d i x w a t e r i w λ w a t e r and x w a t e r i 0 ξ i where the unknown values are x l a n d i x w a t e r i the land and water inputs for crop i π i the total production for crop i and λ l a n d λ w a t e r ξ the lagrangian multipliers the known values include μ i β i l ρ i δ i λ i l model parameters determined from the calibration equations p i c i l x p r e c i p i l w crop prices per unit production costs water from natural sources total arable land and total supplemental irrigation water same as in the calibration equation b 1 the simulation equations to solve the above maximization problem are given by b 4 p i δ i π i β l a n d i x l a n d i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i c l a n d i λ l a n d i λ 1 x l a n d i for i 1 i p i δ i π i β w a t e r i x w a t e r i ρ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i c w a t e r i λ w a t e r i λ 2 ξ i x w a t e r i for i 1 i π i μ i β l a n d i x l a n d i ρ i β w a t e r i x w a t e r i ρ i δ i ρ i for i 1 i i x l a n d i l for i 1 i i x w a t e r i w for i 1 i the simulation model will be able to recover farmers land and water use choices x l a n d i and x w a t e r i under the new set of exogenous conditions the model will also be able to recover shadow values with respect to land and water inputs λ l a n d and λ w a t e r note that this system of equations requires that the water constraint is binding if the water constraint is non binding complementary slackness conditions need to be built to allow for the case in which λ w a t e r 0 appendix c appendix tables table a1 supply elasticity estimates table a1 authors journal region elasticity alfalfa howitt et al 2012b env mod softw california 0 44 knapp working paper california 0 61 author s calculation 0 141 barley antle and capalbo 2001 am j ag econ northern plains 0 35 authors calculation 0 408 dropped maize hendricks et al 2014 am j ag econ iowa illinois indiana 0 40 short run hendricks et al 2014 am j ag econ iowa illinois indiana 0 29 long run arnade and kelch 2007 am j ag econ iowa 0 2 lin and dismukes 2007 rev ag econ north central region 0 17 linear model lin and dismukes 2007 rev ag econ north central region 0 35 acreage share model miao et al 2016 am j ag econ united states 0 68 chavas and holt 1990 am j ag econ north central region 0 15 howitt et al 2012b env mod softw california 0 55 chembezi and womack 1992 j ag applied econ united states 0 1 lee and helmberger 1985 am j ag econ united states 0 05 houck and gallagher 1976 am j ag econ united states 0 24 lower bound houck and gallagher 1976 am j ag econ united states 0 76 upper bound authors calculation a 0 762 wheat antle and capalbo 2001 am j ag econ northern plains 0 36 winter wheat antle and capalbo 2001 am j ag econ northern plains 0 14 spring wheat burt and worthington 1988 j ag res econ great plains 1 5 howitt et al 2012b environ model softw california 0 36 oehmke and yao 1990 am j ag econ us 0 4 sullivan et al 1989 usda report us 0 5 authors calculation 0 368 winter wheat authors calculation 0 409 spring wheat a we empirically calculate the supply elasticity using 22 with annual county level production and price statistics in the state of montana provided by the usda appendix b supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix b supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104836 
