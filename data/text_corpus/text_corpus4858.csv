index,text
24290,this article introduces oryza n as an enhanced soil water nitrogen plant coupling model to simulate agro hydrological processes and crop growth in rice paddy fields the model is developed based on the oryza2000 a widely used rice model with an open source code with significant improvements in modeling the nitrogen n fate and related processes three new modules were designed in oryza n for simulating n transport and transformation processes including a soil temperature module a solute module for ammonium nitrogen nh4 n and nitrate nitrogen no3 n transport and a soil nitrogen module for organic carbon and nitrogen turnover the mechanics of root water uptake and soil water drainage also were improved to better describe the soil water movement and its effects on root n uptake the oryza n model was then tested and applied in simulating the fate of water and nitrogen and crop growth for japonica rice in cold regions jrc in the northeast china plain necp for a two year field experiment during 2018 and 2019 model evaluation shows a good performance was achieved with the oryza n model the simulated values for pond water depths n uptake and partitions and various organ productions were in particularly good agreement with the observed values r2 0 68 nse 0 50 meanwhile the simulated fluctuation trends for nh4 n and no3 n concentrations were reasonable as well the calibrated obtained nitrogen related parameters for jrc were obviously different from those for rice varieties in warmer regions which can efficiently complement the parameter dataset for rice modeling in cold regions finally the n dynamics balance and utilization efficiency were interpreted and assessed for the two experimental years and possible improvement measures for n use for jrc were proposed the total aboveground n content was about 160 kg n ha 1 at harvest while the n content in the stems green leaves dead leaves and panicles accounted for about 15 5 25 and 55 of the total aboveground n content respectively overall rational simulation proved the enhanced functionality and practicality of oryza n for modeling the n fate and utilization keywords rice growth simulation nitrogen modeling parameterization nitrogen utilization oryza n cold regions data availability data will be made available on request 1 introduction rice oryza sativa l is the main staple food for more than half of the world s population and is crucial to world food security china s paddy area accounts for 18 5 of the world s paddy area while rice production accounts for 28 of the world s total rice production faostat 2019 global rice consumption has been increasing following population growth sufficient nitrogen n fertilizer input is one of the most critical factors to ensure rice production however in some developing countries e g china bangladesh egypt and uzbekistan n application rates are significantly high but with low n use efficiency bijay singh et al 1995 conway and pretty 1988 faostat 2019 in pursuit of high yields farmers often tend to apply excessive fertilizer in paddy rice fields such as china accounts for 37 of the world s nitrogen fertilizer used in rice production and 28 of the world s rice production while only about 30 of the nitrogen applied can be recovered from paddy fields peng et al 2002 faostat 2019 qi et al 2020 the intensive irrigation and drainage in paddy fields have resulted in n loss and non point pollution to varying degrees lassaletta et al 2014 latifah et al 2018 zhou et al 2017 with increasing fertilizer consumption and environmental pollution issues improving n fertilizer use efficiency becomes a significant challenge for farmers and policymakers ahmad et al 2017 ding et al 2018 guo et al 2020 it is clear that a full quantitative understanding of the complicated field n processes including n transport transformation uptake partitioning etc is a vital prerequisite to solving the foregoing problems follett 2001 2008 han et al 2021 the conjunction use of field experiments and crop modeling has gradually become an effective and popular method in agricultural analysis and research jha et al 2017 ren et al 2018 xu et al 2018 field experiments are very useful but costly laborious and time consuming due to the complex and changing field conditions in addition some elements are too difficult to be directly observed using a crop model could effectively supplement the shortcomings of field experiments a large number of crop models have been developed and used to simulate water and nitrogen transport and use for rice systems the emphasis of each of those models is generally on a specific aspect of rice modeling involving physiological processes e g ceres rice and wofost ritchie et al 1987 van diepen et al 1989 soil n transformation processes e g dndc and daisy li et al 1997 hansen 2002 the performance of management practices e g whcns and cropsyst liang et al 2016 confalonieri et al 2006 etc currently several widely used models have been developed for rice paddy simulations e g oryza aquacrop and ceres rice bouman et al 2001 ritchie et al 1987 steduto et al 2009 of which the oryza model is a typical and also widely used example with detailed characterization of rice growth and abiotic factors the current version oryza2000 does not simulate the soil n dynamics and only the soil available n must be specified by users with a simple bookkeeping algorithm bouman et al 2001 the successor of oryza2000 i e oryza v3 still not an open source version includes soil temperature and soil carbon and nitrogen modules li et al 2017 nevertheless the thermal simulation in oryza v3 is limited to a uniform spatial grid and the soil carbon and nitrogen turnover seem to be too simple due to the non consideration of the effects of microbial action soil organic matter som mineralization may be underestimated in areas with high organic matter content and active microorganisms such as in black soil areas moreover a good description of n dynamics in surface ponding water and n transport in the soil porous media is still not reported in the previous versions of the oryza model therefore it is attractive to further enhance the function and accuracy of the oryza model in the simulation of n fate the japonica rice in cold regions hereafter called jrc mainly distributed in northeast asia is famous for its high quality and great taste gao et al 2021 hansen et al 2002 zader 2020 most of the jrc planting area is located in the northeast china plain necp which is one of the three major black soil i e the most fertile soil regions worldwide gong et al 2013 xu et al 2010 relatively high quality price and economic values triggered the rapid expansion of planting areas of jrc in recent decades e g with the planting area increasing from 2 68 million ha in 2000 to 5 11 million ha in 2018 in the necp nbsc 2020 the increasing n demand and application rates require efficiently improving n use for economic and eco environmental considerations it is thus necessary to clarify the n fate and utilization processes for jrc quantitative research on n processes and use efficiency is well described for rice growth in warmer climatic regions mae 1997 makino 2011 wang et al 2014 yadav et al 2017 but less reported for jrc in fact rice growth varies significantly in different soil and climate planting environments particularly it is interesting to understand how to rationalize black soil s fertilizer efficiency and in the meantime protect its quality liu et al 2004 tong et al 2018 zhang et al 2007a therefore a quantitative study with the combination of field experiments and simulation models is crucial to characterize the n fate and improve n management for jrc this paper presents the development and application of an enhanced soil water nitrogen crop coupling model for rice simulation named oryza n which is based on the comprehensive improvement of the oryza2000 model an open source version the first objective of this study is to introduce the fully mechanism based functions used to improve the n simulation abilities the modification mainly involves developing a a grid flexible soil temperature module b a soil nitrogen module for expressing soil organic carbon and nitrogen turnover taking into account fresh organic matter soil microbial biomass and soil humus and c a solute module for describing the transfer and transformation of ammonium nitrogen nh4 n and nitrate nitrogen no3 n the second objective of this study is to test the performance of oryza n and apply it for quantitative analysis of n dynamics and use for jrc with two years of field experiments in the necp overall this paper provides a comprehensive presentation of the main features and applicability of oryza n and a complete understanding of n fate and utilization for jrc in northeast china 2 model description oryza n the oryza model is a mechanistic and dynamic eco physiological model specifically developed for simulating rice growth and yield formation bouman et al 2001 li et al 2017 the proposed oryza n model is a significantly modified version of oryza for improving the simulation functions of n dynamics and the effects on rice growth oryza n is developed based on the widely used open source version of oryza2000 in oryza n new modules i e the soil heat module the solute module and the soil nitrogen module are introduced while others i e the water balance module are significantly improved the solute module is developed to describe the nh4 n and no3 n transfer and transformation in the soil porous media involving processes of advection dispersion and various reactions the soil nitrogen module is designed by utilizing the three pools of soil carbon and nitrogen turnover concepts which can reasonably consider the effects of microorganisms on n mineralization immobilization the soil temperature module is embedded for simulating the temperature of soil layers which has large effect on n transformation the calculation procedures for root water uptake and soil water drainage are improved in the soil water module the main calculation flowchart of oryza n is shown in fig 1 the basic principles of the new modules and modifications are described in the following sections the detailed equations and descriptions related to the three new modules are provided in the annex a more comprehensive theory and description of soil water balance crop growth and plant n use is detailed in bouman et al 2001 2 1 soil temperature module a new soil temperature module is developed to predict the hourly temperature of the soil layers the one dimensional 1 d temperature transfer is described with a heat diffusion equation of the form 1 c h θ t t z λ θ t z where ch is the volumetric specific heat of the soil j m 3 1 t is time s t is the soil temperature λ is the coefficient of the apparent thermal conductivity of the soil j s 1 m 1 1 and z is the depth m of each soil layer the values of ch and λ are estimated from soil composition and actual volumetric water content θ cm3 cm 3 as follows mcinnes 1981 2 c h 2 39 1 ρ 2 65 4 18 θ 10 6 3 λ a b θ a d exp c θ 4 4 a 0 65 0 78 ρ 0 60 ρ 2 5 b 1 06 ρ 6 c 1 0 2 6 c l a y 0 5 7 d 0 3 0 1 ρ 2 where ρ is the soil bulk density g cm 3 and clay is the fraction of clay content g g 1 a third type boundary condition is applied for both top and bottom boundaries the top boundary is driven by the air temperature tah and the thermal conductivity λ0 w m 1 1 between the air and the first soil layer the bottom boundary condition is specified as the observed soil temperature at the soil bottom a central finite difference scheme is applied to solve eq 1 in both time and space fig 2 shows a schematic diagram of the soil profile discretization and the processing of boundary conditions the calculation is done based on an hourly i e 3600 s time step the numerical solution of heat transport is provided in detail in annex 1 1 note that the daily average soil temperature td is obtained for each layer by averaging the calculated hourly soil temperatures over 24 h td is an important variable used in the calculation of n transformation 2 2 solute module nh4 n and no3 n in oryza n the solute nh4 n or no3 n is transported with soil water flow fig 3 the downwards movement is associated with percolation i e vertical drainage while the capillary rise from groundwater can cause upward solute movement based on the soil water balance equation solute balance equations are proposed for ponded water eq 8 and each soil layer eq 9 for ponded water 8 s w j 1 s w j i r c i r r a c r a q 0 c 0 r u c 0 δ t where s w is the solute storage in ponded water mg m 2 ir and ra are the irrigation and rainfall rates respectively mm d 1 c ir and c ra are the solute concentration of irrigation water and rainfall respectively mg l 1 q 0 is the water flux between the ponded water layer and the first soil layer mm d 1 ru is the surface runoff over the pond embankment mm d 1 c 0 is the solute concentration of pond water which is updated at the end of time step mg l 1 the superscripts j and j 1 indicate values at t and t δt respectively and δt is the calculation time step 1 day for soil layers 9 s i j 1 s i j q i 1 c i 1 q i c i c r i c i 1 s c i z i δ t where the subscript i refers to the soil layer number starting from the surface layer downwards s i is the solute storage of layer i mg m 2 qi is the water flux between the i th and i 1 th layers mm d 1 c i is the solute concentration of layer i mg l 1 cr is the capillary rise from groundwater mm d 1 zi is the thickness of soil layer i mm sc are the daily source and sink terms of transformations processes mg l 1 d 1 the daily source and sink terms sc for nh4 n and no3 n are calculated as follows 10 s c n h 4 r h y u r e a r a d r min r v o t r n i t r u p 11 s c n o 3 r n i t r d e n r u p where s c n h 4 and s c n o 3 are the nh4 n and no3 n concentrations respectively mg l 1 d 1 rhyurea rad rmin rvot rnit rden and rup are the rates of urea hydrolysis solid adsorption mineralization volatilization of ammonium nitrification denitrification and crop n uptake respectively mg l 1 d 1 rad is calculated as follows 12 r a d ρ z q d ρ z k d c r e f c c r e f n where qd is the solute adsorption capacity of soil particles mg kg 1 k d is the freundlich coefficient cm3 g 1 cref is a reference value of the solute concentration mg l 1 which is used to make n dimensionless and n is the freundlich exponent rup is calculated as follows 13 r u p k r t a c where kr is the root uptake solute correction factor and ta is the actual crop transpiration in root zone layers mm d 1 the detailed calculation formulas for solute transformation processes are presented in annex 1 2 2 3 soil nitrogen module carbon nitrogen turnover the soil nitrogen module is developed to simulate the soil n mineralization and immobilization by referring to the concepts of the daisy model hansen 2002 and the apsim model mccown et al 1996 a schematic diagram of carbon and nitrogen cn turnover calculation is shown in fig 4 the soil organic matter is divided into three pools microbial biomass bom humus hum and added fresh organic matter fom the bom pool represents the more labile soil microbial biomass and microbial products while hum comprises the rest of the soil organic matter mccown et al 1996 flows between the different pools are calculated in terms of carbon and the corresponding n flows depend on the c n ratio of the receiving pool each pool of organic matter is characterized by a particular c n ratio cnri dimensionless the overall organic n balance can be established from the equation for the net mineralization of n as follows xu et al 2018 14 r min i c n r i d c i d t where dci is the carbon decomposition content of each pool for soil layer i mg l 1 the module considers the fresh organic matter from crop residue or biological fixation and organic fertilizer kg c and n ha 1 as external sources of organic cn which are defined by users this module estimates the carbon dioxide emissions during the cn turnover and assumes no independent exchange of soil organic cn between the soil layers in addition it should be noted that this module assumes that only nh4 n is produced during the mineralization procedure and nh4 n and no3 n are consumed by microorganisms in equal proportion during immobilization the detailed computation equations of carbon decomposition n mineralization and immobilization are given in annex 1 2 1 2 4 modification in soil water module the calculation procedures related to evaporation e and transpiration tr are modified in oryza n to reasonably describe the water and n uptake by the root system in oryza2000 the ponded water is first used to sustain e and tr demand bouman et al 2001 if the ponded water is insufficient the e and tr values are complemented by the available soil water in the topsoil and root zone layers respectively in oryza n the root water uptake always directly originates from the root zone layers fig 3 the green right arrow its potential rate at a certain depth sp z is calculated by distributing the potential transpiration rate tp throughout the root zone soil layers for upland aerobic rice the root density distribution has a strong influence on root water uptake crusciol et al 2013 thus the sp z is determined by introducing a non uniform distribution of tp rate over a root zone of arbitrary shape as a function of the specified root length density as follows 15 s p z b r z z r 0 b r z d z t p where zr is the root depth cm and br z is the relative root water uptake distribution user specified with piecewise linear input which is often related to the distribution of root length density then sp z is reduced with consideration of water stress as defined by bouman et al 2001 a new drainage calculation option adopted from the aquacrop model has also been incorporated into the soil water module to better simulate water redistribution drainage and infiltration in the soil profile raes et al 2006 16 δ θ δ t τ θ s a t θ f c e θ θ f c 1 e θ s a t θ f c 1 where δθ δt is the decrease in soil water content during time step δt cm3 cm 3 d 1 τ is the drainage characteristic θsat is the soil water content at saturation cm3 cm 3 and θfc is the soil water content at field capacity cm3 cm 3 3 experiment and model testing 3 1 field experiments 1 location climate soil crop condition irrigation and fertilization field experiments were done at the qing an irrigation experimental station 46 58 06 n 127 39 37 e in the songnen plain of northeast china in 2018 and 2019 the songnen plain is in the middle temperate zone with a sub humid continental monsoon climate it is a typical cold area in china with a mean annual temperature of 2 5 and a mean monthly temperature ranging from 30 3 in january to 27 1 in july the average annual precipitation is 635 mm of which about 75 occurs from june to september the number of frost free days averages 130 per year gao et al 2021 the monthly averages of the main weather variables i e sunshine duration maximum and minimum temperature relative humidity and wind speed and the reference evapotranspiration fao eto allen et al 1998 are shown in fig 5 the soil profile at the experimental site has typical layered soil characteristics of lowland paddy fields the upper layer 0 25 cm is a muddy puddled layer with a silty loam texture the second layer interlayer 25 40 cm is a plow sole i e a hard soil layer located below the tillage layer with a large resistance to water flow with significant resistance to water flow and the deeper layer is a non puddled horizon with a sandy type texture the main soil physical properties and the soil hydraulic parameters of the studied soil profile are listed in table 1 details on the analytical methods used and on the determination of the soil hydraulic parameters can be found in gao et al 2021 the japonica rice variety of suijing 18 was used with a growth period of about 120 days i e from may to september the planting density was 20 hills per m2 and 5 plants per hill flooding basin irrigation was applied in the experiment with a total irrigation depth of 408 mm and 290 mm in 2018 and 2019 respectively more detailed information about crop cultivation and irrigation scheduling is provided in the companion paper gao et al 2021 n fertilizer was applied three times during the experiment including base fertilizer tillering fertilizer and panicle fertilizer the base fertilizer was first broadcast on the bare soil surface by manure spreaders and then incorporated into the soil by ploughing before steeping the field i e the initial flooding before transplanting the tillering fertilizer and the panicle fertilizer were both manually broadcast into the ponded water the fertilizer types and schedules are listed in detail in table 2 other cultivation practices including transplanting pest and disease control and weed management were similar to the practices recommended by local agricultural technicians 2 field observation and data field hydrological conditions crop growth and soil plant n dynamics were monitored from planting to harvest during the crop seasons of 2018 and 2019 the ponded water depth pwd the layered soil moisture groundwater depth irrigation amount and rainfall were measured throughout the growing periods as described in gao et al 2021 nh4 n and no3 n contents were measured in different soil layers 0 10 cm 10 25 cm and 25 40 cm with seven and fourteen samplings in 2018 and 2019 respectively nh4 n and no3 n were extracted from the mixture of soil and 1 mol l 1 kcl solution at a ratio of 1 5 their contents were analyzed using continuous flow injection colorimetry seal analytical aa3 seal analytical gmbh norderstedt germany crop monitoring was done about every 10 days during the crop seasons the dry aboveground green biomass d agb and the dry biomass of stems dwst green leaves dwgl dead leaves dwdl and panicles dwso were measured and the leaf area index lai was monitored as well the detailed samplings and measurements can be found in gao et al 2021 the nitrogen content kg n kg 1 biomass and carbon content kg c kg 1 biomass in each plant organ were measured using a chnos elemental analyzer elementar analyzensysteme vario macro cube germany this was measured 9 and 10 times in 2018 and 2019 respectively the dry biomass was firstly ground and sieved through an 80 mesh sieve and then about 50 mg of filtered sample were taken and measured using the chnos elemental analyzer note that the observations related to soils and crops were replicated three times within the experimental field 3 2 model setup calibration and application a soil profile with 80 cm depth was specified during the simulations four soil horizons also were defined with depths and hydraulic properties set according to table 1 the soil column was further divided into ten variable thickness layers for computational purposes 5 cm thickness for the top five layers 15 cm thickness for the sixth layer i e plow sole layer 10 cm thickness for the deeper three layers and 130 cm thickness for the bottom layer the topsoil boundary conditions were determined using the calculated crop evapotranspiration etc the measured water fluxes and n concentrations in irrigation and precipitation and the air temperature the bottom boundary conditions were defined by the observed groundwater depth n concentrations and soil temperature referring to the observed temperature at the 80 cm soil depth at a nearby weather station the simulation period was from late april to late september covering the entire rice growing period initial soil water content solute concentrations and soil temperatures were set according to the measurements in late april the dataset in 2019 was more comprehensive and thus was used to calibrate the model while that in 2018 was used for model validation model calibration was done by adjusting parameters one at a time within reasonable ranges of values using a trial and error approach until deviations between field measurements and model predictions were minimized calibration followed the order of field hydrological processes i e pwd fluctuation crop growth processes n contents in the soil solution and crop n uptake and partitions in plant organs the detailed procedure was similar to the one in the companion paper gao et al 2021 the default parameters related to agro hydrology and crop physiology were taken from gao et al 2021 this paper focuses on the calibration of the nitrogen related parameters listed in table 3 the parameters which were measured in the laboratory and are associated with less uncertainty were just slightly adjusted during calibration the parameter adjustment loops continued until the model performed well both in calibration and validation similar to gao et al 2021 the mean relative error mre the root mean square error rmse the nash and sutcliffe 1970 model efficiency nse the coefficient of determination r 2 and the regression coefficient r were used to evaluate the goodness of fit between simulated and observed values after the proper calibration and validation the oryza n model was applied to quantitatively assess the water and n uses and their respective effects on crop growth and yield formation as a result this modeling exercise can further provide a set of reasonable parameter values for n simulation of jrc 4 results and discussion 4 1 modeling performance the results of this study showed that the model performed well in simulating hydrological processes n dynamics and crop growth in the jrc field during the calibration and validation periods figs 6 9 and table 4 the water crop related parameters calibrated in the companion paper gao et al 2021 without considering n effects remained the same while the nitrogen related parameters are now calibrated as listed in table 3 this was mainly because the soil water crop processes were almost unaffected by the n dynamics due to adequate n supply in the jrc study case simulations of the various dry biomass components d agb dwst dwgl and dwso and lai all matched well with the measured values fig 6 the simulated pwds also were in agreement with the observed values fig 9 the goodness of fit indicators were also all very close to those in the previous companion paper gao et al 2021 both in calibration and validation table 4 the simulated crop yields were 7200 and 8048 kg ha 1 in 2019 and 2018 respectively which were only slightly different from the observed ones 7081 566 kg ha 1 and 7604 738 kg ha 1 for crop n uptake the model could well capture the dynamic processes of n uptake partition and translocation in the plants fig 7 and table 4 during calibration the mre and rmse were 26 3 and 7 8 kg n ha 1 respectively with the nse achieving 0 98 for the amount of n in the aboveground biomass crop an agb for the amount of n in stems anst green leaves anlv and panicles anso the mre and rmse ranged from 9 4 to 51 3 and from 2 6 to 6 8 kg n ha 1 respectively while the nse values were between 0 75 and 0 98 table 4 some discrepancies may be attributed to the fact that destructive sampling was conducted for crop growth monitoring which cannot reflect the real continuous growth of a rice plant for validation the goodness of fit for anst anlv and anso resulted in mre rmse and nse values ranging from 12 2 to 10 5 4 6 to 8 6 kg n ha 1 and 0 88 to 0 94 respectively table 4 the foregoing results indicate that the oyrza n model could well simulate the root n uptake and the n partitions in different organs in addition the simulated and observed nh4 n and no3 n concentrations in the soil solution of the root zone 0 25 cm were compared as shown in fig 8 the results indicated that the calibrated model reasonably captured the change trends of the observations i e the rapidly increasing trend after fertilization and subsequent slow declining trend but the simulation accuracy was not as good as that for crop n uptake this was mainly because the simulation for nh4 n and no3 n concentrations was inherently more difficult than that for other terms due to the complex processes of n transport and transformation in rice paddy fields the fertilizer spreading patterns also may increase the uncertainty in the observations moreover the lower fit between the measured and simulated values in some stages might have been caused by untimely measurement of samplings particularly for nh4 n during 2018 the possible nitrification of soil samples resulted in relatively lower nh4 n contents and thus higher no3 n contents fig 8b nonetheless the general agreement between the simulated and measured data both for calibration and validation implies that the model performance was acceptable note that the statistical indicators that returned less acceptable results such as for the nse table 4 also are usually not often reported in application studies like this one due to the difficulties previously mentioned hence the calibrated model can be applied to evaluate field water use crop growth and n use for jrc 4 2 parametrization of nitrogen related processes table 3 lists the calibrated values of the main nitrogen related parameters for jrc and compares them to the default recommended values for tropical and subtropical rice results show that the parameters for jrc grown in an environment with lower cumulative temperatures and more fertile black soils were specific and significantly different from those for rice varieties grown in warmer regions the residual n fraction of leaves and stems for jrc were 0 0176 and 0 0065 kg n kg 1 respectively throughout measurements being much larger than the default values 0 004 and 0 0015 kg n kg 1 respectively for rice in tropical regions the measured maximum n concentration in storage organs panicles reached 0 0279 kg n kg 1 which was obviously higher than the default value of 0 0175 kg n kg 1 note that the root system of jrc is not so developed compared to rice in tropical subtropical regions and thus the translocation fraction from roots to panicles i e nmaxso 0 05 was correspondingly less than the default value 0 15 table 3 it was found that the maximum leaf n fraction i e nmaxlt for jrc was less than the default values in all developmental stages table 3 the leaf n content is mainly affected by light conditions and its levels are generally consistent with the intensity of light conditions yin et al 2019 zhu and zhang 1985 in cold regions light conditions and radiation intensity are lower than those in tropical subtropical regions this explains the lower calibrated value of nmaxlt for jrc in addition some newly introduced parameters for simulating n transport and transformation processes also are included in table 3 these parameters were calibrated and determined based on the values available from some previous research hansen 2002 holzworth et al 2014 kroes and van dam 2003 mccown et al 1996 these parameters were mainly in the ranges of recommended or were reported values and thus had reasonable physical meaning however these parameters are still required to be calibrated more rigorously when more soil n data become available from experiments in black paddy soils for jrc note that parameters related to the decomposition rate c n ratio and substrate utilization of the three n pools are sensitive to the n simulation process and should be given more attention in modeling applications conclusively the foregoing nitrogen related parameter values should be meaningful to n modeling work for jrc 4 3 nitrogen uptake and biomass production for jrc with adequate n supply the crop n uptake showed a similar trend in the growing season of 2018 and 2019 fig 7 the an agb at harvest was about 160 kg n ha 1 in both 2018 and 2019 which was consistent with the values 151 169 kg n ha 1 reported by zhang et al 2020 for jrc with n fertilizer of 110 kg n ha 1 actually the an agb of japonica rice usually shows a large range of variation under sufficient n supply e g ranging from about 140 to 215 kg n ha 1 for different varieties and climatic regions according to the literature chu et al 2019 jing et al 2008 zhang et al 2007b zhu et al 2020 the n amounts of various organs followed a similar trend as the biomass figs 6 and 7 during the early growth periods i e from late may to early july anlv was approximately twice as much as anst fig 7 anlv reached a maximum value of about 50 kg n ha 1 at the stage of jointing and booting around late july and then decreased gradually meanwhile anst increased slowly and reached the maximum about 45 kg n ha 1 by the blooming stage early august and then had a decreasing trend during the reproductive phase the translocation of n from other crop organs to the panicles was accelerated with the rapid growth of the storage organs fig 7 when approaching harvest anst and anlv decreased rapidly due to the death of green leaves and n translocation to panicles while anso showed a rapid upward trend with the increase of dwso the n translocation from stems leaves and roots to panicles started when panicles were formed in early july figs 6 and 7 before panicle formation the an agb was 39 5 and 50 0 kg n ha 1 in 2018 and 2019 respectively the percentages of anst anlv anld and anso to the an agb were similar in the two years equaling about 15 5 25 and 55 respectively table 5 in both years the amount of n transported from the roots stems and leaves to the panicles was about 4 50 and 30 kg n ha 1 being 5 60 and 35 of the anso respectively at harvest the an agb reached 162 9 and 162 5 kg n ha 1 in 2018 and 2019 respectively anst anlv anld and anso respectively reached 25 6 6 2 36 4 and 94 7 kg n ha 1 in 2018 and 27 4 8 7 41 8 and 84 6 kg n ha 1 in 2019 table 5 anlv was the lowest among all organs occupying less than 4 of an agb anst and anso accounted for about 16 and over 50 of an agb respectively table 5 the differences between 2018 and 2019 were mainly caused by the higher radiation and temperature in the key reproductive period i e july and august during 2018 fig 5 resulting in both about 12 higher crop yield and anso at harvest in that year 4 4 nitrogen dynamics balance and utilization efficiency the total n supply tns was mainly from the initial soil mineral n storage fertilizer application and organic matter mineralization in the current field experiments table 6 the n amount from fertilizer was 134 7 and 137 5 kg n ha 1 in 2018 and 2019 respectively table 2 accounting for about 40 45 of the tns these values are relatively low compared to the average amount of n fertilization about 180 kg n ha 1 used in a single rice season in chinese paddy fields peng et al 2002 simulation indicated that the mineralization rate was relatively stable throughout the growing seasons fig 9 the soil mineral n storage was the second largest component of the tns 22 25 the n amount from net mineralization reached about 73 kg n ha 1 for both 2018 and 2019 which was generally higher than the values in most paddy fields in china reported in previous research e g mainly 51 62 kg n ha 1 in the yangtze river basin tang et al 2006 zhu and wen 1992 the n supply from wet deposition and irrigation water was only about 23 kg n ha 1 10 of tns the results showed that the tns in jcr fields was lost through denitrification leaching surface runoff n2o emissions from nitrification immobilization and ammonia nh3 volatilization table 6 the total n loss tnl in 2018 and 2019 was 146 8 and 113 7 kg n ha 1 accounting for 44 4 and 38 1 of the tns respectively denitrification was the largest consumption item among n loss components the n loss by denitrification in 2018 and 2019 was 88 8 and 50 1 kg n ha 1 accounting for 26 9 and 16 8 of the tns respectively previous studies have shown that the nitrogen loss by nitrification denitrification in rice fields was about 16 41 tang et al 2006 zhu 2000 and thus simulation results in this study were within a reasonable range the n leaching from the vertical percolation in the soil profile was 33 6 and 38 4 kg n ha 1 in 2018 and 2019 respectively which accounted for around 10 13 of the tns due to the similar runoff observed in 2018 and 2019 the n loss from surface runoff was 13 3 and 13 9 kg n ha 1 respectively around 4 of the tns the nh3 volatilization amount was about 10 kg ha 1 in both 2018 and 2019 accounting for around 7 of the total n fertilization applied which was consistent with some field measurement research results 4 17 huang et al 2006 zhu 2008 li et al 2018 the n immobilization only occurred when mineralization did not exist and could almost be neglected n2o emissions from nitrification were 1 5 and 0 3 kg n ha 1 in 2018 and 2019 accounting for only 0 5 and 0 1 of the tns respectively however n2o emissions from denitrification reached 30 5 and 15 0 kg n ha 1 in 2018 and 2019 respectively and the differences between the two years should be attributed to different ponding water conditions during the growth periods in 2018 the repeated surface drying and water ponding from the middle reproductive period to maturity i e after mid august enhanced soil nitrification and subsequent denitrification subsequently resulting in more soil mineral n loss in comparison nitrification and denitrification were relatively weak in 2019 due to the persistence of the ponded water above the field surface fig 9 over 50 of the tns was taken up by the aboveground parts with nearly 7 of the tns stored in the roots for jrc the internal n use efficiency i e the grain yield divided by an agb was 49 4 and 44 3 kg kg 1 in 2018 and 2019 respectively this value was in the range of some previously reported values for japonica rice in japan and eastern china 40 8 53 3 kg kg 1 jing et al 2008 sun et al 2021 zhao et al 2011 the foregoing analysis showed that reducing n leaching and n loss by denitrification could further improve n use efficiency the appropriate practices should focus more on controlling the suitable shallow ponding water depth at necessary flooding stages and applying timely drainage during the sun drying stages especially avoiding alternative dryness and flooding in order to improve n utilization for jrc the foregoing quantitative analysis of n fate could provide beneficial field management and policymaking information for farmers and managers 5 summary and conclusions in this paper the oryza n model was developed as an enhanced soil water nitrogen plant coupling model for paddy rice fields based on the comprehensive improvement of oryza2000 it was designed to particularly strengthen the simulation capability of nitrogen n fate the significant modifications mainly included the incorporation of three new models a soil temperature module for numerically solving the soil heat conduction equation a multi layered solute module for simulating advection dispersion and reactions of ammonium nitrogen nh4 n and nitrate nitrogen no3 n in the soil and soil nitrogen modules describing soil organic carbon and nitrogen turnover meanwhile the calculation of root water uptake and soil water drainage also were improved to reasonably describe the soil water fate and its effects on root n uptake the oryza n model was then calibrated and validated with detailed two year field experimental data 2018 and 2019 of japonica rice in cold regions jrc in the northeast china plain necp simulation results indicated that the above modification made the oryza n capable of describing the n transfer and transformation in soil media uptake by roots and partitions translocation in rice organs very well the simulated crop indicators for aboveground biomass biomass of stems green leaves panicles leaf area index and grain yield and n indicators n amount in the aboveground biomass stems green leaves and panicles showed quite good agreement with field observations simulated fluctuation trends for nh4 n and no3 n contents in the soil were also reasonable although the simulation accuracy was not as good as crop n the nitrogen related parameter values were determined for jrc by combining the detailed measurements with model parameterization and were different from the parameters for rice varieties planted in tropical subtropical regions thus the result of this study can complement the parameter database for jrc modeling the model application indicated that initial soil mineral n storage and fertilizer application contributed nearly 70 to total n supply tns in the jcr field the net mineralization reached about 73 kg n ha 1 and accounted for about 22 25 of the tns around 60 of the tns was taken up by the crop including aboveground parts and roots the total amount of n in the aboveground biomass an agb was about 160 kg n ha 1 at harvest with the percentage of n in stems green leaves dead leaves and panicles being about 15 5 25 and 55 respectively the total n loss in 2018 and 2019 was 146 8 and 113 7 kg n ha 1 44 4 and 38 1 of the tns respectively with the n loss by denitrification the largest n loss item amounting 88 8 and 50 1 kg n ha 1 during the years 2018 and 2019 respectively the difference in denitrification losses between the years was caused by the ponded water and drying conditions at different stages the n transformation analysis indicates that maintaining suitable shallow waterlogging during flooding stages and the timely drainage at sun drying stages could reduce n loss through leaching and denitrification in summary the oryza n model may be a reliable tool to quantify n fate and support rational irrigation and fertilization management moreover the model can help researchers simulate rice growth soil water nitrogen comprehensively for jrc in northeast china and other cold weather places follow up investigations will focus primarily on testing model parameter sensitivity and structural uncertainties credit authorship contribution statement ya gao conceptualization software formal analysis writing original draft writing review editing chen sun conceptualization methodology supervision writing review editing tiago b ramos data curation writing review editing zailin huo resources project administration guanhua huang resources supervision project administration xu xu conceptualization methodology supervision funding acquisition project administration writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research was supported by the national natural science foundation of china grant no 52022108 and the 13th five year national key research and development program of the chinese ministry of science and technology grant nos 2016yfc0400107 and 2017yfd0300403 a scholarship to ms ya gao from the china scholarship council to support her one year stay at the university of lisbon also is acknowledged t b ramos was supported by contract ceecind 01152 2017 of the fundação para a ciência e a tecnologia portugal supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j ecolmodel 2022 110184 appendix supplementary materials image application 1 
24290,this article introduces oryza n as an enhanced soil water nitrogen plant coupling model to simulate agro hydrological processes and crop growth in rice paddy fields the model is developed based on the oryza2000 a widely used rice model with an open source code with significant improvements in modeling the nitrogen n fate and related processes three new modules were designed in oryza n for simulating n transport and transformation processes including a soil temperature module a solute module for ammonium nitrogen nh4 n and nitrate nitrogen no3 n transport and a soil nitrogen module for organic carbon and nitrogen turnover the mechanics of root water uptake and soil water drainage also were improved to better describe the soil water movement and its effects on root n uptake the oryza n model was then tested and applied in simulating the fate of water and nitrogen and crop growth for japonica rice in cold regions jrc in the northeast china plain necp for a two year field experiment during 2018 and 2019 model evaluation shows a good performance was achieved with the oryza n model the simulated values for pond water depths n uptake and partitions and various organ productions were in particularly good agreement with the observed values r2 0 68 nse 0 50 meanwhile the simulated fluctuation trends for nh4 n and no3 n concentrations were reasonable as well the calibrated obtained nitrogen related parameters for jrc were obviously different from those for rice varieties in warmer regions which can efficiently complement the parameter dataset for rice modeling in cold regions finally the n dynamics balance and utilization efficiency were interpreted and assessed for the two experimental years and possible improvement measures for n use for jrc were proposed the total aboveground n content was about 160 kg n ha 1 at harvest while the n content in the stems green leaves dead leaves and panicles accounted for about 15 5 25 and 55 of the total aboveground n content respectively overall rational simulation proved the enhanced functionality and practicality of oryza n for modeling the n fate and utilization keywords rice growth simulation nitrogen modeling parameterization nitrogen utilization oryza n cold regions data availability data will be made available on request 1 introduction rice oryza sativa l is the main staple food for more than half of the world s population and is crucial to world food security china s paddy area accounts for 18 5 of the world s paddy area while rice production accounts for 28 of the world s total rice production faostat 2019 global rice consumption has been increasing following population growth sufficient nitrogen n fertilizer input is one of the most critical factors to ensure rice production however in some developing countries e g china bangladesh egypt and uzbekistan n application rates are significantly high but with low n use efficiency bijay singh et al 1995 conway and pretty 1988 faostat 2019 in pursuit of high yields farmers often tend to apply excessive fertilizer in paddy rice fields such as china accounts for 37 of the world s nitrogen fertilizer used in rice production and 28 of the world s rice production while only about 30 of the nitrogen applied can be recovered from paddy fields peng et al 2002 faostat 2019 qi et al 2020 the intensive irrigation and drainage in paddy fields have resulted in n loss and non point pollution to varying degrees lassaletta et al 2014 latifah et al 2018 zhou et al 2017 with increasing fertilizer consumption and environmental pollution issues improving n fertilizer use efficiency becomes a significant challenge for farmers and policymakers ahmad et al 2017 ding et al 2018 guo et al 2020 it is clear that a full quantitative understanding of the complicated field n processes including n transport transformation uptake partitioning etc is a vital prerequisite to solving the foregoing problems follett 2001 2008 han et al 2021 the conjunction use of field experiments and crop modeling has gradually become an effective and popular method in agricultural analysis and research jha et al 2017 ren et al 2018 xu et al 2018 field experiments are very useful but costly laborious and time consuming due to the complex and changing field conditions in addition some elements are too difficult to be directly observed using a crop model could effectively supplement the shortcomings of field experiments a large number of crop models have been developed and used to simulate water and nitrogen transport and use for rice systems the emphasis of each of those models is generally on a specific aspect of rice modeling involving physiological processes e g ceres rice and wofost ritchie et al 1987 van diepen et al 1989 soil n transformation processes e g dndc and daisy li et al 1997 hansen 2002 the performance of management practices e g whcns and cropsyst liang et al 2016 confalonieri et al 2006 etc currently several widely used models have been developed for rice paddy simulations e g oryza aquacrop and ceres rice bouman et al 2001 ritchie et al 1987 steduto et al 2009 of which the oryza model is a typical and also widely used example with detailed characterization of rice growth and abiotic factors the current version oryza2000 does not simulate the soil n dynamics and only the soil available n must be specified by users with a simple bookkeeping algorithm bouman et al 2001 the successor of oryza2000 i e oryza v3 still not an open source version includes soil temperature and soil carbon and nitrogen modules li et al 2017 nevertheless the thermal simulation in oryza v3 is limited to a uniform spatial grid and the soil carbon and nitrogen turnover seem to be too simple due to the non consideration of the effects of microbial action soil organic matter som mineralization may be underestimated in areas with high organic matter content and active microorganisms such as in black soil areas moreover a good description of n dynamics in surface ponding water and n transport in the soil porous media is still not reported in the previous versions of the oryza model therefore it is attractive to further enhance the function and accuracy of the oryza model in the simulation of n fate the japonica rice in cold regions hereafter called jrc mainly distributed in northeast asia is famous for its high quality and great taste gao et al 2021 hansen et al 2002 zader 2020 most of the jrc planting area is located in the northeast china plain necp which is one of the three major black soil i e the most fertile soil regions worldwide gong et al 2013 xu et al 2010 relatively high quality price and economic values triggered the rapid expansion of planting areas of jrc in recent decades e g with the planting area increasing from 2 68 million ha in 2000 to 5 11 million ha in 2018 in the necp nbsc 2020 the increasing n demand and application rates require efficiently improving n use for economic and eco environmental considerations it is thus necessary to clarify the n fate and utilization processes for jrc quantitative research on n processes and use efficiency is well described for rice growth in warmer climatic regions mae 1997 makino 2011 wang et al 2014 yadav et al 2017 but less reported for jrc in fact rice growth varies significantly in different soil and climate planting environments particularly it is interesting to understand how to rationalize black soil s fertilizer efficiency and in the meantime protect its quality liu et al 2004 tong et al 2018 zhang et al 2007a therefore a quantitative study with the combination of field experiments and simulation models is crucial to characterize the n fate and improve n management for jrc this paper presents the development and application of an enhanced soil water nitrogen crop coupling model for rice simulation named oryza n which is based on the comprehensive improvement of the oryza2000 model an open source version the first objective of this study is to introduce the fully mechanism based functions used to improve the n simulation abilities the modification mainly involves developing a a grid flexible soil temperature module b a soil nitrogen module for expressing soil organic carbon and nitrogen turnover taking into account fresh organic matter soil microbial biomass and soil humus and c a solute module for describing the transfer and transformation of ammonium nitrogen nh4 n and nitrate nitrogen no3 n the second objective of this study is to test the performance of oryza n and apply it for quantitative analysis of n dynamics and use for jrc with two years of field experiments in the necp overall this paper provides a comprehensive presentation of the main features and applicability of oryza n and a complete understanding of n fate and utilization for jrc in northeast china 2 model description oryza n the oryza model is a mechanistic and dynamic eco physiological model specifically developed for simulating rice growth and yield formation bouman et al 2001 li et al 2017 the proposed oryza n model is a significantly modified version of oryza for improving the simulation functions of n dynamics and the effects on rice growth oryza n is developed based on the widely used open source version of oryza2000 in oryza n new modules i e the soil heat module the solute module and the soil nitrogen module are introduced while others i e the water balance module are significantly improved the solute module is developed to describe the nh4 n and no3 n transfer and transformation in the soil porous media involving processes of advection dispersion and various reactions the soil nitrogen module is designed by utilizing the three pools of soil carbon and nitrogen turnover concepts which can reasonably consider the effects of microorganisms on n mineralization immobilization the soil temperature module is embedded for simulating the temperature of soil layers which has large effect on n transformation the calculation procedures for root water uptake and soil water drainage are improved in the soil water module the main calculation flowchart of oryza n is shown in fig 1 the basic principles of the new modules and modifications are described in the following sections the detailed equations and descriptions related to the three new modules are provided in the annex a more comprehensive theory and description of soil water balance crop growth and plant n use is detailed in bouman et al 2001 2 1 soil temperature module a new soil temperature module is developed to predict the hourly temperature of the soil layers the one dimensional 1 d temperature transfer is described with a heat diffusion equation of the form 1 c h θ t t z λ θ t z where ch is the volumetric specific heat of the soil j m 3 1 t is time s t is the soil temperature λ is the coefficient of the apparent thermal conductivity of the soil j s 1 m 1 1 and z is the depth m of each soil layer the values of ch and λ are estimated from soil composition and actual volumetric water content θ cm3 cm 3 as follows mcinnes 1981 2 c h 2 39 1 ρ 2 65 4 18 θ 10 6 3 λ a b θ a d exp c θ 4 4 a 0 65 0 78 ρ 0 60 ρ 2 5 b 1 06 ρ 6 c 1 0 2 6 c l a y 0 5 7 d 0 3 0 1 ρ 2 where ρ is the soil bulk density g cm 3 and clay is the fraction of clay content g g 1 a third type boundary condition is applied for both top and bottom boundaries the top boundary is driven by the air temperature tah and the thermal conductivity λ0 w m 1 1 between the air and the first soil layer the bottom boundary condition is specified as the observed soil temperature at the soil bottom a central finite difference scheme is applied to solve eq 1 in both time and space fig 2 shows a schematic diagram of the soil profile discretization and the processing of boundary conditions the calculation is done based on an hourly i e 3600 s time step the numerical solution of heat transport is provided in detail in annex 1 1 note that the daily average soil temperature td is obtained for each layer by averaging the calculated hourly soil temperatures over 24 h td is an important variable used in the calculation of n transformation 2 2 solute module nh4 n and no3 n in oryza n the solute nh4 n or no3 n is transported with soil water flow fig 3 the downwards movement is associated with percolation i e vertical drainage while the capillary rise from groundwater can cause upward solute movement based on the soil water balance equation solute balance equations are proposed for ponded water eq 8 and each soil layer eq 9 for ponded water 8 s w j 1 s w j i r c i r r a c r a q 0 c 0 r u c 0 δ t where s w is the solute storage in ponded water mg m 2 ir and ra are the irrigation and rainfall rates respectively mm d 1 c ir and c ra are the solute concentration of irrigation water and rainfall respectively mg l 1 q 0 is the water flux between the ponded water layer and the first soil layer mm d 1 ru is the surface runoff over the pond embankment mm d 1 c 0 is the solute concentration of pond water which is updated at the end of time step mg l 1 the superscripts j and j 1 indicate values at t and t δt respectively and δt is the calculation time step 1 day for soil layers 9 s i j 1 s i j q i 1 c i 1 q i c i c r i c i 1 s c i z i δ t where the subscript i refers to the soil layer number starting from the surface layer downwards s i is the solute storage of layer i mg m 2 qi is the water flux between the i th and i 1 th layers mm d 1 c i is the solute concentration of layer i mg l 1 cr is the capillary rise from groundwater mm d 1 zi is the thickness of soil layer i mm sc are the daily source and sink terms of transformations processes mg l 1 d 1 the daily source and sink terms sc for nh4 n and no3 n are calculated as follows 10 s c n h 4 r h y u r e a r a d r min r v o t r n i t r u p 11 s c n o 3 r n i t r d e n r u p where s c n h 4 and s c n o 3 are the nh4 n and no3 n concentrations respectively mg l 1 d 1 rhyurea rad rmin rvot rnit rden and rup are the rates of urea hydrolysis solid adsorption mineralization volatilization of ammonium nitrification denitrification and crop n uptake respectively mg l 1 d 1 rad is calculated as follows 12 r a d ρ z q d ρ z k d c r e f c c r e f n where qd is the solute adsorption capacity of soil particles mg kg 1 k d is the freundlich coefficient cm3 g 1 cref is a reference value of the solute concentration mg l 1 which is used to make n dimensionless and n is the freundlich exponent rup is calculated as follows 13 r u p k r t a c where kr is the root uptake solute correction factor and ta is the actual crop transpiration in root zone layers mm d 1 the detailed calculation formulas for solute transformation processes are presented in annex 1 2 2 3 soil nitrogen module carbon nitrogen turnover the soil nitrogen module is developed to simulate the soil n mineralization and immobilization by referring to the concepts of the daisy model hansen 2002 and the apsim model mccown et al 1996 a schematic diagram of carbon and nitrogen cn turnover calculation is shown in fig 4 the soil organic matter is divided into three pools microbial biomass bom humus hum and added fresh organic matter fom the bom pool represents the more labile soil microbial biomass and microbial products while hum comprises the rest of the soil organic matter mccown et al 1996 flows between the different pools are calculated in terms of carbon and the corresponding n flows depend on the c n ratio of the receiving pool each pool of organic matter is characterized by a particular c n ratio cnri dimensionless the overall organic n balance can be established from the equation for the net mineralization of n as follows xu et al 2018 14 r min i c n r i d c i d t where dci is the carbon decomposition content of each pool for soil layer i mg l 1 the module considers the fresh organic matter from crop residue or biological fixation and organic fertilizer kg c and n ha 1 as external sources of organic cn which are defined by users this module estimates the carbon dioxide emissions during the cn turnover and assumes no independent exchange of soil organic cn between the soil layers in addition it should be noted that this module assumes that only nh4 n is produced during the mineralization procedure and nh4 n and no3 n are consumed by microorganisms in equal proportion during immobilization the detailed computation equations of carbon decomposition n mineralization and immobilization are given in annex 1 2 1 2 4 modification in soil water module the calculation procedures related to evaporation e and transpiration tr are modified in oryza n to reasonably describe the water and n uptake by the root system in oryza2000 the ponded water is first used to sustain e and tr demand bouman et al 2001 if the ponded water is insufficient the e and tr values are complemented by the available soil water in the topsoil and root zone layers respectively in oryza n the root water uptake always directly originates from the root zone layers fig 3 the green right arrow its potential rate at a certain depth sp z is calculated by distributing the potential transpiration rate tp throughout the root zone soil layers for upland aerobic rice the root density distribution has a strong influence on root water uptake crusciol et al 2013 thus the sp z is determined by introducing a non uniform distribution of tp rate over a root zone of arbitrary shape as a function of the specified root length density as follows 15 s p z b r z z r 0 b r z d z t p where zr is the root depth cm and br z is the relative root water uptake distribution user specified with piecewise linear input which is often related to the distribution of root length density then sp z is reduced with consideration of water stress as defined by bouman et al 2001 a new drainage calculation option adopted from the aquacrop model has also been incorporated into the soil water module to better simulate water redistribution drainage and infiltration in the soil profile raes et al 2006 16 δ θ δ t τ θ s a t θ f c e θ θ f c 1 e θ s a t θ f c 1 where δθ δt is the decrease in soil water content during time step δt cm3 cm 3 d 1 τ is the drainage characteristic θsat is the soil water content at saturation cm3 cm 3 and θfc is the soil water content at field capacity cm3 cm 3 3 experiment and model testing 3 1 field experiments 1 location climate soil crop condition irrigation and fertilization field experiments were done at the qing an irrigation experimental station 46 58 06 n 127 39 37 e in the songnen plain of northeast china in 2018 and 2019 the songnen plain is in the middle temperate zone with a sub humid continental monsoon climate it is a typical cold area in china with a mean annual temperature of 2 5 and a mean monthly temperature ranging from 30 3 in january to 27 1 in july the average annual precipitation is 635 mm of which about 75 occurs from june to september the number of frost free days averages 130 per year gao et al 2021 the monthly averages of the main weather variables i e sunshine duration maximum and minimum temperature relative humidity and wind speed and the reference evapotranspiration fao eto allen et al 1998 are shown in fig 5 the soil profile at the experimental site has typical layered soil characteristics of lowland paddy fields the upper layer 0 25 cm is a muddy puddled layer with a silty loam texture the second layer interlayer 25 40 cm is a plow sole i e a hard soil layer located below the tillage layer with a large resistance to water flow with significant resistance to water flow and the deeper layer is a non puddled horizon with a sandy type texture the main soil physical properties and the soil hydraulic parameters of the studied soil profile are listed in table 1 details on the analytical methods used and on the determination of the soil hydraulic parameters can be found in gao et al 2021 the japonica rice variety of suijing 18 was used with a growth period of about 120 days i e from may to september the planting density was 20 hills per m2 and 5 plants per hill flooding basin irrigation was applied in the experiment with a total irrigation depth of 408 mm and 290 mm in 2018 and 2019 respectively more detailed information about crop cultivation and irrigation scheduling is provided in the companion paper gao et al 2021 n fertilizer was applied three times during the experiment including base fertilizer tillering fertilizer and panicle fertilizer the base fertilizer was first broadcast on the bare soil surface by manure spreaders and then incorporated into the soil by ploughing before steeping the field i e the initial flooding before transplanting the tillering fertilizer and the panicle fertilizer were both manually broadcast into the ponded water the fertilizer types and schedules are listed in detail in table 2 other cultivation practices including transplanting pest and disease control and weed management were similar to the practices recommended by local agricultural technicians 2 field observation and data field hydrological conditions crop growth and soil plant n dynamics were monitored from planting to harvest during the crop seasons of 2018 and 2019 the ponded water depth pwd the layered soil moisture groundwater depth irrigation amount and rainfall were measured throughout the growing periods as described in gao et al 2021 nh4 n and no3 n contents were measured in different soil layers 0 10 cm 10 25 cm and 25 40 cm with seven and fourteen samplings in 2018 and 2019 respectively nh4 n and no3 n were extracted from the mixture of soil and 1 mol l 1 kcl solution at a ratio of 1 5 their contents were analyzed using continuous flow injection colorimetry seal analytical aa3 seal analytical gmbh norderstedt germany crop monitoring was done about every 10 days during the crop seasons the dry aboveground green biomass d agb and the dry biomass of stems dwst green leaves dwgl dead leaves dwdl and panicles dwso were measured and the leaf area index lai was monitored as well the detailed samplings and measurements can be found in gao et al 2021 the nitrogen content kg n kg 1 biomass and carbon content kg c kg 1 biomass in each plant organ were measured using a chnos elemental analyzer elementar analyzensysteme vario macro cube germany this was measured 9 and 10 times in 2018 and 2019 respectively the dry biomass was firstly ground and sieved through an 80 mesh sieve and then about 50 mg of filtered sample were taken and measured using the chnos elemental analyzer note that the observations related to soils and crops were replicated three times within the experimental field 3 2 model setup calibration and application a soil profile with 80 cm depth was specified during the simulations four soil horizons also were defined with depths and hydraulic properties set according to table 1 the soil column was further divided into ten variable thickness layers for computational purposes 5 cm thickness for the top five layers 15 cm thickness for the sixth layer i e plow sole layer 10 cm thickness for the deeper three layers and 130 cm thickness for the bottom layer the topsoil boundary conditions were determined using the calculated crop evapotranspiration etc the measured water fluxes and n concentrations in irrigation and precipitation and the air temperature the bottom boundary conditions were defined by the observed groundwater depth n concentrations and soil temperature referring to the observed temperature at the 80 cm soil depth at a nearby weather station the simulation period was from late april to late september covering the entire rice growing period initial soil water content solute concentrations and soil temperatures were set according to the measurements in late april the dataset in 2019 was more comprehensive and thus was used to calibrate the model while that in 2018 was used for model validation model calibration was done by adjusting parameters one at a time within reasonable ranges of values using a trial and error approach until deviations between field measurements and model predictions were minimized calibration followed the order of field hydrological processes i e pwd fluctuation crop growth processes n contents in the soil solution and crop n uptake and partitions in plant organs the detailed procedure was similar to the one in the companion paper gao et al 2021 the default parameters related to agro hydrology and crop physiology were taken from gao et al 2021 this paper focuses on the calibration of the nitrogen related parameters listed in table 3 the parameters which were measured in the laboratory and are associated with less uncertainty were just slightly adjusted during calibration the parameter adjustment loops continued until the model performed well both in calibration and validation similar to gao et al 2021 the mean relative error mre the root mean square error rmse the nash and sutcliffe 1970 model efficiency nse the coefficient of determination r 2 and the regression coefficient r were used to evaluate the goodness of fit between simulated and observed values after the proper calibration and validation the oryza n model was applied to quantitatively assess the water and n uses and their respective effects on crop growth and yield formation as a result this modeling exercise can further provide a set of reasonable parameter values for n simulation of jrc 4 results and discussion 4 1 modeling performance the results of this study showed that the model performed well in simulating hydrological processes n dynamics and crop growth in the jrc field during the calibration and validation periods figs 6 9 and table 4 the water crop related parameters calibrated in the companion paper gao et al 2021 without considering n effects remained the same while the nitrogen related parameters are now calibrated as listed in table 3 this was mainly because the soil water crop processes were almost unaffected by the n dynamics due to adequate n supply in the jrc study case simulations of the various dry biomass components d agb dwst dwgl and dwso and lai all matched well with the measured values fig 6 the simulated pwds also were in agreement with the observed values fig 9 the goodness of fit indicators were also all very close to those in the previous companion paper gao et al 2021 both in calibration and validation table 4 the simulated crop yields were 7200 and 8048 kg ha 1 in 2019 and 2018 respectively which were only slightly different from the observed ones 7081 566 kg ha 1 and 7604 738 kg ha 1 for crop n uptake the model could well capture the dynamic processes of n uptake partition and translocation in the plants fig 7 and table 4 during calibration the mre and rmse were 26 3 and 7 8 kg n ha 1 respectively with the nse achieving 0 98 for the amount of n in the aboveground biomass crop an agb for the amount of n in stems anst green leaves anlv and panicles anso the mre and rmse ranged from 9 4 to 51 3 and from 2 6 to 6 8 kg n ha 1 respectively while the nse values were between 0 75 and 0 98 table 4 some discrepancies may be attributed to the fact that destructive sampling was conducted for crop growth monitoring which cannot reflect the real continuous growth of a rice plant for validation the goodness of fit for anst anlv and anso resulted in mre rmse and nse values ranging from 12 2 to 10 5 4 6 to 8 6 kg n ha 1 and 0 88 to 0 94 respectively table 4 the foregoing results indicate that the oyrza n model could well simulate the root n uptake and the n partitions in different organs in addition the simulated and observed nh4 n and no3 n concentrations in the soil solution of the root zone 0 25 cm were compared as shown in fig 8 the results indicated that the calibrated model reasonably captured the change trends of the observations i e the rapidly increasing trend after fertilization and subsequent slow declining trend but the simulation accuracy was not as good as that for crop n uptake this was mainly because the simulation for nh4 n and no3 n concentrations was inherently more difficult than that for other terms due to the complex processes of n transport and transformation in rice paddy fields the fertilizer spreading patterns also may increase the uncertainty in the observations moreover the lower fit between the measured and simulated values in some stages might have been caused by untimely measurement of samplings particularly for nh4 n during 2018 the possible nitrification of soil samples resulted in relatively lower nh4 n contents and thus higher no3 n contents fig 8b nonetheless the general agreement between the simulated and measured data both for calibration and validation implies that the model performance was acceptable note that the statistical indicators that returned less acceptable results such as for the nse table 4 also are usually not often reported in application studies like this one due to the difficulties previously mentioned hence the calibrated model can be applied to evaluate field water use crop growth and n use for jrc 4 2 parametrization of nitrogen related processes table 3 lists the calibrated values of the main nitrogen related parameters for jrc and compares them to the default recommended values for tropical and subtropical rice results show that the parameters for jrc grown in an environment with lower cumulative temperatures and more fertile black soils were specific and significantly different from those for rice varieties grown in warmer regions the residual n fraction of leaves and stems for jrc were 0 0176 and 0 0065 kg n kg 1 respectively throughout measurements being much larger than the default values 0 004 and 0 0015 kg n kg 1 respectively for rice in tropical regions the measured maximum n concentration in storage organs panicles reached 0 0279 kg n kg 1 which was obviously higher than the default value of 0 0175 kg n kg 1 note that the root system of jrc is not so developed compared to rice in tropical subtropical regions and thus the translocation fraction from roots to panicles i e nmaxso 0 05 was correspondingly less than the default value 0 15 table 3 it was found that the maximum leaf n fraction i e nmaxlt for jrc was less than the default values in all developmental stages table 3 the leaf n content is mainly affected by light conditions and its levels are generally consistent with the intensity of light conditions yin et al 2019 zhu and zhang 1985 in cold regions light conditions and radiation intensity are lower than those in tropical subtropical regions this explains the lower calibrated value of nmaxlt for jrc in addition some newly introduced parameters for simulating n transport and transformation processes also are included in table 3 these parameters were calibrated and determined based on the values available from some previous research hansen 2002 holzworth et al 2014 kroes and van dam 2003 mccown et al 1996 these parameters were mainly in the ranges of recommended or were reported values and thus had reasonable physical meaning however these parameters are still required to be calibrated more rigorously when more soil n data become available from experiments in black paddy soils for jrc note that parameters related to the decomposition rate c n ratio and substrate utilization of the three n pools are sensitive to the n simulation process and should be given more attention in modeling applications conclusively the foregoing nitrogen related parameter values should be meaningful to n modeling work for jrc 4 3 nitrogen uptake and biomass production for jrc with adequate n supply the crop n uptake showed a similar trend in the growing season of 2018 and 2019 fig 7 the an agb at harvest was about 160 kg n ha 1 in both 2018 and 2019 which was consistent with the values 151 169 kg n ha 1 reported by zhang et al 2020 for jrc with n fertilizer of 110 kg n ha 1 actually the an agb of japonica rice usually shows a large range of variation under sufficient n supply e g ranging from about 140 to 215 kg n ha 1 for different varieties and climatic regions according to the literature chu et al 2019 jing et al 2008 zhang et al 2007b zhu et al 2020 the n amounts of various organs followed a similar trend as the biomass figs 6 and 7 during the early growth periods i e from late may to early july anlv was approximately twice as much as anst fig 7 anlv reached a maximum value of about 50 kg n ha 1 at the stage of jointing and booting around late july and then decreased gradually meanwhile anst increased slowly and reached the maximum about 45 kg n ha 1 by the blooming stage early august and then had a decreasing trend during the reproductive phase the translocation of n from other crop organs to the panicles was accelerated with the rapid growth of the storage organs fig 7 when approaching harvest anst and anlv decreased rapidly due to the death of green leaves and n translocation to panicles while anso showed a rapid upward trend with the increase of dwso the n translocation from stems leaves and roots to panicles started when panicles were formed in early july figs 6 and 7 before panicle formation the an agb was 39 5 and 50 0 kg n ha 1 in 2018 and 2019 respectively the percentages of anst anlv anld and anso to the an agb were similar in the two years equaling about 15 5 25 and 55 respectively table 5 in both years the amount of n transported from the roots stems and leaves to the panicles was about 4 50 and 30 kg n ha 1 being 5 60 and 35 of the anso respectively at harvest the an agb reached 162 9 and 162 5 kg n ha 1 in 2018 and 2019 respectively anst anlv anld and anso respectively reached 25 6 6 2 36 4 and 94 7 kg n ha 1 in 2018 and 27 4 8 7 41 8 and 84 6 kg n ha 1 in 2019 table 5 anlv was the lowest among all organs occupying less than 4 of an agb anst and anso accounted for about 16 and over 50 of an agb respectively table 5 the differences between 2018 and 2019 were mainly caused by the higher radiation and temperature in the key reproductive period i e july and august during 2018 fig 5 resulting in both about 12 higher crop yield and anso at harvest in that year 4 4 nitrogen dynamics balance and utilization efficiency the total n supply tns was mainly from the initial soil mineral n storage fertilizer application and organic matter mineralization in the current field experiments table 6 the n amount from fertilizer was 134 7 and 137 5 kg n ha 1 in 2018 and 2019 respectively table 2 accounting for about 40 45 of the tns these values are relatively low compared to the average amount of n fertilization about 180 kg n ha 1 used in a single rice season in chinese paddy fields peng et al 2002 simulation indicated that the mineralization rate was relatively stable throughout the growing seasons fig 9 the soil mineral n storage was the second largest component of the tns 22 25 the n amount from net mineralization reached about 73 kg n ha 1 for both 2018 and 2019 which was generally higher than the values in most paddy fields in china reported in previous research e g mainly 51 62 kg n ha 1 in the yangtze river basin tang et al 2006 zhu and wen 1992 the n supply from wet deposition and irrigation water was only about 23 kg n ha 1 10 of tns the results showed that the tns in jcr fields was lost through denitrification leaching surface runoff n2o emissions from nitrification immobilization and ammonia nh3 volatilization table 6 the total n loss tnl in 2018 and 2019 was 146 8 and 113 7 kg n ha 1 accounting for 44 4 and 38 1 of the tns respectively denitrification was the largest consumption item among n loss components the n loss by denitrification in 2018 and 2019 was 88 8 and 50 1 kg n ha 1 accounting for 26 9 and 16 8 of the tns respectively previous studies have shown that the nitrogen loss by nitrification denitrification in rice fields was about 16 41 tang et al 2006 zhu 2000 and thus simulation results in this study were within a reasonable range the n leaching from the vertical percolation in the soil profile was 33 6 and 38 4 kg n ha 1 in 2018 and 2019 respectively which accounted for around 10 13 of the tns due to the similar runoff observed in 2018 and 2019 the n loss from surface runoff was 13 3 and 13 9 kg n ha 1 respectively around 4 of the tns the nh3 volatilization amount was about 10 kg ha 1 in both 2018 and 2019 accounting for around 7 of the total n fertilization applied which was consistent with some field measurement research results 4 17 huang et al 2006 zhu 2008 li et al 2018 the n immobilization only occurred when mineralization did not exist and could almost be neglected n2o emissions from nitrification were 1 5 and 0 3 kg n ha 1 in 2018 and 2019 accounting for only 0 5 and 0 1 of the tns respectively however n2o emissions from denitrification reached 30 5 and 15 0 kg n ha 1 in 2018 and 2019 respectively and the differences between the two years should be attributed to different ponding water conditions during the growth periods in 2018 the repeated surface drying and water ponding from the middle reproductive period to maturity i e after mid august enhanced soil nitrification and subsequent denitrification subsequently resulting in more soil mineral n loss in comparison nitrification and denitrification were relatively weak in 2019 due to the persistence of the ponded water above the field surface fig 9 over 50 of the tns was taken up by the aboveground parts with nearly 7 of the tns stored in the roots for jrc the internal n use efficiency i e the grain yield divided by an agb was 49 4 and 44 3 kg kg 1 in 2018 and 2019 respectively this value was in the range of some previously reported values for japonica rice in japan and eastern china 40 8 53 3 kg kg 1 jing et al 2008 sun et al 2021 zhao et al 2011 the foregoing analysis showed that reducing n leaching and n loss by denitrification could further improve n use efficiency the appropriate practices should focus more on controlling the suitable shallow ponding water depth at necessary flooding stages and applying timely drainage during the sun drying stages especially avoiding alternative dryness and flooding in order to improve n utilization for jrc the foregoing quantitative analysis of n fate could provide beneficial field management and policymaking information for farmers and managers 5 summary and conclusions in this paper the oryza n model was developed as an enhanced soil water nitrogen plant coupling model for paddy rice fields based on the comprehensive improvement of oryza2000 it was designed to particularly strengthen the simulation capability of nitrogen n fate the significant modifications mainly included the incorporation of three new models a soil temperature module for numerically solving the soil heat conduction equation a multi layered solute module for simulating advection dispersion and reactions of ammonium nitrogen nh4 n and nitrate nitrogen no3 n in the soil and soil nitrogen modules describing soil organic carbon and nitrogen turnover meanwhile the calculation of root water uptake and soil water drainage also were improved to reasonably describe the soil water fate and its effects on root n uptake the oryza n model was then calibrated and validated with detailed two year field experimental data 2018 and 2019 of japonica rice in cold regions jrc in the northeast china plain necp simulation results indicated that the above modification made the oryza n capable of describing the n transfer and transformation in soil media uptake by roots and partitions translocation in rice organs very well the simulated crop indicators for aboveground biomass biomass of stems green leaves panicles leaf area index and grain yield and n indicators n amount in the aboveground biomass stems green leaves and panicles showed quite good agreement with field observations simulated fluctuation trends for nh4 n and no3 n contents in the soil were also reasonable although the simulation accuracy was not as good as crop n the nitrogen related parameter values were determined for jrc by combining the detailed measurements with model parameterization and were different from the parameters for rice varieties planted in tropical subtropical regions thus the result of this study can complement the parameter database for jrc modeling the model application indicated that initial soil mineral n storage and fertilizer application contributed nearly 70 to total n supply tns in the jcr field the net mineralization reached about 73 kg n ha 1 and accounted for about 22 25 of the tns around 60 of the tns was taken up by the crop including aboveground parts and roots the total amount of n in the aboveground biomass an agb was about 160 kg n ha 1 at harvest with the percentage of n in stems green leaves dead leaves and panicles being about 15 5 25 and 55 respectively the total n loss in 2018 and 2019 was 146 8 and 113 7 kg n ha 1 44 4 and 38 1 of the tns respectively with the n loss by denitrification the largest n loss item amounting 88 8 and 50 1 kg n ha 1 during the years 2018 and 2019 respectively the difference in denitrification losses between the years was caused by the ponded water and drying conditions at different stages the n transformation analysis indicates that maintaining suitable shallow waterlogging during flooding stages and the timely drainage at sun drying stages could reduce n loss through leaching and denitrification in summary the oryza n model may be a reliable tool to quantify n fate and support rational irrigation and fertilization management moreover the model can help researchers simulate rice growth soil water nitrogen comprehensively for jrc in northeast china and other cold weather places follow up investigations will focus primarily on testing model parameter sensitivity and structural uncertainties credit authorship contribution statement ya gao conceptualization software formal analysis writing original draft writing review editing chen sun conceptualization methodology supervision writing review editing tiago b ramos data curation writing review editing zailin huo resources project administration guanhua huang resources supervision project administration xu xu conceptualization methodology supervision funding acquisition project administration writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research was supported by the national natural science foundation of china grant no 52022108 and the 13th five year national key research and development program of the chinese ministry of science and technology grant nos 2016yfc0400107 and 2017yfd0300403 a scholarship to ms ya gao from the china scholarship council to support her one year stay at the university of lisbon also is acknowledged t b ramos was supported by contract ceecind 01152 2017 of the fundação para a ciência e a tecnologia portugal supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j ecolmodel 2022 110184 appendix supplementary materials image application 1 
24291,cropmetapop is a new simulation tool to model the genetic evolution of crop diversity under on farm dynamic management under this type of conservation and use of varieties seeds are resown and exchanged between farmers and the set of connected populations is described as a crop metapopulation cropmetapop is therefore at the interface of genetic and social processes we used sensitivity analyses to check the behaviour of the model and to identify which parameters and range of values for them induce the most variability in the outputs cropmetapop was found to behave as expected depending on the type of locus studied neutral or selected the parameters related to drift or selection were those that induced the most variability in the outputs colonisation migration and network topology parameters were less influential looking at the detailed results will help setting the parameters to relevant values in the future utilisation of the model keywords genetic diversity dynamic management seed network agent based model agroecology data availability data will be made available on request 1 introduction in small scale farming systems farmers save their seeds from one year to the next and often exchange seeds for a variety of reasons including the search for better production seed loss or even curiosity pautasso et al 2013 seed circulation among farmers has been shown to greatly impact the genetic diversity of the plant populations they grow in their fields fuentes et al 2012 louette et al 1997 pressoir and berthaud 2004 those crop populations are linked by past or future seed transfers and are subject to extinction for these reasons they can be considered as a particular case of metapopulation called crop metapopulation which is submitted to farmers management van heerwaarden et al 2010 farmers seed management practices and the functioning of these cultivated metapopulations are at the interface between social and ecological processes and understanding the impacts of farmers practices and organisation on the dynamics of crop populations diversity is a complex issue that seems unlikely to be tackled through experimental pautasso et al 2013 or analytical approaches only indeed setting up experiments aimed at comparing the impact of different management methods would be far too cumbersome too long e g to observe allele fixation time kimura 1980 and therefore too costly a modelling approach is therefore well suited to such studies which allows cheap and fast results though they might lack accuracy several metapopulation models exist such as quantinemo 2 neuenschwander et al 2019 which is considered the most comprehensive one available the extensivity of this model can address four features specific to crop metapopulations as describes by van heerwaarden et al 2010 these are 1 the large number of offspring per plant 2 the non random seed circulation 3 the low rate of seed circulation and 4 the rare bottlenecks during recolonisation events despite this several key features are misrepresented in quantinemo 2 extinction occurs after the regulation of adults see fig 1 a whereas it seems more likely to occur during the seed storage phase in crop metapopulations after seed production and before the seedling or adult phases i e before regulation the order of events during a life cycle has been shown in the literature to influence the evolution of local adaptive polymorphism ravigne et al 2004 massol and débarre 2015 although the authors do not explicitly address extinctions we assume that such a change is likely to have the same kind of impact on the results for this reason it seems important to represent extinction at the most likely phase of the cycle furthermore quantinemo 2 does not distinguish between migration and colonisation whereas the two processes allow to represent two coexisting situations that are classically encountered by farmers who produce their own seeds migration allows to represent situations quite frequently encountered in subsistence farming systems where farmers need to supplement their own seed stocks to sow their entire available field in this context they used to acquiring seed locally within their village from relatives neighbours or friends through gift exchange or purchase boster 1986 wencélius et al 2016 thomas and caillon 2016 violon et al 2016 colonisation coupled with extinction represents more extreme but less frequent situations in which farmers no longer have seed stocks after a poor harvest due to climatic hazards or because of problems with seed storage fenzi et al 2021 violon et al 2016 it has been described that in this type of situation people change their seed supply network by going to obtain seed from relatives or acquaintances outside the village in some case travelling very long distances fenzi et al 2021 violon et al 2016 bellon et al 2011 song et al 2019 the simultaneous consideration of these two social processes into account offers the possibility of representing relatively accurately situations commonly encountered in agriculture finally an other critical feature van heerwaarden et al 2010 is to define independently the seed transfer rate and the level of seed replacement between every pair of populations because in crop management migration is episodic rather than continuous and involves enough seeds to limit the bottleneck all these deviations from classical metapopulation models such as those implemented in quantinemo 2 prompted us to develop cropmetapop a model of cultivated metapopulations in the continuity of the work that was conducted by van heerwaarden et al 2010 to investigate the impact of seed exchanges and farmers management practices cropmetapop 1 1 the software is available at https forgemia inra fr cropmetapop cropmetapop wikis home is an agent based model where agents are individuals represented by plants or seeds which was specifically designed to model cultivated populations and the gene flows resulting from seed circulation due to the social interactions between farmers labeyrie et al 2016 calvet mir et al 2012 mcguire 2008 cropmetapop simulates the evolution of individuals represented as multilocus genomes organised into populations in turn organised into a metapopulation it aims at simulating the evolution of seed lots within the context of seed exchange following the social network of the farmers the life cycle of individuals in cropmetapop is described in fig 1 and presents the comparison between the life cycles of cropmetapop and quantinemo 2 it allows to model various genetic situations low or high genetic diversity weak or strong population differentiation for instance moreover different parameters can be specified to best represent the crop of interest mating system number of individuals per population etc one can also finely tune the seed movement parameters for migration and for colonisation such that the probability of seed exchange is defined between all pairs of populations due to the large number of parameters in the model performing a sensitivity analysis sa in the following saltelli et al 2019 burgers et al 2010 of the model was needed to better understand its behaviour and to ensure that it performs as expected sensitivity analyses also provide a better understanding of which input parameters are responsible for the variability of the model s outputs lurette et al 2009 lamboni et al 2011 finally one can use sas for a better targeting of a realistic range of parameters to be used in the model the two objectives of this paper are i to introduce the cropmetapop model and software and ii to conduct several sas of the cropmetapop model in order to check that the model behaves as expected and to assess the relative importance of the parameters in the model based on the variability they induce in the outputs 2 materials and methods this section begins with a description of the cropmetapop model it continues with the presentation of the main steps to be taken when performing a sensitivity analysis before introducing the 6 sensitivity analyses performed in this paper 2 1 the cropmetapop model 2 1 1 technical features of cropmetapop cropmetapop can be seen as a wrapper library for simupop specifically designed to easily simulate crop metapopulations simupop peng and kimmel 2005 peng and amos 2008 is a python library for the simulation of stochastic individual based model accounting for mutation genetic drift migration and selection and for demographic processes such as extinction and colonisation cropmetapop provides a useful and practical addition to simupop by integrating specific characteristics of crop metapopulations such as in particular the possibility to generate or import various connection matrices to link the fields together it also integrates modules to create random networks with specific characteristics it is therefore designed to represent accurately seed transfer processes with specific parameters cropmetapop is a console program written in python3 using an object oriented approach it allows running simulations without knowledge about coding by just filling a text based simulation file and it can be run on any computer platform tests restricted to one or sometimes two evolutionary forces at a time made it possible to verify that the model was able to find the theoretical expectations data not shown and thus to validate the broad lines of its operation 2 1 2 general features in the context of seed management by farmers organisations a crop metapopulation may correspond for instance to different versions here referred to as populations of the same variety of a considered species cropmetapop relies on the following life cycle breeding extinction within population regulation colonisation migration and meta population regulation the model works with discrete and non overlapping generations which makes it more suitable for representing annual or short generation time species depending on the life cycle stage each individual is either a plant in the field or a seed that may circulate among populations in the following the populations are equivalent to the demes as well as the fields to the patches 2 1 2 1 demographic features of cropmetapop cropmetapop accounts for several social features of the farmers networks number of farmers involved and number of populations per farmer and farming practices sowing density and field size by simulating a finite number of populations each composed of a finite number of crop plants corresponding to the demographic size each population is cultivated in a field characterised by the maximum number of plants that can be grown there called carrying capacity the demographic size may vary from one generation to the following one according to the number of offspring produced per individual called fecundity the demographic size of a crop population can grow up to the carrying capacity of the field in which the population is cultivated each population is subject to extinction colonisation or migration in each generation it should be noted that pollen flows between fields are neglected in cropmetapop because we consider that farmer practices limit such phenomenon they take care to grow different varieties at sufficient distances in the case of mainly self pollinating species and will generally only grow one variety under isolated conditions in the case of a cross pollinating species e g pearl millet naino jika et al 2017 maize or onion in the context of crop metapopulation extinction may correspond either to difficulties in maintaining the population e g climatic or pest disasters or to the choice of replacing the population with a potentially more interesting one colonisation and migration will be defined in the following section 2 1 2 2 genetic features of cropmetapop to account for a critical biological feature of crops each crop metapopulation is characterised by a selfing rate ranging from 0 open pollination to 1 self pollination each diploid individual plant i in a given field j consists in a finite set of genetically linked or independent loci each locus is biallelic or multi allelic mutation rate is defined for each locus and mutation may occur at each reproduction event each locus may correspond to a neutral marker or to an adaptive marker located in a gene associated to a genetic value the sum of the genetic values of all adaptive markers provides the individual genetic value of a quantitative trait g i under selection natural selection due to the local pedo climatic conditions or to particular farming practices is accounted for by applying selection for a local optimum defined for each field depending on the local field optimum o p t j the individual fitness w i j is assumed to have a classical normal shape johnson and barton 2005 centred on the local optimum w i j e 1 2 g i o p t j 2 with i an individual plant and j a given field similar or different optima can be assigned to the different fields in order to compute plant fitness and apply various patterns of selection to local populations during the breeding step the parents of each offspring are randomly selected proportionality to their fitness when genetic values and fields optima are defined within population regulation is applied after seed production to adjust potential excess of offspring to the carrying capacity of each population 2 1 3 special features in cropmetapop the focus has been on describing seed circulation practices in order to represent a diversity of socially established rules that underpin the circulation of seed among farmers two different processes are considered to model seed circulation colonisation and migration colonisation arises after the extinction of a local population while migration happens when farmers mix intentionally or unintentionally their own seed lot with foreign ones unlike other metapopulation simulation softwares cropmetapop can model both colonisation and migration in the same simulation with the possibility to use two different social networks if necessary because we consider that farmers can solicit two different social networks depending on the context in both cases seed circulation is a stochastic process and seed supply can come from one or from several non empty fields when farmers are socially connected the amount of seed in circulation is defined at the level of metapopulation regulation on the basis of donor seed supply and receiver seed demand for instance one farmer can give seeds to neighbours according to his or her stock and receive seeds from them depending on his or her needs in addition for migration it is possible to define the rate of local seed replacement which can be different from the migration rate this specific feature is necessary to take into account the fact that migration rarely occurs but with a potentially strong impact in terms of genetic composition on the receiving population when the seed replacement rate is huge 2 2 sensitivity analysis approach cropmetapop is a stochastic simulation model that allows to adjust the values of more than 10 parameters predicting the behaviour and results of simulations can be very complicated in some situations to better understand the general behaviour of the model we propose to use sas performing a sa of a model first requires defining the input parameters and output variables of the model to be analysed it is then necessary to run the model for a large number of combinations of input parameter values for each combination values are obtained for the different output variables of the model sa relies on variance analysis to attribute the variability of the outputs of the model to one of the parameters changing in the simulations cariboni et al 2007 burgers et al 2010 carpani et al 2012 in this paper we chose to vary the main parameters that control biological features and evolutionary forces of the crop metapopulations i e the selfing rate to characterise the mating system the population size for genetic drift the mutation rate the number of locus under selection and local selection optima extinction and colonisation rate migration rate and network topology for colonisation and migration in order to study in depth the evolutionary processes of particular interest to us we have divided the work into six sas this allowed us to better describe the impact of each parameter in each sa the parameters chosen to vary in these sas were carr cap carrying capacity the number of individuals in the population percentself percent of selfing the proportion of individuals in the population that are autogamous mutrate mutation rate of each locus nblocsel number of locus of the genome that are under selection optimum optimums of the demes the set of optimums to which the genotypic value of the individuals are compared to compute the fitness of each individual in the deme colrate colonisation rate between two populations extinction extinction rate of the populations network network topology type see section 2 2 3 for the tested graph topologies nbedges number of edges in the network i e the number of social relationships in the metapopulation migrate migration rate i e probability of seed lots between two populations migreplace proportion of replaced individuals in the destination population during migration the other parameters of the simulations have been set to fixed values the most important ones are displayed in table 1 the number of generations generations to achieve the sas was set at 30 which represents situations that can be observed in reality beyond that it seems unlikely that the social networks are the same for example therefore exploring the behaviour of the model over a longer period of time does not seem to be a priority with respect to the conditions of use of the model the number of replicates replicates was set to 10 to capture some of the stochasticity of the model while limiting the simulation time of the sas the number of populations nb pop was set at 100 which corresponds to a reasonable number of people involved in a collective action of crop diversity management the number of alleles nb allele was set to two to represent snps the fecundity parameter fecondity was set to 4 to produce enough offspring to allow for migration events while limiting simulation time the number of neutral markers defined as the difference between the total number of markers nb marker and the number of markers associated with a fitness value was set to 10 to be able to follow the evolution of several loci simultaneously while limiting the simulation time to assess the impact of the parameters variation genetic diversity indices see section 2 2 4 were computed on genotypic data the protocol was the same for the six sas it consisted in the following steps 1 creation of the design of experiments with the correct number of parameter section 2 2 1 2 creation of the simulations setting files and of the launcher files for the simulations section 2 2 2 3 launch of the simulations 4 analysis of the genetic monolocus data section 2 2 4 launched with the scripts generated in section 2 2 2 5 gathering of all the files in big files by indicator 6 sa of the resulting files section 2 2 5 7 the graphs interpretation of the sas section 2 2 6 2 2 1 creation of the plan of simulation in order to avoid running thousands of simulations a fractional factorial design was applied using the r package planor kobilinsky 2005 kobilinsky et al 2017 2019 for each of the six sas of cropmetapop this package allowed us to run less than 500 simulations where 20 000 would have been needed with a full factorial design it requires to set each parameter chosen to an equal number of level and allows to determine up to second order interactions between the parameters i e interaction of one parameter with one other it returns a design of experiments composed of a list of levels combinations this design of experiments was exported to a comma separated value formatted file and used as an input for the scripts generating the setting files for the simulations and the analysis to run in this paper we chose to use three levels for each parameter we considered it allows to correctly yet concisely explore the variation ranges of the parameters of the model we chose for every parameter a low realistic value a high realistic value and an intermediary value 2 2 2 creation of the simulations the setting file generator creates one configuration file for each replicate and for each of the levels combination in the design of experiments it associates to the set of levels described in the design of experiment the correct corresponding values to each parameter it also writes two more files one that contains the set of simulations to run on the computer cluster the simulation launcher file and the other that contains the corresponding analyses to run after the simulations the analysis launcher file the ten replicates of every parameter combination are split in separate simulations in order to maximise the variability of both the network topology used and the genetic diversity at initialisation these replicates are then grouped together to perform the analysis of monolocus data the simulations are initialised genetically by sampling for each locus of each individual a random allele between the two available at each locus this process can induce an imbalance in the frequencies of each allele especially in small size populations this can also induce linkage disequilibrium between markers 2 2 3 network topologies tested we used three contrasted topologies chosen to be representative of the reality of the systems we model the erdős renyi network topology erdős and rényi 1959 in which the connections between the populations are randomly and statistically equally distributed was designed to represent a perfectly distributed and horizontal network we then used the community network topology nowicki and snijders 2001 girvan and newman 2002 in which the connections between the populations are more frequent within a community to represent the collective management of seeds in different farmers organisations last we used the barabási barabási and albert 1999 topology network in which only a few populations are connected to many other populations this was chosen to represent centralisation around a few major actors in the seed system the densities have been chosen to represent networks with low medium and almost maximal densities for the sas that focused on migration or colonisation a library of networks was generated before the simulations to maximise the network topology stochasticity a total of 900 networks was generated in the library a network with corresponding parameters was randomly selected in the library and written in the configuration file 2 2 4 monolocus data analysis for each sa after the simulations the data of each replicate that have the same parameter combination and that are in separate folders were gathered in the same file all the files i e all simulations were then analysed by a python script to compute two genetic and one demographic indicators for each generation including the average within population expected genetic diversity expected heterozygosity hs nei 1987 the average genetic differentiation gst weir and cockerham 1984 takahata and nei 1984 and the survival rate surv of the populations h s s 1 s l 1 l 1 i 1 i p i l s 2 l s g s t s 1 s h t s h s s h t s s with h t l 1 l i 1 i p i 2 l and s u r v 1 number of non empty populations total number of populations with i the number of alleles l the number of loci and s the number of populations this analysis produced as many result files as there were combinations of parameters and indicators these files were then merged by indicator to produce the final result files of the simulations these indicator files contain the average indicator values over the ten replicates 2 2 5 sensitivity analysis for each sa the resulting files were then analysed for each indicator with the r multisensi package bidot et al 2018 lamboni et al 2009 2011 it allows to evaluate the share of every parameter in the variability of the output along with time determining up to second order interactions of parameters it takes as inputs a merged indicator data file and the design of experiments created by planor and returns detailed sensitivity indices as well as several graphs including one presenting the evolution of the share of every parameter to the variability of the output indicator of the model along time such as in figs 2 and 4 2 2 6 graphs interpretation for each sa the lower part of the graph represents the main sensitivity indices for each input parameter normalised between 0 and 1 the bigger the width of the ribbon of the parameter the more the parameter is important to explain the variability of the model output at the given generation for clarity interactions of parameters are merged and represented in a unique ribbon the residual represents the part of the variability of the model that cannot be explained by any parameter or second order interaction the upper part of the graph represents the distribution of the output of the model the dark heavy line represents the mean of the data the grey area represents the quartiles of the data the blue dotted lines cover 90 of the data and the red dotted lines the extreme data one can consider that the wider the distribution the more significant the effects we detect the figs 2 c 3 c 4 c 5 c and 7 present the total sensitivity indices i e the sum of the sensitivity indices of each parameter and of its interactions with other parameters for the last generation of all sas as the last generation sensitivity indices is the sum of interactions attributed to two parameters the sum of all shares can be superior to 1 2 3 a six sensitivity analyses system 2 3 1 description six sas were performed to identify the parameters that induce the most variability in the results according to the evolutionary forces considered these sas differ according to two criteria if and how the populations are connected isolated connected by colonisation connected by migration and the type of markers studied neutral or under selection their names follow a pattern describing first the connection of populations isolated populations colonisation extinction or migration and then the type of markers studied neutral markers or selected markers note that the results of two sas are not comparable since they are not based on the same set of input value combinations the values of the parameters for each sas are presented in tables 2 4 for each of the parameter chosen we defined three levels which were fixed to span over most of the actual variation ranges of the parameters mutation rates were chosen to cover the range of values that can be found in vivo raquin et al 2008 schoen and schultz 2019 the number of loci under selection were chosen to represent cases with no selection and with selection when selection was present in the simulations we chose to represent cases with a monogenic traits or traits composed by 5 or 10 loci even though these numbers are quite low compared to the number of loci associated with traits in vivo e g for wheat height zanke et al 2014 we were able to show expected dynamics for selection and spared computation time other parameters were chosen to cover a wide range of realistic values for every parameter with one intermediary value in order to have contrasted effects with the parameter range carr cap ranged from 40 vegetable like size of population to 1000 to represent cereal populations those populations can be a lot bigger but genetic drift is estimated to be fairly reduced from 1000 individuals nei et al 1975 percentself ranged from 0 purely allogamous individuals to 0 95 mostly autogamous individuals to represent the most species possible optimum were chosen to represent contrasted situations of selection where individuals are all in the same environment individuals are in two contrasted environments individuals are in environments all different one from another network more information about network topologies can be found in section 2 2 3 colrate and migrate were chosen to represent situations with very few to a lot of colonisation migration i e one event in a hundred generations to one event every four generations per population extinction were chosen to represent situations with very few to a lot of extinction i e one event in a hundred generations to one event every four generations per population migreplace were chosen to represent situations where only a hundredth of the population is replaced to half of the population is replaced by migration events nbedges more information about network topologies can be found in section 2 2 3 2 3 2 hypotheses qualitative hypotheses regarding the nature of the results are proposed for each of the six sa based on the main principles of population genetics 2 3 2 1 hypotheses for isolated populations neutral markers here as we analyse the genetic diversity indicators at neutral markers that are not linked to selected genes selection is not expected to have any impact neutral markers will only be submitted to genetic drift and mutation and the sampling effect due to the carrying capacity dobzhansky and pavlovsky 1957 is expected to be the main source of variability of such genetic diversity indicators mutation introduces new genetic diversity but we do not expect it to be important in the analysis because we run the simulations over too few generations for the mutations to accumulate halligan and keightley 2009 at equilibrium in a finite size population only submitted to mutation diversity will be maintained if 4 n e μ 1 taking the carrying capacity as a rough value for the genetic effective size only one set of parameter values carr cap 1000 and mutrate 10 3 would meet the condition moreover as the simulations are far from reaching equilibrium the time period studied being very short compared to 4 n e mutation is not expected to contribute to variability in the outputs of the simulations crow 1950 2 3 2 2 hypotheses for isolated populations selected markers we analyse here the genetic diversity indicators at the selected markers the evolutionary forces on the selected markers are the genetic drift mutation and selection kirk and freeland 2011 the selection should affect the most the variability of the indicators as populations are generally initialised far from the populations optima genetic drift is also expected to affect the variability of the indicators due to cases with small population sizes as for neutral markers mutation is not expected to contribute much to variability 2 3 2 3 hypotheses for colonisation extinction in these sas we analyse the genetic diversity at neutral and selected markers separately in cases where populations are connected by colonisation and submitted to extinction as we add colonisation and extinction to the isolated populations sas we expect the same genetic forces to contribute to the variability of the model i e genetic drift and selection together with colonisation and extinction the importance of the contribution of each parameter is difficult to foresee due to the multiple parameters of the system and little information is available from analytical approaches moreover the demographic forces of the simulations and the network topologies are expected to contribute to most of the variability of the survival rate barbillon et al 2015 2 3 2 4 hypotheses for migration in these sas the genetic diversity is analysed separately at neutral and selected markers in cases where populations are connected by migration for genetic diversity parameters the expectations are quite similar to those of colonisation extinction sas as migration and colonisation both correspond to seed circulation among populations therefore influencing both within and between population genetic diversity indices so the same genetic forces are expected to contribute to the variability of the model i e genetic drift and selection as well as migration and network topologies but without presuming the relative importance of the different parameters 3 results 3 1 isolated populations 3 1 1 isolated populations neutral markers the mean expected heterozygosity hs in the sa isolated populations neutral markers decreases from 0 5 to 0 4 over the thirty generations fig 2 a its variability also increases with 90 of the simulations between 0 5 and 0 25 hs at the thirtieth generation the mean population differentiation gst in the sa isolated populations neutral markers increases from 0 to 0 25 cf fig 2 b the variability also increases during the simulations with 90 of the replicates between 0 and 0 5 the carrying capacity carr cap in the figures i e the size of the populations explains most of the variability of the expected heterozygosity indicator for the sa isolated populations neutral markers fig 2 a the remaining variability of the model is mostly explained by the reproduction regime percentself in the figures the same phenomenon can be observed for the population differentiation indicator gst fig 2 b the same distribution of the variability is observed for both indicators in the last generation graph for the sa isolated populations neutral markers as shown in graph fig 2 c 3 1 2 isolated populations selected markers the mean hs indicator decreases from 0 5 to 0 3 over time fig 3 a and its variability maximises at the fifteenth generation with 90 of the replicates between slightly less than 0 5 and 0 at the last generation the mean gst increases from 0 to 0 2 over time its variability maximises at generation 15 with 90 of the replicates between 0 and 0 95 at the last generation fig 3 b the number of loci under selection nblocsel in the figures explains most of the variability of hs fig 3 a during the first three generations the carrying capacity explains transiently most of the variability of the indicator later replaced by the reproduction regime interactions explain almost half of the variability of the gst indicator in fig 3 b therefore the last generation graph fig 3 c is important to determine the components of the variability the optimum parameter optimum in the figures explains most of the variability of the gst indicator the number of loci under selection is the second most important contributor to the variability of this indicator by mostly bringing it through interaction with other parameters finally the carrying capacity and the reproduction regime both contribute to the variability of the gst especially in the early generations 3 2 colonisation extinction 3 2 1 colonisation extinction neutral markers the mean theoretical heterozygosity for the sa colonisation extinction neutral markers fig 4 a decreases from 0 5 to 0 4 during the thirty generations of the simulations 90 of hs values range between 0 5 and 0 25 extreme values in the simulations appear at the thirteenth generation corresponding to extinct or fixed metapopulations the non continuity of the variability increases the share of residual up to 0 45 of the variability when the variability becomes continuous again the residual reduces to 0 2 of the variability share the carrying capacity explains the largest part of the variability of hs in the first fifteen generations while the reproduction regime explains the remaining part the figs 2 a and 4 a display similar trends for the variability share during the first fifteen generations from the fifteenth generation to the thirtieth the colonisation rate colrate in the figures and the extinction rate extinction in the figures take a larger part in the variability of the hs indicator it is likely that particular combinations of extinction and colonisation rates high extinction and low colonisation lead to extinct metapopulations with h s 0 inducing a large variability in the outputs these two parameters are the main components of the interaction as it can be seen in the fig 4 c the mean population differentiation for the sa colonisation extinction neutral markers fig 4 b increases from 0 to 0 1 during the thirty generations 90 of the gst range between 0 and 0 4 similarly to the trends observed in the fig 2 b the carrying capacity explains most of the variability of the gst indicator especially in the first twenty generations the reproduction regime is the second most important parameter for the same generations during the last ten generations the share of the carrying capacity decreases and the extinction parameter becomes the second most important parameter as shown in fig 4 c 3 2 2 colonisation extinction selected markers the mean expected heterozygosity for the sa colonisation extinction selected markers fig 5 a decreases from 0 5 to 0 3 during the thirty generations i e as expected much more than at neutral markers 90 of hs range between 0 5 and 0 the number of locus under selection explains the largest part of the variability of the expected heterozygosity especially from the third generation on the reproduction regime is the second most important parameter from the generation four to twenty then replaced by the colonisation rate the extinction rate is also important in the last generations as shown in fig 5 c though it is mostly influencing through interactions with other parameters the mean population differentiation increases from 0 to 0 1 through the thirty generations 90 of the simulations range from 0 to 1 most of the variability of the gst indicator fig 5 b is explained by the interaction between parameters after the fifth generation in the last generation the interaction is mainly composed by the number of locus under selection and in a second order by the colonisation rate and the extinction rate as it can be seen in fig 5 c the following most important parameters are the optima of the populations and the carrying capacity 3 2 3 colonisation extinction demographic indices the survival rate decreases from 1 to 0 8 through the thirty generations fig 6 moreover the variability of the indicator rapidly increases and 90 of the simulations range between 1 and 0 04 the colonisation rate explains less than half of the variability of the indicator during the first half of the generations its share increases over the thirty generations and ends explaining the majority of the variability of the survival rate including in interaction with other parameters the extinction rate explains half of the variability of the survival rate in the early generations its share decreases during the thirty generations to stand below the colonisation rate the number of edges nbedges in the figures i e the number of social links through which seeds can circulate shows a steady share of 0 05 of the variability of the survival rate 3 3 migration the mean expected heterozygosity for the sa migration neutral markers fig a 1 decreases from 0 5 to 0 45 during the thirty generations the population differentiation of the same sa increases from 0 to 0 05 for the sa migration neutral markers the carrying capacity explains most of the variability of hs and gst indicators fig 7 a the following most important parameters are the migration rate migrate in the figure and the proportion of seeds replaced by migration migreplace in the figure the reproduction regime explains 0 1 of the variability finally the number of edges brings half the variability of the reproduction regime to the simulation compared to the colonisation extinction neutral markers sa seed circulation parameters induce less variability in the output as they do not lead to extinct metapopulations the mean expected heterozygosity for the sa migration selected markers fig a 2 decreases from 0 5 to 0 35 during the thirty generations the population differentiation of the same sa increases from 0 to 0 05 for the sa migration selected markers the number of locus submitted to selection explains the largest part of the variability of the hs indicator at the last generation fig 7 b the distribution of optima represents a source of variability over 7 fold lower the migration rate the proportion of seed replaced during a migration the carrying capacity and the reproduction regime also bring variability to the simulations to a lesser degree for the migration selected markers sa the distribution of selective optima of the populations and in a lower extent the number of locus under selection explain the greatest part of the variability of the gst indicator fig 7 b the migration rate the proportion of seeds replaced by migration and the carrying capacity explain ten times less of the variability of gst than the optimum distribution finally most of the remaining variability is explained by the reproduction regime the number of edges of the network and the network topology network in the figures 4 discussion 4 1 influence of the parameters in the different sas 4 1 1 origin of the variability for isolated populations neutral markers of isolated populations cf section 3 1 1 for the description of the sas are mainly submitted to genetic drift parameters the carrying capacity explains most of the variability of the outputs of the model and the reproduction regime is the second most important parameter the mutation rate mutrate in the figures does not induce variability in the outputs of the model which is consistent with the expectations halligan and keightley 2009 schoen and brown 1991 as genetic drift is the main evolutionary force expected on neutral markers given the rather small population sizes considered and the short time period studied dobzhansky and pavlovsky 1957 the selection parameters do not bring any variability in the outputs which is consistent with the fact that all loci markers are neutral and modelled as unlinked genetically to the selected markers and so no linkage drag is expected to occur although populations are initialised by drawing alleles at random independently at each locus sampling of a small number of multilocus genotypes in the case of small population size 40 could generate some initial linkage disequilibrium ohta and kimura 1969 this could generate variability due to the interaction between carrying capacity and selection parameters however this does not seem to be the case here in contrast selected markers cf section 3 1 2 for the description of the sa are mostly under the influence of the selection forces the number of locus under selection explains most of the variability of the hs indicator this is consistent with our hypotheses see 2 3 2 2 and is caused by the fact that the response to selection will be faster when fewer loci determine the fitness as little linkage disequilibrium is expected among positive and negative alleles at different selected markers kirk and freeland 2011 although selection is expected to be stronger in larger populations i e when genetic drift is limited than in small populations no interaction seems to influence the variability of hs indicator for the gst indicator the main parameter that explains the variability of the simulations is the distribution of the selection optima of the populations this is consistent with our expectations see 2 3 2 2 as the distribution of the optima will directly impact the differentiation among populations this is confirmed by the fact that the optimum parameter has strong interactions with the number of locus under selection for both types of markers neutral and selected hs decreases over time as expected especially as genetic drift is strong and as selection is intense for the selected markers in parallel gst increases at both types of markers the increase in differentiation is larger at neutral markers as expected wang 2015 because the sampling effect will not pick the same alleles in the different populations at selected markers the differentiation among populations depends on the optimum distribution and number of locus under selection while similar optima for all populations will lead to few or no differentiation contrasted and continuous optima can maximise differentiation depending on the number of selected locus in the case of isolated populations the genetic drift parameter i e the carrying capacity of the populations and the two selection parameters number of selected loci and distribution of the populations optima will the most influence the variability of the genetic diversity outputs depending on the type of markers we consider neutral or selected showing therefore the importance to tune these parameters finely 4 1 2 origin of the variability for colonisation extinction the genetic diversity indicators in the colonisation extinction sas are mainly influenced by the genetic drift or selection parameters depending on the markers analysed the colonisation and extinction rates are of second importance to induce variability in the outputs of the model in particular at neutral markers the colonisation rate mostly influences the within population genetic diversity through its capacity to introduce locally new diversity due to the possibility of multiple sources of seed flows while mainly the extinction rate influences the genetic differentiation among populations it is surprising that the network parameters contribute so little to the variability of the outputs of the model this could be explained by the large range of variation of the genetic drift parameter which accommodates most of the variability in contrast the colonisation and extinction parameters explain all the variability of the survival rate this is expected see 2 3 2 3 as these parameters and their relative values have a direct impact on the demography of the metapopulation in these sas the evolution of hs mean is quite similar to the evolution in isolated populations sas whatever the markers while the genetic differentiation increases much less over time due to seed circulation among populations thus even though the existence of seed flows between populations influences the evolution over generations of the genetic differentiation between populations neither the colonisation rate nor the network specificities strongly determine the variability of gst response 4 1 3 origin of the variability for migration the variability of genetic diversity indicators in the migration sas is mainly influenced by the genetic drift or selection parameters depending on the markers analysed as is the case for the isolated populations sas the migration parameters are of second order of importance to explain the variability of the output of the model the migration rate induces more variability in the outputs of the model than the colonisation rate in colonisation extinction sas for the gst of neutral markers yet as seed circulation under extinction colonisation regime is governed by the combination of both the extinction rate and the colonisation rate as colonisation can only occur in case a population became extinct one should consider the influence of these two parameters together similarly it is sensible to consider the influence of both the migration rate and the replacement rate together as under the migration regime seed circulation is governed by the combination of the migration rate and the replacement rate within the target population in the same way as the extinction and colonisation parameters in the colonisation extinction sas the migration rate and the replacement rate parameters contribute both equally to the variability of the selected markers indicators but to a smaller extent compared to variability of the neutral markers indicators finally network parameters have very few impacts on the variability of the genetic outputs as for the colonisation extinction sas this might be explained by the wide range of variation of our genetic drift parameters in the migration sas hs mean over generations decreases slightly less compared to the trends in isolated population and colonisation extinction sas while the mean gst increases less than in colonisation extinction sa indicating that the range of situations considered in migration sas leads to less structure of the genetic diversity within the metapopulation consistently seed flows between populations described here by the migration rate and the replacement rate do not strongly determine the variability of genetic diversity and population differentiation 4 1 4 early generations of colonisation extinction neutral markers the residual of hs increases very fast after the tenth generation and then reduces progressively fig 4 a this is due to the fact that for certain combinations of parameters at this generation in all the replicates the metapopulation is empty or fixed at all loci this causes a huge variability in the outputs that the analysis cannot explain by any up to second order effect or interaction afterwards other combinations of parameters lead to an empty or fixed metapopulation and the variability turns more continuous so that the analysis becomes more explanatory and thus the residual decreases it can be noted that the colonisation rate and the extinction rate have a larger share in the variability of the outputs in the late generations than in the early generations this is because in the early generations the populations are not genetically stabilised yet to their reproduction regime and population size the genetic frequencies will thus vary a lot in the early generations and only stabilise usually around the 15th generation the stabilised share of the parameters to the variability of the outputs can then be observed it is interesting to note that colonisation does not simply behave as migration the migration rate seems to influence more the variability of the gst indicator than the colonisation rate does figs 7 4 c and 5 c this might come from the fact that the migration is not dependent of an extinction process to move seeds migration could thus take place more often than colonisation creating more gene flow between populations than colonisation it is surprising that so little variability of the outputs in the colonisation extinction and in the migration sas is coming from differences in the topology of the network compared to the variability due to the genetic drift parameter and to extinction colonisation and migration rates in barbillon et al 2015 the authors evaluated with a sensitivity analysis a dynamic colonisation extinction model in the context of metapopulations to assess the impact of several parameters related to colonisation extinction network topology and density on the average survival rate of a variety over all the farms growing the variety crop metapopulation and on the persistence of the variety in the crop metapopulation the authors show that after the extinction and colonisation parameters it is the number of edges in the network that induces most of the variability then the network topology induces less but not negligible variability we show here that the same parameters induce far less variability the added genetic aspect or the large variation range of the genetic drift parameters might explain this observed difference tan et al 2017 4 2 limitations of the experimental design even if we used a fractional factorial design of experiments increasing the number of parameters beyond 9 would result in too many simulations for the duration of the simulations which ranges from a few dozens of seconds to more than 24 h moreover running six different sas allowed us to better understand the dynamics of the different evolutionary forces separately we thus chose to restrict the sas dedicated to isolated populations to 5 parameters to study evolutionary forces related to genetic drift and selection and the sas dedicated to colonisation extinction and migration to 9 parameters to study forces related to colonisation and migration respectively along with the genetic drift and selection as mentioned in the section 2 2 1 using planor requires the same number of levels for each parameter chosen as we chose to have 3 levels for our parameters i e two extreme values and an intermediate one it imposed us to chose parameters among the continuous ones and leave aside the on off parameters even if they might have been interesting to include in the sa using a fractional factorial design of experiments allows the number of simulations to be reduced considerably in our case up to 10 times less however it does not allow to detect interactions above the second order this limits the power of the analysis although we observe in the results that very little variability can be explained by second order interactions already few of the variability is explained by second order interactions this indicates that while we do not yet fully understand the role of each parameter in the variability of the indicators we expect very little divergence between what we understand of the model and what actually happens in it in addition interactions above second order not detected by the analysis are included in the residual thus as long as the residual is small one can be sure that the larger interactions induce very little variability in the model outputs the use of two separate sas for selected and non selected markers allowed a better understanding of the behaviour of the model with and without selection as when the number of selected loci is set to 0 i e no selection it is not possible to define selective optima for populations or to analyse genetic diversity at selected markers yet we are not able to quantitatively compare the results of the two sas because the combinations of parameters might interact differently in the two sas we are however able to qualitatively compare two sas with each other in order to diversify as much as possible the networks used by cropmetapop in the analysis we generated a library of a hundred networks for each combination of network type and density therefore as we run ten replicates it is quite unlikely to find the same network several times in the same parameter combination to analyse the results of the simulation more efficiently home made python scripts were created in the team it allows for an adapted and fast computation of the genetic and demographic indicators 5 conclusion here we present cropmetapop a model that addresses the lack of a suitable model to study the genetic evolution of crop metapopulations critical features of crop metapopulations that can usually not be represented in classic metapopulations models are included in cropmetapop among those features the distinct migration and colonisation processes the fact that these processes happen on seeds and not on juveniles and or adults moreover the cropmetapop allows to model precisely the seed movements that can be realised this seed circulation network can be defined precisely based on real data or defined randomly moreover cropmetapop allows to set parameters specific to seed movements such as the ratio of seeds replaced by migration or the ratio kept by farmers haring seeds among other parameters we performed sensitivity analyses of the cropmetapop model for a time frame corresponding to the situations encountered in the field i e a few dozen generations maximum to check that the model works as expected and to determine the relative influence that the major input parameters have on the outputs of the model results showed that the drift related parameter was of the most influential on the variability of the genetic diversity indicators especially at the neutral markers while indicators at selected markers were mostly influenced by the number of loci under selection and the distribution of the populations optimums colonisation extinction and migration processes through the rates of extinction colonisation migration and migration replacement introduced additional variability to the outputs of the model in the corresponding sensitivity analyses while the topology of the network parameters induced only little variability in the outputs of the model the results of the sensitivity analyses are not intended to directly describe situations encountered in the field rather they will rather they will help cropmetapop users to be vigilant in the choice of values for certain parameters especially those that play an important role in the results these results support a proper functioning of the model cropmetapop can therefore be used in concrete applications to study the genetic evolution of crop metapopulations for example the model can be used to practices and organisational modes on the evolution of crop genetic diversity this type of work could be used as a mediation tool to build decisions in a collective managing crop genetic diversity credit authorship contribution statement baptiste rouger improved the code of the software designed ran and analysed the sensitivity analyses writing original draft isabelle goldringer conceptualised and designed the software designed the sensitivity analyses and discussed the results contributed to and edited the manuscript pierre barbillon designed the sensitivity analyses edited the manuscript anne miramon developped the code of the software abdel kader naino jika contributed to test the model contributed to part of the manuscript mathieu thomas conceptualised and designed the software designed the sensitivity analyses and discussed the results contributed to and edited the manuscript declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors thank frédéric hospital for his help in designing and developing the software the authors are very grateful to the mires network financially supported by inrae and to françois massol for his very helpful advises this research was funded by the european union s horizon 2020 research and innovation programme under grant agreement no 633571 diversifood project for the period 2015 2019 and br received a grant from the école doctorale frontières de l innovation en recherche et éducation programme bettencourt and phd funding from inrae appendix results of sas migration see figs a 1 and a 2 
24291,cropmetapop is a new simulation tool to model the genetic evolution of crop diversity under on farm dynamic management under this type of conservation and use of varieties seeds are resown and exchanged between farmers and the set of connected populations is described as a crop metapopulation cropmetapop is therefore at the interface of genetic and social processes we used sensitivity analyses to check the behaviour of the model and to identify which parameters and range of values for them induce the most variability in the outputs cropmetapop was found to behave as expected depending on the type of locus studied neutral or selected the parameters related to drift or selection were those that induced the most variability in the outputs colonisation migration and network topology parameters were less influential looking at the detailed results will help setting the parameters to relevant values in the future utilisation of the model keywords genetic diversity dynamic management seed network agent based model agroecology data availability data will be made available on request 1 introduction in small scale farming systems farmers save their seeds from one year to the next and often exchange seeds for a variety of reasons including the search for better production seed loss or even curiosity pautasso et al 2013 seed circulation among farmers has been shown to greatly impact the genetic diversity of the plant populations they grow in their fields fuentes et al 2012 louette et al 1997 pressoir and berthaud 2004 those crop populations are linked by past or future seed transfers and are subject to extinction for these reasons they can be considered as a particular case of metapopulation called crop metapopulation which is submitted to farmers management van heerwaarden et al 2010 farmers seed management practices and the functioning of these cultivated metapopulations are at the interface between social and ecological processes and understanding the impacts of farmers practices and organisation on the dynamics of crop populations diversity is a complex issue that seems unlikely to be tackled through experimental pautasso et al 2013 or analytical approaches only indeed setting up experiments aimed at comparing the impact of different management methods would be far too cumbersome too long e g to observe allele fixation time kimura 1980 and therefore too costly a modelling approach is therefore well suited to such studies which allows cheap and fast results though they might lack accuracy several metapopulation models exist such as quantinemo 2 neuenschwander et al 2019 which is considered the most comprehensive one available the extensivity of this model can address four features specific to crop metapopulations as describes by van heerwaarden et al 2010 these are 1 the large number of offspring per plant 2 the non random seed circulation 3 the low rate of seed circulation and 4 the rare bottlenecks during recolonisation events despite this several key features are misrepresented in quantinemo 2 extinction occurs after the regulation of adults see fig 1 a whereas it seems more likely to occur during the seed storage phase in crop metapopulations after seed production and before the seedling or adult phases i e before regulation the order of events during a life cycle has been shown in the literature to influence the evolution of local adaptive polymorphism ravigne et al 2004 massol and débarre 2015 although the authors do not explicitly address extinctions we assume that such a change is likely to have the same kind of impact on the results for this reason it seems important to represent extinction at the most likely phase of the cycle furthermore quantinemo 2 does not distinguish between migration and colonisation whereas the two processes allow to represent two coexisting situations that are classically encountered by farmers who produce their own seeds migration allows to represent situations quite frequently encountered in subsistence farming systems where farmers need to supplement their own seed stocks to sow their entire available field in this context they used to acquiring seed locally within their village from relatives neighbours or friends through gift exchange or purchase boster 1986 wencélius et al 2016 thomas and caillon 2016 violon et al 2016 colonisation coupled with extinction represents more extreme but less frequent situations in which farmers no longer have seed stocks after a poor harvest due to climatic hazards or because of problems with seed storage fenzi et al 2021 violon et al 2016 it has been described that in this type of situation people change their seed supply network by going to obtain seed from relatives or acquaintances outside the village in some case travelling very long distances fenzi et al 2021 violon et al 2016 bellon et al 2011 song et al 2019 the simultaneous consideration of these two social processes into account offers the possibility of representing relatively accurately situations commonly encountered in agriculture finally an other critical feature van heerwaarden et al 2010 is to define independently the seed transfer rate and the level of seed replacement between every pair of populations because in crop management migration is episodic rather than continuous and involves enough seeds to limit the bottleneck all these deviations from classical metapopulation models such as those implemented in quantinemo 2 prompted us to develop cropmetapop a model of cultivated metapopulations in the continuity of the work that was conducted by van heerwaarden et al 2010 to investigate the impact of seed exchanges and farmers management practices cropmetapop 1 1 the software is available at https forgemia inra fr cropmetapop cropmetapop wikis home is an agent based model where agents are individuals represented by plants or seeds which was specifically designed to model cultivated populations and the gene flows resulting from seed circulation due to the social interactions between farmers labeyrie et al 2016 calvet mir et al 2012 mcguire 2008 cropmetapop simulates the evolution of individuals represented as multilocus genomes organised into populations in turn organised into a metapopulation it aims at simulating the evolution of seed lots within the context of seed exchange following the social network of the farmers the life cycle of individuals in cropmetapop is described in fig 1 and presents the comparison between the life cycles of cropmetapop and quantinemo 2 it allows to model various genetic situations low or high genetic diversity weak or strong population differentiation for instance moreover different parameters can be specified to best represent the crop of interest mating system number of individuals per population etc one can also finely tune the seed movement parameters for migration and for colonisation such that the probability of seed exchange is defined between all pairs of populations due to the large number of parameters in the model performing a sensitivity analysis sa in the following saltelli et al 2019 burgers et al 2010 of the model was needed to better understand its behaviour and to ensure that it performs as expected sensitivity analyses also provide a better understanding of which input parameters are responsible for the variability of the model s outputs lurette et al 2009 lamboni et al 2011 finally one can use sas for a better targeting of a realistic range of parameters to be used in the model the two objectives of this paper are i to introduce the cropmetapop model and software and ii to conduct several sas of the cropmetapop model in order to check that the model behaves as expected and to assess the relative importance of the parameters in the model based on the variability they induce in the outputs 2 materials and methods this section begins with a description of the cropmetapop model it continues with the presentation of the main steps to be taken when performing a sensitivity analysis before introducing the 6 sensitivity analyses performed in this paper 2 1 the cropmetapop model 2 1 1 technical features of cropmetapop cropmetapop can be seen as a wrapper library for simupop specifically designed to easily simulate crop metapopulations simupop peng and kimmel 2005 peng and amos 2008 is a python library for the simulation of stochastic individual based model accounting for mutation genetic drift migration and selection and for demographic processes such as extinction and colonisation cropmetapop provides a useful and practical addition to simupop by integrating specific characteristics of crop metapopulations such as in particular the possibility to generate or import various connection matrices to link the fields together it also integrates modules to create random networks with specific characteristics it is therefore designed to represent accurately seed transfer processes with specific parameters cropmetapop is a console program written in python3 using an object oriented approach it allows running simulations without knowledge about coding by just filling a text based simulation file and it can be run on any computer platform tests restricted to one or sometimes two evolutionary forces at a time made it possible to verify that the model was able to find the theoretical expectations data not shown and thus to validate the broad lines of its operation 2 1 2 general features in the context of seed management by farmers organisations a crop metapopulation may correspond for instance to different versions here referred to as populations of the same variety of a considered species cropmetapop relies on the following life cycle breeding extinction within population regulation colonisation migration and meta population regulation the model works with discrete and non overlapping generations which makes it more suitable for representing annual or short generation time species depending on the life cycle stage each individual is either a plant in the field or a seed that may circulate among populations in the following the populations are equivalent to the demes as well as the fields to the patches 2 1 2 1 demographic features of cropmetapop cropmetapop accounts for several social features of the farmers networks number of farmers involved and number of populations per farmer and farming practices sowing density and field size by simulating a finite number of populations each composed of a finite number of crop plants corresponding to the demographic size each population is cultivated in a field characterised by the maximum number of plants that can be grown there called carrying capacity the demographic size may vary from one generation to the following one according to the number of offspring produced per individual called fecundity the demographic size of a crop population can grow up to the carrying capacity of the field in which the population is cultivated each population is subject to extinction colonisation or migration in each generation it should be noted that pollen flows between fields are neglected in cropmetapop because we consider that farmer practices limit such phenomenon they take care to grow different varieties at sufficient distances in the case of mainly self pollinating species and will generally only grow one variety under isolated conditions in the case of a cross pollinating species e g pearl millet naino jika et al 2017 maize or onion in the context of crop metapopulation extinction may correspond either to difficulties in maintaining the population e g climatic or pest disasters or to the choice of replacing the population with a potentially more interesting one colonisation and migration will be defined in the following section 2 1 2 2 genetic features of cropmetapop to account for a critical biological feature of crops each crop metapopulation is characterised by a selfing rate ranging from 0 open pollination to 1 self pollination each diploid individual plant i in a given field j consists in a finite set of genetically linked or independent loci each locus is biallelic or multi allelic mutation rate is defined for each locus and mutation may occur at each reproduction event each locus may correspond to a neutral marker or to an adaptive marker located in a gene associated to a genetic value the sum of the genetic values of all adaptive markers provides the individual genetic value of a quantitative trait g i under selection natural selection due to the local pedo climatic conditions or to particular farming practices is accounted for by applying selection for a local optimum defined for each field depending on the local field optimum o p t j the individual fitness w i j is assumed to have a classical normal shape johnson and barton 2005 centred on the local optimum w i j e 1 2 g i o p t j 2 with i an individual plant and j a given field similar or different optima can be assigned to the different fields in order to compute plant fitness and apply various patterns of selection to local populations during the breeding step the parents of each offspring are randomly selected proportionality to their fitness when genetic values and fields optima are defined within population regulation is applied after seed production to adjust potential excess of offspring to the carrying capacity of each population 2 1 3 special features in cropmetapop the focus has been on describing seed circulation practices in order to represent a diversity of socially established rules that underpin the circulation of seed among farmers two different processes are considered to model seed circulation colonisation and migration colonisation arises after the extinction of a local population while migration happens when farmers mix intentionally or unintentionally their own seed lot with foreign ones unlike other metapopulation simulation softwares cropmetapop can model both colonisation and migration in the same simulation with the possibility to use two different social networks if necessary because we consider that farmers can solicit two different social networks depending on the context in both cases seed circulation is a stochastic process and seed supply can come from one or from several non empty fields when farmers are socially connected the amount of seed in circulation is defined at the level of metapopulation regulation on the basis of donor seed supply and receiver seed demand for instance one farmer can give seeds to neighbours according to his or her stock and receive seeds from them depending on his or her needs in addition for migration it is possible to define the rate of local seed replacement which can be different from the migration rate this specific feature is necessary to take into account the fact that migration rarely occurs but with a potentially strong impact in terms of genetic composition on the receiving population when the seed replacement rate is huge 2 2 sensitivity analysis approach cropmetapop is a stochastic simulation model that allows to adjust the values of more than 10 parameters predicting the behaviour and results of simulations can be very complicated in some situations to better understand the general behaviour of the model we propose to use sas performing a sa of a model first requires defining the input parameters and output variables of the model to be analysed it is then necessary to run the model for a large number of combinations of input parameter values for each combination values are obtained for the different output variables of the model sa relies on variance analysis to attribute the variability of the outputs of the model to one of the parameters changing in the simulations cariboni et al 2007 burgers et al 2010 carpani et al 2012 in this paper we chose to vary the main parameters that control biological features and evolutionary forces of the crop metapopulations i e the selfing rate to characterise the mating system the population size for genetic drift the mutation rate the number of locus under selection and local selection optima extinction and colonisation rate migration rate and network topology for colonisation and migration in order to study in depth the evolutionary processes of particular interest to us we have divided the work into six sas this allowed us to better describe the impact of each parameter in each sa the parameters chosen to vary in these sas were carr cap carrying capacity the number of individuals in the population percentself percent of selfing the proportion of individuals in the population that are autogamous mutrate mutation rate of each locus nblocsel number of locus of the genome that are under selection optimum optimums of the demes the set of optimums to which the genotypic value of the individuals are compared to compute the fitness of each individual in the deme colrate colonisation rate between two populations extinction extinction rate of the populations network network topology type see section 2 2 3 for the tested graph topologies nbedges number of edges in the network i e the number of social relationships in the metapopulation migrate migration rate i e probability of seed lots between two populations migreplace proportion of replaced individuals in the destination population during migration the other parameters of the simulations have been set to fixed values the most important ones are displayed in table 1 the number of generations generations to achieve the sas was set at 30 which represents situations that can be observed in reality beyond that it seems unlikely that the social networks are the same for example therefore exploring the behaviour of the model over a longer period of time does not seem to be a priority with respect to the conditions of use of the model the number of replicates replicates was set to 10 to capture some of the stochasticity of the model while limiting the simulation time of the sas the number of populations nb pop was set at 100 which corresponds to a reasonable number of people involved in a collective action of crop diversity management the number of alleles nb allele was set to two to represent snps the fecundity parameter fecondity was set to 4 to produce enough offspring to allow for migration events while limiting simulation time the number of neutral markers defined as the difference between the total number of markers nb marker and the number of markers associated with a fitness value was set to 10 to be able to follow the evolution of several loci simultaneously while limiting the simulation time to assess the impact of the parameters variation genetic diversity indices see section 2 2 4 were computed on genotypic data the protocol was the same for the six sas it consisted in the following steps 1 creation of the design of experiments with the correct number of parameter section 2 2 1 2 creation of the simulations setting files and of the launcher files for the simulations section 2 2 2 3 launch of the simulations 4 analysis of the genetic monolocus data section 2 2 4 launched with the scripts generated in section 2 2 2 5 gathering of all the files in big files by indicator 6 sa of the resulting files section 2 2 5 7 the graphs interpretation of the sas section 2 2 6 2 2 1 creation of the plan of simulation in order to avoid running thousands of simulations a fractional factorial design was applied using the r package planor kobilinsky 2005 kobilinsky et al 2017 2019 for each of the six sas of cropmetapop this package allowed us to run less than 500 simulations where 20 000 would have been needed with a full factorial design it requires to set each parameter chosen to an equal number of level and allows to determine up to second order interactions between the parameters i e interaction of one parameter with one other it returns a design of experiments composed of a list of levels combinations this design of experiments was exported to a comma separated value formatted file and used as an input for the scripts generating the setting files for the simulations and the analysis to run in this paper we chose to use three levels for each parameter we considered it allows to correctly yet concisely explore the variation ranges of the parameters of the model we chose for every parameter a low realistic value a high realistic value and an intermediary value 2 2 2 creation of the simulations the setting file generator creates one configuration file for each replicate and for each of the levels combination in the design of experiments it associates to the set of levels described in the design of experiment the correct corresponding values to each parameter it also writes two more files one that contains the set of simulations to run on the computer cluster the simulation launcher file and the other that contains the corresponding analyses to run after the simulations the analysis launcher file the ten replicates of every parameter combination are split in separate simulations in order to maximise the variability of both the network topology used and the genetic diversity at initialisation these replicates are then grouped together to perform the analysis of monolocus data the simulations are initialised genetically by sampling for each locus of each individual a random allele between the two available at each locus this process can induce an imbalance in the frequencies of each allele especially in small size populations this can also induce linkage disequilibrium between markers 2 2 3 network topologies tested we used three contrasted topologies chosen to be representative of the reality of the systems we model the erdős renyi network topology erdős and rényi 1959 in which the connections between the populations are randomly and statistically equally distributed was designed to represent a perfectly distributed and horizontal network we then used the community network topology nowicki and snijders 2001 girvan and newman 2002 in which the connections between the populations are more frequent within a community to represent the collective management of seeds in different farmers organisations last we used the barabási barabási and albert 1999 topology network in which only a few populations are connected to many other populations this was chosen to represent centralisation around a few major actors in the seed system the densities have been chosen to represent networks with low medium and almost maximal densities for the sas that focused on migration or colonisation a library of networks was generated before the simulations to maximise the network topology stochasticity a total of 900 networks was generated in the library a network with corresponding parameters was randomly selected in the library and written in the configuration file 2 2 4 monolocus data analysis for each sa after the simulations the data of each replicate that have the same parameter combination and that are in separate folders were gathered in the same file all the files i e all simulations were then analysed by a python script to compute two genetic and one demographic indicators for each generation including the average within population expected genetic diversity expected heterozygosity hs nei 1987 the average genetic differentiation gst weir and cockerham 1984 takahata and nei 1984 and the survival rate surv of the populations h s s 1 s l 1 l 1 i 1 i p i l s 2 l s g s t s 1 s h t s h s s h t s s with h t l 1 l i 1 i p i 2 l and s u r v 1 number of non empty populations total number of populations with i the number of alleles l the number of loci and s the number of populations this analysis produced as many result files as there were combinations of parameters and indicators these files were then merged by indicator to produce the final result files of the simulations these indicator files contain the average indicator values over the ten replicates 2 2 5 sensitivity analysis for each sa the resulting files were then analysed for each indicator with the r multisensi package bidot et al 2018 lamboni et al 2009 2011 it allows to evaluate the share of every parameter in the variability of the output along with time determining up to second order interactions of parameters it takes as inputs a merged indicator data file and the design of experiments created by planor and returns detailed sensitivity indices as well as several graphs including one presenting the evolution of the share of every parameter to the variability of the output indicator of the model along time such as in figs 2 and 4 2 2 6 graphs interpretation for each sa the lower part of the graph represents the main sensitivity indices for each input parameter normalised between 0 and 1 the bigger the width of the ribbon of the parameter the more the parameter is important to explain the variability of the model output at the given generation for clarity interactions of parameters are merged and represented in a unique ribbon the residual represents the part of the variability of the model that cannot be explained by any parameter or second order interaction the upper part of the graph represents the distribution of the output of the model the dark heavy line represents the mean of the data the grey area represents the quartiles of the data the blue dotted lines cover 90 of the data and the red dotted lines the extreme data one can consider that the wider the distribution the more significant the effects we detect the figs 2 c 3 c 4 c 5 c and 7 present the total sensitivity indices i e the sum of the sensitivity indices of each parameter and of its interactions with other parameters for the last generation of all sas as the last generation sensitivity indices is the sum of interactions attributed to two parameters the sum of all shares can be superior to 1 2 3 a six sensitivity analyses system 2 3 1 description six sas were performed to identify the parameters that induce the most variability in the results according to the evolutionary forces considered these sas differ according to two criteria if and how the populations are connected isolated connected by colonisation connected by migration and the type of markers studied neutral or under selection their names follow a pattern describing first the connection of populations isolated populations colonisation extinction or migration and then the type of markers studied neutral markers or selected markers note that the results of two sas are not comparable since they are not based on the same set of input value combinations the values of the parameters for each sas are presented in tables 2 4 for each of the parameter chosen we defined three levels which were fixed to span over most of the actual variation ranges of the parameters mutation rates were chosen to cover the range of values that can be found in vivo raquin et al 2008 schoen and schultz 2019 the number of loci under selection were chosen to represent cases with no selection and with selection when selection was present in the simulations we chose to represent cases with a monogenic traits or traits composed by 5 or 10 loci even though these numbers are quite low compared to the number of loci associated with traits in vivo e g for wheat height zanke et al 2014 we were able to show expected dynamics for selection and spared computation time other parameters were chosen to cover a wide range of realistic values for every parameter with one intermediary value in order to have contrasted effects with the parameter range carr cap ranged from 40 vegetable like size of population to 1000 to represent cereal populations those populations can be a lot bigger but genetic drift is estimated to be fairly reduced from 1000 individuals nei et al 1975 percentself ranged from 0 purely allogamous individuals to 0 95 mostly autogamous individuals to represent the most species possible optimum were chosen to represent contrasted situations of selection where individuals are all in the same environment individuals are in two contrasted environments individuals are in environments all different one from another network more information about network topologies can be found in section 2 2 3 colrate and migrate were chosen to represent situations with very few to a lot of colonisation migration i e one event in a hundred generations to one event every four generations per population extinction were chosen to represent situations with very few to a lot of extinction i e one event in a hundred generations to one event every four generations per population migreplace were chosen to represent situations where only a hundredth of the population is replaced to half of the population is replaced by migration events nbedges more information about network topologies can be found in section 2 2 3 2 3 2 hypotheses qualitative hypotheses regarding the nature of the results are proposed for each of the six sa based on the main principles of population genetics 2 3 2 1 hypotheses for isolated populations neutral markers here as we analyse the genetic diversity indicators at neutral markers that are not linked to selected genes selection is not expected to have any impact neutral markers will only be submitted to genetic drift and mutation and the sampling effect due to the carrying capacity dobzhansky and pavlovsky 1957 is expected to be the main source of variability of such genetic diversity indicators mutation introduces new genetic diversity but we do not expect it to be important in the analysis because we run the simulations over too few generations for the mutations to accumulate halligan and keightley 2009 at equilibrium in a finite size population only submitted to mutation diversity will be maintained if 4 n e μ 1 taking the carrying capacity as a rough value for the genetic effective size only one set of parameter values carr cap 1000 and mutrate 10 3 would meet the condition moreover as the simulations are far from reaching equilibrium the time period studied being very short compared to 4 n e mutation is not expected to contribute to variability in the outputs of the simulations crow 1950 2 3 2 2 hypotheses for isolated populations selected markers we analyse here the genetic diversity indicators at the selected markers the evolutionary forces on the selected markers are the genetic drift mutation and selection kirk and freeland 2011 the selection should affect the most the variability of the indicators as populations are generally initialised far from the populations optima genetic drift is also expected to affect the variability of the indicators due to cases with small population sizes as for neutral markers mutation is not expected to contribute much to variability 2 3 2 3 hypotheses for colonisation extinction in these sas we analyse the genetic diversity at neutral and selected markers separately in cases where populations are connected by colonisation and submitted to extinction as we add colonisation and extinction to the isolated populations sas we expect the same genetic forces to contribute to the variability of the model i e genetic drift and selection together with colonisation and extinction the importance of the contribution of each parameter is difficult to foresee due to the multiple parameters of the system and little information is available from analytical approaches moreover the demographic forces of the simulations and the network topologies are expected to contribute to most of the variability of the survival rate barbillon et al 2015 2 3 2 4 hypotheses for migration in these sas the genetic diversity is analysed separately at neutral and selected markers in cases where populations are connected by migration for genetic diversity parameters the expectations are quite similar to those of colonisation extinction sas as migration and colonisation both correspond to seed circulation among populations therefore influencing both within and between population genetic diversity indices so the same genetic forces are expected to contribute to the variability of the model i e genetic drift and selection as well as migration and network topologies but without presuming the relative importance of the different parameters 3 results 3 1 isolated populations 3 1 1 isolated populations neutral markers the mean expected heterozygosity hs in the sa isolated populations neutral markers decreases from 0 5 to 0 4 over the thirty generations fig 2 a its variability also increases with 90 of the simulations between 0 5 and 0 25 hs at the thirtieth generation the mean population differentiation gst in the sa isolated populations neutral markers increases from 0 to 0 25 cf fig 2 b the variability also increases during the simulations with 90 of the replicates between 0 and 0 5 the carrying capacity carr cap in the figures i e the size of the populations explains most of the variability of the expected heterozygosity indicator for the sa isolated populations neutral markers fig 2 a the remaining variability of the model is mostly explained by the reproduction regime percentself in the figures the same phenomenon can be observed for the population differentiation indicator gst fig 2 b the same distribution of the variability is observed for both indicators in the last generation graph for the sa isolated populations neutral markers as shown in graph fig 2 c 3 1 2 isolated populations selected markers the mean hs indicator decreases from 0 5 to 0 3 over time fig 3 a and its variability maximises at the fifteenth generation with 90 of the replicates between slightly less than 0 5 and 0 at the last generation the mean gst increases from 0 to 0 2 over time its variability maximises at generation 15 with 90 of the replicates between 0 and 0 95 at the last generation fig 3 b the number of loci under selection nblocsel in the figures explains most of the variability of hs fig 3 a during the first three generations the carrying capacity explains transiently most of the variability of the indicator later replaced by the reproduction regime interactions explain almost half of the variability of the gst indicator in fig 3 b therefore the last generation graph fig 3 c is important to determine the components of the variability the optimum parameter optimum in the figures explains most of the variability of the gst indicator the number of loci under selection is the second most important contributor to the variability of this indicator by mostly bringing it through interaction with other parameters finally the carrying capacity and the reproduction regime both contribute to the variability of the gst especially in the early generations 3 2 colonisation extinction 3 2 1 colonisation extinction neutral markers the mean theoretical heterozygosity for the sa colonisation extinction neutral markers fig 4 a decreases from 0 5 to 0 4 during the thirty generations of the simulations 90 of hs values range between 0 5 and 0 25 extreme values in the simulations appear at the thirteenth generation corresponding to extinct or fixed metapopulations the non continuity of the variability increases the share of residual up to 0 45 of the variability when the variability becomes continuous again the residual reduces to 0 2 of the variability share the carrying capacity explains the largest part of the variability of hs in the first fifteen generations while the reproduction regime explains the remaining part the figs 2 a and 4 a display similar trends for the variability share during the first fifteen generations from the fifteenth generation to the thirtieth the colonisation rate colrate in the figures and the extinction rate extinction in the figures take a larger part in the variability of the hs indicator it is likely that particular combinations of extinction and colonisation rates high extinction and low colonisation lead to extinct metapopulations with h s 0 inducing a large variability in the outputs these two parameters are the main components of the interaction as it can be seen in the fig 4 c the mean population differentiation for the sa colonisation extinction neutral markers fig 4 b increases from 0 to 0 1 during the thirty generations 90 of the gst range between 0 and 0 4 similarly to the trends observed in the fig 2 b the carrying capacity explains most of the variability of the gst indicator especially in the first twenty generations the reproduction regime is the second most important parameter for the same generations during the last ten generations the share of the carrying capacity decreases and the extinction parameter becomes the second most important parameter as shown in fig 4 c 3 2 2 colonisation extinction selected markers the mean expected heterozygosity for the sa colonisation extinction selected markers fig 5 a decreases from 0 5 to 0 3 during the thirty generations i e as expected much more than at neutral markers 90 of hs range between 0 5 and 0 the number of locus under selection explains the largest part of the variability of the expected heterozygosity especially from the third generation on the reproduction regime is the second most important parameter from the generation four to twenty then replaced by the colonisation rate the extinction rate is also important in the last generations as shown in fig 5 c though it is mostly influencing through interactions with other parameters the mean population differentiation increases from 0 to 0 1 through the thirty generations 90 of the simulations range from 0 to 1 most of the variability of the gst indicator fig 5 b is explained by the interaction between parameters after the fifth generation in the last generation the interaction is mainly composed by the number of locus under selection and in a second order by the colonisation rate and the extinction rate as it can be seen in fig 5 c the following most important parameters are the optima of the populations and the carrying capacity 3 2 3 colonisation extinction demographic indices the survival rate decreases from 1 to 0 8 through the thirty generations fig 6 moreover the variability of the indicator rapidly increases and 90 of the simulations range between 1 and 0 04 the colonisation rate explains less than half of the variability of the indicator during the first half of the generations its share increases over the thirty generations and ends explaining the majority of the variability of the survival rate including in interaction with other parameters the extinction rate explains half of the variability of the survival rate in the early generations its share decreases during the thirty generations to stand below the colonisation rate the number of edges nbedges in the figures i e the number of social links through which seeds can circulate shows a steady share of 0 05 of the variability of the survival rate 3 3 migration the mean expected heterozygosity for the sa migration neutral markers fig a 1 decreases from 0 5 to 0 45 during the thirty generations the population differentiation of the same sa increases from 0 to 0 05 for the sa migration neutral markers the carrying capacity explains most of the variability of hs and gst indicators fig 7 a the following most important parameters are the migration rate migrate in the figure and the proportion of seeds replaced by migration migreplace in the figure the reproduction regime explains 0 1 of the variability finally the number of edges brings half the variability of the reproduction regime to the simulation compared to the colonisation extinction neutral markers sa seed circulation parameters induce less variability in the output as they do not lead to extinct metapopulations the mean expected heterozygosity for the sa migration selected markers fig a 2 decreases from 0 5 to 0 35 during the thirty generations the population differentiation of the same sa increases from 0 to 0 05 for the sa migration selected markers the number of locus submitted to selection explains the largest part of the variability of the hs indicator at the last generation fig 7 b the distribution of optima represents a source of variability over 7 fold lower the migration rate the proportion of seed replaced during a migration the carrying capacity and the reproduction regime also bring variability to the simulations to a lesser degree for the migration selected markers sa the distribution of selective optima of the populations and in a lower extent the number of locus under selection explain the greatest part of the variability of the gst indicator fig 7 b the migration rate the proportion of seeds replaced by migration and the carrying capacity explain ten times less of the variability of gst than the optimum distribution finally most of the remaining variability is explained by the reproduction regime the number of edges of the network and the network topology network in the figures 4 discussion 4 1 influence of the parameters in the different sas 4 1 1 origin of the variability for isolated populations neutral markers of isolated populations cf section 3 1 1 for the description of the sas are mainly submitted to genetic drift parameters the carrying capacity explains most of the variability of the outputs of the model and the reproduction regime is the second most important parameter the mutation rate mutrate in the figures does not induce variability in the outputs of the model which is consistent with the expectations halligan and keightley 2009 schoen and brown 1991 as genetic drift is the main evolutionary force expected on neutral markers given the rather small population sizes considered and the short time period studied dobzhansky and pavlovsky 1957 the selection parameters do not bring any variability in the outputs which is consistent with the fact that all loci markers are neutral and modelled as unlinked genetically to the selected markers and so no linkage drag is expected to occur although populations are initialised by drawing alleles at random independently at each locus sampling of a small number of multilocus genotypes in the case of small population size 40 could generate some initial linkage disequilibrium ohta and kimura 1969 this could generate variability due to the interaction between carrying capacity and selection parameters however this does not seem to be the case here in contrast selected markers cf section 3 1 2 for the description of the sa are mostly under the influence of the selection forces the number of locus under selection explains most of the variability of the hs indicator this is consistent with our hypotheses see 2 3 2 2 and is caused by the fact that the response to selection will be faster when fewer loci determine the fitness as little linkage disequilibrium is expected among positive and negative alleles at different selected markers kirk and freeland 2011 although selection is expected to be stronger in larger populations i e when genetic drift is limited than in small populations no interaction seems to influence the variability of hs indicator for the gst indicator the main parameter that explains the variability of the simulations is the distribution of the selection optima of the populations this is consistent with our expectations see 2 3 2 2 as the distribution of the optima will directly impact the differentiation among populations this is confirmed by the fact that the optimum parameter has strong interactions with the number of locus under selection for both types of markers neutral and selected hs decreases over time as expected especially as genetic drift is strong and as selection is intense for the selected markers in parallel gst increases at both types of markers the increase in differentiation is larger at neutral markers as expected wang 2015 because the sampling effect will not pick the same alleles in the different populations at selected markers the differentiation among populations depends on the optimum distribution and number of locus under selection while similar optima for all populations will lead to few or no differentiation contrasted and continuous optima can maximise differentiation depending on the number of selected locus in the case of isolated populations the genetic drift parameter i e the carrying capacity of the populations and the two selection parameters number of selected loci and distribution of the populations optima will the most influence the variability of the genetic diversity outputs depending on the type of markers we consider neutral or selected showing therefore the importance to tune these parameters finely 4 1 2 origin of the variability for colonisation extinction the genetic diversity indicators in the colonisation extinction sas are mainly influenced by the genetic drift or selection parameters depending on the markers analysed the colonisation and extinction rates are of second importance to induce variability in the outputs of the model in particular at neutral markers the colonisation rate mostly influences the within population genetic diversity through its capacity to introduce locally new diversity due to the possibility of multiple sources of seed flows while mainly the extinction rate influences the genetic differentiation among populations it is surprising that the network parameters contribute so little to the variability of the outputs of the model this could be explained by the large range of variation of the genetic drift parameter which accommodates most of the variability in contrast the colonisation and extinction parameters explain all the variability of the survival rate this is expected see 2 3 2 3 as these parameters and their relative values have a direct impact on the demography of the metapopulation in these sas the evolution of hs mean is quite similar to the evolution in isolated populations sas whatever the markers while the genetic differentiation increases much less over time due to seed circulation among populations thus even though the existence of seed flows between populations influences the evolution over generations of the genetic differentiation between populations neither the colonisation rate nor the network specificities strongly determine the variability of gst response 4 1 3 origin of the variability for migration the variability of genetic diversity indicators in the migration sas is mainly influenced by the genetic drift or selection parameters depending on the markers analysed as is the case for the isolated populations sas the migration parameters are of second order of importance to explain the variability of the output of the model the migration rate induces more variability in the outputs of the model than the colonisation rate in colonisation extinction sas for the gst of neutral markers yet as seed circulation under extinction colonisation regime is governed by the combination of both the extinction rate and the colonisation rate as colonisation can only occur in case a population became extinct one should consider the influence of these two parameters together similarly it is sensible to consider the influence of both the migration rate and the replacement rate together as under the migration regime seed circulation is governed by the combination of the migration rate and the replacement rate within the target population in the same way as the extinction and colonisation parameters in the colonisation extinction sas the migration rate and the replacement rate parameters contribute both equally to the variability of the selected markers indicators but to a smaller extent compared to variability of the neutral markers indicators finally network parameters have very few impacts on the variability of the genetic outputs as for the colonisation extinction sas this might be explained by the wide range of variation of our genetic drift parameters in the migration sas hs mean over generations decreases slightly less compared to the trends in isolated population and colonisation extinction sas while the mean gst increases less than in colonisation extinction sa indicating that the range of situations considered in migration sas leads to less structure of the genetic diversity within the metapopulation consistently seed flows between populations described here by the migration rate and the replacement rate do not strongly determine the variability of genetic diversity and population differentiation 4 1 4 early generations of colonisation extinction neutral markers the residual of hs increases very fast after the tenth generation and then reduces progressively fig 4 a this is due to the fact that for certain combinations of parameters at this generation in all the replicates the metapopulation is empty or fixed at all loci this causes a huge variability in the outputs that the analysis cannot explain by any up to second order effect or interaction afterwards other combinations of parameters lead to an empty or fixed metapopulation and the variability turns more continuous so that the analysis becomes more explanatory and thus the residual decreases it can be noted that the colonisation rate and the extinction rate have a larger share in the variability of the outputs in the late generations than in the early generations this is because in the early generations the populations are not genetically stabilised yet to their reproduction regime and population size the genetic frequencies will thus vary a lot in the early generations and only stabilise usually around the 15th generation the stabilised share of the parameters to the variability of the outputs can then be observed it is interesting to note that colonisation does not simply behave as migration the migration rate seems to influence more the variability of the gst indicator than the colonisation rate does figs 7 4 c and 5 c this might come from the fact that the migration is not dependent of an extinction process to move seeds migration could thus take place more often than colonisation creating more gene flow between populations than colonisation it is surprising that so little variability of the outputs in the colonisation extinction and in the migration sas is coming from differences in the topology of the network compared to the variability due to the genetic drift parameter and to extinction colonisation and migration rates in barbillon et al 2015 the authors evaluated with a sensitivity analysis a dynamic colonisation extinction model in the context of metapopulations to assess the impact of several parameters related to colonisation extinction network topology and density on the average survival rate of a variety over all the farms growing the variety crop metapopulation and on the persistence of the variety in the crop metapopulation the authors show that after the extinction and colonisation parameters it is the number of edges in the network that induces most of the variability then the network topology induces less but not negligible variability we show here that the same parameters induce far less variability the added genetic aspect or the large variation range of the genetic drift parameters might explain this observed difference tan et al 2017 4 2 limitations of the experimental design even if we used a fractional factorial design of experiments increasing the number of parameters beyond 9 would result in too many simulations for the duration of the simulations which ranges from a few dozens of seconds to more than 24 h moreover running six different sas allowed us to better understand the dynamics of the different evolutionary forces separately we thus chose to restrict the sas dedicated to isolated populations to 5 parameters to study evolutionary forces related to genetic drift and selection and the sas dedicated to colonisation extinction and migration to 9 parameters to study forces related to colonisation and migration respectively along with the genetic drift and selection as mentioned in the section 2 2 1 using planor requires the same number of levels for each parameter chosen as we chose to have 3 levels for our parameters i e two extreme values and an intermediate one it imposed us to chose parameters among the continuous ones and leave aside the on off parameters even if they might have been interesting to include in the sa using a fractional factorial design of experiments allows the number of simulations to be reduced considerably in our case up to 10 times less however it does not allow to detect interactions above the second order this limits the power of the analysis although we observe in the results that very little variability can be explained by second order interactions already few of the variability is explained by second order interactions this indicates that while we do not yet fully understand the role of each parameter in the variability of the indicators we expect very little divergence between what we understand of the model and what actually happens in it in addition interactions above second order not detected by the analysis are included in the residual thus as long as the residual is small one can be sure that the larger interactions induce very little variability in the model outputs the use of two separate sas for selected and non selected markers allowed a better understanding of the behaviour of the model with and without selection as when the number of selected loci is set to 0 i e no selection it is not possible to define selective optima for populations or to analyse genetic diversity at selected markers yet we are not able to quantitatively compare the results of the two sas because the combinations of parameters might interact differently in the two sas we are however able to qualitatively compare two sas with each other in order to diversify as much as possible the networks used by cropmetapop in the analysis we generated a library of a hundred networks for each combination of network type and density therefore as we run ten replicates it is quite unlikely to find the same network several times in the same parameter combination to analyse the results of the simulation more efficiently home made python scripts were created in the team it allows for an adapted and fast computation of the genetic and demographic indicators 5 conclusion here we present cropmetapop a model that addresses the lack of a suitable model to study the genetic evolution of crop metapopulations critical features of crop metapopulations that can usually not be represented in classic metapopulations models are included in cropmetapop among those features the distinct migration and colonisation processes the fact that these processes happen on seeds and not on juveniles and or adults moreover the cropmetapop allows to model precisely the seed movements that can be realised this seed circulation network can be defined precisely based on real data or defined randomly moreover cropmetapop allows to set parameters specific to seed movements such as the ratio of seeds replaced by migration or the ratio kept by farmers haring seeds among other parameters we performed sensitivity analyses of the cropmetapop model for a time frame corresponding to the situations encountered in the field i e a few dozen generations maximum to check that the model works as expected and to determine the relative influence that the major input parameters have on the outputs of the model results showed that the drift related parameter was of the most influential on the variability of the genetic diversity indicators especially at the neutral markers while indicators at selected markers were mostly influenced by the number of loci under selection and the distribution of the populations optimums colonisation extinction and migration processes through the rates of extinction colonisation migration and migration replacement introduced additional variability to the outputs of the model in the corresponding sensitivity analyses while the topology of the network parameters induced only little variability in the outputs of the model the results of the sensitivity analyses are not intended to directly describe situations encountered in the field rather they will rather they will help cropmetapop users to be vigilant in the choice of values for certain parameters especially those that play an important role in the results these results support a proper functioning of the model cropmetapop can therefore be used in concrete applications to study the genetic evolution of crop metapopulations for example the model can be used to practices and organisational modes on the evolution of crop genetic diversity this type of work could be used as a mediation tool to build decisions in a collective managing crop genetic diversity credit authorship contribution statement baptiste rouger improved the code of the software designed ran and analysed the sensitivity analyses writing original draft isabelle goldringer conceptualised and designed the software designed the sensitivity analyses and discussed the results contributed to and edited the manuscript pierre barbillon designed the sensitivity analyses edited the manuscript anne miramon developped the code of the software abdel kader naino jika contributed to test the model contributed to part of the manuscript mathieu thomas conceptualised and designed the software designed the sensitivity analyses and discussed the results contributed to and edited the manuscript declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors thank frédéric hospital for his help in designing and developing the software the authors are very grateful to the mires network financially supported by inrae and to françois massol for his very helpful advises this research was funded by the european union s horizon 2020 research and innovation programme under grant agreement no 633571 diversifood project for the period 2015 2019 and br received a grant from the école doctorale frontières de l innovation en recherche et éducation programme bettencourt and phd funding from inrae appendix results of sas migration see figs a 1 and a 2 
24292,species distribution models sdms are key tools in biodiversity and conservation but assessing their reliability in unsampled locations is difficult especially where there are sampling biases we present a spatially explicit sensitivity analysis for sdms sdm profiling which assesses the leverage that unsampled locations have on the overall model by exploring the interaction between the effect on the variable response curves and the prevalence of the affected environmental conditions the method adds a pseudo presence and pseudo absence to unsampled locations re running the sdm for each and measuring the difference between the probability surfaces of the original and new sdms when the standardised difference values are plotted against each other a profile plot each point s location can be summarized by four leverage measures calculated as the distances to each corner we explore several applications visualization of model certainty identification of optimal new sampling locations and redundant existing locations and flagging potentially erroneous occurrence records graphical abstract image graphical abstract keywords active learning conservation ecological niche models model evaluation monitoring uncertainty data availability rmo data is publicly available at https rmo senckenberg de search home php simulated data can be generated using the r package downloadable from https github com charliem2003 sdmprofiling 1 introduction knowledge of species distributions is key to successful conservation measures but in nearly all cases species are known from incomplete and often spatially biased observations consequently species distribution models sdms have become key tools in biodiversity monitoring and conservation planning guisan et al 2013 they allow for a set of presence only presence pseudo absence or presence absence data hereafter occurrence data to be used to infer a species distribution across the remainder of the unsampled region elith and leathwick 2009 such outputs may then be used for a wide range of conservation applications such as tracking changes in the distribution of target species to identify increasing or decreasing trends e g brotons et al 2007 projecting potential future range shifts e g elith et al 2010 or to identify critical conservation areas essential for species persistence and reintroductions or the protection of biodiversity e g kremen et al 2008 riaz et al 2020 for sdms to be used effectively it is therefore essential that such model outputs are accurate representations of the true distributions the accuracies of sdms are dependant not only upon the sampling effort the quantity of occurrence data used to generate the models aizpurua et al 2015 valavi et al 2021 but also the spatial configuration of those sampling points kramer schadt et al 2013 syfert et al 2013 particularly for presence pseudoabsence models barbet massin et al 2012 phillips et al 2009 as there is likely to be considerable sample selection bias in occurrence data any sdm therefore risks conflating modelling species distribution with modelling this sampling bias beck et al 2014 phillips et al 2009 ploton et al 2020 radosavljevic and anderson 2014 furthermore sdms are generally evaluated through metrics summarising their accuracy against a set of validation data set aside from the modelling procedure fielding and bell 1997 ensuring maximum fit to those locations with many data this can be especially problematic if the validation data have the same spatial and environmental biases as the modelling data bahn and mcgill 2013 leroy et al 2018 such that a high level of accuracy to a small area in geographical or environmental space is assumed to apply to all areas beyond those bounds charney et al 2021 validation data can be carefully structured or filtered to minimize the influence of spatial biases as far as possible e g boria et al 2014 hallman and robinson 2020 kramer schadt et al 2013 roberts et al 2017 but any selection is still limited by where available samples are located although there is some movement towards producing maps of model uncertainty beale and lennon 2012 rocchini et al 2011 swanson et al 2013 estimating accuracy in the model outputs in a spatially explicit manner is still challenging here we develop such a method for evaluating sdms which we call sdm profiling that highlights key locations with the potential to affect model predictions should further data be collected it does this by calculating the leverage that unsampled areas would have on the overall model predictions rather than simply the effect on the response curves themselves if they were to be sampled we first describe the sdm profiling procedure in detail we then show that the values generated for each unsampled cell provide a meaningful estimate of its likely effect on our model predictions using simulated species distributions finally using simulated species and data for a freshwater gastropod from a long term monitoring scheme we highlight several potential applications for sdm profiling including as a tool for visualising areas of high and low model certainty selecting sites for collecting further data optimising monitoring schemes and flagging potentially erroneous occurrence records 2 materials and methods 2 1 the sdm profiling procedure the basic assumption of sdm profiling is that each cell sampled or unsampled can be assigned to one of only two potential states presence or absence thus we can explore the effect of the cell on an sdm by comparing the predicted probability of occurrence map when the cell is included in the analysis to a probability of occurrence map produced when the cell is not included in the analysis for example we can virtually sample an unsampled cell by including it in the sdm training data in each of its two possible states once when the cell is assumed to be a presence and once when assumed to be an absence to generate two new probability of occurrence maps fig 1 these two measures of change can be standardized and plotted against each other in a profile plot the location of the cell in this plot relative to other cells allows the quantification of the information leverage of each cell for both possible states the method incorporates not only information on the change to the response curves of the environmental variables if a cell were to be sampled but also the prevalence of those conditions within the landscape ewers et al 2010 it therefore differs fundamentally from methods that only examine which unsampled locations would cause the largest changes to the response curves such as traditional statistical leverage or influence measurements like the cook s distance in a generalized linear model for example a new sampling location might cause a very large change in predicted probability of occurrence in a particular portion of an environmental gradient if however a very small portion of the landscape possess those environmental conditions then the effect on the overall accuracy of our predictions will be small since sdm profiling always compares a new probability of occurrence map to an original one it can be applied to any species for which we have some initial occurrence data that can be used to create a base sdm as the procedure directly compares the probability of occurrence values generated by multiple sdms it is therefore advisable to build models using true presence absence data where detectability issues are accounted for rather than presence only models that may predict only relative likelihoods guillera arroita et al 2015 to start the procedure we first use the initial occurrence data to fit an sdm and create the base probability of occurrence map to which all other generated maps will be compared at this stage we have for each cell j from a total of j cells in the map the predicted probability of occurrence according to the base sdm hereafter base j we then generate a list of all the k cells we wish to profile a subset of j for a given cell k in k we set its state to presence and re run the sdm to produce a new probability of occurrence for each cell new1 k j we then repeat this procedure for the same cell k while setting its state as absence to produce a new probability of occurrence for each cell j new0 k j for each cell j we calculate the absolute deviation from the probability of occurrence in the base sdm with the new probability of occurrence when cell k is changed to a presence or absence 1 d e v 1 k j n e w 1 k j b a s e j 2 d e v 0 k j n e w 0 k j b a s e j then for each cell k the dev1 k j and dev0 k j are summed over all j cells to represent the total change in probability of occurrence across all cells when cell k is made a presence or an absence respectively next the maximum and minimum deviation across all cells are calculated 3 δ m a x m a x k j 1 j d e v 0 k j j 1 j d e v 1 k j 4 δ m i n m i n k j 1 j d e v 0 k j j 1 j d e v 1 k j finally for each focal cell k the total deviation is standardized between 0 and 1 by the maximum and minimum deviations to calculate the total change in probability of occurrence when assumed presence or absence 5 d i f f 1 k j 1 j d e v 1 k j δ m i n δ m a x δ m i n 6 d i f f 0 k j 1 j d e v 0 k j δ m i n δ m a x δ m i n 2 2 the profile plot and the four measures of leverage when repeated for all k cells we can then plot the standardised diff 1 k and diff 0 k values against each other in a profile plot fig 2 the position of cell k in this plot is therefore an indication of the total information leverage that cell would have on the model if it was sampled and the species was found to occur there or not we recognise four leverage measures that can be derived from the plot relating to the proximity to each of the four corners in all cases we calculate proximity as 2 minus the euclidean distance to the corner such that the largest leverage values for a given corner indicate the closest points these four measures are heuristically useful even though they overspecify the data once any three are known the location of any point could be triangulated making the fourth variable redundant indeed the four measures can be categorised along two axes 2 2 1 leverage strength the first axis runs from corner a to b in fig 2 and relates category to leverage strength the further along this axis towards corner a the stronger the overall leverage of that cell a dual leverage cells in this corner indicate locations that have high leverage whether the species is present or absent this may occur for example for cells in poorly sampled and or prevalent environments where small changes in the modelled responses can result in large sum changes in probability across the landscape we cannot therefore make a priori judgements on the species likely state in that cell but know that the cell has important consequences for our model predictions cells with high dual leverage values are therefore good candidates for future sampling b redundancy for cells close to this corner although leverage is similar whether made a presence or absence the change in model predictions are small in both cases and so they are not likely to be providing information not already present in the model this may occur if the environmental conditions are rare in the landscape or already well sampled cells with high redundancy values would therefore be inefficient selections for future sampling 2 2 2 leverage symmetry the second axis runs for corner c to d and relates category to leverage symmetry location along this axis indicates that leverage is stronger for one state i e either presence or absence than the other c presence leverage cells near this corner indicate that there is a large change in the predicted probability of occurrence if the species were to occur in that cell but conversely the predicted probability of occurrence remains largely unchanged when the cell is made an absence it is therefore an unlikely site for the occurrence of the species if those environmental conditions have been well sampled for example if modelling a species that is confined only to woodland adding an absence to a grassland cell would not greatly affect our predictions but adding a presence to that cell may lead to increases in suitability across all grassland cells especially if grassland has hitherto been poorly sampled therefore sampling at such a site may further confirm what the model currently predicts as absences if those conditions are well sampled but greatly change the model if those conditions were poorly sampled and modelled preference is based on relatively little data the incorrect assignment of a presence in these cells has the potential to significantly mislead predictions d absence leverage cells in the opposite corner indicate a small leverage when a presence is added but a large change in the model with the cell is made an absence again this may indicate that the cell is deemed likely to be a presence for example a woodland cell in the previous example here the incorrect assignment of an absence has the potential to significantly mislead predictions it is also worth noting that the degree of change a cell s sampling will have on the model is a function of two factors first leverage is a function of the spatial and environmental information that the cell is providing for the model so that a cell located in environmental conditions dissimilar from those already sampled will likely have higher leverage values than a cell located within a heavily sampled region of environmental space second leverage is also dependant upon the prevalence of those environmental conditions within the landscape for example the altered model may double the probability of occurrence for a certain environmental condition but if that condition is scarce within the landscape the overall change in the probability of occurrence across all cells will be small conversely only a slight increase in probability of occurrence for those conditions prevalent in the landscape may lead to a large overall change this highlights the general importance in spatial ecology that the effect sizes themselves may not be informative until mapped and aggregated across the landscape ewers et al 2010 as well as explaining why simply selecting cells based on maximising the sampled environmental space is also likely to be an inefficient solution 2 3 testing the relevance of the four leverage measures we illustrate the relevance of a cell s position in the profile plot and the four leverage measures through simulations fig 3 we created a series of virtual species and generated sdms from initially a small number of randomly assigned cells further cells were subsequently added iteratively by selecting cells closest to the respective corners of the profile plot and the change in accuracy of the sdm predictions calculated by utilising virtual species we were able to assess the true accuracy of each sdm as we increased sampling effort consistent differences in the rate of increase in model accuracy for species of different prevalences indicate if our leverage measures do indeed reflect different informational content for unsampled cells all simulations were carried out in r 3 4 3 r core team 2020 environmental and species layers were generated using the gstat package gräler et al 2016 pebesma 2004 and sdms were generated using the randomforest package liaw and wiener 2002 although sdm profiling could be applied to any sdm algorithm that outputs probability of occurrence values an r package which contains functions for carrying out sdm profiling and plotting the results can be installed from https github com charliem2003 sdmprofiling the package also contains functions for creating simulated species and sets of environmental variables that follows the described methodology 2 3 1 creation of virtual environmental variables and species distributions environmental variables environmental variables were generated in groups of five across landscapes of 50 50 cells first a surface was created using an unconditional gaussian simulation to create a random field from a spherical variogram using a consistent but arbitrary sill value of 1 5 spatial autocorrelation controlled using the range parameter was drawn from an exponential distribution the exponential of a value drawn randomly between 1 and 6 larger values result in higher levels of spatial autocorrelation four further environmental variables were then created based upon the first by subsampling 50 of the cells of the first variable the subsampled cells were then used as input for a new gaussian simulation with new spatial autocorrelation values randomly assigned from the same distribution finally values for all five variables were standardised between 0 and 1 this resulted in a group of five closely related variables but each with different levels of spatial autocorrelation we repeated this procedure a further three times to produce four groups of five environmental variables only the first variable from three groups was used to generate the virtual species distributions themselves see below but the sdms were trained with all twenty environmental variables as predictors in real world cases we generally don t know a priori which environmental variables are important in determining the distribution of the species in question and so usually there will be unimportant variables that are erroneously included our approach here means that there is ample scope for an sdm to incorrectly identify the important predictors and for this to lead to an inefficient accumulation of new sampling points sampling bias a further independent environmental variable with very high spatial autocorrelation range 500 was created that approximates a typical spatial bias in sampling probability we might expect similar real world sampling probability surfaces e g beck et al 2014 due to for example higher sampling effort around cities and universities the botanist effect moerman and estabrook 2006 this layer was generated independently of any environmental or species layer virtual species to generate a virtual species for a given set of environmental variables we multiplied the first variable of three of the environmental groups we subsampled 50 of these cells and used them as input to generate a new surface layer in the same manner as for the environmental variables using an unconditional gaussian simulation to create a random field from a spherical variogram with a sill value of 1 the surface was then converted to a presence absence distribution by selecting the number of highest value cells that equalled the desired proportion of occupied cells the procedure was repeated for six species prevalence values for a given set of environmental variables with proportions of 0 025 0 05 0 1 0 25 0 5 and 0 9 occupied cells so that for a given run all six species had similar underlying distributions but different prevalences in order to check that the species had appropriate distribution characteristics we calculated the area weighted mean class aggregation index value he et al 2000 as aggregation indices are dependant upon prevalence we only carried this out for prevalence of 0 1 species were assigned as having an aggregated distribution if the aggregated index value fell between 80 and 90 and as having a dispersed distribution if the aggregated index value fell between 30 and 40 although the thresholds are somewhat arbitrary they produced subjectively very different distribution patterns see examples in fig s1 in supplementary material if the species could not be assigned to either then the species and environmental variables were discarded and the procedure restarted initial sampling cells for each species we selected 25 cells in order to build the initial sdms we assumed perfect detection so that models were built with presence absence information cells were drawn from the sampling bias layer by generating a probability value for each cell from a uniform distribution between 0 and 1 cells where the sampling bias value exceeded the probability value were assigned as sampled we then drew 25 of the sampled cells at random ensuring a minimum of three presences or absences therefore our knowledge of the species distribution starts from a spatially biased position with no correlation to environmental variables or the species distribution approximating spatial biases that predominate in biological databases we also present results in the supplementary material where the initial 25 cells were sampled randomly with no spatial bias 2 3 2 sampling procedure for a given species within a set of environmental variables we first generated an initial sdm using the 25 starting sampling cells as presence absences all sdms were built using random forests with 2500 trees although many other algorithms are available for building sdms random forest models are very rapid to compute which is important as our simulations required fitting some 123 651 480 models however the procedure should be robust to the modelling approach used if other algorithms are preferred sdms were built using all 20 environmental variables as well as the sampling bias layer as independent variables including quadratic terms as species distributions were built using only three environmental variables multiplied we were therefore providing models that were greatly more complex than necessary and of high risk of overfitting if provided with spatially or environmentally biased training data accuracy of the sdm prediction was then evaluated against the true species distribution through the true skills statistics tss after applying a presence absence threshold of 0 5 accuracy was also assessed using the kappa statistic and auc and presented in the supplementary material further sampling sites were added with increasing increments of sampling effort initially five further sampling cells were added followed by a further 10 cells 15 cells to 95 cells in 5 cell increments for a total of 19 iterations therefore sampling effort ranged from 25 to 975 cells for each iteration a profile plot was generated for all unsampled cells additional sampling cells were selected based upon the four leverage measures generated from the profile plot a the highest dual leverage values b the highest redundancy values c the highest presence leverage values d and the highest absence leverage values as a null model we also accumulated additional sampling cells based upon the same spatially biased layer used for assigning the initial 25 sampled cells without consideration of the species potential distribution through sdms as is often typical in non species specific sampling schemes or ad hoc recording in all cases at each iteration a new sdm was generated and its accuracy assessed against the true distribution we replicated the procedure 30 times generating 30 new sets of environmental variables for each species type aggregated and dispersed and 6 species prevalences for each environmental variable set the success of the five approaches for accumulating sample cells was assessed as the increase in accuracy as sampling effort increased averaged across the 30 replicates for each species we also explored the relationship between the probability of occurrence of cells against the leverage values once the cells were profiled for a representative species if correlations are high then it may indicate that there is little additional information gained from the profiling procedure however even where probability of occurrence and leverage are correlated if there is variation in leverage values for a given probability of occurrence then selecting cells based on probability of occurrence alone would potentially result in selecting cells with relatively small leverage values we explored several potential applications for sdm profiling including visualization of model certainty in rgb colour space identification of new sampling locations and redundant existing locations and the flagging potentially erroneous occurrence records applications were illustrated using either virtual species generated using the same procedure as above the example species is the same shown in fig 6 where the initial sampling data comes from 25 sampling points arranged across a regular grid or a real world scenario of an existing freshwater monitoring scheme the long term ecological research lter mirtl et al 2018 site rhine main observatory rmo kuemmerlen et al 2016 focusing on data for a freshwater gastropod ancylus fluviatilis o f müller 1774 in this monitoring scheme 21 existing sampling points were located along the main channel and a further 50 unsampled locations were identified as potential additions for future monitoring rmo data is publicly available from https rmo senckenberg de search home php 3 results when the profile values were plotted against the probability of occurrences of the sdm profiled fig 4 leverage symmetry presence and absence leverage values but not leverage strength redundancy and dual leverage values were highly correlated with probability of occurrence cells with high presence leverage values have low probability of occurrence whereas cells with high absence leverage have high probability of occurrence there is some indication that those cells with the highest dual leverage values have probability of occurrence values around 0 5 suggesting that the measure is focusing on cells of highest uncertainty but importantly selecting sites on medium probability of occurrence alone gives little indication of their redundancy or dual leverage value selecting new sampling locations based upon their leverage values greatly affected our ability to accurately predict a species distribution in consistent ways fig 5 confirming the relevance of the profile plot however the identity of the most appropriate sampling method differed depending upon the prevalence of the species in general selecting points using redundancy fig 5 purple lines those points that result in little change to the sdm output when added led to slow increases in accuracy whereas selecting points based on dual leverage fig 5 green lines those points that cause large change to the sdm output when added generally led to rapid increases in accuracy especially when adding to small numbers of sampled cells or for species with medium prevalences accumulating samples based only on a spatial bias independent of the species fig 5 orange lines was inefficient across all scenarios for prevalent species accumulating sampling points based on presence leverage low values for diff 0 high values for diff 1 fig 5 blue lines led to rapid increases in accuracy whereas for rare species i e the majority of species on earth accumulating sampling points based on absence leverage high values for diff 0 low values for diff 1 fig 5 red lines led to rapid increases in accuracy for example selecting points for a rare species based upon absence leverage can almost double accuracy compared to other methods whereas selecting points based upon presence leverage would lead to only half as much increase in accuracy fig 5 we can see in fig 6 first column that using absence leverage concentrates points on the few true presences and so even though the selected points covers only a small proportion of the environmental space second column the model can accurately predict the edges of the species range by contrast selecting points for rare species through presence leverage values identifies locations where there is high certainty of absence which are of little value to increasing model accuracy although a wide environmental space is sampled many cells need to be sampled before the environmental space dividing presences and absences has been adequately covered selecting points based on redundancy low values for diff 0 low values for diff 1 accumulates points in a spatially clustered manner whereas selecting points based upon dual leverage high values for diff 0 high values for diff 1 samples widely across the entire landscape roughly in proportion to prevalence and so provides a good compromise between absence and presence leverage whilst performing well across all species prevalences fig 5 4 discussion we can envisage three main uses for sdm profiling ranging from model visualisation to optimising sampling schemes and flagging suspicious points in existing datasets e g occurrence records with geocoordinate issues or misidentifications 4 1 visualisation of leverage and spatial biases if we calculate leverage for every cell we can plot the four leverage distances individually as spatially explicit maps fig 7 alternatively as there are only three degrees of freedom see 2 2 above we can visualise all leverages simultaneously by mapping three of the leverage values on to three axes using a red green blue rgb plot in the example in fig 7 values for absence leverage determine the values for red dual leverage the values for green and blue is determined by presence leverage now areas in blue are likely absences high presence leverage areas in red likely presences high absence leverage areas in purple of little importance for model accuracy high redundancy and light green indicates high dual leverage 4 2 evaluating and improving existing sampling schemes existing monitoring schemes have limited sampling capacity due to financial and methodological constraints therefore producing sdms for target species can be an important analytical tool in conservation and management where complete sampling of all sites is not feasible domisch et al 2015 kuemmerlen et al 2016 2015 in most cases the location of sampling sites is based on an equally spaced or on an environmentally stratified design with some degree of randomness within those constraints all these cases are insensitive to the species perspective of its environment and to the model s ability to distinguish between presences and absences thus it is important to develop tools that will optimize sampling sites selection for existing or new monitoring schemes guisan et al 2006 as the simulations show in the previous section sdm profiling may be used to select new sampling sites that will likely lead to the largest increases in model accuracy for the minimum increase in sampling effort figs 5 6 interestingly the simulations showed that contrary to expectations selecting new sites so as to cover a broad range of environmental conditions e g an environmentally stratified design is generally inefficient when monitoring a single species although such a scheme may be advantageous for assemblage monitoring where species have differing environmental preferences instead concentrating on selecting those sites that are at the environmental boundaries between areas of presence and absence is more likely to result in higher accuracy the sdm profiling approach differs fundamentally from sdm targeted approaches guisan et al 2006 that base further sampling only on the output of the sdm using sampled locations such approaches such as adaptive niche based sampling developed for rare species chiffard et al 2020 typically prioritise detecting new presences by focussing on further sampling in unsampled locations with predicted high probability of occurrences or targeting areas of environmental space that remain unsampled in contrast by assessing model leverage sdm profiling examines the interactions between unsampled environmental space the prevalence of that environmental space in the landscape and the effect sizes of the difference between the unsampled environmental space from sampled environmental space estimated from the response curves recovered from the sdm therefore we are prioritising sampling that will increase the accuracy of model predictions rather than necessarily discovering new locations of presences or absences we illustrate this potential using the monitoring data of the freshwater gastropod ancylus fluviatilis in the rmo dataset the scheme is to be extended to higher order streams and 50 candidate sites were drawn up fig 8 by applying sdm profiling to the candidate sites we can select those that have a large but unknown potential effect on our knowledge of the species distribution as the sites with the highest dual leverage values alternatively we can choose to omit sites with highest redundancy values that will provide the least new information as well as evaluation of unsampled cells we can similarly assess the leverage of our sampled sites for example if we wanted to reallocate effort from existing monitoring sites in this case we remove each sample point in turn and re run our sdm calculating the deviance between the new and base sdms and standardising each site relative to the largest deviance value sites where models are very similar when built with and without that data point i e high redundancy values are therefore ones with little leverage on our model and so could be removed entirely with small impacts on model accuracy in the example in fig 9 we remove 5 points iteratively by repeating the leverage analysis each time the point with the lowest deviance is removed 4 3 flagging suspicious records similarly high deviance after removing a point might indicate incorrect status for that point this can be a false absence due to for example insufficient sampling effort or alternatively a false presence which can occur in ad hoc sampling records such as that found in mixed origin datasets such as the global biodiversity information facility gbif http www gbif org any dataset may contain erroneous records for example due to misidentification a record of a transient individual or an error in the assigned coordinates maldonado et al 2015 yesson et al 2007 and much effort is now exerted in finding and removing such cases chapman et al 2020 zizka et al 2020 a procedure such as that described above for assessing existing monitoring sites might provide an automated method for flagging up potential errors in datasets or points that have large influence that can then be expert assessed returning to the simulated monitoring scheme from fig 7 we change one of the absences to a false presence fig 10 top row and then separately one of the presences to a false absence fig 10 bottom row similar to the previous section we then measure the total deviance between an sdm built using all 20 points including the false record in each case and then an sdm where each point was removed in turn in both cases removing the false record led to the largest total deviance in the predicted probabilities between the new and original sdms 5 conclusions we present a new tool for analysing species distribution models in a spatially explicit manner sdm profiling we take advantage of the fact that an unsampled cell can only be in one of two potential states presence or absence we can therefore measure the leverage that a cell has on a sdm through the change in predicted probability of occurrences should that cell be sampled in the future and the species be found to occur there or not as well as providing a visual aid for identifying areas of high and low certainty in our model predictions we believe sdm profiling may also provide valuable information for designing and refining monitoring schemes of course there are constraints on processing time from the number of sampling points and the extent of the modelling area as the number of unsampled cells increases as well as the complexity of the modelling procedure for example sdm profiling of a 100 100 cell grid with 25 sampled points i e two new sdms will be created for 9975 unsampled cells 10 environmental variables and using 500 trees to build the random forest models requires 22 mins 40 secs intel core i7 8750h 2 20 ghz and 32gb ram but we recommend in such cases to run sdm profiling across multiple cores using the parallelisation option in the provided r package which will reduce the processing time considerably 4 mins 58 secs across 8 cores on the same machine of course constraints on processing time may also be alleviated by only carrying out the profiling for a subset of cells that are of interest e g fig 8 or modelling decisions such as reducing the number of environmental variables model complexity or algorithm although sdm profiling will inevitably increase the time used to create sdms we believe it can provide the spatially explicit evaluation of model outputs that is currently lacking from the majority of workflows to maximise the usage of limited funds we also encourage the consideration of sampling and modelling strategies at the planning stage of any project as part of an overall strategy to better predict species distribution patterns jeliazkov et al 2022 we therefore hope that sdm profiling can become an important tool to for the adaptive optimisation of monitoring and conservation projects credit authorship contribution statement charles j marsh conceptualization methodology data curation formal analysis investigation software validation visualization writing original draft writing review editing yoni gavish conceptualization methodology software writing review editing mathias kuemmerlen data curation investigation software writing review editing stefan stoll data curation funding acquisition project administration supervision writing review editing peter haase data curation funding acquisition project administration supervision writing review editing william e kunin conceptualization methodology funding acquisition project administration supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements funding this work was financed by the eu bon project www eubon eu that is a 7th framework programme funded by the european union under contract no 308454 the authors would like to acknowledge the use of the university of oxford advanced research computing arc facility in carrying out this work richards 2015 ph received additional funding from the eu horizon 2020 project elter plus grant agreement no 871128 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j ecolmodel 2022 110170 appendix supplementary materials image application 1 
24292,species distribution models sdms are key tools in biodiversity and conservation but assessing their reliability in unsampled locations is difficult especially where there are sampling biases we present a spatially explicit sensitivity analysis for sdms sdm profiling which assesses the leverage that unsampled locations have on the overall model by exploring the interaction between the effect on the variable response curves and the prevalence of the affected environmental conditions the method adds a pseudo presence and pseudo absence to unsampled locations re running the sdm for each and measuring the difference between the probability surfaces of the original and new sdms when the standardised difference values are plotted against each other a profile plot each point s location can be summarized by four leverage measures calculated as the distances to each corner we explore several applications visualization of model certainty identification of optimal new sampling locations and redundant existing locations and flagging potentially erroneous occurrence records graphical abstract image graphical abstract keywords active learning conservation ecological niche models model evaluation monitoring uncertainty data availability rmo data is publicly available at https rmo senckenberg de search home php simulated data can be generated using the r package downloadable from https github com charliem2003 sdmprofiling 1 introduction knowledge of species distributions is key to successful conservation measures but in nearly all cases species are known from incomplete and often spatially biased observations consequently species distribution models sdms have become key tools in biodiversity monitoring and conservation planning guisan et al 2013 they allow for a set of presence only presence pseudo absence or presence absence data hereafter occurrence data to be used to infer a species distribution across the remainder of the unsampled region elith and leathwick 2009 such outputs may then be used for a wide range of conservation applications such as tracking changes in the distribution of target species to identify increasing or decreasing trends e g brotons et al 2007 projecting potential future range shifts e g elith et al 2010 or to identify critical conservation areas essential for species persistence and reintroductions or the protection of biodiversity e g kremen et al 2008 riaz et al 2020 for sdms to be used effectively it is therefore essential that such model outputs are accurate representations of the true distributions the accuracies of sdms are dependant not only upon the sampling effort the quantity of occurrence data used to generate the models aizpurua et al 2015 valavi et al 2021 but also the spatial configuration of those sampling points kramer schadt et al 2013 syfert et al 2013 particularly for presence pseudoabsence models barbet massin et al 2012 phillips et al 2009 as there is likely to be considerable sample selection bias in occurrence data any sdm therefore risks conflating modelling species distribution with modelling this sampling bias beck et al 2014 phillips et al 2009 ploton et al 2020 radosavljevic and anderson 2014 furthermore sdms are generally evaluated through metrics summarising their accuracy against a set of validation data set aside from the modelling procedure fielding and bell 1997 ensuring maximum fit to those locations with many data this can be especially problematic if the validation data have the same spatial and environmental biases as the modelling data bahn and mcgill 2013 leroy et al 2018 such that a high level of accuracy to a small area in geographical or environmental space is assumed to apply to all areas beyond those bounds charney et al 2021 validation data can be carefully structured or filtered to minimize the influence of spatial biases as far as possible e g boria et al 2014 hallman and robinson 2020 kramer schadt et al 2013 roberts et al 2017 but any selection is still limited by where available samples are located although there is some movement towards producing maps of model uncertainty beale and lennon 2012 rocchini et al 2011 swanson et al 2013 estimating accuracy in the model outputs in a spatially explicit manner is still challenging here we develop such a method for evaluating sdms which we call sdm profiling that highlights key locations with the potential to affect model predictions should further data be collected it does this by calculating the leverage that unsampled areas would have on the overall model predictions rather than simply the effect on the response curves themselves if they were to be sampled we first describe the sdm profiling procedure in detail we then show that the values generated for each unsampled cell provide a meaningful estimate of its likely effect on our model predictions using simulated species distributions finally using simulated species and data for a freshwater gastropod from a long term monitoring scheme we highlight several potential applications for sdm profiling including as a tool for visualising areas of high and low model certainty selecting sites for collecting further data optimising monitoring schemes and flagging potentially erroneous occurrence records 2 materials and methods 2 1 the sdm profiling procedure the basic assumption of sdm profiling is that each cell sampled or unsampled can be assigned to one of only two potential states presence or absence thus we can explore the effect of the cell on an sdm by comparing the predicted probability of occurrence map when the cell is included in the analysis to a probability of occurrence map produced when the cell is not included in the analysis for example we can virtually sample an unsampled cell by including it in the sdm training data in each of its two possible states once when the cell is assumed to be a presence and once when assumed to be an absence to generate two new probability of occurrence maps fig 1 these two measures of change can be standardized and plotted against each other in a profile plot the location of the cell in this plot relative to other cells allows the quantification of the information leverage of each cell for both possible states the method incorporates not only information on the change to the response curves of the environmental variables if a cell were to be sampled but also the prevalence of those conditions within the landscape ewers et al 2010 it therefore differs fundamentally from methods that only examine which unsampled locations would cause the largest changes to the response curves such as traditional statistical leverage or influence measurements like the cook s distance in a generalized linear model for example a new sampling location might cause a very large change in predicted probability of occurrence in a particular portion of an environmental gradient if however a very small portion of the landscape possess those environmental conditions then the effect on the overall accuracy of our predictions will be small since sdm profiling always compares a new probability of occurrence map to an original one it can be applied to any species for which we have some initial occurrence data that can be used to create a base sdm as the procedure directly compares the probability of occurrence values generated by multiple sdms it is therefore advisable to build models using true presence absence data where detectability issues are accounted for rather than presence only models that may predict only relative likelihoods guillera arroita et al 2015 to start the procedure we first use the initial occurrence data to fit an sdm and create the base probability of occurrence map to which all other generated maps will be compared at this stage we have for each cell j from a total of j cells in the map the predicted probability of occurrence according to the base sdm hereafter base j we then generate a list of all the k cells we wish to profile a subset of j for a given cell k in k we set its state to presence and re run the sdm to produce a new probability of occurrence for each cell new1 k j we then repeat this procedure for the same cell k while setting its state as absence to produce a new probability of occurrence for each cell j new0 k j for each cell j we calculate the absolute deviation from the probability of occurrence in the base sdm with the new probability of occurrence when cell k is changed to a presence or absence 1 d e v 1 k j n e w 1 k j b a s e j 2 d e v 0 k j n e w 0 k j b a s e j then for each cell k the dev1 k j and dev0 k j are summed over all j cells to represent the total change in probability of occurrence across all cells when cell k is made a presence or an absence respectively next the maximum and minimum deviation across all cells are calculated 3 δ m a x m a x k j 1 j d e v 0 k j j 1 j d e v 1 k j 4 δ m i n m i n k j 1 j d e v 0 k j j 1 j d e v 1 k j finally for each focal cell k the total deviation is standardized between 0 and 1 by the maximum and minimum deviations to calculate the total change in probability of occurrence when assumed presence or absence 5 d i f f 1 k j 1 j d e v 1 k j δ m i n δ m a x δ m i n 6 d i f f 0 k j 1 j d e v 0 k j δ m i n δ m a x δ m i n 2 2 the profile plot and the four measures of leverage when repeated for all k cells we can then plot the standardised diff 1 k and diff 0 k values against each other in a profile plot fig 2 the position of cell k in this plot is therefore an indication of the total information leverage that cell would have on the model if it was sampled and the species was found to occur there or not we recognise four leverage measures that can be derived from the plot relating to the proximity to each of the four corners in all cases we calculate proximity as 2 minus the euclidean distance to the corner such that the largest leverage values for a given corner indicate the closest points these four measures are heuristically useful even though they overspecify the data once any three are known the location of any point could be triangulated making the fourth variable redundant indeed the four measures can be categorised along two axes 2 2 1 leverage strength the first axis runs from corner a to b in fig 2 and relates category to leverage strength the further along this axis towards corner a the stronger the overall leverage of that cell a dual leverage cells in this corner indicate locations that have high leverage whether the species is present or absent this may occur for example for cells in poorly sampled and or prevalent environments where small changes in the modelled responses can result in large sum changes in probability across the landscape we cannot therefore make a priori judgements on the species likely state in that cell but know that the cell has important consequences for our model predictions cells with high dual leverage values are therefore good candidates for future sampling b redundancy for cells close to this corner although leverage is similar whether made a presence or absence the change in model predictions are small in both cases and so they are not likely to be providing information not already present in the model this may occur if the environmental conditions are rare in the landscape or already well sampled cells with high redundancy values would therefore be inefficient selections for future sampling 2 2 2 leverage symmetry the second axis runs for corner c to d and relates category to leverage symmetry location along this axis indicates that leverage is stronger for one state i e either presence or absence than the other c presence leverage cells near this corner indicate that there is a large change in the predicted probability of occurrence if the species were to occur in that cell but conversely the predicted probability of occurrence remains largely unchanged when the cell is made an absence it is therefore an unlikely site for the occurrence of the species if those environmental conditions have been well sampled for example if modelling a species that is confined only to woodland adding an absence to a grassland cell would not greatly affect our predictions but adding a presence to that cell may lead to increases in suitability across all grassland cells especially if grassland has hitherto been poorly sampled therefore sampling at such a site may further confirm what the model currently predicts as absences if those conditions are well sampled but greatly change the model if those conditions were poorly sampled and modelled preference is based on relatively little data the incorrect assignment of a presence in these cells has the potential to significantly mislead predictions d absence leverage cells in the opposite corner indicate a small leverage when a presence is added but a large change in the model with the cell is made an absence again this may indicate that the cell is deemed likely to be a presence for example a woodland cell in the previous example here the incorrect assignment of an absence has the potential to significantly mislead predictions it is also worth noting that the degree of change a cell s sampling will have on the model is a function of two factors first leverage is a function of the spatial and environmental information that the cell is providing for the model so that a cell located in environmental conditions dissimilar from those already sampled will likely have higher leverage values than a cell located within a heavily sampled region of environmental space second leverage is also dependant upon the prevalence of those environmental conditions within the landscape for example the altered model may double the probability of occurrence for a certain environmental condition but if that condition is scarce within the landscape the overall change in the probability of occurrence across all cells will be small conversely only a slight increase in probability of occurrence for those conditions prevalent in the landscape may lead to a large overall change this highlights the general importance in spatial ecology that the effect sizes themselves may not be informative until mapped and aggregated across the landscape ewers et al 2010 as well as explaining why simply selecting cells based on maximising the sampled environmental space is also likely to be an inefficient solution 2 3 testing the relevance of the four leverage measures we illustrate the relevance of a cell s position in the profile plot and the four leverage measures through simulations fig 3 we created a series of virtual species and generated sdms from initially a small number of randomly assigned cells further cells were subsequently added iteratively by selecting cells closest to the respective corners of the profile plot and the change in accuracy of the sdm predictions calculated by utilising virtual species we were able to assess the true accuracy of each sdm as we increased sampling effort consistent differences in the rate of increase in model accuracy for species of different prevalences indicate if our leverage measures do indeed reflect different informational content for unsampled cells all simulations were carried out in r 3 4 3 r core team 2020 environmental and species layers were generated using the gstat package gräler et al 2016 pebesma 2004 and sdms were generated using the randomforest package liaw and wiener 2002 although sdm profiling could be applied to any sdm algorithm that outputs probability of occurrence values an r package which contains functions for carrying out sdm profiling and plotting the results can be installed from https github com charliem2003 sdmprofiling the package also contains functions for creating simulated species and sets of environmental variables that follows the described methodology 2 3 1 creation of virtual environmental variables and species distributions environmental variables environmental variables were generated in groups of five across landscapes of 50 50 cells first a surface was created using an unconditional gaussian simulation to create a random field from a spherical variogram using a consistent but arbitrary sill value of 1 5 spatial autocorrelation controlled using the range parameter was drawn from an exponential distribution the exponential of a value drawn randomly between 1 and 6 larger values result in higher levels of spatial autocorrelation four further environmental variables were then created based upon the first by subsampling 50 of the cells of the first variable the subsampled cells were then used as input for a new gaussian simulation with new spatial autocorrelation values randomly assigned from the same distribution finally values for all five variables were standardised between 0 and 1 this resulted in a group of five closely related variables but each with different levels of spatial autocorrelation we repeated this procedure a further three times to produce four groups of five environmental variables only the first variable from three groups was used to generate the virtual species distributions themselves see below but the sdms were trained with all twenty environmental variables as predictors in real world cases we generally don t know a priori which environmental variables are important in determining the distribution of the species in question and so usually there will be unimportant variables that are erroneously included our approach here means that there is ample scope for an sdm to incorrectly identify the important predictors and for this to lead to an inefficient accumulation of new sampling points sampling bias a further independent environmental variable with very high spatial autocorrelation range 500 was created that approximates a typical spatial bias in sampling probability we might expect similar real world sampling probability surfaces e g beck et al 2014 due to for example higher sampling effort around cities and universities the botanist effect moerman and estabrook 2006 this layer was generated independently of any environmental or species layer virtual species to generate a virtual species for a given set of environmental variables we multiplied the first variable of three of the environmental groups we subsampled 50 of these cells and used them as input to generate a new surface layer in the same manner as for the environmental variables using an unconditional gaussian simulation to create a random field from a spherical variogram with a sill value of 1 the surface was then converted to a presence absence distribution by selecting the number of highest value cells that equalled the desired proportion of occupied cells the procedure was repeated for six species prevalence values for a given set of environmental variables with proportions of 0 025 0 05 0 1 0 25 0 5 and 0 9 occupied cells so that for a given run all six species had similar underlying distributions but different prevalences in order to check that the species had appropriate distribution characteristics we calculated the area weighted mean class aggregation index value he et al 2000 as aggregation indices are dependant upon prevalence we only carried this out for prevalence of 0 1 species were assigned as having an aggregated distribution if the aggregated index value fell between 80 and 90 and as having a dispersed distribution if the aggregated index value fell between 30 and 40 although the thresholds are somewhat arbitrary they produced subjectively very different distribution patterns see examples in fig s1 in supplementary material if the species could not be assigned to either then the species and environmental variables were discarded and the procedure restarted initial sampling cells for each species we selected 25 cells in order to build the initial sdms we assumed perfect detection so that models were built with presence absence information cells were drawn from the sampling bias layer by generating a probability value for each cell from a uniform distribution between 0 and 1 cells where the sampling bias value exceeded the probability value were assigned as sampled we then drew 25 of the sampled cells at random ensuring a minimum of three presences or absences therefore our knowledge of the species distribution starts from a spatially biased position with no correlation to environmental variables or the species distribution approximating spatial biases that predominate in biological databases we also present results in the supplementary material where the initial 25 cells were sampled randomly with no spatial bias 2 3 2 sampling procedure for a given species within a set of environmental variables we first generated an initial sdm using the 25 starting sampling cells as presence absences all sdms were built using random forests with 2500 trees although many other algorithms are available for building sdms random forest models are very rapid to compute which is important as our simulations required fitting some 123 651 480 models however the procedure should be robust to the modelling approach used if other algorithms are preferred sdms were built using all 20 environmental variables as well as the sampling bias layer as independent variables including quadratic terms as species distributions were built using only three environmental variables multiplied we were therefore providing models that were greatly more complex than necessary and of high risk of overfitting if provided with spatially or environmentally biased training data accuracy of the sdm prediction was then evaluated against the true species distribution through the true skills statistics tss after applying a presence absence threshold of 0 5 accuracy was also assessed using the kappa statistic and auc and presented in the supplementary material further sampling sites were added with increasing increments of sampling effort initially five further sampling cells were added followed by a further 10 cells 15 cells to 95 cells in 5 cell increments for a total of 19 iterations therefore sampling effort ranged from 25 to 975 cells for each iteration a profile plot was generated for all unsampled cells additional sampling cells were selected based upon the four leverage measures generated from the profile plot a the highest dual leverage values b the highest redundancy values c the highest presence leverage values d and the highest absence leverage values as a null model we also accumulated additional sampling cells based upon the same spatially biased layer used for assigning the initial 25 sampled cells without consideration of the species potential distribution through sdms as is often typical in non species specific sampling schemes or ad hoc recording in all cases at each iteration a new sdm was generated and its accuracy assessed against the true distribution we replicated the procedure 30 times generating 30 new sets of environmental variables for each species type aggregated and dispersed and 6 species prevalences for each environmental variable set the success of the five approaches for accumulating sample cells was assessed as the increase in accuracy as sampling effort increased averaged across the 30 replicates for each species we also explored the relationship between the probability of occurrence of cells against the leverage values once the cells were profiled for a representative species if correlations are high then it may indicate that there is little additional information gained from the profiling procedure however even where probability of occurrence and leverage are correlated if there is variation in leverage values for a given probability of occurrence then selecting cells based on probability of occurrence alone would potentially result in selecting cells with relatively small leverage values we explored several potential applications for sdm profiling including visualization of model certainty in rgb colour space identification of new sampling locations and redundant existing locations and the flagging potentially erroneous occurrence records applications were illustrated using either virtual species generated using the same procedure as above the example species is the same shown in fig 6 where the initial sampling data comes from 25 sampling points arranged across a regular grid or a real world scenario of an existing freshwater monitoring scheme the long term ecological research lter mirtl et al 2018 site rhine main observatory rmo kuemmerlen et al 2016 focusing on data for a freshwater gastropod ancylus fluviatilis o f müller 1774 in this monitoring scheme 21 existing sampling points were located along the main channel and a further 50 unsampled locations were identified as potential additions for future monitoring rmo data is publicly available from https rmo senckenberg de search home php 3 results when the profile values were plotted against the probability of occurrences of the sdm profiled fig 4 leverage symmetry presence and absence leverage values but not leverage strength redundancy and dual leverage values were highly correlated with probability of occurrence cells with high presence leverage values have low probability of occurrence whereas cells with high absence leverage have high probability of occurrence there is some indication that those cells with the highest dual leverage values have probability of occurrence values around 0 5 suggesting that the measure is focusing on cells of highest uncertainty but importantly selecting sites on medium probability of occurrence alone gives little indication of their redundancy or dual leverage value selecting new sampling locations based upon their leverage values greatly affected our ability to accurately predict a species distribution in consistent ways fig 5 confirming the relevance of the profile plot however the identity of the most appropriate sampling method differed depending upon the prevalence of the species in general selecting points using redundancy fig 5 purple lines those points that result in little change to the sdm output when added led to slow increases in accuracy whereas selecting points based on dual leverage fig 5 green lines those points that cause large change to the sdm output when added generally led to rapid increases in accuracy especially when adding to small numbers of sampled cells or for species with medium prevalences accumulating samples based only on a spatial bias independent of the species fig 5 orange lines was inefficient across all scenarios for prevalent species accumulating sampling points based on presence leverage low values for diff 0 high values for diff 1 fig 5 blue lines led to rapid increases in accuracy whereas for rare species i e the majority of species on earth accumulating sampling points based on absence leverage high values for diff 0 low values for diff 1 fig 5 red lines led to rapid increases in accuracy for example selecting points for a rare species based upon absence leverage can almost double accuracy compared to other methods whereas selecting points based upon presence leverage would lead to only half as much increase in accuracy fig 5 we can see in fig 6 first column that using absence leverage concentrates points on the few true presences and so even though the selected points covers only a small proportion of the environmental space second column the model can accurately predict the edges of the species range by contrast selecting points for rare species through presence leverage values identifies locations where there is high certainty of absence which are of little value to increasing model accuracy although a wide environmental space is sampled many cells need to be sampled before the environmental space dividing presences and absences has been adequately covered selecting points based on redundancy low values for diff 0 low values for diff 1 accumulates points in a spatially clustered manner whereas selecting points based upon dual leverage high values for diff 0 high values for diff 1 samples widely across the entire landscape roughly in proportion to prevalence and so provides a good compromise between absence and presence leverage whilst performing well across all species prevalences fig 5 4 discussion we can envisage three main uses for sdm profiling ranging from model visualisation to optimising sampling schemes and flagging suspicious points in existing datasets e g occurrence records with geocoordinate issues or misidentifications 4 1 visualisation of leverage and spatial biases if we calculate leverage for every cell we can plot the four leverage distances individually as spatially explicit maps fig 7 alternatively as there are only three degrees of freedom see 2 2 above we can visualise all leverages simultaneously by mapping three of the leverage values on to three axes using a red green blue rgb plot in the example in fig 7 values for absence leverage determine the values for red dual leverage the values for green and blue is determined by presence leverage now areas in blue are likely absences high presence leverage areas in red likely presences high absence leverage areas in purple of little importance for model accuracy high redundancy and light green indicates high dual leverage 4 2 evaluating and improving existing sampling schemes existing monitoring schemes have limited sampling capacity due to financial and methodological constraints therefore producing sdms for target species can be an important analytical tool in conservation and management where complete sampling of all sites is not feasible domisch et al 2015 kuemmerlen et al 2016 2015 in most cases the location of sampling sites is based on an equally spaced or on an environmentally stratified design with some degree of randomness within those constraints all these cases are insensitive to the species perspective of its environment and to the model s ability to distinguish between presences and absences thus it is important to develop tools that will optimize sampling sites selection for existing or new monitoring schemes guisan et al 2006 as the simulations show in the previous section sdm profiling may be used to select new sampling sites that will likely lead to the largest increases in model accuracy for the minimum increase in sampling effort figs 5 6 interestingly the simulations showed that contrary to expectations selecting new sites so as to cover a broad range of environmental conditions e g an environmentally stratified design is generally inefficient when monitoring a single species although such a scheme may be advantageous for assemblage monitoring where species have differing environmental preferences instead concentrating on selecting those sites that are at the environmental boundaries between areas of presence and absence is more likely to result in higher accuracy the sdm profiling approach differs fundamentally from sdm targeted approaches guisan et al 2006 that base further sampling only on the output of the sdm using sampled locations such approaches such as adaptive niche based sampling developed for rare species chiffard et al 2020 typically prioritise detecting new presences by focussing on further sampling in unsampled locations with predicted high probability of occurrences or targeting areas of environmental space that remain unsampled in contrast by assessing model leverage sdm profiling examines the interactions between unsampled environmental space the prevalence of that environmental space in the landscape and the effect sizes of the difference between the unsampled environmental space from sampled environmental space estimated from the response curves recovered from the sdm therefore we are prioritising sampling that will increase the accuracy of model predictions rather than necessarily discovering new locations of presences or absences we illustrate this potential using the monitoring data of the freshwater gastropod ancylus fluviatilis in the rmo dataset the scheme is to be extended to higher order streams and 50 candidate sites were drawn up fig 8 by applying sdm profiling to the candidate sites we can select those that have a large but unknown potential effect on our knowledge of the species distribution as the sites with the highest dual leverage values alternatively we can choose to omit sites with highest redundancy values that will provide the least new information as well as evaluation of unsampled cells we can similarly assess the leverage of our sampled sites for example if we wanted to reallocate effort from existing monitoring sites in this case we remove each sample point in turn and re run our sdm calculating the deviance between the new and base sdms and standardising each site relative to the largest deviance value sites where models are very similar when built with and without that data point i e high redundancy values are therefore ones with little leverage on our model and so could be removed entirely with small impacts on model accuracy in the example in fig 9 we remove 5 points iteratively by repeating the leverage analysis each time the point with the lowest deviance is removed 4 3 flagging suspicious records similarly high deviance after removing a point might indicate incorrect status for that point this can be a false absence due to for example insufficient sampling effort or alternatively a false presence which can occur in ad hoc sampling records such as that found in mixed origin datasets such as the global biodiversity information facility gbif http www gbif org any dataset may contain erroneous records for example due to misidentification a record of a transient individual or an error in the assigned coordinates maldonado et al 2015 yesson et al 2007 and much effort is now exerted in finding and removing such cases chapman et al 2020 zizka et al 2020 a procedure such as that described above for assessing existing monitoring sites might provide an automated method for flagging up potential errors in datasets or points that have large influence that can then be expert assessed returning to the simulated monitoring scheme from fig 7 we change one of the absences to a false presence fig 10 top row and then separately one of the presences to a false absence fig 10 bottom row similar to the previous section we then measure the total deviance between an sdm built using all 20 points including the false record in each case and then an sdm where each point was removed in turn in both cases removing the false record led to the largest total deviance in the predicted probabilities between the new and original sdms 5 conclusions we present a new tool for analysing species distribution models in a spatially explicit manner sdm profiling we take advantage of the fact that an unsampled cell can only be in one of two potential states presence or absence we can therefore measure the leverage that a cell has on a sdm through the change in predicted probability of occurrences should that cell be sampled in the future and the species be found to occur there or not as well as providing a visual aid for identifying areas of high and low certainty in our model predictions we believe sdm profiling may also provide valuable information for designing and refining monitoring schemes of course there are constraints on processing time from the number of sampling points and the extent of the modelling area as the number of unsampled cells increases as well as the complexity of the modelling procedure for example sdm profiling of a 100 100 cell grid with 25 sampled points i e two new sdms will be created for 9975 unsampled cells 10 environmental variables and using 500 trees to build the random forest models requires 22 mins 40 secs intel core i7 8750h 2 20 ghz and 32gb ram but we recommend in such cases to run sdm profiling across multiple cores using the parallelisation option in the provided r package which will reduce the processing time considerably 4 mins 58 secs across 8 cores on the same machine of course constraints on processing time may also be alleviated by only carrying out the profiling for a subset of cells that are of interest e g fig 8 or modelling decisions such as reducing the number of environmental variables model complexity or algorithm although sdm profiling will inevitably increase the time used to create sdms we believe it can provide the spatially explicit evaluation of model outputs that is currently lacking from the majority of workflows to maximise the usage of limited funds we also encourage the consideration of sampling and modelling strategies at the planning stage of any project as part of an overall strategy to better predict species distribution patterns jeliazkov et al 2022 we therefore hope that sdm profiling can become an important tool to for the adaptive optimisation of monitoring and conservation projects credit authorship contribution statement charles j marsh conceptualization methodology data curation formal analysis investigation software validation visualization writing original draft writing review editing yoni gavish conceptualization methodology software writing review editing mathias kuemmerlen data curation investigation software writing review editing stefan stoll data curation funding acquisition project administration supervision writing review editing peter haase data curation funding acquisition project administration supervision writing review editing william e kunin conceptualization methodology funding acquisition project administration supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements funding this work was financed by the eu bon project www eubon eu that is a 7th framework programme funded by the european union under contract no 308454 the authors would like to acknowledge the use of the university of oxford advanced research computing arc facility in carrying out this work richards 2015 ph received additional funding from the eu horizon 2020 project elter plus grant agreement no 871128 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j ecolmodel 2022 110170 appendix supplementary materials image application 1 
24293,the study presents several steps of a fish ramp geometry optimization performed with a 3d numerical model dualsphysics which is based on the smoothed particle hydrodynamics sph method the optimization process led to the design of a bottom ramp that is capable of providing suitable conditions for the migration of target fish species salmo truta phoxinus phoxinus cottus gobio and eudontomyzon vladykovi migration routes were determined as complex 3d volumes of fluid according to the simulated velocity field in various steady flow conditions including three categories of potential migration zones rest effort and limit zones migration routes were quantified in high detail in terms of the size and position of each zone and in terms of the distance from a given fluid part to the nearest rest zone the interdisciplinary approach of this study also led to the development of new tools for the dualsphysics model specifically suited to improve functionality in eco hydraulics research keywords fishway ramp river restoration smoothed particle hydrodynamics dualsphysics data availability data will be made available on request 1 introduction 1 1 background drawing from the ecological niche concept grinnell 1917 hutchinson 1957 dingle and alistair drake 2007 we recognize that each species is bound by its own set of limiting and optimum environmental conditions that define its behavior and survival although fish migration distances range from several hundred meters short distance migrants to thousands of kilometers long distance migrants aarestrup et al 2009 lucas et al 2001 all fish move up and down the river during their life to fulfill the essential life processes such as feeding shelter reproduction etc jungwirth 1998 northcote 1978 lucas et al 2001 radinger and wolter 2014 silva et al 2018 longitudinal connectivity is an essential function of rivers that not only enables the dispersal and migration of fauna e g fish migration macroinvertebrate dispersal etc but also allows sediment transport the key process in the creation of habitat diversity mikuś et al 2021 across the globe freshwater fish populations and biodiversity are in drastic decline it is known that hydro morphological alterations especially barriers are the most common pressure on surface waters in europe eea 2018 and cause tremendous harm to the natural functioning of our riverine ecosystems chamberlain 2020 european environment agency 2020 liermann et al 2012 silva et al 2018 wwf 2018 an indicator of which are fish populations deinet et al 2020 more than one million barriers fragment european rivers belletti et al 2020 of which more than 60 000 are impacting slovenian rivers pengal et al 2021 recent policies such as eu biodiversity strategy european commission 2020 the un decade on restoration unep and fao 2020 and the green deal european commission 2019 call for a complete shift in our treatment of aquatic ecosystems from management and governance to stewardship and restoration as a mitigation measure numerous fish passage solutions have been proposed ranging from technical fish passes pool passes vertical slot passes vsf denil passes eel ladders fish locks fish lifts to close to nature types bottom ramps and slopes bypass channels fish ramps fao and dvwk 2002 schmutz and mielach 2013 mader et al 1998 however recent findings suggest that common fishway design criteria do not adequately account for natural variation among individuals populations and species birnie gauvin et al 2019 silva et al 2018 engineered solutions often cannot reinstate the natural habitat and geomorphological properties of the river and these objectives have been largely ignored birnie gauvin et al 2019 therefore a shift from merely designing a hydraulic solution to providing a more ecological solution has been recognized as the most efficient approach eea european environment agency 2018 iucn 2020 raymond et al 2017 among others technical solutions to help fish migrate may include close to nature bottom ramps and by passes such actions need to be carefully designed to determine their impact on the current state this is where experience from experts in fish passage design implementation and monitoring is of great value one possible solution is also dam removal experts estimate that between 4000 and 5000 dams in total have already been removed in europe with records from france and sweden indicating 2300 and 1600 dams removed respectively gough et al 2018 however dam removal may also raise certain concerns e g water surface and groundwater levels erosion and sedimentation often leading to negative public opinion especially where existing infrastructure and land use present limitations that cannot be avoided where a complete restoration of a river reach is not possible e g a by pass cannot be constructed due to existing land use constraints or economic reasons partial removal of a dam or a weir combined with additional mitigation measures may present a viable compromise an example of such a compromise is the solution proposed in the present study where the existing weir could be partially lowered but not completely removed and a suitable ramp could be implemented upstream and downstream of the weir resembling the nearby natural stream channel recently the design of fish passes is increasingly based on 3d modelling e g fuentes pérez et al 2018 investigated turbulent flow in vertical slot fishways detailed quantification e g marti puig et al 2018 investigated animal scoring behavior in terms of trajectories and integrating different aspects of habitat suitability e g shim et al 2020 aimed to combine hydraulic and physiologic habitat suitability the present study aims at providing an application of such an approach including 3d modelling detailed quantification of velocity fields and migration routes and interdisciplinary cooperation focusing on a real life case of the radušnica stream in slovenia the main goal of the study was to use computational fluid dynamics cfd to design a fish friendly ramp that would provide nature like flow conditions similar to those in a natural reach of an existing stream as such the present study provides designers and decision makers with a fish passage optimization cfd tool that takes into consideration both functionality and harmonious integration into the landscape one of the advantages of cfd is that it allows the quantification of flow characteristics that are difficult to measure either in a laboratory or in the field as the present study involves a complex free surface flow over a very non uniform geometry we adopt the fully three dimensional 3d dualsphysics solver which is based on the smoothed particle hydrodynamics method sph introduced by monaghan and gingold 1983 validated and verified against numerous benchmark tests e g see spheric sph org and dual sphysics org the dualsphysics has been successfully applied to cases of turbulent free surface flow such as in a weir and pool fishway english et al 2022 vertical slot fishway novak et al 2019 and flow over a complex geometry bottom ramp novak et al 2021 in the present study new functionalities for eco hydraulics applications were developed new post processing tools were added to the dualsphysics as explained in section 2 3 the driving hypothesis of the study was that the dualsphysiscs software supported by the newly developed tools would allow a detailed design of a fish passage that takes into account the swimming capabilities of target species and flow characteristics in a geometrically and hydraulically complex environment the design process involved several steps of geometry optimization to quantify the proposed solution potential migration routes were analyzed in terms of various zones and distances to their locations data on the swimming performance of local fish and lamprey species were used to identify different zones within the resulting velocity fields migration zones were treated as complex 3d volumes the main novelties of this study include 1 the resulting velocity fields were analyzed in terms of potential migration routes represented by three different zones i e rest effort and limit zone 2 based on the velocity fields the distances to nearest rest zones were calculated as a way of quantifying fish friendliness to the proposed design 3 dualsphysics post processing tools were improved to increase the code functionality in eco hydraulics applications 2 methods this study builds on our previous work novak et al 2021 in which we first validated our numerical tools against the experiments by kupferschmidt and zhu 2017 and the numerical work by baki et al 2020 and then modeled a bottom ramp fish passage in the present study this model was applied to design a nature like fish ramp which is in essence a similar task in terms of model performance i e steady 3d water flow around and over obstacles of various shapes and sizes with a focus on horizontal velocity fields thus it is assumed the validation performed in our previous work is adequate for the present application the optimization was an iterative process starting from a very regular configuration and ending with a complex one that could be applied as a channel restoration measure for the actual site 2 1 study area the study area is a short section of radušnica a 5 km long stream flowing into the suhodolnica river in north eastern slovenia fig 1 a radušnica is an interesting case study because it is quite typical for the region but at the same time protected by natura 2000 status even more importantly local stakeholders have a positive attitude towards restoration plans indicating that the conclusions of the present study i e the proposed geometry of the ramp could be implemented at the target section there is a 1 3 m high concrete obsolete weir that spans the entire 4 m width of the stream and is followed by several wooden sill cascades fig 1b the weir blocks migration of freshwater organisms impacts sediment transport and deteriorates the visual appearance of the stream upstream of the weir the natural channel has a minimum slope while the average slope of the radušnica is 1 5 the steep drop of the weir and the steps created by the downstream sills could be mitigated for example by keeping the weir but constructing a bottom ramp immediately downstream of the weir keeping the radušnica s average slope of 1 5 the span of 1 3 m elevation difference would require a restoration of an 87 m section of the river channel which could be achieved through re meandering but would require extensive land purchases alternatively the connectivity could be achieved by decreasing the elevation of the obsolete weir and restoring two shorter river sections upstream and downstream of the weir in this study one such section of the river channel 15 m length is modeled as a typical case considered representative of the flow dynamics in the entire restoration section as described in novak et al 2021 no detailed hydrological data currently exists for the radušnica thus the input data for the model had to be estimated in contrast to our previous study where the inflow velocity was assigned as u 0 5 m s for all the cases the present study considers wider range of conditions with inflow velocity ranging from u 0 4 m s to u 0 7 m s inflow depths ranging from h 0 1 m to h 0 3 m and inflow discharges ranging from q 0 16 m3 s to q 0 84 m3 s as summarized in table 1 it was assumed that these cases correspond to typical discharges at the target location during different fish migration periods further work should include a more detailed field confirmation the case denoted with q1 represents dry conditions and its u and h correspond to data from the nearby suhadolnica river u 0 403 m s measured during low discharge the case denoted with q2 represents average conditions while the case denoted with q3 represents the highest flow during the fish migration period in its natural reach upstream of the weir the radušnica is a gently meandering 2 m wide channel with a pebbled bed and stones with diameters up to 0 25 m in the model these characteristics were taken into consideration during the geometry optimization and were modeled with various elements as explained in section 3 1 2 2 the target species three species of fish and one species of lamprey live in the target stream brown trout salmo truta european minnow phoxinus phoxinus european bullhead cottus gobio and the danubian brook lamprey eudontomyzon vladykovi a range of approaches are used for estimating fish swimming capacities e g sustained critical burst swimming speed etc defined in terms of speed and time sustained until fatigue table 2 the brown trout is the most efficient swimmer among the target species with critical and optimal swimming speeds estimated at 65 4 cm s and 31 6 cm s respectively tudorache et al 2008 bullhead anchor themselves with their pectoral fins at the bottom so the critical swimming speed is practically impossible to determine tudorache et al 2008 therefore only the maximum swimming speed was available from the literature experimentally estimated at 112 5 cm s tudorache et al 2008 because the ecological and biological requirements especially in terms of biomechanics of the other two target species have not been studied selected proxies from ecologically similar species are used in the analysis for the european minnow the mean critical swimming speed of spotfin shiner cyprinella spiloptera was used having a value of 60 8 cm s nichols et al 2018 the burst swimming speed of larval pacific lamprey lampetra tridentata ranges from 33 3 to 75 0 cm s sutphin and hueth 2010 so the lower value was used to estimate the swimming capacity of the danubian brook lamprey data on the swimming speed of each target species as well as their ecological requirements e g resting areas was taken into consideration during the optimization of the channel geometry and for the definition of migration routes as described in the results section it was assumed that if a suitable migration route is achieved for the weakest swimmer the species with higher capabilities would also find a suitable migration route thus the optimization was based on the swimming capacities of the weakest swimmer i e the danubian brook lamprey this means that the smallest parts of potential migration zones were defined as cylindrical volumes of water flow having the following characteristics radius rm 0 03 m length lm 0 15 m and velocity magnitude um 0 45 m s as explained in more detail in section 2 3 2 2 3 computational model the numerical simulations in this study were performed using the dualsphysics solver a 3d open source cfd model that is based on the sph method as described in domínguez et al 2022 dualsphysics is based on the weakly compressible formulation of sph and it can run on conventional cpus or cuda supported graphics processing units gpus the latter was employed in the present study and this allowed simulations with up to 8 million particles to be completed within reasonable computational times the main features of dualsphysics and the new features that were implemented in the present study are briefly reported below 2 3 1 dualsphysics a detailed description of the dualsphysics formulation can be found in domínguez et al 2022 therefore only the formulations used in this study are mentioned here modeling viscosity was achieved through an artificial diffusive term that is added to the momentum equation to reduce oscillations and stabilize the sph scheme monaghan and gingold 1983 due to its simplicity the artificial viscosity formulation is often used as a physical viscous dissipation term with an associated coefficient α based on scaled flume experiments the default value of this coefficient in dualsphysics is α 0 01 altomare et al 2015 and this value was used in the present study moreover the use of a density diffusion term in the sph method is necessary to reduce the density fluctuations associated with this method which can be aggravated in long term simulations the density diffusion term proposed by fourtakas et al 2019 with the coefficient value of 0 1 was used to perform the simulations in this study in dualsphysics solid boundary conditions e g for the riverbed and channel sides can be modeled in two ways dynamic boundary conditions dbc are represented by fixed particles with density computed from the continuity equation and pressure obtained from the equation of state crespo et al 2007 when using dbc an unphysical gap between the fluid and the solid boundaries appears lowering the accuracy of the pressure prediction at the boundaries this can be alleviated by a second approach called modified dynamic boundary conditions mdbc english et al 2022 with the density of boundary particles obtained from so called ghost nodes cleverly positioned within the fluid domain in all simulations of the present study the mdbc were employed in the present study new tools were added to dualsphysics to increase its functionality joined in a post processing tool called flowrest these new options allow the calculation of 3d resting zones or migration routes and their distance to the main flow as described in the following section 2 3 2 flowrest tool a resting zone or a migration zone was defined as a volume of fluid where the flow conditions were likely to be suitable for the resting or migration of the target species based on the biomechanic skills of each species thus a resting migration zone was defined as a 3d volume of fluid that simultaneously met the following two criteria 1 the fluid velocity within the zone is below a specified value related to the swimming speed of the target species i e u u m and 2 the size and shape of the volume is larger than a specified value related to the size of the target species i e radius r r m and length l l m in other words a pill shaped object like the one shown in fig 2 must fit inside a resting migration zone this way each zone can be identified computationally based on the simulation results i e location of fluid particles and their velocity fields within post processing several characteristics of the zones were quantified including their number location dimensions volume absolute and in percentage and mean velocity within the volume next a distance from any fluid point to the nearest rest zone was calculated and again quantified in terms of mean and maximum distance the main results of the flowrest tool are summarized at the end of section 3 2 3 3 numerical setup the model domain included an open rectangular channel with l 15 m length b 4 m width and h 1 m height the length of the domain was selected as a good compromise between computational cost and accuracy various elements were added to the channel to mimic the stream substrate randomly generated half spheres for pebbles suitably positioned spheres for stones and cylinders representing rocks in all the simulations the initial inter particle distance was set to dp 1 5 cm following the procedure described in tafuni et al 2018 the constant slope of the channel was simulated via a horizontal channel subjected to an inclined gravity acceleration for example i 1 5 slope was modeled as a horizontal channel with g g x g y g z 0 147 0 9 809 m2 s steady flows at the inlet and outlet sections were imposed with constant fluid depths h and uniform fluid velocities u auxiliary upstream and downstream reaches of the channel each 1 m long and located next to the inlet and outlet respectively were kept smooth and without any obstacles with the initial fluid depth and velocity set to desired values the main simulations covered 30 seconds of physical time so that steady conditions were accomplished the convergence of the flow can be analyzed in terms of the discharge calculated volumetrically from the fluid particles i e as a volume of fluid divided by time for the q3 discharge q 0 84 m3 s flowing over the proposed geometry the convergence was confirmed with the following result fig 3 a horizontal line showing q 0 84 m3 s is added for easier visualization note that the first 5 seconds of the simulation are not shown and that it takes some time for the initial condition to evolve according to the ramp characteristics fig 3 shows that convergence occurred after 20 seconds as mentioned our simulations of the proposed configuration extended over that period 3 results 3 1 geometry optimization the proposed design of the presented nature like channel was obtained as the result of several optimization stages going from a simple uniform geometry to a complex one the main optimization criteria were velocity fields especially near the bed and in the mid depth region these stages investigated the effect of the following parameters 1 channel slope 2 bed roughness 3 curvature of the mean flow 4 position and size of larger obstacles 5 position and size of smaller obstacles against the swimming capacities of the target fish and lamprey the main steps are summarized in table 3 each stage represents an intermediate step toward the final solution and is thus described only briefly while the final geometry is described in more detail the process was completed iteratively considering the comments by engineers and biologists in our team the best configuration from the first stage was fixed in the second then the best option from the first two stages was fixed in the third and so on all optimization stages were performed using input data u and h for the q2 case which represented the average discharge 3 1 1 bed slope stage 1 investigated the slope i of a smooth channel and confirmed i should be kept as low as possible with the inlet imposed the same way as the outlet uin uout hin hout a hydraulic jump occurred in cases with a steeper slope maximum velocities occurred upstream of the hydraulic jump ranging from 2 0 to 4 5 m s for i 1 5 to i 7 5 respectively 3 1 2 bed roughness elements stage 2 employed i 1 5 slope in all the cases and showed that the bed roughness elements decreased the near bed velocities and slightly increased the fluid depth without affecting other overall characteristics of the flow model roughness represented by semi spheres rr 0 03 m was selected as the best approximation of the bed along the natural part of the radušnica the bed roughness elements were generated along the width b and from x 1 m to x 14 m and were randomly placed to obtain a more natural non uniform distribution an example is shown in fig 4 model variants ranged from a case of a smooth bed i e zero bed roughness elements to a case with 5200 semi spheres i e an average of 400 elements per meter length based on the resulting velocity fields for the z 0 05 m plane parallel to the bed a configuration with 3900 elements i e 300 elements per meter length was selected 3 1 3 mean flow curvature in stage 3 the i 1 5 channel with a total of 3900 bed roughness elements was equipped with transverse sets of five equal cylinders with rc 0 2 m hc 0 3 m uniformly distributed at a longitudinal distance δxc apart their purpose was to replicate the meandering of natural streams somewhat resembling technical types of fishways and diversification of flows based on the resulting velocity fields the geometry with δxc 3 5 to 4 m was selected as the best option fig 5 note that in fig 5 the velocities at the downstream line of obstacles locally reach above 2 m s even at q2 and even close to the bed the figure shows a flow that is steady i e not changing with time and non uniform i e changing with location even in equally wide sections of unobstructed flow the velocity fields change with location 3 1 4 size and position of larger obstacles in stage 4 larger obstacles were placed transversely but included cylinders of various heights and radii the following variants were tested a rc 0 2 m hc 0 3 m horizontal high crest b rc 0 2 m hc 0 15 m horizontal low crest c rc 0 2 m hc 0 15 to 0 35 m stepped crest hc decreasing towards the channel axis d rc 0 2 m hc 0 15 to 0 35 m distributed non uniformly variant 1 e rc 0 2 m hc 0 15 to 0 35 m distributed non uniformly variant 2 based on the resulting velocity fields the last variant was selected 3 1 5 size and position of smaller obstacles in stage 5 sets of larger obstacles were changed so that each set included more cylinders with their size and position varying even more than in stage 4 additionally smaller obstacles i e spheres were added within the main flow region the cylinders and spheres were added in several steps iteratively providing a greater variety of velocity fields while simultaneously decreasing the maximum velocities to establish suitable conditions for all target species the optimization resulted in the final geometry of a nature like channel shown in fig 6 fig 6 shows bed roughness elements a total of 3900 semi spheres with rr 0 03 m distributed along the 13 m reach three sets of eight larger obstacles cylinders with rc 0 2 to 0 3 m and hc 0 2 to 0 45 m and twenty five smaller obstacles spheres with radius r s 0 15 m this geometry was later used with q1 and q3 flow conditions as those two cases were estimated as being the most potentially problematic in terms of low depth q1 and high velocities q3 thus the main results presented next focus only on q1 and q3 conditions 3 1 6 statistical comparison of optimization stages typical cases of optimization stages are compared in terms of statistics given in table 4 in table 4 the notion of slow fluid means the volume of fluid where u 0 5 m s while a rest zone is defined as having a mean u 0 45 m s which corresponds to the effort migration zone discussed in section 3 4 interestingly the variant representing stage 3 seems to be the best according to the selected statistics however the apparent superiority of the stage 3 configurations is misleading flow in all of the stage 3 variants is a uniformly meandering stream with high velocities in the narrow sections and low velocities behind obstacles this can lead to a favorable average but such a geometry is inferior to the one proposed in the present study because the latter allows various paths of migration in our previous work novak et al 2021 a tool for the calculation of the ratio between the flow area and flow velocity was introduced applied to each cross section of the model this tool gives a clearer view of flow characteristics than most common statistics a comparison of a typical uniformly meandering stream stage 3 and the proposed configuration is presented in fig 7 fig 7a shows distinctive dents at locations of narrow sections at these locations the flow depths are lower and the velocities are higher making these parts more difficult for a fish to pass in contrast fig 7b shows a much more gradually varying flow with a slightly smaller portion of very low velocities but also with a distinctly smaller portion of high velocities making such fish pass more efficient 3 2 flow depth the first critical parameter defining suitable fish migration routes is the flow depth baudoin et al 2015 the results for the q1 dry conditions and the q3 larger discharge cases are shown in fig 8 a and 8b respectively note that fig 8 shows the fluid depth above the solid boundary bed roughness element smaller or larger obstacle not the water surface elevation the proposed geometry provides a depth of about 0 1 m in dry conditions fig 8a and a relatively uniform depth of about 0 3 m during the larger discharge fig 8b 3 3 velocity fields velocity was the second critical parameter that was analyzed and used to define the potential routes for fish migration in the presented model all three velocity components longitudinal u transverse v vertical w were calculated for each location x y z of the domain and for each output step outputs for every 0 05 s of the simulation were selected it was decided to focus on velocity fields at the end of the simulation given as vector fields in planes located at a constant z above the channel bed such slices of complex 3d fields are presented in fig 9 including near bed velocities z 0 05 m plane and mid depth velocities z 0 15 m plane fig 9a shows that in dry conditions case q1 velocities remain mostly below 0 5 m s with numerous areas of very low velocities 0 2 m s fig 9b shows how near bed velocities increase with discharge velocities of up to 1 5 m s occur in separate jets within the downstream set of rocks but these conditions are localized figure 9c confirms that mid depth velocities are greater than the near bed ones local maximum values reach 2 m s but there are areas of low velocities 0 4 m s nearby 3 4 migration routes since fish migration is essentially limited by the swimming capacities of each species we define migration routes as the paths in which flow conditions correspond to the swimming capacities of the fish and as such theoretically allow fish to move along the river such routes consist of migration zones as defined in section 2 3 a migration zone can be regarded as a volume of fluid with a certain velocity radius and length in our case the following values were selected radius of at least rm 0 03 m length of at least lm 0 15 m and velocity thresholds ranging from um 0 34 m s to 0 45 m s to 0 52 m s these velocities can be used to define different types of zones as listed in table 5 all three zone types combined represent a migration route the listed values correspond to experimental results for optimal sustained and critical burst swimming speeds for target fish these zones are 3d volumes that form complex shapes not just layers limited to the water surface migration zones for q1 and q3 cases are given in figs 10 and 11 respectively figs 10 and 11 show that lower velocity volumes are located behind various obstacles and that the extent of limit zones is expectedly larger than the extent of the rest zones in the q1 case migration routes are almost continuous while in the q3 case they are smaller and more fragmented besides the size and position the present study introduces also the calculation of the distance between the migration zones applying the proposed geometry they are readily reachable from practically any location as confirmed in fig 12 which shows a map of the distances from fluid points to the nearest migration zone selected here for the comparison are effort zones with um 0 45 in fig 12 the main flow region lighter and the low velocity regions darker can be distinguished note that larger distances appear only close to inlet and outlet sections which are on the edge of the designed channel reach within the reach with obstacles the distances to the nearest migration zones are below 0 5 m and 1 5 m in the q1 and q3 cases respectively some main statistical characteristics of the migration zones are summarized in table 6 table 6 shows that during low discharge the percentage of migration routes is larger due to the lower flow velocities also the volumes of zones increase if we allow a larger velocity threshold 4 discussion based on flow depth results fig 8 the proposed geometry provides sufficiently deep flow even in dry conditions important advantages of the proposed geometry are its bed roughness elements and obstacles model stones and rocks of various heights which allow water to flow around or over them providing target species with a variety of flow depths along their migrating corridors in contrast to more technical fish passes e g vsf where the flow depth is typically mostly constant within a pool also the proposed geometry is without unconnected crevices that can become ecological traps as pointed out by plesiński et al 2018 although it was not an object of the present study a favorable tailwater effect could occur at the downstream end of the study site increasing the downstream depth and decreasing the velocities thus contributing to more suitable depths and velocity fields along the whole observed section based on resulting velocity fields fig 9 the proposed geometry provides suitable conditions for all target species the weakest swimmers can find their way upstream staying close to the bottom while better swimmers can overcome even the localized areas of larger velocities the fact that velocity fields parallel to the bed change with their distance from the bed is an important advantage in comparison to more technical fish passes where flow fields are much more uniform e g in a vsf they are depth averaged and flow patterns remain practically the same in all pools diverse velocity fields are also favorable in terms of whirls as pointed out by puzdrowska and heese 2019 the size of vortices depends on the size of the flow e g distances between the obstacles thus the proposed geometry does not allow the formation of potentially problematic larger whirls at the same time the configuration is not too uniformly fragmented thus avoiding the disadvantages of the technical solutions such as baffled chutes bylak et al 2017 based on calculated migration routes resting areas and their mutual distance figs 10 11 12 the proposed geometry provides the fish with ample resting space to recover their strength after periods of burst and or critical swimming sessions the velocity fields and migration zones show localized regions of higher flow velocities and thus fragmented migration routes during higher discharge indicating that the weaker swimmers might not be able to migrate in these conditions however the distances between migration zones fig 12 are small enough for the stronger swimmers to easily cross areas of faster flow as they can maintain various levels of swimming effort for long enough comparing these results against the swimming capacities of target species it is clear that all species except the lamprey should be able to migrate even during the high discharge period however most fish species do not migrate during high discharge periods and such periods occur rarely and have limited duration so they should not be taken as a reference but rather as the limit conditions the present study could be upgraded with simulations of movable bed elements to investigate how the ramp and its flow characteristics would change due to sediment transport such simulations would be a valuable contribution to evaluations of restoration projects e g like the one described in mikuś et al 2021 5 conclusions several stages of fish ramp geometry optimization were performed including variants of channel slope bed roughness and sizes and positions of flow diverting obstacles adjusting the geometry to the characteristics of the actual site led to a near natural ramp configuration that provides flow conditions diverse enough to allow different fish species to find their preferred migration route the flow conditions were presented in terms of velocity fields at selected planes parallel to the channel bed based on the fish swimming performance criteria suitable migration routes were identified these routes form complex 3d structures made of numerous volumes of slower fluid and give important insights into a future design of similar eco hydraulics applications these representations also indicate how fish might perceive the river identifying areas of favorable and unfavorable spaces to navigate the rivers the presented analysis of flow over a complex geometry confirms that the design of a nature like fish pass configuration can be optimized using a fully 3d numerical model based on the sph method the resulting flow can be analyzed in great detail allowing calculations of fluid depths velocity fields flow area flow velocity ratio migration zones and their mutual distances this means the decision makers can now get better insight into the flow features that were previously difficult to quantify leading to more efficient designs of fish passages in terms of software development improvements to the validated and verified dualsphysics model were implemented to achieve the objectives of the present study a new tool named flowrest was devised to allow a detailed quantification of migration zones future work will focus on importing additional non uniformly shaped 3d objects into the model to mimic natural stones and rocks the riverbed slope will be diversified to accommodate the natural riffle pool sequence characteristics furthermore an improved tool for the quantification of trajectories focused on whirls will be applied enabling complex fishway flows to be analyzed in even more detail finally with the employment of a multi phase combination of water and sediment the simulations will produce even more realistic results allowing investigations of sediment transport in stream restoration solutions credit authorship contribution statement gorazd novak conceptualization formal analysis investigation data curation writing original draft polona pengal conceptualization investigation writing original draft ana t silva conceptualization writing original draft josé m domínguez data curation methodology software visualization writing review editing angelo tafuni methodology software visualization writing review editing matjaž četina funding acquisition supervision writing review editing dušan žagar funding acquisition supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was partially funded by the slovenian research agency arrs as part of the research programme p2 0180 water science and technology and geotechnical engineering tools and methods for process analyses and simulations and development of technologies this work was partially supported by the project surviwec pid2020 113245rb i00 financed by mcin aei 10 13039 501100011033 and by the project ed431c 2021 44 programa de consolidación e estructuración de unidades de investigación competitivas financed by xunta de galicia consellería de cultura educación e universidade this study forms part of the marine science programme thinkinazul supported by ministerio de ciencia e innovación and xunta de galicia with funding from european union nextgenerationeu prtr c17 i1 and european maritime and fisheries fund 
24293,the study presents several steps of a fish ramp geometry optimization performed with a 3d numerical model dualsphysics which is based on the smoothed particle hydrodynamics sph method the optimization process led to the design of a bottom ramp that is capable of providing suitable conditions for the migration of target fish species salmo truta phoxinus phoxinus cottus gobio and eudontomyzon vladykovi migration routes were determined as complex 3d volumes of fluid according to the simulated velocity field in various steady flow conditions including three categories of potential migration zones rest effort and limit zones migration routes were quantified in high detail in terms of the size and position of each zone and in terms of the distance from a given fluid part to the nearest rest zone the interdisciplinary approach of this study also led to the development of new tools for the dualsphysics model specifically suited to improve functionality in eco hydraulics research keywords fishway ramp river restoration smoothed particle hydrodynamics dualsphysics data availability data will be made available on request 1 introduction 1 1 background drawing from the ecological niche concept grinnell 1917 hutchinson 1957 dingle and alistair drake 2007 we recognize that each species is bound by its own set of limiting and optimum environmental conditions that define its behavior and survival although fish migration distances range from several hundred meters short distance migrants to thousands of kilometers long distance migrants aarestrup et al 2009 lucas et al 2001 all fish move up and down the river during their life to fulfill the essential life processes such as feeding shelter reproduction etc jungwirth 1998 northcote 1978 lucas et al 2001 radinger and wolter 2014 silva et al 2018 longitudinal connectivity is an essential function of rivers that not only enables the dispersal and migration of fauna e g fish migration macroinvertebrate dispersal etc but also allows sediment transport the key process in the creation of habitat diversity mikuś et al 2021 across the globe freshwater fish populations and biodiversity are in drastic decline it is known that hydro morphological alterations especially barriers are the most common pressure on surface waters in europe eea 2018 and cause tremendous harm to the natural functioning of our riverine ecosystems chamberlain 2020 european environment agency 2020 liermann et al 2012 silva et al 2018 wwf 2018 an indicator of which are fish populations deinet et al 2020 more than one million barriers fragment european rivers belletti et al 2020 of which more than 60 000 are impacting slovenian rivers pengal et al 2021 recent policies such as eu biodiversity strategy european commission 2020 the un decade on restoration unep and fao 2020 and the green deal european commission 2019 call for a complete shift in our treatment of aquatic ecosystems from management and governance to stewardship and restoration as a mitigation measure numerous fish passage solutions have been proposed ranging from technical fish passes pool passes vertical slot passes vsf denil passes eel ladders fish locks fish lifts to close to nature types bottom ramps and slopes bypass channels fish ramps fao and dvwk 2002 schmutz and mielach 2013 mader et al 1998 however recent findings suggest that common fishway design criteria do not adequately account for natural variation among individuals populations and species birnie gauvin et al 2019 silva et al 2018 engineered solutions often cannot reinstate the natural habitat and geomorphological properties of the river and these objectives have been largely ignored birnie gauvin et al 2019 therefore a shift from merely designing a hydraulic solution to providing a more ecological solution has been recognized as the most efficient approach eea european environment agency 2018 iucn 2020 raymond et al 2017 among others technical solutions to help fish migrate may include close to nature bottom ramps and by passes such actions need to be carefully designed to determine their impact on the current state this is where experience from experts in fish passage design implementation and monitoring is of great value one possible solution is also dam removal experts estimate that between 4000 and 5000 dams in total have already been removed in europe with records from france and sweden indicating 2300 and 1600 dams removed respectively gough et al 2018 however dam removal may also raise certain concerns e g water surface and groundwater levels erosion and sedimentation often leading to negative public opinion especially where existing infrastructure and land use present limitations that cannot be avoided where a complete restoration of a river reach is not possible e g a by pass cannot be constructed due to existing land use constraints or economic reasons partial removal of a dam or a weir combined with additional mitigation measures may present a viable compromise an example of such a compromise is the solution proposed in the present study where the existing weir could be partially lowered but not completely removed and a suitable ramp could be implemented upstream and downstream of the weir resembling the nearby natural stream channel recently the design of fish passes is increasingly based on 3d modelling e g fuentes pérez et al 2018 investigated turbulent flow in vertical slot fishways detailed quantification e g marti puig et al 2018 investigated animal scoring behavior in terms of trajectories and integrating different aspects of habitat suitability e g shim et al 2020 aimed to combine hydraulic and physiologic habitat suitability the present study aims at providing an application of such an approach including 3d modelling detailed quantification of velocity fields and migration routes and interdisciplinary cooperation focusing on a real life case of the radušnica stream in slovenia the main goal of the study was to use computational fluid dynamics cfd to design a fish friendly ramp that would provide nature like flow conditions similar to those in a natural reach of an existing stream as such the present study provides designers and decision makers with a fish passage optimization cfd tool that takes into consideration both functionality and harmonious integration into the landscape one of the advantages of cfd is that it allows the quantification of flow characteristics that are difficult to measure either in a laboratory or in the field as the present study involves a complex free surface flow over a very non uniform geometry we adopt the fully three dimensional 3d dualsphysics solver which is based on the smoothed particle hydrodynamics method sph introduced by monaghan and gingold 1983 validated and verified against numerous benchmark tests e g see spheric sph org and dual sphysics org the dualsphysics has been successfully applied to cases of turbulent free surface flow such as in a weir and pool fishway english et al 2022 vertical slot fishway novak et al 2019 and flow over a complex geometry bottom ramp novak et al 2021 in the present study new functionalities for eco hydraulics applications were developed new post processing tools were added to the dualsphysics as explained in section 2 3 the driving hypothesis of the study was that the dualsphysiscs software supported by the newly developed tools would allow a detailed design of a fish passage that takes into account the swimming capabilities of target species and flow characteristics in a geometrically and hydraulically complex environment the design process involved several steps of geometry optimization to quantify the proposed solution potential migration routes were analyzed in terms of various zones and distances to their locations data on the swimming performance of local fish and lamprey species were used to identify different zones within the resulting velocity fields migration zones were treated as complex 3d volumes the main novelties of this study include 1 the resulting velocity fields were analyzed in terms of potential migration routes represented by three different zones i e rest effort and limit zone 2 based on the velocity fields the distances to nearest rest zones were calculated as a way of quantifying fish friendliness to the proposed design 3 dualsphysics post processing tools were improved to increase the code functionality in eco hydraulics applications 2 methods this study builds on our previous work novak et al 2021 in which we first validated our numerical tools against the experiments by kupferschmidt and zhu 2017 and the numerical work by baki et al 2020 and then modeled a bottom ramp fish passage in the present study this model was applied to design a nature like fish ramp which is in essence a similar task in terms of model performance i e steady 3d water flow around and over obstacles of various shapes and sizes with a focus on horizontal velocity fields thus it is assumed the validation performed in our previous work is adequate for the present application the optimization was an iterative process starting from a very regular configuration and ending with a complex one that could be applied as a channel restoration measure for the actual site 2 1 study area the study area is a short section of radušnica a 5 km long stream flowing into the suhodolnica river in north eastern slovenia fig 1 a radušnica is an interesting case study because it is quite typical for the region but at the same time protected by natura 2000 status even more importantly local stakeholders have a positive attitude towards restoration plans indicating that the conclusions of the present study i e the proposed geometry of the ramp could be implemented at the target section there is a 1 3 m high concrete obsolete weir that spans the entire 4 m width of the stream and is followed by several wooden sill cascades fig 1b the weir blocks migration of freshwater organisms impacts sediment transport and deteriorates the visual appearance of the stream upstream of the weir the natural channel has a minimum slope while the average slope of the radušnica is 1 5 the steep drop of the weir and the steps created by the downstream sills could be mitigated for example by keeping the weir but constructing a bottom ramp immediately downstream of the weir keeping the radušnica s average slope of 1 5 the span of 1 3 m elevation difference would require a restoration of an 87 m section of the river channel which could be achieved through re meandering but would require extensive land purchases alternatively the connectivity could be achieved by decreasing the elevation of the obsolete weir and restoring two shorter river sections upstream and downstream of the weir in this study one such section of the river channel 15 m length is modeled as a typical case considered representative of the flow dynamics in the entire restoration section as described in novak et al 2021 no detailed hydrological data currently exists for the radušnica thus the input data for the model had to be estimated in contrast to our previous study where the inflow velocity was assigned as u 0 5 m s for all the cases the present study considers wider range of conditions with inflow velocity ranging from u 0 4 m s to u 0 7 m s inflow depths ranging from h 0 1 m to h 0 3 m and inflow discharges ranging from q 0 16 m3 s to q 0 84 m3 s as summarized in table 1 it was assumed that these cases correspond to typical discharges at the target location during different fish migration periods further work should include a more detailed field confirmation the case denoted with q1 represents dry conditions and its u and h correspond to data from the nearby suhadolnica river u 0 403 m s measured during low discharge the case denoted with q2 represents average conditions while the case denoted with q3 represents the highest flow during the fish migration period in its natural reach upstream of the weir the radušnica is a gently meandering 2 m wide channel with a pebbled bed and stones with diameters up to 0 25 m in the model these characteristics were taken into consideration during the geometry optimization and were modeled with various elements as explained in section 3 1 2 2 the target species three species of fish and one species of lamprey live in the target stream brown trout salmo truta european minnow phoxinus phoxinus european bullhead cottus gobio and the danubian brook lamprey eudontomyzon vladykovi a range of approaches are used for estimating fish swimming capacities e g sustained critical burst swimming speed etc defined in terms of speed and time sustained until fatigue table 2 the brown trout is the most efficient swimmer among the target species with critical and optimal swimming speeds estimated at 65 4 cm s and 31 6 cm s respectively tudorache et al 2008 bullhead anchor themselves with their pectoral fins at the bottom so the critical swimming speed is practically impossible to determine tudorache et al 2008 therefore only the maximum swimming speed was available from the literature experimentally estimated at 112 5 cm s tudorache et al 2008 because the ecological and biological requirements especially in terms of biomechanics of the other two target species have not been studied selected proxies from ecologically similar species are used in the analysis for the european minnow the mean critical swimming speed of spotfin shiner cyprinella spiloptera was used having a value of 60 8 cm s nichols et al 2018 the burst swimming speed of larval pacific lamprey lampetra tridentata ranges from 33 3 to 75 0 cm s sutphin and hueth 2010 so the lower value was used to estimate the swimming capacity of the danubian brook lamprey data on the swimming speed of each target species as well as their ecological requirements e g resting areas was taken into consideration during the optimization of the channel geometry and for the definition of migration routes as described in the results section it was assumed that if a suitable migration route is achieved for the weakest swimmer the species with higher capabilities would also find a suitable migration route thus the optimization was based on the swimming capacities of the weakest swimmer i e the danubian brook lamprey this means that the smallest parts of potential migration zones were defined as cylindrical volumes of water flow having the following characteristics radius rm 0 03 m length lm 0 15 m and velocity magnitude um 0 45 m s as explained in more detail in section 2 3 2 2 3 computational model the numerical simulations in this study were performed using the dualsphysics solver a 3d open source cfd model that is based on the sph method as described in domínguez et al 2022 dualsphysics is based on the weakly compressible formulation of sph and it can run on conventional cpus or cuda supported graphics processing units gpus the latter was employed in the present study and this allowed simulations with up to 8 million particles to be completed within reasonable computational times the main features of dualsphysics and the new features that were implemented in the present study are briefly reported below 2 3 1 dualsphysics a detailed description of the dualsphysics formulation can be found in domínguez et al 2022 therefore only the formulations used in this study are mentioned here modeling viscosity was achieved through an artificial diffusive term that is added to the momentum equation to reduce oscillations and stabilize the sph scheme monaghan and gingold 1983 due to its simplicity the artificial viscosity formulation is often used as a physical viscous dissipation term with an associated coefficient α based on scaled flume experiments the default value of this coefficient in dualsphysics is α 0 01 altomare et al 2015 and this value was used in the present study moreover the use of a density diffusion term in the sph method is necessary to reduce the density fluctuations associated with this method which can be aggravated in long term simulations the density diffusion term proposed by fourtakas et al 2019 with the coefficient value of 0 1 was used to perform the simulations in this study in dualsphysics solid boundary conditions e g for the riverbed and channel sides can be modeled in two ways dynamic boundary conditions dbc are represented by fixed particles with density computed from the continuity equation and pressure obtained from the equation of state crespo et al 2007 when using dbc an unphysical gap between the fluid and the solid boundaries appears lowering the accuracy of the pressure prediction at the boundaries this can be alleviated by a second approach called modified dynamic boundary conditions mdbc english et al 2022 with the density of boundary particles obtained from so called ghost nodes cleverly positioned within the fluid domain in all simulations of the present study the mdbc were employed in the present study new tools were added to dualsphysics to increase its functionality joined in a post processing tool called flowrest these new options allow the calculation of 3d resting zones or migration routes and their distance to the main flow as described in the following section 2 3 2 flowrest tool a resting zone or a migration zone was defined as a volume of fluid where the flow conditions were likely to be suitable for the resting or migration of the target species based on the biomechanic skills of each species thus a resting migration zone was defined as a 3d volume of fluid that simultaneously met the following two criteria 1 the fluid velocity within the zone is below a specified value related to the swimming speed of the target species i e u u m and 2 the size and shape of the volume is larger than a specified value related to the size of the target species i e radius r r m and length l l m in other words a pill shaped object like the one shown in fig 2 must fit inside a resting migration zone this way each zone can be identified computationally based on the simulation results i e location of fluid particles and their velocity fields within post processing several characteristics of the zones were quantified including their number location dimensions volume absolute and in percentage and mean velocity within the volume next a distance from any fluid point to the nearest rest zone was calculated and again quantified in terms of mean and maximum distance the main results of the flowrest tool are summarized at the end of section 3 2 3 3 numerical setup the model domain included an open rectangular channel with l 15 m length b 4 m width and h 1 m height the length of the domain was selected as a good compromise between computational cost and accuracy various elements were added to the channel to mimic the stream substrate randomly generated half spheres for pebbles suitably positioned spheres for stones and cylinders representing rocks in all the simulations the initial inter particle distance was set to dp 1 5 cm following the procedure described in tafuni et al 2018 the constant slope of the channel was simulated via a horizontal channel subjected to an inclined gravity acceleration for example i 1 5 slope was modeled as a horizontal channel with g g x g y g z 0 147 0 9 809 m2 s steady flows at the inlet and outlet sections were imposed with constant fluid depths h and uniform fluid velocities u auxiliary upstream and downstream reaches of the channel each 1 m long and located next to the inlet and outlet respectively were kept smooth and without any obstacles with the initial fluid depth and velocity set to desired values the main simulations covered 30 seconds of physical time so that steady conditions were accomplished the convergence of the flow can be analyzed in terms of the discharge calculated volumetrically from the fluid particles i e as a volume of fluid divided by time for the q3 discharge q 0 84 m3 s flowing over the proposed geometry the convergence was confirmed with the following result fig 3 a horizontal line showing q 0 84 m3 s is added for easier visualization note that the first 5 seconds of the simulation are not shown and that it takes some time for the initial condition to evolve according to the ramp characteristics fig 3 shows that convergence occurred after 20 seconds as mentioned our simulations of the proposed configuration extended over that period 3 results 3 1 geometry optimization the proposed design of the presented nature like channel was obtained as the result of several optimization stages going from a simple uniform geometry to a complex one the main optimization criteria were velocity fields especially near the bed and in the mid depth region these stages investigated the effect of the following parameters 1 channel slope 2 bed roughness 3 curvature of the mean flow 4 position and size of larger obstacles 5 position and size of smaller obstacles against the swimming capacities of the target fish and lamprey the main steps are summarized in table 3 each stage represents an intermediate step toward the final solution and is thus described only briefly while the final geometry is described in more detail the process was completed iteratively considering the comments by engineers and biologists in our team the best configuration from the first stage was fixed in the second then the best option from the first two stages was fixed in the third and so on all optimization stages were performed using input data u and h for the q2 case which represented the average discharge 3 1 1 bed slope stage 1 investigated the slope i of a smooth channel and confirmed i should be kept as low as possible with the inlet imposed the same way as the outlet uin uout hin hout a hydraulic jump occurred in cases with a steeper slope maximum velocities occurred upstream of the hydraulic jump ranging from 2 0 to 4 5 m s for i 1 5 to i 7 5 respectively 3 1 2 bed roughness elements stage 2 employed i 1 5 slope in all the cases and showed that the bed roughness elements decreased the near bed velocities and slightly increased the fluid depth without affecting other overall characteristics of the flow model roughness represented by semi spheres rr 0 03 m was selected as the best approximation of the bed along the natural part of the radušnica the bed roughness elements were generated along the width b and from x 1 m to x 14 m and were randomly placed to obtain a more natural non uniform distribution an example is shown in fig 4 model variants ranged from a case of a smooth bed i e zero bed roughness elements to a case with 5200 semi spheres i e an average of 400 elements per meter length based on the resulting velocity fields for the z 0 05 m plane parallel to the bed a configuration with 3900 elements i e 300 elements per meter length was selected 3 1 3 mean flow curvature in stage 3 the i 1 5 channel with a total of 3900 bed roughness elements was equipped with transverse sets of five equal cylinders with rc 0 2 m hc 0 3 m uniformly distributed at a longitudinal distance δxc apart their purpose was to replicate the meandering of natural streams somewhat resembling technical types of fishways and diversification of flows based on the resulting velocity fields the geometry with δxc 3 5 to 4 m was selected as the best option fig 5 note that in fig 5 the velocities at the downstream line of obstacles locally reach above 2 m s even at q2 and even close to the bed the figure shows a flow that is steady i e not changing with time and non uniform i e changing with location even in equally wide sections of unobstructed flow the velocity fields change with location 3 1 4 size and position of larger obstacles in stage 4 larger obstacles were placed transversely but included cylinders of various heights and radii the following variants were tested a rc 0 2 m hc 0 3 m horizontal high crest b rc 0 2 m hc 0 15 m horizontal low crest c rc 0 2 m hc 0 15 to 0 35 m stepped crest hc decreasing towards the channel axis d rc 0 2 m hc 0 15 to 0 35 m distributed non uniformly variant 1 e rc 0 2 m hc 0 15 to 0 35 m distributed non uniformly variant 2 based on the resulting velocity fields the last variant was selected 3 1 5 size and position of smaller obstacles in stage 5 sets of larger obstacles were changed so that each set included more cylinders with their size and position varying even more than in stage 4 additionally smaller obstacles i e spheres were added within the main flow region the cylinders and spheres were added in several steps iteratively providing a greater variety of velocity fields while simultaneously decreasing the maximum velocities to establish suitable conditions for all target species the optimization resulted in the final geometry of a nature like channel shown in fig 6 fig 6 shows bed roughness elements a total of 3900 semi spheres with rr 0 03 m distributed along the 13 m reach three sets of eight larger obstacles cylinders with rc 0 2 to 0 3 m and hc 0 2 to 0 45 m and twenty five smaller obstacles spheres with radius r s 0 15 m this geometry was later used with q1 and q3 flow conditions as those two cases were estimated as being the most potentially problematic in terms of low depth q1 and high velocities q3 thus the main results presented next focus only on q1 and q3 conditions 3 1 6 statistical comparison of optimization stages typical cases of optimization stages are compared in terms of statistics given in table 4 in table 4 the notion of slow fluid means the volume of fluid where u 0 5 m s while a rest zone is defined as having a mean u 0 45 m s which corresponds to the effort migration zone discussed in section 3 4 interestingly the variant representing stage 3 seems to be the best according to the selected statistics however the apparent superiority of the stage 3 configurations is misleading flow in all of the stage 3 variants is a uniformly meandering stream with high velocities in the narrow sections and low velocities behind obstacles this can lead to a favorable average but such a geometry is inferior to the one proposed in the present study because the latter allows various paths of migration in our previous work novak et al 2021 a tool for the calculation of the ratio between the flow area and flow velocity was introduced applied to each cross section of the model this tool gives a clearer view of flow characteristics than most common statistics a comparison of a typical uniformly meandering stream stage 3 and the proposed configuration is presented in fig 7 fig 7a shows distinctive dents at locations of narrow sections at these locations the flow depths are lower and the velocities are higher making these parts more difficult for a fish to pass in contrast fig 7b shows a much more gradually varying flow with a slightly smaller portion of very low velocities but also with a distinctly smaller portion of high velocities making such fish pass more efficient 3 2 flow depth the first critical parameter defining suitable fish migration routes is the flow depth baudoin et al 2015 the results for the q1 dry conditions and the q3 larger discharge cases are shown in fig 8 a and 8b respectively note that fig 8 shows the fluid depth above the solid boundary bed roughness element smaller or larger obstacle not the water surface elevation the proposed geometry provides a depth of about 0 1 m in dry conditions fig 8a and a relatively uniform depth of about 0 3 m during the larger discharge fig 8b 3 3 velocity fields velocity was the second critical parameter that was analyzed and used to define the potential routes for fish migration in the presented model all three velocity components longitudinal u transverse v vertical w were calculated for each location x y z of the domain and for each output step outputs for every 0 05 s of the simulation were selected it was decided to focus on velocity fields at the end of the simulation given as vector fields in planes located at a constant z above the channel bed such slices of complex 3d fields are presented in fig 9 including near bed velocities z 0 05 m plane and mid depth velocities z 0 15 m plane fig 9a shows that in dry conditions case q1 velocities remain mostly below 0 5 m s with numerous areas of very low velocities 0 2 m s fig 9b shows how near bed velocities increase with discharge velocities of up to 1 5 m s occur in separate jets within the downstream set of rocks but these conditions are localized figure 9c confirms that mid depth velocities are greater than the near bed ones local maximum values reach 2 m s but there are areas of low velocities 0 4 m s nearby 3 4 migration routes since fish migration is essentially limited by the swimming capacities of each species we define migration routes as the paths in which flow conditions correspond to the swimming capacities of the fish and as such theoretically allow fish to move along the river such routes consist of migration zones as defined in section 2 3 a migration zone can be regarded as a volume of fluid with a certain velocity radius and length in our case the following values were selected radius of at least rm 0 03 m length of at least lm 0 15 m and velocity thresholds ranging from um 0 34 m s to 0 45 m s to 0 52 m s these velocities can be used to define different types of zones as listed in table 5 all three zone types combined represent a migration route the listed values correspond to experimental results for optimal sustained and critical burst swimming speeds for target fish these zones are 3d volumes that form complex shapes not just layers limited to the water surface migration zones for q1 and q3 cases are given in figs 10 and 11 respectively figs 10 and 11 show that lower velocity volumes are located behind various obstacles and that the extent of limit zones is expectedly larger than the extent of the rest zones in the q1 case migration routes are almost continuous while in the q3 case they are smaller and more fragmented besides the size and position the present study introduces also the calculation of the distance between the migration zones applying the proposed geometry they are readily reachable from practically any location as confirmed in fig 12 which shows a map of the distances from fluid points to the nearest migration zone selected here for the comparison are effort zones with um 0 45 in fig 12 the main flow region lighter and the low velocity regions darker can be distinguished note that larger distances appear only close to inlet and outlet sections which are on the edge of the designed channel reach within the reach with obstacles the distances to the nearest migration zones are below 0 5 m and 1 5 m in the q1 and q3 cases respectively some main statistical characteristics of the migration zones are summarized in table 6 table 6 shows that during low discharge the percentage of migration routes is larger due to the lower flow velocities also the volumes of zones increase if we allow a larger velocity threshold 4 discussion based on flow depth results fig 8 the proposed geometry provides sufficiently deep flow even in dry conditions important advantages of the proposed geometry are its bed roughness elements and obstacles model stones and rocks of various heights which allow water to flow around or over them providing target species with a variety of flow depths along their migrating corridors in contrast to more technical fish passes e g vsf where the flow depth is typically mostly constant within a pool also the proposed geometry is without unconnected crevices that can become ecological traps as pointed out by plesiński et al 2018 although it was not an object of the present study a favorable tailwater effect could occur at the downstream end of the study site increasing the downstream depth and decreasing the velocities thus contributing to more suitable depths and velocity fields along the whole observed section based on resulting velocity fields fig 9 the proposed geometry provides suitable conditions for all target species the weakest swimmers can find their way upstream staying close to the bottom while better swimmers can overcome even the localized areas of larger velocities the fact that velocity fields parallel to the bed change with their distance from the bed is an important advantage in comparison to more technical fish passes where flow fields are much more uniform e g in a vsf they are depth averaged and flow patterns remain practically the same in all pools diverse velocity fields are also favorable in terms of whirls as pointed out by puzdrowska and heese 2019 the size of vortices depends on the size of the flow e g distances between the obstacles thus the proposed geometry does not allow the formation of potentially problematic larger whirls at the same time the configuration is not too uniformly fragmented thus avoiding the disadvantages of the technical solutions such as baffled chutes bylak et al 2017 based on calculated migration routes resting areas and their mutual distance figs 10 11 12 the proposed geometry provides the fish with ample resting space to recover their strength after periods of burst and or critical swimming sessions the velocity fields and migration zones show localized regions of higher flow velocities and thus fragmented migration routes during higher discharge indicating that the weaker swimmers might not be able to migrate in these conditions however the distances between migration zones fig 12 are small enough for the stronger swimmers to easily cross areas of faster flow as they can maintain various levels of swimming effort for long enough comparing these results against the swimming capacities of target species it is clear that all species except the lamprey should be able to migrate even during the high discharge period however most fish species do not migrate during high discharge periods and such periods occur rarely and have limited duration so they should not be taken as a reference but rather as the limit conditions the present study could be upgraded with simulations of movable bed elements to investigate how the ramp and its flow characteristics would change due to sediment transport such simulations would be a valuable contribution to evaluations of restoration projects e g like the one described in mikuś et al 2021 5 conclusions several stages of fish ramp geometry optimization were performed including variants of channel slope bed roughness and sizes and positions of flow diverting obstacles adjusting the geometry to the characteristics of the actual site led to a near natural ramp configuration that provides flow conditions diverse enough to allow different fish species to find their preferred migration route the flow conditions were presented in terms of velocity fields at selected planes parallel to the channel bed based on the fish swimming performance criteria suitable migration routes were identified these routes form complex 3d structures made of numerous volumes of slower fluid and give important insights into a future design of similar eco hydraulics applications these representations also indicate how fish might perceive the river identifying areas of favorable and unfavorable spaces to navigate the rivers the presented analysis of flow over a complex geometry confirms that the design of a nature like fish pass configuration can be optimized using a fully 3d numerical model based on the sph method the resulting flow can be analyzed in great detail allowing calculations of fluid depths velocity fields flow area flow velocity ratio migration zones and their mutual distances this means the decision makers can now get better insight into the flow features that were previously difficult to quantify leading to more efficient designs of fish passages in terms of software development improvements to the validated and verified dualsphysics model were implemented to achieve the objectives of the present study a new tool named flowrest was devised to allow a detailed quantification of migration zones future work will focus on importing additional non uniformly shaped 3d objects into the model to mimic natural stones and rocks the riverbed slope will be diversified to accommodate the natural riffle pool sequence characteristics furthermore an improved tool for the quantification of trajectories focused on whirls will be applied enabling complex fishway flows to be analyzed in even more detail finally with the employment of a multi phase combination of water and sediment the simulations will produce even more realistic results allowing investigations of sediment transport in stream restoration solutions credit authorship contribution statement gorazd novak conceptualization formal analysis investigation data curation writing original draft polona pengal conceptualization investigation writing original draft ana t silva conceptualization writing original draft josé m domínguez data curation methodology software visualization writing review editing angelo tafuni methodology software visualization writing review editing matjaž četina funding acquisition supervision writing review editing dušan žagar funding acquisition supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was partially funded by the slovenian research agency arrs as part of the research programme p2 0180 water science and technology and geotechnical engineering tools and methods for process analyses and simulations and development of technologies this work was partially supported by the project surviwec pid2020 113245rb i00 financed by mcin aei 10 13039 501100011033 and by the project ed431c 2021 44 programa de consolidación e estructuración de unidades de investigación competitivas financed by xunta de galicia consellería de cultura educación e universidade this study forms part of the marine science programme thinkinazul supported by ministerio de ciencia e innovación and xunta de galicia with funding from european union nextgenerationeu prtr c17 i1 and european maritime and fisheries fund 
24294,dioecy characterized by the presence of distinct male and female individuals in the breeding population has evolved independently numerous times suggesting that a simple common mechanism may prevail behind the evolution of dioecy from hermaphroditism in the present study a floral sex allocation model is demonstrated for the presence of a hermaphroditism dioecy continuum in higher plants using an n player game model in the continuum we pay attention to the emergence of gynodioecy in which both hermaphroditic and female individuals coexist in the breeding population and trioecy which includes hermaphroditic male and female individuals in the breeding population as these have often been considered as an intermediate step in the evolution of dioecy from hermaphroditism and vice versa in the n player game model we assumed a local breeding population containing n players with different reproductive investment and there is a trade off between the reproductive investment to male function and female function at individual level furthermore we focused on the uncertainty of pollen transportation as dioecy is often linked to both the unreliable pollen vectors and harsh environment for pollinators the pollen transport efficiency was explained by the probability of the pollen hitting ovules or stigmata in the model setting hypothetical populations with different population sizes we showed the nash solutions for dioecy appeared at a smaller pollen transport efficiency than for hermaphroditism in all hypothetical populations since the low pollen transport efficiency equals the low reliability of pollen vectors the result is comparable with the pollinators of real dioecy such as water wind and opportunistic species the nash solution for gynodioecy and trioecy was obtained at the transition zone between dioecy and hermaphroditism in the continuum the number of male and female individuals in dioecy were almost stable in the range of low pollen transport efficiency if the number of males decreased with increasing pollen transport efficiency hermaphroditic individuals emerged in the population establishment of trioecy gynodioecy established as soon as no males were left in the population finally hermaphroditism established at the time no females were left in the population these results imply that pollen transport efficiency played an important role of obtaining a variety of nash solutions in the model though the darwinian paradigm in evolutionary ecology of dioecy is based on the various aspects of the interaction between environment and species specific characters our model is composed of numerical interactions between and within individuals in this paper we argue that the association between the continuum and the pollen transport efficiency is reflected in the real world keywords floral sex allocation n player game model pollen transport efficiency competitive sharing nash solution data availability no data was used for the research described in the article introduction since darwin 1877 floral sex allocation in plant species has inspired biologists and botanists to study the ecological and evolutionary factors that favor dioecy over hermaphroditism fig 1 dioecy is marked by the presence of distinct male and female plants and is a rare breeding system in flowering plants renner and ricklefs 1995 phylogenetic analyses on the systematic distribution of dioecy have indicated that this trait has evolved independently numerous times in a variety of taxa renner 2014 volz and renner 2008 weiblen et al 2000 bawa 1980 1982 and baker and cox 1984 demonstrated foresight in noting the association of dioecy with abiotic pollen vectors perenniality tropical regions and oceanic islands unfavorable or harsh environments such as drought barrett 1992 costich 1995 also see scobell and schultz 2005 and high altitude delph 1990 humeau et al 1999 renner and won 2001 are associated with the dominance of dioecy over hermaphroditism bawa 1980 and other researchers as mentioned above have considered that the evolution of dioecy from hermaphroditism is caused by the various interactions between the environment and species specific characters however the authors do not model the association between the environment and species specific characters mechanistically recently the transition between dioecy and other sex expression was evaluated from the standpoint of genetic engineering henry et al 2018 we consider that the genomic approaches can answer how dioecy is expressed i e the proximate cause but cannot answer why the dioecy is associated with tropical regions oceanic islands perenniality and unfavorable harsh environments i e the ultimate cause on the other hand heilbuth 2000 pointed out that dioecy is an unsuccessful mating system because dioecious flora comprise only 6 of the world s angiosperms despite the many possible advantages such as avoidance of inbreeding depression heilbuth 2000 considered that dioecy is an evolutionary dead end and westergaard 1958 considered it to be a failure for plants but some researchers recently challenged the evolutionary dead end hypothesis käfer et al 2014 2017 muyle et al 2021 käfer et al 2017 reported that dioecy is evolutionarily labile and reversion from dioecy to other sexual systems is frequent for example cossard et al 2021 and dorken and pannell 2009 removed the males from the dioecious population and demonstrated the rapid evolution of hermaphroditism here we must pay attention to the hydrophilous plant species the fact that predominance of dioecy is in hydrophilous plant species cox 1988 would be evidence against the evolutionary dead end hypothesis it would mean that many hydrophilous plant species are endangered if the hypothesis is correct actually muyle et al 2021 showed no genetic evidence for extinction risk in dioecy barrett and crowson 2016 focused on selfing to consider the mating system transition in flowering plants conventional theoretical models assume the mechanism that the dioecious condition compensates for the lack of fitness of another sex i e that unisexual individuals have to gain at least twice the fitness as hermaprodites cf charlesworth and charlesworth 1978 in the case of no inbreeding depression a selective force that compensates for the disadvantage is thought to be inbreeding depression in hermaphroditism barrett and crowson 2016 charlesworth 1993 charlesworth and charlesworth 1978 dorken et al 2002 lloyd 1984 because inbreeding depression decreases offspring fitness inbreeding depression is considered to be a key factor in the maintenance of separate sexes in plants through selection for the avoidance of selfing barrett and crowson 2016 barrett 2015 dorken et al 2002 eppley and pannell 2009 however hermaphroditism especially in monoecy often avoid selfing via dichogamy i e the temporal separation of male and female function in flowering plants bertin 1993 also see friedman and barrett 2009a because many dichogamous species are self incompatible routley et al 2004 we can hypothesize that the effect of inbreeding depression is not a main driver of the evolution of dioecy thus a different approach is necessary to consider the cause of evolution of dioecy scobell and schultz 2005 provided an important clue to consider the transition between hermaphroditism and dioecy that is dioecious populations of echinocereus coccineus cactaceae tended to be found in areas with low hummingbird abundance their result implies that pollination is one of the key factors to explain the transition between hermaphroditism and dioecy pollen transport between plants is ultimately analogous to the delivery of an object between a sender and recipient and this condition can be explained as a probabilistic system if so the hermaphroditism dioecy continuum can be described by a mathematical model based on the stochastic process we focus on the uncertainty of pollen transportation as one of the ultimate factors governing plant fitness this is because pollen transport between plants is ultimately analogous to a delivery system optimal delivery depends on the transport efficiency between sender and recipient so allocation between senders male flowers and recipients female flowers will be adjusted depending on the transport efficiency of the object pollen from the view point of the uncertainty of pollen transportation it is no wonder that dioecy is more predominant in hydrophilous plant species than in terrestrial plants i e 55 of all hydrophilous genera and 75 of marine hydrophilous genera are dioecious cox 1988 whereas this is 6 in terrestrial plants renner and ricklefs 1995 water and air are fluid media and will be inefficient pollen vectors compared with animals ackerman 2000 among the abiotic pollinators water is the most unreliable pollen vector and may result in pollen dilution cf van tussenbroek et al 2010 2016 and a very small breeding area within the order of meters ackerman 2002 zipperle et al 2011 in addition abiotic stresses e g drought and high altitude may result in reduced activity of animal pollinators e g culley et al 2002 uno 1982 also see scobell and schultz 2005 as stated above we consider that uncertainty in pollination is more prevalent in dioecy thus the unreliability of pollen vectors will play a vital role in the emergence of dioecy the aim of this study was to examine the evolutionary transition between hermaphroditism and dioecy from the stand point of pollen transport efficiency in a mathematical model if dioecy solutions appeared in our model the theoretical condition can be compared with the ecological characteristics of dioecy in the real world here we also focused on the existence of gynodioecy i e co occurrence of female individuals with hermaphroditic individuals within the same species fig 1 because gynodioecy has often been considered as an intermediate step in the evolution of dioecy from hermaphroditism and vice versa barrett and crowson 2016 dorken and barrett 2004 dufay et al 2014 käfer et al 2017 spigler and ashman 2012 if our model could explain the hermaphroditism dioecy continuum a gynodioecy solution should also be derived by our model we used a n player game model developed by masaka and takada 2006 the unreliability of pollination i e pollen transport efficiency was incorporated into the model this may have the potential to explain the emergence of dioecy under conditions of low pollen transport efficiency in our previous study masaka and takada 2006 we focused on the floral sex allocation in monoecy only but the model can be versatile to apply the other sex expressions the model assumed that n individuals in a breeding population have different reproductive resources a numerical calculation was performed to obtain the game solution and the result revealed that dioecy tended to emerge under conditions of lower pollination efficiency compared to hermaphroditism we finally discuss the superiority of dioecy over hermaphroditism under low pollen transport efficiency then we discuss how the low pollen transport efficiency can be induced in various habitats model according to masaka and takada 2006 the floral sex ratio allocation strategy in wind pollinated monoecious species is well explained by an n player game model which assumes the presence of players with different reproductive resources among individuals along with a limited population size we do not consider the heritability of resources to invest in reproduction but the sex ratio depending on the amount of the resources it is generally called conditional strategy which is a theoretical concept on strategy that expresses different behavior or life history when the fitness depends on the status of the individual or environmental conditions cf charnov 1976 for the optimal foraging model and hamilton 1967 for the sex ratio model the n player game model on sex ratio was used also in yamaguchi 1985 to explain the dependence of sex ratio on the amount of parental investment in an aphid prociphilus oriens because the parents of the aphid differed in their reproductive investment yamaguchi 1985 when there is variation in parent reproductive investment within the breeding population the n player game model is more adequate than the evolutionary stable strategy ess models proposed by hamilton and other researchers hamilton 1967 lloyd 1984 the reason is in ess models all individuals are assumed to be uniform and adopt a single strategy since dioecy implies that individuals in the population adopt at least two different strategies the n player game model is needed to construct a mathematical model for the hermaphroditism dioecy continuum the model described here includes two key assumptions first the breeding population is founded by n individuals that potentially differ in their reproductive investment ii i 1 2 n reproductive investment means total allocation of resources to reproductive functions second the number of pollen grains reaching a given stigma is described by a poisson distribution feller 1968 smith et al 1990 although we did not take the effect of spatial constraints into consideration in the pollen transport we assume that spatial constraints are incorporated implicitly in our model through variation in transport efficiency with lower transport efficiency reflecting systems in which pollen transport is lower due to spatial effects e g distance besides we did not take the cost of development of seeds and fruits into consideration in the female cost because we focus on the pollen transport efficiency in this model as for the first assumption we can set i 1 i 2 in 1 in without loss of generality masaka 2007 individuals invest xi in male flowers and yi ii xi in female flowers and the fitness of the i th individual wi is given by the sum of the female fi and male mi components of reproductive success wi fi mi following the assumption of hamilton 1967 lloyd 1984 and yamaguchi 1985 the female reproductive success of i th individual fi is equal to yi 1 f i y i i i x i to simplify the number of pollen grains is assumed to be enough to fertilize all the female flowers and there is no loss in the investment for female function male reproductive success mi is a function of investment in male flowers xi from the second assumption the probability that no pollen of the i th individual reaches a given individual s stigma is the first term of the poisson distribution as e α i α i is the mean number of pollen grains from i th individual and is expected to increase with the amount of male investment fig 2 thus we assume the mean number is proportional to xi i e α i β x i where β represents the index of pollen transport efficiency that is identical irrespective of individual masaka and takada 2006 cf cox 1988 smith et al 1990 therefore the probability of reaching stigma is 1 e β x i and x i 1 e β x i grains from i th individual on average reach the stigma s fig 2 the shape of 1 e β x i with respect to xi shows the saturation curve fig 3a and that of x i 1 e β x i deviates from the asymptote in the small range of xi fig 3b if the individual has low resources for the male flowers i e x i is small the probability of reaching stigmas is much smaller than 1 and the difference between the solid line and the dashed line in fig 3b is large which means that a large proportion of pollen grains cannot reach the stigma s and most of the investment to male flowers is wasted however only one pollen grain fertilizes an ovule even if numerous grains reach the stigma therefore there must be a competition on the stigma among the grains from all the individuals competitive sharing among males referred by lloyd 1984 and their sum is x j 1 e β x j the sum through male investment competitively shares the total investment in female i 1 n y i i 1 n i i x i within the breeding population i e a fair lottery proportionally to male contribution from each individual therefore the reproductive success of i th individual through male investment male reproductive success mi is written as 2 m i x i 1 e β x i j 1 n x j 1 e β x j j 1 n y j it represents the proportion of male i s pollen multiplied by total available females the fitness gain curve of the i th individual is the sum of female and male reproductive successes of i th individual from eqs 1 and 2 3 w i x 1 x 2 x n f i m i i i x i x i 1 e β x i x j 1 e β x j j 1 n i j x j where the first term on the right hand side of eq 3 designates fitness through female investment assuming all females are fertilized hamilton 1967 yamaguchi 1985 we don t formulate the reproductive success of grandchildren generation as formulated in fisher s model fisher 1930 the reason is that parents of plants i e players in this game are capable of having both sexes in their reproductive organ and thus that the reproductive success caused by sex ratio is reflected in their offspring generation analysis the shape of fitness gain curve here we analyze the shape of the i th fitness gain curve the fitness gain curve starts from w i x i 0 i i and decreases from the coordinate 0 ii in fig 4 a and 4d because the first derivative of eq 3 is 4 w i x i 1 x i 1 e β x i x j 1 e β x j j 1 n i j x j e 1 e β x i β x i e β x i x j 1 e β x j 2 and w i x i 1 when xi 0 where e j i x j 1 e β x j 0 see the detail in appendix a because w i x i 1 when xi 0 the fitness gain curve decreases when x i is zero irrespective of the investment by other individuals the 1 term is derived from the property of female reproductive success fi i e i i x i therefore the female reproductive success in an individual decreases as the male investment x i increases even if every other individual in the population is female in contrast the male reproductive success mi depends on the investment of other individuals and increases much with x i when every other individual is female see appendix a the second derivative is 2 w i x i 2 2 β j 1 n i j x j e 0 when xi 0 therefore wi xi increases around xi 0 from a mathematical analysis in appendix b we show that there are two cases on the shape of the wi variables presented in this study are listed in table 1 in the first case depicted in fig 4a there is no intersection of the fitness curve and w i i i except xi 0 fig 4a and fig ba in appendix b it biologically implies that maximum fitness is realized when the i th individual does not invest into male function thus being female is the best strategy in the second case depicted in fig 4d there are two intersections xi and xi xi xi of the fitness curve and w i i i except xi 0 fig 4d and fig bb in appendix b the wi curve has a local minimum between xi 0 and xi xi and a local maximum between xi xi and xi xi fig 4d because the fitness gain curve has at most two extremums see appendix c they were named xi min and xi max as shown in fig 4d the i th individual obtains the maximum fitness depending on the amount of reproductive resources i i if i i ranges from xi 0 and xi it obtains the maximum when the individual does not invest for male function i e female individual if i i exceeds xi max then it obtains the maximum fitness between x i 0 and i i which means investing both male and female function is the best i e hermaphroditic strategy xi can be written simply as 1 β l n 1 s 1 t s using s σxj σij and t x j 1 e β x j i j s represents the male investment ratio in the population and condition xi 0 implies that the male investment ratio s is less than 1 2 see appendix d reproductive resource in male flowers will reduce the fitness of the i th individual as shown in fig 4a the optimal investment in male flowers xi and the optimal male ratio ri xi ii of the i th individual in a population are 5 x i 0 and r i 0 if i i 0 where the asterisk represents optimal investment that maximizes wi fig 4b and 4c therefore the individual benefits by investing all reproductive resources in female flowers female phase i e yi ii note that the other female costs such as development of seeds and fruits are not included in the female cost in the model because we focus on the pollen transport efficiency in the second pattern investing reproductive resources in male flowers will reduce the fitness of the i th individual in the range 0 ii xi because the fitness gain curve is under the line wi ii in the range fig 4d therefore in this range the individual benefits by investing all reproductive resources in female flowers female phase i e yi ii and xi 0 the optimal investment in female flowers yi increases linearly as ii increases then the optimal male ratio is kept as zero fig 4e and 4f the constant xi is a switching point from the female phase to the male phase fig 4d and 4e if the i th individual has reproductive resources higher than xi i e xi ii xi max then all of the reproductive resources are invested in male flowers male phase i e yi 0 and xi ii because investing in a female flower contributes to reduction of the fitness rather than gain however if the i th individual has reproductive resources greater than xi max the individual benefits by investing xi max in male flowers and invest the remaining reproductive resource in female flowers hermaphroditic phase i e yi ii xi max and xi xi max because investing the remaining reproductive resource in male flowers would reduce the fitness of the individual fig 4e it biologically means that individuals with sufficient reproductive resources produce only hermaphroditic flowers with a certain proportion of male investment depending on i i and xi max in summary the optimal investment in male flowers xi and the optimal male ratio ri xi ii of the i th individual in a population are written as 6a x i 0 and r i 0 if 0 i i x i 6b x i i i and r i 1 if x i i i x i max 6c x i x i max and r i x i max i i if i i x i max female phase male phase and hermaphroditic phase appear sequentially along the gradient of the total investment of the i th individual ii nash solution and plant sex expression based on the analysis on the shape of the fitness gain curve we can obtain nash solution in our n player game model the optimal investment corresponds to a nash solution defined by the following inequality 7 w i x 1 x i x n w i x 1 x i x n for x i x i in all i note that the left and right sides of the inequality are slightly different x i versus x i on the left and right sides respectively the solution is called the interior nash equilibrium if xi satisfies wi xi 0 2 wi xi 2 0 and the condition in eq 6c holds for any i otherwise it is called the edge nash equilibrium for a given set of x 1 x 2 x i 1 x i 1 x n we can obtain the nash solution of the i th individual by examining the shape of the i th fitness gain curve and discuss the sex expression of plants here we focus on the nash solution that corresponds to the sex expression observed in real plants though there could exist many other types of nash solution in this game model first if ii xi max for all i only the hermaphroditic phase emerges i e hermaphrodite cf masaka and takada 2006 then xi xi max and ri xi max ii for all i the solution x 1 x 2 xn is an interior nash solution because wi xi 0 at xi for any i second if 0 ii xi for i 1 k and xi ii xi max for i k 1 n both female and male phases will emerge in the population i e dioecy investment in male phase is larger than female phase it is quite general among dioecious plant species that male individuals invest more in reproduction than females at flowering nicotra 1999 otero arnaiz and oyama 2001 rocheleau and houle 2001 torimaru and tomaru 2006 therefore the solution is consistent with observed patterns of dioecy then the optimal investment in male flowers xi and the optimal male ratio ri of the i th individual in the dioecious population is written as 8a x i 0 and r i 0 if 0 i i x i 8b x i i i and r i 1 if i i x i the solution x 1 x 2 xn is an edge nash solution because wi xi 0 at xi for any i third if 0 ii xi for i 1 k xi ii xi max for i k 1 k l and xi max ii for i k l 1 n three phases female male and hermaphrodite can emerge in the population figs 4e and 4f in masaka and takada 2006 this was named a monoecious population which was composed of hermaphroditic individuals only since a few female and male individuals sometimes coexisted in real populations therefore here we name it trioecy in a broad sense see fig 2 in juglans ailanthifolia juglandaceae and betula platyphylla var japonica betulaceae for example individual sex expression changes in order of female male and hermaphrodite with increasing reproductive resource see table 1 in masaka and takada 2006 masaka 2007 this order corresponds to the order observed in the solution fig 4f fourth if ii xi for i 1 k and xi max ii for i k 1 n are satisfied simultaneously k females and n k hermaphrodites will emerge in the population i e gynodioecy the optimal investment in male flowers and the optimal male ratios in the female and hermaphroditic phases of a gynodioecious population are written as 9a x i 0 and r i 0 if 0 i i x i i 1 2 k 9b x i x i max and r i x i max i i if i i x i max i k 1 n note that we assume i 1 i 2 in 1 in results of numerical calculation the type of sex expression that is the optimal solution depends on both the distribution of the reproductive investment ii and pollen transportation efficiency β the distribution of ii is influenced by the population size numerical analyses were conducted for various populations with different population structures four hypothetical populations were set up based on different population sizes n 11 21 41 and 81 ii 1 ii 280 for n 11 ii 1 ii 140 for n 21 ii 1 ii 70 for n 41 and ii 1 ii 35 for n 81 we set i 1 1600 in the four populations and they had the same average ii i i 3000 for a given β numerical calculations were conducted to obtain four types of nash solutions each corresponding to hermaphroditism dioecy trioecy or gynodioecy several mathematical conditions are used for each type of nash solution see appendix e when obtaining the hermaphroditic nash solution there are n hermaphroditic individuals in the population and the solution is x 1 x 2 xn x 1 max x 2 max xn max we obtained xi max using eq e1 and examined whether or not conditions e2 to e4 are satisfied if these conditions are not satisfied the cases were removed from the nash solution candidates when obtaining the dioecious nash solution we assume there are k females and l males in the population and the solution is that xi 0 for i 1 to k and xi ii for i k 1 to k l n there are n 1 dioecy solutions varying from k 1 to n 1 for each solution we obtained xi using eqs e7 and e8 in appendix e and examined whether or not conditions e9 and e10 are satisfied we removed the cases from the nash solution candidates if these conditions are not satisfied more than one solution could be found for each β similarly we obtained nash solutions for trioecy and gynodioecy see appendix e mathematica ver 10 wolfram research inc champaign il was used for the calculations from the above procedure used to obtain the nash solutions we identified two quantities that determine the optimal sex expression the switching point from the female phase to the male phase xi and the maximal point of fitness gain function xi max more than one xi and xi max were obtained for a given β because more than one nash solution was often found by the numerical analyses see fig e in appendix e multiple nash solutions are discussed in the discussion the numbers of male female and hermaphroditic individuals with respect to the β are shown in fig 5 for a variety of population sizes n 11 21 41 and 81 the nash solutions for dioecy appeared at a smaller β range than for hermaphroditism in all hypothetical populations appearance of male female and hermaphroditic individuals presented a unique trend along the β gradient in the sequence of nash solutions with respect to β the number of males in dioecy connected to that in trioecy trioecy was established by adding hermaphroditic individuals to dioecious population along with an increase of β males rather than females were likely to contribute to the establishment of hermaphroditic individuals see fig 5a the number of males in trioecious populations decreased with increasing β fig 5 consequently trioecy was replaced by gynodioecy conversely trioecy is established by adding males to gynodioecious population along with a decrease of β on the other hand the number of female individuals in gynodioecious population decreased with increasing β fig 5 consequently gynodioecy was replaced by hermaphroditism at the same time the result indicates that gynodioecy was established by losing male function in some hermaphroditic individuals in hermaphroditic population along with a decrease of β thus there were no intermittent transition in the sequence of solutions and smooth transition was observed depending on β the male investment ratio at population level s was close to s 0 5 in many cases fig 6 although the number of females tended to be greater than that of males in dioecy fig 5 the sequence of the male investment ratio tended to increase with increasing β in the large population of dioecy and the male ratio of trioecy and gynodioecy was larger than that of dioecy fig 6 in turn the male ratio tended to decrease with increasing β in hermaphroditism the male strategy is less effective when more pollen is lost due to low β but males of dioecy never produce any female flowers even if β is getting lower discussion in the present study various sex expressions were explained by a mathematical model pollen transport efficiency played an important role in obtaining solutions for many patterns of sex expression in our model dioecy emerged in the lower β range and the sex expression switched from dioecy to hermaphroditism with increasing β via trioecy and gynodioecy fig 5 this means that the solutions of trioecy and gynodioecy occupy intermediate range between those of hermaphroditism and dioecy we theoretically demonstrated the presence of a hermaphroditism dioecy continuum as an evolutionary solution role of two assumptions we made two crucial assumptions in our study i e individuals have different reproductive strategies and there is uncertainty in pollen efficiency the first assumption was necessary to model the variety of sex expression in plants if we used the assumption under traditional ess models i e all individuals in the population had a single population wide strategy that cannot be invaded by another strategy hamilton 1967 lloyd 1984 dioecy gynodioecy and trioecy with sex expression varying among individuals in the population could not be simultaneously explained therefore we used an n player game model based on the first assumption the second assumption is also necessary to explain the variation in plant sex expression if the pollen efficiency β is infinite there is no uncertainty in the pollen transport and the fitness gain function in eq 3 is simplified to 10 w i x 1 x 2 x n i i x i x i j 1 n x j j 1 n i j x j eq 10 is the same as the mathematical model proposed by yamaguchi 1985 that author proposed the n player game model to explain the sex ratio of an aphid population using empirical data the fitness gain curve of yamaguchi s model differs from that of our model in yamaguchi s model individuals with low investment resource allocated all their resources to the male function the male phase in this paper while individuals with high investment resource allocated their resources to both male and female functions the hermaphroditic phase in this paper in other words there are no individuals that fully invest into female function in yamaguchi s model though investing fully into female function is normal in dioecious plants the incorporation of β into our model was therefore required to establish female individuals in the breeding population therefore low transport efficiency was necessary to obtain the nash solutions for dioecy and gynodioecy multiple nash solutions for each β were often found in our model it is a well known characteristic of the nash solution that more than one solution can exist in game theory there were three parameter ranges of β where more than one solution occurred for a certain β fig 5 the ranges appeared in the transition zone from dioecy to trioecy from trioecy to gynodioecy and from gynodioecy to hermaphroditism that is the range of dioecious solutions partially overlapped with that of trioecious solutions as well as between trioecious and gynodioecious solutions and between gynodioecious and hermaphroditic nash solutions fig 7 only one nash solution occurred in dioecy and hermaphroditism figs 5 and e these results imply that co existence of unisexual and hermaphroditic individuals in the breeding population enables the occurrence of the multiple nash solutions exchange of male function with female function and vice versa between unisexual and hermaphroditic individuals at a given β is achieved by the occurrence of more than one xi and xi max here we should refer to androdioecy though we excluded it from the analysis in this study androdioecy in which male individuals coexist with hermaphroditic individuals in a population may be explained by our model as β eq 3 can be modified as eq 10 eq 10 has only one xi that satisfies w i x i x i x i 0 and individuals with ii xi invest only in males whereas individuals with ii xi invest in xi males and divert the remaining resource to females yamaguchi 1985 this scenario describes a breeding system analogous to androdioecy in plants however androdioecy also seems to depend on unreliable pollen vectors akimoto et al 1999 appanah 1982 there is a need to demonstrate the realistic androdioecious solution in future study massive investment compensates low pollen transport efficiency the low pollen transport efficiency low β values was the cause of the dioecy in the nash solution the low β is equivalent to low reliability of pollen vectors if pollination efficiency is low then more investment in male reproduction is required to ensure fertilization i e he who shoots often hits at last japanese proverb in fact wind pollinated species often form dense pollen clouds cf regal 1982 synchronized flowering so called masting or mast seeding can also alter pollen limitation in wind pollination kon et al 2005 norton and kelly 1988 similarly the fertilization of ovules in hydrophilous plants seems to be altered by synchronized flowering van tussenbroek et al 2016 plant species with abiotic pollination systems generally tend to have large pollen ovule ratios ackerman 2000 erbar and langlotz 2005 according to cruden 1977 the more efficient the transfer of pollen should be the lower the pollen ovule ratio should be nash solution of dioecy in low β fig 5 will lead to the hypothesis that individuals are favored to invest all their reproductive resource in male at individual level simultaneously it is better for the individuals to invest all reproductive resources into female function than to dedicate resources to only a few males because a few males cannot form a dense pollen cloud in wind pollination similarly for animal pollination opportunistic pollinators such as horseflies flies moths and beetles would not be expected to visit a few male flowers within a crown filled with many female flowers such opportunistic pollinators are not considered to be effective pollinators for pollen transportation matsuyama et al 2009 even if some insects visit a male flower on a female individual they may not visit a female flower afterwards furthermore any pollen grains that reach a stigma in this case will be numerically overwhelmed by pollen grains from other individuals we therefore consider that a female individual will not produce any male flowers as long as pollination efficiency is low thus massive investment into one sex at the individual level will compensate for the unreliability of pollination systems and also enhance pollen transfer between sexes consequently female and male individuals are established in the breeding population which is neither a failure for plants westergaard 1958 nor an evolutionary dead end heilbuth 2000 we propose that a dioecious breeding system is an adaptive solution to low pollination efficiency conditions on the other hand unfavorable or harsh environments have also been often associated with the dominance of dioecy over hermaphroditism for example echinocereus coccineus in the southwestern united states has both hermaphroditic populations and dioecious ones and the distribution of the latter is associated with areas of low hummingbird abundance related to low rainfall scobell and schultz 2005 an increase of dioecious dombeya spp sterculiaceae at high altitude was also documented on la réunion humeau et al 1999 barrett 1992 showed that dioecious populations of wurmbea dioica colchicaceae in western australia often occur in drier areas whereas hermaphroditic populations are found on moist localities hart 1985 also noted a correlation between dioecy and dry habitats in lepechinia spp lamiaceae in case of monoecy in the real hermaphroditism dioecy continuum costich 1995 described that dioecious ecballium spp cucurbitaceae live in habitats with drier summers than do monoecious phenotype on the iberian peninsula delph 1990 and renner and won 2001 demonstrated that dioecious populations occur at high altitude while monoecious populations confined into low altitude low reliability of animal pollen vectors can be induced by low activity due to the harsh environments bawa 1980 1982 and baker and cox 1984 noted the association of dioecy with tropical regions oceanic islands and perenniality these aspects can be explained by low pollination efficiency in dioecy first high species diversity in tropical regions immediately indicates a low abundance of each species whitmore 1990 under such conditions we can assume two options to enhance the pollen transfer 1 dependence on specialist pollinators such as bats birds or honeybees or 2 concentrated investment in one sex if the pollen vectors are very unreliable the former corresponds to hermaphroditism and the latter represents dioecy second many dioecious species are found on oceanic islands opportunistic pollinators such as solitary bees flies and small moths are typical pollen vectors on oceanic islands abe 2006 barrett 1996 sakai et al 1995a b often referred to as the island syndrome whittaker 1998 this implies a low β this condition would promote the evolution of dioecy on some oceanic islands at a higher rate than in other locations third perenniality will increase the chance of the pollination success of dioecious species over their long lifespan because annual species exhibits monocarpic reproduction we hypothesize that it is risky for annual plants to produce only male flowers if the plant depends on unreliable pollen vectors indeed dioecy is rather uncommon in annual plants pickup and barrett 2013 our model can explain the abundance of dioecy in tropical regions oceanic islands and perenniality reasonably hermaphroditism dioecy continuum in our model gynodioecy emerged at the transition zone in the hermaphroditism dioecy continuum figs 5 and 7 it has been suggested that the evolution of dioecy from hermaphroditism is often achieved via gynodioecy barrett and crowson 2016 dorken and barrett 2004 dufay et al 2014 käfer et al 2017 spigler and ashman 2012 the invasion of females into hermaphroditic populations is the first step leading to gynodioecy barrett and crowson 2016 similarly in our model gynodioecy is established by losing male function in some hermaphroditic individuals figs 5 and 7 female advantage over a hermaphrodite has been considered to be main driver of evolution of gynodioecy i e more flowers more fruits more seeds and or better germination dufay and billard 2012 shykoff et al 2003 conversely spigler and ashman 2012 have asserted that females can more easily gain the seed fertility advantage needed to invade hermaphroditic populations if hermaphrodites reduce their allocation to female function in favor of male function in addition ashman 1999 and dorken and pannell 2009 have posited that the presence of females results in selective pressures on hermaphrodites leading to selection for enhanced male sexual characteristics see also charlesworth 1989 in fact sinclair et al 2016 have shown that the mating system of daphne jezoensis in northern japan is functionally close to a dioecious mating system i e strongly male biased hermaphroditism in our model the maximal point of the fitness gain function xi max increases with decreasing β fig e which indicates that hermaphroditic individuals enhance their allocation to male function under low β male function is thus also favored by hermaphroditic individuals under low pollination efficiency in our model however except alonso 2005 there are few arguments about the establishment of gynodioecy linked with the pollen transport efficiency and the environment of habitat gynodioecious species are often observed in the plants that bloom in winter or early spring e g daphne spp thymelaeaceae kikuzawa 1989 alonso 2005 stachyurus praecox stachyuraceae abe 2007 geranium maculatum geraniaceae van etten et al 2008 nemophila menziesii hydrophyllaceae ganders 1978 activity of dominant specialist pollinators such as bumblebees is not so high in early spring abe 2007 in silene spp caryophyllaceae night flying moths are the main pollinators dulberger and horovitz 1984 or the insect visitors are scarce talavera et al 1996 anemophilous gynodioecy has been found at the windswept habitat dufay et al 2009 koelewijn and van damme 2005 waller and sakai 2005 iris douglasiana iridaceae is gynodioecious species although this species depends on the specialist pollinators uno 1982 douglas iris is found at the coastal region in which low temperature and strong wind seems to reduce the activity of the insects cf uno 1982 furthermore harsh environment can be linked with the increase of female individuals in the population e g higher altitude and drier environment ashman 2006 delph 2003 vaughton and ramsey 2004 alonso 2005 and alonso and herrera 2001 have discovered a negative relationship between elevation and the number of female individuals in spurge laurel daphne laureola populations in southeastern spain in mediterranean areas summer drought is a critical factor for plant recruitment and is severe at lower elevations with hotter summers alonso and herrera 2001 spurge laurel is scarcest at lower elevations where the smallest populations occur alonso and herrera 2001 alonso 2005 has reported that female disadvantage in pollination success increases with elevation but the opposite is also true namely female advantage in pollination success is increased at lower elevations we believe that this is the reason why female spurge laurel plants are predominant at lower elevations in addition to having a low population density at lower elevations flowering period of spurge laurel is winter and the nitidulid beetles solitary bees and noctuid moths are the ordinary pollinators alonso 2005 a low population density together with opportunistic pollinators in winter should result in a very low pollination efficiency and may facilitate female invasion into hermaphroditic populations of spurge laurel in southeastern spain we note that inbreeding avoidance is not able to explain the high proportion of female individuals in spurge laurel populations alonso and herrera 2001 see also dufay and billard 2012 the establishment of a gynodioecious nash solution at a lower β range than that of the hermaphroditic solution in our model fig 5 corresponds to the situation in reality similar to gynodioecy trioecy emerged at the transition zone in the continuum figs 5 and 7 barrett and crowson 2016 consider subdioecy to be an intermediate stage between gynodioecy and dioecy subdioecy which has thus arisen from gynodioecy via the loss of female function in hermaphroditic individuals can also arise from dioecy when males begin to add female functionality barrett and crowson 2016 cf cossard and pannell 2019 hereafter we use the term trioecy instead of subdioecy see the caption of fig 1 in our model the trioecious nash solution is derived if some hermaphroditic individuals not all in a gynodioecious population are replaced by male individuals fig 5 according to ashman 2006 high frequencies of females may select for increased maleness of hermaphrodites in fragaria virginiana rosaceae if the frequency of females increases or pollinator visits decline pollen limitation becomes more likely and hermaphroditic individuals experience frequency dependent selection for enhanced male function ashman 2006 in our model hermaphroditic individuals are replaced by males as the proportion of females increase and β decreases fig 5 which implies that both the frequency of females and the uncertainty of pollination efficiency play vital roles in the evolution of trioecy from gynodioecy at the same time males rather than females contribute to the breakdown of dioecy into trioecy in our model fig 5 most dioecious species exhibit inconstant sex expression and males tend to show leaky sex expression far more than females cossard and pannell 2019 del blanco et al 2019 also seec delph 2009 this inconstancy is advantageous when mates are limiting as inconstant males but not females benefit from the ability to self pollinate in the absence of mates cossard and pannell 2019 since strict trioecy is rare ainsworth 2000 however far less information than gynodioecy is available about the pollination ecology in trioecy for example coccoloba cereifera polygonaceae occurs at high altitude in southeastern brazil and low number of small hymenopterans visit the small flowers 3 mm in diameter silva et al 2008 though trioecious nash solutions occurred subsequently to gynodioecious nash solutions with the decrease of β in our model figs 5 and 7 a counterexample may be found according to fleming et al 1998 the sonoran desert columnar cactus pachycereus pringlei cactaceae in mexico exhibits trioecy near the roosts of chiropteran pollinators whereas gynodioecy occurs 50 km from the bat roosts the authors argued that the low frequency of bat visitation i e low β was associated with the establishment of gynodioecious population trioecy in our study involves monoecy to some extent since a few female and male individuals are sometimes observed in monoecy see fig 2 masaka and takada 2006 masaka 2007 also see jordano 1991 compared with hermaphroditism monoecious species often adopt unreliable pollen vectors such as wind and opportunistic pollinators e g charlesworth 1993 vamosi et al 2006 therefore there is little discrepancy between the establishment of trioecy with respect to low β in our model and in reality based on the ecological traits of dioecy described above we propose a schematic diagram model for the hermaphroditism dioecy continuum as shown in fig 8 change of sex expression with respect to β corresponds appropriately to the performance of pollen vectors i e water must be the most unreliable pollen vector lower β and a specialist pollinator is the most reliable pollen vector higher β the schematic model indicates that dioecy is the extreme phenotype under unfavorable reproductive conditions since there is a lower limit in β 0 although hermaphroditism and monoecy cannot be distinguished mathematically in our model monoecy can be placed between hermaphroditism and trioecy fig 8 the reason for this placement is that monoecy unisexual flowers is considered to have evolved from hermaphroditism in response to pollinator limitation and changes in the abiotic environment culley et al 2002 friedman and barrett 2009a b unisexual flowers are strongly associated with abiotic pollen vectors and opportunistic pollinators charlesworth 1993 furthermore trioecy can partially include monoecy as unisexual individuals are sometimes found in monoecious species masaka and takada 2006 moreover a dioecious solution was obtained without consideration for the inbreeding depression even in our model that allows for self fertilization our approach using the n player game departs from the darwinian paradigm in evolutionary ecology which is the view that the evolution of dioecy from hermaphroditism is explained by various aspects of the interactions between environment and species specific characters our model is based on numerical interactions between and within individuals i e the fitness gain of each sex depends on local mates and a trade off exists between sexes under limited reproductive resources furthermore pollen transportation between individuals was assumed to be uncertain nevertheless a hermaphroditism dioecy continuum was derived although the hermaphroditism dioecy continuum in our model can be explained without consideration of genetic characters such as inbreeding depression and dichogamy pollen transport efficiency in our model will correspond to the ability or activity of the pollen vectors fig 8 β will be the neutral index that enables us to compare the performance of pollen vectors among habitats such as unfavorable or harsh environments contributors the first author hit on an idea to build the model and interpreted the results from the view point of reproductive ecology while the second author probed the analysis of the model from the view point of the mathematical ecology whichever we conducted the study always together declaration of competing interest this study was supported by grants in aid for scientific research 20k06821 japan society for the promotion of science jsps there is no conflict relationship with other researchers and organizations acknowledgment the authors thank three anonymous reviewers for critical comments on previous versions of the manuscript this study was supported by grants in aid for scientific research 20k06821 japan society for the promotion of science jsps appendix a the i th fitness gain function w i x 1 x 2 x n the function is w i x 1 x 2 x n i i x i x i 1 e β x i x j 1 e β x j j 1 n i j x j eq 3 in the main text and w i x i 0 i i the first derivative of eq 3 is w i x i 1 x i 1 e β x i x j 1 e β x j j 1 n i j x j e 1 e β x i β x i e β x i x j 1 e β x j 2 eq 4 in the main text where e j i x j 1 e β x j 0 therefore w i x i x i 0 1 the 1 is derived from the property of female reproductive success fi i e i i x i the functional form is followed by the studies of hamilton 1967 lloyd 1984 and yamaguchi 1985 the female reproductive success in an individual decreases as the male investment x i increases therefore in case of female reproductive success the change in fitness with an increase in investment in male function does not depend on the investment of other individuals in contrast the male reproductive success mi depends on the investment of other individuals and increases with x i because mi xi 0 and 2 mi xi 2 0 when xi 0 when xi is small the degree of increase in male reproductive success is not so large enough to compensate for the negative effect derived from i i x i therefore the fitness gain curve wi initially decreases and increases when x i becomes large enough the second derivative of eq 3 is 2 w i x i 2 2 e 1 e β x i β x i e β x i j x j 1 e β x j 2 1 j i j x j 1 e β x i β x i e β x i j x j 1 e β x j β e j i j x j e β x i 2 β x i j x j 1 e β x j 2 therefore 2 w i x i 2 x i 0 2 β j 1 n i j x j e 0 and 2 w i x i 2 x i 2 β 2 e 1 e 2 j x j 1 e β x j 2 1 j i j x j 1 e 2 j x j 1 e β x j 0 appendix b proof that there are at most two positive x i s from eq 3 it s obvious that w i is equal to i i when xi 0 we prove there are at most two positive x i s that satisfy w i x i i i i e i i x i x i 1 e β x i j 1 n x j 1 e β x j j 1 n i j x j i i it can be written as x i 1 1 e β x i j 1 n x j 1 e β x j j 1 n i j x j 0 thus the positive x i satisfies the following equation 1 1 e β x i j 1 n x j 1 e β x j j 1 n i j x j 0 i e b1 j 1 n x j 1 e β x j 1 e β x i j 1 n i j x j extracting x i in the summation symbols explicitly we rewrite eq b1 as follows x i 1 e β x i j i x j 1 e β x j 1 e β x i i i x i j i i j x j x i 1 e β x i e 1 e β x i d x i where e j i x j 1 e β x j 0 and d i i j i i j x j 0 d and e do not include x i eventually we obtain b2 d 2 x i e 1 e β x i defining the r h s of eq b2 as a function of x i g x i e 1 e β x i 0 from the first derivative i e g x i e β e β x i 1 e β x i 2 0 the function decreases monotonously from g 0 furthermore from the second derivative i e g x i e β 2 e β x i 1 e β x i 1 e β x i 3 0 the function g is a downward convex curve with asymptote e as shown in fig b the intersection of g x i and the line of d 2 x i is the positive solution of x i that satisfies eq b2 therefore depending on e and d there are two cases on the number of positive solutions i no solution and ii two positive solutions see fig b the second x i is denoted as x i x i x i in the main text there is a single positive solution as an exceptional case where the straight line is tangent to the function g for simplicity we do not discuss the case here appendix c the fitness gain curve has at most two extremum points from eq 4 the first derivative of the fitness gain curve is zero at the extremums 1 x i 1 e β x i x j 1 e β x j j 1 n i j x j e 1 e β x i β x i e β x i x j 1 e β x j 2 0 simplifying the equation we obtain the following equation c1 2 x i 1 e β x i 2 3 e x i 1 e β x i e 2 d x i e 1 e β x i β x i e β x i defining the l h s of eq c1 as m x i 2 x i 1 e β x i 2 3 e x i 1 e β x i e 2 and the r h s of eq c1 as l x i d x i e 1 e β x i β x i e β x i we have m 0 e 2 m the first derivative is m x i 4 x i 1 e β x i 1 e β x i β x i e β x i 3 e 1 e β x i β x i e β x i 1 e β x i β x i e β x i 4 x i 1 e β x i 3 e 0 therefore m 0 0 and m and m x i is a monotonous increasing function of x i when x i is positive furthermore the second derivative is c2 m x i β e β x i 2 β x i 4 x i 1 e β x i 3 e 4 1 e β x i β x i e β x i 2 because the first term of l h s of eq c2 is positive for 0 x i 2 β and the second term is positive m xi is positive for 0 x i 2 β the inflection point of m x i is larger than 2 β if there exists the inflection point b such that m b 0 i e b 2 β therefore m x i is a downward convex curve in the range of 0 x i 2 β fig ca from l xi we have l 0 0 l d 0 the function v xi 1 e β x i β x i e β x i in the function l xi is a unimodal positive function passing the origin 0 0 with the asymptote 1 and the local maximum at xi 2 β fig cb w xi d x i e is a linearly decreasing function and thus the product of these two functions in l xi is a unimodal function and zero when x i 0 and d fig cb we firstly examine l x i when d 2 β the first derivative of l x i is as follows l x i e 1 e β x i β x i e β x i e d x i β 2 β x i e β x i and l 2 β 0 therefore it has the maximum at x i in the range of 0 x i 2 β i e x i 2 β fig cb furthermore the second derivative l x i 2 e β 2 β x i e β x i e β 2 d x i 3 β x i e β x i is negative in the range of 0 x i x i because of x i 2 β eventually m xi is a downward convex curve in the range of 0 x i x i and l xi is an upward convex curve in the same range the point xi xi tan that satisfies m x i tan l x i tan and m x i tan l x i tan simultaneously is a tangent point fig cc the number of the intersection is one at that tangent point there is no intersection if m xi moves upward from the tangent point and it has two intersection points if m xi moves downward from the tangent point fig cd because of b 2 β fig ca the number of intersections of m x i and l x i is at most two figs cc and ce we can examine l x i when d 2 β similarly and obtain the same conclusion appendix d the male investment ratio should be less than 1 2 we can obtain the positive xi that satisfy wi xi ii using eq b1 b1 j 1 n x j 1 e β x j 1 e β x i j 1 n i j x j it can be written as t 1 e β x i 1 s where s is male investment ratio σxj σij and t x j 1 e β x j i j then xi can be written as x i 1 β l n 1 s 1 t s furthermore the r h s of the equation 1 β l n 1 s 1 t s is less than 1 β l n 1 s 1 2 s because 0 t s 1 therefore s has to be less than ½ when we obtain a positive xi appendix e mathematical conditions used to obtain the nash solutions numerically for the hermaphroditic solution in case of hermaphroditism only hermaphroditic individuals exist in a population the interior nash solution should be obtained by satisfying the following four conditions for all i e1 w i x i x i x i max 0 e2 2 w i x i 2 x i x i max 0 e3 x i max i i e4 w i x i max i i for the dioecy solution considering a nash solution with k females and l males in the dioecious population n k l then the nash solution is x 1 x 2 x k x k 1 x n 0 0 i k 1 i k l this is because the individuals with low investment resource are likely to show female in real dioecious plants indeed male individuals of dioecious plant species often allocate significantly more biomass number to reproductive organs than females at flowering nicotra 1999 otero arnaiz and oyama 2001 rocheleau and houle 2001 torimaru and tomaru 2006 from eq 3 and eq b1 the switching point xi satisfies e5 j x j 1 e β x j 1 e β x i j i j j x j to obtain xi which satisfies eq e5 under the condition that other xj s j i are at the nash solution we substituted xj 0 for j 1 to k 1 and xj ij for j k 1 to n except xi into eq e5 i when i 1 to k 1 the left hand side of eq e5 is e6 0 x i 1 e β x i j k 1 n i j 1 e β i j in addition the right hand side of eq e5 is 1 e β x i j i j 0 x i j k 1 n i j here j k 1 n i j 1 e β i j and j k 1 n i j are conveniently rewritten by c and c respectively from eqs e5 and e6 we obtain e7 x i 1 e β x i c 1 e β x i j i j c x i ii when i k 1 to k l the switching point is given by e8 1 e β x i j i j c i i x i x i 1 e β x i c i i 1 e β i i eventually for a nash solution with k females and l males the following conditions should be achieved e9 x i i i and w i x i x i x i 0 for i 1 2 k because the optimal investment for male flowers is zero under the condition furthermore e10 x i i i x i max and w i x i x i x i 0 for i k 1 to k l because the optimal investment into male flowers is ii under the condition if either eq e9 or e10 is not satisfied then the nash solution with k females and l males does not exist for the trioecy solution trioecy contains hermaphroditic individuals with some unisexual individuals in the population the conditions for hermaphroditic individuals with some unisexual individuals in the population should be given assuming there are k females l males and m hermaphroditic individuals n k l m as follows e9 for i 1 2 k e10 for i k 1 k 2 k l e1 to e4 for i k l 1 to n for the gynodioecious solution the gynodioecy contains both female and hermaphroditic individuals in the breeding population for a nash solution with k female and l hermaphroditic individuals eq e9 for i 1 2 k should be satisfied to obtain solution of females conversely to obtain solution of hermaphroditic individuals eqs e1 to e4 for i k 1 to k l should be satisfied as an example sequence of the maximal point of fitness gain function xn max of n th individual were shown in fig e more than one xn max were obtained for a given β there was one xn max for dioecious and hermaphroditic nash solutions at a given β whereas there were some xn maxs for trioecious and gynodioecious nash solutions 
24294,dioecy characterized by the presence of distinct male and female individuals in the breeding population has evolved independently numerous times suggesting that a simple common mechanism may prevail behind the evolution of dioecy from hermaphroditism in the present study a floral sex allocation model is demonstrated for the presence of a hermaphroditism dioecy continuum in higher plants using an n player game model in the continuum we pay attention to the emergence of gynodioecy in which both hermaphroditic and female individuals coexist in the breeding population and trioecy which includes hermaphroditic male and female individuals in the breeding population as these have often been considered as an intermediate step in the evolution of dioecy from hermaphroditism and vice versa in the n player game model we assumed a local breeding population containing n players with different reproductive investment and there is a trade off between the reproductive investment to male function and female function at individual level furthermore we focused on the uncertainty of pollen transportation as dioecy is often linked to both the unreliable pollen vectors and harsh environment for pollinators the pollen transport efficiency was explained by the probability of the pollen hitting ovules or stigmata in the model setting hypothetical populations with different population sizes we showed the nash solutions for dioecy appeared at a smaller pollen transport efficiency than for hermaphroditism in all hypothetical populations since the low pollen transport efficiency equals the low reliability of pollen vectors the result is comparable with the pollinators of real dioecy such as water wind and opportunistic species the nash solution for gynodioecy and trioecy was obtained at the transition zone between dioecy and hermaphroditism in the continuum the number of male and female individuals in dioecy were almost stable in the range of low pollen transport efficiency if the number of males decreased with increasing pollen transport efficiency hermaphroditic individuals emerged in the population establishment of trioecy gynodioecy established as soon as no males were left in the population finally hermaphroditism established at the time no females were left in the population these results imply that pollen transport efficiency played an important role of obtaining a variety of nash solutions in the model though the darwinian paradigm in evolutionary ecology of dioecy is based on the various aspects of the interaction between environment and species specific characters our model is composed of numerical interactions between and within individuals in this paper we argue that the association between the continuum and the pollen transport efficiency is reflected in the real world keywords floral sex allocation n player game model pollen transport efficiency competitive sharing nash solution data availability no data was used for the research described in the article introduction since darwin 1877 floral sex allocation in plant species has inspired biologists and botanists to study the ecological and evolutionary factors that favor dioecy over hermaphroditism fig 1 dioecy is marked by the presence of distinct male and female plants and is a rare breeding system in flowering plants renner and ricklefs 1995 phylogenetic analyses on the systematic distribution of dioecy have indicated that this trait has evolved independently numerous times in a variety of taxa renner 2014 volz and renner 2008 weiblen et al 2000 bawa 1980 1982 and baker and cox 1984 demonstrated foresight in noting the association of dioecy with abiotic pollen vectors perenniality tropical regions and oceanic islands unfavorable or harsh environments such as drought barrett 1992 costich 1995 also see scobell and schultz 2005 and high altitude delph 1990 humeau et al 1999 renner and won 2001 are associated with the dominance of dioecy over hermaphroditism bawa 1980 and other researchers as mentioned above have considered that the evolution of dioecy from hermaphroditism is caused by the various interactions between the environment and species specific characters however the authors do not model the association between the environment and species specific characters mechanistically recently the transition between dioecy and other sex expression was evaluated from the standpoint of genetic engineering henry et al 2018 we consider that the genomic approaches can answer how dioecy is expressed i e the proximate cause but cannot answer why the dioecy is associated with tropical regions oceanic islands perenniality and unfavorable harsh environments i e the ultimate cause on the other hand heilbuth 2000 pointed out that dioecy is an unsuccessful mating system because dioecious flora comprise only 6 of the world s angiosperms despite the many possible advantages such as avoidance of inbreeding depression heilbuth 2000 considered that dioecy is an evolutionary dead end and westergaard 1958 considered it to be a failure for plants but some researchers recently challenged the evolutionary dead end hypothesis käfer et al 2014 2017 muyle et al 2021 käfer et al 2017 reported that dioecy is evolutionarily labile and reversion from dioecy to other sexual systems is frequent for example cossard et al 2021 and dorken and pannell 2009 removed the males from the dioecious population and demonstrated the rapid evolution of hermaphroditism here we must pay attention to the hydrophilous plant species the fact that predominance of dioecy is in hydrophilous plant species cox 1988 would be evidence against the evolutionary dead end hypothesis it would mean that many hydrophilous plant species are endangered if the hypothesis is correct actually muyle et al 2021 showed no genetic evidence for extinction risk in dioecy barrett and crowson 2016 focused on selfing to consider the mating system transition in flowering plants conventional theoretical models assume the mechanism that the dioecious condition compensates for the lack of fitness of another sex i e that unisexual individuals have to gain at least twice the fitness as hermaprodites cf charlesworth and charlesworth 1978 in the case of no inbreeding depression a selective force that compensates for the disadvantage is thought to be inbreeding depression in hermaphroditism barrett and crowson 2016 charlesworth 1993 charlesworth and charlesworth 1978 dorken et al 2002 lloyd 1984 because inbreeding depression decreases offspring fitness inbreeding depression is considered to be a key factor in the maintenance of separate sexes in plants through selection for the avoidance of selfing barrett and crowson 2016 barrett 2015 dorken et al 2002 eppley and pannell 2009 however hermaphroditism especially in monoecy often avoid selfing via dichogamy i e the temporal separation of male and female function in flowering plants bertin 1993 also see friedman and barrett 2009a because many dichogamous species are self incompatible routley et al 2004 we can hypothesize that the effect of inbreeding depression is not a main driver of the evolution of dioecy thus a different approach is necessary to consider the cause of evolution of dioecy scobell and schultz 2005 provided an important clue to consider the transition between hermaphroditism and dioecy that is dioecious populations of echinocereus coccineus cactaceae tended to be found in areas with low hummingbird abundance their result implies that pollination is one of the key factors to explain the transition between hermaphroditism and dioecy pollen transport between plants is ultimately analogous to the delivery of an object between a sender and recipient and this condition can be explained as a probabilistic system if so the hermaphroditism dioecy continuum can be described by a mathematical model based on the stochastic process we focus on the uncertainty of pollen transportation as one of the ultimate factors governing plant fitness this is because pollen transport between plants is ultimately analogous to a delivery system optimal delivery depends on the transport efficiency between sender and recipient so allocation between senders male flowers and recipients female flowers will be adjusted depending on the transport efficiency of the object pollen from the view point of the uncertainty of pollen transportation it is no wonder that dioecy is more predominant in hydrophilous plant species than in terrestrial plants i e 55 of all hydrophilous genera and 75 of marine hydrophilous genera are dioecious cox 1988 whereas this is 6 in terrestrial plants renner and ricklefs 1995 water and air are fluid media and will be inefficient pollen vectors compared with animals ackerman 2000 among the abiotic pollinators water is the most unreliable pollen vector and may result in pollen dilution cf van tussenbroek et al 2010 2016 and a very small breeding area within the order of meters ackerman 2002 zipperle et al 2011 in addition abiotic stresses e g drought and high altitude may result in reduced activity of animal pollinators e g culley et al 2002 uno 1982 also see scobell and schultz 2005 as stated above we consider that uncertainty in pollination is more prevalent in dioecy thus the unreliability of pollen vectors will play a vital role in the emergence of dioecy the aim of this study was to examine the evolutionary transition between hermaphroditism and dioecy from the stand point of pollen transport efficiency in a mathematical model if dioecy solutions appeared in our model the theoretical condition can be compared with the ecological characteristics of dioecy in the real world here we also focused on the existence of gynodioecy i e co occurrence of female individuals with hermaphroditic individuals within the same species fig 1 because gynodioecy has often been considered as an intermediate step in the evolution of dioecy from hermaphroditism and vice versa barrett and crowson 2016 dorken and barrett 2004 dufay et al 2014 käfer et al 2017 spigler and ashman 2012 if our model could explain the hermaphroditism dioecy continuum a gynodioecy solution should also be derived by our model we used a n player game model developed by masaka and takada 2006 the unreliability of pollination i e pollen transport efficiency was incorporated into the model this may have the potential to explain the emergence of dioecy under conditions of low pollen transport efficiency in our previous study masaka and takada 2006 we focused on the floral sex allocation in monoecy only but the model can be versatile to apply the other sex expressions the model assumed that n individuals in a breeding population have different reproductive resources a numerical calculation was performed to obtain the game solution and the result revealed that dioecy tended to emerge under conditions of lower pollination efficiency compared to hermaphroditism we finally discuss the superiority of dioecy over hermaphroditism under low pollen transport efficiency then we discuss how the low pollen transport efficiency can be induced in various habitats model according to masaka and takada 2006 the floral sex ratio allocation strategy in wind pollinated monoecious species is well explained by an n player game model which assumes the presence of players with different reproductive resources among individuals along with a limited population size we do not consider the heritability of resources to invest in reproduction but the sex ratio depending on the amount of the resources it is generally called conditional strategy which is a theoretical concept on strategy that expresses different behavior or life history when the fitness depends on the status of the individual or environmental conditions cf charnov 1976 for the optimal foraging model and hamilton 1967 for the sex ratio model the n player game model on sex ratio was used also in yamaguchi 1985 to explain the dependence of sex ratio on the amount of parental investment in an aphid prociphilus oriens because the parents of the aphid differed in their reproductive investment yamaguchi 1985 when there is variation in parent reproductive investment within the breeding population the n player game model is more adequate than the evolutionary stable strategy ess models proposed by hamilton and other researchers hamilton 1967 lloyd 1984 the reason is in ess models all individuals are assumed to be uniform and adopt a single strategy since dioecy implies that individuals in the population adopt at least two different strategies the n player game model is needed to construct a mathematical model for the hermaphroditism dioecy continuum the model described here includes two key assumptions first the breeding population is founded by n individuals that potentially differ in their reproductive investment ii i 1 2 n reproductive investment means total allocation of resources to reproductive functions second the number of pollen grains reaching a given stigma is described by a poisson distribution feller 1968 smith et al 1990 although we did not take the effect of spatial constraints into consideration in the pollen transport we assume that spatial constraints are incorporated implicitly in our model through variation in transport efficiency with lower transport efficiency reflecting systems in which pollen transport is lower due to spatial effects e g distance besides we did not take the cost of development of seeds and fruits into consideration in the female cost because we focus on the pollen transport efficiency in this model as for the first assumption we can set i 1 i 2 in 1 in without loss of generality masaka 2007 individuals invest xi in male flowers and yi ii xi in female flowers and the fitness of the i th individual wi is given by the sum of the female fi and male mi components of reproductive success wi fi mi following the assumption of hamilton 1967 lloyd 1984 and yamaguchi 1985 the female reproductive success of i th individual fi is equal to yi 1 f i y i i i x i to simplify the number of pollen grains is assumed to be enough to fertilize all the female flowers and there is no loss in the investment for female function male reproductive success mi is a function of investment in male flowers xi from the second assumption the probability that no pollen of the i th individual reaches a given individual s stigma is the first term of the poisson distribution as e α i α i is the mean number of pollen grains from i th individual and is expected to increase with the amount of male investment fig 2 thus we assume the mean number is proportional to xi i e α i β x i where β represents the index of pollen transport efficiency that is identical irrespective of individual masaka and takada 2006 cf cox 1988 smith et al 1990 therefore the probability of reaching stigma is 1 e β x i and x i 1 e β x i grains from i th individual on average reach the stigma s fig 2 the shape of 1 e β x i with respect to xi shows the saturation curve fig 3a and that of x i 1 e β x i deviates from the asymptote in the small range of xi fig 3b if the individual has low resources for the male flowers i e x i is small the probability of reaching stigmas is much smaller than 1 and the difference between the solid line and the dashed line in fig 3b is large which means that a large proportion of pollen grains cannot reach the stigma s and most of the investment to male flowers is wasted however only one pollen grain fertilizes an ovule even if numerous grains reach the stigma therefore there must be a competition on the stigma among the grains from all the individuals competitive sharing among males referred by lloyd 1984 and their sum is x j 1 e β x j the sum through male investment competitively shares the total investment in female i 1 n y i i 1 n i i x i within the breeding population i e a fair lottery proportionally to male contribution from each individual therefore the reproductive success of i th individual through male investment male reproductive success mi is written as 2 m i x i 1 e β x i j 1 n x j 1 e β x j j 1 n y j it represents the proportion of male i s pollen multiplied by total available females the fitness gain curve of the i th individual is the sum of female and male reproductive successes of i th individual from eqs 1 and 2 3 w i x 1 x 2 x n f i m i i i x i x i 1 e β x i x j 1 e β x j j 1 n i j x j where the first term on the right hand side of eq 3 designates fitness through female investment assuming all females are fertilized hamilton 1967 yamaguchi 1985 we don t formulate the reproductive success of grandchildren generation as formulated in fisher s model fisher 1930 the reason is that parents of plants i e players in this game are capable of having both sexes in their reproductive organ and thus that the reproductive success caused by sex ratio is reflected in their offspring generation analysis the shape of fitness gain curve here we analyze the shape of the i th fitness gain curve the fitness gain curve starts from w i x i 0 i i and decreases from the coordinate 0 ii in fig 4 a and 4d because the first derivative of eq 3 is 4 w i x i 1 x i 1 e β x i x j 1 e β x j j 1 n i j x j e 1 e β x i β x i e β x i x j 1 e β x j 2 and w i x i 1 when xi 0 where e j i x j 1 e β x j 0 see the detail in appendix a because w i x i 1 when xi 0 the fitness gain curve decreases when x i is zero irrespective of the investment by other individuals the 1 term is derived from the property of female reproductive success fi i e i i x i therefore the female reproductive success in an individual decreases as the male investment x i increases even if every other individual in the population is female in contrast the male reproductive success mi depends on the investment of other individuals and increases much with x i when every other individual is female see appendix a the second derivative is 2 w i x i 2 2 β j 1 n i j x j e 0 when xi 0 therefore wi xi increases around xi 0 from a mathematical analysis in appendix b we show that there are two cases on the shape of the wi variables presented in this study are listed in table 1 in the first case depicted in fig 4a there is no intersection of the fitness curve and w i i i except xi 0 fig 4a and fig ba in appendix b it biologically implies that maximum fitness is realized when the i th individual does not invest into male function thus being female is the best strategy in the second case depicted in fig 4d there are two intersections xi and xi xi xi of the fitness curve and w i i i except xi 0 fig 4d and fig bb in appendix b the wi curve has a local minimum between xi 0 and xi xi and a local maximum between xi xi and xi xi fig 4d because the fitness gain curve has at most two extremums see appendix c they were named xi min and xi max as shown in fig 4d the i th individual obtains the maximum fitness depending on the amount of reproductive resources i i if i i ranges from xi 0 and xi it obtains the maximum when the individual does not invest for male function i e female individual if i i exceeds xi max then it obtains the maximum fitness between x i 0 and i i which means investing both male and female function is the best i e hermaphroditic strategy xi can be written simply as 1 β l n 1 s 1 t s using s σxj σij and t x j 1 e β x j i j s represents the male investment ratio in the population and condition xi 0 implies that the male investment ratio s is less than 1 2 see appendix d reproductive resource in male flowers will reduce the fitness of the i th individual as shown in fig 4a the optimal investment in male flowers xi and the optimal male ratio ri xi ii of the i th individual in a population are 5 x i 0 and r i 0 if i i 0 where the asterisk represents optimal investment that maximizes wi fig 4b and 4c therefore the individual benefits by investing all reproductive resources in female flowers female phase i e yi ii note that the other female costs such as development of seeds and fruits are not included in the female cost in the model because we focus on the pollen transport efficiency in the second pattern investing reproductive resources in male flowers will reduce the fitness of the i th individual in the range 0 ii xi because the fitness gain curve is under the line wi ii in the range fig 4d therefore in this range the individual benefits by investing all reproductive resources in female flowers female phase i e yi ii and xi 0 the optimal investment in female flowers yi increases linearly as ii increases then the optimal male ratio is kept as zero fig 4e and 4f the constant xi is a switching point from the female phase to the male phase fig 4d and 4e if the i th individual has reproductive resources higher than xi i e xi ii xi max then all of the reproductive resources are invested in male flowers male phase i e yi 0 and xi ii because investing in a female flower contributes to reduction of the fitness rather than gain however if the i th individual has reproductive resources greater than xi max the individual benefits by investing xi max in male flowers and invest the remaining reproductive resource in female flowers hermaphroditic phase i e yi ii xi max and xi xi max because investing the remaining reproductive resource in male flowers would reduce the fitness of the individual fig 4e it biologically means that individuals with sufficient reproductive resources produce only hermaphroditic flowers with a certain proportion of male investment depending on i i and xi max in summary the optimal investment in male flowers xi and the optimal male ratio ri xi ii of the i th individual in a population are written as 6a x i 0 and r i 0 if 0 i i x i 6b x i i i and r i 1 if x i i i x i max 6c x i x i max and r i x i max i i if i i x i max female phase male phase and hermaphroditic phase appear sequentially along the gradient of the total investment of the i th individual ii nash solution and plant sex expression based on the analysis on the shape of the fitness gain curve we can obtain nash solution in our n player game model the optimal investment corresponds to a nash solution defined by the following inequality 7 w i x 1 x i x n w i x 1 x i x n for x i x i in all i note that the left and right sides of the inequality are slightly different x i versus x i on the left and right sides respectively the solution is called the interior nash equilibrium if xi satisfies wi xi 0 2 wi xi 2 0 and the condition in eq 6c holds for any i otherwise it is called the edge nash equilibrium for a given set of x 1 x 2 x i 1 x i 1 x n we can obtain the nash solution of the i th individual by examining the shape of the i th fitness gain curve and discuss the sex expression of plants here we focus on the nash solution that corresponds to the sex expression observed in real plants though there could exist many other types of nash solution in this game model first if ii xi max for all i only the hermaphroditic phase emerges i e hermaphrodite cf masaka and takada 2006 then xi xi max and ri xi max ii for all i the solution x 1 x 2 xn is an interior nash solution because wi xi 0 at xi for any i second if 0 ii xi for i 1 k and xi ii xi max for i k 1 n both female and male phases will emerge in the population i e dioecy investment in male phase is larger than female phase it is quite general among dioecious plant species that male individuals invest more in reproduction than females at flowering nicotra 1999 otero arnaiz and oyama 2001 rocheleau and houle 2001 torimaru and tomaru 2006 therefore the solution is consistent with observed patterns of dioecy then the optimal investment in male flowers xi and the optimal male ratio ri of the i th individual in the dioecious population is written as 8a x i 0 and r i 0 if 0 i i x i 8b x i i i and r i 1 if i i x i the solution x 1 x 2 xn is an edge nash solution because wi xi 0 at xi for any i third if 0 ii xi for i 1 k xi ii xi max for i k 1 k l and xi max ii for i k l 1 n three phases female male and hermaphrodite can emerge in the population figs 4e and 4f in masaka and takada 2006 this was named a monoecious population which was composed of hermaphroditic individuals only since a few female and male individuals sometimes coexisted in real populations therefore here we name it trioecy in a broad sense see fig 2 in juglans ailanthifolia juglandaceae and betula platyphylla var japonica betulaceae for example individual sex expression changes in order of female male and hermaphrodite with increasing reproductive resource see table 1 in masaka and takada 2006 masaka 2007 this order corresponds to the order observed in the solution fig 4f fourth if ii xi for i 1 k and xi max ii for i k 1 n are satisfied simultaneously k females and n k hermaphrodites will emerge in the population i e gynodioecy the optimal investment in male flowers and the optimal male ratios in the female and hermaphroditic phases of a gynodioecious population are written as 9a x i 0 and r i 0 if 0 i i x i i 1 2 k 9b x i x i max and r i x i max i i if i i x i max i k 1 n note that we assume i 1 i 2 in 1 in results of numerical calculation the type of sex expression that is the optimal solution depends on both the distribution of the reproductive investment ii and pollen transportation efficiency β the distribution of ii is influenced by the population size numerical analyses were conducted for various populations with different population structures four hypothetical populations were set up based on different population sizes n 11 21 41 and 81 ii 1 ii 280 for n 11 ii 1 ii 140 for n 21 ii 1 ii 70 for n 41 and ii 1 ii 35 for n 81 we set i 1 1600 in the four populations and they had the same average ii i i 3000 for a given β numerical calculations were conducted to obtain four types of nash solutions each corresponding to hermaphroditism dioecy trioecy or gynodioecy several mathematical conditions are used for each type of nash solution see appendix e when obtaining the hermaphroditic nash solution there are n hermaphroditic individuals in the population and the solution is x 1 x 2 xn x 1 max x 2 max xn max we obtained xi max using eq e1 and examined whether or not conditions e2 to e4 are satisfied if these conditions are not satisfied the cases were removed from the nash solution candidates when obtaining the dioecious nash solution we assume there are k females and l males in the population and the solution is that xi 0 for i 1 to k and xi ii for i k 1 to k l n there are n 1 dioecy solutions varying from k 1 to n 1 for each solution we obtained xi using eqs e7 and e8 in appendix e and examined whether or not conditions e9 and e10 are satisfied we removed the cases from the nash solution candidates if these conditions are not satisfied more than one solution could be found for each β similarly we obtained nash solutions for trioecy and gynodioecy see appendix e mathematica ver 10 wolfram research inc champaign il was used for the calculations from the above procedure used to obtain the nash solutions we identified two quantities that determine the optimal sex expression the switching point from the female phase to the male phase xi and the maximal point of fitness gain function xi max more than one xi and xi max were obtained for a given β because more than one nash solution was often found by the numerical analyses see fig e in appendix e multiple nash solutions are discussed in the discussion the numbers of male female and hermaphroditic individuals with respect to the β are shown in fig 5 for a variety of population sizes n 11 21 41 and 81 the nash solutions for dioecy appeared at a smaller β range than for hermaphroditism in all hypothetical populations appearance of male female and hermaphroditic individuals presented a unique trend along the β gradient in the sequence of nash solutions with respect to β the number of males in dioecy connected to that in trioecy trioecy was established by adding hermaphroditic individuals to dioecious population along with an increase of β males rather than females were likely to contribute to the establishment of hermaphroditic individuals see fig 5a the number of males in trioecious populations decreased with increasing β fig 5 consequently trioecy was replaced by gynodioecy conversely trioecy is established by adding males to gynodioecious population along with a decrease of β on the other hand the number of female individuals in gynodioecious population decreased with increasing β fig 5 consequently gynodioecy was replaced by hermaphroditism at the same time the result indicates that gynodioecy was established by losing male function in some hermaphroditic individuals in hermaphroditic population along with a decrease of β thus there were no intermittent transition in the sequence of solutions and smooth transition was observed depending on β the male investment ratio at population level s was close to s 0 5 in many cases fig 6 although the number of females tended to be greater than that of males in dioecy fig 5 the sequence of the male investment ratio tended to increase with increasing β in the large population of dioecy and the male ratio of trioecy and gynodioecy was larger than that of dioecy fig 6 in turn the male ratio tended to decrease with increasing β in hermaphroditism the male strategy is less effective when more pollen is lost due to low β but males of dioecy never produce any female flowers even if β is getting lower discussion in the present study various sex expressions were explained by a mathematical model pollen transport efficiency played an important role in obtaining solutions for many patterns of sex expression in our model dioecy emerged in the lower β range and the sex expression switched from dioecy to hermaphroditism with increasing β via trioecy and gynodioecy fig 5 this means that the solutions of trioecy and gynodioecy occupy intermediate range between those of hermaphroditism and dioecy we theoretically demonstrated the presence of a hermaphroditism dioecy continuum as an evolutionary solution role of two assumptions we made two crucial assumptions in our study i e individuals have different reproductive strategies and there is uncertainty in pollen efficiency the first assumption was necessary to model the variety of sex expression in plants if we used the assumption under traditional ess models i e all individuals in the population had a single population wide strategy that cannot be invaded by another strategy hamilton 1967 lloyd 1984 dioecy gynodioecy and trioecy with sex expression varying among individuals in the population could not be simultaneously explained therefore we used an n player game model based on the first assumption the second assumption is also necessary to explain the variation in plant sex expression if the pollen efficiency β is infinite there is no uncertainty in the pollen transport and the fitness gain function in eq 3 is simplified to 10 w i x 1 x 2 x n i i x i x i j 1 n x j j 1 n i j x j eq 10 is the same as the mathematical model proposed by yamaguchi 1985 that author proposed the n player game model to explain the sex ratio of an aphid population using empirical data the fitness gain curve of yamaguchi s model differs from that of our model in yamaguchi s model individuals with low investment resource allocated all their resources to the male function the male phase in this paper while individuals with high investment resource allocated their resources to both male and female functions the hermaphroditic phase in this paper in other words there are no individuals that fully invest into female function in yamaguchi s model though investing fully into female function is normal in dioecious plants the incorporation of β into our model was therefore required to establish female individuals in the breeding population therefore low transport efficiency was necessary to obtain the nash solutions for dioecy and gynodioecy multiple nash solutions for each β were often found in our model it is a well known characteristic of the nash solution that more than one solution can exist in game theory there were three parameter ranges of β where more than one solution occurred for a certain β fig 5 the ranges appeared in the transition zone from dioecy to trioecy from trioecy to gynodioecy and from gynodioecy to hermaphroditism that is the range of dioecious solutions partially overlapped with that of trioecious solutions as well as between trioecious and gynodioecious solutions and between gynodioecious and hermaphroditic nash solutions fig 7 only one nash solution occurred in dioecy and hermaphroditism figs 5 and e these results imply that co existence of unisexual and hermaphroditic individuals in the breeding population enables the occurrence of the multiple nash solutions exchange of male function with female function and vice versa between unisexual and hermaphroditic individuals at a given β is achieved by the occurrence of more than one xi and xi max here we should refer to androdioecy though we excluded it from the analysis in this study androdioecy in which male individuals coexist with hermaphroditic individuals in a population may be explained by our model as β eq 3 can be modified as eq 10 eq 10 has only one xi that satisfies w i x i x i x i 0 and individuals with ii xi invest only in males whereas individuals with ii xi invest in xi males and divert the remaining resource to females yamaguchi 1985 this scenario describes a breeding system analogous to androdioecy in plants however androdioecy also seems to depend on unreliable pollen vectors akimoto et al 1999 appanah 1982 there is a need to demonstrate the realistic androdioecious solution in future study massive investment compensates low pollen transport efficiency the low pollen transport efficiency low β values was the cause of the dioecy in the nash solution the low β is equivalent to low reliability of pollen vectors if pollination efficiency is low then more investment in male reproduction is required to ensure fertilization i e he who shoots often hits at last japanese proverb in fact wind pollinated species often form dense pollen clouds cf regal 1982 synchronized flowering so called masting or mast seeding can also alter pollen limitation in wind pollination kon et al 2005 norton and kelly 1988 similarly the fertilization of ovules in hydrophilous plants seems to be altered by synchronized flowering van tussenbroek et al 2016 plant species with abiotic pollination systems generally tend to have large pollen ovule ratios ackerman 2000 erbar and langlotz 2005 according to cruden 1977 the more efficient the transfer of pollen should be the lower the pollen ovule ratio should be nash solution of dioecy in low β fig 5 will lead to the hypothesis that individuals are favored to invest all their reproductive resource in male at individual level simultaneously it is better for the individuals to invest all reproductive resources into female function than to dedicate resources to only a few males because a few males cannot form a dense pollen cloud in wind pollination similarly for animal pollination opportunistic pollinators such as horseflies flies moths and beetles would not be expected to visit a few male flowers within a crown filled with many female flowers such opportunistic pollinators are not considered to be effective pollinators for pollen transportation matsuyama et al 2009 even if some insects visit a male flower on a female individual they may not visit a female flower afterwards furthermore any pollen grains that reach a stigma in this case will be numerically overwhelmed by pollen grains from other individuals we therefore consider that a female individual will not produce any male flowers as long as pollination efficiency is low thus massive investment into one sex at the individual level will compensate for the unreliability of pollination systems and also enhance pollen transfer between sexes consequently female and male individuals are established in the breeding population which is neither a failure for plants westergaard 1958 nor an evolutionary dead end heilbuth 2000 we propose that a dioecious breeding system is an adaptive solution to low pollination efficiency conditions on the other hand unfavorable or harsh environments have also been often associated with the dominance of dioecy over hermaphroditism for example echinocereus coccineus in the southwestern united states has both hermaphroditic populations and dioecious ones and the distribution of the latter is associated with areas of low hummingbird abundance related to low rainfall scobell and schultz 2005 an increase of dioecious dombeya spp sterculiaceae at high altitude was also documented on la réunion humeau et al 1999 barrett 1992 showed that dioecious populations of wurmbea dioica colchicaceae in western australia often occur in drier areas whereas hermaphroditic populations are found on moist localities hart 1985 also noted a correlation between dioecy and dry habitats in lepechinia spp lamiaceae in case of monoecy in the real hermaphroditism dioecy continuum costich 1995 described that dioecious ecballium spp cucurbitaceae live in habitats with drier summers than do monoecious phenotype on the iberian peninsula delph 1990 and renner and won 2001 demonstrated that dioecious populations occur at high altitude while monoecious populations confined into low altitude low reliability of animal pollen vectors can be induced by low activity due to the harsh environments bawa 1980 1982 and baker and cox 1984 noted the association of dioecy with tropical regions oceanic islands and perenniality these aspects can be explained by low pollination efficiency in dioecy first high species diversity in tropical regions immediately indicates a low abundance of each species whitmore 1990 under such conditions we can assume two options to enhance the pollen transfer 1 dependence on specialist pollinators such as bats birds or honeybees or 2 concentrated investment in one sex if the pollen vectors are very unreliable the former corresponds to hermaphroditism and the latter represents dioecy second many dioecious species are found on oceanic islands opportunistic pollinators such as solitary bees flies and small moths are typical pollen vectors on oceanic islands abe 2006 barrett 1996 sakai et al 1995a b often referred to as the island syndrome whittaker 1998 this implies a low β this condition would promote the evolution of dioecy on some oceanic islands at a higher rate than in other locations third perenniality will increase the chance of the pollination success of dioecious species over their long lifespan because annual species exhibits monocarpic reproduction we hypothesize that it is risky for annual plants to produce only male flowers if the plant depends on unreliable pollen vectors indeed dioecy is rather uncommon in annual plants pickup and barrett 2013 our model can explain the abundance of dioecy in tropical regions oceanic islands and perenniality reasonably hermaphroditism dioecy continuum in our model gynodioecy emerged at the transition zone in the hermaphroditism dioecy continuum figs 5 and 7 it has been suggested that the evolution of dioecy from hermaphroditism is often achieved via gynodioecy barrett and crowson 2016 dorken and barrett 2004 dufay et al 2014 käfer et al 2017 spigler and ashman 2012 the invasion of females into hermaphroditic populations is the first step leading to gynodioecy barrett and crowson 2016 similarly in our model gynodioecy is established by losing male function in some hermaphroditic individuals figs 5 and 7 female advantage over a hermaphrodite has been considered to be main driver of evolution of gynodioecy i e more flowers more fruits more seeds and or better germination dufay and billard 2012 shykoff et al 2003 conversely spigler and ashman 2012 have asserted that females can more easily gain the seed fertility advantage needed to invade hermaphroditic populations if hermaphrodites reduce their allocation to female function in favor of male function in addition ashman 1999 and dorken and pannell 2009 have posited that the presence of females results in selective pressures on hermaphrodites leading to selection for enhanced male sexual characteristics see also charlesworth 1989 in fact sinclair et al 2016 have shown that the mating system of daphne jezoensis in northern japan is functionally close to a dioecious mating system i e strongly male biased hermaphroditism in our model the maximal point of the fitness gain function xi max increases with decreasing β fig e which indicates that hermaphroditic individuals enhance their allocation to male function under low β male function is thus also favored by hermaphroditic individuals under low pollination efficiency in our model however except alonso 2005 there are few arguments about the establishment of gynodioecy linked with the pollen transport efficiency and the environment of habitat gynodioecious species are often observed in the plants that bloom in winter or early spring e g daphne spp thymelaeaceae kikuzawa 1989 alonso 2005 stachyurus praecox stachyuraceae abe 2007 geranium maculatum geraniaceae van etten et al 2008 nemophila menziesii hydrophyllaceae ganders 1978 activity of dominant specialist pollinators such as bumblebees is not so high in early spring abe 2007 in silene spp caryophyllaceae night flying moths are the main pollinators dulberger and horovitz 1984 or the insect visitors are scarce talavera et al 1996 anemophilous gynodioecy has been found at the windswept habitat dufay et al 2009 koelewijn and van damme 2005 waller and sakai 2005 iris douglasiana iridaceae is gynodioecious species although this species depends on the specialist pollinators uno 1982 douglas iris is found at the coastal region in which low temperature and strong wind seems to reduce the activity of the insects cf uno 1982 furthermore harsh environment can be linked with the increase of female individuals in the population e g higher altitude and drier environment ashman 2006 delph 2003 vaughton and ramsey 2004 alonso 2005 and alonso and herrera 2001 have discovered a negative relationship between elevation and the number of female individuals in spurge laurel daphne laureola populations in southeastern spain in mediterranean areas summer drought is a critical factor for plant recruitment and is severe at lower elevations with hotter summers alonso and herrera 2001 spurge laurel is scarcest at lower elevations where the smallest populations occur alonso and herrera 2001 alonso 2005 has reported that female disadvantage in pollination success increases with elevation but the opposite is also true namely female advantage in pollination success is increased at lower elevations we believe that this is the reason why female spurge laurel plants are predominant at lower elevations in addition to having a low population density at lower elevations flowering period of spurge laurel is winter and the nitidulid beetles solitary bees and noctuid moths are the ordinary pollinators alonso 2005 a low population density together with opportunistic pollinators in winter should result in a very low pollination efficiency and may facilitate female invasion into hermaphroditic populations of spurge laurel in southeastern spain we note that inbreeding avoidance is not able to explain the high proportion of female individuals in spurge laurel populations alonso and herrera 2001 see also dufay and billard 2012 the establishment of a gynodioecious nash solution at a lower β range than that of the hermaphroditic solution in our model fig 5 corresponds to the situation in reality similar to gynodioecy trioecy emerged at the transition zone in the continuum figs 5 and 7 barrett and crowson 2016 consider subdioecy to be an intermediate stage between gynodioecy and dioecy subdioecy which has thus arisen from gynodioecy via the loss of female function in hermaphroditic individuals can also arise from dioecy when males begin to add female functionality barrett and crowson 2016 cf cossard and pannell 2019 hereafter we use the term trioecy instead of subdioecy see the caption of fig 1 in our model the trioecious nash solution is derived if some hermaphroditic individuals not all in a gynodioecious population are replaced by male individuals fig 5 according to ashman 2006 high frequencies of females may select for increased maleness of hermaphrodites in fragaria virginiana rosaceae if the frequency of females increases or pollinator visits decline pollen limitation becomes more likely and hermaphroditic individuals experience frequency dependent selection for enhanced male function ashman 2006 in our model hermaphroditic individuals are replaced by males as the proportion of females increase and β decreases fig 5 which implies that both the frequency of females and the uncertainty of pollination efficiency play vital roles in the evolution of trioecy from gynodioecy at the same time males rather than females contribute to the breakdown of dioecy into trioecy in our model fig 5 most dioecious species exhibit inconstant sex expression and males tend to show leaky sex expression far more than females cossard and pannell 2019 del blanco et al 2019 also seec delph 2009 this inconstancy is advantageous when mates are limiting as inconstant males but not females benefit from the ability to self pollinate in the absence of mates cossard and pannell 2019 since strict trioecy is rare ainsworth 2000 however far less information than gynodioecy is available about the pollination ecology in trioecy for example coccoloba cereifera polygonaceae occurs at high altitude in southeastern brazil and low number of small hymenopterans visit the small flowers 3 mm in diameter silva et al 2008 though trioecious nash solutions occurred subsequently to gynodioecious nash solutions with the decrease of β in our model figs 5 and 7 a counterexample may be found according to fleming et al 1998 the sonoran desert columnar cactus pachycereus pringlei cactaceae in mexico exhibits trioecy near the roosts of chiropteran pollinators whereas gynodioecy occurs 50 km from the bat roosts the authors argued that the low frequency of bat visitation i e low β was associated with the establishment of gynodioecious population trioecy in our study involves monoecy to some extent since a few female and male individuals are sometimes observed in monoecy see fig 2 masaka and takada 2006 masaka 2007 also see jordano 1991 compared with hermaphroditism monoecious species often adopt unreliable pollen vectors such as wind and opportunistic pollinators e g charlesworth 1993 vamosi et al 2006 therefore there is little discrepancy between the establishment of trioecy with respect to low β in our model and in reality based on the ecological traits of dioecy described above we propose a schematic diagram model for the hermaphroditism dioecy continuum as shown in fig 8 change of sex expression with respect to β corresponds appropriately to the performance of pollen vectors i e water must be the most unreliable pollen vector lower β and a specialist pollinator is the most reliable pollen vector higher β the schematic model indicates that dioecy is the extreme phenotype under unfavorable reproductive conditions since there is a lower limit in β 0 although hermaphroditism and monoecy cannot be distinguished mathematically in our model monoecy can be placed between hermaphroditism and trioecy fig 8 the reason for this placement is that monoecy unisexual flowers is considered to have evolved from hermaphroditism in response to pollinator limitation and changes in the abiotic environment culley et al 2002 friedman and barrett 2009a b unisexual flowers are strongly associated with abiotic pollen vectors and opportunistic pollinators charlesworth 1993 furthermore trioecy can partially include monoecy as unisexual individuals are sometimes found in monoecious species masaka and takada 2006 moreover a dioecious solution was obtained without consideration for the inbreeding depression even in our model that allows for self fertilization our approach using the n player game departs from the darwinian paradigm in evolutionary ecology which is the view that the evolution of dioecy from hermaphroditism is explained by various aspects of the interactions between environment and species specific characters our model is based on numerical interactions between and within individuals i e the fitness gain of each sex depends on local mates and a trade off exists between sexes under limited reproductive resources furthermore pollen transportation between individuals was assumed to be uncertain nevertheless a hermaphroditism dioecy continuum was derived although the hermaphroditism dioecy continuum in our model can be explained without consideration of genetic characters such as inbreeding depression and dichogamy pollen transport efficiency in our model will correspond to the ability or activity of the pollen vectors fig 8 β will be the neutral index that enables us to compare the performance of pollen vectors among habitats such as unfavorable or harsh environments contributors the first author hit on an idea to build the model and interpreted the results from the view point of reproductive ecology while the second author probed the analysis of the model from the view point of the mathematical ecology whichever we conducted the study always together declaration of competing interest this study was supported by grants in aid for scientific research 20k06821 japan society for the promotion of science jsps there is no conflict relationship with other researchers and organizations acknowledgment the authors thank three anonymous reviewers for critical comments on previous versions of the manuscript this study was supported by grants in aid for scientific research 20k06821 japan society for the promotion of science jsps appendix a the i th fitness gain function w i x 1 x 2 x n the function is w i x 1 x 2 x n i i x i x i 1 e β x i x j 1 e β x j j 1 n i j x j eq 3 in the main text and w i x i 0 i i the first derivative of eq 3 is w i x i 1 x i 1 e β x i x j 1 e β x j j 1 n i j x j e 1 e β x i β x i e β x i x j 1 e β x j 2 eq 4 in the main text where e j i x j 1 e β x j 0 therefore w i x i x i 0 1 the 1 is derived from the property of female reproductive success fi i e i i x i the functional form is followed by the studies of hamilton 1967 lloyd 1984 and yamaguchi 1985 the female reproductive success in an individual decreases as the male investment x i increases therefore in case of female reproductive success the change in fitness with an increase in investment in male function does not depend on the investment of other individuals in contrast the male reproductive success mi depends on the investment of other individuals and increases with x i because mi xi 0 and 2 mi xi 2 0 when xi 0 when xi is small the degree of increase in male reproductive success is not so large enough to compensate for the negative effect derived from i i x i therefore the fitness gain curve wi initially decreases and increases when x i becomes large enough the second derivative of eq 3 is 2 w i x i 2 2 e 1 e β x i β x i e β x i j x j 1 e β x j 2 1 j i j x j 1 e β x i β x i e β x i j x j 1 e β x j β e j i j x j e β x i 2 β x i j x j 1 e β x j 2 therefore 2 w i x i 2 x i 0 2 β j 1 n i j x j e 0 and 2 w i x i 2 x i 2 β 2 e 1 e 2 j x j 1 e β x j 2 1 j i j x j 1 e 2 j x j 1 e β x j 0 appendix b proof that there are at most two positive x i s from eq 3 it s obvious that w i is equal to i i when xi 0 we prove there are at most two positive x i s that satisfy w i x i i i i e i i x i x i 1 e β x i j 1 n x j 1 e β x j j 1 n i j x j i i it can be written as x i 1 1 e β x i j 1 n x j 1 e β x j j 1 n i j x j 0 thus the positive x i satisfies the following equation 1 1 e β x i j 1 n x j 1 e β x j j 1 n i j x j 0 i e b1 j 1 n x j 1 e β x j 1 e β x i j 1 n i j x j extracting x i in the summation symbols explicitly we rewrite eq b1 as follows x i 1 e β x i j i x j 1 e β x j 1 e β x i i i x i j i i j x j x i 1 e β x i e 1 e β x i d x i where e j i x j 1 e β x j 0 and d i i j i i j x j 0 d and e do not include x i eventually we obtain b2 d 2 x i e 1 e β x i defining the r h s of eq b2 as a function of x i g x i e 1 e β x i 0 from the first derivative i e g x i e β e β x i 1 e β x i 2 0 the function decreases monotonously from g 0 furthermore from the second derivative i e g x i e β 2 e β x i 1 e β x i 1 e β x i 3 0 the function g is a downward convex curve with asymptote e as shown in fig b the intersection of g x i and the line of d 2 x i is the positive solution of x i that satisfies eq b2 therefore depending on e and d there are two cases on the number of positive solutions i no solution and ii two positive solutions see fig b the second x i is denoted as x i x i x i in the main text there is a single positive solution as an exceptional case where the straight line is tangent to the function g for simplicity we do not discuss the case here appendix c the fitness gain curve has at most two extremum points from eq 4 the first derivative of the fitness gain curve is zero at the extremums 1 x i 1 e β x i x j 1 e β x j j 1 n i j x j e 1 e β x i β x i e β x i x j 1 e β x j 2 0 simplifying the equation we obtain the following equation c1 2 x i 1 e β x i 2 3 e x i 1 e β x i e 2 d x i e 1 e β x i β x i e β x i defining the l h s of eq c1 as m x i 2 x i 1 e β x i 2 3 e x i 1 e β x i e 2 and the r h s of eq c1 as l x i d x i e 1 e β x i β x i e β x i we have m 0 e 2 m the first derivative is m x i 4 x i 1 e β x i 1 e β x i β x i e β x i 3 e 1 e β x i β x i e β x i 1 e β x i β x i e β x i 4 x i 1 e β x i 3 e 0 therefore m 0 0 and m and m x i is a monotonous increasing function of x i when x i is positive furthermore the second derivative is c2 m x i β e β x i 2 β x i 4 x i 1 e β x i 3 e 4 1 e β x i β x i e β x i 2 because the first term of l h s of eq c2 is positive for 0 x i 2 β and the second term is positive m xi is positive for 0 x i 2 β the inflection point of m x i is larger than 2 β if there exists the inflection point b such that m b 0 i e b 2 β therefore m x i is a downward convex curve in the range of 0 x i 2 β fig ca from l xi we have l 0 0 l d 0 the function v xi 1 e β x i β x i e β x i in the function l xi is a unimodal positive function passing the origin 0 0 with the asymptote 1 and the local maximum at xi 2 β fig cb w xi d x i e is a linearly decreasing function and thus the product of these two functions in l xi is a unimodal function and zero when x i 0 and d fig cb we firstly examine l x i when d 2 β the first derivative of l x i is as follows l x i e 1 e β x i β x i e β x i e d x i β 2 β x i e β x i and l 2 β 0 therefore it has the maximum at x i in the range of 0 x i 2 β i e x i 2 β fig cb furthermore the second derivative l x i 2 e β 2 β x i e β x i e β 2 d x i 3 β x i e β x i is negative in the range of 0 x i x i because of x i 2 β eventually m xi is a downward convex curve in the range of 0 x i x i and l xi is an upward convex curve in the same range the point xi xi tan that satisfies m x i tan l x i tan and m x i tan l x i tan simultaneously is a tangent point fig cc the number of the intersection is one at that tangent point there is no intersection if m xi moves upward from the tangent point and it has two intersection points if m xi moves downward from the tangent point fig cd because of b 2 β fig ca the number of intersections of m x i and l x i is at most two figs cc and ce we can examine l x i when d 2 β similarly and obtain the same conclusion appendix d the male investment ratio should be less than 1 2 we can obtain the positive xi that satisfy wi xi ii using eq b1 b1 j 1 n x j 1 e β x j 1 e β x i j 1 n i j x j it can be written as t 1 e β x i 1 s where s is male investment ratio σxj σij and t x j 1 e β x j i j then xi can be written as x i 1 β l n 1 s 1 t s furthermore the r h s of the equation 1 β l n 1 s 1 t s is less than 1 β l n 1 s 1 2 s because 0 t s 1 therefore s has to be less than ½ when we obtain a positive xi appendix e mathematical conditions used to obtain the nash solutions numerically for the hermaphroditic solution in case of hermaphroditism only hermaphroditic individuals exist in a population the interior nash solution should be obtained by satisfying the following four conditions for all i e1 w i x i x i x i max 0 e2 2 w i x i 2 x i x i max 0 e3 x i max i i e4 w i x i max i i for the dioecy solution considering a nash solution with k females and l males in the dioecious population n k l then the nash solution is x 1 x 2 x k x k 1 x n 0 0 i k 1 i k l this is because the individuals with low investment resource are likely to show female in real dioecious plants indeed male individuals of dioecious plant species often allocate significantly more biomass number to reproductive organs than females at flowering nicotra 1999 otero arnaiz and oyama 2001 rocheleau and houle 2001 torimaru and tomaru 2006 from eq 3 and eq b1 the switching point xi satisfies e5 j x j 1 e β x j 1 e β x i j i j j x j to obtain xi which satisfies eq e5 under the condition that other xj s j i are at the nash solution we substituted xj 0 for j 1 to k 1 and xj ij for j k 1 to n except xi into eq e5 i when i 1 to k 1 the left hand side of eq e5 is e6 0 x i 1 e β x i j k 1 n i j 1 e β i j in addition the right hand side of eq e5 is 1 e β x i j i j 0 x i j k 1 n i j here j k 1 n i j 1 e β i j and j k 1 n i j are conveniently rewritten by c and c respectively from eqs e5 and e6 we obtain e7 x i 1 e β x i c 1 e β x i j i j c x i ii when i k 1 to k l the switching point is given by e8 1 e β x i j i j c i i x i x i 1 e β x i c i i 1 e β i i eventually for a nash solution with k females and l males the following conditions should be achieved e9 x i i i and w i x i x i x i 0 for i 1 2 k because the optimal investment for male flowers is zero under the condition furthermore e10 x i i i x i max and w i x i x i x i 0 for i k 1 to k l because the optimal investment into male flowers is ii under the condition if either eq e9 or e10 is not satisfied then the nash solution with k females and l males does not exist for the trioecy solution trioecy contains hermaphroditic individuals with some unisexual individuals in the population the conditions for hermaphroditic individuals with some unisexual individuals in the population should be given assuming there are k females l males and m hermaphroditic individuals n k l m as follows e9 for i 1 2 k e10 for i k 1 k 2 k l e1 to e4 for i k l 1 to n for the gynodioecious solution the gynodioecy contains both female and hermaphroditic individuals in the breeding population for a nash solution with k female and l hermaphroditic individuals eq e9 for i 1 2 k should be satisfied to obtain solution of females conversely to obtain solution of hermaphroditic individuals eqs e1 to e4 for i k 1 to k l should be satisfied as an example sequence of the maximal point of fitness gain function xn max of n th individual were shown in fig e more than one xn max were obtained for a given β there was one xn max for dioecious and hermaphroditic nash solutions at a given β whereas there were some xn maxs for trioecious and gynodioecious nash solutions 
