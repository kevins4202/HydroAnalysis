index,text
2070,reliable runoff prediction plays a significant role in reservoir scheduling water resources management and efficient utilization of water resources to effectively enhance the prediction accuracy of monthly runoff series a hybrid prediction model tvf emd ssa elm combining time varying filtering tvf based empirical mode decomposition emd salp swarm algorithm ssa and extreme learning machine elm is proposed firstly the monthly runoff series is decomposed into several sub series using tvf emd secondly ssa is used to optimize the input weights and hidden layer biases of the selected elm model finally the prediction results are generated by summing and reconstructing each sub series based on the ssa optimized elm model this hybrid model is applied to the monthly runoff prediction of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station and compared with back propagation bp elm ssa elm pso elm gsa elm tvf emd elm emd ssa elm extreme point symmetric mode decomposition esmd ssa elm wavelet decomposition wd ssa elm and complete ensemble empirical mode decomposition with adaptive noise ceemdan ssa elm models the prediction performance of various models is reflected by four evaluation indicators r nsec nrmse mape results reveal that the prediction effect of the elm model is better than that of bp the optimization accuracy of ssa is better than those of particle swarm optimization pso and gravitational search algorithm gsa and the prediction accuracy of the hybrid tvf emd and ssa is better than that of only tvf emd or ssa tvf emd ssa elm model has the highest prediction accuracy when compared with the single elm model it s nrmse and mape at manwan hydropower decrease by 84 4 and 72 38 those of hongjiadu hydropower decrease by 85 21 and 78 38 and those of yingluoxi hydrological station decrease by 68 42 and 39 51 respectively r and nsec of the three sites are close to 1 therefore the proposed model provides a new method for the prediction of monthly runoff and the results can provide a reference for the prediction of monthly runoff in the study area keywords monthly runoff prediction extreme learning machine elm time varying filtering tvf empirical mode decomposition emd salp swarm algorithm ssa data availability the authors do not have permission to share data 1 introduction accurate and reliable medium and long term runoff predictions are very important for the optimal allocation of water resources li et al 2022b li et al 2023b wang et al 2017 wu and liu 2022 yan et al 2022 zhou et al 2015 optimization of reservoir operation ehteram et al 2021 meema et al 2021 yao et al 2022 zhu et al 2022 flood control su et al 2022 wu et al 2022 zhang et al 2020 zhao et al 2022 power generation cai et al 2020 tang et al 2010 zhao et al 2023 drought resistance aksoy and dahamsheh 2018 bae et al 2017 zhang et al 2023 and ecological restoration cao et al 2022 duan et al 2022 feng et al 2020a xia et al 2019 however runoff series are susceptible to many uncertainties and exhibit non linear and non stationary features which make it difficult for relevant departments to make runoff predictions he et al 2023 zhao and zhao 2014 therefore constructing an accurate and reliable runoff prediction model to enhance the prediction accuracy of runoff series has received extensive attention from hydrologists at present runoff forecast models may be roughly classified into two categories process driven models and data driven models adnan et al 2021 parisouj et al 2020 process driven models usually depend on a large number of reliable data but there is usually a lack of data in many regions of the world which cannot meet the requirements of modeling meanwhile process driven models also require a large amount of computation and the modeling process is complicated in contrast data driven models can simplify complex problems make modeling processes simple and efficient and the internal relationship between data can be deeply explored it can provide satisfactory prediction performance for hydrological forecasting in areas where data are lacking therefore data driven models have become increasingly popular over the years many data driven models have been applied in the field of runoff forecast such as artificial neural network ann ikram et al 2022 tareke and awoke 2023 wang et al 2015b support vector machine svm feng et al 2020b huang et al 2014 long short term memory neural network lstm xu et al 2022 gated recurrent unit gru gao et al 2020 zhao et al 2021 and extreme learning machine elm feng et al 2021 wen et al 2019 yue et al 2020 with the use of advanced technology and new materials by researchers people s lives are constantly being improved rezayeenik et al 2022 salehi et al 2016 zinatloo ajabshir et al 2020a zinatloo ajabshir et al 2020b zinatloo ajabshir et al 2017 zinatloo ajabshir et al 2019 among them the use of artificial intelligence technology is more prominent ann svm lstm and other prediction models have been widely used in various fields and runoff prediction ezzahra yatim et al 2022 geetha et al 2022 li et al 2023a lu et al 2023 wang et al 2009 wang et al 2023d but they all have shortcomings and deficiencies bp is based on gradient descent which is easy to fall into the local minimum problem and the algorithm needs many iterations so the overall efficiency is not high the svm training process is time consuming sensitive to parameters and has poor performance in large sample prediction lstm model has good predictive performance but it has some defects such as large memory consumption and long running time elm is a kind of learning algorithm developed in recent years which has been widely used in different scientific fields due to its advantages of simple parameter setting high learning efficiency and strong generalization performance elm was applied by anicic et al 2017 to predict the heat affected zone haz and results showed that the elm model could provide better prediction performance abdullah et al 2015 used elm to predict reference evapotranspiration for three major meteorological stations in northern central and southern iraq which reflected the simplicity high speed and good generalization performance of elm gao et al 2022b used elm to forecast electricity demand in the mid term for three provinces in china which played an important role in ensuring the safety of power operations zhang et al 2022 applied elm to determine the brittleness index of shale asteris et al 2022 used elm to predict the compression index of clay which was important for determining the degree of soil improvement wang et al 2023b used elm to predict the concentrations of blood glucose cholesterol and triglyceride in human blood samples and coupled it with raman spectroscopy to quickly and accurately determine blood components wu et al 2021 combined elm with three meta heuristic algorithms to predict reference crop evaporation which was of great significance for regional water resources management for the past few years elm has been gradually used by hydrologists for runoff prediction and has achieved fruitful research results li and cheng 2014 niu et al 2020b wang et al 2019 therefore the elm model is selected in this study to develop a monthly runoff prediction model in practical applications elm may fall into local optimum due to the random selection of input weights and hidden layer biases moreover it is often difficult for a single prediction model to achieve satisfactory prediction results because runoff series are easily affected by uncertain factors therefore the performance of runoff prediction still has some room for improvement at present scholars have proposed a hybrid prediction model which has better forecasting performance than a single prediction model and has become a new trend in hydrological prediction adnan et al 2021 qin et al 2019 a hybrid prediction model is usually composed of two ways one is to use a decomposition method to pre process the original runoff series to improve the prediction performance feng et al 2022b the other is to use an intelligent optimization algorithm to optimize model parameters to improve the predictive performance of the model niu et al 2020b table 1 shows runoff prediction studies in recent years using data preprocessing techniques and optimization algorithm strategies the decomposition methods that have emerged include emd esmd yue and li 2020 ceemdan vmd xie et al 2019 wd and tvf emd bai et al 2023 zhao et al 2017 combined emd and least squares support vector machine lssvm based on chaos theory to predict the annual runoff of four hydrological stations in the upper reaches of fenhe river basin and the results proved that emd effectively improved the prediction accuracy however mode mixing still exists after emd decomposition for this reason torres et al 2011 improved emd and used the idea of adding white noise to eemd to reduce mode aliasing and proposed ceemdan wang et al 2023a combined ceemdan with artificial intelligence model to effectively improve the accuracy of runoff prediction showing that the hybrid model played an important role in improving the forecast results ceemdan effectively solved the mode mixing problem but required proper selection of parameters and constant cutoff frequency making the series not time varying wang et al 2021 studied the combination of esmd and sample entropy based wpd data pre processing methods with lstm to predict annual runoff in seven regions of china and achieved better results however the results showed that a single esmd could not handle the nonlinearity of the series well and did not have high frequency separation performance seo et al 2018 proposed to combine vmd with different models to build a variety of hybrid models and their results showed that the prediction accuracy was effectively enhanced after vmd was introduced and the study showed that the decomposition method was effective in improving the accuracy of runoff prediction zuo et al 2020 combined vmd with lstm to predict the daily runoff of jinghe river and hanjiang river in china and compared it with the integrated model of eemd and dwt results showed that vmd was superior to eemd and dwt in addressing non linear and non stationary conditions many studies have proved that vmd has strong robustness to noise and can effectively avoid mode mixing to achieve satisfactory performance but its drawback is that it needs to determine the appropriate parameters to achieve satisfactory decomposition effect to overcome the shortcomings of the above decomposition techniques this paper adopts tvf emd to pre process the runoff series tvf emd is an improvement of emd and uses non uniform b spline approximation as time varying filter to adaptively design local cutoff frequency compared with existing methods the mode mixing problem can be effectively solved while maintaining the time varying characteristics that ceemdan and vmd do not have and still has good performance at low sampling rate chen et al 2020 applied tvf emd to the monthly runoff prediction of baishan reservoir and achieved satisfactory prediction results with significant improvement in reducing runoff prediction errors song et al 2021 combined three decomposition methods with enn to build three models for precipitation prediction at different weather stations and results showed that the tvf emd enn model had the best prediction effect and tvf emd was more suitable for dealing with non stationary and non linear series jamei et al 2023 proposed a multi decomposition model based on tvf emd to predict monthly precipitation in the himalayan region of india effectively improving the prediction accuracy of three data driven models intelligent optimization algorithms are used to optimize model parameters and can improve the prediction performance of the model at present particle swarm optimization pso kumar et al 2019 firefly algorithm fa das et al 2019 gravitational search algorithm gsa banadkooki et al 2020 grey wolf optimizer gwo zhao et al 2021 and whale optimization algorithm woa shang et al 2020 etc have been used to optimize model parameters and obtain higher forecasting accuracy the sparrow search algorithm was used by feng et al 2022a to optimize the structural parameters of elm compared with the standard elm model the proposed method significantly improved four evaluation indicators in training and testing periods cheng et al 2020 combined the gwo with elm to predict the monthly runoff of the three gorges reservoir and obtained better prediction results samantaray et al 2022 used svm based on ssa to predict monthly runoff in the baitarani river basin the results of four indicators showed that the hybrid model had better prediction accuracy compared with the traditional model ssa is a new optimization algorithm inspired by the behavior of salp in the ocean this optimization algorithm has a simple structure and a relatively fast convergence speed which can well reduce the situation of falling into local optima however elm model may be prone to local optima due to random selection of initial parameters therefore ssa is used in this paper to find the optimal parameters of elm model in order to improve the elm prediction performance currently hydrologists are increasingly interested in combining two strategies to improve runoff prediction accuracy to a greater degree a hybrid prediction model coupled with vmd and lstm optimized by gwo was proposed by li et al 2022a and the proposed model achieved the best prediction accuracy for the monthly runoff of xinfengjiang reservoir and guangzhao reservoir niu et al 2020a proposed a hybrid prediction model optimized by elm based on vmd and gravitational search algorithm gsa to effectively improve the prediction accuracy of runoff of large hydropower in china therefore in this study a novel tvf emd ssa elm monthly runoff prediction model is proposed by coupling time varying filtering based empirical mode decomposition salp swarm algorithm and extreme learning machine this model is then compared with seven benchmarking models providing a new approach for current runoff prediction the main contributions of this study are summarized as follows 1 a hybrid tvf emd ssa elm prediction model is proposed which can provide reliable results for monthly runoff prediction 2 because of the strong randomness caused by input weights and hidden layer biases of traditional elm ssa is optimized to enhance the generalization ability and prediction performance of the elm 3 the model developed in this paper and ten benchmarking models are applied to the monthly runoff prediction of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station four evaluation indicators verify the superiority of the proposed method the rest of this paper is arranged as follows section 2 introduces the methods of tvf emd ssa elm tvf emd ssa elm model and indicators for evaluating model performance section 3 presents the study area and dataset section 4 introduces detailed information on model inputs and decomposition results section 5 analyses and discusses the prediction results of different models finally section 6 summarizes the conclusions of this paper 2 methodology and evaluation indicators 2 1 tvf emd tvf emd was proposed by li et al 2017 which is an improvement of emd and effectively solves the mode mixing problem existing in emd the basic idea is very simple that is to determine the local cutoff frequency and then perform time varying filtering on the signal the specific steps of the tvf emd method are as follows step 1 hilbert transform is used to compute the instantaneous amplitude a t and instantaneous frequency φ t of the runoff series x t and the computation formula is as follows 1 a t x t 2 x t 2 2 φ t d arctan x t x t dt where x t is the hilbert transform of runoff series x t step 2 determine the local maximum a t max and minimum a t min values of instantaneous amplitude a t step 3 interpolate a t min and a t max to get curves β 1 t and β 2 t respectively and then compute the instantaneous mean value a 1 t and instantaneous envelope a 2 t and the computation formula is as follows 3 a 1 t β 1 t β 2 t 2 4 a 2 t β 2 t β 1 t 2 step 4 interpolate φ t min a 2 t min and φ t max a 2 t max respectively to get η 1 t and η 2 t and then compute φ 1 t and φ 2 t as follows 5 φ 1 t η 1 t 2 a 1 2 t 2 a 1 t a 2 t η 2 t 2 a 1 2 t 2 a 1 t a 2 t 6 φ 2 t η 1 t 2 a 2 2 t 2 a 1 t a 2 t η 2 t 2 a 2 2 t 2 a 1 t a 2 t step 5 compute the local cutoff frequency φ bis t as follows 7 φ bis t φ 1 t φ 2 t 2 step 6 rearrange φ bis t to solve the intermittent problem step 7 the signal h t cos φ bis t d t is defined the extreme value point of h t is taken as the node and the runoff series is approximated by b sample interpolation the approximation result is m t representing the local mean curve step 8 compute cutoff criterion θ t if θ t ξ x t is judged to be an imf otherwise make x 1 t x t m t repeat steps 1 to 8 the computation formula up to cutoff criterion θ t is as follows 8 θ t b loughlin t φ avg t 9 b loughlin t a 1 2 t a 2 2 t a 1 2 t a 2 2 t a 1 2 t a 2 2 t φ 1 2 t φ 2 t 2 a 1 2 t a 2 2 t 2 10 φ avg t a 1 2 t φ 1 2 t a 2 2 t φ 2 t a 1 2 t a 2 2 t where b loughlin t is the loughlin instantaneous bandwidth of two component signals φ avg t is the weighted average instantaneous frequency of a single component after the decomposition of the above steps the value of the original runoff series x t is the sum of all mode components x i t 2 2 ssa ssa is a meta heuristic swarm intelligence optimization algorithm proposed by mirjalili et al 2017 the algorithm simulates the aggregation behavior of salp which consists of two types of salps namely leaders and followers to form salp chains and then prey and move the leader is located at the front of the chain and is responsible for global exploration while the follower is responsible for local search which greatly reduces the situation of falling into local optimization hu et al 2021 in ssa the position of each salp individual is defined as a d dimensional vector then the chain x connected by n salp can be regarded as a population therefore the salp population is a n d matrix which can be expressed as 11 x x 1 1 x 2 1 x d 1 x 1 2 x 2 2 x d 2 x 1 n x 2 n x d n the i th salp individual is expressed as x i x 1 i x 2 i x d i the leader is the first vector in a matrix x and is responsible for searching for food to lead the movement direction of the whole group its position update formula is as follows 12 x j 1 f j c 1 u b j l b j c 2 l b j c 3 0 5 f j c 1 u b j l b j c 2 l b j c 3 0 5 where x j 1 is the position of leader in the j dimensional space f j is the position of food in the j th dimensional space u b j and l b j are the upper and lower boundaries of the j th dimensional space respectively parameters c 2 and c 3 are randomly generated within 0 1 which determine the length and direction of the leader s movement a population s exploration ability is mainly controlled by c 1 which is related to the number of undergone iterations its formula is as follows 13 c 1 2 e 4 t t max 2 where t and t max are the current and maximum iteration times respectively the location update formula of followers is 14 x j i t 1 2 x j i t 1 x j i 1 t 1 where x j i t is the location of the i th salp follower in the j th dimensional space at the t th iteration 2 3 elm elm was proposed by huang et al 2006 which could effectively solve the problems of slow learning rate and long iteration time of feedforward neural networks the algorithm simply generates input weights and hidden layer biases randomly before training and does not need to be adjusted after setting and output weights are determined once by solving the equation without iterative generation its benefits over other traditional training algorithms include easy parameter selection quick computation and high generalization capabilities the configuration of the elm is shown in fig 1 its basic theory is described as follows for n randomly different samples x i t i where x i x i 1 x i 2 x in t r n t i t i 1 t i 2 t im t r m g x is defined as the activation function and l as the number of hidden layers in order to make the output error free the output function of elm is 15 i 1 l β i g ω i x j b i t j j 1 2 n where ω i ω i 1 ω i 2 ω in t is the weight matrix between input and hidden layers β i β i 1 β i 2 β im t is the output weight matrix between hidden and output layers b i is the bias of the i th hidden layer neuron eq 15 is expressed by the matrix as follows 16 h β t where h is the output matrix of the hidden layer β is the output weight matrix t is the target matrix of sample set below is a specific form 17 h ω 1 ω l b 1 b l x 1 x l g ω 1 x 1 b 1 g ω 2 x 1 b 2 g ω l x 1 b l g ω 1 x 2 b 1 g ω 2 x 2 b 2 g ω l x 2 b l g ω 1 x n b 1 g ω 2 x n b 2 g ω l x n b l n l β β 1 t β l t l m t t 1 t t l t n m in view of the fact that input weights and biases for hidden layers are given at random h is turned into a deterministic matrix making the training process to solve the least square solution of the output weight matrix and the output matrix is 18 β h t where h is the moore penrose generalized inverse matrix of the hidden layer s output matrix 2 4 proposed model due to the influence of various uncertain factors the runoff series usually presents the characteristics of non linear and non stationarity it is difficult to capture the characteristics of runoff series using a single elm model and the data preprocessing technology can well reduce the non stationarity of runoff series in practical applications the random selection of elm input weights and hidden layer biases have a great influence on elm prediction performance feng et al 2019 in order to improve the prediction accuracy of monthly runoff series a hybrid prediction model tvf emd ssa elm is proposed in this paper in this model the tvf emd method is first used to stabilize the runoff series and then input weights and hidden layer biases of elm are optimized using ssa then the elm model with optimized parameters is used to predict the stabilized sub series finally the prediction results of each sub series are superimposed and reconstructed to obtain the final prediction results the flow chart of the tvf emd ssa elm hybrid prediction model is shown in fig 2 and the specific steps are as follows step 1 decomposition tvf emd is used to decompose the original runoff series into several sub series step 2 determination of input variables model input variables are determined based on the autocorrelation coefficient acf and partial autocorrelation coefficient pacf step 3 data manipulation the original runoff series are divided into training sets and testing sets and all data are normalized by the following formula which is limited between 0 1 to accelerate the convergence speed of the model 19 x i x i x min x max x min where x i is the i th input value in the sample sequence x max and x min are the maximum and minimum values in the sample respectively x i is the i th input value corresponding to the normalized sample sequence step 4 establishment of the ssa elm model step 4 1 determination of the elm structure the activation function and node number of each layer of the elm model are determined according to data samples step 4 2 initial ssa population the population size n and the maximum number of iterations t max are set step 4 3 computation of the fitness the training set is put into the elm model and the fitness of each salp individual is computed according to the fitness function step 4 4 selection of a leader follower and food the fitness size is computed and the position of salp with the best fitness is set as the current food position among the remaining n 1 salps the top half will be the leader and the rest will be the followers step 4 5 update of the positions of leaders and followers step 4 6 computation of the updated salp individual fitness f s and comparison with the fitness f food of the current food if f s f food the slap position corresponding to f s is taken as the new food position step 4 7 repeating step 4 3 to step 4 6 if t t max the optimal food position is output the result corresponding to the optimal food position is the optimal input weights and hidden layer biases of the elm model and thus the ssa elm model is established step 5 model prediction according to the established ssa elm model the predicted value is obtained by fitting each sub series after pre processing then to get the final prediction result all sub series predictions are added together 2 5 evaluation indicators to more directly reflect the reliability of the prediction results of each model normalized root mean squared error nrmse mean absolute percentage error mape coefficient of correlation r and nash sutcliffe efficiency coefficient nsec are selected as the model evaluation indicators adnan et al 2019 gao et al 2022a han and morrison 2022 lee 2022 nrmse is a dimensionless form of rmse which is obtained by normalizing rmse according to the observed range nrmse is more suitable than rmse to compare model performance when model output is in different units or the same unit but of different orders of magnitude ahmed et al 2019 the closer nrmse is to 0 the smaller the error is the smaller the mape is the smaller the error is the closer nsec and r are to 1 the better the process coincidence is the following formulas are used to compute them 20 nrmse 1 n i 1 n y i y i 2 1 2 y max y min 21 mape 1 n i 1 n y i y i y i 100 22 r i 1 n y i y avg y i y avg i 1 n y i y avg 2 y i y avg 2 23 nsec 1 i 1 n y i y i 2 i 1 n y i y avg 2 where y i is the observed value of the i th sample y i is the predicted value of the i th sample y avg is the average of all measured values y avg is the average of all predicted values 3 study areas and dataset manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are selected as study areas manwan hydropower is the first large scale hydropower in the cascade development of lancangjiang river hydropower resources the dam site is located in the middle reaches of lancangjiang river at the junction of yunxian and jingdong counties in yunnan province the lancang river emanates in the northern tanggula mountains of qinghai province china and flows through qinghai tibet and yunnan provinces from north to south before emptying into the south china sea the total length of the river is about 4 500 km with a total drop of 5 500 m and a watershed area of 744 000 km2 the reservoir area of manwan hydropower has a controlled drainage area of 114 500 km2 with an annual average runoff of 1 230 m3 s and an annual average runoff of 38 8 billion m3 hongjiadu hydropower is located on the mainstream of the wujiang river at the junction of qianxi county and zhijin county in guizhou province it is the leading hydropower in the cascade hydropower development of the wujiang river basin wujiang river originates from xianglu mountain weining county guizhou province crosses the eastern part of guizhou province and flows into the yangtze river at fuling it is the largest river in guizhou province with a total length of 1 037 km a watershed area of 87 900 km2 and a natural drop of 2 123 5 m the reservoir of hydropower has a regulating function for many years hydropower mainly generates electricity and has comprehensive benefits of flood control water supply and shipping the controlled watershed above the hongjiadu dam site covers an area of 9 900 km2 with an annual average runoff of 155 m3 s and an annual average runoff of 4 89 billion m3 yingluoxia hydrological station is located in longqu township zhangye city gansu province it is a national level hydrological station and a control station for the exit pass of the heihe river heihe river originates from the middle part of the northern foot of the qilian mountains with a total length of 948 km and a watershed area of 444 000 km2 the catchment area of yingluoxia hydrological station is 10 009 km2 303 km away from the river source and the annual average runoff is 51 5 m3 s in this paper the monthly runoff data of manwan hydropower from 1953 to 2004 hongjiadu hydropower from 1951 to 2005 and yingluoxia hydrological station from 1956 to 2009 are taken as research objects each data set is divided into different sub datasets about 90 of which are taken as training sets and the rest as testing sets the data sets used are shown in table 2 the monthly runoff series of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in fig 3 4 model development 4 1 decomposition results in this study tvf emd with adaptive series characteristics is devoted to decompose the monthly runoff series according to previous studies the decomposition effect of tvf emd was affected by the bandwidth threshold and b spline order in order to obtain a satisfactory decomposition effect the bandwidth threshold of tvf emd is 0 3 and the b spline order is 26 the decomposition results of tvf emd at manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in figs 4 5 and 6 respectively fig 4 reveals that tvf emd decomposes the original monthly runoff series into 6 sub series with frequencies from high to low from imf1 to imf6 the wavelength gradually increases the amplitude gradually decreases and the sequence gradually tends to be stable therefore the sub series is more stable than the original series which is more beneficial for the accuracy of prediction to verify the superiority of tvf emd decomposition the original monthly runoff series is also decomposed into 4 10 6 and 8 sub series by using wd ceemdan esmd and emd respectively at the same time figs 5 and 6 show that tvf emd decomposes the monthly runoff series of hongjiadu hydropower and yingluoxia hydrological station into 9 and 8 sub series respectively wd ceemdan esmd and emd decompose the monthly runoff series of hongjiadu hydropower into 4 10 8 and 7 sub series and the monthly runoff series of yingluoxia hydrological station into 4 9 8 and 7 sub series respectively 4 2 number of input variables determining the appropriate number of model input variables is conducive to capturing the non linear feature of the runoff series and achieving better prediction results in this paper acf and pacf are used to determine model inputs fig 7 shows the acf and pacf plots of the original runoff series of manwan hydropower it shows that the estimated value of acf reaches the peak value at 18 and the estimated value of pacf falls within the 95 confidence band therefore the lag time is determined as 18 periods that is every 18 earlier flows are used as model inputs figs 8 and 9 are acf and pacf plots of the original runoff series at hongjiadu hydropower and yingluoxia hydrological station respectively similarly the lag time of the original runoff series at hongjiadu hydropower is 18 periods and the lag time of the original runoff series at yingluoxia hydrological station is 13 periods as the characteristics of each sub series of runoff series are different after decomposition different lag times should be considered for different sub series the lag time of the sub series is determined by acf and pacf plots of each sub series the numbers of input variables to different prediction models for manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in table 3 4 3 bp and elm models both bp and elm models are standard three layer network structures the number of neurons in input layer and output layer of the elm model are input variables and 1 respectively the sigmoid function is used for hidden layer activation function and the number of hidden layer nodes is 2 input 1 input is the number of model inputs bp model adopts the same structure as the elm model and the hidden layer activation function training function and output layer function adopt tansig function trainlm function and purelin function respectively the number of network iterations is 5000 the expected error is 0 01 the learning rate is 0 1 and the network performance function adopts mse 4 4 tvf emd elm model for the tvf emd elm model the original monthly runoff series is firstly decomposed into several sub series by tvf emd and then each sub series is predicted by elm the number of inputs for each sub series is shown in table 3 4 5 ssa elm pso elm and gsa elm models ssa pso and gsa algorithms are used to select the input weights and hidden layer biases of the elm model and the search range of the input weights and hidden layer biases is 1 1 the iteration times of the three optimization algorithms are all 200 the population sizes are 40 and the fitness functions are mse the initial parameter g 0 of gsa is 100 and α is 20 the initial parameter learning factor of pso is c 1 c 2 2 and inertia factor ω 0 9 4 6 a hybrid model combining decomposition and optimization algorithms for emd ssa elm esmd ssa elm ceemdan ssa elm wd ssa elm and tvf emd ssa elm models the original monthly runoff series are firstly decomposed by emd esmd ceemdan wd and tvf emd respectively then ssa elm model is used to predict each sub series the input quantities of each decomposed sub series are shown in table 3 5 results and discussion the proposed hybrid model and ten benchmarking models are used to predict the original monthly runoff series and decomposed sub series at manwan hydropower hongjiadu hydropower and yingluoxia hydrological station respectively r nsec nrmse and mape are used to assess the performance of the models the computation results of evaluation indicators of each model in the training and testing periods are shown in table 4 the prediction and comparison diagrams of each model in the training and testing periods of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in figs 10 to 15 the prediction results in the model testing period can better reflect the prediction performance therefore the prediction results in the testing period are comprehensively analyzed as can be seen from fig 11 fig 13 and fig 15 the prediction effect of a single elm model is poor which can only display the general trend of the series and the predicted value differs greatly from the observed value the prediction accuracies of hybrid models with different decomposition methods are significantly different the prediction accuracy of the tvf emd ssa elm model is better than those of the wd ssa elm ceemdan ssa elm esmd ssa elm and emd ssa elm models the prediction effect of the emd ssa elm model is the worst tvf emd ssa elm model has the best fitting effect and the predicted series trend is the same as the original series trend and the predicted result is closer to the measured monthly runoff series based on the evaluation results of each model testing period shown in table 4 a detailed analysis is carried out as follows 1 both elm and bp are single models however the prediction performances of the elm model are better than those of the bp model in manwan hydropower hongjiadu hydropower and yingluoxia hydrological station for manwan hydropower compared with bp r and nsec of elm model increase from 0 905 and 0 745 to 0 928 and 0 857 respectively while nrmse and mape both decrease namely nrmse is reduced by 24 83 and mape is reduced by 33 81 for hongjiadu hydropower r and nsec increase by 0 028 and 0 054 respectively while nrmse and mape decrease for yingluoxia hydrological station r and nsec both increase while nrmse decrease by 1 72 in general the results of four evaluation indicators show that the elm model has a better ability to capture the characteristics of runoff series than the bp model and is more suitable for monthly runoff prediction but a single model is difficult to obtain satisfactory prediction effect 2 tvf emd elm ssa elm pso elm and gsa elm are single strategy processing models compared with the single elm model the prediction accuracy of the model using a single strategy processing is improved in this study three optimization algorithms are used to optimize the input weights and hidden layer biases of the elm model the computation results of four evaluation indicators of the three sites show that the ssa elm model obtains a better prediction effect the optimization accuracy of the ssa is higher than those of pso and gsa the unique output weights determined by input weights and hidden layer biases after optimization of pso and gsa are shown in table 5 for manwan hydropower compared with the elm model both r and nsec of the ssa elm model increase while nrmse decreases compared with the elm model r and nsec of the tvf emd elm model increase by 6 57 and 13 89 while nrmse and mape decrease by 58 72 and 12 42 respectively for hongjiadu hydropower compared with the elm model r and nsec of the ssa elm model increase while nrmse and mape decrease compared with the elm model r and nsec of the tvf emd elm model increase by 27 71 and 68 73 while nrmse and mape decrease by 79 58 and 67 42 respectively for yingluoxia hydrological station compared with the elm model r and nsec of the ssa elm model increase by 2 81 and 9 10 while nrmse and mape decrease by 24 56 and 17 78 respectively compared with the elm model r and nsec of the tvf emd elm model increase by 6 93 and 18 33 while nrmse and mape decrease by 62 28 and 22 82 respectively it can be seen from the results of the three cases that among the single strategy processing models the ssa elm model shows the best prediction performance among the three optimization models indicating that ssa has stronger applicability to the parameter selection of the elm model compared with pso and gsa therefore this paper selects ssa to optimize the parameters of the elm model at the same time the data preprocessing technology can reduce the non stationary and non linear characteristics of the runoff series and improve the prediction performance of the model the combination of the dual strategies can improve the prediction accuracy of the model more effectively 3 this paper proposes the tvf emd ssa elm hybrid model by combining the dual strategies for manwan hydropower compared with the ssa elm model r and nsec of tvf emd ssa elm model are up to 0 998 and 0 996 while nrmse and mape are reduced by 83 96 and 73 18 respectively compared with the tvf emd elm model r and nsec of the tvf emd ssa elm model are improved while nrmse and mape decrease by 62 22 and 68 46 respectively for hongjiadu hydropower compared with the ssa elm model r and nsec of tvf emd ssa elm model increase by 0 204 and 0 38 while nrmse and mape decrease by 84 67 and 76 31 respectively compared with the tvf emd elm model r and nsec increase by 0 005 and 0 009 while nrmse and mape decrease by 27 59 and 33 65 respectively for yingluoxia hydrological station compared with the ssa elm model r and nsec of tvf emd ssa elm model increase by 0 041 and 0 083 and nrmse and mape decrease by 58 14 and 26 43 respectively compared with the tvf emd elm model r and nsec increase by 0 003 and 0 007 while nrmse and mape decrease by 16 28 and 21 63 respectively by comparing the dual strategy processing model with the single strategy processing model the prediction accuracy of the dual strategy processing model is better than that of the single strategy processing model the combination of dual strategy that is data preprocessing technology and optimization algorithm are used at the same time incorporating the advantages of the two strategies thus the prediction accuracy of the model is significantly improved compared with the single use 4 in order to further verify the predictive performance of the tvf emd ssa elm model it is compared with four dual strategy processing models which adopt different data and processing techniques combined with the ssa elm model namely wd ssa elm ceemdan ssa elm esmd ssa elm and emd ssa elm the proposed tvf emd ssa elm achieves the highest prediction accuracy for manwan hydropower compared with wd ssa elm both r and nsec of tvf emd ssa elm increase while nrmse and mape decrease by 62 22 and 66 59 respectively compared with ceemdan ssa elm r and nsec increase by 0 022 and 0 045 while nrmse and mape decrease by 73 44 and 75 61 respectively compared with esmd ssa elm r and nsec increase by 8 13 and 18 71 while nrmse and mape decrease by 85 34 and 84 24 compared with emd ssa elm r and nsec increase by 9 55 and 22 06 while nrmse and mape decrease by 86 18 and 80 54 respectively for hongjiadu hydropower compared with wd ssa elm r and nsec of tvf emd ssa elm increase by 0 008 and 0 016 while nrmse and mape decrease by 38 24 and 36 4 respectively compared with ceemdan ssa elm r and nsec increase by 0 064 and 0 123 while nrmse and mape decrease by 73 75 and 69 27 respectively compared with esmd ssa elm r and nsec increase by 0 116 and 0 232 while nrmse and mape decrease by 80 56 and 77 58 respectively compared with emd ssa elm r and nsec increase by 0 118 and 0 246 while nrmse and mape decrease by 81 08 and 76 91 respectively for yingluoxia hydrological station compared with wd ssa elm r and nsec of tvf emd ssa elm increase by 0 009 and 0 019 while nrmse and mape decrease by 30 77 and 22 82 respectively compared with ceemdan ssa elm r and nsec increase by 0 015 and 0 039 while nrmse and mape decrease by 44 62 and 28 96 compared with esmd ssa elm r and nsec increase by 0 073 and 0 142 while nrmse and mape decrease by 66 97 and 57 54 respectively compared with emd ssa elm r and nsec increase by 0 33 and 0 792 while nrmse and mape decrease by 85 25 and 81 93 respectively the results show that tvf emd is more suitable for non linear non stationary runoff series the method can adapt to the characteristics of the series effectively alleviate the mode aliasing problem of ceemdan and emd and the decomposition results are more suitable for prediction which greatly improves the prediction accuracy figs 16 to 18 show the scatter plots between observed values and predicted values of different models it can be seen from the figures that the proposed tvf emd ssa elm model has the best fitting degree with the 45 degree line which again clearly confirms the reliability of the proposed model in conclusion the proposed tvf emd ssa elm hybrid model has the best forecasting performance which demonstrates the superiority of the model in forecasting compared with ten benchmarking models this model obtains the highest r and nsec and the lowest nrmse and mape in the three study areas and r and nsec in the three study areas are close to 1 indicating that the proposed model has high credibility at the same time nrmse is close to 0 which shows that the proposed model has a small prediction error and the prediction accuracy of the model is very good the results of the four evaluation indicators show that the proposed model can well predict the monthly runoff series in the three study areas bp model requires a large number of network parameters to be set artificially before training and it is easy to produce the optimal solution in contrast the elm model only needs to set the hidden layer nodes of the network and input weights and hidden layer biases are randomly selected its learning speed is fast and generalization performance is good however a single elm model cannot achieve satisfactory prediction performance in this study a hybrid model is established by combining data pre processing technology and an optimization algorithm compared with a single model the prediction accuracy of the model is greatly improved compared with the single use of data preprocessing technology or optimization algorithm to optimize model parameters the combination of these two strategies can further improve the prediction accuracy feng et al 2019 li and cheng 2014 niu et al 2019 samantaray et al 2022 wang et al 2023c wang et al 2009 wang et al 2015a the reasons why this hybrid model is superior to other models are analyzed as follows 1 the runoff series is non stationary and non linear tvf emd can effectively reduce the complexity of the original monthly runoff series render the runoff series stationary and improve the predictability of the original series 2 ssa is used to find the optimal input weights and hidden layer biases of the elm model which reduces the possibility of elm falling into local optima and enhances the generalization ability of the model 3 tvf emd ssa elm hybrid model combines data pre processing technology and optimization algorithm into the prediction model which produces a synergistic effect and effectively alleviates defects existing in the single model in general this method can effectively predict monthly runoff 6 conclusion monthly runoff prediction research is one of the important contents in the field of hydrological prediction research improving the prediction accuracy of monthly runoff series is of great significance to water resources management reservoir optimization etc because the runoff series often presents non linear and non stationary properties it is difficult for a single model to achieve satisfactory prediction results due to the random selection of input weights and hidden layer biases the elm model may easily fall into a local optimum therefore this paper introduces data preprocessing technology and optimization algorithm strategy at the same time and proposes tvf emd ssa elm hybrid prediction model first the original monthly runoff series is decomposed by tvf emd to obtain several relatively stable sub series then the elm model optimized by ssa is used to predict all the sub series finally the prediction results of all the sub series are superimposed in this paper the model is applied to the monthly runoff prediction of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station and the prediction effect of the model is evaluated based on four evaluation indicators the results show that the tvf emd ssa elm model is better than bp elm tvf emd elm ssa elm pso elm gsa elm emd ssa elm esmd ssa elm ceemdan ssa elm and wd ssa elm models r and nsec of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are as high as 0 998 0 996 0 991 and 0 996 0 991 and 0 982 respectively and the model can significantly reduce the prediction error tvf emd has a good processing ability for non linear and non stationary series this method can adapt to the characteristics of the series better alleviate the problem of mode mixing through time varying filters and retain the time variability of the series which provides a reference for the pretreatment of runoff series using ssa to optimize the network structure parameters of the elm model reduces the possibility of elm falling into a local optimum and enhances the generalization ability of the model in this study the combination of data preprocessing technology and optimization algorithm can effectively improve the prediction accuracy of monthly runoff prediction verify the effectiveness of combining the two strategies to improve the prediction accuracy provide a new method for medium and long term monthly runoff prediction and provide valuable technical reference for hydrologists to carry out runoff prediction in future research multiple factors should be considered to better understand characteristics for runoff forecasting modeling credit authorship contribution statement wen chuan wang conceptualization methodology writing original draft qi cheng methodology data curation writing original draft kwok wing chau writing original draft hao hu hong fei zang investigation dong mei xu formal analysis data curation declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors are grateful for the support of the special project for collaborative innovation of science and technology in 2021 no 202121206 and henan province university scientific and technological innovation team no 18irtsthn009 we gratefully acknowledge the critical comments and corrections of the anonymous reviewers which improved the presentation of the paper considerably appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129460 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2070,reliable runoff prediction plays a significant role in reservoir scheduling water resources management and efficient utilization of water resources to effectively enhance the prediction accuracy of monthly runoff series a hybrid prediction model tvf emd ssa elm combining time varying filtering tvf based empirical mode decomposition emd salp swarm algorithm ssa and extreme learning machine elm is proposed firstly the monthly runoff series is decomposed into several sub series using tvf emd secondly ssa is used to optimize the input weights and hidden layer biases of the selected elm model finally the prediction results are generated by summing and reconstructing each sub series based on the ssa optimized elm model this hybrid model is applied to the monthly runoff prediction of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station and compared with back propagation bp elm ssa elm pso elm gsa elm tvf emd elm emd ssa elm extreme point symmetric mode decomposition esmd ssa elm wavelet decomposition wd ssa elm and complete ensemble empirical mode decomposition with adaptive noise ceemdan ssa elm models the prediction performance of various models is reflected by four evaluation indicators r nsec nrmse mape results reveal that the prediction effect of the elm model is better than that of bp the optimization accuracy of ssa is better than those of particle swarm optimization pso and gravitational search algorithm gsa and the prediction accuracy of the hybrid tvf emd and ssa is better than that of only tvf emd or ssa tvf emd ssa elm model has the highest prediction accuracy when compared with the single elm model it s nrmse and mape at manwan hydropower decrease by 84 4 and 72 38 those of hongjiadu hydropower decrease by 85 21 and 78 38 and those of yingluoxi hydrological station decrease by 68 42 and 39 51 respectively r and nsec of the three sites are close to 1 therefore the proposed model provides a new method for the prediction of monthly runoff and the results can provide a reference for the prediction of monthly runoff in the study area keywords monthly runoff prediction extreme learning machine elm time varying filtering tvf empirical mode decomposition emd salp swarm algorithm ssa data availability the authors do not have permission to share data 1 introduction accurate and reliable medium and long term runoff predictions are very important for the optimal allocation of water resources li et al 2022b li et al 2023b wang et al 2017 wu and liu 2022 yan et al 2022 zhou et al 2015 optimization of reservoir operation ehteram et al 2021 meema et al 2021 yao et al 2022 zhu et al 2022 flood control su et al 2022 wu et al 2022 zhang et al 2020 zhao et al 2022 power generation cai et al 2020 tang et al 2010 zhao et al 2023 drought resistance aksoy and dahamsheh 2018 bae et al 2017 zhang et al 2023 and ecological restoration cao et al 2022 duan et al 2022 feng et al 2020a xia et al 2019 however runoff series are susceptible to many uncertainties and exhibit non linear and non stationary features which make it difficult for relevant departments to make runoff predictions he et al 2023 zhao and zhao 2014 therefore constructing an accurate and reliable runoff prediction model to enhance the prediction accuracy of runoff series has received extensive attention from hydrologists at present runoff forecast models may be roughly classified into two categories process driven models and data driven models adnan et al 2021 parisouj et al 2020 process driven models usually depend on a large number of reliable data but there is usually a lack of data in many regions of the world which cannot meet the requirements of modeling meanwhile process driven models also require a large amount of computation and the modeling process is complicated in contrast data driven models can simplify complex problems make modeling processes simple and efficient and the internal relationship between data can be deeply explored it can provide satisfactory prediction performance for hydrological forecasting in areas where data are lacking therefore data driven models have become increasingly popular over the years many data driven models have been applied in the field of runoff forecast such as artificial neural network ann ikram et al 2022 tareke and awoke 2023 wang et al 2015b support vector machine svm feng et al 2020b huang et al 2014 long short term memory neural network lstm xu et al 2022 gated recurrent unit gru gao et al 2020 zhao et al 2021 and extreme learning machine elm feng et al 2021 wen et al 2019 yue et al 2020 with the use of advanced technology and new materials by researchers people s lives are constantly being improved rezayeenik et al 2022 salehi et al 2016 zinatloo ajabshir et al 2020a zinatloo ajabshir et al 2020b zinatloo ajabshir et al 2017 zinatloo ajabshir et al 2019 among them the use of artificial intelligence technology is more prominent ann svm lstm and other prediction models have been widely used in various fields and runoff prediction ezzahra yatim et al 2022 geetha et al 2022 li et al 2023a lu et al 2023 wang et al 2009 wang et al 2023d but they all have shortcomings and deficiencies bp is based on gradient descent which is easy to fall into the local minimum problem and the algorithm needs many iterations so the overall efficiency is not high the svm training process is time consuming sensitive to parameters and has poor performance in large sample prediction lstm model has good predictive performance but it has some defects such as large memory consumption and long running time elm is a kind of learning algorithm developed in recent years which has been widely used in different scientific fields due to its advantages of simple parameter setting high learning efficiency and strong generalization performance elm was applied by anicic et al 2017 to predict the heat affected zone haz and results showed that the elm model could provide better prediction performance abdullah et al 2015 used elm to predict reference evapotranspiration for three major meteorological stations in northern central and southern iraq which reflected the simplicity high speed and good generalization performance of elm gao et al 2022b used elm to forecast electricity demand in the mid term for three provinces in china which played an important role in ensuring the safety of power operations zhang et al 2022 applied elm to determine the brittleness index of shale asteris et al 2022 used elm to predict the compression index of clay which was important for determining the degree of soil improvement wang et al 2023b used elm to predict the concentrations of blood glucose cholesterol and triglyceride in human blood samples and coupled it with raman spectroscopy to quickly and accurately determine blood components wu et al 2021 combined elm with three meta heuristic algorithms to predict reference crop evaporation which was of great significance for regional water resources management for the past few years elm has been gradually used by hydrologists for runoff prediction and has achieved fruitful research results li and cheng 2014 niu et al 2020b wang et al 2019 therefore the elm model is selected in this study to develop a monthly runoff prediction model in practical applications elm may fall into local optimum due to the random selection of input weights and hidden layer biases moreover it is often difficult for a single prediction model to achieve satisfactory prediction results because runoff series are easily affected by uncertain factors therefore the performance of runoff prediction still has some room for improvement at present scholars have proposed a hybrid prediction model which has better forecasting performance than a single prediction model and has become a new trend in hydrological prediction adnan et al 2021 qin et al 2019 a hybrid prediction model is usually composed of two ways one is to use a decomposition method to pre process the original runoff series to improve the prediction performance feng et al 2022b the other is to use an intelligent optimization algorithm to optimize model parameters to improve the predictive performance of the model niu et al 2020b table 1 shows runoff prediction studies in recent years using data preprocessing techniques and optimization algorithm strategies the decomposition methods that have emerged include emd esmd yue and li 2020 ceemdan vmd xie et al 2019 wd and tvf emd bai et al 2023 zhao et al 2017 combined emd and least squares support vector machine lssvm based on chaos theory to predict the annual runoff of four hydrological stations in the upper reaches of fenhe river basin and the results proved that emd effectively improved the prediction accuracy however mode mixing still exists after emd decomposition for this reason torres et al 2011 improved emd and used the idea of adding white noise to eemd to reduce mode aliasing and proposed ceemdan wang et al 2023a combined ceemdan with artificial intelligence model to effectively improve the accuracy of runoff prediction showing that the hybrid model played an important role in improving the forecast results ceemdan effectively solved the mode mixing problem but required proper selection of parameters and constant cutoff frequency making the series not time varying wang et al 2021 studied the combination of esmd and sample entropy based wpd data pre processing methods with lstm to predict annual runoff in seven regions of china and achieved better results however the results showed that a single esmd could not handle the nonlinearity of the series well and did not have high frequency separation performance seo et al 2018 proposed to combine vmd with different models to build a variety of hybrid models and their results showed that the prediction accuracy was effectively enhanced after vmd was introduced and the study showed that the decomposition method was effective in improving the accuracy of runoff prediction zuo et al 2020 combined vmd with lstm to predict the daily runoff of jinghe river and hanjiang river in china and compared it with the integrated model of eemd and dwt results showed that vmd was superior to eemd and dwt in addressing non linear and non stationary conditions many studies have proved that vmd has strong robustness to noise and can effectively avoid mode mixing to achieve satisfactory performance but its drawback is that it needs to determine the appropriate parameters to achieve satisfactory decomposition effect to overcome the shortcomings of the above decomposition techniques this paper adopts tvf emd to pre process the runoff series tvf emd is an improvement of emd and uses non uniform b spline approximation as time varying filter to adaptively design local cutoff frequency compared with existing methods the mode mixing problem can be effectively solved while maintaining the time varying characteristics that ceemdan and vmd do not have and still has good performance at low sampling rate chen et al 2020 applied tvf emd to the monthly runoff prediction of baishan reservoir and achieved satisfactory prediction results with significant improvement in reducing runoff prediction errors song et al 2021 combined three decomposition methods with enn to build three models for precipitation prediction at different weather stations and results showed that the tvf emd enn model had the best prediction effect and tvf emd was more suitable for dealing with non stationary and non linear series jamei et al 2023 proposed a multi decomposition model based on tvf emd to predict monthly precipitation in the himalayan region of india effectively improving the prediction accuracy of three data driven models intelligent optimization algorithms are used to optimize model parameters and can improve the prediction performance of the model at present particle swarm optimization pso kumar et al 2019 firefly algorithm fa das et al 2019 gravitational search algorithm gsa banadkooki et al 2020 grey wolf optimizer gwo zhao et al 2021 and whale optimization algorithm woa shang et al 2020 etc have been used to optimize model parameters and obtain higher forecasting accuracy the sparrow search algorithm was used by feng et al 2022a to optimize the structural parameters of elm compared with the standard elm model the proposed method significantly improved four evaluation indicators in training and testing periods cheng et al 2020 combined the gwo with elm to predict the monthly runoff of the three gorges reservoir and obtained better prediction results samantaray et al 2022 used svm based on ssa to predict monthly runoff in the baitarani river basin the results of four indicators showed that the hybrid model had better prediction accuracy compared with the traditional model ssa is a new optimization algorithm inspired by the behavior of salp in the ocean this optimization algorithm has a simple structure and a relatively fast convergence speed which can well reduce the situation of falling into local optima however elm model may be prone to local optima due to random selection of initial parameters therefore ssa is used in this paper to find the optimal parameters of elm model in order to improve the elm prediction performance currently hydrologists are increasingly interested in combining two strategies to improve runoff prediction accuracy to a greater degree a hybrid prediction model coupled with vmd and lstm optimized by gwo was proposed by li et al 2022a and the proposed model achieved the best prediction accuracy for the monthly runoff of xinfengjiang reservoir and guangzhao reservoir niu et al 2020a proposed a hybrid prediction model optimized by elm based on vmd and gravitational search algorithm gsa to effectively improve the prediction accuracy of runoff of large hydropower in china therefore in this study a novel tvf emd ssa elm monthly runoff prediction model is proposed by coupling time varying filtering based empirical mode decomposition salp swarm algorithm and extreme learning machine this model is then compared with seven benchmarking models providing a new approach for current runoff prediction the main contributions of this study are summarized as follows 1 a hybrid tvf emd ssa elm prediction model is proposed which can provide reliable results for monthly runoff prediction 2 because of the strong randomness caused by input weights and hidden layer biases of traditional elm ssa is optimized to enhance the generalization ability and prediction performance of the elm 3 the model developed in this paper and ten benchmarking models are applied to the monthly runoff prediction of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station four evaluation indicators verify the superiority of the proposed method the rest of this paper is arranged as follows section 2 introduces the methods of tvf emd ssa elm tvf emd ssa elm model and indicators for evaluating model performance section 3 presents the study area and dataset section 4 introduces detailed information on model inputs and decomposition results section 5 analyses and discusses the prediction results of different models finally section 6 summarizes the conclusions of this paper 2 methodology and evaluation indicators 2 1 tvf emd tvf emd was proposed by li et al 2017 which is an improvement of emd and effectively solves the mode mixing problem existing in emd the basic idea is very simple that is to determine the local cutoff frequency and then perform time varying filtering on the signal the specific steps of the tvf emd method are as follows step 1 hilbert transform is used to compute the instantaneous amplitude a t and instantaneous frequency φ t of the runoff series x t and the computation formula is as follows 1 a t x t 2 x t 2 2 φ t d arctan x t x t dt where x t is the hilbert transform of runoff series x t step 2 determine the local maximum a t max and minimum a t min values of instantaneous amplitude a t step 3 interpolate a t min and a t max to get curves β 1 t and β 2 t respectively and then compute the instantaneous mean value a 1 t and instantaneous envelope a 2 t and the computation formula is as follows 3 a 1 t β 1 t β 2 t 2 4 a 2 t β 2 t β 1 t 2 step 4 interpolate φ t min a 2 t min and φ t max a 2 t max respectively to get η 1 t and η 2 t and then compute φ 1 t and φ 2 t as follows 5 φ 1 t η 1 t 2 a 1 2 t 2 a 1 t a 2 t η 2 t 2 a 1 2 t 2 a 1 t a 2 t 6 φ 2 t η 1 t 2 a 2 2 t 2 a 1 t a 2 t η 2 t 2 a 2 2 t 2 a 1 t a 2 t step 5 compute the local cutoff frequency φ bis t as follows 7 φ bis t φ 1 t φ 2 t 2 step 6 rearrange φ bis t to solve the intermittent problem step 7 the signal h t cos φ bis t d t is defined the extreme value point of h t is taken as the node and the runoff series is approximated by b sample interpolation the approximation result is m t representing the local mean curve step 8 compute cutoff criterion θ t if θ t ξ x t is judged to be an imf otherwise make x 1 t x t m t repeat steps 1 to 8 the computation formula up to cutoff criterion θ t is as follows 8 θ t b loughlin t φ avg t 9 b loughlin t a 1 2 t a 2 2 t a 1 2 t a 2 2 t a 1 2 t a 2 2 t φ 1 2 t φ 2 t 2 a 1 2 t a 2 2 t 2 10 φ avg t a 1 2 t φ 1 2 t a 2 2 t φ 2 t a 1 2 t a 2 2 t where b loughlin t is the loughlin instantaneous bandwidth of two component signals φ avg t is the weighted average instantaneous frequency of a single component after the decomposition of the above steps the value of the original runoff series x t is the sum of all mode components x i t 2 2 ssa ssa is a meta heuristic swarm intelligence optimization algorithm proposed by mirjalili et al 2017 the algorithm simulates the aggregation behavior of salp which consists of two types of salps namely leaders and followers to form salp chains and then prey and move the leader is located at the front of the chain and is responsible for global exploration while the follower is responsible for local search which greatly reduces the situation of falling into local optimization hu et al 2021 in ssa the position of each salp individual is defined as a d dimensional vector then the chain x connected by n salp can be regarded as a population therefore the salp population is a n d matrix which can be expressed as 11 x x 1 1 x 2 1 x d 1 x 1 2 x 2 2 x d 2 x 1 n x 2 n x d n the i th salp individual is expressed as x i x 1 i x 2 i x d i the leader is the first vector in a matrix x and is responsible for searching for food to lead the movement direction of the whole group its position update formula is as follows 12 x j 1 f j c 1 u b j l b j c 2 l b j c 3 0 5 f j c 1 u b j l b j c 2 l b j c 3 0 5 where x j 1 is the position of leader in the j dimensional space f j is the position of food in the j th dimensional space u b j and l b j are the upper and lower boundaries of the j th dimensional space respectively parameters c 2 and c 3 are randomly generated within 0 1 which determine the length and direction of the leader s movement a population s exploration ability is mainly controlled by c 1 which is related to the number of undergone iterations its formula is as follows 13 c 1 2 e 4 t t max 2 where t and t max are the current and maximum iteration times respectively the location update formula of followers is 14 x j i t 1 2 x j i t 1 x j i 1 t 1 where x j i t is the location of the i th salp follower in the j th dimensional space at the t th iteration 2 3 elm elm was proposed by huang et al 2006 which could effectively solve the problems of slow learning rate and long iteration time of feedforward neural networks the algorithm simply generates input weights and hidden layer biases randomly before training and does not need to be adjusted after setting and output weights are determined once by solving the equation without iterative generation its benefits over other traditional training algorithms include easy parameter selection quick computation and high generalization capabilities the configuration of the elm is shown in fig 1 its basic theory is described as follows for n randomly different samples x i t i where x i x i 1 x i 2 x in t r n t i t i 1 t i 2 t im t r m g x is defined as the activation function and l as the number of hidden layers in order to make the output error free the output function of elm is 15 i 1 l β i g ω i x j b i t j j 1 2 n where ω i ω i 1 ω i 2 ω in t is the weight matrix between input and hidden layers β i β i 1 β i 2 β im t is the output weight matrix between hidden and output layers b i is the bias of the i th hidden layer neuron eq 15 is expressed by the matrix as follows 16 h β t where h is the output matrix of the hidden layer β is the output weight matrix t is the target matrix of sample set below is a specific form 17 h ω 1 ω l b 1 b l x 1 x l g ω 1 x 1 b 1 g ω 2 x 1 b 2 g ω l x 1 b l g ω 1 x 2 b 1 g ω 2 x 2 b 2 g ω l x 2 b l g ω 1 x n b 1 g ω 2 x n b 2 g ω l x n b l n l β β 1 t β l t l m t t 1 t t l t n m in view of the fact that input weights and biases for hidden layers are given at random h is turned into a deterministic matrix making the training process to solve the least square solution of the output weight matrix and the output matrix is 18 β h t where h is the moore penrose generalized inverse matrix of the hidden layer s output matrix 2 4 proposed model due to the influence of various uncertain factors the runoff series usually presents the characteristics of non linear and non stationarity it is difficult to capture the characteristics of runoff series using a single elm model and the data preprocessing technology can well reduce the non stationarity of runoff series in practical applications the random selection of elm input weights and hidden layer biases have a great influence on elm prediction performance feng et al 2019 in order to improve the prediction accuracy of monthly runoff series a hybrid prediction model tvf emd ssa elm is proposed in this paper in this model the tvf emd method is first used to stabilize the runoff series and then input weights and hidden layer biases of elm are optimized using ssa then the elm model with optimized parameters is used to predict the stabilized sub series finally the prediction results of each sub series are superimposed and reconstructed to obtain the final prediction results the flow chart of the tvf emd ssa elm hybrid prediction model is shown in fig 2 and the specific steps are as follows step 1 decomposition tvf emd is used to decompose the original runoff series into several sub series step 2 determination of input variables model input variables are determined based on the autocorrelation coefficient acf and partial autocorrelation coefficient pacf step 3 data manipulation the original runoff series are divided into training sets and testing sets and all data are normalized by the following formula which is limited between 0 1 to accelerate the convergence speed of the model 19 x i x i x min x max x min where x i is the i th input value in the sample sequence x max and x min are the maximum and minimum values in the sample respectively x i is the i th input value corresponding to the normalized sample sequence step 4 establishment of the ssa elm model step 4 1 determination of the elm structure the activation function and node number of each layer of the elm model are determined according to data samples step 4 2 initial ssa population the population size n and the maximum number of iterations t max are set step 4 3 computation of the fitness the training set is put into the elm model and the fitness of each salp individual is computed according to the fitness function step 4 4 selection of a leader follower and food the fitness size is computed and the position of salp with the best fitness is set as the current food position among the remaining n 1 salps the top half will be the leader and the rest will be the followers step 4 5 update of the positions of leaders and followers step 4 6 computation of the updated salp individual fitness f s and comparison with the fitness f food of the current food if f s f food the slap position corresponding to f s is taken as the new food position step 4 7 repeating step 4 3 to step 4 6 if t t max the optimal food position is output the result corresponding to the optimal food position is the optimal input weights and hidden layer biases of the elm model and thus the ssa elm model is established step 5 model prediction according to the established ssa elm model the predicted value is obtained by fitting each sub series after pre processing then to get the final prediction result all sub series predictions are added together 2 5 evaluation indicators to more directly reflect the reliability of the prediction results of each model normalized root mean squared error nrmse mean absolute percentage error mape coefficient of correlation r and nash sutcliffe efficiency coefficient nsec are selected as the model evaluation indicators adnan et al 2019 gao et al 2022a han and morrison 2022 lee 2022 nrmse is a dimensionless form of rmse which is obtained by normalizing rmse according to the observed range nrmse is more suitable than rmse to compare model performance when model output is in different units or the same unit but of different orders of magnitude ahmed et al 2019 the closer nrmse is to 0 the smaller the error is the smaller the mape is the smaller the error is the closer nsec and r are to 1 the better the process coincidence is the following formulas are used to compute them 20 nrmse 1 n i 1 n y i y i 2 1 2 y max y min 21 mape 1 n i 1 n y i y i y i 100 22 r i 1 n y i y avg y i y avg i 1 n y i y avg 2 y i y avg 2 23 nsec 1 i 1 n y i y i 2 i 1 n y i y avg 2 where y i is the observed value of the i th sample y i is the predicted value of the i th sample y avg is the average of all measured values y avg is the average of all predicted values 3 study areas and dataset manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are selected as study areas manwan hydropower is the first large scale hydropower in the cascade development of lancangjiang river hydropower resources the dam site is located in the middle reaches of lancangjiang river at the junction of yunxian and jingdong counties in yunnan province the lancang river emanates in the northern tanggula mountains of qinghai province china and flows through qinghai tibet and yunnan provinces from north to south before emptying into the south china sea the total length of the river is about 4 500 km with a total drop of 5 500 m and a watershed area of 744 000 km2 the reservoir area of manwan hydropower has a controlled drainage area of 114 500 km2 with an annual average runoff of 1 230 m3 s and an annual average runoff of 38 8 billion m3 hongjiadu hydropower is located on the mainstream of the wujiang river at the junction of qianxi county and zhijin county in guizhou province it is the leading hydropower in the cascade hydropower development of the wujiang river basin wujiang river originates from xianglu mountain weining county guizhou province crosses the eastern part of guizhou province and flows into the yangtze river at fuling it is the largest river in guizhou province with a total length of 1 037 km a watershed area of 87 900 km2 and a natural drop of 2 123 5 m the reservoir of hydropower has a regulating function for many years hydropower mainly generates electricity and has comprehensive benefits of flood control water supply and shipping the controlled watershed above the hongjiadu dam site covers an area of 9 900 km2 with an annual average runoff of 155 m3 s and an annual average runoff of 4 89 billion m3 yingluoxia hydrological station is located in longqu township zhangye city gansu province it is a national level hydrological station and a control station for the exit pass of the heihe river heihe river originates from the middle part of the northern foot of the qilian mountains with a total length of 948 km and a watershed area of 444 000 km2 the catchment area of yingluoxia hydrological station is 10 009 km2 303 km away from the river source and the annual average runoff is 51 5 m3 s in this paper the monthly runoff data of manwan hydropower from 1953 to 2004 hongjiadu hydropower from 1951 to 2005 and yingluoxia hydrological station from 1956 to 2009 are taken as research objects each data set is divided into different sub datasets about 90 of which are taken as training sets and the rest as testing sets the data sets used are shown in table 2 the monthly runoff series of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in fig 3 4 model development 4 1 decomposition results in this study tvf emd with adaptive series characteristics is devoted to decompose the monthly runoff series according to previous studies the decomposition effect of tvf emd was affected by the bandwidth threshold and b spline order in order to obtain a satisfactory decomposition effect the bandwidth threshold of tvf emd is 0 3 and the b spline order is 26 the decomposition results of tvf emd at manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in figs 4 5 and 6 respectively fig 4 reveals that tvf emd decomposes the original monthly runoff series into 6 sub series with frequencies from high to low from imf1 to imf6 the wavelength gradually increases the amplitude gradually decreases and the sequence gradually tends to be stable therefore the sub series is more stable than the original series which is more beneficial for the accuracy of prediction to verify the superiority of tvf emd decomposition the original monthly runoff series is also decomposed into 4 10 6 and 8 sub series by using wd ceemdan esmd and emd respectively at the same time figs 5 and 6 show that tvf emd decomposes the monthly runoff series of hongjiadu hydropower and yingluoxia hydrological station into 9 and 8 sub series respectively wd ceemdan esmd and emd decompose the monthly runoff series of hongjiadu hydropower into 4 10 8 and 7 sub series and the monthly runoff series of yingluoxia hydrological station into 4 9 8 and 7 sub series respectively 4 2 number of input variables determining the appropriate number of model input variables is conducive to capturing the non linear feature of the runoff series and achieving better prediction results in this paper acf and pacf are used to determine model inputs fig 7 shows the acf and pacf plots of the original runoff series of manwan hydropower it shows that the estimated value of acf reaches the peak value at 18 and the estimated value of pacf falls within the 95 confidence band therefore the lag time is determined as 18 periods that is every 18 earlier flows are used as model inputs figs 8 and 9 are acf and pacf plots of the original runoff series at hongjiadu hydropower and yingluoxia hydrological station respectively similarly the lag time of the original runoff series at hongjiadu hydropower is 18 periods and the lag time of the original runoff series at yingluoxia hydrological station is 13 periods as the characteristics of each sub series of runoff series are different after decomposition different lag times should be considered for different sub series the lag time of the sub series is determined by acf and pacf plots of each sub series the numbers of input variables to different prediction models for manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in table 3 4 3 bp and elm models both bp and elm models are standard three layer network structures the number of neurons in input layer and output layer of the elm model are input variables and 1 respectively the sigmoid function is used for hidden layer activation function and the number of hidden layer nodes is 2 input 1 input is the number of model inputs bp model adopts the same structure as the elm model and the hidden layer activation function training function and output layer function adopt tansig function trainlm function and purelin function respectively the number of network iterations is 5000 the expected error is 0 01 the learning rate is 0 1 and the network performance function adopts mse 4 4 tvf emd elm model for the tvf emd elm model the original monthly runoff series is firstly decomposed into several sub series by tvf emd and then each sub series is predicted by elm the number of inputs for each sub series is shown in table 3 4 5 ssa elm pso elm and gsa elm models ssa pso and gsa algorithms are used to select the input weights and hidden layer biases of the elm model and the search range of the input weights and hidden layer biases is 1 1 the iteration times of the three optimization algorithms are all 200 the population sizes are 40 and the fitness functions are mse the initial parameter g 0 of gsa is 100 and α is 20 the initial parameter learning factor of pso is c 1 c 2 2 and inertia factor ω 0 9 4 6 a hybrid model combining decomposition and optimization algorithms for emd ssa elm esmd ssa elm ceemdan ssa elm wd ssa elm and tvf emd ssa elm models the original monthly runoff series are firstly decomposed by emd esmd ceemdan wd and tvf emd respectively then ssa elm model is used to predict each sub series the input quantities of each decomposed sub series are shown in table 3 5 results and discussion the proposed hybrid model and ten benchmarking models are used to predict the original monthly runoff series and decomposed sub series at manwan hydropower hongjiadu hydropower and yingluoxia hydrological station respectively r nsec nrmse and mape are used to assess the performance of the models the computation results of evaluation indicators of each model in the training and testing periods are shown in table 4 the prediction and comparison diagrams of each model in the training and testing periods of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are shown in figs 10 to 15 the prediction results in the model testing period can better reflect the prediction performance therefore the prediction results in the testing period are comprehensively analyzed as can be seen from fig 11 fig 13 and fig 15 the prediction effect of a single elm model is poor which can only display the general trend of the series and the predicted value differs greatly from the observed value the prediction accuracies of hybrid models with different decomposition methods are significantly different the prediction accuracy of the tvf emd ssa elm model is better than those of the wd ssa elm ceemdan ssa elm esmd ssa elm and emd ssa elm models the prediction effect of the emd ssa elm model is the worst tvf emd ssa elm model has the best fitting effect and the predicted series trend is the same as the original series trend and the predicted result is closer to the measured monthly runoff series based on the evaluation results of each model testing period shown in table 4 a detailed analysis is carried out as follows 1 both elm and bp are single models however the prediction performances of the elm model are better than those of the bp model in manwan hydropower hongjiadu hydropower and yingluoxia hydrological station for manwan hydropower compared with bp r and nsec of elm model increase from 0 905 and 0 745 to 0 928 and 0 857 respectively while nrmse and mape both decrease namely nrmse is reduced by 24 83 and mape is reduced by 33 81 for hongjiadu hydropower r and nsec increase by 0 028 and 0 054 respectively while nrmse and mape decrease for yingluoxia hydrological station r and nsec both increase while nrmse decrease by 1 72 in general the results of four evaluation indicators show that the elm model has a better ability to capture the characteristics of runoff series than the bp model and is more suitable for monthly runoff prediction but a single model is difficult to obtain satisfactory prediction effect 2 tvf emd elm ssa elm pso elm and gsa elm are single strategy processing models compared with the single elm model the prediction accuracy of the model using a single strategy processing is improved in this study three optimization algorithms are used to optimize the input weights and hidden layer biases of the elm model the computation results of four evaluation indicators of the three sites show that the ssa elm model obtains a better prediction effect the optimization accuracy of the ssa is higher than those of pso and gsa the unique output weights determined by input weights and hidden layer biases after optimization of pso and gsa are shown in table 5 for manwan hydropower compared with the elm model both r and nsec of the ssa elm model increase while nrmse decreases compared with the elm model r and nsec of the tvf emd elm model increase by 6 57 and 13 89 while nrmse and mape decrease by 58 72 and 12 42 respectively for hongjiadu hydropower compared with the elm model r and nsec of the ssa elm model increase while nrmse and mape decrease compared with the elm model r and nsec of the tvf emd elm model increase by 27 71 and 68 73 while nrmse and mape decrease by 79 58 and 67 42 respectively for yingluoxia hydrological station compared with the elm model r and nsec of the ssa elm model increase by 2 81 and 9 10 while nrmse and mape decrease by 24 56 and 17 78 respectively compared with the elm model r and nsec of the tvf emd elm model increase by 6 93 and 18 33 while nrmse and mape decrease by 62 28 and 22 82 respectively it can be seen from the results of the three cases that among the single strategy processing models the ssa elm model shows the best prediction performance among the three optimization models indicating that ssa has stronger applicability to the parameter selection of the elm model compared with pso and gsa therefore this paper selects ssa to optimize the parameters of the elm model at the same time the data preprocessing technology can reduce the non stationary and non linear characteristics of the runoff series and improve the prediction performance of the model the combination of the dual strategies can improve the prediction accuracy of the model more effectively 3 this paper proposes the tvf emd ssa elm hybrid model by combining the dual strategies for manwan hydropower compared with the ssa elm model r and nsec of tvf emd ssa elm model are up to 0 998 and 0 996 while nrmse and mape are reduced by 83 96 and 73 18 respectively compared with the tvf emd elm model r and nsec of the tvf emd ssa elm model are improved while nrmse and mape decrease by 62 22 and 68 46 respectively for hongjiadu hydropower compared with the ssa elm model r and nsec of tvf emd ssa elm model increase by 0 204 and 0 38 while nrmse and mape decrease by 84 67 and 76 31 respectively compared with the tvf emd elm model r and nsec increase by 0 005 and 0 009 while nrmse and mape decrease by 27 59 and 33 65 respectively for yingluoxia hydrological station compared with the ssa elm model r and nsec of tvf emd ssa elm model increase by 0 041 and 0 083 and nrmse and mape decrease by 58 14 and 26 43 respectively compared with the tvf emd elm model r and nsec increase by 0 003 and 0 007 while nrmse and mape decrease by 16 28 and 21 63 respectively by comparing the dual strategy processing model with the single strategy processing model the prediction accuracy of the dual strategy processing model is better than that of the single strategy processing model the combination of dual strategy that is data preprocessing technology and optimization algorithm are used at the same time incorporating the advantages of the two strategies thus the prediction accuracy of the model is significantly improved compared with the single use 4 in order to further verify the predictive performance of the tvf emd ssa elm model it is compared with four dual strategy processing models which adopt different data and processing techniques combined with the ssa elm model namely wd ssa elm ceemdan ssa elm esmd ssa elm and emd ssa elm the proposed tvf emd ssa elm achieves the highest prediction accuracy for manwan hydropower compared with wd ssa elm both r and nsec of tvf emd ssa elm increase while nrmse and mape decrease by 62 22 and 66 59 respectively compared with ceemdan ssa elm r and nsec increase by 0 022 and 0 045 while nrmse and mape decrease by 73 44 and 75 61 respectively compared with esmd ssa elm r and nsec increase by 8 13 and 18 71 while nrmse and mape decrease by 85 34 and 84 24 compared with emd ssa elm r and nsec increase by 9 55 and 22 06 while nrmse and mape decrease by 86 18 and 80 54 respectively for hongjiadu hydropower compared with wd ssa elm r and nsec of tvf emd ssa elm increase by 0 008 and 0 016 while nrmse and mape decrease by 38 24 and 36 4 respectively compared with ceemdan ssa elm r and nsec increase by 0 064 and 0 123 while nrmse and mape decrease by 73 75 and 69 27 respectively compared with esmd ssa elm r and nsec increase by 0 116 and 0 232 while nrmse and mape decrease by 80 56 and 77 58 respectively compared with emd ssa elm r and nsec increase by 0 118 and 0 246 while nrmse and mape decrease by 81 08 and 76 91 respectively for yingluoxia hydrological station compared with wd ssa elm r and nsec of tvf emd ssa elm increase by 0 009 and 0 019 while nrmse and mape decrease by 30 77 and 22 82 respectively compared with ceemdan ssa elm r and nsec increase by 0 015 and 0 039 while nrmse and mape decrease by 44 62 and 28 96 compared with esmd ssa elm r and nsec increase by 0 073 and 0 142 while nrmse and mape decrease by 66 97 and 57 54 respectively compared with emd ssa elm r and nsec increase by 0 33 and 0 792 while nrmse and mape decrease by 85 25 and 81 93 respectively the results show that tvf emd is more suitable for non linear non stationary runoff series the method can adapt to the characteristics of the series effectively alleviate the mode aliasing problem of ceemdan and emd and the decomposition results are more suitable for prediction which greatly improves the prediction accuracy figs 16 to 18 show the scatter plots between observed values and predicted values of different models it can be seen from the figures that the proposed tvf emd ssa elm model has the best fitting degree with the 45 degree line which again clearly confirms the reliability of the proposed model in conclusion the proposed tvf emd ssa elm hybrid model has the best forecasting performance which demonstrates the superiority of the model in forecasting compared with ten benchmarking models this model obtains the highest r and nsec and the lowest nrmse and mape in the three study areas and r and nsec in the three study areas are close to 1 indicating that the proposed model has high credibility at the same time nrmse is close to 0 which shows that the proposed model has a small prediction error and the prediction accuracy of the model is very good the results of the four evaluation indicators show that the proposed model can well predict the monthly runoff series in the three study areas bp model requires a large number of network parameters to be set artificially before training and it is easy to produce the optimal solution in contrast the elm model only needs to set the hidden layer nodes of the network and input weights and hidden layer biases are randomly selected its learning speed is fast and generalization performance is good however a single elm model cannot achieve satisfactory prediction performance in this study a hybrid model is established by combining data pre processing technology and an optimization algorithm compared with a single model the prediction accuracy of the model is greatly improved compared with the single use of data preprocessing technology or optimization algorithm to optimize model parameters the combination of these two strategies can further improve the prediction accuracy feng et al 2019 li and cheng 2014 niu et al 2019 samantaray et al 2022 wang et al 2023c wang et al 2009 wang et al 2015a the reasons why this hybrid model is superior to other models are analyzed as follows 1 the runoff series is non stationary and non linear tvf emd can effectively reduce the complexity of the original monthly runoff series render the runoff series stationary and improve the predictability of the original series 2 ssa is used to find the optimal input weights and hidden layer biases of the elm model which reduces the possibility of elm falling into local optima and enhances the generalization ability of the model 3 tvf emd ssa elm hybrid model combines data pre processing technology and optimization algorithm into the prediction model which produces a synergistic effect and effectively alleviates defects existing in the single model in general this method can effectively predict monthly runoff 6 conclusion monthly runoff prediction research is one of the important contents in the field of hydrological prediction research improving the prediction accuracy of monthly runoff series is of great significance to water resources management reservoir optimization etc because the runoff series often presents non linear and non stationary properties it is difficult for a single model to achieve satisfactory prediction results due to the random selection of input weights and hidden layer biases the elm model may easily fall into a local optimum therefore this paper introduces data preprocessing technology and optimization algorithm strategy at the same time and proposes tvf emd ssa elm hybrid prediction model first the original monthly runoff series is decomposed by tvf emd to obtain several relatively stable sub series then the elm model optimized by ssa is used to predict all the sub series finally the prediction results of all the sub series are superimposed in this paper the model is applied to the monthly runoff prediction of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station and the prediction effect of the model is evaluated based on four evaluation indicators the results show that the tvf emd ssa elm model is better than bp elm tvf emd elm ssa elm pso elm gsa elm emd ssa elm esmd ssa elm ceemdan ssa elm and wd ssa elm models r and nsec of manwan hydropower hongjiadu hydropower and yingluoxia hydrological station are as high as 0 998 0 996 0 991 and 0 996 0 991 and 0 982 respectively and the model can significantly reduce the prediction error tvf emd has a good processing ability for non linear and non stationary series this method can adapt to the characteristics of the series better alleviate the problem of mode mixing through time varying filters and retain the time variability of the series which provides a reference for the pretreatment of runoff series using ssa to optimize the network structure parameters of the elm model reduces the possibility of elm falling into a local optimum and enhances the generalization ability of the model in this study the combination of data preprocessing technology and optimization algorithm can effectively improve the prediction accuracy of monthly runoff prediction verify the effectiveness of combining the two strategies to improve the prediction accuracy provide a new method for medium and long term monthly runoff prediction and provide valuable technical reference for hydrologists to carry out runoff prediction in future research multiple factors should be considered to better understand characteristics for runoff forecasting modeling credit authorship contribution statement wen chuan wang conceptualization methodology writing original draft qi cheng methodology data curation writing original draft kwok wing chau writing original draft hao hu hong fei zang investigation dong mei xu formal analysis data curation declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors are grateful for the support of the special project for collaborative innovation of science and technology in 2021 no 202121206 and henan province university scientific and technological innovation team no 18irtsthn009 we gratefully acknowledge the critical comments and corrections of the anonymous reviewers which improved the presentation of the paper considerably appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129460 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2071,the seasonal cycle of ice formation and breakup in lake hanzhang china was monitored during the winter of 2020 2021 using a float equipped with meteorological hydrological and optical instruments this lake is located in mid latitude cold and dry climate zone we categorized the ice season into growth equilibrium and melting stages the thickness of ice increased by an average of 0 7 cm day 1 at the bottom of the ice during the growth stage and during the equilibrium stage it was stable at 35 0 0 5 cm during the melting stage the internal melting dominated the ice ablation 1 0 cm day 1 followed by bottom melting 0 45 cm day 1 and surface melting 0 25 cm day 1 the net short wave and long wave radiative fluxes dominated the heat budget throughout the seasonal cycle sublimation was 1 1 cm 73 of that in the growth stage during the melting stage the absorbed short wave radiative flux promoted internal melting enlarged the porosity and enhanced further surface melting the frequent negative air temperature during nighttime hindered the phase changes of the lake ice surface layer in addition the upward sensible heat flux in the lake water body increased from 7 8 to 14 5 w m 2 due to the increased light transmittance by lake ice the heat balance and heat fluxes in ice covered lakes in mid latitude dry climate have rarely been explored the results increase the knowledge of lake ice geophysics and are also useful for calibration and validation of lake ice models keywords lake hanzhang ice thickness heat budget of seasonal lake ice ice water heat flux data availability all data are available at the website https doi org 10 5281 zenodo 7790299 lu et al 2023 1 introduction lake ice is an important element of the cryosphere kirillin et al 2012 qin et al 2018 it impacts local climate ghanbari et al 2009 benefits human society by providing ice roads and locations for recreational activities and affects the ecology under the ice hampton et al 2017 the freezing of a lake is affected by the heat stored in the water in autumn while the ice breakup also has extensive effects on the lake ecology in spring and summer yang et al 2020 under the background of global warming changes in the lake ice season have intensified in recent years many studies have shown a shortening of the ice season karetnikov et al 2017 lopez et al 2019 sharma et al 2019 guo et al 2020 understanding the thermodynamic mechanisms of lake ice is the key to making predictions for future winters in freezing lakes in cold climates a stable lake ice cover forms in winter and turns the direct atmosphere water heat exchange into an atmosphere ice water transfer process leppäranta 2014 the evolution of the ice cover is controlled by the heat budget at the surface and bottom of the ice as well as the heat content within the ice the surface heat balance is controlled by the short wave and long wave radiative fluxes sensible and latent turbulent heat fluxes and the conductive heat flux from the ice precipitation leads to the accumulation of a snow layer which has a large impact on ice thickness cheng et al 2003 sublimation can reduce the ice mass at the surface huang et al 2019 the bias between heat conduction at the bottom of the ice and the upward sensible heat flux from the lake water results in the freezing and melting of ice having an impact on the hydrothermal structure and lake hydrodynamics below the ice wang et al 2021 the heat conduction through the ice is primarily controlled by the thermal properties of ice density heat conductivity porosity and impurities the absorbed solar radiative flux may bring the ice temperature to the melting point and induce internal ice melting leppäranta et al 2010 the results for the melting period have shown that is has different characteristics compared to the stable period leppäranta et al 2019 the ice water heat flux will also increase in the melting period jakkila et al 2009 lu et al 2020 and the under ice water column may also overturn pieters and lawrence 2009 these previous studies have enhanced our understanding of lake ice but there is still a lack of data for dry mid latitude climate characterized by ice thicknesses 0 5 m low snowfall and strong solar radiation through the winter field surveys are often conducted to investigate lake ice wang et al 2005 leppäranta et al 2010 kirillin et al 2018 huang et al 2022 and provide guidelines for modelling lake ice bernhardt et al 2012 semmler et al 2012 cheng et al 2014 however for safety reasons field surveys have mostly been conducted when the ice has sufficient bearing capacity the initial freezing and final breakup periods are therefore gaps in our knowledge of lake ice for the whole ice season the applicability of the growth and melting models also needs to be verified to fill these gaps a floating remote observation system fros xie et al 2022 was developed and used to measure the seasonal cycle of lake ice this study analyzed the seasonal energy budget for lake ice throughout the 2020 2021 winter in the warm temperate continental monsoon climate zone the specific aims of the study were to determine 1 the characteristics and main drivers of the heat fluxes in a complete seasonal cycle of lake ice in mid latitude dry climate and 2 the physical processes and typical heat balance characteristics during the early freezing and late melting phases 2 data and methods 2 1 research site the in situ observations were conducted in lake hanzhang fig 1 which is a brackish water body that originates from the bohai sea the salinity of the lake water remains around 5 7 ppt the average lake depth is 6 m with a maximum depth of 10 m and surface area of 10 km2 the lake stretches 8 km from west to east and is 0 5 1 5 km wide there is no inflow or drainage in winter and the bottom sediment is silt the ice season lasts 3 4 months from early december to mid march the region is governed by a warm temperate continental monsoon climate the long term 1981 2010 http data cma cn winter average air temperature and wind speed were 4 4 c and 3 4 m s 1 respectively the average accumulated precipitation was 35 7 mm water equivalent almost all in the form of snow snow cover is present for an average of one fifth of the freezing period 2 2 field observations the fros platform was deployed on december 1 2020 before ice formation and recovered on march 11 2021 when the ice had melted completely at the site the fros was equipped with the following instruments fig 1 and table 1 a a compact unmanned weather station maximet gmx 501 gill instruments ltd lymington uk capable of measuring the incident short wave radiative flux q s air temperature t az relative humidity r h wind speed u az direction u d and atmospheric pressure p a respectively b a pyranometer tbq 2 sunshine meteorological technology jinzhou ltd jinzhou china placed 0 6 m above the ice surface and facing downward to measure the reflected short wave radiation c a downward looking infrared radiometer si 411 apogee instruments logan ut usa measuring the surface skin temperature d a platinum resistance temperature detector ptwd to measure the ice and water temperature e two sonic ranging sensors pa500 6 tritech westhill uk and sr50a campbell scientific logan ut usa for measuring ice thickness and snow depth respectively f two spectral radiometers ramses acc vis trios rastede germany were deployed on the fros raft when ice formed one was placed facing upward 2 0 m above the ice surface to measure the downward incident spectral irradiance the other was placed facing downward 0 6 m above the ice surface to measure the reflected spectral irradiance g two spectral radiometers were placed facing upward at 0 7 and 1 1 m below the ice surface to measure the incident irradiance four spectral radiometers were operated between january 6 and march 11 2 3 heat budget of lake ice the surface heat gain q 0 comprising the radiation balance turbulent heat fluxes and the heat from the precipitation is defined as follows 1 q 0 q s0 q lnet q h q le q p where q s0 is the solar radiation absorbed by the surface q lnet is the net long wave radiation q h is the sensible heat flux q le is the latent heat flux and q p is the heat flux from precipitation during the observation period only a small amount of rainfall occurred and the flux q p was negligible the radiation terms are 2 q s0 1 α 1 γ q s 3 q lnet ε q ld σ t 0 4 where q s and q ld are the incident short wave and long wave radiation respectively α is the surface albedo γ is the transmittance through the near surface layer ε 0 97 is the ice surface emissivity σ is the stefan boltzmann constant and t 0 is the surface temperature because the fraction of infrared solar radiation is relatively stable and insensitive to cloudiness and solar zenith angle we took γ 0 5 leppäranta 2014 the incident long wave radiation is estimated as follows 4 q ld ε a σ t az 4 where t az is the air temperature and ε a is the effective atmospheric emissivity which depends on humidity and cloudiness leppäranta 2014 5 ε a a b e 1 c n 2 where a and b are the clear sky parameters of the brent equation typically a 0 68 and b 0 036 mbar 0 5 e is the water vapor pressure c is the cloudiness coefficient normal value is 0 18 and n is the cloudiness cloudiness can be estimated by the difference between the theoretical clear sky irradiance and the measured irradiance jakkila et al 2009 turbulent heat fluxes q h and q le are calculated by the bulk equations 6 q h ρ a c p c hz t az t 0 u az 7 q le ρ a l e c ez q az q 0 u az where ρ a is the air density c p is the specific heat of air l e is the latent heat of evaporation or sublimation the subscript z refers to altitude above the surface with z 0 representing the initial ice surface c hz and c ez are the turbulence transfer coefficients for the sensible heat flux and latent heat flux respectively q 0 and q az are the specific humidity at the surface and in the air respectively and u az is the wind speed the surface heat gain latent heat of melting and heat transfer from the ice surface should be balanced as follows 8 q 0 ρ i l f d h d t λ i t i z z 0 where the second term is the latent heat consumed by the melting at the ice surface ρ i is the ice density l f is the latent heat of melting t i is the ice temperature and λ i is the thermal conductivity of the ice z 0 refers to the partial derivative just below the ice surface the solar radiation absorption by the ice interior q i is calculated as follows 9 q i 1 α γ q s q d h i where q d h i is the downward irradiance reaching the water beneath the ice and can be estimated from two trios sensors under the ice as follows 10 q d z q d h i exp k w z h i where h i is the ice thickness in the data z 0 7 and 1 1 m and q d h i can be calculated from the measurements the attenuation coefficient of light in water is k w 0 018 cm 1 the internal light transmittance of the ice cover is 11 τ exp k s h s k si h si k i h i where k s k si and k i are the attenuation coefficients of snow snow ice and congelation ice respectively and h s h si and h i are the thickness of snow snow ice and congelation ice respectively the ice cover of lake hanzhang was almost completely composed of congelation ice and due to the absence of snow during the growth stage the transmittance was estimated as τ exp k i h i internal melting can be estimated from the net solar radiation absorbed by the ice q im when the average ice temperature reached 0 c it was represented by an equivalent thickness h im nh i equal to the loss of ice volume per area over the entire ice thickness with n as the porosity the daily change of h im was the internal melting rate v i the equivalent thickness equals the porosity times thickness and the evolution of porosity is obtained from 12 ρ i l f dn h i dt q im when n n 0 5 the ice breaks due to its own weight and the remaining ice cover rapidly melts at the bottom of the ice the heat budget is calculated as follows 13 f w ρ i l f d h i d t λ i t i z z ice bottom 0 where the second term denoted by fl is the latent heat generated by the growth or melting at the bottom of the ice f w plays a significant role especially during the melting of ice but at the same time it is more difficult to determine 14 f w λ w t w z z ice bottom where λ w is the thermal conductivity of water and t w is water temperature in laminar flow λ w k wat 0 569 w m 1 c 1 in turbulent conditions the first order theory is formally similar to eq 14 but λ w k wat 10 100 w m 1 c 1 and the eddy conductivity depends on the roughness of the bottom of the ice and the stratification of the boundary layer the flow under a stable lake ice cover is usually in a laminar turbulent transition regime and the exchange coefficient is poorly understood but it is an order of magnitude higher than in the laminar case shirasawa et al 2006 when the solar radiation triggered convection the effective thermal conductivity k wat 10 w m 1 c 1 was chosen and the temperature gradient was taken across the conduction layer δ 2 m fig 2 3 results and analysis 3 1 weather conditions the lake was frozen on december 4 and the ice cover disappeared in mid march the entire observation period was 101 days during which the ice cover lasted for 97 days the meteorological conditions are shown in fig 3 the average air temperature during the observation period was 4 1 c and the lowest air temperature 19 8 c occurred on january 7 fig 3a the average humidity was 63 8 and the highest humidity was close to 100 on january 26 and 27 mainly due to a heavy fog that resulted in visibility being 200 m fig 3b the wind speed was on average 3 0 m s 1 higher in february and march than in december and january fig 3c the daily peak of net solar radiation remained around 500 w m 2 until february and then gradually increased reaching 794 w m 2 on march 6 fig 3d the peak was lower during periods of snow cover and on cloudy days 3 2 snow and ice mass balance the snow and ice mass balance of lake hanzhang over the seasonal cycle is shown in fig 4 the evolution of the lake ice cover occurred in three stages the growth rate of the ice thickness was about 0 7 cm day 1 from december 4 2020 to january 20 2021 when it formed as congelation ice fig 4 this period was defined as the growth stage from january 21 to february 18 the ice thickness was stable 35 0 0 5 cm with a maximum of 35 5 cm and this period was defined as the equilibrium stage on february 19 the ice entered the melting stage the three stages were defined in the following way ten days of daily ice thickness values were used as samples and that sample was taken as the start of the equilibrium stage when the standard deviation was 0 5 cm for the first time when the standard deviation was 0 5 cm for the last time the last day in the sample was taken as the start of the melting stage almost all melting took place at the bottom and internal of the ice with a mean melt rate of 1 45 cm day 1 while the surface melting rate was only 0 25 cm day 1 three snowfalls occurred on january 15 january 28 and february 15 fig 4 with thicknesses of 1 0 5 9 and 6 3 cm respectively there have been few field investigations of the early freezing and late melting periods and we therefore considered these two phases separately the characteristics of the two periods are shown in figs 5 and 6 on december 3 a thin ice cover formed at the study site for a short period with surface temperature below 0 c but then the surface opened again under the influence of solar radiation and wind with surface temperature above 0 c fig 5a next night the ice cover was stabilized and the surface temperature remained below 0 the wind speed was seldom 4 m s 1 before the freezing event fig 5b and mixed layer depth was 1 2 m fig 5e high wind speed would lead to an increase of the mixing depth slowing the decline of the surface water temperature and delaying the freezing event toffolon et al 2021 the albedo increased after the ice cover formed above 0 1 but remained low when the ice was thin fig 5c as the ice cover formed the turbulent heat flux remained fig 5d the heat loss rose again during the windy weather on december 5 and 9 prior to the formation of the ice cover the water body was stratified with cold upper layer and the deep water temperature was at 4 c fig 5e the formation of ice cover blocked the direct heat exchange between the atmosphere and the water body and the water temperature gradually decreased to 2 melting of the lake ice cover started from the bridge piers on the east side of the observation site and gradually extended westward showing a clear lateral melting pattern fig 6a according to the fros video records the ice surface at the observation site looked gray at 13 00 on march 10 fig 6b and the ice was completely melted about 10 h later the open water surface continued to progress westwards and the entire lake was completely open on march 17 in the late melting period the air temperature fluctuated around the freezing point but the general trend was almost consistent with the daily average of 1981 2010 fig 6c when the air temperature had risen above 0 c the surface temperature increased to 0 c resulting in the melting of a very thin layer on the ice surface however when the air temperature dropped below 0 c again the surface melt water was refrozen causing a sharp drop in the surface temperature this physical process became clearer when combining the temperature record with the variations in surface albedo fig 6d when the air temperature was maintained above 0 c the albedo gradually decreased with the surface melting and the albedo increased when cold air refroze the surface meltwater even for a very short time the increased intensity of solar radiation and reduced albedo during the melting stage directly resulted in higher net radiation absorbed by the ice and the under ice water column fig 3d the ice temperature increased to the melting point and the part of solar radiation absorbed within the ice caused internal melting and the part absorbed in the water heated the water but also added on the melting of ice at the bottom the role played by the solar radiation during the melting stage was remarkable and with positive feedback so that although there was no notable air temperature increase fig 3a accelerated melting of the ice cover occurred fig 4 during the growth stage the ice temperature profile was nearly linear and the temperature gradients in the surface and bottom layers were similar fig 7 a in the equilibrium stage the ice temperature profile became concave and the surface temperature gradient was slightly higher than the bottom layer in later melting ice temperature was between 0 and 1 with no significant gradient at the beginning of the melting stage the water temperature was relatively low at 3 m depth 2 c and around 3 c at 4 m depth lake bottom and they did not change significantly with time fig 7b the main water temperature variations occurred in the 0 5 1 m depth layer increasing from 2 to 2 2 c on february 19 to 3 6 4 9 c on february 28 the thermal structure state was broken on march 1 fig 7c showing a significant decrease in water temperature at 1 m and an increase at 3 m the maximum water temperature difference slightly above 3 was rapidly reduced to 2 in march significant changes in water temperature structure occurred in the upper 2 m layer changes in the hydrothermal structure of the under ice boundary layer triggered by ice melting were driven together by salinity stratification and solar radiation the thermal structure of the under ice water column and the ice water heat flux during the ice covered period is an important part of the heat feedback between the ice and water and this needs to be investigated in conjunction with detail data of boundary layer dynamics and solar radiation bluteau et al 2017 winters et al 2019 3 3 heat budget 3 3 1 ice surface heat budget the albedo and transmittance of the ice cover are shown in fig 8 the albedo was determined by global radiation in the 300 3000 nm band and the transmittance was determined by photosynthetically active radiation par and covered the 400 700 nm band snowfall was 1 cm on december 12 which was lower than the accuracy of the snow depth sensor we did not define this case as a snowfall event because the snow did not cover the entire lake but such a thin layer of snowflakes also caused detectable changes in albedo fig 8a the presence of fresh snow raised the albedo significantly with an even 1 cm snow layer increasing the albedo to 0 6 on january 15 the last two snowfalls with about 6 cm snow accumulation produced an albedo of 0 9 as the snow cover gradually deteriorated due to the action of wind and solar radiation the albedo decreased consistently day by day additionally the albedo was smaller in the early freezing and later melting stages than in the other stages this was determined visually from the daily average albedo fig 8a with open water and very thin ice 5 cm before december 12 the albedo was small only about 0 1 the albedo decreased again to about 0 1 for an ice thickness of 20 cm on march 4 with meltwater absorbing much of the radiation the albedo was consistent with previous reports in fresh snow and ice free conditions but the albedo for bare ice was about 0 20 0 25 less than the previously reported values of about 0 4 in the boreal zone e g arst et al 2006 this was attributed to the small ice thickness and high solar elevation in the study site compared with the sub polar and polar latitudes where previous studies were conducted the light attenuation coefficient k i was calculated using the spectral irradiance and ice thickness measurements made between january 7 and 14 the result was k i 0 04 cm 1 which was higher than in lake vendyurskoe s congelation ice k i 0 017 cm 1 but lower than in snow ice k si 0 06 cm 1 leppäranta et al 2010 this was because the water body of lake hanzhang had a low transparency secchi depth 1 m and the ice cover was brackish ice the transmittance between december 3 and january 6 was simulated by τ exp k i h i while the transmittance from january 7 to march 10 was according to the observations with the ice thickness around the maximum the transmittance stabilized at around 0 2 however the presence of snow cover caused the transmittance to be 0 1 and occasionally only slightly 0 during the melting stage there was no significant increase in transmittance as the ice thickness decreased this was because changes within the ice altered its optical properties increasing the scattering coefficient and lowering the transmission yu et al 2022 fig 9 shows the surface heat budget during the ice season the average standard deviation surface absorption solar radiation and net long wave radiation were q s0 41 6 19 7 w m 2 fig 9a and q lnet 64 2 9 8 w m 2 fig 9b the q s0 fluctuated more widely than q lnet because of the large variability in the solar cycle fig 3d and albedo fig 9b during the ice covered period the turbulent fluxes were q h 5 7 13 2 w m 2 and q le 2 3 4 7 w m 2 respectively fig 9c and 9d the surface heat gain was 19 2 29 8 w m 2 fig 9e the ice surface lost heat during ice growth followed by heat uptake during ice melting the surface heat balance was mainly controlled by the radiation balance and the turbulent heat fluxes occasionally peaked in response to changes in air temperature humidity and wind speed fig 3a 3b and 3c variations in the heat balance terms at different stages of the ice season are more interesting than the average and provide a deeper insight into the heat budget characteristics the q s0 decreased by 11 5 during the transition from the growth stage to the equilibrium stage but increased rapidly by 106 2 as it entered the melting stage fig 9a this was because the snow cover existed mainly in the equilibrium stage but the solar noon altitude and the day length increased during the melting stage the mean value of q lnet was smallest in the equilibrium stage fig 9b when it was 18 4 and 10 0 smaller than in the growth and melting stages respectively the mean values of the sensible heat flux in the equilibrium and melting stages were 8 8 10 1 and 13 0 13 9 w m 2 which were both significantly higher than the value of 0 9 12 6 w m 2 in the growth stage fig 9c this was attributed to the increase in the air surface temperature difference and wind speed the latent heat fluxes for the three periods were 4 3 4 1 0 2 3 2 and 0 6 5 8 w m 2 respectively fig 9d therefore the equivalent thickness h sub of the sublimated ice in the three stages were 7 6 1 3 and 1 9 mm the sum of h sub 11 0 mm only 3 of the maximum ice thickness 355 mm the mean bowen ratio was q h q le 2 5 in the transition from the growth stage to the equilibrium stage the mean surface heat flux was reduced by 56 9 fig 9e entering the melting stage the net surface heat flux shifted rapidly from 15 6 21 2 w m 2 to 16 3 26 8 w m 2 and the surface layer began to absorb heat 3 3 2 absorption of solar radiation by the ice interior fig 10 shows the solar radiation absorbed inside the ice and the associated potential internal melting rate during the ice covered period the average solar radiation absorbed by the ice during the complete seasonal cycle was q i 14 5 14 2 w m 2 fig 10a during the growth stage q i was only 7 5 5 7 w m 2 the solar radiation absorbed inside the ice gradually increased with the increase in ice thickness upon reaching the equilibrium q i was approximately doubled to 12 2 12 9 w m 2 and the fluctuations in this stage were mainly due to snowfall during the melting stage q i increased further to q i 34 6 11 5 w m 2 the fluctuations of q i during the melting stage were mainly due to the weather for example on cloudy days e g february 28 and march 5 the net radiation peak was 250 w m 2 fig 3d the phase change of the lake ice surface layer is hindered by the positive and negative fluctuations of the daily mean air temperature fig 3a and fig 10b internal melting resulted in an increase in porosity and a decrease in volume per unit surface area of 1 0 cm per day throughout the melting stage fig 10b melting refreezing caused fluctuations in porosity the maximum porosity did not exceed 0 5 and the ice cover was completely melted without significant breakup 3 3 3 ice bottom heat budget fig 11 shows the ice water heat flux f w and the latent heat of phase change f l at the ice bottom the mean values of f w and f l during the ice covered period were 7 7 4 1 and 3 2 33 2 w m 2 respectively fig 11a and 11b in the growth and equilibrium stages f w was 4 8 2 0 and 7 8 1 8 w m 2 respectively f w was higher in the equilibrium stage than in the growth stage f w increased by 86 in the melting stage the ice water heat flux of 14 5 1 4 w m 2 was higher than in the previous observation period 8 1 w m 2 which was due to the high water temperature in the late melting stage of this survey xie et al 2021 2022 the f l during the growth stage was 24 8 22 3 w m 2 and the mean value of f l during the equilibrium stage was 0 corresponding to a consistent level of ice thickness with fluctuations only within 0 5 cm the value dropped to 44 2 27 0 w m 2 in the melting stage because internal melting increases the porosity fig 10b f l cuts more out of ice thickness in the progress of the melting stage fig 11b 4 discussion 4 1 heat budget during the three stages the ice season can be characterized by the evolution in the heat content of the ice cover which has a closed loop through the seasonal cycle the ice cover collects negative latent heat during the growth period and this heat is released by the external heat input in the melting period the heat content of ice can be expressed as h h 0 δh where h0 is the reference heat content of liquid water at the freezing point t tf and δh 0 is the heat content of ice as shown by eq 15 15 δ h ρ i c i t t f h i ρ i l f h i where c i is the specific heat of ice and t is the mean ice temperature i e δh 0 contains a cold component and latent heat then the temporal evolution is 16 d d t δ h ρ i c i d d t t t f h i ρ i l f d d t h i thus we can calculate the evolution of δh from the ice temperature and thickness data there were also external fluxes to consider surface flux q 0 interior flux q i and bottom flux f w thus 17 d d t δ h q 0 q i f w the evolution of δh can be used to control the heat fluxes table 2 equation 16 gives the true change in the heat content while eq 17 indicates how close the measured heat fluxes are to the actual change in heat content table 2 shows the components of the lake ice heat budget during the growth equilibrium and melting stages the heat content of ice and the external heat input realized a closed loop fig 12 the differences in the heat content during the equilibrium stage were due to the neglect of the heat content of the snow cover in the growth stage the residual 1 0 w m 2 and q s0 and q lnet were the main parameters leading to a change in the heat content in the ice q i f w 12 3 w m 2 hindering the growth of the ice cover table 2 90 of the snowfall occurred in the equilibrium stage and therefore the surface was covered with snow for more than half of this stage fig 4 the residual 4 8 w m 2 mainly due to changes in the latent heat of snow and changes in the heat content in addition the q h q i and f w increased during this stage with multiple heat fluxes together controlling the emergence of the equilibrium stage but little involvement of q le the most complex physical process occurred during the melting stage when the residual 5 0 w m 2 the increase in the intensity of incident solar radiation and the decrease in albedo led to a significant increase in q s0 in addition the three parameters of q h q i and f w also reached their maximum values throughout the ice covered period and all contributed to the recession of the ice cover the number of days spent in the melting stage was therefore only 40 of the number in the growth stage investigating the whole ice cover process in terms of the seasonal cycle revealed that solar radiation absorbed by the surface and net long wave radiation dominated the ice cover processes with q i and f w playing a secondary controlling role the q h provided a high heat flux mainly during the melting stage q le caused sublimation mainly during the growth stage the thermal balance was almost closed throughout the ice covered period and there was only a residual of about 3 0 w m 2 the lack of accuracy of the data was the main reason for the existence of residuals it was difficult to distinguish the near surface layer from the interior during the thin ice phase which may have led to errors in q i additionally parametric calculations of cloudiness at night were not available leading to a reliance on visual translations and references to local forecasts which in turn led to errors in net long wave radiation in contrast to previous studies we obtained a case study of an almost complete seasonal cyclic lake ice heat budget closure future repetitive in situ observations of the study area are essential to fully understand the seasonal cycle of lake ice 4 2 comparison with other lakes lake hanzhang has a smaller area than lake great bear rouse et al 2008 lake ulansuhai huang et al 2022 and lake simcoe yang et al 2020 the water area of 10 km2 and the maximum depth of 10 m are very similar to those of lake vendyurskoe leppäranta et al 2010 and lake orajärvi cheng et al 2014 but the ice covered period is only half of that in these two lakes the local climate was found to be the primary factor affecting the ice season characteristics in lake hanzhang the snow covered period was 20 of the whole ice season with the maximum snowfall resulting in about 6 cm snow accumulation thus there was almost no snow ice or superimposed ice formed on the surface in contrast for lake kilpisjärvi lake orajärvi lake macdonald ariano and brown 2019 lake vendyurskoe leppäranta et al 2010 and lake pääjärvi jakkila et al 2009 it was found that superimposed ice accounted for a notable proportion 20 of the total ice thickness ice surface melting was 0 25 cm day 1 in lake hanzhang in the boreal zone for lake vendyurskoe the reported surface melt rate was 1 2 cm day 1 during the melting stage and the air temperature was positive in the daytime and negative at night leppäranta et al 2010 in contrast lake hanzhang had a negative air temperature throughout the day for 30 of the melting stage and even part of the open water east of the observation site refroze in a tundra environment lake kilpisjärvi exhibited surface melting rates of 2 9 and 0 8 cm day 1 for two different melting periods the former case was high because the maximum daytime air temperature was 25 c during the melting period while the latter case was close to the climatic average with an air temperature around 5 c during the day and close to 0 c at night leppäranta et al 2019 the air temperature at lake hanzhang during the melting period was also close to the climatic average fig 6c and the fluctuations of the daily average temperature around the melting point were also recorded in the previous observation period xie et al 2021 in the melting stage lake hanzhang had an average internal melting rate of 1 0 cm day 1 which was close to lake vendyurskoe leppäranta et al 2010 and higher than that reported from lake lake kilpisjärvi leppäranta et al 2019 bottom melting was close to that of many other lakes leppäranta et al 2010 leppäranta et al 2019 huang et al 2019 a remarkable increase in the ice water heat flux in lake hanzhang was observed during the melting period compared to the growth period which was similar to observations made at lake pääjärvi jakkila et al 2009 the average heat flux over the entire ice covered period was 7 7 w m 2 which was close to the reported values for lake baikal aslamov et al 2014 lake kilpisjärvi kirillin et al 2018 and lake saroma ko lagoon shirasawa et al 2006 but less than the values for lake blh a huang et al 2019 and lake ulansuhai huang et al 2022 5 conclusion and future prospects a field survey of the full seasonal evolution of lake ice in lake hanzhang during 2020 2021 was conducted to investigate the heat budget of the ice cover a dataset of lake ice evolution parameters was established especially for the early freezing and late melting periods the conclusions were as follows 1 the heat budget during the whole ice covered period was dominated by the solar radiation absorbed by the ice surface 41 6 19 7 w m 2 and the net long wave radiation 64 2 9 8 w m 2 the sensible and latent heat in the turbulent heat flux were 5 7 13 2 and 2 3 4 7 w m 2 respectively the solar radiation absorbed inside the ice was 14 5 14 2 w m 2 the average ice water heat flux was 7 7 4 1 w m 2 which was consistent with previous reports the heat budget resulted in an ice thickness growth rate of 0 7 cm day 1 surface melting of 0 25 cm day 1 internal melting rate of 1 0 cm day 1 and bottom melting rate of 0 45 cm day 1 over a complete seasonal cycle the total sublimation during the whole ice covered period was 1 1 cm the heat budget for the full ice season was closed 2 lake ice was characterized by a clear three stage evolution with obvious differences in the heat budget these were defined as the growth stage equilibrium stage and melting stage during the three stages the solar radiation absorbed by the surface layer first decreased by 11 5 and then increased by 106 2 reaching 66 8 22 9 w m 2 in the melting stage the net long wave radiation showed a decrease followed by an increase during the three stages there were occasional increases in the turbulent sensible heat flux caused by brief high winds and sudden changes in air temperature while the seasonal increases in wind speed and warmer temperatures controlled the gradual increase in the turbulent sensible heat flux the turbulent latent heat flux only played an important role in the growth stage the solar radiation absorbed by the ice increased gradually in the three stages the ice water heat flux increased by 86 during the melting period from 7 8 to 14 5 w m 2 3 during the early freezing and late melting stages for which there were no previous measurements the albedo did not change significantly until the ice thickness reached 5 cm the frequent negative air temperature during nighttime hindered the phase changes of the lake ice surface layer and also caused the albedo to vary around 0 1 in the late melting period the albedo declined from 0 20 to 0 25 to about 0 1 the transmittance was about 0 2 and the maximum porosity was 0 5 4 snow covered the ice surface for only 20 of the whole ice season one snowfall of 1 cm and two snowfalls of about 6 cm resulted in sharp increases in albedo of 0 4 and 0 6 respectively and a decrease in transmittance of 0 2 the ice cover with a maximum thickness of 35 5 cm was almost completely comprised of black ice with white ice accounting for 5 this study provides the first insight into the variations in the heat budget of lake ice cover during a full seasonal cycle the variations of the heat budget in different stages of lake ice cover were obtained from this case study which further improved our understanding of the physical process of the ice cover and will provide a reference for model development in the future the solar radiative transfer and thermal structure of under ice water during the seasonal cycle of lake ice should also be studied credit authorship contribution statement fei xie formal analysis investigation writing original draft peng lu supervision conceptualization matti leppäranta writing review editing bin cheng writing review editing zhijun li supervision conceptualization yiwen zhang investigation hang zhang investigation jiaru zhou investigation declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was supported by the national key r d program of china 2019yfe0197600 the national natural science foundation of china 41922045 41876213 52211530038 and the liaoning revitalization talents program xlyc2007033 
2071,the seasonal cycle of ice formation and breakup in lake hanzhang china was monitored during the winter of 2020 2021 using a float equipped with meteorological hydrological and optical instruments this lake is located in mid latitude cold and dry climate zone we categorized the ice season into growth equilibrium and melting stages the thickness of ice increased by an average of 0 7 cm day 1 at the bottom of the ice during the growth stage and during the equilibrium stage it was stable at 35 0 0 5 cm during the melting stage the internal melting dominated the ice ablation 1 0 cm day 1 followed by bottom melting 0 45 cm day 1 and surface melting 0 25 cm day 1 the net short wave and long wave radiative fluxes dominated the heat budget throughout the seasonal cycle sublimation was 1 1 cm 73 of that in the growth stage during the melting stage the absorbed short wave radiative flux promoted internal melting enlarged the porosity and enhanced further surface melting the frequent negative air temperature during nighttime hindered the phase changes of the lake ice surface layer in addition the upward sensible heat flux in the lake water body increased from 7 8 to 14 5 w m 2 due to the increased light transmittance by lake ice the heat balance and heat fluxes in ice covered lakes in mid latitude dry climate have rarely been explored the results increase the knowledge of lake ice geophysics and are also useful for calibration and validation of lake ice models keywords lake hanzhang ice thickness heat budget of seasonal lake ice ice water heat flux data availability all data are available at the website https doi org 10 5281 zenodo 7790299 lu et al 2023 1 introduction lake ice is an important element of the cryosphere kirillin et al 2012 qin et al 2018 it impacts local climate ghanbari et al 2009 benefits human society by providing ice roads and locations for recreational activities and affects the ecology under the ice hampton et al 2017 the freezing of a lake is affected by the heat stored in the water in autumn while the ice breakup also has extensive effects on the lake ecology in spring and summer yang et al 2020 under the background of global warming changes in the lake ice season have intensified in recent years many studies have shown a shortening of the ice season karetnikov et al 2017 lopez et al 2019 sharma et al 2019 guo et al 2020 understanding the thermodynamic mechanisms of lake ice is the key to making predictions for future winters in freezing lakes in cold climates a stable lake ice cover forms in winter and turns the direct atmosphere water heat exchange into an atmosphere ice water transfer process leppäranta 2014 the evolution of the ice cover is controlled by the heat budget at the surface and bottom of the ice as well as the heat content within the ice the surface heat balance is controlled by the short wave and long wave radiative fluxes sensible and latent turbulent heat fluxes and the conductive heat flux from the ice precipitation leads to the accumulation of a snow layer which has a large impact on ice thickness cheng et al 2003 sublimation can reduce the ice mass at the surface huang et al 2019 the bias between heat conduction at the bottom of the ice and the upward sensible heat flux from the lake water results in the freezing and melting of ice having an impact on the hydrothermal structure and lake hydrodynamics below the ice wang et al 2021 the heat conduction through the ice is primarily controlled by the thermal properties of ice density heat conductivity porosity and impurities the absorbed solar radiative flux may bring the ice temperature to the melting point and induce internal ice melting leppäranta et al 2010 the results for the melting period have shown that is has different characteristics compared to the stable period leppäranta et al 2019 the ice water heat flux will also increase in the melting period jakkila et al 2009 lu et al 2020 and the under ice water column may also overturn pieters and lawrence 2009 these previous studies have enhanced our understanding of lake ice but there is still a lack of data for dry mid latitude climate characterized by ice thicknesses 0 5 m low snowfall and strong solar radiation through the winter field surveys are often conducted to investigate lake ice wang et al 2005 leppäranta et al 2010 kirillin et al 2018 huang et al 2022 and provide guidelines for modelling lake ice bernhardt et al 2012 semmler et al 2012 cheng et al 2014 however for safety reasons field surveys have mostly been conducted when the ice has sufficient bearing capacity the initial freezing and final breakup periods are therefore gaps in our knowledge of lake ice for the whole ice season the applicability of the growth and melting models also needs to be verified to fill these gaps a floating remote observation system fros xie et al 2022 was developed and used to measure the seasonal cycle of lake ice this study analyzed the seasonal energy budget for lake ice throughout the 2020 2021 winter in the warm temperate continental monsoon climate zone the specific aims of the study were to determine 1 the characteristics and main drivers of the heat fluxes in a complete seasonal cycle of lake ice in mid latitude dry climate and 2 the physical processes and typical heat balance characteristics during the early freezing and late melting phases 2 data and methods 2 1 research site the in situ observations were conducted in lake hanzhang fig 1 which is a brackish water body that originates from the bohai sea the salinity of the lake water remains around 5 7 ppt the average lake depth is 6 m with a maximum depth of 10 m and surface area of 10 km2 the lake stretches 8 km from west to east and is 0 5 1 5 km wide there is no inflow or drainage in winter and the bottom sediment is silt the ice season lasts 3 4 months from early december to mid march the region is governed by a warm temperate continental monsoon climate the long term 1981 2010 http data cma cn winter average air temperature and wind speed were 4 4 c and 3 4 m s 1 respectively the average accumulated precipitation was 35 7 mm water equivalent almost all in the form of snow snow cover is present for an average of one fifth of the freezing period 2 2 field observations the fros platform was deployed on december 1 2020 before ice formation and recovered on march 11 2021 when the ice had melted completely at the site the fros was equipped with the following instruments fig 1 and table 1 a a compact unmanned weather station maximet gmx 501 gill instruments ltd lymington uk capable of measuring the incident short wave radiative flux q s air temperature t az relative humidity r h wind speed u az direction u d and atmospheric pressure p a respectively b a pyranometer tbq 2 sunshine meteorological technology jinzhou ltd jinzhou china placed 0 6 m above the ice surface and facing downward to measure the reflected short wave radiation c a downward looking infrared radiometer si 411 apogee instruments logan ut usa measuring the surface skin temperature d a platinum resistance temperature detector ptwd to measure the ice and water temperature e two sonic ranging sensors pa500 6 tritech westhill uk and sr50a campbell scientific logan ut usa for measuring ice thickness and snow depth respectively f two spectral radiometers ramses acc vis trios rastede germany were deployed on the fros raft when ice formed one was placed facing upward 2 0 m above the ice surface to measure the downward incident spectral irradiance the other was placed facing downward 0 6 m above the ice surface to measure the reflected spectral irradiance g two spectral radiometers were placed facing upward at 0 7 and 1 1 m below the ice surface to measure the incident irradiance four spectral radiometers were operated between january 6 and march 11 2 3 heat budget of lake ice the surface heat gain q 0 comprising the radiation balance turbulent heat fluxes and the heat from the precipitation is defined as follows 1 q 0 q s0 q lnet q h q le q p where q s0 is the solar radiation absorbed by the surface q lnet is the net long wave radiation q h is the sensible heat flux q le is the latent heat flux and q p is the heat flux from precipitation during the observation period only a small amount of rainfall occurred and the flux q p was negligible the radiation terms are 2 q s0 1 α 1 γ q s 3 q lnet ε q ld σ t 0 4 where q s and q ld are the incident short wave and long wave radiation respectively α is the surface albedo γ is the transmittance through the near surface layer ε 0 97 is the ice surface emissivity σ is the stefan boltzmann constant and t 0 is the surface temperature because the fraction of infrared solar radiation is relatively stable and insensitive to cloudiness and solar zenith angle we took γ 0 5 leppäranta 2014 the incident long wave radiation is estimated as follows 4 q ld ε a σ t az 4 where t az is the air temperature and ε a is the effective atmospheric emissivity which depends on humidity and cloudiness leppäranta 2014 5 ε a a b e 1 c n 2 where a and b are the clear sky parameters of the brent equation typically a 0 68 and b 0 036 mbar 0 5 e is the water vapor pressure c is the cloudiness coefficient normal value is 0 18 and n is the cloudiness cloudiness can be estimated by the difference between the theoretical clear sky irradiance and the measured irradiance jakkila et al 2009 turbulent heat fluxes q h and q le are calculated by the bulk equations 6 q h ρ a c p c hz t az t 0 u az 7 q le ρ a l e c ez q az q 0 u az where ρ a is the air density c p is the specific heat of air l e is the latent heat of evaporation or sublimation the subscript z refers to altitude above the surface with z 0 representing the initial ice surface c hz and c ez are the turbulence transfer coefficients for the sensible heat flux and latent heat flux respectively q 0 and q az are the specific humidity at the surface and in the air respectively and u az is the wind speed the surface heat gain latent heat of melting and heat transfer from the ice surface should be balanced as follows 8 q 0 ρ i l f d h d t λ i t i z z 0 where the second term is the latent heat consumed by the melting at the ice surface ρ i is the ice density l f is the latent heat of melting t i is the ice temperature and λ i is the thermal conductivity of the ice z 0 refers to the partial derivative just below the ice surface the solar radiation absorption by the ice interior q i is calculated as follows 9 q i 1 α γ q s q d h i where q d h i is the downward irradiance reaching the water beneath the ice and can be estimated from two trios sensors under the ice as follows 10 q d z q d h i exp k w z h i where h i is the ice thickness in the data z 0 7 and 1 1 m and q d h i can be calculated from the measurements the attenuation coefficient of light in water is k w 0 018 cm 1 the internal light transmittance of the ice cover is 11 τ exp k s h s k si h si k i h i where k s k si and k i are the attenuation coefficients of snow snow ice and congelation ice respectively and h s h si and h i are the thickness of snow snow ice and congelation ice respectively the ice cover of lake hanzhang was almost completely composed of congelation ice and due to the absence of snow during the growth stage the transmittance was estimated as τ exp k i h i internal melting can be estimated from the net solar radiation absorbed by the ice q im when the average ice temperature reached 0 c it was represented by an equivalent thickness h im nh i equal to the loss of ice volume per area over the entire ice thickness with n as the porosity the daily change of h im was the internal melting rate v i the equivalent thickness equals the porosity times thickness and the evolution of porosity is obtained from 12 ρ i l f dn h i dt q im when n n 0 5 the ice breaks due to its own weight and the remaining ice cover rapidly melts at the bottom of the ice the heat budget is calculated as follows 13 f w ρ i l f d h i d t λ i t i z z ice bottom 0 where the second term denoted by fl is the latent heat generated by the growth or melting at the bottom of the ice f w plays a significant role especially during the melting of ice but at the same time it is more difficult to determine 14 f w λ w t w z z ice bottom where λ w is the thermal conductivity of water and t w is water temperature in laminar flow λ w k wat 0 569 w m 1 c 1 in turbulent conditions the first order theory is formally similar to eq 14 but λ w k wat 10 100 w m 1 c 1 and the eddy conductivity depends on the roughness of the bottom of the ice and the stratification of the boundary layer the flow under a stable lake ice cover is usually in a laminar turbulent transition regime and the exchange coefficient is poorly understood but it is an order of magnitude higher than in the laminar case shirasawa et al 2006 when the solar radiation triggered convection the effective thermal conductivity k wat 10 w m 1 c 1 was chosen and the temperature gradient was taken across the conduction layer δ 2 m fig 2 3 results and analysis 3 1 weather conditions the lake was frozen on december 4 and the ice cover disappeared in mid march the entire observation period was 101 days during which the ice cover lasted for 97 days the meteorological conditions are shown in fig 3 the average air temperature during the observation period was 4 1 c and the lowest air temperature 19 8 c occurred on january 7 fig 3a the average humidity was 63 8 and the highest humidity was close to 100 on january 26 and 27 mainly due to a heavy fog that resulted in visibility being 200 m fig 3b the wind speed was on average 3 0 m s 1 higher in february and march than in december and january fig 3c the daily peak of net solar radiation remained around 500 w m 2 until february and then gradually increased reaching 794 w m 2 on march 6 fig 3d the peak was lower during periods of snow cover and on cloudy days 3 2 snow and ice mass balance the snow and ice mass balance of lake hanzhang over the seasonal cycle is shown in fig 4 the evolution of the lake ice cover occurred in three stages the growth rate of the ice thickness was about 0 7 cm day 1 from december 4 2020 to january 20 2021 when it formed as congelation ice fig 4 this period was defined as the growth stage from january 21 to february 18 the ice thickness was stable 35 0 0 5 cm with a maximum of 35 5 cm and this period was defined as the equilibrium stage on february 19 the ice entered the melting stage the three stages were defined in the following way ten days of daily ice thickness values were used as samples and that sample was taken as the start of the equilibrium stage when the standard deviation was 0 5 cm for the first time when the standard deviation was 0 5 cm for the last time the last day in the sample was taken as the start of the melting stage almost all melting took place at the bottom and internal of the ice with a mean melt rate of 1 45 cm day 1 while the surface melting rate was only 0 25 cm day 1 three snowfalls occurred on january 15 january 28 and february 15 fig 4 with thicknesses of 1 0 5 9 and 6 3 cm respectively there have been few field investigations of the early freezing and late melting periods and we therefore considered these two phases separately the characteristics of the two periods are shown in figs 5 and 6 on december 3 a thin ice cover formed at the study site for a short period with surface temperature below 0 c but then the surface opened again under the influence of solar radiation and wind with surface temperature above 0 c fig 5a next night the ice cover was stabilized and the surface temperature remained below 0 the wind speed was seldom 4 m s 1 before the freezing event fig 5b and mixed layer depth was 1 2 m fig 5e high wind speed would lead to an increase of the mixing depth slowing the decline of the surface water temperature and delaying the freezing event toffolon et al 2021 the albedo increased after the ice cover formed above 0 1 but remained low when the ice was thin fig 5c as the ice cover formed the turbulent heat flux remained fig 5d the heat loss rose again during the windy weather on december 5 and 9 prior to the formation of the ice cover the water body was stratified with cold upper layer and the deep water temperature was at 4 c fig 5e the formation of ice cover blocked the direct heat exchange between the atmosphere and the water body and the water temperature gradually decreased to 2 melting of the lake ice cover started from the bridge piers on the east side of the observation site and gradually extended westward showing a clear lateral melting pattern fig 6a according to the fros video records the ice surface at the observation site looked gray at 13 00 on march 10 fig 6b and the ice was completely melted about 10 h later the open water surface continued to progress westwards and the entire lake was completely open on march 17 in the late melting period the air temperature fluctuated around the freezing point but the general trend was almost consistent with the daily average of 1981 2010 fig 6c when the air temperature had risen above 0 c the surface temperature increased to 0 c resulting in the melting of a very thin layer on the ice surface however when the air temperature dropped below 0 c again the surface melt water was refrozen causing a sharp drop in the surface temperature this physical process became clearer when combining the temperature record with the variations in surface albedo fig 6d when the air temperature was maintained above 0 c the albedo gradually decreased with the surface melting and the albedo increased when cold air refroze the surface meltwater even for a very short time the increased intensity of solar radiation and reduced albedo during the melting stage directly resulted in higher net radiation absorbed by the ice and the under ice water column fig 3d the ice temperature increased to the melting point and the part of solar radiation absorbed within the ice caused internal melting and the part absorbed in the water heated the water but also added on the melting of ice at the bottom the role played by the solar radiation during the melting stage was remarkable and with positive feedback so that although there was no notable air temperature increase fig 3a accelerated melting of the ice cover occurred fig 4 during the growth stage the ice temperature profile was nearly linear and the temperature gradients in the surface and bottom layers were similar fig 7 a in the equilibrium stage the ice temperature profile became concave and the surface temperature gradient was slightly higher than the bottom layer in later melting ice temperature was between 0 and 1 with no significant gradient at the beginning of the melting stage the water temperature was relatively low at 3 m depth 2 c and around 3 c at 4 m depth lake bottom and they did not change significantly with time fig 7b the main water temperature variations occurred in the 0 5 1 m depth layer increasing from 2 to 2 2 c on february 19 to 3 6 4 9 c on february 28 the thermal structure state was broken on march 1 fig 7c showing a significant decrease in water temperature at 1 m and an increase at 3 m the maximum water temperature difference slightly above 3 was rapidly reduced to 2 in march significant changes in water temperature structure occurred in the upper 2 m layer changes in the hydrothermal structure of the under ice boundary layer triggered by ice melting were driven together by salinity stratification and solar radiation the thermal structure of the under ice water column and the ice water heat flux during the ice covered period is an important part of the heat feedback between the ice and water and this needs to be investigated in conjunction with detail data of boundary layer dynamics and solar radiation bluteau et al 2017 winters et al 2019 3 3 heat budget 3 3 1 ice surface heat budget the albedo and transmittance of the ice cover are shown in fig 8 the albedo was determined by global radiation in the 300 3000 nm band and the transmittance was determined by photosynthetically active radiation par and covered the 400 700 nm band snowfall was 1 cm on december 12 which was lower than the accuracy of the snow depth sensor we did not define this case as a snowfall event because the snow did not cover the entire lake but such a thin layer of snowflakes also caused detectable changes in albedo fig 8a the presence of fresh snow raised the albedo significantly with an even 1 cm snow layer increasing the albedo to 0 6 on january 15 the last two snowfalls with about 6 cm snow accumulation produced an albedo of 0 9 as the snow cover gradually deteriorated due to the action of wind and solar radiation the albedo decreased consistently day by day additionally the albedo was smaller in the early freezing and later melting stages than in the other stages this was determined visually from the daily average albedo fig 8a with open water and very thin ice 5 cm before december 12 the albedo was small only about 0 1 the albedo decreased again to about 0 1 for an ice thickness of 20 cm on march 4 with meltwater absorbing much of the radiation the albedo was consistent with previous reports in fresh snow and ice free conditions but the albedo for bare ice was about 0 20 0 25 less than the previously reported values of about 0 4 in the boreal zone e g arst et al 2006 this was attributed to the small ice thickness and high solar elevation in the study site compared with the sub polar and polar latitudes where previous studies were conducted the light attenuation coefficient k i was calculated using the spectral irradiance and ice thickness measurements made between january 7 and 14 the result was k i 0 04 cm 1 which was higher than in lake vendyurskoe s congelation ice k i 0 017 cm 1 but lower than in snow ice k si 0 06 cm 1 leppäranta et al 2010 this was because the water body of lake hanzhang had a low transparency secchi depth 1 m and the ice cover was brackish ice the transmittance between december 3 and january 6 was simulated by τ exp k i h i while the transmittance from january 7 to march 10 was according to the observations with the ice thickness around the maximum the transmittance stabilized at around 0 2 however the presence of snow cover caused the transmittance to be 0 1 and occasionally only slightly 0 during the melting stage there was no significant increase in transmittance as the ice thickness decreased this was because changes within the ice altered its optical properties increasing the scattering coefficient and lowering the transmission yu et al 2022 fig 9 shows the surface heat budget during the ice season the average standard deviation surface absorption solar radiation and net long wave radiation were q s0 41 6 19 7 w m 2 fig 9a and q lnet 64 2 9 8 w m 2 fig 9b the q s0 fluctuated more widely than q lnet because of the large variability in the solar cycle fig 3d and albedo fig 9b during the ice covered period the turbulent fluxes were q h 5 7 13 2 w m 2 and q le 2 3 4 7 w m 2 respectively fig 9c and 9d the surface heat gain was 19 2 29 8 w m 2 fig 9e the ice surface lost heat during ice growth followed by heat uptake during ice melting the surface heat balance was mainly controlled by the radiation balance and the turbulent heat fluxes occasionally peaked in response to changes in air temperature humidity and wind speed fig 3a 3b and 3c variations in the heat balance terms at different stages of the ice season are more interesting than the average and provide a deeper insight into the heat budget characteristics the q s0 decreased by 11 5 during the transition from the growth stage to the equilibrium stage but increased rapidly by 106 2 as it entered the melting stage fig 9a this was because the snow cover existed mainly in the equilibrium stage but the solar noon altitude and the day length increased during the melting stage the mean value of q lnet was smallest in the equilibrium stage fig 9b when it was 18 4 and 10 0 smaller than in the growth and melting stages respectively the mean values of the sensible heat flux in the equilibrium and melting stages were 8 8 10 1 and 13 0 13 9 w m 2 which were both significantly higher than the value of 0 9 12 6 w m 2 in the growth stage fig 9c this was attributed to the increase in the air surface temperature difference and wind speed the latent heat fluxes for the three periods were 4 3 4 1 0 2 3 2 and 0 6 5 8 w m 2 respectively fig 9d therefore the equivalent thickness h sub of the sublimated ice in the three stages were 7 6 1 3 and 1 9 mm the sum of h sub 11 0 mm only 3 of the maximum ice thickness 355 mm the mean bowen ratio was q h q le 2 5 in the transition from the growth stage to the equilibrium stage the mean surface heat flux was reduced by 56 9 fig 9e entering the melting stage the net surface heat flux shifted rapidly from 15 6 21 2 w m 2 to 16 3 26 8 w m 2 and the surface layer began to absorb heat 3 3 2 absorption of solar radiation by the ice interior fig 10 shows the solar radiation absorbed inside the ice and the associated potential internal melting rate during the ice covered period the average solar radiation absorbed by the ice during the complete seasonal cycle was q i 14 5 14 2 w m 2 fig 10a during the growth stage q i was only 7 5 5 7 w m 2 the solar radiation absorbed inside the ice gradually increased with the increase in ice thickness upon reaching the equilibrium q i was approximately doubled to 12 2 12 9 w m 2 and the fluctuations in this stage were mainly due to snowfall during the melting stage q i increased further to q i 34 6 11 5 w m 2 the fluctuations of q i during the melting stage were mainly due to the weather for example on cloudy days e g february 28 and march 5 the net radiation peak was 250 w m 2 fig 3d the phase change of the lake ice surface layer is hindered by the positive and negative fluctuations of the daily mean air temperature fig 3a and fig 10b internal melting resulted in an increase in porosity and a decrease in volume per unit surface area of 1 0 cm per day throughout the melting stage fig 10b melting refreezing caused fluctuations in porosity the maximum porosity did not exceed 0 5 and the ice cover was completely melted without significant breakup 3 3 3 ice bottom heat budget fig 11 shows the ice water heat flux f w and the latent heat of phase change f l at the ice bottom the mean values of f w and f l during the ice covered period were 7 7 4 1 and 3 2 33 2 w m 2 respectively fig 11a and 11b in the growth and equilibrium stages f w was 4 8 2 0 and 7 8 1 8 w m 2 respectively f w was higher in the equilibrium stage than in the growth stage f w increased by 86 in the melting stage the ice water heat flux of 14 5 1 4 w m 2 was higher than in the previous observation period 8 1 w m 2 which was due to the high water temperature in the late melting stage of this survey xie et al 2021 2022 the f l during the growth stage was 24 8 22 3 w m 2 and the mean value of f l during the equilibrium stage was 0 corresponding to a consistent level of ice thickness with fluctuations only within 0 5 cm the value dropped to 44 2 27 0 w m 2 in the melting stage because internal melting increases the porosity fig 10b f l cuts more out of ice thickness in the progress of the melting stage fig 11b 4 discussion 4 1 heat budget during the three stages the ice season can be characterized by the evolution in the heat content of the ice cover which has a closed loop through the seasonal cycle the ice cover collects negative latent heat during the growth period and this heat is released by the external heat input in the melting period the heat content of ice can be expressed as h h 0 δh where h0 is the reference heat content of liquid water at the freezing point t tf and δh 0 is the heat content of ice as shown by eq 15 15 δ h ρ i c i t t f h i ρ i l f h i where c i is the specific heat of ice and t is the mean ice temperature i e δh 0 contains a cold component and latent heat then the temporal evolution is 16 d d t δ h ρ i c i d d t t t f h i ρ i l f d d t h i thus we can calculate the evolution of δh from the ice temperature and thickness data there were also external fluxes to consider surface flux q 0 interior flux q i and bottom flux f w thus 17 d d t δ h q 0 q i f w the evolution of δh can be used to control the heat fluxes table 2 equation 16 gives the true change in the heat content while eq 17 indicates how close the measured heat fluxes are to the actual change in heat content table 2 shows the components of the lake ice heat budget during the growth equilibrium and melting stages the heat content of ice and the external heat input realized a closed loop fig 12 the differences in the heat content during the equilibrium stage were due to the neglect of the heat content of the snow cover in the growth stage the residual 1 0 w m 2 and q s0 and q lnet were the main parameters leading to a change in the heat content in the ice q i f w 12 3 w m 2 hindering the growth of the ice cover table 2 90 of the snowfall occurred in the equilibrium stage and therefore the surface was covered with snow for more than half of this stage fig 4 the residual 4 8 w m 2 mainly due to changes in the latent heat of snow and changes in the heat content in addition the q h q i and f w increased during this stage with multiple heat fluxes together controlling the emergence of the equilibrium stage but little involvement of q le the most complex physical process occurred during the melting stage when the residual 5 0 w m 2 the increase in the intensity of incident solar radiation and the decrease in albedo led to a significant increase in q s0 in addition the three parameters of q h q i and f w also reached their maximum values throughout the ice covered period and all contributed to the recession of the ice cover the number of days spent in the melting stage was therefore only 40 of the number in the growth stage investigating the whole ice cover process in terms of the seasonal cycle revealed that solar radiation absorbed by the surface and net long wave radiation dominated the ice cover processes with q i and f w playing a secondary controlling role the q h provided a high heat flux mainly during the melting stage q le caused sublimation mainly during the growth stage the thermal balance was almost closed throughout the ice covered period and there was only a residual of about 3 0 w m 2 the lack of accuracy of the data was the main reason for the existence of residuals it was difficult to distinguish the near surface layer from the interior during the thin ice phase which may have led to errors in q i additionally parametric calculations of cloudiness at night were not available leading to a reliance on visual translations and references to local forecasts which in turn led to errors in net long wave radiation in contrast to previous studies we obtained a case study of an almost complete seasonal cyclic lake ice heat budget closure future repetitive in situ observations of the study area are essential to fully understand the seasonal cycle of lake ice 4 2 comparison with other lakes lake hanzhang has a smaller area than lake great bear rouse et al 2008 lake ulansuhai huang et al 2022 and lake simcoe yang et al 2020 the water area of 10 km2 and the maximum depth of 10 m are very similar to those of lake vendyurskoe leppäranta et al 2010 and lake orajärvi cheng et al 2014 but the ice covered period is only half of that in these two lakes the local climate was found to be the primary factor affecting the ice season characteristics in lake hanzhang the snow covered period was 20 of the whole ice season with the maximum snowfall resulting in about 6 cm snow accumulation thus there was almost no snow ice or superimposed ice formed on the surface in contrast for lake kilpisjärvi lake orajärvi lake macdonald ariano and brown 2019 lake vendyurskoe leppäranta et al 2010 and lake pääjärvi jakkila et al 2009 it was found that superimposed ice accounted for a notable proportion 20 of the total ice thickness ice surface melting was 0 25 cm day 1 in lake hanzhang in the boreal zone for lake vendyurskoe the reported surface melt rate was 1 2 cm day 1 during the melting stage and the air temperature was positive in the daytime and negative at night leppäranta et al 2010 in contrast lake hanzhang had a negative air temperature throughout the day for 30 of the melting stage and even part of the open water east of the observation site refroze in a tundra environment lake kilpisjärvi exhibited surface melting rates of 2 9 and 0 8 cm day 1 for two different melting periods the former case was high because the maximum daytime air temperature was 25 c during the melting period while the latter case was close to the climatic average with an air temperature around 5 c during the day and close to 0 c at night leppäranta et al 2019 the air temperature at lake hanzhang during the melting period was also close to the climatic average fig 6c and the fluctuations of the daily average temperature around the melting point were also recorded in the previous observation period xie et al 2021 in the melting stage lake hanzhang had an average internal melting rate of 1 0 cm day 1 which was close to lake vendyurskoe leppäranta et al 2010 and higher than that reported from lake lake kilpisjärvi leppäranta et al 2019 bottom melting was close to that of many other lakes leppäranta et al 2010 leppäranta et al 2019 huang et al 2019 a remarkable increase in the ice water heat flux in lake hanzhang was observed during the melting period compared to the growth period which was similar to observations made at lake pääjärvi jakkila et al 2009 the average heat flux over the entire ice covered period was 7 7 w m 2 which was close to the reported values for lake baikal aslamov et al 2014 lake kilpisjärvi kirillin et al 2018 and lake saroma ko lagoon shirasawa et al 2006 but less than the values for lake blh a huang et al 2019 and lake ulansuhai huang et al 2022 5 conclusion and future prospects a field survey of the full seasonal evolution of lake ice in lake hanzhang during 2020 2021 was conducted to investigate the heat budget of the ice cover a dataset of lake ice evolution parameters was established especially for the early freezing and late melting periods the conclusions were as follows 1 the heat budget during the whole ice covered period was dominated by the solar radiation absorbed by the ice surface 41 6 19 7 w m 2 and the net long wave radiation 64 2 9 8 w m 2 the sensible and latent heat in the turbulent heat flux were 5 7 13 2 and 2 3 4 7 w m 2 respectively the solar radiation absorbed inside the ice was 14 5 14 2 w m 2 the average ice water heat flux was 7 7 4 1 w m 2 which was consistent with previous reports the heat budget resulted in an ice thickness growth rate of 0 7 cm day 1 surface melting of 0 25 cm day 1 internal melting rate of 1 0 cm day 1 and bottom melting rate of 0 45 cm day 1 over a complete seasonal cycle the total sublimation during the whole ice covered period was 1 1 cm the heat budget for the full ice season was closed 2 lake ice was characterized by a clear three stage evolution with obvious differences in the heat budget these were defined as the growth stage equilibrium stage and melting stage during the three stages the solar radiation absorbed by the surface layer first decreased by 11 5 and then increased by 106 2 reaching 66 8 22 9 w m 2 in the melting stage the net long wave radiation showed a decrease followed by an increase during the three stages there were occasional increases in the turbulent sensible heat flux caused by brief high winds and sudden changes in air temperature while the seasonal increases in wind speed and warmer temperatures controlled the gradual increase in the turbulent sensible heat flux the turbulent latent heat flux only played an important role in the growth stage the solar radiation absorbed by the ice increased gradually in the three stages the ice water heat flux increased by 86 during the melting period from 7 8 to 14 5 w m 2 3 during the early freezing and late melting stages for which there were no previous measurements the albedo did not change significantly until the ice thickness reached 5 cm the frequent negative air temperature during nighttime hindered the phase changes of the lake ice surface layer and also caused the albedo to vary around 0 1 in the late melting period the albedo declined from 0 20 to 0 25 to about 0 1 the transmittance was about 0 2 and the maximum porosity was 0 5 4 snow covered the ice surface for only 20 of the whole ice season one snowfall of 1 cm and two snowfalls of about 6 cm resulted in sharp increases in albedo of 0 4 and 0 6 respectively and a decrease in transmittance of 0 2 the ice cover with a maximum thickness of 35 5 cm was almost completely comprised of black ice with white ice accounting for 5 this study provides the first insight into the variations in the heat budget of lake ice cover during a full seasonal cycle the variations of the heat budget in different stages of lake ice cover were obtained from this case study which further improved our understanding of the physical process of the ice cover and will provide a reference for model development in the future the solar radiative transfer and thermal structure of under ice water during the seasonal cycle of lake ice should also be studied credit authorship contribution statement fei xie formal analysis investigation writing original draft peng lu supervision conceptualization matti leppäranta writing review editing bin cheng writing review editing zhijun li supervision conceptualization yiwen zhang investigation hang zhang investigation jiaru zhou investigation declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was supported by the national key r d program of china 2019yfe0197600 the national natural science foundation of china 41922045 41876213 52211530038 and the liaoning revitalization talents program xlyc2007033 
2072,remote sensing has long been used for inland water quality monitoring however due to the complex correlation between water quality parameters wqps and water optical properties the interactions of wqps and the impacts of climate using remote sensing reflectance r rs to adequately estimate wqps is still a grand challenge deep learning has the potential in capturing the correlation among r rs optically active constituents oacs and non oacs and is progressively used in remote sensing retrieval of inland water quality in this study the enhanced multimodal deep learning emdl models were proposed for chlorophyll a total phosphorous total nitrogen secchi disk depth dissolved organic carbon and dissolved oxygen retrieval in lake simcoe 80 km north of toronto canada the emdl models were developed and validated using the r rs data derived from the harmonized landsat and sentinel 2 images synchronized water quality measurements water surface temperature and climate data n 1173 the performance of the emdl models was compared to that of several other machine learning deep learning and empirical models using the developed emdl models the spatial distributions and long term variations of the wqps in lake simcoe from 2013 to 2019 were reconstructed the impacts of 12 potential natural and anthropogenic factors on the water quality of the entire lake simcoe and its two most concerned estuaries were also quantitatively discussed the results showed that the emdl models produced satisfactory performance in estimation of the six wqps with the slope being close to 1 0 84 0 95 normalized mean absolute error 20 17 and bias 14 68 the emdl models had the potential to reconstruct the spatial patterns and time series dynamics of water quality and effectively detect the gradients of spatial patterns this study provides a novel approach to supporting the environmental management and identification of the affecting factors for the lake simcoe watershed keywords deep learning remote sensing water quality landsat sentinel 2 data availability data will be made available on request 1 introduction inland waters such as lakes provide drinking water food recreational and economic opportunities and other critical support for the anthroposphere biosphere and environmental health tranvik et al 2009 effective and interpretable monitoring of long term and broad scale water quality changes and the affecting factors is key to environmental management stanley et al 2019 remote sensing has been considered as a practical method of the water quality monitoring and has been progressively applied to inland waters palmer et al 2015 schaeffer et al 2013 compared with traditional costly point based monitoring remote sensing supports full coverage periodic convenient and cost effective water quality monitoring when incident solar radiation or other light hits the water surface part of the light penetrates the water column and was absorbed and scattered by suspended and dissolved matter in water sagan et al 2020 the inherent optical properties iops of water e g absorption and scattering coefficients vary with water quality conditions and determine the water apparent optical properties aops e g remote sensing reflectance r rs from the radiances received by satellite sensors the iops and aops can be derived for water quality parameter wqp estimation since 1978 more than ten water color sensors have been put into orbits such as the coastal zone color scanner sea viewing wide field of view sensor moderate resolution imaging spectroradiometer modis medium resolution imaging spectrometer chinese ocean colour and temperature scanner onboard hy 1 ocean and land colour instrument olci and geostationary ocean color imager goci which have accumulated abundant remote sensing data for water quality monitoring however these sensors usually have relatively low spatial resolution usually hundreds of meters which limits their application in small scale inland lakes the landsat 8 was launched in 2013 and carries a push broom sensor with radiometric precision over 12 bit namely the operational land imager oli the oli added two new bands a coastal band and a cirrus band to the heritage landsat multispectral bands the oli provides multi spectral images with the spatial resolution of 30 m and the repeat cycle of 16 days the sentinel 2 mission was initialized in 2015 and comprises a constellation of two polar orbiting satellites the constellation improves the repeat cycle to 5 days 2 3 days at mid latitudes the multispectral instrument msi onboard sentinel 2 has similar spectral bands to oli but the spatial resolution of the visible and near infrared nir bands was improved to 10 m although both oli and msi were originally designed for land applications the high spatiotemporal resolution provides a unique opportunity to detect the strong heterogeneity and high dynamics of inland waters to date extensive studies on estimating inland water quality using oli and msi have been reported cao et al 2021 liu et al 2021 maciel et al 2021 pahlevan et al 2020 recently nasa initiated the harmonized landsat and sentinel 2 project with the approach proposed by claverie et al 2018 and began to process global harmonized landsat and sentinel 2 data in 2020 based on the virtual constellation of landsat 8 and sentinel 2 the repeat cycle of meter scale resolution earth observation is further improved to 2 3 days pahlevan et al 2019 using the harmonized landsat and sentinel 2 data peterson et al 2020a estimated multiple wqps such as chlorophyll a chla and dissolved oxygen do of several inland waterbodies contained within the midwestern united states cao and tzortziou 2021 examined the dissolved organic carbon doc dynamics with the harmonized landsat and sentinel 2 data in a tidally influenced marsh estuarine system in the chesapeake bay usa these studies demonstrated the feasibility of estimating inland and coastal water quality using the harmonized landsat and sentinel 2 data water quality constituents can be roughly divided into optically active constituents oacs and non oacs according to their impacts on water optical properties oacs refer to the fraction of suspended and dissolved substances that interact with electromagnetic radiation through absorptive refractive and scattering mechanisms such as chla and other phytoplankton pigments non algal particles and chromophoric dissolved organic matter cdom ioccg 2018 non oacs are those that do not absorb light and hence cannot be directly measured by spectral methods such as total phosphorous tp total nitrogen tn doc and do oacs significantly affect the water optical properties and these effects can be detected by satellite sensors hence oacs can be estimated directly by the aops and iops of water at present extensive robust algorithms for chla secchi disk depth sdd and cdom estimation at regional and even global scales with remote sensing have been developed bonelli et al 2021 lee et al 2016 neil et al 2019 non oacs are difficult to be captured by satellite sensors especially the multispectral sensors with wide bandwidths because they don t directly impact water optical properties therefore the retrieval of non oacs using remote sensing usually assumes that non oacs and oacs are correlated for example phosphorus and nitrogen do not impact the visible spectrum of water directly but do affect the water color due to their promotion of algal growth sagan et al 2020 chang et al 2013 explored the spatiotemporal patterns of tp in a coastal bay usa with modis images based on the link of tp with relevant wqps li et al 2017 developed empirical models to estimate tp and tn in the xin anjiang reservoir china using oli images and analyze their responses to hydrological and meteorological conditions fichot et al 2016 used airborne images to derive high spatial resolution 2 6 m distributions of the doc concentration in a wetland influenced region of the san francisco bay delta estuary on this basis they further developed the relationship of filter passing methylmercury and doc using in situ samples and enabled the high spatial resolution depiction of surface methylmercury concentrations in this area batur and maktav 2019 estimated multiple wqps such as do and total dissolved substance of a small inland lake in turkey by using data fusion and mining techniques with the aid of oli msi and göktürk 2 data these studies achieved reliable results with the determination coefficient for the regression models of 0 58 0 93 and provide practical references for estimating non oacs with remote sensing chla is an effective and quantitative indicator of the eutrophication nitrogen and phosphorus are important nutrient elements that dominate the biochemical process of harmful algae conley et al 2009 shi et al 2019 sdd is a measurement of water clarity reflecting the concentrations of algal and suspended particles lee et al 2015 doc is a basic nutrient supporting the growth of microorganisms and is a significant component of carbon budgets kolka et al 2008 do is the amount of oxygen dissolved in water and directly indicates the ability of water to support aquatic organisms breitburg et al 2018 chla and suspended particles affecting sdd belong to oacs hence there are extensive studies on chla and sdd estimation using remote sensing pahlevan et al 2020 zhang et al 2021 doc is highly correlated with oac cdom and there are also many studies on direct and indirect estimation of doc based on cdom cao and tzortziou 2021 chen et al 2020 since tp tn and do belong to non oacs there are few studies on estimating these parameters resulting in a lack of mature algorithms at present chang et al 2015 sagan et al 2020 xiong et al 2020 in addition chla tp tn sdd doc and do interact with each other for example tp and tn have a significant impact on chla algal blooms lead to a short term do increase because of the photosynthesis shortly after do decreases sharply due to the microbial decomposition of algal debris in estuaries algal growth and the input of exogenous organic matter are closely related to doc and also lead to the decline of sdd the interaction among wqps increases the difficulty of estimating a wqp without being affected by the others which further challenges the development of robust algorithms guo et al 2021a as a result the research on quantitative retrieval of multiple parameters at the same time and effective split of their interaction is still limited at present moreover chla tp tn sdd doc and do are affected by climate and human activities chapra et al 2017 for example air temperature and solar radiation affect chla and doc concentrations by affecting the photosynthetic of algae agricultural activities such as fertilization contribute to tp and tn liu et al 2020 the surface runoff caused by precipitation especially short duration intense rainfall events carries non algal particles and organic matter into the lake which significantly affects sdd and doc in water do is proved to be inversely proportional to air temperature and directly proportional to air pressure zhi et al 2021 in recent years many reliable and freely available climate data products have been released which provides a substantial basis for better retrieval of wqps through the comprehensive analysis of the correlation between wqps and climate factors in addition to the water optical properties introducing climate factors that directly affect wqps into the model would enhance the model capability especially models for non oacs in detecting spatiotemporal patterns of wqps and improve the model robustness and generalization guo et al 2021b a growing body of research proved the strengths of machine learning and deep learning in fitting the complex correlation between target variables and satellite data cao et al 2021 la and chai 2021 niu et al 2021 stampoulis et al 2021 yuan et al 2020 to date machine learning and deep learning have been progressively applied to the remote estimation of both oacs and non oacs chen et al 2022 du et al 2021 peterson et al 2020 pahlevan et al 2020 developed a mixture density networks based approach for consistent chla products generation for inland and coastal waters with msi and olci data topp et al 2021 used the extreme gradient boosting xgboost model and landsat images to estimate the sdd of over 14 000 lakes in the u s and found that lake water clarity has increased by an average of 0 52 cm yr 1 since 1984 du et al 2021 estimated multiple wqps such as tp tn and do and derived water quality classification maps in the zhejiang coastal sea china using a spatially weighted neural network and the goci data this study demonstrated the feasibility of deep learning in water quality assessment and management practice in large scale and complex coastal waters recently guo et al 2022 proposed and proved the effectiveness of a multimodal deep learning based approach mdl for chla tp and tn estimation in inland waters with the long term landsat archive mdl is a novel derivative of deep learning based on the fact that human learns information through multiple senses ngiam et al 2011 the robustness of mdl in human activity recognition medical applications and autonomous driving has been continuously confirmed ramachandram and taylor 2017 mdl has also attracted great interest in remote sensing applications including imagery classification semantic labeling image segmentation and crop yield prediction maimaitijiang et al 2020 the mdl models use different sub neuron networks to independently learn each category of features so as to control the possible noise amplification caused by inputting all features into the fully connected neural network and effectively balance the effective information and noise however in guo et al 2022 the mdl model and its application still have some limitations i e 1 the inputs of the mdl model essentially belonged to spectral information more diversified input features are expected to help the model capture the spatiotemporal characteristics of wqps at a deeper level and improve the model generalization 2 the feasibility of the mdl model for the estimation of broader wqps has not been tested adapting the mdl model to more wqps would further broaden its application scenarios 3 the mdl model was developed using the landsat series images the 16 day temporal resolution reduces the practical application value of this approach 4 the influence mechanism of the same feature s different values on the model was still unknown filling this gap would help to further improve the physical interpretability of the model in this study we proposed enhanced mdl emdl models to estimate chla tp tn sdd doc and do from improved harmonized landsat and sentinel 2 data by including climate factors into model input features the developed models were rigorously validated with the test set and another independent data set we also compared the emdl models with several other deep learning machine learning and empirical models and discussed the pros and cons of each model then the mechanism of effectively splitting the estimation interactions of the wqps was analyzed based on the state of the art deep learning interpretability algorithm lastly using the developed emdl models the spatiotemporal patterns of the wqps in lake simcoe canada from 2013 to 2019 were reconstructed and the impacts of natural and anthropogenic factors on each wqp were quantitatively analyzed 2 martials and method 2 1 model development and performance evaluation 2 1 1 model development based on the mdl models this study proposed the emdl models to fit the correlation between wqps and input features more specifically we first constructed a sub neural network snn for every category of features i e spectral bands snn1 remote sensing indices snn2 and climate variables snn3 to independently learn this category of features then the learning results of the snn1 3 were input into the fourth independent snn snn4 as features finally the wqps were predicted by the snn4 fig 1 in fully connected neural networks the superposition and accumulation of noise might reduce the model s learning efficiency resulting in under fitting besides the model might also be confused due to learning much noise resulting in over fitting while the multimodal model structure was expected to efficiently avoid much noise being learned when learning useful information since the mathematical expressions of the emdl and mdl models were the same they were not repeated here and could be found in guo et al 2022 for comparison purposes we also developed five other deep learning and machine learning models in addition to the emdl model including the mdl model only using spectral bands and remote sensing indices as input features in guo et al 2022 mdl a dnn with same numbers of neurons and hidden layers but not being split into snns sdnn two decision tree based models i e the xgboost and the random forest rf cao et al 2020 maciel et al 2021 and the support vector regression svr hafeez et al 2019 mdl and sdnn were used to verify the contributions of adding climate variables in features and the multimodal mode respectively xgboost svr and rf representing traditional machine learning algorithms have been broadly used in wqps estimation recently maciel et al 2021 we also included several empirical algorithms including the multiple linear regression mlr nasa two band oc2 and three band oc3 algorithms for chla estimation o reilly et al 1998 o reilly and werdell 2019 two sdd algorithms in olmanson et al 2011 and zhang et al 2021 and one doc algorithm in cao and tzortziou 2021 to further verify the performances of the emdl models the detailed implementation of the models and the descriptions of the empirical models for chla sdd and doc estimation could be found in the supplementary materials 2 1 2 interpretation of model predictions compared with empirical algorithms and traditional machine learning models although deep learning models have the potential to improve model performance the model complexity challenges the correct interpretation of model predictions in this study we calculated the contribution of each feature input into the emdl models using the shapley additive explanations library shap version 0 39 0 lundberg and lee 2017 shap connects optimal credit allocation with local explanations using the classic shapley values initially from game theory and their related extensions the resulting shap values provide the unique additive feature importance measure that adheres to the desirable properties i e local accuracy missingness and consistency and use conditional expectations to define simplified inputs positive shap values represent positive impacts of features on the models while negative shap values represent the negative impacts of features on the models it is worthwhile to mention that shap can be used to calculate feature contributions of neural networks developed with both tensorflow and pytorch and also supports a variety of traditional machine learning models e g xgboost 2 1 3 model performance evaluation for the evaluation of model performance we used the slope of the linear regression two log transformed metrics i e the mean absolute error mae and bias and the root mean square error rmse 1 mae 10 i 1 n a lg e i lg m i n 1 100 2 bias 10 i 1 n lg e i lg m i n 1 100 3 rmse 1 n i 1 n e i m i 2 where n notes the number of samples e i notes the estimated wqp and m i notes the measured wqp the closer mae bias and rmse are to zero the better the performance of the model 2 2 satellite data processing the landsat 8 and sentinel 2 images from may 2013 to december 2019 were chosen as the satellite data sources the image filtering followed the same criteria used in guo et al 2022 after applying these criteria 32 level 1 landsat 8 images and 54 level 1c sentinel 2 images were filtered and obtained from the united states geological survey portal https earthexplorer usgs gov and copernicus open access hub https scihub copernicus eu respectively the open source software termed acolite v 20210802 0 vanhellemont 2019 was used to atmospherically correct the top of atmosphere toa reflectance to r rs coimbra et al 2021 tian et al 2022 our previous study found that the dark spectrum fitting algorithm of acolite outperformed the exponential extrapolation algorithm in lake simcoe guo et al 2022 thus the dark spectrum fitting algorithm was used in this study subsequently we fused the oli and msi r rs data sets by referring to the approach proposed in claverie et al 2017 and claverie et al 2018 and the main steps included 1 the sentinel 2 pixels were resampled to the same size i e 30 m of the landsat 8 pixels 2 the geographical registration of the two data sets 3 a bidirectional reflectance distribution function normalization was applied to the visible nir bands of both data sets for the correction of view and illumination angle effects 4 a bandpass adjustment was conducted to reduce the spectral differences in the overlapping spectral bands the sentinel 2 spectral bands were linearly adjusted with the landsat 8 data being used as reference the pixels contaminated by clouds were detected and masked using a threshold of 0 0215 at the short wave infrared swir bands closest to 1 600 nm to at least partly reduce the data loss caused by low snr in nir band a 3 3 standard deviation filter was used to smooth the nir bands the pixels within 300 m of lake simcoe s shoreline were excluded to remove the pixels affected by the severe land adjacency effect s wang et al 2020b the processed data set contains corrected r rs data of the five overlapping spectral bands besides the five individual spectral bands we also included three remote sensing indices calculated by the r rs data i e the ratio of blue to green bgr normalized difference chlorophyll index ndci and chlorophyll vegetation index cvi to supplement the individual spectral bands peterson et al 2020 zhu et al 2022 the equations for calculating the bgr ndci and cvi are detailed in the supplementary material 2 3 in situ water quality measurements we used two in situ measured data sets from 2013 to 2019 to match with the satellite data to train the mdl models for wqps estimation using remote sensing the lslmp data set n 950 provided by the lake simcoe lake monitoring program https data ontario ca was used to train and test the model while the lsrca data set n 223 provided by the lake simcoe region conservation authority https data lsrca on ca was selected as an independent set to further verify the generalization performance of the model to ensure that the matchups of water quality measurements and synchronous satellite data were valid for model calibration we removed the matchups with the time interval between sampling and image acquisition being greater than 6 h cao et al 2020 to avoid the uncertainty caused by the spatial variability of satellite data we calculated the coefficient of variation of the matched pixels with a 3 3 slide window and removed the matched pixels with the coefficient of variation being greater than 20 zibordi et al 2009 the distributions of the matched in situ water quality measurements were shown in fig a1 ml models e g xgboost 2 4 ancillary data and analysis of factors affecting water quality to help the emdl models to better detect the complex spatiotemporal variation of wqps affected by climate factors we also included air temperature sea level pressure hereinafter termed pressure for brevity precipitation wind speed wind direction and water surface temperature as input features in addition to the r rs of five individual spectral bands and remote sensing indices to quantitatively analyze the impacts of natural and anthropogenic factors on chla tp tn sdd doc and do of lake simcoe and its two most concerned estuaries we calculated the correlations between the wqps and the climate factors i e air temperature pressure precipitation wind speed and wind direction the anthropogenic factors i e urban and farmland areas nighttime light and the number of mobile devices connecting to cellular towers hereinafter termed cell for brevity and other potential factors i e the normalized difference vegetation index ndvi and discharge nighttime light and cell were considered as potential factors affecting the water quality because nighttime light may indicate the economic development and human activities of the watershed while cell may represent the population distribution in the watershed the daily air temperature pressure precipitation wind speed and wind direction data were obtained from the fifth generation of monthly global climate reanalysis era5 product hersbach et al 2020 the daily water surface temperature data set was obtained from the mod11a1 006 product wan et al 2015 the yearly urban area and farmland area data was obtained from the mcd12q1 006 product friedl and sulla menashe 2019 the monthly nighttime light data was obtained from the viirs nighttime day night band composites version 1 on the google earth engine platform gee the daily cell data was obtained from the opencellid https opencellid org the daily ndvi data was obtained from the modis terra daily ndvi data set on gee the daily mean discharge data was obtained from the measurements of the lsrca surface water stations https data lsrca on ca the air temperature pressure precipitation wind speed wind direction and ndvi excluding lake area were the spatial averages of the lake simcoe talbot river and holland river watersheds respectively the nighttime light and cell were the spatial sums of the three watersheds the wqps and water surface temperature of lake simcoe were the spatial averages of the lake the wqps and water surface temperature of the talbot river estuary and holland river estuary were the spatial averages of a 3000 m buffer centered on the estuaries we used the pearson correlation coefficient r to quantitatively analyze the linear correlation between the wqps and each factor the value range of r is 1 1 where negatives indicate negative correlation and positives indicate positive correlation considering that r is only suitable for determining the linear correlation in addition to r we calculated the distance correlation coefficient d which was proved to be able to determine non linear correlation székely et al 2007 the value range of d is 0 1 where zero indicates that the two variables are independent and one indicates a total correlation for the detailed calculation of r and d please refer to edelmann et al 2021 2 5 study site the lake simcoe watershed is located in the south of ontario canada and covers 3 400 km2 and 20 municipalities including the york region durham region and the barrie city and orillia city in the simcoe county fig 2 a the lake simcoe watershed provides more than 450 000 people with many vital resources for instance clean drinking and agricultural water lake simcoe covers an area of 722 km2 and is the largest lake on the trent severn waterway a total of 18 major river systems such as the holland river and talbot river flow into lake simcoe and create 18 distinct sub watersheds fig 2b we selected the holland river and talbot river estuaries as representatives to quantitively explore the impacts of natural and anthropogenic factors on water quality 3 results 3 1 performance of the developed models the emdl models performed well for chla tp tn sdd doc and do estimation on the lslmp test set as indicated by the statistical metrics with slope of 0 84 0 95 mae of 4 11 20 17 and bias of 0 56 14 68 fig 3 the rmse of the emdl models for chla tp tn sdd doc and do estimation on the lslmp test set was 0 06 μg l 1 1 82 μg l 1 0 04 mg l 1 1 02 m 1 04 mg l 1 0 52 mg l 1 respectively chla and sdd belong to oacs and they have significant impacts on the spectral signals received by the satellite sensors hence their models were expected to perform better however the performances of chla and sdd models did not show substantial differences from those of other models since there was no tn and doc data in the lsrca data set we split 20 of the lslmp data as independent data set to verify the model generalization and 50 and 30 of the lslmp data were used for training and test of the emdl models respectively although the training sets of the tn and doc models were smaller n 475 the model performances showed no substantial difference from those of other models we also observed that the chla tp and sdd models showed slight overestimation while the other models showed a certain degree of underestimation in addition we compared the mae bias and slope of the models on the lslmp training set and test set respectively to better verify the overfitting the overall performances of the models on the training set and the test set were balanced although the performances of all models showed slight decreases on the test set the results showed that the emdl models effectively controlled the overfitting the lslmp test set did not participate in the model training and can objectively reflect the model performances therefore this study used the slope mae bias and rmse on the lslmp test set to represent the model performances in the application in addition to the lslmp data set we further verified the generalization of the emdl models with the independent data sets fig 4 as expected the emdl models maintained good performance with slope of 0 82 0 99 mae of 3 53 19 56 and bias of 0 13 15 08 the rmse of the emdl models for chla tp tn sdd doc and do estimation on the independent data set was 0 06 μg l 1 1 93 μg l 1 0 03 mg l 1 1 20 m 0 97 mg l 1 0 45 mg l 1 respectively the slope mae bias and rmse of the emdl models on the independent data set showed differences from those on the lslmp data set some metrics on the independent data set were even better than those on the lslmp data set for example the tn model performed better on the independent data set than on the lslmp test set there existed some samples with tn 0 6 mg l 1 in the lslmp test set while in the independent data set all tn was lower than 0 6 mg l 1 therefore we speculated that the narrower tn range induced that the tn model performed better on the independent data set than on the lslmp test set considering that the sample size and the input and output measurement error might lead to uncertainties of the emdl models we further characterized the impacts of the sample size and the input and output measurement error on the models through the sensitivity analysis f wang et al 2020a wang et al 2022 to characterize the impacts of the sample size we split the whole data set according to the size proportion of the training set and the test set and set up four sample scenarios namely 5 5 6 4 7 3 and 8 2 to characterize the impacts of the input and output measurement error we added random perturbations to the 13 input features and six wqps the gaussian noise distributions were adopted to set up four perturbation scenarios with different strengths namely 10 20 30 and 40 wang et al 2022 the impacts of the sample size and the input and output measurement error on the emdl models were shown in table a1 a3 respectively the results showed that when the training set accounted for 70 or more of the whole data set the performance of the models was no longer sensitive to the sample size table a1 for each input feature the random perturbations with different strengths had slight impacts on the model performance but none of these impacts significantly changed the four metrics of the model performance table a2 similar to the input measurement error perturbations the output measurement error perturbations had little effect on the performance of the emdl models table a3 these sensitivity analysis results proved the robustness of the emdl models for the estimation of the six wqps 3 2 contributions of model input features for different wqps the input features of the emdl models were the same there also existed interaction among the six wqps which challenged the adequate estimation of each wqp without the impacts of other wqps therefore we calculated the contributions of the input features using the shap and explored the model interpretability in an attempt to verify the feasibility of the emdl models to adequately estimate each wqp and effectively split the interactions fig 5 the feature contributions to the emdl model of each wqp were different for the chla model bgr especially the high and low values had positive impacts on the model most high values of ndci had positive impacts on the model previous studies showed that the algorithms based on bgr were suitable for clean waters while ndci based algorithms were suitable for turbid waters neil et al 2019 chla in lake simcoe is low in most areas and most of the time hence the contribution of bgr to the model was higher than that of ndci when chla was high ndci could reduce the estimation deviation induced by bgr air temperature wind speed and wind direction affect chla of lake simcoe only in a specific range while only the high values of precipitation and pressure affect chla of lake simcoe the feature contributions to the tp and tn models were similar most low values of the bgr had negative impacts on the models while high values had positive impacts on the models bgr was proved to correlate with chla o reilly and werdell 2019 therefore we inferred that the emdl models mainly estimated tp and tn through the correlation between tp and tn and chla it is difficult for the models to estimate tp and tn through spectral information in waters with low chla for the sdd model the low values of bgr had significant positive impacts on the model among the climate features the low values of air temperature pressure precipitation and wind speed had significant positive impacts on the model the high values of air temperature and pressure had significant negative impacts on the model the low and high values of wind direction had significant negative and positive impacts on the model respectively the contributions of spectral bands and remote sensing indices on the doc model were similar to those on sdd it was not surprising because previous studies showed that doc had a significant exponential correlation with cdom and cdom significantly affected sdd chen et al 2020 among the remote sensing indices the low values of bgr had significant positive impacts on the model while the high values had significant negative impacts on the model the high values of bgr commonly indicate high chla in water therefore we speculated that the high chla in water affected the adequate estimation of sdd among the climate factors the high values of air temperature and pressure had positive impacts on the model while most low values had negative impacts on the model the high values of precipitation mainly had negative impacts on the model wind speed and wind direction had significant positive impacts on the model for the do model air temperature and precipitation had balanced contributions to the model although extensive studies proved that there was a significant negative correlation between air temperature and do our results showed that air temperature might no longer be the main factor of do with the impacts of other factors the low values of pressure and wind direction had significant negative impacts on the model wind speed especially the low values showed significant positive impacts on the model in summary the contribution of each feature in estimating chla tp tn sdd doc and do showed substantial differences the contribution of high and low values of the same feature to the same model was also different according to the model performances and the feature contributions we inferred that the emdl models adequately estimated the wqps and effectively split the interaction among the wqps 3 3 water quality mapping using the developed emdl models and all available harmonized landsat and sentinel 2 data we mapped the average spatial distribution of chla tp tn sdd doc and do in lake simcoe from 2013 to 2019 fig 6 generally the water quality in the center and west of lake simcoe was good while poor water quality was distributed in the cook s bay cb east and north the spatial distributions of chla tp and tn were consistent with averages of 1 14 0 93 μg l 1 10 32 3 47 μg l 1 and 0 38 0 04 mg l 1 respectively we observed that the high values of tp and tn were mainly distributed in the estuaries of urban and agricultural intensive watersheds the nutrients brought by urban runoff urban stormwater drainage and agricultural runoff made tp and tn in these areas significantly higher than those in other areas besides phosphorous and nitrogen are the main limiting nutrients for algal growth therefore algae grow vigorously when tp and tn are high resulting in the increase of chla the high values of chla tp and tn were mainly distributed in the nearshore areas of cb south of georgina island and thorah island east the shannon bay and the barnstable bay we also observed large areas of high chla tp and tn in the northeast of georgina island with tp and tn almost reaching 40 μg l 1 and 0 7 mg l 1 and chla reaching 5 7 μg l 1 in addition the nearshore areas in the northwest of cb and southeast of the snake island also distributed high chla tp and tn the spatial distributions of sdd and doc were consistent with averages of 6 70 2 71 m and 4 54 0 59 mg l 1 respectively the lowest sdd and highest doc were mainly distributed in the cb east and north algae and suspended solids such as cdom and non algal particles are the main factors affecting sdd and doc is highly correlated to cdom in the cb and north the area of high chla was significantly smaller than that of low sdd while the distribution of high doc showed consistency with that of low sdd therefore we speculated that sdd was mainly affected by cdom in these two areas although non algal particles might also affect sdd the low sdd was also distributed in the kempenfelt bay and the north nearshore area of the kempenfelt bay 13 15 m while chla and doc were low in these areas therefore we inferred that the low sdd in these areas was mainly affected by non algal particles do was low in cb east center and northwest of lake simcoe extensive estuaries were distributed in cb and east of the lake receiving runoff from areas with dense cities and intensive agricultural activities the nutrients and organic matter in the runoff lead to vigorous algal growth in cb and east microbial decomposition of the algal debris consumes much do resulting in low do in cb and east the high chla tp tn doc and low sdd were mainly distributed in cb and east which also supported the above inference the northwest of the lake was also widely covered by farmland we also observed that high tp tn and doc and low sdd were distributed in the northwest of the lake therefore although tp and tn in the northwest were insufficient to promote vigorous algal growth we speculated that the biochemical processes similar to that in cb and east also occurred in the northwest which might lead to the low do in the northwest we analyzed the water temperature monitored at the s15 station of lsrca in the lake center and found that the average water temperature 16 82 5 95 from 2013 to 2019 was about 0 74 higher than the average of all stations 16 08 5 83 the results suggested that the low do in the lake center might be owing to the higher water temperature in summary cb and north of lake simcoe are highly urbanized densely populated and covered by farmland and extensive farmland and estuaries are distributed in the east of the lake rapid urbanization and intensive agricultural activities increased the phosphorous and nitrogen loads resulting in the continuous growth of aquatic organizations and even algae blooms microbial decomposition activities increase doc while consuming do in recent years under the background of global climate change the increases in temperature and precipitation especially short duration intense rainfall events directly affect the water quality of lake simcoe urban heat island and rain island effects also indirectly affect the water quality of the lake by changing regional climate we further quantitatively analyzed the impacts of potential natural and anthropogenic factors on lake simcoe water quality using the open source climate reanalysis data remote sensing data hydrological data and cell data this content was discussed in detail in section 4 3 3 4 temporal variability of water quality we analyzed the dynamics of each wqp of two most concerned areas of lake simcoe i e cb and east from 2013 to 2019 using the model estimates of c6 and e51 stations fig 7 the in situ measurements of the two stations were also presented in fig 7 to verify the strength of the emdl models in time series water quality mapping generally all the wqps showed consistent change trends in c6 and e51 chla tp and tn of e51 were 53 69 32 77 and 10 00 lower than those of c6 respectively sdd of e51 was 138 73 higher than that of c6 the doc and do of c6 and e51 showed no significant difference and the average differences were 4 57 and 2 26 respectively c6 and e51 are located in the cb and northeast of the lake respectively around the cb are agricultural land and densely populated aggregations of the greater toronto area blodau et al 2018 high tp and tn in c6 were a result of elevated inputs of phosphorous and nitrogen in tributaries and pump off water from the highly agricultural area which entered cb via the holland river the increase of tp and tn promoted the phytoplankton growth and then the chla increased and the sdd decreased besides the holland river brought sediment and organic matter from urban and agricultural areas into cb which also led to the decrease of sdd although the water quality of e51 was affected by the input of the talbot river the site is relatively far from the estuary compared to c6 therefore we speculated that part of the phosphorous and nitrogen brought by the talbot river was retained in segment which might explain the lower tp tn and chla and the higher sdd of e51 eimers et al 2005 in c6 and e51 chla increased in 2014 then decreased continuously in the next two years and reached the lowest 4 43 μg l 1 and 2 79 μg l 1 in 2016 from 2017 chla fluctuated and increased to 8 29 μg l 1 and 3 13 μg l 1 in 2019 in c6 tp increased to 26 91 μg l 1 and 28 46 μg l 1 in 2014 and 2017 and fluctuated and decreased in other years with a percentage of 3 73 in e51 tp increased to 20 03 μg l 1 only in 2016 and decreased slightly in other years with a percentage of 10 00 tn in c6 and e51 fluctuated slightly in the range of 0 50 0 54 mg l 1 and 0 46 0 48 mg l 1 respectively and showed slight downward trends from 2017 and 2016 with percentages of 7 98 and 4 90 respectively sdd of e51 showed greater fluctuation than that of c6 reaching local minimums of 10 62 m 12 25 m and 11 60 m in 2014 2017 and 2019 sdd of c6 was always in a small range of 4 29 6 00 m from 2013 to 2019 and reached the local minimum of 4 29 m in 2017 the dynamics of doc in c6 and e51 showed obvious consistency from 2013 to 2019 in 2015 and 2016 the doc of c6 and e51 was significantly higher than that of other years with averages reaching 10 23 mg l 1 and 9 70 mg l 1 respectively in other years the doc of c6 and e51 fluctuated in a small range of 8 33 9 00 mg l 1 with averages of 8 81 mg l 1 and 8 45 mg l 1 respectively the do of c6 and e51 fluctuated in small ranges of 7 87 8 41 mg l 1 and 7 78 8 15 mg l 1 from 2013 to 2019 with averages of 8 13 mg l 1 and 7 95 mg l 1 respectively we also observed that the emdl models adequately estimated the wqps the results showed that the emdl models could be used in time series water quality mapping of lake simcoe with acceptable accuracy 4 discussion 4 1 approach strengths and limitations 4 1 1 comprehensive comparison to benchmarks we verified the performances of the emdl models using the lslmp test set and the independent data set and the results showed that the models produced satisfactory estimates of the wqps to further validate the model performance we also compared the performances of the emdl models and several other algorithms on the lslmp test set including five deep learning and machine learning models i e mdl sdnn xgboost rf and svr and six empirical algorithms i e mlr oc2 and oc3 for chla estimation the algorithms in olmanson et al 2011 and zhang et al 2021 for sdd estimation and the algorithm in cao and tzortziou 2021 for doc estimation which has been successfully applied in remote sensing retrieval of water quality recently we employed the taylor diagrams taylor 2001 to present the comprehensive comparisons of these algorithms fig 8 taylor diagrams provide a way of graphically summarizing how closely the model estimations matches the in situ measurements the similarity between the model estimations and the in situ measurements is quantified by three metrics 1 the correlation coefficient r 2 the normalized root mean squared error nrmse and 3 the amplitude of their variations represented by the normalized standard deviations the three metrics can be plotted on one two dimensional graph because that their relationship can be represented through the law of cosines in the taylor diagram the radial distances from the origin 0 0 to the points are proportional to the normalized standard deviations the radial distances from the reference point 1 0 to the points are proportional to the nrmse the azimuthal positions give the r between the model estimations matches the in situ measurements according to fig 8 although most models showed effective performance for chla tp tn sdd doc and do estimation the emdl performed better than the other models more specifically in chla estimation the emdl showed the best r 0 94 and nrmse 0 34 in tp estimation emdl and mdl showed better performances with r being greater than 0 9 and nrmse of 0 35 and 0 42 respectively in tn estimation emdl showed a clear better performance than other models r 0 96 nrmse 0 34 in sdd estimation the r of emdl sdnn and mdl was greater than 0 9 and the nrmse was 0 26 0 41 and 0 44 respectively in doc estimation emdl and sdnn showed better performances with r being greater than 0 9 and nrmse of 0 30 and 0 32 respectively in do estimation emdl performed best with r of 0 93 and nrmse of 0 47 for all wqps the emdl performed better than the mdl besides except for tp estimation sdnn performed better than the mdl in the estimation of other wqps therefore we inferred that in addition to spectral information adding climate features could help the models estimate wqps more adequately extensive previous studies proved that there existed close relationships between the climate factors and wqps chapra et al 2017 zhi et al 2021 deep learning was able to adequately capture these relationships especially the complex nonlinear correlation the performance of the emdl was enhanced by including the climate data as model input feature and using deep learning to fit the relationship between the wqps and climate factors besides the emdl only selected three remote sensing indices that contributed the most to the mdl as input features optimizing the model input reduced the interference of redundant information on the model which further improved the performance of the emdl we also observed that the emdl performed better than sdnn indicating that using different snns to learn each category of features could effectively balance the effective information and noise and improve the model efficiency in addition compared to the traditional fully connected model structure although the number of neurons and hidden layers were the same the multimodal model structure reduced the trainable parameters of the model this optimization of the model structure improved the training and prediction efficiency of the model in the estimation of different wqps the models developed in this study showed varying performance except that xgboost performed better than sdnn in tp estimation the performances of deep learning models i e emdl mdl and sdnn were generally better than those of the traditional machine learning models i e xgboost svr and rf the deep learning models were also been proved to perform better than oc3 oc2 and algorithms in zhang et al 2021 olmanson et al 2011 and cao and tzortziou 2021 for chla sdd and doc estimation these results further proved the strengths of the emdl models in estimating chla tp tn sdd doc and do in lake simcoe 4 1 2 feasibility in spatiotemporal estimation previous studies found that although the models had high scores in the model evaluation there might still be uncertainties in spatiotemporal water quality mapping hu et al 2021 we mapped the spatial distributions of chla in the east and sdd in the cb on april 11 2020 and april 26 2021 using the top five models so as to visually examine the feasibility of the emdl models for spatiotemporal water quality mapping in lake simcoe fig 9 fig 10 fig 9 showed the comparison between the spatial distributions of chla estimated by emdl sdnn xgboost mdl and svr in the east and the true color composite tcc image on april 11 2020 the results showed that the emdl model reconstructed the spatial distribution characteristics of chla more precisely than other models by comparing with the tcc image the sdnn had performance close to the emdl model but produced high chla in the center of the lake although xgboost performed better than mdl in terms of the mae bias and taylor diagram it produced a larger area of high chla than other models svr failed to reconstruct the distribution characteristics of chla and only identified the areas where chla might be high we also observed that the emdl model effectively controlled the noise and produced more continuous chla spatial distribution fig 10 showed the comparison between the spatial distributions of sdd estimated by emdl sdnn mdl xgboost and svr in the cb and the tcc image on april 26 2020 similar to chla mapping the emdl model more clearly reconstructed the spatial distribution characteristics of sdd presented by the tcc images although the low sdd areas identified by sdnn mdl xgboost and svr models were close to those of the emdl model we noted that the emdl model could further identify lower sdd in low sdd areas these results showed that the emdl models had the potential to precisely reconstruct the spatial distribution characteristics of water quality and effectively capture the spatial gradients of water quality however the comparison between the spatial distributions of chla and sdd estimated by the models and those observed from the tcc images could only qualitatively describe the model performances in water quality mapping therefore we further compared the wqps estimated by the top three models to the in situ measurements of the e51 station from 2013 to 2019 fig 11 the performances of the three models were similar when the water quality was stable but emdl models showed better performances in capturing the high dynamics of water quality in summary these results suggested the feasibility of the emdl models for spatial mapping and time series estimation of chla tp tn sdd doc and do in lake simcoe 4 1 3 approach limitations and promotion the approach proposed in this study still had some limitations in the model generalization model interpretability larger scale application and development of automatic monitoring systems towards the broad and practical adoption of the approach we further discussed several possible paths which were expected to provide reference for the subsequent improvement research the deep learning models have complex model structures and hence have high requirements and dependence on the sample size the harmonized landsat and sentinel 2 data shortened the observation repeat cycle to 2 3 days making it possible for more data matching we also strictly controlled the number of the input features and used as few hidden layers and neurons as possible to reduce the data requirements of the models the model performances showed that the models could be used to estimate the wqps of lake simcoe with acceptable accuracy however considering that the models were only trained with in situ measurements of lake simcoe we deemed that the models were only capable for water quality retrieval at a regional scale when applied to other water bodies the models might fail due to the low generalization with the rapid improvement of data sharing framework using more diversified field data to train the models and developing more reliable data assimilation and quality control methods would significantly improve the feasibility of the models for water quality monitoring at larger or even global scales spyrakos et al 2018 stanley et al 2019 werdell et al 2002 werdell and bailey 2005 on the other hand under the background of regional responsibility system for water resource management continuous training and updating of the models with the regional data could also help the models contribute to the efficient water quality monitoring zhu et al 2022 in this mode more efforts should be spent on reducing the model complexity and the model dependence on computing power although the multimodal model structure contributes to better model performance it also leads to a large number of trainable parameters which challenges the model interpretability besides due to the random initialization of w and b and the sgd strategy used in parameter optimization we found that the model outputs of each training were slightly different these uncertainties led to that the deep learning models might not be as robust as the physics based models in practical application we noted that only a few studies on retrieving water quality using machine learning and deep learning discussed the model interpretability recently model interpretability has become one of the priorities in the artificial intelligence community a variety of robust algorithms such as local interpretable model agnostic explanations ribeiro et al 2016 shap lundberg and lee 2017 and captum kokhlikyan et al 2020 have been developed to explain model predictions therefore we encourage increasing attention to the model interpretability in estimating water quality using machine learning and deep learning and remote sensing in the future which helps to understand the physical mechanism of the models clarifying the model s physical mechanism contributes to the selection of model input features which helps to avoid the interference of invalid information on the model and also reduce the model dependence on data and the model complexity besides part of the model parameters could be fixed providing opportunities for the model to be applied to different scenarios through transfer learning this might reduce the uncertainty of the model output and improve the efficiency of model construction in the practical application the climate data i e air temperature precipitation pressure wind speed and wind direction used in this study was derived from the era5 product section 2 5 the era5 product has a temporal resolution of one day which makes it possible for more data matching but the spatial resolution is approximately 28 km although the meteorological conditions usually tend to be uniform in a certain range we still considered that the low spatial resolution might impact model performance however at present the global open source climate data with both high temporal and spatial resolution is limited fortunately a series of regional scale climate data with high spatiotemporal resolution was produced in recent years e g the daymet thornton et al 2022 in practical application using the available regional data with high spatiotemporal resolution to replace some parameters in era5 could at least partially reduce the model uncertainty atmospheric correction is one of the crucial affecting factors of remote sensing retrieval of inland and coastal water quality frouin et al 2019 in this study to avoid the uncertainty of lasrc and sen2cor in aquatic applications we used the dark spectrum fitting algorithm in acolite for atmospheric correction whose effectiveness of applications in inland and coastal waters has been proved in many studies section 2 2 however since gee limits its web interface to scripts created by users adding atmospheric correction methods for aquatic applications e g the dark spectrum fitting algorithm to gee is still not an easy task maciel et al 2021 page et al 2019 at present we still need to download the images and conduct atmospheric correction locally which limits the larger scale water quality retrieval and the development of automatic monitoring systems future research might focus on acquiring the image properties and corresponding atmospheric parameters through the gee python application programming interface and then estimate the aerosol optical thickness using the py6s library this would enable the development of atmospheric correction algorithms for waters based on gee or at least the integration of the existing atmospheric correction algorithms into gee in practical application in addition gee has now supported the training and prediction of the deep learning models constructed with tensorflow by hosting the developed models on the google artificial intelligence platform users could conduct larger scale and more efficient water quality monitoring through gee 4 2 potential to split the estimating interaction we calculated the contribution of each feature to the model estimation using the shap section 3 2 fig 5 which improves the black box property of the deep learning model the features had different contributions to models of different wqps and even some features had positive impacts on one model while negative impacts on another model for example air temperature showed positive contributions to the sdd and tn estimation but negative contributions to the tp and doc estimation precipitation showed a positive contribution to the do estimation but a negative contribution to the chla tp and tn estimation we inferred that the differences in these contributions made it possible for the emdl models to adequately estimate each wqp and effectively split the interaction among the wqps meanwhile the low and high values of a feature showed different impacts on the same model for example in doc estimation the low values of bgr showed positive contributions while the high values showed negative contributions in tp estimation the low values of wind speed showed positive contributions while the high values showed negative contributions these results indicated that the emdl models learned the nonlinear correlation between features and wqps and effectively balanced the noise and effective information moreover we observed that all features had impacts on the models a feature mainly had positive or negative impacts on the model but for some samples this feature had opposite impacts this helped the models to learn not only the main affecting factors of the wqps but also some special situations and further improved the model generalization 4 3 identification of factors affecting water quality using the developed emdl models and all available harmonized landsat and sentinel 2 data from 2013 to 2019 we reconstructed the spatiotemporal water quality patterns and quantitatively analyzed the impacts of 12 potential natural and anthropogenic factors on the water quality of lake simcoe fig 12 the p values associated with the pearson correlation analysis were shown in table a4 please note that to facilitate the comparison between r and d r was presented in absolute values in fig 12 as expected the r between some factors and wqps is low while the d was high for example the r between the farmland and urban areas and the sdd doc and do of lake simcoe was less than 0 5 but the d was greater than 0 6 the r between the urban area and the chla sdd doc and do of the talbot river estuary was less than 0 5 but the d was greater than 0 5 these results suggested that there might be a nonlinear correlation between the affecting factors and wqps compared with r previous studies proved that d could capture the nonlinear correlation between variables section 2 5 here we judged the factors with d greater than 0 5 as the main factors affecting wqps according to experience some factors with r greater than 0 5 and d close to 0 5 were also judged as the main factors affecting wqps urban area cell farmland area nighttime light and air temperature were the main factors affecting chla in lake simcoe urban area cell farmland area and nighttime light were also the main factors affecting chla in the talbot river estuary and holland river estuary this result indicated that the urban development and population growth in the populated watersheds e g the holland river watershed and the intensive agricultural activities in watersheds such as the talbot river watershed input a large number of nutrients into lake simcoe and promoted algal growth cao et al 2021 the significant impacts of these factors on tp also supported this inference air temperature and water surface temperature significantly affected chla in lake simcoe and the talbot river estuary we also observed that chla in the holland river estuary was affected by air temperature and water surface temperature with both r and d close to 0 5 adequate temperature created an appropriate environment for algae growth tp and tn in lake simcoe were mainly affected by nighttime light cell farmland area urban area and ndvi the nighttime light cell and farmland area were also the main factors affecting tp and tn in the talbot river estuary and holland river estuary this result indicated that human activities such as industrial development population growth and agricultural fertilization dominated the increase of phosphorous and nitrogen loads in lake simcoe in the talbot river estuary some natural factors namely ndvi and precipitation also affected tp and tn extensive farmlands were distributed in the talbot river watershed and ndvi was seriously affected by agricultural activities therefore we inferred that the ndvi also represented the impact of agricultural activities on tp and tn in the talbot river estuary the precipitation especially short duration intense rainfall events input phosphorous and nitrogen from agricultural fertilization into the lake through surface runoff resulting in the increase of tp and tn we observed that discharge affected tp and tn in the talbot river estuary with d of 0 49 and 0 45 respectively the holland river watershed is one of the most densely populated areas in lake simcoe watershed the phosphorous and nitrogen emissions from urbanization led to the increase of tp and tn in the holland river estuary therefore urban area became one of the main affecting factors of tp r 0 52 d 0 59 and tn r 0 50 d 0 54 in the holland river estuary the main affecting factors of sdd in lake simcoe included urban area farmland area cell nighttime light precipitation air temperature water surface temperature and discharge in the context of intensive urbanization the increasing impermeable surfaces such as roads accelerated the inflow of wastewater into the lake without infiltration stets et al 2020 the short duration intense rainfall events were also considered to aggravate the runoff production and confluence in addition agricultural activities and appropriate air temperature water surface temperature brought sufficient nutrients and created ideal environments for algal growth s wang et al 2020 we speculated that these processes led to the decrease of sdd in lake simcoe the factors dominating sdd in the talbot river estuary and holland river estuary were different in the talbot river estuary natural factors air temperature r 0 58 d 0 64 and water surface temperature r 0 54 d 0 57 were the main factors while in the holland river estuary in addition to air temperature and water surface temperature urban area discharge and cell also significantly affected sdd we inferred that the sdd in the talbot river estuary was mainly affected by algal growth while the sdd in the holland river estuary was affected by both terrestrial suspended solids and algal growth farmland area urban area ndvi precipitation air temperature discharge and water surface temperature were the main factors affecting the doc in lake simcoe this result showed that the doc in lake simcoe mainly came from the input of organic matter from urban and agricultural areas through runoff and the algal growth in the lake high phosphorous and nitrogen loads caused by urban development and agricultural activities surface runoff caused by precipitation and appropriate water temperature for algal growth might contribute to the increase of doc similar to lake simcoe doc in the talbot river estuary was also affected by human activities i e farmland area and natural factors i e ndvi air temperature and water surface temperature while in the holland river estuary anthropogenic factors i e urban and farmland areas were the main factors affecting doc in lake simcoe farmland area urban area cell air temperature water surface temperature wind speed and pressure were the main factors affecting do indicating that both natural and anthropogenic factors had impacts on do urban development and agricultural activities increased the phosphorous and nitrogen loads in the lake and promoted algal growth in the short term algal photosynthesis led to the increase of do while in the near future microbial decomposition of the algal debris induced the substantial decrease of do many studies showed that there exist significant negative and positive correlations between air temperature water surface temperature and pressure and do respectively besides waves created by winds accelerated the oxygen in the air to enter the water through aeration hence wind speed showed a significant correlation with do r 0 54 d 0 56 natural factors including air temperature water surface temperature wind speed discharge pressure and precipitation dominated the do of the talbot river estuary the factors affecting do in the holland river estuary were similar to those of lake simcoe mainly including urban area cell nighttime light precipitation air temperature discharge and water surface temperature runoff from urban and agricultural areas not only carried rich nutrients to promote algal growth but also carried a large amount of organic matter microbial decomposition of algal debris and organic matter consumed much do and even led to fish kills due to hypoxia in summary the water quality of lake simcoe and its two most concerned estuaries was mainly affected by human activities such as urban and farmland areas the natural factors e g air temperature water surface temperature precipitation and discharge also had significant impacts on the water quality in these areas the affecting factors of different wqps were different the climate land use nighttime light cell water surface temperature and ndvi data used in this study were retrieved from global open source data products without regional validation and correction the temporal 30 days and spatial resolution 500 m of part data sets were relatively low although this might lead to uncertainties in the quantification of water quality affecting factors we considered that the above results still provided a basis for identifying potential affecting factors of water quality and water quality management in lake simcoe 5 conclusion in this study we proposed enhanced multimodal deep learning models i e emdl for lake simcoe chla tp tn sdd doc and do estimation using remote sensing the emdl models were developed and validated using the r rs data derived from the improved harmonized landsat and sentinel 2 data and synchronized lslmp in situ water quality measurements and water surface temperature and climate data n 950 the in situ water quality measurements of lsrca n 223 were used as independent data sets to further verify the model generalization we compared the performance of the emdl models with several other machine learning and deep learning models i e mdl sdnn xgboost rf and svr as well as empirical algorithms i e mlr oc2 and oc3 for chla estimation algorithms in zhang et al 2021 and olmanson et al 2011 for sdd estimation and algorithm in cao and tzortziou 2021 for doc estimation on the lslmp test set we also compared the performance of the emdl models and several other candidate algorithms in spatiotemporal mapping and time series estimation of wqps the model evaluation indicated that the emdl models produced satisfactory performance in chla tp tn sdd doc and do estimation of lake simcoe with slope being close to 1 0 84 0 95 mae 20 17 and bias 14 68 introducing the climate data into the model input enhanced the model performance the results showed that the emdl models had the potential to reconstruct the spatial patterns and time series dynamics of water quality and effectively capture the gradients of spatial variations the fusion of landsat 8 and sentinel 2 data improved the time resolution for meter scale resolution optical satellite images which contributed to the water quality monitoring of inland and coastal waters we calculated the contributions of the input features to the emdl models using the shap and discussed the potential to split the estimation interactions among the wqps which increased the physical interpretability of the models to a certain extent using the developed emdl models we reconstructed and analyzed the spatial distributions and time series variations of the wqps in lake simcoe from 2013 to 2019 furthermore we quantitatively analyzed the impacts of 12 potential natural i e air temperature pressure precipitation wind speed wind direction and discharge and anthropogenic i e cell urban area farmland area nighttime light and ndvi factors on the water quality of lake simcoe the results showed that the water quality of lake simcoe and its two most concerned estuaries was mainly affected by human activities such as urban development and agricultural production the natural factors e g air temperature water surface temperature precipitation and discharge also had significant impacts on the water quality in these areas this study provides a framework for environmental management practices in inland watersheds such as water quality monitoring and identification of affecting factors credit authorship contribution statement hongwei guo conceptualization methodology software writing original draft xiaotong zhu methodology jinhui jeanne huang supervision validation writing review editing zijie zhang data curation visualization shang tian software data curation visualization yiheng chen writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by the national key research and development program of china no 2016yfc0400709 we appreciate the careful and thoughtful comments of two anonymous reviewers which helped improve this paper substantially appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129466 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2072,remote sensing has long been used for inland water quality monitoring however due to the complex correlation between water quality parameters wqps and water optical properties the interactions of wqps and the impacts of climate using remote sensing reflectance r rs to adequately estimate wqps is still a grand challenge deep learning has the potential in capturing the correlation among r rs optically active constituents oacs and non oacs and is progressively used in remote sensing retrieval of inland water quality in this study the enhanced multimodal deep learning emdl models were proposed for chlorophyll a total phosphorous total nitrogen secchi disk depth dissolved organic carbon and dissolved oxygen retrieval in lake simcoe 80 km north of toronto canada the emdl models were developed and validated using the r rs data derived from the harmonized landsat and sentinel 2 images synchronized water quality measurements water surface temperature and climate data n 1173 the performance of the emdl models was compared to that of several other machine learning deep learning and empirical models using the developed emdl models the spatial distributions and long term variations of the wqps in lake simcoe from 2013 to 2019 were reconstructed the impacts of 12 potential natural and anthropogenic factors on the water quality of the entire lake simcoe and its two most concerned estuaries were also quantitatively discussed the results showed that the emdl models produced satisfactory performance in estimation of the six wqps with the slope being close to 1 0 84 0 95 normalized mean absolute error 20 17 and bias 14 68 the emdl models had the potential to reconstruct the spatial patterns and time series dynamics of water quality and effectively detect the gradients of spatial patterns this study provides a novel approach to supporting the environmental management and identification of the affecting factors for the lake simcoe watershed keywords deep learning remote sensing water quality landsat sentinel 2 data availability data will be made available on request 1 introduction inland waters such as lakes provide drinking water food recreational and economic opportunities and other critical support for the anthroposphere biosphere and environmental health tranvik et al 2009 effective and interpretable monitoring of long term and broad scale water quality changes and the affecting factors is key to environmental management stanley et al 2019 remote sensing has been considered as a practical method of the water quality monitoring and has been progressively applied to inland waters palmer et al 2015 schaeffer et al 2013 compared with traditional costly point based monitoring remote sensing supports full coverage periodic convenient and cost effective water quality monitoring when incident solar radiation or other light hits the water surface part of the light penetrates the water column and was absorbed and scattered by suspended and dissolved matter in water sagan et al 2020 the inherent optical properties iops of water e g absorption and scattering coefficients vary with water quality conditions and determine the water apparent optical properties aops e g remote sensing reflectance r rs from the radiances received by satellite sensors the iops and aops can be derived for water quality parameter wqp estimation since 1978 more than ten water color sensors have been put into orbits such as the coastal zone color scanner sea viewing wide field of view sensor moderate resolution imaging spectroradiometer modis medium resolution imaging spectrometer chinese ocean colour and temperature scanner onboard hy 1 ocean and land colour instrument olci and geostationary ocean color imager goci which have accumulated abundant remote sensing data for water quality monitoring however these sensors usually have relatively low spatial resolution usually hundreds of meters which limits their application in small scale inland lakes the landsat 8 was launched in 2013 and carries a push broom sensor with radiometric precision over 12 bit namely the operational land imager oli the oli added two new bands a coastal band and a cirrus band to the heritage landsat multispectral bands the oli provides multi spectral images with the spatial resolution of 30 m and the repeat cycle of 16 days the sentinel 2 mission was initialized in 2015 and comprises a constellation of two polar orbiting satellites the constellation improves the repeat cycle to 5 days 2 3 days at mid latitudes the multispectral instrument msi onboard sentinel 2 has similar spectral bands to oli but the spatial resolution of the visible and near infrared nir bands was improved to 10 m although both oli and msi were originally designed for land applications the high spatiotemporal resolution provides a unique opportunity to detect the strong heterogeneity and high dynamics of inland waters to date extensive studies on estimating inland water quality using oli and msi have been reported cao et al 2021 liu et al 2021 maciel et al 2021 pahlevan et al 2020 recently nasa initiated the harmonized landsat and sentinel 2 project with the approach proposed by claverie et al 2018 and began to process global harmonized landsat and sentinel 2 data in 2020 based on the virtual constellation of landsat 8 and sentinel 2 the repeat cycle of meter scale resolution earth observation is further improved to 2 3 days pahlevan et al 2019 using the harmonized landsat and sentinel 2 data peterson et al 2020a estimated multiple wqps such as chlorophyll a chla and dissolved oxygen do of several inland waterbodies contained within the midwestern united states cao and tzortziou 2021 examined the dissolved organic carbon doc dynamics with the harmonized landsat and sentinel 2 data in a tidally influenced marsh estuarine system in the chesapeake bay usa these studies demonstrated the feasibility of estimating inland and coastal water quality using the harmonized landsat and sentinel 2 data water quality constituents can be roughly divided into optically active constituents oacs and non oacs according to their impacts on water optical properties oacs refer to the fraction of suspended and dissolved substances that interact with electromagnetic radiation through absorptive refractive and scattering mechanisms such as chla and other phytoplankton pigments non algal particles and chromophoric dissolved organic matter cdom ioccg 2018 non oacs are those that do not absorb light and hence cannot be directly measured by spectral methods such as total phosphorous tp total nitrogen tn doc and do oacs significantly affect the water optical properties and these effects can be detected by satellite sensors hence oacs can be estimated directly by the aops and iops of water at present extensive robust algorithms for chla secchi disk depth sdd and cdom estimation at regional and even global scales with remote sensing have been developed bonelli et al 2021 lee et al 2016 neil et al 2019 non oacs are difficult to be captured by satellite sensors especially the multispectral sensors with wide bandwidths because they don t directly impact water optical properties therefore the retrieval of non oacs using remote sensing usually assumes that non oacs and oacs are correlated for example phosphorus and nitrogen do not impact the visible spectrum of water directly but do affect the water color due to their promotion of algal growth sagan et al 2020 chang et al 2013 explored the spatiotemporal patterns of tp in a coastal bay usa with modis images based on the link of tp with relevant wqps li et al 2017 developed empirical models to estimate tp and tn in the xin anjiang reservoir china using oli images and analyze their responses to hydrological and meteorological conditions fichot et al 2016 used airborne images to derive high spatial resolution 2 6 m distributions of the doc concentration in a wetland influenced region of the san francisco bay delta estuary on this basis they further developed the relationship of filter passing methylmercury and doc using in situ samples and enabled the high spatial resolution depiction of surface methylmercury concentrations in this area batur and maktav 2019 estimated multiple wqps such as do and total dissolved substance of a small inland lake in turkey by using data fusion and mining techniques with the aid of oli msi and göktürk 2 data these studies achieved reliable results with the determination coefficient for the regression models of 0 58 0 93 and provide practical references for estimating non oacs with remote sensing chla is an effective and quantitative indicator of the eutrophication nitrogen and phosphorus are important nutrient elements that dominate the biochemical process of harmful algae conley et al 2009 shi et al 2019 sdd is a measurement of water clarity reflecting the concentrations of algal and suspended particles lee et al 2015 doc is a basic nutrient supporting the growth of microorganisms and is a significant component of carbon budgets kolka et al 2008 do is the amount of oxygen dissolved in water and directly indicates the ability of water to support aquatic organisms breitburg et al 2018 chla and suspended particles affecting sdd belong to oacs hence there are extensive studies on chla and sdd estimation using remote sensing pahlevan et al 2020 zhang et al 2021 doc is highly correlated with oac cdom and there are also many studies on direct and indirect estimation of doc based on cdom cao and tzortziou 2021 chen et al 2020 since tp tn and do belong to non oacs there are few studies on estimating these parameters resulting in a lack of mature algorithms at present chang et al 2015 sagan et al 2020 xiong et al 2020 in addition chla tp tn sdd doc and do interact with each other for example tp and tn have a significant impact on chla algal blooms lead to a short term do increase because of the photosynthesis shortly after do decreases sharply due to the microbial decomposition of algal debris in estuaries algal growth and the input of exogenous organic matter are closely related to doc and also lead to the decline of sdd the interaction among wqps increases the difficulty of estimating a wqp without being affected by the others which further challenges the development of robust algorithms guo et al 2021a as a result the research on quantitative retrieval of multiple parameters at the same time and effective split of their interaction is still limited at present moreover chla tp tn sdd doc and do are affected by climate and human activities chapra et al 2017 for example air temperature and solar radiation affect chla and doc concentrations by affecting the photosynthetic of algae agricultural activities such as fertilization contribute to tp and tn liu et al 2020 the surface runoff caused by precipitation especially short duration intense rainfall events carries non algal particles and organic matter into the lake which significantly affects sdd and doc in water do is proved to be inversely proportional to air temperature and directly proportional to air pressure zhi et al 2021 in recent years many reliable and freely available climate data products have been released which provides a substantial basis for better retrieval of wqps through the comprehensive analysis of the correlation between wqps and climate factors in addition to the water optical properties introducing climate factors that directly affect wqps into the model would enhance the model capability especially models for non oacs in detecting spatiotemporal patterns of wqps and improve the model robustness and generalization guo et al 2021b a growing body of research proved the strengths of machine learning and deep learning in fitting the complex correlation between target variables and satellite data cao et al 2021 la and chai 2021 niu et al 2021 stampoulis et al 2021 yuan et al 2020 to date machine learning and deep learning have been progressively applied to the remote estimation of both oacs and non oacs chen et al 2022 du et al 2021 peterson et al 2020 pahlevan et al 2020 developed a mixture density networks based approach for consistent chla products generation for inland and coastal waters with msi and olci data topp et al 2021 used the extreme gradient boosting xgboost model and landsat images to estimate the sdd of over 14 000 lakes in the u s and found that lake water clarity has increased by an average of 0 52 cm yr 1 since 1984 du et al 2021 estimated multiple wqps such as tp tn and do and derived water quality classification maps in the zhejiang coastal sea china using a spatially weighted neural network and the goci data this study demonstrated the feasibility of deep learning in water quality assessment and management practice in large scale and complex coastal waters recently guo et al 2022 proposed and proved the effectiveness of a multimodal deep learning based approach mdl for chla tp and tn estimation in inland waters with the long term landsat archive mdl is a novel derivative of deep learning based on the fact that human learns information through multiple senses ngiam et al 2011 the robustness of mdl in human activity recognition medical applications and autonomous driving has been continuously confirmed ramachandram and taylor 2017 mdl has also attracted great interest in remote sensing applications including imagery classification semantic labeling image segmentation and crop yield prediction maimaitijiang et al 2020 the mdl models use different sub neuron networks to independently learn each category of features so as to control the possible noise amplification caused by inputting all features into the fully connected neural network and effectively balance the effective information and noise however in guo et al 2022 the mdl model and its application still have some limitations i e 1 the inputs of the mdl model essentially belonged to spectral information more diversified input features are expected to help the model capture the spatiotemporal characteristics of wqps at a deeper level and improve the model generalization 2 the feasibility of the mdl model for the estimation of broader wqps has not been tested adapting the mdl model to more wqps would further broaden its application scenarios 3 the mdl model was developed using the landsat series images the 16 day temporal resolution reduces the practical application value of this approach 4 the influence mechanism of the same feature s different values on the model was still unknown filling this gap would help to further improve the physical interpretability of the model in this study we proposed enhanced mdl emdl models to estimate chla tp tn sdd doc and do from improved harmonized landsat and sentinel 2 data by including climate factors into model input features the developed models were rigorously validated with the test set and another independent data set we also compared the emdl models with several other deep learning machine learning and empirical models and discussed the pros and cons of each model then the mechanism of effectively splitting the estimation interactions of the wqps was analyzed based on the state of the art deep learning interpretability algorithm lastly using the developed emdl models the spatiotemporal patterns of the wqps in lake simcoe canada from 2013 to 2019 were reconstructed and the impacts of natural and anthropogenic factors on each wqp were quantitatively analyzed 2 martials and method 2 1 model development and performance evaluation 2 1 1 model development based on the mdl models this study proposed the emdl models to fit the correlation between wqps and input features more specifically we first constructed a sub neural network snn for every category of features i e spectral bands snn1 remote sensing indices snn2 and climate variables snn3 to independently learn this category of features then the learning results of the snn1 3 were input into the fourth independent snn snn4 as features finally the wqps were predicted by the snn4 fig 1 in fully connected neural networks the superposition and accumulation of noise might reduce the model s learning efficiency resulting in under fitting besides the model might also be confused due to learning much noise resulting in over fitting while the multimodal model structure was expected to efficiently avoid much noise being learned when learning useful information since the mathematical expressions of the emdl and mdl models were the same they were not repeated here and could be found in guo et al 2022 for comparison purposes we also developed five other deep learning and machine learning models in addition to the emdl model including the mdl model only using spectral bands and remote sensing indices as input features in guo et al 2022 mdl a dnn with same numbers of neurons and hidden layers but not being split into snns sdnn two decision tree based models i e the xgboost and the random forest rf cao et al 2020 maciel et al 2021 and the support vector regression svr hafeez et al 2019 mdl and sdnn were used to verify the contributions of adding climate variables in features and the multimodal mode respectively xgboost svr and rf representing traditional machine learning algorithms have been broadly used in wqps estimation recently maciel et al 2021 we also included several empirical algorithms including the multiple linear regression mlr nasa two band oc2 and three band oc3 algorithms for chla estimation o reilly et al 1998 o reilly and werdell 2019 two sdd algorithms in olmanson et al 2011 and zhang et al 2021 and one doc algorithm in cao and tzortziou 2021 to further verify the performances of the emdl models the detailed implementation of the models and the descriptions of the empirical models for chla sdd and doc estimation could be found in the supplementary materials 2 1 2 interpretation of model predictions compared with empirical algorithms and traditional machine learning models although deep learning models have the potential to improve model performance the model complexity challenges the correct interpretation of model predictions in this study we calculated the contribution of each feature input into the emdl models using the shapley additive explanations library shap version 0 39 0 lundberg and lee 2017 shap connects optimal credit allocation with local explanations using the classic shapley values initially from game theory and their related extensions the resulting shap values provide the unique additive feature importance measure that adheres to the desirable properties i e local accuracy missingness and consistency and use conditional expectations to define simplified inputs positive shap values represent positive impacts of features on the models while negative shap values represent the negative impacts of features on the models it is worthwhile to mention that shap can be used to calculate feature contributions of neural networks developed with both tensorflow and pytorch and also supports a variety of traditional machine learning models e g xgboost 2 1 3 model performance evaluation for the evaluation of model performance we used the slope of the linear regression two log transformed metrics i e the mean absolute error mae and bias and the root mean square error rmse 1 mae 10 i 1 n a lg e i lg m i n 1 100 2 bias 10 i 1 n lg e i lg m i n 1 100 3 rmse 1 n i 1 n e i m i 2 where n notes the number of samples e i notes the estimated wqp and m i notes the measured wqp the closer mae bias and rmse are to zero the better the performance of the model 2 2 satellite data processing the landsat 8 and sentinel 2 images from may 2013 to december 2019 were chosen as the satellite data sources the image filtering followed the same criteria used in guo et al 2022 after applying these criteria 32 level 1 landsat 8 images and 54 level 1c sentinel 2 images were filtered and obtained from the united states geological survey portal https earthexplorer usgs gov and copernicus open access hub https scihub copernicus eu respectively the open source software termed acolite v 20210802 0 vanhellemont 2019 was used to atmospherically correct the top of atmosphere toa reflectance to r rs coimbra et al 2021 tian et al 2022 our previous study found that the dark spectrum fitting algorithm of acolite outperformed the exponential extrapolation algorithm in lake simcoe guo et al 2022 thus the dark spectrum fitting algorithm was used in this study subsequently we fused the oli and msi r rs data sets by referring to the approach proposed in claverie et al 2017 and claverie et al 2018 and the main steps included 1 the sentinel 2 pixels were resampled to the same size i e 30 m of the landsat 8 pixels 2 the geographical registration of the two data sets 3 a bidirectional reflectance distribution function normalization was applied to the visible nir bands of both data sets for the correction of view and illumination angle effects 4 a bandpass adjustment was conducted to reduce the spectral differences in the overlapping spectral bands the sentinel 2 spectral bands were linearly adjusted with the landsat 8 data being used as reference the pixels contaminated by clouds were detected and masked using a threshold of 0 0215 at the short wave infrared swir bands closest to 1 600 nm to at least partly reduce the data loss caused by low snr in nir band a 3 3 standard deviation filter was used to smooth the nir bands the pixels within 300 m of lake simcoe s shoreline were excluded to remove the pixels affected by the severe land adjacency effect s wang et al 2020b the processed data set contains corrected r rs data of the five overlapping spectral bands besides the five individual spectral bands we also included three remote sensing indices calculated by the r rs data i e the ratio of blue to green bgr normalized difference chlorophyll index ndci and chlorophyll vegetation index cvi to supplement the individual spectral bands peterson et al 2020 zhu et al 2022 the equations for calculating the bgr ndci and cvi are detailed in the supplementary material 2 3 in situ water quality measurements we used two in situ measured data sets from 2013 to 2019 to match with the satellite data to train the mdl models for wqps estimation using remote sensing the lslmp data set n 950 provided by the lake simcoe lake monitoring program https data ontario ca was used to train and test the model while the lsrca data set n 223 provided by the lake simcoe region conservation authority https data lsrca on ca was selected as an independent set to further verify the generalization performance of the model to ensure that the matchups of water quality measurements and synchronous satellite data were valid for model calibration we removed the matchups with the time interval between sampling and image acquisition being greater than 6 h cao et al 2020 to avoid the uncertainty caused by the spatial variability of satellite data we calculated the coefficient of variation of the matched pixels with a 3 3 slide window and removed the matched pixels with the coefficient of variation being greater than 20 zibordi et al 2009 the distributions of the matched in situ water quality measurements were shown in fig a1 ml models e g xgboost 2 4 ancillary data and analysis of factors affecting water quality to help the emdl models to better detect the complex spatiotemporal variation of wqps affected by climate factors we also included air temperature sea level pressure hereinafter termed pressure for brevity precipitation wind speed wind direction and water surface temperature as input features in addition to the r rs of five individual spectral bands and remote sensing indices to quantitatively analyze the impacts of natural and anthropogenic factors on chla tp tn sdd doc and do of lake simcoe and its two most concerned estuaries we calculated the correlations between the wqps and the climate factors i e air temperature pressure precipitation wind speed and wind direction the anthropogenic factors i e urban and farmland areas nighttime light and the number of mobile devices connecting to cellular towers hereinafter termed cell for brevity and other potential factors i e the normalized difference vegetation index ndvi and discharge nighttime light and cell were considered as potential factors affecting the water quality because nighttime light may indicate the economic development and human activities of the watershed while cell may represent the population distribution in the watershed the daily air temperature pressure precipitation wind speed and wind direction data were obtained from the fifth generation of monthly global climate reanalysis era5 product hersbach et al 2020 the daily water surface temperature data set was obtained from the mod11a1 006 product wan et al 2015 the yearly urban area and farmland area data was obtained from the mcd12q1 006 product friedl and sulla menashe 2019 the monthly nighttime light data was obtained from the viirs nighttime day night band composites version 1 on the google earth engine platform gee the daily cell data was obtained from the opencellid https opencellid org the daily ndvi data was obtained from the modis terra daily ndvi data set on gee the daily mean discharge data was obtained from the measurements of the lsrca surface water stations https data lsrca on ca the air temperature pressure precipitation wind speed wind direction and ndvi excluding lake area were the spatial averages of the lake simcoe talbot river and holland river watersheds respectively the nighttime light and cell were the spatial sums of the three watersheds the wqps and water surface temperature of lake simcoe were the spatial averages of the lake the wqps and water surface temperature of the talbot river estuary and holland river estuary were the spatial averages of a 3000 m buffer centered on the estuaries we used the pearson correlation coefficient r to quantitatively analyze the linear correlation between the wqps and each factor the value range of r is 1 1 where negatives indicate negative correlation and positives indicate positive correlation considering that r is only suitable for determining the linear correlation in addition to r we calculated the distance correlation coefficient d which was proved to be able to determine non linear correlation székely et al 2007 the value range of d is 0 1 where zero indicates that the two variables are independent and one indicates a total correlation for the detailed calculation of r and d please refer to edelmann et al 2021 2 5 study site the lake simcoe watershed is located in the south of ontario canada and covers 3 400 km2 and 20 municipalities including the york region durham region and the barrie city and orillia city in the simcoe county fig 2 a the lake simcoe watershed provides more than 450 000 people with many vital resources for instance clean drinking and agricultural water lake simcoe covers an area of 722 km2 and is the largest lake on the trent severn waterway a total of 18 major river systems such as the holland river and talbot river flow into lake simcoe and create 18 distinct sub watersheds fig 2b we selected the holland river and talbot river estuaries as representatives to quantitively explore the impacts of natural and anthropogenic factors on water quality 3 results 3 1 performance of the developed models the emdl models performed well for chla tp tn sdd doc and do estimation on the lslmp test set as indicated by the statistical metrics with slope of 0 84 0 95 mae of 4 11 20 17 and bias of 0 56 14 68 fig 3 the rmse of the emdl models for chla tp tn sdd doc and do estimation on the lslmp test set was 0 06 μg l 1 1 82 μg l 1 0 04 mg l 1 1 02 m 1 04 mg l 1 0 52 mg l 1 respectively chla and sdd belong to oacs and they have significant impacts on the spectral signals received by the satellite sensors hence their models were expected to perform better however the performances of chla and sdd models did not show substantial differences from those of other models since there was no tn and doc data in the lsrca data set we split 20 of the lslmp data as independent data set to verify the model generalization and 50 and 30 of the lslmp data were used for training and test of the emdl models respectively although the training sets of the tn and doc models were smaller n 475 the model performances showed no substantial difference from those of other models we also observed that the chla tp and sdd models showed slight overestimation while the other models showed a certain degree of underestimation in addition we compared the mae bias and slope of the models on the lslmp training set and test set respectively to better verify the overfitting the overall performances of the models on the training set and the test set were balanced although the performances of all models showed slight decreases on the test set the results showed that the emdl models effectively controlled the overfitting the lslmp test set did not participate in the model training and can objectively reflect the model performances therefore this study used the slope mae bias and rmse on the lslmp test set to represent the model performances in the application in addition to the lslmp data set we further verified the generalization of the emdl models with the independent data sets fig 4 as expected the emdl models maintained good performance with slope of 0 82 0 99 mae of 3 53 19 56 and bias of 0 13 15 08 the rmse of the emdl models for chla tp tn sdd doc and do estimation on the independent data set was 0 06 μg l 1 1 93 μg l 1 0 03 mg l 1 1 20 m 0 97 mg l 1 0 45 mg l 1 respectively the slope mae bias and rmse of the emdl models on the independent data set showed differences from those on the lslmp data set some metrics on the independent data set were even better than those on the lslmp data set for example the tn model performed better on the independent data set than on the lslmp test set there existed some samples with tn 0 6 mg l 1 in the lslmp test set while in the independent data set all tn was lower than 0 6 mg l 1 therefore we speculated that the narrower tn range induced that the tn model performed better on the independent data set than on the lslmp test set considering that the sample size and the input and output measurement error might lead to uncertainties of the emdl models we further characterized the impacts of the sample size and the input and output measurement error on the models through the sensitivity analysis f wang et al 2020a wang et al 2022 to characterize the impacts of the sample size we split the whole data set according to the size proportion of the training set and the test set and set up four sample scenarios namely 5 5 6 4 7 3 and 8 2 to characterize the impacts of the input and output measurement error we added random perturbations to the 13 input features and six wqps the gaussian noise distributions were adopted to set up four perturbation scenarios with different strengths namely 10 20 30 and 40 wang et al 2022 the impacts of the sample size and the input and output measurement error on the emdl models were shown in table a1 a3 respectively the results showed that when the training set accounted for 70 or more of the whole data set the performance of the models was no longer sensitive to the sample size table a1 for each input feature the random perturbations with different strengths had slight impacts on the model performance but none of these impacts significantly changed the four metrics of the model performance table a2 similar to the input measurement error perturbations the output measurement error perturbations had little effect on the performance of the emdl models table a3 these sensitivity analysis results proved the robustness of the emdl models for the estimation of the six wqps 3 2 contributions of model input features for different wqps the input features of the emdl models were the same there also existed interaction among the six wqps which challenged the adequate estimation of each wqp without the impacts of other wqps therefore we calculated the contributions of the input features using the shap and explored the model interpretability in an attempt to verify the feasibility of the emdl models to adequately estimate each wqp and effectively split the interactions fig 5 the feature contributions to the emdl model of each wqp were different for the chla model bgr especially the high and low values had positive impacts on the model most high values of ndci had positive impacts on the model previous studies showed that the algorithms based on bgr were suitable for clean waters while ndci based algorithms were suitable for turbid waters neil et al 2019 chla in lake simcoe is low in most areas and most of the time hence the contribution of bgr to the model was higher than that of ndci when chla was high ndci could reduce the estimation deviation induced by bgr air temperature wind speed and wind direction affect chla of lake simcoe only in a specific range while only the high values of precipitation and pressure affect chla of lake simcoe the feature contributions to the tp and tn models were similar most low values of the bgr had negative impacts on the models while high values had positive impacts on the models bgr was proved to correlate with chla o reilly and werdell 2019 therefore we inferred that the emdl models mainly estimated tp and tn through the correlation between tp and tn and chla it is difficult for the models to estimate tp and tn through spectral information in waters with low chla for the sdd model the low values of bgr had significant positive impacts on the model among the climate features the low values of air temperature pressure precipitation and wind speed had significant positive impacts on the model the high values of air temperature and pressure had significant negative impacts on the model the low and high values of wind direction had significant negative and positive impacts on the model respectively the contributions of spectral bands and remote sensing indices on the doc model were similar to those on sdd it was not surprising because previous studies showed that doc had a significant exponential correlation with cdom and cdom significantly affected sdd chen et al 2020 among the remote sensing indices the low values of bgr had significant positive impacts on the model while the high values had significant negative impacts on the model the high values of bgr commonly indicate high chla in water therefore we speculated that the high chla in water affected the adequate estimation of sdd among the climate factors the high values of air temperature and pressure had positive impacts on the model while most low values had negative impacts on the model the high values of precipitation mainly had negative impacts on the model wind speed and wind direction had significant positive impacts on the model for the do model air temperature and precipitation had balanced contributions to the model although extensive studies proved that there was a significant negative correlation between air temperature and do our results showed that air temperature might no longer be the main factor of do with the impacts of other factors the low values of pressure and wind direction had significant negative impacts on the model wind speed especially the low values showed significant positive impacts on the model in summary the contribution of each feature in estimating chla tp tn sdd doc and do showed substantial differences the contribution of high and low values of the same feature to the same model was also different according to the model performances and the feature contributions we inferred that the emdl models adequately estimated the wqps and effectively split the interaction among the wqps 3 3 water quality mapping using the developed emdl models and all available harmonized landsat and sentinel 2 data we mapped the average spatial distribution of chla tp tn sdd doc and do in lake simcoe from 2013 to 2019 fig 6 generally the water quality in the center and west of lake simcoe was good while poor water quality was distributed in the cook s bay cb east and north the spatial distributions of chla tp and tn were consistent with averages of 1 14 0 93 μg l 1 10 32 3 47 μg l 1 and 0 38 0 04 mg l 1 respectively we observed that the high values of tp and tn were mainly distributed in the estuaries of urban and agricultural intensive watersheds the nutrients brought by urban runoff urban stormwater drainage and agricultural runoff made tp and tn in these areas significantly higher than those in other areas besides phosphorous and nitrogen are the main limiting nutrients for algal growth therefore algae grow vigorously when tp and tn are high resulting in the increase of chla the high values of chla tp and tn were mainly distributed in the nearshore areas of cb south of georgina island and thorah island east the shannon bay and the barnstable bay we also observed large areas of high chla tp and tn in the northeast of georgina island with tp and tn almost reaching 40 μg l 1 and 0 7 mg l 1 and chla reaching 5 7 μg l 1 in addition the nearshore areas in the northwest of cb and southeast of the snake island also distributed high chla tp and tn the spatial distributions of sdd and doc were consistent with averages of 6 70 2 71 m and 4 54 0 59 mg l 1 respectively the lowest sdd and highest doc were mainly distributed in the cb east and north algae and suspended solids such as cdom and non algal particles are the main factors affecting sdd and doc is highly correlated to cdom in the cb and north the area of high chla was significantly smaller than that of low sdd while the distribution of high doc showed consistency with that of low sdd therefore we speculated that sdd was mainly affected by cdom in these two areas although non algal particles might also affect sdd the low sdd was also distributed in the kempenfelt bay and the north nearshore area of the kempenfelt bay 13 15 m while chla and doc were low in these areas therefore we inferred that the low sdd in these areas was mainly affected by non algal particles do was low in cb east center and northwest of lake simcoe extensive estuaries were distributed in cb and east of the lake receiving runoff from areas with dense cities and intensive agricultural activities the nutrients and organic matter in the runoff lead to vigorous algal growth in cb and east microbial decomposition of the algal debris consumes much do resulting in low do in cb and east the high chla tp tn doc and low sdd were mainly distributed in cb and east which also supported the above inference the northwest of the lake was also widely covered by farmland we also observed that high tp tn and doc and low sdd were distributed in the northwest of the lake therefore although tp and tn in the northwest were insufficient to promote vigorous algal growth we speculated that the biochemical processes similar to that in cb and east also occurred in the northwest which might lead to the low do in the northwest we analyzed the water temperature monitored at the s15 station of lsrca in the lake center and found that the average water temperature 16 82 5 95 from 2013 to 2019 was about 0 74 higher than the average of all stations 16 08 5 83 the results suggested that the low do in the lake center might be owing to the higher water temperature in summary cb and north of lake simcoe are highly urbanized densely populated and covered by farmland and extensive farmland and estuaries are distributed in the east of the lake rapid urbanization and intensive agricultural activities increased the phosphorous and nitrogen loads resulting in the continuous growth of aquatic organizations and even algae blooms microbial decomposition activities increase doc while consuming do in recent years under the background of global climate change the increases in temperature and precipitation especially short duration intense rainfall events directly affect the water quality of lake simcoe urban heat island and rain island effects also indirectly affect the water quality of the lake by changing regional climate we further quantitatively analyzed the impacts of potential natural and anthropogenic factors on lake simcoe water quality using the open source climate reanalysis data remote sensing data hydrological data and cell data this content was discussed in detail in section 4 3 3 4 temporal variability of water quality we analyzed the dynamics of each wqp of two most concerned areas of lake simcoe i e cb and east from 2013 to 2019 using the model estimates of c6 and e51 stations fig 7 the in situ measurements of the two stations were also presented in fig 7 to verify the strength of the emdl models in time series water quality mapping generally all the wqps showed consistent change trends in c6 and e51 chla tp and tn of e51 were 53 69 32 77 and 10 00 lower than those of c6 respectively sdd of e51 was 138 73 higher than that of c6 the doc and do of c6 and e51 showed no significant difference and the average differences were 4 57 and 2 26 respectively c6 and e51 are located in the cb and northeast of the lake respectively around the cb are agricultural land and densely populated aggregations of the greater toronto area blodau et al 2018 high tp and tn in c6 were a result of elevated inputs of phosphorous and nitrogen in tributaries and pump off water from the highly agricultural area which entered cb via the holland river the increase of tp and tn promoted the phytoplankton growth and then the chla increased and the sdd decreased besides the holland river brought sediment and organic matter from urban and agricultural areas into cb which also led to the decrease of sdd although the water quality of e51 was affected by the input of the talbot river the site is relatively far from the estuary compared to c6 therefore we speculated that part of the phosphorous and nitrogen brought by the talbot river was retained in segment which might explain the lower tp tn and chla and the higher sdd of e51 eimers et al 2005 in c6 and e51 chla increased in 2014 then decreased continuously in the next two years and reached the lowest 4 43 μg l 1 and 2 79 μg l 1 in 2016 from 2017 chla fluctuated and increased to 8 29 μg l 1 and 3 13 μg l 1 in 2019 in c6 tp increased to 26 91 μg l 1 and 28 46 μg l 1 in 2014 and 2017 and fluctuated and decreased in other years with a percentage of 3 73 in e51 tp increased to 20 03 μg l 1 only in 2016 and decreased slightly in other years with a percentage of 10 00 tn in c6 and e51 fluctuated slightly in the range of 0 50 0 54 mg l 1 and 0 46 0 48 mg l 1 respectively and showed slight downward trends from 2017 and 2016 with percentages of 7 98 and 4 90 respectively sdd of e51 showed greater fluctuation than that of c6 reaching local minimums of 10 62 m 12 25 m and 11 60 m in 2014 2017 and 2019 sdd of c6 was always in a small range of 4 29 6 00 m from 2013 to 2019 and reached the local minimum of 4 29 m in 2017 the dynamics of doc in c6 and e51 showed obvious consistency from 2013 to 2019 in 2015 and 2016 the doc of c6 and e51 was significantly higher than that of other years with averages reaching 10 23 mg l 1 and 9 70 mg l 1 respectively in other years the doc of c6 and e51 fluctuated in a small range of 8 33 9 00 mg l 1 with averages of 8 81 mg l 1 and 8 45 mg l 1 respectively the do of c6 and e51 fluctuated in small ranges of 7 87 8 41 mg l 1 and 7 78 8 15 mg l 1 from 2013 to 2019 with averages of 8 13 mg l 1 and 7 95 mg l 1 respectively we also observed that the emdl models adequately estimated the wqps the results showed that the emdl models could be used in time series water quality mapping of lake simcoe with acceptable accuracy 4 discussion 4 1 approach strengths and limitations 4 1 1 comprehensive comparison to benchmarks we verified the performances of the emdl models using the lslmp test set and the independent data set and the results showed that the models produced satisfactory estimates of the wqps to further validate the model performance we also compared the performances of the emdl models and several other algorithms on the lslmp test set including five deep learning and machine learning models i e mdl sdnn xgboost rf and svr and six empirical algorithms i e mlr oc2 and oc3 for chla estimation the algorithms in olmanson et al 2011 and zhang et al 2021 for sdd estimation and the algorithm in cao and tzortziou 2021 for doc estimation which has been successfully applied in remote sensing retrieval of water quality recently we employed the taylor diagrams taylor 2001 to present the comprehensive comparisons of these algorithms fig 8 taylor diagrams provide a way of graphically summarizing how closely the model estimations matches the in situ measurements the similarity between the model estimations and the in situ measurements is quantified by three metrics 1 the correlation coefficient r 2 the normalized root mean squared error nrmse and 3 the amplitude of their variations represented by the normalized standard deviations the three metrics can be plotted on one two dimensional graph because that their relationship can be represented through the law of cosines in the taylor diagram the radial distances from the origin 0 0 to the points are proportional to the normalized standard deviations the radial distances from the reference point 1 0 to the points are proportional to the nrmse the azimuthal positions give the r between the model estimations matches the in situ measurements according to fig 8 although most models showed effective performance for chla tp tn sdd doc and do estimation the emdl performed better than the other models more specifically in chla estimation the emdl showed the best r 0 94 and nrmse 0 34 in tp estimation emdl and mdl showed better performances with r being greater than 0 9 and nrmse of 0 35 and 0 42 respectively in tn estimation emdl showed a clear better performance than other models r 0 96 nrmse 0 34 in sdd estimation the r of emdl sdnn and mdl was greater than 0 9 and the nrmse was 0 26 0 41 and 0 44 respectively in doc estimation emdl and sdnn showed better performances with r being greater than 0 9 and nrmse of 0 30 and 0 32 respectively in do estimation emdl performed best with r of 0 93 and nrmse of 0 47 for all wqps the emdl performed better than the mdl besides except for tp estimation sdnn performed better than the mdl in the estimation of other wqps therefore we inferred that in addition to spectral information adding climate features could help the models estimate wqps more adequately extensive previous studies proved that there existed close relationships between the climate factors and wqps chapra et al 2017 zhi et al 2021 deep learning was able to adequately capture these relationships especially the complex nonlinear correlation the performance of the emdl was enhanced by including the climate data as model input feature and using deep learning to fit the relationship between the wqps and climate factors besides the emdl only selected three remote sensing indices that contributed the most to the mdl as input features optimizing the model input reduced the interference of redundant information on the model which further improved the performance of the emdl we also observed that the emdl performed better than sdnn indicating that using different snns to learn each category of features could effectively balance the effective information and noise and improve the model efficiency in addition compared to the traditional fully connected model structure although the number of neurons and hidden layers were the same the multimodal model structure reduced the trainable parameters of the model this optimization of the model structure improved the training and prediction efficiency of the model in the estimation of different wqps the models developed in this study showed varying performance except that xgboost performed better than sdnn in tp estimation the performances of deep learning models i e emdl mdl and sdnn were generally better than those of the traditional machine learning models i e xgboost svr and rf the deep learning models were also been proved to perform better than oc3 oc2 and algorithms in zhang et al 2021 olmanson et al 2011 and cao and tzortziou 2021 for chla sdd and doc estimation these results further proved the strengths of the emdl models in estimating chla tp tn sdd doc and do in lake simcoe 4 1 2 feasibility in spatiotemporal estimation previous studies found that although the models had high scores in the model evaluation there might still be uncertainties in spatiotemporal water quality mapping hu et al 2021 we mapped the spatial distributions of chla in the east and sdd in the cb on april 11 2020 and april 26 2021 using the top five models so as to visually examine the feasibility of the emdl models for spatiotemporal water quality mapping in lake simcoe fig 9 fig 10 fig 9 showed the comparison between the spatial distributions of chla estimated by emdl sdnn xgboost mdl and svr in the east and the true color composite tcc image on april 11 2020 the results showed that the emdl model reconstructed the spatial distribution characteristics of chla more precisely than other models by comparing with the tcc image the sdnn had performance close to the emdl model but produced high chla in the center of the lake although xgboost performed better than mdl in terms of the mae bias and taylor diagram it produced a larger area of high chla than other models svr failed to reconstruct the distribution characteristics of chla and only identified the areas where chla might be high we also observed that the emdl model effectively controlled the noise and produced more continuous chla spatial distribution fig 10 showed the comparison between the spatial distributions of sdd estimated by emdl sdnn mdl xgboost and svr in the cb and the tcc image on april 26 2020 similar to chla mapping the emdl model more clearly reconstructed the spatial distribution characteristics of sdd presented by the tcc images although the low sdd areas identified by sdnn mdl xgboost and svr models were close to those of the emdl model we noted that the emdl model could further identify lower sdd in low sdd areas these results showed that the emdl models had the potential to precisely reconstruct the spatial distribution characteristics of water quality and effectively capture the spatial gradients of water quality however the comparison between the spatial distributions of chla and sdd estimated by the models and those observed from the tcc images could only qualitatively describe the model performances in water quality mapping therefore we further compared the wqps estimated by the top three models to the in situ measurements of the e51 station from 2013 to 2019 fig 11 the performances of the three models were similar when the water quality was stable but emdl models showed better performances in capturing the high dynamics of water quality in summary these results suggested the feasibility of the emdl models for spatial mapping and time series estimation of chla tp tn sdd doc and do in lake simcoe 4 1 3 approach limitations and promotion the approach proposed in this study still had some limitations in the model generalization model interpretability larger scale application and development of automatic monitoring systems towards the broad and practical adoption of the approach we further discussed several possible paths which were expected to provide reference for the subsequent improvement research the deep learning models have complex model structures and hence have high requirements and dependence on the sample size the harmonized landsat and sentinel 2 data shortened the observation repeat cycle to 2 3 days making it possible for more data matching we also strictly controlled the number of the input features and used as few hidden layers and neurons as possible to reduce the data requirements of the models the model performances showed that the models could be used to estimate the wqps of lake simcoe with acceptable accuracy however considering that the models were only trained with in situ measurements of lake simcoe we deemed that the models were only capable for water quality retrieval at a regional scale when applied to other water bodies the models might fail due to the low generalization with the rapid improvement of data sharing framework using more diversified field data to train the models and developing more reliable data assimilation and quality control methods would significantly improve the feasibility of the models for water quality monitoring at larger or even global scales spyrakos et al 2018 stanley et al 2019 werdell et al 2002 werdell and bailey 2005 on the other hand under the background of regional responsibility system for water resource management continuous training and updating of the models with the regional data could also help the models contribute to the efficient water quality monitoring zhu et al 2022 in this mode more efforts should be spent on reducing the model complexity and the model dependence on computing power although the multimodal model structure contributes to better model performance it also leads to a large number of trainable parameters which challenges the model interpretability besides due to the random initialization of w and b and the sgd strategy used in parameter optimization we found that the model outputs of each training were slightly different these uncertainties led to that the deep learning models might not be as robust as the physics based models in practical application we noted that only a few studies on retrieving water quality using machine learning and deep learning discussed the model interpretability recently model interpretability has become one of the priorities in the artificial intelligence community a variety of robust algorithms such as local interpretable model agnostic explanations ribeiro et al 2016 shap lundberg and lee 2017 and captum kokhlikyan et al 2020 have been developed to explain model predictions therefore we encourage increasing attention to the model interpretability in estimating water quality using machine learning and deep learning and remote sensing in the future which helps to understand the physical mechanism of the models clarifying the model s physical mechanism contributes to the selection of model input features which helps to avoid the interference of invalid information on the model and also reduce the model dependence on data and the model complexity besides part of the model parameters could be fixed providing opportunities for the model to be applied to different scenarios through transfer learning this might reduce the uncertainty of the model output and improve the efficiency of model construction in the practical application the climate data i e air temperature precipitation pressure wind speed and wind direction used in this study was derived from the era5 product section 2 5 the era5 product has a temporal resolution of one day which makes it possible for more data matching but the spatial resolution is approximately 28 km although the meteorological conditions usually tend to be uniform in a certain range we still considered that the low spatial resolution might impact model performance however at present the global open source climate data with both high temporal and spatial resolution is limited fortunately a series of regional scale climate data with high spatiotemporal resolution was produced in recent years e g the daymet thornton et al 2022 in practical application using the available regional data with high spatiotemporal resolution to replace some parameters in era5 could at least partially reduce the model uncertainty atmospheric correction is one of the crucial affecting factors of remote sensing retrieval of inland and coastal water quality frouin et al 2019 in this study to avoid the uncertainty of lasrc and sen2cor in aquatic applications we used the dark spectrum fitting algorithm in acolite for atmospheric correction whose effectiveness of applications in inland and coastal waters has been proved in many studies section 2 2 however since gee limits its web interface to scripts created by users adding atmospheric correction methods for aquatic applications e g the dark spectrum fitting algorithm to gee is still not an easy task maciel et al 2021 page et al 2019 at present we still need to download the images and conduct atmospheric correction locally which limits the larger scale water quality retrieval and the development of automatic monitoring systems future research might focus on acquiring the image properties and corresponding atmospheric parameters through the gee python application programming interface and then estimate the aerosol optical thickness using the py6s library this would enable the development of atmospheric correction algorithms for waters based on gee or at least the integration of the existing atmospheric correction algorithms into gee in practical application in addition gee has now supported the training and prediction of the deep learning models constructed with tensorflow by hosting the developed models on the google artificial intelligence platform users could conduct larger scale and more efficient water quality monitoring through gee 4 2 potential to split the estimating interaction we calculated the contribution of each feature to the model estimation using the shap section 3 2 fig 5 which improves the black box property of the deep learning model the features had different contributions to models of different wqps and even some features had positive impacts on one model while negative impacts on another model for example air temperature showed positive contributions to the sdd and tn estimation but negative contributions to the tp and doc estimation precipitation showed a positive contribution to the do estimation but a negative contribution to the chla tp and tn estimation we inferred that the differences in these contributions made it possible for the emdl models to adequately estimate each wqp and effectively split the interaction among the wqps meanwhile the low and high values of a feature showed different impacts on the same model for example in doc estimation the low values of bgr showed positive contributions while the high values showed negative contributions in tp estimation the low values of wind speed showed positive contributions while the high values showed negative contributions these results indicated that the emdl models learned the nonlinear correlation between features and wqps and effectively balanced the noise and effective information moreover we observed that all features had impacts on the models a feature mainly had positive or negative impacts on the model but for some samples this feature had opposite impacts this helped the models to learn not only the main affecting factors of the wqps but also some special situations and further improved the model generalization 4 3 identification of factors affecting water quality using the developed emdl models and all available harmonized landsat and sentinel 2 data from 2013 to 2019 we reconstructed the spatiotemporal water quality patterns and quantitatively analyzed the impacts of 12 potential natural and anthropogenic factors on the water quality of lake simcoe fig 12 the p values associated with the pearson correlation analysis were shown in table a4 please note that to facilitate the comparison between r and d r was presented in absolute values in fig 12 as expected the r between some factors and wqps is low while the d was high for example the r between the farmland and urban areas and the sdd doc and do of lake simcoe was less than 0 5 but the d was greater than 0 6 the r between the urban area and the chla sdd doc and do of the talbot river estuary was less than 0 5 but the d was greater than 0 5 these results suggested that there might be a nonlinear correlation between the affecting factors and wqps compared with r previous studies proved that d could capture the nonlinear correlation between variables section 2 5 here we judged the factors with d greater than 0 5 as the main factors affecting wqps according to experience some factors with r greater than 0 5 and d close to 0 5 were also judged as the main factors affecting wqps urban area cell farmland area nighttime light and air temperature were the main factors affecting chla in lake simcoe urban area cell farmland area and nighttime light were also the main factors affecting chla in the talbot river estuary and holland river estuary this result indicated that the urban development and population growth in the populated watersheds e g the holland river watershed and the intensive agricultural activities in watersheds such as the talbot river watershed input a large number of nutrients into lake simcoe and promoted algal growth cao et al 2021 the significant impacts of these factors on tp also supported this inference air temperature and water surface temperature significantly affected chla in lake simcoe and the talbot river estuary we also observed that chla in the holland river estuary was affected by air temperature and water surface temperature with both r and d close to 0 5 adequate temperature created an appropriate environment for algae growth tp and tn in lake simcoe were mainly affected by nighttime light cell farmland area urban area and ndvi the nighttime light cell and farmland area were also the main factors affecting tp and tn in the talbot river estuary and holland river estuary this result indicated that human activities such as industrial development population growth and agricultural fertilization dominated the increase of phosphorous and nitrogen loads in lake simcoe in the talbot river estuary some natural factors namely ndvi and precipitation also affected tp and tn extensive farmlands were distributed in the talbot river watershed and ndvi was seriously affected by agricultural activities therefore we inferred that the ndvi also represented the impact of agricultural activities on tp and tn in the talbot river estuary the precipitation especially short duration intense rainfall events input phosphorous and nitrogen from agricultural fertilization into the lake through surface runoff resulting in the increase of tp and tn we observed that discharge affected tp and tn in the talbot river estuary with d of 0 49 and 0 45 respectively the holland river watershed is one of the most densely populated areas in lake simcoe watershed the phosphorous and nitrogen emissions from urbanization led to the increase of tp and tn in the holland river estuary therefore urban area became one of the main affecting factors of tp r 0 52 d 0 59 and tn r 0 50 d 0 54 in the holland river estuary the main affecting factors of sdd in lake simcoe included urban area farmland area cell nighttime light precipitation air temperature water surface temperature and discharge in the context of intensive urbanization the increasing impermeable surfaces such as roads accelerated the inflow of wastewater into the lake without infiltration stets et al 2020 the short duration intense rainfall events were also considered to aggravate the runoff production and confluence in addition agricultural activities and appropriate air temperature water surface temperature brought sufficient nutrients and created ideal environments for algal growth s wang et al 2020 we speculated that these processes led to the decrease of sdd in lake simcoe the factors dominating sdd in the talbot river estuary and holland river estuary were different in the talbot river estuary natural factors air temperature r 0 58 d 0 64 and water surface temperature r 0 54 d 0 57 were the main factors while in the holland river estuary in addition to air temperature and water surface temperature urban area discharge and cell also significantly affected sdd we inferred that the sdd in the talbot river estuary was mainly affected by algal growth while the sdd in the holland river estuary was affected by both terrestrial suspended solids and algal growth farmland area urban area ndvi precipitation air temperature discharge and water surface temperature were the main factors affecting the doc in lake simcoe this result showed that the doc in lake simcoe mainly came from the input of organic matter from urban and agricultural areas through runoff and the algal growth in the lake high phosphorous and nitrogen loads caused by urban development and agricultural activities surface runoff caused by precipitation and appropriate water temperature for algal growth might contribute to the increase of doc similar to lake simcoe doc in the talbot river estuary was also affected by human activities i e farmland area and natural factors i e ndvi air temperature and water surface temperature while in the holland river estuary anthropogenic factors i e urban and farmland areas were the main factors affecting doc in lake simcoe farmland area urban area cell air temperature water surface temperature wind speed and pressure were the main factors affecting do indicating that both natural and anthropogenic factors had impacts on do urban development and agricultural activities increased the phosphorous and nitrogen loads in the lake and promoted algal growth in the short term algal photosynthesis led to the increase of do while in the near future microbial decomposition of the algal debris induced the substantial decrease of do many studies showed that there exist significant negative and positive correlations between air temperature water surface temperature and pressure and do respectively besides waves created by winds accelerated the oxygen in the air to enter the water through aeration hence wind speed showed a significant correlation with do r 0 54 d 0 56 natural factors including air temperature water surface temperature wind speed discharge pressure and precipitation dominated the do of the talbot river estuary the factors affecting do in the holland river estuary were similar to those of lake simcoe mainly including urban area cell nighttime light precipitation air temperature discharge and water surface temperature runoff from urban and agricultural areas not only carried rich nutrients to promote algal growth but also carried a large amount of organic matter microbial decomposition of algal debris and organic matter consumed much do and even led to fish kills due to hypoxia in summary the water quality of lake simcoe and its two most concerned estuaries was mainly affected by human activities such as urban and farmland areas the natural factors e g air temperature water surface temperature precipitation and discharge also had significant impacts on the water quality in these areas the affecting factors of different wqps were different the climate land use nighttime light cell water surface temperature and ndvi data used in this study were retrieved from global open source data products without regional validation and correction the temporal 30 days and spatial resolution 500 m of part data sets were relatively low although this might lead to uncertainties in the quantification of water quality affecting factors we considered that the above results still provided a basis for identifying potential affecting factors of water quality and water quality management in lake simcoe 5 conclusion in this study we proposed enhanced multimodal deep learning models i e emdl for lake simcoe chla tp tn sdd doc and do estimation using remote sensing the emdl models were developed and validated using the r rs data derived from the improved harmonized landsat and sentinel 2 data and synchronized lslmp in situ water quality measurements and water surface temperature and climate data n 950 the in situ water quality measurements of lsrca n 223 were used as independent data sets to further verify the model generalization we compared the performance of the emdl models with several other machine learning and deep learning models i e mdl sdnn xgboost rf and svr as well as empirical algorithms i e mlr oc2 and oc3 for chla estimation algorithms in zhang et al 2021 and olmanson et al 2011 for sdd estimation and algorithm in cao and tzortziou 2021 for doc estimation on the lslmp test set we also compared the performance of the emdl models and several other candidate algorithms in spatiotemporal mapping and time series estimation of wqps the model evaluation indicated that the emdl models produced satisfactory performance in chla tp tn sdd doc and do estimation of lake simcoe with slope being close to 1 0 84 0 95 mae 20 17 and bias 14 68 introducing the climate data into the model input enhanced the model performance the results showed that the emdl models had the potential to reconstruct the spatial patterns and time series dynamics of water quality and effectively capture the gradients of spatial variations the fusion of landsat 8 and sentinel 2 data improved the time resolution for meter scale resolution optical satellite images which contributed to the water quality monitoring of inland and coastal waters we calculated the contributions of the input features to the emdl models using the shap and discussed the potential to split the estimation interactions among the wqps which increased the physical interpretability of the models to a certain extent using the developed emdl models we reconstructed and analyzed the spatial distributions and time series variations of the wqps in lake simcoe from 2013 to 2019 furthermore we quantitatively analyzed the impacts of 12 potential natural i e air temperature pressure precipitation wind speed wind direction and discharge and anthropogenic i e cell urban area farmland area nighttime light and ndvi factors on the water quality of lake simcoe the results showed that the water quality of lake simcoe and its two most concerned estuaries was mainly affected by human activities such as urban development and agricultural production the natural factors e g air temperature water surface temperature precipitation and discharge also had significant impacts on the water quality in these areas this study provides a framework for environmental management practices in inland watersheds such as water quality monitoring and identification of affecting factors credit authorship contribution statement hongwei guo conceptualization methodology software writing original draft xiaotong zhu methodology jinhui jeanne huang supervision validation writing review editing zijie zhang data curation visualization shang tian software data curation visualization yiheng chen writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by the national key research and development program of china no 2016yfc0400709 we appreciate the careful and thoughtful comments of two anonymous reviewers which helped improve this paper substantially appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129466 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2073,landscape composition and configuration of urban patches impact greatly on hydrological process of which low impact development practices lids have been incorporated worldwide to management stormwater runoff quantity and quality related issues although optimization design for lids has been studied extensively to improve stormwater management at catchment scale a further study of lids based landscape configuration at site scale has not been fully explored in this study a two scale optimization framework was constructed to integrate spatial layout and landscape configuration of lids using swmm nsga ii and gis techniques the spatial optimization at catchment scale showed that area of sink landscape almost doubled as the distance to outlets decreased a further site scale optimization by a new landscape metric in terms of crss configuration ratio between patches of runoff sources and sink was conduct to achieve lids based landscape configuration optimization runoff flow and pollution were significantly correlated with crss in power function quantifying crss thresholds of 0 57 0 69 as the most adaptive strategies for stormwater management notably the crss thresholds were higher for ammonia nitrogen nh3 n and suspended solid ss pollution especially targeting source patches of roofs the optimization in this study could improve the reduction of runoff peak flow of heavy rain peak concentration of chemical oxygen demand and ss and initial scouring of nh3 n keywords low impact development optimization source sink landscape configuration ratio stormwater management non point source pollution data availability data will be made available on request 1 introduction urban areas are increasingly suffering from a series of climate driven extreme events which especially aggravates the risks of urban flooding and surface water pollution eckart et al 2017 liao et al 2021 a key point is the conversions of natural landscapes into urban patches chang et al 2021 it will disturb natural hydrological process during the processes of flow control detention retention infiltration and treatment kong et al 2021 in recent decades low impact development practices lids have been widely and extensively practiced worldwide to restore natural hydrological processes and pre development conditions epa 2000 aiming to solve both stormwater quantity and quality problems liu et al 2017 lopes and da silva 2021 yang et al 2022 the incorporation of lids at catchment scale into landscape composition and configuration at site scale is critical to derive adaptive strategies for effective stormwater management with the rapid development of landscape theory landscape patterns including landscape composition and configuration determine the storage exchange and movement of water flows among different landscape patches liu et al 2020 landscape composition refers to the proportion of different land use patches within the landscape while landscape configuration refers to the physical and spatial distribution of these patches and their relationships to each other mcgarigal and marks 1995 generally landscape composition exhibits distinct hydrological functions which are usually defined as source and sink landscapes playing promoting and weakening roles for hydrological flows respectively sun et al 2018 the theory of source sink landscape has been successfully applied in many research fields such as ecological risk wu et al 2021 population dynamics iles et al 2018 and environmental pollution zhang et al 2021a furtherly landscape composition is expected to regulate catchment hydrological variations through modifying hydrological process according to the above theories lids should be considered as sink landscapes and regulate urban landscape compositions as they can change the physical distribution spatial characteristics zeng et al 2020 kumar et al 2022 and hydrological connection mao et al 2017 tang et al 2022 of landscapes therefore lids based landscape configuration at site scale is a vital factor for effective stormwater management and should be incorporated in lids optimization the fast development and widely application of gis geographic information system and rs remote sensing technology makes it possible to quantitatively describe the spatial characteristics and configuration of landscapes a variety of landscape pattern metrics exist representing the shape structure diversity and aggregation of landscapes yeh and huang 2009 as for stormwater runoff simulation and lids design mechanism model e g swmm storm water management model sustain mike urban etc and intelligent algorithms e g nsga ii non dominated sorting genetic algorithms picea g borg etc have been widely used to solve flooding pollution related problems zhang and chui 2018 ferrans et al 2022 however a gap still exists regarding the integration of simulation optimization and landscape configuration techniques their combination is even more extremely important because some studies have confirmed that lids may fail when receiving excessive runoff from source landscapes due to their capacity limitation eckart et al 2017 dai et al 2020 an integrated framework is necessary to link lids planning at catchment scale and landscape configuration for optimizing source and sink patches at site scale from the quantity and quality related perspectives to address this research issue we monitored a newly built lid catchment during rainy season in 2021 by collecting extensive rainfall event samples modelling and optimization work were also conducted to explore more effective stormwater management by linking lids and landscape configuration the specific objectives were to 1 explore the integrated framework for lids based landscape configuration 2 quantify the comprehensive impacts of landscape configuration on both stormwater quantity and quality 3 investigate the thresholds of landscape configuration for effective stormwater management 2 materials and methods 2 1 study area and stormwater monitoring the future science city is adjacent to the north fifth ring road of beijing and has been constructing a typical lid urban catchment since 2009 fig 1 it is divided into north and south parts by the wenyu river of which the southern catchment has a relatively larger area about 4 6 km2 and richer functional areas the land use in the southern catchment covers approximately 11 68 roofs 34 78 roads pavements asphalt roads and roads within the community 18 32 green spaces including green belts and other green land and 14 77 under construction area fig 1 the elevation ranges from 28 to 41 m with an average slope of about 1 07 indicating a flat terrain fig s1 the average temperature is 11 13 c and precipitation is 500 600 mm with 80 received from june to august the lids implemented in this catchment involve green roof permeable pavement green belt bioretention cells etc this catchment is helpful to evaluate management efficiencies of lids on stormwater runoff and provide opportunities to quantify the optimal configuration ratio between patches of runoff source and sink landscapes the catchment has a separate sewage system with the size of drainage pipes ranging from a diameter of 0 4 m to 2 0 m or a channel section of 1 6 2 2 m to 3 0 4 0 m covering 791 junctions and 5 outfalls fig 1 to explore runoff characteristics of the current catchment the outfall 1 which has the largest catchment area was monitored for runoff flow and water quality in total 8 rainfall events were monitored in june and july 2021 a weather station hobo onset computer corporation bourne ma usa was set on the roof of the building within the study area to record continuous precipitation data with a resolution of 5 min abundant rainfall characteristics various antecedent dry days peak flow peak time rainfall amount etc were included in the 8 monitored events providing reliable information for model simulation detailed information can be found in table s1 an automatic logging flowmeter with 10 4 m3 s detection limit fl900 hach us was installed at outfall 1 to record continuous runoff flow of each rainfall event at 5 min intervals water quality samples were manually collected using 2 l plastic bottles with sampling intervals of 5 30 min which led to a total of 139 samples these collected samples were stored in a cooler immediately and shipped to an accredited laboratory for additional analysis within 24 h quality control samples and blank samples were analyzed first to test the accuracy of the experimental instrument and manual operation then tests on the collected samples were conducted ammonia nitrogen nh3 n total phosphorus tp chemical oxygen demand cod and suspended solids ss were examined following the methods hj 535 2009 gb 11893 1989 gb11914 1989 and gb 11901 1989 in the determination methods for the examination of water and wastewater 4th edition respectively sepa 2002 2 2 an integrated framework for lids effective configuration the impacts of impervious areas on stormwater runoff generation and nps pollution have been researched widely and the directly connected impervious area is regarded as the governing landscape for determining the size of lids for stormwater management yao et al 2016 dai et al 2020 although considerable studies have been conducted to optimize spatial location and implementation ratio of lids kumar et al 2022 a further research remains under explored for quantifying lids configuration relating to sink landscape and the directly connected source landscape besides the configuration relationships may vary in different source landscapes and runoff indicators which could be one key factor for effective stormwater management eckart et al 2017 therefore an integrated framework of two scale optimization was constructed for lids based landscape configuration optimization fig 2 firstly the mechanism model swmm was operated in the current lid catchment according to which output characteristics and reduction of stormwater runoff quantity quality were simulated to achieve the specific benefits the intelligent model coupled with improved nsga ii elitist non dominated sorting genetic algorithm was then used to optimized spatial layout of lids location finally lids based landscape configuration was further optimized incorporating hydrological process during which a new landscape metric crss configuration ratio between patches of runoff sources and sink was defined its threshold effects were then quantified expecting to improve and optimize lids configuration from the scale of source sink landscapes the details were shown in section 2 3 2 5 this framework could further quantify implementation design at site scale according to lids based sink and source configuration based on the catchment scale optimized spatial layout the results and method in this study can easily be applied to other areas 2 3 modeling of stormwater management 2 3 1 model setup and calibration to characterize the spatial output of stormwater runoff quantity and quality the personal computer stormwater management model pcswmm version 2017 developed based on swmm engines was used in this study the catchment was delineated according to the digital elevation model dem through arcgis 10 2 software considering the flat terrain further delineation was conducted using the thiessen polygon function based on the pipe network layer to better characterize the impact of different underlying surface conditions on hydrological path further detailed sub catchments were delineated referring land use and digital image map layers a total of 4155 sub catchments were obtained representing homogeneous sub catchments single land use of which 1824 were 100 impervious areas fig 1 this approach made it possible to assign one lid practice to every homogenous sub catchment and modify their designs with no major alterations on the sub catchment parameters sub catchment was connected to the nearest junction or other sub catchments according to dem data and field investigation the area of these sub catchments ranged from 0 001 to 10 3 ha to calibrate swmm model the sensitivity based radio tuning calibration srtc tool in pcswmm was used to analyze and determine parameter sensitivity and ranges according to eq 1 and eq 2 1 v low v initial 1 v f 2 v high v initial 1 v f where v initial is the initial value of calibrated parameter v f is the uncertainty value v low and v high are lower and upper limits of the calibrated parameter respectively the initial values of calibrated parameters were set referring to some relevant studies i e hou et al 2020 lopes and da silva 2021 zhang and chui 2020 etc the nash sutcliffe efficiency nse and pearson correlation coefficient r2 were used to evaluate the fitness between measured data and simulated data fig 3 shows the calibration results of runoff flow and the pollution calibration results were in figs s2 s5 generally the r2 in both calibration and validation were greater than 0 7 and nse values were above 0 5 table s2 indicating acceptable results in contrast to some other studies randall et al 2019 ebrahimian et al 2021 the model parameters can be found in tables s3 s4 2 3 2 runoff reduction assessment to evaluate the ability of the current lid catchment to runoff quantify and pollution reduction the baseline scenario was constructed which was obtained by removing the current existing lids it served as a baseline to characterize runoff output in traditional urban development runoff management efficiencies of the current lid catchment including runoff volume and pollutant loads cod nh3 n tp and ss reduction can be quantified by eq 3 3 p current ri baseline ri current ri baseline 100 where ri baseline represents the runoff index under baseline scenario including runoff volume and pollutant loads cod nh3 n tp and ss ri current indicates the runoff index under current scenarios p current is the runoff management efficiency of the current scenario 2 4 spatial optimization of lids at catchment scale 2 4 1 lid facilities selection with excellent performance on stormwater management biswal et al 2022 bioretention cells and permeable pavement as popular facilities were selected for spatial layout optimization to improve stormwater reduction efficiencies in the study area specifically bioretention cells were adopted for allocation to potential green spaces which received runoff from roof and community sidewalk directly the potential sites for permeable pavement were decided through satellite maps and field investigation according to which some sidewalks and roads in the communities were selected table s5 records the lids parameters based on previous researches 2 4 2 multi objective optimization the optimal design of lids is generally intended to maximize the benefits in terms of runoff quantity and quality control with cost reduction the nsga ii was chosen in this study which conserves the best individuals of each generation to the next generation however some sensitive parameters such as population cross over rate mutation rate etc are necessary while may affect the optimization results therefore an improved adaptive nsga ii aansga ii was used in this study which adopted dynamically adaptive populations and cross mutation coefficients thus not required assigning values to sensitive parameters and would reduce model uncertainties the flowchart of the multi objective optimization model coupling nsga ii and swmm was shown in fig s6 some details of the multi objective optimization platform can be found in our previous study chen et al 2021 2 4 3 determination of objectives and decision variables to find the optimal scheme that can achieve runoff quantity and pollution reduction under specific targets with less cost six objectives were set including cost runoff quantity and pollutant loads reduction showing an approximately 60 runoff volume reduction corresponding to the minimum of 20 70 50 and 55 reduction for cod nh3 n ss and tp respectively which was an annual downscaling decomposition result shown in our previous study zhang et al 2021b it should be noted that these objectives were annual averages for optimization all rainfall events during the monitoring period of this study were simulated continuously to assess whether the optimization results were satisfactory therefore the optimization results were considered reasonable when they were close to the expected objectives the objective of minimum cost was set according to the lids construction cost referring to a summary database xu et al 2022 as shown in eq 4 the eq 5 and eq 6 show runoff related objectives 4 min i 1 m j 1 n c i j 1 0 5 min q 6 min l p where c i j denotes the cost of lid type j in sub catchment i the 1 indicates that type i will be adopted in the sub catchment i otherwise it is 0 q is the runoff quantity of all the outfalls while l p is pollutant loads cod nh3 n tp or ss output of all the outfalls the decision variables were spatial locations for different lids based on the potential sites in section 2 4 1 a further detailed screening was conducted considering filed function which produced 936 decision variables in total sub catchments that only incorporated single land use have been delineated so 1 and 0 were set to represent whether the decision variables were selected or not the area of each lid was defined based on the available space of each sub catchment pareto front was obtained following eq 7 according to which the optimal lids layout can be selected 7 p optimal ri baseline ri optimal ri baseline 100 where ri baseline represents the runoff index under baseline scenario including runoff volume and pollutant loads cod nh3 n tp and ss ri optimal indicates the runoff index of the optimal scheme p optimal is the efficiencies of lids in the optimal scheme 2 5 lids based landscape configuration at site scale 2 5 1 definition of the crss a new landscape metric in terms of configuration ratio between patches of runoff sources and sink crss was defined impervious coverage ic especially the direct impervious coverage dic where runoff flows directly into the pipe network without flowing through the pervious area fig s7 dominates regional runoff and pollution generation yao et al 2016 dai et al 2020 and is usually regarded as source landscapes green fields can absorb runoff and intercept pollutants which are considered as sink landscapes commonly however less attention has been paid to configuration ratio between indirect source and sink landscapes which could produce erroneous estimates if dic are used to predict runoff output in situations of fig s7a and c if the configuration ratio in fig s7b is assumed to be a threshold state the runoff output decreases initially with the decrease of dic before reaching the threshold from fig s7a to b while may remain constant when exceeding the threshold from fig s7b to c consequently the configuration ratio between source and sink landscapes that have upstream and downstream relationships becomes critical otherwise some indirect impervious coverage may be equivalent to direct impervious coverage in this study a landscape configuration optimization was further conducted considering hydrological path based processes the crss was defined by eq 8 8 i sink s o u r c e area g area idic where i sink s o u r c e is the configuration ratio between patches of runoff sources and sink crss area g is the area of green field and area idic is the area of indirect impervious coverage 2 5 2 quantification of the crss metric to quantify the crss metric patch combinations of source and sink landscapes should be searched and identified according to the hydrological process in this study very fine sub catchments that only incorporated single land use were delineated and the flow directions were defined according to dem data and field investigation which provided opportunities for hydrological path searching and source sink landscape identifying using gis technique a further screening was conducted to select the combinations where hydrological paths had homogeneity without multiple flow directions the crss threshold represents the critical state of the sink landscape s ability to manage runoff above which runoff reduction is less effective while below which economic benefits are poor therefore it is significant to explore the threshold effects of crss on runoff management which will facilitate the implementation of lids optimization and the management of urban flood and non point source nps pollution more effectively to explore the crss thresholds regression analysis was conducted the regression between runoff volume pollutant output and crss was conducted firstly then the response relationship of runoff variations caused by crss change was fitted according to eq 9 adjust r2 and residual distribution were used to examine regression results taking the runoff volume in fig s8 as an example the increase of crss reduced volume output dramatically initially and then remained stable consequently the point where runoff output did not decrease significantly was defined as the crss threshold fig s8b in order to quantify the threshold the curvature model was introduced within various situations following eq 10 the quantified crss thresholds is of great significance to predict runoff occurrence and guide lids construction 9 g x f δ x dx 10 ρ x x i g x i 1 g x i 2 3 2 where f x represents regression between runoff output and crss g x is the response regression of runoff variations caused by unit crss variation of which g x i is the first derivative and g x i is the second derivative ρ indicates the curvature 3 results 3 1 spatial output and management efficiencies of the current lids continuous meteorological data in june and july were input into the calibrated swmm model to characterize the spatial output of runoff volume and pollutant load fig 4 illustrates significant spatial heterogeneity of runoff output which was closely related to land use types the runoff volume and pollutant load per unit area of open land under construction land and green space were lower comparatively the residential areas and the commercial areas located in the northwest and central east respectively generated more runoff volume and pollutant loads where high intensity of anthropogenic activities accounted for the main reasons chang et al 2021 moreover spatial characteristics of runoff pollution varied in pollutants for all underlying surfaces except for the land under construction cod and ss pollution were more serious whereas lower pollution of nh3 n and tp mainly occurred in asphalt pavement and green space respectively generally cod and ss primarily come from roof and road runoff hu et al 2020 and account for more than 50 of particles in the receiving water bodies ma et al 2018 therefore they tend to be transported easily through stormwater runoff on impervious surfaces the study area is a new urban district where separate drainage system is constructed without combined sewer overflows consequently there was less tp pollution that mainly comes from municipal sewage occurred sweeping contributes to pollutant removal resulting lower nh3 n pollution on asphalt pavement which tracks with jarlskog et al 2020 who illustrate a potential prevention of runoff pollution transmission through road sweeping however grassland and roofs showed serious nh3 n pollution which could be caused by over maintenance of grassland using nutrients and atmospheric n deposition respectively in line with our previous study zhang et al 2021a in general roofs and roads are the key sites for stormwater runoff pollution management runoff volume and pollution reduction by the current lids were quantified through eq 3 table s6 shows that better performances on runoff management of current lid catchment were found toward moderate and light rainfall events with a about 60 runoff reduction in line with the conclusion by yang et al 2021 in a newly developed lid catchment rainfall intensity affected runoff volume and pollution reduction seriously resulting in an 30 50 decrease with rainfall changed from moderate and light to heavy rain despite similar conclusions from many other studies she et al 2021 believe that load reduction of tss cod tn and tp can reach 60 after optimization even in heavy rainfall events the comprehensive effect of runoff management was quantified through continuous rainfall simulation showing an approximately 40 60 pollutant load reduction and 48 38 runoff volume reduction table s6 which however have not yet reached the local objectives see 2 4 2 it is necessary to optimize the lids design in this region to further improve runoff management effects 3 2 charactering the catchment scale spatial optimization spatial locations of the sink landscapes were optimized to achieve expected stormwater management objectives fig 5 a shows all the alternatives obtained by aansga ii algorithm about 8000 in total among which 700 optimal alternatives were found in pareto front decision makers can choose any alternative in pareto frontier based on specific objectives however the selected alternative may not achieve the desired management efficiencies therefore according to the decomposition objectives an approximately 60 runoff volume reduction corresponding to the minimum of 20 70 50 and 55 reduction for cod nh3 n ss and tp respectively as shown in section 2 4 3 4 groups of alternatives were divided by assessing whether the individual indicators of each alternative met the stated objectives in alternative group 1 only cod pollution reduction satisfied the requirements the ss nh3 n and tp pollution management successively met the requirements as the increase of cost from alternative group 2 to alternative group 4 comprehensively the optimal alternative with lowest cost in group 4 was finally decided of which runoff volume reduction was 58 closing to the decomposition objective for runoff volume management fig 5b illustrates the spatial layout of the determined optimal alternative the blue blocks indicated the sink landscapes in catchment of outfall 1 o1 while green blocks were the sink landscapes in catchment of outfall 3 o3 in both catchments area of sink landscapes almost doubled as the distance to outlets decreased quantifying a variation from 20 81 to 38 69 in o1 catchment and from 8 58 to 17 62 in o3 catchment fig 5b generally runoff volume and pollutants in the sub catchments near the outlets are easier to be transported to receiving waterbodies and thus cause more serious water pollution geng et al 2019 therefore more sink landscapes in the sub catchments near the outlet could achieve higher stormwater management benefits moreover the area proportion of sink landscapes in the o3 catchment 59 50 was more than twice that of o1 26 20 the o3 catchment is a concentrated residential area where more runoff volume and pollutions could be generated by high intensity of anthropogenic activities chang et al 2021 comprehensively the spatial location of sink landscapes is related to the distance from the pipe network outlet and the spatial characteristics of runoff output 3 3 lids based landscape configuration at site scale area ratio of lids could be a key factor affecting runoff management ahiablame et al 2012 it is necessary to explore optimal crss values targeting different source landscapes and runoff indicators a total of 124 source sink landscape combinations were screened shown in fig s9 the crss values were calculated according to eq 8 fig 6 shows that the output of runoff volume and pollutant loads flattened out gradually after a dramatical decline as the crss increased which could be mainly caused by lids capacity limitation in runoff retention detention jia et al 2015 kumar et al 2022 besides it was found that the output of runoff quantity and pollutant loads significantly correlated with the crss in power function table s7 providing opportunities for runoff prediction the thresholds of crss were expected to achieve the most adaptive strategies for stormwater management considering landscape configuration effectiveness which were quantified by eq 9 and eq 10 the results quantified the thresholds of 0 57 0 63 0 66 0 62 and 0 68 for cod nh3 n ss tp and runoff volume reduction responding to area ratios of sink landscapes of 36 31 38 65 39 76 38 27 and 40 48 respectively targeting source landscapes of roofs fig 6 the thresholds were 0 58 0 69 0 61 0 62 and 0 58 respectively 36 71 40 83 37 89 38 27 and 36 71 for area ratios of sink landscape for source landscapes of roads lopes and da silva 2021 also believe a more than 40 lids coverage percentage would achieve dramatically increase of runoff reduction however lee et al 2022 indicated that 3 10 lids coverage could attain desirable runoff and pollution reduction most previous studies focused on total ratio of lids coverage in a sub catchment or whole study area while less considering the configuration ratio between lids area and its service area nevertheless the latter seems to be more important due to the limited ability of lids on runoff and pollution reduction eckart et al 2017 dai et al 2020 the crss thresholds quantified the capacity and effectiveness of lids in runoff management which could provide references for lids planning and implementing at site scale more precisely the crss thresholds varied in both runoff indicators and source landscape types the crss thresholds for nh3 n and ss pollution management were higher than others which may be related to pollution characteristics of the study area in urban catchment over maintenance of grassland using nutrients and atmospheric n deposition account for the main source for nh3 n pollution while particulate pollutants can be transported easily on impervious surface lundy et al 2012 müller et al 2020 the results in fig 4 indicate more serious nh3 n and ss pollution so a higher crss was needed for their pollution reduction meanwhile the thresholds were also impacted by source landscape types generally the average threshold related to source landscapes of roofs 0 632 was slightly higher than road landscapes 0 616 possible reasons were the different confluence processes the grass swale or greenbelt usually arranged along the road provides long confluence path for stormwater runoff which creates more possibilities for runoff infiltration and pollutant interception gavrić et al 2019 comparatively shorter confluence path occurs in green land around buildings mehmood et al 2021 leading to the need for higher crss targeting effective runoff reduction this study optimized the lids based source sink landscape configuration and quantified their thresholds which is expected to integrate lids optimization with landscape configuration 4 discussion 4 1 management efficiencies with the two scale optimization in this study runoff duration curves of different rainfall events under current and optimal schemes were comparatively analyzed fig 7 indicates that differences in runoff flow occurred at cumulative probability of 60 in moderate and light rain while cumulative probability of 80 in heavy rain commonly the lids face limited infiltration and retention capacities restraining the rapid capture of a large amount of runoff during high intensity storms hou et al 2020 yang et al 2022 showing better performance for light events liu et al 2017 therefore less significant differences were shown in the heavy rainfall events for runoff flow reduction however as for peak flow reduction it increased by 20 70 in heavy rain by optimal scheme compared with current scenario while only an estimated 10 higher reduction in other rainfall events but studies elucidated that runoff volume was more sensitive to changes in rainfall intensity than peak flow with a 32 and 19 reduction drop respectively when facing 1 to 100 year rainfall events sohn et al 2019 consequently effective configuration of source sink landscapes could maximize the ability of sink landscapes which performed more substantially through peak flow reduction the incorporation of landscape configuration for lids optimization is expected to meet the challenge of lids performance under extreme climate conditions the optimal scheme for pollution reduction varied in rainfall events and pollutants more significant reduction was achieved by optimal scheme in moderate and light events with a difference in cumulative probability of 20 it is probably due to the fact that the strong rainfall enhanced the first flush effect and thus washed off a high proportion of the diffusive pollutants bach et al 2010 which led to higher pressure for lids to intercept pollutants therefore the optimal scheme worked better for pollution reduction under moderate and light rainfall conditions for different pollutants tp pollution showed week differences at all rainfall events while nh3 n cod and ss showed similar variations in light rain however varied greatly in heavy rain the p mainly comes from agricultural activities and lower nps phosphorus pollution in urban catchments zhang et al 2021a which reduced the difference of tp pollution management under different rainfall events generally cod and ss had similarities during the duration curves which in line with the perspectives from müller et al 2020 differences occurred at cumulative probability of 60 80 for cod and ss however at cumulative probability of 80 for nh3 n besides fig 7 indicates that peak concentration reduction of cod and ss was more than twice that of nh3 n this could be affected by pollutant properties for example ss as a particulate pollutant is easily intercepted by vegetation after being washed into runoff so its concentration could be affected greatly by sink landscapes hu et al 2020 müller et al 2020 consequently it can be concluded that the improvement of cod and ss pollution reduction by the optimal scheme performed in their peak concentration reduction while nh3 n concentration reduction mainly occurred in initial scouring management the optimal scheme can further improve the stormwater management capacity especially the peak flow reduction under heavy rain conditions the understanding of lids on runoff pollution management mechanism could provide significant insight for lids design and implementation 4 2 thresholds for lid based landscape configuration spatial optimization at catchment scale provided opportunities to site lids in the suitable places zhang and chui 2020 lopes and da silva 2021 while landscape configuration optimization at site scale further defined detailed implementation objectives the design with an appropriate balance between the contributing area and the lids area is one of the most parameters to be optimized khadka et al 2021 to fill this research gap the present study integrated lids optimization and landscape configuration using swmm nsga ii and gis techniques to achieve optimal lids based landscape configuration the method and results could be applied in other regions due to the global issue of rapid urbanization and stormwater management gogate et al 2017 zhang et al 2021a the proposed crss is a new lids based landscape metric for effective stormwater management specifically the quantified crss thresholds suggested the construction scale of lids referring to source landscape where runoff is generated this is a landscape configuration result at site scale quantifying the maximum capacity of lids and demonstrating their adaptability for stormwater management spatial optimization determines the location of lids while crss further quantifies the configurations ratio of lids to source landscapes therefore the two scale optimization makes lids planning more reliable and scientific the results of crss thresholds can be used directly in other regions when the location of lids has been determined there are some advantages of this new landscape metric on the one hand it is a more detailed objective for lids design at site implementation scale compared with the indicators in previous studies e g lids coverage in a sub catchment or whole study area on the other hand it is easily calculated according to the given crss values if obtaining the area of source landscapes moreover roads and roofs are two main source landscapes of stormwater runoff in urban context yao et al 2016 dai et al 2020 however show distinct principles for runoff pollution generation ma et al 2018 and the interactions with lids gavrić et al 2019 mehmood et al 2021 this study quantified various crss values toward different source landscapes roads and roofs as well as different runoff indicators runoff volume nh3 n tp ss and cod the results can be used in various scenarios for different places the crss linked lids optimization and landscape configuration benefiting lids planning and implementation more precisely 5 conclusion this study optimized lids based landscape configuration through an integrated framework by linking lids and landscape configuration for optimizing source and sink patches the swmm nsga ii gis techniques and a new crss landscape metric were integrated from the quantity and quality related perspectives based on the results the runoff output was spatially heterogeneous with higher runoff quantify and pollution in high density residential areas besides it also varied in pollutants the spatial layout of sink landscapes at catchment scale was related to the distance from the pipe network outlet and the spatial characteristics of runoff output two common source landscape types roads and roofs were studied for landscape configurations optimization at site scale indicating the crss thresholds of 0 57 0 69 for the most effective runoff quantity and quality management however the crss thresholds varied in both runoff indicators and source landscape types with higher thresholds for nh3 n and ss pollution and for source landscapes of roofs the two scale optimization showed the improvement of peak flow reduction in heavy rain peak concentration reduction of cod and ss and initial scouring reduction of nh3 n however some limitations existed in this study different types of lids were not involved which were generalized as a sink landscape for runoff management due to the large scale of the study area different types of lids possess different capacities for stormwater management the crss values quantified in this study may be overestimated or underestimated for a specific lid practice more research work is needed in the future to determine the crss value for each lid measure credit authorship contribution statement xiaoyue zhang conceptualization funding acquisition investigation methodology writing original draft lei chen conceptualization funding acquisition supervision writing review editing chenxi guo writing review editing haifeng jia conceptualization writing review editing zhenyao shen funding acquisition supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was funded by the fund for the innovative research group of the national natural science foundation of china grant no 52221003 the national high tech research and development program of china grant no 51779010 and project funded by china postdoctoral science foundation grant no 2022m711799 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129332 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2073,landscape composition and configuration of urban patches impact greatly on hydrological process of which low impact development practices lids have been incorporated worldwide to management stormwater runoff quantity and quality related issues although optimization design for lids has been studied extensively to improve stormwater management at catchment scale a further study of lids based landscape configuration at site scale has not been fully explored in this study a two scale optimization framework was constructed to integrate spatial layout and landscape configuration of lids using swmm nsga ii and gis techniques the spatial optimization at catchment scale showed that area of sink landscape almost doubled as the distance to outlets decreased a further site scale optimization by a new landscape metric in terms of crss configuration ratio between patches of runoff sources and sink was conduct to achieve lids based landscape configuration optimization runoff flow and pollution were significantly correlated with crss in power function quantifying crss thresholds of 0 57 0 69 as the most adaptive strategies for stormwater management notably the crss thresholds were higher for ammonia nitrogen nh3 n and suspended solid ss pollution especially targeting source patches of roofs the optimization in this study could improve the reduction of runoff peak flow of heavy rain peak concentration of chemical oxygen demand and ss and initial scouring of nh3 n keywords low impact development optimization source sink landscape configuration ratio stormwater management non point source pollution data availability data will be made available on request 1 introduction urban areas are increasingly suffering from a series of climate driven extreme events which especially aggravates the risks of urban flooding and surface water pollution eckart et al 2017 liao et al 2021 a key point is the conversions of natural landscapes into urban patches chang et al 2021 it will disturb natural hydrological process during the processes of flow control detention retention infiltration and treatment kong et al 2021 in recent decades low impact development practices lids have been widely and extensively practiced worldwide to restore natural hydrological processes and pre development conditions epa 2000 aiming to solve both stormwater quantity and quality problems liu et al 2017 lopes and da silva 2021 yang et al 2022 the incorporation of lids at catchment scale into landscape composition and configuration at site scale is critical to derive adaptive strategies for effective stormwater management with the rapid development of landscape theory landscape patterns including landscape composition and configuration determine the storage exchange and movement of water flows among different landscape patches liu et al 2020 landscape composition refers to the proportion of different land use patches within the landscape while landscape configuration refers to the physical and spatial distribution of these patches and their relationships to each other mcgarigal and marks 1995 generally landscape composition exhibits distinct hydrological functions which are usually defined as source and sink landscapes playing promoting and weakening roles for hydrological flows respectively sun et al 2018 the theory of source sink landscape has been successfully applied in many research fields such as ecological risk wu et al 2021 population dynamics iles et al 2018 and environmental pollution zhang et al 2021a furtherly landscape composition is expected to regulate catchment hydrological variations through modifying hydrological process according to the above theories lids should be considered as sink landscapes and regulate urban landscape compositions as they can change the physical distribution spatial characteristics zeng et al 2020 kumar et al 2022 and hydrological connection mao et al 2017 tang et al 2022 of landscapes therefore lids based landscape configuration at site scale is a vital factor for effective stormwater management and should be incorporated in lids optimization the fast development and widely application of gis geographic information system and rs remote sensing technology makes it possible to quantitatively describe the spatial characteristics and configuration of landscapes a variety of landscape pattern metrics exist representing the shape structure diversity and aggregation of landscapes yeh and huang 2009 as for stormwater runoff simulation and lids design mechanism model e g swmm storm water management model sustain mike urban etc and intelligent algorithms e g nsga ii non dominated sorting genetic algorithms picea g borg etc have been widely used to solve flooding pollution related problems zhang and chui 2018 ferrans et al 2022 however a gap still exists regarding the integration of simulation optimization and landscape configuration techniques their combination is even more extremely important because some studies have confirmed that lids may fail when receiving excessive runoff from source landscapes due to their capacity limitation eckart et al 2017 dai et al 2020 an integrated framework is necessary to link lids planning at catchment scale and landscape configuration for optimizing source and sink patches at site scale from the quantity and quality related perspectives to address this research issue we monitored a newly built lid catchment during rainy season in 2021 by collecting extensive rainfall event samples modelling and optimization work were also conducted to explore more effective stormwater management by linking lids and landscape configuration the specific objectives were to 1 explore the integrated framework for lids based landscape configuration 2 quantify the comprehensive impacts of landscape configuration on both stormwater quantity and quality 3 investigate the thresholds of landscape configuration for effective stormwater management 2 materials and methods 2 1 study area and stormwater monitoring the future science city is adjacent to the north fifth ring road of beijing and has been constructing a typical lid urban catchment since 2009 fig 1 it is divided into north and south parts by the wenyu river of which the southern catchment has a relatively larger area about 4 6 km2 and richer functional areas the land use in the southern catchment covers approximately 11 68 roofs 34 78 roads pavements asphalt roads and roads within the community 18 32 green spaces including green belts and other green land and 14 77 under construction area fig 1 the elevation ranges from 28 to 41 m with an average slope of about 1 07 indicating a flat terrain fig s1 the average temperature is 11 13 c and precipitation is 500 600 mm with 80 received from june to august the lids implemented in this catchment involve green roof permeable pavement green belt bioretention cells etc this catchment is helpful to evaluate management efficiencies of lids on stormwater runoff and provide opportunities to quantify the optimal configuration ratio between patches of runoff source and sink landscapes the catchment has a separate sewage system with the size of drainage pipes ranging from a diameter of 0 4 m to 2 0 m or a channel section of 1 6 2 2 m to 3 0 4 0 m covering 791 junctions and 5 outfalls fig 1 to explore runoff characteristics of the current catchment the outfall 1 which has the largest catchment area was monitored for runoff flow and water quality in total 8 rainfall events were monitored in june and july 2021 a weather station hobo onset computer corporation bourne ma usa was set on the roof of the building within the study area to record continuous precipitation data with a resolution of 5 min abundant rainfall characteristics various antecedent dry days peak flow peak time rainfall amount etc were included in the 8 monitored events providing reliable information for model simulation detailed information can be found in table s1 an automatic logging flowmeter with 10 4 m3 s detection limit fl900 hach us was installed at outfall 1 to record continuous runoff flow of each rainfall event at 5 min intervals water quality samples were manually collected using 2 l plastic bottles with sampling intervals of 5 30 min which led to a total of 139 samples these collected samples were stored in a cooler immediately and shipped to an accredited laboratory for additional analysis within 24 h quality control samples and blank samples were analyzed first to test the accuracy of the experimental instrument and manual operation then tests on the collected samples were conducted ammonia nitrogen nh3 n total phosphorus tp chemical oxygen demand cod and suspended solids ss were examined following the methods hj 535 2009 gb 11893 1989 gb11914 1989 and gb 11901 1989 in the determination methods for the examination of water and wastewater 4th edition respectively sepa 2002 2 2 an integrated framework for lids effective configuration the impacts of impervious areas on stormwater runoff generation and nps pollution have been researched widely and the directly connected impervious area is regarded as the governing landscape for determining the size of lids for stormwater management yao et al 2016 dai et al 2020 although considerable studies have been conducted to optimize spatial location and implementation ratio of lids kumar et al 2022 a further research remains under explored for quantifying lids configuration relating to sink landscape and the directly connected source landscape besides the configuration relationships may vary in different source landscapes and runoff indicators which could be one key factor for effective stormwater management eckart et al 2017 therefore an integrated framework of two scale optimization was constructed for lids based landscape configuration optimization fig 2 firstly the mechanism model swmm was operated in the current lid catchment according to which output characteristics and reduction of stormwater runoff quantity quality were simulated to achieve the specific benefits the intelligent model coupled with improved nsga ii elitist non dominated sorting genetic algorithm was then used to optimized spatial layout of lids location finally lids based landscape configuration was further optimized incorporating hydrological process during which a new landscape metric crss configuration ratio between patches of runoff sources and sink was defined its threshold effects were then quantified expecting to improve and optimize lids configuration from the scale of source sink landscapes the details were shown in section 2 3 2 5 this framework could further quantify implementation design at site scale according to lids based sink and source configuration based on the catchment scale optimized spatial layout the results and method in this study can easily be applied to other areas 2 3 modeling of stormwater management 2 3 1 model setup and calibration to characterize the spatial output of stormwater runoff quantity and quality the personal computer stormwater management model pcswmm version 2017 developed based on swmm engines was used in this study the catchment was delineated according to the digital elevation model dem through arcgis 10 2 software considering the flat terrain further delineation was conducted using the thiessen polygon function based on the pipe network layer to better characterize the impact of different underlying surface conditions on hydrological path further detailed sub catchments were delineated referring land use and digital image map layers a total of 4155 sub catchments were obtained representing homogeneous sub catchments single land use of which 1824 were 100 impervious areas fig 1 this approach made it possible to assign one lid practice to every homogenous sub catchment and modify their designs with no major alterations on the sub catchment parameters sub catchment was connected to the nearest junction or other sub catchments according to dem data and field investigation the area of these sub catchments ranged from 0 001 to 10 3 ha to calibrate swmm model the sensitivity based radio tuning calibration srtc tool in pcswmm was used to analyze and determine parameter sensitivity and ranges according to eq 1 and eq 2 1 v low v initial 1 v f 2 v high v initial 1 v f where v initial is the initial value of calibrated parameter v f is the uncertainty value v low and v high are lower and upper limits of the calibrated parameter respectively the initial values of calibrated parameters were set referring to some relevant studies i e hou et al 2020 lopes and da silva 2021 zhang and chui 2020 etc the nash sutcliffe efficiency nse and pearson correlation coefficient r2 were used to evaluate the fitness between measured data and simulated data fig 3 shows the calibration results of runoff flow and the pollution calibration results were in figs s2 s5 generally the r2 in both calibration and validation were greater than 0 7 and nse values were above 0 5 table s2 indicating acceptable results in contrast to some other studies randall et al 2019 ebrahimian et al 2021 the model parameters can be found in tables s3 s4 2 3 2 runoff reduction assessment to evaluate the ability of the current lid catchment to runoff quantify and pollution reduction the baseline scenario was constructed which was obtained by removing the current existing lids it served as a baseline to characterize runoff output in traditional urban development runoff management efficiencies of the current lid catchment including runoff volume and pollutant loads cod nh3 n tp and ss reduction can be quantified by eq 3 3 p current ri baseline ri current ri baseline 100 where ri baseline represents the runoff index under baseline scenario including runoff volume and pollutant loads cod nh3 n tp and ss ri current indicates the runoff index under current scenarios p current is the runoff management efficiency of the current scenario 2 4 spatial optimization of lids at catchment scale 2 4 1 lid facilities selection with excellent performance on stormwater management biswal et al 2022 bioretention cells and permeable pavement as popular facilities were selected for spatial layout optimization to improve stormwater reduction efficiencies in the study area specifically bioretention cells were adopted for allocation to potential green spaces which received runoff from roof and community sidewalk directly the potential sites for permeable pavement were decided through satellite maps and field investigation according to which some sidewalks and roads in the communities were selected table s5 records the lids parameters based on previous researches 2 4 2 multi objective optimization the optimal design of lids is generally intended to maximize the benefits in terms of runoff quantity and quality control with cost reduction the nsga ii was chosen in this study which conserves the best individuals of each generation to the next generation however some sensitive parameters such as population cross over rate mutation rate etc are necessary while may affect the optimization results therefore an improved adaptive nsga ii aansga ii was used in this study which adopted dynamically adaptive populations and cross mutation coefficients thus not required assigning values to sensitive parameters and would reduce model uncertainties the flowchart of the multi objective optimization model coupling nsga ii and swmm was shown in fig s6 some details of the multi objective optimization platform can be found in our previous study chen et al 2021 2 4 3 determination of objectives and decision variables to find the optimal scheme that can achieve runoff quantity and pollution reduction under specific targets with less cost six objectives were set including cost runoff quantity and pollutant loads reduction showing an approximately 60 runoff volume reduction corresponding to the minimum of 20 70 50 and 55 reduction for cod nh3 n ss and tp respectively which was an annual downscaling decomposition result shown in our previous study zhang et al 2021b it should be noted that these objectives were annual averages for optimization all rainfall events during the monitoring period of this study were simulated continuously to assess whether the optimization results were satisfactory therefore the optimization results were considered reasonable when they were close to the expected objectives the objective of minimum cost was set according to the lids construction cost referring to a summary database xu et al 2022 as shown in eq 4 the eq 5 and eq 6 show runoff related objectives 4 min i 1 m j 1 n c i j 1 0 5 min q 6 min l p where c i j denotes the cost of lid type j in sub catchment i the 1 indicates that type i will be adopted in the sub catchment i otherwise it is 0 q is the runoff quantity of all the outfalls while l p is pollutant loads cod nh3 n tp or ss output of all the outfalls the decision variables were spatial locations for different lids based on the potential sites in section 2 4 1 a further detailed screening was conducted considering filed function which produced 936 decision variables in total sub catchments that only incorporated single land use have been delineated so 1 and 0 were set to represent whether the decision variables were selected or not the area of each lid was defined based on the available space of each sub catchment pareto front was obtained following eq 7 according to which the optimal lids layout can be selected 7 p optimal ri baseline ri optimal ri baseline 100 where ri baseline represents the runoff index under baseline scenario including runoff volume and pollutant loads cod nh3 n tp and ss ri optimal indicates the runoff index of the optimal scheme p optimal is the efficiencies of lids in the optimal scheme 2 5 lids based landscape configuration at site scale 2 5 1 definition of the crss a new landscape metric in terms of configuration ratio between patches of runoff sources and sink crss was defined impervious coverage ic especially the direct impervious coverage dic where runoff flows directly into the pipe network without flowing through the pervious area fig s7 dominates regional runoff and pollution generation yao et al 2016 dai et al 2020 and is usually regarded as source landscapes green fields can absorb runoff and intercept pollutants which are considered as sink landscapes commonly however less attention has been paid to configuration ratio between indirect source and sink landscapes which could produce erroneous estimates if dic are used to predict runoff output in situations of fig s7a and c if the configuration ratio in fig s7b is assumed to be a threshold state the runoff output decreases initially with the decrease of dic before reaching the threshold from fig s7a to b while may remain constant when exceeding the threshold from fig s7b to c consequently the configuration ratio between source and sink landscapes that have upstream and downstream relationships becomes critical otherwise some indirect impervious coverage may be equivalent to direct impervious coverage in this study a landscape configuration optimization was further conducted considering hydrological path based processes the crss was defined by eq 8 8 i sink s o u r c e area g area idic where i sink s o u r c e is the configuration ratio between patches of runoff sources and sink crss area g is the area of green field and area idic is the area of indirect impervious coverage 2 5 2 quantification of the crss metric to quantify the crss metric patch combinations of source and sink landscapes should be searched and identified according to the hydrological process in this study very fine sub catchments that only incorporated single land use were delineated and the flow directions were defined according to dem data and field investigation which provided opportunities for hydrological path searching and source sink landscape identifying using gis technique a further screening was conducted to select the combinations where hydrological paths had homogeneity without multiple flow directions the crss threshold represents the critical state of the sink landscape s ability to manage runoff above which runoff reduction is less effective while below which economic benefits are poor therefore it is significant to explore the threshold effects of crss on runoff management which will facilitate the implementation of lids optimization and the management of urban flood and non point source nps pollution more effectively to explore the crss thresholds regression analysis was conducted the regression between runoff volume pollutant output and crss was conducted firstly then the response relationship of runoff variations caused by crss change was fitted according to eq 9 adjust r2 and residual distribution were used to examine regression results taking the runoff volume in fig s8 as an example the increase of crss reduced volume output dramatically initially and then remained stable consequently the point where runoff output did not decrease significantly was defined as the crss threshold fig s8b in order to quantify the threshold the curvature model was introduced within various situations following eq 10 the quantified crss thresholds is of great significance to predict runoff occurrence and guide lids construction 9 g x f δ x dx 10 ρ x x i g x i 1 g x i 2 3 2 where f x represents regression between runoff output and crss g x is the response regression of runoff variations caused by unit crss variation of which g x i is the first derivative and g x i is the second derivative ρ indicates the curvature 3 results 3 1 spatial output and management efficiencies of the current lids continuous meteorological data in june and july were input into the calibrated swmm model to characterize the spatial output of runoff volume and pollutant load fig 4 illustrates significant spatial heterogeneity of runoff output which was closely related to land use types the runoff volume and pollutant load per unit area of open land under construction land and green space were lower comparatively the residential areas and the commercial areas located in the northwest and central east respectively generated more runoff volume and pollutant loads where high intensity of anthropogenic activities accounted for the main reasons chang et al 2021 moreover spatial characteristics of runoff pollution varied in pollutants for all underlying surfaces except for the land under construction cod and ss pollution were more serious whereas lower pollution of nh3 n and tp mainly occurred in asphalt pavement and green space respectively generally cod and ss primarily come from roof and road runoff hu et al 2020 and account for more than 50 of particles in the receiving water bodies ma et al 2018 therefore they tend to be transported easily through stormwater runoff on impervious surfaces the study area is a new urban district where separate drainage system is constructed without combined sewer overflows consequently there was less tp pollution that mainly comes from municipal sewage occurred sweeping contributes to pollutant removal resulting lower nh3 n pollution on asphalt pavement which tracks with jarlskog et al 2020 who illustrate a potential prevention of runoff pollution transmission through road sweeping however grassland and roofs showed serious nh3 n pollution which could be caused by over maintenance of grassland using nutrients and atmospheric n deposition respectively in line with our previous study zhang et al 2021a in general roofs and roads are the key sites for stormwater runoff pollution management runoff volume and pollution reduction by the current lids were quantified through eq 3 table s6 shows that better performances on runoff management of current lid catchment were found toward moderate and light rainfall events with a about 60 runoff reduction in line with the conclusion by yang et al 2021 in a newly developed lid catchment rainfall intensity affected runoff volume and pollution reduction seriously resulting in an 30 50 decrease with rainfall changed from moderate and light to heavy rain despite similar conclusions from many other studies she et al 2021 believe that load reduction of tss cod tn and tp can reach 60 after optimization even in heavy rainfall events the comprehensive effect of runoff management was quantified through continuous rainfall simulation showing an approximately 40 60 pollutant load reduction and 48 38 runoff volume reduction table s6 which however have not yet reached the local objectives see 2 4 2 it is necessary to optimize the lids design in this region to further improve runoff management effects 3 2 charactering the catchment scale spatial optimization spatial locations of the sink landscapes were optimized to achieve expected stormwater management objectives fig 5 a shows all the alternatives obtained by aansga ii algorithm about 8000 in total among which 700 optimal alternatives were found in pareto front decision makers can choose any alternative in pareto frontier based on specific objectives however the selected alternative may not achieve the desired management efficiencies therefore according to the decomposition objectives an approximately 60 runoff volume reduction corresponding to the minimum of 20 70 50 and 55 reduction for cod nh3 n ss and tp respectively as shown in section 2 4 3 4 groups of alternatives were divided by assessing whether the individual indicators of each alternative met the stated objectives in alternative group 1 only cod pollution reduction satisfied the requirements the ss nh3 n and tp pollution management successively met the requirements as the increase of cost from alternative group 2 to alternative group 4 comprehensively the optimal alternative with lowest cost in group 4 was finally decided of which runoff volume reduction was 58 closing to the decomposition objective for runoff volume management fig 5b illustrates the spatial layout of the determined optimal alternative the blue blocks indicated the sink landscapes in catchment of outfall 1 o1 while green blocks were the sink landscapes in catchment of outfall 3 o3 in both catchments area of sink landscapes almost doubled as the distance to outlets decreased quantifying a variation from 20 81 to 38 69 in o1 catchment and from 8 58 to 17 62 in o3 catchment fig 5b generally runoff volume and pollutants in the sub catchments near the outlets are easier to be transported to receiving waterbodies and thus cause more serious water pollution geng et al 2019 therefore more sink landscapes in the sub catchments near the outlet could achieve higher stormwater management benefits moreover the area proportion of sink landscapes in the o3 catchment 59 50 was more than twice that of o1 26 20 the o3 catchment is a concentrated residential area where more runoff volume and pollutions could be generated by high intensity of anthropogenic activities chang et al 2021 comprehensively the spatial location of sink landscapes is related to the distance from the pipe network outlet and the spatial characteristics of runoff output 3 3 lids based landscape configuration at site scale area ratio of lids could be a key factor affecting runoff management ahiablame et al 2012 it is necessary to explore optimal crss values targeting different source landscapes and runoff indicators a total of 124 source sink landscape combinations were screened shown in fig s9 the crss values were calculated according to eq 8 fig 6 shows that the output of runoff volume and pollutant loads flattened out gradually after a dramatical decline as the crss increased which could be mainly caused by lids capacity limitation in runoff retention detention jia et al 2015 kumar et al 2022 besides it was found that the output of runoff quantity and pollutant loads significantly correlated with the crss in power function table s7 providing opportunities for runoff prediction the thresholds of crss were expected to achieve the most adaptive strategies for stormwater management considering landscape configuration effectiveness which were quantified by eq 9 and eq 10 the results quantified the thresholds of 0 57 0 63 0 66 0 62 and 0 68 for cod nh3 n ss tp and runoff volume reduction responding to area ratios of sink landscapes of 36 31 38 65 39 76 38 27 and 40 48 respectively targeting source landscapes of roofs fig 6 the thresholds were 0 58 0 69 0 61 0 62 and 0 58 respectively 36 71 40 83 37 89 38 27 and 36 71 for area ratios of sink landscape for source landscapes of roads lopes and da silva 2021 also believe a more than 40 lids coverage percentage would achieve dramatically increase of runoff reduction however lee et al 2022 indicated that 3 10 lids coverage could attain desirable runoff and pollution reduction most previous studies focused on total ratio of lids coverage in a sub catchment or whole study area while less considering the configuration ratio between lids area and its service area nevertheless the latter seems to be more important due to the limited ability of lids on runoff and pollution reduction eckart et al 2017 dai et al 2020 the crss thresholds quantified the capacity and effectiveness of lids in runoff management which could provide references for lids planning and implementing at site scale more precisely the crss thresholds varied in both runoff indicators and source landscape types the crss thresholds for nh3 n and ss pollution management were higher than others which may be related to pollution characteristics of the study area in urban catchment over maintenance of grassland using nutrients and atmospheric n deposition account for the main source for nh3 n pollution while particulate pollutants can be transported easily on impervious surface lundy et al 2012 müller et al 2020 the results in fig 4 indicate more serious nh3 n and ss pollution so a higher crss was needed for their pollution reduction meanwhile the thresholds were also impacted by source landscape types generally the average threshold related to source landscapes of roofs 0 632 was slightly higher than road landscapes 0 616 possible reasons were the different confluence processes the grass swale or greenbelt usually arranged along the road provides long confluence path for stormwater runoff which creates more possibilities for runoff infiltration and pollutant interception gavrić et al 2019 comparatively shorter confluence path occurs in green land around buildings mehmood et al 2021 leading to the need for higher crss targeting effective runoff reduction this study optimized the lids based source sink landscape configuration and quantified their thresholds which is expected to integrate lids optimization with landscape configuration 4 discussion 4 1 management efficiencies with the two scale optimization in this study runoff duration curves of different rainfall events under current and optimal schemes were comparatively analyzed fig 7 indicates that differences in runoff flow occurred at cumulative probability of 60 in moderate and light rain while cumulative probability of 80 in heavy rain commonly the lids face limited infiltration and retention capacities restraining the rapid capture of a large amount of runoff during high intensity storms hou et al 2020 yang et al 2022 showing better performance for light events liu et al 2017 therefore less significant differences were shown in the heavy rainfall events for runoff flow reduction however as for peak flow reduction it increased by 20 70 in heavy rain by optimal scheme compared with current scenario while only an estimated 10 higher reduction in other rainfall events but studies elucidated that runoff volume was more sensitive to changes in rainfall intensity than peak flow with a 32 and 19 reduction drop respectively when facing 1 to 100 year rainfall events sohn et al 2019 consequently effective configuration of source sink landscapes could maximize the ability of sink landscapes which performed more substantially through peak flow reduction the incorporation of landscape configuration for lids optimization is expected to meet the challenge of lids performance under extreme climate conditions the optimal scheme for pollution reduction varied in rainfall events and pollutants more significant reduction was achieved by optimal scheme in moderate and light events with a difference in cumulative probability of 20 it is probably due to the fact that the strong rainfall enhanced the first flush effect and thus washed off a high proportion of the diffusive pollutants bach et al 2010 which led to higher pressure for lids to intercept pollutants therefore the optimal scheme worked better for pollution reduction under moderate and light rainfall conditions for different pollutants tp pollution showed week differences at all rainfall events while nh3 n cod and ss showed similar variations in light rain however varied greatly in heavy rain the p mainly comes from agricultural activities and lower nps phosphorus pollution in urban catchments zhang et al 2021a which reduced the difference of tp pollution management under different rainfall events generally cod and ss had similarities during the duration curves which in line with the perspectives from müller et al 2020 differences occurred at cumulative probability of 60 80 for cod and ss however at cumulative probability of 80 for nh3 n besides fig 7 indicates that peak concentration reduction of cod and ss was more than twice that of nh3 n this could be affected by pollutant properties for example ss as a particulate pollutant is easily intercepted by vegetation after being washed into runoff so its concentration could be affected greatly by sink landscapes hu et al 2020 müller et al 2020 consequently it can be concluded that the improvement of cod and ss pollution reduction by the optimal scheme performed in their peak concentration reduction while nh3 n concentration reduction mainly occurred in initial scouring management the optimal scheme can further improve the stormwater management capacity especially the peak flow reduction under heavy rain conditions the understanding of lids on runoff pollution management mechanism could provide significant insight for lids design and implementation 4 2 thresholds for lid based landscape configuration spatial optimization at catchment scale provided opportunities to site lids in the suitable places zhang and chui 2020 lopes and da silva 2021 while landscape configuration optimization at site scale further defined detailed implementation objectives the design with an appropriate balance between the contributing area and the lids area is one of the most parameters to be optimized khadka et al 2021 to fill this research gap the present study integrated lids optimization and landscape configuration using swmm nsga ii and gis techniques to achieve optimal lids based landscape configuration the method and results could be applied in other regions due to the global issue of rapid urbanization and stormwater management gogate et al 2017 zhang et al 2021a the proposed crss is a new lids based landscape metric for effective stormwater management specifically the quantified crss thresholds suggested the construction scale of lids referring to source landscape where runoff is generated this is a landscape configuration result at site scale quantifying the maximum capacity of lids and demonstrating their adaptability for stormwater management spatial optimization determines the location of lids while crss further quantifies the configurations ratio of lids to source landscapes therefore the two scale optimization makes lids planning more reliable and scientific the results of crss thresholds can be used directly in other regions when the location of lids has been determined there are some advantages of this new landscape metric on the one hand it is a more detailed objective for lids design at site implementation scale compared with the indicators in previous studies e g lids coverage in a sub catchment or whole study area on the other hand it is easily calculated according to the given crss values if obtaining the area of source landscapes moreover roads and roofs are two main source landscapes of stormwater runoff in urban context yao et al 2016 dai et al 2020 however show distinct principles for runoff pollution generation ma et al 2018 and the interactions with lids gavrić et al 2019 mehmood et al 2021 this study quantified various crss values toward different source landscapes roads and roofs as well as different runoff indicators runoff volume nh3 n tp ss and cod the results can be used in various scenarios for different places the crss linked lids optimization and landscape configuration benefiting lids planning and implementation more precisely 5 conclusion this study optimized lids based landscape configuration through an integrated framework by linking lids and landscape configuration for optimizing source and sink patches the swmm nsga ii gis techniques and a new crss landscape metric were integrated from the quantity and quality related perspectives based on the results the runoff output was spatially heterogeneous with higher runoff quantify and pollution in high density residential areas besides it also varied in pollutants the spatial layout of sink landscapes at catchment scale was related to the distance from the pipe network outlet and the spatial characteristics of runoff output two common source landscape types roads and roofs were studied for landscape configurations optimization at site scale indicating the crss thresholds of 0 57 0 69 for the most effective runoff quantity and quality management however the crss thresholds varied in both runoff indicators and source landscape types with higher thresholds for nh3 n and ss pollution and for source landscapes of roofs the two scale optimization showed the improvement of peak flow reduction in heavy rain peak concentration reduction of cod and ss and initial scouring reduction of nh3 n however some limitations existed in this study different types of lids were not involved which were generalized as a sink landscape for runoff management due to the large scale of the study area different types of lids possess different capacities for stormwater management the crss values quantified in this study may be overestimated or underestimated for a specific lid practice more research work is needed in the future to determine the crss value for each lid measure credit authorship contribution statement xiaoyue zhang conceptualization funding acquisition investigation methodology writing original draft lei chen conceptualization funding acquisition supervision writing review editing chenxi guo writing review editing haifeng jia conceptualization writing review editing zhenyao shen funding acquisition supervision writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was funded by the fund for the innovative research group of the national natural science foundation of china grant no 52221003 the national high tech research and development program of china grant no 51779010 and project funded by china postdoctoral science foundation grant no 2022m711799 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129332 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2074,reinforcement learning rl has been used in real time control of urban drainage system uds for flooding mitigation achieving a milestone in urban water management however rl can only guarantee an optimization control rather than keep the control trajectory safe and trustworthy therefore unacceptable risk still exists when handing over the real world control process to an rl agent although safe learning is effective in enhancing rl s safety it cannot be applied directly due to the lack of quantitative framework of rl s safety in uds context this study conducts three tasks to investigate and improve the safety of rl in uds first a metric framework of rls safety in the context of uds is provided through a mathematic description then it is plugged into safe learning methods to improve rls safety in uds after that a systemic uncertainty analysis is employed to evaluate the robustness of rl the results of the case study indicate that i all the rls show a promising result in flooding mitigation ii safe learning helps rls achieve a safer control process with a lower average water level and lower frequency of orifices operation iii the robustness of rls in uds is influenced by the volume of rainfalls the degree of randomness and the type of rls keywords flooding mitigation reinforcement learning safe learning urban drainage system uncertainty analysis data availability data will be made available on request 1 introduction urban drainage system uds is important in modern cities however many of them are beyond their limit under the influence of urbanization and global climate change and causing flooding during drainage process xu and liao 2013 butler et al 2014 zhi et al 2020 xie et al 2017 liao et al 2019 traditional solutions such as pipeline expanding yazdi 2018 and low impact development batalini de macedo et al 2021 chan et al 2018 might be financially and practically unfeasible in many places lund et al 2020 meanwhile many researches have turned to the solutions in the context of urban water management eggimann et al 2017 one of them is real time control rtc which uses system observations numerical modelling and control strategies in coordination for flooding mitigation schütze et al 2004 garcía et al 2015 kerkez et al 2016 recently a state of the art artificial intelligence training method called deep reinforcement learning rl sutton barto 2018 was also used to establish rtc systems of uds mullapudi and kerkez 2018 mullapudi et al 2020 saliba et al 2020 bowes et al 2021 tian et al 2022a tian et al 2022b it uses experimental trials of simulations and relatively simple feedback reward to train an agent to control uds in real time under different situations for flooding mitigation however rl agents are black box neural networks their training process can only guarantee an optimization controlling sutton barto 2018 rather than keep the control trajectory stay in a user defined safe zone causing an unacceptable risk when handing over the real world uds control process to an rl agent clearly few would argue with the view that rls without safety is not worthy to explore its feasibility in real world condition therefore the safety of rls in uds is necessarily needed to push forward its development and application to solve this challenge the safe reinforcement learning or safe learning an advance version of rl provides an effective solution it can be abstracted as to ensure reasonable system performance with respect to given safety constraints during the learning and or deployment processes by minimizing the variance of the total expected reward reducing the temporal differences and avoiding the error state garcia and fernandez 2015 in this way the safety related constraints can be added into training process to teach rl agent behave safely however safe learning cannot be used in uds directly the main reason is the lack of the relevant quantity definition of safety constraints in the context of uds therefore how to specify the safe zone of rl with respect to urban water management is a prerequisite for the application of safe learning this study conducts three tasks to provide a primary but important exploration of the rl safety in uds context i develop a metric framework of rls safety in uds through a mathematic description to provide quantity definition of safe constraints ii plug it into two safe learning methods to improve rls safety in the context of uds iii evaluate the robustness of rl through a systemic uncertainty analysis the remainder of this paper is organized as follows in section 2 the case study and the details of our method are provided including the mathematic description two safe learning methods and uncertainty analysis the results of the case study and their corresponding discussions are given in section 3 and 4 the conclusions are summarized in section 5 fig 1 2 material and methodology this section provides our case study and method the case and the configuration of rls are provided in section 2 1 and 2 2 the mathematic description is given in section 2 3 as a quantitative model of rl s safety the two safe learning methods reward constrained policy optimization rcpo and human intervention reinforcement learning hirl are introduced and implemented in section 2 4 finally the uncertainty analysis is applied to investigate the robustness of rls in section 2 5 the specific flow chart is shown in fig 2 a table summarizing the acronyms and notations are provided in table 1 2 1 case study and rainfall data an open source stormwater management model swmm called astlingen sun et al 2020 is used as the case in this study it topology is shown in fig 3 there are six storage tanks t1 t6 and six orifices v1 v6 in this system more detail of this model can be found in open source data https github com open toolbox swmm astlingen in this study we use rls to control these 6 orifices in real time with 10 min interval to reduce flooding during rainfall events the rainfalls events used for training and testing also come from the rainfall data of the open source astlingen swmm https github com open toolbox swmm astlingen which were recorded in 5 minute interval from 2000 to 2009 sun et al 2020 all the data are divided into individual daily dataset each daily rainfall has 4 time series data came from 4 rain gages rg1 rg4 in the study area we randomly select 162 of them with daily volume larger than 20 mm and use 152 of them as training data of rl the rest 10 of them fig 4 are used as test data to validate the trained rls 2 2 2 2 reinforcement learning in uds context 2 2 1 brief review of rls the rl model involves the agent making decisions within the given environment sutton barto 2018 the environment is the system controlled by agent and can be swmm in the context of uds in a control loop fig 5 the agent provides the control action of next time interval with respect to current state of environment then the environment takes the action and evaluates the effect of one time interval controlling through a reward the states s t actions a t rewards r t data during control loops are collected and used to upgrade the rl agent through a given rl training algorithm to maximize the expected total rewards value function eq 1 or q value eq 2 1 v s t e k 0 γ k r t k 1 s t 2 q a t s t e k 0 γ k r t k 1 a t s t the discount factor γ is a hyperparameter between 0 and 1 used to guarantee the convergence of the functions and govern the temporal context of the reward k is the forward step which represents how many steps should the agent consider some researches separate the training from testing chen et al 2015 thus the rls at initial status will not be used for real world controlling usually rl training algorithms can be classified as value based mnih et al 2015 hasselt 2010 and policy based schulman et al 2015 schulman et al 2017 mnih et al 2016 the former is better in terms of the optimality of the control process while the latter have better performance in the continuous policy space mnih et al 2016 sutton barto 2018 2 2 2 configuration of two traditional rls two rl algorithms deep q neural network learning mnih et al 2015 mullapudi et al 2020 and proximal policy optimization schulman et al 2017 are used to train two agents named dqn and ppo after their training algorithm to control the uds for flooding mitigation in this study their agents are trained to control the six orifices of astlingen swmm with respect to selected states including water level of six tanks total flooding current rain intensity and flow of outfall dqn outputs the estimated q value and uses it to select the action with the highest q value while ppo outputs the action which is more likely to obtain the highest q value directly their rewards are designed based on flooding volume eq 3 the control interval δt is 10 min in this case their detailed configurations are provided as follow 3 r t f l o o d i n g v o l u m e i f f l o o d i n g i n t δ t t 0 1 e l s e 1 dqn dqn is a famous member of value based rl training algorithm it uses deep neural network to approximate q value function through sampled data mnih et al 2015 sutton barto 2018 the deep neural network of dqn in this study has an architecture of four layers n 20 20 a in which n is the dimension of state vector a is the dimension of action space or the number of orifices selectable action values the linear function eq 5 w t and b are trainable parameters is used as the activation function in the last layer the relu function eq 4 serves as the activation function in other layers the discount factor is 0 9 the training algorithm is adam algorithm lecun et al 2015 with 200 iteration step and 0 001 learning rate 4 r e l u x 0 x 0 x x 0 5 l i n e a r x w t x b 2 ppo proximal policy optimization model belongs to policy based models schulman et al 2015 schulman et al 2017 which uses a deep neural network π θ a t s t with parameter θ input state s t output action a t to approximate the policy function it is trained by computing an estimator of the policy gradient eq 6 the q is q value through sampled state reward action data and plugging it into a gradient ascent algorithm schulman et al 2017 6 g e t θ l o g π θ a t s t q the deep neural network of ppo in this study has an architecture of four layers n 100 100 m in which n and m are the dimension of state and the action vector the linear function eq 5 w t and b are trainable parameters is used as the activation function in the last layer the relu function eq 4 serves as the activation function in other layers the discount factor is 0 9 training algorithm is adam algorithm lecun et al 2015 with 200 iteration step and 0 001 learning rate 2 2 3 mathematic description of rls safety in the context of uds before we improve the safety of drl through safe learning we need to quantitatively clarify what a safe rl should be like in the context of uds to provide a metric framework for safe learning usually we expect the trained rl agents to achieve a given objective under some constrains for instance some special location e g town centre schools hospitals and transport stations should have zero tolerance for flooding birgani and yazdandoost 2016 also the operation frequency of pumps and orifices should be low to save energy these mean that the state s t and action a t should stay in a given range or a safety constrain as much time as possible to ensure that its control process is reasonably effective the selection of the ranges or safety constrains can be various when facing different situations and objectives therefore a mathematic description of different safety constrains is provided as follow to measure different safety constrains mathematic description in facing different situations of uds a safe rl should achieve a given objective while satisfying certain safety constraints of uds as much time as possible this can be mathematically described through eq 7 where safe is a user defined safe zone t is the simulation duration safety i are the mathematically representation of ith safety constraints with respect to a threshold value uppe r i e g maximum water level of nodes or maximum frequency of pumps operation and there are l of them respectively 7 s t a t s a f e i 1 l safe i i 1 l s t a t safety i s t a t u p p e r i t 1 t although the mathematic description provides a mathematical framework of safety the selection of its safety constraints still has various formula this study considers three objectives to give safety constraints low flooding low water level of some selected nodes and low frequency of orifices operating because the reward eq 3 of rls is designed for flooding mitigation the first safety constraint is already considered some area in urban system may be more vulnerable to flooding such as town centre schools hospitals and transport stations therefore the water level of the nodes located around such area should stay low during drainage in this study the storage tank t1 t6 in the case should stay in a low water level to reduce the risk which gives our first safety constraints eq 8 where max d e p t h is the maximum depth t1 t6 tank and is 4 5 m e t h node is average water level over time of a given node safe 1 s t e e t h node 0 9 m a x d e p t h 8 node t 1 t 2 t 6 a low operation frequency has certain contribution to save energy and prolong the life time of orifices thus the operation frequency of six orifices is generally required to be kept within a certain range following with the safety constraints eq 9 where a i j is the operation variable of the i th orifices one of v1 v6 at time point j t is current time point minute the e f r e a t 6 t 60 means that the average operation frequency before current time should less than 6 times per hour 9 safe 2 a t t e f r e a t 6 t 60 a t a i j j 1 t i 1 2 n 2 3 improve the safety of rls in the context of uds through safe learning based on the mathematic description two safe learning methods reward constrained policy optimization rcpo and human intervention reinforcement learning hirl are combined to improve the safety of dqn and ppo 2 3 1 reward constrained policy optimization rcpo the reward constrained policy optimization rcpo modifies the optimality criterion the value function to make rls consider safety constraints during training process pushing the rls agent to upgrade itself in the direction of user defined safe zone tessler et al 2019 dalal et al 2018 di castro et al 2012 garcia and fernandez 2015 the key point of rcpo is the use of the discounted penalty which is a measure of risk and can be used to replace original reward and value function through eqs 10 and 11 the v π λ s is the new value function λ is penalized value the c s a is the constrained condition which can be given through safety constraints based on mathematic description 10 r λ s a r s a λ c s a 11 v π λ s e t 0 t γ t r λ s t a t s 0 s e t 0 t γ t r s t a t s 0 s e t 0 t γ t λ c s t a t s 0 s two safety constraints given in eqs 8 and 9 are used to obtain the constraint functions eqs 12 and 13 and then plugged into the rcpo through a new reward eq 14 and a value function eq 15 the λ 1 and λ 2 are penalized value of each safety constraint this new reward and its corresponded value function are used to replace the original ones during training process 12 c 1 s t e e t h node 0 9 m a x d e p t h 13 c 2 a t e f r e a t n 14 r λ 1 λ 2 s t a t r s t a t λ 1 c 1 s t λ 2 c 2 a t t 15 v π λ s e t 0 t γ t r λ s t a t s 0 s e t 0 t γ t r s t a t s 0 s e t 0 t γ t i 1 2 λ i c i s 0 s 2 3 2 human intervention on the output different from rcpo hirl forces the agent to avoid risky action during training and exploration process garcia and fernandez 2015 saunders et al 2017 previous rl research claimed that an rl agent is safe if it never takes catastrophic actions or the actions that the human overseer deems unacceptable saunders et al 2017 accordingly hirl filters dangerous memory from sampled data through human designed supervisor to avoid formalized concept of catastrophes saunders et al 2017 specifically experience gathered from human or previous information is used to provide initial knowledge during the training process through an imitator to block intercept unsafe actions and replace them with safe one fig 6 for this case study efd in previous research sun et al 2020 already provided an excellent control strategy therefore its actions can be used as the reference of the imitator to find the selectable action values a max and a min of dqn and ppo through eq 16 the selectable action values are given in table 2 16 a t a max i f a t a min a max a min 2 a min i f a t a min a max a min 2 t 1 t another advantage of hirl in this study is shrinkage of the action space dimension saunders et al 2017 the original rls have a huge action space for instance if each orifice has 10 selectable action values and there are 6 of them the dimension of their action space a will be 106 this means that a very large number of sampled data are required for effective training through the step of hirl the dimension of action space of dqn and ppo can be shrunken because of the limitation of selectable actions for this case if we apply hirl their action space will reduce to 16 1 1 2 4 the only thing the agents need to change is their neural network architecture dqn s neural network is changed as 4 20 20 16 while ppo only need to add a new output layer with hard sigmoid function eq 17 17 h a r d s i g m o i d x y y j a max i f y j a min a max a min 2 a min i f y j a min a max a min 2 j 1 2 3 4 5 6 2 4 uncertainty analysis trained rl agent can be treated as an input output system which provides action with respect to different state fig 7 many factors will trigger uncertainty and influence its controlling effect through this input output structure therefore their influence can be boiled down to corresponding changes in state saliba et al 2020 and action or specifically p s t and p a t the analysis of the rl agent s robustness requires finding the source of uncertainties and observing how well the agent reacts to them with respect to different ranges of variation based on input output structure the source of uncertainties in the context of uds come from three aspects different types of rainfall events imperfect input and noisy output all of them are analyzed in this study 2 4 1 uncertainty of various rainfalls different real rainfalls of the study area are used in multiple simulations to investigate the uncertainty caused by rainfall diversity the test rainfalls are the 162 real rainfalls with daily volume larger than 20 mm we analyze the uncertainty of rainfalls by obtaining the range of upper and lower values of the control effect under each of these rainfalls meanwhile flooding volume may be unobjective when used as the measurement of uncertainty analysis as it is strongly influenced by rainfall volume van daal et al 2017 lund et al 2018 lund et al 2020 to avoid this the control effects of all the rls are measured by the ratio of the total flooding to the total inflow called rfi eq 18 18 rfi total f l o o d i n g total i n f l o w compared with flooding volume rfi reduces the fluctuations caused by rainfall volume a system with good control effect should have an rfi close to zero no matter what kind of rainfall therefore it reflects the drainage capacity of rls more objectively 2 4 2 uncertainty of imperfect input and noisy output previous research showed that forward uncertainty analysis with monte carlo simulations can be used to investigate the uncertainty of imperfect input van daal et al 2017 saliba et al 2020 and they found that rl has a certain robustness saliba et al 2020 but they only test on uniform distribution with one set of parameters which can be described through eq 19 19 s t x s t x u 0 95 1 05 u 1 0 05 1 0 05 to specifically and objectively evaluate rls robustness uncertainty analysis on both imperfect input and noisy action with respect to different random variable are provided and analyzed through eqs 20 to 21 where δ is amplification factor af used to describe the upper and lower bound of random variable mean is the mean value of random variable 20 s t x s t x u m e a n δ m e a n δ 21 a t x a t x u m e a n δ m e a n δ the δ and mean represent the level of random which influence the system dynamic their selection can be various but has certainty limitation small values lead to a low influence of random variable and the results of uncertainty analysis may not provide useful information e g eq 19 however large values lead to a wide range of randomness and lead to meaninglessness in s t and a t e g too large water level considering the maximum depth of node in this case 5 m the mean is 2 and the δ is 0 5 1 0 1 5 and 2 0 in this study through these steps the uncertainty can be analyzed by taking different δ in rl control simulation to obtain the range of upper and lower values of the control effect more precisely given a rainfall we use trained rls to control swmm in real time with respect to imperfect input or noisy action or both of them and obtain several trajectories of the simulations to observe the maximum and minimum total flooding 3 results four rls are trained and used to control astlingen swmm under 10 real rainfalls for flooding mitigation they are named after their training algorithm and their configurations are list in table 3 all the system is established through python 3 7 pyswmm 0 6 0 mcdonnell et al 2020 and tensorflow 1 14 0 abadi et al 2016 to improve the training efficiency the hirl is used for all the rl agents to reduce the dimension of their action space for comparison do nothing bc and efd are also used in this case do nothing is a baseline method which turns on all the orifices without any control during rainfalls bc is a local control strategy which uses constant nominal throttle flow settings to control the emptying of each storage tanks for flooding mitigation its parameters were estimated using a trial and error procedure until deviation between swmm and output was below 10 sun et al 2020 efd is a global rule based control strategy which compares the filling degree of the storage tanks 2 3 4 and 6 in the network and sets the throttle flows accordingly for an equal filling degree in all the tanks sun et al 2020 their detailed setting can be found in the open source data https github com open toolbox swmm astlingen 3 1 effectiveness of safe learning 3 1 1 control effect of rls and safe rls the total flooding volume in different rainfalls are given in table 4 the control trajectories are provided in fig 8 accordingly all the rls have better performance than do nothing indicating certain effectiveness in flooding mitigation because efd is optimized on all these rainfalls its performance is better than rls the control effect of safe dqn safe ppo are close to dqn ppo which means that the safe learning will not significantly affect the control effect 3 1 2 safety constrains the average water level of t1 t6 in rain1 10 e h t n o d e are given in table 5 the water level of do nothing is the lowest this is consistent with the fact that it turns on all the orifices without any control all the safe rls have lower water level than traditional rls which shows the effectiveness of safe learning the average operation number e f r e a t of orifices during rain1 10 are provided in table 6 it shows that safe rls have lower operation number than traditional rls to further show the control effect of low frequency operation the flow of v3 is provided in figs 9 and 10 which shows that safe rls have relative stable flow the flows of other orifices are given in appendix 3 2 uncertainty analysis 3 2 1 uncertainty of various rainfalls the methods of section 2 5 1 are used to analyse the uncertainty of rls under 162 different real rainfalls the rfi are provided in table 7 the rfi range width 95 5 of all the rls are similar to each other which indicates that the safe learning maintains the performance for all the rls also rls have stable control effect than do nothing and efd as they achieve narrower rfi range width to further demonstrate the relation between rfi and rainfall volume we provide the rfi and the daily volume of 162 rainfalls in fig 11 which shows that the shapes of rls figure are thinner than bc and efd and also indicates a stable control effect meanwhile fig 11 shows that the daily volume of rainfall influences the performance of rls more discussions are given in section 4 2 3 2 2 uncertainty of input and output the method in section 2 5 2 is used to analyse the uncertainty of rls with respect to different amplification factor δ the values of δ are 0 5 1 0 1 5 and 2 0 respectively the range of their total flooding are given in figs 12 17 accordingly the amplification factor δ influence the performance of rls also the impact of input and output on the control effect have different pattern more discussions are given in section 4 2 4 discussion 4 1 the changing of value function based on the penalized reward according to the results in section 3 1 safe rls achieve similar control effect with lower average water level and operation frequency the reason can be explained through the change of value function based on the penalized reward traditional rls are intended to find the conditional probability p a t s t to obtain higher q value when safe learning applied their training process focus on both control objective and safety thus lead to a different value function eq 22 where safe in eq 7 is the safe zone provided through mathematic description 22 v s t a t s t s a s a f e p a t s t r s t a t i 1 2 λ i c i γ v s t 1 after training based on eq 22 a different conditional probability p a t s t s a f e will be obtained and is able to consider both safety and control effect thus safe learning is a natural method to improve rls safety 4 2 the factors influence rls robustness previous research claimed that rl has a certain level of stability when facing slight perturbation in training and testing process in this study we show that this conclusion is not fully correct according to the results in section 3 2 1 rls performance are various when facing different rainfalls which indicates that its control effect is strongly influenced by the volume of rainfalls this can be detailed demonstrate through fig 11 in which the rfi increases with the volume of rainfall the reason that rfi converge at 0 7 is mainly because the drainage system is full and there is no space for adjusting and controlling lund et al 2020 the influence of imperfect input and noisy output have very different patterns this can be explained through two metrics flooding mean value and the flooding range width in figs 12 17 for dqns the flooding mean value is decreased with the af of input and is increased with the af of output for ppos the flooding mean value of safe ppo is larger than it of ppo when facing imperfect input while the situation is opposite when facing noisy output also safe rls are more likely to have a smaller flooding range width than original rls which means that the safe rls are more likely to meet the safety constrains given by mathematic description although an explicit explanation of this phenomenon is hard to be provided it is far enough to be used to confirm that the rls robustness is influenced by these factors 4 3 the adaptability of efd the results of section 3 1 1 and the rfi in section 3 2 1 show that the control effect of rls is only close to but do not exceed efd during these rainfalls the reason is that the efd is an optimized control method on all these rainfalls therefore the performance of efd will decrease when facing brand new rainfall events that it has not learned to demonstrate this all methods are tested in three extra 4 hour rainfall events fig 18 in which dqn and safe dqn achieve better performance than efd table 8 fig 19 this results further indicate the advantage of rls in the adaptability to different rainfalls 4 4 future works 4 4 1 the use of prior information in the above case the rcpo only improves the probability of selecting safe action rather than forces rl agents to stay in the safe zone all the time this is solved in the above case through the combination of hirl and prior information of the study area also we use prior information of the study area to drastically reduce the dimension of dqn ppo s action space the idea of using prior knowledge to help training is not new lu and zong 2019 but how to use it appropriately and efficiently in the field of uds is still unknown 4 4 2 the selection of safety constraints for different udss the selection of safety constraints can be various as long as they can be mathematically represented by the mathematic description therefore the above method is a highly adaptive and problem dependent how to select suitable safety constraints for different udss with respect to a stable control process richards et al 2018 is still an unsolved puzzle also the mathematic description is based on the premise that the hardware and structure of rl control systems is operated normally without damage the safety problem caused by structure failure cannot easily solved through safe learning framework and is not be considered in this paper usually increasing of system redundancy ahern 2011 is a common method to solve this problem more study is still need in this direction 4 4 3 the formula of mathematic description the specifical formula of the mathematic description can be various and flexible if we consider statistic model then a safe rl should satisfy a different mathematic description given by conditional probability eq 23 23 s t a t p s t a t s a f e i 1 m p s t a t safety i s t a t u p p e r i satisfying eq 23 requires the control process to converge gradually along time or force the control trajectory stay in a region of attraction roa these contents are directly related to resilience of uds wang et al 2021 butler et al 2014 casal campos et al 2018 control lyapunov function s stability clf richards et al 2018 and control barrier function cbf ames et al 2019 and will be present in our future study 5 conclusions to remedy the lack of rl safety in the context of uds three main tasks are completed in this study i a metric of rls safety is investigated through a mathematic description for the application of uds ii two safe learning methods are employed to improve rl safety in uds iii uncertainty analysis is used to validate rls robustness with respect to different conditions all these methods are validated through an open source swmm model called astlingen the main conclusions are summarized as follows i all the rls have a certain effect in flooding mitigation ii safe rls achieve a similar control effect with a safer control process iii the robustness of rls in the context of uds is influenced by the rainfall events the degree of randomness and the type of rls the safety of rl in the context of uds is still worth exploration for instance the mathematic description provided in this study is highly adaptive flexible and problem dependent how to select suitable safety constraints for different udss with respect to a stable control process is still unknown also its relationship with resilience of uds control lyapunov stability and control barrier function still need more research meanwhile how to use prior engineering knowledge appropriately and efficiently to improve the rl in uds is an interesting topic to be discussed credit authorship contribution statement wenchong tian conceptualization methodology software validation writing original draft writing review editing visualization kunlun xin project administration supervision funding acquisition conceptualization validation writing original draft writing review editing zhiyu zhang software validation writing original draft muhan zhao conceptualization methodology software writing original draft zhenliang liao funding acquisition validation writing original draft tao tao funding acquisition validation writing original draft writing review editing declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests kunlun xin reports financial support was provided by national natural science foundation of china zhenliang liao reports financial support was provided by national natural science foundation of china tao tao reports financial support was provided by national natural science foundation of china acknowledgements this study was financially supported by the national natural science foundation of china grant no 51978493 grant no 51778452 grant no 52170102 the details of the swmm model and the data of real rainfall event in the case is available in these references sun et al 2020 all the code can be found on github https github com dantezio safe rl in uds appendix a a the flow results of v1 v2 v4 v5 v6 figs a1 a10 
2074,reinforcement learning rl has been used in real time control of urban drainage system uds for flooding mitigation achieving a milestone in urban water management however rl can only guarantee an optimization control rather than keep the control trajectory safe and trustworthy therefore unacceptable risk still exists when handing over the real world control process to an rl agent although safe learning is effective in enhancing rl s safety it cannot be applied directly due to the lack of quantitative framework of rl s safety in uds context this study conducts three tasks to investigate and improve the safety of rl in uds first a metric framework of rls safety in the context of uds is provided through a mathematic description then it is plugged into safe learning methods to improve rls safety in uds after that a systemic uncertainty analysis is employed to evaluate the robustness of rl the results of the case study indicate that i all the rls show a promising result in flooding mitigation ii safe learning helps rls achieve a safer control process with a lower average water level and lower frequency of orifices operation iii the robustness of rls in uds is influenced by the volume of rainfalls the degree of randomness and the type of rls keywords flooding mitigation reinforcement learning safe learning urban drainage system uncertainty analysis data availability data will be made available on request 1 introduction urban drainage system uds is important in modern cities however many of them are beyond their limit under the influence of urbanization and global climate change and causing flooding during drainage process xu and liao 2013 butler et al 2014 zhi et al 2020 xie et al 2017 liao et al 2019 traditional solutions such as pipeline expanding yazdi 2018 and low impact development batalini de macedo et al 2021 chan et al 2018 might be financially and practically unfeasible in many places lund et al 2020 meanwhile many researches have turned to the solutions in the context of urban water management eggimann et al 2017 one of them is real time control rtc which uses system observations numerical modelling and control strategies in coordination for flooding mitigation schütze et al 2004 garcía et al 2015 kerkez et al 2016 recently a state of the art artificial intelligence training method called deep reinforcement learning rl sutton barto 2018 was also used to establish rtc systems of uds mullapudi and kerkez 2018 mullapudi et al 2020 saliba et al 2020 bowes et al 2021 tian et al 2022a tian et al 2022b it uses experimental trials of simulations and relatively simple feedback reward to train an agent to control uds in real time under different situations for flooding mitigation however rl agents are black box neural networks their training process can only guarantee an optimization controlling sutton barto 2018 rather than keep the control trajectory stay in a user defined safe zone causing an unacceptable risk when handing over the real world uds control process to an rl agent clearly few would argue with the view that rls without safety is not worthy to explore its feasibility in real world condition therefore the safety of rls in uds is necessarily needed to push forward its development and application to solve this challenge the safe reinforcement learning or safe learning an advance version of rl provides an effective solution it can be abstracted as to ensure reasonable system performance with respect to given safety constraints during the learning and or deployment processes by minimizing the variance of the total expected reward reducing the temporal differences and avoiding the error state garcia and fernandez 2015 in this way the safety related constraints can be added into training process to teach rl agent behave safely however safe learning cannot be used in uds directly the main reason is the lack of the relevant quantity definition of safety constraints in the context of uds therefore how to specify the safe zone of rl with respect to urban water management is a prerequisite for the application of safe learning this study conducts three tasks to provide a primary but important exploration of the rl safety in uds context i develop a metric framework of rls safety in uds through a mathematic description to provide quantity definition of safe constraints ii plug it into two safe learning methods to improve rls safety in the context of uds iii evaluate the robustness of rl through a systemic uncertainty analysis the remainder of this paper is organized as follows in section 2 the case study and the details of our method are provided including the mathematic description two safe learning methods and uncertainty analysis the results of the case study and their corresponding discussions are given in section 3 and 4 the conclusions are summarized in section 5 fig 1 2 material and methodology this section provides our case study and method the case and the configuration of rls are provided in section 2 1 and 2 2 the mathematic description is given in section 2 3 as a quantitative model of rl s safety the two safe learning methods reward constrained policy optimization rcpo and human intervention reinforcement learning hirl are introduced and implemented in section 2 4 finally the uncertainty analysis is applied to investigate the robustness of rls in section 2 5 the specific flow chart is shown in fig 2 a table summarizing the acronyms and notations are provided in table 1 2 1 case study and rainfall data an open source stormwater management model swmm called astlingen sun et al 2020 is used as the case in this study it topology is shown in fig 3 there are six storage tanks t1 t6 and six orifices v1 v6 in this system more detail of this model can be found in open source data https github com open toolbox swmm astlingen in this study we use rls to control these 6 orifices in real time with 10 min interval to reduce flooding during rainfall events the rainfalls events used for training and testing also come from the rainfall data of the open source astlingen swmm https github com open toolbox swmm astlingen which were recorded in 5 minute interval from 2000 to 2009 sun et al 2020 all the data are divided into individual daily dataset each daily rainfall has 4 time series data came from 4 rain gages rg1 rg4 in the study area we randomly select 162 of them with daily volume larger than 20 mm and use 152 of them as training data of rl the rest 10 of them fig 4 are used as test data to validate the trained rls 2 2 2 2 reinforcement learning in uds context 2 2 1 brief review of rls the rl model involves the agent making decisions within the given environment sutton barto 2018 the environment is the system controlled by agent and can be swmm in the context of uds in a control loop fig 5 the agent provides the control action of next time interval with respect to current state of environment then the environment takes the action and evaluates the effect of one time interval controlling through a reward the states s t actions a t rewards r t data during control loops are collected and used to upgrade the rl agent through a given rl training algorithm to maximize the expected total rewards value function eq 1 or q value eq 2 1 v s t e k 0 γ k r t k 1 s t 2 q a t s t e k 0 γ k r t k 1 a t s t the discount factor γ is a hyperparameter between 0 and 1 used to guarantee the convergence of the functions and govern the temporal context of the reward k is the forward step which represents how many steps should the agent consider some researches separate the training from testing chen et al 2015 thus the rls at initial status will not be used for real world controlling usually rl training algorithms can be classified as value based mnih et al 2015 hasselt 2010 and policy based schulman et al 2015 schulman et al 2017 mnih et al 2016 the former is better in terms of the optimality of the control process while the latter have better performance in the continuous policy space mnih et al 2016 sutton barto 2018 2 2 2 configuration of two traditional rls two rl algorithms deep q neural network learning mnih et al 2015 mullapudi et al 2020 and proximal policy optimization schulman et al 2017 are used to train two agents named dqn and ppo after their training algorithm to control the uds for flooding mitigation in this study their agents are trained to control the six orifices of astlingen swmm with respect to selected states including water level of six tanks total flooding current rain intensity and flow of outfall dqn outputs the estimated q value and uses it to select the action with the highest q value while ppo outputs the action which is more likely to obtain the highest q value directly their rewards are designed based on flooding volume eq 3 the control interval δt is 10 min in this case their detailed configurations are provided as follow 3 r t f l o o d i n g v o l u m e i f f l o o d i n g i n t δ t t 0 1 e l s e 1 dqn dqn is a famous member of value based rl training algorithm it uses deep neural network to approximate q value function through sampled data mnih et al 2015 sutton barto 2018 the deep neural network of dqn in this study has an architecture of four layers n 20 20 a in which n is the dimension of state vector a is the dimension of action space or the number of orifices selectable action values the linear function eq 5 w t and b are trainable parameters is used as the activation function in the last layer the relu function eq 4 serves as the activation function in other layers the discount factor is 0 9 the training algorithm is adam algorithm lecun et al 2015 with 200 iteration step and 0 001 learning rate 4 r e l u x 0 x 0 x x 0 5 l i n e a r x w t x b 2 ppo proximal policy optimization model belongs to policy based models schulman et al 2015 schulman et al 2017 which uses a deep neural network π θ a t s t with parameter θ input state s t output action a t to approximate the policy function it is trained by computing an estimator of the policy gradient eq 6 the q is q value through sampled state reward action data and plugging it into a gradient ascent algorithm schulman et al 2017 6 g e t θ l o g π θ a t s t q the deep neural network of ppo in this study has an architecture of four layers n 100 100 m in which n and m are the dimension of state and the action vector the linear function eq 5 w t and b are trainable parameters is used as the activation function in the last layer the relu function eq 4 serves as the activation function in other layers the discount factor is 0 9 training algorithm is adam algorithm lecun et al 2015 with 200 iteration step and 0 001 learning rate 2 2 3 mathematic description of rls safety in the context of uds before we improve the safety of drl through safe learning we need to quantitatively clarify what a safe rl should be like in the context of uds to provide a metric framework for safe learning usually we expect the trained rl agents to achieve a given objective under some constrains for instance some special location e g town centre schools hospitals and transport stations should have zero tolerance for flooding birgani and yazdandoost 2016 also the operation frequency of pumps and orifices should be low to save energy these mean that the state s t and action a t should stay in a given range or a safety constrain as much time as possible to ensure that its control process is reasonably effective the selection of the ranges or safety constrains can be various when facing different situations and objectives therefore a mathematic description of different safety constrains is provided as follow to measure different safety constrains mathematic description in facing different situations of uds a safe rl should achieve a given objective while satisfying certain safety constraints of uds as much time as possible this can be mathematically described through eq 7 where safe is a user defined safe zone t is the simulation duration safety i are the mathematically representation of ith safety constraints with respect to a threshold value uppe r i e g maximum water level of nodes or maximum frequency of pumps operation and there are l of them respectively 7 s t a t s a f e i 1 l safe i i 1 l s t a t safety i s t a t u p p e r i t 1 t although the mathematic description provides a mathematical framework of safety the selection of its safety constraints still has various formula this study considers three objectives to give safety constraints low flooding low water level of some selected nodes and low frequency of orifices operating because the reward eq 3 of rls is designed for flooding mitigation the first safety constraint is already considered some area in urban system may be more vulnerable to flooding such as town centre schools hospitals and transport stations therefore the water level of the nodes located around such area should stay low during drainage in this study the storage tank t1 t6 in the case should stay in a low water level to reduce the risk which gives our first safety constraints eq 8 where max d e p t h is the maximum depth t1 t6 tank and is 4 5 m e t h node is average water level over time of a given node safe 1 s t e e t h node 0 9 m a x d e p t h 8 node t 1 t 2 t 6 a low operation frequency has certain contribution to save energy and prolong the life time of orifices thus the operation frequency of six orifices is generally required to be kept within a certain range following with the safety constraints eq 9 where a i j is the operation variable of the i th orifices one of v1 v6 at time point j t is current time point minute the e f r e a t 6 t 60 means that the average operation frequency before current time should less than 6 times per hour 9 safe 2 a t t e f r e a t 6 t 60 a t a i j j 1 t i 1 2 n 2 3 improve the safety of rls in the context of uds through safe learning based on the mathematic description two safe learning methods reward constrained policy optimization rcpo and human intervention reinforcement learning hirl are combined to improve the safety of dqn and ppo 2 3 1 reward constrained policy optimization rcpo the reward constrained policy optimization rcpo modifies the optimality criterion the value function to make rls consider safety constraints during training process pushing the rls agent to upgrade itself in the direction of user defined safe zone tessler et al 2019 dalal et al 2018 di castro et al 2012 garcia and fernandez 2015 the key point of rcpo is the use of the discounted penalty which is a measure of risk and can be used to replace original reward and value function through eqs 10 and 11 the v π λ s is the new value function λ is penalized value the c s a is the constrained condition which can be given through safety constraints based on mathematic description 10 r λ s a r s a λ c s a 11 v π λ s e t 0 t γ t r λ s t a t s 0 s e t 0 t γ t r s t a t s 0 s e t 0 t γ t λ c s t a t s 0 s two safety constraints given in eqs 8 and 9 are used to obtain the constraint functions eqs 12 and 13 and then plugged into the rcpo through a new reward eq 14 and a value function eq 15 the λ 1 and λ 2 are penalized value of each safety constraint this new reward and its corresponded value function are used to replace the original ones during training process 12 c 1 s t e e t h node 0 9 m a x d e p t h 13 c 2 a t e f r e a t n 14 r λ 1 λ 2 s t a t r s t a t λ 1 c 1 s t λ 2 c 2 a t t 15 v π λ s e t 0 t γ t r λ s t a t s 0 s e t 0 t γ t r s t a t s 0 s e t 0 t γ t i 1 2 λ i c i s 0 s 2 3 2 human intervention on the output different from rcpo hirl forces the agent to avoid risky action during training and exploration process garcia and fernandez 2015 saunders et al 2017 previous rl research claimed that an rl agent is safe if it never takes catastrophic actions or the actions that the human overseer deems unacceptable saunders et al 2017 accordingly hirl filters dangerous memory from sampled data through human designed supervisor to avoid formalized concept of catastrophes saunders et al 2017 specifically experience gathered from human or previous information is used to provide initial knowledge during the training process through an imitator to block intercept unsafe actions and replace them with safe one fig 6 for this case study efd in previous research sun et al 2020 already provided an excellent control strategy therefore its actions can be used as the reference of the imitator to find the selectable action values a max and a min of dqn and ppo through eq 16 the selectable action values are given in table 2 16 a t a max i f a t a min a max a min 2 a min i f a t a min a max a min 2 t 1 t another advantage of hirl in this study is shrinkage of the action space dimension saunders et al 2017 the original rls have a huge action space for instance if each orifice has 10 selectable action values and there are 6 of them the dimension of their action space a will be 106 this means that a very large number of sampled data are required for effective training through the step of hirl the dimension of action space of dqn and ppo can be shrunken because of the limitation of selectable actions for this case if we apply hirl their action space will reduce to 16 1 1 2 4 the only thing the agents need to change is their neural network architecture dqn s neural network is changed as 4 20 20 16 while ppo only need to add a new output layer with hard sigmoid function eq 17 17 h a r d s i g m o i d x y y j a max i f y j a min a max a min 2 a min i f y j a min a max a min 2 j 1 2 3 4 5 6 2 4 uncertainty analysis trained rl agent can be treated as an input output system which provides action with respect to different state fig 7 many factors will trigger uncertainty and influence its controlling effect through this input output structure therefore their influence can be boiled down to corresponding changes in state saliba et al 2020 and action or specifically p s t and p a t the analysis of the rl agent s robustness requires finding the source of uncertainties and observing how well the agent reacts to them with respect to different ranges of variation based on input output structure the source of uncertainties in the context of uds come from three aspects different types of rainfall events imperfect input and noisy output all of them are analyzed in this study 2 4 1 uncertainty of various rainfalls different real rainfalls of the study area are used in multiple simulations to investigate the uncertainty caused by rainfall diversity the test rainfalls are the 162 real rainfalls with daily volume larger than 20 mm we analyze the uncertainty of rainfalls by obtaining the range of upper and lower values of the control effect under each of these rainfalls meanwhile flooding volume may be unobjective when used as the measurement of uncertainty analysis as it is strongly influenced by rainfall volume van daal et al 2017 lund et al 2018 lund et al 2020 to avoid this the control effects of all the rls are measured by the ratio of the total flooding to the total inflow called rfi eq 18 18 rfi total f l o o d i n g total i n f l o w compared with flooding volume rfi reduces the fluctuations caused by rainfall volume a system with good control effect should have an rfi close to zero no matter what kind of rainfall therefore it reflects the drainage capacity of rls more objectively 2 4 2 uncertainty of imperfect input and noisy output previous research showed that forward uncertainty analysis with monte carlo simulations can be used to investigate the uncertainty of imperfect input van daal et al 2017 saliba et al 2020 and they found that rl has a certain robustness saliba et al 2020 but they only test on uniform distribution with one set of parameters which can be described through eq 19 19 s t x s t x u 0 95 1 05 u 1 0 05 1 0 05 to specifically and objectively evaluate rls robustness uncertainty analysis on both imperfect input and noisy action with respect to different random variable are provided and analyzed through eqs 20 to 21 where δ is amplification factor af used to describe the upper and lower bound of random variable mean is the mean value of random variable 20 s t x s t x u m e a n δ m e a n δ 21 a t x a t x u m e a n δ m e a n δ the δ and mean represent the level of random which influence the system dynamic their selection can be various but has certainty limitation small values lead to a low influence of random variable and the results of uncertainty analysis may not provide useful information e g eq 19 however large values lead to a wide range of randomness and lead to meaninglessness in s t and a t e g too large water level considering the maximum depth of node in this case 5 m the mean is 2 and the δ is 0 5 1 0 1 5 and 2 0 in this study through these steps the uncertainty can be analyzed by taking different δ in rl control simulation to obtain the range of upper and lower values of the control effect more precisely given a rainfall we use trained rls to control swmm in real time with respect to imperfect input or noisy action or both of them and obtain several trajectories of the simulations to observe the maximum and minimum total flooding 3 results four rls are trained and used to control astlingen swmm under 10 real rainfalls for flooding mitigation they are named after their training algorithm and their configurations are list in table 3 all the system is established through python 3 7 pyswmm 0 6 0 mcdonnell et al 2020 and tensorflow 1 14 0 abadi et al 2016 to improve the training efficiency the hirl is used for all the rl agents to reduce the dimension of their action space for comparison do nothing bc and efd are also used in this case do nothing is a baseline method which turns on all the orifices without any control during rainfalls bc is a local control strategy which uses constant nominal throttle flow settings to control the emptying of each storage tanks for flooding mitigation its parameters were estimated using a trial and error procedure until deviation between swmm and output was below 10 sun et al 2020 efd is a global rule based control strategy which compares the filling degree of the storage tanks 2 3 4 and 6 in the network and sets the throttle flows accordingly for an equal filling degree in all the tanks sun et al 2020 their detailed setting can be found in the open source data https github com open toolbox swmm astlingen 3 1 effectiveness of safe learning 3 1 1 control effect of rls and safe rls the total flooding volume in different rainfalls are given in table 4 the control trajectories are provided in fig 8 accordingly all the rls have better performance than do nothing indicating certain effectiveness in flooding mitigation because efd is optimized on all these rainfalls its performance is better than rls the control effect of safe dqn safe ppo are close to dqn ppo which means that the safe learning will not significantly affect the control effect 3 1 2 safety constrains the average water level of t1 t6 in rain1 10 e h t n o d e are given in table 5 the water level of do nothing is the lowest this is consistent with the fact that it turns on all the orifices without any control all the safe rls have lower water level than traditional rls which shows the effectiveness of safe learning the average operation number e f r e a t of orifices during rain1 10 are provided in table 6 it shows that safe rls have lower operation number than traditional rls to further show the control effect of low frequency operation the flow of v3 is provided in figs 9 and 10 which shows that safe rls have relative stable flow the flows of other orifices are given in appendix 3 2 uncertainty analysis 3 2 1 uncertainty of various rainfalls the methods of section 2 5 1 are used to analyse the uncertainty of rls under 162 different real rainfalls the rfi are provided in table 7 the rfi range width 95 5 of all the rls are similar to each other which indicates that the safe learning maintains the performance for all the rls also rls have stable control effect than do nothing and efd as they achieve narrower rfi range width to further demonstrate the relation between rfi and rainfall volume we provide the rfi and the daily volume of 162 rainfalls in fig 11 which shows that the shapes of rls figure are thinner than bc and efd and also indicates a stable control effect meanwhile fig 11 shows that the daily volume of rainfall influences the performance of rls more discussions are given in section 4 2 3 2 2 uncertainty of input and output the method in section 2 5 2 is used to analyse the uncertainty of rls with respect to different amplification factor δ the values of δ are 0 5 1 0 1 5 and 2 0 respectively the range of their total flooding are given in figs 12 17 accordingly the amplification factor δ influence the performance of rls also the impact of input and output on the control effect have different pattern more discussions are given in section 4 2 4 discussion 4 1 the changing of value function based on the penalized reward according to the results in section 3 1 safe rls achieve similar control effect with lower average water level and operation frequency the reason can be explained through the change of value function based on the penalized reward traditional rls are intended to find the conditional probability p a t s t to obtain higher q value when safe learning applied their training process focus on both control objective and safety thus lead to a different value function eq 22 where safe in eq 7 is the safe zone provided through mathematic description 22 v s t a t s t s a s a f e p a t s t r s t a t i 1 2 λ i c i γ v s t 1 after training based on eq 22 a different conditional probability p a t s t s a f e will be obtained and is able to consider both safety and control effect thus safe learning is a natural method to improve rls safety 4 2 the factors influence rls robustness previous research claimed that rl has a certain level of stability when facing slight perturbation in training and testing process in this study we show that this conclusion is not fully correct according to the results in section 3 2 1 rls performance are various when facing different rainfalls which indicates that its control effect is strongly influenced by the volume of rainfalls this can be detailed demonstrate through fig 11 in which the rfi increases with the volume of rainfall the reason that rfi converge at 0 7 is mainly because the drainage system is full and there is no space for adjusting and controlling lund et al 2020 the influence of imperfect input and noisy output have very different patterns this can be explained through two metrics flooding mean value and the flooding range width in figs 12 17 for dqns the flooding mean value is decreased with the af of input and is increased with the af of output for ppos the flooding mean value of safe ppo is larger than it of ppo when facing imperfect input while the situation is opposite when facing noisy output also safe rls are more likely to have a smaller flooding range width than original rls which means that the safe rls are more likely to meet the safety constrains given by mathematic description although an explicit explanation of this phenomenon is hard to be provided it is far enough to be used to confirm that the rls robustness is influenced by these factors 4 3 the adaptability of efd the results of section 3 1 1 and the rfi in section 3 2 1 show that the control effect of rls is only close to but do not exceed efd during these rainfalls the reason is that the efd is an optimized control method on all these rainfalls therefore the performance of efd will decrease when facing brand new rainfall events that it has not learned to demonstrate this all methods are tested in three extra 4 hour rainfall events fig 18 in which dqn and safe dqn achieve better performance than efd table 8 fig 19 this results further indicate the advantage of rls in the adaptability to different rainfalls 4 4 future works 4 4 1 the use of prior information in the above case the rcpo only improves the probability of selecting safe action rather than forces rl agents to stay in the safe zone all the time this is solved in the above case through the combination of hirl and prior information of the study area also we use prior information of the study area to drastically reduce the dimension of dqn ppo s action space the idea of using prior knowledge to help training is not new lu and zong 2019 but how to use it appropriately and efficiently in the field of uds is still unknown 4 4 2 the selection of safety constraints for different udss the selection of safety constraints can be various as long as they can be mathematically represented by the mathematic description therefore the above method is a highly adaptive and problem dependent how to select suitable safety constraints for different udss with respect to a stable control process richards et al 2018 is still an unsolved puzzle also the mathematic description is based on the premise that the hardware and structure of rl control systems is operated normally without damage the safety problem caused by structure failure cannot easily solved through safe learning framework and is not be considered in this paper usually increasing of system redundancy ahern 2011 is a common method to solve this problem more study is still need in this direction 4 4 3 the formula of mathematic description the specifical formula of the mathematic description can be various and flexible if we consider statistic model then a safe rl should satisfy a different mathematic description given by conditional probability eq 23 23 s t a t p s t a t s a f e i 1 m p s t a t safety i s t a t u p p e r i satisfying eq 23 requires the control process to converge gradually along time or force the control trajectory stay in a region of attraction roa these contents are directly related to resilience of uds wang et al 2021 butler et al 2014 casal campos et al 2018 control lyapunov function s stability clf richards et al 2018 and control barrier function cbf ames et al 2019 and will be present in our future study 5 conclusions to remedy the lack of rl safety in the context of uds three main tasks are completed in this study i a metric of rls safety is investigated through a mathematic description for the application of uds ii two safe learning methods are employed to improve rl safety in uds iii uncertainty analysis is used to validate rls robustness with respect to different conditions all these methods are validated through an open source swmm model called astlingen the main conclusions are summarized as follows i all the rls have a certain effect in flooding mitigation ii safe rls achieve a similar control effect with a safer control process iii the robustness of rls in the context of uds is influenced by the rainfall events the degree of randomness and the type of rls the safety of rl in the context of uds is still worth exploration for instance the mathematic description provided in this study is highly adaptive flexible and problem dependent how to select suitable safety constraints for different udss with respect to a stable control process is still unknown also its relationship with resilience of uds control lyapunov stability and control barrier function still need more research meanwhile how to use prior engineering knowledge appropriately and efficiently to improve the rl in uds is an interesting topic to be discussed credit authorship contribution statement wenchong tian conceptualization methodology software validation writing original draft writing review editing visualization kunlun xin project administration supervision funding acquisition conceptualization validation writing original draft writing review editing zhiyu zhang software validation writing original draft muhan zhao conceptualization methodology software writing original draft zhenliang liao funding acquisition validation writing original draft tao tao funding acquisition validation writing original draft writing review editing declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests kunlun xin reports financial support was provided by national natural science foundation of china zhenliang liao reports financial support was provided by national natural science foundation of china tao tao reports financial support was provided by national natural science foundation of china acknowledgements this study was financially supported by the national natural science foundation of china grant no 51978493 grant no 51778452 grant no 52170102 the details of the swmm model and the data of real rainfall event in the case is available in these references sun et al 2020 all the code can be found on github https github com dantezio safe rl in uds appendix a a the flow results of v1 v2 v4 v5 v6 figs a1 a10 
