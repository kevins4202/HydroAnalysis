index,text
15670,as the importance of fecal sludge management fsm is increasingly being realized the need for adequately designed and functioning fecal sludge fs treatment plants is also increasing research to fill this gap is only emerging and dewatering is a key challenge for developing sustainable treatment solutions this study evaluated the effect of extracellular polymeric substances eps on dewaterability of fs and how eps and dewaterability change during anaerobic storage as a proxy for time in onsite containment eps was extracted from fs and activated sludge using na2co3 and sonication and added to sludge samples to determine the effect on dewaterability the results confirmed that an increase in eps had a direct impact of decreasing fs dewaterability as capillary suction time in this context we evaluated fs degradation during anaerobic storage the effect of anaerobic storage time on eps eps fractions and particle size distribution and the effect of variations in these factors on fs dewaterability variations in eps eps fraction and particle size distribution during anaerobic storage were less than expected and average vs reduction of 20 was recorded over 7 weeks although anaerobic digestion was verified biogas production the results indicate that kinetics of degradation of fs is different from wastewater sludges comparatively eps fractions in fs were 70 75 lower and with higher fractions of humic like substances than wastewater sludges although eps significantly affects fs dewaterability anaerobic storage time is not a predictor of dewaterability graphical abstract image graphical abstract keywords blackwater sludge filtration biomethane potential test microbial community analysis particle size distribution data availability the data for this study is openly available in eawag data repository https doi org 10 25678 0006fp 1 introduction adequate fecal sludge management fsm is a key aspect of meeting the sustainable development goal sdg 6 2 united nations 2015 which aims to safely manage sanitation and hygiene services similar to wastewater sludge treatment the critical step in fsm is the separation of liquids and solids in fecal sludge fs by dewatering strande et al 2014 fs typically consists of more than 95 water gold et al 2017 and improvement in dewatering can reduce the cost of transportation and facilitate further treatment processes unlike fs dewatering is widely implemented and studied in wastewater sludges however a direct application of dewatering technologies from wastewater to fs is not feasible due to the marked differences between fs and wastewater and the high variability of fs characteristics and composition ward et al 2019 the variability of fs stems from the different types of containments differences in emptying practices usage patterns e g flush toilet and the duration of storage in onsite containment which affects the level of stabilization ward et al 2019 hence fs arriving at treatment plants has much more variable characteristics than wastewater which is relatively more homogenized as it travels in the sewer network and is one to two orders of magnitude more variable in cod and ts concentrations strande et al 2018 for example cod of fs has been reported to be about 8000 127 000 mg l compared to 500 2500 mg l for wastewater sludges primary and secondary sludge junglen et al 2020 niwagaba et al 2014 dewatering performance of fs is more variable than wastewater sludges gold et al 2017 with differences occurring among distinct onsite sanitation systems different cities or even similar onsite systems such as lined and unlined pit latrines strande et al 2018 based on extensive knowledge of dewatering of wastewater floc properties such as microorganisms extracellular polymeric substances eps organic debris and inorganic particles christensen et al 2015 are major factors that influence dewaterability of activated sludges additionally particle size distribution affects dewaterability because higher concentrations of small particles can contribute to clogging of filter media and reduce settleability christensen et al 2015 houghton and stephenson 2002 lawler et al 1986 the role of eps and particle size distribution on dewaterability of wastewater are well known dewaterability is enhanced by soluble and loosely bound eps which contribute to increased bioflocculation resulting in improved filtration christensen et al 2015 however floc disintegration and the release of eps into solution worsens dewaterability lei et al 2007 novak et al 2003 in addition floc disintegration generates suspended fine flocs and individual particles which further reduce dewaterability houghton and stephenson 2002 anaerobic conditions can either worsen or improve dewaterability in wastewater sludges under anaerobic conditions flocs disintegrate which releases suspended organic matter and worsens dewatering novak et al 2003 however suspended organic matter including eps and particles are also ultimately degraded which improves dewaterability mikkelsen and keiding 2002 it is not clear if these relationships exist in fs because research on fs is very limited in comparison to wastewater with over a hundred year gap in research knowledge jenkins and wanner 2014 furthermore processes occurring in fs containments are not well understood there is a common perception that a thin micro aerophilic layer exist on the surface of the fs in containments while the bulk of the fs containment is predominantly anaerobic bakare et al 2012 brouckaert et al 2013 current research on fs dewaterability has identified that physical and chemical characteristics such as ph conductivity total solids eps particle size distribution and microbiology have statistical correlations with fs dewaterability gold et al 2017 ward et al 2019 it is commonly accepted that stabilization of fs with time in containment which affects these factors will influence the sludge dewaterability to the best of our knowledge there has only been one study characterizing eps in fs where a correlation was observed between eps and dewatering of fs based on 20 field samples ward et al 2019 however it has never been demonstrated or verified that eps is controlling dewaterability of fs the study by ward et al 2019 observed that fs that appeared to be more stabilized had lower eps and better dewatering performance compared to unstabilized sludge however these were grab samples taken at one time point in the field the effect of time on eps concentrations during storage of fs in anaerobic containments and the relation to dewaterability is not known therefore the objective of this study was to validate the role of eps in dewaterability of fs and conduct controlled anaerobic stabilization experiments to gain an understanding of changes in eps and dewaterability that take place with time during anaerobic storage reflective of onsite containments laboratory based anaerobic batch reactors and anaerobic biomethane potential bmp test were used to mimic conditions in onsite containments 2 materials and methods 2 1 source of inoculum and feed four different inocula were used in this study anaerobic digester sludge ad cow manure cm septic tank sludge st and pit latrine sludge pl the ad sludge was obtained from a pilot scale anaerobic reactor at eawag in dübendorf switzerland which was being fed with waste activated sludge and operating under mesophilic conditions 35 c cm samples were obtained from a farm in dübendorf st sludge was collected from vacuum trucks during discharge at a fs treatment plant in accra ghana pl sludge was collected from pit latrines in kampala uganda both st and pl samples were immediately stored in cooling boxes with ice before being airfreighted to switzerland with ice packs to maintain the temperature at eawag the inocula were homogenized using a kitchen blender at the highest speed and stored at 4 c feed for anaerobic reactors and bmp tests consisted of feces and urine collected with urine separating dry toilets at eawag the feed was prepared by mixing freshly collected feces and urine to obtain a feces to urine ratio of 2 5 or 3 75 by wet weight and subsequently diluted to less than 5 ts with tap water to be in the range of reported ts concentrations of fs velkushanova et al 2021 in addition to the ts other characteristics i e vs vss tss and cod were confirmed to be in the range of characteristics reported for fs the feed was stored at 4 c and brought to room temperature prior to use characterization data of all the inocula and the feeds is provided in the supplementary information table s1 to make a slurry for the bmp tests and batch reactors cm which originally had a ts of 18 6 was diluted by adding deionized water to achieve a ts concentration of 4 which is a standard value when using cm as inoculum for anaerobic digestion systems sunada et al 2018 2 2 biomethane potential tests bmp tests were conducted to evaluate the ability of the four inocula to degrade fs under laboratory conditions the tests were conducted as described by holliger et al 2016 with two modifications including operating temperatures of 20 c and 37 c and the feed composition of urine and feces two sets of bmp tests were conducted run a and run b with varying feed composition and temperatures the feed for run a had feces to urine ratio of 1 2 5 by wet weight and for run b feces to urine ratio of 1 3 75 the ratios of feces to urine was based on the daily per capita production of feces and urine reported in the literature with an average of 400 g feces and 1 l urine 1 2 5 colón et al 2015 or 400 g feces and 1 5 l urine vögeli et al 2014 although higher daily per capita production of urine has been reported it was taken into account that not all urine is captured in onsite containment especially in low income countries where there is limited access to sanitation colón et al 2015 an inoculum to feed ratio of four based on the volatile solids vs concentration was selected due to unknown degradation characteristics of the feed as described in angelidaki et al 2009 the bmp tests were carried out in triplicate in 200 ml glass serum bottles with 70 active volume the headspace of reaction bottles were flushed with n2 gas to provide anaerobic conditions and incubated in a vwr 5000 l shaking incubator at 100 rpm following collection of the gas measurement bottles were shaken by hand to ensure complete mixing of the floating layer that formed immediately after biogas is released the performance of the bmp tests were measured by the biogas volume using a water displacement setup described by filer et al 2019 and normalized with the initial volatile solids vs g l added methane content was measured periodically using gas chromatography gc 9350 with flame ionization detector and ion capture detector agilent technologies us microcrystalline cellulose avicel ph 101 and nanopure water were used as positive and negative controls respectively and the bmp tests were stopped when biogas production for 3 consecutive days was less than one percent of the cumulative gas production filer et al 2019 the microbial community of the different inocula were also determined to understand the differences and similarities between the inocula in relation to biogas production presented in table 1 are the characteristics of the all the bmp tests at the start of the experiments 2 3 anaerobic batch reactors and serum bottle tests as summarized in table 2 a series of batch reactor runs were conducted using ad and pl as inoculum designated as run 1 to run 6 to evaluate the influence of eps concentrations eps fractions and particle size distribution with time on the dewaterability of fs the selection of inoculum and feed ratios for the batch reactors in this study were based on results of the bmp tests after confirming that both ad and pl sludges were capable of degrading the feed in bmp tests ad was selected to ensure that the results were comparable to literature and pl sludge was selected as it was considered to be the most representative of fs in sub saharan africa ad sludge was used as inoculum in 12 l reactors in runs 1 3 at 20 c and run 4 at 35 c whiles pl sludge was used in runs 2 and 3 in runs 2 and 4 two reactors were operated in parallel fed with the 1 2 5 feces urine feed with one reactor in run 4 fed with synthetic wastewater as a control reactor although the reaction conditions and inocula were the same for runs 2 and 3 the two runs differed in the reaction time in run 4 35 c reaction temperature was selected for comparison with the literature and the control reactor with synthetic wastewater was used to control for the interference of other substances in fs and to verify that the fs feed had adequate nutrients for growth the reactor contents were mixed continuously using heidolph r2r2020 mechanical stirrers at speed 7 biogas was collected in 10 l plastic biogas collection bags and the volume and methane content determined by a gas sensor ritter drum type tg series runs 5 and 6 were operated in parallel with similar conditions and inocula but in different setups to evaluate mixing in the reactors run 5 consisted of 5 l and 2 l glass batch reactors for ad and pl sludge respectively and the operational temperature was 35 c glass batch reactors were used to visually verify adequate mixing which was achieved with a magnetic stirring rod and biogas was collected in 2 l biogas run 6 hereafter referred to as the serum bottle test was conducted in serum bottles with the same setup as described in section 2 2 this verification of mixing in glass reactors was conducted because the degradation of organic matter in runs 1 4 was less than expected in the anaerobic batch reactors which were opaque and did not allow for visual observation of mixing 2 4 physicochemical analysis 2 4 1 sample analysis the inoculum feed and content of the reactors were analyzed for total solids ts volatile solids vs total suspended solids tss and volatile suspended solids vss using methods for fs analysis velkushanova et al 2021 cod and soluble cod were determined with hach lange test kits according to the manufacturer s instructions which is based on the american public health association apha standard methods 5220 d ammonium nitrogen nh4 n and total nitrogen tn were measured with hach lange test kits based on apha standards 5400nc and 4500nh3 f respectively alkalinity was determined using the titration method and volatile fatty acids vfa were analysed using a shimadzu 881 compact ic pro ion chromatograph 2 4 2 extracellular polymeric substances eps measurements were performed by the method described by ward et al 2019 the eps concentration and fractions were measured with the size exclusion chromatography organic carbon detection organic nitrogen detection lcocd ond and fiffikus software doc labor dr huber germany was used for the analysis of the different fractions the lc ocd ond chromatogram presents the fraction of the sample according to their molecular weight in the dissolved phase five peaks are generated representing biopolymers 20 000 7 5 1011 g mol humic substances 1000 g mol building blocks 300 500 g mol low molecular weight organics 350 g mol and neutrals including aldehydes and ketones 350 g mol huber et al 2011 jacquin et al 2017 the biopolymer fraction of eps in this study had a low c n ratio 2 7 which indicates that the biopolymers are composed mainly of proteins thus the eps was therefore categorized into protein like biopolymer peak and humic like substances humic acids and building block peak according to jacquin et al 2017 and ward et al 2019 and the total eps was calculated as the sum of the two 2 4 3 eps extraction eps soluble loosely bound was extracted from activated sludge obtained from eawag and from pit latrine fs samples using the na2co3 method described by shambeck et al 2020 and sonication as described in detail by ward et al 2019 followed by centrifugation at 3500 g for 20 min to determine the effect of eps on dewaterability in terms of cst two tests were performed in test a 2 ml of soluble loosely bound eps was added to 10 ml of ad sludge and pl sludge samples and compared to addition of 2 ml of water as a control samples were vortexed for 1 min and cst was measured using the setup described in section 2 4 4 in test b different weights 0 01 0 02 0 05 and 0 1 gs of freeze dried eps was added to 10 ml of ad sludge and pl sludge samples vortexed and cst measured accordingly cst of ad sludge and pl sludge samples were measured prior to and after eps addition 2 4 4 dewaterability sludge dewaterability was assessed by measuring the capillary suction time cst and turbidity of supernatant following centrifugation cst measures the time required for water to pass through a filter paper filterability whereas supernatant turbidity indicates the extent of settleability of the sludge cst was measured in quadruplicates according to methods for fecal sludge analysis velkushanova et al 2021 using the 319 multi cst apparatus instrument from triton electronics ltd uk with an 18 mm funnel supernatant turbidity of centrifuged sludge was measured using 30 ml of sludge and centrifuging at 3000 x g for 20 min in a 50 ml falcon tube the turbidity of the supernatant after centrifugation was determined with a hach tl 2300 turbidity meter 2 4 5 particle size distribution particle size distribution was analyzed using the static light scattering measurement according to ahpa standard method 2560d using a beckman coulter ls 13 320 laser diffraction particle size analyzer liquid samples were gently mixed by pipetting with a pasteur pipette to homogenize the sample without breaking up aggregates and then dispersed for measurement using the universal liquid module which is capable of suspending and analyzing samples in the 0 017 2000 µm size range 2 4 6 microbial community analysis to assess the influence of the microbial community of the different inocula on the bmp test 2 ml sample of each inoculum was centrifuged at 6000 rcf for 10 min the supernatant was discarded and 1 ml of rna later was added to the pellets and stored at 20 c until dna extraction dna was extracted following a modified method by griffiths et al 2000 to each inoculum pellet 0 5 ml of hexadecyltrimethylammonium bromide buffer was added and gently mixed with the sample the mixture was transferred to a 2 ml lysing matrix tube 0 5 ml of phenol chloroform isoamylalcohol pci 25 24 1 ph 6 8 was added after which a fastprep equipment is used to lyse the sludge samples further extraction was carried out with the addition of 0 5 ml of chloroform isoamylalcohol ci 24 1 to each sample nucleic acids were precipitated with polyethylene glycol 6000 on ice and further washed with 70 ethanol before being dissolved in 100 ul of molecular grade water nucleic acid quality and quantity was determined with a nanodrop nd 2000c 16s rrna gene amplicon sequencing was carried out by novogene on an illumina miseq platform based on bacterial and archaeal v4 region raw sequences were analysed within the qiime2 framework taxonomical assignment of the amplicon sequence variants asvs was performed within qiime2 environment with the midas database nierychlo et al 2020 accessed october 2021 based on the relative abundances we plotted the top bacterial phyla for each sample picrust2 douglas et al 2020 was used to predict the functional potential of the microbial communities based on the lowest common ancestor approach where the 16s rrna genes are mapped against a public available genome reference database that allows for prediction of the functional potential 2 4 7 statistical analysis the kendall rank correlation was used to assess the potentially non linear dependencies between the measured parameters and anaerobic storage time a p value below 0 05 was considered statistically significant the same approach was used to determine the correlation between factors that affect dewaterability eps and particle size and the metrics of dewaterability cst and turbidity the data for this study are openly available in eawag repository https doi org 10 25678 0006fp 3 results and discussion 3 1 effect of eps on dewaterability of fecal sludge and wastewater sludge as illustrated in fig 1 the influence of eps on the dewaterability of fs and ad was evaluated by measuring changes in cst with the addition of aliquots of soluble loosely bound fig 1a and freeze dried form of the same soluble loosely bound eps fig 1b that was extracted from fs and activated sludge with two different methods of extraction sonication and na2co3 addition of eps extracted from both fs and activated sludge had the same effect on dewaterability and increasing amounts of eps continued to decrease dewaterability indicated by a high cst this confirms that concentrations of eps can govern dewaterability in fs and that eps from fs and activated sludge have a similar effect ward et al 2019 also reported that fs samples collected in senegal and tanzania had lower dewaterability with higher concentrations of eps an increase in eps results in increased clogging of the filter media thus reducing the dewatering performance as suggested by novak et al 2003 the release of bound eps into solution is expected to decrease sludge dewaterability based on experiences in municipal wastewater where eps increases during activated sludge jia et al 1996 liu and fang 2003 and decreases during anaerobic digestion lei et al 2007 nielsen et al 1996 if eps is the main controller of dewaterability of fs it is expected that anaerobic storage will result in degradation of biopolymers resulting in improved dewaterability 3 2 preliminary bmp tests presented in fig 2 are results of the total biogas production for bmp runs a and b which were conducted to validate fs degradation under anaerobic storage with different inocula results of biogas from the positive controls are presented in table s2 biogas from the ad sludge which is a conventional inoculum for bmp tests was within 86 98 of the theoretical biogas production st sludge had 97 of the theoretical biogas from microcrystalline cellulose cm 59 94 and pl 8 53 a range of field temperatures have been reported for onsite containments for example 22 3 30 7 c for pit latrines in kampala nakagiri et al 2017 30 c for septic tanks in hanoi huynh et al 2021 30 32 c for pit latrines in morogoro tanzania van eekert et al 2019 19 32 c pit latrines in tanzania and vietnam torondel et al 2016 the selection of 20 c and 37 c for the bmp test therefore covers the range of reported temperatures using a feed with 1 2 5 feces to urine ratio the ad inoculum produced similar volumes of biogas at 20 c and 37 c whereas the pl inoculum had higher biogas production at 37 c than 20 c however ts and ammonium concentration may have contributed more to the lower biogas production than temperature as pl sludge had a higher concentration of ts see table 1 that could have resulted in a mass transfer limitation and ammonia inhibition due to concentrations 1 5 g l zuo et al 2021 the bmp test demonstrated that anaerobic degradation of fs was possible irrespective of the inoculum temperature and nh4 n concentration 3 3 microbial community analysis varying biogas production in the bmp tests could also be associated with microbial community as illustrated in fig 3 dominant bacterial phyla observed in all inocula included proteobacteria 12 21 firmicutes 18 35 and bacteroidetes 6 25 while members of chloroflexi were highly abundant in ad 30 st 19 and cm 12 they only made up a small fraction in the pl inoculum 3 this is in agreement with members of proteobacteria firmicutes and bacteriodes being reported as most abundant in fs samples ward et al 2019 while phylum latescibacteria which is present in animal intestines and sediments farag et al 2017 appeared as a dominant phylum in the st inoculum it was absent in all other inocula similarly the phylum deinococcota found mainly in animal feces and intestines murray 2004 was also unique to the cow manure inoculum besides the differences in community composition at the phylum level the different inocula presented significant differences in diversity within the group of methane producing bacteria figure s2 a prediction of the functional potential of the community via a lowest common ancestor approach douglas et al 2020 as illustrated in fig 3b indicates a high degree of functional redundancy despite the differences in community composition it is therefore not surprising that irrespective of the inoculum used fs was degraded to some extent as indicated by the biogas production 3 4 effect of anaerobic storage on dewaterability illustrated in fig 4 a and 4b are the changes in cst s with anaerobic storage time for pl and ad inoculated runs using the kendall rank correlation with a 95 confidence level to test the correlation between cst s and storage time we observed that cst s for both pl and ad inoculated runs generally decreased with anaerobic storage table s3 however the decrease in cst s were only statistically significant p 0 05 for run 5 inoculated with ad and runs 2 and 5 inoculated with pl variations in supernatant turbidity illustrated in fig 4c and 4d for pl and ad inoculated runs showed both a decrease and increase in supernatant turbidity with anaerobic storage reduction in turbidity was only statistically significant for run 5 for pl sludge and runs 3 and 5 for ad sludge a more clear trend in decreasing cst and supernatant turbidity was expected based on the literature sakaveli et al 2021 3 5 influence of anaerobic storage on eps and eps fractions reported in fig 5 a and 5b are eps vss concentration for pl and ad inoculated runs with anaerobic storage time it was observed that for pl inoculated runs in three out of four runs 2 5 and 6 there was decreasing eps vss and in ad inoculum runs five out of six runs 2 3 4 5 and 6 however the reductions were not statistically significant which indicates that there is no preferential degradation of eps over other vss components also illustrated in fig 5c 5d 5e and 5f are the humic like and protein like fractions of the extracted eps with time during anaerobic storage there were no clear trends and changes in humic like substances were statistically significant for only run 2 in the pl inoculated runs and for protein like substances only run 2 in both pl and ad inoculated runs however eps mg l for runs involving both ad and pl shown in fig 6 shows a decrease with time decreasing eps with time in anaerobic storage was expected and agrees with observations by nielsen et al 1996 where anaerobic storage resulted in a reduction in eps however the total reduction was less than expected possibly due to the lower initial concentrations of eps in fs illustrated in fig 6 are the total concentrations of eps as mg l and the specific fractions comprised of protein and humic like substances of eps mg l over the reaction time for runs 2 3 5 and 6 for comparison between ad and pl runs the figure indicates that the fractions of eps were generally degraded with anaerobic storage time with an average reduction of 40 for protein like and 22 for humic like fraction in ad inoculated runs in runs inoculated with pl on the other hand an average of 47 and 33 degradation was observed for protein and humic like substances respectively the decrease in total eps mg l and eps fractions generally did not have a significant correlation with metrics of dewaterability cst using the kendall rank correlation table s5 although degradation is seen in the total eps mg l the extent of degradation is lower relative to anaerobic storage or digestion of activated sludge where a higher reduction of eps is observed however of interest humic like substances in all samples were about twice the concentration of protein like fractions this observation is similar to fs field samples from senegal and tanzania ward et al 2019 but is contrary to wastewater sludges where proteins and carbohydrates constitute a higher fraction of eps neyens et al 2004 indicating that eps from fs is comprised of greater fractions of humics to verify the legitimacy of our observations of high humic like substances in fs eps ftir was performed as a qualitative analysis on the extracted eps together with standard samples of glucose cellulose humic acids and proteins as illustrated in fig 7 peaks representing carboxylic or hydrocarbon containing compounds 1500 1300 cm 1 and carbohydrates 1200 900 cm 1 were clearly evident badireddy et al 2010 a major peak between 1033 and 1086 cm 1 which is attributed to c o stretching of polysaccharides or polysaccharide like substances was seen in all samples except proteins two prominent peaks around 2850 cm 1 and 2919 cm 1 which are aliphatic ch group stretching of fatty acids and long chain structures were seen in all samples zhu and zhao 2011 the spectrum of the extracted eps showed more similarities in peaks with the humic acid and cellulose standard which supports the measurement of higher humic acid concentrations in the extracted eps from fs 3 6 performance of bmp tests and anaerobic batch reactors all inocula in bmp tests were monitored for ph vfa alkalinity and nh4 n concentrations to ensure adequate operating conditions the inocula all had a ph between 7 2 to 8 0 vfa between 0 1 and 1 6 g l acetate nh4 n between 0 8 and 3 3 g l and alkalinity between 2 8 and 9 4 g l caco3 recommendations for bmp test are ph 7 0 and 8 5 vfa 1 g l acetate nh4 n 2 5 g l nh4 n and alkalinity 3 gcaco3 l 1 holliger et al 2016 the percentage of ch4 in biogas was 58 68 anaerobic batch reactors and serum bottle tests were monitored for biogas methane vfa ph alkalinity and reduction in vs and cod biogas was produced in all reactors with methane of 56 70 the vfa alkalinity ratio g l g l caco3 was between 0 09 and 0 31 and ph between 6 85 7 92 average vs and cod reductions were 20 and 30 respectively vs reduction was low expected 50 65 tchobanoglous et al 2014 however the control synthetic wastewater showed a comparable vs reduction of 24 indicating no inhibition in the reactors 3 7 influence of particle size distribution fig 8 illustrates the particle size distribution of samples from the start and end times of reactors inoculated with pl and ad sludge in run 6 and the percentage of particles by volume from 0 4 2000 µm particle size distribution was performed in run 6 to see if it could help explain the dewaterability results in runs 1 5 whiles pl sludge shows multiple peaks at 30 52 and 185 um ad sludge had a unimodal distribution with a peak at 52 µm and a shoulder at 560 µm in the higher particle size range the results indicate that in both ad and pl reactors anaerobic storage resulted in an increase in supracolloidal particles 1 100 µm and a decrease of larger particles during anaerobic storage of wastewater sludge the breakdown of organic matter generates more supracolloidal particles which if not completely utilized are known to have a negative effect on dewaterability higher cst rudolfs and heukelekian 1934 however in this study there was no significant correlation between the supracolloidal particles and the cst or turbidity for both ad and pl inoculated runs table s3 in wastewater sludges tightly bound eps provides binding sites for flocculation which improves dewaterability lin et al 2019 whereas extracted soluble and loosely bound eps in this study represents colloidal and suspended organic substances that affect dewaterability by clogging of filter media ward et al 2019 and not flocculation if extracted soluble and loosely bound eps is being degraded at the same time that small particles are generated it is difficult to know which is contributing more to dewaterability it is possible that the influence of eps on cst is more pronounced than the effect of small particle generation and this is an area for further research 3 8 elucidation the role of eps in dewaterability of fs in this study it was empirically demonstrated that the addition of extracted eps decreases dewaterability however the degradation of eps during anaerobic storage was not as great as expected and the relation to dewaterability was not clear improvement in sludge dewaterability has been reported with both an increase or a decrease in eps liu and fang 2003 shahid et al 2022 houghton and stephenson 2002 argued that an initial increase in eps increases dewaterability but beyond a certain eps threshold dewaterability decreases fractions of eps mainly proteins and carbohydrates have also been reported as having different effects on sludge dewaterability cetin and erdincler 2004 sheng et al 2010 eps concentrations in this study 9 72 mgeps gvss were lower than reported eps concentrations in wastewater sludges using similar methods of extraction 30 and 290 mg gvss caudan et al 2012 comte et al 2006 pellicer nàcher et al 2013 the eps concentration in this study is below the 100 mgeps gtss that has been suggested as a minimum for floc formation jørgensen et al 2017 and rather fits the description of colloidal and suspended organic substances that affect dewaterability by clogging of filter media ward et al 2019 in addition humic like and protein like fractions of eps did not follow clear trends during anaerobic storage or have significant relations to sludge dewaterability but the humic like fractions of eps were consistently greater than for wastewater sludges 4 implications to fecal sludge treatment in this study anaerobic storage of fs did not fit into the well known anaerobic digestion model batstone et al 2002 which predicts 50 60 vs reduction the lower average vs reduction 20 observed in this study indicates that anaerobic degradation of fs follows different kinetics than for wastewater sludges this could be due to inhibitory factors or organic fractions in feces rose et al 2015 which are difficult to degrade and different from biological secondary or blended primary and secondary wastewater sludges further studies should consider the behavior of the less biodegradable organic compounds such as cellulose and lignin during anaerobic storage in addition experiments in this study were based on the general consensus that predominantly anaerobic conditions are present in onsite containments as research in fs increases these conventions are being questioned and purely anaerobic conditions may or may not be totally reflective of onsite containments especially in the surface or border regions shaw and dorea 2021 the presence of anaerobic aerobic and anoxic zones in onsite containments needs to be further investigated in order to understand the degradation kinetics of organics in different layers and predict what is occurring throughout storage in containment with time lópez vázquez et al 2021 5 conclusions to the best of our knowledge this was the first study to evaluate eps concentrations in fs during anaerobic storage in the laboratory and to assess the influence of changing total eps concentrations and fractions on fs dewaterability conclusions from this research include eps has a significant effect on fs dewaterability irrespective of the extraction method or the source of sludge used in this study an increase in eps concentration of the sludges decreased dewaterability fs is different from wastewater sludges meaning knowledge of wastewater treatment performance cannot be directly transferred fundamental differences include lower overall concentrations of eps and greater concentrations of humic like fractions of eps it is clear that eps plays a role in dewaterability of fs however due to the lower than predicted degradation during anaerobic storage the fate of tightly bound loosely bound and humic protein and carbohydrate fractions of eps needs to be further investigated in addition to the contribution of other compounds with water holding capacities anaerobic storage time is not a predictor of particle size distribution other physical properties such as charge density that play a role in dewaterability need to be further investigated differences in degradation of eps and changes in particle size distribution are likely related to variations in microbial community there remains a lack of knowledge of pathways of digestion of fs during storage in containment author contribution sam s b ward b j strande l and morgenroth e contributed to study design all authors provided helpful feedback and suggestions throughout the study sam s b was responsible for experimental design reactor setup collection and analysis of sample ward b j performed particle size distribution analysis niederdorfer r performed the data analysis on microbial community sam s b took the lead in writing the manuscript strande l contributed to data analysis and writing with critical and helpful reviews from all authors strande l conceived the idea obtained funding and supervised the project declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments financial support for this study was provided by the swiss national foundation for scientific research snsf we acknowledge jacqueline traber for helping with eps extraction procedure karin beck and patrick kathriner for helping with dna extraction methods and gas measurement respectively as well as helmut bergmann for the expert advice on the dna extraction the authors would like to thank andreas scheidegger and damian hausherr for the helpful scientific discussions and all the technical staff of the experimental hall eawag in dübendorf supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118915 appendix supplementary materials image application 1 
15670,as the importance of fecal sludge management fsm is increasingly being realized the need for adequately designed and functioning fecal sludge fs treatment plants is also increasing research to fill this gap is only emerging and dewatering is a key challenge for developing sustainable treatment solutions this study evaluated the effect of extracellular polymeric substances eps on dewaterability of fs and how eps and dewaterability change during anaerobic storage as a proxy for time in onsite containment eps was extracted from fs and activated sludge using na2co3 and sonication and added to sludge samples to determine the effect on dewaterability the results confirmed that an increase in eps had a direct impact of decreasing fs dewaterability as capillary suction time in this context we evaluated fs degradation during anaerobic storage the effect of anaerobic storage time on eps eps fractions and particle size distribution and the effect of variations in these factors on fs dewaterability variations in eps eps fraction and particle size distribution during anaerobic storage were less than expected and average vs reduction of 20 was recorded over 7 weeks although anaerobic digestion was verified biogas production the results indicate that kinetics of degradation of fs is different from wastewater sludges comparatively eps fractions in fs were 70 75 lower and with higher fractions of humic like substances than wastewater sludges although eps significantly affects fs dewaterability anaerobic storage time is not a predictor of dewaterability graphical abstract image graphical abstract keywords blackwater sludge filtration biomethane potential test microbial community analysis particle size distribution data availability the data for this study is openly available in eawag data repository https doi org 10 25678 0006fp 1 introduction adequate fecal sludge management fsm is a key aspect of meeting the sustainable development goal sdg 6 2 united nations 2015 which aims to safely manage sanitation and hygiene services similar to wastewater sludge treatment the critical step in fsm is the separation of liquids and solids in fecal sludge fs by dewatering strande et al 2014 fs typically consists of more than 95 water gold et al 2017 and improvement in dewatering can reduce the cost of transportation and facilitate further treatment processes unlike fs dewatering is widely implemented and studied in wastewater sludges however a direct application of dewatering technologies from wastewater to fs is not feasible due to the marked differences between fs and wastewater and the high variability of fs characteristics and composition ward et al 2019 the variability of fs stems from the different types of containments differences in emptying practices usage patterns e g flush toilet and the duration of storage in onsite containment which affects the level of stabilization ward et al 2019 hence fs arriving at treatment plants has much more variable characteristics than wastewater which is relatively more homogenized as it travels in the sewer network and is one to two orders of magnitude more variable in cod and ts concentrations strande et al 2018 for example cod of fs has been reported to be about 8000 127 000 mg l compared to 500 2500 mg l for wastewater sludges primary and secondary sludge junglen et al 2020 niwagaba et al 2014 dewatering performance of fs is more variable than wastewater sludges gold et al 2017 with differences occurring among distinct onsite sanitation systems different cities or even similar onsite systems such as lined and unlined pit latrines strande et al 2018 based on extensive knowledge of dewatering of wastewater floc properties such as microorganisms extracellular polymeric substances eps organic debris and inorganic particles christensen et al 2015 are major factors that influence dewaterability of activated sludges additionally particle size distribution affects dewaterability because higher concentrations of small particles can contribute to clogging of filter media and reduce settleability christensen et al 2015 houghton and stephenson 2002 lawler et al 1986 the role of eps and particle size distribution on dewaterability of wastewater are well known dewaterability is enhanced by soluble and loosely bound eps which contribute to increased bioflocculation resulting in improved filtration christensen et al 2015 however floc disintegration and the release of eps into solution worsens dewaterability lei et al 2007 novak et al 2003 in addition floc disintegration generates suspended fine flocs and individual particles which further reduce dewaterability houghton and stephenson 2002 anaerobic conditions can either worsen or improve dewaterability in wastewater sludges under anaerobic conditions flocs disintegrate which releases suspended organic matter and worsens dewatering novak et al 2003 however suspended organic matter including eps and particles are also ultimately degraded which improves dewaterability mikkelsen and keiding 2002 it is not clear if these relationships exist in fs because research on fs is very limited in comparison to wastewater with over a hundred year gap in research knowledge jenkins and wanner 2014 furthermore processes occurring in fs containments are not well understood there is a common perception that a thin micro aerophilic layer exist on the surface of the fs in containments while the bulk of the fs containment is predominantly anaerobic bakare et al 2012 brouckaert et al 2013 current research on fs dewaterability has identified that physical and chemical characteristics such as ph conductivity total solids eps particle size distribution and microbiology have statistical correlations with fs dewaterability gold et al 2017 ward et al 2019 it is commonly accepted that stabilization of fs with time in containment which affects these factors will influence the sludge dewaterability to the best of our knowledge there has only been one study characterizing eps in fs where a correlation was observed between eps and dewatering of fs based on 20 field samples ward et al 2019 however it has never been demonstrated or verified that eps is controlling dewaterability of fs the study by ward et al 2019 observed that fs that appeared to be more stabilized had lower eps and better dewatering performance compared to unstabilized sludge however these were grab samples taken at one time point in the field the effect of time on eps concentrations during storage of fs in anaerobic containments and the relation to dewaterability is not known therefore the objective of this study was to validate the role of eps in dewaterability of fs and conduct controlled anaerobic stabilization experiments to gain an understanding of changes in eps and dewaterability that take place with time during anaerobic storage reflective of onsite containments laboratory based anaerobic batch reactors and anaerobic biomethane potential bmp test were used to mimic conditions in onsite containments 2 materials and methods 2 1 source of inoculum and feed four different inocula were used in this study anaerobic digester sludge ad cow manure cm septic tank sludge st and pit latrine sludge pl the ad sludge was obtained from a pilot scale anaerobic reactor at eawag in dübendorf switzerland which was being fed with waste activated sludge and operating under mesophilic conditions 35 c cm samples were obtained from a farm in dübendorf st sludge was collected from vacuum trucks during discharge at a fs treatment plant in accra ghana pl sludge was collected from pit latrines in kampala uganda both st and pl samples were immediately stored in cooling boxes with ice before being airfreighted to switzerland with ice packs to maintain the temperature at eawag the inocula were homogenized using a kitchen blender at the highest speed and stored at 4 c feed for anaerobic reactors and bmp tests consisted of feces and urine collected with urine separating dry toilets at eawag the feed was prepared by mixing freshly collected feces and urine to obtain a feces to urine ratio of 2 5 or 3 75 by wet weight and subsequently diluted to less than 5 ts with tap water to be in the range of reported ts concentrations of fs velkushanova et al 2021 in addition to the ts other characteristics i e vs vss tss and cod were confirmed to be in the range of characteristics reported for fs the feed was stored at 4 c and brought to room temperature prior to use characterization data of all the inocula and the feeds is provided in the supplementary information table s1 to make a slurry for the bmp tests and batch reactors cm which originally had a ts of 18 6 was diluted by adding deionized water to achieve a ts concentration of 4 which is a standard value when using cm as inoculum for anaerobic digestion systems sunada et al 2018 2 2 biomethane potential tests bmp tests were conducted to evaluate the ability of the four inocula to degrade fs under laboratory conditions the tests were conducted as described by holliger et al 2016 with two modifications including operating temperatures of 20 c and 37 c and the feed composition of urine and feces two sets of bmp tests were conducted run a and run b with varying feed composition and temperatures the feed for run a had feces to urine ratio of 1 2 5 by wet weight and for run b feces to urine ratio of 1 3 75 the ratios of feces to urine was based on the daily per capita production of feces and urine reported in the literature with an average of 400 g feces and 1 l urine 1 2 5 colón et al 2015 or 400 g feces and 1 5 l urine vögeli et al 2014 although higher daily per capita production of urine has been reported it was taken into account that not all urine is captured in onsite containment especially in low income countries where there is limited access to sanitation colón et al 2015 an inoculum to feed ratio of four based on the volatile solids vs concentration was selected due to unknown degradation characteristics of the feed as described in angelidaki et al 2009 the bmp tests were carried out in triplicate in 200 ml glass serum bottles with 70 active volume the headspace of reaction bottles were flushed with n2 gas to provide anaerobic conditions and incubated in a vwr 5000 l shaking incubator at 100 rpm following collection of the gas measurement bottles were shaken by hand to ensure complete mixing of the floating layer that formed immediately after biogas is released the performance of the bmp tests were measured by the biogas volume using a water displacement setup described by filer et al 2019 and normalized with the initial volatile solids vs g l added methane content was measured periodically using gas chromatography gc 9350 with flame ionization detector and ion capture detector agilent technologies us microcrystalline cellulose avicel ph 101 and nanopure water were used as positive and negative controls respectively and the bmp tests were stopped when biogas production for 3 consecutive days was less than one percent of the cumulative gas production filer et al 2019 the microbial community of the different inocula were also determined to understand the differences and similarities between the inocula in relation to biogas production presented in table 1 are the characteristics of the all the bmp tests at the start of the experiments 2 3 anaerobic batch reactors and serum bottle tests as summarized in table 2 a series of batch reactor runs were conducted using ad and pl as inoculum designated as run 1 to run 6 to evaluate the influence of eps concentrations eps fractions and particle size distribution with time on the dewaterability of fs the selection of inoculum and feed ratios for the batch reactors in this study were based on results of the bmp tests after confirming that both ad and pl sludges were capable of degrading the feed in bmp tests ad was selected to ensure that the results were comparable to literature and pl sludge was selected as it was considered to be the most representative of fs in sub saharan africa ad sludge was used as inoculum in 12 l reactors in runs 1 3 at 20 c and run 4 at 35 c whiles pl sludge was used in runs 2 and 3 in runs 2 and 4 two reactors were operated in parallel fed with the 1 2 5 feces urine feed with one reactor in run 4 fed with synthetic wastewater as a control reactor although the reaction conditions and inocula were the same for runs 2 and 3 the two runs differed in the reaction time in run 4 35 c reaction temperature was selected for comparison with the literature and the control reactor with synthetic wastewater was used to control for the interference of other substances in fs and to verify that the fs feed had adequate nutrients for growth the reactor contents were mixed continuously using heidolph r2r2020 mechanical stirrers at speed 7 biogas was collected in 10 l plastic biogas collection bags and the volume and methane content determined by a gas sensor ritter drum type tg series runs 5 and 6 were operated in parallel with similar conditions and inocula but in different setups to evaluate mixing in the reactors run 5 consisted of 5 l and 2 l glass batch reactors for ad and pl sludge respectively and the operational temperature was 35 c glass batch reactors were used to visually verify adequate mixing which was achieved with a magnetic stirring rod and biogas was collected in 2 l biogas run 6 hereafter referred to as the serum bottle test was conducted in serum bottles with the same setup as described in section 2 2 this verification of mixing in glass reactors was conducted because the degradation of organic matter in runs 1 4 was less than expected in the anaerobic batch reactors which were opaque and did not allow for visual observation of mixing 2 4 physicochemical analysis 2 4 1 sample analysis the inoculum feed and content of the reactors were analyzed for total solids ts volatile solids vs total suspended solids tss and volatile suspended solids vss using methods for fs analysis velkushanova et al 2021 cod and soluble cod were determined with hach lange test kits according to the manufacturer s instructions which is based on the american public health association apha standard methods 5220 d ammonium nitrogen nh4 n and total nitrogen tn were measured with hach lange test kits based on apha standards 5400nc and 4500nh3 f respectively alkalinity was determined using the titration method and volatile fatty acids vfa were analysed using a shimadzu 881 compact ic pro ion chromatograph 2 4 2 extracellular polymeric substances eps measurements were performed by the method described by ward et al 2019 the eps concentration and fractions were measured with the size exclusion chromatography organic carbon detection organic nitrogen detection lcocd ond and fiffikus software doc labor dr huber germany was used for the analysis of the different fractions the lc ocd ond chromatogram presents the fraction of the sample according to their molecular weight in the dissolved phase five peaks are generated representing biopolymers 20 000 7 5 1011 g mol humic substances 1000 g mol building blocks 300 500 g mol low molecular weight organics 350 g mol and neutrals including aldehydes and ketones 350 g mol huber et al 2011 jacquin et al 2017 the biopolymer fraction of eps in this study had a low c n ratio 2 7 which indicates that the biopolymers are composed mainly of proteins thus the eps was therefore categorized into protein like biopolymer peak and humic like substances humic acids and building block peak according to jacquin et al 2017 and ward et al 2019 and the total eps was calculated as the sum of the two 2 4 3 eps extraction eps soluble loosely bound was extracted from activated sludge obtained from eawag and from pit latrine fs samples using the na2co3 method described by shambeck et al 2020 and sonication as described in detail by ward et al 2019 followed by centrifugation at 3500 g for 20 min to determine the effect of eps on dewaterability in terms of cst two tests were performed in test a 2 ml of soluble loosely bound eps was added to 10 ml of ad sludge and pl sludge samples and compared to addition of 2 ml of water as a control samples were vortexed for 1 min and cst was measured using the setup described in section 2 4 4 in test b different weights 0 01 0 02 0 05 and 0 1 gs of freeze dried eps was added to 10 ml of ad sludge and pl sludge samples vortexed and cst measured accordingly cst of ad sludge and pl sludge samples were measured prior to and after eps addition 2 4 4 dewaterability sludge dewaterability was assessed by measuring the capillary suction time cst and turbidity of supernatant following centrifugation cst measures the time required for water to pass through a filter paper filterability whereas supernatant turbidity indicates the extent of settleability of the sludge cst was measured in quadruplicates according to methods for fecal sludge analysis velkushanova et al 2021 using the 319 multi cst apparatus instrument from triton electronics ltd uk with an 18 mm funnel supernatant turbidity of centrifuged sludge was measured using 30 ml of sludge and centrifuging at 3000 x g for 20 min in a 50 ml falcon tube the turbidity of the supernatant after centrifugation was determined with a hach tl 2300 turbidity meter 2 4 5 particle size distribution particle size distribution was analyzed using the static light scattering measurement according to ahpa standard method 2560d using a beckman coulter ls 13 320 laser diffraction particle size analyzer liquid samples were gently mixed by pipetting with a pasteur pipette to homogenize the sample without breaking up aggregates and then dispersed for measurement using the universal liquid module which is capable of suspending and analyzing samples in the 0 017 2000 µm size range 2 4 6 microbial community analysis to assess the influence of the microbial community of the different inocula on the bmp test 2 ml sample of each inoculum was centrifuged at 6000 rcf for 10 min the supernatant was discarded and 1 ml of rna later was added to the pellets and stored at 20 c until dna extraction dna was extracted following a modified method by griffiths et al 2000 to each inoculum pellet 0 5 ml of hexadecyltrimethylammonium bromide buffer was added and gently mixed with the sample the mixture was transferred to a 2 ml lysing matrix tube 0 5 ml of phenol chloroform isoamylalcohol pci 25 24 1 ph 6 8 was added after which a fastprep equipment is used to lyse the sludge samples further extraction was carried out with the addition of 0 5 ml of chloroform isoamylalcohol ci 24 1 to each sample nucleic acids were precipitated with polyethylene glycol 6000 on ice and further washed with 70 ethanol before being dissolved in 100 ul of molecular grade water nucleic acid quality and quantity was determined with a nanodrop nd 2000c 16s rrna gene amplicon sequencing was carried out by novogene on an illumina miseq platform based on bacterial and archaeal v4 region raw sequences were analysed within the qiime2 framework taxonomical assignment of the amplicon sequence variants asvs was performed within qiime2 environment with the midas database nierychlo et al 2020 accessed october 2021 based on the relative abundances we plotted the top bacterial phyla for each sample picrust2 douglas et al 2020 was used to predict the functional potential of the microbial communities based on the lowest common ancestor approach where the 16s rrna genes are mapped against a public available genome reference database that allows for prediction of the functional potential 2 4 7 statistical analysis the kendall rank correlation was used to assess the potentially non linear dependencies between the measured parameters and anaerobic storage time a p value below 0 05 was considered statistically significant the same approach was used to determine the correlation between factors that affect dewaterability eps and particle size and the metrics of dewaterability cst and turbidity the data for this study are openly available in eawag repository https doi org 10 25678 0006fp 3 results and discussion 3 1 effect of eps on dewaterability of fecal sludge and wastewater sludge as illustrated in fig 1 the influence of eps on the dewaterability of fs and ad was evaluated by measuring changes in cst with the addition of aliquots of soluble loosely bound fig 1a and freeze dried form of the same soluble loosely bound eps fig 1b that was extracted from fs and activated sludge with two different methods of extraction sonication and na2co3 addition of eps extracted from both fs and activated sludge had the same effect on dewaterability and increasing amounts of eps continued to decrease dewaterability indicated by a high cst this confirms that concentrations of eps can govern dewaterability in fs and that eps from fs and activated sludge have a similar effect ward et al 2019 also reported that fs samples collected in senegal and tanzania had lower dewaterability with higher concentrations of eps an increase in eps results in increased clogging of the filter media thus reducing the dewatering performance as suggested by novak et al 2003 the release of bound eps into solution is expected to decrease sludge dewaterability based on experiences in municipal wastewater where eps increases during activated sludge jia et al 1996 liu and fang 2003 and decreases during anaerobic digestion lei et al 2007 nielsen et al 1996 if eps is the main controller of dewaterability of fs it is expected that anaerobic storage will result in degradation of biopolymers resulting in improved dewaterability 3 2 preliminary bmp tests presented in fig 2 are results of the total biogas production for bmp runs a and b which were conducted to validate fs degradation under anaerobic storage with different inocula results of biogas from the positive controls are presented in table s2 biogas from the ad sludge which is a conventional inoculum for bmp tests was within 86 98 of the theoretical biogas production st sludge had 97 of the theoretical biogas from microcrystalline cellulose cm 59 94 and pl 8 53 a range of field temperatures have been reported for onsite containments for example 22 3 30 7 c for pit latrines in kampala nakagiri et al 2017 30 c for septic tanks in hanoi huynh et al 2021 30 32 c for pit latrines in morogoro tanzania van eekert et al 2019 19 32 c pit latrines in tanzania and vietnam torondel et al 2016 the selection of 20 c and 37 c for the bmp test therefore covers the range of reported temperatures using a feed with 1 2 5 feces to urine ratio the ad inoculum produced similar volumes of biogas at 20 c and 37 c whereas the pl inoculum had higher biogas production at 37 c than 20 c however ts and ammonium concentration may have contributed more to the lower biogas production than temperature as pl sludge had a higher concentration of ts see table 1 that could have resulted in a mass transfer limitation and ammonia inhibition due to concentrations 1 5 g l zuo et al 2021 the bmp test demonstrated that anaerobic degradation of fs was possible irrespective of the inoculum temperature and nh4 n concentration 3 3 microbial community analysis varying biogas production in the bmp tests could also be associated with microbial community as illustrated in fig 3 dominant bacterial phyla observed in all inocula included proteobacteria 12 21 firmicutes 18 35 and bacteroidetes 6 25 while members of chloroflexi were highly abundant in ad 30 st 19 and cm 12 they only made up a small fraction in the pl inoculum 3 this is in agreement with members of proteobacteria firmicutes and bacteriodes being reported as most abundant in fs samples ward et al 2019 while phylum latescibacteria which is present in animal intestines and sediments farag et al 2017 appeared as a dominant phylum in the st inoculum it was absent in all other inocula similarly the phylum deinococcota found mainly in animal feces and intestines murray 2004 was also unique to the cow manure inoculum besides the differences in community composition at the phylum level the different inocula presented significant differences in diversity within the group of methane producing bacteria figure s2 a prediction of the functional potential of the community via a lowest common ancestor approach douglas et al 2020 as illustrated in fig 3b indicates a high degree of functional redundancy despite the differences in community composition it is therefore not surprising that irrespective of the inoculum used fs was degraded to some extent as indicated by the biogas production 3 4 effect of anaerobic storage on dewaterability illustrated in fig 4 a and 4b are the changes in cst s with anaerobic storage time for pl and ad inoculated runs using the kendall rank correlation with a 95 confidence level to test the correlation between cst s and storage time we observed that cst s for both pl and ad inoculated runs generally decreased with anaerobic storage table s3 however the decrease in cst s were only statistically significant p 0 05 for run 5 inoculated with ad and runs 2 and 5 inoculated with pl variations in supernatant turbidity illustrated in fig 4c and 4d for pl and ad inoculated runs showed both a decrease and increase in supernatant turbidity with anaerobic storage reduction in turbidity was only statistically significant for run 5 for pl sludge and runs 3 and 5 for ad sludge a more clear trend in decreasing cst and supernatant turbidity was expected based on the literature sakaveli et al 2021 3 5 influence of anaerobic storage on eps and eps fractions reported in fig 5 a and 5b are eps vss concentration for pl and ad inoculated runs with anaerobic storage time it was observed that for pl inoculated runs in three out of four runs 2 5 and 6 there was decreasing eps vss and in ad inoculum runs five out of six runs 2 3 4 5 and 6 however the reductions were not statistically significant which indicates that there is no preferential degradation of eps over other vss components also illustrated in fig 5c 5d 5e and 5f are the humic like and protein like fractions of the extracted eps with time during anaerobic storage there were no clear trends and changes in humic like substances were statistically significant for only run 2 in the pl inoculated runs and for protein like substances only run 2 in both pl and ad inoculated runs however eps mg l for runs involving both ad and pl shown in fig 6 shows a decrease with time decreasing eps with time in anaerobic storage was expected and agrees with observations by nielsen et al 1996 where anaerobic storage resulted in a reduction in eps however the total reduction was less than expected possibly due to the lower initial concentrations of eps in fs illustrated in fig 6 are the total concentrations of eps as mg l and the specific fractions comprised of protein and humic like substances of eps mg l over the reaction time for runs 2 3 5 and 6 for comparison between ad and pl runs the figure indicates that the fractions of eps were generally degraded with anaerobic storage time with an average reduction of 40 for protein like and 22 for humic like fraction in ad inoculated runs in runs inoculated with pl on the other hand an average of 47 and 33 degradation was observed for protein and humic like substances respectively the decrease in total eps mg l and eps fractions generally did not have a significant correlation with metrics of dewaterability cst using the kendall rank correlation table s5 although degradation is seen in the total eps mg l the extent of degradation is lower relative to anaerobic storage or digestion of activated sludge where a higher reduction of eps is observed however of interest humic like substances in all samples were about twice the concentration of protein like fractions this observation is similar to fs field samples from senegal and tanzania ward et al 2019 but is contrary to wastewater sludges where proteins and carbohydrates constitute a higher fraction of eps neyens et al 2004 indicating that eps from fs is comprised of greater fractions of humics to verify the legitimacy of our observations of high humic like substances in fs eps ftir was performed as a qualitative analysis on the extracted eps together with standard samples of glucose cellulose humic acids and proteins as illustrated in fig 7 peaks representing carboxylic or hydrocarbon containing compounds 1500 1300 cm 1 and carbohydrates 1200 900 cm 1 were clearly evident badireddy et al 2010 a major peak between 1033 and 1086 cm 1 which is attributed to c o stretching of polysaccharides or polysaccharide like substances was seen in all samples except proteins two prominent peaks around 2850 cm 1 and 2919 cm 1 which are aliphatic ch group stretching of fatty acids and long chain structures were seen in all samples zhu and zhao 2011 the spectrum of the extracted eps showed more similarities in peaks with the humic acid and cellulose standard which supports the measurement of higher humic acid concentrations in the extracted eps from fs 3 6 performance of bmp tests and anaerobic batch reactors all inocula in bmp tests were monitored for ph vfa alkalinity and nh4 n concentrations to ensure adequate operating conditions the inocula all had a ph between 7 2 to 8 0 vfa between 0 1 and 1 6 g l acetate nh4 n between 0 8 and 3 3 g l and alkalinity between 2 8 and 9 4 g l caco3 recommendations for bmp test are ph 7 0 and 8 5 vfa 1 g l acetate nh4 n 2 5 g l nh4 n and alkalinity 3 gcaco3 l 1 holliger et al 2016 the percentage of ch4 in biogas was 58 68 anaerobic batch reactors and serum bottle tests were monitored for biogas methane vfa ph alkalinity and reduction in vs and cod biogas was produced in all reactors with methane of 56 70 the vfa alkalinity ratio g l g l caco3 was between 0 09 and 0 31 and ph between 6 85 7 92 average vs and cod reductions were 20 and 30 respectively vs reduction was low expected 50 65 tchobanoglous et al 2014 however the control synthetic wastewater showed a comparable vs reduction of 24 indicating no inhibition in the reactors 3 7 influence of particle size distribution fig 8 illustrates the particle size distribution of samples from the start and end times of reactors inoculated with pl and ad sludge in run 6 and the percentage of particles by volume from 0 4 2000 µm particle size distribution was performed in run 6 to see if it could help explain the dewaterability results in runs 1 5 whiles pl sludge shows multiple peaks at 30 52 and 185 um ad sludge had a unimodal distribution with a peak at 52 µm and a shoulder at 560 µm in the higher particle size range the results indicate that in both ad and pl reactors anaerobic storage resulted in an increase in supracolloidal particles 1 100 µm and a decrease of larger particles during anaerobic storage of wastewater sludge the breakdown of organic matter generates more supracolloidal particles which if not completely utilized are known to have a negative effect on dewaterability higher cst rudolfs and heukelekian 1934 however in this study there was no significant correlation between the supracolloidal particles and the cst or turbidity for both ad and pl inoculated runs table s3 in wastewater sludges tightly bound eps provides binding sites for flocculation which improves dewaterability lin et al 2019 whereas extracted soluble and loosely bound eps in this study represents colloidal and suspended organic substances that affect dewaterability by clogging of filter media ward et al 2019 and not flocculation if extracted soluble and loosely bound eps is being degraded at the same time that small particles are generated it is difficult to know which is contributing more to dewaterability it is possible that the influence of eps on cst is more pronounced than the effect of small particle generation and this is an area for further research 3 8 elucidation the role of eps in dewaterability of fs in this study it was empirically demonstrated that the addition of extracted eps decreases dewaterability however the degradation of eps during anaerobic storage was not as great as expected and the relation to dewaterability was not clear improvement in sludge dewaterability has been reported with both an increase or a decrease in eps liu and fang 2003 shahid et al 2022 houghton and stephenson 2002 argued that an initial increase in eps increases dewaterability but beyond a certain eps threshold dewaterability decreases fractions of eps mainly proteins and carbohydrates have also been reported as having different effects on sludge dewaterability cetin and erdincler 2004 sheng et al 2010 eps concentrations in this study 9 72 mgeps gvss were lower than reported eps concentrations in wastewater sludges using similar methods of extraction 30 and 290 mg gvss caudan et al 2012 comte et al 2006 pellicer nàcher et al 2013 the eps concentration in this study is below the 100 mgeps gtss that has been suggested as a minimum for floc formation jørgensen et al 2017 and rather fits the description of colloidal and suspended organic substances that affect dewaterability by clogging of filter media ward et al 2019 in addition humic like and protein like fractions of eps did not follow clear trends during anaerobic storage or have significant relations to sludge dewaterability but the humic like fractions of eps were consistently greater than for wastewater sludges 4 implications to fecal sludge treatment in this study anaerobic storage of fs did not fit into the well known anaerobic digestion model batstone et al 2002 which predicts 50 60 vs reduction the lower average vs reduction 20 observed in this study indicates that anaerobic degradation of fs follows different kinetics than for wastewater sludges this could be due to inhibitory factors or organic fractions in feces rose et al 2015 which are difficult to degrade and different from biological secondary or blended primary and secondary wastewater sludges further studies should consider the behavior of the less biodegradable organic compounds such as cellulose and lignin during anaerobic storage in addition experiments in this study were based on the general consensus that predominantly anaerobic conditions are present in onsite containments as research in fs increases these conventions are being questioned and purely anaerobic conditions may or may not be totally reflective of onsite containments especially in the surface or border regions shaw and dorea 2021 the presence of anaerobic aerobic and anoxic zones in onsite containments needs to be further investigated in order to understand the degradation kinetics of organics in different layers and predict what is occurring throughout storage in containment with time lópez vázquez et al 2021 5 conclusions to the best of our knowledge this was the first study to evaluate eps concentrations in fs during anaerobic storage in the laboratory and to assess the influence of changing total eps concentrations and fractions on fs dewaterability conclusions from this research include eps has a significant effect on fs dewaterability irrespective of the extraction method or the source of sludge used in this study an increase in eps concentration of the sludges decreased dewaterability fs is different from wastewater sludges meaning knowledge of wastewater treatment performance cannot be directly transferred fundamental differences include lower overall concentrations of eps and greater concentrations of humic like fractions of eps it is clear that eps plays a role in dewaterability of fs however due to the lower than predicted degradation during anaerobic storage the fate of tightly bound loosely bound and humic protein and carbohydrate fractions of eps needs to be further investigated in addition to the contribution of other compounds with water holding capacities anaerobic storage time is not a predictor of particle size distribution other physical properties such as charge density that play a role in dewaterability need to be further investigated differences in degradation of eps and changes in particle size distribution are likely related to variations in microbial community there remains a lack of knowledge of pathways of digestion of fs during storage in containment author contribution sam s b ward b j strande l and morgenroth e contributed to study design all authors provided helpful feedback and suggestions throughout the study sam s b was responsible for experimental design reactor setup collection and analysis of sample ward b j performed particle size distribution analysis niederdorfer r performed the data analysis on microbial community sam s b took the lead in writing the manuscript strande l contributed to data analysis and writing with critical and helpful reviews from all authors strande l conceived the idea obtained funding and supervised the project declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments financial support for this study was provided by the swiss national foundation for scientific research snsf we acknowledge jacqueline traber for helping with eps extraction procedure karin beck and patrick kathriner for helping with dna extraction methods and gas measurement respectively as well as helmut bergmann for the expert advice on the dna extraction the authors would like to thank andreas scheidegger and damian hausherr for the helpful scientific discussions and all the technical staff of the experimental hall eawag in dübendorf supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118915 appendix supplementary materials image application 1 
15671,the calibration and continuous maintenance of hydraulic models is essential for the optimisation planning and management of water distribution networks wdns this process requires model fitting against multiple hydraulic states however when extended time series of hydraulic data are considered it is essential to know which hydraulic states to use for model fitting as too many become computationally impractical this paper presents a novel principal component analysis pca based sampling method which evaluates the significance of newly observed hydraulic data to be included in the model calibration and maintenance a framework is presented which allows for different sized batches of hydraulic data to be utilised this enables both model calibration on extended time series of data or model calibration and maintenance with continuous data an extensive experimental program was conducted to investigate the performance of the proposed framework with different sampling methods compared to other conventional approaches the results demonstrate that the presented sampling methods can maintain and improve model prediction accuracy both for retrospective and concurrent implementations when used with extended time series data which capture different hydraulic states the hydraulic model of the operational wdn used in this study and the acquired hydraulic data are provided as supplementary data to facilitate reproducible research keywords sampling design model fitting parameter estimation machine learning 1 introduction hydraulic models of water distribution networks wdns are an essential tool used by water utilities for operational and management tasks costs reduction and meeting key performance indicators imposed by regulatory bodies in order to reduce the risk of associated operational and investment decisions applications such as advanced pressure control ulanicki et al 2000 wright et al 2014 pump scheduling and demand response jung et al 2015 nerantzis et al 2020 the design for control of wdns pecci et al 2019 ulusoy et al 2020 leakage detection and localisation blocher et al 2020 sanz et al 2016 blockage detection and localisation do et al 2018 pecci et al 2020 and contaminant detection vrachimis et al 2020 must all be supported by accurate hydraulic models the calibration of wdn hydraulic models which consists in aligning model predictions with measurements from the wdn is a well studied area díaz et al 2017 lansey and basnet 1991 reddy et al 1996 savic et al 2009 waldron et al 2020 however hydraulic models may become inaccurate after a certain period of time due to changes in physical attributes or control components consequently a hydraulic model must be maintained over its life span either through periodic calibration or continuous model maintenance to ensure it remains accurate and representative of the wdn when i different control settings are used within the network e g updated pump valve settings ii different network configurations are implemented e g incident response or the use of networks with dynamically configurable connectivity wright et al 2014 and iii a period of higher customer demand is experienced e g industrial users large social gatherings seasonal variations etc model maintenance in particular refers to the practice of continuously updating and validating the hydraulic model thanks to the availability of large quantities of high quality data each of the scenarios above results in hydraulic states which may substantially deviate from the initial set of hydraulic states used for model calibration as a result the inclusion of a larger variety of hydraulic states both for model calibration and continuous model maintenance improves the robustness of a hydraulic model some literature recommends increasing pipe flow velocities using fire flow tests e g walski 1983 however many water utilities e g in the uk do not conduct fire flow tests as these tests are resource intensive time consuming and potentially disruptive e g discolouration events see waldron et al 2021 furthermore it is not feasible to frequently perform fire flow tests to support periodic model calibration or continuous model maintenance in this paper we propose an alternative data sampling method to capture a wider variety of hydraulic states which is based on the passive observation of naturally occurring hydraulic variations in a wdn over an extended period of time advances in pressure sensing and communication technologies allow for the continuous pressure monitoring of wdns with unprecedented spatial and temporal resolution whilst simultaneous development in computing power means that these large datasets can enable and enhance many near real time applications e g brentan et al 2017a 2017b lima et al 2018 romano and kapelan 2014 etc in particular we propose to implement the presented sampling method in a novel approach for continuous model maintenance where the accuracy of a hydraulic model is continuously maintained as data streams from wdns are acquired there are several intrinsic advantages of continuously maintaining a hydraulic model in comparison to periodically recalibrating it firstly recalibrating a wdn using a new dataset does not take advantage of knowledge on state variations included in previous hydraulic data secondly the hydraulic model may not have a good prediction accuracy for dynamic control states e g valve pump settings or topology which were not included in the original model calibration thirdly calibration exercises are time consuming and expensive and they may need to be undertaken by experienced individuals it is therefore preferable to reduce the number of independent model fitting exercises model maintenance is common practice in other sectors e g process engineering matias and jäschke 2019 wise and roginski 2015 and the idea of updating a hydraulic model with newly recorded data has been previously explored as examples see kang and lansey 2009 todini 1999 zhou et al 2018 in particular control theory approaches fit the hydraulic model to measured data over short periods with varying levels of success e g kang and lansey 2009 todini 1999 zhou et al 2018 proposed a self adapting calibration approach using a combination of kalman filters to solve the problem over a longer period however various assumptions about the uncertainty in the measurements and wdn are made the approach requires multiple iterations to converge to a solution and data pre processing is required to handle anomalies e g null data or bursts while different approaches for fitting the hydraulic model against measured data for a fixed dataset have been studied in the literature this paper proposes and investigates a sampling method for the continuous maintenance of hydraulic models in particular the sampling method is independent from the specific optimisation model fitting algorithm used or the applied hydraulic solver in summary we present a flexible analytical framework for the continuous maintenance or periodic calibration of hydraulic models a main novelty of the proposed approach is the sampling method which is applied to identify the best hydraulic states against which to fit a hydraulic model the sampling method uses pca based algorithms to determine the time steps with the largest variety in their hydraulic states such that a representative sample of data is used to train the hydraulic model an anomaly detection method using local outlier factor lof is also implemented to discard samples which are outside the operational conditions and indicative of a failure this work is detailed in appendix a as it is not the main emphasis of the paper moreover the presented method is independent of the chosen model fitting procedure and does not rely on a pre existing hydraulic model thus any parameter estimation method can be used in conjunction with the sampling method another novelty is the proposed tailored sequential convex programming scp algorithm to solve the parameter estimation problem we also apply a data driven demand reallocation method for state estimation the sampling method is demonstrated on an operational wdn with an extended set of specifically acquired hydraulic data available in the supplementary data to illustrate the flexibility of the approach parameter estimation is then performed i as one off model calibration and ii for continuous model maintenance 2 problem formulation in this manuscript we propose a sampling algorithm for the continuous maintenance of hydraulic models which identifies from a time series of hydraulic data the set of time steps t which capture the greatest variation and represent the best set of hydraulic states for the hydraulic model to be fitted against given a new set of time steps t algorithm 1 iteratively updates the current best selection t by evaluating through the choice of the hyperparameters α or β whether it can be sufficiently improved by individual time steps t t the role of sampling hyperparameters α and β is defined in detail in sections 3 2 1 to 3 2 3 the algorithm also checks whether t contains anomalies e g bursts and can discard previously selected time steps made redundant by t the advantage of designing an algorithm which can evaluate individual time steps against the current selected set is the flexibility it offers this includes the full spectrum of options from periodically evaluating large batches of data where t the number of individual time steps t t is large to near real time applications where t approaches 1 furthermore the sampling procedure does not require a hydraulic model hence the more computationally expensive parameter estimation and updating process is only implemented after each time step in t has been considered fig 1 in this manuscript we use the terminology of batch for the full dataset stream when considering t 1 and mini batch for anything in between the continuous model maintenance process starts by initialising t 0 corresponding to the training data computed at a previous implementation of algorithm 1 or as an empty set t 0 algorithm 1 is then applied with the new set of data t and t t 0 producing a sampled t if t differs from t 0 the current model is updated by fitting it against the dataset corresponding to t this process is repeated when a new set t becomes available the accuracy of the model updated with t is evaluated using m v the corresponding maintenance or prediction error of the model on a sub sample of data corresponding to all previous non anomaly time steps v if the model maintains its accuracy over time the maintenance error should remain constant irrespective to changes in the control state the maintenance error can be used to observe if the model is being maintained but also to verify that the most recent model is at least as good as the previous model with maintenance error m v if it is not the updated model can be disregarded as shown in fig 1 there are different ways to define the set of time steps v to compute the maintenance error of the updated model following the execution of the parameter estimation in this work we set v to be a combination of previous non anomaly time steps and where possible non sampled time steps when enough time steps are available it is preferable to keep the training and validation sets independent i e t v in this section we formulate i a parameter estimation problem for fitting the hydraulic model and ii a pca based sampling approach for evaluating new time steps t t against t the stepping functions for evaluating t against t and then the proceeding actions are described in section 3 the anomaly detection method in algorithm 1 is detailed in appendix a note that further data assurance and quality checks may be required when continuous streams of data are available for the continuous maintenance of a hydraulic model 2 1 parameter estimation the described model maintenance approach requires solving a parameter estimation problem to fit the hydraulic model against the measured hydraulic states corresponding to time steps in t a demand driven hydraulic model determines the unknown hydraulic heads h t r n n and flows q t r n p at a time step t t where n n and n p are number of nodes and pipes respectively this assumes that the nodal demands d t r n n and n 0 fixed hydraulic heads h 0 t r n 0 are known at t t in this paper we implement a data driven demand reallocation approach for state estimation the approach analogous to do et al 2018 waldron et al 2020 scales the demand at each node for each time step depending on the ratio between the measured water used in an area and the predicted water used in an area moreover the model considers u t r n v as the vector of known control inputs defined by data for n v control valves at t t we assume that inlet and outlet hydraulic heads as well as flow across the control valves are measured given k 1 n v the control input u k t is calculated as the head loss between inlet and outlet nodes given by 1 u k t h in k t h out k t ϕ k q k t where h in k t and h out k t are the measured hydraulic heads at nodes corresponding to inlet and outlet of control valve k moreover we denote by ϕ k q k t the minor loss across the valve which can be calculated from the measured flow q k t we introduce the link node incidence matrices for both the known and unknown heads denoted by a 12 r n p n n and a 10 r n p n 0 respectively and the link control valve incidence matrix a 13 r n p n v energy and mass conversation is given by 2 φ q t c a 12 h t a 10 h 0 t a 13 u t 0 3 a 12 t q t d t 0 where c r n p is the vector of roughness coefficients and φ q t c is the head loss model usually defined by the hazen williams or darcy weisbach formulae larock et al 1999 unknown hydraulic heads h t t and flows q t t at time t are found using a null space newton method abraham and stoianov 2015 and we define x t h t t q t t t given a vector of roughness coefficients c r n p a unique vector of hydraulic states x t c solves 2 and 3 for all t t hence the considered hydraulic model defines functions c x t c t t and the model error ψ c can be defined as the summation of the squared ℓ 2 norms of the residuals between n y hydraulic measurements and model predictions at each time step given by 4 ψ c 1 2 t t t a x t c y t 2 2 where y t r n y is the vector of hydraulic measurements at time t and a r n y n n n p is the logger node link incidence matrix the nonlinear least squares optimisation problem for parameter estimation is then formulated as follows 5 minimise ψ c c subject to c min c c max where c min c max r enforce the roughness coefficient values to be positive and within a realistic range problem 5 is usually significantly underdetermined as the number of measurements is far fewer than the number of roughness coefficients n p common ways of circumventing this issue include grouping the number of pipes to reduce the number of variables e g kumar et al 2010 mallick et al 2002 or using regularisation with statistical learning techniques to reduce ill posedness waldron et al 2020 in this paper a wider variety of hydraulic states are used to improve the robustness of the solution by utilising naturally occurring variations in a wdn over time a comparison on the effect of pipe grouping and regularisation is also implemented within the results section 2 2 pca the approach for maximising the hydraulic information in the training dataset corresponding to t for algorithm 1 is inspired by early efforts to calibrate wdn hydraulic models which used only a few time steps hydraulic states due to computational constraints of the time small sets of hydraulic states containing the largest variety of flow intensities had to be generated by fire flow tests walski 1983 the underlying assumption of the approach is that over an extended period of time many observed hydraulic states will be similar thus redundant for the purpose of model calibration therefore the aim is to identify the combination of hydraulic states from t t which have the maximum variance between them an approach for maximising the variance whilst reducing the dimensionality of the dataset is pca which is applied in machine learning for linearly reducing the dimensionality of data into uncorrelated components jackson 1991bsemi jolliffe 2002bsemi lee and verleysen 2007bsemi shalizi 2013 chapter 15bsemi james et al 2013 chapter 10 2bsemi etc reducing dimensions improves the interpretability of the data it also allows for less significant components to be discarded which improves the signal to noise ratio in the acquired hydraulic data let h t r n h and q t r n q be vectors of pressure and flow measurements at time step t respectively where n h is the number of pressure loggers and n q is the number of flow meters we then define the vector y t h t t q t t t of length n y n h n q and the n t by n y matrix of hydraulic data for n t time steps y y t 1 y t n t t here both pressure and flow measurements are used in the parameter estimation least squares formulation and we assume that y contains no erroneous or missing data the problem of dealing with erroneous and missing data is subject to future work the objective is to find a unit vector w r n y representing the direction where we can project each y t such that we get the maximum possible variance over the considered n t time steps implementing pca allows us to find w via eigendecomposition on the covariance matrix of y such that 6 σ w λ w 7 w t w 1 where σ represents the covariance matrix of y and λ is an eigenvalue note that w is equivalent to an eigenvector of σ and λ the covariance matrix σ is always a positive definite or positive semi definite matrix of size n y n y hence implying that there are no more than n y eigenvalues or n t n y eigenvalues if σ is singular and that the eigenvalues are non negative pairs of eigenvalues and associated non trivial eigenvectors can be efficiently calculated the symmetric quality of σ also implies that these eigenvectors are orthogonal meaning that each eigenvector corresponds to a different uncorrelated dimension therefore the dimension with the largest eigenvalue λ 1 has the largest variance the dimension with the second largest eigenvalue λ 2 has the second largest variance and so on up to the n y th dimension when reducing high dimensional data into its principal components every additional dimension captures finer variations between time steps while considering too few principal components leads to underfitting on the dataset too many leads to overfitting the problem of determining the appropriate number of non trivial principal components to be used in order to provide a meaningful interpretation of the data has been extensively studied e g cattell 1966 efron 1979 frontier 1976 horn 1965 jackson 1993 jolliffe 2002 peres neto et al 2005 vieira 2012 etc in this paper we implement the kaiser guttman method guttman 1954 kaiser 1991 and define the principal components to be used as λ j j n p c where 8 n p c i λ i 1 i 1 n y let n p c n p c w j be the eigenvector corresponding to the principal component λ j i e 9 σ w j λ j w j j n p c and w r n y n p c be a matrix where each column corresponds to an eigenvector w j for all j n p c then 10 s y w is a n t n p c matrix where each row represents a time step and each column represents a different projection on an orthogonal dimension below we provide an illustration for interpreting the principal components projections s of hydraulic data recorded during the day and the night the reasoning behind this is that at night we see the lowest demand within the wdn thus the pressure and flow data is relatively consistent by using a week of recorded hydraulic data we can ascertain whether this hypothesis yields noticeable similarities when applying pca figure 2 a shows a week of continuous pressure and flow measurements which are extracted from the much larger dataset used in the case study further details are provided in the supplementary data the week is chosen because it is without operational incidents and within normal operating conditions figure 2b shows the projected points on the first two principal components and a clear cluster of the nocturnal hydraulic data is observed which suggests that the variance between the hydraulic data at each time step is directly related to the relative distance between each projected point using this observation we propose a method for updating the time steps chosen for the parameter estimation by utilising the relative distance between the points in the projected space in fig 2b we observe that λ 1 accounts for 98 50 of the total variance this reaffirms empirical knowledge that the daily demand pattern is the main cause for the observed hydraulic variations and is easily identifiable through the first principal component although it may be advantageous to take into account the weighting of each principal component for other applications the main objective for using pca is to be able to identify hydraulic states with small natural variances during each day therefore it is advantageous to consider all n p c principal components with as much interest as the first principal component as they are more likely to represent variations in the data which are not driven purely by the change of demand pattern for this reason we do not consider weightings when evaluating the distances between the projections and we measure the similarity between two vectors of measurements y t i and y t j using the euclidean distance between their projections let d r n t n t be a matrix whose elements are 11 d i j w t y t i y t j 2 i 1 n t j 1 n t note that d is symmetrical and only the lower left triangle needs to be calculated 3 solution methodology in this section we propose a tailored scp algorithm for the solution of the parameter estimation problem 5 we also present and investigate three stepping methods for exploiting the distances between each hydraulic state projection in order to determine the time steps with the largest variance 3 1 sequential convex programming although problem 5 is a non convex non linear program we can compute locally optimal solutions using gradient based optimisation methods in this paper we tailor a sequential convex programming scp algorithm which has been previously applied for solving fault estimation problems in wdns pecci et al 2020 the scp algorithm was chosen for its simple implementation and additional flexibility when considering non smooth objective functions e g ℓ 1 regularisation huber regression etc hence allowing the user to incorporate additional strategies for dealing with noise and ill posedness in the data if required however in this paper we only consider a ℓ 2 formulation for parameter estimation with a data driven demand reallocation approach for state estimation the scp method minimises a convex approximation of the initial objective function from equation 4 within a trust region radius of δ k 0 at iteration k this leads to a new problem being formulated which relies on the solution estimate at iteration k to find the next estimate for k 1 12 minimise 1 2 t t t a x t c k j x t c k c c k y t 2 2 c subject to c c k δ k c min c c max where j x t c k is the jacobian matrix of x t evaluated at c k the algorithm starts with a set value for δ 0 increasing or decreasing the size of δ k 1 by a predetermined factor depending on whether the approximated objective function results in substantial progress eventually the algorithm terminates when either the solution or the relative change in the solution or trust region radius are below a given tolerance all parameters used in this paper are the same as the ones found in algorithm 1 pecci et al 2020 details on how to calculate j x t for both the hazen willams and darcy weisbach roughness coefficients can be found in waldron et al 2020 3 2 stepping methods in this section we propose three algorithms to update the set t given a new time step t t as shown in algorithm 1 by calculating the principal components of t t the euclidean distance between the hydraulic states corresponding to t and any of the hydraulic states in t can be assessed as we sequentially evaluate each time step t from t we take inspiration from stepwise selection methods used in machine learning when deciding whether to add parameters to the model e g james et al 2013 section 6 1 2 i e forward backward and mixed stepping in the context of the hydraulic model maintenance problem it is logical to add time steps as hydraulic data is acquired hence forward stepping is intuitive and the simplest solution however we expect that the ability to remove redundant time steps may be essential thus giving backward and mixed stepping an advantage the operation of adding t to t or removing a hydraulic state from t is described for each stepping method in the following algorithms note that algorithms 2 3 and 4 assume the time steps in the rows of d t r i a l are in chronological order 3 2 1 forward stepping the forward stepping function algorithm 2 takes the arguments t and t and identifies the set of critical time steps c t t which are most similar i e correspond to the shortest distances in d trial in particular the set of critical time steps c computed by algorithm 2 contains the α t 1 2 t time steps in t t which are closest to other time steps where the hyperparameter α defined a priori limits the number of samples added to c the algorithm then checks whether t c excluding t from t if it is note that for a given set t and time step t the larger the hyperparameter α the more likely it is that t c and that t is not included in the updated set t as a result larger values of α which can be seen as a measure of rejection probability result in smaller sets t to illustrate the forward stepping method algorithm 2 was tested on the week of hydraulic data from fig 2a with the output shown in fig 3 this is achieved by proceeding chronologically through the time series as shown in fig 1 and updating t by using algorithm 2 through algorithm 1 figure 3 shows that λ 1 grows with α demonstrating the high correlation between hydraulic data under the same control state this is further illustrated by fig 5 which shows t for each of the α values it is observed that the majority of the time steps added for each value of α are from the first 24 hours of data aside from slight variations on the weekend the next six days are a repeat of the first day as the week of hydraulic data contains no events the dominance of λ 1 should decrease when the wdn is under multiple control states as the correlation between the hydraulic data should then change the forward stepping algorithm delivers a good spread of points across the projected planes however there are drawbacks to the algorithm i once a time step has been added to t it can not be removed ii as t increases the set of critical time steps c grows limiting the chances of a new time step being added observed in the first two hours in fig 5 and iii over an extended period of time the number of time steps added may get very large resulting in impractical computational effort for calibrating the hydraulic model 3 2 2 backward stepping to avoid the drawbacks of forward stepping the problem can be considered conversely specifically remove time steps which are the most similar backward stepping instead of adding time steps which are significantly different this resolves the potential problem of exceeding the computational limits of the calibration solver by including too many time steps in particular the backward stepping algorithm algorithm 3 takes as an input the hyperparameter β which defines the maximum cardinality of t while t β t is added to t when the number of time steps in t reaches β however the algorithm removes from t t the time step which is most similar to the others algorithm 3 achieves this by finding the two projected points which have the shortest distance between them and then removes the hydraulic state which is the closest to any of the remaining points algorithm 3 is also illustrated on the week of data from fig 2a and β is set to the different values of t from fig 3 for comparison producing the output in fig 4 we again initiate t and proceed chronologically through the time series using algorithm 3 through algorithm 1 note that for this situation we can instead initiate t such that t t 1 t β to avoid unnecessarily running the algorithm β times a direct comparison of figures 3 and 4 shows little difference with the backward stepping appearing more sparse however in fig 5 we observe that the sampled time steps are more spread out over the week with a bias towards the end whereas time steps sampled using forward stepping mainly belong to the first day the backward stepping algorithm chooses a good variety of samples over the week of hydraulic data similarly to the forward stepping algorithm moreover algorithm 3 addresses the limitations of algorithm 2 by specifying a maximum cardinality β for t and removing time steps which are too similar thus avoiding bias towards the start of the time series however there are also drawbacks to using backward stepping if β is chosen i too large unnecessary time steps may be included in t i e if β 100 there are 40 redundant time steps if 60 would have produced an equivalent result or ii too small t might not capture the full spectrum of different hydraulic states 3 2 3 mixed stepping by combining the first two algorithms the mixed stepping function algorithm 4 aims to address the main limitations of forward and backward stepping algorithm 4 implements forward stepping until t β and then implements backward stepping from that point onward this removes the issue of redundant time steps being added to t in algorithm 3 however once t β there is still the same underlying drawbacks of backward sampling including the challenge in capturing the full range of hydraulic states although if β is the maximum number of time steps than can be handled by the computer this is more related to the computational limitations when running the parameter estimation than the sampling method 4 case study awnet awnet is a wdn operated by anglian water in the uk fig 6 awnet consists of two district metered areas dmas with approximately 4000 domestic and 200 commercial properties including stables with large water use the wdn has around 50km of mains and an elevation difference of about 20m between its highest and lowest points the hydraulic model of awnet has 1144 nodes 1182 links and one known head node at the inlet to dma 1 represented by h 0 in 2 awnet is a subset of a larger system of cascading dmas such that the inlet of dma 1 is the outlet of a pressure reducing valve prv from an upstream dma and the outlet of dma 2 is the inlet to a prv leading to a downstream dma the two dmas of awnet are also separated by a prv logger 01 all prvs in the system measure flow hence the flows at the inlet outlet and dma boundary are recorded logger 01 f logger 19 and logger 20 the remainder of the loggers shown in fig 6 are pressure loggers five of which are within dma 1 logger 01 i and logger 02 to logger 05 and the other 14 are in dma 2 logger 01 o and logger 06 to logger 18 we consider three months of recorded hydraulic data from the 19 pressure loggers and three flow meters in awnet during this period three significant bursts b1 b2 and b3 occurred at the times and locations shown in fig 6 bursts b1 and b2 were combined into an even larger event which significantly affected customers in the area on 03 feb 2020 as shown in further detail in fig 7 in response to b1 the prv between the two dmas was closed along with a few other local valves to isolate the burst while the boundary valve bv connecting the dmas further up was opened to maintain customer supply in dma 2 however minutes after the bv was opened b2 occurred escalating the scale of the event which resulted in a reduced water service in the area for the remainder of the day the incident on 03 feb 2020 prompted the opening of kept shut boundary valves in the surrounding area in order to deliver water to customers downstream whilst the pipe breaks were being repaired after the pipe breaks were fixed the previously opened boundary valves were all closed except the bv connecting dma 1 and dma 2 which remained unintentionally open for over a month almost exactly a month later another burst b3 occurred in the middle of dma 2 once b3 was fixed an investigation from the water technicians found the open bv which was consequently closed we model the opening and closing of the bv using a time varying head loss model in 2 we consider a new head loss function such that 13 φ q t c t φ q t c δ t where 14 δ j t γ bv is closed 0 otherwise j 1 n p with γ 0 an arbitrarily large number the described events which are summarised in fig 7 are unique in the sense that they were monitored by a large number of sensors in awnet therefore the dataset is particularly useful and representative for the presented framework for model calibration and continuous model maintenance as multiple control states occur over an extended period albeit unintentionally the dataset also includes two loggers affected by data recording issues logger 15 has a brief three hour gap of data on 05 jan 2020 as observed in fig 7 and logger 17 malfunctions from around b1 b2 onward the described sampling method does not explicitly account for null data therefore for this case study the time steps where logger 15 stopped recording are ignored and the data from logger 17 is disregarded completely future work may look at incorporating methods for addressing null data as data streams can have data gaps 5 results the objectives of the paper were to design a framework for the continuous maintenance and improvement of hydraulic models by i identifying desirable hydraulic states for the purpose of fitting a hydraulic model ii determining the hydraulic states by evaluating only hydraulic data without the need of a hydraulic model and iii experimentally validating common calibration maintenance scenarios on a real world case study to illustrate the flexibility of the process described in fig 1 we consider two extreme hydraulic maintenance scenarios alternative options could be considered between these two extreme scenarios based on specific application needs firstly we consider the scenario that a one off calibration exercise is to be performed by a water utility the loggers are deployed for the period described in the case study afterwards the entire dataset is available for the model fitting process t 9409 and the presented sampling and parameter estimation approaches will be used for a single batch calibration secondly we consider the scenario of continuous model maintenance where an accurate hydraulic model is essential for a near real time optimisation task e g pump scheduling dynamically adaptive control etc the time steps are passed into the process one at a time t 1 demonstrating the ability of the method to adapt over time as well as being fast enough to keep up with a new dataset being received every 15 minutes by investigating batch calibration and streaming maintenance scenarios we evaluate how the framework performs in the two extremes of its application the batch scenario demonstrates the performance when handling large datasets and the streaming scenario demonstrates if the computation speed is sufficient to keep up with newly received data the use of mini batches is outside the scope of this paper and a subject of future work as the sampling procedure produces the same selected time steps for both of the testing scenarios we first evaluate the performance of solely the sampling procedure both testing scenarios are subsequently evaluated all computations were performed on matlab r2019b 64 bit on windows 10 enterprise installed on a 2 40 ghz intel xeon cpu e5 2665 with 8 cores the parameter estimation solver scp was implemented in matlab and used gurobi 8 1 1 for the convex optimisation gurobi optimization 2019 a single extended period simulation is needed at each iteration when the objective function and gradients are calculated the hydraulic simulations are performed using the computationally efficient null space newton method for hydraulic analysis abraham and stoianov 2015 the awnet model uses the darcy weisbach head loss model and thus the parameter estimation explicitly uses the derivatives calculated in waldron et al 2020 the pressure data is downsampled to 15 minute time steps to match the flow data a detailed description of awnet and the associated hydraulic data is available in the supplementary material to promote reproducibility 5 1 evaluation of stepping methods the forward backward and mixed stepping methods presented in section 3 2 need either one or both of the hyperparameters α and β to evaluate the effect of the values of α and β different combinations of the hyperparameters are compared in tables 2 and 3 alongside the stepping method procedures we also evaluate a manual sampling method as a comparison of a best alternative approach referred to as manual peak sampling in this strategy the training dataset is initialised to include the first 24 hours of the dataset 97 time steps then we add the measurements corresponding to the time steps of peak demand for the following days excluding days with bursts note that t 97 is a commonly recurring number in the results as we consider a day worth of 15 minute samples from midnight to midnight on the following day in all the experiments with forward backward mixed stepping or manual sampling methods we do not consider pipe grouping and each pipes roughness coefficients is individually calibrated we investigate whether the availability of large datasets with sufficiently varied hydraulic states can be exploited to deal with the underdetermined problem and generate accurate hydraulic models fig 8 provides an illustration of the results from a single sampling experiment forward stepping with α 0 02 with the lof results control changes and principal components also visualised the anomaly detection method lof identified and excluded the bursts shown in figures 6 and 7 with a high level of accuracy discussed further in appendix a this included a pressure related event detected on 25 feb 2020 fig 8 shows the alignment of the lof results with the sampled time steps and hydraulic data for forward stepping with α 0 02 this figure allows us to interpret the results of lof as we can see disturbances in either the pressure and or flow for the locations where incidents have occurred we also recognise the previously observed behaviour of the forward stepping which is sampling at a higher frequency when new control states start notice how small fluctuations between 02 jan 2020 and 10 jan 2020 are also highly sampled furthermore the illustration of the first two principal components demonstrates that different control states bv open closed project onto separates spaces all other sampling results for the rest of the experiments can be found in appendix b 5 2 test 1 batch calibration first we consider the batch calibration of awnet using the sampled time steps corresponding to the different sampling algorithms and hyperparameters and scp for the parameter estimation the total error of the resulting hydraulic model with updated roughness coefficients is then compared with i the initial hydraulic model and hydraulic models calibrated with ii an approach using regularisation and iii an approach using pipe grouping the regularisation approach adds a term to the objective function which penalises deviations from the initial vector of roughness coefficients to reduce the ill posedness of the problem waldron et al 2020 while pipe grouping reduces the number of decision variables to prevent the problem from being underdetermined mallick et al 2002 both of these approaches still use the same scp method to find a new set of roughness coefficients but they instead use a single day of data 24 dec 2019 as a training period for the optimisation the regularisation requires a longer validation period 26 dec 2019 to 29 mar 2020 with the anomalies removed to tune the regularisation hyperparameter we compare the model accuracy using the new roughness coefficients from each experiment on a set of unsampled or anomalous time steps v we call this period the test period the model error ψ t e s t 9409 is calculated analogously to equation 4 and it is used for all different experiments when 9409 time steps of data have been considered furthermore we define two error functions ψ b v c l o s e d and ψ b v o p e n considering two separate subsets of v denoted by v b v c l o s e d and v b v o p e n corresponding to the two different control states the results summarised in table 2 support previous observations about the properties of the different stepping methods discussed in section 3 2 a reduction of α when using forward stepping reduces the chances of a new time step t belonging to the critical time steps c thus increases the number of sampled hydraulic states t algorithm 2 similarly increasing β when using backward stepping directly increases t algorithm 3 the batch calibration results demonstrate the value of using a sampling method in fact across all experiments where stepping methods are used the error ψ t e s t 9409 has similar values which are smaller than those corresponding to the conventional approaches i e using regularisation and pipe grouping moreover sampling strategies resulting in training datasets of the same size as the conventional approaches i e t 97 result in improved model accuracy manual peak sampling achieves a ψ t e s t 9409 value close to the median of the stepping method experiments it also manages to do comparatively well in both of the different control states with only the backward stepping methods performing consistently better the results also demonstrate the issue of forward stepping keeping redundant time steps we observe the backward stepping with t 97 produces a similar level of accuracy to the forward stepping methods despite fitting on considerably fewer hydraulic states moreover the backward stepping does comparatively better when considering similar values of t both the grouping and regularisation methods aim to mitigate the ill posedness of the parameter estimation problem and thus provide more robust solutions which can perform better under multiple hydraulic states however although they both made a significant improvement in ψ t e s t 9409 compared to the initial model they resulted in lower accuracy compared to the sampling approaches this is further illustrated in fig 9 which compares the prediction error from the two control state periods as cumulative distribution functions cdfs of the test error values ψ b v c l o s e d and ψ b v o p e n over time steps v b v c l o s e d and v b v o p e n respectively in fig 9 it can be observed that both the manual peak sampling and the stepping methods show the smaller error values over both control states whilst using regularisation on a single day provides a good solution for when the bv is closed it struggles to improve at all from the initial model when the bv opens this can be attributed to the fact that the training day is only in the bv closed control state and although the validation period includes the bv open control state this does not improve the prediction performance the grouping approach results in a solution which improves significantly on the initial model and remains consistent over both control states this reaffirms the robustness of the solution when pipe grouping is used and why it is the most appropriate approach when there is a limited quantity of data over a wide variety of hydraulic states however for the purposes of this case study the results demonstrate the benefits of using a sampling approach as a significant improvement can be made to the hydraulic model accuracy without the need for pipe grouping or fire flow tests 5 3 test 2 streaming maintenance the results from table 2 and fig 9 have already demonstrated that a sampling approach which retrospectively evaluates a large set of hydraulic data is effective when performing an initial calibration exercise now we investigate the potential of using a sampling approach with a data stream for updating a model and keeping it maintained unlike batch calibration this scenario does not allow us to directly compare sampling with grouping or regularisation as extending traditional approaches to streaming model maintenance is not straightforward in particular updating the model with a stream using grouping considering all past time steps requires solving increasingly large calibration problems at every new time step hence we instead implement the same sampling experiments with grouping applied to determine if there are any benefits to using it the averaged results are shown below with the full grouping results for each experiment available in appendix b the regularisation strategy proposed in waldron et al 2020 on the other hand requires the availability of a large dataset for training and validation which is not always available in a data streaming framework additionally the extra computation required for tuning the regularisation parameter becomes impractical in the time frame between newly recorded hydraulic data therefore we do not consider the regularisation approach for the streaming maintenance scenario the results from these experiments are shown in table 3 here the test period is the same as the batch test period i e all non anomalous and non sampled time steps and ψ t e s t 9409 represents the final error over the test period at the end of an experiment the test error is also evaluated at each time step throughout and the mean is denoted by ψ t e s t a direct comparison of the ψ t e s t 9409 values from tables 2 and 3 justifies the use of the proposed framework from fig 1 as the streaming results are generally lower than the batch results hence continuously updating the model using a stream of hydraulic data results in hydraulic models that are as accurate as those obtained with a batch calibration approach alongside ψ t e s t 9409 we also consider the mean test error over the course of each experiment ψ t e s t the stepping methods with the lowest ψ t e s t value are shown alongside the other calibration approaches in fig 10 note that test errors can only be calculated retrospectively and if the methodology is being used in streaming maintenance only the maintenance error is observable the maintenance error is calculated on all previous non anomalous time steps v after each model update and is representative of the hydraulic data in t at that point in time as v s t r e a m is representative of previously observed hydraulic conditions the maintenance error remains relatively constant throughout this is observed in fig 10 as well as ψ t e s t over time in fig 10 we observe from the maintenance error that each experiment gave a similar prediction accuracy on the acquired hydraulic data as the experiment progressed moreover these results highlight the benefits of the approach as the prediction accuracy is maintained even when different control states are considered therefore the model is continuously maintained as new significant variations in the hydraulic data are considered in the model fitting process however ψ t e s t which is evaluated a posteriori on the entire test period is a better indication of the true model error and we generally observe that it is much higher when only one control state is considered dropping dramatically as soon as the second control state begins this is not the case for the results obtained using sampling with grouping which quickly converges to an improved solution and then remains constant over the course of the rest of the experiment this once again demonstrates that in a situation with limited hydraulic data grouping is an effective way to achieve an improved robust solution across all hydraulic conditions the manual peak sampling finishes with a similarly accurate hydraulic model as the stepping methods however unlike these methods the manual peak sampling experiment struggles to improve the quality of its solution over the course of the first control state period hence the larger value for ψ t e s t in table 3 it then requires a longer time to improve the accuracy of its solution when the second control state begins this gives the stepping methods a significant advantage if the methodology wants to be implemented as a stream furthermore when using the stepping methods we observe ψ t e s t decreasing over the first control state before the second control state is considered demonstrating its worth if only one control state is planned for the foreseeable future all of the stepping methods outperform the other calibration approaches and all of them improve albeit to different extents the accuracy of the hydraulic model over the course of the first control state period however from fig 10 we observe that the experiments using the backward stepping algorithm do significantly better than the forward stepping result furthermore table 3 shows that backward stepping outperforms forward stepping in all experiments this can be attributed to the several factors i the bias the forward stepping shows at the start of its sampling process ii when forward stepping updates only a single hydraulic state is added at a time whereas backward stepping removes a state also changing the solution space by a larger amount and iii backward stepping results in a large m providing more opportunity to find an improved solution these points are further investigated considering the temporal differences of ψ t e s t with respect to time to calculate cumulative absolute change in the test error ψ t such that 15 ψ t i 2 t ψ t e s t i ψ t e s t i 1 the metric ψ t which measures the sum of differences in ψ t e s t before and after an update is an indication of how much the hydraulic model has changed up to time step t the variable ψ is plotted against time from the second day onward for all experiments in fig 11 the first 24 hours are removed as we evaluate the period of improvement after the first day in fig 11 we observe that the experiments using the backward stepping algorithm have a much higher rate of change than the other experiments as previously stated this gives them more opportunities to overcome the ill posedness caused by the nonconvex nature of the problem thus explaining why the experiments using backward stepping generally have a better prediction accuracy therefore using backward stepping or mixed stepping with a small α value is considered preferable the results from the streaming testing scenario demonstrate the potential of the approach for continuously maintaining a hydraulic model this complements the results from using the procedure for a batch calibration exercise demonstrating the flexibility of the framework a full set of figures analogous to fig 10 for each sampling experiment can be found in appendix b 6 conclusion water utilities have become increasingly reliant on the application of hydraulic models to optimise the performance of their water supply systems and assets therefore it is critical that hydraulic models are efficiently calibrated and continuously maintained this process can be facilitated with recent advances in pressure sensing and communication technologies which result in the continuous acquisition of hydraulic data with high spatial and temporal resolution the paper presents an analytical framework for the calibration and continuous maintenance of hydraulic models for wdns the framework combines novel pca based sampling methods to identify the best hydraulic states to fit a hydraulic model against and a tailored scp algorithm for solving the parameter estimation problem furthermore the stepping methods sample the data without requiring a hydraulic model the flexibility of the presented methodology allows for its application with data batches of different sizes thus being a robust approach for one off calibration exercises or for continuous hydraulic model maintenance the batch calibration results using sampling achieve a higher prediction accuracy than conventional methods especially when considering more than one control state fig 9 this demonstrates the importance of considering a wider variety of hydraulic states to get the best possible hydraulic model thus by utilising fire flow tests or observed events such as the one in the case study a more robust model is achieved from a wider variety of hydraulic states the streaming maintenance results demonstrate the method can be used concurrently with a parameter estimation method for initial calibration and then continuous hydraulic model maintenance furthermore the stepping method experiments show an improvement in the model over time even when only one control state is considered this demonstrates the applicability of using the sampling method with a model fitting approach in conjunction with other near real time applications the results also demonstrate that using pipe grouping provides robust solutions over multiple control states making it the preferred tool when limited hydraulic data is available when the use of sampling is possible the ease of interpretability of the hyperparameter β and the removable of the bias towards the start of the sampling means that backward stepping or mixed stepping with a small α value is preferable furthermore forward stepping and manual peak sampling share the issue of having no upper limit for t making them unsuitable over much longer periods future work should include the addition of a more comprehensive demand estimation model within the sampling process which could improve the model accuracy quantifying demand changes over time also has the potential to generate a larger number of independent hydraulic states e g steffelbauer et al 2020 in addition specifically designed control states within wdns with dynamically adaptive network connectivity and hydraulic control may be used to generate a wider range of hydraulic states the pca projections could then be clustered by control state e g the distinct clusters in fig 8 to be used for identifying unintentional network connectivity changes such as the accidental bv left open in the case study the extensive experimental research which we include in this paper demonstrates that the problem of calibration and continuous maintenance of hydraulic models for water distribution networks is non trivial the results indicate that the developed method for determining hydraulic states with large variety combined with a computationally efficient optimisation method present a significant step forward towards enabling water utilities to effectively and efficiently calibrate and maintain their hydraulic models based on the increased spatial and temporal resolution of acquired hydraulic data declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by epsrc ep p004229 1 dynamically adaptive and resilient water supply networks for a sustainable future ep l016826 1 centre for doctoral training in sustainable civil engineering and anglian water supplementary material the awnet case study and associated data is available online at http doi org 10 17632 9xbjcg6w5s supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118905 appendix a supplementary materials supplementary data s1 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s1 supplementary data s2 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s2 
15671,the calibration and continuous maintenance of hydraulic models is essential for the optimisation planning and management of water distribution networks wdns this process requires model fitting against multiple hydraulic states however when extended time series of hydraulic data are considered it is essential to know which hydraulic states to use for model fitting as too many become computationally impractical this paper presents a novel principal component analysis pca based sampling method which evaluates the significance of newly observed hydraulic data to be included in the model calibration and maintenance a framework is presented which allows for different sized batches of hydraulic data to be utilised this enables both model calibration on extended time series of data or model calibration and maintenance with continuous data an extensive experimental program was conducted to investigate the performance of the proposed framework with different sampling methods compared to other conventional approaches the results demonstrate that the presented sampling methods can maintain and improve model prediction accuracy both for retrospective and concurrent implementations when used with extended time series data which capture different hydraulic states the hydraulic model of the operational wdn used in this study and the acquired hydraulic data are provided as supplementary data to facilitate reproducible research keywords sampling design model fitting parameter estimation machine learning 1 introduction hydraulic models of water distribution networks wdns are an essential tool used by water utilities for operational and management tasks costs reduction and meeting key performance indicators imposed by regulatory bodies in order to reduce the risk of associated operational and investment decisions applications such as advanced pressure control ulanicki et al 2000 wright et al 2014 pump scheduling and demand response jung et al 2015 nerantzis et al 2020 the design for control of wdns pecci et al 2019 ulusoy et al 2020 leakage detection and localisation blocher et al 2020 sanz et al 2016 blockage detection and localisation do et al 2018 pecci et al 2020 and contaminant detection vrachimis et al 2020 must all be supported by accurate hydraulic models the calibration of wdn hydraulic models which consists in aligning model predictions with measurements from the wdn is a well studied area díaz et al 2017 lansey and basnet 1991 reddy et al 1996 savic et al 2009 waldron et al 2020 however hydraulic models may become inaccurate after a certain period of time due to changes in physical attributes or control components consequently a hydraulic model must be maintained over its life span either through periodic calibration or continuous model maintenance to ensure it remains accurate and representative of the wdn when i different control settings are used within the network e g updated pump valve settings ii different network configurations are implemented e g incident response or the use of networks with dynamically configurable connectivity wright et al 2014 and iii a period of higher customer demand is experienced e g industrial users large social gatherings seasonal variations etc model maintenance in particular refers to the practice of continuously updating and validating the hydraulic model thanks to the availability of large quantities of high quality data each of the scenarios above results in hydraulic states which may substantially deviate from the initial set of hydraulic states used for model calibration as a result the inclusion of a larger variety of hydraulic states both for model calibration and continuous model maintenance improves the robustness of a hydraulic model some literature recommends increasing pipe flow velocities using fire flow tests e g walski 1983 however many water utilities e g in the uk do not conduct fire flow tests as these tests are resource intensive time consuming and potentially disruptive e g discolouration events see waldron et al 2021 furthermore it is not feasible to frequently perform fire flow tests to support periodic model calibration or continuous model maintenance in this paper we propose an alternative data sampling method to capture a wider variety of hydraulic states which is based on the passive observation of naturally occurring hydraulic variations in a wdn over an extended period of time advances in pressure sensing and communication technologies allow for the continuous pressure monitoring of wdns with unprecedented spatial and temporal resolution whilst simultaneous development in computing power means that these large datasets can enable and enhance many near real time applications e g brentan et al 2017a 2017b lima et al 2018 romano and kapelan 2014 etc in particular we propose to implement the presented sampling method in a novel approach for continuous model maintenance where the accuracy of a hydraulic model is continuously maintained as data streams from wdns are acquired there are several intrinsic advantages of continuously maintaining a hydraulic model in comparison to periodically recalibrating it firstly recalibrating a wdn using a new dataset does not take advantage of knowledge on state variations included in previous hydraulic data secondly the hydraulic model may not have a good prediction accuracy for dynamic control states e g valve pump settings or topology which were not included in the original model calibration thirdly calibration exercises are time consuming and expensive and they may need to be undertaken by experienced individuals it is therefore preferable to reduce the number of independent model fitting exercises model maintenance is common practice in other sectors e g process engineering matias and jäschke 2019 wise and roginski 2015 and the idea of updating a hydraulic model with newly recorded data has been previously explored as examples see kang and lansey 2009 todini 1999 zhou et al 2018 in particular control theory approaches fit the hydraulic model to measured data over short periods with varying levels of success e g kang and lansey 2009 todini 1999 zhou et al 2018 proposed a self adapting calibration approach using a combination of kalman filters to solve the problem over a longer period however various assumptions about the uncertainty in the measurements and wdn are made the approach requires multiple iterations to converge to a solution and data pre processing is required to handle anomalies e g null data or bursts while different approaches for fitting the hydraulic model against measured data for a fixed dataset have been studied in the literature this paper proposes and investigates a sampling method for the continuous maintenance of hydraulic models in particular the sampling method is independent from the specific optimisation model fitting algorithm used or the applied hydraulic solver in summary we present a flexible analytical framework for the continuous maintenance or periodic calibration of hydraulic models a main novelty of the proposed approach is the sampling method which is applied to identify the best hydraulic states against which to fit a hydraulic model the sampling method uses pca based algorithms to determine the time steps with the largest variety in their hydraulic states such that a representative sample of data is used to train the hydraulic model an anomaly detection method using local outlier factor lof is also implemented to discard samples which are outside the operational conditions and indicative of a failure this work is detailed in appendix a as it is not the main emphasis of the paper moreover the presented method is independent of the chosen model fitting procedure and does not rely on a pre existing hydraulic model thus any parameter estimation method can be used in conjunction with the sampling method another novelty is the proposed tailored sequential convex programming scp algorithm to solve the parameter estimation problem we also apply a data driven demand reallocation method for state estimation the sampling method is demonstrated on an operational wdn with an extended set of specifically acquired hydraulic data available in the supplementary data to illustrate the flexibility of the approach parameter estimation is then performed i as one off model calibration and ii for continuous model maintenance 2 problem formulation in this manuscript we propose a sampling algorithm for the continuous maintenance of hydraulic models which identifies from a time series of hydraulic data the set of time steps t which capture the greatest variation and represent the best set of hydraulic states for the hydraulic model to be fitted against given a new set of time steps t algorithm 1 iteratively updates the current best selection t by evaluating through the choice of the hyperparameters α or β whether it can be sufficiently improved by individual time steps t t the role of sampling hyperparameters α and β is defined in detail in sections 3 2 1 to 3 2 3 the algorithm also checks whether t contains anomalies e g bursts and can discard previously selected time steps made redundant by t the advantage of designing an algorithm which can evaluate individual time steps against the current selected set is the flexibility it offers this includes the full spectrum of options from periodically evaluating large batches of data where t the number of individual time steps t t is large to near real time applications where t approaches 1 furthermore the sampling procedure does not require a hydraulic model hence the more computationally expensive parameter estimation and updating process is only implemented after each time step in t has been considered fig 1 in this manuscript we use the terminology of batch for the full dataset stream when considering t 1 and mini batch for anything in between the continuous model maintenance process starts by initialising t 0 corresponding to the training data computed at a previous implementation of algorithm 1 or as an empty set t 0 algorithm 1 is then applied with the new set of data t and t t 0 producing a sampled t if t differs from t 0 the current model is updated by fitting it against the dataset corresponding to t this process is repeated when a new set t becomes available the accuracy of the model updated with t is evaluated using m v the corresponding maintenance or prediction error of the model on a sub sample of data corresponding to all previous non anomaly time steps v if the model maintains its accuracy over time the maintenance error should remain constant irrespective to changes in the control state the maintenance error can be used to observe if the model is being maintained but also to verify that the most recent model is at least as good as the previous model with maintenance error m v if it is not the updated model can be disregarded as shown in fig 1 there are different ways to define the set of time steps v to compute the maintenance error of the updated model following the execution of the parameter estimation in this work we set v to be a combination of previous non anomaly time steps and where possible non sampled time steps when enough time steps are available it is preferable to keep the training and validation sets independent i e t v in this section we formulate i a parameter estimation problem for fitting the hydraulic model and ii a pca based sampling approach for evaluating new time steps t t against t the stepping functions for evaluating t against t and then the proceeding actions are described in section 3 the anomaly detection method in algorithm 1 is detailed in appendix a note that further data assurance and quality checks may be required when continuous streams of data are available for the continuous maintenance of a hydraulic model 2 1 parameter estimation the described model maintenance approach requires solving a parameter estimation problem to fit the hydraulic model against the measured hydraulic states corresponding to time steps in t a demand driven hydraulic model determines the unknown hydraulic heads h t r n n and flows q t r n p at a time step t t where n n and n p are number of nodes and pipes respectively this assumes that the nodal demands d t r n n and n 0 fixed hydraulic heads h 0 t r n 0 are known at t t in this paper we implement a data driven demand reallocation approach for state estimation the approach analogous to do et al 2018 waldron et al 2020 scales the demand at each node for each time step depending on the ratio between the measured water used in an area and the predicted water used in an area moreover the model considers u t r n v as the vector of known control inputs defined by data for n v control valves at t t we assume that inlet and outlet hydraulic heads as well as flow across the control valves are measured given k 1 n v the control input u k t is calculated as the head loss between inlet and outlet nodes given by 1 u k t h in k t h out k t ϕ k q k t where h in k t and h out k t are the measured hydraulic heads at nodes corresponding to inlet and outlet of control valve k moreover we denote by ϕ k q k t the minor loss across the valve which can be calculated from the measured flow q k t we introduce the link node incidence matrices for both the known and unknown heads denoted by a 12 r n p n n and a 10 r n p n 0 respectively and the link control valve incidence matrix a 13 r n p n v energy and mass conversation is given by 2 φ q t c a 12 h t a 10 h 0 t a 13 u t 0 3 a 12 t q t d t 0 where c r n p is the vector of roughness coefficients and φ q t c is the head loss model usually defined by the hazen williams or darcy weisbach formulae larock et al 1999 unknown hydraulic heads h t t and flows q t t at time t are found using a null space newton method abraham and stoianov 2015 and we define x t h t t q t t t given a vector of roughness coefficients c r n p a unique vector of hydraulic states x t c solves 2 and 3 for all t t hence the considered hydraulic model defines functions c x t c t t and the model error ψ c can be defined as the summation of the squared ℓ 2 norms of the residuals between n y hydraulic measurements and model predictions at each time step given by 4 ψ c 1 2 t t t a x t c y t 2 2 where y t r n y is the vector of hydraulic measurements at time t and a r n y n n n p is the logger node link incidence matrix the nonlinear least squares optimisation problem for parameter estimation is then formulated as follows 5 minimise ψ c c subject to c min c c max where c min c max r enforce the roughness coefficient values to be positive and within a realistic range problem 5 is usually significantly underdetermined as the number of measurements is far fewer than the number of roughness coefficients n p common ways of circumventing this issue include grouping the number of pipes to reduce the number of variables e g kumar et al 2010 mallick et al 2002 or using regularisation with statistical learning techniques to reduce ill posedness waldron et al 2020 in this paper a wider variety of hydraulic states are used to improve the robustness of the solution by utilising naturally occurring variations in a wdn over time a comparison on the effect of pipe grouping and regularisation is also implemented within the results section 2 2 pca the approach for maximising the hydraulic information in the training dataset corresponding to t for algorithm 1 is inspired by early efforts to calibrate wdn hydraulic models which used only a few time steps hydraulic states due to computational constraints of the time small sets of hydraulic states containing the largest variety of flow intensities had to be generated by fire flow tests walski 1983 the underlying assumption of the approach is that over an extended period of time many observed hydraulic states will be similar thus redundant for the purpose of model calibration therefore the aim is to identify the combination of hydraulic states from t t which have the maximum variance between them an approach for maximising the variance whilst reducing the dimensionality of the dataset is pca which is applied in machine learning for linearly reducing the dimensionality of data into uncorrelated components jackson 1991bsemi jolliffe 2002bsemi lee and verleysen 2007bsemi shalizi 2013 chapter 15bsemi james et al 2013 chapter 10 2bsemi etc reducing dimensions improves the interpretability of the data it also allows for less significant components to be discarded which improves the signal to noise ratio in the acquired hydraulic data let h t r n h and q t r n q be vectors of pressure and flow measurements at time step t respectively where n h is the number of pressure loggers and n q is the number of flow meters we then define the vector y t h t t q t t t of length n y n h n q and the n t by n y matrix of hydraulic data for n t time steps y y t 1 y t n t t here both pressure and flow measurements are used in the parameter estimation least squares formulation and we assume that y contains no erroneous or missing data the problem of dealing with erroneous and missing data is subject to future work the objective is to find a unit vector w r n y representing the direction where we can project each y t such that we get the maximum possible variance over the considered n t time steps implementing pca allows us to find w via eigendecomposition on the covariance matrix of y such that 6 σ w λ w 7 w t w 1 where σ represents the covariance matrix of y and λ is an eigenvalue note that w is equivalent to an eigenvector of σ and λ the covariance matrix σ is always a positive definite or positive semi definite matrix of size n y n y hence implying that there are no more than n y eigenvalues or n t n y eigenvalues if σ is singular and that the eigenvalues are non negative pairs of eigenvalues and associated non trivial eigenvectors can be efficiently calculated the symmetric quality of σ also implies that these eigenvectors are orthogonal meaning that each eigenvector corresponds to a different uncorrelated dimension therefore the dimension with the largest eigenvalue λ 1 has the largest variance the dimension with the second largest eigenvalue λ 2 has the second largest variance and so on up to the n y th dimension when reducing high dimensional data into its principal components every additional dimension captures finer variations between time steps while considering too few principal components leads to underfitting on the dataset too many leads to overfitting the problem of determining the appropriate number of non trivial principal components to be used in order to provide a meaningful interpretation of the data has been extensively studied e g cattell 1966 efron 1979 frontier 1976 horn 1965 jackson 1993 jolliffe 2002 peres neto et al 2005 vieira 2012 etc in this paper we implement the kaiser guttman method guttman 1954 kaiser 1991 and define the principal components to be used as λ j j n p c where 8 n p c i λ i 1 i 1 n y let n p c n p c w j be the eigenvector corresponding to the principal component λ j i e 9 σ w j λ j w j j n p c and w r n y n p c be a matrix where each column corresponds to an eigenvector w j for all j n p c then 10 s y w is a n t n p c matrix where each row represents a time step and each column represents a different projection on an orthogonal dimension below we provide an illustration for interpreting the principal components projections s of hydraulic data recorded during the day and the night the reasoning behind this is that at night we see the lowest demand within the wdn thus the pressure and flow data is relatively consistent by using a week of recorded hydraulic data we can ascertain whether this hypothesis yields noticeable similarities when applying pca figure 2 a shows a week of continuous pressure and flow measurements which are extracted from the much larger dataset used in the case study further details are provided in the supplementary data the week is chosen because it is without operational incidents and within normal operating conditions figure 2b shows the projected points on the first two principal components and a clear cluster of the nocturnal hydraulic data is observed which suggests that the variance between the hydraulic data at each time step is directly related to the relative distance between each projected point using this observation we propose a method for updating the time steps chosen for the parameter estimation by utilising the relative distance between the points in the projected space in fig 2b we observe that λ 1 accounts for 98 50 of the total variance this reaffirms empirical knowledge that the daily demand pattern is the main cause for the observed hydraulic variations and is easily identifiable through the first principal component although it may be advantageous to take into account the weighting of each principal component for other applications the main objective for using pca is to be able to identify hydraulic states with small natural variances during each day therefore it is advantageous to consider all n p c principal components with as much interest as the first principal component as they are more likely to represent variations in the data which are not driven purely by the change of demand pattern for this reason we do not consider weightings when evaluating the distances between the projections and we measure the similarity between two vectors of measurements y t i and y t j using the euclidean distance between their projections let d r n t n t be a matrix whose elements are 11 d i j w t y t i y t j 2 i 1 n t j 1 n t note that d is symmetrical and only the lower left triangle needs to be calculated 3 solution methodology in this section we propose a tailored scp algorithm for the solution of the parameter estimation problem 5 we also present and investigate three stepping methods for exploiting the distances between each hydraulic state projection in order to determine the time steps with the largest variance 3 1 sequential convex programming although problem 5 is a non convex non linear program we can compute locally optimal solutions using gradient based optimisation methods in this paper we tailor a sequential convex programming scp algorithm which has been previously applied for solving fault estimation problems in wdns pecci et al 2020 the scp algorithm was chosen for its simple implementation and additional flexibility when considering non smooth objective functions e g ℓ 1 regularisation huber regression etc hence allowing the user to incorporate additional strategies for dealing with noise and ill posedness in the data if required however in this paper we only consider a ℓ 2 formulation for parameter estimation with a data driven demand reallocation approach for state estimation the scp method minimises a convex approximation of the initial objective function from equation 4 within a trust region radius of δ k 0 at iteration k this leads to a new problem being formulated which relies on the solution estimate at iteration k to find the next estimate for k 1 12 minimise 1 2 t t t a x t c k j x t c k c c k y t 2 2 c subject to c c k δ k c min c c max where j x t c k is the jacobian matrix of x t evaluated at c k the algorithm starts with a set value for δ 0 increasing or decreasing the size of δ k 1 by a predetermined factor depending on whether the approximated objective function results in substantial progress eventually the algorithm terminates when either the solution or the relative change in the solution or trust region radius are below a given tolerance all parameters used in this paper are the same as the ones found in algorithm 1 pecci et al 2020 details on how to calculate j x t for both the hazen willams and darcy weisbach roughness coefficients can be found in waldron et al 2020 3 2 stepping methods in this section we propose three algorithms to update the set t given a new time step t t as shown in algorithm 1 by calculating the principal components of t t the euclidean distance between the hydraulic states corresponding to t and any of the hydraulic states in t can be assessed as we sequentially evaluate each time step t from t we take inspiration from stepwise selection methods used in machine learning when deciding whether to add parameters to the model e g james et al 2013 section 6 1 2 i e forward backward and mixed stepping in the context of the hydraulic model maintenance problem it is logical to add time steps as hydraulic data is acquired hence forward stepping is intuitive and the simplest solution however we expect that the ability to remove redundant time steps may be essential thus giving backward and mixed stepping an advantage the operation of adding t to t or removing a hydraulic state from t is described for each stepping method in the following algorithms note that algorithms 2 3 and 4 assume the time steps in the rows of d t r i a l are in chronological order 3 2 1 forward stepping the forward stepping function algorithm 2 takes the arguments t and t and identifies the set of critical time steps c t t which are most similar i e correspond to the shortest distances in d trial in particular the set of critical time steps c computed by algorithm 2 contains the α t 1 2 t time steps in t t which are closest to other time steps where the hyperparameter α defined a priori limits the number of samples added to c the algorithm then checks whether t c excluding t from t if it is note that for a given set t and time step t the larger the hyperparameter α the more likely it is that t c and that t is not included in the updated set t as a result larger values of α which can be seen as a measure of rejection probability result in smaller sets t to illustrate the forward stepping method algorithm 2 was tested on the week of hydraulic data from fig 2a with the output shown in fig 3 this is achieved by proceeding chronologically through the time series as shown in fig 1 and updating t by using algorithm 2 through algorithm 1 figure 3 shows that λ 1 grows with α demonstrating the high correlation between hydraulic data under the same control state this is further illustrated by fig 5 which shows t for each of the α values it is observed that the majority of the time steps added for each value of α are from the first 24 hours of data aside from slight variations on the weekend the next six days are a repeat of the first day as the week of hydraulic data contains no events the dominance of λ 1 should decrease when the wdn is under multiple control states as the correlation between the hydraulic data should then change the forward stepping algorithm delivers a good spread of points across the projected planes however there are drawbacks to the algorithm i once a time step has been added to t it can not be removed ii as t increases the set of critical time steps c grows limiting the chances of a new time step being added observed in the first two hours in fig 5 and iii over an extended period of time the number of time steps added may get very large resulting in impractical computational effort for calibrating the hydraulic model 3 2 2 backward stepping to avoid the drawbacks of forward stepping the problem can be considered conversely specifically remove time steps which are the most similar backward stepping instead of adding time steps which are significantly different this resolves the potential problem of exceeding the computational limits of the calibration solver by including too many time steps in particular the backward stepping algorithm algorithm 3 takes as an input the hyperparameter β which defines the maximum cardinality of t while t β t is added to t when the number of time steps in t reaches β however the algorithm removes from t t the time step which is most similar to the others algorithm 3 achieves this by finding the two projected points which have the shortest distance between them and then removes the hydraulic state which is the closest to any of the remaining points algorithm 3 is also illustrated on the week of data from fig 2a and β is set to the different values of t from fig 3 for comparison producing the output in fig 4 we again initiate t and proceed chronologically through the time series using algorithm 3 through algorithm 1 note that for this situation we can instead initiate t such that t t 1 t β to avoid unnecessarily running the algorithm β times a direct comparison of figures 3 and 4 shows little difference with the backward stepping appearing more sparse however in fig 5 we observe that the sampled time steps are more spread out over the week with a bias towards the end whereas time steps sampled using forward stepping mainly belong to the first day the backward stepping algorithm chooses a good variety of samples over the week of hydraulic data similarly to the forward stepping algorithm moreover algorithm 3 addresses the limitations of algorithm 2 by specifying a maximum cardinality β for t and removing time steps which are too similar thus avoiding bias towards the start of the time series however there are also drawbacks to using backward stepping if β is chosen i too large unnecessary time steps may be included in t i e if β 100 there are 40 redundant time steps if 60 would have produced an equivalent result or ii too small t might not capture the full spectrum of different hydraulic states 3 2 3 mixed stepping by combining the first two algorithms the mixed stepping function algorithm 4 aims to address the main limitations of forward and backward stepping algorithm 4 implements forward stepping until t β and then implements backward stepping from that point onward this removes the issue of redundant time steps being added to t in algorithm 3 however once t β there is still the same underlying drawbacks of backward sampling including the challenge in capturing the full range of hydraulic states although if β is the maximum number of time steps than can be handled by the computer this is more related to the computational limitations when running the parameter estimation than the sampling method 4 case study awnet awnet is a wdn operated by anglian water in the uk fig 6 awnet consists of two district metered areas dmas with approximately 4000 domestic and 200 commercial properties including stables with large water use the wdn has around 50km of mains and an elevation difference of about 20m between its highest and lowest points the hydraulic model of awnet has 1144 nodes 1182 links and one known head node at the inlet to dma 1 represented by h 0 in 2 awnet is a subset of a larger system of cascading dmas such that the inlet of dma 1 is the outlet of a pressure reducing valve prv from an upstream dma and the outlet of dma 2 is the inlet to a prv leading to a downstream dma the two dmas of awnet are also separated by a prv logger 01 all prvs in the system measure flow hence the flows at the inlet outlet and dma boundary are recorded logger 01 f logger 19 and logger 20 the remainder of the loggers shown in fig 6 are pressure loggers five of which are within dma 1 logger 01 i and logger 02 to logger 05 and the other 14 are in dma 2 logger 01 o and logger 06 to logger 18 we consider three months of recorded hydraulic data from the 19 pressure loggers and three flow meters in awnet during this period three significant bursts b1 b2 and b3 occurred at the times and locations shown in fig 6 bursts b1 and b2 were combined into an even larger event which significantly affected customers in the area on 03 feb 2020 as shown in further detail in fig 7 in response to b1 the prv between the two dmas was closed along with a few other local valves to isolate the burst while the boundary valve bv connecting the dmas further up was opened to maintain customer supply in dma 2 however minutes after the bv was opened b2 occurred escalating the scale of the event which resulted in a reduced water service in the area for the remainder of the day the incident on 03 feb 2020 prompted the opening of kept shut boundary valves in the surrounding area in order to deliver water to customers downstream whilst the pipe breaks were being repaired after the pipe breaks were fixed the previously opened boundary valves were all closed except the bv connecting dma 1 and dma 2 which remained unintentionally open for over a month almost exactly a month later another burst b3 occurred in the middle of dma 2 once b3 was fixed an investigation from the water technicians found the open bv which was consequently closed we model the opening and closing of the bv using a time varying head loss model in 2 we consider a new head loss function such that 13 φ q t c t φ q t c δ t where 14 δ j t γ bv is closed 0 otherwise j 1 n p with γ 0 an arbitrarily large number the described events which are summarised in fig 7 are unique in the sense that they were monitored by a large number of sensors in awnet therefore the dataset is particularly useful and representative for the presented framework for model calibration and continuous model maintenance as multiple control states occur over an extended period albeit unintentionally the dataset also includes two loggers affected by data recording issues logger 15 has a brief three hour gap of data on 05 jan 2020 as observed in fig 7 and logger 17 malfunctions from around b1 b2 onward the described sampling method does not explicitly account for null data therefore for this case study the time steps where logger 15 stopped recording are ignored and the data from logger 17 is disregarded completely future work may look at incorporating methods for addressing null data as data streams can have data gaps 5 results the objectives of the paper were to design a framework for the continuous maintenance and improvement of hydraulic models by i identifying desirable hydraulic states for the purpose of fitting a hydraulic model ii determining the hydraulic states by evaluating only hydraulic data without the need of a hydraulic model and iii experimentally validating common calibration maintenance scenarios on a real world case study to illustrate the flexibility of the process described in fig 1 we consider two extreme hydraulic maintenance scenarios alternative options could be considered between these two extreme scenarios based on specific application needs firstly we consider the scenario that a one off calibration exercise is to be performed by a water utility the loggers are deployed for the period described in the case study afterwards the entire dataset is available for the model fitting process t 9409 and the presented sampling and parameter estimation approaches will be used for a single batch calibration secondly we consider the scenario of continuous model maintenance where an accurate hydraulic model is essential for a near real time optimisation task e g pump scheduling dynamically adaptive control etc the time steps are passed into the process one at a time t 1 demonstrating the ability of the method to adapt over time as well as being fast enough to keep up with a new dataset being received every 15 minutes by investigating batch calibration and streaming maintenance scenarios we evaluate how the framework performs in the two extremes of its application the batch scenario demonstrates the performance when handling large datasets and the streaming scenario demonstrates if the computation speed is sufficient to keep up with newly received data the use of mini batches is outside the scope of this paper and a subject of future work as the sampling procedure produces the same selected time steps for both of the testing scenarios we first evaluate the performance of solely the sampling procedure both testing scenarios are subsequently evaluated all computations were performed on matlab r2019b 64 bit on windows 10 enterprise installed on a 2 40 ghz intel xeon cpu e5 2665 with 8 cores the parameter estimation solver scp was implemented in matlab and used gurobi 8 1 1 for the convex optimisation gurobi optimization 2019 a single extended period simulation is needed at each iteration when the objective function and gradients are calculated the hydraulic simulations are performed using the computationally efficient null space newton method for hydraulic analysis abraham and stoianov 2015 the awnet model uses the darcy weisbach head loss model and thus the parameter estimation explicitly uses the derivatives calculated in waldron et al 2020 the pressure data is downsampled to 15 minute time steps to match the flow data a detailed description of awnet and the associated hydraulic data is available in the supplementary material to promote reproducibility 5 1 evaluation of stepping methods the forward backward and mixed stepping methods presented in section 3 2 need either one or both of the hyperparameters α and β to evaluate the effect of the values of α and β different combinations of the hyperparameters are compared in tables 2 and 3 alongside the stepping method procedures we also evaluate a manual sampling method as a comparison of a best alternative approach referred to as manual peak sampling in this strategy the training dataset is initialised to include the first 24 hours of the dataset 97 time steps then we add the measurements corresponding to the time steps of peak demand for the following days excluding days with bursts note that t 97 is a commonly recurring number in the results as we consider a day worth of 15 minute samples from midnight to midnight on the following day in all the experiments with forward backward mixed stepping or manual sampling methods we do not consider pipe grouping and each pipes roughness coefficients is individually calibrated we investigate whether the availability of large datasets with sufficiently varied hydraulic states can be exploited to deal with the underdetermined problem and generate accurate hydraulic models fig 8 provides an illustration of the results from a single sampling experiment forward stepping with α 0 02 with the lof results control changes and principal components also visualised the anomaly detection method lof identified and excluded the bursts shown in figures 6 and 7 with a high level of accuracy discussed further in appendix a this included a pressure related event detected on 25 feb 2020 fig 8 shows the alignment of the lof results with the sampled time steps and hydraulic data for forward stepping with α 0 02 this figure allows us to interpret the results of lof as we can see disturbances in either the pressure and or flow for the locations where incidents have occurred we also recognise the previously observed behaviour of the forward stepping which is sampling at a higher frequency when new control states start notice how small fluctuations between 02 jan 2020 and 10 jan 2020 are also highly sampled furthermore the illustration of the first two principal components demonstrates that different control states bv open closed project onto separates spaces all other sampling results for the rest of the experiments can be found in appendix b 5 2 test 1 batch calibration first we consider the batch calibration of awnet using the sampled time steps corresponding to the different sampling algorithms and hyperparameters and scp for the parameter estimation the total error of the resulting hydraulic model with updated roughness coefficients is then compared with i the initial hydraulic model and hydraulic models calibrated with ii an approach using regularisation and iii an approach using pipe grouping the regularisation approach adds a term to the objective function which penalises deviations from the initial vector of roughness coefficients to reduce the ill posedness of the problem waldron et al 2020 while pipe grouping reduces the number of decision variables to prevent the problem from being underdetermined mallick et al 2002 both of these approaches still use the same scp method to find a new set of roughness coefficients but they instead use a single day of data 24 dec 2019 as a training period for the optimisation the regularisation requires a longer validation period 26 dec 2019 to 29 mar 2020 with the anomalies removed to tune the regularisation hyperparameter we compare the model accuracy using the new roughness coefficients from each experiment on a set of unsampled or anomalous time steps v we call this period the test period the model error ψ t e s t 9409 is calculated analogously to equation 4 and it is used for all different experiments when 9409 time steps of data have been considered furthermore we define two error functions ψ b v c l o s e d and ψ b v o p e n considering two separate subsets of v denoted by v b v c l o s e d and v b v o p e n corresponding to the two different control states the results summarised in table 2 support previous observations about the properties of the different stepping methods discussed in section 3 2 a reduction of α when using forward stepping reduces the chances of a new time step t belonging to the critical time steps c thus increases the number of sampled hydraulic states t algorithm 2 similarly increasing β when using backward stepping directly increases t algorithm 3 the batch calibration results demonstrate the value of using a sampling method in fact across all experiments where stepping methods are used the error ψ t e s t 9409 has similar values which are smaller than those corresponding to the conventional approaches i e using regularisation and pipe grouping moreover sampling strategies resulting in training datasets of the same size as the conventional approaches i e t 97 result in improved model accuracy manual peak sampling achieves a ψ t e s t 9409 value close to the median of the stepping method experiments it also manages to do comparatively well in both of the different control states with only the backward stepping methods performing consistently better the results also demonstrate the issue of forward stepping keeping redundant time steps we observe the backward stepping with t 97 produces a similar level of accuracy to the forward stepping methods despite fitting on considerably fewer hydraulic states moreover the backward stepping does comparatively better when considering similar values of t both the grouping and regularisation methods aim to mitigate the ill posedness of the parameter estimation problem and thus provide more robust solutions which can perform better under multiple hydraulic states however although they both made a significant improvement in ψ t e s t 9409 compared to the initial model they resulted in lower accuracy compared to the sampling approaches this is further illustrated in fig 9 which compares the prediction error from the two control state periods as cumulative distribution functions cdfs of the test error values ψ b v c l o s e d and ψ b v o p e n over time steps v b v c l o s e d and v b v o p e n respectively in fig 9 it can be observed that both the manual peak sampling and the stepping methods show the smaller error values over both control states whilst using regularisation on a single day provides a good solution for when the bv is closed it struggles to improve at all from the initial model when the bv opens this can be attributed to the fact that the training day is only in the bv closed control state and although the validation period includes the bv open control state this does not improve the prediction performance the grouping approach results in a solution which improves significantly on the initial model and remains consistent over both control states this reaffirms the robustness of the solution when pipe grouping is used and why it is the most appropriate approach when there is a limited quantity of data over a wide variety of hydraulic states however for the purposes of this case study the results demonstrate the benefits of using a sampling approach as a significant improvement can be made to the hydraulic model accuracy without the need for pipe grouping or fire flow tests 5 3 test 2 streaming maintenance the results from table 2 and fig 9 have already demonstrated that a sampling approach which retrospectively evaluates a large set of hydraulic data is effective when performing an initial calibration exercise now we investigate the potential of using a sampling approach with a data stream for updating a model and keeping it maintained unlike batch calibration this scenario does not allow us to directly compare sampling with grouping or regularisation as extending traditional approaches to streaming model maintenance is not straightforward in particular updating the model with a stream using grouping considering all past time steps requires solving increasingly large calibration problems at every new time step hence we instead implement the same sampling experiments with grouping applied to determine if there are any benefits to using it the averaged results are shown below with the full grouping results for each experiment available in appendix b the regularisation strategy proposed in waldron et al 2020 on the other hand requires the availability of a large dataset for training and validation which is not always available in a data streaming framework additionally the extra computation required for tuning the regularisation parameter becomes impractical in the time frame between newly recorded hydraulic data therefore we do not consider the regularisation approach for the streaming maintenance scenario the results from these experiments are shown in table 3 here the test period is the same as the batch test period i e all non anomalous and non sampled time steps and ψ t e s t 9409 represents the final error over the test period at the end of an experiment the test error is also evaluated at each time step throughout and the mean is denoted by ψ t e s t a direct comparison of the ψ t e s t 9409 values from tables 2 and 3 justifies the use of the proposed framework from fig 1 as the streaming results are generally lower than the batch results hence continuously updating the model using a stream of hydraulic data results in hydraulic models that are as accurate as those obtained with a batch calibration approach alongside ψ t e s t 9409 we also consider the mean test error over the course of each experiment ψ t e s t the stepping methods with the lowest ψ t e s t value are shown alongside the other calibration approaches in fig 10 note that test errors can only be calculated retrospectively and if the methodology is being used in streaming maintenance only the maintenance error is observable the maintenance error is calculated on all previous non anomalous time steps v after each model update and is representative of the hydraulic data in t at that point in time as v s t r e a m is representative of previously observed hydraulic conditions the maintenance error remains relatively constant throughout this is observed in fig 10 as well as ψ t e s t over time in fig 10 we observe from the maintenance error that each experiment gave a similar prediction accuracy on the acquired hydraulic data as the experiment progressed moreover these results highlight the benefits of the approach as the prediction accuracy is maintained even when different control states are considered therefore the model is continuously maintained as new significant variations in the hydraulic data are considered in the model fitting process however ψ t e s t which is evaluated a posteriori on the entire test period is a better indication of the true model error and we generally observe that it is much higher when only one control state is considered dropping dramatically as soon as the second control state begins this is not the case for the results obtained using sampling with grouping which quickly converges to an improved solution and then remains constant over the course of the rest of the experiment this once again demonstrates that in a situation with limited hydraulic data grouping is an effective way to achieve an improved robust solution across all hydraulic conditions the manual peak sampling finishes with a similarly accurate hydraulic model as the stepping methods however unlike these methods the manual peak sampling experiment struggles to improve the quality of its solution over the course of the first control state period hence the larger value for ψ t e s t in table 3 it then requires a longer time to improve the accuracy of its solution when the second control state begins this gives the stepping methods a significant advantage if the methodology wants to be implemented as a stream furthermore when using the stepping methods we observe ψ t e s t decreasing over the first control state before the second control state is considered demonstrating its worth if only one control state is planned for the foreseeable future all of the stepping methods outperform the other calibration approaches and all of them improve albeit to different extents the accuracy of the hydraulic model over the course of the first control state period however from fig 10 we observe that the experiments using the backward stepping algorithm do significantly better than the forward stepping result furthermore table 3 shows that backward stepping outperforms forward stepping in all experiments this can be attributed to the several factors i the bias the forward stepping shows at the start of its sampling process ii when forward stepping updates only a single hydraulic state is added at a time whereas backward stepping removes a state also changing the solution space by a larger amount and iii backward stepping results in a large m providing more opportunity to find an improved solution these points are further investigated considering the temporal differences of ψ t e s t with respect to time to calculate cumulative absolute change in the test error ψ t such that 15 ψ t i 2 t ψ t e s t i ψ t e s t i 1 the metric ψ t which measures the sum of differences in ψ t e s t before and after an update is an indication of how much the hydraulic model has changed up to time step t the variable ψ is plotted against time from the second day onward for all experiments in fig 11 the first 24 hours are removed as we evaluate the period of improvement after the first day in fig 11 we observe that the experiments using the backward stepping algorithm have a much higher rate of change than the other experiments as previously stated this gives them more opportunities to overcome the ill posedness caused by the nonconvex nature of the problem thus explaining why the experiments using backward stepping generally have a better prediction accuracy therefore using backward stepping or mixed stepping with a small α value is considered preferable the results from the streaming testing scenario demonstrate the potential of the approach for continuously maintaining a hydraulic model this complements the results from using the procedure for a batch calibration exercise demonstrating the flexibility of the framework a full set of figures analogous to fig 10 for each sampling experiment can be found in appendix b 6 conclusion water utilities have become increasingly reliant on the application of hydraulic models to optimise the performance of their water supply systems and assets therefore it is critical that hydraulic models are efficiently calibrated and continuously maintained this process can be facilitated with recent advances in pressure sensing and communication technologies which result in the continuous acquisition of hydraulic data with high spatial and temporal resolution the paper presents an analytical framework for the calibration and continuous maintenance of hydraulic models for wdns the framework combines novel pca based sampling methods to identify the best hydraulic states to fit a hydraulic model against and a tailored scp algorithm for solving the parameter estimation problem furthermore the stepping methods sample the data without requiring a hydraulic model the flexibility of the presented methodology allows for its application with data batches of different sizes thus being a robust approach for one off calibration exercises or for continuous hydraulic model maintenance the batch calibration results using sampling achieve a higher prediction accuracy than conventional methods especially when considering more than one control state fig 9 this demonstrates the importance of considering a wider variety of hydraulic states to get the best possible hydraulic model thus by utilising fire flow tests or observed events such as the one in the case study a more robust model is achieved from a wider variety of hydraulic states the streaming maintenance results demonstrate the method can be used concurrently with a parameter estimation method for initial calibration and then continuous hydraulic model maintenance furthermore the stepping method experiments show an improvement in the model over time even when only one control state is considered this demonstrates the applicability of using the sampling method with a model fitting approach in conjunction with other near real time applications the results also demonstrate that using pipe grouping provides robust solutions over multiple control states making it the preferred tool when limited hydraulic data is available when the use of sampling is possible the ease of interpretability of the hyperparameter β and the removable of the bias towards the start of the sampling means that backward stepping or mixed stepping with a small α value is preferable furthermore forward stepping and manual peak sampling share the issue of having no upper limit for t making them unsuitable over much longer periods future work should include the addition of a more comprehensive demand estimation model within the sampling process which could improve the model accuracy quantifying demand changes over time also has the potential to generate a larger number of independent hydraulic states e g steffelbauer et al 2020 in addition specifically designed control states within wdns with dynamically adaptive network connectivity and hydraulic control may be used to generate a wider range of hydraulic states the pca projections could then be clustered by control state e g the distinct clusters in fig 8 to be used for identifying unintentional network connectivity changes such as the accidental bv left open in the case study the extensive experimental research which we include in this paper demonstrates that the problem of calibration and continuous maintenance of hydraulic models for water distribution networks is non trivial the results indicate that the developed method for determining hydraulic states with large variety combined with a computationally efficient optimisation method present a significant step forward towards enabling water utilities to effectively and efficiently calibrate and maintain their hydraulic models based on the increased spatial and temporal resolution of acquired hydraulic data declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by epsrc ep p004229 1 dynamically adaptive and resilient water supply networks for a sustainable future ep l016826 1 centre for doctoral training in sustainable civil engineering and anglian water supplementary material the awnet case study and associated data is available online at http doi org 10 17632 9xbjcg6w5s supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118905 appendix a supplementary materials supplementary data s1 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s1 supplementary data s2 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s2 
15672,this paper investigates control and design for control strategies to improve the resilience of sectorized water distribution networks wdn while minimizing pressure induced pipe stress and leakage both evolutionary algorithms ea and gradient based mathematical optimization approaches are investigated for the solution of the resulting large scale non linear nlp and bi objective mixed integer non linear programs bominlp while eas have been successfully applied to solve discrete network design problems for large scale wdns gradient based mathematical optimization methods are more computationally efficient when dealing with large search spaces associated with continuous variables in optimal network control problems considering the advantages of each method we propose a sequential hybrid method for the optimal design for control of large scale wdns where a refinement stage relying on gradient based mathematical optimization is used to solve continuous optimal control problems corresponding to design solutions returned by an initial ea search the proposed method is applied to compute the pareto front of a bi objective design for control problem for the operational network bwpnet where we consider reopening closed connections between isolated supply areas the results show that the considered design for control strategy increases the resilience of bwpnet while minimizing pressure induced leakage moreover the refinement stage of the proposed hybrid method efficiently improves the coarse approximation computed by the initial ea search returning a continuous and even pareto front approximation keywords resilience pressure management design for control bi objective optimization mixed integer non linear programming evolutionary algorithms 1 introduction water distribution networks wdns have a critical public health function as a result water utilities need to comply with strict operational requirements the need for operators to maintain performance levels under financial and environmental constraints despite increasing customer demand and asset deterioration results in challenging design and control problems in order to address these challenges this paper investigates the application of evolutionary algorithms ea and gradient based mathematical optimization methods to the design for control dfc of dynamically adaptive water distribution networks the operational challenges facing water utilities are illustrated by bwpnet a case study network adapted from an operational wdn in england fig 1 water utilities in england and wales are required by the water services regulation authority to minimize water losses ofwat 2019 this has lead to the widespread implementation of network sectorization awwa water loss control committee 2003 uk water industry research 1999 i e the partitioning of wdns into single feed district metered areas dma using boundary valves bv bwpnet for instance is divided into 12 dmas despite facilitating pressure management and leakage monitoring permanent network sectorization reduces the redundancy of wdns and increases the risk of interruptions of supply although the resilience of sectorized wdns can be improved at minimal cost by reopening closed bv and aggregating dmas permanently reopening bvs can result in flow reversals high pressure levels and leakage to preserve the benefits of sectorization while improving network resilience bvs between dmas can be either partially reopened or replaced with dynamically adaptive e g time or flow modulated control valves the benefits of dynamically adaptive dma aggregation combined with the optimal control of pressure reducing valves prv were first demonstrated by wright et al 2014 on an operational network the study does not however provide a design methodology for identifying the optimal set of closed bvs to reopen or replace with control valves di nardo et al 2016 on the other hand propose a dynamic partitioning approach for non sectorized wdns with the objective of maximizing network resilience the authors first apply a clustering algorithm to assign nodes to dmas before optimizing the placement of flow meters or remotely controlled gate valves at dma boundaries using a genetic algorithm ga finally giudicianni et al 2020 propose a methodology to aggregate dmas by reopening closed bvs in a sectorized wdn using a community detection algorithm and ga the authors optimize the placement of new gate valves and flow meters to maximize the resilience index todini 2000 of larger aggregated dmas the problem formulations adopted by di nardo et al 2016 and giudicianni et al 2020 however do not consider optimizing the control settings of pressure reducing or sustaining valves in this paper we investigate a dynamically adaptive dma aggregation strategy for the joint minimization of pressure induced leakage and maximization of resilience where closed bvs between dmas represent candidates for partial reopening or replacement with automatic control valves we focus on the replacement of bvs with non return prvs but other forms of pressure reducing or sustaining control valves can also be considered the optimal aggregation of dmas results in a bi objective design for control dfc problem combining discrete and continuous variables which consists in identifying simultaneously the optimal set of bvs to reopen or replace with prvs and optimal control settings for new and existing prvs optimal wdn design control and design for control problems have been previously solved using both heuristic methods araujo et al 2006 atkinson et al 2014 cunha and sousa 1999 liberatore and sechi 2009 nicolini and zovatto 2009 savic and walters 1997 and gradient based deterministic mathematical optimization methods bragalli et al 2008 dai and li 2014 pecci et al 2017a while gradient based mathematical optimization methods deal efficiently with continuous variables and exact methods provide global optimality bounds the size of problems involving both integer variables and non convex constraints which can be solved using global solvers remains limited sahinidis 2019 as a result solving optimal design or design for control problems to global optimality is intractable for operational wdns on the other hand heuristic approaches such as evolutionary algorithms ea have been successfully applied to compute satisfactory solutions for large instances of multi objective wdn design problems guo et al 2007 yazdi 2016 previous studies suggest however that the number and precision of continuous variables in real world optimal wdn control and design for control problems which result in extremely large search spaces can significantly impact the computational efficiency of eas maier et al 2014 approaches to overcome the limitations of evolutionary algorithms and gradient based mathematical optimization include hybridization harada et al 2006 shukla 2007 sindhya et al 2008 this paper proposes and investigates the application of a tailored hybrid method to solve the multi objective design for control problem of dma aggregation in operational wdns such as bwpnet the manuscript is organized as follows in section 2 we introduce the case study network bwpnet and the considered wdn control and design for control dfc strategies which are formulated as optimization problems in section 3 we first investigate the optimization of prv control settings in the sectorized bwpnet network with the single objective of minimizing pressure induced pipe stress and leakage the optimal wdn control problem is solved in section 4 using both evolutionary algorithms ea and gradient based mathematical optimization while the results show that gradient based mathematical optimization methods are more efficient for the solution of the continuous wdn control problem they do not scale well for the solution of wdn design for control problems which involve discrete decision variables in order to solve the design for control problem of dma aggregation in bwpnet which consists in reopening or replacing closed bvs with prvs and simultaneously optimizing the control settings of prvs for the joint minimization of pressure induced leakage and maximization of resilience section 5 then investigates a hybrid method combining evolutionary algorithms ea and gradient based mathematical optimization finally we discuss the performance of the hybrid method and the benefits of dma aggregation and present our conclusions in section 6 2 presentation of the network and considered control and design for control strategies the case study network considered in this paper bwpnet is adapted from an operational network in england in this section we describe bwpnet and propose control and design for control strategies to improve the performance of the network 2 1 bwpnet bwpnet counts n n 10 100 nodes junctions or customer demand nodes n 0 3 sources or reservoirs and n p 10 597 links which include 18 prvs and 57 closed bvs located at the boundaries between dmas the network is sectorized into 12 dmas of which 10 are single feed dmas and the remaining 2 have two inlets each friction head losses across network links are modeled by the darcy weisbach d w equation for the optimal control and design for control of bwpnet we consider a set of loading conditions customer demands and heads at sources representative of a typical day of network operation to illustrate the improvements in performance which can be achieved under normal operating conditions in particular a 15 minute time step is adopted for daily demand patterns representing n t 96 time steps over 24h it is recommended that solutions returned by the optimization be then validated against peak or extreme loading conditions prior to their implementation throughout this paper a network design refers to the fixed status of bvs open closed and candidate prvs selected for installation or not while a network configuration corresponds to the union of a network design and a set of prv control settings in the current or initial configuration of bwpnet against which we evaluate improvements in network performance all bvs are closed sectorized design and all existing prvs are considered fully open next we describe the control and design for control strategies investigated for bwpnet and the mathematical formulation of the corresponding optimization problems 2 2 optimal control and design for control strategies the first task is to optimize the control settings of existing prvs for the current network design in order to minimize pressure induced pipe stress and leakage the operational drawbacks of network sectorization and recent work on dynamically adaptive networks see section 1 then motivate the investigation of a design for control strategy for the joint minimization of pressure induced leakage and maximization of resilience in particular the dma aggregation strategy investigated in this manuscript increases the redundancy in connectivity by reopening closed bvs between dmas the objective is to improve the resilience of the network to pipe failures by increasing the number of alternative supply paths however most bvs cannot be permanently reopened without causing flow reversals across dmas moreover fully opening bvs without introducing additional pressure control results in high pressure levels and pressure induced pipe stress and leakage under normal operating conditions as a result we formulate and investigate the solution of three problems for the optimal control and design for control of bwpnet summarized in fig 2 these problems are referred to as tasks 1 2 and 3 1 task 1 consists in optimizing the control settings of existing prvs in the current sectorized network design to minimize pressure induced pipe stress and leakage this task reflects standard pressure and leakage management practices adopted in the water industry in england and wales task 1 results in a continuous single objective optimization problem 2 for task 2 we investigate the bi objective wdn design for control problem of dma pairing for the joint maximization of resilience and minimization of pressure induced pipe stress and leakage closed bvs are selected for reopening or replacement with non return prvs subject to the aggregation of every dma with at most one neighboring dma and control settings of new and existing prvs are simultaneously optimized in particular if dma a shares one or more boundaries with dmas b and c then dma pairing prevents simultaneously reopening or replacing bvs isolating a from b and bvs isolating a from c see also ulusoy et al 2019 appendix a for the definition of the dma pairing constraint the dma pairing constraint which derives from discussions with water network operators limits the total number of bvs that can be reopened or replaced with prvs this restriction represents a trade off between the redundancy and complexity of operating multi feed pressure managed areas 3 finally task 3 extends task 2 by removing the dmas pairing constraint and investigates the bi objective wdn design for control problem of dma aggregation note that task 1 does not require additional capital investment in comparison the costs of the solutions of tasks 2 and 3 depend on the results of the optimization e g whether bvs can be partially reopened or whether new time flow modulated prvs need to be installed finally task 2 demonstrates that the proposed design for control strategy can incorporate constraints imposed by network operators 3 formulation of the wdn control and design for control problems in this section we present a mathematical formulation of the wdn control and design for control problems corresponding to tasks 1 2 and 3 we use a steady state discrete time demand driven hydraulic model we define the index set e p of network links and subsets e prv e p and e bv e p of existing prvs and closed bvs which are candidates for partial reopening or replacement with prvs we consider n t 96 different time steps of network operation which corresponds to a day of operation using a 15 minute time steps at time step k 1 n t we denote by h k r n n the vector of unknown hydraulic heads while q k r n p represents the vector of unknown flows the vector of known nodal demands is given by d k r n n and known hydraulic heads at water sources by h 0 k r n 0 let ζ and h min r n n be the vectors of known elevations and minimum allowed hydraulic heads at network nodes respectively in compliance with the dg2 serviceability indicator ofwat 2004 defined by ofwat for england and wales the minimum allowed hydraulic head h i min of a node i is defined as the elevation ζ i of i plus the minimum allowed pressure at that node which is 10 m for customer nodes we also introduce the unknown vector η k r n p to model the additional head difference across links introduced by the action of non return prvs and bvs hydraulic heads h k flows q k and additional head differences η k are subject to mass and energy conservation constraints 1a a 12 t q k d k 0 k 1 n t 1b a 12 h k a 10 h 0 k ϕ q k η k 0 k 1 n t where a 12 r n p n n and a 10 r n p n 0 are the link node incidence matrices for demand nodes and water sources respectively friction head losses associated with pipe flows q k q 1 k q n p k t represented by the vector ϕ q k ϕ 1 q 1 k ϕ n p q n p k t are described by the non smooth darcy weisbach d w formula upper and lower bounds on variables q k h k and η k respectively are represented using the vectors q u k q l k h u k h l k η u k and η l k r n p such that 2 q l k q k q u k k 1 n t h l k h k h u k k 1 n t η l k η k η u k k 1 n t where h u k max i 1 n 0 h 0 k i 1 n n h l k h min and for the sake of brevity q u k q l k η u k and η l k are defined for pipes prvs and bvs by eqs a 4 to a 6 in appendix a finally to model design decisions regarding the status of bvs j e bv in tasks 2 and 3 we introduce the binary decision variables z z z 0 1 n bv indexed by l j 1 n bv and we set z z z z for j e bv each binary decision variable z l j z l j and z l j represents a different design option namely z l j 1 corresponds to partially reopening bv j z l j 1 corresponds to replacing bv j with a non return prv in the assigned positive direction of the bv and z l j 1 corresponds to replacing j with a non return prv in the negative direction on the other hand if z l j z l j z l j 0 then bv j is kept closed and flows across j are forced to zero at all time steps note that this is the case for all j e bv in task 1 in the formulation of the optimization problem the status of bvs is represented using big m constraints and constraints on flow and head loss directions across new prvs are modeled using bilinear constraints see eqs a 1 a 2 and a 3 in appendix a 3 1 task 1 water utilities in england and wales are financially incentivized by ofwat to reduce water losses due to e g pipe bursts or background leakage resulting from joints or small cracks in pipes one of the main factors influencing pipe bursts and leakage in wdns is pressure here we use the average zone pressure wright et al 2015 as a surrogate measure of pressure induced pipe stress and leakage 3 azp 1 n t w k 1 n t w t h k ζ where w r n n and w r are the vector of azp weights and the azp normalization factor respectively for i v we define j i the set of all pipes incident to node i then w i j j i l j 2 and w i 1 n n w i where l r n p is the vector of pipe lengths the wdn control problem corresponding to task 1 results in the following single objective non linear program nlp nlp minimize azp subject to linear mass conservation equations 1a non convex energy conservation equations 1b upper and lower bounds 2 big m constraints modeling bvs closure a 1 and a 2 for fixed z 0 n bv z 0 n bv z 0 n bv bi linear head loss directional constraints a 3 3 2 tasks 2 and 3 in addition to minimizing water losses a key performance commitment for water utilities is to minimize supply interruptions and customer minutes lost which depend on the resilience of a wdn i e the ability of a wdn to maintain continuous customer supply under failure conditions the resilience of a wdn is underpinned by the availability of alternative supply paths topological redundancy and pressure surplus energy redundancy it can be estimated from simulating the network under failure conditions however this approach suffers from combinatorial limitations as it requires the simulation of a wide range of failure scenarios which makes it challenging to incorporate within an optimization framework in comparison surrogate measures of resilience depend only on the topology of the network or its performance under normal operating conditions a commonly adopted surrogate measure of resilience for the design of wdns is the resilience index todini 2000 which is defined for any time step k 1 n t as the ratio of surplus energy to total energy input under normal operating conditions 4 d k t h k d k t h min a 10 h 0 k t q k d k t h min based on 4 we can define the average energy efficiency of the network over a day of operation by 5 ri 1 n t k 1 n t d k t h k d k t h min a 10 h 0 k t q k d k t h min we observe from 3 and 5 that both azp and ri are increasing functions of the hydraulic heads at network nodes as a result the minimization of azp and the maximization of ri are conflicting objectives the sectorization of bwpnet which facilitates pressure management and leakage reduction negatively impacts the resilience of the network as it reduces the redundancy in connectivity and increases energy losses as a result tasks 2 and 3 investigate bi objective wdn design for control problems which consist in simultaneously identifying closed bvs to reopen or replace with new prvs and computing optimal prv control settings with the objectives of maximizing ri and minimizing azp the partial reopening or replacement of closed bvs with prvs is limited to a single decision per bv j e bv and is subject to the additional constraint of dma pairing in task 2 the combinatorial constraints on the binary decision variables z l j z l j z l j 0 1 corresponding to task i i 2 3 are represented by equation b i which is described in appendix a the resulting bi objective mixed integer non linear programs bominlp which correspond to the design for control strategies of task i i 2 3 are formulated as follows bominlp minimize azp maximize ri subject to linear mass conservation equations 1a non convex energy conservation equations 1b upper and lower bounds 2 big m constraints modeling bvs operation a 1 and a 2 bi linear head loss directional constraints a 3 combinatorial constraints b i z z z 0 1 n bv problems nlp and bominlp represent the general mathematical formulations of the optimization problems corresponding to tasks 1 2 and 3 note that these formulations are not explicitly adopted in the ea approaches described below where hydraulic feasibility constraints are implicitly handled by the hydraulic solver here we use epanet2 0 rossman 1994 4 solution of the wdn control problem task 1 we first investigate the single objective wdn control problem nlp described in section 3 the objective is to find optimal control settings for existing prvs to minimize azp over 96 time steps i e a day of operation for the fixed dma sectorization of bwpnet i e z l j 0 z l j 0 z l j 0 for all j e bv in this section we apply and compare the performance of two different methods for the solution of the continuous problem nlp the benefits of optimal pressure management in the sectorized network bwpnet are also discussed 4 1 solution methods both eas and gradient based mathematical optimization mo approaches have been previously applied for the optimization of wdns in this section we investigate the application of approaches from these two families of methods to the solution of the continuous single objective wdn control problem nlp details of the different implementations are presented in table 1 4 1 1 evolutionary algorithm evolutionary algorithms ea are population based optimization methods inspired by the genetic processes in biological organisms and the principle of natural evolution in an ea search a population of chromosomes which define a set of potential solutions are initially created and modified through selection crossover and mutation promising candidate solutions are selected from the population and perturbed by a sequence of unary mutation type and higher order crossover type transformations these individuals strive for survival through a selection scheme which is biased towards fitter individuals after a number of generations the program converges with no guarantee of optimality eas have been shown to be valuable tools for solving complex optimization problems in the engineering field and in particular water system design problems maier et al 2014 mala jetmarova et al 2018 for task 1 a single objective genetic algorithm ga goldberg and kuo 1987 is applied as an ea approach to find optimal pressure settings for existing prvs with a 15 minute time step in the ea search the epanet2 0 rossman 1994 hydraulic solver is used to ensure individual solutions defined by a set of prv control settings are hydraulically feasible and evaluate their fitness note that in preliminary experiments total head deficits associated with solutions returned by the mathematical optimization ranged between 0 and roughly 20 m over all network nodes and all time steps due to errors introduced by the quadratic approximation of the darcy weisbach friction head loss formula see section 4 1 2 as a result in order not to disadvantage the ga by rejecting solutions which might be considered feasible by the mathematical optimization minimum pressure constraints are relaxed to accept solutions with up to 30 m of cumulative violations over all nodes and all time steps this corresponds to an average 0 3 m cumulative pressure violation over all nodes at each time step which compared to the uncertainty associated with the hydraulic model and measurements for an operational water network such as bwpnet is small enough to justify that the relaxation does not in practice affect the feasibility of the solutions returned by the ga 4 1 2 mathematical optimization in order to apply gradient based mathematical optimization methods to the solution of the continuous problem nlp we reformulate the non smooth head loss term in the energy conservation eq 1b and the bi linear head loss directional constraints a 3 quadratic approximation of the d w head loss formula we first consider the vector of friction head losses ϕ q k ϕ 1 q 1 k ϕ n p q n p k t which is described by the non smooth darcy weisbach d w formula section 3 as the explicit approximation of the d w equation involves a non smooth rational exponent the hessian is unbounded around the origin as a result the d w equation is difficult to handle in a smooth mathematical optimization framework instead it is more convenient to use a quadratic approximation of the formula given by ϕ q k ϕ 1 q 1 k ϕ n p q n p k t where ϕ j q j k q j k a j q j k b j and a j b j r 2 are positive coefficients computed for each pipe j in the network this is a common approach in the literature dai and li 2014 eck and mevissen 2015 pecci et al 2017b zamzam et al 2019 previous studies and the results reported in appendix b demonstrate that the use of a quadratic approximation does not affect the accuracy of the hydraulic model for bwpnet in particular the difference between the hydraulic head values obtained using the d w formula and its quadratic approximation does not exceed 0 1 m for more than 98 of network nodes this error is significantly less than the uncertainty associated with the hydraulic model and measurements for an operational water network such as bwpnet in order to apply the quadratic approximation of the d w formula the non convex friction head loss term ϕ q k is isolated by introducing the vector of auxiliary variables θ k r n p and constraint 1b becomes 6a a 12 h k a 10 h 0 k θ k η k 0 k 1 n t 6b θ k ϕ q k k 1 n t where 6b is the non convex friction loss equality constraint while constraint 6a is linear reformulation of the bi linear head loss positivity constraints using a penalty method next we reformulate the bi linear constraints a 3 also called vanishing constraints which model the disjunctive behaviour of non return valves prvs by preventing reverse flows and decoupling the hydraulic heads at the extremities of closed prvs due to the geometry of the feasible set defined by constraints a 3 most classical constraint qualifications on which non linear solvers rely to define optimality conditions do not hold achtziger and kanzow 2008 dussault et al 2019 hoheisel 2009 see figure c 1 in appendix c a common approach is to regularize the thin domain of the problem achtziger et al 2012 hoheisel et al 2012 izmailov and solodov 2009 by introducing for instance an auxiliary variable t such that 7 0 q j k η j k t k 1 n t j e prv e bv and a penalty function depending on t and a parameter ρ in the objective we implement the quadratic approximation and penalization approach to reformulate nlp which is rewritten as the ρ parametrized problem 8 minimize x q h η θ t azp x ρ t subject to linear mass and energy conservation constraints 1a and 6a non convex friction head loss constraints 6b upper and lower bounds 2 big m constraints on flows and head differences a 1 and a 2 for fixed z 0 n bv z 0 n bv z 0 n bv bi linear penalty constraints 7 t 0 nlp ρ where x q h η θ represents the hydraulic variables of the problem note that while the decision variables of the control problem i e prv control settings are represented by the additional head loss η the auxiliary variables q h and θ representing unknown flows heads and friction headloss across network pipes are used to explicitly define the objective function and mass and energy conservation constraints finally the optimal value of problem nlp defined over all time steps can be found by solving n t 96 independent smaller problems of the form 8 one for each time step k 1 n t counting over 30 000 continuous variables 20 000 linear constraints and 10 000 non convex constraints each using off the shelf non linear programming solvers in most of our numerical experiments a solution satisfying the bi linear head loss directional constraints a 3 is obtained by solving 8 for ρ 10 6 however if the solver fails to converge to a solution we consider the sequence of sub problems nlp ρ k for ρ 1 10 3 and ρ k 1 10 ρ k until ρ k 10 6 moreover for k 1 the solution of nlp ρ k 1 is initialized at the solution of the previous sub problem a candidate solution of the original wdn control problem nlp is then obtained by performing a hydraulic simulation of the network in epanet 2 0 where prv control settings are given by the solution of 8 the results of the hydraulic simulation are used to verify the feasibility of the solution and quantify the cumulative violation of minimum pressure requirements which is also limited to 30 m at all time steps 4 2 results the results obtained for the single objective wdn control problem nlp corresponding to task 1 with both the ea and mathematical optimization methods show a significant reduction in azp in the sectorized network the optimal control settings computed with the ea approach for instance reduce network azp from 37 6 m to 29 9 m as expected a reduction in ri is also observed figures d 1 and d 2 in appendix d represent respectively the time based and flow modulation profiles of the optimal settings obtained for each prv total pressure violations azp and ri values of the original and optimal sectorized configurations are summarized in table 3 and figure d 3 note that cumulative pressure violations over all network nodes do not exceed 0 25 m on average at any given time step for the solutions obtained with ea and mathematical optimization below we present the details of the implementation and the results obtained with the ea and mathematical optimization methods 4 2 1 using ea a steady state ga is first applied to solve the wdn control problem corresponding to task 1 see tables 1 and 2 for details of the implementation random solutions as well as the initial network configuration i e fully open prvs are initially injected into the ga population the values of decision variables corresponding to prv settings are set to range between 0 m and 45 m the results of the implementation show that the azp value starts to converge after approximately 60 000 fitness evaluations or 34 9 h and the final value reached at the end of the evaluations is 29 9 m see table 2 this is 0 4 m less than the final value returned by the gradient based mathematical optimization method see below and it is a substantial reduction in azp from the initial value of 37 6 m 4 2 2 using mathematical optimization we apply the non linear solver ipopt v3 12 9 wachter and biegler 2006 using the matlab interface currie et al 2012 to solve for ρ 10 6 n t 96 reformulated problems 8 one for each time step k see table 1 for details of the implementation for k 1 n t the search is initialized at x 0 k q 0 k h 0 k η 0 k θ 0 k which corresponds to the solution of the hydraulic simulation of the initial bwpnet configuration i e all prvs fully open with 8 threads running in parallel the wdn control problem is solved in around one minute the optimal azp value returned by the solution of the reformulated problem 8 is 30 1 m in comparison the azp value obtained with epanet 2 0 using the optimal prv control settings returned by the solution of the optimization problem is 30 3 m 4 3 discussion next we discuss the results obtained for task 1 we comment on the improvement in azp in bwpnet before comparing the performance of ea and gradient based mathematical optimization methods for the solution of the wdn control problem 4 3 1 optimal prv control settings and improvement in network performance figure 3 shows the daily azp variations in different areas of the network before and after the optimization of prv control settings areas 3029 3030 3040 3050 3080 3081 3082 3090 3094 3095 3120 and 3130 correspond to dmas while the remaining areas include network transmission mains and isolated customer connections see also fig 1 this is the case of area 3078 for instance where the largest differences are observed between the results obtained using the ea and mathematical optimization methods these differences are explained by the fact that the optimal configuration returned by the ea search requires closing an existing prv whereas in the optimal configuration found with gradient based mathematical optimization all existing prvs support positive head differences and flows see figures d 1 and d 2 this results in higher azp values across transmission mains sections 3078 and 1117 further numerical experiments show that this behavior is due to the sensitivity of the gradient based mathematical optimization method to the initial point provided to ipopt across all other areas of the network however the daily azp variations corresponding to the optimal configurations returned for task 1 by the ea and gradient based mathematical optimization method are nearly identical we also observe that compared to the initial network configuration the implementation of optimal prv control settings achieves significant reductions in azp exceeding 15 m on average throughout the day in dmas 3030 3081 3082 3090 and 3094 despite the limited improvements achieved in other dmas e g 3080 and sections of transmission mains e g 1147 3098 3139 the results obtained for task 1 highlight the potential to substantially reduce pressure and leakage in specific areas of bwpnet by applying optimization methods to derive the control settings of existing prvs 4 3 2 comparison of ea and mathematical optimization approaches the results obtained for task 1 show that ea and mathematical optimization converge to similar solutions however a comparison of computation times shows that the gradient based mathematical optimization approach returns a feasible solution in one minute this solution is nearly as good as the final solution obtained with ea in over 34 h the number range and precision of continuous control variables as well as the number of time steps considered in task 1 result in an extremely large search space for eas this represents a main challenge for the application of eas to the optimization of wdns maier et al 2014 as eas balance the need for reducing the size of the search space with the risks of reducing solution precision and excluding globally optimal solutions the difference in the orders of magnitude of solution times suggest that mathematical optimization methods are more efficient for the solution of the continuous wdn control problem in particular while it is possible to include extreme loading conditions derived from historic demand data or based on a fixed multiplier in the formulation of the optimal design for control problem the performance of the non linear solver ipopt on the wdn control problem suggests that for a fixed wdn design mathematical optimization can be efficiently applied to occasionally or periodically e g daily or weekly recompute prv control settings in response to changes in operating conditions or uncertainties in the network model however gradient based mathematical optimization methods do not scale well for the solution of wdn design for control problems which involve discrete decision variables in order to address the limitations of eas and gradient based mathematical optimization methods while exploiting their respective advantages we propose a hybrid method for the solution of the bi objective wdn design for control problems corresponding to tasks 2 and 3 restricted wdn design for control problems are first solved using eas to produce an initial set of potentially pareto optimal design solutions i e solutions that are not dominated by any solution generated so far the design of the network is then fixed to the solutions returned by the ea and gradient based mathematical optimization methods are applied to efficiently solve the resulting optimal control problems 5 solution of the wdn design for control problems tasks 2 and 3 the results of task 1 show that the implementation of optimal prv control settings achieve significant reductions in azp in certain areas of bwpnet however we also observe a reduction in ri in this section we investigate a design for control strategy based on the aggregation of dmas to jointly maximize ri and minimize azp in bwpnet in task 2 we solve the bi objective wdn design for control problem of optimal dma pairing in bwpnet where closed bvs are considered as candidates for reopening or replacement with prvs subject to the combinatorial dma pairing constraints b 2 see appendix a the wdn design for control problem consists in simultaneously optimizing the settings of partially reopened bvs and controls of new and existing prvs task 3 which extends task 2 corresponds to the bi objective wdn design for control problem of optimal dma aggregation although the aggregation of dmas is no longer subject to pairing design decisions i e partial bv reopening or replacement with a prv are limited to one per bv as represented by the combinatorial constraints b 3 see appendix a in this section we present and investigate a hybrid method combining ea and gradient based mathematical optimization for the solution of the bominlps corresponding to tasks 2 and 3 5 1 hybrid solution method the size of minlps which can be solved using exact solvers implementing gradient based mathematical optimization methods remains relatively small compared to the wdn design for control problems corresponding to tasks 2 and 3 kronqvist et al 2019 although tailored global solution methods have been shown to outperform off the shelf solvers in a number of instances sahinidis 2019 including applications to wdns pecci et al 2018 ulusoy et al 2019 solving optimal design for control problems for large scale wdns to global optimality using exact methods is intractable at present in practice heuristic methods are used to reduce the search space and compute good feasible solutions for the optimal design for control of operational systems pecci et al 2019 this paper investigates a hybrid method where gradient based mathematical optimization is applied to refine an initial set of potentially pareto optimal solutions returned by an ea search for the bi objective wdn design for control problems of optimal dma pairing and aggregation several studies in the literature have investigated refinement or local search strategies based on heuristics or gradient based mathematical programming methods within or following eas to accelerate convergence to the true pareto front see koch et al 2009 sindhya et al 2008 for a review the resulting hybrid methods make use of the complementary advantages of successful global and local optimization methods in this work we investigate a two stage method based on the serial or sequential hybridization of ea and gradient based mathematical optimization for the solution of the bi objective wdn design for control problems bominlp corresponding to tasks 2 and 3 see fig 4 a network design refers to the fixed status of bvs open closed and candidate prvs selected for installation or not while a network configuration corresponds to the union of a network design and a set of prv control settings in stage 1 an ea search is performed to solve a restricted wdn design for control problem where prv settings are considered fixed over time this returns a set of potentially pareto optimal configurations c which represents a coarse approximation of the pareto front of bominlp then we select a subset d of designs whose configurations are in c although we do not define a general approach for selecting d case specific approaches are presented for tasks 2 and 3 in section 5 2 in stage 2 we formulate and solve using gradient based mathematical optimization a bi objective control problem with time based prv control settings for each design in d the obtained solutions are added to the pareto front approximation formed by the configurations in c and dominated solutions are excluded the refinement algorithm stops when all designs in d have been considered the application of sequential hybrid approaches combining gradient based mathematical optimization with heuristics has previously been considered for the least cost design and or operation of small to moderate sized case study wdns in zheng et al 2011 qiu et al 2021 for instance the authors first implement an algorithm based on mathematical optimization methods which returns a population of feasible solutions used to initialize a ga 5 1 1 stage 1 as part of the hybrid approach an initial search is performed using the non dominated sorting genetic algorithm ii nsga ii deb et al 2002 to solve problems bominlp corresponding to tasks 2 and 3 over a restricted search space the restricted problem consists in simultaneously identifying the optimal set of bvs to reopen or replace with prvs and optimizing a single control setting for each new and existing prv nsga ii is an evolutionary algorithm where a population of solutions grows through the selection mutation and crossover of individuals compared to the steady state ga applied in task 1 however the performance of individual solutions is given by their partial ordering obtained from non dominated sorting of the population in the event that two solutions are equivalent a crowding distance operator prioritizes solutions in less explored areas of the pareto front finally the ea search returns a set c of feasible solutions each corresponding to a network design and fixed control settings for all prvs 5 1 2 stage 2 let d be a subset of designs corresponding to the configurations in c the set of potentially pareto optimal configurations returned by the initial ea search consider a particular design solution z 0 z 0 z 0 d the continuous bi objective wdn control problem associated with network design z 0 z 0 z 0 z 0 and considering time based prv control settings is then given by bonlp z 0 minimize x q h η θ azp x maximize x q h η θ ri x subject to linear mass conservation 1a and non convex energy conservation constraints 1b upper and lower bounds 2 big m constraints on flows and head differences a 1 and a 2 for fixed z z 0 z z 0 z z 0 and bi linear head loss positivity constraints a 3 note that since the wdn control problems corresponding to each time step are independent we can solve n t 96 independent bi objective problems of the form bonlp z 0 producing individual pareto front approximations for each time step a procedure described in proposition f 3 of appendix f is then implemented to derive an approximation of the pareto front for the full problem from points that are potentially pareto optimal for the individual time steps in appendix f we show that our approach returns a subset of supported pareto optimal combinations of control settings for the full problem bonlp z 0 a common approach for solving multi objective optimization problems using gradient based methods is scalarization which converts a multi objective problem into a sequence of parametrized single objective problems for a review of scalarization methods see ehrgott 2006 miettinen 1998 in this paper we use the method of ϵ constraints to convert the bi objective problems bonlp z 0 corresponding to each time step k 1 n t into sequences of single objective nlps in the method of ϵ constraints the first objective function is optimized subject to upper or lower bounding constraints on the others here we solve a sequence of parametrized problems where azp is minimized subject to lower bounding constraints on ri by applying the quadratic approximation the penalty reformulation and the method of ϵ constraint to bonlp z 0 we obtain a sequence of n ϵ non convex nlps parametrized by ϵ i i 1 n ϵ 0 1 counting over 30 000 continuous variables 20 000 linear constraints and 10 000 non convex constraints each 9 minimize x q h η θ t azp x ρ t subject to ri x ri ϵ i ri x ri ri x azp ri x linear mass and energy conservation constraints 1a and 6a non convex friction head loss constraints 6b upper and lower bounds 2 big m constraints on flows and head differences a 1 and a 2 for fixed z z 0 z z 0 z z 0 bi linear penalty constraints 7 t 0 nlp ρ ϵ i z 0 where for f azp or ri x f is the solution of the single objective optimization problem obtained by considering only the objective function f and ignoring the second objective in bonlp z 0 we set ϵ i i n ϵ i 1 n ϵ and show that by combining the resulting n t 96 individual pareto front approximations obtained for n ϵ 20 according to the procedure presented in appendix f we obtain an even distribution of potentially pareto optimal solutions of the bi objective problem bonlp z 0 we define ρ 10 6 and implement an off the shelf non linear programming solver to compute locally optimal solutions for the sequence of scalarized problems 9 for any i 1 n ϵ if the solver does not converge to a feasible solution we consider the sequence of problems nlp ρ k ϵ i z 0 for ρ 1 10 3 and ρ k 1 10 ρ k until ρ k 10 6 finally a candidate pareto optimal solution for the original problem bominlp is recovered by performing a hydraulic simulation in epanet 2 0 where prv control settings are given by the solution of 9 if the configuration is feasible and in particular if it verifies minimum pressure requirements it is compared against current potentially pareto optimal configurations to update the set c see fig 4 5 2 results the bi objective wdn design for control problems corresponding to tasks 2 and 3 are solved using the hybrid method presented in section 5 1 the potentially pareto optimal solutions obtained which correspond to the best trade offs between leakage management and improvement in resilience that can be achieved with dma pairing and aggregation in bwpnet are represented in fig 5 for both tasks 2 and 3 an initial search is carried out using nsga ii where prv control settings are considered fixed over time see table 1 and lines 2 and 3 in table 2 for details of the implementation of the initial ea search stage decision variables corresponding to the settings of existing prvs and boundary valves selected for replacement with prvs are set to range between 0 and 45 m for decision variables corresponding to partially or fully reopened boundary valves on the other hand valve setting values i e unitless loss coefficients range between 0 and 6 10 6 finally the hypervolume indicator is used as a stopping criterion to measure the quality of the pareto front approximation generated by nsga ii given a potentially pareto optimal design z 0 returned by the initial search stage we apply the non linear solver ipopt v3 12 9 wachter and biegler 2006 using the matlab interface currie et al 2012 to solve n t 96 sequences of continuous problems 9 i 1 n ϵ see table 1 for details of the implementation of the refinement stage 5 2 1 task 2 initial results show that when applied directly to the problem of selecting bvs for reopening or replacement and optimizing fixed prv settings for the problem of optimal dma pairing nsga ii fails to find a feasible solution in under 50 000 evaluations while minimum pressure constraints are easily satisfied at all nodes the algorithm struggles with the combinatorial dma pairing constraints in order to reduce the set of candidate bvs for reopening or replacement with prvs we run a series of hydraulic simulations over 24 h in epanet 2 0 opening one bv at a time all existing prvs are fully open and we measure the resulting minimum pressure violations and ri a pairwise comparison of the results is then performed for every pair of bvs violating the combinatorial dma pairing constraints the bv associated with the highest minimum pressure constraint violation and the lowest ri when reopened is removed from the set of candidate bvs based on the results of the filtration process the set of candidate bvs for reopening or replacement with prvs is reduced from 57 to 11 considering the restricted subset of candidate bvs defined above the initial search stage for task 2 performed using nsga ii is completed in 21 1 h and a single design z 0 is found to represent all potentially pareto optimal configurations we fix the value of binary variables z z z z in bominlp to z 0 reformulate the resulting bi objective problem bonlp z 0 and solve a sequence of parametrized problems 9 for each time step using ipopt the refinement stage is completed in 2 1 h and the combination of the resulting n t 96 individual pareto front approximations provides a continuous distribution of over a thousand potentially pareto optimal solutions of the original problem bonlp z 0 the potentially pareto optimal solutions returned by the initial search and refinement stages of the hybrid method are presented in fig 5 5 2 2 task 3 in comparison to task 2 potentially pareto optimal solutions found for task 3 in the initial search stage cannot be described with a single design z 0 this is illustrated by figure e 1 a in appendix e which represents the number of occurrences on the coarse pareto front approximation of the 105 different designs corresponding to the solutions returned by nsga ii solving a sequence of parametrized problems 9 for all 105 unique designs found in the initial search stage is not tractable instead for the refinement stage we consider only network designs with the largest number of occurrences on the pareto front which are expected to achieve better trade offs between the objectives over a greater range of azp and ri values in particular the designs denoted by 1 2 and 4 in appendix e correspond respectively to 4 5 and 10 pareto optimal solutions returned by nsga ii and span separate sections of the initial pareto front approximation see figure e 1 b as a result we fix in turn the design variables z in bominlp to the values corresponding to designs 1 2 and 4 from figure e 1 appendix e we solve the corresponding bi objective problems bonlp z 0 for each time step k 1 n t before combining the resulting n t 96 pareto fronts according to the procedure in appendix f the potentially pareto optimal solutions returned by the initial search and refinement stages of the proposed hybrid method are represented in fig 5 5 3 discussion in this section we discuss the hydraulic interpretation and performance of the potentially pareto optimal configurations obtained for the bi objective wdn design for control problems of dma pairing and aggregation corresponding to the solutions represented in fig 5 finally we comment on the performance of the proposed sequential hybrid method 5 3 1 improvement in network performance for task 2 a single network design which includes the replacement of 11 closed bvs with prvs and the creation of 4 new pairs of dmas is found to describe all potentially pareto optimal solutions and achieve good trade off configurations for both high average resilience index and low azp values in task 3 on the other hand different designs allow for better trade offs depending on the priorities of a network operator out of the 3 designs returned by the hybrid method the design which allows to achieve the best trade offs for higher average resilience index values requires reopening 6 bvs and replacing 17 bvs with prvs in comparison the network design corresponding to the potentially pareto optimal solutions achieving the lowest azp values requires replacing 9 bvs with prvs and reopening 5 of them the results of task 3 suggests that designs with increased topological redundancy i e which require partially reopening or replacing more bvs with prvs achieve the largest improvements in network resilience and provide the best trade off options between azp and ri around high ri values this is supported by the analysis of the potentially pareto optimal configurations obtained for task 2 as we move along the pareto front approximation from the bottom left i e low azp values to the top right corner i e high ri values potentially pareto optimal configurations correspond to opening more bvs and prvs over more time steps finally compared to the azp reduction achieved in task 1 the results presented in fig 5 show that dma pairing task 2 and aggregation task 3 do not allow to further reduce pressure induced leakage levels in bwpnet however the geometries of the pareto front approximations corresponding to tasks 2 and 3 and in particular the steep section spanning the range of low azp values show that by reopening or replacing closed bvs with new prvs nearly optimal azp values can be achieved while significantly improving ri dma pairing task 2 for instance allows to reach ri values of 0 68 while maintaining network azp under 31 m whereas it is possible to recover initial levels of resilience in bwpnet for less than a 2 m increase in azp compared to the optimal solution of task 1 5 3 2 performance of the sequential hybrid method figure 5 shows that the refinement stage of the proposed hybrid approach efficiently improves the coarse pareto front approximation computed by the initial ea search taking just over 2 h to return a continuous and even pareto front approximation for the wdn design for control problem in task 2 for instance in comparison further numerical experiments show that applying nsga ii instead of gradient based mathematical optimization to solve the refinement stage takes nearly 100 h and results in a pareto front approximation similar to the one returned by the sequential hybrid method moreover the analysis of the results obtained for task 3 shows that the potentially pareto optimal solutions found by nsga ii in the initial search stage correspond to 105 different designs see appendix e figure e 1 a the pareto front obtained after the refinement stage on the other hand contains 3 separate branches each corresponding to a different network design for a decision maker a pareto front approximation consisting of a small number of separate branches each obtained by varying the prv control settings for a given design can be interpreted more easily than a set of 105 different design solutions the high number of different designs returned by nsga ii is likely to be due to the fact that in order to reduce the search space prv settings are considered fixed over time in the initial search stage of the hybrid method this reduces the search space of the wdn design for control problem but also the range of objective values a given design is able to achieve and excludes potentially pareto optimal solutions on the other hand considering independent prv control settings for each time step allows to explore larger solution and objective spaces for each network design the proposed hybrid method is able to efficiently return time based prv control settings for all 96 time steps considered in the formulation of tasks 2 and 3 from which daily control profiles can then be derived 6 conclusion this papers investigates methods to compute dynamically adaptive design for control solutions to improve the pressure management and resilience of large scale water distribution networks the presented methods are applied to the operational case study network bwpnet an optimal control problem for the minimization of average zone pressure azp which is a surrogate metric for pressure induced leakage is formulated as a continuous non linear program and then solved using evolutionary algorithms ea and gradient based mathematical optimization methods after evaluating both approaches we propose and investigate a tailored hybrid method to approximate the pareto front of bi objective mixed integer non linear wdn design for control problems for the minimization of azp and maximization of network resilience ri gradient based mathematical optimization methods are applied to refine a coarse pareto front approximation returned by an initial ea search the proposed hybrid method also includes a procedure to retrieve for a separable problem a subset of supported combinations of potentially pareto optimal solutions of the independent subproblems the proposed hybrid method is applied to the optimal pairing and aggregation of dmas in bwpnet which consists in reopening or replacing closed boundary valves bv with pressure reducing valves prv and optimizing the control settings of new and existing prvs for the joint minimization of azp and maximization of ri the results show that the refinement of the coarse pareto front approximation computed by the initial search stage allows the hybrid method to return a continuous and even pareto front approximation another advantage of the refinement stage of the hybrid approach compared to the coarse pareto front approximation returned by the initial ea search is the interpretability of the results in particular for the bi objective wdn design for control problem of optimal dma aggregation in bwpnet task 3 the solutions returned by the refinement stage of the hybrid method correspond to 3 different network designs in comparison the results of the initial ea search included 105 different network designs the results presented in this paper also show that the proposed optimization method and design for control strategies of dma pairing and aggregation allow water utilities to reduce pressure induced pipe stress and leakage while improving the resilience of their networks in order to maintain continuous customer supply this trade off is becoming critical as utilities operate aging infrastructure under increasing financial pressures and environmental constraints and continuously changing operational priorities in particular among the potentially pareto optimal solutions identified for the dma pairing and aggregation problems in bwpnet we observe that configurations requiring the reopening or replacement of a larger number of bvs with prvs provide a better trade off between the objectives of azp and ri at high ri values the proposed hybrid method could be extended with a concurrent hybrid approach sindhya et al 2008 where gradient based mathematical optimization is implemented within a global search to iteratively compute branches of the pareto front as new potentially pareto optimal designs are found by an ea additional hybridization could also integrate human knowledge to improve the features of individuals in the ea population in interactive evolutionary algorithm iea takagi 2001 for instance fitness evaluation is performed directly by a human expert to guide the optimization towards solutions that are more suitable in practice alternatively human experts can be replaced by human derived heuristics johns et al 2020a 2020b which have the advantage of not requiring constant input from the user discussions with network operators have highlighted the need to integrate the optimization methods presented in this manuscript with a posteriori evaluations based on engineering judgment to support the implementation of dynamically adaptive design for control strategies in large scale operational networks in particular expert feedback is required to iteratively refine the formulation and improve the features of the solutions of the optimization problem declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests herman a mahmoud edward c keedwell ivan stoianov filippo pecci reports financial support was provided by engineering and physical sciences research council aly joy ulusoy reports financial support was provided by engineering and physical sciences research council declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to acknowledge the funding from the epsrc dynamically adaptive and resilient water supply networks for a sustainable future ep p004229 1 ukri epsrc impact acceleration accounts iaa and the epsrc cdt in sustainable civil engineering the authors would also like to thank kevin henderson bristol water for providing the case study network bwpnet as well as the anonymous reviewers for their valuable feedback and suggestions supplementary material the hydraulic model of the case study network bwpnet is available online at https data mendeley com datasets rsk3jvy22f together with with additional information i e the dma memberships of network nodes supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118914 appendix a supplementary materials supplementary data s1 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s1 
15672,this paper investigates control and design for control strategies to improve the resilience of sectorized water distribution networks wdn while minimizing pressure induced pipe stress and leakage both evolutionary algorithms ea and gradient based mathematical optimization approaches are investigated for the solution of the resulting large scale non linear nlp and bi objective mixed integer non linear programs bominlp while eas have been successfully applied to solve discrete network design problems for large scale wdns gradient based mathematical optimization methods are more computationally efficient when dealing with large search spaces associated with continuous variables in optimal network control problems considering the advantages of each method we propose a sequential hybrid method for the optimal design for control of large scale wdns where a refinement stage relying on gradient based mathematical optimization is used to solve continuous optimal control problems corresponding to design solutions returned by an initial ea search the proposed method is applied to compute the pareto front of a bi objective design for control problem for the operational network bwpnet where we consider reopening closed connections between isolated supply areas the results show that the considered design for control strategy increases the resilience of bwpnet while minimizing pressure induced leakage moreover the refinement stage of the proposed hybrid method efficiently improves the coarse approximation computed by the initial ea search returning a continuous and even pareto front approximation keywords resilience pressure management design for control bi objective optimization mixed integer non linear programming evolutionary algorithms 1 introduction water distribution networks wdns have a critical public health function as a result water utilities need to comply with strict operational requirements the need for operators to maintain performance levels under financial and environmental constraints despite increasing customer demand and asset deterioration results in challenging design and control problems in order to address these challenges this paper investigates the application of evolutionary algorithms ea and gradient based mathematical optimization methods to the design for control dfc of dynamically adaptive water distribution networks the operational challenges facing water utilities are illustrated by bwpnet a case study network adapted from an operational wdn in england fig 1 water utilities in england and wales are required by the water services regulation authority to minimize water losses ofwat 2019 this has lead to the widespread implementation of network sectorization awwa water loss control committee 2003 uk water industry research 1999 i e the partitioning of wdns into single feed district metered areas dma using boundary valves bv bwpnet for instance is divided into 12 dmas despite facilitating pressure management and leakage monitoring permanent network sectorization reduces the redundancy of wdns and increases the risk of interruptions of supply although the resilience of sectorized wdns can be improved at minimal cost by reopening closed bv and aggregating dmas permanently reopening bvs can result in flow reversals high pressure levels and leakage to preserve the benefits of sectorization while improving network resilience bvs between dmas can be either partially reopened or replaced with dynamically adaptive e g time or flow modulated control valves the benefits of dynamically adaptive dma aggregation combined with the optimal control of pressure reducing valves prv were first demonstrated by wright et al 2014 on an operational network the study does not however provide a design methodology for identifying the optimal set of closed bvs to reopen or replace with control valves di nardo et al 2016 on the other hand propose a dynamic partitioning approach for non sectorized wdns with the objective of maximizing network resilience the authors first apply a clustering algorithm to assign nodes to dmas before optimizing the placement of flow meters or remotely controlled gate valves at dma boundaries using a genetic algorithm ga finally giudicianni et al 2020 propose a methodology to aggregate dmas by reopening closed bvs in a sectorized wdn using a community detection algorithm and ga the authors optimize the placement of new gate valves and flow meters to maximize the resilience index todini 2000 of larger aggregated dmas the problem formulations adopted by di nardo et al 2016 and giudicianni et al 2020 however do not consider optimizing the control settings of pressure reducing or sustaining valves in this paper we investigate a dynamically adaptive dma aggregation strategy for the joint minimization of pressure induced leakage and maximization of resilience where closed bvs between dmas represent candidates for partial reopening or replacement with automatic control valves we focus on the replacement of bvs with non return prvs but other forms of pressure reducing or sustaining control valves can also be considered the optimal aggregation of dmas results in a bi objective design for control dfc problem combining discrete and continuous variables which consists in identifying simultaneously the optimal set of bvs to reopen or replace with prvs and optimal control settings for new and existing prvs optimal wdn design control and design for control problems have been previously solved using both heuristic methods araujo et al 2006 atkinson et al 2014 cunha and sousa 1999 liberatore and sechi 2009 nicolini and zovatto 2009 savic and walters 1997 and gradient based deterministic mathematical optimization methods bragalli et al 2008 dai and li 2014 pecci et al 2017a while gradient based mathematical optimization methods deal efficiently with continuous variables and exact methods provide global optimality bounds the size of problems involving both integer variables and non convex constraints which can be solved using global solvers remains limited sahinidis 2019 as a result solving optimal design or design for control problems to global optimality is intractable for operational wdns on the other hand heuristic approaches such as evolutionary algorithms ea have been successfully applied to compute satisfactory solutions for large instances of multi objective wdn design problems guo et al 2007 yazdi 2016 previous studies suggest however that the number and precision of continuous variables in real world optimal wdn control and design for control problems which result in extremely large search spaces can significantly impact the computational efficiency of eas maier et al 2014 approaches to overcome the limitations of evolutionary algorithms and gradient based mathematical optimization include hybridization harada et al 2006 shukla 2007 sindhya et al 2008 this paper proposes and investigates the application of a tailored hybrid method to solve the multi objective design for control problem of dma aggregation in operational wdns such as bwpnet the manuscript is organized as follows in section 2 we introduce the case study network bwpnet and the considered wdn control and design for control dfc strategies which are formulated as optimization problems in section 3 we first investigate the optimization of prv control settings in the sectorized bwpnet network with the single objective of minimizing pressure induced pipe stress and leakage the optimal wdn control problem is solved in section 4 using both evolutionary algorithms ea and gradient based mathematical optimization while the results show that gradient based mathematical optimization methods are more efficient for the solution of the continuous wdn control problem they do not scale well for the solution of wdn design for control problems which involve discrete decision variables in order to solve the design for control problem of dma aggregation in bwpnet which consists in reopening or replacing closed bvs with prvs and simultaneously optimizing the control settings of prvs for the joint minimization of pressure induced leakage and maximization of resilience section 5 then investigates a hybrid method combining evolutionary algorithms ea and gradient based mathematical optimization finally we discuss the performance of the hybrid method and the benefits of dma aggregation and present our conclusions in section 6 2 presentation of the network and considered control and design for control strategies the case study network considered in this paper bwpnet is adapted from an operational network in england in this section we describe bwpnet and propose control and design for control strategies to improve the performance of the network 2 1 bwpnet bwpnet counts n n 10 100 nodes junctions or customer demand nodes n 0 3 sources or reservoirs and n p 10 597 links which include 18 prvs and 57 closed bvs located at the boundaries between dmas the network is sectorized into 12 dmas of which 10 are single feed dmas and the remaining 2 have two inlets each friction head losses across network links are modeled by the darcy weisbach d w equation for the optimal control and design for control of bwpnet we consider a set of loading conditions customer demands and heads at sources representative of a typical day of network operation to illustrate the improvements in performance which can be achieved under normal operating conditions in particular a 15 minute time step is adopted for daily demand patterns representing n t 96 time steps over 24h it is recommended that solutions returned by the optimization be then validated against peak or extreme loading conditions prior to their implementation throughout this paper a network design refers to the fixed status of bvs open closed and candidate prvs selected for installation or not while a network configuration corresponds to the union of a network design and a set of prv control settings in the current or initial configuration of bwpnet against which we evaluate improvements in network performance all bvs are closed sectorized design and all existing prvs are considered fully open next we describe the control and design for control strategies investigated for bwpnet and the mathematical formulation of the corresponding optimization problems 2 2 optimal control and design for control strategies the first task is to optimize the control settings of existing prvs for the current network design in order to minimize pressure induced pipe stress and leakage the operational drawbacks of network sectorization and recent work on dynamically adaptive networks see section 1 then motivate the investigation of a design for control strategy for the joint minimization of pressure induced leakage and maximization of resilience in particular the dma aggregation strategy investigated in this manuscript increases the redundancy in connectivity by reopening closed bvs between dmas the objective is to improve the resilience of the network to pipe failures by increasing the number of alternative supply paths however most bvs cannot be permanently reopened without causing flow reversals across dmas moreover fully opening bvs without introducing additional pressure control results in high pressure levels and pressure induced pipe stress and leakage under normal operating conditions as a result we formulate and investigate the solution of three problems for the optimal control and design for control of bwpnet summarized in fig 2 these problems are referred to as tasks 1 2 and 3 1 task 1 consists in optimizing the control settings of existing prvs in the current sectorized network design to minimize pressure induced pipe stress and leakage this task reflects standard pressure and leakage management practices adopted in the water industry in england and wales task 1 results in a continuous single objective optimization problem 2 for task 2 we investigate the bi objective wdn design for control problem of dma pairing for the joint maximization of resilience and minimization of pressure induced pipe stress and leakage closed bvs are selected for reopening or replacement with non return prvs subject to the aggregation of every dma with at most one neighboring dma and control settings of new and existing prvs are simultaneously optimized in particular if dma a shares one or more boundaries with dmas b and c then dma pairing prevents simultaneously reopening or replacing bvs isolating a from b and bvs isolating a from c see also ulusoy et al 2019 appendix a for the definition of the dma pairing constraint the dma pairing constraint which derives from discussions with water network operators limits the total number of bvs that can be reopened or replaced with prvs this restriction represents a trade off between the redundancy and complexity of operating multi feed pressure managed areas 3 finally task 3 extends task 2 by removing the dmas pairing constraint and investigates the bi objective wdn design for control problem of dma aggregation note that task 1 does not require additional capital investment in comparison the costs of the solutions of tasks 2 and 3 depend on the results of the optimization e g whether bvs can be partially reopened or whether new time flow modulated prvs need to be installed finally task 2 demonstrates that the proposed design for control strategy can incorporate constraints imposed by network operators 3 formulation of the wdn control and design for control problems in this section we present a mathematical formulation of the wdn control and design for control problems corresponding to tasks 1 2 and 3 we use a steady state discrete time demand driven hydraulic model we define the index set e p of network links and subsets e prv e p and e bv e p of existing prvs and closed bvs which are candidates for partial reopening or replacement with prvs we consider n t 96 different time steps of network operation which corresponds to a day of operation using a 15 minute time steps at time step k 1 n t we denote by h k r n n the vector of unknown hydraulic heads while q k r n p represents the vector of unknown flows the vector of known nodal demands is given by d k r n n and known hydraulic heads at water sources by h 0 k r n 0 let ζ and h min r n n be the vectors of known elevations and minimum allowed hydraulic heads at network nodes respectively in compliance with the dg2 serviceability indicator ofwat 2004 defined by ofwat for england and wales the minimum allowed hydraulic head h i min of a node i is defined as the elevation ζ i of i plus the minimum allowed pressure at that node which is 10 m for customer nodes we also introduce the unknown vector η k r n p to model the additional head difference across links introduced by the action of non return prvs and bvs hydraulic heads h k flows q k and additional head differences η k are subject to mass and energy conservation constraints 1a a 12 t q k d k 0 k 1 n t 1b a 12 h k a 10 h 0 k ϕ q k η k 0 k 1 n t where a 12 r n p n n and a 10 r n p n 0 are the link node incidence matrices for demand nodes and water sources respectively friction head losses associated with pipe flows q k q 1 k q n p k t represented by the vector ϕ q k ϕ 1 q 1 k ϕ n p q n p k t are described by the non smooth darcy weisbach d w formula upper and lower bounds on variables q k h k and η k respectively are represented using the vectors q u k q l k h u k h l k η u k and η l k r n p such that 2 q l k q k q u k k 1 n t h l k h k h u k k 1 n t η l k η k η u k k 1 n t where h u k max i 1 n 0 h 0 k i 1 n n h l k h min and for the sake of brevity q u k q l k η u k and η l k are defined for pipes prvs and bvs by eqs a 4 to a 6 in appendix a finally to model design decisions regarding the status of bvs j e bv in tasks 2 and 3 we introduce the binary decision variables z z z 0 1 n bv indexed by l j 1 n bv and we set z z z z for j e bv each binary decision variable z l j z l j and z l j represents a different design option namely z l j 1 corresponds to partially reopening bv j z l j 1 corresponds to replacing bv j with a non return prv in the assigned positive direction of the bv and z l j 1 corresponds to replacing j with a non return prv in the negative direction on the other hand if z l j z l j z l j 0 then bv j is kept closed and flows across j are forced to zero at all time steps note that this is the case for all j e bv in task 1 in the formulation of the optimization problem the status of bvs is represented using big m constraints and constraints on flow and head loss directions across new prvs are modeled using bilinear constraints see eqs a 1 a 2 and a 3 in appendix a 3 1 task 1 water utilities in england and wales are financially incentivized by ofwat to reduce water losses due to e g pipe bursts or background leakage resulting from joints or small cracks in pipes one of the main factors influencing pipe bursts and leakage in wdns is pressure here we use the average zone pressure wright et al 2015 as a surrogate measure of pressure induced pipe stress and leakage 3 azp 1 n t w k 1 n t w t h k ζ where w r n n and w r are the vector of azp weights and the azp normalization factor respectively for i v we define j i the set of all pipes incident to node i then w i j j i l j 2 and w i 1 n n w i where l r n p is the vector of pipe lengths the wdn control problem corresponding to task 1 results in the following single objective non linear program nlp nlp minimize azp subject to linear mass conservation equations 1a non convex energy conservation equations 1b upper and lower bounds 2 big m constraints modeling bvs closure a 1 and a 2 for fixed z 0 n bv z 0 n bv z 0 n bv bi linear head loss directional constraints a 3 3 2 tasks 2 and 3 in addition to minimizing water losses a key performance commitment for water utilities is to minimize supply interruptions and customer minutes lost which depend on the resilience of a wdn i e the ability of a wdn to maintain continuous customer supply under failure conditions the resilience of a wdn is underpinned by the availability of alternative supply paths topological redundancy and pressure surplus energy redundancy it can be estimated from simulating the network under failure conditions however this approach suffers from combinatorial limitations as it requires the simulation of a wide range of failure scenarios which makes it challenging to incorporate within an optimization framework in comparison surrogate measures of resilience depend only on the topology of the network or its performance under normal operating conditions a commonly adopted surrogate measure of resilience for the design of wdns is the resilience index todini 2000 which is defined for any time step k 1 n t as the ratio of surplus energy to total energy input under normal operating conditions 4 d k t h k d k t h min a 10 h 0 k t q k d k t h min based on 4 we can define the average energy efficiency of the network over a day of operation by 5 ri 1 n t k 1 n t d k t h k d k t h min a 10 h 0 k t q k d k t h min we observe from 3 and 5 that both azp and ri are increasing functions of the hydraulic heads at network nodes as a result the minimization of azp and the maximization of ri are conflicting objectives the sectorization of bwpnet which facilitates pressure management and leakage reduction negatively impacts the resilience of the network as it reduces the redundancy in connectivity and increases energy losses as a result tasks 2 and 3 investigate bi objective wdn design for control problems which consist in simultaneously identifying closed bvs to reopen or replace with new prvs and computing optimal prv control settings with the objectives of maximizing ri and minimizing azp the partial reopening or replacement of closed bvs with prvs is limited to a single decision per bv j e bv and is subject to the additional constraint of dma pairing in task 2 the combinatorial constraints on the binary decision variables z l j z l j z l j 0 1 corresponding to task i i 2 3 are represented by equation b i which is described in appendix a the resulting bi objective mixed integer non linear programs bominlp which correspond to the design for control strategies of task i i 2 3 are formulated as follows bominlp minimize azp maximize ri subject to linear mass conservation equations 1a non convex energy conservation equations 1b upper and lower bounds 2 big m constraints modeling bvs operation a 1 and a 2 bi linear head loss directional constraints a 3 combinatorial constraints b i z z z 0 1 n bv problems nlp and bominlp represent the general mathematical formulations of the optimization problems corresponding to tasks 1 2 and 3 note that these formulations are not explicitly adopted in the ea approaches described below where hydraulic feasibility constraints are implicitly handled by the hydraulic solver here we use epanet2 0 rossman 1994 4 solution of the wdn control problem task 1 we first investigate the single objective wdn control problem nlp described in section 3 the objective is to find optimal control settings for existing prvs to minimize azp over 96 time steps i e a day of operation for the fixed dma sectorization of bwpnet i e z l j 0 z l j 0 z l j 0 for all j e bv in this section we apply and compare the performance of two different methods for the solution of the continuous problem nlp the benefits of optimal pressure management in the sectorized network bwpnet are also discussed 4 1 solution methods both eas and gradient based mathematical optimization mo approaches have been previously applied for the optimization of wdns in this section we investigate the application of approaches from these two families of methods to the solution of the continuous single objective wdn control problem nlp details of the different implementations are presented in table 1 4 1 1 evolutionary algorithm evolutionary algorithms ea are population based optimization methods inspired by the genetic processes in biological organisms and the principle of natural evolution in an ea search a population of chromosomes which define a set of potential solutions are initially created and modified through selection crossover and mutation promising candidate solutions are selected from the population and perturbed by a sequence of unary mutation type and higher order crossover type transformations these individuals strive for survival through a selection scheme which is biased towards fitter individuals after a number of generations the program converges with no guarantee of optimality eas have been shown to be valuable tools for solving complex optimization problems in the engineering field and in particular water system design problems maier et al 2014 mala jetmarova et al 2018 for task 1 a single objective genetic algorithm ga goldberg and kuo 1987 is applied as an ea approach to find optimal pressure settings for existing prvs with a 15 minute time step in the ea search the epanet2 0 rossman 1994 hydraulic solver is used to ensure individual solutions defined by a set of prv control settings are hydraulically feasible and evaluate their fitness note that in preliminary experiments total head deficits associated with solutions returned by the mathematical optimization ranged between 0 and roughly 20 m over all network nodes and all time steps due to errors introduced by the quadratic approximation of the darcy weisbach friction head loss formula see section 4 1 2 as a result in order not to disadvantage the ga by rejecting solutions which might be considered feasible by the mathematical optimization minimum pressure constraints are relaxed to accept solutions with up to 30 m of cumulative violations over all nodes and all time steps this corresponds to an average 0 3 m cumulative pressure violation over all nodes at each time step which compared to the uncertainty associated with the hydraulic model and measurements for an operational water network such as bwpnet is small enough to justify that the relaxation does not in practice affect the feasibility of the solutions returned by the ga 4 1 2 mathematical optimization in order to apply gradient based mathematical optimization methods to the solution of the continuous problem nlp we reformulate the non smooth head loss term in the energy conservation eq 1b and the bi linear head loss directional constraints a 3 quadratic approximation of the d w head loss formula we first consider the vector of friction head losses ϕ q k ϕ 1 q 1 k ϕ n p q n p k t which is described by the non smooth darcy weisbach d w formula section 3 as the explicit approximation of the d w equation involves a non smooth rational exponent the hessian is unbounded around the origin as a result the d w equation is difficult to handle in a smooth mathematical optimization framework instead it is more convenient to use a quadratic approximation of the formula given by ϕ q k ϕ 1 q 1 k ϕ n p q n p k t where ϕ j q j k q j k a j q j k b j and a j b j r 2 are positive coefficients computed for each pipe j in the network this is a common approach in the literature dai and li 2014 eck and mevissen 2015 pecci et al 2017b zamzam et al 2019 previous studies and the results reported in appendix b demonstrate that the use of a quadratic approximation does not affect the accuracy of the hydraulic model for bwpnet in particular the difference between the hydraulic head values obtained using the d w formula and its quadratic approximation does not exceed 0 1 m for more than 98 of network nodes this error is significantly less than the uncertainty associated with the hydraulic model and measurements for an operational water network such as bwpnet in order to apply the quadratic approximation of the d w formula the non convex friction head loss term ϕ q k is isolated by introducing the vector of auxiliary variables θ k r n p and constraint 1b becomes 6a a 12 h k a 10 h 0 k θ k η k 0 k 1 n t 6b θ k ϕ q k k 1 n t where 6b is the non convex friction loss equality constraint while constraint 6a is linear reformulation of the bi linear head loss positivity constraints using a penalty method next we reformulate the bi linear constraints a 3 also called vanishing constraints which model the disjunctive behaviour of non return valves prvs by preventing reverse flows and decoupling the hydraulic heads at the extremities of closed prvs due to the geometry of the feasible set defined by constraints a 3 most classical constraint qualifications on which non linear solvers rely to define optimality conditions do not hold achtziger and kanzow 2008 dussault et al 2019 hoheisel 2009 see figure c 1 in appendix c a common approach is to regularize the thin domain of the problem achtziger et al 2012 hoheisel et al 2012 izmailov and solodov 2009 by introducing for instance an auxiliary variable t such that 7 0 q j k η j k t k 1 n t j e prv e bv and a penalty function depending on t and a parameter ρ in the objective we implement the quadratic approximation and penalization approach to reformulate nlp which is rewritten as the ρ parametrized problem 8 minimize x q h η θ t azp x ρ t subject to linear mass and energy conservation constraints 1a and 6a non convex friction head loss constraints 6b upper and lower bounds 2 big m constraints on flows and head differences a 1 and a 2 for fixed z 0 n bv z 0 n bv z 0 n bv bi linear penalty constraints 7 t 0 nlp ρ where x q h η θ represents the hydraulic variables of the problem note that while the decision variables of the control problem i e prv control settings are represented by the additional head loss η the auxiliary variables q h and θ representing unknown flows heads and friction headloss across network pipes are used to explicitly define the objective function and mass and energy conservation constraints finally the optimal value of problem nlp defined over all time steps can be found by solving n t 96 independent smaller problems of the form 8 one for each time step k 1 n t counting over 30 000 continuous variables 20 000 linear constraints and 10 000 non convex constraints each using off the shelf non linear programming solvers in most of our numerical experiments a solution satisfying the bi linear head loss directional constraints a 3 is obtained by solving 8 for ρ 10 6 however if the solver fails to converge to a solution we consider the sequence of sub problems nlp ρ k for ρ 1 10 3 and ρ k 1 10 ρ k until ρ k 10 6 moreover for k 1 the solution of nlp ρ k 1 is initialized at the solution of the previous sub problem a candidate solution of the original wdn control problem nlp is then obtained by performing a hydraulic simulation of the network in epanet 2 0 where prv control settings are given by the solution of 8 the results of the hydraulic simulation are used to verify the feasibility of the solution and quantify the cumulative violation of minimum pressure requirements which is also limited to 30 m at all time steps 4 2 results the results obtained for the single objective wdn control problem nlp corresponding to task 1 with both the ea and mathematical optimization methods show a significant reduction in azp in the sectorized network the optimal control settings computed with the ea approach for instance reduce network azp from 37 6 m to 29 9 m as expected a reduction in ri is also observed figures d 1 and d 2 in appendix d represent respectively the time based and flow modulation profiles of the optimal settings obtained for each prv total pressure violations azp and ri values of the original and optimal sectorized configurations are summarized in table 3 and figure d 3 note that cumulative pressure violations over all network nodes do not exceed 0 25 m on average at any given time step for the solutions obtained with ea and mathematical optimization below we present the details of the implementation and the results obtained with the ea and mathematical optimization methods 4 2 1 using ea a steady state ga is first applied to solve the wdn control problem corresponding to task 1 see tables 1 and 2 for details of the implementation random solutions as well as the initial network configuration i e fully open prvs are initially injected into the ga population the values of decision variables corresponding to prv settings are set to range between 0 m and 45 m the results of the implementation show that the azp value starts to converge after approximately 60 000 fitness evaluations or 34 9 h and the final value reached at the end of the evaluations is 29 9 m see table 2 this is 0 4 m less than the final value returned by the gradient based mathematical optimization method see below and it is a substantial reduction in azp from the initial value of 37 6 m 4 2 2 using mathematical optimization we apply the non linear solver ipopt v3 12 9 wachter and biegler 2006 using the matlab interface currie et al 2012 to solve for ρ 10 6 n t 96 reformulated problems 8 one for each time step k see table 1 for details of the implementation for k 1 n t the search is initialized at x 0 k q 0 k h 0 k η 0 k θ 0 k which corresponds to the solution of the hydraulic simulation of the initial bwpnet configuration i e all prvs fully open with 8 threads running in parallel the wdn control problem is solved in around one minute the optimal azp value returned by the solution of the reformulated problem 8 is 30 1 m in comparison the azp value obtained with epanet 2 0 using the optimal prv control settings returned by the solution of the optimization problem is 30 3 m 4 3 discussion next we discuss the results obtained for task 1 we comment on the improvement in azp in bwpnet before comparing the performance of ea and gradient based mathematical optimization methods for the solution of the wdn control problem 4 3 1 optimal prv control settings and improvement in network performance figure 3 shows the daily azp variations in different areas of the network before and after the optimization of prv control settings areas 3029 3030 3040 3050 3080 3081 3082 3090 3094 3095 3120 and 3130 correspond to dmas while the remaining areas include network transmission mains and isolated customer connections see also fig 1 this is the case of area 3078 for instance where the largest differences are observed between the results obtained using the ea and mathematical optimization methods these differences are explained by the fact that the optimal configuration returned by the ea search requires closing an existing prv whereas in the optimal configuration found with gradient based mathematical optimization all existing prvs support positive head differences and flows see figures d 1 and d 2 this results in higher azp values across transmission mains sections 3078 and 1117 further numerical experiments show that this behavior is due to the sensitivity of the gradient based mathematical optimization method to the initial point provided to ipopt across all other areas of the network however the daily azp variations corresponding to the optimal configurations returned for task 1 by the ea and gradient based mathematical optimization method are nearly identical we also observe that compared to the initial network configuration the implementation of optimal prv control settings achieves significant reductions in azp exceeding 15 m on average throughout the day in dmas 3030 3081 3082 3090 and 3094 despite the limited improvements achieved in other dmas e g 3080 and sections of transmission mains e g 1147 3098 3139 the results obtained for task 1 highlight the potential to substantially reduce pressure and leakage in specific areas of bwpnet by applying optimization methods to derive the control settings of existing prvs 4 3 2 comparison of ea and mathematical optimization approaches the results obtained for task 1 show that ea and mathematical optimization converge to similar solutions however a comparison of computation times shows that the gradient based mathematical optimization approach returns a feasible solution in one minute this solution is nearly as good as the final solution obtained with ea in over 34 h the number range and precision of continuous control variables as well as the number of time steps considered in task 1 result in an extremely large search space for eas this represents a main challenge for the application of eas to the optimization of wdns maier et al 2014 as eas balance the need for reducing the size of the search space with the risks of reducing solution precision and excluding globally optimal solutions the difference in the orders of magnitude of solution times suggest that mathematical optimization methods are more efficient for the solution of the continuous wdn control problem in particular while it is possible to include extreme loading conditions derived from historic demand data or based on a fixed multiplier in the formulation of the optimal design for control problem the performance of the non linear solver ipopt on the wdn control problem suggests that for a fixed wdn design mathematical optimization can be efficiently applied to occasionally or periodically e g daily or weekly recompute prv control settings in response to changes in operating conditions or uncertainties in the network model however gradient based mathematical optimization methods do not scale well for the solution of wdn design for control problems which involve discrete decision variables in order to address the limitations of eas and gradient based mathematical optimization methods while exploiting their respective advantages we propose a hybrid method for the solution of the bi objective wdn design for control problems corresponding to tasks 2 and 3 restricted wdn design for control problems are first solved using eas to produce an initial set of potentially pareto optimal design solutions i e solutions that are not dominated by any solution generated so far the design of the network is then fixed to the solutions returned by the ea and gradient based mathematical optimization methods are applied to efficiently solve the resulting optimal control problems 5 solution of the wdn design for control problems tasks 2 and 3 the results of task 1 show that the implementation of optimal prv control settings achieve significant reductions in azp in certain areas of bwpnet however we also observe a reduction in ri in this section we investigate a design for control strategy based on the aggregation of dmas to jointly maximize ri and minimize azp in bwpnet in task 2 we solve the bi objective wdn design for control problem of optimal dma pairing in bwpnet where closed bvs are considered as candidates for reopening or replacement with prvs subject to the combinatorial dma pairing constraints b 2 see appendix a the wdn design for control problem consists in simultaneously optimizing the settings of partially reopened bvs and controls of new and existing prvs task 3 which extends task 2 corresponds to the bi objective wdn design for control problem of optimal dma aggregation although the aggregation of dmas is no longer subject to pairing design decisions i e partial bv reopening or replacement with a prv are limited to one per bv as represented by the combinatorial constraints b 3 see appendix a in this section we present and investigate a hybrid method combining ea and gradient based mathematical optimization for the solution of the bominlps corresponding to tasks 2 and 3 5 1 hybrid solution method the size of minlps which can be solved using exact solvers implementing gradient based mathematical optimization methods remains relatively small compared to the wdn design for control problems corresponding to tasks 2 and 3 kronqvist et al 2019 although tailored global solution methods have been shown to outperform off the shelf solvers in a number of instances sahinidis 2019 including applications to wdns pecci et al 2018 ulusoy et al 2019 solving optimal design for control problems for large scale wdns to global optimality using exact methods is intractable at present in practice heuristic methods are used to reduce the search space and compute good feasible solutions for the optimal design for control of operational systems pecci et al 2019 this paper investigates a hybrid method where gradient based mathematical optimization is applied to refine an initial set of potentially pareto optimal solutions returned by an ea search for the bi objective wdn design for control problems of optimal dma pairing and aggregation several studies in the literature have investigated refinement or local search strategies based on heuristics or gradient based mathematical programming methods within or following eas to accelerate convergence to the true pareto front see koch et al 2009 sindhya et al 2008 for a review the resulting hybrid methods make use of the complementary advantages of successful global and local optimization methods in this work we investigate a two stage method based on the serial or sequential hybridization of ea and gradient based mathematical optimization for the solution of the bi objective wdn design for control problems bominlp corresponding to tasks 2 and 3 see fig 4 a network design refers to the fixed status of bvs open closed and candidate prvs selected for installation or not while a network configuration corresponds to the union of a network design and a set of prv control settings in stage 1 an ea search is performed to solve a restricted wdn design for control problem where prv settings are considered fixed over time this returns a set of potentially pareto optimal configurations c which represents a coarse approximation of the pareto front of bominlp then we select a subset d of designs whose configurations are in c although we do not define a general approach for selecting d case specific approaches are presented for tasks 2 and 3 in section 5 2 in stage 2 we formulate and solve using gradient based mathematical optimization a bi objective control problem with time based prv control settings for each design in d the obtained solutions are added to the pareto front approximation formed by the configurations in c and dominated solutions are excluded the refinement algorithm stops when all designs in d have been considered the application of sequential hybrid approaches combining gradient based mathematical optimization with heuristics has previously been considered for the least cost design and or operation of small to moderate sized case study wdns in zheng et al 2011 qiu et al 2021 for instance the authors first implement an algorithm based on mathematical optimization methods which returns a population of feasible solutions used to initialize a ga 5 1 1 stage 1 as part of the hybrid approach an initial search is performed using the non dominated sorting genetic algorithm ii nsga ii deb et al 2002 to solve problems bominlp corresponding to tasks 2 and 3 over a restricted search space the restricted problem consists in simultaneously identifying the optimal set of bvs to reopen or replace with prvs and optimizing a single control setting for each new and existing prv nsga ii is an evolutionary algorithm where a population of solutions grows through the selection mutation and crossover of individuals compared to the steady state ga applied in task 1 however the performance of individual solutions is given by their partial ordering obtained from non dominated sorting of the population in the event that two solutions are equivalent a crowding distance operator prioritizes solutions in less explored areas of the pareto front finally the ea search returns a set c of feasible solutions each corresponding to a network design and fixed control settings for all prvs 5 1 2 stage 2 let d be a subset of designs corresponding to the configurations in c the set of potentially pareto optimal configurations returned by the initial ea search consider a particular design solution z 0 z 0 z 0 d the continuous bi objective wdn control problem associated with network design z 0 z 0 z 0 z 0 and considering time based prv control settings is then given by bonlp z 0 minimize x q h η θ azp x maximize x q h η θ ri x subject to linear mass conservation 1a and non convex energy conservation constraints 1b upper and lower bounds 2 big m constraints on flows and head differences a 1 and a 2 for fixed z z 0 z z 0 z z 0 and bi linear head loss positivity constraints a 3 note that since the wdn control problems corresponding to each time step are independent we can solve n t 96 independent bi objective problems of the form bonlp z 0 producing individual pareto front approximations for each time step a procedure described in proposition f 3 of appendix f is then implemented to derive an approximation of the pareto front for the full problem from points that are potentially pareto optimal for the individual time steps in appendix f we show that our approach returns a subset of supported pareto optimal combinations of control settings for the full problem bonlp z 0 a common approach for solving multi objective optimization problems using gradient based methods is scalarization which converts a multi objective problem into a sequence of parametrized single objective problems for a review of scalarization methods see ehrgott 2006 miettinen 1998 in this paper we use the method of ϵ constraints to convert the bi objective problems bonlp z 0 corresponding to each time step k 1 n t into sequences of single objective nlps in the method of ϵ constraints the first objective function is optimized subject to upper or lower bounding constraints on the others here we solve a sequence of parametrized problems where azp is minimized subject to lower bounding constraints on ri by applying the quadratic approximation the penalty reformulation and the method of ϵ constraint to bonlp z 0 we obtain a sequence of n ϵ non convex nlps parametrized by ϵ i i 1 n ϵ 0 1 counting over 30 000 continuous variables 20 000 linear constraints and 10 000 non convex constraints each 9 minimize x q h η θ t azp x ρ t subject to ri x ri ϵ i ri x ri ri x azp ri x linear mass and energy conservation constraints 1a and 6a non convex friction head loss constraints 6b upper and lower bounds 2 big m constraints on flows and head differences a 1 and a 2 for fixed z z 0 z z 0 z z 0 bi linear penalty constraints 7 t 0 nlp ρ ϵ i z 0 where for f azp or ri x f is the solution of the single objective optimization problem obtained by considering only the objective function f and ignoring the second objective in bonlp z 0 we set ϵ i i n ϵ i 1 n ϵ and show that by combining the resulting n t 96 individual pareto front approximations obtained for n ϵ 20 according to the procedure presented in appendix f we obtain an even distribution of potentially pareto optimal solutions of the bi objective problem bonlp z 0 we define ρ 10 6 and implement an off the shelf non linear programming solver to compute locally optimal solutions for the sequence of scalarized problems 9 for any i 1 n ϵ if the solver does not converge to a feasible solution we consider the sequence of problems nlp ρ k ϵ i z 0 for ρ 1 10 3 and ρ k 1 10 ρ k until ρ k 10 6 finally a candidate pareto optimal solution for the original problem bominlp is recovered by performing a hydraulic simulation in epanet 2 0 where prv control settings are given by the solution of 9 if the configuration is feasible and in particular if it verifies minimum pressure requirements it is compared against current potentially pareto optimal configurations to update the set c see fig 4 5 2 results the bi objective wdn design for control problems corresponding to tasks 2 and 3 are solved using the hybrid method presented in section 5 1 the potentially pareto optimal solutions obtained which correspond to the best trade offs between leakage management and improvement in resilience that can be achieved with dma pairing and aggregation in bwpnet are represented in fig 5 for both tasks 2 and 3 an initial search is carried out using nsga ii where prv control settings are considered fixed over time see table 1 and lines 2 and 3 in table 2 for details of the implementation of the initial ea search stage decision variables corresponding to the settings of existing prvs and boundary valves selected for replacement with prvs are set to range between 0 and 45 m for decision variables corresponding to partially or fully reopened boundary valves on the other hand valve setting values i e unitless loss coefficients range between 0 and 6 10 6 finally the hypervolume indicator is used as a stopping criterion to measure the quality of the pareto front approximation generated by nsga ii given a potentially pareto optimal design z 0 returned by the initial search stage we apply the non linear solver ipopt v3 12 9 wachter and biegler 2006 using the matlab interface currie et al 2012 to solve n t 96 sequences of continuous problems 9 i 1 n ϵ see table 1 for details of the implementation of the refinement stage 5 2 1 task 2 initial results show that when applied directly to the problem of selecting bvs for reopening or replacement and optimizing fixed prv settings for the problem of optimal dma pairing nsga ii fails to find a feasible solution in under 50 000 evaluations while minimum pressure constraints are easily satisfied at all nodes the algorithm struggles with the combinatorial dma pairing constraints in order to reduce the set of candidate bvs for reopening or replacement with prvs we run a series of hydraulic simulations over 24 h in epanet 2 0 opening one bv at a time all existing prvs are fully open and we measure the resulting minimum pressure violations and ri a pairwise comparison of the results is then performed for every pair of bvs violating the combinatorial dma pairing constraints the bv associated with the highest minimum pressure constraint violation and the lowest ri when reopened is removed from the set of candidate bvs based on the results of the filtration process the set of candidate bvs for reopening or replacement with prvs is reduced from 57 to 11 considering the restricted subset of candidate bvs defined above the initial search stage for task 2 performed using nsga ii is completed in 21 1 h and a single design z 0 is found to represent all potentially pareto optimal configurations we fix the value of binary variables z z z z in bominlp to z 0 reformulate the resulting bi objective problem bonlp z 0 and solve a sequence of parametrized problems 9 for each time step using ipopt the refinement stage is completed in 2 1 h and the combination of the resulting n t 96 individual pareto front approximations provides a continuous distribution of over a thousand potentially pareto optimal solutions of the original problem bonlp z 0 the potentially pareto optimal solutions returned by the initial search and refinement stages of the hybrid method are presented in fig 5 5 2 2 task 3 in comparison to task 2 potentially pareto optimal solutions found for task 3 in the initial search stage cannot be described with a single design z 0 this is illustrated by figure e 1 a in appendix e which represents the number of occurrences on the coarse pareto front approximation of the 105 different designs corresponding to the solutions returned by nsga ii solving a sequence of parametrized problems 9 for all 105 unique designs found in the initial search stage is not tractable instead for the refinement stage we consider only network designs with the largest number of occurrences on the pareto front which are expected to achieve better trade offs between the objectives over a greater range of azp and ri values in particular the designs denoted by 1 2 and 4 in appendix e correspond respectively to 4 5 and 10 pareto optimal solutions returned by nsga ii and span separate sections of the initial pareto front approximation see figure e 1 b as a result we fix in turn the design variables z in bominlp to the values corresponding to designs 1 2 and 4 from figure e 1 appendix e we solve the corresponding bi objective problems bonlp z 0 for each time step k 1 n t before combining the resulting n t 96 pareto fronts according to the procedure in appendix f the potentially pareto optimal solutions returned by the initial search and refinement stages of the proposed hybrid method are represented in fig 5 5 3 discussion in this section we discuss the hydraulic interpretation and performance of the potentially pareto optimal configurations obtained for the bi objective wdn design for control problems of dma pairing and aggregation corresponding to the solutions represented in fig 5 finally we comment on the performance of the proposed sequential hybrid method 5 3 1 improvement in network performance for task 2 a single network design which includes the replacement of 11 closed bvs with prvs and the creation of 4 new pairs of dmas is found to describe all potentially pareto optimal solutions and achieve good trade off configurations for both high average resilience index and low azp values in task 3 on the other hand different designs allow for better trade offs depending on the priorities of a network operator out of the 3 designs returned by the hybrid method the design which allows to achieve the best trade offs for higher average resilience index values requires reopening 6 bvs and replacing 17 bvs with prvs in comparison the network design corresponding to the potentially pareto optimal solutions achieving the lowest azp values requires replacing 9 bvs with prvs and reopening 5 of them the results of task 3 suggests that designs with increased topological redundancy i e which require partially reopening or replacing more bvs with prvs achieve the largest improvements in network resilience and provide the best trade off options between azp and ri around high ri values this is supported by the analysis of the potentially pareto optimal configurations obtained for task 2 as we move along the pareto front approximation from the bottom left i e low azp values to the top right corner i e high ri values potentially pareto optimal configurations correspond to opening more bvs and prvs over more time steps finally compared to the azp reduction achieved in task 1 the results presented in fig 5 show that dma pairing task 2 and aggregation task 3 do not allow to further reduce pressure induced leakage levels in bwpnet however the geometries of the pareto front approximations corresponding to tasks 2 and 3 and in particular the steep section spanning the range of low azp values show that by reopening or replacing closed bvs with new prvs nearly optimal azp values can be achieved while significantly improving ri dma pairing task 2 for instance allows to reach ri values of 0 68 while maintaining network azp under 31 m whereas it is possible to recover initial levels of resilience in bwpnet for less than a 2 m increase in azp compared to the optimal solution of task 1 5 3 2 performance of the sequential hybrid method figure 5 shows that the refinement stage of the proposed hybrid approach efficiently improves the coarse pareto front approximation computed by the initial ea search taking just over 2 h to return a continuous and even pareto front approximation for the wdn design for control problem in task 2 for instance in comparison further numerical experiments show that applying nsga ii instead of gradient based mathematical optimization to solve the refinement stage takes nearly 100 h and results in a pareto front approximation similar to the one returned by the sequential hybrid method moreover the analysis of the results obtained for task 3 shows that the potentially pareto optimal solutions found by nsga ii in the initial search stage correspond to 105 different designs see appendix e figure e 1 a the pareto front obtained after the refinement stage on the other hand contains 3 separate branches each corresponding to a different network design for a decision maker a pareto front approximation consisting of a small number of separate branches each obtained by varying the prv control settings for a given design can be interpreted more easily than a set of 105 different design solutions the high number of different designs returned by nsga ii is likely to be due to the fact that in order to reduce the search space prv settings are considered fixed over time in the initial search stage of the hybrid method this reduces the search space of the wdn design for control problem but also the range of objective values a given design is able to achieve and excludes potentially pareto optimal solutions on the other hand considering independent prv control settings for each time step allows to explore larger solution and objective spaces for each network design the proposed hybrid method is able to efficiently return time based prv control settings for all 96 time steps considered in the formulation of tasks 2 and 3 from which daily control profiles can then be derived 6 conclusion this papers investigates methods to compute dynamically adaptive design for control solutions to improve the pressure management and resilience of large scale water distribution networks the presented methods are applied to the operational case study network bwpnet an optimal control problem for the minimization of average zone pressure azp which is a surrogate metric for pressure induced leakage is formulated as a continuous non linear program and then solved using evolutionary algorithms ea and gradient based mathematical optimization methods after evaluating both approaches we propose and investigate a tailored hybrid method to approximate the pareto front of bi objective mixed integer non linear wdn design for control problems for the minimization of azp and maximization of network resilience ri gradient based mathematical optimization methods are applied to refine a coarse pareto front approximation returned by an initial ea search the proposed hybrid method also includes a procedure to retrieve for a separable problem a subset of supported combinations of potentially pareto optimal solutions of the independent subproblems the proposed hybrid method is applied to the optimal pairing and aggregation of dmas in bwpnet which consists in reopening or replacing closed boundary valves bv with pressure reducing valves prv and optimizing the control settings of new and existing prvs for the joint minimization of azp and maximization of ri the results show that the refinement of the coarse pareto front approximation computed by the initial search stage allows the hybrid method to return a continuous and even pareto front approximation another advantage of the refinement stage of the hybrid approach compared to the coarse pareto front approximation returned by the initial ea search is the interpretability of the results in particular for the bi objective wdn design for control problem of optimal dma aggregation in bwpnet task 3 the solutions returned by the refinement stage of the hybrid method correspond to 3 different network designs in comparison the results of the initial ea search included 105 different network designs the results presented in this paper also show that the proposed optimization method and design for control strategies of dma pairing and aggregation allow water utilities to reduce pressure induced pipe stress and leakage while improving the resilience of their networks in order to maintain continuous customer supply this trade off is becoming critical as utilities operate aging infrastructure under increasing financial pressures and environmental constraints and continuously changing operational priorities in particular among the potentially pareto optimal solutions identified for the dma pairing and aggregation problems in bwpnet we observe that configurations requiring the reopening or replacement of a larger number of bvs with prvs provide a better trade off between the objectives of azp and ri at high ri values the proposed hybrid method could be extended with a concurrent hybrid approach sindhya et al 2008 where gradient based mathematical optimization is implemented within a global search to iteratively compute branches of the pareto front as new potentially pareto optimal designs are found by an ea additional hybridization could also integrate human knowledge to improve the features of individuals in the ea population in interactive evolutionary algorithm iea takagi 2001 for instance fitness evaluation is performed directly by a human expert to guide the optimization towards solutions that are more suitable in practice alternatively human experts can be replaced by human derived heuristics johns et al 2020a 2020b which have the advantage of not requiring constant input from the user discussions with network operators have highlighted the need to integrate the optimization methods presented in this manuscript with a posteriori evaluations based on engineering judgment to support the implementation of dynamically adaptive design for control strategies in large scale operational networks in particular expert feedback is required to iteratively refine the formulation and improve the features of the solutions of the optimization problem declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests herman a mahmoud edward c keedwell ivan stoianov filippo pecci reports financial support was provided by engineering and physical sciences research council aly joy ulusoy reports financial support was provided by engineering and physical sciences research council declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to acknowledge the funding from the epsrc dynamically adaptive and resilient water supply networks for a sustainable future ep p004229 1 ukri epsrc impact acceleration accounts iaa and the epsrc cdt in sustainable civil engineering the authors would also like to thank kevin henderson bristol water for providing the case study network bwpnet as well as the anonymous reviewers for their valuable feedback and suggestions supplementary material the hydraulic model of the case study network bwpnet is available online at https data mendeley com datasets rsk3jvy22f together with with additional information i e the dma memberships of network nodes supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118914 appendix a supplementary materials supplementary data s1 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s1 
15673,on their path to becoming sustainable facilities it is required that wastewater treatment plants reduce their energy demand sludge production and chemical consumption as well as increase on site power generation this study describes the results obtained from upgrading the sludge line of a full scale wastewater treatment plant over 6 years 2015 2021 using three advanced process control strategies the advanced process control tools were designed with the aim of i enhancing primary and secondary sludge thickening ii improving anaerobic digestion performance and iii reducing chemical consumption in the sludge line the results obtained show that the use of advanced process control tools allows for optimising sludge thickening increasing solids content by 9 5 and anaerobic digestion increasing both the removal of volatile solids and specific methane yield by 10 respectively while reducing iron chloride and antifoam consumption by 75 and 53 respectively with the strategies implemented the plant increased its potential energy self sufficiency from 43 to 51 and reduced de watered sludge production by 11 furthermore the upgrade required a low investment with a return of capital expense capex in 1 98 years which presents a promising and affordable alternative for upgrading existing wastewater treatment plants graphical abstract image graphical abstract keywords wastewater treatment plant wwtp advanced process control apc sewage sludge anaerobic digestion energy self sufficiency abbreviations ad anaerobic digestion apc advanced process control bmp biomethane potential bod5 biochemical oxygen demand capex capital expenses chp combined heat and power cod chemical oxygen demand er external recirculation hrt hydraulic retention time nur nutrients removal olr organic loading rate opex operational expenses p eq population equivalent pr purge rate ps primary sludge scada supervisory control and data acquisition sp set point srt sludge retention time ss sewage sludge svi sludge volumetric index ta total alkalinity tn total nitrogen tp total phosphorus ts total solids tss total suspended solids vfa volatile fatty acids was waste activated sludge wrrf water resource recovery facility wwtp wastewater treatment plant 1 introduction wastewater treatment is evolving to create a new resource recovery paradigm transforming wastewater treatment plants wwtps into water resource recovery facilities wrrfs larriba et al 2020 this change has motivated the development of a wide range of new technologies that can deliver high quality effluents with lower energy demand and operational costs thereby generating rapid progress toward becoming wrrfs which are sustainable and economically feasible soares 2020 however most existing wwtps are based on the conventional activated sludge treatment process in such traditional wwtp configurations aeration requirements for nutrient removal nur account for 45 75 of the total energy demand of the plant rosso et al 2008 moreover during water treatment large volumes of primary sludge ps and secondary or waste activated sludge was are generated which are collectively referred to as sewage sludge ss in the sludge line of wwtps ps and was are usually independently thickened to an average total solids ts content in the range of 2 8 and subsequently mixed in wwtps of a certain size the mixed ss is then sent to anaerobic digestion ad reactors to produce biogas energy reduce the volatile solids vs content and stabilise the sludge from a biological perspective borzooei et al 2019 finally the thickened or digested sludge is de watered up to 15 30 of the ts and appropriately managed for disposal in landfills incineration composting or applications in agriculture it is estimated that the treatment and management of sewage sludge account for 50 of the wwtp s operational costs lorenzo toja et al 2016 fortunately when available the biogas produced from ad can be recovered and used to supply 40 60 of the on site energy needs bezirgiannidis et al 2020 with the aim of enhancing the sustainability of the water cycle wwtps are attempting to achieve energy self sufficiency by reducing their energy consumption and maximising on site power generation macintosh et al 2019a the optimization of ad plays a key role in achieving this ambitious objective jenicek et al 2013 several technologies can be applied to improve ad performance such as ss pre treatments carrère et al 2010 romero güiza et al 2019 anaerobic co digestion mata alvarez et al 2014 use of additives liu et al 2021 romero güiza et al 2016 or two step ad romero güiza et al 2021 although co digestion is a feasible alternative to increase the energy self sufficiency of wwtps macintosh et al 2019b wwtp specific singularities or local regulation restrictions sometimes exclude the option of co digestion moreover alternatives such as pre treatments or two step ad may also consume significant amounts of energy or require large capital expenses capex which can make them economically or energetically unfavourable çelebi et al 2021 several studies have suggested that enhancing sludge thickening plays an important role in achieving energy self sufficiency ruffino et al 2014 jenicek et al 2013 showed that improvements in ps and was thickening significantly increased biogas production to 12 5 m3 per population equivalent per year p eq y 1 similarly borzooei et al 2019 showed that the introduction of an optimised thickening stage has a positive impact on the energy and greenhouse gas balance of wwtps a high ts content above 4 in the thickened sludge could be sufficient for achieving a positive energy balance in two step ad processes bolzonella et al 2007 moreover ge et al 2011 showed that 4 of ts in the feed of anaerobic digesters is enough to fully offset heat requirements with the heat produced in a co generation engine focused on electricity production furthermore these requirements were largely exceeded if the feed concentration increased to 6 ts consequently many efforts have been made to improve sludge thickening especially in was some examples of these developments technologies include i modified hydro cyclones that can help to increase sludge thickening but are still in the early stages of development according to senfter et al 2021 and ii membrane technologies such as forward osmosis which can enhance was thickening up to 50 g l 1 sun et al 2019 yi et al 2021 or iii high rate dissolved air flotation systems cagnetta et al 2019 however all of these alternatives have some drawbacks such as large investment for implementation nevertheless previous attempts at improving ps thickening have mostly focused on chemical precipitation such as acidification maraschin et al 2020b use of aluminium salts attapulgite and polyelectrolytes maraschin et al 2020a for instance bezirgiannidis et al 2020 studied the effects of a chemically enhanced primary treatment in terms of organic carbon removal and biogas production their results showed that the chemically enhanced primary treatment minimized oxygen consumption and increased biogas production thereby achieving annual energy gains of 1 3 gwh for a wwtp of 50 000 p eq however these new applications need to be assessed under full scale conditions in terms of economic feasibility and the effect of chemicals in the resulting sludge as they can affect the final sludge disposal alternatives kacprzak et al 2017 advanced process control apc is widely used in water lines to control aeration rieger et al 2012 and for nutrient removal regmi et al 2015 vanrolleghem et al 2003 or energy optimisation palatsi et al 2021 the main references for process control used in the sludge line are aimed at controlling ad through the development of predictive mathematical models draa et al 2019 kim et al 2014 micolucci et al 2014 the control of vfa concentrations in reactors garcía sandoval et al 2016 or the development of soft sensors oppong et al 2012 however there are limited literature references on the application of apc in optimising thickening in previous studies on optimising the water lines of the wwtp under study apc tools emerged as an affordable alternative to upgrading existing wwtps palatsi et al 2021 considering each apc tool as an individual module within the overall control of the wwtp it is easy to gradually incorporate new control tools into the sludge line as well as those interrelated to them with the water line consequently apc strategies may be a simple and cost effective solution that can be applied to optimise existing sludge lines without the need for additional chemical consumption or large capex which is associated with the implementation of other advanced technologies equipment in this study we provide practical knowledge of different apc strategies applied in a full scale wwtp to improve the performance of the sludge line and to increase the energy self sufficiency and sustainability of the wwtp apc tools are used to i enhance ps and was thickening ii improve ad performance and iii reduce chemical consumption in the sludge line a detailed discussion of the effect of the apc strategies on each process step is provided furthermore a final energy and economic study was conducted to evaluate the contribution of the apc to the energy self sufficiency of the wwtp and the economic impact of its implementation 2 material methods 2 1 wastewater plant description the sludge line the municipal wwtp under study is located in lleida northeast of spain utm 489853 m e 4694716 m n the current treatment capacity of the wwtp activated sludge process is 160 000 p eq a complete wwtp description of the water line and the established discharge limits set by the regional national authority can be found in palatsi et al 2021 regarding the sludge line the ps is thickened in two thickening settlers 440 m3 while the was is thickened using a flotation system composed of an air sludge compressor unit 5 m3 and a flotation unit 435 m3 the thickened sludges are mixed ss in a buffer tank 80 m3 and digested in two thermally isolated mesophilic anaerobic reactors 4960 m3 for organic matter removal and biogas generation the digested sludge is de watered using two centrifuges and reused in agricultural applications a current 2021 schematic representation of the wwtp water lines and sludge lines is shown in fig 1 2 2 process control instrumentation and apc description three apc strategies were implemented in the studied wwtp during the period of 2017 2021 table 1 during the reference period p0 table 1 there was no apc implemented and the sludge line was operated manually according to the original wwtp design recommendations the operation was mainly based on on off controls with fixed set points sp regardless of the variations in operation conditions flow rate and organic loading the first apc system implemented p1 in table 1 or apcp1 was the primary sludge thickening control psth control fig 1 the thickening units were equipped with ultrasonic sensors to continuously monitor the sludge levels hsludge1 based on an established hsludge1 sp the apcp1 tool activates the purge valves of the thickeners to maintain a constant sludge level the aim of this apcp1 tool is to optimise the solids content in the thickened ps ts 8 fig 1 and prevent uncontrolled fermentation in may 2018 new apc tools were implemented to optimise reagent consumption antifoam and iron chloride fecl3 in the anaerobic digesters apcp2 fecl3 is mainly used for the control of the h2s concentration in biogas but there are multiple benefits of dosing digesters with iron that are related to phosphate removal mitigating struvite formation in pipelines and ss de waterability improvement kulandaivelu et al 2020 yuan et al 2020 second the control of foaming in ad is required because frequent foaming reduces the working volume of the digester and may decrease ad yields moreover security devices and or outlet pipes can be blocked which results in uneven distribution and increases the difficulty of operation as well as the environmental and safety risks yang et al 2021 until period p2 fecl3 doses were proportional to the ps flow rate q 4 fig 1 while antifoam dosing was manually regulated by the wwtp staff who monitored the foam level hfoam fig 1 in the supervisory control and data acquisition scada system in p2 the biogas line was equipped with an online biogas composition ch4 co2 o2 and h2s analyser apcp2 controlled the fecl3 40 dosing pumps frequency inverters to maintain the h2s concentration in biogas below an sp to protect the energy recovery facilities of boilers and combined heat and power chp units co generation engine as described in fig 1 h2s control the anaerobic reactors were also equipped with new antifoam dosing pumps in p2 including frequency inverters and plc communications apcp2 controlled the antifoam dosing pumps of the digesters ensuring an hfoam level below an sp anf control fig 1 additionally during p2 the ad temperature sp increased from 35 c to 37 c during p3 an external recirculation er control er control was developed using the creapro createch360 spain control platform er control included the measurement of sludge levels in secondary settlers hsludge2 as well as inflow outflow ts online metering wwtp inlet flow qwwtp biological reactor biomass content tsreactor and sludge settleability using the ratio between ts content in the er and ts content in the biological reactor tser tsreactor the er control strategy which is based on fuzzy logic is schematically represented in fig 2 additionally during p3 a preliminary apc tool to determine the optimum was purge rate prwas in biological reactors was implemented pr control apcp3 continuously estimates and monitors the sludge retention time srt 2 to ensure that the concentration of biomass in the biological reactors is within optimum values based on the process conditions fig 1 in addition during p3 the was thickener was improved by adding drained outflow ts monitoring via online metering once the optimum prwas was determined considering srt 2 apcp3 displayed a recommendation every 8 h of purge flow q 6 as well as the speed of the thickener extraction bridge in the wwtp scada system fig 1 similarly a preliminary apc tool for ps settler control ps control fig 1 was implemented during p3 the ps control tool considers inflow and outflow entering wastewater and clarified outflow ts and chemical oxygen demand cod sensors allowing real time mass balancing solids and organic matter of the primary settlers this control tool recommends sp values in scada for ps purge rates prps which are manually modified by the wwtp staff q 4 moreover during p3 the temperature sp of ad increased from 37 c to 40 c a complete description of the wwtp sludge line sensors and analysers is presented in table 1s supplementary material 2 3 analytical methods the concentrations of total suspended solids tss ts and volatile solids vs were measured according to the standard methods for the examination of water and wastewater eaton et al 2005 as shown in table 2s supplementary material the cod total nitrogen tn and total phosphorous tp were measured after sample digestion lt200 hach with vis rfid spectrophotometry dr3900 hach using commercial kits lck hach respirometer caps oxitop system vwr were used for biological oxygen demand bod5 readings finally the total alkalinity ta ph and vfa were measured using a ph probe phc805 hach and an automatic titrator titralab at1000 hach the ta and vfa alkalinity ratios vfa ta were determined according to the methods of hill and jenkins 1989 and lahav et al 2002 tests for biomethane potential bmp were carried out under mesophilic conditions following the guidelines proposed by angelidaki et al 2009 a complete description of the procedure is provided in the supplementary material bmp tests were performed several times over the study periods p0 to p3 at 36 c and at the end of period p3 at 36 38 40 and 42 c this was done using the digested sludge taken at the end of p3 as inoculum with samples of ps was and ss obtained in the same period the experimental data were fitted using a first order exponential equation as shown in eq 1 eq 1 b b m a x 1 e x p k h y d t where b mlch4 gvs 1 is the cumulative specific methane production bmax mlch4 gvs 1 is the ultimate methane production khyd is the specific rate constant or apparent kinetic constant d 1 and t d is the digestion time parameters were estimated with 95 confidence intervals using non linear regression as described by jensen et al 2011 2 3 1 data analysis to assess the effectiveness of the developed apc tools the wwtp analytical data were divided into four operational periods p0 to p3 each with a duration of 12 months to capture seasonal variations in wastewater properties and flow rates one way analysis of variance one way anova was used to determine whether operational parameter modifications over the periods p0 to p3 produced statistically significant differences among the periods for the measured variables with a statistical significance of α 0 05 when the variance analysis indicated significant differences among periods tukey s test α 0 05 for the multiple comparisons of means was used to find means that were significantly different from each other when the anova results indicated no significant differences among periods for a given variable owing to the high variance of one or several parameters the same turkey analysis was applied to periods p0 and p3 only this was done to compare the means for these two periods spearman s correlation coefficient α 0 05 was determined when the correlations among some of the variables were studied minitab statistical software pennsylvania state university usa was used for the statistical calculations because the wwtp design does not allow for the installation of outflow flow meters at the ps and was thickening units q 8 and q 9 respectively fig 1 these flow rates were estimated using a mass balance equation as described in the supplementary material similarly to obtain other parameters and perform further economic analysis a desktop energy balance assessment was conducted for a full scale wwtp of 160 000 p eq considering the results obtained from the actual operation data of lleida s wwtp for periods p0 and p3 in this analysis it was assumed that all the biogas produced could be used in a chp system with no power limitation other considerations and the equations used are also summarised in the supplementary material 3 results discussion 3 1 sludge line performance for each of the operation phases at the wwtp the mean values of the process parameters during the entire operation period with their standard deviation and statistical analysis were compared these means were obtained daily and averaged monthly for 2 years for p0 and p2 and 1 year for p1 and p3 this was done to evaluate the effect of the different apc strategies implemented on the wwtp table 2 the relatively high standard deviation for some of the inflow parameters in the water line is due to the seasonal variations in the wwtp inflow characteristics while deviations in the outflow values of tss tn and tp were due to specific severe episodes of filamentous bulking table 3s fig 1s and fig 1sbis in the supplementary material the main objective of phase p0 was to guarantee sludge line performance that aligns with the original wwtp design parameters to obtain reasonable thickening and digestion yields as seen in table 2 mixed ss is composed of approximately 50 50 ps and was q 4 and q 6 with the average flow rate to anaerobic reactors being 208 m3 d 1 q 10 containing 42 0 gts l 1 ts 10 with 75 vs vs 10 these inflow parameters resulted in a digestion hydraulic retention time hrt of 26 d and an organic loading rate olr of 1 30 kgvs m 3 d 1 hrt 11 and olr 11 table 2 in the anaerobic digesters 51 8 of the organic matter vs basis was removed resulting in a specific biogas production of 0 56 nmbiogas 3 mreactor 3 d 1 biogas reactor yield 11 table 2 finally the digested sludge resulted in 24 tn d 1 s q 12 of de watered sludge with 22 2 ts ts 12 to be managed for agricultural applications table 2 the global wwtp energy ratio accounted for 0 23 kwhwwtp m 3 table 2 which is in the low range of typical values 0 1 2 1 kwhwwtp m 3 according to gu et al 2017 the sludge line represented 16 of the total energy demand of the wwtp table 2 whereas the sludge line usually accounts for more than 20 of the global energy demand panepinto et al 2016 in p1 apcp1 the primary sludge thickening control tool was implemented psth control fig 1 in this phase a significant increase in the thickened ps purge flow rate q 8 was observed from 80 to 142 m3 d 1 however compared to the reference period no statistically significant improvement in the solids content of thickened sludge ts 8 from 49 0 to 59 9 g l 1 or a clear reduction in tss values of drained water tss 5 from 197 to 149 g l 1 was observed table 2 and fig 2s in the supplementary material it must be considered that it is not always easy to close the mass balances in sludge lines one of the main difficulties faced is that wwtps usually work with punctual or unintegrated 24 h samples in the sludge lines therefore at the end of period p1 automatic samplers were incorporated into the sludge line based on timed pneumatic valves to obtain more representative samples fig 3s supplementary material shows images of this development during p1 the temperature of the anaerobic digesters t 11 increased from 35 c to 37 c table 2 despite this increase no disturbances were observed in the digester monitoring parameters fig 4s supplementary material furthermore as a consequence of the improvement of psth control the digesters olr olr 11 was increased from 1 3 to 1 7 kgvs m 3 d 1 a 27 7 increase comparing p1 and p0 as shown in table 2 the improvement in olr resulted in a statistically significant increase in biogas production b flow 11 from 2895 to 3651 nm3 biogas d 1 but not in the digester yields which increased from 0 56 to 0 61 nm3 biogas m 3 digesters d 1 table 2 however specific methane yields presented a significant decrease from 0 29 to 0 23 nm3 ch4 kgvs 1 which could be related to the hrt reduction from 26 to 20 d methane yield 11 table 2 hrt and olr play important roles in the performance of the anaerobic digester it is generally accepted that mesophilic reactors must operate at an hrt of at least 15 20 days in this case although digester instability was not observed fig 4s supplementary material in the last phase of p1 the hrt reached values below 20 d and lower methane yields were observed in addition to the effect of the increase in the ps purge flow rate q 8 the hrt decrease at the end of period p1 fig 4sbis in the supplementary material could be related to the poor efficiency of was thickening at the end of this period with an increase in the secondary sludge flow rate q 9 and a reduction in the ts content in the thickened was fig 5s in the supplementary material nevertheless the mean values of ts 9 table 2 did not show these differences when all p1 periods were considered period p2 was optimised for reagent consumption in ad through the implementation of apcp2 tools fecl3 consumption controlled by h2s control fig 1 was significantly reduced from 306 to 73 kg d 1 a 76 decrease between p1 and p2 mean values fecl3 11 in table 2 moreover the reduction in fecl3 dosing resulted in a significant reduction in operational expenses opex as further described in p2 although an increase in h2s concentration between p1 and p2 h2s 11 from 23 ppm to 52 ppm was observed the h2s concentration values during p2 did not exceed the established h2s sp of 80 ppm recommended value by the chp manufacturer is 100 ppm with the established sp in apcp2 h2s levels were also always below inhibitory concentrations reported in the range of 100 800 mg l dissolved sulphide or approximately 50 400 mg l dissociated h2s chen et al 2008 nevertheless contrary to some previous studies kulandaivelu et al 2020 yuan et al 2020 no correlation between fecl3 dosage fecl3 11 and polyelectrolyte consumption polyelectrolyte 12 was found figs 6s and 7s in supplementary material as the results yielded a spearman s correlation coefficient value of 0 054 narrow 95 confidence interval around zero with no significant differences in polyelectrolyte requirements over periods p1 to p3 table 2 regarding anf control in p3 fig 1 the antifoam consumption was reduced from 20 to 9 kg d 1 a 42 decrease between p0 p1 and p3 antifoam 11 in table 2 despite this important reduction the analysis of variance one way anova indicated no statistical differences in antifoam consumption during the experimental periods table 2 it must be taken into consideration that foam formation in anaerobic reactors is related to bulking processes in biological reactors of the water line consequently reagent consumption is seasonal and specifically concentrated during winter or periods of low temperatures the fact that during part of the year the antifoam consumption is close to zero but it is high during december february produces great variability in the data resulting in an anova with no significant differences among periods p0 to p3 if the data are plotted against time months clear differences can be observed as shown in fig 3 when comparing p0 and p3 data only anova and tukey s test results indicated statistically significant differences between these two periods table 2 in any case the results show that the anf control tool is a reliable strategy to control reagent overdoses compared to the non automated system previous periods p0 or p1 in fig 3 during p2 an increase in methane yield was observed from 0 23 to 0 34 nm3 ch4 kgvs 1 a 48 increase from p1 to p2 which could be attributed to the increase in the hrt from 20 to 25 days and the increase in digesters temperature from 35 c to 37 c furthermore comparing p0 and p2 with similar hrt 11 values an increase in the methane yield was also observed 17 2 supporting the hypothesis that temperature increase enhanced biogas production the effect of digestion temperature will be discussed further p3 focused on improving the performance of the secondary sludge settlers through the implementation of apcp3 er control fig 1 increased the biomass content in the activated sludge reactors tss r 2 which was necessary to achieve the new nur and outflow requirements fig 8s and table 3s in the supplementary material as extensively described by palatsi et al 2021 according to table 2 the implementation of the apcp3 tool also resulted in a significant increase in the tss 6 of the secondary settled sludge from 3 8 to 4 7 mg l 1 a 24 increase in mean values between p0 p1 p2 and p3 whereas the was flow rate sent to the secondary thickener q 6 was reduced from 1148 to 772 m3 h 1 a 33 reduction in mean values between p0 p1 p2 and p3 regarding the was thickening performance the ts in the secondary thickened sludge ts 9 did not show significant variation table 2 furthermore the primary settler control introduced in p3 ps control fig 1 caused a significant increase in primary sludge concentration tss 4 increasing from 4 1 to 5 8 mg l 1 a 41 increase in mean values between p0 p1 p2 and p3 in contrast the primary sludge purge q 4 was reduced from 1220 to 1025 m3 h 1 a reduction in mean values between p0 p1 p2 and p3 as shown in table 2 and fig 2s supplementary material finally both ps control and psth control resulted in a significant increase in the primary thickened sludge s solids content ts 8 from 49 0 to 64 5 g l 1 32 from p0 to p3 table 2 to summarize fig 4 shows main variations in the ad parameters along experimental periods or tested apcs p1 to p3 vs p0 the effects of the ps was ratio and temperature on the yields from the ad process are discussed in the next section 3 2 mass and energy balance mass and energy balances were carried out to evaluate how the apc control strategies applied to the sludge line affected the energy self sufficiency of the wwtp fig 9s and fig 10s supplementary material show the wwtp mass and energy balances for periods p0 and p3 respectively considering the average values reported in table 2 the improvements in the sludge line control resulted in a 15 4 increase in methane production from 1740 nm3 ch4 d 1 18 740 kwh d 1 to 2009 nm3 ch4 d 1 21 600 kwh d 1 this increase in methane production is primarily linked to the increase in vs digester feeding statistically significant differences in vs 10 between p0 and p3 table 2 and to the improvement in digester performance vsremoval 11 it can be observed that the production of thickened ps increased from 2983 to 5244 kgvs d 1 whereas the production of thickened was decreased from 3471 to 2690 kgvs d 1 figs 9s and 10s supplementary material consequently the ratio between the ps and was thickened sludges changed from 46 54 to 66 34 bmp tests were performed at 36 c with ps was and ss to evaluate the methane production potentials during the experimental period fig 5 it can be observed how during all the tested periods the highest biomethane potential bmax was obtained for the ps mean value of 0 37 0 03 nlch4 kgvs 1 whereas the lowest was that of the was mean value of 0 21 0 03 nlch4 kgvs 1 thereby yielding sss with a biomethane potential within this range 0 30 0 04 nlch4 kgvs 1 the organic matter present in ps consists of fatty acids cellulose lipids fibres and other solids with higher energy potential than was composed mainly of refractory products such as microbes and extracellular polymeric substances sakaveli et al 2021 as shown in fig 5 a slight improvement in the cumulative specific methane production nlch4 kgvs 1 was observed mainly in the ps experiments these differences can be related to variations in organic matter content in wwtp inflow and consequently in ps composition expressed in fig 5 as the cod ts ratio of wwtpinflow it is widely known that temperature is a crucial parameter in ad nie et al 2021 the main advantages of a mesophilic operation compared to high temperature approaches are lower energy consumption and resilience to shock loading or the addition of inhibitor materials kim et al 2017 therefore most mesophilic digestion systems are designed to operate in a temperature range of 37 2 c and for optimum digester performance a stable operating temperature should be maintained with a daily variability of less than 0 5 c lin et al 2017 liu et al 2018 merlin et al 2012 moreover the mesophilic temperature has an important impact on the rate of hydrolysis and biogas formation nielsen et al 2017 showed that increasing the reactor temperature from 35 c to 39 c led to a yield of approximately 20 mlch4 gvs 1 with a favourable energy balance however in practice and for various reasons some full scale mesophilic digesters continue to operate under low mesophilic temperature conditions additional bmp tests were performed with ps was and ss at 36 38 40 and 42 c using the digested sludge taken at the end of period p3 as the inoculum table 3 the inoculum although adapted to the operating conditions of p3 40 c did not show differences in the bmax values obtained at different temperatures in contrast a clear effect on the estimated digestion kinetic constant khyd was observed with increasing temperature for the different sludge types table 3 as mentioned before an important factor in the present study is the increase in srt in the biological reactor to accomplish new wwtp discharge limits srt r 2 table 3s in the supporting material this strategy resulted in a reduction in the secondary sludge purge q 6 table 2 furthermore the present apc tools significantly reduced the ratio between the purged solids in the was and the organic matter inflow to the biological reactor prwas ratio table 2 from 0 54 to 0 33 gtss gcod 1 this reduction indicates a more efficient use of the organic matter entering the reactor codrecycled table 2 which was used to remove the nutrients instead of transforming them into sludge that requires management to summarise based on the energy balances performed the adoption of apc strategies increased the potential electric production of the wwtp from 5798 to 6696 kwh d 1 considering that the electric energy consumption of the plant remained unaltered and the produced biogas could be used this increase translates to an improvement towards the plant s energy self sufficiency from 43 to 51 fig 6 3 3 economic analysis from an economic standpoint it is challenging to determine the exact profitability of the presented apc systems several factors such as the performance through 6 years of operation seasonal variations in wastewater properties new strategies adopted in the operation of the biological reactor in the water line variations in energy and chemical costs and the uncertainty in estimating the effect cost associated with some wwtp upgrades limit the completion of an economic analysis despite these limitations from p0 reference period to p3 optimised period an economic assessment was conducted considering the costs associated with the investments performed in the tested apc systems capex and estimating the benefits over operational expenses opex with the improved wwtp yields as shown in table 4 despite the cumulative capex over 6 years of operation 169 696 a positive opex savings was obtained with the implemented apc systems 85 565 y 1 resulting in a capex payback after 1 98 y which is economically feasible for a large scale wwtp although the savings may be specific to the studied wwtp the results show that three main factors influence the savings in opex energy reagents and sludge management regarding sludge management it is observed that the increase in vsremoval in anaerobic digesters reduces sludge production from 8760 to 7811 ton y 1 this represents savings of 11 in sludge management costs even with an increase in polyelectrolyte consumption from 13 5 to 16 9 kgpolyelectrolyte y 1 which is not a significant increase in global sludge de watering management costs according to table 4 3 4 apc experiences lessons learned and new challenges this study shows the implementation of different apc tools to improve an actual full scale wwtp sludge line over a 6 year period the positive practical implications lessons learned and challenges remaining are detailed below i sludge lines are largely forgotten issues in wwtp optimisation goals the most common approach for sludge line optimisation is the use of pre treatments or advanced digestion systems that do not pay sufficient attention to sludge thickening this study shows how apc systems focused on sludge thickening can optimise the sludge line and therefore increase wwtp energy self sufficiency ii the results and practical experience show that the sludge line sampling methodology plays an important role in the quality of the data acquired punctual and random sampling makes it difficult to achieve a correct mass balance although implementing integrated sampling in a sludge line can be challenging the results show that this methodology can significantly increase the accuracy of the data iii the implementation of a robust apc system requires numerous sensors analysers and hardware that require frequent maintenance errors in sensor measurements can create significant problems related to the achievement of process rates in this regard the deployment of soft sensor technologies can improve sensor predictive maintenance or decision support tools thereby increasing the reliability of apc systems at the present wwtp these technologies were introduced to the water line the implementation of this technology in the key sensors of the sludge line is the next step in the sludge line optimisation process described in this study iv although apcs are presented as individual tools or apps most of them are interrelated consequently it is necessary to have a global and open control platform for wwtps that allows the integration of these different modules v most anaerobic reactors in wwtp can still be promoted in terms of olr vsremoval or operational temperature regime to achieve a considerable increase in on site biogas production and a higher energy self sufficiency vi in the current european scenario final sludge production in wwtps poses enormous environmental and economic challenges although the final sludge is composed of by products that are valuable for agricultural applications organic matter phosphorus and nitrogen they are not exempt from risks associated with their use potential pollutants pathogens and others leading to restrictive legislation for soil applications the optimisation of the sludge line using apc tools can result in a final sludge decrease of 11 thereby helping to make this challenge more achievable 4 conclusions the implementation of apc tools represents an easy and cost effective solution for improving the sludge lines of existing wwtp with the strategies implemented herein a 43 51 increase in the wwtp s energy self sufficiency was achieved a significant enhancement 9 5 in the thickening of the sewage sludge was achieved together with an increase in the methane yield of digesters 10 a reduction in the consumption of antifoam and iron chloride 53 and 75 respectively and a reduction 11 in the de watered sludge to be managed from an economic perspective the implementation of the tested apc tools resulted in opex reductions with an estimated return of the performed capex after 1 98 years which is economically feasible for a large scale wwtp declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors are grateful to the dedication and work of jordi lopez on wwtp supervision and maintenance tasks gloria prunera for analytical support and previous wwtp managers process managers j millà j giribet d gonzalez d blanch m isidro and o domingo for their work on operation and control acknowledgements are also due to voltec l perez and the createch360 teams f ripoll involved in the design implementation and adjustment of the apc tools the authors would also like to thank david bedoya dewberry usa and joseph el kadi university of cambridge uk for proofreading and reviewing the article this research was made possible due to the support of research activities at municipal wwtp by the aqualia i d department p icaran x tomas and v monsalvo aca catalan water agency g ramirez and lleida city council j domingo supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118924 appendix supplementary materials image application 1 
15673,on their path to becoming sustainable facilities it is required that wastewater treatment plants reduce their energy demand sludge production and chemical consumption as well as increase on site power generation this study describes the results obtained from upgrading the sludge line of a full scale wastewater treatment plant over 6 years 2015 2021 using three advanced process control strategies the advanced process control tools were designed with the aim of i enhancing primary and secondary sludge thickening ii improving anaerobic digestion performance and iii reducing chemical consumption in the sludge line the results obtained show that the use of advanced process control tools allows for optimising sludge thickening increasing solids content by 9 5 and anaerobic digestion increasing both the removal of volatile solids and specific methane yield by 10 respectively while reducing iron chloride and antifoam consumption by 75 and 53 respectively with the strategies implemented the plant increased its potential energy self sufficiency from 43 to 51 and reduced de watered sludge production by 11 furthermore the upgrade required a low investment with a return of capital expense capex in 1 98 years which presents a promising and affordable alternative for upgrading existing wastewater treatment plants graphical abstract image graphical abstract keywords wastewater treatment plant wwtp advanced process control apc sewage sludge anaerobic digestion energy self sufficiency abbreviations ad anaerobic digestion apc advanced process control bmp biomethane potential bod5 biochemical oxygen demand capex capital expenses chp combined heat and power cod chemical oxygen demand er external recirculation hrt hydraulic retention time nur nutrients removal olr organic loading rate opex operational expenses p eq population equivalent pr purge rate ps primary sludge scada supervisory control and data acquisition sp set point srt sludge retention time ss sewage sludge svi sludge volumetric index ta total alkalinity tn total nitrogen tp total phosphorus ts total solids tss total suspended solids vfa volatile fatty acids was waste activated sludge wrrf water resource recovery facility wwtp wastewater treatment plant 1 introduction wastewater treatment is evolving to create a new resource recovery paradigm transforming wastewater treatment plants wwtps into water resource recovery facilities wrrfs larriba et al 2020 this change has motivated the development of a wide range of new technologies that can deliver high quality effluents with lower energy demand and operational costs thereby generating rapid progress toward becoming wrrfs which are sustainable and economically feasible soares 2020 however most existing wwtps are based on the conventional activated sludge treatment process in such traditional wwtp configurations aeration requirements for nutrient removal nur account for 45 75 of the total energy demand of the plant rosso et al 2008 moreover during water treatment large volumes of primary sludge ps and secondary or waste activated sludge was are generated which are collectively referred to as sewage sludge ss in the sludge line of wwtps ps and was are usually independently thickened to an average total solids ts content in the range of 2 8 and subsequently mixed in wwtps of a certain size the mixed ss is then sent to anaerobic digestion ad reactors to produce biogas energy reduce the volatile solids vs content and stabilise the sludge from a biological perspective borzooei et al 2019 finally the thickened or digested sludge is de watered up to 15 30 of the ts and appropriately managed for disposal in landfills incineration composting or applications in agriculture it is estimated that the treatment and management of sewage sludge account for 50 of the wwtp s operational costs lorenzo toja et al 2016 fortunately when available the biogas produced from ad can be recovered and used to supply 40 60 of the on site energy needs bezirgiannidis et al 2020 with the aim of enhancing the sustainability of the water cycle wwtps are attempting to achieve energy self sufficiency by reducing their energy consumption and maximising on site power generation macintosh et al 2019a the optimization of ad plays a key role in achieving this ambitious objective jenicek et al 2013 several technologies can be applied to improve ad performance such as ss pre treatments carrère et al 2010 romero güiza et al 2019 anaerobic co digestion mata alvarez et al 2014 use of additives liu et al 2021 romero güiza et al 2016 or two step ad romero güiza et al 2021 although co digestion is a feasible alternative to increase the energy self sufficiency of wwtps macintosh et al 2019b wwtp specific singularities or local regulation restrictions sometimes exclude the option of co digestion moreover alternatives such as pre treatments or two step ad may also consume significant amounts of energy or require large capital expenses capex which can make them economically or energetically unfavourable çelebi et al 2021 several studies have suggested that enhancing sludge thickening plays an important role in achieving energy self sufficiency ruffino et al 2014 jenicek et al 2013 showed that improvements in ps and was thickening significantly increased biogas production to 12 5 m3 per population equivalent per year p eq y 1 similarly borzooei et al 2019 showed that the introduction of an optimised thickening stage has a positive impact on the energy and greenhouse gas balance of wwtps a high ts content above 4 in the thickened sludge could be sufficient for achieving a positive energy balance in two step ad processes bolzonella et al 2007 moreover ge et al 2011 showed that 4 of ts in the feed of anaerobic digesters is enough to fully offset heat requirements with the heat produced in a co generation engine focused on electricity production furthermore these requirements were largely exceeded if the feed concentration increased to 6 ts consequently many efforts have been made to improve sludge thickening especially in was some examples of these developments technologies include i modified hydro cyclones that can help to increase sludge thickening but are still in the early stages of development according to senfter et al 2021 and ii membrane technologies such as forward osmosis which can enhance was thickening up to 50 g l 1 sun et al 2019 yi et al 2021 or iii high rate dissolved air flotation systems cagnetta et al 2019 however all of these alternatives have some drawbacks such as large investment for implementation nevertheless previous attempts at improving ps thickening have mostly focused on chemical precipitation such as acidification maraschin et al 2020b use of aluminium salts attapulgite and polyelectrolytes maraschin et al 2020a for instance bezirgiannidis et al 2020 studied the effects of a chemically enhanced primary treatment in terms of organic carbon removal and biogas production their results showed that the chemically enhanced primary treatment minimized oxygen consumption and increased biogas production thereby achieving annual energy gains of 1 3 gwh for a wwtp of 50 000 p eq however these new applications need to be assessed under full scale conditions in terms of economic feasibility and the effect of chemicals in the resulting sludge as they can affect the final sludge disposal alternatives kacprzak et al 2017 advanced process control apc is widely used in water lines to control aeration rieger et al 2012 and for nutrient removal regmi et al 2015 vanrolleghem et al 2003 or energy optimisation palatsi et al 2021 the main references for process control used in the sludge line are aimed at controlling ad through the development of predictive mathematical models draa et al 2019 kim et al 2014 micolucci et al 2014 the control of vfa concentrations in reactors garcía sandoval et al 2016 or the development of soft sensors oppong et al 2012 however there are limited literature references on the application of apc in optimising thickening in previous studies on optimising the water lines of the wwtp under study apc tools emerged as an affordable alternative to upgrading existing wwtps palatsi et al 2021 considering each apc tool as an individual module within the overall control of the wwtp it is easy to gradually incorporate new control tools into the sludge line as well as those interrelated to them with the water line consequently apc strategies may be a simple and cost effective solution that can be applied to optimise existing sludge lines without the need for additional chemical consumption or large capex which is associated with the implementation of other advanced technologies equipment in this study we provide practical knowledge of different apc strategies applied in a full scale wwtp to improve the performance of the sludge line and to increase the energy self sufficiency and sustainability of the wwtp apc tools are used to i enhance ps and was thickening ii improve ad performance and iii reduce chemical consumption in the sludge line a detailed discussion of the effect of the apc strategies on each process step is provided furthermore a final energy and economic study was conducted to evaluate the contribution of the apc to the energy self sufficiency of the wwtp and the economic impact of its implementation 2 material methods 2 1 wastewater plant description the sludge line the municipal wwtp under study is located in lleida northeast of spain utm 489853 m e 4694716 m n the current treatment capacity of the wwtp activated sludge process is 160 000 p eq a complete wwtp description of the water line and the established discharge limits set by the regional national authority can be found in palatsi et al 2021 regarding the sludge line the ps is thickened in two thickening settlers 440 m3 while the was is thickened using a flotation system composed of an air sludge compressor unit 5 m3 and a flotation unit 435 m3 the thickened sludges are mixed ss in a buffer tank 80 m3 and digested in two thermally isolated mesophilic anaerobic reactors 4960 m3 for organic matter removal and biogas generation the digested sludge is de watered using two centrifuges and reused in agricultural applications a current 2021 schematic representation of the wwtp water lines and sludge lines is shown in fig 1 2 2 process control instrumentation and apc description three apc strategies were implemented in the studied wwtp during the period of 2017 2021 table 1 during the reference period p0 table 1 there was no apc implemented and the sludge line was operated manually according to the original wwtp design recommendations the operation was mainly based on on off controls with fixed set points sp regardless of the variations in operation conditions flow rate and organic loading the first apc system implemented p1 in table 1 or apcp1 was the primary sludge thickening control psth control fig 1 the thickening units were equipped with ultrasonic sensors to continuously monitor the sludge levels hsludge1 based on an established hsludge1 sp the apcp1 tool activates the purge valves of the thickeners to maintain a constant sludge level the aim of this apcp1 tool is to optimise the solids content in the thickened ps ts 8 fig 1 and prevent uncontrolled fermentation in may 2018 new apc tools were implemented to optimise reagent consumption antifoam and iron chloride fecl3 in the anaerobic digesters apcp2 fecl3 is mainly used for the control of the h2s concentration in biogas but there are multiple benefits of dosing digesters with iron that are related to phosphate removal mitigating struvite formation in pipelines and ss de waterability improvement kulandaivelu et al 2020 yuan et al 2020 second the control of foaming in ad is required because frequent foaming reduces the working volume of the digester and may decrease ad yields moreover security devices and or outlet pipes can be blocked which results in uneven distribution and increases the difficulty of operation as well as the environmental and safety risks yang et al 2021 until period p2 fecl3 doses were proportional to the ps flow rate q 4 fig 1 while antifoam dosing was manually regulated by the wwtp staff who monitored the foam level hfoam fig 1 in the supervisory control and data acquisition scada system in p2 the biogas line was equipped with an online biogas composition ch4 co2 o2 and h2s analyser apcp2 controlled the fecl3 40 dosing pumps frequency inverters to maintain the h2s concentration in biogas below an sp to protect the energy recovery facilities of boilers and combined heat and power chp units co generation engine as described in fig 1 h2s control the anaerobic reactors were also equipped with new antifoam dosing pumps in p2 including frequency inverters and plc communications apcp2 controlled the antifoam dosing pumps of the digesters ensuring an hfoam level below an sp anf control fig 1 additionally during p2 the ad temperature sp increased from 35 c to 37 c during p3 an external recirculation er control er control was developed using the creapro createch360 spain control platform er control included the measurement of sludge levels in secondary settlers hsludge2 as well as inflow outflow ts online metering wwtp inlet flow qwwtp biological reactor biomass content tsreactor and sludge settleability using the ratio between ts content in the er and ts content in the biological reactor tser tsreactor the er control strategy which is based on fuzzy logic is schematically represented in fig 2 additionally during p3 a preliminary apc tool to determine the optimum was purge rate prwas in biological reactors was implemented pr control apcp3 continuously estimates and monitors the sludge retention time srt 2 to ensure that the concentration of biomass in the biological reactors is within optimum values based on the process conditions fig 1 in addition during p3 the was thickener was improved by adding drained outflow ts monitoring via online metering once the optimum prwas was determined considering srt 2 apcp3 displayed a recommendation every 8 h of purge flow q 6 as well as the speed of the thickener extraction bridge in the wwtp scada system fig 1 similarly a preliminary apc tool for ps settler control ps control fig 1 was implemented during p3 the ps control tool considers inflow and outflow entering wastewater and clarified outflow ts and chemical oxygen demand cod sensors allowing real time mass balancing solids and organic matter of the primary settlers this control tool recommends sp values in scada for ps purge rates prps which are manually modified by the wwtp staff q 4 moreover during p3 the temperature sp of ad increased from 37 c to 40 c a complete description of the wwtp sludge line sensors and analysers is presented in table 1s supplementary material 2 3 analytical methods the concentrations of total suspended solids tss ts and volatile solids vs were measured according to the standard methods for the examination of water and wastewater eaton et al 2005 as shown in table 2s supplementary material the cod total nitrogen tn and total phosphorous tp were measured after sample digestion lt200 hach with vis rfid spectrophotometry dr3900 hach using commercial kits lck hach respirometer caps oxitop system vwr were used for biological oxygen demand bod5 readings finally the total alkalinity ta ph and vfa were measured using a ph probe phc805 hach and an automatic titrator titralab at1000 hach the ta and vfa alkalinity ratios vfa ta were determined according to the methods of hill and jenkins 1989 and lahav et al 2002 tests for biomethane potential bmp were carried out under mesophilic conditions following the guidelines proposed by angelidaki et al 2009 a complete description of the procedure is provided in the supplementary material bmp tests were performed several times over the study periods p0 to p3 at 36 c and at the end of period p3 at 36 38 40 and 42 c this was done using the digested sludge taken at the end of p3 as inoculum with samples of ps was and ss obtained in the same period the experimental data were fitted using a first order exponential equation as shown in eq 1 eq 1 b b m a x 1 e x p k h y d t where b mlch4 gvs 1 is the cumulative specific methane production bmax mlch4 gvs 1 is the ultimate methane production khyd is the specific rate constant or apparent kinetic constant d 1 and t d is the digestion time parameters were estimated with 95 confidence intervals using non linear regression as described by jensen et al 2011 2 3 1 data analysis to assess the effectiveness of the developed apc tools the wwtp analytical data were divided into four operational periods p0 to p3 each with a duration of 12 months to capture seasonal variations in wastewater properties and flow rates one way analysis of variance one way anova was used to determine whether operational parameter modifications over the periods p0 to p3 produced statistically significant differences among the periods for the measured variables with a statistical significance of α 0 05 when the variance analysis indicated significant differences among periods tukey s test α 0 05 for the multiple comparisons of means was used to find means that were significantly different from each other when the anova results indicated no significant differences among periods for a given variable owing to the high variance of one or several parameters the same turkey analysis was applied to periods p0 and p3 only this was done to compare the means for these two periods spearman s correlation coefficient α 0 05 was determined when the correlations among some of the variables were studied minitab statistical software pennsylvania state university usa was used for the statistical calculations because the wwtp design does not allow for the installation of outflow flow meters at the ps and was thickening units q 8 and q 9 respectively fig 1 these flow rates were estimated using a mass balance equation as described in the supplementary material similarly to obtain other parameters and perform further economic analysis a desktop energy balance assessment was conducted for a full scale wwtp of 160 000 p eq considering the results obtained from the actual operation data of lleida s wwtp for periods p0 and p3 in this analysis it was assumed that all the biogas produced could be used in a chp system with no power limitation other considerations and the equations used are also summarised in the supplementary material 3 results discussion 3 1 sludge line performance for each of the operation phases at the wwtp the mean values of the process parameters during the entire operation period with their standard deviation and statistical analysis were compared these means were obtained daily and averaged monthly for 2 years for p0 and p2 and 1 year for p1 and p3 this was done to evaluate the effect of the different apc strategies implemented on the wwtp table 2 the relatively high standard deviation for some of the inflow parameters in the water line is due to the seasonal variations in the wwtp inflow characteristics while deviations in the outflow values of tss tn and tp were due to specific severe episodes of filamentous bulking table 3s fig 1s and fig 1sbis in the supplementary material the main objective of phase p0 was to guarantee sludge line performance that aligns with the original wwtp design parameters to obtain reasonable thickening and digestion yields as seen in table 2 mixed ss is composed of approximately 50 50 ps and was q 4 and q 6 with the average flow rate to anaerobic reactors being 208 m3 d 1 q 10 containing 42 0 gts l 1 ts 10 with 75 vs vs 10 these inflow parameters resulted in a digestion hydraulic retention time hrt of 26 d and an organic loading rate olr of 1 30 kgvs m 3 d 1 hrt 11 and olr 11 table 2 in the anaerobic digesters 51 8 of the organic matter vs basis was removed resulting in a specific biogas production of 0 56 nmbiogas 3 mreactor 3 d 1 biogas reactor yield 11 table 2 finally the digested sludge resulted in 24 tn d 1 s q 12 of de watered sludge with 22 2 ts ts 12 to be managed for agricultural applications table 2 the global wwtp energy ratio accounted for 0 23 kwhwwtp m 3 table 2 which is in the low range of typical values 0 1 2 1 kwhwwtp m 3 according to gu et al 2017 the sludge line represented 16 of the total energy demand of the wwtp table 2 whereas the sludge line usually accounts for more than 20 of the global energy demand panepinto et al 2016 in p1 apcp1 the primary sludge thickening control tool was implemented psth control fig 1 in this phase a significant increase in the thickened ps purge flow rate q 8 was observed from 80 to 142 m3 d 1 however compared to the reference period no statistically significant improvement in the solids content of thickened sludge ts 8 from 49 0 to 59 9 g l 1 or a clear reduction in tss values of drained water tss 5 from 197 to 149 g l 1 was observed table 2 and fig 2s in the supplementary material it must be considered that it is not always easy to close the mass balances in sludge lines one of the main difficulties faced is that wwtps usually work with punctual or unintegrated 24 h samples in the sludge lines therefore at the end of period p1 automatic samplers were incorporated into the sludge line based on timed pneumatic valves to obtain more representative samples fig 3s supplementary material shows images of this development during p1 the temperature of the anaerobic digesters t 11 increased from 35 c to 37 c table 2 despite this increase no disturbances were observed in the digester monitoring parameters fig 4s supplementary material furthermore as a consequence of the improvement of psth control the digesters olr olr 11 was increased from 1 3 to 1 7 kgvs m 3 d 1 a 27 7 increase comparing p1 and p0 as shown in table 2 the improvement in olr resulted in a statistically significant increase in biogas production b flow 11 from 2895 to 3651 nm3 biogas d 1 but not in the digester yields which increased from 0 56 to 0 61 nm3 biogas m 3 digesters d 1 table 2 however specific methane yields presented a significant decrease from 0 29 to 0 23 nm3 ch4 kgvs 1 which could be related to the hrt reduction from 26 to 20 d methane yield 11 table 2 hrt and olr play important roles in the performance of the anaerobic digester it is generally accepted that mesophilic reactors must operate at an hrt of at least 15 20 days in this case although digester instability was not observed fig 4s supplementary material in the last phase of p1 the hrt reached values below 20 d and lower methane yields were observed in addition to the effect of the increase in the ps purge flow rate q 8 the hrt decrease at the end of period p1 fig 4sbis in the supplementary material could be related to the poor efficiency of was thickening at the end of this period with an increase in the secondary sludge flow rate q 9 and a reduction in the ts content in the thickened was fig 5s in the supplementary material nevertheless the mean values of ts 9 table 2 did not show these differences when all p1 periods were considered period p2 was optimised for reagent consumption in ad through the implementation of apcp2 tools fecl3 consumption controlled by h2s control fig 1 was significantly reduced from 306 to 73 kg d 1 a 76 decrease between p1 and p2 mean values fecl3 11 in table 2 moreover the reduction in fecl3 dosing resulted in a significant reduction in operational expenses opex as further described in p2 although an increase in h2s concentration between p1 and p2 h2s 11 from 23 ppm to 52 ppm was observed the h2s concentration values during p2 did not exceed the established h2s sp of 80 ppm recommended value by the chp manufacturer is 100 ppm with the established sp in apcp2 h2s levels were also always below inhibitory concentrations reported in the range of 100 800 mg l dissolved sulphide or approximately 50 400 mg l dissociated h2s chen et al 2008 nevertheless contrary to some previous studies kulandaivelu et al 2020 yuan et al 2020 no correlation between fecl3 dosage fecl3 11 and polyelectrolyte consumption polyelectrolyte 12 was found figs 6s and 7s in supplementary material as the results yielded a spearman s correlation coefficient value of 0 054 narrow 95 confidence interval around zero with no significant differences in polyelectrolyte requirements over periods p1 to p3 table 2 regarding anf control in p3 fig 1 the antifoam consumption was reduced from 20 to 9 kg d 1 a 42 decrease between p0 p1 and p3 antifoam 11 in table 2 despite this important reduction the analysis of variance one way anova indicated no statistical differences in antifoam consumption during the experimental periods table 2 it must be taken into consideration that foam formation in anaerobic reactors is related to bulking processes in biological reactors of the water line consequently reagent consumption is seasonal and specifically concentrated during winter or periods of low temperatures the fact that during part of the year the antifoam consumption is close to zero but it is high during december february produces great variability in the data resulting in an anova with no significant differences among periods p0 to p3 if the data are plotted against time months clear differences can be observed as shown in fig 3 when comparing p0 and p3 data only anova and tukey s test results indicated statistically significant differences between these two periods table 2 in any case the results show that the anf control tool is a reliable strategy to control reagent overdoses compared to the non automated system previous periods p0 or p1 in fig 3 during p2 an increase in methane yield was observed from 0 23 to 0 34 nm3 ch4 kgvs 1 a 48 increase from p1 to p2 which could be attributed to the increase in the hrt from 20 to 25 days and the increase in digesters temperature from 35 c to 37 c furthermore comparing p0 and p2 with similar hrt 11 values an increase in the methane yield was also observed 17 2 supporting the hypothesis that temperature increase enhanced biogas production the effect of digestion temperature will be discussed further p3 focused on improving the performance of the secondary sludge settlers through the implementation of apcp3 er control fig 1 increased the biomass content in the activated sludge reactors tss r 2 which was necessary to achieve the new nur and outflow requirements fig 8s and table 3s in the supplementary material as extensively described by palatsi et al 2021 according to table 2 the implementation of the apcp3 tool also resulted in a significant increase in the tss 6 of the secondary settled sludge from 3 8 to 4 7 mg l 1 a 24 increase in mean values between p0 p1 p2 and p3 whereas the was flow rate sent to the secondary thickener q 6 was reduced from 1148 to 772 m3 h 1 a 33 reduction in mean values between p0 p1 p2 and p3 regarding the was thickening performance the ts in the secondary thickened sludge ts 9 did not show significant variation table 2 furthermore the primary settler control introduced in p3 ps control fig 1 caused a significant increase in primary sludge concentration tss 4 increasing from 4 1 to 5 8 mg l 1 a 41 increase in mean values between p0 p1 p2 and p3 in contrast the primary sludge purge q 4 was reduced from 1220 to 1025 m3 h 1 a reduction in mean values between p0 p1 p2 and p3 as shown in table 2 and fig 2s supplementary material finally both ps control and psth control resulted in a significant increase in the primary thickened sludge s solids content ts 8 from 49 0 to 64 5 g l 1 32 from p0 to p3 table 2 to summarize fig 4 shows main variations in the ad parameters along experimental periods or tested apcs p1 to p3 vs p0 the effects of the ps was ratio and temperature on the yields from the ad process are discussed in the next section 3 2 mass and energy balance mass and energy balances were carried out to evaluate how the apc control strategies applied to the sludge line affected the energy self sufficiency of the wwtp fig 9s and fig 10s supplementary material show the wwtp mass and energy balances for periods p0 and p3 respectively considering the average values reported in table 2 the improvements in the sludge line control resulted in a 15 4 increase in methane production from 1740 nm3 ch4 d 1 18 740 kwh d 1 to 2009 nm3 ch4 d 1 21 600 kwh d 1 this increase in methane production is primarily linked to the increase in vs digester feeding statistically significant differences in vs 10 between p0 and p3 table 2 and to the improvement in digester performance vsremoval 11 it can be observed that the production of thickened ps increased from 2983 to 5244 kgvs d 1 whereas the production of thickened was decreased from 3471 to 2690 kgvs d 1 figs 9s and 10s supplementary material consequently the ratio between the ps and was thickened sludges changed from 46 54 to 66 34 bmp tests were performed at 36 c with ps was and ss to evaluate the methane production potentials during the experimental period fig 5 it can be observed how during all the tested periods the highest biomethane potential bmax was obtained for the ps mean value of 0 37 0 03 nlch4 kgvs 1 whereas the lowest was that of the was mean value of 0 21 0 03 nlch4 kgvs 1 thereby yielding sss with a biomethane potential within this range 0 30 0 04 nlch4 kgvs 1 the organic matter present in ps consists of fatty acids cellulose lipids fibres and other solids with higher energy potential than was composed mainly of refractory products such as microbes and extracellular polymeric substances sakaveli et al 2021 as shown in fig 5 a slight improvement in the cumulative specific methane production nlch4 kgvs 1 was observed mainly in the ps experiments these differences can be related to variations in organic matter content in wwtp inflow and consequently in ps composition expressed in fig 5 as the cod ts ratio of wwtpinflow it is widely known that temperature is a crucial parameter in ad nie et al 2021 the main advantages of a mesophilic operation compared to high temperature approaches are lower energy consumption and resilience to shock loading or the addition of inhibitor materials kim et al 2017 therefore most mesophilic digestion systems are designed to operate in a temperature range of 37 2 c and for optimum digester performance a stable operating temperature should be maintained with a daily variability of less than 0 5 c lin et al 2017 liu et al 2018 merlin et al 2012 moreover the mesophilic temperature has an important impact on the rate of hydrolysis and biogas formation nielsen et al 2017 showed that increasing the reactor temperature from 35 c to 39 c led to a yield of approximately 20 mlch4 gvs 1 with a favourable energy balance however in practice and for various reasons some full scale mesophilic digesters continue to operate under low mesophilic temperature conditions additional bmp tests were performed with ps was and ss at 36 38 40 and 42 c using the digested sludge taken at the end of period p3 as the inoculum table 3 the inoculum although adapted to the operating conditions of p3 40 c did not show differences in the bmax values obtained at different temperatures in contrast a clear effect on the estimated digestion kinetic constant khyd was observed with increasing temperature for the different sludge types table 3 as mentioned before an important factor in the present study is the increase in srt in the biological reactor to accomplish new wwtp discharge limits srt r 2 table 3s in the supporting material this strategy resulted in a reduction in the secondary sludge purge q 6 table 2 furthermore the present apc tools significantly reduced the ratio between the purged solids in the was and the organic matter inflow to the biological reactor prwas ratio table 2 from 0 54 to 0 33 gtss gcod 1 this reduction indicates a more efficient use of the organic matter entering the reactor codrecycled table 2 which was used to remove the nutrients instead of transforming them into sludge that requires management to summarise based on the energy balances performed the adoption of apc strategies increased the potential electric production of the wwtp from 5798 to 6696 kwh d 1 considering that the electric energy consumption of the plant remained unaltered and the produced biogas could be used this increase translates to an improvement towards the plant s energy self sufficiency from 43 to 51 fig 6 3 3 economic analysis from an economic standpoint it is challenging to determine the exact profitability of the presented apc systems several factors such as the performance through 6 years of operation seasonal variations in wastewater properties new strategies adopted in the operation of the biological reactor in the water line variations in energy and chemical costs and the uncertainty in estimating the effect cost associated with some wwtp upgrades limit the completion of an economic analysis despite these limitations from p0 reference period to p3 optimised period an economic assessment was conducted considering the costs associated with the investments performed in the tested apc systems capex and estimating the benefits over operational expenses opex with the improved wwtp yields as shown in table 4 despite the cumulative capex over 6 years of operation 169 696 a positive opex savings was obtained with the implemented apc systems 85 565 y 1 resulting in a capex payback after 1 98 y which is economically feasible for a large scale wwtp although the savings may be specific to the studied wwtp the results show that three main factors influence the savings in opex energy reagents and sludge management regarding sludge management it is observed that the increase in vsremoval in anaerobic digesters reduces sludge production from 8760 to 7811 ton y 1 this represents savings of 11 in sludge management costs even with an increase in polyelectrolyte consumption from 13 5 to 16 9 kgpolyelectrolyte y 1 which is not a significant increase in global sludge de watering management costs according to table 4 3 4 apc experiences lessons learned and new challenges this study shows the implementation of different apc tools to improve an actual full scale wwtp sludge line over a 6 year period the positive practical implications lessons learned and challenges remaining are detailed below i sludge lines are largely forgotten issues in wwtp optimisation goals the most common approach for sludge line optimisation is the use of pre treatments or advanced digestion systems that do not pay sufficient attention to sludge thickening this study shows how apc systems focused on sludge thickening can optimise the sludge line and therefore increase wwtp energy self sufficiency ii the results and practical experience show that the sludge line sampling methodology plays an important role in the quality of the data acquired punctual and random sampling makes it difficult to achieve a correct mass balance although implementing integrated sampling in a sludge line can be challenging the results show that this methodology can significantly increase the accuracy of the data iii the implementation of a robust apc system requires numerous sensors analysers and hardware that require frequent maintenance errors in sensor measurements can create significant problems related to the achievement of process rates in this regard the deployment of soft sensor technologies can improve sensor predictive maintenance or decision support tools thereby increasing the reliability of apc systems at the present wwtp these technologies were introduced to the water line the implementation of this technology in the key sensors of the sludge line is the next step in the sludge line optimisation process described in this study iv although apcs are presented as individual tools or apps most of them are interrelated consequently it is necessary to have a global and open control platform for wwtps that allows the integration of these different modules v most anaerobic reactors in wwtp can still be promoted in terms of olr vsremoval or operational temperature regime to achieve a considerable increase in on site biogas production and a higher energy self sufficiency vi in the current european scenario final sludge production in wwtps poses enormous environmental and economic challenges although the final sludge is composed of by products that are valuable for agricultural applications organic matter phosphorus and nitrogen they are not exempt from risks associated with their use potential pollutants pathogens and others leading to restrictive legislation for soil applications the optimisation of the sludge line using apc tools can result in a final sludge decrease of 11 thereby helping to make this challenge more achievable 4 conclusions the implementation of apc tools represents an easy and cost effective solution for improving the sludge lines of existing wwtp with the strategies implemented herein a 43 51 increase in the wwtp s energy self sufficiency was achieved a significant enhancement 9 5 in the thickening of the sewage sludge was achieved together with an increase in the methane yield of digesters 10 a reduction in the consumption of antifoam and iron chloride 53 and 75 respectively and a reduction 11 in the de watered sludge to be managed from an economic perspective the implementation of the tested apc tools resulted in opex reductions with an estimated return of the performed capex after 1 98 years which is economically feasible for a large scale wwtp declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors are grateful to the dedication and work of jordi lopez on wwtp supervision and maintenance tasks gloria prunera for analytical support and previous wwtp managers process managers j millà j giribet d gonzalez d blanch m isidro and o domingo for their work on operation and control acknowledgements are also due to voltec l perez and the createch360 teams f ripoll involved in the design implementation and adjustment of the apc tools the authors would also like to thank david bedoya dewberry usa and joseph el kadi university of cambridge uk for proofreading and reviewing the article this research was made possible due to the support of research activities at municipal wwtp by the aqualia i d department p icaran x tomas and v monsalvo aca catalan water agency g ramirez and lleida city council j domingo supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118924 appendix supplementary materials image application 1 
15674,globally eruptive harmful algal blooms habs have caused numerous negative effects on aquatic ecosystem and human health conversion of habs into biohythane via dark fermentation df is a promising approach to simultaneously cope with environmental and energy issues but low habs harvesting efficiency and biohythane productivity severely hinder its application here we designed a gradient electro processing strategy for efficient habs harvesting and disruption which had intrinsic advantages of no secondary pollution and high economic feasibility firstly low current density 0 888 4 444 ma cm2 was supplied to habs suspension to harvest biomass via electro flocculation which achieved 98 59 harvesting efficiency a mathematic model considering coupling effects of multi influencing factors on habs harvesting was constructed to guide large scale application then the harvested habs biomass was disrupted via electro oxidation under higher current density 44 44 ma cm2 to improve bioavailability for df as results hydrogen and methane yields of 64 46 ml g vs and 171 82 ml g vs were obtained under 6 min electro oxidation along with the highest energy yield 50 1 kj l and energy conversion efficiency 44 87 mechanisms of habs harvesting and disruption under gradient electro processing were revealed along with the conversion pathways from habs to biohythane together this work provides a promising strategy for efficient disposal of habs with extra benefit of biohythane production graphical abstract image graphical abstract keywords harmful algal blooms dark fermentation biohythane electro oxidation 1 introduction outbreak of harmful algal blooms habs due to water eutrophication has caused numerous negative effects on public health and aquatic ecosystem including massive fish deaths aquatic habitats destruction drinking water contamination and human illness induced by cyanotoxins zhu et al 2020a habs disposal is a globally significant concern with respect to water quality management kim et al 2021 the available approaches for habs removal include physical methods such as filtration chemical methods such as algaecides addition and biological methods such as algae predator introduction huang et al 2021 zhu et al 2020b for example chemical algaecides addition such as diuron and dibromohydantoin is commonly applied in emergency attributing to operational ease and fast start huisman et al 2018 however secondary pollutions of water body for the available chemical or biological methods and high energy consumption for the physical methods are unavoidable problems that should be concerned roussl et al 2020 yang et al 2022 unfortunately an eco friendly and efficient approach to ease habs issue is yet to be reported besides energy conversion from wastes is another challenge to humans chang et al 2018 li et al 2022 there is a pressing need to exploit renewable and environmental friendly energy sources to reduce dependency on fossil fuels hythane fuels containing carbon neutral bio h2 and one carbon involved bio ch4 generated from waste biomass are competitive candidates for energy sustainability and carbon neutrality li et al 2021 jia et al 2020 among all approaches for hythane production biological route i e biohythane via dark fermentation df has many intrinsic advantages by avoiding high energy cost and extreme reaction condition compared to chemical or thermochemical routes during df the feedstocks are consumed and converted into bio h2 and bio ch4 through microbial metabolism under mild conditions park et al 2019 the habs biomass contains abundant carbohydrates and proteins which are superior feedstocks for biohythane production via df peter et al 2022 it would be of great interest in commercial applications if the overrun habs can be fermented into biohythane and thus potentially resolving water pollution and energy conversion issues at the same time however large scale biohythane production with habs biomass still faces many technical limitations in which inefficient habs biomass harvesting and intracellular compositions release are two typical terms lam et al 2017 from one hand microalgae cells stably suspend in water due to strong electrostatic repulsive force originated from cellular surface negative charge with zeta potential of 40 to 7 5 mv and low settling rate owing to tiny cell gravity zheng et al 2019 compared to the energy intensive physical methods such as centrifugation and filtration using chemical methods to harvest habs biomass have attracted increasing interests due to low energy consumption the reported chemical methods mainly focused on electrostatic neutralization and microalgal cells aggregation thereby accelerating the settling rates of microalgal biomass zhao et al 2021 for example ferrate was used as flocculants by alshahri et al 2021 to neutralize negative charge of microalgae cells and achieved ca 85 of habs biomass collection but the massive utilization of fe based flocculants may cause heavy metal pollution and inhibit df performance which weakens technical and economic feasibility of bioenergy conversion from habs from the other hand processes of habs biomass disruption and intracellular compositions release are energy intensive carvalho et al 2020 although microalgae cell wall is not as recalcitrant as terrestrial plants like rice straw pretreatment is also an important step to break down carbohydrates and proteins into monomers for efficient df ding et al 2019 available methods for microalgae pretreatment mainly include mechanical approaches such as high pressure homogenization chemical approaches such as acid alkaline hydrolysis or supercritical co2 and enzymatic hydrolysis approaches phwan et al 2018 these pretreatments can enhance biodegradability of microalgae biomass to a great extent for improving df performance but still many challenges remain including environmental pollutions risk chemical approaches high energy consumption physical approaches and high operation cost enzymatic approaches li et al 2020a therefore an efficient strategy for simultaneous habs harvesting and pretreatment is required which is yet to be reported in this work a gradient electro processing strategy was designed to simultaneously achieve habs harvesting and pretreatment fig 1 a in detail a low current density was provided to the habs suspension first to harvest microalgae biomass by neutralizing cellular negative charge with electro generated al oh 3 then a higher current density was provided to disrupt cell wall of the harvest habs biomass by generating oh radical finally the pretreated habs biomass was converted into biohythane via two stage df fig 1b together the insights of this work include 1 evaluate performance of the designed gradient electro processing strategy 2 reveal mechanisms of habs harvesting cell disruption and biohythane generation 3 optimize overall energy conversion efficiency from habs to biohythane 2 materials and methods 2 1 materials and strains k2cr2o7 99 h2so4 95 98 phenol 99 5 and ag2so4 99 5 were purchased from sigma aldrich co ltd usa coomassie brilliant blue and hgso4 99 5 were purchased from sinopharm chemical reagent co ltd china hydrogen producing bacteria hpb and methane producing bacteria mpb were isolated from the sludge collecting from a rural household biogas digester in chongqing china to better study habs harvesting kinetics via electro flocculation microalgae biomass concentration was precisely controlled by simulating a habs suspension with chlorella pyrenoidosa as target strain the microalgal suspension was pre cultured in a light incubator zgz 800c l binglin shanghai china at constant light intensity of 9000 lux carbon dioxide concentration of 5 and temperature of 25 0 5 c 2 2 gradient electro processing system the equipment used for gradient electro processing contained a bioreactor made of glass working volume 0 5 l dc power and two aluminum plate electrodes the dimensions of aluminum plates were 75 30 3 mm and the current range of dc power was 0 10 a with voltage range of 0 15 v all electro processing tests were performed under batch mode 2 3 habs harvesting through electro flocculation with low current density in the first stage low current densities of 0 888 1 778 2 666 3 556 and 4 444 ma cm2 were provided to the habs suspensions for biomass harvesting to approach environmental relevant conditions room temperature of 25 c was adopted to simulate temperature condition for frequent habs outbreak and 1 g l of microalgae biomass concentration was used to simulate habs concentration at the most serious case in real pandey et al 2019 effects of major influencing factors like ph 2 4 6 8 and 10 current density 0 888 1 778 2 666 3 556 and 4 444 ma cm2 and electro flocculation duration 2 4 6 8 10 min on habs removal were investigated to explore the most efficient manner for habs harvesting firstly single factor influence on habs harvesting was investigated via control variable method after coupling effects of three major influencing factors ph current density and electro flocculation duration on habs harvesting were investigated via response surface methodology rsm to facilitate working conditions optimization during practical application the experimental conditions for rsm were designed with designing software regarding ph current density and electro flocculation duration as variables x1 x2 and x3 respectively table 1 experimental ranges of three influencing factors were selected as ph of 2 10 current density of 0 888 4 444 ma cm2 and electro flocculation duration of 2 10 min during electro flocculation 3 ml of microalgal suspension in middle layer of the test tube was sampled per 10 minutes and sample absorbance at 680 nm was measured with a uv vis spectrophotometer t6 new century persee china to calculate the residual microalgal biomass concentration 2 4 habs disruption through electro oxidation under high current density in the second stage high current density of 44 44 ma cm2 was provided to harvest microalgae biomass from 500 ml of habs suspension to cell wall disruption along with intracellular biodegradable compositions release effects of electro oxidation duration 2 4 6 8 10 min on composition changes of the feedstocks were investigated under constant current density of 44 44 ma cm2 2 5 dark fermentation of pretreated habs biomass for biohythane production pretreated habs biomass and 25 ml activated hpb were injected into 250 ml fermentation flasks with working volume of 200 ml initial ph of all groups was adjusted to 6 0 0 1 with 6 m hcl and naoh the flasks were completely sealed with rubber stopper and purged with nitrogen gas purity 99 999 for 10 min to create an anaerobic environment for hpb metabolism all groups were first incubated in a water bath at 35 0 1 c to produce hydrogen and volatile fatty acids vfas after 2 days 25 ml activated mpb was added to the fermentation flasks and initial ph was adjusted to 8 0 0 1 the flasks were completely sealed with rubber stopper and purged with nitrogen gas for 10 minutes to create an anaerobic environment for mpb metabolism the mpb was incubated for 36 days in water bath at 35 0 1 c for methane generation 2 6 analysis 2 6 1 properties of habs biomass total solids ts volatile solids vs suspended solids ss and volatile suspended solids vss of harvest habs biomass before and after electro oxidation were determined by gravimetric method specifically ts and ss were dried to constant weight in an oven at 105 c vs and vss were measured by burning in a muffle furnace at 600 c 2 6 2 carbohydrates proteins and cod concentration carbohydrates of habs biomass were detected by phenol sulfuric acid method dubois et al 1956 proteins were detected by coomassie brilliant blue method bradford et al 1976 and chemical oxygen demand cod was determined using rapid digestion spectrophotometry chang et al 2020 all samples were filtered through a 0 22 μm microporous membrane before analysis 2 6 3 macromolecular organics content gas chromatograph mass spectrometer gc ms gc ms qp2010 plus shimadzu japan was used to determine types and contents of organics in the fermentation medium under different electro oxidation duration first organics contained in the samples were extracted with 30 ml ch2cl2 chuandong chemical co ltd china ar w 99 5 under acidic neutral and alkaline conditions then the extract was concentrated to 3 ml at 40 c using a rotary evaporator re 52aa shanghai china for gc ms analysis concentrations of macromolecular organics were calculated as product of total cod concentration and percentage of each organic species 2 6 4 hydrogen methane and vfas concentration gas chromatograph equipped with a thermal conductivity detector and a microfilled column sc 3000b chuan yi chongqing china was used to detect hydrogen and methane concentration gas chromatograph equipped with a hydrogen flame ionization detector and a polar capillary column gc126n jingke shanghai china was used to detect vfas concentration 2 7 calculation 2 7 1 kinetic parameters of anaerobic fermentation kinetic parameters of hydrogen and methane production during df were obtained by fitting experimental data with the modified gompertz formula eq 1 1 h h m e x p e x p r m e h m λ t 1 where h is the cumulative gas production ml g hm is the highest gas production potential ml g rm is the peak gas production rate ml g h tm is the peak gas production time h λ is the fermentation delay time h and e is the natural logarithm which is 2 718 2 7 2 inhibition coefficient of anaerobic fermentation the inhibiting effect of electro oxidation on hydrogen and methane production during df was quantitatively analyzed by the inhibition coefficient ic which was calculated with eq 2 2 ic 1 apr 90 with added inhibitor ap r 90 without added inhibitor 100 where apr90 represents the average gas production rate calculated when gas production reaches 90 of the total cumulative production the parameter ic can comprehensively reflect the effect of inhibitors on fermentation delay time fermentation cycle and total gas production 2 7 3 energy conversion characteristics based on previous work by liu et al 2018 high heating values hhv of hydrogen and methane are 286 and 889 kj mol respectively corresponding to 12 8 kj l h2 and 39 7 kj l ch4 besides the hhvs of ethanol acetic acid propionic acid butyric acid valeric acid and capric acid are 1367 874 1527 2184 2837 and 3492 kj mol respectively the hhvs of c pyrenoidosa were calculated according to the mendeleev equation as shown in eq 3 sun et al 2019 in which c h o and s represent elementary contents that were determined with elemental analyzer vario macro cube elementar germany 3 hhv kj g 0 33858 c 1 254 h 0 10868 o s energy conversion efficiency ece of conversion process from habs to biohythane was calculated as result of total output energy divided by total input energy eq 4 in eq 4 total hhvs of hydrogen methane and vfas were deemed as output energy total input energy included electric energy and hhv of habs biomass it should be mentioned that input electric energy contains the energy consumption during both electro flocculation and electro oxidation processes 4 ece total output energys kj total input energy kj 100 3 results and discussion 3 1 habs harvesting efficiency enhancement assisted by electro flocculation 3 1 1 effect of single factor on habs harvesting to reveal effect of single influencing factor on habs harvesting the maximum harvesting efficiencies changed with ph current density and electro flocculation duration were illustrated in fig 2 a and b the electro flocculation strategy achieved efficient biomass harvesting from suspension with the maximum harvesting efficiency of 98 59 under acidic environment of ph 2 it is obvious that low ph high current density and long electro flocculation duration were more favorable conditions for habs harvesting the gaps of harvesting efficiencies between different conditions were in close relations with amount and morphology of cationic al3 in habs suspension when current density was 0 888 ma cm2 fig 2a initial ph had great impact on habs harvesting because it controlled the morphology of aluminum hydroxide in the solution and the maximum habs harvesting efficiency 90 4 98 3 was achieved under acidic environment with ph of 2 4 during electro oxidation cationic al3 was released from electrode and formed monomeric or polymeric al oh 3 al3 as flocculants which can aggregate microalgae cells via synergistic effects of bridging and charge neutralization the acidic environment triggered formation of positively charged monomeric or polymeric al oh 3 al3 wong et al 2017 paulista et al 2018 which enhanced interactions with negative charged microalgae cells and resulted in habs suspension destabilization liu et al 2017 when suspension changed from acidic to alkaline condition formation of monomeric or polymeric al oh 3 al3 was inhibited resulting in decrease of habs harvesting efficiency to 59 1 75 3 under ph of 6 8 and to 44 3 under ph of 10 harvesting kinetic curves supplementary fig s1a illustrated that first order kinetic model fitted well with experimental data but the precision decreased with increasing ph when habs suspension was kept under acidic condition ph 2 fig 2b habs harvesting efficiency increased with improving current density and electro flocculation duration attributing to higher al3 availability in suspension fig 2c illustrated that al3 concentration in suspension was obviously improved with increasing current density and electro flocculation duration which accelerated habs biomass aggregation and settlement as results habs harvesting efficiencies increased from 48 38 under 0 888 ma cm2 2 min to 98 59 under 4 444 ma cm2 10 min fig 2b besides it is seen shorter electro flocculation duration was needed to achieve total removal of habs biomass under higher current density for example it needed 10 min electro flocculation to achieve 97 13 habs removal under 0 888 ma cm2 while only 2 min was required for 97 00 habs removal under 4 444 ma cm2 fig 2b harvesting kinetic curves supplementary fig s1b illustrated that first order kinetic model fitted well with experimental date at all current density 3 1 2 coupled effects of multi factors on habs harvesting high habs removal efficiency and low energy consumption are major objectives that pursued by researchers for practical application but these two targets are usually incompatible investigation on coupled effects of multi factors on habs harvesting to explore optimized conditions concerning both economy and efficiency are feasible approach at present experimental conditions and results of habs harvesting considering coupled effects of ph current density and electro flocculation duration were shown in table 1 and the rsm results were illustrated in fig 2d 2e f and supplementary fig s2 it is shown that ph had more significant influence on habs harvesting than current density and electro flocculation duration the maximum habs harvesting efficiency of 99 11 was achieved when ph 2 current density 4 444 ma cm2 and electro flocculation duration 6 min based on experimental data shown in table 1 a mathematic modelling regarding habs harvesting efficiency as dependent variable y and regarding ph x1 current density x2 electro flocculation duration x3 as independent variables were established as eq 5 the mathematic modeling was constructed with quadratic polynomial model which was convinced to have a better fitting precision with r2 0 968 5 y 79 35 34 33 x 1 0 5488 x 2 1 78 x 3 3 41 x 1 x 2 6 4 x 2 x 3 2 73 x 2 x 3 11 18 x 1 2 4 56 x 2 2 3 27 x 3 2 relevant parameters for the established habs harvesting model i e eq 5 were shown in supplementary table 1 p value for ph was 0 0001 while the value was much higher for current density p 0 9128 and electro flocculation duration p 0 4513 it demonstrated that ph had a more significant impact on habs harvesting suggesting that ph sensitive al3 morphology existed in habs suspension was more important than al3 concentration as shown in fig 2d and e when electro flocculation duration was fixed at 6 min fig 2d or current density was fixed at 2 666 ma cm2 fig 2e habs harvesting efficiency changed drastically with ph but influenced slightly by current density or electro flocculation duration when ph value was kept constant at 2 fig 2f habs harvesting efficiency varied slightly from 80 84 to 99 62 with similar impacts by current density and electro flocculation duration this result can contribute to select smart operating options for minimizing energy consumption during practical application 3 2 habs biomass disruption assisted by electro oxidation compositions of the harvested habs biomass without electro oxidation pretreatment showed that the biomass contained high vs content 71 00 especially for high soluble proteins 156 84 mg g vs and soluble carbohydrates 81 57 mg g vs table 2 which were a superior feedstock for biohythane production during df to disrupt microalgae cell and release intracellular biodegradable compositions into df medium current density of 44 44 ma cm2 was provided to the harvest habs biomass for 2 4 6 8 and 10 min effects of electro oxidation duration on df medium compositions including ts vs vss ss dissolved cod carbohydrates and proteins concentrations were shown in fig 3 a in general electro oxidation had little effects on ts and vs with constant contents of ca 70 90 before and after electro oxidation but vss ss soluble cod carbohydrates proteins and lipids concentrations were greatly enhanced by electro oxidation which obviously improved bioavailability of soluble compositions in df medium when electro oxidation duration increased from 0 to 2 min vss and ss contents sharply increased from 0 to ca 40 whereafter these contents kept constant with increasing electro oxidation duration from 2 to 10 min fig 3 since vss and ss contents in df medium can reflect cell disruption degree it indicated that electro oxidation of 2 min was enough to fully disrupt microalgae cell wall with electro oxidation duration increased from 2 to 6 min soluble cod carbohydrates proteins and lipids concentrations monotonously increased to 609 63 177 37 328 81 and 191 51 mg g vs respectively it indicated that improving electro oxidation duration triggered conversion of disrupted microalgae biomass into soluble compositions like cod carbohydrates and proteins which were potential biodegradable feedstock for biohythane production but when electro oxidation duration further improved from 6 to 10 min concentrations of cod carbohydrates and proteins increased little or even decreased slightly indicating that excessive electro oxidation resulted in decomposition of the soluble compositions therefore it can be concluded that electro oxidation of 6 min was a better choice to balance feedstock bioavailability and energy consumption changes of macromolecular organics compositions and concentrations for habs biomass under various electro oxidation duration were illustrated in fig 3b c and supplementary fig s3 in fig 3b concentrations of macromolecular organics gradually increased with electro oxidation duration increasing from 0 to 10 min showing that longer electro oxidation duration enhanced biomass conversion to soluble organics among these macromolecular organics percentages of phytol and octadecatrienoic acid were improved with increasing electro oxidation duration while hexadecenoic acid and 13 docosenamide percentages were reduced with increasing duration fig 3c the decrease of hexadecenoic acid and 13 docosenamide percentages were because of possible degradation reactions occurred with increasing electro oxidation duration which was convinced by reduced concentrations of these organics fig 3b while the decreases of phytol and octadecatrienoic acid concentrations were not observed with increasing duration leading to improved phytol and octadecatrienoic acid percentages fig 3b and c most of all 13 67 mg l and 36 68 mg l phenol were generated under electro oxidation duration of 8 and 10 min respectively which is a typical inhibitor for df indicating that excessive electro oxidation of habs biomass can cause negative effects on biohythane production 3 3 hydrogen and methane production hydrogen yield hy methane production my hydrogen production rate hpr methane production rate mpr as well as kinetics fitted with the gompertz model when using habs biomass treated with various electro oxidation duration were illustrated in fig 4 it is shown that electro oxidation had obvious positive effects on hydrogen and methane production which enhanced hy and my compared to the control group with 0 min electro oxidation the highest hy of 64 46 ml g vs and my of 171 82 ml g vs were obtained under electro oxidation for 6 min when the harvest habs biomass was electro oxidized for 0 min the hy and my were 33 08 and 51 14 ml g vs fig 4a and b with the maximum hpr and mpr of 2 67 ml g vs h and 3 23 ml g vs d respectively fig 4c and d this may suggest that algal blooms have the potential to be used as feedstock for biohythane production but productivities were very low this was because that the solid cell membrane of untreated habs hindered intracellular organics like carbohydrates and proteins release resulting in low bioavailability of df substrates when electro oxidation duration increased from 0 to 6 min the hy and my were improved to 64 46 and 171 83 ml g vs with hpr and mpr improving to 6 79 ml g vs h and 7 29 ml g vs d respecively the improvement of hy and my were mainly ascribed to the following two reasons firstly the soluble cod carbohydrates and proteins concentrations were improved fig 3 which provided more biodegradable feedstocks for hpb and mpb secondly the oxidation reduction potential opr was reduced to a more negative value fig 4e which created a suitable environment for hpb and mpb metabolism li et al 2020b fig 4e shows that orp level of df medium under 0 min was ca 450 mv while the orp value decreased to a level of 300 to 100 mv under electro oxidation of 6 min as seen in table 3 the inhibition coefficient ic was reduced from 62 26 to 115 33 for hydrogen and reduced from 47 64 to 273 41 for methane production when electro oxidation duration increased from 2 to 6 min demonstrating a stronger promotion effects on df with 6 min electro oxidation when electro oxidation duration further increased from 6 to 10 min bioavailability of soluble composition was similar with that under 6 min and the orp level was kept at favorable range of 378 50 to 121 50 mv fig 4e however the hy and my were obviously reduced to 42 83 and 73 92 ml g vs respectively fig 4a and b the inhibition effects were mainly ascribed to a reason that the prolonged electro oxidation duration generated massive phenol in df medium 38 68 mg l phenol for 10 min fig 3c which had much stronger inhibition effect on df than furans sun et al 2019 although the longer electro oxidation duration 8 and 10 min released more al3 into medium 6 05 mg l for 10 min fig 4f such a value was not high enough to inhibit hpb and mpb activity wu et al 2019 ic under 10 min electro oxidation was improved to 60 64 table 3 demonstrating that the promotion effects originated from electro oxidation pretreatment was greatly reduced after kinetic characteristics of fermentation processes were fitted with gompertz model fig 4g h and tables 4 5 it is shown that the gompertz model fitted well with experimental data for all cases r2 0 97 the gas production potential hm first increased and then decreased with improving electro oxidation duration and the highest hm for hydrogen 68 06 ml g vs and methane 170 44 ml g vs were obtained under 6 min electro oxidation however the fermentation delay time λ was continuously shortened with increasing electro oxidation duration which is a pleasant result for overall productivity improvement 3 4 volatile fatty acid production in addition to biohythane vfas are also valuable platform molecules to produce biochemicals like degradable plastic commodity sun et al 2020 the vfas concentrations in fermentation medium during hydrogen and methane production processes were shown in fig 5 it is seen that the fermentation medium mainly contained acetic acid 68 82 4540 76 mg l propionic acid 1 06 1755 58 mg l butyric acid 0 55 1367 38 mg l and ethanol 27 99 235 69 mg l as major vfas products among butyric acid and ethanol were major compositions existed in the first 30 h i e hydrogen production process while acetic acid and propionic acid were major vfas compositions during day 3 to day 36 i e methanogenesis process during hydrogen producing process i e the first 30 h carbohydrates and proteins were regarded as major feedstocks for hydrogen production since lipids were hard to be used by hpb drapcho et al 2008 feng et al 2022a as illustrated in fig 5 large quantities of butyric acid and ethanol were generated while little acetic acid and propionic acid were detected in the first 30 h therefore the probably dominating reactions happened in this process using carbohydrates and proteins as feedstocks can be concluded as following eqs 6 9 carbohydrates as feedstock 6 c 6 h 12 o 6 c h 3 c h 2 2 cooh 2 c o 2 2 h 2 7 c 6 h 12 o 6 2 c h 3 c h 2 oh 2 c o 2 proteins as feedstock 8 2 c 3 h 7 o 2 n 2 h 2 o c h 3 c h 2 2 cooh n h 3 c o 2 h 2 o 9 2 c 3 h 7 o 3 n c h 3 c h 2 2 cooh 2 n h 3 2 c o 2 at this time the ethanol concentration in df medium monotonously decreased with increasing electro oxidation duration from 0 to 10 min while butyric acid concentration first increased and then decreased with the maximum value 1367 38 mg l obtained under 6 min fig 5a and d demonstrating that slight electro oxidation pretreatment 6 min promoted butyric production reaction eqs 6 8 and 9 but inhibited ethanol production eq 7 during methanogenesis process i e from 30 h to day 36 changes of vfas compositions mainly experienced two stages i e in the first stage the butyric acid and ethanol were consumed to generate methane accompanied by acetic acid and propionic acid concentrations improvement from 30 h to day 18 and in the second stage the acetic acid and propionic acid were consumed to generate methane from day 18 to day 36 in the first stage from 30 h to day 18 the butyric acid and ethanol concentrations sharply decreased to almost 0 mg l from 30 h to day 3 fig 5a and d at this time the acetic acid and propionic acid concentrations continuously increased from day 3 to day 18 which probably triggered butyric acid and ethanol degradation reactions eqs 10 13 to produce methane along with acetic acid and propionic acid as by products during this stage electro oxidation pretreatment greatly enhanced acetic and propionic acid yields and production rates but excessive electro oxidation like 8 and 10 min caused negative effects on propionic acid production with obvious concentration decrease fig 5b and c it should be mentioned that since hydrogen generated in hydrogen production process was stored in the collection bottle thus the hydrogen gas in eq 13 was very likely sourced from butyric acid degradation to produce propionic acid and acetic acid eqs 11 and 12 10 2 c h 3 c h 2 oh c o 2 c h 4 2 c h 3 cooh 11 c h 3 c h 2 2 cooh 2 h 2 o c h 3 c h 2 cooh 3 h 2 c o 2 12 c h 3 c h 2 2 cooh 4 h 2 o c h 3 cooh 6 h 2 2 c o 2 13 4 h 2 c o 2 c h 4 2 h 2 o at the second stage from day 18 to day 36 the acetic acid and propionic acid were consumed by bacteria to produce methane via the following eqs 14 16 compared to propionic acid the acetic acid was consumed in priority attributing to lower gibbs free energy g0 31 0 kj mol for eq 14 than the pathway of propionic acid fermentation for methane production g0 9 68 kj mol for eq 15 and g0 76 44 kj mol for eq 16 feng et al 2022b therefore acetic acid concentration was quickly reduced from day 18 to very low value 1000 mg l at day 24 under all electro oxidation durations fig 5b while the decrease of propionic acid concentration was very limited until day 30 rapid decrease of propionic acid concentration from day 30 to day 36 can be ascribed to depletion of acetic acid fig 5c 14 c h 3 cooh c h 4 c o 2 15 c h 3 c h 2 cooh h 2 c h 3 cooh c h 4 16 c h 3 c h 2 c o o h 2 h 2 o c h 4 3 h 2 2 c o 2 3 5 energy conversion efficiency energy yields and energy conversion efficiencies ece from habs biomass to hydrogen methane and vfas under various electro oxidation duration were illustrated in fig 6 the highest total energy yield of 50 1 kj l with ece of 44 87 was obtained under 6 min electro oxidation under this case vfas were major energy carriers 42 26 kj l in total with propionic acid 29 8 kj l as dominating compositions following by acetic acid 6 42 kj l butyric acid 4 68 kj l and ethanol 1 36 kj l output energy of biohythane was much lower than vfas with 6 89 kj l for methane and 0 86 kj l for hydrogen when habs biomass was directly used for df i e 0 min 23 9 kj l of total energy yield was obtained with only 2 07 kj l methane and 0 42 kj l hydrogen fig 6a demonstrating possibility of bioenergy production with habs biomass but the ece was very low 21 51 fig 5b when electro oxidation duration increased from 0 to 2 min energy yield and ece were sharply improved to 48 2 kj l and 43 26 which were over 100 higher than that of 0 min with further increasing duration from 2 to 6 min improvements on energy yield and ece were limited however when electro oxidation duration increased from 6 min to 10 min the energy yield was greatly reduced to 20 1 kj l which was slight lower than that of 0 min indicating that excessive electro oxidation had little promotion effect on habs conversion to bioenergy therefore it can be concluded that 6 min of electro oxidation under current density of 44 44 ma cm2 may be a sensible choice for habs disposal and energy conversion to biohythane and vfas from energy feasibility perspective in summary the strategy of gradient electro processing for energy conversion from habs to biohythane simultaneously address environmental and energy problems however long term continuous running of the technique in real scenarios may elevate al3 concentration to a detrimental level for downstream df and inhibit energy conversion efficiency for biohythane production which should be concerned in future investigation a more environmentally friendly and efficient electrode material for habs harvesting and disruption should be explored in subsequent studies 4 conclusion the proposed strategy of gradient electro processing is a promising approach for habs conversion to biohythane energy simultaneous addressing environmental and energy problems during electro flocculation process 98 59 of habs were harvested under current density of 4 444 ma cm2 at ph 2 for 2 min a mathematic model r2 0 968 considering coupled effects of ph current density and electro flocculation duration was constructed indicating that ph had more significant impacts on habs harvesting than other factors during electro oxidation of habs biomass increasing electro oxidation from 0 to 6 min can enhance biomass disruption and dissolution into df medium but excessive electro oxidation 10 min generated 36 68 mg l of phenol which inhibited biohythane production as results the highest hy of 64 46 ml g vs and my of 171 82 ml g vs were obtained under 6 min electro oxidation which energy yield 50 1 kj l and ece 44 87 were also higher than other cases declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements projected funded by national natural science foundation of china no 51806026 51906023 china postdoctoral science foundation 2021m700019 the national and local joint engineering research center for biomass energy development and utilization harbin institute of technology project no 2021a004 the innovation research group of universities in chongqing no cxqt21035 and the action plan for high quality development of graduate education of chongqing university of technology grant gzltd202204 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118929 appendix supplementary materials image application 1 
15674,globally eruptive harmful algal blooms habs have caused numerous negative effects on aquatic ecosystem and human health conversion of habs into biohythane via dark fermentation df is a promising approach to simultaneously cope with environmental and energy issues but low habs harvesting efficiency and biohythane productivity severely hinder its application here we designed a gradient electro processing strategy for efficient habs harvesting and disruption which had intrinsic advantages of no secondary pollution and high economic feasibility firstly low current density 0 888 4 444 ma cm2 was supplied to habs suspension to harvest biomass via electro flocculation which achieved 98 59 harvesting efficiency a mathematic model considering coupling effects of multi influencing factors on habs harvesting was constructed to guide large scale application then the harvested habs biomass was disrupted via electro oxidation under higher current density 44 44 ma cm2 to improve bioavailability for df as results hydrogen and methane yields of 64 46 ml g vs and 171 82 ml g vs were obtained under 6 min electro oxidation along with the highest energy yield 50 1 kj l and energy conversion efficiency 44 87 mechanisms of habs harvesting and disruption under gradient electro processing were revealed along with the conversion pathways from habs to biohythane together this work provides a promising strategy for efficient disposal of habs with extra benefit of biohythane production graphical abstract image graphical abstract keywords harmful algal blooms dark fermentation biohythane electro oxidation 1 introduction outbreak of harmful algal blooms habs due to water eutrophication has caused numerous negative effects on public health and aquatic ecosystem including massive fish deaths aquatic habitats destruction drinking water contamination and human illness induced by cyanotoxins zhu et al 2020a habs disposal is a globally significant concern with respect to water quality management kim et al 2021 the available approaches for habs removal include physical methods such as filtration chemical methods such as algaecides addition and biological methods such as algae predator introduction huang et al 2021 zhu et al 2020b for example chemical algaecides addition such as diuron and dibromohydantoin is commonly applied in emergency attributing to operational ease and fast start huisman et al 2018 however secondary pollutions of water body for the available chemical or biological methods and high energy consumption for the physical methods are unavoidable problems that should be concerned roussl et al 2020 yang et al 2022 unfortunately an eco friendly and efficient approach to ease habs issue is yet to be reported besides energy conversion from wastes is another challenge to humans chang et al 2018 li et al 2022 there is a pressing need to exploit renewable and environmental friendly energy sources to reduce dependency on fossil fuels hythane fuels containing carbon neutral bio h2 and one carbon involved bio ch4 generated from waste biomass are competitive candidates for energy sustainability and carbon neutrality li et al 2021 jia et al 2020 among all approaches for hythane production biological route i e biohythane via dark fermentation df has many intrinsic advantages by avoiding high energy cost and extreme reaction condition compared to chemical or thermochemical routes during df the feedstocks are consumed and converted into bio h2 and bio ch4 through microbial metabolism under mild conditions park et al 2019 the habs biomass contains abundant carbohydrates and proteins which are superior feedstocks for biohythane production via df peter et al 2022 it would be of great interest in commercial applications if the overrun habs can be fermented into biohythane and thus potentially resolving water pollution and energy conversion issues at the same time however large scale biohythane production with habs biomass still faces many technical limitations in which inefficient habs biomass harvesting and intracellular compositions release are two typical terms lam et al 2017 from one hand microalgae cells stably suspend in water due to strong electrostatic repulsive force originated from cellular surface negative charge with zeta potential of 40 to 7 5 mv and low settling rate owing to tiny cell gravity zheng et al 2019 compared to the energy intensive physical methods such as centrifugation and filtration using chemical methods to harvest habs biomass have attracted increasing interests due to low energy consumption the reported chemical methods mainly focused on electrostatic neutralization and microalgal cells aggregation thereby accelerating the settling rates of microalgal biomass zhao et al 2021 for example ferrate was used as flocculants by alshahri et al 2021 to neutralize negative charge of microalgae cells and achieved ca 85 of habs biomass collection but the massive utilization of fe based flocculants may cause heavy metal pollution and inhibit df performance which weakens technical and economic feasibility of bioenergy conversion from habs from the other hand processes of habs biomass disruption and intracellular compositions release are energy intensive carvalho et al 2020 although microalgae cell wall is not as recalcitrant as terrestrial plants like rice straw pretreatment is also an important step to break down carbohydrates and proteins into monomers for efficient df ding et al 2019 available methods for microalgae pretreatment mainly include mechanical approaches such as high pressure homogenization chemical approaches such as acid alkaline hydrolysis or supercritical co2 and enzymatic hydrolysis approaches phwan et al 2018 these pretreatments can enhance biodegradability of microalgae biomass to a great extent for improving df performance but still many challenges remain including environmental pollutions risk chemical approaches high energy consumption physical approaches and high operation cost enzymatic approaches li et al 2020a therefore an efficient strategy for simultaneous habs harvesting and pretreatment is required which is yet to be reported in this work a gradient electro processing strategy was designed to simultaneously achieve habs harvesting and pretreatment fig 1 a in detail a low current density was provided to the habs suspension first to harvest microalgae biomass by neutralizing cellular negative charge with electro generated al oh 3 then a higher current density was provided to disrupt cell wall of the harvest habs biomass by generating oh radical finally the pretreated habs biomass was converted into biohythane via two stage df fig 1b together the insights of this work include 1 evaluate performance of the designed gradient electro processing strategy 2 reveal mechanisms of habs harvesting cell disruption and biohythane generation 3 optimize overall energy conversion efficiency from habs to biohythane 2 materials and methods 2 1 materials and strains k2cr2o7 99 h2so4 95 98 phenol 99 5 and ag2so4 99 5 were purchased from sigma aldrich co ltd usa coomassie brilliant blue and hgso4 99 5 were purchased from sinopharm chemical reagent co ltd china hydrogen producing bacteria hpb and methane producing bacteria mpb were isolated from the sludge collecting from a rural household biogas digester in chongqing china to better study habs harvesting kinetics via electro flocculation microalgae biomass concentration was precisely controlled by simulating a habs suspension with chlorella pyrenoidosa as target strain the microalgal suspension was pre cultured in a light incubator zgz 800c l binglin shanghai china at constant light intensity of 9000 lux carbon dioxide concentration of 5 and temperature of 25 0 5 c 2 2 gradient electro processing system the equipment used for gradient electro processing contained a bioreactor made of glass working volume 0 5 l dc power and two aluminum plate electrodes the dimensions of aluminum plates were 75 30 3 mm and the current range of dc power was 0 10 a with voltage range of 0 15 v all electro processing tests were performed under batch mode 2 3 habs harvesting through electro flocculation with low current density in the first stage low current densities of 0 888 1 778 2 666 3 556 and 4 444 ma cm2 were provided to the habs suspensions for biomass harvesting to approach environmental relevant conditions room temperature of 25 c was adopted to simulate temperature condition for frequent habs outbreak and 1 g l of microalgae biomass concentration was used to simulate habs concentration at the most serious case in real pandey et al 2019 effects of major influencing factors like ph 2 4 6 8 and 10 current density 0 888 1 778 2 666 3 556 and 4 444 ma cm2 and electro flocculation duration 2 4 6 8 10 min on habs removal were investigated to explore the most efficient manner for habs harvesting firstly single factor influence on habs harvesting was investigated via control variable method after coupling effects of three major influencing factors ph current density and electro flocculation duration on habs harvesting were investigated via response surface methodology rsm to facilitate working conditions optimization during practical application the experimental conditions for rsm were designed with designing software regarding ph current density and electro flocculation duration as variables x1 x2 and x3 respectively table 1 experimental ranges of three influencing factors were selected as ph of 2 10 current density of 0 888 4 444 ma cm2 and electro flocculation duration of 2 10 min during electro flocculation 3 ml of microalgal suspension in middle layer of the test tube was sampled per 10 minutes and sample absorbance at 680 nm was measured with a uv vis spectrophotometer t6 new century persee china to calculate the residual microalgal biomass concentration 2 4 habs disruption through electro oxidation under high current density in the second stage high current density of 44 44 ma cm2 was provided to harvest microalgae biomass from 500 ml of habs suspension to cell wall disruption along with intracellular biodegradable compositions release effects of electro oxidation duration 2 4 6 8 10 min on composition changes of the feedstocks were investigated under constant current density of 44 44 ma cm2 2 5 dark fermentation of pretreated habs biomass for biohythane production pretreated habs biomass and 25 ml activated hpb were injected into 250 ml fermentation flasks with working volume of 200 ml initial ph of all groups was adjusted to 6 0 0 1 with 6 m hcl and naoh the flasks were completely sealed with rubber stopper and purged with nitrogen gas purity 99 999 for 10 min to create an anaerobic environment for hpb metabolism all groups were first incubated in a water bath at 35 0 1 c to produce hydrogen and volatile fatty acids vfas after 2 days 25 ml activated mpb was added to the fermentation flasks and initial ph was adjusted to 8 0 0 1 the flasks were completely sealed with rubber stopper and purged with nitrogen gas for 10 minutes to create an anaerobic environment for mpb metabolism the mpb was incubated for 36 days in water bath at 35 0 1 c for methane generation 2 6 analysis 2 6 1 properties of habs biomass total solids ts volatile solids vs suspended solids ss and volatile suspended solids vss of harvest habs biomass before and after electro oxidation were determined by gravimetric method specifically ts and ss were dried to constant weight in an oven at 105 c vs and vss were measured by burning in a muffle furnace at 600 c 2 6 2 carbohydrates proteins and cod concentration carbohydrates of habs biomass were detected by phenol sulfuric acid method dubois et al 1956 proteins were detected by coomassie brilliant blue method bradford et al 1976 and chemical oxygen demand cod was determined using rapid digestion spectrophotometry chang et al 2020 all samples were filtered through a 0 22 μm microporous membrane before analysis 2 6 3 macromolecular organics content gas chromatograph mass spectrometer gc ms gc ms qp2010 plus shimadzu japan was used to determine types and contents of organics in the fermentation medium under different electro oxidation duration first organics contained in the samples were extracted with 30 ml ch2cl2 chuandong chemical co ltd china ar w 99 5 under acidic neutral and alkaline conditions then the extract was concentrated to 3 ml at 40 c using a rotary evaporator re 52aa shanghai china for gc ms analysis concentrations of macromolecular organics were calculated as product of total cod concentration and percentage of each organic species 2 6 4 hydrogen methane and vfas concentration gas chromatograph equipped with a thermal conductivity detector and a microfilled column sc 3000b chuan yi chongqing china was used to detect hydrogen and methane concentration gas chromatograph equipped with a hydrogen flame ionization detector and a polar capillary column gc126n jingke shanghai china was used to detect vfas concentration 2 7 calculation 2 7 1 kinetic parameters of anaerobic fermentation kinetic parameters of hydrogen and methane production during df were obtained by fitting experimental data with the modified gompertz formula eq 1 1 h h m e x p e x p r m e h m λ t 1 where h is the cumulative gas production ml g hm is the highest gas production potential ml g rm is the peak gas production rate ml g h tm is the peak gas production time h λ is the fermentation delay time h and e is the natural logarithm which is 2 718 2 7 2 inhibition coefficient of anaerobic fermentation the inhibiting effect of electro oxidation on hydrogen and methane production during df was quantitatively analyzed by the inhibition coefficient ic which was calculated with eq 2 2 ic 1 apr 90 with added inhibitor ap r 90 without added inhibitor 100 where apr90 represents the average gas production rate calculated when gas production reaches 90 of the total cumulative production the parameter ic can comprehensively reflect the effect of inhibitors on fermentation delay time fermentation cycle and total gas production 2 7 3 energy conversion characteristics based on previous work by liu et al 2018 high heating values hhv of hydrogen and methane are 286 and 889 kj mol respectively corresponding to 12 8 kj l h2 and 39 7 kj l ch4 besides the hhvs of ethanol acetic acid propionic acid butyric acid valeric acid and capric acid are 1367 874 1527 2184 2837 and 3492 kj mol respectively the hhvs of c pyrenoidosa were calculated according to the mendeleev equation as shown in eq 3 sun et al 2019 in which c h o and s represent elementary contents that were determined with elemental analyzer vario macro cube elementar germany 3 hhv kj g 0 33858 c 1 254 h 0 10868 o s energy conversion efficiency ece of conversion process from habs to biohythane was calculated as result of total output energy divided by total input energy eq 4 in eq 4 total hhvs of hydrogen methane and vfas were deemed as output energy total input energy included electric energy and hhv of habs biomass it should be mentioned that input electric energy contains the energy consumption during both electro flocculation and electro oxidation processes 4 ece total output energys kj total input energy kj 100 3 results and discussion 3 1 habs harvesting efficiency enhancement assisted by electro flocculation 3 1 1 effect of single factor on habs harvesting to reveal effect of single influencing factor on habs harvesting the maximum harvesting efficiencies changed with ph current density and electro flocculation duration were illustrated in fig 2 a and b the electro flocculation strategy achieved efficient biomass harvesting from suspension with the maximum harvesting efficiency of 98 59 under acidic environment of ph 2 it is obvious that low ph high current density and long electro flocculation duration were more favorable conditions for habs harvesting the gaps of harvesting efficiencies between different conditions were in close relations with amount and morphology of cationic al3 in habs suspension when current density was 0 888 ma cm2 fig 2a initial ph had great impact on habs harvesting because it controlled the morphology of aluminum hydroxide in the solution and the maximum habs harvesting efficiency 90 4 98 3 was achieved under acidic environment with ph of 2 4 during electro oxidation cationic al3 was released from electrode and formed monomeric or polymeric al oh 3 al3 as flocculants which can aggregate microalgae cells via synergistic effects of bridging and charge neutralization the acidic environment triggered formation of positively charged monomeric or polymeric al oh 3 al3 wong et al 2017 paulista et al 2018 which enhanced interactions with negative charged microalgae cells and resulted in habs suspension destabilization liu et al 2017 when suspension changed from acidic to alkaline condition formation of monomeric or polymeric al oh 3 al3 was inhibited resulting in decrease of habs harvesting efficiency to 59 1 75 3 under ph of 6 8 and to 44 3 under ph of 10 harvesting kinetic curves supplementary fig s1a illustrated that first order kinetic model fitted well with experimental data but the precision decreased with increasing ph when habs suspension was kept under acidic condition ph 2 fig 2b habs harvesting efficiency increased with improving current density and electro flocculation duration attributing to higher al3 availability in suspension fig 2c illustrated that al3 concentration in suspension was obviously improved with increasing current density and electro flocculation duration which accelerated habs biomass aggregation and settlement as results habs harvesting efficiencies increased from 48 38 under 0 888 ma cm2 2 min to 98 59 under 4 444 ma cm2 10 min fig 2b besides it is seen shorter electro flocculation duration was needed to achieve total removal of habs biomass under higher current density for example it needed 10 min electro flocculation to achieve 97 13 habs removal under 0 888 ma cm2 while only 2 min was required for 97 00 habs removal under 4 444 ma cm2 fig 2b harvesting kinetic curves supplementary fig s1b illustrated that first order kinetic model fitted well with experimental date at all current density 3 1 2 coupled effects of multi factors on habs harvesting high habs removal efficiency and low energy consumption are major objectives that pursued by researchers for practical application but these two targets are usually incompatible investigation on coupled effects of multi factors on habs harvesting to explore optimized conditions concerning both economy and efficiency are feasible approach at present experimental conditions and results of habs harvesting considering coupled effects of ph current density and electro flocculation duration were shown in table 1 and the rsm results were illustrated in fig 2d 2e f and supplementary fig s2 it is shown that ph had more significant influence on habs harvesting than current density and electro flocculation duration the maximum habs harvesting efficiency of 99 11 was achieved when ph 2 current density 4 444 ma cm2 and electro flocculation duration 6 min based on experimental data shown in table 1 a mathematic modelling regarding habs harvesting efficiency as dependent variable y and regarding ph x1 current density x2 electro flocculation duration x3 as independent variables were established as eq 5 the mathematic modeling was constructed with quadratic polynomial model which was convinced to have a better fitting precision with r2 0 968 5 y 79 35 34 33 x 1 0 5488 x 2 1 78 x 3 3 41 x 1 x 2 6 4 x 2 x 3 2 73 x 2 x 3 11 18 x 1 2 4 56 x 2 2 3 27 x 3 2 relevant parameters for the established habs harvesting model i e eq 5 were shown in supplementary table 1 p value for ph was 0 0001 while the value was much higher for current density p 0 9128 and electro flocculation duration p 0 4513 it demonstrated that ph had a more significant impact on habs harvesting suggesting that ph sensitive al3 morphology existed in habs suspension was more important than al3 concentration as shown in fig 2d and e when electro flocculation duration was fixed at 6 min fig 2d or current density was fixed at 2 666 ma cm2 fig 2e habs harvesting efficiency changed drastically with ph but influenced slightly by current density or electro flocculation duration when ph value was kept constant at 2 fig 2f habs harvesting efficiency varied slightly from 80 84 to 99 62 with similar impacts by current density and electro flocculation duration this result can contribute to select smart operating options for minimizing energy consumption during practical application 3 2 habs biomass disruption assisted by electro oxidation compositions of the harvested habs biomass without electro oxidation pretreatment showed that the biomass contained high vs content 71 00 especially for high soluble proteins 156 84 mg g vs and soluble carbohydrates 81 57 mg g vs table 2 which were a superior feedstock for biohythane production during df to disrupt microalgae cell and release intracellular biodegradable compositions into df medium current density of 44 44 ma cm2 was provided to the harvest habs biomass for 2 4 6 8 and 10 min effects of electro oxidation duration on df medium compositions including ts vs vss ss dissolved cod carbohydrates and proteins concentrations were shown in fig 3 a in general electro oxidation had little effects on ts and vs with constant contents of ca 70 90 before and after electro oxidation but vss ss soluble cod carbohydrates proteins and lipids concentrations were greatly enhanced by electro oxidation which obviously improved bioavailability of soluble compositions in df medium when electro oxidation duration increased from 0 to 2 min vss and ss contents sharply increased from 0 to ca 40 whereafter these contents kept constant with increasing electro oxidation duration from 2 to 10 min fig 3 since vss and ss contents in df medium can reflect cell disruption degree it indicated that electro oxidation of 2 min was enough to fully disrupt microalgae cell wall with electro oxidation duration increased from 2 to 6 min soluble cod carbohydrates proteins and lipids concentrations monotonously increased to 609 63 177 37 328 81 and 191 51 mg g vs respectively it indicated that improving electro oxidation duration triggered conversion of disrupted microalgae biomass into soluble compositions like cod carbohydrates and proteins which were potential biodegradable feedstock for biohythane production but when electro oxidation duration further improved from 6 to 10 min concentrations of cod carbohydrates and proteins increased little or even decreased slightly indicating that excessive electro oxidation resulted in decomposition of the soluble compositions therefore it can be concluded that electro oxidation of 6 min was a better choice to balance feedstock bioavailability and energy consumption changes of macromolecular organics compositions and concentrations for habs biomass under various electro oxidation duration were illustrated in fig 3b c and supplementary fig s3 in fig 3b concentrations of macromolecular organics gradually increased with electro oxidation duration increasing from 0 to 10 min showing that longer electro oxidation duration enhanced biomass conversion to soluble organics among these macromolecular organics percentages of phytol and octadecatrienoic acid were improved with increasing electro oxidation duration while hexadecenoic acid and 13 docosenamide percentages were reduced with increasing duration fig 3c the decrease of hexadecenoic acid and 13 docosenamide percentages were because of possible degradation reactions occurred with increasing electro oxidation duration which was convinced by reduced concentrations of these organics fig 3b while the decreases of phytol and octadecatrienoic acid concentrations were not observed with increasing duration leading to improved phytol and octadecatrienoic acid percentages fig 3b and c most of all 13 67 mg l and 36 68 mg l phenol were generated under electro oxidation duration of 8 and 10 min respectively which is a typical inhibitor for df indicating that excessive electro oxidation of habs biomass can cause negative effects on biohythane production 3 3 hydrogen and methane production hydrogen yield hy methane production my hydrogen production rate hpr methane production rate mpr as well as kinetics fitted with the gompertz model when using habs biomass treated with various electro oxidation duration were illustrated in fig 4 it is shown that electro oxidation had obvious positive effects on hydrogen and methane production which enhanced hy and my compared to the control group with 0 min electro oxidation the highest hy of 64 46 ml g vs and my of 171 82 ml g vs were obtained under electro oxidation for 6 min when the harvest habs biomass was electro oxidized for 0 min the hy and my were 33 08 and 51 14 ml g vs fig 4a and b with the maximum hpr and mpr of 2 67 ml g vs h and 3 23 ml g vs d respectively fig 4c and d this may suggest that algal blooms have the potential to be used as feedstock for biohythane production but productivities were very low this was because that the solid cell membrane of untreated habs hindered intracellular organics like carbohydrates and proteins release resulting in low bioavailability of df substrates when electro oxidation duration increased from 0 to 6 min the hy and my were improved to 64 46 and 171 83 ml g vs with hpr and mpr improving to 6 79 ml g vs h and 7 29 ml g vs d respecively the improvement of hy and my were mainly ascribed to the following two reasons firstly the soluble cod carbohydrates and proteins concentrations were improved fig 3 which provided more biodegradable feedstocks for hpb and mpb secondly the oxidation reduction potential opr was reduced to a more negative value fig 4e which created a suitable environment for hpb and mpb metabolism li et al 2020b fig 4e shows that orp level of df medium under 0 min was ca 450 mv while the orp value decreased to a level of 300 to 100 mv under electro oxidation of 6 min as seen in table 3 the inhibition coefficient ic was reduced from 62 26 to 115 33 for hydrogen and reduced from 47 64 to 273 41 for methane production when electro oxidation duration increased from 2 to 6 min demonstrating a stronger promotion effects on df with 6 min electro oxidation when electro oxidation duration further increased from 6 to 10 min bioavailability of soluble composition was similar with that under 6 min and the orp level was kept at favorable range of 378 50 to 121 50 mv fig 4e however the hy and my were obviously reduced to 42 83 and 73 92 ml g vs respectively fig 4a and b the inhibition effects were mainly ascribed to a reason that the prolonged electro oxidation duration generated massive phenol in df medium 38 68 mg l phenol for 10 min fig 3c which had much stronger inhibition effect on df than furans sun et al 2019 although the longer electro oxidation duration 8 and 10 min released more al3 into medium 6 05 mg l for 10 min fig 4f such a value was not high enough to inhibit hpb and mpb activity wu et al 2019 ic under 10 min electro oxidation was improved to 60 64 table 3 demonstrating that the promotion effects originated from electro oxidation pretreatment was greatly reduced after kinetic characteristics of fermentation processes were fitted with gompertz model fig 4g h and tables 4 5 it is shown that the gompertz model fitted well with experimental data for all cases r2 0 97 the gas production potential hm first increased and then decreased with improving electro oxidation duration and the highest hm for hydrogen 68 06 ml g vs and methane 170 44 ml g vs were obtained under 6 min electro oxidation however the fermentation delay time λ was continuously shortened with increasing electro oxidation duration which is a pleasant result for overall productivity improvement 3 4 volatile fatty acid production in addition to biohythane vfas are also valuable platform molecules to produce biochemicals like degradable plastic commodity sun et al 2020 the vfas concentrations in fermentation medium during hydrogen and methane production processes were shown in fig 5 it is seen that the fermentation medium mainly contained acetic acid 68 82 4540 76 mg l propionic acid 1 06 1755 58 mg l butyric acid 0 55 1367 38 mg l and ethanol 27 99 235 69 mg l as major vfas products among butyric acid and ethanol were major compositions existed in the first 30 h i e hydrogen production process while acetic acid and propionic acid were major vfas compositions during day 3 to day 36 i e methanogenesis process during hydrogen producing process i e the first 30 h carbohydrates and proteins were regarded as major feedstocks for hydrogen production since lipids were hard to be used by hpb drapcho et al 2008 feng et al 2022a as illustrated in fig 5 large quantities of butyric acid and ethanol were generated while little acetic acid and propionic acid were detected in the first 30 h therefore the probably dominating reactions happened in this process using carbohydrates and proteins as feedstocks can be concluded as following eqs 6 9 carbohydrates as feedstock 6 c 6 h 12 o 6 c h 3 c h 2 2 cooh 2 c o 2 2 h 2 7 c 6 h 12 o 6 2 c h 3 c h 2 oh 2 c o 2 proteins as feedstock 8 2 c 3 h 7 o 2 n 2 h 2 o c h 3 c h 2 2 cooh n h 3 c o 2 h 2 o 9 2 c 3 h 7 o 3 n c h 3 c h 2 2 cooh 2 n h 3 2 c o 2 at this time the ethanol concentration in df medium monotonously decreased with increasing electro oxidation duration from 0 to 10 min while butyric acid concentration first increased and then decreased with the maximum value 1367 38 mg l obtained under 6 min fig 5a and d demonstrating that slight electro oxidation pretreatment 6 min promoted butyric production reaction eqs 6 8 and 9 but inhibited ethanol production eq 7 during methanogenesis process i e from 30 h to day 36 changes of vfas compositions mainly experienced two stages i e in the first stage the butyric acid and ethanol were consumed to generate methane accompanied by acetic acid and propionic acid concentrations improvement from 30 h to day 18 and in the second stage the acetic acid and propionic acid were consumed to generate methane from day 18 to day 36 in the first stage from 30 h to day 18 the butyric acid and ethanol concentrations sharply decreased to almost 0 mg l from 30 h to day 3 fig 5a and d at this time the acetic acid and propionic acid concentrations continuously increased from day 3 to day 18 which probably triggered butyric acid and ethanol degradation reactions eqs 10 13 to produce methane along with acetic acid and propionic acid as by products during this stage electro oxidation pretreatment greatly enhanced acetic and propionic acid yields and production rates but excessive electro oxidation like 8 and 10 min caused negative effects on propionic acid production with obvious concentration decrease fig 5b and c it should be mentioned that since hydrogen generated in hydrogen production process was stored in the collection bottle thus the hydrogen gas in eq 13 was very likely sourced from butyric acid degradation to produce propionic acid and acetic acid eqs 11 and 12 10 2 c h 3 c h 2 oh c o 2 c h 4 2 c h 3 cooh 11 c h 3 c h 2 2 cooh 2 h 2 o c h 3 c h 2 cooh 3 h 2 c o 2 12 c h 3 c h 2 2 cooh 4 h 2 o c h 3 cooh 6 h 2 2 c o 2 13 4 h 2 c o 2 c h 4 2 h 2 o at the second stage from day 18 to day 36 the acetic acid and propionic acid were consumed by bacteria to produce methane via the following eqs 14 16 compared to propionic acid the acetic acid was consumed in priority attributing to lower gibbs free energy g0 31 0 kj mol for eq 14 than the pathway of propionic acid fermentation for methane production g0 9 68 kj mol for eq 15 and g0 76 44 kj mol for eq 16 feng et al 2022b therefore acetic acid concentration was quickly reduced from day 18 to very low value 1000 mg l at day 24 under all electro oxidation durations fig 5b while the decrease of propionic acid concentration was very limited until day 30 rapid decrease of propionic acid concentration from day 30 to day 36 can be ascribed to depletion of acetic acid fig 5c 14 c h 3 cooh c h 4 c o 2 15 c h 3 c h 2 cooh h 2 c h 3 cooh c h 4 16 c h 3 c h 2 c o o h 2 h 2 o c h 4 3 h 2 2 c o 2 3 5 energy conversion efficiency energy yields and energy conversion efficiencies ece from habs biomass to hydrogen methane and vfas under various electro oxidation duration were illustrated in fig 6 the highest total energy yield of 50 1 kj l with ece of 44 87 was obtained under 6 min electro oxidation under this case vfas were major energy carriers 42 26 kj l in total with propionic acid 29 8 kj l as dominating compositions following by acetic acid 6 42 kj l butyric acid 4 68 kj l and ethanol 1 36 kj l output energy of biohythane was much lower than vfas with 6 89 kj l for methane and 0 86 kj l for hydrogen when habs biomass was directly used for df i e 0 min 23 9 kj l of total energy yield was obtained with only 2 07 kj l methane and 0 42 kj l hydrogen fig 6a demonstrating possibility of bioenergy production with habs biomass but the ece was very low 21 51 fig 5b when electro oxidation duration increased from 0 to 2 min energy yield and ece were sharply improved to 48 2 kj l and 43 26 which were over 100 higher than that of 0 min with further increasing duration from 2 to 6 min improvements on energy yield and ece were limited however when electro oxidation duration increased from 6 min to 10 min the energy yield was greatly reduced to 20 1 kj l which was slight lower than that of 0 min indicating that excessive electro oxidation had little promotion effect on habs conversion to bioenergy therefore it can be concluded that 6 min of electro oxidation under current density of 44 44 ma cm2 may be a sensible choice for habs disposal and energy conversion to biohythane and vfas from energy feasibility perspective in summary the strategy of gradient electro processing for energy conversion from habs to biohythane simultaneously address environmental and energy problems however long term continuous running of the technique in real scenarios may elevate al3 concentration to a detrimental level for downstream df and inhibit energy conversion efficiency for biohythane production which should be concerned in future investigation a more environmentally friendly and efficient electrode material for habs harvesting and disruption should be explored in subsequent studies 4 conclusion the proposed strategy of gradient electro processing is a promising approach for habs conversion to biohythane energy simultaneous addressing environmental and energy problems during electro flocculation process 98 59 of habs were harvested under current density of 4 444 ma cm2 at ph 2 for 2 min a mathematic model r2 0 968 considering coupled effects of ph current density and electro flocculation duration was constructed indicating that ph had more significant impacts on habs harvesting than other factors during electro oxidation of habs biomass increasing electro oxidation from 0 to 6 min can enhance biomass disruption and dissolution into df medium but excessive electro oxidation 10 min generated 36 68 mg l of phenol which inhibited biohythane production as results the highest hy of 64 46 ml g vs and my of 171 82 ml g vs were obtained under 6 min electro oxidation which energy yield 50 1 kj l and ece 44 87 were also higher than other cases declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements projected funded by national natural science foundation of china no 51806026 51906023 china postdoctoral science foundation 2021m700019 the national and local joint engineering research center for biomass energy development and utilization harbin institute of technology project no 2021a004 the innovation research group of universities in chongqing no cxqt21035 and the action plan for high quality development of graduate education of chongqing university of technology grant gzltd202204 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j watres 2022 118929 appendix supplementary materials image application 1 
