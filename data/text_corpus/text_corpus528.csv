index,text
2640,prediction using neural networks is applied in various fields including hydrology and water resource management in the learning process an optimizer is used to determine the relationship weights and biases between the input and output data to lower the value of the loss function existing optimizers rely absolutely on the relationship that are initially generated and have the probability to converge to a local optimum additionally since there is no structure for storing information about the previously generated correlation there is a probability that the optimal weights and biases could not be found even when learning proceeds it is necessary to apply a meta heuristic optimization algorithm that can consider both global local search and has a structure that can store the previously generated solution in this study a new optimizer was combined with a harmony search hs to improve existing optimizers to test the performance of the improved multi layer perceptron using the new optimizer imlp the runoff of the dorim stream in seoul was predicted the rainfall and the discharge of pump stations were constructed as input data and data preprocessing was performed by normalization and correlation coefficients the imlp showed improved accuracy and could be used to manage urban streams keywords urban stream improved multi layer perceptron combined optimizer meta heuristic optimization algorithm harmony search runoff prediction data availability the data that has been used is confidential 1 introduction recently the frequency and intensity of heavy rainfall events have increased due to rapid climate change leading to a rapid increase in flood damage in the past conceptual or physical models were used to predict water levels or runoff but a large amount of data was needed because different variables such as climate geology and topography were to be considered to overcome these limitations artificial neural network ann models were used the ann model can make highly accuracy predictions by learning the correlation between the input and output data regardless of the variables used in the conceptual and physical models the perceptron had a major impact on early research in the field of ann rosenblatt 1958 the original perceptron is a single layer perceptron that uses multiple inputs and outputs a single result the single layer perceptron has the disadvantage that only linear problems can be solved to overcome this a multilayer perceptron has been proposed that can also solve nonlinear problems a multilayer perceptron consists of an input layer a hidden layer and an output layer several studies have been conducted using neural networks in hydrology and water resources management since 2010 studies have been conducted to estimate floods using time series data the modular soft computing models combining support vector regression svr and ann was suggested for prediction of rainfall time series using preprocessing techniques such as moving average and singular spectrum analysis wu and chau 2013 interval prediction of streamflow discharges using ann with lower upper bound estimation and particle swarm optimization was proposed taormina and chau 2015 various machine learning models such as ann adaptive neuro fuzzy inference system wavelet neural network support vector machine decision tree ensemble prediction systems were investigated for flood prediction although ann was not applied there was a study that applied a meta heuristic optimization algorithm flood plain inundation in mountainous region with no upstream gauged stations was predicted using the reverse flood routing method combined with hec ras model and genetic algorithm ga kaya et al 2019 a hybrid model of long short term memory lstm and an ant lion optimizer was proposed for monthly runoff forecasting yuan et al 2018 ann svr and deep learning algorithms were proposed for modeling and simulating the operation of a reservoir zhang et al 2018 lstm was suggested for rainfall runoff modeling in 241 catchments and results from the sacramento soil moisture accounting model were compared kratzert et al 2018 a hybrid model of variational mode decomposition and deep neural networks was proposed to predict daily runoff in the jing river in china he et al 2019 integrated lstm and a reduced order model framework were applied to predict rapid spatiotemporal flooding hu et al 2019 lstm was applied to global hydrologic models for flood simulations using data from 1032 gauging stations from 1971 to 2010 yang et al 2019 the streamflow of the brazos river basin in texas was predicted for an effective reservoir operation using lstm damavandi et al 2019 the flow duration curves from 9 203 unmeasured locations in the southeastern united states were predicted from 1950 to 2009 worland et al 2019 monthly precipitation was forecasted using long term sequential modeling using a recurrent neural network rnn and lstm kumar et al 2019 hydrologic time series prediction was simulated using an lstm and compared with an autoregressive model qin et al 2018 various studies have been conducted since 2020 flash flood vulnerability has been predicted using a deep learning neural network dlnn and the dlnn has been compared with several machine learning models such as multi layer perceptron mlp and support vector machine svm bui et al 2020 urban flooding prediction has improved by correcting the mean areal precipitation using lstm nguyen and bae 2020 lstm with an encoder decoder framework has been proposed for flood forecasting using the multi step ahead method kao et al 2020 a rainfall runoff model using lstm with sequence to sequence learning was applied to the clear creek and the upper wapsipinicon river in iowa xiang et al 2020 streamflow prediction was performed using a decomposition ensemble model and lstm zuo et al 2020 several neural network models such as mlp and rnn were used to predict the real time water level of cascade channels and compared with svm ren et al 2020 the daily streamflow of the upper yangtze river was predicted using lstm in conjunction with a gaussian process zhu et al 2020 streamflow in kelantan river was predicted using lstm and compared with the classic backpropagation neural network model fu et al 2020 generalized structure group method of data handling and neuro fuzzy inference system fuzzy c means were combined for prediction of daily water level ebtehaj et al 2021 existing studies can be classified as new applications using developed neural networks nn in new applications or combinations of nn with various other methods this study focused on improving accuracy by improving the optimizer which is an important element of the nn existing optimizers including stochastic gradient descent sgd adaptive delta adadelta adaptive gradient adagrad adaptive moment adam a variant of adam based on the infinity norm adamax that follows the regularized leader ftrl nesterov accelerated adaptive moment nadam and root mean squared propagation rmsprop have the potential to converge to a local minimum relying entirely on the relationships weights and biases generated initially sedki et al 2009 furthermore since there is no structure for storing information about previously generated relationships there is a possibility that an optimal relationship will not be found even as learning progresses lee and lee 2022 a new optimizer combined with a meta heuristic optimization algorithm is proposed to add a structure to avoid local minima and store information about previously generated relationships improved multi layer perceptron imlp with a new optimizer can include both a method of calculating weights and biases based on numerical differentiation and a method of probabilistically searching for weights and biases in addition imlp can be applied to various hydrology fields as well as runoff prediction of urban streams the ga the first meta heuristic optimization algorithm to motivate human evolution was developed goldberg and holland 1988 since then various metaheuristic optimization algorithms have been developed the harmony search hs used in this study is an algorithm inspired by the harmony of instrument players geem et al 2001 in this study imlp with new combined optimizers combing the existing optimizer and hs was developed to improve the shortcomings of the existing optimizers in addition to verify the performance of imlp the runoff of the urban stream was predicted by applying the discharge of pump stations and rainfall data to compare the results the runoff of the dorim stream in seoul korea was predicted using the discharge of pump stations and rainfall data data from 2010 2011 2012 2013 2014 2016 2018 2019 and 2020 when rainfall events occurred and pump stations operated in the study area were used for training imlp with new combined optimizers could be used to preemptively manage urban streams by accurately predicting the runoff of urban streams preemptive management of urban streams could be used to save lives and valuable assets around urban streams and to manage urban areas 2 methodologies 2 1 preprocessing of training data deep learning may be impaired due to divergence when training data contains a wide range of values machine learning models including mlp learn by extracting features from training data if the range of the training data that the model accepts is uneven there is a risk that the model will learn the data in a strange way therefore regardless of the quality of the data preprocessing of the training data is necessary for proper learning normalization ensures that all data are applied within the same range normalization was applied to correct the training and increase the learning accuracy according to the normalization the training data were converted to values between 0 and 1 eq 1 shows the normalization 1 b a a min a max a min where b is the normalized data and a is the original data amax is the maximum original data and amin is the minimum original data to improve the learning accuracy it is necessary to adjust the time lag between the input data and the target data among the learning data the method to consider the time lag between the input data and the target data was correlation analysis correlation analysis is a method of analyzing the nature of the linear relationship between two variables which is measured by a correlation coefficient the correlation coefficient is calculated using eq 2 2 r a b i 1 n a i a b i b i 1 n a i a 2 i 1 n b i b 2 where ra b is the correlation coefficient a i is the input data and b i is the target data a is the average of ai and b is the average of bi fig 1 shows the schematic of the time lag correlation in fig 1 the calculation of the time lag is repeated until the highest correlation coefficient is reached in this study normalization and time lag correlation are performed to preprocess the training data to improve learning accuracy a feasible alternative to correlation analysis is the observed time of arrival the observed time of arrival has the advantage of being easily applied without the time required for data preprocessing 2 2 multi layer perceptron a single layer perceptron slp is a simple ann which consists of an input layer and an output layer although slp showed good results on linear problems it had the disadvantage that it could not solve nonlinear problems such as the exclusive or xor problem to overcome this drawback an mlp with one or more hidden layers was proposed fig 2 shows the structure of the mlp and the imlp in this study the training data consisted of 12 input values and one output value the mlp and imlp used in this study consisted of 12 nodes in the input layer 10 nodes in five hidden layers and one node in the output layer the activation function used in the mlp and imlp was a rectified linear unit relu and the total number of epochs was 100 000 the loss function of mlp and imlp is the mean square error mse a new structure in which the number of hidden layers and the number of nodes in each hidden layers is changed could be a feasible alternative if the number of hidden layers and the number nodes in the hidden layers are reduced faster learning is possible however if the number of hidden layers and the number of nodes in each hidden layer are reduced too much the learning accuracy could decrease it is also possible to increase or decrease the total number of epochs of mlp and imlp by increasing the total number of epochs the learning accuracy could be improved through additional learning however if the total number of epochs is greatly increased overfitting could occur 2 3 meta heuristic optimization algorithm heuristics is a method that attempts to solve a problem using available information to solve this problem several variables should be considered however in the real world a perfect solution is not possible due to lack of information and shortage of time therefore a feasible solution based on limited information is required heuristics is a method to determine the most realistic solution level for this case in general it is difficult to develop heuristics based on the characteristics of each problem to be solved therefore it is possible to use a high level heuristic i e a meta heuristic that is applicable to different problems without being limited to a specific problem although various meta heuristic optimization algorithms have been developed their concepts and theories are simple and their ability to search for solutions is outstanding therefore they can be used in various fields including engineering and science it is also possible to apply a meta heuristic optimization algorithm such as ga instead of hs ga has the advantage of being applicable regardless of the continuity and differentiability of the objective function however since a lot of weights and biases are generated in one iteration it could take a long time to learn 2 4 multi layer perceptron using existing optimizers python was used to create the code and libraries such as tensorflow and keras were used the optimizers available for application to mlp in this study were keras sgd rmsprop adagrad adadelta adam nadam adamax and ftrl sgd is an optimizer for calculating the predicted gradients of each step with a single value selected probabilistically from all the data rmsprop is an optimizer that improves on the shortcomings of adagrad instead of simply adding all the gradients rmsprop takes into account the most recent gradient information and compensates for the disadvantage that the learning rate drops too much towards the second half adagrad is calculated by squaring and adding past gradients and is an optimizer for applying a learning rate reduction to each parameter adadelta is an optimizer that uses an exponential moving average to overcome the disadvantages of adagrad which hardly learns at all in the latter part adam is an optimizer that combines the strengths of momentum and rmsprop maintains the past change of gradients and taking into account the latest information more than the past nadam is an optimizer that combines the strengths of the nesterov adaptive moment and rmsprop and calculates the gradient by moving in the direction of momentum rather than calculating the gradient from the current position adamax is an optimizer for the transformation of adam based on the infinite norm 2 5 improved multi layer perceptron using combined optimizer the disadvantages of existing optimizers such as sgd rmsprop adagrad adadelta adam nadam adamax and ftrl can converge the local minimum and the lack of a structure to store information to overcome the shortcomings of the existing optimizers a meta heuristic optimization algorithm with a global search and a structure to store information is combined with the existing optimizers among the various meta heuristic optimization algorithms hs was used which has a simple structure and efficient search performance additionally there was a study in which meta heuristic optimization algorithms such as ga and hs were applied as optimizers instead of the existing optimizers to predict the runoff of urban stream lee and lee 2022 however there was a disadvantage in that the results were not stable because the learning proceeded by excluding the mathematical calculation of the existing optimizer and relying only on the probabilistic search of meta heuristic optimization algorithms when only the probabilistic search of the meta heuristic optimization algorithm was performed bad learning results were often produced so a new method was required to overcome this the combined optimizers proposed in this study combined mathematical calculations and probabilistic search this method overcomes the unstable results generated when only the meta heuristic optimization algorithm is used hs is a meta heuristic optimization algorithm proposed by geem et al 2001 it was developed by motivating the process of finding the optimal harmony by instrumentalists practice each harmony is stored in the harmony memory hm and a new harmony is created using an existing hm solution set through the harmony memory considering rate hmcr or an arbitrary harmony is created in the case of hmcr the existing harmony is adjusted as much as the bandwidth bw using the pitch adjustment rate par in this study hm hmcr par and bw to 30 0 9 0 5 and 0 1 respectively the imlp application process can be divided into five steps first the training data were collected second the training data were preprocessed third the structure of the imlp was constructed fourth combined optimizers were applied fifth the weights and biases were updated using a combined optimizer the combined optimizers generate the initial solutions hm calculate the fitness of the initial hm sort in ascending order by fitness apply the existing optimizer apply an hmcr random search rs and apply par when applying the combined optimizer the existing optimizer is not applied to all hms since a new solution is generated by the search process of hs the combined optimizer also generates a new solution in the combined optimizer depending on the probability of the hmcr it is decided whether to select from the existing hms weights and biases or the rs between the upper and lower boundaries in each weight and bias fig 3 shows the application flow of imlp using the combined optimizers the imlp process can be divided into data acquisition data preprocessing and imlp applications including mlp and meta heuristic optimization algorithms in fig 3 data acquisition and data preprocessing are simply expressed and most of the contents are expressed in detail with imlp including the hs process it is possible to apply the parallel combined optimizers instead of the vertical combined optimizers presented in imlp the parallel combined optimizers have the advantage of being able to learn faster than the vertical combined optimizers however there is a disadvantage that the learning accuracy could be low 3 application and results 3 1 study area seoul is the capital of korea and is crossed by one of the four major rivers han river nakdong river geum river and youngsan river the han river the han river has several tributaries of which the anyang stream has an area of 286 km2 and a length of 32 5 km the anyang stream which flows through seoul and gyeonggi do has tributaries such as the mokgam and dorim streams the dorim stream has an area of 41 93 km2 and a length of 11 km the dorim stream originates at gwanak mountain where seoul national university is located and flows to its confluence with the anyang stream the dorim stream has two tributaries the daebang and bongchun streams there are 11 pump stations that include the mullae dorim2 daelim3 daelim2 guro1 guro2 guro3 guro4 sinlim1 sinlim2 and sinlim5 on the dorim stream the watershed drained by the pump stations is 8 84 km2 which is approximately 21 of the total catchment area of the dorim stream fig 4 shows the location of the study area a precipitation observatory was included in the study area and 12 input datasets including the rainfall and discharge of 11 pump stations were generated one monitoring point located at the confluence of the dorim and anyang streams provided the data generated as output datasets learning datasets were constructed by combining the input and output data instead of dorim stream applied in this study an urban stream with many pump stations can be selected if an urban stream with many pump stations is selected the number of input data increases so it could be able to show high learning accuracy however in the case of a newly constructed pump station it could not be available as input data because the recorded data is not sufficient 3 2 preparation of data for runoff prediction data from 2010 to 2020 was collected when rainfall events occurred and pump stations operated in the study area data from 2015 and 2017 when pump stations were not in operation were excluded the time interval of all data including rainfall runoff and discharge of the pump stations was 10 min the observed rainfall and runoff in the study area are shown in fig 5 data from 2010 to 2019 were used as training data and data from 2020 was sued as validation data the high runoff in the 2010 and 2011 data was caused by heavy rainfall in 2010 and 2011 since the maximum values of the data for each year were different the accuracy could be low when learning with the raw data therefore normalization was used to prevent overfitting the reason that the historical data for 2021 is not included is that pump stations were not in operation because there was no major rainfall in the study area in the future the inclusion of additional historical data could improve the accuracy of runoff prediction 3 3 runoff prediction using imlp the structure of the mlp using existing optimizers and imlp using combined optimizers five hidden layers with 10 nodes was set identically and learning was performed root mean square error rmse was used to calculate the accuracy of the predicted values the rmse is calculated by eq 3 3 rmse i 1 n o i s i 2 n where oi is the observed value si the predicted value and n the number of values the error was calculated not only from the rmse with the square value of the difference between the observed and predicted values but also from the mean square error mae with the absolute value of the difference between the observed and predicted values mae has the advantage of intuitively knowing the difference but also has the disadvantage of being less sensitive to errors the mae is calculated by eq 4 4 mae i 1 n o i s i n as an additional error calculation method the mean absolute percentage error mape was applied under normal circumstances rmse reflects the extent to which the predicted value of the regression model deviate from the actual values however when there are outliers with a very large degree of deviation the rmse value becomes very high due to this small number of outliers mape can be applied as an index to solve the above problems compared with rmse mape normalizes the errors of each point to lower the influence of the absolute error caused by each singular point the mape is calculated by eq 5 5 mape 1 n i 1 n o i s i o i since mape has a value between 0 and 1 it has the advantage of easy interpretation of results and comparison of model performance however there is also a disadvantage that the mape value could become large when the actual value is a very small value close to 0 as an additional error calculation method the sum of absolute difference sad was applied the sad is calculated by eq 6 6 sad i 1 n o i s i to verify the performance of data preprocessing the results of the two methods normalization and correlation analysis applied in this study were analyzed normalization converted all data from 0 to 1 based on the maximum value correlation analysis was applied to the rainfall data and the discharge of each pump station and the results of correlation analysis are shown in the table 1 for rainfall data the correlation coefficient was maximum when the lag time was 60 min for each pump station the correlation coefficient was maximized at different lag times the largest value of the correlation coefficient was rainfall data and the smallest is the discharge of sinlim5 pump station results according to the data preprocessing were compared by applying imlp table 2 shows the results according to the data preprocessing application when normalization and correlation analysis were applied the prediction accuracy was improved compared to when the raw data was applied in particular normalization in adamax combined with hs showed a great improvement in prediction accuracy in the results of imlp using all combined optimizers the effect of data preprocessing was significant table 3 shows the runoff prediction results of the mlp using the existing optimizers and the imlp using the combined optimizers among the existing optimizers adagrad showed the lowest rmse and mae values table 3 in particular the errors of the existing optimizers except for ftrl were distributed in the rmse from 25 m3 s to 30 m3 s and the mae from 11 m3 s to 13 m3 s among the combined optimizers adamax combined with hs showed the best results the lowest rmse and mae in the imlp results using combined optimizers sgd combined with hs showed the highest rmse and mae however the rmse of all combined optimizers including sgd combined with hs did not exceed 9 m3 s and the mae did not exceed 4 m3 s in the mape results all existing optimizers showed results exceeding 1 and all combined optimizers did not exceed 1 among the combined optimizers the mape of adamax combined with hs was 0 09 showing the smallest value in the sad results all existing optimizers exceeded 3000 m3 s but all combined optimizers showed results below 1200 m3 s among the combined optimizers the sad of adamax combined with hs was 529 m3 s showing the smallest value fig 6 shows a comparison of runoff prediction using sgd with rmsprop sgd combined with hs and rmsprop combined with hs the combined optimizers such as sgd combined with hs and rmsprop combined with hs showed relatively accurate results compared to the existing optimizers such as sgd and rmsprop in terms of not only the overall error but also the difference in the peak runoff in the peak runoff sgd combined with hs showed a difference about 34 m3 s and rmsprop combined with hs about 45 m3 s when the existing optimizers were changed to the combined optimizers sgd improved by approximately 125 m3 s and rmsprop improved by approximately 116 m3 s based on peak runoff there was a large difference in the peak runoff of the runoff prediction results using mlp using sgd and rmsprop in the case of imlp to which sgd combined with hs was applied a relatively large difference occurred at 1860 min but the difference decreased and almost coincided with the observed runoff at 1900 min in the case of imlp to which rmsprop combined with hs was applied it was predicted that the runoff did not fluctuate significantly from 1860 min to 1900 min at peak runoff imlp to which sgd combined with hs was applied and rmsprop combined with hs showed relatively more accurate runoff than mlp to which sgd and rmsprop were applied fig 7 shows a comparison of runoff prediction using adagrad adadelta adagrad combined with hs and adadelta combined with hs the combined optimizers such as adagrad combined with hs and adadelta combined with hs showed relatively accurate results compared to the existing optimizers such as adagrad and adadelta not only in terms of the overall error but also in terms of the difference in the peak runoff for the peak runoff adagrad combined with hs showed a difference of about 33 m3 s and adadelta combined with hs showed about 14 m3 s when the existing optimizers were replaced with the combined optimizers adagrad improved by approximately 109 m3 s and rmsprop improved by approximately 117 m3 s based on peak runoff most of the peak runoff prediction results using the mlp with adagrad and adadelta at the peak runoff were maintained at approximately 50 m3 s and there was a significant difference from the observed runoff in the case of imlp to which adagrad was applied combined with hs the difference was relatively small at 1880 min in the case of imlp to which adadelta combined with hs was applied there was no significant difference in the observed runoff from 1860 min to 1900 min except for the results of 1890 min for peak runoff the imlp to which adagrad combined with hs and adadelta combined with hs were applied showed relatively more accurate runoff than mlp to which adagrad and adadelta were applied fig 8 shows a comparison of the runoff prediction using adam nadam adam combined with hs and nadam combined with hs the combined optimizers such as adam combined with hs and nadam combined with hs showed relatively accurate results compared to the existing optimizers such as adam and nadam not only in terms of the overall error but also in terms of the difference in the peak runoff for peak runoff adam combined with hs showed a difference of about 65 m3 s and nadam combined with hs showed a difference of about 49 m3 s when the existing optimizers were replaced with the combined optimizers adam improved by approximately 134 m3 s and nadam improved by approximately 107 m3 s based on peak runoff peak runoff prediction results using mlp with adam and nadam for 1870 and 1900 min were maintained at approximately 100 m3 s and there was a significant difference from the observed runoff the runoff predicted with mlp using existing optimizers such as adam and nadam in 1860 1880 and 1890 min was largely different from the observed runoff the predicted runoff with imlp using adam combined with hs showed a constant difference from 1860 min to 1900 min the predicted runoff using imlp to which nadam combined with hs was applied was similar to the observed runoff at 1860 min and 1900 min at peak runoff the imlp to which the combined optimizers were applied showed a smaller difference than the mlp to which the existing optimizers were applied among the combined optimizers nadam combined with hs showed a smaller difference in the peak runoff than adam combined with hs fig 9 shows a comparison of runoff prediction with adamax ftrl adamax combined with hs and ftrl combined with hs the combined optimizers such as adamax combined with hs and ftrl combined with hs showed relatively accurate results compared to the existing optimizers such as adamax and ftrl in terms of not only the overall error but also the difference in the peak runoff in particular the existing ftrl showed poor prediction results however ftrl combined with hs significantly improved the prediction results in the peak runoff adamax combined with hs showed a difference about 36 m3 s and ftrl combined with hs about 26 m3 s when the existing optimizers were replaced with the combined optimizers adamax improved by approximately 138 m3 s and ftrl improved by approximately 169 m3 s based on peak runoff in general the overall errors rmse and mae and peak to peak accuracy improved when the combined optimizers were used the optimizer that showed the greatest improvement was ftrl as the results of applying the existing ftrl were the least accurate the optimizer with the second largest improvement was adamax significant improvement was observed in the case of adamax although the results were not too inaccurate when the existing adamax was applied the reason that adamax showed a large improvement appears to have been influenced by the improvement in accuracy at peak runoff adamax could diverge depending on the initial value and thus the accuracy could be reduced however in adamax combined with hs since there are various initial values stored in the hm this problem can be overcome and the performance is greatly improved fig 10 shows a comparison of runoff prediction using adagrad which showed the best results among the existing optimizers and adamax combined with hs which showed the best results among the combined optimizers as shown in fig 10 the peak value occurred at 1880 min the difference from the observed runoff was 174 52 m3 s for adamax 142 56 m3 s for adagrad 36 26 m3 s for adamax combined with hs and 33 56 m3 s for adagrad combined with hs when the existing optimizers were replaced with the combined optimizers the difference from the peak runoff improved by approximately 109 m3 s for adagrad and by approximately 138 m3 s for adamax table 4 shows the runoff prediction results at 1880 min the combined optimizers including adamax combined with hs showed good results not only for the overall rmse and mae but also for the peak to peak error for the rmse and mae results adamax combined with hs showed a smaller difference than adagrad combined with hs however when adagrad combined with hs was applied the difference in the peak runoff was smaller than that of adamax combined with hs when a loss function is applied that includes the difference from the peak runoff the rmse and mae increase however the difference from the peak runoff can be reduced 4 discussion to compare the runoff predicted by the imlp with the observed runoff the r2 value was calculated and a comparison was made according to the flow rate the r2 value was calculated using eq 7 7 r 2 i 1 n s i o 2 i 1 n o i o 2 where oi is the observed value and si is the simulated value n is the number of data points and o is the average of oi a comparison of r2 for mlp and imlp is shown in fig 11 for the results of mlp using adagrad and adamax fig 11 the predicted values were very small compared to the observed runoff for the results of the imlp using adagrad combined with hs and adamax combined with hs the observed runoff generally higher than the predicted runoff but the difference was not significant compared to that of the mlp using adagrad and adamax combined optimizers such as adagrad combined with hs and adamax combined with hs in imlp showed relatively accurate results even at high flow rates moreover the results were checked based on the parameter changes of the hs in the combined optimizer sgd combined with hs was applied to the combined optimizer of imlp and the values of hm hmcr par and bw were changed the range of hm was set from 10 to 50 the range of hmcr was set from 0 1 to 0 9 the range of par was set from 0 1 to 0 9 and the range of bw was set from 0 1 to 0 9 fig 12 shows a comparison of the results according to hm hmcr par and bw in the imlp when hm varied from 10 to 30 the rmse decreased and when it reached 40 the rmse increased when hm was 30 it had the lowest rmse this means that an hm that was too large showed poor results when the hmcr varied from 0 1 to 0 5 the rmse decreased and increased at 0 7 with the smallest rmse at 0 9 it showed a low rmse when the par was low and the smallest rmse of 0 5 indicating that an appropriate par is required by the parameter setting process it showed a low rmse when bw was low and the smallest rmse when bw was 0 1 when a large bw was applied there was no effect of weight adjustment to determine the structure of the imlp the results were compared according to the number of nodes and the number of hidden layers in the imlp the optimizer of imlp was selected as sgd the number of nodes was varied from 1 to 10 and the number of hidden layers was also varied from 1 to 10 the comparison of the results according to the number of nodes and the number of hidden layers is shown in fig 13 in fig 13 a large rmse was shown when the number of nodes ranged from 1 to 3 when the number of nodes increased the rmse decreased and then increased when the number of nodes was 6 it decreased again when the number of nodes was 9 and showed the smallest value when the number of nodes is 10 the rmse fluctuated when the number of hidden layers was 1 to 4 but showed the smallest value when the number of hidden layers was 5 when the number of hidden layers was 6 the rmse increased and the number of hidden layers decreased slightly if a structure that can store weights and biases is added to the existing optimizer instead of the meta heuristic optimization algorithm and a structure that enables global search within the range of each variable is added it could be a feasible alternative if a feasible alternative is possible there are two advantages first it is possible to prevent convergence to the local optimum due to the global search second it is possible to exclude the case where the learning result the value of the loss function is bad due to the structure that can store the weights and biases showing the best result two advantages enable stable and high accuracy learning fig 14 shows the difference between the existing optimizer and the feasible alternative the water levels of the tributaries can be applied instead of the rainfall and the discharge of pump stations as input data the water levels of the tributaries being measured in the urban stream could be a feasible alternative it is expected that accurate learning will be possible because the water levels of the tributaries have a direct effect on the runoff of urban streams rather than other parameters if the water level of the tributaries is added improved learning accuracy can be expected instead of mlp applied in this study rnn or lstm can be a feasible alternative a feasible alternative has the advantage of being able to link current learning with past learning however if the distance between the input information and the output point using the input information is long the learning ability could deteriorate 5 conclusions in this study the combined optimizers of existing optimizers and meta heuristic optimization algorithms developed according to different existing optimizers were analyzed the newly developed imlp was applied to dorim stream an urban stream in seoul to predict runoff the runoff of the dorim stream was predicted using the rainfall and discharge of the pump stations to verify the performance of the combined optimizers and to compensate for the drawbacks of the existing optimizers the results showed the lowest error among the existing optimizers such as sgd rmsprop adagrad adadelta adam nadam adamax and ftrl when adagrad was applied the combined optimizers had lower errors than the existing optimizers and adamax combined with hs had the lowest error it was confirmed that the mse mae mape and sad of the combined optimizers were lower than those of the existing optimizers when the prediction was performed by applying the imlp these results indicate that the combined optimizers were relatively more stable in learning than the existing optimizers and did not fall into the local solution it is expected that the imlp developed in this study can be applied in various fields of hydrology and water resource management the parameter setting of hs the meta heuristic optimization algorithm used in this study could decrease usability if self adaptive meta heuristic optimization algorithms are used usability can be increased since the preprocessing takes a lot of time it could be inconvenient for users to apply the method proposed in this study because only normalization and correlation analysis were applied not all preprocessing analysis on whether the best preprocessing method was selected can be added in follow up studies the combined optimizer developed in this study could be applied to rnn lstm and gated recurrent unit gru which are neural network models specialized for time series learning additionally if a method for automatically selecting a meta heuristic optimization algorithm suitable for training data is added the prediction accuracy could be improved if a method for optimizing the structure of mlp the number of hidden layers and the number of nodes by applying a meta heuristic optimization algorithm is developed usability can be increased credit authorship contribution statement eui hoon lee conceptualization methodology software validation formal analysis investigation resources data curation writing original draft writing review editing visualization supervision project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement this work was supported by a grant from the national research foundation nrf of korea nrf 2019r1i1a3a01059929 
2640,prediction using neural networks is applied in various fields including hydrology and water resource management in the learning process an optimizer is used to determine the relationship weights and biases between the input and output data to lower the value of the loss function existing optimizers rely absolutely on the relationship that are initially generated and have the probability to converge to a local optimum additionally since there is no structure for storing information about the previously generated correlation there is a probability that the optimal weights and biases could not be found even when learning proceeds it is necessary to apply a meta heuristic optimization algorithm that can consider both global local search and has a structure that can store the previously generated solution in this study a new optimizer was combined with a harmony search hs to improve existing optimizers to test the performance of the improved multi layer perceptron using the new optimizer imlp the runoff of the dorim stream in seoul was predicted the rainfall and the discharge of pump stations were constructed as input data and data preprocessing was performed by normalization and correlation coefficients the imlp showed improved accuracy and could be used to manage urban streams keywords urban stream improved multi layer perceptron combined optimizer meta heuristic optimization algorithm harmony search runoff prediction data availability the data that has been used is confidential 1 introduction recently the frequency and intensity of heavy rainfall events have increased due to rapid climate change leading to a rapid increase in flood damage in the past conceptual or physical models were used to predict water levels or runoff but a large amount of data was needed because different variables such as climate geology and topography were to be considered to overcome these limitations artificial neural network ann models were used the ann model can make highly accuracy predictions by learning the correlation between the input and output data regardless of the variables used in the conceptual and physical models the perceptron had a major impact on early research in the field of ann rosenblatt 1958 the original perceptron is a single layer perceptron that uses multiple inputs and outputs a single result the single layer perceptron has the disadvantage that only linear problems can be solved to overcome this a multilayer perceptron has been proposed that can also solve nonlinear problems a multilayer perceptron consists of an input layer a hidden layer and an output layer several studies have been conducted using neural networks in hydrology and water resources management since 2010 studies have been conducted to estimate floods using time series data the modular soft computing models combining support vector regression svr and ann was suggested for prediction of rainfall time series using preprocessing techniques such as moving average and singular spectrum analysis wu and chau 2013 interval prediction of streamflow discharges using ann with lower upper bound estimation and particle swarm optimization was proposed taormina and chau 2015 various machine learning models such as ann adaptive neuro fuzzy inference system wavelet neural network support vector machine decision tree ensemble prediction systems were investigated for flood prediction although ann was not applied there was a study that applied a meta heuristic optimization algorithm flood plain inundation in mountainous region with no upstream gauged stations was predicted using the reverse flood routing method combined with hec ras model and genetic algorithm ga kaya et al 2019 a hybrid model of long short term memory lstm and an ant lion optimizer was proposed for monthly runoff forecasting yuan et al 2018 ann svr and deep learning algorithms were proposed for modeling and simulating the operation of a reservoir zhang et al 2018 lstm was suggested for rainfall runoff modeling in 241 catchments and results from the sacramento soil moisture accounting model were compared kratzert et al 2018 a hybrid model of variational mode decomposition and deep neural networks was proposed to predict daily runoff in the jing river in china he et al 2019 integrated lstm and a reduced order model framework were applied to predict rapid spatiotemporal flooding hu et al 2019 lstm was applied to global hydrologic models for flood simulations using data from 1032 gauging stations from 1971 to 2010 yang et al 2019 the streamflow of the brazos river basin in texas was predicted for an effective reservoir operation using lstm damavandi et al 2019 the flow duration curves from 9 203 unmeasured locations in the southeastern united states were predicted from 1950 to 2009 worland et al 2019 monthly precipitation was forecasted using long term sequential modeling using a recurrent neural network rnn and lstm kumar et al 2019 hydrologic time series prediction was simulated using an lstm and compared with an autoregressive model qin et al 2018 various studies have been conducted since 2020 flash flood vulnerability has been predicted using a deep learning neural network dlnn and the dlnn has been compared with several machine learning models such as multi layer perceptron mlp and support vector machine svm bui et al 2020 urban flooding prediction has improved by correcting the mean areal precipitation using lstm nguyen and bae 2020 lstm with an encoder decoder framework has been proposed for flood forecasting using the multi step ahead method kao et al 2020 a rainfall runoff model using lstm with sequence to sequence learning was applied to the clear creek and the upper wapsipinicon river in iowa xiang et al 2020 streamflow prediction was performed using a decomposition ensemble model and lstm zuo et al 2020 several neural network models such as mlp and rnn were used to predict the real time water level of cascade channels and compared with svm ren et al 2020 the daily streamflow of the upper yangtze river was predicted using lstm in conjunction with a gaussian process zhu et al 2020 streamflow in kelantan river was predicted using lstm and compared with the classic backpropagation neural network model fu et al 2020 generalized structure group method of data handling and neuro fuzzy inference system fuzzy c means were combined for prediction of daily water level ebtehaj et al 2021 existing studies can be classified as new applications using developed neural networks nn in new applications or combinations of nn with various other methods this study focused on improving accuracy by improving the optimizer which is an important element of the nn existing optimizers including stochastic gradient descent sgd adaptive delta adadelta adaptive gradient adagrad adaptive moment adam a variant of adam based on the infinity norm adamax that follows the regularized leader ftrl nesterov accelerated adaptive moment nadam and root mean squared propagation rmsprop have the potential to converge to a local minimum relying entirely on the relationships weights and biases generated initially sedki et al 2009 furthermore since there is no structure for storing information about previously generated relationships there is a possibility that an optimal relationship will not be found even as learning progresses lee and lee 2022 a new optimizer combined with a meta heuristic optimization algorithm is proposed to add a structure to avoid local minima and store information about previously generated relationships improved multi layer perceptron imlp with a new optimizer can include both a method of calculating weights and biases based on numerical differentiation and a method of probabilistically searching for weights and biases in addition imlp can be applied to various hydrology fields as well as runoff prediction of urban streams the ga the first meta heuristic optimization algorithm to motivate human evolution was developed goldberg and holland 1988 since then various metaheuristic optimization algorithms have been developed the harmony search hs used in this study is an algorithm inspired by the harmony of instrument players geem et al 2001 in this study imlp with new combined optimizers combing the existing optimizer and hs was developed to improve the shortcomings of the existing optimizers in addition to verify the performance of imlp the runoff of the urban stream was predicted by applying the discharge of pump stations and rainfall data to compare the results the runoff of the dorim stream in seoul korea was predicted using the discharge of pump stations and rainfall data data from 2010 2011 2012 2013 2014 2016 2018 2019 and 2020 when rainfall events occurred and pump stations operated in the study area were used for training imlp with new combined optimizers could be used to preemptively manage urban streams by accurately predicting the runoff of urban streams preemptive management of urban streams could be used to save lives and valuable assets around urban streams and to manage urban areas 2 methodologies 2 1 preprocessing of training data deep learning may be impaired due to divergence when training data contains a wide range of values machine learning models including mlp learn by extracting features from training data if the range of the training data that the model accepts is uneven there is a risk that the model will learn the data in a strange way therefore regardless of the quality of the data preprocessing of the training data is necessary for proper learning normalization ensures that all data are applied within the same range normalization was applied to correct the training and increase the learning accuracy according to the normalization the training data were converted to values between 0 and 1 eq 1 shows the normalization 1 b a a min a max a min where b is the normalized data and a is the original data amax is the maximum original data and amin is the minimum original data to improve the learning accuracy it is necessary to adjust the time lag between the input data and the target data among the learning data the method to consider the time lag between the input data and the target data was correlation analysis correlation analysis is a method of analyzing the nature of the linear relationship between two variables which is measured by a correlation coefficient the correlation coefficient is calculated using eq 2 2 r a b i 1 n a i a b i b i 1 n a i a 2 i 1 n b i b 2 where ra b is the correlation coefficient a i is the input data and b i is the target data a is the average of ai and b is the average of bi fig 1 shows the schematic of the time lag correlation in fig 1 the calculation of the time lag is repeated until the highest correlation coefficient is reached in this study normalization and time lag correlation are performed to preprocess the training data to improve learning accuracy a feasible alternative to correlation analysis is the observed time of arrival the observed time of arrival has the advantage of being easily applied without the time required for data preprocessing 2 2 multi layer perceptron a single layer perceptron slp is a simple ann which consists of an input layer and an output layer although slp showed good results on linear problems it had the disadvantage that it could not solve nonlinear problems such as the exclusive or xor problem to overcome this drawback an mlp with one or more hidden layers was proposed fig 2 shows the structure of the mlp and the imlp in this study the training data consisted of 12 input values and one output value the mlp and imlp used in this study consisted of 12 nodes in the input layer 10 nodes in five hidden layers and one node in the output layer the activation function used in the mlp and imlp was a rectified linear unit relu and the total number of epochs was 100 000 the loss function of mlp and imlp is the mean square error mse a new structure in which the number of hidden layers and the number of nodes in each hidden layers is changed could be a feasible alternative if the number of hidden layers and the number nodes in the hidden layers are reduced faster learning is possible however if the number of hidden layers and the number of nodes in each hidden layer are reduced too much the learning accuracy could decrease it is also possible to increase or decrease the total number of epochs of mlp and imlp by increasing the total number of epochs the learning accuracy could be improved through additional learning however if the total number of epochs is greatly increased overfitting could occur 2 3 meta heuristic optimization algorithm heuristics is a method that attempts to solve a problem using available information to solve this problem several variables should be considered however in the real world a perfect solution is not possible due to lack of information and shortage of time therefore a feasible solution based on limited information is required heuristics is a method to determine the most realistic solution level for this case in general it is difficult to develop heuristics based on the characteristics of each problem to be solved therefore it is possible to use a high level heuristic i e a meta heuristic that is applicable to different problems without being limited to a specific problem although various meta heuristic optimization algorithms have been developed their concepts and theories are simple and their ability to search for solutions is outstanding therefore they can be used in various fields including engineering and science it is also possible to apply a meta heuristic optimization algorithm such as ga instead of hs ga has the advantage of being applicable regardless of the continuity and differentiability of the objective function however since a lot of weights and biases are generated in one iteration it could take a long time to learn 2 4 multi layer perceptron using existing optimizers python was used to create the code and libraries such as tensorflow and keras were used the optimizers available for application to mlp in this study were keras sgd rmsprop adagrad adadelta adam nadam adamax and ftrl sgd is an optimizer for calculating the predicted gradients of each step with a single value selected probabilistically from all the data rmsprop is an optimizer that improves on the shortcomings of adagrad instead of simply adding all the gradients rmsprop takes into account the most recent gradient information and compensates for the disadvantage that the learning rate drops too much towards the second half adagrad is calculated by squaring and adding past gradients and is an optimizer for applying a learning rate reduction to each parameter adadelta is an optimizer that uses an exponential moving average to overcome the disadvantages of adagrad which hardly learns at all in the latter part adam is an optimizer that combines the strengths of momentum and rmsprop maintains the past change of gradients and taking into account the latest information more than the past nadam is an optimizer that combines the strengths of the nesterov adaptive moment and rmsprop and calculates the gradient by moving in the direction of momentum rather than calculating the gradient from the current position adamax is an optimizer for the transformation of adam based on the infinite norm 2 5 improved multi layer perceptron using combined optimizer the disadvantages of existing optimizers such as sgd rmsprop adagrad adadelta adam nadam adamax and ftrl can converge the local minimum and the lack of a structure to store information to overcome the shortcomings of the existing optimizers a meta heuristic optimization algorithm with a global search and a structure to store information is combined with the existing optimizers among the various meta heuristic optimization algorithms hs was used which has a simple structure and efficient search performance additionally there was a study in which meta heuristic optimization algorithms such as ga and hs were applied as optimizers instead of the existing optimizers to predict the runoff of urban stream lee and lee 2022 however there was a disadvantage in that the results were not stable because the learning proceeded by excluding the mathematical calculation of the existing optimizer and relying only on the probabilistic search of meta heuristic optimization algorithms when only the probabilistic search of the meta heuristic optimization algorithm was performed bad learning results were often produced so a new method was required to overcome this the combined optimizers proposed in this study combined mathematical calculations and probabilistic search this method overcomes the unstable results generated when only the meta heuristic optimization algorithm is used hs is a meta heuristic optimization algorithm proposed by geem et al 2001 it was developed by motivating the process of finding the optimal harmony by instrumentalists practice each harmony is stored in the harmony memory hm and a new harmony is created using an existing hm solution set through the harmony memory considering rate hmcr or an arbitrary harmony is created in the case of hmcr the existing harmony is adjusted as much as the bandwidth bw using the pitch adjustment rate par in this study hm hmcr par and bw to 30 0 9 0 5 and 0 1 respectively the imlp application process can be divided into five steps first the training data were collected second the training data were preprocessed third the structure of the imlp was constructed fourth combined optimizers were applied fifth the weights and biases were updated using a combined optimizer the combined optimizers generate the initial solutions hm calculate the fitness of the initial hm sort in ascending order by fitness apply the existing optimizer apply an hmcr random search rs and apply par when applying the combined optimizer the existing optimizer is not applied to all hms since a new solution is generated by the search process of hs the combined optimizer also generates a new solution in the combined optimizer depending on the probability of the hmcr it is decided whether to select from the existing hms weights and biases or the rs between the upper and lower boundaries in each weight and bias fig 3 shows the application flow of imlp using the combined optimizers the imlp process can be divided into data acquisition data preprocessing and imlp applications including mlp and meta heuristic optimization algorithms in fig 3 data acquisition and data preprocessing are simply expressed and most of the contents are expressed in detail with imlp including the hs process it is possible to apply the parallel combined optimizers instead of the vertical combined optimizers presented in imlp the parallel combined optimizers have the advantage of being able to learn faster than the vertical combined optimizers however there is a disadvantage that the learning accuracy could be low 3 application and results 3 1 study area seoul is the capital of korea and is crossed by one of the four major rivers han river nakdong river geum river and youngsan river the han river the han river has several tributaries of which the anyang stream has an area of 286 km2 and a length of 32 5 km the anyang stream which flows through seoul and gyeonggi do has tributaries such as the mokgam and dorim streams the dorim stream has an area of 41 93 km2 and a length of 11 km the dorim stream originates at gwanak mountain where seoul national university is located and flows to its confluence with the anyang stream the dorim stream has two tributaries the daebang and bongchun streams there are 11 pump stations that include the mullae dorim2 daelim3 daelim2 guro1 guro2 guro3 guro4 sinlim1 sinlim2 and sinlim5 on the dorim stream the watershed drained by the pump stations is 8 84 km2 which is approximately 21 of the total catchment area of the dorim stream fig 4 shows the location of the study area a precipitation observatory was included in the study area and 12 input datasets including the rainfall and discharge of 11 pump stations were generated one monitoring point located at the confluence of the dorim and anyang streams provided the data generated as output datasets learning datasets were constructed by combining the input and output data instead of dorim stream applied in this study an urban stream with many pump stations can be selected if an urban stream with many pump stations is selected the number of input data increases so it could be able to show high learning accuracy however in the case of a newly constructed pump station it could not be available as input data because the recorded data is not sufficient 3 2 preparation of data for runoff prediction data from 2010 to 2020 was collected when rainfall events occurred and pump stations operated in the study area data from 2015 and 2017 when pump stations were not in operation were excluded the time interval of all data including rainfall runoff and discharge of the pump stations was 10 min the observed rainfall and runoff in the study area are shown in fig 5 data from 2010 to 2019 were used as training data and data from 2020 was sued as validation data the high runoff in the 2010 and 2011 data was caused by heavy rainfall in 2010 and 2011 since the maximum values of the data for each year were different the accuracy could be low when learning with the raw data therefore normalization was used to prevent overfitting the reason that the historical data for 2021 is not included is that pump stations were not in operation because there was no major rainfall in the study area in the future the inclusion of additional historical data could improve the accuracy of runoff prediction 3 3 runoff prediction using imlp the structure of the mlp using existing optimizers and imlp using combined optimizers five hidden layers with 10 nodes was set identically and learning was performed root mean square error rmse was used to calculate the accuracy of the predicted values the rmse is calculated by eq 3 3 rmse i 1 n o i s i 2 n where oi is the observed value si the predicted value and n the number of values the error was calculated not only from the rmse with the square value of the difference between the observed and predicted values but also from the mean square error mae with the absolute value of the difference between the observed and predicted values mae has the advantage of intuitively knowing the difference but also has the disadvantage of being less sensitive to errors the mae is calculated by eq 4 4 mae i 1 n o i s i n as an additional error calculation method the mean absolute percentage error mape was applied under normal circumstances rmse reflects the extent to which the predicted value of the regression model deviate from the actual values however when there are outliers with a very large degree of deviation the rmse value becomes very high due to this small number of outliers mape can be applied as an index to solve the above problems compared with rmse mape normalizes the errors of each point to lower the influence of the absolute error caused by each singular point the mape is calculated by eq 5 5 mape 1 n i 1 n o i s i o i since mape has a value between 0 and 1 it has the advantage of easy interpretation of results and comparison of model performance however there is also a disadvantage that the mape value could become large when the actual value is a very small value close to 0 as an additional error calculation method the sum of absolute difference sad was applied the sad is calculated by eq 6 6 sad i 1 n o i s i to verify the performance of data preprocessing the results of the two methods normalization and correlation analysis applied in this study were analyzed normalization converted all data from 0 to 1 based on the maximum value correlation analysis was applied to the rainfall data and the discharge of each pump station and the results of correlation analysis are shown in the table 1 for rainfall data the correlation coefficient was maximum when the lag time was 60 min for each pump station the correlation coefficient was maximized at different lag times the largest value of the correlation coefficient was rainfall data and the smallest is the discharge of sinlim5 pump station results according to the data preprocessing were compared by applying imlp table 2 shows the results according to the data preprocessing application when normalization and correlation analysis were applied the prediction accuracy was improved compared to when the raw data was applied in particular normalization in adamax combined with hs showed a great improvement in prediction accuracy in the results of imlp using all combined optimizers the effect of data preprocessing was significant table 3 shows the runoff prediction results of the mlp using the existing optimizers and the imlp using the combined optimizers among the existing optimizers adagrad showed the lowest rmse and mae values table 3 in particular the errors of the existing optimizers except for ftrl were distributed in the rmse from 25 m3 s to 30 m3 s and the mae from 11 m3 s to 13 m3 s among the combined optimizers adamax combined with hs showed the best results the lowest rmse and mae in the imlp results using combined optimizers sgd combined with hs showed the highest rmse and mae however the rmse of all combined optimizers including sgd combined with hs did not exceed 9 m3 s and the mae did not exceed 4 m3 s in the mape results all existing optimizers showed results exceeding 1 and all combined optimizers did not exceed 1 among the combined optimizers the mape of adamax combined with hs was 0 09 showing the smallest value in the sad results all existing optimizers exceeded 3000 m3 s but all combined optimizers showed results below 1200 m3 s among the combined optimizers the sad of adamax combined with hs was 529 m3 s showing the smallest value fig 6 shows a comparison of runoff prediction using sgd with rmsprop sgd combined with hs and rmsprop combined with hs the combined optimizers such as sgd combined with hs and rmsprop combined with hs showed relatively accurate results compared to the existing optimizers such as sgd and rmsprop in terms of not only the overall error but also the difference in the peak runoff in the peak runoff sgd combined with hs showed a difference about 34 m3 s and rmsprop combined with hs about 45 m3 s when the existing optimizers were changed to the combined optimizers sgd improved by approximately 125 m3 s and rmsprop improved by approximately 116 m3 s based on peak runoff there was a large difference in the peak runoff of the runoff prediction results using mlp using sgd and rmsprop in the case of imlp to which sgd combined with hs was applied a relatively large difference occurred at 1860 min but the difference decreased and almost coincided with the observed runoff at 1900 min in the case of imlp to which rmsprop combined with hs was applied it was predicted that the runoff did not fluctuate significantly from 1860 min to 1900 min at peak runoff imlp to which sgd combined with hs was applied and rmsprop combined with hs showed relatively more accurate runoff than mlp to which sgd and rmsprop were applied fig 7 shows a comparison of runoff prediction using adagrad adadelta adagrad combined with hs and adadelta combined with hs the combined optimizers such as adagrad combined with hs and adadelta combined with hs showed relatively accurate results compared to the existing optimizers such as adagrad and adadelta not only in terms of the overall error but also in terms of the difference in the peak runoff for the peak runoff adagrad combined with hs showed a difference of about 33 m3 s and adadelta combined with hs showed about 14 m3 s when the existing optimizers were replaced with the combined optimizers adagrad improved by approximately 109 m3 s and rmsprop improved by approximately 117 m3 s based on peak runoff most of the peak runoff prediction results using the mlp with adagrad and adadelta at the peak runoff were maintained at approximately 50 m3 s and there was a significant difference from the observed runoff in the case of imlp to which adagrad was applied combined with hs the difference was relatively small at 1880 min in the case of imlp to which adadelta combined with hs was applied there was no significant difference in the observed runoff from 1860 min to 1900 min except for the results of 1890 min for peak runoff the imlp to which adagrad combined with hs and adadelta combined with hs were applied showed relatively more accurate runoff than mlp to which adagrad and adadelta were applied fig 8 shows a comparison of the runoff prediction using adam nadam adam combined with hs and nadam combined with hs the combined optimizers such as adam combined with hs and nadam combined with hs showed relatively accurate results compared to the existing optimizers such as adam and nadam not only in terms of the overall error but also in terms of the difference in the peak runoff for peak runoff adam combined with hs showed a difference of about 65 m3 s and nadam combined with hs showed a difference of about 49 m3 s when the existing optimizers were replaced with the combined optimizers adam improved by approximately 134 m3 s and nadam improved by approximately 107 m3 s based on peak runoff peak runoff prediction results using mlp with adam and nadam for 1870 and 1900 min were maintained at approximately 100 m3 s and there was a significant difference from the observed runoff the runoff predicted with mlp using existing optimizers such as adam and nadam in 1860 1880 and 1890 min was largely different from the observed runoff the predicted runoff with imlp using adam combined with hs showed a constant difference from 1860 min to 1900 min the predicted runoff using imlp to which nadam combined with hs was applied was similar to the observed runoff at 1860 min and 1900 min at peak runoff the imlp to which the combined optimizers were applied showed a smaller difference than the mlp to which the existing optimizers were applied among the combined optimizers nadam combined with hs showed a smaller difference in the peak runoff than adam combined with hs fig 9 shows a comparison of runoff prediction with adamax ftrl adamax combined with hs and ftrl combined with hs the combined optimizers such as adamax combined with hs and ftrl combined with hs showed relatively accurate results compared to the existing optimizers such as adamax and ftrl in terms of not only the overall error but also the difference in the peak runoff in particular the existing ftrl showed poor prediction results however ftrl combined with hs significantly improved the prediction results in the peak runoff adamax combined with hs showed a difference about 36 m3 s and ftrl combined with hs about 26 m3 s when the existing optimizers were replaced with the combined optimizers adamax improved by approximately 138 m3 s and ftrl improved by approximately 169 m3 s based on peak runoff in general the overall errors rmse and mae and peak to peak accuracy improved when the combined optimizers were used the optimizer that showed the greatest improvement was ftrl as the results of applying the existing ftrl were the least accurate the optimizer with the second largest improvement was adamax significant improvement was observed in the case of adamax although the results were not too inaccurate when the existing adamax was applied the reason that adamax showed a large improvement appears to have been influenced by the improvement in accuracy at peak runoff adamax could diverge depending on the initial value and thus the accuracy could be reduced however in adamax combined with hs since there are various initial values stored in the hm this problem can be overcome and the performance is greatly improved fig 10 shows a comparison of runoff prediction using adagrad which showed the best results among the existing optimizers and adamax combined with hs which showed the best results among the combined optimizers as shown in fig 10 the peak value occurred at 1880 min the difference from the observed runoff was 174 52 m3 s for adamax 142 56 m3 s for adagrad 36 26 m3 s for adamax combined with hs and 33 56 m3 s for adagrad combined with hs when the existing optimizers were replaced with the combined optimizers the difference from the peak runoff improved by approximately 109 m3 s for adagrad and by approximately 138 m3 s for adamax table 4 shows the runoff prediction results at 1880 min the combined optimizers including adamax combined with hs showed good results not only for the overall rmse and mae but also for the peak to peak error for the rmse and mae results adamax combined with hs showed a smaller difference than adagrad combined with hs however when adagrad combined with hs was applied the difference in the peak runoff was smaller than that of adamax combined with hs when a loss function is applied that includes the difference from the peak runoff the rmse and mae increase however the difference from the peak runoff can be reduced 4 discussion to compare the runoff predicted by the imlp with the observed runoff the r2 value was calculated and a comparison was made according to the flow rate the r2 value was calculated using eq 7 7 r 2 i 1 n s i o 2 i 1 n o i o 2 where oi is the observed value and si is the simulated value n is the number of data points and o is the average of oi a comparison of r2 for mlp and imlp is shown in fig 11 for the results of mlp using adagrad and adamax fig 11 the predicted values were very small compared to the observed runoff for the results of the imlp using adagrad combined with hs and adamax combined with hs the observed runoff generally higher than the predicted runoff but the difference was not significant compared to that of the mlp using adagrad and adamax combined optimizers such as adagrad combined with hs and adamax combined with hs in imlp showed relatively accurate results even at high flow rates moreover the results were checked based on the parameter changes of the hs in the combined optimizer sgd combined with hs was applied to the combined optimizer of imlp and the values of hm hmcr par and bw were changed the range of hm was set from 10 to 50 the range of hmcr was set from 0 1 to 0 9 the range of par was set from 0 1 to 0 9 and the range of bw was set from 0 1 to 0 9 fig 12 shows a comparison of the results according to hm hmcr par and bw in the imlp when hm varied from 10 to 30 the rmse decreased and when it reached 40 the rmse increased when hm was 30 it had the lowest rmse this means that an hm that was too large showed poor results when the hmcr varied from 0 1 to 0 5 the rmse decreased and increased at 0 7 with the smallest rmse at 0 9 it showed a low rmse when the par was low and the smallest rmse of 0 5 indicating that an appropriate par is required by the parameter setting process it showed a low rmse when bw was low and the smallest rmse when bw was 0 1 when a large bw was applied there was no effect of weight adjustment to determine the structure of the imlp the results were compared according to the number of nodes and the number of hidden layers in the imlp the optimizer of imlp was selected as sgd the number of nodes was varied from 1 to 10 and the number of hidden layers was also varied from 1 to 10 the comparison of the results according to the number of nodes and the number of hidden layers is shown in fig 13 in fig 13 a large rmse was shown when the number of nodes ranged from 1 to 3 when the number of nodes increased the rmse decreased and then increased when the number of nodes was 6 it decreased again when the number of nodes was 9 and showed the smallest value when the number of nodes is 10 the rmse fluctuated when the number of hidden layers was 1 to 4 but showed the smallest value when the number of hidden layers was 5 when the number of hidden layers was 6 the rmse increased and the number of hidden layers decreased slightly if a structure that can store weights and biases is added to the existing optimizer instead of the meta heuristic optimization algorithm and a structure that enables global search within the range of each variable is added it could be a feasible alternative if a feasible alternative is possible there are two advantages first it is possible to prevent convergence to the local optimum due to the global search second it is possible to exclude the case where the learning result the value of the loss function is bad due to the structure that can store the weights and biases showing the best result two advantages enable stable and high accuracy learning fig 14 shows the difference between the existing optimizer and the feasible alternative the water levels of the tributaries can be applied instead of the rainfall and the discharge of pump stations as input data the water levels of the tributaries being measured in the urban stream could be a feasible alternative it is expected that accurate learning will be possible because the water levels of the tributaries have a direct effect on the runoff of urban streams rather than other parameters if the water level of the tributaries is added improved learning accuracy can be expected instead of mlp applied in this study rnn or lstm can be a feasible alternative a feasible alternative has the advantage of being able to link current learning with past learning however if the distance between the input information and the output point using the input information is long the learning ability could deteriorate 5 conclusions in this study the combined optimizers of existing optimizers and meta heuristic optimization algorithms developed according to different existing optimizers were analyzed the newly developed imlp was applied to dorim stream an urban stream in seoul to predict runoff the runoff of the dorim stream was predicted using the rainfall and discharge of the pump stations to verify the performance of the combined optimizers and to compensate for the drawbacks of the existing optimizers the results showed the lowest error among the existing optimizers such as sgd rmsprop adagrad adadelta adam nadam adamax and ftrl when adagrad was applied the combined optimizers had lower errors than the existing optimizers and adamax combined with hs had the lowest error it was confirmed that the mse mae mape and sad of the combined optimizers were lower than those of the existing optimizers when the prediction was performed by applying the imlp these results indicate that the combined optimizers were relatively more stable in learning than the existing optimizers and did not fall into the local solution it is expected that the imlp developed in this study can be applied in various fields of hydrology and water resource management the parameter setting of hs the meta heuristic optimization algorithm used in this study could decrease usability if self adaptive meta heuristic optimization algorithms are used usability can be increased since the preprocessing takes a lot of time it could be inconvenient for users to apply the method proposed in this study because only normalization and correlation analysis were applied not all preprocessing analysis on whether the best preprocessing method was selected can be added in follow up studies the combined optimizer developed in this study could be applied to rnn lstm and gated recurrent unit gru which are neural network models specialized for time series learning additionally if a method for automatically selecting a meta heuristic optimization algorithm suitable for training data is added the prediction accuracy could be improved if a method for optimizing the structure of mlp the number of hidden layers and the number of nodes by applying a meta heuristic optimization algorithm is developed usability can be increased credit authorship contribution statement eui hoon lee conceptualization methodology software validation formal analysis investigation resources data curation writing original draft writing review editing visualization supervision project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement this work was supported by a grant from the national research foundation nrf of korea nrf 2019r1i1a3a01059929 
2641,the random walk path method rwp is a stochastic model that transforms the solution of the unsteady open channel flow equations into a probability problem in this paper this method is introduced to solve the discretized saint venant equations with probabilistic representation of the water levels at junctions different boundary conditions which specify either water levels or discharge hydrographs can be implemented by specifying how walkers react when arriving at the boundaries the pointwise solution at river junctions can be obtained via random walk simulations the efficacy of the model was verified against the following test cases 1 a real world looped channel example documented in the manual of the software hec ras and 2 a hypothetical channel system consisting of dendritic and divergent networks the number of random simulations is an important aspect of the rwp method and needs to be chosen by considering the trade off between precision and computational efficiency the impact of the boundary water level or discharge on the water levels at internal nodes can be quantitatively evaluated by adopting the terminal weights which present a distinct advantage of the rwp method this assessment of water levels can serve as a guide in the operation of hydraulic controls such as dams sluices and pumps to effectively regulate the flow in mitigating flood risks keywords random walk path unsteady flow saint venant equations open channel channel networks data availability data will be made available on request 1 introduction modelling of unsteady flow in open channel networks plays an important role in many hydraulic applications such as flood forecasting bates and de roo 2000 beltaos et al 2012 nazari and seo 2021 drainage system design henine et al 2014 irrigation assar et al 2020 algae control fovet et al 2013 and wastewater management akella and bhallamudi 2019 numerical simulation is extensively used to study the hydrodynamic processes in channel networks by solving the one dimensional flow equations commonly known as the saint venant equations these equations cunge et al 1980 are a set of non linear partial derivative equations which are difficult to solve analytically numerical techniques are widely used in the discretization of the saint venant equations to obtain non linear algebraic equations finite difference schemes el kadi abderrezzak and paquier 2009 qi et al 2022 sen and garg 2002 are the most commonly applied techniques due to their advantages such as a small amount of computation and ease of implementation in the past two decades the finite volume method hodges 2019 kesserwani et al 2008a sarkhosh et al 2020 was widely applied to solve the saint venant equations limited mostly to 2d cases liang et al 2007 zhao et al 2019 the non linear equations are solved using iterative techniques such as the newton raphson method janicke and kost 1998 zhu et al 2011 or through linearization for modelling the flow in a single channel the coefficient matrix of the linear equation system is banded and efficient methods such as the double sweep algorithm can be used to solve the well structured matrix equation cunge et al 1980 however for a channel network the coefficient matrix does not exhibit the banded property due to difficulties in generating a coefficient matrix of the minimum bandwidth considering the role of junctions directly solving these coefficient matrices usually requires considerable computational time and computer storage some attempts have been made in the past to simplify these complicated or extremely large coefficient matrices with the initial research focused on dendritic channel networks the separate segment method akan and yen 1981 fread 1973 was used to split the channels network into overlapping and independent components for computation however it needed a large number of iterations and failed to accurately describe the physical phenomena near channel junctions some scholars transformed the matrix into formats that were suitable for the double scan algorithm techniques such as matrix diagonalization or recursive equations choi and molinas 1993 in addition specific node numbering was used to obtain banded matrices with reduced bandwidth nguyen and kawano 1995 thus all the above algorithms have very specific requirements regarding the topology or node numbering of the channel network and cannot be applied easily to networks containing loops the three step algorithm is a generalized algorithm for unsteady flow modelling which is suitable for any type of channel network fang et al 2012 sen and garg 2002 sen and garg 1998 zhang and shen 2007 this algorithm splits the channel network into segments the end node variables of each channel are calculated first followed by the solution for variables at all other sections by a backward substitution this method improves the computational efficiency by reducing the order of the computational matrix however the entire set of equations needs to be solved simultaneously and thus the advantage of the banded nature is lost zhu et al 2011 another problem with the three step algorithm is that it is difficult to explicitly check the individual contributions of model components in the absence of additional tools for sensitivity analysis the random walk path method rwp is a method 0f solving mathematical problems via random walk simulations the basic idea of the rwp method is to establish a random walk process whose parameters are linked to the solution of the equation the statistical characteristics of the parameters which yield the exact value of the solution can be obtained through sampling experiments there are distinctions between this method and the particle tracking method which is a typical mesh free approach for modelling contaminant transport roubinet et al 2010 yang and liang 2020 although both methods are based on random motions of particles they are different in terms of the mathematical bases the particle tracking method is based on fokker planck equation labolle et al 1996 and is known as one of the lagrangian methods while the rwp method is an application of the feynman kac theorem nan and wu 2018 gave a detailed description of these two methods from a theoretical point of view to avoid confusion the method adopted in this paper is termed the rwp method for problems that are too complex to get an analytical solution or have no analytical solution the rwp method is an effective way to find a numerical solution this approach provides a new perspective for the solution of partial differential equations pdes different schemes of the rwp method have been developed in the past and applied to solve pdes of various physical processes maire and nguyen 2016 mascagni and simonov 2004 simonov and mascagni 2004 in addition the rwp method can be used to calculate the interdependence between nodes in a network known as the correlation specifically with regard to hydraulics rwp has been successfully applied for solving pdes of complicated groundwater problems and pumping well management nan et al 2020 nan and wu 2018 solving steady state problems in channel networks using the rwp method has also been well studied chen et al 2001 wang et al 2016 made an attempt to apply it to unsteady flow modelling but the consistency between the mathematical expectation of probabilistic representation and the deterministic solution was not well proven moreover only looped networks were considered and the boundary condition was restricted to the water level hydrograph this present study focuses on the rwp method applied to unsteady flow modelling of channel networks and its potential prospects in water conservancy projects management a probabilistic description of the solutions to the discretized saint venant equations is presented and its mathematical expectation has been derived this paper also presents the conditions under which they are applicable by taking into account the limitations of the transition probability the key to dealing with different boundary conditions such as water level hydrograph and discharge hydrograph is to define the reaction of the walkers when they meet the boundaries 2 methodology 2 1 basic equations and formulation of the problem the saint venant equations for open channel flows can be expressed as follows 1 q x l t z t 0 q t qv x ga z x j 0 where q m 3 s is the volumetric discharge l t m is the river width z m is the water level t s is time v m s 1 is the velocity a m 2 is the flow area of cross section g 9 81 m s 2 is the gravitational acceleration and j is the friction slope along a channel j can be expressed as j q q d 2 where d m 6 s 2 is the conveyance function among the numerous numerical schemes for solving the saint venant equations the implicit scheme has the advantage of allowing for large time steps zhu and chen 2019 and references therein in this paper eq 1 is discretized using the four point implicit preissmann scheme which exhibits good numerical stability sen and garg 2002 this scheme results in a system of nonlinear algebraic equations between cross sections i and j for each small river section which can be expressed as follows 2 as 1 i 1 q i bs 1 i 1 z i cs 1 i 1 q i 1 ds 1 i 1 z i 1 es 1 i 1 as 2 i 1 q i bs 2 i 1 z i cs 2 i 1 q i 1 ds 2 i 1 z i 1 es 2 i 1 where z i z i 1 q i and q i 1 are the water levels and discharges at cross sections i and i 1 respectively as 1 bs 1 cs 1 ds 1 es 1 as 2 bs 2 cs 2 ds 2 and es 2 are the coefficients of the discretized saint venant equations see appendix a and subscript i 1 is omitted here for the sake of brevity the forward elimination in the three step method sen and garg 2002 is used here to derive the basic simultaneous equations for a branch involving n c number of cross section 2n c 2 number of coupled equations can be established according to eq 2 the number of unknown variables is 2n c so the equations can be solved if we know two of the variables for each branch the variables corresponding to the interior cross sections are not directly connected to those corresponding to other branches therefore the end node variables of all the branches can be separated to establish global branch equations the 2n c 2 equations for a branch can be reduced to two equations involving four variables at the two ends of the branch z b 1 z b i e q b 1 and q b i e this can be achieved using the chasing method zhang and shen 2007 in other words the discharge at the first and last sections of a branch can be expressed as linear functions of the water levels as follows 3 q b 1  b  b z b 1  b z b i e q b i e  b  b z b i e  b z b 1 where the subscript denotes the location b denotes the branch index i denotes the cross section index see fig 1 e denotes the last cross section of the branch and       are the chasing coefficients the details about the derivations of these coefficients can be found in zhang and shen 2007 the next step is to reduce the number of unknowns by incorporating a boundary condition based on the mass conservation at each junction as shown in eq 4 akan and yen 1981 showed that the energy equation could be approximated by the water stage equality when the flow at the junction is subcritical as shown in eq 5 hence the water level at the junction node can be regarded to be the same as those at the nearest cross sections of the branches linked to the junction more complex conditions kesserwani et al 2008b yuan et al 2021 yuan et al 2022 are not considered in this paper 4 q q in q out 0 5 z in z out where subscript in and out denotes inflow and outflow respectively according to eq 5 the nodal water level z j the subscript indicates the location of the node can be used to represent the cross sectional water levels that are directly related to the junction for example z 1 6 z 2 6 and z 3 1 we can establish a linear relationship between the water level at a junction and those at its nearby junctions by substituting the relationship between the flow rate and the nodal water level eq 3 into eq 4 the linear nodal water level equation is as follows 6 u j z j k 1 n j u jk z jk v j where u j u jk and v j are the linearized coefficients u j is a linear combination of the chasing coefficients  and  u j is a linear combination of the chasing coefficients  and  u j is a linear combination of the chasing coefficients  and  the above nodal water level equation eq 6 can be established for each junction then a system of global equations can be established with the water levels at junction nodes as the basic unknowns 7  z s where  is the coefficient matrix s is the right hand vector z z 1 z 2 z np t is the vector containing the water level variables at all junctions and np is the total number of junction nodes the values of the junction water levels can be obtained by solving the above global equation system i e eq 7 once the end node variables are found for a branch they are substituted into the branch equations as boundary conditions to get the variables at interior nodes in this study the global equations are solved by the rwp method which is a probabilistic approach it is known that the probability of an event can be estimated by its frequency observed during a large number of experiments the key to transforming the deterministic problem into a probabilistic problem is to establish a stochastic process whose statistical quantities are equivalent to the solution to the deterministic problem these statistical quantities are calculated by implementing a statistical process after taking enough samples the approximate solution is obtained in this study the statistical quantities are obtained via monte carlo simulation a rigorous mathematical proof of the probabilistic representation is provided in the following subsection 2 2 theoretic basis of random walk path method 2 2 1 the link between transition probability formula and random walk path dividing both sides of eq 6 by u j eq 6 can be rewritten as eq 8 the transition probability formula between one junction and its adjacent junctions 8 z j k 1 n j p jk z jk s j where p jk u jk u j denotes the transition probability s j v j u j is the source term it is worth mentioning that two conditions of the transition probability formula are 1 k 1 n j p jk 1 and 2 0 p jk 1 the first condition can be met by normalization while not all conditions satisfy the prerequisite of probability non negativity the requirements that the practical application should meet are detailed in appendix b the transition probability between junction nodes is related to the strength of their correlation when it is applied to a channel network the transition probability can reveal the strength of the relationship between water levels at junctions such a strength might be related to the branch length resistance head difference and other factors between the adjacent junction nodes if the transition probability approaches zero the change of junction water level virtually does not affect the surrounding junctions this can happen when the distance between the junction is long or the resistance is too large the relevance of eq 8 can be understood from the perspective of the probabilistic process here a simple example exhibits the relationship between the deterministic formula and the random walk path consider a simple river layout as seen in fig 2 it is assumed that the water levels at boundaries z 1 z 2 z 5 and z 6 are already known whereas the values at interior junction nodes z 3 and z 4 are unknown according to eq 8 the relationship between the water levels at junction nodes 3 and 4 can be written as 9 z 3 p 31 z 1 p 32 z 2 p 34 z 4 s 3 z 4 p 43 z 3 p 45 z 5 p 46 z 6 s 4 from the perspective of a random process p jk can be deemed as the probability of a walker moving to junction node k corresponding to the subscript jk from junction node j we can set a random walk scheme based on these probabilities at node j a walker can move to its adjacent junction nodes with probability p jk and the walker continues to move based on the transition probability until it arrives at the terminal which may be node 1 2 5 or 6 then z 3 can be expressed by the weighted average of the known boundary water levels assuming all the probabilities p jk are 1 3 one can quickly solve eq 9 and then obtain eq 10 it is important to note that here the probability of 1 3 is assumed in practice the likelihood of the transfer varies from one direction to another for this condition the 3 8 and 1 8 are the likelihoods of walker starting from node 3 and ending at nodes 1 and 5 respectively for node 4 the random variable at the junction can also be written in a similar form in conclusion the random variable z j at any junction node can be expressed as in eq 11 10 z 3 3 8 z 1 3 8 z 2 1 8 z 5 1 8 z 6 9 s 3 3 s 4 8 z 4 1 8 z 1 1 8 z 2 3 8 z 5 3 8 z 6 3 s 3 9 s 4 8 11 z j l 1 nt p l z l t s j w j s j where p l denotes the existing probability z l t is a known water level at a boundary the subscript l indicates the position of the boundary and the superscript t stands for terminal nt is the number of boundary points s j is the set of source items s j w j s j is the cumulative impact of the source terms along the random walk path w j is the coefficient for the source term s j conventionally the existing probabilities p l and coefficients w j are obtained through transformation equations such as eq 9 however in a complex channel network solving matrices directly is highly time consuming the gaussian elimination procedure the standard method for solving the linear equations needs o n 3 arithmetic operations for higher order matrix operations stochastic algorithms such as the monte carlo method can be used moreover boundary effects can also be considered which is demonstrated in sec 3 5 2 2 2 a probabilistic representation of the solution of the global equations to get the relationship between the random variable z and the known water level values at boundaries monte carlo simulations are introduced in this study for each simulation a random walk path  p path p 1 p 2 p m 1 p t where the arrow denotes the direction of movement can be obtained which starts from the point p 1 with an unknown water level and terminates at an external boundary node p t with a known water level the stochastic representation of the solution implies a brownian path until the walker arrives at the boundary note that the subscript here indicates an arbitrary intermediate location of the walker rather than a precise location one can obtain many random walk paths by multiple simulations and these paths vary with simulations define a random variable  corresponding to a random route as 12  g  p s p 1 s p 2 s p m f p t where g and f are functions of the random route and boundary points respectively s p m is equal to the source term for the m th node along the random path passes through multiple trials we can get a set of random variables   1  n  n rs corresponding to different random routes the probabilistic representation of the solution at junction node p 1 is 13 z p 1 e  in other words the defined random variable   1  n  n rs has a mathematical expectation equal to the water level at the junction node if eq 13 holds then a statistical test can be performed to estimate the value of this variable z p 1 one random variable s value can be obtained from one random walk and n rs random walks simulations yield n rs random variable values with the average value serving as an approximation of z p 1 the following is a formal proof that the mathematical expectation of random variables is indeed the same as the problem s solution depending on the location of the starting point it can be divided into two cases case 1 if the starting point of a walker is a boundary node p t then it stays at point p t so the value of the defined variables  can be formulated as 14  g  p t f p t case 2 if the walker does not start from a boundary node p t then we only need to prove eq 15 to justify eq 13 15 e g  p t k 1 n j p jk z p jk s p 1 the random process  p can be thought of as consisting of two routes namely p 1 p 1 k and  p 1 k p 2 p 3 p m 1 p t for the second route  p 1 k the random variable  should have the value 16  g  p 1 k s p 2 s p m f p t from the above eq 12 and eq 16 it is clear that 17 g  p g  p 1 k s p 1 according to the mathematical properties of the expectation of the discrete random variables the right side of the eq 12 can be expressed as 18 e g  p  p g  p pr  p k n j  p 1 k g  p 1 k s p 1 pr p 1 p 1 k pr  p 1 k k n j p 1 k  p 1 k g  p 1 j s p 1 pr  p 1 k k n j p 1 k  p 1 k g  p 1 k pr  p 1 k k n j p 1 k s p 1  p 1 k pr  p 1 k in the above proof pr  p is the probability that the walker moves along the route  p pr p 1 p 1 k is the probability with which the walkers moves from point p 1 to point p 1 k which is equal to p 1 k since s p 1 has nothing to do with k eq 18 can be rewritten as 19 e g  p k n j p 1 k  p 1 k g  p 1 k pr  p 1 k k n j p 1 k s p 1 k n j p 1 k u p 1 k s p 1 thus eq 15 is proved which means that eq 13 holds good 2 3 numerical evaluation of water level functions via rwp theoretically the function f p t in eq 12 can be arbitrary and here it is taken as the known water level z l t at the boundary the average value of all the random variables  1  n  n rs can be deemed equal to the mathematical expectation if the number of rwp simulations n rs is large enough according to the large number theorem after conducting a large number of monte carlo simulations one can get 20 z j 1 n rs n 1 n rs  n 1 n rs l 1 nt d l z l t 1 n rs s j h j s j where t denotes the terminal value d l and z l t is the number of walkers ending up at the external boundaries and the corresponding terminal water level respectively s j h j s j is the source accumulations in all realizations and h j is the number of occurrences of walkers at the corresponding source item point the values of d l and h j are obtained statistically in summary realization of a rwp simulation can be conducted according to the following workflow 1 define the basic global equation and get the transition formulation 2 define the random wandering function eq 12 3 conduct monte carlo numerical tests a place a walker at the point p and begin to simulate a random walk path starting from point p b generate a random number with a value in the interval 0 1 and judge wandering directions by comparing it to the intervals of transfer probabilities 1 p j 1 k 1 k n k 1 p jk k 1 k n k p jk k 1 k n j 1 p jk 1 where n k is the index of junction node connected to junction node j the walker is then displaced to a neighboring junction node based on the wandering direction c the walker is then continuously displaced until it reaches an external boundary once one random walk path simulation is accomplished we can retrieve one simulated value  n d repeat the preceding steps to simulate a large number i e n rs of random walkers and obtain n rs simulated random values e average the random variables to estimate the expected water level 4 update the variables and proceed with backward substitution of the branch equations to calculate the remaining unknown variables at the interior cross sectional nodes the flowcharts of the traditional three step method and rwp method are illustrated in fig 3 for comparison the main differences between the two methods are marked in blue color 2 4 boundary condition the water level hydrograph function at the boundary can be directly given as the value of the water level itself however a special technique is required to treat the discharge hydrograph boundary taking the channel network in fig 2 as an example suppose that the boundary type at point 1 changes from the water level hydrograph to a discharge hydrograph according to eq 3 the flow rate at the boundary can be linearly expressed in terms of the water levels as q 1  1  1 z 1  1 z 3 by rewriting eq 3 a relationship between the water levels at the boundary and its adjacent internal junction nodes i e point 1 and point 3 can be obtained 21 z 1 p r z 3 p a q 1  1  1  1 where p r  1  1 1 and p a 1 p r the subscript r and a denotes reflection and absorption respectively  1  1 and  1 are the chasing coefficients associated with the branch 1 according to the theory proposed by maire and nguyen 2016 q 1  1  1  1 can be added to the water level at point 1 which converts the discharge at the boundary into a virtual water level z 1 q 1  1  1  1 from the probabilistic point of view there is a likelihood that the water levels at point 1 and point 3 are identical in such a circumstance the walkers that advance to point 1 are all returned to point 3 in addition there is a chance that the water level at point 1 is equal to the virtual water level z 1 in which case the walkers stop moving when they hit boundaries because the water levels are already known there we define the aforementioned processes as reflection and absorption we can then specify how the walkers should react when they hit different types of boundaries in monte carlo simulations in the case of the water level boundary the walker gets simply absorbed while meeting the boundary terminal points p t meanwhile the function of the boundary f p t is equal to the water level at point p t i e f p t z p t in the case of the discharge hydrograph boundary the walker will get reflected to an adjacent junction node with the probability p r or be absorbed with the probability p a when it meets the boundary when the walker is absorbed the calculation flowchart is the same as above the function of the discharge hydrograph boundary is determined by the virtual water level at the boundary point i e f p t z p t when  0 the discharge hydrograph boundary is equivalent to the water level hydrograph boundary and all walkers are absorbed by the boundary to summarize the difference between the discharge boundary and the water level boundary lies in the probability of reflection after computing the water levels at internal junctions the real water levels at the boundary can be obtained by substituting those at adjacent junction nodes through eq 21 the rating curve boundary condition too can be linearized and treated in a similar way by specifying the initial water level and initial flow rate in the channel system the initial condition is provided li et al 2020 pu et al 2012 3 numerical results and discussion to assess the performance of the rwp method three numerical tests are presented in this section hec ras hydrologic engineering center river analysis system is an engineering model for the solution of the saint venant equations which was developed by the u s army corps of engineers hec ras has been verified in numerous applications liu and hodges 2014 and is used to generate benchmark solutions in this article to evaluate the efficacy of rwp method the first two benchmark tests are used to test the performance of the rwp method for the looped channel system under different boundary conditions the third one is to test the performance for the dendritic and divergent channel system and to show the advantages of terminal weights in quantitatively evaluating the influence of the conditions at various boundaries on the channel s interior flows 3 1 test case 1 the applicability of the rwp method is first checked in the context of a looped channel network as seen in fig 4 brunner 2018 the split in the main channel spruce creek forms two streams bear run and middle spruce creek which later join together spruce creek is approximately 610 m long and bear run is approximately 450 m long the manning s roughness coefficient for the main channel and flood plain are 0 04 s m 1 3 and 0 08 s m 1 3 respectively the reader may refer to the hec ras application guide for more detailed geometric data the looped network example in the hec ras application manual considers a steady state setup to study the characteristics of the rwp model under unsteady conditions with the pure water level hydrograph boundaries the steady discharge of 8 459 m3 s at the upstream boundary was changed to be time variant in hec ras the final upstream boundary condition used was the water level hydrograph calculated by hec ras as shown in fig 5 the downstream condition remains the same with a constant water level of 6 66 m the initial condition of water level is 6 66 m throughout the whole river system the calculation duration is 24 h and t is 60 s the results are compared with those from hec ras for the reader s convenience the boundary cross sections and types of boundary conditions involved in this study are listed in table 1 3 1 1 errors of the rwp method the errors were found to generally fall as the number of random experiments increases the results of rwp computations are compared with the hec ras solutions at time t 6 h t 12 h and t 24 h in fig 6 the rmse root mean square error and mape mean absolute percentage error are adopted to quantify the deviation of the rwp solutions from the hec ras solutions the rmse is defined as rmse j 1 np z j rwp z j 2 np where z j rwp is the water level at the j th junction node and z j is the true value calculated by hec ras the mape is defined as mape j 1 np z j rwp z j z j np where np is the total number of junction nodes the corresponding rmse and mape are listed in table 2 if the number of random experiments is 5 the errors are relatively large the errors decrease as the number of random experiments increases if n rs is increased to 100 the rmse and the mape at t 12 h decrease from 0 0105 m to 0 0029 m and from 0 13 to 0 04 respectively see table 2 the error distribution along the channel at fixed times t 6 h for example fig 6 a below suggests that n rs 100 results in larger errors compared to n rs 50 rmse increases from 0 0068 m to 0 007 m this may be due to the random errors of the stochastic model itself if n rs increases to a certain threshold value the calculated results gradually converge and the computational errors stabilize within a narrow range the stabilized computational error is comparable to the magnitude 10 3 of the random error to study the error of the stochastic process itself 50 calculations were repeated with the same number of random simulations the results are presented in fig 7 using hec ras results as reference values the median was chosen because it can better describe the central tendency of the errors to avoid the influence of extreme values if the number of random simulations is small there exists considerable instability in the results for example the fluctuations of flow errors at cross section c5 are approximately 0 03 m for n rs 25 and fall to 9 10 3 m when n rs 150 it can be concluded that when the number of random simulations is larger the range of fluctuations formed by the random process gets smaller however if the number of random simulations increases the convergence error stabilizes this is expected because more simulations eliminate the influence of random errors according to the law of large numbers however increase in the number of walks beyond a certain level does little to improve the accuracy too little simulation leads to large random errors and too many simulations take too much of time we should therefore choose a moderate simulation number n rs depending upon the accuracy needed 3 1 2 discharge and flow partition the rwp predicted discharges are compared with the hec ras solutions at t 6 h and t 24 h in fig 8 unsurprisingly an increase in the simulation number reduces the errors of the solution when n rs 100 the relative flow error is in the range of 5 see fig 8 channel bifurcations cause discharge apportioning and the prediction of flow partitioning at channel networks is important dong et al 2020 therefore the split ratio of flow which shows the percentage of discharge in middle spruce to that in bear run is also computed fig 9 shows the variation in the split ratio of flow over time for different numbers of random simulations even when n rs 5 the split ratio is close to the simulated values by hec ras this suggests that if we want to know quickly the partitioning of flow it would suffice to choose a smaller number of simulations 3 2 test case 2 here all settings are the same as in case 1 except that we change the upstream boundary conditions to a discharge hydrograph the upstream discharge hydrograph is the same as that in section 3 1 see fig 5 following the above analysis the solutions still did have random errors see fig 10 not surprisingly the random error fades away as n rs grows hence it is important to choose number of random simulations suitably under the prevailing boundary conditions the error distribution in random walk solutions seems to be different and shows an opposite trend in case 2 compared with case 1 in case 2 the error at the cross section near the upstream boundary is larger which may have resulted as the virtual water level was derived from discharge referred to in subsection 2 4 3 3 test case 3 a hypothetical network consisting of the dendritic and divergent channel system is shown in fig 11 fig 11 shows a discharge with a constant condition that has been pre calculated by hec ras as an initial discharge condition relevant features of the channels are given in table 3 the upstream node 4 1 and node 5 1 and downstream node 3 6 and node 10 11 water level boundary conditions are held constant at 5 01 m and 5 m respectively the boundary condition at node 8 1 is firstly specified with a non constant discharge process in hec ras as illustrated in fig 12 same as in test case 1 case 3 uses the water level hydrograph see fig 12 calculated by hec ras as all other boundary conditions the water level errors can be ignored in this test case because the magnitude of the change in water level is minimal for simplicity we only demonstrate the results of the discharge calculation here the discharges at node 7 1 node 6 1 and node 3 6 are compared to the simulated values of hec ras as illustrated in fig 13 and fig 14 they show the effects of different parameters fig 13 presents the effect of the number of simulations and initial conditions on the calculation results the initial condition of water level is 5 m throughout the whole channel system two initial conditions of discharge in the channel network are tested here 1 steady condition shown in fig 11 calculated by hec ras with constant water levels of 5 01 m and 5 m at the upstream and downstream boundaries respectively 2 q 0 m3 s along all the branches in the case of initial condition 1 when n rs 5 and 50 the discharge values calculated by rwp match well with those calculated by hec ras although there are apparent fluctuations when n rs 5 the calculated discharge tended to be to a certain extent consistent with the solution given by hec ras the stochastic error can be eliminated or decreased by smoothing techniques in the case of initial condition 2 the fairly large error at the beginning is due to the inaccurate initial conditions studies have pointed out that the three step algorithms could be unstable when the initial conditions are inaccurate or the time step is not carefully chosen zhu et al 2011 and references therein however if we are more concerned with the constant flow state of the channel network under hydraulic control operation this is not a major issue the inadequate initial conditions could be trivial and the solution is affected only by the imposed boundary conditions after the spin up time the effect of the time step is illustrated in fig 14 according to fig 14 the time step barely affects the accuracy and convergence 3 4 boundary effects in subsection 2 2 it was mentioned that the internal nodal water level can be expressed by linear combinations of water levels at known boundaries the terminal weight d k n rs describes the possibility of walkers starting from the calculated point to end at a certain boundary this random walk process is a markov chain and is reversible as a result the path starting from an internal node that ends at a boundary is equivalent to that starting from the boundary and ending at the interior node in numerous experiments the frequency of paths from a boundary that arrive at internal nodes reveals the extent of the boundary s influence on the water level at those nodes then the boundary effect which specifies the contribution of the boundary condition to the water level at a junction node can be reflected by the terminal weights the boundary effect found in case 1 and case 3 are illustrated in fig 15 case 1 and case 2 have very similar results about the boundary effect so case 2 is not discussed here there are only two boundaries in case 1 upstream condition plays a leading role in influencing the water level in node 1 in other words this point is hardly influenced by the downstream backwater effect in contrast junction node 2 is affected by the combination of upstream and downstream conditions the upstream effect first increases and then decreases consistently in accordance with the upstream flow rate trend in case 3 the boundary effects compete with each other this phenomenon may arise from the backwater effects especially in the plain river network area case 3 also shows that the boundary effects barely vary although the boundary condition at node 8 1 is time variant this near constant influence may result as the water level fluctuations are small for low discharge conditions in the plain river network area the terminal weights can act as a simple and effective tool in the sensitivity analysis of flooding problems mazzoleni et al 2018 pappenberger et al 2006 tang et al 2020 3 5 computational time and efficiency computational efficiency is one of the most critical aspects of an algorithm table 4 lists the computational times of the rwp method hec ras and the traditional three step method owing to the randomness the repetition calculation time of the rwp method is not always the same the values of the rwp method listed in table 4 are the averages of 50 runs the numbers in brackets indicate the times for solving the equations excluding the computational costs for equation initialization and problem setup as mentioned above the main difference between the rwp method and the conventional three step method is matrix solving fig 3 hec ras uses a sparse matrix solution technique to solve the equations directly rather than reduce the order of the matrix brunner 2016 to better study the efficiency of rwp the traditional three step method with the gaussian elimination algorithm as a global matrix solver sen and garg 2002 is also used here for the comparison all the numbers listed here exclude the time of post processing table 4 shows that the computational cost increases as n rs increases in both cases the computational efficiency of the traditional three step and rwp methods seems larger than that of hec ras as the code is not open source we can only presume that hec ras adopts the approach of solving the system of equations directly if n rs 5 the computational cost of the rwp method is the lowest for n rs 50 and n rs 100 rwp is less efficient than the traditional three step method which is based on the linear matrix solver owing to the reflectivity of the flow boundary walkers may be reflected at the boundary thereby increasing the wandering time therefore the computational times of the test cases with discharge hydrograph boundary conditions were generally longer than those with water level hydrograph boundary conditions however the marginally higher cost of the rwp method in table 4 does not give the full story of the rwp method in comparison with the traditional method due to the inherent properties of the monte carlo simulation the rwp method is more robust and suitable for parallel computation a recent study demonstrated that the time cost can be significantly reduced by up to 92 6 by applying the rwp method to transient groundwater flow problems nan et al 2020 therefore the rwp computation has a great potential for speedup one can choose the number of random simulations depending on the required precision in some specific cases it is essential to know quickly the split ratio of flow and the general trend of changes in the flow in that case a small n rs will be appropriate because it requires a short computational time the high computational efficiency is required for repeated simulations during the process of optimization in water resources management tian et al 2019 xu et al 2011 although the rwp method has no obvious advantages in a single simulation the total computational costs in case of repeated simulations are expected to be greatly reduced thanks to the physical meaning of the terminal weights mentioned in sec 3 4 they can be used in advance to reduce the computational burden by imposing constraints to the ranges of parameters which can instantly disregard pumps that have little effects on the internal water levels they can also be used to rank the pumping effectiveness 4 conclusions in this study a random walk path method was developed for unsteady flows in open channel networks considering different boundary conditions it can provide reliable results for flows in both looped and dendritic channel networks this method skips the global matrix solution and quickly yields the junction water levels by adopting monte carlo simulations hence this method requires smaller computer storage than the traditional three step method this method s computational efficiency depends upon the number of simulations and the length of the walk the reflectivity of the discharge boundary leads to an increase in the walking length thereby increasing the computation time as compared with the pure water level hydrograph boundary although larger number of random simulations improves the precision doing this increases the computational time it is necessary to choose this parameter n rs aptly by considering the trade off between precision and computational efficiency a small number of random simulations such as n rs 5 seems to be a good choice when a quick rough estimate of the flow is needed in the future parallel algorithms can be implemented to improve the speed of computation furthermore the rwp is able to quantify the water level dependence among junctions the by product of the rwp method is the terminal weights which can be used to quantitatively evaluate the influence of the conditions at various boundaries on the channel s interior flows hence one can estimate the area flooded due to the backwater effects furthermore these quantitative assessments can be useful to optimize the operations of hydraulic structures to reduce flood hazards for river networks controlled by numerous sluice gates and pumps the location of such engineering devices which play key roles can then be easily identified therefore this method is able to improve the computational efficiency in the optimization phase additional studies will be carried out in future to better understand the properties of the terminal weights for time invariant weights the linearized water level relationships can be pre calculated in engineering applications it will then be possible to develop a rwp framework that undertakes efficient recalculations of the flows subjected to different combinations of the boundary conditions declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was funded by national key r d program of china grant no 2022yfc3200032 the national natural science foundation of china grant nos u2040205 u2240209 and 52079044 the 111 project grant no b17015 and the fok ying tung education foundation grant no 520013312 the authors would like to thank professor bidya sagar pani of the indian institute of technology bombay for his help in revising this work and thank dr haitong zhang for his help in computer programming thanks are also extended to dr hao cao of hohai university and professor jiabiao wang of sun yat sen university for their valuable advice appendix a coefficients in the discretized saint venant equations a1 as 1 cs 1  a2 bs 1 ds 1  x 4  t l t i l t i 1 a3 es 1 q i 1 q i as 1 q i bs 1 z i cs 1 q i 1 ds 1 z i 1 a4 as 2  q i 1 4 g d i 2 d i 1 2 1 a i 1 a i 1 1 2  t 2   x v i a5 b s 2 1 2 d i 2 d i 1 2  x 1 2 g 1 a i 1 a i 1  x v i 2 l t i  2 g l t i a i 2 1 x v i q i v i 1 q i 1  d i k r 2 3 3 5 l t 2 r p z i z i z i 1 x 1 2 g 1 a i 1 a i 1 1 x v i q i v i 1 q i 1 a6 cs 2  q i 1 1 4 g d i 2 d i 1 2 1 s i 1 s i 1 1 2  t 2   x v i 1 a7 d s 2 1 2 d i 2 d i 1 2  x 1 2 g 1 a i 1 a i 1  x v i 1 2 l t i 1  2 g l t i 1 a i 1 2 1 x v i q i v i 1 q i 1  d i 1 k r 2 3 3 5 l t 2 r p z i 1 z i z i 1 x 1 2 g 1 a i 1 a i 1 1 x v i q i v i 1 q i 1 a8 es 2 1 2 q i q i q i 1 q i 1 1 2 d i 2 d i 1 2 z i z i 1  x 1 2 g 1 a i 1 a i 1 1  x v i q i v i 1 q i 1 as 2 q i bs 2 z i cs 2 q i 1 ds 2 z i 1 where i and i 1 denote the locations of the cross section  is preissmann weighting coefficient q is the volumetric discharge z is the water level l t is the river width t is time v is the velocity a is the flow area of cross section g 9 81 m s 2 is the gravitational acceleration d is the conveyance function p is wetted perimeter r is hydraulic mean depth appendix b constraint of probability non negativity substitute coefficients in appendix a into eq 3 and then eq 6 the transition probabilities can be written in the form as follow b1 p ds 2  bs 1 cs 2 cs 2 as 2 ds 1  bs 1 cs 2 cs 2 as 2 bs 2  bs 1 as 2 cs 2 as 2 or b2 p bs 2  bs 1 as 2 cs 2 as 1 ds 2  bs 1 cs 2 cs 2 as 1 bs 2  bs 1 as 2 cs 2 as 1 two assumptions are adopted here a given the magnitude the friction term is ignored in cs 2 as 1 we can get cs 2 as 1 0 b assuming s i s j and retaining the first term of the convection term one has b3 bs 2  bs 1 cs 2  2 2  x d i 2 d j 2 1 fr i 2  x 2  2 2 gh j  t 1 2  t 2   x v j b4 ds 2  bs 1 as 2  2 2  x d i 2 d j 2 1 fr j 2  x 2  2 2 gh i  t 1 2  t 2   x v i probability non negativity holds if eq b3 and eq b4 are the same as positive and negative signs considering the constraint of low fr these two equations should be all positive that requires  x 2  2 2 gh  t 1 2  t 2   x v fr 2 1 
2641,the random walk path method rwp is a stochastic model that transforms the solution of the unsteady open channel flow equations into a probability problem in this paper this method is introduced to solve the discretized saint venant equations with probabilistic representation of the water levels at junctions different boundary conditions which specify either water levels or discharge hydrographs can be implemented by specifying how walkers react when arriving at the boundaries the pointwise solution at river junctions can be obtained via random walk simulations the efficacy of the model was verified against the following test cases 1 a real world looped channel example documented in the manual of the software hec ras and 2 a hypothetical channel system consisting of dendritic and divergent networks the number of random simulations is an important aspect of the rwp method and needs to be chosen by considering the trade off between precision and computational efficiency the impact of the boundary water level or discharge on the water levels at internal nodes can be quantitatively evaluated by adopting the terminal weights which present a distinct advantage of the rwp method this assessment of water levels can serve as a guide in the operation of hydraulic controls such as dams sluices and pumps to effectively regulate the flow in mitigating flood risks keywords random walk path unsteady flow saint venant equations open channel channel networks data availability data will be made available on request 1 introduction modelling of unsteady flow in open channel networks plays an important role in many hydraulic applications such as flood forecasting bates and de roo 2000 beltaos et al 2012 nazari and seo 2021 drainage system design henine et al 2014 irrigation assar et al 2020 algae control fovet et al 2013 and wastewater management akella and bhallamudi 2019 numerical simulation is extensively used to study the hydrodynamic processes in channel networks by solving the one dimensional flow equations commonly known as the saint venant equations these equations cunge et al 1980 are a set of non linear partial derivative equations which are difficult to solve analytically numerical techniques are widely used in the discretization of the saint venant equations to obtain non linear algebraic equations finite difference schemes el kadi abderrezzak and paquier 2009 qi et al 2022 sen and garg 2002 are the most commonly applied techniques due to their advantages such as a small amount of computation and ease of implementation in the past two decades the finite volume method hodges 2019 kesserwani et al 2008a sarkhosh et al 2020 was widely applied to solve the saint venant equations limited mostly to 2d cases liang et al 2007 zhao et al 2019 the non linear equations are solved using iterative techniques such as the newton raphson method janicke and kost 1998 zhu et al 2011 or through linearization for modelling the flow in a single channel the coefficient matrix of the linear equation system is banded and efficient methods such as the double sweep algorithm can be used to solve the well structured matrix equation cunge et al 1980 however for a channel network the coefficient matrix does not exhibit the banded property due to difficulties in generating a coefficient matrix of the minimum bandwidth considering the role of junctions directly solving these coefficient matrices usually requires considerable computational time and computer storage some attempts have been made in the past to simplify these complicated or extremely large coefficient matrices with the initial research focused on dendritic channel networks the separate segment method akan and yen 1981 fread 1973 was used to split the channels network into overlapping and independent components for computation however it needed a large number of iterations and failed to accurately describe the physical phenomena near channel junctions some scholars transformed the matrix into formats that were suitable for the double scan algorithm techniques such as matrix diagonalization or recursive equations choi and molinas 1993 in addition specific node numbering was used to obtain banded matrices with reduced bandwidth nguyen and kawano 1995 thus all the above algorithms have very specific requirements regarding the topology or node numbering of the channel network and cannot be applied easily to networks containing loops the three step algorithm is a generalized algorithm for unsteady flow modelling which is suitable for any type of channel network fang et al 2012 sen and garg 2002 sen and garg 1998 zhang and shen 2007 this algorithm splits the channel network into segments the end node variables of each channel are calculated first followed by the solution for variables at all other sections by a backward substitution this method improves the computational efficiency by reducing the order of the computational matrix however the entire set of equations needs to be solved simultaneously and thus the advantage of the banded nature is lost zhu et al 2011 another problem with the three step algorithm is that it is difficult to explicitly check the individual contributions of model components in the absence of additional tools for sensitivity analysis the random walk path method rwp is a method 0f solving mathematical problems via random walk simulations the basic idea of the rwp method is to establish a random walk process whose parameters are linked to the solution of the equation the statistical characteristics of the parameters which yield the exact value of the solution can be obtained through sampling experiments there are distinctions between this method and the particle tracking method which is a typical mesh free approach for modelling contaminant transport roubinet et al 2010 yang and liang 2020 although both methods are based on random motions of particles they are different in terms of the mathematical bases the particle tracking method is based on fokker planck equation labolle et al 1996 and is known as one of the lagrangian methods while the rwp method is an application of the feynman kac theorem nan and wu 2018 gave a detailed description of these two methods from a theoretical point of view to avoid confusion the method adopted in this paper is termed the rwp method for problems that are too complex to get an analytical solution or have no analytical solution the rwp method is an effective way to find a numerical solution this approach provides a new perspective for the solution of partial differential equations pdes different schemes of the rwp method have been developed in the past and applied to solve pdes of various physical processes maire and nguyen 2016 mascagni and simonov 2004 simonov and mascagni 2004 in addition the rwp method can be used to calculate the interdependence between nodes in a network known as the correlation specifically with regard to hydraulics rwp has been successfully applied for solving pdes of complicated groundwater problems and pumping well management nan et al 2020 nan and wu 2018 solving steady state problems in channel networks using the rwp method has also been well studied chen et al 2001 wang et al 2016 made an attempt to apply it to unsteady flow modelling but the consistency between the mathematical expectation of probabilistic representation and the deterministic solution was not well proven moreover only looped networks were considered and the boundary condition was restricted to the water level hydrograph this present study focuses on the rwp method applied to unsteady flow modelling of channel networks and its potential prospects in water conservancy projects management a probabilistic description of the solutions to the discretized saint venant equations is presented and its mathematical expectation has been derived this paper also presents the conditions under which they are applicable by taking into account the limitations of the transition probability the key to dealing with different boundary conditions such as water level hydrograph and discharge hydrograph is to define the reaction of the walkers when they meet the boundaries 2 methodology 2 1 basic equations and formulation of the problem the saint venant equations for open channel flows can be expressed as follows 1 q x l t z t 0 q t qv x ga z x j 0 where q m 3 s is the volumetric discharge l t m is the river width z m is the water level t s is time v m s 1 is the velocity a m 2 is the flow area of cross section g 9 81 m s 2 is the gravitational acceleration and j is the friction slope along a channel j can be expressed as j q q d 2 where d m 6 s 2 is the conveyance function among the numerous numerical schemes for solving the saint venant equations the implicit scheme has the advantage of allowing for large time steps zhu and chen 2019 and references therein in this paper eq 1 is discretized using the four point implicit preissmann scheme which exhibits good numerical stability sen and garg 2002 this scheme results in a system of nonlinear algebraic equations between cross sections i and j for each small river section which can be expressed as follows 2 as 1 i 1 q i bs 1 i 1 z i cs 1 i 1 q i 1 ds 1 i 1 z i 1 es 1 i 1 as 2 i 1 q i bs 2 i 1 z i cs 2 i 1 q i 1 ds 2 i 1 z i 1 es 2 i 1 where z i z i 1 q i and q i 1 are the water levels and discharges at cross sections i and i 1 respectively as 1 bs 1 cs 1 ds 1 es 1 as 2 bs 2 cs 2 ds 2 and es 2 are the coefficients of the discretized saint venant equations see appendix a and subscript i 1 is omitted here for the sake of brevity the forward elimination in the three step method sen and garg 2002 is used here to derive the basic simultaneous equations for a branch involving n c number of cross section 2n c 2 number of coupled equations can be established according to eq 2 the number of unknown variables is 2n c so the equations can be solved if we know two of the variables for each branch the variables corresponding to the interior cross sections are not directly connected to those corresponding to other branches therefore the end node variables of all the branches can be separated to establish global branch equations the 2n c 2 equations for a branch can be reduced to two equations involving four variables at the two ends of the branch z b 1 z b i e q b 1 and q b i e this can be achieved using the chasing method zhang and shen 2007 in other words the discharge at the first and last sections of a branch can be expressed as linear functions of the water levels as follows 3 q b 1  b  b z b 1  b z b i e q b i e  b  b z b i e  b z b 1 where the subscript denotes the location b denotes the branch index i denotes the cross section index see fig 1 e denotes the last cross section of the branch and       are the chasing coefficients the details about the derivations of these coefficients can be found in zhang and shen 2007 the next step is to reduce the number of unknowns by incorporating a boundary condition based on the mass conservation at each junction as shown in eq 4 akan and yen 1981 showed that the energy equation could be approximated by the water stage equality when the flow at the junction is subcritical as shown in eq 5 hence the water level at the junction node can be regarded to be the same as those at the nearest cross sections of the branches linked to the junction more complex conditions kesserwani et al 2008b yuan et al 2021 yuan et al 2022 are not considered in this paper 4 q q in q out 0 5 z in z out where subscript in and out denotes inflow and outflow respectively according to eq 5 the nodal water level z j the subscript indicates the location of the node can be used to represent the cross sectional water levels that are directly related to the junction for example z 1 6 z 2 6 and z 3 1 we can establish a linear relationship between the water level at a junction and those at its nearby junctions by substituting the relationship between the flow rate and the nodal water level eq 3 into eq 4 the linear nodal water level equation is as follows 6 u j z j k 1 n j u jk z jk v j where u j u jk and v j are the linearized coefficients u j is a linear combination of the chasing coefficients  and  u j is a linear combination of the chasing coefficients  and  u j is a linear combination of the chasing coefficients  and  the above nodal water level equation eq 6 can be established for each junction then a system of global equations can be established with the water levels at junction nodes as the basic unknowns 7  z s where  is the coefficient matrix s is the right hand vector z z 1 z 2 z np t is the vector containing the water level variables at all junctions and np is the total number of junction nodes the values of the junction water levels can be obtained by solving the above global equation system i e eq 7 once the end node variables are found for a branch they are substituted into the branch equations as boundary conditions to get the variables at interior nodes in this study the global equations are solved by the rwp method which is a probabilistic approach it is known that the probability of an event can be estimated by its frequency observed during a large number of experiments the key to transforming the deterministic problem into a probabilistic problem is to establish a stochastic process whose statistical quantities are equivalent to the solution to the deterministic problem these statistical quantities are calculated by implementing a statistical process after taking enough samples the approximate solution is obtained in this study the statistical quantities are obtained via monte carlo simulation a rigorous mathematical proof of the probabilistic representation is provided in the following subsection 2 2 theoretic basis of random walk path method 2 2 1 the link between transition probability formula and random walk path dividing both sides of eq 6 by u j eq 6 can be rewritten as eq 8 the transition probability formula between one junction and its adjacent junctions 8 z j k 1 n j p jk z jk s j where p jk u jk u j denotes the transition probability s j v j u j is the source term it is worth mentioning that two conditions of the transition probability formula are 1 k 1 n j p jk 1 and 2 0 p jk 1 the first condition can be met by normalization while not all conditions satisfy the prerequisite of probability non negativity the requirements that the practical application should meet are detailed in appendix b the transition probability between junction nodes is related to the strength of their correlation when it is applied to a channel network the transition probability can reveal the strength of the relationship between water levels at junctions such a strength might be related to the branch length resistance head difference and other factors between the adjacent junction nodes if the transition probability approaches zero the change of junction water level virtually does not affect the surrounding junctions this can happen when the distance between the junction is long or the resistance is too large the relevance of eq 8 can be understood from the perspective of the probabilistic process here a simple example exhibits the relationship between the deterministic formula and the random walk path consider a simple river layout as seen in fig 2 it is assumed that the water levels at boundaries z 1 z 2 z 5 and z 6 are already known whereas the values at interior junction nodes z 3 and z 4 are unknown according to eq 8 the relationship between the water levels at junction nodes 3 and 4 can be written as 9 z 3 p 31 z 1 p 32 z 2 p 34 z 4 s 3 z 4 p 43 z 3 p 45 z 5 p 46 z 6 s 4 from the perspective of a random process p jk can be deemed as the probability of a walker moving to junction node k corresponding to the subscript jk from junction node j we can set a random walk scheme based on these probabilities at node j a walker can move to its adjacent junction nodes with probability p jk and the walker continues to move based on the transition probability until it arrives at the terminal which may be node 1 2 5 or 6 then z 3 can be expressed by the weighted average of the known boundary water levels assuming all the probabilities p jk are 1 3 one can quickly solve eq 9 and then obtain eq 10 it is important to note that here the probability of 1 3 is assumed in practice the likelihood of the transfer varies from one direction to another for this condition the 3 8 and 1 8 are the likelihoods of walker starting from node 3 and ending at nodes 1 and 5 respectively for node 4 the random variable at the junction can also be written in a similar form in conclusion the random variable z j at any junction node can be expressed as in eq 11 10 z 3 3 8 z 1 3 8 z 2 1 8 z 5 1 8 z 6 9 s 3 3 s 4 8 z 4 1 8 z 1 1 8 z 2 3 8 z 5 3 8 z 6 3 s 3 9 s 4 8 11 z j l 1 nt p l z l t s j w j s j where p l denotes the existing probability z l t is a known water level at a boundary the subscript l indicates the position of the boundary and the superscript t stands for terminal nt is the number of boundary points s j is the set of source items s j w j s j is the cumulative impact of the source terms along the random walk path w j is the coefficient for the source term s j conventionally the existing probabilities p l and coefficients w j are obtained through transformation equations such as eq 9 however in a complex channel network solving matrices directly is highly time consuming the gaussian elimination procedure the standard method for solving the linear equations needs o n 3 arithmetic operations for higher order matrix operations stochastic algorithms such as the monte carlo method can be used moreover boundary effects can also be considered which is demonstrated in sec 3 5 2 2 2 a probabilistic representation of the solution of the global equations to get the relationship between the random variable z and the known water level values at boundaries monte carlo simulations are introduced in this study for each simulation a random walk path  p path p 1 p 2 p m 1 p t where the arrow denotes the direction of movement can be obtained which starts from the point p 1 with an unknown water level and terminates at an external boundary node p t with a known water level the stochastic representation of the solution implies a brownian path until the walker arrives at the boundary note that the subscript here indicates an arbitrary intermediate location of the walker rather than a precise location one can obtain many random walk paths by multiple simulations and these paths vary with simulations define a random variable  corresponding to a random route as 12  g  p s p 1 s p 2 s p m f p t where g and f are functions of the random route and boundary points respectively s p m is equal to the source term for the m th node along the random path passes through multiple trials we can get a set of random variables   1  n  n rs corresponding to different random routes the probabilistic representation of the solution at junction node p 1 is 13 z p 1 e  in other words the defined random variable   1  n  n rs has a mathematical expectation equal to the water level at the junction node if eq 13 holds then a statistical test can be performed to estimate the value of this variable z p 1 one random variable s value can be obtained from one random walk and n rs random walks simulations yield n rs random variable values with the average value serving as an approximation of z p 1 the following is a formal proof that the mathematical expectation of random variables is indeed the same as the problem s solution depending on the location of the starting point it can be divided into two cases case 1 if the starting point of a walker is a boundary node p t then it stays at point p t so the value of the defined variables  can be formulated as 14  g  p t f p t case 2 if the walker does not start from a boundary node p t then we only need to prove eq 15 to justify eq 13 15 e g  p t k 1 n j p jk z p jk s p 1 the random process  p can be thought of as consisting of two routes namely p 1 p 1 k and  p 1 k p 2 p 3 p m 1 p t for the second route  p 1 k the random variable  should have the value 16  g  p 1 k s p 2 s p m f p t from the above eq 12 and eq 16 it is clear that 17 g  p g  p 1 k s p 1 according to the mathematical properties of the expectation of the discrete random variables the right side of the eq 12 can be expressed as 18 e g  p  p g  p pr  p k n j  p 1 k g  p 1 k s p 1 pr p 1 p 1 k pr  p 1 k k n j p 1 k  p 1 k g  p 1 j s p 1 pr  p 1 k k n j p 1 k  p 1 k g  p 1 k pr  p 1 k k n j p 1 k s p 1  p 1 k pr  p 1 k in the above proof pr  p is the probability that the walker moves along the route  p pr p 1 p 1 k is the probability with which the walkers moves from point p 1 to point p 1 k which is equal to p 1 k since s p 1 has nothing to do with k eq 18 can be rewritten as 19 e g  p k n j p 1 k  p 1 k g  p 1 k pr  p 1 k k n j p 1 k s p 1 k n j p 1 k u p 1 k s p 1 thus eq 15 is proved which means that eq 13 holds good 2 3 numerical evaluation of water level functions via rwp theoretically the function f p t in eq 12 can be arbitrary and here it is taken as the known water level z l t at the boundary the average value of all the random variables  1  n  n rs can be deemed equal to the mathematical expectation if the number of rwp simulations n rs is large enough according to the large number theorem after conducting a large number of monte carlo simulations one can get 20 z j 1 n rs n 1 n rs  n 1 n rs l 1 nt d l z l t 1 n rs s j h j s j where t denotes the terminal value d l and z l t is the number of walkers ending up at the external boundaries and the corresponding terminal water level respectively s j h j s j is the source accumulations in all realizations and h j is the number of occurrences of walkers at the corresponding source item point the values of d l and h j are obtained statistically in summary realization of a rwp simulation can be conducted according to the following workflow 1 define the basic global equation and get the transition formulation 2 define the random wandering function eq 12 3 conduct monte carlo numerical tests a place a walker at the point p and begin to simulate a random walk path starting from point p b generate a random number with a value in the interval 0 1 and judge wandering directions by comparing it to the intervals of transfer probabilities 1 p j 1 k 1 k n k 1 p jk k 1 k n k p jk k 1 k n j 1 p jk 1 where n k is the index of junction node connected to junction node j the walker is then displaced to a neighboring junction node based on the wandering direction c the walker is then continuously displaced until it reaches an external boundary once one random walk path simulation is accomplished we can retrieve one simulated value  n d repeat the preceding steps to simulate a large number i e n rs of random walkers and obtain n rs simulated random values e average the random variables to estimate the expected water level 4 update the variables and proceed with backward substitution of the branch equations to calculate the remaining unknown variables at the interior cross sectional nodes the flowcharts of the traditional three step method and rwp method are illustrated in fig 3 for comparison the main differences between the two methods are marked in blue color 2 4 boundary condition the water level hydrograph function at the boundary can be directly given as the value of the water level itself however a special technique is required to treat the discharge hydrograph boundary taking the channel network in fig 2 as an example suppose that the boundary type at point 1 changes from the water level hydrograph to a discharge hydrograph according to eq 3 the flow rate at the boundary can be linearly expressed in terms of the water levels as q 1  1  1 z 1  1 z 3 by rewriting eq 3 a relationship between the water levels at the boundary and its adjacent internal junction nodes i e point 1 and point 3 can be obtained 21 z 1 p r z 3 p a q 1  1  1  1 where p r  1  1 1 and p a 1 p r the subscript r and a denotes reflection and absorption respectively  1  1 and  1 are the chasing coefficients associated with the branch 1 according to the theory proposed by maire and nguyen 2016 q 1  1  1  1 can be added to the water level at point 1 which converts the discharge at the boundary into a virtual water level z 1 q 1  1  1  1 from the probabilistic point of view there is a likelihood that the water levels at point 1 and point 3 are identical in such a circumstance the walkers that advance to point 1 are all returned to point 3 in addition there is a chance that the water level at point 1 is equal to the virtual water level z 1 in which case the walkers stop moving when they hit boundaries because the water levels are already known there we define the aforementioned processes as reflection and absorption we can then specify how the walkers should react when they hit different types of boundaries in monte carlo simulations in the case of the water level boundary the walker gets simply absorbed while meeting the boundary terminal points p t meanwhile the function of the boundary f p t is equal to the water level at point p t i e f p t z p t in the case of the discharge hydrograph boundary the walker will get reflected to an adjacent junction node with the probability p r or be absorbed with the probability p a when it meets the boundary when the walker is absorbed the calculation flowchart is the same as above the function of the discharge hydrograph boundary is determined by the virtual water level at the boundary point i e f p t z p t when  0 the discharge hydrograph boundary is equivalent to the water level hydrograph boundary and all walkers are absorbed by the boundary to summarize the difference between the discharge boundary and the water level boundary lies in the probability of reflection after computing the water levels at internal junctions the real water levels at the boundary can be obtained by substituting those at adjacent junction nodes through eq 21 the rating curve boundary condition too can be linearized and treated in a similar way by specifying the initial water level and initial flow rate in the channel system the initial condition is provided li et al 2020 pu et al 2012 3 numerical results and discussion to assess the performance of the rwp method three numerical tests are presented in this section hec ras hydrologic engineering center river analysis system is an engineering model for the solution of the saint venant equations which was developed by the u s army corps of engineers hec ras has been verified in numerous applications liu and hodges 2014 and is used to generate benchmark solutions in this article to evaluate the efficacy of rwp method the first two benchmark tests are used to test the performance of the rwp method for the looped channel system under different boundary conditions the third one is to test the performance for the dendritic and divergent channel system and to show the advantages of terminal weights in quantitatively evaluating the influence of the conditions at various boundaries on the channel s interior flows 3 1 test case 1 the applicability of the rwp method is first checked in the context of a looped channel network as seen in fig 4 brunner 2018 the split in the main channel spruce creek forms two streams bear run and middle spruce creek which later join together spruce creek is approximately 610 m long and bear run is approximately 450 m long the manning s roughness coefficient for the main channel and flood plain are 0 04 s m 1 3 and 0 08 s m 1 3 respectively the reader may refer to the hec ras application guide for more detailed geometric data the looped network example in the hec ras application manual considers a steady state setup to study the characteristics of the rwp model under unsteady conditions with the pure water level hydrograph boundaries the steady discharge of 8 459 m3 s at the upstream boundary was changed to be time variant in hec ras the final upstream boundary condition used was the water level hydrograph calculated by hec ras as shown in fig 5 the downstream condition remains the same with a constant water level of 6 66 m the initial condition of water level is 6 66 m throughout the whole river system the calculation duration is 24 h and t is 60 s the results are compared with those from hec ras for the reader s convenience the boundary cross sections and types of boundary conditions involved in this study are listed in table 1 3 1 1 errors of the rwp method the errors were found to generally fall as the number of random experiments increases the results of rwp computations are compared with the hec ras solutions at time t 6 h t 12 h and t 24 h in fig 6 the rmse root mean square error and mape mean absolute percentage error are adopted to quantify the deviation of the rwp solutions from the hec ras solutions the rmse is defined as rmse j 1 np z j rwp z j 2 np where z j rwp is the water level at the j th junction node and z j is the true value calculated by hec ras the mape is defined as mape j 1 np z j rwp z j z j np where np is the total number of junction nodes the corresponding rmse and mape are listed in table 2 if the number of random experiments is 5 the errors are relatively large the errors decrease as the number of random experiments increases if n rs is increased to 100 the rmse and the mape at t 12 h decrease from 0 0105 m to 0 0029 m and from 0 13 to 0 04 respectively see table 2 the error distribution along the channel at fixed times t 6 h for example fig 6 a below suggests that n rs 100 results in larger errors compared to n rs 50 rmse increases from 0 0068 m to 0 007 m this may be due to the random errors of the stochastic model itself if n rs increases to a certain threshold value the calculated results gradually converge and the computational errors stabilize within a narrow range the stabilized computational error is comparable to the magnitude 10 3 of the random error to study the error of the stochastic process itself 50 calculations were repeated with the same number of random simulations the results are presented in fig 7 using hec ras results as reference values the median was chosen because it can better describe the central tendency of the errors to avoid the influence of extreme values if the number of random simulations is small there exists considerable instability in the results for example the fluctuations of flow errors at cross section c5 are approximately 0 03 m for n rs 25 and fall to 9 10 3 m when n rs 150 it can be concluded that when the number of random simulations is larger the range of fluctuations formed by the random process gets smaller however if the number of random simulations increases the convergence error stabilizes this is expected because more simulations eliminate the influence of random errors according to the law of large numbers however increase in the number of walks beyond a certain level does little to improve the accuracy too little simulation leads to large random errors and too many simulations take too much of time we should therefore choose a moderate simulation number n rs depending upon the accuracy needed 3 1 2 discharge and flow partition the rwp predicted discharges are compared with the hec ras solutions at t 6 h and t 24 h in fig 8 unsurprisingly an increase in the simulation number reduces the errors of the solution when n rs 100 the relative flow error is in the range of 5 see fig 8 channel bifurcations cause discharge apportioning and the prediction of flow partitioning at channel networks is important dong et al 2020 therefore the split ratio of flow which shows the percentage of discharge in middle spruce to that in bear run is also computed fig 9 shows the variation in the split ratio of flow over time for different numbers of random simulations even when n rs 5 the split ratio is close to the simulated values by hec ras this suggests that if we want to know quickly the partitioning of flow it would suffice to choose a smaller number of simulations 3 2 test case 2 here all settings are the same as in case 1 except that we change the upstream boundary conditions to a discharge hydrograph the upstream discharge hydrograph is the same as that in section 3 1 see fig 5 following the above analysis the solutions still did have random errors see fig 10 not surprisingly the random error fades away as n rs grows hence it is important to choose number of random simulations suitably under the prevailing boundary conditions the error distribution in random walk solutions seems to be different and shows an opposite trend in case 2 compared with case 1 in case 2 the error at the cross section near the upstream boundary is larger which may have resulted as the virtual water level was derived from discharge referred to in subsection 2 4 3 3 test case 3 a hypothetical network consisting of the dendritic and divergent channel system is shown in fig 11 fig 11 shows a discharge with a constant condition that has been pre calculated by hec ras as an initial discharge condition relevant features of the channels are given in table 3 the upstream node 4 1 and node 5 1 and downstream node 3 6 and node 10 11 water level boundary conditions are held constant at 5 01 m and 5 m respectively the boundary condition at node 8 1 is firstly specified with a non constant discharge process in hec ras as illustrated in fig 12 same as in test case 1 case 3 uses the water level hydrograph see fig 12 calculated by hec ras as all other boundary conditions the water level errors can be ignored in this test case because the magnitude of the change in water level is minimal for simplicity we only demonstrate the results of the discharge calculation here the discharges at node 7 1 node 6 1 and node 3 6 are compared to the simulated values of hec ras as illustrated in fig 13 and fig 14 they show the effects of different parameters fig 13 presents the effect of the number of simulations and initial conditions on the calculation results the initial condition of water level is 5 m throughout the whole channel system two initial conditions of discharge in the channel network are tested here 1 steady condition shown in fig 11 calculated by hec ras with constant water levels of 5 01 m and 5 m at the upstream and downstream boundaries respectively 2 q 0 m3 s along all the branches in the case of initial condition 1 when n rs 5 and 50 the discharge values calculated by rwp match well with those calculated by hec ras although there are apparent fluctuations when n rs 5 the calculated discharge tended to be to a certain extent consistent with the solution given by hec ras the stochastic error can be eliminated or decreased by smoothing techniques in the case of initial condition 2 the fairly large error at the beginning is due to the inaccurate initial conditions studies have pointed out that the three step algorithms could be unstable when the initial conditions are inaccurate or the time step is not carefully chosen zhu et al 2011 and references therein however if we are more concerned with the constant flow state of the channel network under hydraulic control operation this is not a major issue the inadequate initial conditions could be trivial and the solution is affected only by the imposed boundary conditions after the spin up time the effect of the time step is illustrated in fig 14 according to fig 14 the time step barely affects the accuracy and convergence 3 4 boundary effects in subsection 2 2 it was mentioned that the internal nodal water level can be expressed by linear combinations of water levels at known boundaries the terminal weight d k n rs describes the possibility of walkers starting from the calculated point to end at a certain boundary this random walk process is a markov chain and is reversible as a result the path starting from an internal node that ends at a boundary is equivalent to that starting from the boundary and ending at the interior node in numerous experiments the frequency of paths from a boundary that arrive at internal nodes reveals the extent of the boundary s influence on the water level at those nodes then the boundary effect which specifies the contribution of the boundary condition to the water level at a junction node can be reflected by the terminal weights the boundary effect found in case 1 and case 3 are illustrated in fig 15 case 1 and case 2 have very similar results about the boundary effect so case 2 is not discussed here there are only two boundaries in case 1 upstream condition plays a leading role in influencing the water level in node 1 in other words this point is hardly influenced by the downstream backwater effect in contrast junction node 2 is affected by the combination of upstream and downstream conditions the upstream effect first increases and then decreases consistently in accordance with the upstream flow rate trend in case 3 the boundary effects compete with each other this phenomenon may arise from the backwater effects especially in the plain river network area case 3 also shows that the boundary effects barely vary although the boundary condition at node 8 1 is time variant this near constant influence may result as the water level fluctuations are small for low discharge conditions in the plain river network area the terminal weights can act as a simple and effective tool in the sensitivity analysis of flooding problems mazzoleni et al 2018 pappenberger et al 2006 tang et al 2020 3 5 computational time and efficiency computational efficiency is one of the most critical aspects of an algorithm table 4 lists the computational times of the rwp method hec ras and the traditional three step method owing to the randomness the repetition calculation time of the rwp method is not always the same the values of the rwp method listed in table 4 are the averages of 50 runs the numbers in brackets indicate the times for solving the equations excluding the computational costs for equation initialization and problem setup as mentioned above the main difference between the rwp method and the conventional three step method is matrix solving fig 3 hec ras uses a sparse matrix solution technique to solve the equations directly rather than reduce the order of the matrix brunner 2016 to better study the efficiency of rwp the traditional three step method with the gaussian elimination algorithm as a global matrix solver sen and garg 2002 is also used here for the comparison all the numbers listed here exclude the time of post processing table 4 shows that the computational cost increases as n rs increases in both cases the computational efficiency of the traditional three step and rwp methods seems larger than that of hec ras as the code is not open source we can only presume that hec ras adopts the approach of solving the system of equations directly if n rs 5 the computational cost of the rwp method is the lowest for n rs 50 and n rs 100 rwp is less efficient than the traditional three step method which is based on the linear matrix solver owing to the reflectivity of the flow boundary walkers may be reflected at the boundary thereby increasing the wandering time therefore the computational times of the test cases with discharge hydrograph boundary conditions were generally longer than those with water level hydrograph boundary conditions however the marginally higher cost of the rwp method in table 4 does not give the full story of the rwp method in comparison with the traditional method due to the inherent properties of the monte carlo simulation the rwp method is more robust and suitable for parallel computation a recent study demonstrated that the time cost can be significantly reduced by up to 92 6 by applying the rwp method to transient groundwater flow problems nan et al 2020 therefore the rwp computation has a great potential for speedup one can choose the number of random simulations depending on the required precision in some specific cases it is essential to know quickly the split ratio of flow and the general trend of changes in the flow in that case a small n rs will be appropriate because it requires a short computational time the high computational efficiency is required for repeated simulations during the process of optimization in water resources management tian et al 2019 xu et al 2011 although the rwp method has no obvious advantages in a single simulation the total computational costs in case of repeated simulations are expected to be greatly reduced thanks to the physical meaning of the terminal weights mentioned in sec 3 4 they can be used in advance to reduce the computational burden by imposing constraints to the ranges of parameters which can instantly disregard pumps that have little effects on the internal water levels they can also be used to rank the pumping effectiveness 4 conclusions in this study a random walk path method was developed for unsteady flows in open channel networks considering different boundary conditions it can provide reliable results for flows in both looped and dendritic channel networks this method skips the global matrix solution and quickly yields the junction water levels by adopting monte carlo simulations hence this method requires smaller computer storage than the traditional three step method this method s computational efficiency depends upon the number of simulations and the length of the walk the reflectivity of the discharge boundary leads to an increase in the walking length thereby increasing the computation time as compared with the pure water level hydrograph boundary although larger number of random simulations improves the precision doing this increases the computational time it is necessary to choose this parameter n rs aptly by considering the trade off between precision and computational efficiency a small number of random simulations such as n rs 5 seems to be a good choice when a quick rough estimate of the flow is needed in the future parallel algorithms can be implemented to improve the speed of computation furthermore the rwp is able to quantify the water level dependence among junctions the by product of the rwp method is the terminal weights which can be used to quantitatively evaluate the influence of the conditions at various boundaries on the channel s interior flows hence one can estimate the area flooded due to the backwater effects furthermore these quantitative assessments can be useful to optimize the operations of hydraulic structures to reduce flood hazards for river networks controlled by numerous sluice gates and pumps the location of such engineering devices which play key roles can then be easily identified therefore this method is able to improve the computational efficiency in the optimization phase additional studies will be carried out in future to better understand the properties of the terminal weights for time invariant weights the linearized water level relationships can be pre calculated in engineering applications it will then be possible to develop a rwp framework that undertakes efficient recalculations of the flows subjected to different combinations of the boundary conditions declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was funded by national key r d program of china grant no 2022yfc3200032 the national natural science foundation of china grant nos u2040205 u2240209 and 52079044 the 111 project grant no b17015 and the fok ying tung education foundation grant no 520013312 the authors would like to thank professor bidya sagar pani of the indian institute of technology bombay for his help in revising this work and thank dr haitong zhang for his help in computer programming thanks are also extended to dr hao cao of hohai university and professor jiabiao wang of sun yat sen university for their valuable advice appendix a coefficients in the discretized saint venant equations a1 as 1 cs 1  a2 bs 1 ds 1  x 4  t l t i l t i 1 a3 es 1 q i 1 q i as 1 q i bs 1 z i cs 1 q i 1 ds 1 z i 1 a4 as 2  q i 1 4 g d i 2 d i 1 2 1 a i 1 a i 1 1 2  t 2   x v i a5 b s 2 1 2 d i 2 d i 1 2  x 1 2 g 1 a i 1 a i 1  x v i 2 l t i  2 g l t i a i 2 1 x v i q i v i 1 q i 1  d i k r 2 3 3 5 l t 2 r p z i z i z i 1 x 1 2 g 1 a i 1 a i 1 1 x v i q i v i 1 q i 1 a6 cs 2  q i 1 1 4 g d i 2 d i 1 2 1 s i 1 s i 1 1 2  t 2   x v i 1 a7 d s 2 1 2 d i 2 d i 1 2  x 1 2 g 1 a i 1 a i 1  x v i 1 2 l t i 1  2 g l t i 1 a i 1 2 1 x v i q i v i 1 q i 1  d i 1 k r 2 3 3 5 l t 2 r p z i 1 z i z i 1 x 1 2 g 1 a i 1 a i 1 1 x v i q i v i 1 q i 1 a8 es 2 1 2 q i q i q i 1 q i 1 1 2 d i 2 d i 1 2 z i z i 1  x 1 2 g 1 a i 1 a i 1 1  x v i q i v i 1 q i 1 as 2 q i bs 2 z i cs 2 q i 1 ds 2 z i 1 where i and i 1 denote the locations of the cross section  is preissmann weighting coefficient q is the volumetric discharge z is the water level l t is the river width t is time v is the velocity a is the flow area of cross section g 9 81 m s 2 is the gravitational acceleration d is the conveyance function p is wetted perimeter r is hydraulic mean depth appendix b constraint of probability non negativity substitute coefficients in appendix a into eq 3 and then eq 6 the transition probabilities can be written in the form as follow b1 p ds 2  bs 1 cs 2 cs 2 as 2 ds 1  bs 1 cs 2 cs 2 as 2 bs 2  bs 1 as 2 cs 2 as 2 or b2 p bs 2  bs 1 as 2 cs 2 as 1 ds 2  bs 1 cs 2 cs 2 as 1 bs 2  bs 1 as 2 cs 2 as 1 two assumptions are adopted here a given the magnitude the friction term is ignored in cs 2 as 1 we can get cs 2 as 1 0 b assuming s i s j and retaining the first term of the convection term one has b3 bs 2  bs 1 cs 2  2 2  x d i 2 d j 2 1 fr i 2  x 2  2 2 gh j  t 1 2  t 2   x v j b4 ds 2  bs 1 as 2  2 2  x d i 2 d j 2 1 fr j 2  x 2  2 2 gh i  t 1 2  t 2   x v i probability non negativity holds if eq b3 and eq b4 are the same as positive and negative signs considering the constraint of low fr these two equations should be all positive that requires  x 2  2 2 gh  t 1 2  t 2   x v fr 2 1 
2642,identifying the dynamics of water retention wr is critical for developing adaptive strategies for effective water resources management under climate change however our understanding about the responses of wr to climate change is still limited which hinders risk assessment and warning of wr under future climate trajectories in this study we used the soil and water assessment tool swat to quantify the impact of climate change on wr in the upper heihe river basin uhrb a typical inner headwater basin and predicted the future trends and potential degradation risks of wr based on climate scenarios under three representative concentration pathways rcp2 6 rcp4 5 and rcp8 5 our results showed that the historical 1971 2020 average wr in the uhrb was approximately 91 1 mm with high wr occurring in the middle and west of the basin and low wr in the north and southeast our prediction suggested that the wr may remain stable during the near future 2021 2060 under the rcp2 6 scenario however wr may decrease by 23 and 32 during this period under the rcp4 5 and rcp8 5 respectively by the end of this century 2061 2099 the wr may decrease by 10 40 and 69 under the rcp2 6 rcp4 5 and rcp8 5 scenarios respectively due to the substantially enhanced evapotranspiration in the warming context though a slight increase in precipitation may partly offset this negative impact in brief this study provides a paradigm for assessing the dynamics and future degradation risk of water retention at watershed scale and this can be valuable and applicable for other areas keywords climate change swat watershed ecosystem risk warning data availability i have shared the link to my data in the manuscript 1 introduction the biological resources and functional services provided by ecosystems are the basis of human existence and socioeconomic development zhang et al 2001 jiang et al 2015 gong et al 2017 as an ecosystem function water retention wr refers to the interception of rainfall by the ecosystem under specific spatiotemporal conditions lv et al 2015 and it plays an important role in regional hydrological improvement water cycle regulation and drinking water protection atalov kenderessy 2017 wr also reflects the resilience of terrestrial ecosystems to extreme droughts and floods zhai tao 2021 however climate change can affect ecosystems jones et al 2009 nolan et al 2018 meir et al 2006 and thus can lead to significant changes in the wr of an ecosystem bai et al 2019 zhai et al 2018 therefore understanding the responses of regional wr to climate change and its potential dynamics under future climate trajectories are critical to water resource management usually wr was estimated based on soil water observation zhang et al 2012 xia et al 2017 with the development of computer and geographic information system gis numerical models have become an effective way to simulate water cycle and thus can be used for estimating wr dynamics such as the variable infiltration capacity vic liang et al 1994 and soil and water assessment tool swat arnold et al 1998 for example zhai et al 2018 used four global circulation model gcm data and vic model to investigate the impacts of global warming on runoff and terrestrial ecosystem wr across china li et al 2021b evaluated the temporal and spatial dynamics of wr in china s danjiang river basin based on the integrated valuation of ecosystem services and trade offs invest model and provided an effective scheme for policy makers in water resource management based on the regional water balance equation and gis spatial analysis tools wang et al 2021 showed that the wr in xilin gol league correlated with the changes in precipitation temperature and vegetation coverage and unfavorable changes in these factors led to a significant decline in regional water conservation capacity glavan et al 2013 investigated the influence of land use change on the hydrological processes and blue green water flow in the slovenian mediterranean catchments and they found that land use change would insignificantly affect the total and green water quantity but would have considerable effects on the seasonal flows though numerous previous studies used numerical models based on the water balance equation to estimate water retention gong et al 2017 wang et al 2021 the temporal and spatial variations of water retention under climate change in arid and semi arid areas have not received adequate attention wang et al 2021 therefore the selection and implementation of ecological restoration projects are often in question due to insufficient information on water retention changes li et al 2013 wang et al 2021 climate change may affect the temporal and spatial dynamics of wr and has been identified as one of the most important drivers for ecological and environmental changes as mentioned in the report of the intergovernmental panel on climate change ipcc stocker 2014 global land surface temperature was projected to continue to rise and the global average air temperature rise may exceed 1 5 c or even 2 c in the coming decades if the atmospheric greenhouse gases continue to rise stocker 2014 schleussner et al 2016 global warming is expected to increase evapotranspiration and the frequency and intensity of extreme weather events in the 21st century sylla et al 2015 causing changes of hydrological processes and water retention dottori et al 2018 yin et al 2018 yin et al 2022 for example zhai et al 2020 showed that runoff change caused by climate change was the main factor controlling wr change in northern canada eastern united states and the east europe plain and evapotranspiration change was the dominant factor controlling wr change in northern russia wang et al 2021 pointed out that the increased evapotranspiration and drying caused by regional warming may exacerbate the grassland degradation and water retention in xilin gol league further causing streamflow change the above studies showed that climate change can influence the hydrological processes and thus can lead to the change of wr though there are some cases of assessing water retention at the regional scale during the historical period li et al 2021b wang et al 2021 how water retention will be affected by global warming in the future has been rarely studied zhai et al 2020 the upper heihe river basin uhrb is located in the arid area of the northwest china and the arid climate in the basin leads to the fragile ecological environment of the region previous studies revealed that the uhrb experienced warming and wetting trends over the past few decades wang et al 2012 wang qin 2017 but the impacts of the warmer and wetter climate on hydrological cycle and water retention were not well understood further it was projected that climate change would intensify over the 21st century with the increasing atmospheric co2 concentration thomson et al 2011 riahi et al 2011 therefore it is of importance to investigate the hydrological process and water retention changes in the uhrb in future serving rational allocation of water resources in the downstream areas the objectives of the study were to investigate the spatiotemporal changes of the wr in the uhrb under climate change based on hydrological process modeling and predict the risk of wr degradation in the rest of the 21st century 2 materials and methods 2 1 study area the heihe river basin hrb is the second largest inland basin in the northwest china yao et al 2014 and its main stream flows through the yingluo gorge into the juyan lake fig 1 a the uhrb is an important ecological barrier energy source and mineral base of china and it is also the core water source of the hexi corridor the study area covers an acreage of 9998 km2 with an elevation ranging from about 1556 to 5003 m the uhrb has a typical plateau continental climate and the annual average precipitation and temperature were about 396 mm and 0 62 c during 1971 to 2018 the uhrb is located in the middle part of the corridor nanshan anticline and the tuole mountain anticline in the qilian fold system and the north qilian caledonian eugeosyncline fold belt due to the strong activity of neotectonic movement dominated by ascent towering mountain systems and deep river valleys are formed in the area shallow metamorphic rock series are widely distributed in the valley in which fissure water is commonly found in rocks such as clastic rock formation carbonate formation and intermediate acid igneous rock formation liu 2013 in the uhrb there are three main soil types leptosols cambisols and gleysols accounting for 58 1 17 0 and 7 0 of the basin respectively the leptosols mainly covers the centrals north area and the south region the cambisols is distributed in the southeast and downstream area of the basin and the gleysols is mainly distributed in the northwest area of the basin there are also four major land use types grassland barren land shrub and forest grassland accounts for the largest portion 58 of the land use in the uhrb followed by barren land 19 shrub 12 and forest 5 5 see figure s1 in the supporting information 2 2 the swat model the swat model was developed by the united states department of agriculture usda research service arnold et al 1998 to assist water resource managers in predicting impacts of climate and land management practices on water sediment and agricultural chemicals yields this physically based watershed scale model simulates the hydrological cycle plant growth the transportation of sediment and agricultural chemical yields on a daily time step arnold et al 1998 neitsch et al 2011 the well established swat model has been successfully applied around the world for a variety of watershed issues especially under climate change at watershed scales narsimlu et al 2013 fundamentally the simulation of water cycle by swat is based on the water balance equation in the soil profile with processes including precipitation evapotranspiration infiltration surface runoff lateral flow percolation baseflow etc more detailed information about the hydrological processes simulated by swat can be found in its theoretical documentation neitsch et al 2011 2 3 the calculation of water retention the wr in the uhrb is quantified using a regional water balance equation ouyang et al 2016 wr is defined as the difference between precipitation p and evapotranspiration et plus surface runoff sr the calculation formula of wr is expressed as follow 1 wr i p i et i s r i where i is the number of hydrological response units hrus wr is the water retention mm p is the daily precipitation mm et is the evapotranspiration mm sr is the surface runoff mm et and sr are simulated by swat 2 4 swat input and setup 2 4 1 geospatial data the digital elevation model dem with the spatial resolution of 90 m was collected from the shuttle radar topography mission srtm and is available at the national tibetan plateau data center https srtm csi cgiar org the dem data was used to delineate the uhrb into 139 sub basins the soil data at 1 km resolution were collected from the national cryosphere desert data center https www ncdc ac cn the land use data at 1 km resolution was collected from the resources and environmental science data center resdc chinese academy of sciences cas https www resdc cn the multiple hydrological response units hrus were used to represent each unique field combination of land cover soil and slope as a separate unit leading to a total of 1369 hrus 2 4 2 climate data the climate data observed during the period 1960 2016 were provided by the data center of the china meteorological administration cma https data cma cn including daily maximum minimum air temperature precipitation sunshine duration wind speed and relative humidity the sunshine duration was used to calculate the solar radiation required for the swat model following the approach as described in previous studies zhang et al 2019 zhang 2019 2 5 model calibration and validation there are some parameters in swat that need to be determined for a specific basin through comparison with the observed data thiemann et al 2001 we selected nine model parameters for model calibration using the sequential uncertainty fitting version 2 sufi 2 algorithm for the parameter optimization table 1 green van griensven 2008 specifically the model was calibrated using 23 year 1971 1993 monthly streamflow and validated by observations from the subsequent 23 year 1994 2016 three statistical evaluation terms were used to assess the performance of swat including the percentage bias pb nash sutcliffe efficiency nse and coefficient of determination r2 see appendix a 2 6 future climate scenarios we drived the swat with future climate trajectories from five gcms table 2 to evaluate the future changes of hydrological components and wr the downscaled and bias corrected daily data sets precipitation and maximum minimum air temperature of five gcms gfdl esm2m hadgem2 es ipsl cm5a lr miroc and noeresm1 m were from the inter sectoral impact model inter comparison project isi mip under rcp4 5 moderate emission pathway and rcp8 5 high emission pathway hempel et al 2013 ashraf vaghefi et al 2017 for rcp2 6 low emission path the related future climae data were provided by the national cryosphere desert data center https www ncdc ac cn the validations of the future climate data were shown in figure s2 in the supporting information 2 7 early warning in this study based on the absolute difference between the predicted wr during the future period and that during the historical period we used the quartile method in statistics to determine the degradation threshold of wr and set four risk warning levels low medium high and very high 3 results 3 1 model examination a visual and numerical comparison of the simulated monthly streamflow against the observed data during the calibration and validation periods is shown in fig 2 our simulated monthly streamflow matched well with observations during both calibration r2 0 82 nse 0 81 pb 5 5 and validation r2 0 84 nse 0 83 pb 2 2 periods according to evaluation criteria for a monthly step moriasi et al 2007 the performance of streamflow simulation can be regarded as good overall the model evaluation demonstrated that our established model can be accepted for long term simulation of the hydrological cycle in the uhrb 3 2 temporal variations of the key hydrological variables precipitation increased slowly during the first 25 years 1971 1995 followed by a significant increase 3 15 1 50 mm yr 1 p 0 05 during the subsequent 25 years 1996 2020 fig 3 as shown in the box diagram on the right panel of fig 3 the average soil water of the study area was around 220 mm from 1971 to 2020 with a non significant increase from 1971 to 2020 the average evapotranspiration water yield and surface runoff were 265 mm 123 mm and 31 mm respectively among these three variables water yield and surface runoff showed significant p 0 05 variation trends with increasing rates of 0 64 0 37 and 0 22 0 11 mm yr 1 respectively 3 3 spatiotemporal changes of the wr wr exhibited an non significant uptrend of 0 50 0 61 mm yr 1 during the historical period p 0 35 fig 4 during this period the lowest wr is 5 mm occurring in 1994 and the highest value of wr of 218 mm occurred in 1998 in terms of the spatial distribution of wr as shown in fig 4b the high values of wr were mostly distributed in the middle area of the basin and most low values of wr were found in the northwest and southeast of the basin the historical and projected changes in meteorological variables air temperature and precipitation under rcp2 6 rcp4 5 and rcp8 5 are presented in fig 5 a and b the mean air temperature shows an overall upward trend during the historical period and would continue to rise in the future 2021 2099 under all rcp scenarios indicating a significant warming trend in the 21st century during the near future period 2021 2060 the annual mean temperature was projected to rise by 1 04 1 36 and 1 64 c under the rcp2 6 rcp4 5 and rcp8 5 respectively the annual mean air temperature during the far future period 2061 2099 was projected to increase by 1 18 2 32 and 3 98 c respectively specifically the annual mean air temperature in the late 21st century may be as high as 5 72 c under the rcp8 5 the average precipitation also showed an increasing trend during the historical period and may continue to increase in the future 2021 2099 under all rcp scenarios the annual precipitation in the uhrb would increase by 9 3 and 5 under the rcp2 6 rcp4 5 and rcp8 5 during the near future period respectively the annual precipitation in the uhrb may increase by 6 5 and 6 under the rcp2 6 rcp4 5 and rcp8 5 during the far future periods respectively fig 5c presents the temporal changes of wr in the uhrb under the three rcp scenarios during the future periods when compared to the baseline wr under the rcp2 6 scenario showed a slight increase 1 during the near future but decreased by 10 in the far future period under the rcp4 5 and rcp8 5 scenarios wr may decrease by 23 and 32 in the near future respectively and the decrease percentages would reach 40 and 69 in the far future respectively by the end of the 21st century the annual wr under rcp8 5 may reduce to 13 96 3 84 mm fig 6 shows the predicted future spatial patterns of wr under rcp2 6 rcp4 5 and rcp8 5 scenarios in the future the low wr levels may occur in the northeastern and southern parts of the study area while the high wr values can be found in the central regions overall the average level of wr was at the highest level under the rcp2 6 followed by rcp4 5 and rcp8 5 3 4 risk warning of future wr fig 7 shows the differences  of the basin average annual wr wr between the baseline condition and the two future periods near and far future under the three rcps a negative value of wr means that degradation occurred and the greater the absolute value of the negative wr the higher the risk level is table 3 during the near future period though wr may exhibit a non significant upward trend 0 41 mm yr 1 p 0 25 and a downward trend 0 38 mm yr 1 p 0 33 under rcp2 6 and rcp 4 5 respectively a significant downward trend of 1 18 mm yr 1 p 0 005 was found for rcp8 5 for the far future period wr may decrease non significantly under rcp4 5 and rcp8 5 but it would increase under the rcp2 6 to determine the degradation degree of wr we used the quartile method to define the risk warning levels fig 8 the acreage of areas with low and medium degradation accounted for 30 36 and 11 07 during the near future under rcp2 6 and these areas were mainly distributed in the northwest and southeast the acreage percentage for the low degradation decreased to 24 86 but medium degradation increased to 24 47 during the far future period under the rcp4 5 the area with low and medium degradation accounted for 28 55 and 37 55 of the total watershed during the near future period and the area percentage for the high degradation could reach 45 39 during the far future period mainly distributing in the central region of the basin during the future periods the air temperature would continue to increase and thereby the degradation degree was projected to be high and very high under the high emission scenario rcp8 5 the acreage percentage for the very high degradation could reach 46 29 during the far future period and the water retention would degrade substantially in the middle and northwest of the basin 4 discussion 4 1 projected hydrologic changes and influencing climate factors the precipitation air temperature evapotranspiration water yield and surface runoff in the uhrb showed increasing trends but soil water exhibited an opposite trend during the historical period the rising temperature led to the increase in evapotranspiration but it may also contribute to the increase in streamflow caused by snow and glacier melting duethmann et al 2015 fig 9 b our study showed that the temperature in the uhrb may continue to rise in the future and rcp4 5 and rcp8 5 had a higher warming potential than rcp2 6 li et al 2021a the potential slight increase in precipitation and the rising temperature exhibit a wetter and warmer climate in the uhrb in addition evapotranspiration was projected to increase by 45 under the rcp8 5 scenario while surface runoff would decrease by 50 overall our results suggest that evapotranspiration would increase in future and thus may further aggravate the regional water stress therefore water saving measures should be taken to tackle with the potential shortage in water resources 4 2 attribution of the future changes in wr under the three climate scenarios wr may increase under the rcp2 6 but decrease under the other scenarios in the near future wr decreases with the increase of temperature in the northwest area of the uhrb where rainfall and vegetation coverage are relatively low the decrease of water holding capacity of litters also leads to the decrease of wr sun et al 2018 forest canopy interception is an essential part of wr li et al 2021b altitude and latitude affect forest canopy interception through precipitation distribution as shown in fig 6 wr is low in the northwestern regions with relative higher elevations in addition areas with deeper soil will hold more water after precipitation and the accumulated soil water gradually drain through lateral flow and baseflow therefore the wr is larger in the middle of the study area with a thicker soil layer but lower in the northwestern part with a thinner soil and higher elevation some areas of the uhrb exhibited a medium degree of wr degradation under the rcp2 6 during the future periods but the degradation degree with very high may occur by the end of this century under rcp8 5 it should be noted that the soil water and water yield during the future periods showed a downward trend however the continuous rise of temperature in this region projected during the 21st century conditions may be less conducive for wr and the threat of wr degradation may substantially increase it needs to emphasize that warming is just one driver of future wr risk in this region future changes in other climate conditions e g extreme climate events and the increase of ecosystem vulnerability may potentially lead to various risk scenarios threating the regional water safety therefore we appeal to remain flexible and alert to the new challenges of wr that could emerge under a warmer climate 4 3 uncertainties and limitations there are some uncertainties and limitations in our study first of all the spatial distribution of wr at regional scale depends on multiple influencing factors wu et al 2021 yin et al 2022 although the key driving factors such as meteorological elements land use types soil types and topography were considered in our study other potential drivers such as forest density forest age vegetation litter capacity agricultural water practices and water management may also affect the wr land use is an important factor especially in those areas with substantial changes however this study area is an ecological nature reserve with little human disturbance see figure s3 in the supporting information and this study focused on climate change impacts on water retention nonetheless we acknowledge the potential limitation that may be caused by excluding land use change in our design second there are also great uncertainties the gcm data buytaert et al 2009 wu et al 2012 woldemeskel et al 2014 many studies reported that over reliance on a single gcm may leads to inappropriate predictions li jin 2017 vousdoukas et al 2018 though the ensemble average precipitation and temperature from gcms showed good consistence with the cma based observations and the results were close to a previous study li et al 2021a it is indeed difficult to predict climate change accurately in the future because the sophisticated climate system in addition we did not consider future land use change and potential anthropogenic activities that may also influence the water retention and this would be a good subject of our future study 5 conclusions in this study we investigated the spatiotemporal changes of the wr under climate change based on hydrological process modeling and predicted the risk of wr degradation in the upper heihe river basin the climate projections showed that the precipitation would slightly increase and warming may continue under all three rcp scenarios the negative impact of warming induced increase of evapotranspiration was greater than the positive impact of increased precipitation on wr leading to degradation of wr in the uhrb the wr will decrease by 10 40 and 69 under rcp2 6 rcp4 5 and rcp8 5 scenarios respectively in particular the degradation degree of the wr under the rcp8 5 scenario is the most serious areas with high and very high degradation would account for 68 56 of the basin during the far future period this study provided a framework by combining the spatiotemporal dynamics assessment and future degradation risk prediction and warning to assess the dynamics and future risk of the water retention in a typical inner headwater basin our framework can be valuable for evaluating the historical and future spatiotemporal variation of water retention and the degradation risk at the watershed scale in summary our quantitative assessment can provide valuable guidance for rational allocation of water resources and ecosystem management in headwater areas under a shifting climate emphasizing the importance of ecological protection in the headwater area credit authorship contribution statement guangchuang zhang conceptualization methodology data curation formal analysis writing original draft yiping wu conceptualization project administration writing review editing supervision huiwen li writing review editing wenzhi zhao project administration funding acquisition fan wang data curation methodology ji chen writing review editing bellie sivakumar writing review editing shuguang liu writing review editing linjing qiu review visualization wenke wang resources declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this study was funded by the national key research and development program of china 2019yfc0507403 the technology innovation center for land engineering and human settlements shaanxi land engineering construction group co ltd and xi an jiaotong university 201912131 b2 the national science foundation of china 42271025 and 31961143011 shaanxi key research and development program 2022zdlsf06 04 the innovation team of shaanxi province 2021td 52 the national thousand youth talent program of china and the shaanxi hundred talent program we also thank the hpcc platform in xi an jiaotong university for computing equipment and computer maintenance appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128717 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2642,identifying the dynamics of water retention wr is critical for developing adaptive strategies for effective water resources management under climate change however our understanding about the responses of wr to climate change is still limited which hinders risk assessment and warning of wr under future climate trajectories in this study we used the soil and water assessment tool swat to quantify the impact of climate change on wr in the upper heihe river basin uhrb a typical inner headwater basin and predicted the future trends and potential degradation risks of wr based on climate scenarios under three representative concentration pathways rcp2 6 rcp4 5 and rcp8 5 our results showed that the historical 1971 2020 average wr in the uhrb was approximately 91 1 mm with high wr occurring in the middle and west of the basin and low wr in the north and southeast our prediction suggested that the wr may remain stable during the near future 2021 2060 under the rcp2 6 scenario however wr may decrease by 23 and 32 during this period under the rcp4 5 and rcp8 5 respectively by the end of this century 2061 2099 the wr may decrease by 10 40 and 69 under the rcp2 6 rcp4 5 and rcp8 5 scenarios respectively due to the substantially enhanced evapotranspiration in the warming context though a slight increase in precipitation may partly offset this negative impact in brief this study provides a paradigm for assessing the dynamics and future degradation risk of water retention at watershed scale and this can be valuable and applicable for other areas keywords climate change swat watershed ecosystem risk warning data availability i have shared the link to my data in the manuscript 1 introduction the biological resources and functional services provided by ecosystems are the basis of human existence and socioeconomic development zhang et al 2001 jiang et al 2015 gong et al 2017 as an ecosystem function water retention wr refers to the interception of rainfall by the ecosystem under specific spatiotemporal conditions lv et al 2015 and it plays an important role in regional hydrological improvement water cycle regulation and drinking water protection atalov kenderessy 2017 wr also reflects the resilience of terrestrial ecosystems to extreme droughts and floods zhai tao 2021 however climate change can affect ecosystems jones et al 2009 nolan et al 2018 meir et al 2006 and thus can lead to significant changes in the wr of an ecosystem bai et al 2019 zhai et al 2018 therefore understanding the responses of regional wr to climate change and its potential dynamics under future climate trajectories are critical to water resource management usually wr was estimated based on soil water observation zhang et al 2012 xia et al 2017 with the development of computer and geographic information system gis numerical models have become an effective way to simulate water cycle and thus can be used for estimating wr dynamics such as the variable infiltration capacity vic liang et al 1994 and soil and water assessment tool swat arnold et al 1998 for example zhai et al 2018 used four global circulation model gcm data and vic model to investigate the impacts of global warming on runoff and terrestrial ecosystem wr across china li et al 2021b evaluated the temporal and spatial dynamics of wr in china s danjiang river basin based on the integrated valuation of ecosystem services and trade offs invest model and provided an effective scheme for policy makers in water resource management based on the regional water balance equation and gis spatial analysis tools wang et al 2021 showed that the wr in xilin gol league correlated with the changes in precipitation temperature and vegetation coverage and unfavorable changes in these factors led to a significant decline in regional water conservation capacity glavan et al 2013 investigated the influence of land use change on the hydrological processes and blue green water flow in the slovenian mediterranean catchments and they found that land use change would insignificantly affect the total and green water quantity but would have considerable effects on the seasonal flows though numerous previous studies used numerical models based on the water balance equation to estimate water retention gong et al 2017 wang et al 2021 the temporal and spatial variations of water retention under climate change in arid and semi arid areas have not received adequate attention wang et al 2021 therefore the selection and implementation of ecological restoration projects are often in question due to insufficient information on water retention changes li et al 2013 wang et al 2021 climate change may affect the temporal and spatial dynamics of wr and has been identified as one of the most important drivers for ecological and environmental changes as mentioned in the report of the intergovernmental panel on climate change ipcc stocker 2014 global land surface temperature was projected to continue to rise and the global average air temperature rise may exceed 1 5 c or even 2 c in the coming decades if the atmospheric greenhouse gases continue to rise stocker 2014 schleussner et al 2016 global warming is expected to increase evapotranspiration and the frequency and intensity of extreme weather events in the 21st century sylla et al 2015 causing changes of hydrological processes and water retention dottori et al 2018 yin et al 2018 yin et al 2022 for example zhai et al 2020 showed that runoff change caused by climate change was the main factor controlling wr change in northern canada eastern united states and the east europe plain and evapotranspiration change was the dominant factor controlling wr change in northern russia wang et al 2021 pointed out that the increased evapotranspiration and drying caused by regional warming may exacerbate the grassland degradation and water retention in xilin gol league further causing streamflow change the above studies showed that climate change can influence the hydrological processes and thus can lead to the change of wr though there are some cases of assessing water retention at the regional scale during the historical period li et al 2021b wang et al 2021 how water retention will be affected by global warming in the future has been rarely studied zhai et al 2020 the upper heihe river basin uhrb is located in the arid area of the northwest china and the arid climate in the basin leads to the fragile ecological environment of the region previous studies revealed that the uhrb experienced warming and wetting trends over the past few decades wang et al 2012 wang qin 2017 but the impacts of the warmer and wetter climate on hydrological cycle and water retention were not well understood further it was projected that climate change would intensify over the 21st century with the increasing atmospheric co2 concentration thomson et al 2011 riahi et al 2011 therefore it is of importance to investigate the hydrological process and water retention changes in the uhrb in future serving rational allocation of water resources in the downstream areas the objectives of the study were to investigate the spatiotemporal changes of the wr in the uhrb under climate change based on hydrological process modeling and predict the risk of wr degradation in the rest of the 21st century 2 materials and methods 2 1 study area the heihe river basin hrb is the second largest inland basin in the northwest china yao et al 2014 and its main stream flows through the yingluo gorge into the juyan lake fig 1 a the uhrb is an important ecological barrier energy source and mineral base of china and it is also the core water source of the hexi corridor the study area covers an acreage of 9998 km2 with an elevation ranging from about 1556 to 5003 m the uhrb has a typical plateau continental climate and the annual average precipitation and temperature were about 396 mm and 0 62 c during 1971 to 2018 the uhrb is located in the middle part of the corridor nanshan anticline and the tuole mountain anticline in the qilian fold system and the north qilian caledonian eugeosyncline fold belt due to the strong activity of neotectonic movement dominated by ascent towering mountain systems and deep river valleys are formed in the area shallow metamorphic rock series are widely distributed in the valley in which fissure water is commonly found in rocks such as clastic rock formation carbonate formation and intermediate acid igneous rock formation liu 2013 in the uhrb there are three main soil types leptosols cambisols and gleysols accounting for 58 1 17 0 and 7 0 of the basin respectively the leptosols mainly covers the centrals north area and the south region the cambisols is distributed in the southeast and downstream area of the basin and the gleysols is mainly distributed in the northwest area of the basin there are also four major land use types grassland barren land shrub and forest grassland accounts for the largest portion 58 of the land use in the uhrb followed by barren land 19 shrub 12 and forest 5 5 see figure s1 in the supporting information 2 2 the swat model the swat model was developed by the united states department of agriculture usda research service arnold et al 1998 to assist water resource managers in predicting impacts of climate and land management practices on water sediment and agricultural chemicals yields this physically based watershed scale model simulates the hydrological cycle plant growth the transportation of sediment and agricultural chemical yields on a daily time step arnold et al 1998 neitsch et al 2011 the well established swat model has been successfully applied around the world for a variety of watershed issues especially under climate change at watershed scales narsimlu et al 2013 fundamentally the simulation of water cycle by swat is based on the water balance equation in the soil profile with processes including precipitation evapotranspiration infiltration surface runoff lateral flow percolation baseflow etc more detailed information about the hydrological processes simulated by swat can be found in its theoretical documentation neitsch et al 2011 2 3 the calculation of water retention the wr in the uhrb is quantified using a regional water balance equation ouyang et al 2016 wr is defined as the difference between precipitation p and evapotranspiration et plus surface runoff sr the calculation formula of wr is expressed as follow 1 wr i p i et i s r i where i is the number of hydrological response units hrus wr is the water retention mm p is the daily precipitation mm et is the evapotranspiration mm sr is the surface runoff mm et and sr are simulated by swat 2 4 swat input and setup 2 4 1 geospatial data the digital elevation model dem with the spatial resolution of 90 m was collected from the shuttle radar topography mission srtm and is available at the national tibetan plateau data center https srtm csi cgiar org the dem data was used to delineate the uhrb into 139 sub basins the soil data at 1 km resolution were collected from the national cryosphere desert data center https www ncdc ac cn the land use data at 1 km resolution was collected from the resources and environmental science data center resdc chinese academy of sciences cas https www resdc cn the multiple hydrological response units hrus were used to represent each unique field combination of land cover soil and slope as a separate unit leading to a total of 1369 hrus 2 4 2 climate data the climate data observed during the period 1960 2016 were provided by the data center of the china meteorological administration cma https data cma cn including daily maximum minimum air temperature precipitation sunshine duration wind speed and relative humidity the sunshine duration was used to calculate the solar radiation required for the swat model following the approach as described in previous studies zhang et al 2019 zhang 2019 2 5 model calibration and validation there are some parameters in swat that need to be determined for a specific basin through comparison with the observed data thiemann et al 2001 we selected nine model parameters for model calibration using the sequential uncertainty fitting version 2 sufi 2 algorithm for the parameter optimization table 1 green van griensven 2008 specifically the model was calibrated using 23 year 1971 1993 monthly streamflow and validated by observations from the subsequent 23 year 1994 2016 three statistical evaluation terms were used to assess the performance of swat including the percentage bias pb nash sutcliffe efficiency nse and coefficient of determination r2 see appendix a 2 6 future climate scenarios we drived the swat with future climate trajectories from five gcms table 2 to evaluate the future changes of hydrological components and wr the downscaled and bias corrected daily data sets precipitation and maximum minimum air temperature of five gcms gfdl esm2m hadgem2 es ipsl cm5a lr miroc and noeresm1 m were from the inter sectoral impact model inter comparison project isi mip under rcp4 5 moderate emission pathway and rcp8 5 high emission pathway hempel et al 2013 ashraf vaghefi et al 2017 for rcp2 6 low emission path the related future climae data were provided by the national cryosphere desert data center https www ncdc ac cn the validations of the future climate data were shown in figure s2 in the supporting information 2 7 early warning in this study based on the absolute difference between the predicted wr during the future period and that during the historical period we used the quartile method in statistics to determine the degradation threshold of wr and set four risk warning levels low medium high and very high 3 results 3 1 model examination a visual and numerical comparison of the simulated monthly streamflow against the observed data during the calibration and validation periods is shown in fig 2 our simulated monthly streamflow matched well with observations during both calibration r2 0 82 nse 0 81 pb 5 5 and validation r2 0 84 nse 0 83 pb 2 2 periods according to evaluation criteria for a monthly step moriasi et al 2007 the performance of streamflow simulation can be regarded as good overall the model evaluation demonstrated that our established model can be accepted for long term simulation of the hydrological cycle in the uhrb 3 2 temporal variations of the key hydrological variables precipitation increased slowly during the first 25 years 1971 1995 followed by a significant increase 3 15 1 50 mm yr 1 p 0 05 during the subsequent 25 years 1996 2020 fig 3 as shown in the box diagram on the right panel of fig 3 the average soil water of the study area was around 220 mm from 1971 to 2020 with a non significant increase from 1971 to 2020 the average evapotranspiration water yield and surface runoff were 265 mm 123 mm and 31 mm respectively among these three variables water yield and surface runoff showed significant p 0 05 variation trends with increasing rates of 0 64 0 37 and 0 22 0 11 mm yr 1 respectively 3 3 spatiotemporal changes of the wr wr exhibited an non significant uptrend of 0 50 0 61 mm yr 1 during the historical period p 0 35 fig 4 during this period the lowest wr is 5 mm occurring in 1994 and the highest value of wr of 218 mm occurred in 1998 in terms of the spatial distribution of wr as shown in fig 4b the high values of wr were mostly distributed in the middle area of the basin and most low values of wr were found in the northwest and southeast of the basin the historical and projected changes in meteorological variables air temperature and precipitation under rcp2 6 rcp4 5 and rcp8 5 are presented in fig 5 a and b the mean air temperature shows an overall upward trend during the historical period and would continue to rise in the future 2021 2099 under all rcp scenarios indicating a significant warming trend in the 21st century during the near future period 2021 2060 the annual mean temperature was projected to rise by 1 04 1 36 and 1 64 c under the rcp2 6 rcp4 5 and rcp8 5 respectively the annual mean air temperature during the far future period 2061 2099 was projected to increase by 1 18 2 32 and 3 98 c respectively specifically the annual mean air temperature in the late 21st century may be as high as 5 72 c under the rcp8 5 the average precipitation also showed an increasing trend during the historical period and may continue to increase in the future 2021 2099 under all rcp scenarios the annual precipitation in the uhrb would increase by 9 3 and 5 under the rcp2 6 rcp4 5 and rcp8 5 during the near future period respectively the annual precipitation in the uhrb may increase by 6 5 and 6 under the rcp2 6 rcp4 5 and rcp8 5 during the far future periods respectively fig 5c presents the temporal changes of wr in the uhrb under the three rcp scenarios during the future periods when compared to the baseline wr under the rcp2 6 scenario showed a slight increase 1 during the near future but decreased by 10 in the far future period under the rcp4 5 and rcp8 5 scenarios wr may decrease by 23 and 32 in the near future respectively and the decrease percentages would reach 40 and 69 in the far future respectively by the end of the 21st century the annual wr under rcp8 5 may reduce to 13 96 3 84 mm fig 6 shows the predicted future spatial patterns of wr under rcp2 6 rcp4 5 and rcp8 5 scenarios in the future the low wr levels may occur in the northeastern and southern parts of the study area while the high wr values can be found in the central regions overall the average level of wr was at the highest level under the rcp2 6 followed by rcp4 5 and rcp8 5 3 4 risk warning of future wr fig 7 shows the differences  of the basin average annual wr wr between the baseline condition and the two future periods near and far future under the three rcps a negative value of wr means that degradation occurred and the greater the absolute value of the negative wr the higher the risk level is table 3 during the near future period though wr may exhibit a non significant upward trend 0 41 mm yr 1 p 0 25 and a downward trend 0 38 mm yr 1 p 0 33 under rcp2 6 and rcp 4 5 respectively a significant downward trend of 1 18 mm yr 1 p 0 005 was found for rcp8 5 for the far future period wr may decrease non significantly under rcp4 5 and rcp8 5 but it would increase under the rcp2 6 to determine the degradation degree of wr we used the quartile method to define the risk warning levels fig 8 the acreage of areas with low and medium degradation accounted for 30 36 and 11 07 during the near future under rcp2 6 and these areas were mainly distributed in the northwest and southeast the acreage percentage for the low degradation decreased to 24 86 but medium degradation increased to 24 47 during the far future period under the rcp4 5 the area with low and medium degradation accounted for 28 55 and 37 55 of the total watershed during the near future period and the area percentage for the high degradation could reach 45 39 during the far future period mainly distributing in the central region of the basin during the future periods the air temperature would continue to increase and thereby the degradation degree was projected to be high and very high under the high emission scenario rcp8 5 the acreage percentage for the very high degradation could reach 46 29 during the far future period and the water retention would degrade substantially in the middle and northwest of the basin 4 discussion 4 1 projected hydrologic changes and influencing climate factors the precipitation air temperature evapotranspiration water yield and surface runoff in the uhrb showed increasing trends but soil water exhibited an opposite trend during the historical period the rising temperature led to the increase in evapotranspiration but it may also contribute to the increase in streamflow caused by snow and glacier melting duethmann et al 2015 fig 9 b our study showed that the temperature in the uhrb may continue to rise in the future and rcp4 5 and rcp8 5 had a higher warming potential than rcp2 6 li et al 2021a the potential slight increase in precipitation and the rising temperature exhibit a wetter and warmer climate in the uhrb in addition evapotranspiration was projected to increase by 45 under the rcp8 5 scenario while surface runoff would decrease by 50 overall our results suggest that evapotranspiration would increase in future and thus may further aggravate the regional water stress therefore water saving measures should be taken to tackle with the potential shortage in water resources 4 2 attribution of the future changes in wr under the three climate scenarios wr may increase under the rcp2 6 but decrease under the other scenarios in the near future wr decreases with the increase of temperature in the northwest area of the uhrb where rainfall and vegetation coverage are relatively low the decrease of water holding capacity of litters also leads to the decrease of wr sun et al 2018 forest canopy interception is an essential part of wr li et al 2021b altitude and latitude affect forest canopy interception through precipitation distribution as shown in fig 6 wr is low in the northwestern regions with relative higher elevations in addition areas with deeper soil will hold more water after precipitation and the accumulated soil water gradually drain through lateral flow and baseflow therefore the wr is larger in the middle of the study area with a thicker soil layer but lower in the northwestern part with a thinner soil and higher elevation some areas of the uhrb exhibited a medium degree of wr degradation under the rcp2 6 during the future periods but the degradation degree with very high may occur by the end of this century under rcp8 5 it should be noted that the soil water and water yield during the future periods showed a downward trend however the continuous rise of temperature in this region projected during the 21st century conditions may be less conducive for wr and the threat of wr degradation may substantially increase it needs to emphasize that warming is just one driver of future wr risk in this region future changes in other climate conditions e g extreme climate events and the increase of ecosystem vulnerability may potentially lead to various risk scenarios threating the regional water safety therefore we appeal to remain flexible and alert to the new challenges of wr that could emerge under a warmer climate 4 3 uncertainties and limitations there are some uncertainties and limitations in our study first of all the spatial distribution of wr at regional scale depends on multiple influencing factors wu et al 2021 yin et al 2022 although the key driving factors such as meteorological elements land use types soil types and topography were considered in our study other potential drivers such as forest density forest age vegetation litter capacity agricultural water practices and water management may also affect the wr land use is an important factor especially in those areas with substantial changes however this study area is an ecological nature reserve with little human disturbance see figure s3 in the supporting information and this study focused on climate change impacts on water retention nonetheless we acknowledge the potential limitation that may be caused by excluding land use change in our design second there are also great uncertainties the gcm data buytaert et al 2009 wu et al 2012 woldemeskel et al 2014 many studies reported that over reliance on a single gcm may leads to inappropriate predictions li jin 2017 vousdoukas et al 2018 though the ensemble average precipitation and temperature from gcms showed good consistence with the cma based observations and the results were close to a previous study li et al 2021a it is indeed difficult to predict climate change accurately in the future because the sophisticated climate system in addition we did not consider future land use change and potential anthropogenic activities that may also influence the water retention and this would be a good subject of our future study 5 conclusions in this study we investigated the spatiotemporal changes of the wr under climate change based on hydrological process modeling and predicted the risk of wr degradation in the upper heihe river basin the climate projections showed that the precipitation would slightly increase and warming may continue under all three rcp scenarios the negative impact of warming induced increase of evapotranspiration was greater than the positive impact of increased precipitation on wr leading to degradation of wr in the uhrb the wr will decrease by 10 40 and 69 under rcp2 6 rcp4 5 and rcp8 5 scenarios respectively in particular the degradation degree of the wr under the rcp8 5 scenario is the most serious areas with high and very high degradation would account for 68 56 of the basin during the far future period this study provided a framework by combining the spatiotemporal dynamics assessment and future degradation risk prediction and warning to assess the dynamics and future risk of the water retention in a typical inner headwater basin our framework can be valuable for evaluating the historical and future spatiotemporal variation of water retention and the degradation risk at the watershed scale in summary our quantitative assessment can provide valuable guidance for rational allocation of water resources and ecosystem management in headwater areas under a shifting climate emphasizing the importance of ecological protection in the headwater area credit authorship contribution statement guangchuang zhang conceptualization methodology data curation formal analysis writing original draft yiping wu conceptualization project administration writing review editing supervision huiwen li writing review editing wenzhi zhao project administration funding acquisition fan wang data curation methodology ji chen writing review editing bellie sivakumar writing review editing shuguang liu writing review editing linjing qiu review visualization wenke wang resources declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this study was funded by the national key research and development program of china 2019yfc0507403 the technology innovation center for land engineering and human settlements shaanxi land engineering construction group co ltd and xi an jiaotong university 201912131 b2 the national science foundation of china 42271025 and 31961143011 shaanxi key research and development program 2022zdlsf06 04 the innovation team of shaanxi province 2021td 52 the national thousand youth talent program of china and the shaanxi hundred talent program we also thank the hpcc platform in xi an jiaotong university for computing equipment and computer maintenance appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128717 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2643,the ensemble random forest filter erff is presented as an alternative to the ensemble kalman filter enkf for inverse modeling the enkf is a data assimilation approach that forecasts and updates parameter estimates sequentially in time as observations are collected the updating step is based on the experimental covariances computed from an ensemble of realizations and the updates are given as linear combinations of the differences between observations and forecasted system state values the erff replaces the linear combination in the update step with a non linear function represented by a random forest this way the non linear relationships between the parameters to be updated and the observations can be captured and a better update produced the erff is demonstrated for log conductivity identification from piezometric head observations in several scenarios with varying degrees of heterogeneity log conductivity variances going from 1 up to 6 25 ln m d 2 number of realizations in the ensemble 50 or 100 and number of piezometric head observations 18 or 36 in all scenarios the erff works well reconstructing the log conductivity spatial heterogeneity while matching the observed piezometric heads at selected control points for benchmarking purposes the erff is compared to the restart enkf to find that the erff is superior to the enkf for the number of ensemble realizations used small in typical enkf applications only when the number of realizations grows to 500 the restart enkf can match the performance of the erff albeit at more than double the computational cost keywords groundwater flow inverse modeling random forest bayesian methods data availability data will be made available on request 1 introduction characterization of the subsurface heterogeneity is of critical concern for modeling groundwater flow i e capilla et al 1999 li et al 2011 feyen et al 2003 fernndez garcia and gmez hernndez 2007 since it requires heterogeneous values of hydrogeologic parameters which commonly are only sparsely available if at all to overcome the incomplete knowledge of the system and obtain better predictions with numerical models state variables such as piezometric head generally more extensively sampled can be assimilated to improve the characterization of harder to measure parameters such as hydraulic conductivity carrera et al 2005 wen et al 1999 even with such an improvement parameter heterogeneity is never completely known and its uncertainty also needs to be characterized stochastic data assimilation is an inverse modeling approach that can be used to characterize parameter heterogeneity and its uncertainty by assimilating state data sequentially in time zhou et al 2014 the ensemble kalman filter enkf proposed by evensen 1994 is a very popular data assimilation method for stochastic inverse modeling that has been proven very efficient in numerous applications in fields as varied as atmospheric science oceanography geophysics geotechnical and petroleum engineering hydrology or hydrogeology yin et al 2015 xu and gmez hernndez 2016 shuai et al 2016 zhu et al 2017 chen et al 2018 liu et al 2018 gelsinari et al 2020 kim et al 2020 he et al 2021 data assimilation for inverse modeling as implemented by the enkf and its variants is based on two main steps a forecast of system evolution followed by an update or correction of the parameters describing the system based on the discrepancy at a few locations between predictions and observations the updates are computed using linear combinations with the weights calculated using covariance functions in a manner very similar to the geostatistical interpolation technique of cokriging such a linear scheme is a drawback of the kalman based data assimilation methods since it is optimal only when the system evolves in time following a linear state equation still when the system evolves non linearly the model is suboptimal although its performance may be very good as demonstrated by its successful applications a typical example of an enkf implementation in which the relationship between the parameters and the state is non linear is for inverse groundwater modeling evensen 1994 xu et al 2013 one of the reasons for the success of the enkf is that the experimental covariances are computed from ensembles of realizations that contain parameter values and their corresponding predictions the ensemble size is critical it should be as small as possible to save cpu time but it should be as large as possible to obtain good experimental covariance estimates that will prevent filter inbreeding and the appearance of spurious correlations and avoid filter divergence these problems could be mitigated for small ensemble sizes with covariance localization techniques chen and zhang 2006 todaro et al 2019 xu et al 2013 chen and zhang 2006 studied the sensitivity of the enkf to among other factors the ensemble size and the choice of the initial ensemble and they showed that prior knowledge of the underlying field such as the structure of the covariance function plays an important role in data assimilation besides that they found that a correct estimation of uncertainty may require large ensemble sizes the need for large ensemble sizes and good prior knowledge of the spatial variability of the field the linear nature of the updating step and its big computational cost call for new strategies to improve available data assimilation ensemble methods in the last years machine learning and big data are permeating all ambits of science and technology the easiness with which large amounts of data are acquired in real time and the new approaches to process them to build data based predictive models have given rise to a new paradigm in the treatment of information that is starting to be used in environmental and water resources studies asher et al 2015 sit et al 2020 tahmasebi and sahimi 2021 mariethoz and gmez hernndez 2021 in groundwater modeling machine learning algorithms have been used mainly to replace process driven models with data driven ones to predict piezometric heads or solute concentrations from ancillary variables the justification is that the data driven models are cheaper to run and may capture relationships that could escape a process driven analysis knoll et al 2019 al abadi and alsamaani 2020 nguyen et al 2020 sachdeva and kumar 2021 an et al 2021 although these algorithms have proven their ability to deal with a wide range of problems in groundwater they are seldom used for stochastic inverse modeling purposes to the best of the authors knowledge it has not yet been used as a data assimilation algorithm capable of replacing the restart enkf r enkf chen et al 2018 xu and gmez hernndez 2018 2016 without trying to be exhaustive some example applications of machine learning in groundwater inverse modeling are the works by mo et al 2019 who combined an autoregressive neural network based surrogate method for forward modeling with an iterative local updating ensemble smoother ilues zhang et al 2018 to solve high dimensional contaminant transport inverse problems bao et al 2020 2022 who used generative adversarial networks gan goodfellow et al 2014 to reparameterize hydraulic conductivity using a low dimension latent variable and then coupling it to an ensemble smoother with multiple data assimilation es mda emerick and reynolds 2013 or zhang et al 2020 who used deep learning to improve the ensemble smoother although their starting ensemble was built with good prior knowledge of the underlying hydraulic conductivity spatial heterogeneity since the weakest point of the kalman based data assimilation methods is the linear updating step which is equivalent to cokrige the perturbations of hydraulic conductivity from the deviations between predicted and observed piezometric heads it is proposed to replace the covariance based updating step with a random forest based updating random forest updating should be able to capture the multipoint non linear relationships between conductivities and piezometric heads this new method is termed ensemble random forest filter erff the idea of using random forests breiman 2001 was inspired by the work by hengl et al 2018 in which the authors propose as an alternative to kriging a new framework for spatial interpolation using random forest demonstrating that this approach is capable of capturing relationships that go beyond the linear correlation intrinsic to the covariance the framework proposed by hengl et al 2018 seeks the non linear interpolation of an attribute from sparsely observed attribute values in erff however the task is to interpolate piezometric head deviations between observed and predicted values to provide correction increments for hydraulic conductivity over the entire aquifer model by taking advantage of the ensemble of realizations and subtracting them two by two a new set of realizations an order of magnitude larger is built to train the random forest finally the erff replaces the calculation and inversion of covariance matrices with random forest training the erff is demonstrated in three synthetic aquifers of varying heterogeneity variances ranging from 1 0 to 6 25 ln m d 2 a sensitivity analysis of the ensemble size and the number of observations is carried out differently from previous researchers mo et al 2019 goodfellow et al 2014 zhang et al 2020 and in line with the work by xu et al 2013 it is assumed that there is no prior information about the spatial heterogeneity of hydraulic conductivity but only information about its mean value and its variance xu et al 2013 have already shown the power of transient piezometric heads in the characterization of hydraulic conductivity by the enkf when no prior information is available as will be shown this power is intrinsic and can be taken advantage of by the erff the concept of localization xu et al 2013 todaro et al 2019 is also included in the implementation of the erff to reinforce the notion of spatial correlation by training the random forest giving more weight to the observations that are closer to the point being updated the erff results are benchmarked against the r enkf the structure of this paper is as follows first the basics of ensemble kalman filtering are introduced followed by describing how the enkf becomes the erff second the three reference synthetic transient groundwater flow problems and the scenarios that will be analyzed are described third the results for the different scenarios are shown and one of the scenarios is compared with the r enkf and fourth the paper ends with a summary and an outlook on potential lines of continuing research 2 stochastic data assimilation the enkf algorithm evensen 1994 is the evolution of the kalman filter kalman 1960 to handle nonlinear state transfer functions by using a monte carlo approach the enkf in the context of inverse modeling is a sequential data assimilation method that updates model parameters based on the discrepancies between model predictions and experimental observations at a few locations the relationship between parameters and observations must be known and a forward model relating parameters and state variables must be available in the original implementation of the enkf for inverse modeling both model parameters and system states were updated still it was found that the updated states might violate constitutive relationships such as mass conservation and the restart enkf was introduced whereby only model parameters are updated and the forecast for the next time step is always performed from time zero the reader interested in the details of the enkf is referred to the many papers published particularly those by evensen 1994 2003 in the following a brief description of the r enkf is presented to introduce the errf 2 1 r enkf ensemble data assimilation with covariance based updating consider a transient groundwater flow model in which piezometric heads are predicted based on the hydraulic conductivity values on a discretized aquifer plus corresponding boundary initial conditions and forcing terms the forward model relating them is 1 y t g x y t  t where t is time x r n p is the hydraulic conductivity y r n o is the predicted system state at measurement locations g is a function that includes the numerical flow model plus an observation operator that extracts the predictions at observation locations n p is the number of cells in which the aquifer has been discretized and for which the hydraulic conductivity needs to be known to solve the numerical flow equation and n o are the number of piezometric head observation locations piezometric heads are collected sequentially in time and the purpose of the r enkf is after each data collection to update the hydraulic conductivities so that after a sufficient number of updates the hydraulic conductivity spatial distribution resembles the true but unknown one the r enkf consists of an initialization step followed by repeated forecast and update steps as follows 1 initialization step an initial ensemble of n e realizations of hydraulic conductivity x i n i is generated using statistical or geostatistical methods and incorporating as much prior knowledge as possible in this paper it is assumed that no prior information about the spatial variability of hydraulic conductivity is available the initial set of realizations is made up of homogeneous realizations each with a value drawn from a univariate distribution 2 forecast step from time zero in this step the transient groundwater flow forward model is solved from time zero for each realization i to obtain model predictions of the piezometric heads at time step t using the latest update of the conductivities for the first update the initial ensemble of conductivities is used recall that to ensure mass conservation is not violated by the piezometric heads at time t the simulation is always restarted from time zero 2 y i t g x i t 1 y i 0 i 1 n e where y i t is the vector of forecasted piezometric heads at the t th time step and x i t 1 is the last update of hydraulic conductivities at the previous time step t 1 for the first time step x i t 1 is x i i n i 3 update step the vector of hydraulic conductivities is updated based on the discrepancies between forecasted and observed piezometric heads the updated parameter vector x u is given for the i th realization at the t th time step by 3 x i t u x i t f k t y t o  i t o y i t f where the subscripts i and t refer to a specific realization and time step respectively x i t 1 f x i i n i and x i t f x i t 1 u y i t f is the vector of model predictions at observation locations y t o is the vector of state values at observation locations  i t o is the vector of observation errors the observations errors have zero mean and a covariance matrix r t and k t is the kalman gain matrix given by 4 k t c x y t c y y t r t 1 where c y y t is the auto covariance of the state variables and c x y t is the cross covariance between parameters and state variables for the t th time step which are computed from the ensemble of realizations as 5 c y y t 1 n e 1 i 1 n e y i t y t y i t y t t 6 c x y t 1 n e 1 i 1 n e x i t x t y i t x t t with x and y being the ensemble means of parameters and predictions respectively covariance localization is used to mitigate the problem of spurious correlations it is done by element wise multiplication of the originals covariance matrices and a distance dependent correlation function that reduces the correlations between points as the euclidian distance between them increases the cross covariance and the auto covariance are then calculated as 7 c x y t c x y t  8 c y y t c y y t  where represents the schur product and  is a correlation function given by 9  r 1 4 r a 5 1 2 r a 4 5 8 r a 3 5 3 r a 2 1 0 r a 1 12 r a 5 1 2 r a 4 5 8 r a 3 5 3 d a 2 5 r a 4 2 3 r a 1 a r 2 a 0 r 2 a where a is the distance beyond which no spatial correlation is expected and r is the euclidean distance between the observation and the point where log conductivity has to be updated 4 back to the forecast step in a problem where there are n p parameters in our case n p will be the number of cells in the numerical model and n o observations vectors x i t u and x i t f have sizes n p 1 vectors y t o  i t o and y i t f have sizes n o 1 the kalman gain k t and the cross covariance c x y t are matrices of size n p n o and the matrices c y y t and r are of size n o n o when the observation errors are modeled as uncorrelated r t is a diagonal matrix in the covariance matrix calculations x t is a column vector of size n p 1 with the average values of each parameter computed through the realizations x t 1 n e i 1 n e x i t and similarly y t is a column vector of size n o 1 with the average values of each state variable computed through the ensemble of realizations y t 1 n e i 1 n e y i t 2 2 erff ensemble data assimilation with random forest based updating the erff proposal is to replace the linear updating in eq 4 with a non linear update based on a random forest prediction eq 4 can be rearranged as follows 10 x i t u x i t f k t y t o y i t f  i t o and rewritten as 11  x i t   y i t where  x i t and  y i t are the correction to be applied to the current estimate of the parameters and the discrepancy between state predictions and observations vectors respectively in the r enkf function  is a linear combination of discrepancies where k t eq 4 is the matrix of coefficients in the erff  will be replaced by a random forest regressor which should be able to capture any linear or non linear relationship existing between  x i t and  y i t random forest regression is a supervised machine learning algorithm for building a predictor ensemble with a set of decision trees that is a forest that grow in bootstrapped sub samples of the dataset that is randomly selected samples with replacement predictions are obtained by aggregating the various predictors from each decision tree into a single average value breiman 2001 cutler et al 2012 biau 2012 the bootstrap aggregation procedure used in random forest produces robust and highly accurate predictions without overfitting biau 2012 hengl et al 2018 as the mathematical framework of the random forest itself is not the focal point of this work interested readers are encouraged to refer to breiman 2001 cutler et al 2012 and biau 2012 for a more in depth analysis of the technique a random forest has to be built for each cell in the model where log conductivity is to be estimated once built the discrepancies between forecasted piezometric heads different for each realization and observed values are fed to the random forest to provide an estimate of the log conductivity perturbation to apply at that specific cell to each realization the erff consists of the same steps as the r enkf an initialization step followed by repeated forecast and update steps the difference lies in the update step which is done using random forests as explained next consider a set of n e realizations of the hydraulic conductivity and the associated n e realizations of the piezometric heads at a given time step with such a set subtracting two by two each conductivity realization and its associated piezometric heads an ensemble of n e n e n e 1 2 realizations of differences can be built 12  ln k i 3 t ln k i 2 t ln k i 1 t  h i 3 t h i 2 t h i 1 t i 1 1 n e 1 i 2 i 1 n e i 3 1 n e where  ln k i 3 t is a realization of log conductivity differences at time step t and  h i 3 t is a realization of piezometric head differences at the same time step and for the same conductivity realizations used to obtain the log conductivity difference next consider that observations have been taken at a subset of n o locations these observations will depart from the forecasted values and the differences between observations and forecasts will change for each realization of log conductivity consider now a specific cell in the numerical model j from the ensemble of differences it is possible to build a training data set composed of 13  ln k i j t  h i k t k 1 n o i 1 n e from which to train a random forest to predict the perturbation of log conductivity at location j associated with perturbations of the piezometric heads at the set of n o locations once this random forest is trained the differences between the observed heads and the predicted ones in each realization are calculated the random forest is used to predict a log conductivity difference to apply to the current value of log conductivity at that specific location this procedure is repeated for each cell in the aquifer until all conductivity values are updated this procedure could be extended for the update of multiple parameters given observations of multiple variables such as for instance updating log conductivities and porosities from piezometric head and concentration observations to reinforce the need to account for spatial correlation the head differences are weighted before their use according to 14  h i k t  h i k t  1 r where i is the realization index k is the observation index t is the time index r is the euclidean distance between the observation and the point where log conductivity has to be updated and  is the localization function in eq 9 the rationale for using eq 9 here is the following when the observation location is close to the log conductivity location being updated  is close to one and no correction is introduced but when the head difference is far from the log conductivity the value of  is close to zero and the head difference is amplified in a way that the random forest will interpret that there is no relationship between head differences and log conductivity differences in this way head differences close to the point being updated will receive larger weight in the log conductivity update than head differences that are further apart the random forest was implemented using the scikit learn library in python pedregosa et al 2011 before running the different scenarios described in the next section tuning the algorithm s hyperparameters was necessary this is probably the most tedious part of the erff which is always subject to some subjective decisions and is an application dependent task several preliminary runs were performed splitting the ensemble of differences into two subsets 90 for training and 10 for validation and a sensitivity analysis was performed to derive the best hyperparameter values the values finally chosen for the hyperparameters were number of trees in the forest 120 minimum number of samples required to split an internal node 2 minimum number of samples required to be at a leaf node 3 number of features to consider 0 65 and random state 10 all other hyperparameters were set at their default values as defined in scikit learn it is important to stress one of the advantages of the erff over the enkf is that to get the n e ensemble of realizations is necessary to run n e times the forward model but then the number of realizations to train the random forest increases to n e n e 1 2 after a simple subtraction of the original n e realizations to get the same number of realizations for enkf n e n e 1 2 would have to be forward modeled 3 synthetic examples three synthetic two dimensional heterogeneous and confined aquifers are built on a domain composed of 30 by 10 cells each 1 m by 1 m the gcosim3d code gmez hernndez and journel 1993 was used to generate the three reference log conductivity fields with standard deviations sd of 1 0 1 7 and 2 5 ln m d and all of them with a mean of 4 0 ln m d and a spherical variogram with maximum and minimum ranges of 20 and 10 m respectively with the direction of maximum continuity oriented at 60 counterclockwise with respect to the east west axis transient groundwater flow is simulated in all three synthetic aquifers under the following conditions north and south boundaries are impervious along the east boundary a flow of 200 m3 d is prescribed heads of 0 m are prescribed along the west boundary and initial hydraulic heads are set to 0 m everywhere fig 1 shows the three log conductivity reference fields with indication of the groundwater flow boundary conditions along with their histograms the total simulation time is five days discretized into 100 time steps transient groundwater flow is numerically solved by modflow 2005 harbaugh 2005 in flopy bakker et al 2016 each transient simulation for each reference field was sampled at the locations shown in fig 2 the sampled values will be assimilated by the erff to retrieve the spatial heterogeneity of the reference fields only the observations for the 26 first time steps are used during the assimilation the remaining 74 time steps are used for validation fig 2 also shows three control points that will not be used during the assimilation but that will also serve to validate the final results twelve scenarios were defined to evaluate the performance of the erff the scenarios were built to analyze the influence of the number of realizations in the ensemble the number of observation points and the standard deviation of the reference field table 1 summarizes the scenarios considered for the generation of the initial ensemble of realizations it is assumed that no prior information about the spatial variability of conductivity is available for this reason the assimilation procedure for all scenarios starts with an ensemble of homogeneous log conductivity realizations drawn from gaussian probability distributions of mean 4 0 ln m d and standard deviations of 1 0 1 7 and 2 5 ln m d according to the last column in table 1 fig 3 displays the ensemble means fig 3a and the ensemble variances fig 3b d for the initial log conductivity fields for all scenarios as expected these values are homogeneous and equal to the prior mean the same for all scenarios and variance different for the scenarios according to table 1 each scenario is used to study the erff for identifying the reference field with the same standard deviation in the last column of table 1 apart from the standard deviation the scenarios differ in the number of members of the initial ensemble which can be 50 or 100 and the number of head observation points which can be 18 or 36 as shown in fig 2 hydraulic heads are collected and assimilated every time step for the first 26 time steps then the model continues running until time step 100 in all scenarios localization is used with a parameter a in eq 9 equal to 12 m implying that virtually no spatial correlation between head differences and log conductivity differences exists beyond this distance finally for completeness the r enkf was also applied to scenario s1 and used as a benchmark for errf 4 results and discussion fig 4 shows for scenario s1 how the mean of the ensemble of realizations evolves as observations are assimilated it can be observed that starting from a homogeneous mean heterogeneity is gradually introduced in the ensemble of realizations after each assimilation step by step 26 the mean of the ensemble is a good estimate of the reference the large scale features of the reference are already visible in step 10 and by step 20 the short scale features are displayed too not many changes are noticeable after step 20 similar time evolutions are observable in the rest of the scenarios although not shown here these results are promising mainly since no prior information about spatial heterogeneity is used fig 5 shows the evolution of the histograms of all realizations for each scenario in the first column the histograms for all values in the initial ensembles of realizations for each scenario are shown as solid gray bars the histograms of the updated fields are shown in the second and third columns in all three columns the hollow red histogram is the histogram in the reference field there is not much difference between the initial and the updated histograms although it is clear that there is a shift towards a better fit to the reference histogram in the updated realizations however it is important to notice that the spatial heterogeneity of the realizations has gone from homogeneous values in each realization in the first column to heterogeneous ones trying to replicate the reference so as to match the observed piezometric heads in the other two columns as already said the only statistical information used for the generation of the initial ensemble is the probability distribution from which to draw the homogeneous values for each realization these distributions were chosen to match the ones used to generate the references but it can be said that starting from a uniform distribution with reasonable ranges will yield the same results meaning that the method is capable of retrieving the spatial patterns of the heterogeneous log conductivity field with virtually no prior information on this parameter the difference between the scenarios in the second and third columns of fig 5 is the number of observation points 18 and 36 respectively with 36 observations the final updated histograms are slightly closer to the reference ones the performance of the method was further analyzed through sensitivity analysis to three variables number of observation points ensemble size and hydraulic conductivity variance fig 6 shows the ensemble mean of the updated log conductivity fields after the 26th assimilation time step for all scenarios the left column shows the final mean log conductivity field corresponding to a standard deviation of 1 7 ln m d while the center and right columns show the final fields corresponding to standard deviations of 2 5 and 1 0 ln m d respectively the first row presents the reference fields for comparison purposes the second and third rows refer to scenarios with 18 observation points and the fourth and fifth rows show the scenarios with 36 observation points fig 7 presents the ensemble variance of the updated log conductivity fields after the 26th assimilation time step for all scenarios and fig 8 shows the standardized discrepancy between the reference and the ensemble mean of the updated fields for each scenario computed as the difference between reference value and ensemble mean over the scenario standard deviation in the latter two figures no reference row is displayed the first and second rows correspond to the scenarios with 18 observation points and the third and fourth rows scenarios with 36 observation points left center and right columns correspond to scenarios with log conductivity standard deviations of 1 7 2 5 and 1 0 ln m d respectively from these three figures one can observe that the method successfully reproduces the heterogeneity of the reference fields regardless of the scenario it is worth noting that the results are very similar independently of the number of simulations the number of observations or the standard deviation of the reference field only a slight improvement is found when the number of observations is doubled further analyses carried out and not presented here showed that the number of observations could be reduced to ten and still the erff recovered the heterogeneity of the underlying conductivity fields the success of the approach must be related to the ability of random forests to extract non linear relationships between explanatory variables piezometric head differences and the parameters hydraulic conductivity differences fig 9 compares the erff and the r enkf using the same number of observation points ensemble size and standard deviation of the reference field the first row shows the reference field and the covariance map computed on it the second row shows the ensemble mean for the erff left and the r enkf right as noticeable the erff mean is much closer to the reference than the r enkf the third row shows the ensemble average covariance maps where again the covariance map of erff is closer to the reference than the one from r enkf it should be noticed that the ellipse of anisotropy is slightly smoothed for the erff while for the r enkf the covariance map seems to display a hole effect behavior with maximum continuity close to the north south direction the fourth row shows the ensemble variance which is quite close to zero for both erff and r enkf the fifth row shows the error had the ensemble mean been used as an estimate for the reference again the erff outperforms the r enkf finally the sixth row shows the histograms of the final realizations as compared with the reference histogram the same results can be noticed the conclusion would be that for 50 realizations the erff is superior to the r enkf even with localization the small number of realizations in r enkf takes an important toll this does not mean that the r enkf is disqualified for inverse modeling but the erff is better under these settings aware of the very good results that the r enkf had given in the past the exercise was repeated with an ensemble of 500 realizations and then it yielded results as good as the erff the problem was with the number of realizations the computational costs of both methods and scenarios were also evaluated by measuring the cpu runtime in an 11th gen intel core i9 11900kf 3 5 ghz with 64 gb of ram table 2 shows the run times in minutes for the erff scenarios with 18 observation locations the cpu runtime nearly doubles when we go from 50 to 100 realizations with 36 observation locations going from 50 to 100 observations triples the cpu runtime the cpu runtime for the r enkf with 50 realizations and 18 observations is extremely low compared to scenarios with the same characteristics s1 s2 and s3 reflecting the additional time required by the erff to generate the realizations of the differences and train the rf for each cell however the computational cost needed by the r enkf to arrive at satisfactory results is 2 2 times greater when compared to the erff of the same characteristics for quantitative analysis the root mean square errors rmse and the average standard deviations asd were computed according to 15 r m s e 1 n e n p i 1 n p j 1 n e x i j x i r e f 2 16 a s d 1 n p i 1 n p  x i where n e is the number of realizations in the ensemble n p is the number of cells x i j represents the log conductivity at cell i in realization j x i r e f is the log conductivity in the reference and  x i is the log conductivity ensemble standard deviation at cell i their evolution in time is shown in fig 10 for all 12 scenarios plus the r enkf with 50 and 500 ensemble realizations both values decrease in magnitude as time passes with the best performer being s11 highest values for number of observations number of realizations and reference variance followed by s8 same as s11 but with only 50 realizations note also how the rmse goes chaotic for the r enkf with 50 realizations after iteration 5 probably due to a problem with filter inbreeding very common in ensemble kalman filtering with few realizations finally figs 11 12 and 13 show how the piezometric heads are reproduced at the three control points observations were assimilated only until time step 26 vertical dashed line in all plots but the piezometric head evolution is shown until the end of the simulation period at time 100 all figures show the head simulation in the reference field from time zero dashed red line the average of all head simulations in the initial ensemble of realizations solid blue line and the average of the simulations in the updated log conductivity fields after 26 assimilation steps solid black line note that piezometric head axes vary for each plot to best display the results the graphs have been grouped by columns with each column corresponding to one of the three reference cases it is quite remarkable how the piezometric heads change from being completely off target at time zero to matching almost perfectly the reference head curves the minimal discrepancies between the mean of the simulated values and the reference happen in some of the scenarios with the smaller number of observations i e s4 and s5 for comparison purposes the head evolution in the log conductivity realizations obtained using the r enkf with 50 realizations is shown in fig 14 where it can be seen that the reproduction of the reference values is not as good as for the erff particularly for control points 1 and 2 5 conclusion a new data assimilation method the ensemble random forest filter erff has been proposed it is inspired by the ensemble kalman filter but replaces the linear updating step with a non linear update computed using random forests the erff uses an ensemble of log conductivity realizations and its associated ensemble of predicted piezometric heads to build a large training dataset that is an order of magnitude larger than the initial set of realizations the dataset size grows with the square of the number of realizations the random forest analyzes the differences in the predicted piezometric heads at observation locations with the differences in log conductivities throughout the domain learns from this training set and then predicts what should be the difference to be added to the log conductivity at each location in the domain once the head observations are collected and their differences with respect to the predictions evaluated the method has been tested in a number of scenarios with varying degrees of heterogeneity as measured by the standard deviation different number of realizations in the ensemble and different number of observation locations and it has been found to perform well in all scenarios and better than its benchmarking the restart ensemble kalman filter when the same number of realizations are used only when the number of realizations rises to 500 is the kalman filter capable of providing similar results but at a cost 2 2 times larger than the erff the main caveat of the proposal is as in most machine learning applications the choice of the hyperparameters that control the building of the random forests this task could be time consuming until a suitable set of hyperparameters is found that performs appropriately for the problem at hand research continues on the application of the erff to more complex problems such as those involving the identification of external stresses and boundary and initial conditions or the identification of more complex log conductivity patterns funding the authors acknowledge grant pid2019 109131rb i00 funded by mcin aei 10 13039 501100011033 and project inthemed which is part of the prima programme supported by the european union s horizon 2020 research and innovation programme under grant agreement no 1923 credit authorship contribution statement vanessa a godoy methodology software validation formal analysis investigation writing original draft visualization reviewing gian f napa garca methodology software reviewing j jaime gmez hernndez methodology software validation formal analysis investigation writing review editing visualization supervision funding acquisition reviewing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
2643,the ensemble random forest filter erff is presented as an alternative to the ensemble kalman filter enkf for inverse modeling the enkf is a data assimilation approach that forecasts and updates parameter estimates sequentially in time as observations are collected the updating step is based on the experimental covariances computed from an ensemble of realizations and the updates are given as linear combinations of the differences between observations and forecasted system state values the erff replaces the linear combination in the update step with a non linear function represented by a random forest this way the non linear relationships between the parameters to be updated and the observations can be captured and a better update produced the erff is demonstrated for log conductivity identification from piezometric head observations in several scenarios with varying degrees of heterogeneity log conductivity variances going from 1 up to 6 25 ln m d 2 number of realizations in the ensemble 50 or 100 and number of piezometric head observations 18 or 36 in all scenarios the erff works well reconstructing the log conductivity spatial heterogeneity while matching the observed piezometric heads at selected control points for benchmarking purposes the erff is compared to the restart enkf to find that the erff is superior to the enkf for the number of ensemble realizations used small in typical enkf applications only when the number of realizations grows to 500 the restart enkf can match the performance of the erff albeit at more than double the computational cost keywords groundwater flow inverse modeling random forest bayesian methods data availability data will be made available on request 1 introduction characterization of the subsurface heterogeneity is of critical concern for modeling groundwater flow i e capilla et al 1999 li et al 2011 feyen et al 2003 fernndez garcia and gmez hernndez 2007 since it requires heterogeneous values of hydrogeologic parameters which commonly are only sparsely available if at all to overcome the incomplete knowledge of the system and obtain better predictions with numerical models state variables such as piezometric head generally more extensively sampled can be assimilated to improve the characterization of harder to measure parameters such as hydraulic conductivity carrera et al 2005 wen et al 1999 even with such an improvement parameter heterogeneity is never completely known and its uncertainty also needs to be characterized stochastic data assimilation is an inverse modeling approach that can be used to characterize parameter heterogeneity and its uncertainty by assimilating state data sequentially in time zhou et al 2014 the ensemble kalman filter enkf proposed by evensen 1994 is a very popular data assimilation method for stochastic inverse modeling that has been proven very efficient in numerous applications in fields as varied as atmospheric science oceanography geophysics geotechnical and petroleum engineering hydrology or hydrogeology yin et al 2015 xu and gmez hernndez 2016 shuai et al 2016 zhu et al 2017 chen et al 2018 liu et al 2018 gelsinari et al 2020 kim et al 2020 he et al 2021 data assimilation for inverse modeling as implemented by the enkf and its variants is based on two main steps a forecast of system evolution followed by an update or correction of the parameters describing the system based on the discrepancy at a few locations between predictions and observations the updates are computed using linear combinations with the weights calculated using covariance functions in a manner very similar to the geostatistical interpolation technique of cokriging such a linear scheme is a drawback of the kalman based data assimilation methods since it is optimal only when the system evolves in time following a linear state equation still when the system evolves non linearly the model is suboptimal although its performance may be very good as demonstrated by its successful applications a typical example of an enkf implementation in which the relationship between the parameters and the state is non linear is for inverse groundwater modeling evensen 1994 xu et al 2013 one of the reasons for the success of the enkf is that the experimental covariances are computed from ensembles of realizations that contain parameter values and their corresponding predictions the ensemble size is critical it should be as small as possible to save cpu time but it should be as large as possible to obtain good experimental covariance estimates that will prevent filter inbreeding and the appearance of spurious correlations and avoid filter divergence these problems could be mitigated for small ensemble sizes with covariance localization techniques chen and zhang 2006 todaro et al 2019 xu et al 2013 chen and zhang 2006 studied the sensitivity of the enkf to among other factors the ensemble size and the choice of the initial ensemble and they showed that prior knowledge of the underlying field such as the structure of the covariance function plays an important role in data assimilation besides that they found that a correct estimation of uncertainty may require large ensemble sizes the need for large ensemble sizes and good prior knowledge of the spatial variability of the field the linear nature of the updating step and its big computational cost call for new strategies to improve available data assimilation ensemble methods in the last years machine learning and big data are permeating all ambits of science and technology the easiness with which large amounts of data are acquired in real time and the new approaches to process them to build data based predictive models have given rise to a new paradigm in the treatment of information that is starting to be used in environmental and water resources studies asher et al 2015 sit et al 2020 tahmasebi and sahimi 2021 mariethoz and gmez hernndez 2021 in groundwater modeling machine learning algorithms have been used mainly to replace process driven models with data driven ones to predict piezometric heads or solute concentrations from ancillary variables the justification is that the data driven models are cheaper to run and may capture relationships that could escape a process driven analysis knoll et al 2019 al abadi and alsamaani 2020 nguyen et al 2020 sachdeva and kumar 2021 an et al 2021 although these algorithms have proven their ability to deal with a wide range of problems in groundwater they are seldom used for stochastic inverse modeling purposes to the best of the authors knowledge it has not yet been used as a data assimilation algorithm capable of replacing the restart enkf r enkf chen et al 2018 xu and gmez hernndez 2018 2016 without trying to be exhaustive some example applications of machine learning in groundwater inverse modeling are the works by mo et al 2019 who combined an autoregressive neural network based surrogate method for forward modeling with an iterative local updating ensemble smoother ilues zhang et al 2018 to solve high dimensional contaminant transport inverse problems bao et al 2020 2022 who used generative adversarial networks gan goodfellow et al 2014 to reparameterize hydraulic conductivity using a low dimension latent variable and then coupling it to an ensemble smoother with multiple data assimilation es mda emerick and reynolds 2013 or zhang et al 2020 who used deep learning to improve the ensemble smoother although their starting ensemble was built with good prior knowledge of the underlying hydraulic conductivity spatial heterogeneity since the weakest point of the kalman based data assimilation methods is the linear updating step which is equivalent to cokrige the perturbations of hydraulic conductivity from the deviations between predicted and observed piezometric heads it is proposed to replace the covariance based updating step with a random forest based updating random forest updating should be able to capture the multipoint non linear relationships between conductivities and piezometric heads this new method is termed ensemble random forest filter erff the idea of using random forests breiman 2001 was inspired by the work by hengl et al 2018 in which the authors propose as an alternative to kriging a new framework for spatial interpolation using random forest demonstrating that this approach is capable of capturing relationships that go beyond the linear correlation intrinsic to the covariance the framework proposed by hengl et al 2018 seeks the non linear interpolation of an attribute from sparsely observed attribute values in erff however the task is to interpolate piezometric head deviations between observed and predicted values to provide correction increments for hydraulic conductivity over the entire aquifer model by taking advantage of the ensemble of realizations and subtracting them two by two a new set of realizations an order of magnitude larger is built to train the random forest finally the erff replaces the calculation and inversion of covariance matrices with random forest training the erff is demonstrated in three synthetic aquifers of varying heterogeneity variances ranging from 1 0 to 6 25 ln m d 2 a sensitivity analysis of the ensemble size and the number of observations is carried out differently from previous researchers mo et al 2019 goodfellow et al 2014 zhang et al 2020 and in line with the work by xu et al 2013 it is assumed that there is no prior information about the spatial heterogeneity of hydraulic conductivity but only information about its mean value and its variance xu et al 2013 have already shown the power of transient piezometric heads in the characterization of hydraulic conductivity by the enkf when no prior information is available as will be shown this power is intrinsic and can be taken advantage of by the erff the concept of localization xu et al 2013 todaro et al 2019 is also included in the implementation of the erff to reinforce the notion of spatial correlation by training the random forest giving more weight to the observations that are closer to the point being updated the erff results are benchmarked against the r enkf the structure of this paper is as follows first the basics of ensemble kalman filtering are introduced followed by describing how the enkf becomes the erff second the three reference synthetic transient groundwater flow problems and the scenarios that will be analyzed are described third the results for the different scenarios are shown and one of the scenarios is compared with the r enkf and fourth the paper ends with a summary and an outlook on potential lines of continuing research 2 stochastic data assimilation the enkf algorithm evensen 1994 is the evolution of the kalman filter kalman 1960 to handle nonlinear state transfer functions by using a monte carlo approach the enkf in the context of inverse modeling is a sequential data assimilation method that updates model parameters based on the discrepancies between model predictions and experimental observations at a few locations the relationship between parameters and observations must be known and a forward model relating parameters and state variables must be available in the original implementation of the enkf for inverse modeling both model parameters and system states were updated still it was found that the updated states might violate constitutive relationships such as mass conservation and the restart enkf was introduced whereby only model parameters are updated and the forecast for the next time step is always performed from time zero the reader interested in the details of the enkf is referred to the many papers published particularly those by evensen 1994 2003 in the following a brief description of the r enkf is presented to introduce the errf 2 1 r enkf ensemble data assimilation with covariance based updating consider a transient groundwater flow model in which piezometric heads are predicted based on the hydraulic conductivity values on a discretized aquifer plus corresponding boundary initial conditions and forcing terms the forward model relating them is 1 y t g x y t  t where t is time x r n p is the hydraulic conductivity y r n o is the predicted system state at measurement locations g is a function that includes the numerical flow model plus an observation operator that extracts the predictions at observation locations n p is the number of cells in which the aquifer has been discretized and for which the hydraulic conductivity needs to be known to solve the numerical flow equation and n o are the number of piezometric head observation locations piezometric heads are collected sequentially in time and the purpose of the r enkf is after each data collection to update the hydraulic conductivities so that after a sufficient number of updates the hydraulic conductivity spatial distribution resembles the true but unknown one the r enkf consists of an initialization step followed by repeated forecast and update steps as follows 1 initialization step an initial ensemble of n e realizations of hydraulic conductivity x i n i is generated using statistical or geostatistical methods and incorporating as much prior knowledge as possible in this paper it is assumed that no prior information about the spatial variability of hydraulic conductivity is available the initial set of realizations is made up of homogeneous realizations each with a value drawn from a univariate distribution 2 forecast step from time zero in this step the transient groundwater flow forward model is solved from time zero for each realization i to obtain model predictions of the piezometric heads at time step t using the latest update of the conductivities for the first update the initial ensemble of conductivities is used recall that to ensure mass conservation is not violated by the piezometric heads at time t the simulation is always restarted from time zero 2 y i t g x i t 1 y i 0 i 1 n e where y i t is the vector of forecasted piezometric heads at the t th time step and x i t 1 is the last update of hydraulic conductivities at the previous time step t 1 for the first time step x i t 1 is x i i n i 3 update step the vector of hydraulic conductivities is updated based on the discrepancies between forecasted and observed piezometric heads the updated parameter vector x u is given for the i th realization at the t th time step by 3 x i t u x i t f k t y t o  i t o y i t f where the subscripts i and t refer to a specific realization and time step respectively x i t 1 f x i i n i and x i t f x i t 1 u y i t f is the vector of model predictions at observation locations y t o is the vector of state values at observation locations  i t o is the vector of observation errors the observations errors have zero mean and a covariance matrix r t and k t is the kalman gain matrix given by 4 k t c x y t c y y t r t 1 where c y y t is the auto covariance of the state variables and c x y t is the cross covariance between parameters and state variables for the t th time step which are computed from the ensemble of realizations as 5 c y y t 1 n e 1 i 1 n e y i t y t y i t y t t 6 c x y t 1 n e 1 i 1 n e x i t x t y i t x t t with x and y being the ensemble means of parameters and predictions respectively covariance localization is used to mitigate the problem of spurious correlations it is done by element wise multiplication of the originals covariance matrices and a distance dependent correlation function that reduces the correlations between points as the euclidian distance between them increases the cross covariance and the auto covariance are then calculated as 7 c x y t c x y t  8 c y y t c y y t  where represents the schur product and  is a correlation function given by 9  r 1 4 r a 5 1 2 r a 4 5 8 r a 3 5 3 r a 2 1 0 r a 1 12 r a 5 1 2 r a 4 5 8 r a 3 5 3 d a 2 5 r a 4 2 3 r a 1 a r 2 a 0 r 2 a where a is the distance beyond which no spatial correlation is expected and r is the euclidean distance between the observation and the point where log conductivity has to be updated 4 back to the forecast step in a problem where there are n p parameters in our case n p will be the number of cells in the numerical model and n o observations vectors x i t u and x i t f have sizes n p 1 vectors y t o  i t o and y i t f have sizes n o 1 the kalman gain k t and the cross covariance c x y t are matrices of size n p n o and the matrices c y y t and r are of size n o n o when the observation errors are modeled as uncorrelated r t is a diagonal matrix in the covariance matrix calculations x t is a column vector of size n p 1 with the average values of each parameter computed through the realizations x t 1 n e i 1 n e x i t and similarly y t is a column vector of size n o 1 with the average values of each state variable computed through the ensemble of realizations y t 1 n e i 1 n e y i t 2 2 erff ensemble data assimilation with random forest based updating the erff proposal is to replace the linear updating in eq 4 with a non linear update based on a random forest prediction eq 4 can be rearranged as follows 10 x i t u x i t f k t y t o y i t f  i t o and rewritten as 11  x i t   y i t where  x i t and  y i t are the correction to be applied to the current estimate of the parameters and the discrepancy between state predictions and observations vectors respectively in the r enkf function  is a linear combination of discrepancies where k t eq 4 is the matrix of coefficients in the erff  will be replaced by a random forest regressor which should be able to capture any linear or non linear relationship existing between  x i t and  y i t random forest regression is a supervised machine learning algorithm for building a predictor ensemble with a set of decision trees that is a forest that grow in bootstrapped sub samples of the dataset that is randomly selected samples with replacement predictions are obtained by aggregating the various predictors from each decision tree into a single average value breiman 2001 cutler et al 2012 biau 2012 the bootstrap aggregation procedure used in random forest produces robust and highly accurate predictions without overfitting biau 2012 hengl et al 2018 as the mathematical framework of the random forest itself is not the focal point of this work interested readers are encouraged to refer to breiman 2001 cutler et al 2012 and biau 2012 for a more in depth analysis of the technique a random forest has to be built for each cell in the model where log conductivity is to be estimated once built the discrepancies between forecasted piezometric heads different for each realization and observed values are fed to the random forest to provide an estimate of the log conductivity perturbation to apply at that specific cell to each realization the erff consists of the same steps as the r enkf an initialization step followed by repeated forecast and update steps the difference lies in the update step which is done using random forests as explained next consider a set of n e realizations of the hydraulic conductivity and the associated n e realizations of the piezometric heads at a given time step with such a set subtracting two by two each conductivity realization and its associated piezometric heads an ensemble of n e n e n e 1 2 realizations of differences can be built 12  ln k i 3 t ln k i 2 t ln k i 1 t  h i 3 t h i 2 t h i 1 t i 1 1 n e 1 i 2 i 1 n e i 3 1 n e where  ln k i 3 t is a realization of log conductivity differences at time step t and  h i 3 t is a realization of piezometric head differences at the same time step and for the same conductivity realizations used to obtain the log conductivity difference next consider that observations have been taken at a subset of n o locations these observations will depart from the forecasted values and the differences between observations and forecasts will change for each realization of log conductivity consider now a specific cell in the numerical model j from the ensemble of differences it is possible to build a training data set composed of 13  ln k i j t  h i k t k 1 n o i 1 n e from which to train a random forest to predict the perturbation of log conductivity at location j associated with perturbations of the piezometric heads at the set of n o locations once this random forest is trained the differences between the observed heads and the predicted ones in each realization are calculated the random forest is used to predict a log conductivity difference to apply to the current value of log conductivity at that specific location this procedure is repeated for each cell in the aquifer until all conductivity values are updated this procedure could be extended for the update of multiple parameters given observations of multiple variables such as for instance updating log conductivities and porosities from piezometric head and concentration observations to reinforce the need to account for spatial correlation the head differences are weighted before their use according to 14  h i k t  h i k t  1 r where i is the realization index k is the observation index t is the time index r is the euclidean distance between the observation and the point where log conductivity has to be updated and  is the localization function in eq 9 the rationale for using eq 9 here is the following when the observation location is close to the log conductivity location being updated  is close to one and no correction is introduced but when the head difference is far from the log conductivity the value of  is close to zero and the head difference is amplified in a way that the random forest will interpret that there is no relationship between head differences and log conductivity differences in this way head differences close to the point being updated will receive larger weight in the log conductivity update than head differences that are further apart the random forest was implemented using the scikit learn library in python pedregosa et al 2011 before running the different scenarios described in the next section tuning the algorithm s hyperparameters was necessary this is probably the most tedious part of the erff which is always subject to some subjective decisions and is an application dependent task several preliminary runs were performed splitting the ensemble of differences into two subsets 90 for training and 10 for validation and a sensitivity analysis was performed to derive the best hyperparameter values the values finally chosen for the hyperparameters were number of trees in the forest 120 minimum number of samples required to split an internal node 2 minimum number of samples required to be at a leaf node 3 number of features to consider 0 65 and random state 10 all other hyperparameters were set at their default values as defined in scikit learn it is important to stress one of the advantages of the erff over the enkf is that to get the n e ensemble of realizations is necessary to run n e times the forward model but then the number of realizations to train the random forest increases to n e n e 1 2 after a simple subtraction of the original n e realizations to get the same number of realizations for enkf n e n e 1 2 would have to be forward modeled 3 synthetic examples three synthetic two dimensional heterogeneous and confined aquifers are built on a domain composed of 30 by 10 cells each 1 m by 1 m the gcosim3d code gmez hernndez and journel 1993 was used to generate the three reference log conductivity fields with standard deviations sd of 1 0 1 7 and 2 5 ln m d and all of them with a mean of 4 0 ln m d and a spherical variogram with maximum and minimum ranges of 20 and 10 m respectively with the direction of maximum continuity oriented at 60 counterclockwise with respect to the east west axis transient groundwater flow is simulated in all three synthetic aquifers under the following conditions north and south boundaries are impervious along the east boundary a flow of 200 m3 d is prescribed heads of 0 m are prescribed along the west boundary and initial hydraulic heads are set to 0 m everywhere fig 1 shows the three log conductivity reference fields with indication of the groundwater flow boundary conditions along with their histograms the total simulation time is five days discretized into 100 time steps transient groundwater flow is numerically solved by modflow 2005 harbaugh 2005 in flopy bakker et al 2016 each transient simulation for each reference field was sampled at the locations shown in fig 2 the sampled values will be assimilated by the erff to retrieve the spatial heterogeneity of the reference fields only the observations for the 26 first time steps are used during the assimilation the remaining 74 time steps are used for validation fig 2 also shows three control points that will not be used during the assimilation but that will also serve to validate the final results twelve scenarios were defined to evaluate the performance of the erff the scenarios were built to analyze the influence of the number of realizations in the ensemble the number of observation points and the standard deviation of the reference field table 1 summarizes the scenarios considered for the generation of the initial ensemble of realizations it is assumed that no prior information about the spatial variability of conductivity is available for this reason the assimilation procedure for all scenarios starts with an ensemble of homogeneous log conductivity realizations drawn from gaussian probability distributions of mean 4 0 ln m d and standard deviations of 1 0 1 7 and 2 5 ln m d according to the last column in table 1 fig 3 displays the ensemble means fig 3a and the ensemble variances fig 3b d for the initial log conductivity fields for all scenarios as expected these values are homogeneous and equal to the prior mean the same for all scenarios and variance different for the scenarios according to table 1 each scenario is used to study the erff for identifying the reference field with the same standard deviation in the last column of table 1 apart from the standard deviation the scenarios differ in the number of members of the initial ensemble which can be 50 or 100 and the number of head observation points which can be 18 or 36 as shown in fig 2 hydraulic heads are collected and assimilated every time step for the first 26 time steps then the model continues running until time step 100 in all scenarios localization is used with a parameter a in eq 9 equal to 12 m implying that virtually no spatial correlation between head differences and log conductivity differences exists beyond this distance finally for completeness the r enkf was also applied to scenario s1 and used as a benchmark for errf 4 results and discussion fig 4 shows for scenario s1 how the mean of the ensemble of realizations evolves as observations are assimilated it can be observed that starting from a homogeneous mean heterogeneity is gradually introduced in the ensemble of realizations after each assimilation step by step 26 the mean of the ensemble is a good estimate of the reference the large scale features of the reference are already visible in step 10 and by step 20 the short scale features are displayed too not many changes are noticeable after step 20 similar time evolutions are observable in the rest of the scenarios although not shown here these results are promising mainly since no prior information about spatial heterogeneity is used fig 5 shows the evolution of the histograms of all realizations for each scenario in the first column the histograms for all values in the initial ensembles of realizations for each scenario are shown as solid gray bars the histograms of the updated fields are shown in the second and third columns in all three columns the hollow red histogram is the histogram in the reference field there is not much difference between the initial and the updated histograms although it is clear that there is a shift towards a better fit to the reference histogram in the updated realizations however it is important to notice that the spatial heterogeneity of the realizations has gone from homogeneous values in each realization in the first column to heterogeneous ones trying to replicate the reference so as to match the observed piezometric heads in the other two columns as already said the only statistical information used for the generation of the initial ensemble is the probability distribution from which to draw the homogeneous values for each realization these distributions were chosen to match the ones used to generate the references but it can be said that starting from a uniform distribution with reasonable ranges will yield the same results meaning that the method is capable of retrieving the spatial patterns of the heterogeneous log conductivity field with virtually no prior information on this parameter the difference between the scenarios in the second and third columns of fig 5 is the number of observation points 18 and 36 respectively with 36 observations the final updated histograms are slightly closer to the reference ones the performance of the method was further analyzed through sensitivity analysis to three variables number of observation points ensemble size and hydraulic conductivity variance fig 6 shows the ensemble mean of the updated log conductivity fields after the 26th assimilation time step for all scenarios the left column shows the final mean log conductivity field corresponding to a standard deviation of 1 7 ln m d while the center and right columns show the final fields corresponding to standard deviations of 2 5 and 1 0 ln m d respectively the first row presents the reference fields for comparison purposes the second and third rows refer to scenarios with 18 observation points and the fourth and fifth rows show the scenarios with 36 observation points fig 7 presents the ensemble variance of the updated log conductivity fields after the 26th assimilation time step for all scenarios and fig 8 shows the standardized discrepancy between the reference and the ensemble mean of the updated fields for each scenario computed as the difference between reference value and ensemble mean over the scenario standard deviation in the latter two figures no reference row is displayed the first and second rows correspond to the scenarios with 18 observation points and the third and fourth rows scenarios with 36 observation points left center and right columns correspond to scenarios with log conductivity standard deviations of 1 7 2 5 and 1 0 ln m d respectively from these three figures one can observe that the method successfully reproduces the heterogeneity of the reference fields regardless of the scenario it is worth noting that the results are very similar independently of the number of simulations the number of observations or the standard deviation of the reference field only a slight improvement is found when the number of observations is doubled further analyses carried out and not presented here showed that the number of observations could be reduced to ten and still the erff recovered the heterogeneity of the underlying conductivity fields the success of the approach must be related to the ability of random forests to extract non linear relationships between explanatory variables piezometric head differences and the parameters hydraulic conductivity differences fig 9 compares the erff and the r enkf using the same number of observation points ensemble size and standard deviation of the reference field the first row shows the reference field and the covariance map computed on it the second row shows the ensemble mean for the erff left and the r enkf right as noticeable the erff mean is much closer to the reference than the r enkf the third row shows the ensemble average covariance maps where again the covariance map of erff is closer to the reference than the one from r enkf it should be noticed that the ellipse of anisotropy is slightly smoothed for the erff while for the r enkf the covariance map seems to display a hole effect behavior with maximum continuity close to the north south direction the fourth row shows the ensemble variance which is quite close to zero for both erff and r enkf the fifth row shows the error had the ensemble mean been used as an estimate for the reference again the erff outperforms the r enkf finally the sixth row shows the histograms of the final realizations as compared with the reference histogram the same results can be noticed the conclusion would be that for 50 realizations the erff is superior to the r enkf even with localization the small number of realizations in r enkf takes an important toll this does not mean that the r enkf is disqualified for inverse modeling but the erff is better under these settings aware of the very good results that the r enkf had given in the past the exercise was repeated with an ensemble of 500 realizations and then it yielded results as good as the erff the problem was with the number of realizations the computational costs of both methods and scenarios were also evaluated by measuring the cpu runtime in an 11th gen intel core i9 11900kf 3 5 ghz with 64 gb of ram table 2 shows the run times in minutes for the erff scenarios with 18 observation locations the cpu runtime nearly doubles when we go from 50 to 100 realizations with 36 observation locations going from 50 to 100 observations triples the cpu runtime the cpu runtime for the r enkf with 50 realizations and 18 observations is extremely low compared to scenarios with the same characteristics s1 s2 and s3 reflecting the additional time required by the erff to generate the realizations of the differences and train the rf for each cell however the computational cost needed by the r enkf to arrive at satisfactory results is 2 2 times greater when compared to the erff of the same characteristics for quantitative analysis the root mean square errors rmse and the average standard deviations asd were computed according to 15 r m s e 1 n e n p i 1 n p j 1 n e x i j x i r e f 2 16 a s d 1 n p i 1 n p  x i where n e is the number of realizations in the ensemble n p is the number of cells x i j represents the log conductivity at cell i in realization j x i r e f is the log conductivity in the reference and  x i is the log conductivity ensemble standard deviation at cell i their evolution in time is shown in fig 10 for all 12 scenarios plus the r enkf with 50 and 500 ensemble realizations both values decrease in magnitude as time passes with the best performer being s11 highest values for number of observations number of realizations and reference variance followed by s8 same as s11 but with only 50 realizations note also how the rmse goes chaotic for the r enkf with 50 realizations after iteration 5 probably due to a problem with filter inbreeding very common in ensemble kalman filtering with few realizations finally figs 11 12 and 13 show how the piezometric heads are reproduced at the three control points observations were assimilated only until time step 26 vertical dashed line in all plots but the piezometric head evolution is shown until the end of the simulation period at time 100 all figures show the head simulation in the reference field from time zero dashed red line the average of all head simulations in the initial ensemble of realizations solid blue line and the average of the simulations in the updated log conductivity fields after 26 assimilation steps solid black line note that piezometric head axes vary for each plot to best display the results the graphs have been grouped by columns with each column corresponding to one of the three reference cases it is quite remarkable how the piezometric heads change from being completely off target at time zero to matching almost perfectly the reference head curves the minimal discrepancies between the mean of the simulated values and the reference happen in some of the scenarios with the smaller number of observations i e s4 and s5 for comparison purposes the head evolution in the log conductivity realizations obtained using the r enkf with 50 realizations is shown in fig 14 where it can be seen that the reproduction of the reference values is not as good as for the erff particularly for control points 1 and 2 5 conclusion a new data assimilation method the ensemble random forest filter erff has been proposed it is inspired by the ensemble kalman filter but replaces the linear updating step with a non linear update computed using random forests the erff uses an ensemble of log conductivity realizations and its associated ensemble of predicted piezometric heads to build a large training dataset that is an order of magnitude larger than the initial set of realizations the dataset size grows with the square of the number of realizations the random forest analyzes the differences in the predicted piezometric heads at observation locations with the differences in log conductivities throughout the domain learns from this training set and then predicts what should be the difference to be added to the log conductivity at each location in the domain once the head observations are collected and their differences with respect to the predictions evaluated the method has been tested in a number of scenarios with varying degrees of heterogeneity as measured by the standard deviation different number of realizations in the ensemble and different number of observation locations and it has been found to perform well in all scenarios and better than its benchmarking the restart ensemble kalman filter when the same number of realizations are used only when the number of realizations rises to 500 is the kalman filter capable of providing similar results but at a cost 2 2 times larger than the erff the main caveat of the proposal is as in most machine learning applications the choice of the hyperparameters that control the building of the random forests this task could be time consuming until a suitable set of hyperparameters is found that performs appropriately for the problem at hand research continues on the application of the erff to more complex problems such as those involving the identification of external stresses and boundary and initial conditions or the identification of more complex log conductivity patterns funding the authors acknowledge grant pid2019 109131rb i00 funded by mcin aei 10 13039 501100011033 and project inthemed which is part of the prima programme supported by the european union s horizon 2020 research and innovation programme under grant agreement no 1923 credit authorship contribution statement vanessa a godoy methodology software validation formal analysis investigation writing original draft visualization reviewing gian f napa garca methodology software reviewing j jaime gmez hernndez methodology software validation formal analysis investigation writing review editing visualization supervision funding acquisition reviewing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
2644,climate change constitutes a major threat for all the mediterranean countries due to the combination of large precipitation reductions and temperature increases and the higher frequency of climate extremes especially driving water scarcity and all the derived multi sectoral impacts portugal as most of the mediterranean countries already endures larger frequencies of droughts and deficits in soil moisture and water storage in the current study the future projections of soil moisture are examined using a multi model euro cordex regional climate ensemble in agreement with three future emission scenarios rcp2 6 4 5 and 8 5 the drivers of future soil moisture dynamics are also analysed and its effect on relative humidity and evaporation rates as expected the projections show a clear reduction of soil moisture through the entire annual cycle in response to the large decrease in precipitation and temperature increase via a massive growth of potential evapotranspiration the overall total soil moisture decreases ranges from 5 for the rcp2 6 to 20 10 for the rcp8 5 rcp4 5 w r t the present climate in the historical period soil moisture deficits rarely reach values 3x over the standard deviation but projections reveal that for the rcp4 5 rcp8 5 for the mid century deficits up to 5x 6x are projected to occur and for the end of century even 7x for the rcp8 5 the annual cycle of soil moisture is in present and future climate determined by precipitation and potential evapotranspiration and deficit is both enhanced and covers a wider monthly window in the future especially for the rcp8 5 the surface humidity also decreases importantly up to 4 and 8 in spring and summer in the end of the century in agreement with rcp4 5 and rcp8 5 respectively resulting from the projected changes in precipitation and potential evapotranspiration the typical semi arid climate which in present climate is confined to a small south eastern region of portugal is expected to cover almost 2 3 of the mainland in the case of rcp8 5 finally this study was developed in the framework of the national roadmap for adaptation xxi portuguese territorial climate change vulnerability assessment for xxi century rna2100 project and aims at delivering a deeper and different featuring of terrestrial water for adaptation purposes in a mediterranean country keywords soil moisture land water balance aridity climate change euro cordex portugal data availability data will be made available on request 1 introduction portugal in the western iberia is considered a climate change hotspot in a great extent due to the known projections of large temperature increases and reduction of precipitation cardoso et al 2019 lionello et al 2014 soares et al 2017a turco et al 2015 of the linked drought larger frequencies and severity hoerling et al 2012 spinoni et al 2017 and impacts on water agriculture forest and other sectors the portuguese mainland is characterized by large climate gradients associated with its location and geomorphological complexity located in southwestern europe facing the north atlantic in the transition between the sub tropical anticyclone and the subpolar storm tracking areas this geographical setting its orography and the land ocean thermal contrast defines large gradients of temperature and precipitation mean maximum temperatures peak at 35 c in the southeast and 24 c in the northwest soares et al 2012 this latter region is one of the wettest areas in europe with recorded mean annual accumulated precipitation more than 3 000 mm and in the se barely surpassing 400 mm soares et al 2012 these climate gradients also have associated a large interannual variability the occurrence of drought and desertification pscoa et al 2020 and in fact the portuguese mainland climate spans from humid cold in the north to semi arid in the southeast future projections for the portuguese climate are extremely worrying revealing widespread large temperature increases and precipitation reductions namely summer maximum temperature increase up to 7 c inland and 40 of annual precipitation decrease in the southern areas cardoso et al 2019 soares et al 2017a subsequently large increases of extremes as heatwaves consecutive dry days aridity and drought frequency and severity are projected miralles et al 2019 molina et al 2020 spinoni et al 2018 tramblay et al 2020 vicente serrano et al 2014 the latter have been assessed in a few studies based on drought indices such as pdsi palmer drought severity index spi standardized precipitation index and spei standardized precipitation evapotranspiration index soil moisture is a key hydrologic state variable driving the exchange of water and heat energy between the land surface and the atmosphere berg et al 2017 brocca et al 2012 mccoll et al 2017 miralles et al 2014 through evaporation and plant transpiration regulating surface temperature humidity and potentially affect precipitation though recycling processes eltahir 1998 ford et al 2018 miralles et al 2012 rios entenza et al 2014 soil moisture constitutes a fundamental element of the surface water budget determining the health or stress on land surface ecosystems and managed systems such as those in agriculture and agroforest chen et al 2014 miralles et al 2019 the surface water budget and therefore the soil moisture depends on precipitation plus irrigation when present soil infiltration surface runoff baseflow and evapotranspiration rockstrm et al 2010 seneviratne et al 2010 furthermore soil moisture based indices are used as indicators of agricultural droughts watson et al 2022 and soil moisture drought is one of the preconditioning effects for the development of extreme temperatures following the onset controlled by atmospheric dynamics hirschi et al 2014 humphrey et al 2021 seneviratne et al 2006 yin et al 2014 finally soil moisture is acknowledged as an essential climate variable by the global climate observing system albergel et al 2013 zhang et al 2019 global climate models gcms or the new generation earth system models esms and regional climate models rcms are the state of the art tools to understand the future climate in response to external forcings as the anthropogenic greenhouse gas emissions and land use changes ipcc 2021 2013 gcms and esms represent the large scale processes in a suitable way but fail to capture local to regional fundamental processes due to the coarse resolution often used and to shortcomings in the parametrization schemes in particular linked to convection and clouds randall et al 2007 rcms or limited area models focusing in smaller areas use much finer resolutions representing in an improved way local to regional processes such as the land atmosphere interactions and orographic and thermal circulations cardoso et al 2019 giorgi and mearns 1999 mcgregor 1997 rummukainen 2010 soares et al 2017b soares et al 2017a climate models simulate in a physical consistent way the climate system processes and in particular the water hydrologic cycle di luca et al 2012 feser et al 2011 rummukainen 2010 soares and cardoso 2018 recent studies reveal that pdsi spi and spei metrics often overestimate future increases in drought and decreases in water availability milly and dunne 2016 roderick et al 2015 swann et al 2016 consequently projections of future aridity should be grounded on direct model output of the land water balance precipitation evapotranspiration runoff and soil moisture instead of based on offline aridity and drought indices berg et al 2017 swann et al 2016 furthermore soil moisture constitutes a key information to define adaptation strategies aiming at decreasing damage due to rainfall reductions and warming and determine methods of optimization the management of natural ecosystems in the context of climate change the coordinated regional climate downscaling experiment cordex has the main goal of developing many rcm simulations to ensure an ensemble of high resolution projections throughout the 21st century for all regions of the world to support climate change impact and adaptation research the rcm simulations produced within euro cordex an european branch of cordex provides regional climate projections for europe at a horizontal grid resolution of about 12 km obtained by dynamically downscaling the gcms from cmip5 using a set of rcms the euro cordex simulations constitutes the most valuable dataset for assessing future climate change in europe and therefore in portugal many studies were performed evaluating euro cordex results over the full continent katragkou et al 2015 kotlarski et al 2014 specifically focusing on soil moisture and land atmosphere coupling knist et al 2017 and assessing the added value of rcms for precipitation and temperature cardoso and soares 2022 soares and cardoso 2018 knist et al 2017 revealed an overall good performance of euro cordex runs in simulating the soil moisture interannual variability whilst soares and cardoso 2018 and cardoso and soares 2022 reported the significant added value in the description of precipitation and temperature patterns over the european domain especially for extremes focusing in iberia herrera et al 2020 evaluated extensively the euro cordex evaluation runs and recently careto et al 2022a 2022b also quantified the added value of euro cordex rcms for iberia regarding temperatures and precipitation important gains in the representation of precipitation and temperature patterns and particularly in extremes over the iberian peninsula were identified by careto et al 2022a 2022b for portugal mainland euro cordex models were also extensively evaluated and used to project the future precipitation soares et al 2017a temperatures cardoso et al 2019 and wind resources nogueira et al 2019 based on the building of multi model ensembles and also depicting uncertainty the future evolution of surface soil moisture and aridity evolutions were still not addressed and have not been deeply examined for portugal to the best of our knowledge the present study takes advantage of the large euro cordex regional climate modelling database to project the future evolution of soil moisture and aridity in portugal and its main drivers euro cordex forced by cmip5 models is considered the best modelling portrayal of the regional climate evolution across europe for the twenty first century atmosphere in agreement with the representative concentration pathways rcps emission scenarios specifically our main goals are 1 characterize the pattern of soil moisture in portugal in present climate 2 depict the rcm future projections for soil moisture and aridity 3 to portray the main drivers associated with such a future evolution these questions are addressed in the framework of a weighted multi model ensemble of euro cordex models and the three different rcp emission scenarios rcp2 6 rcp4 5 and rcp8 5 in this way we aim at contributing to assist adaptation needs in portugal under the new national roadmap for adaptation xxi portuguese territorial climate change vulnerability assessment for xxi century rna2100 this multi variable multi model and multi scenario climate information is crucial to the development of storylines for mitigation and adaptation strategies for portugal regarding the water agriculture and forest sectors and ecosystems linked to the global emission trajectories the manuscript is organised as follows the datasets and the methodology applied are described in section 2 the main results regarding the future evolution of soil moisture and aridity over portugal are shown in section 3 and the main conclusions are presented in section 4 2 data and methods 2 1 euro cordex regional climate modelling data in this study the euro cordex high resolution regional climate simulations 0 11 resolution giorgi et al 2009 jacob et al 2020 jacob et al 2014 are used to investigate the climate projections for soil moisture and the related variables across mainland portugal three different future greenhouse gas emission scenarios rcp2 6 rcp4 5 and rcp8 5 are considered and three future time periods are analysed 2011 2040 2041 2070 and 2071 2100 to portray the soil moisture and the land water budget evolution in the 21st century the future changes rely on the comparison with the historical runs output for the period 1971 2000 in total 13 euro cordex simulations are considered covering all the experiments table 1 a set of variables were retrieved through the earth system grid federation esgf data portal and were used in this study such as daily total precipitation 2 m maximum and minimum daily temperatures 2 m specific humidity surface pressure daily mean 10 m wind speed upward latent heat flux total soil moisture content total runoff and evaporation flux 2 2 gleam dataset the global land evaporation amsterdam model gleam dataset version 3 is used to evaluate the soil moisture martens et al 2017 this dataset provides data of surface soil moisture based on satellite observed soil moisture that assimilates soil moisture from the european space agency climate change initiative esa cci vegetation optical depth and snow water equivalents this dataset spans from 1980 to 2020 and it provides data at a 0 25 horizontal resolution 2 3 soil moisture and land water balance properties to assess the future evolution of soil moisture and the land water balance a set of climate variables are needed some variables were directly retrieved from the esgf data portal as output of euro cordex rcms identified in previous section and others needed to be estimated such as evapotranspiration rate potential evapotranspiration and near surface air relative humidity in what concerns the total soil moisture the land surface models within the euro cordex rcms have different soil characteristics especially the number and depths of soil layers and the saturation levels knist et al 2017 consequently a direct comparison of the total soil moisture content is not meaningful however it is expected that the rcms can reproduce the typical intra annual and interannual variabilities as well as consistent future changes within the model system for each model the climatological mean total soil moisture sm was computed from the daily average euro cordex integrated soil moisture content in addition the standardised soil moisture anomaly was computed with respect to the daily means of the historical period and standardised by the daily standard deviations of the historical period orlowsky and seneviratne 2013 for precipitation and total runoff the climatological mean accumulation was computed from the daily average euro cordex data the evapotranspiration rate et was determined from the daily euro cordex upward latent heat flux at the surface hfls using the following equation 1 et hfls  where  is the latent heat of vaporization  2 501 0 00237 t 10 6 j kg 1 considering the 2 meter air temperature t the climatological mean accumulation of evapotranspiration was then computed the potential evapotranspiration for the reference culture pet was estimated from the food and agriculture organization fao penman monteith equation allen et al 1989 2 pet 0 408  r n g  900 t m 373 v h 2 e s e a   1 0 34 v h 2 where r n is the net radiation at the surface g is the soil heat flux density t m is the daily mean 2 m air temperature obtained by computing the average between the maximum and minimum 2 m temperature v h 2 is the daily mean 2 m wind speed obtained using a power law approximation using the daily mean 10 m wind speed e s is the saturation vapor pressure e a is the actual vapor pressure  is the psychrometric constant and  is the slope of the vapor pressure curve the land water balance expression was used to estimate the change of water content ds dt and it is expressed as seneviratne et al 2010 3 ds dt p e t r s r g where ds dt is the change of water content within the given layer p is the precipitation et is the evapotranspiration r s is the surface runoff and r g is the drainage here we used the total runoff r t output from the euro cordex rcms which is the sum of the surface runoff and the drainage the change of water content term includes the soil moisture surface water snow ice cover and groundwater that depends on the depth of the soil layer the near surface air relative humidity rh was computed from euro cordex 2 m air mean temperature 2 m specific humidity q and surface pressure p s using the following approximation 4 rh mr mr sat 1 0 x 100 where mr and mr sat are the mixing ratio and saturation mixing ratio computed as described in hardy 1998 finally the aridity index ai is defined as the ratio between the annual precipitation p and the annual potential evapotranspiration pet following the eq 5 5 ai p pet it is a critical environmental factor affecting the evolution of natural vegetation and therefore rain erosivity by considering rainfall and air temperature the aridity index climate classification system used here follows the description presented in table 2 2 4 weighted multi model ensemble based on precipitation and temperature a weighted multi model multi variable euro cordex were used in the present study to consistently assess the soil moisture and water balance budget in climate studies weighted multi model ensembles have been used since it improves the climate projections derived from ensembles brunner et al 2019 christensen et al 2010 eyring et al 2019 knutti et al 2017 sanderson et al 2017 it allows to generate more reliable regional climate projections and to constrain the uncertainty of climate modelling weighted methods are based on the individual model performance giving more weighting to models that better simulate the present climate of a given variable over a specific domain cardoso et al 2019 nogueira et al 2019 soares et al 2017a based on this assumption a new multi variable approach is used in this study this new approach is key to preserve the physical consistency among climate simulations and fosters the use of the multi model multi variable ensemble for impact modelling that often needs multi variable information in this way an extensive evaluation of the euro cordex available simulations was performed by comparing the historical results of precipitation maximum and minimum temperature against the iberia 01 dataset the recent observational gridded dataset herrera et al 2019 since the historical climate simulations has a non synchronised climate when compared to observations only statistical comparisons over climatology outputs can be performed a wide set of error metrics were considered to perform the assessment of the historical simulations for the 1971 2000 period mean bias mean absolute error root mean squared error normalized standard deviation spatial correlation willmott d score willmott et al 2012 perkins skill score perkins et al 2007 and yule kendall skewness ferro et al 2005 the assessment between the iberia01 and euro cordex models was done from monthly to yearly timescales only the pdf skill score measurements perkins skill score and yule kendall skewness use daily values from this evaluation a weighted multi model ensemble was proposed relying in the ability of rcms to capture the maximum and minimum temperatures and precipitation across portugal mainland to consider the multi variable approach a new weight for each model is computed where the precipitation weight corresponds to 50 and the maximum and minimum temperatures both contributes 25 the multi model ensemble is then computed with those weights for all the variables this new multi variable approach enhances the consistency to the assessment of future conditions of soil moisture and its main drivers such as precipitation evapotranspiration and runoff this new approach allows to preserve the physical consistency among climate simulations 2 5 analysis to assess the future evolution of soil moisture and the land water balance three future time periods are considered 2011 2040 2041 2070 and 2071 2100 from highly to non mitigated emission scenarios rcp2 6 rcp4 5 and rcp8 5 firstly the future climate of soil moisture is analysed through the spatial pattern and interannual variability in addition the pdfs probability density function of the standardised soil moisture anomaly are also examined then the drivers of the soil moisture depletion are investigated through the analysis of the land water balance components and other relevant variables finally the projected changes in the aridity index are explored in context of the previous analysis for all variables we computed the standard deviation of the multi model signal projections to characterize the spread and therefore the uncertainty associated with the corresponding projections the multi model ensemble v ens for each variable v n analysed in this study is obtained by computing a weighted average over the n ensemble members as 5 v ens n 1 n w n v n n 1 n w n similarly the ensemble averaged pdfs vp ens were obtained by computing a weighted average over all individual model pdfs 6 vp ens n 1 n w n p n the weights w n were obtained following the methodology described in the previous sub section all the analysis is performed over portugal domain fig s1 a and at the regional level fig s1b following the nomenclature of territorial units for statics nuts 3 results 3 1 future climate soil moisture as referred in the methods section for analysing the results it is rather important to keep in mind that the diverse rcms more precisely the land surface models within have different soil properties from the number and depths of sub surface layers to the specific characteristics represented therefore a direct comparison of the available total i e vertically integrated soil moisture is not meaningful notwithstanding the different mean total soil moisture values the rcms are expected to reproduce typical intra annual and interannual variabilities as well as coherent future changes within each model system knist et al 2017 in this sense we compare the total soil moisture from the multi model ensemble against the surface soil moisture from gleam dataset to be comparable the standardised soil moisture anomaly was computed and the results are presented in fig s2 in supplementary material for portugal mainland fig s2 a and for the nuts ii regions fig s2b the results presented need to be analysed carefully since there are important differences among the data used 1 we are compared the surface soil moisture in m3 m3 from gleam with the vertically integrated soil moisture kg m2 from the euro cordex multi model 2 the number of grid points considered in each region differ since the horizontal resolution is different in both data and 3 the period considered for the comparison is not the same for gleam we used a 30 year period from 1980 to 2009 and the multi model ensemble is spans the 1971 2000 period despite those differences the distribution of the soil moisture anomaly is quite similar between both data which give us confidence in using the soil moisture from the multi model ensemble to assess the future changes for portugal especially focusing on its distributional future changes the annual cycle of total soil moisture in portugal fig 1a given by the models corresponds to a typical mediterranean climate cycle where maximum values of soil moisture occur in late winter for portugal in february and minimum values in late summer september this annual cycle is rather pronounced and reveals a soil moisture annual amplitude of around 200 mm or one quarter of maximum winter values looking to the future projections of soil moisture fig 1 for the three time periods and three rcp scenarios overall as expected a clear and monotonous decrease with time and rcp of the full annual cycle is identified with much larger magnitudes when going from the rcp2 6 to rcp8 5 in fact for the rcp2 6 a rather small decrease of soil moisture if projected for almost all months and time periods under 3 in relative values and peaking in november in fact for this emission scenario a small recovery little increase and less decrease is seen when comparing the mid century and the end of century in spring for the rcp4 5 the reductions are gradually enhanced throughout the 21st century especially between the beginning and mid century and reaching 7 in november for 2071 2100 in spring and summer from mid century to end of century a small recovery or stabilization of soil moisture is projected for the rcp8 5 the soil moisture reductions are much more severe and always increasing throughout the century jumping from maximum reductions in november of around 3 in 2011 2041 to 9 and 14 in mid and end of century respectively overall some changes in the annual cycle may be identified besides the omnipresent decreases of water availability in the soil for portugal mainland the annual soil moisture amplitude is projected to augment slightly for the rcp2 6 the one showing a rather small diminishing of soil moisture as well as for the rcp4 5 but in a mitigated manner for the rcp8 5 the severe reductions of soil moisture throughout the year are accompanied by a decrease of the annual soil moisture amplitude in absolute values table s1 a spatial view of the projected soil moisture changes at the annual and seasonal scales for the three time periods and the three emission scenarios is displayed in fig 2 focusing absolute for relative values in fig s3 the future projections display a clear reduction of soil moisture especially for the rcp4 5 and rcp8 5 pointing to a dramatic aggravation of water scarcity throughout the 21st century in portugal if emissions are not reduced for the first future period all scenarios have associated projections of a small reduction of annual soil moisture smaller than 40 mm but that intensifies greatly with time and scenario for the mid century the projected reductions for the rcp4 5 are between 40 and 80 mm for all the southern of portugal and for the rcp8 5 almost those reach values in the range of 80 and 120 mm for the south and 40 and 80 mm for the north for the end of the century the soil moisture decrease is enhanced for the rcp8 5 attaining values between 120 and 160 mm for large extensions of the southern regions this change dynamics also applies in a great measure for all the seasons with some exceptions for spring the projections according to the rcp2 6 reveals some increases of soil moisture for the end of the century in some mountainous and big river valleys such as the tagus and for autumn the decreases of soil moisture associated with the rcp8 5 are more homogeneous spatially in fig 3 the pdfs of soil moisture anomalies normalized by the respective standard deviations are displayed for the historical and future periods and in agreement with the three rcp scenarios for portugal mainland fig 3a and for the nuts ii regions fig 3b strikingly the soil moisture pdfs time evolution in response to the emissions scenarios reminds immediately the temperature classical shift and flattened pdfs where a great increase of extreme temperature occurrence is identified both due to the lateral shift and the flattening of the temperature pdfs in fact the soil moisture pdfs reveal distinct shifts and flattening in an increasingly manner with time and scenario which corresponds to multiplying for various orders of magnitude the occurrence of soil moisture deficits w r t the historical climate for portugal and the period 2011 2040 a very slight shift for lower soil moisture values and flattening of the pdfs is seen for all rcps for the rcp2 6 the pdfs remain rather unchanged for all future time periods but for the rcp4 5 and rcp8 5 those pdf changes are enhanced in 2041 2070 and further in 2071 2100 in the historical period soil moisture deficits rarely reach values 3x over the standard deviation but projections reveal that for the rcp4 5 rcp8 5 for the mid century deficits up to 5x 6x are projected to occur and for the end of century even 7x for the rcp8 5 the shift for lower values and the flattening of the soil moisture pdfs is projected for all portuguese nuts ii regions from north to south however the pdf s projected modifications are more severe for the two southern regions alentejo and algarve these regions are already presently the ones suffering recurrently of water scarcity problems with impacts even on public water supply for human consummation for these regions in the case of rcp8 5 a dramatic decrease of the occurrences when soil moisture anomalies will be positive is projected and for example deficits of 3x the standard deviation historical are projected to increase from 0 06 in the historical period to 3 at mid of century and 4 at end of century so as impressive as 67x noteworthy if mitigation is pursued and rcp2 6 achieved the pdfs for those regions almost do not change when compared with the historical period 3 2 drivers of future soil moisture and humidity depletion the dramatic decrease in soil water availability soil moisture in the context of climate change is primarily linked to the projected reductions of precipitation cos et al 2022 soares et al 2017a and large increase of temperature cardoso et al 2019 cos et al 2022 but its physical interdependences overall and at the seasonal cycle setting are explored next in fig 4 an overall view of the land soil water balance for mainland portugal is presented the change of water content depends on the budget between precipitation evapotranspiration and total runoff in all periods from present to future climates the water balanced at the annual scale is firstly controlled by precipitation and then evapotranspiration and runoff for the first period 2011 2040 there is a small reduction of all water balance terms for all scenarios these decreases are much enhanced in the mid century period in agreement with the rcp4 5 and rcp8 5 to the projected decrease in precipitation an important reduction in runoff and water content follows the evapotranspiration suffers a smaller relative decrease for the rcp2 6 the overall precipitation and runoff increase slightly the mid century changes for all term contributions are accentuated in the end of the century especially for the rcp8 5 all terms increase slightly w r t present climate but the water content appears a bit reduced for the rcp2 6 in agreement with the rcp8 5 precipitation evapotranspiration and runoff diminish relatively 21 10 and 35 which results in a water content depletion of 23 looking at the annual cycle of the water budged terms and related variables for the historical period allows understanding the soil moisture dynamics and its projected depletion in future climate scenarios fig 5 a shows the seasonal cycle of precipitation estimated potential evapotranspiration evapotranspiration their balance and total runoff as well in fig 5b the total soil moisture annual cycle is displayed the seasonal dynamics is dominated by precipitation which is almost inexistent in summer and it is maximum in winter in opposite sense evapotranspiration potential evapotranspiration displays minimum values in winter and maximum in may june july in fact evapotranspiration potential evapotranspiration exceeds precipitation in may through september april to september which results in a major net soil water deficit in those periods total runoff seems to respond quickly to precipitation in the first half of the year and afterwards slower the total soil moisture fig 5b closely follows the p p e t p e t seasonal cycle and the order of magnitude with a time lag of two months except for winter meaning that soil moisture is drove by the climate forcing two months later figs 6 and 7 reveals how the water balance terms are projected to change accordingly to the three future scenarios overall the larger precipitation reductions are projected to occur in spring and autumn which will determine an earlier exceedance of both evapotranspiration and potential evapotranspiration over precipitation i e an earlier reduction of water availability and a smaller amount of water to be deposit in the soil this water deficit is further enhanced in summer and in autumn both because of the precipitation reduction the increase of potential evapotranspiration and the relatively small reduction in evapotranspiration again future precipitation reductions seem to drive the total soil moisture decreases with a one month to a two month lag the larger absolute reductions in total soil moisture will occur in late spring may june and early winter november december in the sequence of the larger deceases in precipitation of april and october november in what concerns the projected changes of total runoff it follows the signal of precipitation changes the projected changes of surface relative humidity rh linked to the response to the surface water balance is also shown in fig 6g for the annual cycle and its spatial view on fig s4 the surface relative humidity is an important meteorological parameter that controls the atmospheric evaporative demand changes in relative humidity may have strong implications for ecosystems hydrological cycle climate aridity and drought events through the evolution of the evaporative demand vicente serrano et al 2018 with increasing surface temperature the amount of water vapour in the atmosphere increases whenever the air is not saturated saturated vapour pressure increases exponentially with temperature as expected from the clausius clapeyron relation and in some regions the amount of water vapour in the atmosphere has been increasing in excess of 7 per kelvin willett et al 2010 however increasing global temperatures are not translated into increasing relative humidity over land the opposite or a plateauing of rh has been observed simmons et al 2010 in large regions of the globe the majority of moisture over land has origins over the oceans since oceans are warming at a lower rate than the land surface the rate of evaporation over their surfaces is lower than over land thus the amount of moisture advected from the oceans into the land areas is not enough to keep the ratio between the air s vapour pressure and the saturated vapour pressure constant and a decrease in rh is observed in some areas like portugal changes to general circulation also imply a reduction in moister transport from the oceans further reducing the moisture availability escalating surface warming and increasing the saturated vapour pressure for all scenarios the projected humidity reductions are larger from spring to autumn in rcp 2 6 relative humidity fig 6g decreases by less than 2 5 while in rcp 4 5 reductions reach 4 in the beginning and end of the summer for areas near the coast and reductions up to 4 are expected near the spanish border fig s4 in rcp 8 5 a reduction between 0 and 5 is projected by mid century and a further reduction up to 8 in october 6 in areas near the border with spain by the end of the century in winter the advection of moist air accompanying the winter storms with their expected increase in intensity i e including more moisture is enough to imply an increase in rh for mainland portugal for rcp2 6 and for the regions above the tagus river in rcp 4 5 fig s4 in rcp 8 5 not only a decrease of precipitation is projected but also a significant increase in temperature thus the projected decline of rh the reduction in rcp8 5 is particularly severe in the north eastern regions during summer where relative humidity is projected to decrease between 6 and 8 exacerbated by the extreme rise in surface temperatures the uncertainty of the rh projections is high with the multi model spread up to 75 of ensemble value for rcp2 6 and rcp 4 5 not shown in rcp 8 5 there is lower spread about 50 importantly for water bodies and water saturated soils the potential evapotranspiration increases in all scenarios up to mid 21st century fig s5 the projected increase in pet primarily occurs due to similar processes that lead to the reduction in rh which leads to an increase in vapor pressure deficit over land and the nonlinear increase of saturation vapor pressure as a function of temperature associated to the clausius clapeyron relationship scheff and frierson 2014 sherwood and fu 2014 since under the rcp2 6 scenario temperature stabilises by mid century not shown no further increase in pet is projected until the end of the century overall a rise lower than 10 is projected in scenario rcp4 5 temperature rises at a smaller rate from mid century onwards thus in most regions pet stabilises and an increase between 10 and 15 is projected at the end of the century in rcp8 5 the sharp rise in temperature leads to an enhancement up to 30 in pet in the north by the end of the century the highest rise in pet occurs in the northeast during autumn at the end of the century in rcp8 5 once again the multi model spread is almost as large as the climate change signal indicating a large uncertainty associated to the et0 computation not shown the reduced soil moisture contributes to the overall reduction of evaporation at the surface fig s5 particularly in summer and autumn and in the south of the country as before the multi model spread is large and in summer and autumn it is as large as the climate change signal in rcp8 5 not shown 3 3 semi arid climate overtaking portugal subsequently to the water balance changes explored before and in agreement with the soil moisture depletion it can be seen that portugal is projected to become prevalently a semi arid climate country in fig 8 the aridity index is displayed which relies on precipitation and evapotranspiration historically the portuguese climate is humid in north centre and a small southwest stripe and in the rest of the south dry subhumid and semiarid in a small southeastern area in the east of the country also two small areas are characterized by dry subhumid climate looking at the projections in agreement with the rcp2 6 the portuguese climate does not suffer almost any modification for the rcp4 5 a small expansion of the dry subhumid and semiarid climates is projected especially in the south and centre regions but for the rcp8 5 those expansions are much more severe throughout the century in the mid century the semiarid climate extends almost through all the south the dry subhumid migrates northerly and the small areas in the eastern border are replaced by semiarid climates furthermore in the end of century only roughly the northwestern third of the country remains with humid climate and the rest is almost all covered by semiarid 4 conclusions the mediterranean countries are considered a hotspot of climate change in great measure due to the expected changes in water availability linked to precipitation decrease and regional warming cramer et al 2018 giorgi 2006 lionello and scarascia 2018 terrestrial ecosystems agricultural and forests critically depend on water availability in the soils i e soil water content and at the surface layer soil moisture chen et al 2014 miralles et al 2019 some studies have pointed clearly that associated with climate change the mediterranean countries will endure faster and intense soil dissection enhancing droughts and water scarcity milano et al 2013 nguyen et al 2016 moreover soil moisture depletion contributes as well to regional to local land atmosphere feedbacks that promote the occurrence and mutual intensification of heatwaves and droughts in the current study an analysis of the future soil moisture and aridity in portugal was performed using a high quality multi model ensemble from euro cordex for three future time periods and three rcp emission scenarios rcp2 6 rcp4 5 and rcp8 5 in response to the severe projections of precipitation reductions regional warming and the subsequent large increase of potential evapotranspiration a very impressive decrease in soil moisture is projected the soil moisture depletion is reflected both on mean values the full annual cycle and more severely on the occurrence of low extreme values when compared to the historical climate the future projections display a clear reduction of soil water moisture especially for the rcp4 5 and rcp8 5 pointing to a dramatic aggravation of water scarcity throughout the 21st century in portugal if emissions are not reduced for the mid century the projected reductions for the rcp4 5 are between 40 and 80 mm for all the southern of portugal and for the rcp8 5 almost reach values in the range of 80 and 120 mm for the south and 40 and 80 mm for the north for the end of the century the soil moisture decrease is enhanced for the rcp8 5 attaining values between 120 and 160 mm for large extensions of the southern regions these latter projected changes in the total soil moisture regard all the annual cycle with relative decrease values between 10 and 15 for the rcp8 5 in what concerns to extreme total soil moisture values there is a pronounced shift for much negative values and as well a flattening of the distributions much like what is projected for temperature in many regions of the world the shift for lower values and the flattening of the soil moisture pdfs is projected for all portuguese nuts ii regions from north to south however the pdf s projected modifications are more severe for the two southern regions alentejo and algarve in the historical period soil moisture deficits rarely reach values 3x over the standard deviation but projections reveal that for the rcp4 5 rcp8 5 for the mid century deficits up to 5x 6x are projected to occur and for the end of century even 7x for the rcp8 5 the main drivers of future total soil moisture reductions are clearly determined as the precipitation decreases and the augment of potential evapotranspiration throughout the full annual cycle also associated with the increase of evapotranspiration in winter when there is still water availability to evaporate especially for the rcp8 5 in the rest of the annual cycle there is a decrease of evapotranspiration since soil moisture is greatly depleted at the surface relative humidity is projected to decrease for the rcp4 5 and rcp8 5 and in a less extent for rcp2 6 for fcp8 5 the rh reduction is particularly severe in the north eastern regions during summer where relative humidity is projected to decrease between 6 and 8 it is important to mention that as in relative humidity and potential evapotranspiration the multi model spread is large conducting to uncertainty of climate change projections in soil moisture and evaporation in result of all these projected changes in the water cycle related variables the portuguese climate is projected to become much more semi arid for the rcp8 5 for the end of century only roughly the north western third of the country remains with humid climate and the rest is almost all covered by semiarid in opposite manner for the rcp2 6 the spatial extension of semi arid climate remains largely unchanged when compared to historical climate confined to a small south eastern region finally the future panorama of water scarcity here depicted will impact dramatically many portuguese ecosystems and economic sectors dependent on them such as agriculture forests and tourism these are expected to have to face levels of adaptation immensely different according to the degree of global mitigation of greenhouse gas emissions this study aimed at giving a less common view of the terrestrial water availability for the future of portugal declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to acknowledge the financial support of portuguese fct i p mctes through national funds piddac uidb 50019 2020 instituto dom luiz and eea financial mechanism 2014 2021 and the portuguese environment agency through pre defined project 2 national roadmap for adaptation xxi pdp 2 the authors wish to acknowledge the leading ptdc cta met 28914 2017 project funded by fct we also acknowledge the world climate research programme s working group on regional climate and the working group on coupled modelling former coordinating body of cordex and responsible panel for cmip5 we also thank the climate modelling groups for producing and making available their model output we also acknowledge the earth system grid federation infrastructure an international effort led by the u s department of energy s program for climate model diagnosis and intercomparison the european network for earth system modelling and other partners in the global organisation for earth system science portals go essp funding sources dcal are funded by pre defined project 2 national roadmap for adaptation xxi pdp 2 the publication of this research is funded by the portuguese fct i p mctes through national funds piddac uidb 50019 2020 idl and the pre defined project 2 national roadmap for adaptation xxi pdp 2 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128731 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2644,climate change constitutes a major threat for all the mediterranean countries due to the combination of large precipitation reductions and temperature increases and the higher frequency of climate extremes especially driving water scarcity and all the derived multi sectoral impacts portugal as most of the mediterranean countries already endures larger frequencies of droughts and deficits in soil moisture and water storage in the current study the future projections of soil moisture are examined using a multi model euro cordex regional climate ensemble in agreement with three future emission scenarios rcp2 6 4 5 and 8 5 the drivers of future soil moisture dynamics are also analysed and its effect on relative humidity and evaporation rates as expected the projections show a clear reduction of soil moisture through the entire annual cycle in response to the large decrease in precipitation and temperature increase via a massive growth of potential evapotranspiration the overall total soil moisture decreases ranges from 5 for the rcp2 6 to 20 10 for the rcp8 5 rcp4 5 w r t the present climate in the historical period soil moisture deficits rarely reach values 3x over the standard deviation but projections reveal that for the rcp4 5 rcp8 5 for the mid century deficits up to 5x 6x are projected to occur and for the end of century even 7x for the rcp8 5 the annual cycle of soil moisture is in present and future climate determined by precipitation and potential evapotranspiration and deficit is both enhanced and covers a wider monthly window in the future especially for the rcp8 5 the surface humidity also decreases importantly up to 4 and 8 in spring and summer in the end of the century in agreement with rcp4 5 and rcp8 5 respectively resulting from the projected changes in precipitation and potential evapotranspiration the typical semi arid climate which in present climate is confined to a small south eastern region of portugal is expected to cover almost 2 3 of the mainland in the case of rcp8 5 finally this study was developed in the framework of the national roadmap for adaptation xxi portuguese territorial climate change vulnerability assessment for xxi century rna2100 project and aims at delivering a deeper and different featuring of terrestrial water for adaptation purposes in a mediterranean country keywords soil moisture land water balance aridity climate change euro cordex portugal data availability data will be made available on request 1 introduction portugal in the western iberia is considered a climate change hotspot in a great extent due to the known projections of large temperature increases and reduction of precipitation cardoso et al 2019 lionello et al 2014 soares et al 2017a turco et al 2015 of the linked drought larger frequencies and severity hoerling et al 2012 spinoni et al 2017 and impacts on water agriculture forest and other sectors the portuguese mainland is characterized by large climate gradients associated with its location and geomorphological complexity located in southwestern europe facing the north atlantic in the transition between the sub tropical anticyclone and the subpolar storm tracking areas this geographical setting its orography and the land ocean thermal contrast defines large gradients of temperature and precipitation mean maximum temperatures peak at 35 c in the southeast and 24 c in the northwest soares et al 2012 this latter region is one of the wettest areas in europe with recorded mean annual accumulated precipitation more than 3 000 mm and in the se barely surpassing 400 mm soares et al 2012 these climate gradients also have associated a large interannual variability the occurrence of drought and desertification pscoa et al 2020 and in fact the portuguese mainland climate spans from humid cold in the north to semi arid in the southeast future projections for the portuguese climate are extremely worrying revealing widespread large temperature increases and precipitation reductions namely summer maximum temperature increase up to 7 c inland and 40 of annual precipitation decrease in the southern areas cardoso et al 2019 soares et al 2017a subsequently large increases of extremes as heatwaves consecutive dry days aridity and drought frequency and severity are projected miralles et al 2019 molina et al 2020 spinoni et al 2018 tramblay et al 2020 vicente serrano et al 2014 the latter have been assessed in a few studies based on drought indices such as pdsi palmer drought severity index spi standardized precipitation index and spei standardized precipitation evapotranspiration index soil moisture is a key hydrologic state variable driving the exchange of water and heat energy between the land surface and the atmosphere berg et al 2017 brocca et al 2012 mccoll et al 2017 miralles et al 2014 through evaporation and plant transpiration regulating surface temperature humidity and potentially affect precipitation though recycling processes eltahir 1998 ford et al 2018 miralles et al 2012 rios entenza et al 2014 soil moisture constitutes a fundamental element of the surface water budget determining the health or stress on land surface ecosystems and managed systems such as those in agriculture and agroforest chen et al 2014 miralles et al 2019 the surface water budget and therefore the soil moisture depends on precipitation plus irrigation when present soil infiltration surface runoff baseflow and evapotranspiration rockstrm et al 2010 seneviratne et al 2010 furthermore soil moisture based indices are used as indicators of agricultural droughts watson et al 2022 and soil moisture drought is one of the preconditioning effects for the development of extreme temperatures following the onset controlled by atmospheric dynamics hirschi et al 2014 humphrey et al 2021 seneviratne et al 2006 yin et al 2014 finally soil moisture is acknowledged as an essential climate variable by the global climate observing system albergel et al 2013 zhang et al 2019 global climate models gcms or the new generation earth system models esms and regional climate models rcms are the state of the art tools to understand the future climate in response to external forcings as the anthropogenic greenhouse gas emissions and land use changes ipcc 2021 2013 gcms and esms represent the large scale processes in a suitable way but fail to capture local to regional fundamental processes due to the coarse resolution often used and to shortcomings in the parametrization schemes in particular linked to convection and clouds randall et al 2007 rcms or limited area models focusing in smaller areas use much finer resolutions representing in an improved way local to regional processes such as the land atmosphere interactions and orographic and thermal circulations cardoso et al 2019 giorgi and mearns 1999 mcgregor 1997 rummukainen 2010 soares et al 2017b soares et al 2017a climate models simulate in a physical consistent way the climate system processes and in particular the water hydrologic cycle di luca et al 2012 feser et al 2011 rummukainen 2010 soares and cardoso 2018 recent studies reveal that pdsi spi and spei metrics often overestimate future increases in drought and decreases in water availability milly and dunne 2016 roderick et al 2015 swann et al 2016 consequently projections of future aridity should be grounded on direct model output of the land water balance precipitation evapotranspiration runoff and soil moisture instead of based on offline aridity and drought indices berg et al 2017 swann et al 2016 furthermore soil moisture constitutes a key information to define adaptation strategies aiming at decreasing damage due to rainfall reductions and warming and determine methods of optimization the management of natural ecosystems in the context of climate change the coordinated regional climate downscaling experiment cordex has the main goal of developing many rcm simulations to ensure an ensemble of high resolution projections throughout the 21st century for all regions of the world to support climate change impact and adaptation research the rcm simulations produced within euro cordex an european branch of cordex provides regional climate projections for europe at a horizontal grid resolution of about 12 km obtained by dynamically downscaling the gcms from cmip5 using a set of rcms the euro cordex simulations constitutes the most valuable dataset for assessing future climate change in europe and therefore in portugal many studies were performed evaluating euro cordex results over the full continent katragkou et al 2015 kotlarski et al 2014 specifically focusing on soil moisture and land atmosphere coupling knist et al 2017 and assessing the added value of rcms for precipitation and temperature cardoso and soares 2022 soares and cardoso 2018 knist et al 2017 revealed an overall good performance of euro cordex runs in simulating the soil moisture interannual variability whilst soares and cardoso 2018 and cardoso and soares 2022 reported the significant added value in the description of precipitation and temperature patterns over the european domain especially for extremes focusing in iberia herrera et al 2020 evaluated extensively the euro cordex evaluation runs and recently careto et al 2022a 2022b also quantified the added value of euro cordex rcms for iberia regarding temperatures and precipitation important gains in the representation of precipitation and temperature patterns and particularly in extremes over the iberian peninsula were identified by careto et al 2022a 2022b for portugal mainland euro cordex models were also extensively evaluated and used to project the future precipitation soares et al 2017a temperatures cardoso et al 2019 and wind resources nogueira et al 2019 based on the building of multi model ensembles and also depicting uncertainty the future evolution of surface soil moisture and aridity evolutions were still not addressed and have not been deeply examined for portugal to the best of our knowledge the present study takes advantage of the large euro cordex regional climate modelling database to project the future evolution of soil moisture and aridity in portugal and its main drivers euro cordex forced by cmip5 models is considered the best modelling portrayal of the regional climate evolution across europe for the twenty first century atmosphere in agreement with the representative concentration pathways rcps emission scenarios specifically our main goals are 1 characterize the pattern of soil moisture in portugal in present climate 2 depict the rcm future projections for soil moisture and aridity 3 to portray the main drivers associated with such a future evolution these questions are addressed in the framework of a weighted multi model ensemble of euro cordex models and the three different rcp emission scenarios rcp2 6 rcp4 5 and rcp8 5 in this way we aim at contributing to assist adaptation needs in portugal under the new national roadmap for adaptation xxi portuguese territorial climate change vulnerability assessment for xxi century rna2100 this multi variable multi model and multi scenario climate information is crucial to the development of storylines for mitigation and adaptation strategies for portugal regarding the water agriculture and forest sectors and ecosystems linked to the global emission trajectories the manuscript is organised as follows the datasets and the methodology applied are described in section 2 the main results regarding the future evolution of soil moisture and aridity over portugal are shown in section 3 and the main conclusions are presented in section 4 2 data and methods 2 1 euro cordex regional climate modelling data in this study the euro cordex high resolution regional climate simulations 0 11 resolution giorgi et al 2009 jacob et al 2020 jacob et al 2014 are used to investigate the climate projections for soil moisture and the related variables across mainland portugal three different future greenhouse gas emission scenarios rcp2 6 rcp4 5 and rcp8 5 are considered and three future time periods are analysed 2011 2040 2041 2070 and 2071 2100 to portray the soil moisture and the land water budget evolution in the 21st century the future changes rely on the comparison with the historical runs output for the period 1971 2000 in total 13 euro cordex simulations are considered covering all the experiments table 1 a set of variables were retrieved through the earth system grid federation esgf data portal and were used in this study such as daily total precipitation 2 m maximum and minimum daily temperatures 2 m specific humidity surface pressure daily mean 10 m wind speed upward latent heat flux total soil moisture content total runoff and evaporation flux 2 2 gleam dataset the global land evaporation amsterdam model gleam dataset version 3 is used to evaluate the soil moisture martens et al 2017 this dataset provides data of surface soil moisture based on satellite observed soil moisture that assimilates soil moisture from the european space agency climate change initiative esa cci vegetation optical depth and snow water equivalents this dataset spans from 1980 to 2020 and it provides data at a 0 25 horizontal resolution 2 3 soil moisture and land water balance properties to assess the future evolution of soil moisture and the land water balance a set of climate variables are needed some variables were directly retrieved from the esgf data portal as output of euro cordex rcms identified in previous section and others needed to be estimated such as evapotranspiration rate potential evapotranspiration and near surface air relative humidity in what concerns the total soil moisture the land surface models within the euro cordex rcms have different soil characteristics especially the number and depths of soil layers and the saturation levels knist et al 2017 consequently a direct comparison of the total soil moisture content is not meaningful however it is expected that the rcms can reproduce the typical intra annual and interannual variabilities as well as consistent future changes within the model system for each model the climatological mean total soil moisture sm was computed from the daily average euro cordex integrated soil moisture content in addition the standardised soil moisture anomaly was computed with respect to the daily means of the historical period and standardised by the daily standard deviations of the historical period orlowsky and seneviratne 2013 for precipitation and total runoff the climatological mean accumulation was computed from the daily average euro cordex data the evapotranspiration rate et was determined from the daily euro cordex upward latent heat flux at the surface hfls using the following equation 1 et hfls  where  is the latent heat of vaporization  2 501 0 00237 t 10 6 j kg 1 considering the 2 meter air temperature t the climatological mean accumulation of evapotranspiration was then computed the potential evapotranspiration for the reference culture pet was estimated from the food and agriculture organization fao penman monteith equation allen et al 1989 2 pet 0 408  r n g  900 t m 373 v h 2 e s e a   1 0 34 v h 2 where r n is the net radiation at the surface g is the soil heat flux density t m is the daily mean 2 m air temperature obtained by computing the average between the maximum and minimum 2 m temperature v h 2 is the daily mean 2 m wind speed obtained using a power law approximation using the daily mean 10 m wind speed e s is the saturation vapor pressure e a is the actual vapor pressure  is the psychrometric constant and  is the slope of the vapor pressure curve the land water balance expression was used to estimate the change of water content ds dt and it is expressed as seneviratne et al 2010 3 ds dt p e t r s r g where ds dt is the change of water content within the given layer p is the precipitation et is the evapotranspiration r s is the surface runoff and r g is the drainage here we used the total runoff r t output from the euro cordex rcms which is the sum of the surface runoff and the drainage the change of water content term includes the soil moisture surface water snow ice cover and groundwater that depends on the depth of the soil layer the near surface air relative humidity rh was computed from euro cordex 2 m air mean temperature 2 m specific humidity q and surface pressure p s using the following approximation 4 rh mr mr sat 1 0 x 100 where mr and mr sat are the mixing ratio and saturation mixing ratio computed as described in hardy 1998 finally the aridity index ai is defined as the ratio between the annual precipitation p and the annual potential evapotranspiration pet following the eq 5 5 ai p pet it is a critical environmental factor affecting the evolution of natural vegetation and therefore rain erosivity by considering rainfall and air temperature the aridity index climate classification system used here follows the description presented in table 2 2 4 weighted multi model ensemble based on precipitation and temperature a weighted multi model multi variable euro cordex were used in the present study to consistently assess the soil moisture and water balance budget in climate studies weighted multi model ensembles have been used since it improves the climate projections derived from ensembles brunner et al 2019 christensen et al 2010 eyring et al 2019 knutti et al 2017 sanderson et al 2017 it allows to generate more reliable regional climate projections and to constrain the uncertainty of climate modelling weighted methods are based on the individual model performance giving more weighting to models that better simulate the present climate of a given variable over a specific domain cardoso et al 2019 nogueira et al 2019 soares et al 2017a based on this assumption a new multi variable approach is used in this study this new approach is key to preserve the physical consistency among climate simulations and fosters the use of the multi model multi variable ensemble for impact modelling that often needs multi variable information in this way an extensive evaluation of the euro cordex available simulations was performed by comparing the historical results of precipitation maximum and minimum temperature against the iberia 01 dataset the recent observational gridded dataset herrera et al 2019 since the historical climate simulations has a non synchronised climate when compared to observations only statistical comparisons over climatology outputs can be performed a wide set of error metrics were considered to perform the assessment of the historical simulations for the 1971 2000 period mean bias mean absolute error root mean squared error normalized standard deviation spatial correlation willmott d score willmott et al 2012 perkins skill score perkins et al 2007 and yule kendall skewness ferro et al 2005 the assessment between the iberia01 and euro cordex models was done from monthly to yearly timescales only the pdf skill score measurements perkins skill score and yule kendall skewness use daily values from this evaluation a weighted multi model ensemble was proposed relying in the ability of rcms to capture the maximum and minimum temperatures and precipitation across portugal mainland to consider the multi variable approach a new weight for each model is computed where the precipitation weight corresponds to 50 and the maximum and minimum temperatures both contributes 25 the multi model ensemble is then computed with those weights for all the variables this new multi variable approach enhances the consistency to the assessment of future conditions of soil moisture and its main drivers such as precipitation evapotranspiration and runoff this new approach allows to preserve the physical consistency among climate simulations 2 5 analysis to assess the future evolution of soil moisture and the land water balance three future time periods are considered 2011 2040 2041 2070 and 2071 2100 from highly to non mitigated emission scenarios rcp2 6 rcp4 5 and rcp8 5 firstly the future climate of soil moisture is analysed through the spatial pattern and interannual variability in addition the pdfs probability density function of the standardised soil moisture anomaly are also examined then the drivers of the soil moisture depletion are investigated through the analysis of the land water balance components and other relevant variables finally the projected changes in the aridity index are explored in context of the previous analysis for all variables we computed the standard deviation of the multi model signal projections to characterize the spread and therefore the uncertainty associated with the corresponding projections the multi model ensemble v ens for each variable v n analysed in this study is obtained by computing a weighted average over the n ensemble members as 5 v ens n 1 n w n v n n 1 n w n similarly the ensemble averaged pdfs vp ens were obtained by computing a weighted average over all individual model pdfs 6 vp ens n 1 n w n p n the weights w n were obtained following the methodology described in the previous sub section all the analysis is performed over portugal domain fig s1 a and at the regional level fig s1b following the nomenclature of territorial units for statics nuts 3 results 3 1 future climate soil moisture as referred in the methods section for analysing the results it is rather important to keep in mind that the diverse rcms more precisely the land surface models within have different soil properties from the number and depths of sub surface layers to the specific characteristics represented therefore a direct comparison of the available total i e vertically integrated soil moisture is not meaningful notwithstanding the different mean total soil moisture values the rcms are expected to reproduce typical intra annual and interannual variabilities as well as coherent future changes within each model system knist et al 2017 in this sense we compare the total soil moisture from the multi model ensemble against the surface soil moisture from gleam dataset to be comparable the standardised soil moisture anomaly was computed and the results are presented in fig s2 in supplementary material for portugal mainland fig s2 a and for the nuts ii regions fig s2b the results presented need to be analysed carefully since there are important differences among the data used 1 we are compared the surface soil moisture in m3 m3 from gleam with the vertically integrated soil moisture kg m2 from the euro cordex multi model 2 the number of grid points considered in each region differ since the horizontal resolution is different in both data and 3 the period considered for the comparison is not the same for gleam we used a 30 year period from 1980 to 2009 and the multi model ensemble is spans the 1971 2000 period despite those differences the distribution of the soil moisture anomaly is quite similar between both data which give us confidence in using the soil moisture from the multi model ensemble to assess the future changes for portugal especially focusing on its distributional future changes the annual cycle of total soil moisture in portugal fig 1a given by the models corresponds to a typical mediterranean climate cycle where maximum values of soil moisture occur in late winter for portugal in february and minimum values in late summer september this annual cycle is rather pronounced and reveals a soil moisture annual amplitude of around 200 mm or one quarter of maximum winter values looking to the future projections of soil moisture fig 1 for the three time periods and three rcp scenarios overall as expected a clear and monotonous decrease with time and rcp of the full annual cycle is identified with much larger magnitudes when going from the rcp2 6 to rcp8 5 in fact for the rcp2 6 a rather small decrease of soil moisture if projected for almost all months and time periods under 3 in relative values and peaking in november in fact for this emission scenario a small recovery little increase and less decrease is seen when comparing the mid century and the end of century in spring for the rcp4 5 the reductions are gradually enhanced throughout the 21st century especially between the beginning and mid century and reaching 7 in november for 2071 2100 in spring and summer from mid century to end of century a small recovery or stabilization of soil moisture is projected for the rcp8 5 the soil moisture reductions are much more severe and always increasing throughout the century jumping from maximum reductions in november of around 3 in 2011 2041 to 9 and 14 in mid and end of century respectively overall some changes in the annual cycle may be identified besides the omnipresent decreases of water availability in the soil for portugal mainland the annual soil moisture amplitude is projected to augment slightly for the rcp2 6 the one showing a rather small diminishing of soil moisture as well as for the rcp4 5 but in a mitigated manner for the rcp8 5 the severe reductions of soil moisture throughout the year are accompanied by a decrease of the annual soil moisture amplitude in absolute values table s1 a spatial view of the projected soil moisture changes at the annual and seasonal scales for the three time periods and the three emission scenarios is displayed in fig 2 focusing absolute for relative values in fig s3 the future projections display a clear reduction of soil moisture especially for the rcp4 5 and rcp8 5 pointing to a dramatic aggravation of water scarcity throughout the 21st century in portugal if emissions are not reduced for the first future period all scenarios have associated projections of a small reduction of annual soil moisture smaller than 40 mm but that intensifies greatly with time and scenario for the mid century the projected reductions for the rcp4 5 are between 40 and 80 mm for all the southern of portugal and for the rcp8 5 almost those reach values in the range of 80 and 120 mm for the south and 40 and 80 mm for the north for the end of the century the soil moisture decrease is enhanced for the rcp8 5 attaining values between 120 and 160 mm for large extensions of the southern regions this change dynamics also applies in a great measure for all the seasons with some exceptions for spring the projections according to the rcp2 6 reveals some increases of soil moisture for the end of the century in some mountainous and big river valleys such as the tagus and for autumn the decreases of soil moisture associated with the rcp8 5 are more homogeneous spatially in fig 3 the pdfs of soil moisture anomalies normalized by the respective standard deviations are displayed for the historical and future periods and in agreement with the three rcp scenarios for portugal mainland fig 3a and for the nuts ii regions fig 3b strikingly the soil moisture pdfs time evolution in response to the emissions scenarios reminds immediately the temperature classical shift and flattened pdfs where a great increase of extreme temperature occurrence is identified both due to the lateral shift and the flattening of the temperature pdfs in fact the soil moisture pdfs reveal distinct shifts and flattening in an increasingly manner with time and scenario which corresponds to multiplying for various orders of magnitude the occurrence of soil moisture deficits w r t the historical climate for portugal and the period 2011 2040 a very slight shift for lower soil moisture values and flattening of the pdfs is seen for all rcps for the rcp2 6 the pdfs remain rather unchanged for all future time periods but for the rcp4 5 and rcp8 5 those pdf changes are enhanced in 2041 2070 and further in 2071 2100 in the historical period soil moisture deficits rarely reach values 3x over the standard deviation but projections reveal that for the rcp4 5 rcp8 5 for the mid century deficits up to 5x 6x are projected to occur and for the end of century even 7x for the rcp8 5 the shift for lower values and the flattening of the soil moisture pdfs is projected for all portuguese nuts ii regions from north to south however the pdf s projected modifications are more severe for the two southern regions alentejo and algarve these regions are already presently the ones suffering recurrently of water scarcity problems with impacts even on public water supply for human consummation for these regions in the case of rcp8 5 a dramatic decrease of the occurrences when soil moisture anomalies will be positive is projected and for example deficits of 3x the standard deviation historical are projected to increase from 0 06 in the historical period to 3 at mid of century and 4 at end of century so as impressive as 67x noteworthy if mitigation is pursued and rcp2 6 achieved the pdfs for those regions almost do not change when compared with the historical period 3 2 drivers of future soil moisture and humidity depletion the dramatic decrease in soil water availability soil moisture in the context of climate change is primarily linked to the projected reductions of precipitation cos et al 2022 soares et al 2017a and large increase of temperature cardoso et al 2019 cos et al 2022 but its physical interdependences overall and at the seasonal cycle setting are explored next in fig 4 an overall view of the land soil water balance for mainland portugal is presented the change of water content depends on the budget between precipitation evapotranspiration and total runoff in all periods from present to future climates the water balanced at the annual scale is firstly controlled by precipitation and then evapotranspiration and runoff for the first period 2011 2040 there is a small reduction of all water balance terms for all scenarios these decreases are much enhanced in the mid century period in agreement with the rcp4 5 and rcp8 5 to the projected decrease in precipitation an important reduction in runoff and water content follows the evapotranspiration suffers a smaller relative decrease for the rcp2 6 the overall precipitation and runoff increase slightly the mid century changes for all term contributions are accentuated in the end of the century especially for the rcp8 5 all terms increase slightly w r t present climate but the water content appears a bit reduced for the rcp2 6 in agreement with the rcp8 5 precipitation evapotranspiration and runoff diminish relatively 21 10 and 35 which results in a water content depletion of 23 looking at the annual cycle of the water budged terms and related variables for the historical period allows understanding the soil moisture dynamics and its projected depletion in future climate scenarios fig 5 a shows the seasonal cycle of precipitation estimated potential evapotranspiration evapotranspiration their balance and total runoff as well in fig 5b the total soil moisture annual cycle is displayed the seasonal dynamics is dominated by precipitation which is almost inexistent in summer and it is maximum in winter in opposite sense evapotranspiration potential evapotranspiration displays minimum values in winter and maximum in may june july in fact evapotranspiration potential evapotranspiration exceeds precipitation in may through september april to september which results in a major net soil water deficit in those periods total runoff seems to respond quickly to precipitation in the first half of the year and afterwards slower the total soil moisture fig 5b closely follows the p p e t p e t seasonal cycle and the order of magnitude with a time lag of two months except for winter meaning that soil moisture is drove by the climate forcing two months later figs 6 and 7 reveals how the water balance terms are projected to change accordingly to the three future scenarios overall the larger precipitation reductions are projected to occur in spring and autumn which will determine an earlier exceedance of both evapotranspiration and potential evapotranspiration over precipitation i e an earlier reduction of water availability and a smaller amount of water to be deposit in the soil this water deficit is further enhanced in summer and in autumn both because of the precipitation reduction the increase of potential evapotranspiration and the relatively small reduction in evapotranspiration again future precipitation reductions seem to drive the total soil moisture decreases with a one month to a two month lag the larger absolute reductions in total soil moisture will occur in late spring may june and early winter november december in the sequence of the larger deceases in precipitation of april and october november in what concerns the projected changes of total runoff it follows the signal of precipitation changes the projected changes of surface relative humidity rh linked to the response to the surface water balance is also shown in fig 6g for the annual cycle and its spatial view on fig s4 the surface relative humidity is an important meteorological parameter that controls the atmospheric evaporative demand changes in relative humidity may have strong implications for ecosystems hydrological cycle climate aridity and drought events through the evolution of the evaporative demand vicente serrano et al 2018 with increasing surface temperature the amount of water vapour in the atmosphere increases whenever the air is not saturated saturated vapour pressure increases exponentially with temperature as expected from the clausius clapeyron relation and in some regions the amount of water vapour in the atmosphere has been increasing in excess of 7 per kelvin willett et al 2010 however increasing global temperatures are not translated into increasing relative humidity over land the opposite or a plateauing of rh has been observed simmons et al 2010 in large regions of the globe the majority of moisture over land has origins over the oceans since oceans are warming at a lower rate than the land surface the rate of evaporation over their surfaces is lower than over land thus the amount of moisture advected from the oceans into the land areas is not enough to keep the ratio between the air s vapour pressure and the saturated vapour pressure constant and a decrease in rh is observed in some areas like portugal changes to general circulation also imply a reduction in moister transport from the oceans further reducing the moisture availability escalating surface warming and increasing the saturated vapour pressure for all scenarios the projected humidity reductions are larger from spring to autumn in rcp 2 6 relative humidity fig 6g decreases by less than 2 5 while in rcp 4 5 reductions reach 4 in the beginning and end of the summer for areas near the coast and reductions up to 4 are expected near the spanish border fig s4 in rcp 8 5 a reduction between 0 and 5 is projected by mid century and a further reduction up to 8 in october 6 in areas near the border with spain by the end of the century in winter the advection of moist air accompanying the winter storms with their expected increase in intensity i e including more moisture is enough to imply an increase in rh for mainland portugal for rcp2 6 and for the regions above the tagus river in rcp 4 5 fig s4 in rcp 8 5 not only a decrease of precipitation is projected but also a significant increase in temperature thus the projected decline of rh the reduction in rcp8 5 is particularly severe in the north eastern regions during summer where relative humidity is projected to decrease between 6 and 8 exacerbated by the extreme rise in surface temperatures the uncertainty of the rh projections is high with the multi model spread up to 75 of ensemble value for rcp2 6 and rcp 4 5 not shown in rcp 8 5 there is lower spread about 50 importantly for water bodies and water saturated soils the potential evapotranspiration increases in all scenarios up to mid 21st century fig s5 the projected increase in pet primarily occurs due to similar processes that lead to the reduction in rh which leads to an increase in vapor pressure deficit over land and the nonlinear increase of saturation vapor pressure as a function of temperature associated to the clausius clapeyron relationship scheff and frierson 2014 sherwood and fu 2014 since under the rcp2 6 scenario temperature stabilises by mid century not shown no further increase in pet is projected until the end of the century overall a rise lower than 10 is projected in scenario rcp4 5 temperature rises at a smaller rate from mid century onwards thus in most regions pet stabilises and an increase between 10 and 15 is projected at the end of the century in rcp8 5 the sharp rise in temperature leads to an enhancement up to 30 in pet in the north by the end of the century the highest rise in pet occurs in the northeast during autumn at the end of the century in rcp8 5 once again the multi model spread is almost as large as the climate change signal indicating a large uncertainty associated to the et0 computation not shown the reduced soil moisture contributes to the overall reduction of evaporation at the surface fig s5 particularly in summer and autumn and in the south of the country as before the multi model spread is large and in summer and autumn it is as large as the climate change signal in rcp8 5 not shown 3 3 semi arid climate overtaking portugal subsequently to the water balance changes explored before and in agreement with the soil moisture depletion it can be seen that portugal is projected to become prevalently a semi arid climate country in fig 8 the aridity index is displayed which relies on precipitation and evapotranspiration historically the portuguese climate is humid in north centre and a small southwest stripe and in the rest of the south dry subhumid and semiarid in a small southeastern area in the east of the country also two small areas are characterized by dry subhumid climate looking at the projections in agreement with the rcp2 6 the portuguese climate does not suffer almost any modification for the rcp4 5 a small expansion of the dry subhumid and semiarid climates is projected especially in the south and centre regions but for the rcp8 5 those expansions are much more severe throughout the century in the mid century the semiarid climate extends almost through all the south the dry subhumid migrates northerly and the small areas in the eastern border are replaced by semiarid climates furthermore in the end of century only roughly the northwestern third of the country remains with humid climate and the rest is almost all covered by semiarid 4 conclusions the mediterranean countries are considered a hotspot of climate change in great measure due to the expected changes in water availability linked to precipitation decrease and regional warming cramer et al 2018 giorgi 2006 lionello and scarascia 2018 terrestrial ecosystems agricultural and forests critically depend on water availability in the soils i e soil water content and at the surface layer soil moisture chen et al 2014 miralles et al 2019 some studies have pointed clearly that associated with climate change the mediterranean countries will endure faster and intense soil dissection enhancing droughts and water scarcity milano et al 2013 nguyen et al 2016 moreover soil moisture depletion contributes as well to regional to local land atmosphere feedbacks that promote the occurrence and mutual intensification of heatwaves and droughts in the current study an analysis of the future soil moisture and aridity in portugal was performed using a high quality multi model ensemble from euro cordex for three future time periods and three rcp emission scenarios rcp2 6 rcp4 5 and rcp8 5 in response to the severe projections of precipitation reductions regional warming and the subsequent large increase of potential evapotranspiration a very impressive decrease in soil moisture is projected the soil moisture depletion is reflected both on mean values the full annual cycle and more severely on the occurrence of low extreme values when compared to the historical climate the future projections display a clear reduction of soil water moisture especially for the rcp4 5 and rcp8 5 pointing to a dramatic aggravation of water scarcity throughout the 21st century in portugal if emissions are not reduced for the mid century the projected reductions for the rcp4 5 are between 40 and 80 mm for all the southern of portugal and for the rcp8 5 almost reach values in the range of 80 and 120 mm for the south and 40 and 80 mm for the north for the end of the century the soil moisture decrease is enhanced for the rcp8 5 attaining values between 120 and 160 mm for large extensions of the southern regions these latter projected changes in the total soil moisture regard all the annual cycle with relative decrease values between 10 and 15 for the rcp8 5 in what concerns to extreme total soil moisture values there is a pronounced shift for much negative values and as well a flattening of the distributions much like what is projected for temperature in many regions of the world the shift for lower values and the flattening of the soil moisture pdfs is projected for all portuguese nuts ii regions from north to south however the pdf s projected modifications are more severe for the two southern regions alentejo and algarve in the historical period soil moisture deficits rarely reach values 3x over the standard deviation but projections reveal that for the rcp4 5 rcp8 5 for the mid century deficits up to 5x 6x are projected to occur and for the end of century even 7x for the rcp8 5 the main drivers of future total soil moisture reductions are clearly determined as the precipitation decreases and the augment of potential evapotranspiration throughout the full annual cycle also associated with the increase of evapotranspiration in winter when there is still water availability to evaporate especially for the rcp8 5 in the rest of the annual cycle there is a decrease of evapotranspiration since soil moisture is greatly depleted at the surface relative humidity is projected to decrease for the rcp4 5 and rcp8 5 and in a less extent for rcp2 6 for fcp8 5 the rh reduction is particularly severe in the north eastern regions during summer where relative humidity is projected to decrease between 6 and 8 it is important to mention that as in relative humidity and potential evapotranspiration the multi model spread is large conducting to uncertainty of climate change projections in soil moisture and evaporation in result of all these projected changes in the water cycle related variables the portuguese climate is projected to become much more semi arid for the rcp8 5 for the end of century only roughly the north western third of the country remains with humid climate and the rest is almost all covered by semiarid in opposite manner for the rcp2 6 the spatial extension of semi arid climate remains largely unchanged when compared to historical climate confined to a small south eastern region finally the future panorama of water scarcity here depicted will impact dramatically many portuguese ecosystems and economic sectors dependent on them such as agriculture forests and tourism these are expected to have to face levels of adaptation immensely different according to the degree of global mitigation of greenhouse gas emissions this study aimed at giving a less common view of the terrestrial water availability for the future of portugal declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the authors would like to acknowledge the financial support of portuguese fct i p mctes through national funds piddac uidb 50019 2020 instituto dom luiz and eea financial mechanism 2014 2021 and the portuguese environment agency through pre defined project 2 national roadmap for adaptation xxi pdp 2 the authors wish to acknowledge the leading ptdc cta met 28914 2017 project funded by fct we also acknowledge the world climate research programme s working group on regional climate and the working group on coupled modelling former coordinating body of cordex and responsible panel for cmip5 we also thank the climate modelling groups for producing and making available their model output we also acknowledge the earth system grid federation infrastructure an international effort led by the u s department of energy s program for climate model diagnosis and intercomparison the european network for earth system modelling and other partners in the global organisation for earth system science portals go essp funding sources dcal are funded by pre defined project 2 national roadmap for adaptation xxi pdp 2 the publication of this research is funded by the portuguese fct i p mctes through national funds piddac uidb 50019 2020 idl and the pre defined project 2 national roadmap for adaptation xxi pdp 2 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2022 128731 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
