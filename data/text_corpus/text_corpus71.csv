index,text
355,identifying key driving forces for streamflow variation is essential for improving sustainable water resource management in terms of understanding how changes in the watershed translate to changes in streamflow in this study the relationships between trends in total annual streamflow and trends in watershed characteristics across the contiguous u s during 1981 2016 are investigated with data from 2 621 usgs gages the regions of homogeneous hydrologic change i e watersheds that are undergoing similar statistically significant streamflow trends are delineated and frequent pattern mining i e apriori algorithm and variable importance i e random forest are used to derive the key driving forces for these regions as expected the trends in streamflow are highly associated with the trends of precipitation in contrast the influences of anthropogenic factors vary substantially across regions particularly the influence of water use change tends to be significant in the regions dominated by agricultural land e g dakotas the importance of land use change is highlighted in the regions with relatively large forest coverage e g northeast however these important identified water use changes are not frequently associated with the increasing streamflow in sub regions e g great lakes and thus the significance of the water use impacts are site specific therefore the changes in climate and land use are frequently and importantly identified together in the sub regions with increasing streamflow which can be collectively used to discover the major causes of the streamflow trends in those regions although the impacts of changing water use are highlighted in the southwest climate trends are primarily responsible for the decreasing streamflow keywords annual streamflow climate change land use water use frequent pattern variable importance attribution analysis 1 introduction streamflow is an important measure of long term hydro climatic changes melesse et al 2019 as well as the primary indicator of agricultural and urban water availability ficklin et al 2018 changes in streamflow have direct impacts on ecosystem processes resh et al 1988 hart and finelli 1999 poff et al 2010 and water use patterns dey and mishra 2017 both human activities e g land use and water withdrawal and climate changes e g temperature and precipitation could contribute to monotonic nonlinear or abrupt shifts in streamflow hirsch 2011 villarini and smith 2010 villarini et al 2009 patterson et al 2013 evidence from many regions across the world indicate that streamflow is influenced by multiple drivers including both anthropogenic and climatic factors huntington 2006 therefore identifying the key driving forces for the streamflow variation is not only scientifically challenging but also practically essential for improving the sustainable water resource management in river basins chawla and mujumdar 2015 liu et al 2017 numerous studies have attempted to derive the drivers responsible for streamflow changes by quantifying the contribution of climatic changes and human activities to streamflow changes most of these studies employ one of the following three methods to investigate the impacts of potential drivers 1 hydrologic simulation modelling with scenario analysis ma et al 2010 kim et al 2013 2 a statistical approach with correlation analysis zhao et al 2010 dey and mishra 2017 or 3 elasticity based method with sensitivity and decomposition analysis wang and hejazi 2011 xu et al 2014 more recently some advanced data mining methods have been introduced to identify the characteristics that significantly influence streamflow particularly for the regions with long term streamflow data sawicz et al 2014 rice et al 2015 praskievicz and luo 2019 for example sawicz et al 2014 investigated the reassignment of individual watersheds to different watershed clusters using a classification and regression tree cart model praskievicz and luo 2019 implemented a random forest model to determine the watershed characteristics that influence hydrologic regimes although the magnitude of influence of the watershed characteristics i e relative contribution and importance is widely used as the criterion to derive the key driving factors for streamflow changes in the studies listed above a loss of the derivation information might result from summarizing the attribute information from different gages of a full spatial temporal dataset into the single indicator which is referred to as the so called influencing magnitude issue renard and lall 2014 in particular multiple drivers are often referred to as magnitude relevant liu et al 2017 but an analysis about how to apply these important factors to explain the causes of the regional streamflow changes is lacking in addition the topic of how frequently a particular factor influences regional streamflow changes has received little attention for example both urbanization and precipitation affect streamflow but the frequency with which these important drivers are found together has seldom been investigated the conditions under which these important drivers taken primarily or subordinately to uncover the cause of streamflow variation have also not been addressed in previous studies as one of the most popular association rule mining techniques the apriori algorithm was originally proposed by agrawal et al 1993 to discover the patterns that occur frequently in a dataset i e frequent pattern agrawal et al 1994 thabtah et al 2006 by taking advantage of the monotonic searching property i e apriori property the apriori algorithm can effectively prune the search space and thus significantly reduce computing time han and kamber 2012 lazcorreta et al 2008 in this study we propose a data driven analytical framework with the combined use of frequent pattern mining i e apriori algorithm and machine learning approaches i e random forest to assess the magnitude and frequency of the driving forces responsible for trends in total annual streamflow in comparison with the machine learning approaches such as random forest and standard data models such as linear regression the frequency with which important drivers occur is evaluated by frequent pattern mining along with the work of schnier 2016 according to our knowledge this study might be the first to apply frequent pattern mining in hydrologic sciences particularly for the attribution analysis of streamflow trends given the growing recognition of the increasing non stationarity of streamflow and changing climate and watershed conditions sawicz et al 2014 ahn and merwade 2014 we apply the proposed data driven analytical framework to investigate the relationships between trends in total annual streamflow and trends in watershed characteristics over the contiguous us conus these trends are evaluated from 1981 through 2016 similar to the work of ahn and merwade 2014 we delineate the regions of homogenous hydrologic change i e watersheds that are undergoing similar significant trends and address the following three questions concerning the frequency and importance of the drivers for the watersheds undergoing similar hydrologic changes 1 what patterns in watershed characteristics frequently occur in the watersheds undergoing similar hydrologic changes 2 which watershed characteristics are most strongly related to the magnitude of the trend in total annual streamflow 3 which factors could be used to explain the streamflow trends in the past or possibly predict future streamflow changes by exploring these three questions at both the conus scale and the regional scale we aim to better understand the driving forces that underpin streamflow trends in the past and the potential forces controlling streamflow variation in the future the rest of this paper is organized as follows section 2 provides the details of the dataset and analytical framework used in this study section 3 shows the results of the analysis in the form of frequent patterns and variable importance for the regions of homogeneous streamflow change at both the conus and regional scale section 4 discusses the results in terms of the causes of regional annual streamflow trends and the implications for sustainable water resources management finally section 5 presents the conclusions of this study 2 dataset and attribution framework 2 1 dataset overview gages ii is the acronym for geospatial attributes of gauges for evaluating streamflow version ii with 9 322 stream gages maintained by united states geological survey usgs falcone et al 2010a because of the consecutive long term flow records and reliably delineated basin boundaries the gages ii dataset has been used extensively to investigate streamflow variation falcone et al 2010b chang et al 2014 rice et al 2015 gyawali et al 2015 in this study the analysis of trends in total annual streamflow on the basis of daily data at each year from 1981 through 2016 is conducted using the gages ii dataset the time period 1981 2016 was chosen because water use data was not available before 1981 https water usgs gov watuse data while the latest land use data was released in 2016 https www mrlc gov data as shown in fig 1 only 2 621 gages are taken into consideration because they have complete daily streamflow data over the 36 year period in contrast to some previous studies that identify important drivers of change in watersheds with minimal human activities slack and landwehr 1992 lins 2009 watersheds impacted by human activity are retained for this study because the purpose of this study is to identify key anthropogenic and climatic drivers of streamflow trends among the 2 621 selected gages 525 gages 20 03 are classified as reference minimally influenced by human activity and 2 096 gages 79 97 are classified as non reference influenced by human activity in the usgs hydro climatic data network 2009 hcdn 2009 dataset falcone et al 2010a rice et al 2015 this study uses variables characterizing climate and human activities including precipitation temperature water use and land use as potential explanatory variables trends in total annual precipitation and annual mean temperature are used to represent climate trends while trends in annual land use and water use are used to characterize human activities although this is not an exhaustive list of human activity and climate variables these variables have proven to be useful for quantifying watershed scale human and climate impacts in previous studies falcone et al 2010b rice et al 2015 the data source and resolution for each variable are summarized in table 1 for the climatic variables the total annual precipitation and annual mean temperature at each watershed are collected from the prism parameter elevation regression on independent slopes model dataset with 4 km x 4 km resolution over the 1981 2016 period prism 2019 annual groundwater and surface water use are recorded by usgs at a county level from 1985 to 2015 in 5 year increments barber 2014 maupin et al 2014 corresponding to the metric of total annual streamflow million m3 the annual precipitation and water use are also measured by water volume of million m3 with the consideration of watershed area impacts eight land use and land cover lulc types expressed by area with km2 rely on the national land cover dataset nlcd with 30 m x 30 m resolution for the following years 2001 homer et al 2007 2004 yang et al 2018 2006 fry et al 2011 2008 yang et al 2018 2011 homer et al 2015 2013 yang et al 2018 2016 yang et al 2018 the collected datasets are clipped around the watersheds in the gages ii dataset using the watershed boundaries as masks for the area that extended beyond the watershed boundary the variables are assumed to be uniformly distributed the implicit assumption made here is that the trend specified from the collected data such as the lulc data from 2001 to 2016 is sufficiently representative of the trend in the explanatory variables from 1981 to 2016 yang et al 2018 2 2 trend analysis as one of the commonly used nonparametric techniques for hydrologic trend analysis thiel sen slope sen 1968 girotto et al 2014 scholl and murphy 2013 is employed to estimate the trend magnitude of the total annual streamflow and the watershed characteristics in this study for the thiel sen slope a positive value would indicate an increasing trend of streamflow or watershed characteristics over time while a negative value means a decreasing trend sen 1968 the statistical significance for the trends in total annual streamflow is assessed with the modified mann kendall mmk test proposed by hamed and rao 1998 in this study the mmk test is used because it is applicable to streamflow with serial correlation unlike the traditional mk test hamed and rao 1998 koutsoyiannis and montanari 2007 following that regions with similar types of streamflow trend magnitude i e increasing and decreasing trends with statistical significance p 0 05 mmk test are identified and extracted from the full dataset for the following frequent pattern and variable importance analyses 2 3 apriori algorithm for the watersheds with homogenous hydrologic changes as the first association rule mining approach the apriori algorithm has been widely used as the benchmark for mining frequent itemsets han and kamber 2012 in this study a frequent itemset is defined as a set of trends in watershed characteristics whose support e g frequency exceeds the user specified minimum support i e minsup lazcorreta et al 2008 aggarwal and han 2014 while the support is defined as the percentage of candidate itemsets containing both itemset a and b which represents the usefulness of the co occurrence frequencies for itemset a and b and can be referred to the joint probability p a b han and kamber 2012 therefore at least minsup percent of gages must contain a given combination of k number of watershed attributes before this combination is defined as a frequent k itemset particularly this k itemset is specified as the maximal frequent itemset max itemset if any k 1 itemset is not frequent han and kamber 2012 aggarwal and han 2014 to significantly improve the efficiency of the apriori algorithm the apriori property is proposed by agrawal et al 1993 which states that any subset of a frequent itemset must also be frequent han and kamber 2012 following this principle the candidate set of k 1 items could be generated from the given k itemsets i e joining step the details of the algorithm are given as follows 1 initializing the search starts from finding a list of 1 itemsets i e 1 trend in watershed attribute l1 satisfying the minsup 2 joining the candidate sets of 2 items i e 2 watershed attribute trends are generated by the combination of different 2 items presented in the frequent 1 itemset 3 pruning the support e g frequency of each candidate set is computed and only the combination meeting the minsup would be defined as frequent 2 itemsets l2 which is further used to generate the candidate sets of 3 items 4 iterating the above procedure is iterated until none of the candidate combinations would satisfy the minsup once the maximal frequent itermsets are discovered the correlation between the occurrence of itemset a and b in the maximal frequent pattern could be further evaluated by the lift measure in apriori algorithm han and kamber 2012 lift is measured by comparing the frequency of co occurrence of itemset a and b p a b with the co occurring frequency of a and b under an independent assumption p a p b as follow aggarwal and han 2014 1 l i f t a b p a b p a p b therefore an independent relationship between the occurrence of a and b could be derived if lift a b 1 the occurrence of a is positively correlated with b if lift a b 1 otherwise a and b are negatively correlated if lift a b 1 han and kamber 2012 in this study the increasing and decreasing trends of watershed characteristics are defined as items and the apriori algorithm implemented within the r package a rules is applied to discover the trends in watershed characteristics that occur frequently within watersheds undergoing the similar hydrologic changes 2 4 random forest for the watersheds with homogenous hydrologic changes in order to identify the factors with the highest magnitude of influence on the changes in streamflow the relative importance of each watershed characteristic needs to be quantified generally machine learning algorithms and standard data models such as linear or logistic regression can both be used to measure the influencing magnitude of explanatory variables on the response variable fan and he 2015 however the linear regression as the most popular multiple regression is applicable only when the model residuals are normally distributed the variance is homoscedastic and there are no multicollinearities eric et al 2005 the approach for the variable importance analysis should handle the nonlinear relationships between streamflow trends and trends in watershed characteristics praskievicz and luo 2019 due to the inherent nonlinearity of complex hydrological processes mcdonnell et al 2007 in this study the random forest rf algorithm is applied to measure the magnitude of variable importance for the streamflow trends as one of the most popular ensemble learning methods rf provides robust results with high processing speed for identifying the important variables of nonlinear problems by taking advantage of an ensemble of classification and regression trees carts grimm et al 2008 belgiu and dragut 2016 moreover to overcome the numerical instability and overfitting performance of cart a randomization procedure is introduced in rf to decorrelate the trees so that the forest ensemble approach produces results with lower variance and higher accuracy galiano et al 2012 the randomization process is not only used for the division of tree nodes but also for the training of the trees with different samples through bagging or bootstrap aggregation which randomly resamples the original dataset with replacement i e with no deletion of the data selected from the input sample for generating the next subset the samples that are not selected for the training of the trees are termed as out of bag oob samples galiano et al 2012 praskievicz and luo 2019 and are used to assess the importance of each variable as follows for a given variable the variable is first permuted while other variables in the oob samples are kept constant and then rf is rerun to obtain the new results with the permuted oob samples the importance of the given variable is assessed by the average difference between the results obtained from the permuted oob and the original oob samples mathematically the importance of explanatory variable x is defined as 2 vi x 1 ntree i 1 ntree y i y i where y is the computation result associated with the original oob sample in rf y is the result corresponding to the permuted oob sample ntree is the number of trees set in rf generally a large value of vi indicates a high importance of the explanatory variable this study implements the rf regression within the r package randomforest liaw and wiene 2002 for regions with homogeneous streamflow changes to avoid the impacts of the order of magnitude on the model performance all of the trends are first normalized into values between 0 and 1 following that using the streamflow trend magnitudes as the response variables and the trend magnitude in watershed characteristics as the explanatory variables the relative importance of the watershed characteristics to the streamflow is quantified 3 results 3 1 streamflow trends with statistical significance 314 gages with the statistically significant trends p 0 05 mmk test of total annual streamflow are identified from the 2 621 gages at the conus scale in fig 2 among these gages 107 gages exhibit a significantly increasing trend and 207 gages exhibit a significantly decreasing trend since many gages i e at least 20 gages with significant streamflow trends occur in the same geographic regions four of these regions are identified for further regional analysis the great lakes region 28 gages the eastern dakotas 26 gages and the northeast area 20 gages with significantly increasing trends and the southwestern united states region 189 gages with significantly decreasing trends it should be noted that some trends in watershed characteristics occur across conus with a relatively high frequency which would affect the frequent pattern analysis for example as shown in table 2 100 of the gages in the full dataset are experiencing an increasing trend in urbanization which is consistent with the recent finding from homer et al 2020 and thus the frequency of increasing urbanization in the regions with significantly increasing and decreasing streamflow trends would also be 100 it is more meaningful to reclassify the watershed characteristics trends that have a high frequency at the conus scale in this study the watershed characteristics trends above 80 frequency at the conus scale are reclassified into rapidly and slowly increasing trends or rapidly and slowly decreasing trends categories according to the median slope values the trend with a frequency of 80 at the conus scale is selected because such a trend would also frequently occur at 70 of the gages in the sub regions with either significantly increasing or decreasing trends particularly the above occurring pattern is not available for the trend with a frequency below 65 and no trend has undergone a frequency between 65 and 80 in the whole dataset the three trends in table 2 are then reassigned into 1 rapidly increasing or decreasing trend if the absolute value of its slope is greater than the median slope value of the whole dataset or 2 slowly increasing or decreasing trend if the absolute value of the slope is less than the median value therefore there are three trend categories for the variables listed in table 2 such as rapidly increasing slowly increasing and decreasing temperature trends for the trends not included in table 2 the reclassification procedure is not executed on them and only two categories of increasing and decreasing trends are useful 3 2 frequent pattern analysis minsup is a user defined parameter in the apriori algorithm that specifies meaningful frequent pattern evaluation han and kamber 2012 however a high minsup would limit the application of useful itemsets meanwhile meaningless patterns could be generated from a low minsup liu et al 1999 to assess the effects of minsup on the max itemset derivation six values of minsup ranging from 0 5 to 0 6 with an interval of 0 02 are employed for apriori algorithm implementation that is only the watershed attributes occurring in at least 50 to 60 of the gages with significant streamflow trends would be derived as shown in fig 3 the number of frequent items generally decreases with increasing minsup particularly the increase of minsup from 0 50 to 0 52 would lead to the decrease in number of items in the sub regions of the great lakes northeast u s and southwest u s finally minsup is set as 0 5 in this study to maintain an appropriate number of watershed characteristics and avoid information loss that could assist in interpretation of the results the frequent patterns with minsup of 0 5 for the significantly increasing and decreasing trends at the conus scale and regional scale are given in figs 4 and 5 respectively as can be seen from fig 4a for the 107 gages with significantly increasing trends at conus 92 gages 85 98 have experienced an increasing trend of precipitation i e the most frequent 1 itemset and 65 gages 60 75 i e the dashed line in fig 4a have both increasing precipitation and decreasing surface water use i e the maximal frequent 2 itemset the pattern of increasing precipitation and decreasing surface water use are necessarily frequently found in the sub regions of great lakes and northeast as illustrated in fig 4b and 4d particularly the increasing precipitation trend is found in all of the 28 gages in the great lakes region i e the most frequent 1 itemset and 14 gages 50 undergo the following six trends simultaneously rapidly increasing urbanization and increasing precipitation but decreasing surface water use agriculture and wetland and slowly decreasing forest land i e the maximal frequent 6 itemset similarly 15 gages 75 have experienced both the increasing precipitation and decreasing surface water use in the 20 gages of the northeast region the following maximal frequent 6 itemset is observed in 10 gages 50 increasing precipitation shrub and grassland but decreasing surface water use and agricultural land and rapidly decreasing forest land for the 26 gages in the eastern dakotas the variation pattern of increasing precipitation and land use change are frequently found fig 4c that is all of the gages show the tendency toward increasing precipitation and barren land but decreasing grassland and 14 gages 53 85 undergo the following maximal frequent seven trends simultaneously increase in precipitation groundwater use barren land shrub land and agricultural land and slowly increasing urbanization but decreasing grasslands as shown in fig 5a for the 207 gages with significantly decreasing streamflow trends 178 gages 85 99 experience a decreasing trend in precipitation i e the most frequent 1 itemset and 111 gages 53 62 experience the trends of decreasing precipitation and surface water use and simultaneously increasing agricultural land i e the maximal frequent 3 itemset similar frequent pattern of climatic and anthropogenic changes is also observed in the southwest fig 5b that is 110 of 189 gages 58 20 undergo the above three trends and 95 gages 50 26 have experienced the pattern of decreasing precipitation and surface water use rapidly increasing temperature and increasing agricultural land i e the maximal frequent 4 itemset the correlation between the watershed attributes in the above frequent patterns are further given in terms of the lift measure in fig 6 generally the value range of lift from 0 9 to 1 5 indicates a not strong correlation and such a relationship for the watershed characteristics could be observed from fig 6a and 6b in particular a relatively low correlation between the watershed attributes in the gages with significantly decreasing streamflow is identified from the range between 0 95 and 1 05 fig 6b in contrast a relatively high correlation between different land use types in the sub regions with significantly increasing streamflow is observed with a lift value above 1 05 fig 6a such as the relationship between the rapidly increasing urbanization and the decreasing agricultural land in great lakes regions and the positive correlation between the rapidly decreasing forest land and the increasing grass land in the northeast 3 3 variable importance analysis the implementation of rf requires the determination of two key parameters the number of decision trees to be generated ntree and the number of explanatory variables used in each node to make the tree grow mtry as pointed out by some theoretical and numerical research ghosh et al 2014 kulkarni and sinha 2012 the performance of rf is more sensitive to mtry than ntree particularly due to the so called strong law of large numbers feller 1968 the generalization error would converge and over training is not a problem with increasing ntree in rf model breiman 1996 2001 therefore a large value of ntree 1000 is set in this paper comparing to the default value of 500 on the other hand a low value of mtry could reduce the robustness of rf model while a high value might introduce noise into the performance evaluation grimm et al 2008 galiano et al 2012 concerning the default value of mtry as one third of the total number of variables for rf regression problem i e 4 12 3 7 different values of mtry ranging from 2 to 8 are adopted to evaluate the effects of mtry on the model performance as measured by the coefficient of determination r2 as can be seen in fig 7 r2 generally increases first and then decreases with increasing mtry for the watersheds at conus and regional scales following this variation pattern the best performance in terms of the largest r2 is observed at the value of mtry 4 for the sub region of great lakes and mtry 5 is specified for the regions with significantly increasing trends at conus as well as northeast in addition mtry 6 is optimal for the regions with significantly decreasing trends i e conus and southwest and dakotas therefore either mtry 4 5 or 6 is used in the following analysis corresponding to the best model performance at each region the relative variable importance of watershed characteristics is illustrated in figs 8 and 9 as expected the variables characterizing climate mainly precipitation is highly influential on the magnitude of the streamflow trend whether the trend is increasing or decreasing at the conus and regional scales the relative importance of water use especially surface water use is generally greater than the importance of land use at the conus scale however the importance of trends in anthropogenic features as measured by land use and water use varies among regions for example the changes in land use particularly for forest variation tends to be more important than the trends in water use for northeast and southwest regions fig 8d and 9b with a relatively large forest coverage i e at least 50 and 30 of land cover in northeast and southwest respectively in contrast water use changes play a relatively more important role in the great lakes and dakotas regions fig 8b and 8c where agricultural land is dominant i e agricultural land comprises more than 45 and 70 of the total land use in great lakes and dakotas respectively these results imply that the influence of trends in water use tends to be higher in regions dominated by agricultural land e g dakotas but trends in land use may be more important in the regions with large forest coverage e g northeast to specify a sufficient parsimonious set of important variables within controlled accuracy for the following frequent and importance analysis a cross validation scheme is preferred in the rf model genuer et al 2010 in this paper a 10 fold cross validation is used to minimize mean square error i e mse default performance in randomforest package as can be seen in fig 10 mse decreases significantly with a limited number of variables at first therefore the threshold for ending such a significantly decreasing trend of mse is identified as the criterion for the variable number determination that is the top 4 most important variables are chosen for the conus with significantly increasing and decreasing trends and the numbers of top important variables of 3 3 4 5 are used for the sub regions of great lakes dakotas northeast and southwest respectively note that the accuracy loss from the parsimonious sets are controlled within a reasonable range in each region i e at most 15 difference of mse resulting from all 12 variables 4 discussion 4 1 frequent and important patterns using the frequent patterns identified in section 3 2 i e figs 4 and 5 and the important variables selected in section 3 3 i e figs 8 9 and 10 as the drivers for streamflow changes three categories are classified with the criteria of importance and frequency as 1 frequent and important patterns i e attributes with both importance and frequency 2 frequent but not important patterns i e attributes with sufficient frequency but not importance 3 important but not frequent patterns i e attributes with only importance these three categories provide guidelines about which variables play a dominate role i e the frequent and important patterns or subsidiary role i e the frequent but not important patterns to discover the causes of the regional streamflow trends and which variables might be site specific driving forces of the streamflow trends i e the important but not frequent patterns the three categories for the conus and each region are given in table 3 generally the variation of precipitation is both frequent and important for the streamflow trends at the conus scale and regional scale in contrast many human activities are region specific and not frequently identified at conus scale particularly only decreasing precipitation is specified as a frequent and important pattern for the watersheds with significantly decreasing streamflow across conus although decreasing precipitation and increasing agricultural land occur frequently fig 5a this result implies that increasing agricultural activity does not lead to the decrease in streamflow but is only frequently associated with streamflow trends in addition for the sub regions with significantly increasing trends the important identified water use changes are all not so frequent and vice versa therefore compared to the variation of climate and land use the change of water use could be considered as subsidiary factors or site specific drivers for the increasing streamflow trends these identified regional relationships are further explained with the published studies in the following section 4 2 regional streamflow trends and watershed characteristics in table 3 we attribute the regional trends in streamflow to the trends in watershed characteristics in terms of both importance and frequency a review of the literature verifies the relationships between these characteristics and streamflow changes streamflow variation in the great lakes region is generally driven by changes in climate as well as land use norton et al 2019 the statistical analysis of hydrometeorological dataset in southwestern wisconsin further suggests that the increasing precipitation is the dominant driver for the upward streamflow trend and the less intensive agricultural management interacted with climate change would intensify the magnitude of streamflow changes juckem et al 2008 the variation of impervious surface is likely to be the determinant for this collective effect smakhtin 2001 and the conversion from agricultural land to urbanization i e frequent attribute in table 3 could increase the impervious surface li et al 2020 decrease total infiltration price 2011 and thus result in an increase annual stormwater runoff norton et al 2019 these findings are consistent with the frequent and important patterns of increasing precipitation and decreasing agricultural land identified in subsection 4 1 in the dakotas region some numerical studies have employed the dataset with similar streamflow and climate series from 1981 2014 but different projected land use data to derive the contribution of climate change and land use on annual streamflow variation ahiablame et al 2017 these findings indicate that the increasing trend of precipitation is primarily responsible for the increasing annual streamflow ahiablame et al 2017 according to the results among the 26 gauge stations in eastern dakotas the lands around 18 of them 69 have experienced both increasing agricultural land and decreasing grassland agricultural expansion associated with decreasing grassland i e the correlation coefficient of the trend magnitude between increasing agricultural land and decreasing grassland is 0 99 could further amplify the increasing magnitude of the streamflow trend ahiablame et al 2017 by reducing land surface roughness baker and miller 2013 and available soil water storage busman and sands 2002 these results are consistent with the important and frequent characteristics identified in table 3 and further explain the collective influence of climate trends i e increasing precipitation and land use management i e increasing agricultural land on the streamflow trend there is little question that the increasing precipitation could increase the annual average streamflow in northeast homa et al 2013 typically the increase in precipitation is specified as the primary factor for the increasing streamflow small et al 2006 milly 2005 groisman 2004 which corresponds to the most important variable as given in fig 8d furthermore the hydrologic response to the change in impervious surface from conversion of forest to grassland i e frequent and important attributes in table 3 is pronounced in northeast where humid climate and large forest coverage dominate the landscapes petersen et al 2012 it is generally believed that such an impervious surface conversion would increase streamflow by decreasing soil infiltration capacity price 2011 and decrease et hao et al 2015 the causes of the decreasing streamflow in the southwest us have been widely investigated in previous studies macdonald 2010 maupin et al 2018 ficklin et al 2018 and decreasing precipitation and increasing temperature are primarily responsible for the decreased flow qi et al 2009 maupin et al 2018 combined with the decreasing precipitation the increasing high temperature in the southwest increases evapotranspiration rates and then exacerbates the decrease in streamflow caused by lower precipitation macdonald 2010 garfin et al 2013 in this study the surface water use change is also identified as one primary driver for the streamflow change but the trend of water use is generally decreasing therefore the climate trends are the dominant factors for decreasing streamflow in the southwest while the impacts of decreasing water use would diminish such a decreasing magnitude 4 3 implications for water resources planning and management the important and frequent characteristics are classified into three categories as discussed in section 4 1 these three categories provide implications for not only the application of the important variables to discover the causes of regional streamflow changes as shown in section 4 2 but also for scenario generation for modelling water resources availability and variation particularly the frequent and important role of climate features identified in this study highlights the importance of accurate projections of climate variables in climate models as well as the need for water resource managers to test the system performance over a range of climate scenarios lempert et al 2004 prudhomme et al 2010 brown et al 2012 comparing the important and frequent variables between conus and regional scale the climate trends are not the only drivers of regional streamflow trends the role of human activities identified at the regional scale has some important implications for sustainable water resources management particularly increased understanding of how frequently and importantly the trend in human activities is related to streamflow trends could facilitate detailed and targeted strategies to mediate potential future streamflow changes the influence of land use management on the increase of streamflow has been observed in the dakotas region which has positive implications for water resource availability in the region similarly the rapid urban development with less intensive agricultural practices in the great lakes regions might amplify the magnitude of increasing streamflow trend caused by the climate change green infrastructure such as parks green street corridors and rain gardens is suggested as a cost effective measure to increase water storage in soil and groundwater as well as decrease urban flooding events hopton et al 2015 norton et al 2019 deforestation activities have some positive implications for increasing the total annual streamflow in the northeast however amid reported trends of increasingly erratic and extreme precipitation events wake 2005 nguyen and degaetano 2012 stormwater strategies are suggested to mitigate the likely occurrence of damaging flood risks in the northeast decreasing water use plays an important role to offset the decreasing streamflow trends in the southwest more attention should be given to water conservation measures and effective water utility management for mitigating the decreasing trend in streamflow in the future 5 conclusions in this study the relationships between trends in total annual streamflow and trends in watershed characteristics across the conus from 1981 through 2016 are investigated with a dataset of 2 621 usgs gages the regions of homogenous hydrologic changes i e watersheds that are undergoing similar significant trend magnitude are delineated the results focus on four regions with significant streamflow trends i e the eastern dakotas northeast the great lakes region and the southwest the key driving forces for the streamflow trends in the past and the potential forces for future streamflow changes are specified using a statistical framework of frequent patterns and variable importance in general as expected the trends in streamflow are highly associated with those in precipitation in contrast the influences of anthropogenic factors vary substantially across regions particularly the influence of trends in water use tends to be significant in the regions dominated by agricultural land e g dakotas while the importance of land use change is highlighted in the regions with a relatively large forest coverage e g northeast however these important identified water use changes are not frequently associated with the increasing streamflow in the sub regions and thus the significance of the water use impacts are site specific therefore the climate and land use trends are involved in frequent and important patterns in sub regions with significantly increasing streamflow trend and they are collectively used to discover the major causes of streamflow trends in those regions e g great lakes regions it is found that the agricultural expansion associated with decreasing grassland contribute to increasing streamflow in the dakotas while the rapid urban development with less intensive agricultural policy in the great lakes regions amplifies the increasing streamflow trend through the increase of impervious surface furthermore the increasing streamflow trend in the northeast is mainly attributed to the frequent and important pattern of increasing precipitation and deforestation activities although the importance of the water use changes are highlighted in the southwest the climate trends are mainly responsible for the decreasing streamflow therefore streamflow restoration efforts in the southwest should focus on water conservation measures in general this study follows the direction of streamflow assessment especially its change over time which has had a rich literature e g zanardo et al 2012 mu et al 2020 yao et al 2020 specially this study takes land use and water use as explicit factors to the trends of streamflow change and the results add to the quantification and understanding of the human dimension of hydrology vogel et al 2015 the regions of homogenous hydrologic changes identified from this study and particular sites where human activities such as land uses and water users should be taken into consideration will be useful information for future hydrologic model and data analysis gupta and nearing 2014 tarasova et al 2020 especially for regions with heavy human interferences vogel et al 2015 studies on the relationships between streamflow and land and or water use are used to validate the findings of this study particularly the impacts of land use and water use on annual streamflow with limited explanatory variables more anthropogenic factors e g changes in dam storage and influencing area of human activities and watershed characteristics e g topography could be taken into consideration in future work another limitation of this study is that we employ a binary classification of trends in watershed characteristics for frequent pattern analysis i e increasing or decreasing refined classification methods could be employed to provide more quantitative information of frequent patterns in changing watersheds due to some short data records possible uncertainty and lag effects might exist with the trend analysis and the subsequent results consecutive long term data records could be collected in the future to mitigate these effects and provide better understanding about streamflow change attribution in spite of these limitations with the powerful data analysis tools of frequent pattern mining and machine learning the data driven analytical framework proposed in this study can be extended to derive valuable information on streamflow changes such as a step change or a gradual change and explore the causes from very large datasets contribution spencer schnier and ximing cai designed the study xiang zeng and spencer schnier performed research and analyzed dataset xiang zeng ximing cai and spencer schnier wrote the manuscript declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research is supported by the national natural science foundation of china 91647204 51609174 51909083 and china postdoctoral science foundation 2016m602359 the corresponding author would like to thank thomas over tushar apurv ruijie zeng xiao zhang wuhan university murugesu sivapalan and praveen kumar for their valuable comments on early versions of this manuscript supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103799 appendix supplementary materials image application 1 
355,identifying key driving forces for streamflow variation is essential for improving sustainable water resource management in terms of understanding how changes in the watershed translate to changes in streamflow in this study the relationships between trends in total annual streamflow and trends in watershed characteristics across the contiguous u s during 1981 2016 are investigated with data from 2 621 usgs gages the regions of homogeneous hydrologic change i e watersheds that are undergoing similar statistically significant streamflow trends are delineated and frequent pattern mining i e apriori algorithm and variable importance i e random forest are used to derive the key driving forces for these regions as expected the trends in streamflow are highly associated with the trends of precipitation in contrast the influences of anthropogenic factors vary substantially across regions particularly the influence of water use change tends to be significant in the regions dominated by agricultural land e g dakotas the importance of land use change is highlighted in the regions with relatively large forest coverage e g northeast however these important identified water use changes are not frequently associated with the increasing streamflow in sub regions e g great lakes and thus the significance of the water use impacts are site specific therefore the changes in climate and land use are frequently and importantly identified together in the sub regions with increasing streamflow which can be collectively used to discover the major causes of the streamflow trends in those regions although the impacts of changing water use are highlighted in the southwest climate trends are primarily responsible for the decreasing streamflow keywords annual streamflow climate change land use water use frequent pattern variable importance attribution analysis 1 introduction streamflow is an important measure of long term hydro climatic changes melesse et al 2019 as well as the primary indicator of agricultural and urban water availability ficklin et al 2018 changes in streamflow have direct impacts on ecosystem processes resh et al 1988 hart and finelli 1999 poff et al 2010 and water use patterns dey and mishra 2017 both human activities e g land use and water withdrawal and climate changes e g temperature and precipitation could contribute to monotonic nonlinear or abrupt shifts in streamflow hirsch 2011 villarini and smith 2010 villarini et al 2009 patterson et al 2013 evidence from many regions across the world indicate that streamflow is influenced by multiple drivers including both anthropogenic and climatic factors huntington 2006 therefore identifying the key driving forces for the streamflow variation is not only scientifically challenging but also practically essential for improving the sustainable water resource management in river basins chawla and mujumdar 2015 liu et al 2017 numerous studies have attempted to derive the drivers responsible for streamflow changes by quantifying the contribution of climatic changes and human activities to streamflow changes most of these studies employ one of the following three methods to investigate the impacts of potential drivers 1 hydrologic simulation modelling with scenario analysis ma et al 2010 kim et al 2013 2 a statistical approach with correlation analysis zhao et al 2010 dey and mishra 2017 or 3 elasticity based method with sensitivity and decomposition analysis wang and hejazi 2011 xu et al 2014 more recently some advanced data mining methods have been introduced to identify the characteristics that significantly influence streamflow particularly for the regions with long term streamflow data sawicz et al 2014 rice et al 2015 praskievicz and luo 2019 for example sawicz et al 2014 investigated the reassignment of individual watersheds to different watershed clusters using a classification and regression tree cart model praskievicz and luo 2019 implemented a random forest model to determine the watershed characteristics that influence hydrologic regimes although the magnitude of influence of the watershed characteristics i e relative contribution and importance is widely used as the criterion to derive the key driving factors for streamflow changes in the studies listed above a loss of the derivation information might result from summarizing the attribute information from different gages of a full spatial temporal dataset into the single indicator which is referred to as the so called influencing magnitude issue renard and lall 2014 in particular multiple drivers are often referred to as magnitude relevant liu et al 2017 but an analysis about how to apply these important factors to explain the causes of the regional streamflow changes is lacking in addition the topic of how frequently a particular factor influences regional streamflow changes has received little attention for example both urbanization and precipitation affect streamflow but the frequency with which these important drivers are found together has seldom been investigated the conditions under which these important drivers taken primarily or subordinately to uncover the cause of streamflow variation have also not been addressed in previous studies as one of the most popular association rule mining techniques the apriori algorithm was originally proposed by agrawal et al 1993 to discover the patterns that occur frequently in a dataset i e frequent pattern agrawal et al 1994 thabtah et al 2006 by taking advantage of the monotonic searching property i e apriori property the apriori algorithm can effectively prune the search space and thus significantly reduce computing time han and kamber 2012 lazcorreta et al 2008 in this study we propose a data driven analytical framework with the combined use of frequent pattern mining i e apriori algorithm and machine learning approaches i e random forest to assess the magnitude and frequency of the driving forces responsible for trends in total annual streamflow in comparison with the machine learning approaches such as random forest and standard data models such as linear regression the frequency with which important drivers occur is evaluated by frequent pattern mining along with the work of schnier 2016 according to our knowledge this study might be the first to apply frequent pattern mining in hydrologic sciences particularly for the attribution analysis of streamflow trends given the growing recognition of the increasing non stationarity of streamflow and changing climate and watershed conditions sawicz et al 2014 ahn and merwade 2014 we apply the proposed data driven analytical framework to investigate the relationships between trends in total annual streamflow and trends in watershed characteristics over the contiguous us conus these trends are evaluated from 1981 through 2016 similar to the work of ahn and merwade 2014 we delineate the regions of homogenous hydrologic change i e watersheds that are undergoing similar significant trends and address the following three questions concerning the frequency and importance of the drivers for the watersheds undergoing similar hydrologic changes 1 what patterns in watershed characteristics frequently occur in the watersheds undergoing similar hydrologic changes 2 which watershed characteristics are most strongly related to the magnitude of the trend in total annual streamflow 3 which factors could be used to explain the streamflow trends in the past or possibly predict future streamflow changes by exploring these three questions at both the conus scale and the regional scale we aim to better understand the driving forces that underpin streamflow trends in the past and the potential forces controlling streamflow variation in the future the rest of this paper is organized as follows section 2 provides the details of the dataset and analytical framework used in this study section 3 shows the results of the analysis in the form of frequent patterns and variable importance for the regions of homogeneous streamflow change at both the conus and regional scale section 4 discusses the results in terms of the causes of regional annual streamflow trends and the implications for sustainable water resources management finally section 5 presents the conclusions of this study 2 dataset and attribution framework 2 1 dataset overview gages ii is the acronym for geospatial attributes of gauges for evaluating streamflow version ii with 9 322 stream gages maintained by united states geological survey usgs falcone et al 2010a because of the consecutive long term flow records and reliably delineated basin boundaries the gages ii dataset has been used extensively to investigate streamflow variation falcone et al 2010b chang et al 2014 rice et al 2015 gyawali et al 2015 in this study the analysis of trends in total annual streamflow on the basis of daily data at each year from 1981 through 2016 is conducted using the gages ii dataset the time period 1981 2016 was chosen because water use data was not available before 1981 https water usgs gov watuse data while the latest land use data was released in 2016 https www mrlc gov data as shown in fig 1 only 2 621 gages are taken into consideration because they have complete daily streamflow data over the 36 year period in contrast to some previous studies that identify important drivers of change in watersheds with minimal human activities slack and landwehr 1992 lins 2009 watersheds impacted by human activity are retained for this study because the purpose of this study is to identify key anthropogenic and climatic drivers of streamflow trends among the 2 621 selected gages 525 gages 20 03 are classified as reference minimally influenced by human activity and 2 096 gages 79 97 are classified as non reference influenced by human activity in the usgs hydro climatic data network 2009 hcdn 2009 dataset falcone et al 2010a rice et al 2015 this study uses variables characterizing climate and human activities including precipitation temperature water use and land use as potential explanatory variables trends in total annual precipitation and annual mean temperature are used to represent climate trends while trends in annual land use and water use are used to characterize human activities although this is not an exhaustive list of human activity and climate variables these variables have proven to be useful for quantifying watershed scale human and climate impacts in previous studies falcone et al 2010b rice et al 2015 the data source and resolution for each variable are summarized in table 1 for the climatic variables the total annual precipitation and annual mean temperature at each watershed are collected from the prism parameter elevation regression on independent slopes model dataset with 4 km x 4 km resolution over the 1981 2016 period prism 2019 annual groundwater and surface water use are recorded by usgs at a county level from 1985 to 2015 in 5 year increments barber 2014 maupin et al 2014 corresponding to the metric of total annual streamflow million m3 the annual precipitation and water use are also measured by water volume of million m3 with the consideration of watershed area impacts eight land use and land cover lulc types expressed by area with km2 rely on the national land cover dataset nlcd with 30 m x 30 m resolution for the following years 2001 homer et al 2007 2004 yang et al 2018 2006 fry et al 2011 2008 yang et al 2018 2011 homer et al 2015 2013 yang et al 2018 2016 yang et al 2018 the collected datasets are clipped around the watersheds in the gages ii dataset using the watershed boundaries as masks for the area that extended beyond the watershed boundary the variables are assumed to be uniformly distributed the implicit assumption made here is that the trend specified from the collected data such as the lulc data from 2001 to 2016 is sufficiently representative of the trend in the explanatory variables from 1981 to 2016 yang et al 2018 2 2 trend analysis as one of the commonly used nonparametric techniques for hydrologic trend analysis thiel sen slope sen 1968 girotto et al 2014 scholl and murphy 2013 is employed to estimate the trend magnitude of the total annual streamflow and the watershed characteristics in this study for the thiel sen slope a positive value would indicate an increasing trend of streamflow or watershed characteristics over time while a negative value means a decreasing trend sen 1968 the statistical significance for the trends in total annual streamflow is assessed with the modified mann kendall mmk test proposed by hamed and rao 1998 in this study the mmk test is used because it is applicable to streamflow with serial correlation unlike the traditional mk test hamed and rao 1998 koutsoyiannis and montanari 2007 following that regions with similar types of streamflow trend magnitude i e increasing and decreasing trends with statistical significance p 0 05 mmk test are identified and extracted from the full dataset for the following frequent pattern and variable importance analyses 2 3 apriori algorithm for the watersheds with homogenous hydrologic changes as the first association rule mining approach the apriori algorithm has been widely used as the benchmark for mining frequent itemsets han and kamber 2012 in this study a frequent itemset is defined as a set of trends in watershed characteristics whose support e g frequency exceeds the user specified minimum support i e minsup lazcorreta et al 2008 aggarwal and han 2014 while the support is defined as the percentage of candidate itemsets containing both itemset a and b which represents the usefulness of the co occurrence frequencies for itemset a and b and can be referred to the joint probability p a b han and kamber 2012 therefore at least minsup percent of gages must contain a given combination of k number of watershed attributes before this combination is defined as a frequent k itemset particularly this k itemset is specified as the maximal frequent itemset max itemset if any k 1 itemset is not frequent han and kamber 2012 aggarwal and han 2014 to significantly improve the efficiency of the apriori algorithm the apriori property is proposed by agrawal et al 1993 which states that any subset of a frequent itemset must also be frequent han and kamber 2012 following this principle the candidate set of k 1 items could be generated from the given k itemsets i e joining step the details of the algorithm are given as follows 1 initializing the search starts from finding a list of 1 itemsets i e 1 trend in watershed attribute l1 satisfying the minsup 2 joining the candidate sets of 2 items i e 2 watershed attribute trends are generated by the combination of different 2 items presented in the frequent 1 itemset 3 pruning the support e g frequency of each candidate set is computed and only the combination meeting the minsup would be defined as frequent 2 itemsets l2 which is further used to generate the candidate sets of 3 items 4 iterating the above procedure is iterated until none of the candidate combinations would satisfy the minsup once the maximal frequent itermsets are discovered the correlation between the occurrence of itemset a and b in the maximal frequent pattern could be further evaluated by the lift measure in apriori algorithm han and kamber 2012 lift is measured by comparing the frequency of co occurrence of itemset a and b p a b with the co occurring frequency of a and b under an independent assumption p a p b as follow aggarwal and han 2014 1 l i f t a b p a b p a p b therefore an independent relationship between the occurrence of a and b could be derived if lift a b 1 the occurrence of a is positively correlated with b if lift a b 1 otherwise a and b are negatively correlated if lift a b 1 han and kamber 2012 in this study the increasing and decreasing trends of watershed characteristics are defined as items and the apriori algorithm implemented within the r package a rules is applied to discover the trends in watershed characteristics that occur frequently within watersheds undergoing the similar hydrologic changes 2 4 random forest for the watersheds with homogenous hydrologic changes in order to identify the factors with the highest magnitude of influence on the changes in streamflow the relative importance of each watershed characteristic needs to be quantified generally machine learning algorithms and standard data models such as linear or logistic regression can both be used to measure the influencing magnitude of explanatory variables on the response variable fan and he 2015 however the linear regression as the most popular multiple regression is applicable only when the model residuals are normally distributed the variance is homoscedastic and there are no multicollinearities eric et al 2005 the approach for the variable importance analysis should handle the nonlinear relationships between streamflow trends and trends in watershed characteristics praskievicz and luo 2019 due to the inherent nonlinearity of complex hydrological processes mcdonnell et al 2007 in this study the random forest rf algorithm is applied to measure the magnitude of variable importance for the streamflow trends as one of the most popular ensemble learning methods rf provides robust results with high processing speed for identifying the important variables of nonlinear problems by taking advantage of an ensemble of classification and regression trees carts grimm et al 2008 belgiu and dragut 2016 moreover to overcome the numerical instability and overfitting performance of cart a randomization procedure is introduced in rf to decorrelate the trees so that the forest ensemble approach produces results with lower variance and higher accuracy galiano et al 2012 the randomization process is not only used for the division of tree nodes but also for the training of the trees with different samples through bagging or bootstrap aggregation which randomly resamples the original dataset with replacement i e with no deletion of the data selected from the input sample for generating the next subset the samples that are not selected for the training of the trees are termed as out of bag oob samples galiano et al 2012 praskievicz and luo 2019 and are used to assess the importance of each variable as follows for a given variable the variable is first permuted while other variables in the oob samples are kept constant and then rf is rerun to obtain the new results with the permuted oob samples the importance of the given variable is assessed by the average difference between the results obtained from the permuted oob and the original oob samples mathematically the importance of explanatory variable x is defined as 2 vi x 1 ntree i 1 ntree y i y i where y is the computation result associated with the original oob sample in rf y is the result corresponding to the permuted oob sample ntree is the number of trees set in rf generally a large value of vi indicates a high importance of the explanatory variable this study implements the rf regression within the r package randomforest liaw and wiene 2002 for regions with homogeneous streamflow changes to avoid the impacts of the order of magnitude on the model performance all of the trends are first normalized into values between 0 and 1 following that using the streamflow trend magnitudes as the response variables and the trend magnitude in watershed characteristics as the explanatory variables the relative importance of the watershed characteristics to the streamflow is quantified 3 results 3 1 streamflow trends with statistical significance 314 gages with the statistically significant trends p 0 05 mmk test of total annual streamflow are identified from the 2 621 gages at the conus scale in fig 2 among these gages 107 gages exhibit a significantly increasing trend and 207 gages exhibit a significantly decreasing trend since many gages i e at least 20 gages with significant streamflow trends occur in the same geographic regions four of these regions are identified for further regional analysis the great lakes region 28 gages the eastern dakotas 26 gages and the northeast area 20 gages with significantly increasing trends and the southwestern united states region 189 gages with significantly decreasing trends it should be noted that some trends in watershed characteristics occur across conus with a relatively high frequency which would affect the frequent pattern analysis for example as shown in table 2 100 of the gages in the full dataset are experiencing an increasing trend in urbanization which is consistent with the recent finding from homer et al 2020 and thus the frequency of increasing urbanization in the regions with significantly increasing and decreasing streamflow trends would also be 100 it is more meaningful to reclassify the watershed characteristics trends that have a high frequency at the conus scale in this study the watershed characteristics trends above 80 frequency at the conus scale are reclassified into rapidly and slowly increasing trends or rapidly and slowly decreasing trends categories according to the median slope values the trend with a frequency of 80 at the conus scale is selected because such a trend would also frequently occur at 70 of the gages in the sub regions with either significantly increasing or decreasing trends particularly the above occurring pattern is not available for the trend with a frequency below 65 and no trend has undergone a frequency between 65 and 80 in the whole dataset the three trends in table 2 are then reassigned into 1 rapidly increasing or decreasing trend if the absolute value of its slope is greater than the median slope value of the whole dataset or 2 slowly increasing or decreasing trend if the absolute value of the slope is less than the median value therefore there are three trend categories for the variables listed in table 2 such as rapidly increasing slowly increasing and decreasing temperature trends for the trends not included in table 2 the reclassification procedure is not executed on them and only two categories of increasing and decreasing trends are useful 3 2 frequent pattern analysis minsup is a user defined parameter in the apriori algorithm that specifies meaningful frequent pattern evaluation han and kamber 2012 however a high minsup would limit the application of useful itemsets meanwhile meaningless patterns could be generated from a low minsup liu et al 1999 to assess the effects of minsup on the max itemset derivation six values of minsup ranging from 0 5 to 0 6 with an interval of 0 02 are employed for apriori algorithm implementation that is only the watershed attributes occurring in at least 50 to 60 of the gages with significant streamflow trends would be derived as shown in fig 3 the number of frequent items generally decreases with increasing minsup particularly the increase of minsup from 0 50 to 0 52 would lead to the decrease in number of items in the sub regions of the great lakes northeast u s and southwest u s finally minsup is set as 0 5 in this study to maintain an appropriate number of watershed characteristics and avoid information loss that could assist in interpretation of the results the frequent patterns with minsup of 0 5 for the significantly increasing and decreasing trends at the conus scale and regional scale are given in figs 4 and 5 respectively as can be seen from fig 4a for the 107 gages with significantly increasing trends at conus 92 gages 85 98 have experienced an increasing trend of precipitation i e the most frequent 1 itemset and 65 gages 60 75 i e the dashed line in fig 4a have both increasing precipitation and decreasing surface water use i e the maximal frequent 2 itemset the pattern of increasing precipitation and decreasing surface water use are necessarily frequently found in the sub regions of great lakes and northeast as illustrated in fig 4b and 4d particularly the increasing precipitation trend is found in all of the 28 gages in the great lakes region i e the most frequent 1 itemset and 14 gages 50 undergo the following six trends simultaneously rapidly increasing urbanization and increasing precipitation but decreasing surface water use agriculture and wetland and slowly decreasing forest land i e the maximal frequent 6 itemset similarly 15 gages 75 have experienced both the increasing precipitation and decreasing surface water use in the 20 gages of the northeast region the following maximal frequent 6 itemset is observed in 10 gages 50 increasing precipitation shrub and grassland but decreasing surface water use and agricultural land and rapidly decreasing forest land for the 26 gages in the eastern dakotas the variation pattern of increasing precipitation and land use change are frequently found fig 4c that is all of the gages show the tendency toward increasing precipitation and barren land but decreasing grassland and 14 gages 53 85 undergo the following maximal frequent seven trends simultaneously increase in precipitation groundwater use barren land shrub land and agricultural land and slowly increasing urbanization but decreasing grasslands as shown in fig 5a for the 207 gages with significantly decreasing streamflow trends 178 gages 85 99 experience a decreasing trend in precipitation i e the most frequent 1 itemset and 111 gages 53 62 experience the trends of decreasing precipitation and surface water use and simultaneously increasing agricultural land i e the maximal frequent 3 itemset similar frequent pattern of climatic and anthropogenic changes is also observed in the southwest fig 5b that is 110 of 189 gages 58 20 undergo the above three trends and 95 gages 50 26 have experienced the pattern of decreasing precipitation and surface water use rapidly increasing temperature and increasing agricultural land i e the maximal frequent 4 itemset the correlation between the watershed attributes in the above frequent patterns are further given in terms of the lift measure in fig 6 generally the value range of lift from 0 9 to 1 5 indicates a not strong correlation and such a relationship for the watershed characteristics could be observed from fig 6a and 6b in particular a relatively low correlation between the watershed attributes in the gages with significantly decreasing streamflow is identified from the range between 0 95 and 1 05 fig 6b in contrast a relatively high correlation between different land use types in the sub regions with significantly increasing streamflow is observed with a lift value above 1 05 fig 6a such as the relationship between the rapidly increasing urbanization and the decreasing agricultural land in great lakes regions and the positive correlation between the rapidly decreasing forest land and the increasing grass land in the northeast 3 3 variable importance analysis the implementation of rf requires the determination of two key parameters the number of decision trees to be generated ntree and the number of explanatory variables used in each node to make the tree grow mtry as pointed out by some theoretical and numerical research ghosh et al 2014 kulkarni and sinha 2012 the performance of rf is more sensitive to mtry than ntree particularly due to the so called strong law of large numbers feller 1968 the generalization error would converge and over training is not a problem with increasing ntree in rf model breiman 1996 2001 therefore a large value of ntree 1000 is set in this paper comparing to the default value of 500 on the other hand a low value of mtry could reduce the robustness of rf model while a high value might introduce noise into the performance evaluation grimm et al 2008 galiano et al 2012 concerning the default value of mtry as one third of the total number of variables for rf regression problem i e 4 12 3 7 different values of mtry ranging from 2 to 8 are adopted to evaluate the effects of mtry on the model performance as measured by the coefficient of determination r2 as can be seen in fig 7 r2 generally increases first and then decreases with increasing mtry for the watersheds at conus and regional scales following this variation pattern the best performance in terms of the largest r2 is observed at the value of mtry 4 for the sub region of great lakes and mtry 5 is specified for the regions with significantly increasing trends at conus as well as northeast in addition mtry 6 is optimal for the regions with significantly decreasing trends i e conus and southwest and dakotas therefore either mtry 4 5 or 6 is used in the following analysis corresponding to the best model performance at each region the relative variable importance of watershed characteristics is illustrated in figs 8 and 9 as expected the variables characterizing climate mainly precipitation is highly influential on the magnitude of the streamflow trend whether the trend is increasing or decreasing at the conus and regional scales the relative importance of water use especially surface water use is generally greater than the importance of land use at the conus scale however the importance of trends in anthropogenic features as measured by land use and water use varies among regions for example the changes in land use particularly for forest variation tends to be more important than the trends in water use for northeast and southwest regions fig 8d and 9b with a relatively large forest coverage i e at least 50 and 30 of land cover in northeast and southwest respectively in contrast water use changes play a relatively more important role in the great lakes and dakotas regions fig 8b and 8c where agricultural land is dominant i e agricultural land comprises more than 45 and 70 of the total land use in great lakes and dakotas respectively these results imply that the influence of trends in water use tends to be higher in regions dominated by agricultural land e g dakotas but trends in land use may be more important in the regions with large forest coverage e g northeast to specify a sufficient parsimonious set of important variables within controlled accuracy for the following frequent and importance analysis a cross validation scheme is preferred in the rf model genuer et al 2010 in this paper a 10 fold cross validation is used to minimize mean square error i e mse default performance in randomforest package as can be seen in fig 10 mse decreases significantly with a limited number of variables at first therefore the threshold for ending such a significantly decreasing trend of mse is identified as the criterion for the variable number determination that is the top 4 most important variables are chosen for the conus with significantly increasing and decreasing trends and the numbers of top important variables of 3 3 4 5 are used for the sub regions of great lakes dakotas northeast and southwest respectively note that the accuracy loss from the parsimonious sets are controlled within a reasonable range in each region i e at most 15 difference of mse resulting from all 12 variables 4 discussion 4 1 frequent and important patterns using the frequent patterns identified in section 3 2 i e figs 4 and 5 and the important variables selected in section 3 3 i e figs 8 9 and 10 as the drivers for streamflow changes three categories are classified with the criteria of importance and frequency as 1 frequent and important patterns i e attributes with both importance and frequency 2 frequent but not important patterns i e attributes with sufficient frequency but not importance 3 important but not frequent patterns i e attributes with only importance these three categories provide guidelines about which variables play a dominate role i e the frequent and important patterns or subsidiary role i e the frequent but not important patterns to discover the causes of the regional streamflow trends and which variables might be site specific driving forces of the streamflow trends i e the important but not frequent patterns the three categories for the conus and each region are given in table 3 generally the variation of precipitation is both frequent and important for the streamflow trends at the conus scale and regional scale in contrast many human activities are region specific and not frequently identified at conus scale particularly only decreasing precipitation is specified as a frequent and important pattern for the watersheds with significantly decreasing streamflow across conus although decreasing precipitation and increasing agricultural land occur frequently fig 5a this result implies that increasing agricultural activity does not lead to the decrease in streamflow but is only frequently associated with streamflow trends in addition for the sub regions with significantly increasing trends the important identified water use changes are all not so frequent and vice versa therefore compared to the variation of climate and land use the change of water use could be considered as subsidiary factors or site specific drivers for the increasing streamflow trends these identified regional relationships are further explained with the published studies in the following section 4 2 regional streamflow trends and watershed characteristics in table 3 we attribute the regional trends in streamflow to the trends in watershed characteristics in terms of both importance and frequency a review of the literature verifies the relationships between these characteristics and streamflow changes streamflow variation in the great lakes region is generally driven by changes in climate as well as land use norton et al 2019 the statistical analysis of hydrometeorological dataset in southwestern wisconsin further suggests that the increasing precipitation is the dominant driver for the upward streamflow trend and the less intensive agricultural management interacted with climate change would intensify the magnitude of streamflow changes juckem et al 2008 the variation of impervious surface is likely to be the determinant for this collective effect smakhtin 2001 and the conversion from agricultural land to urbanization i e frequent attribute in table 3 could increase the impervious surface li et al 2020 decrease total infiltration price 2011 and thus result in an increase annual stormwater runoff norton et al 2019 these findings are consistent with the frequent and important patterns of increasing precipitation and decreasing agricultural land identified in subsection 4 1 in the dakotas region some numerical studies have employed the dataset with similar streamflow and climate series from 1981 2014 but different projected land use data to derive the contribution of climate change and land use on annual streamflow variation ahiablame et al 2017 these findings indicate that the increasing trend of precipitation is primarily responsible for the increasing annual streamflow ahiablame et al 2017 according to the results among the 26 gauge stations in eastern dakotas the lands around 18 of them 69 have experienced both increasing agricultural land and decreasing grassland agricultural expansion associated with decreasing grassland i e the correlation coefficient of the trend magnitude between increasing agricultural land and decreasing grassland is 0 99 could further amplify the increasing magnitude of the streamflow trend ahiablame et al 2017 by reducing land surface roughness baker and miller 2013 and available soil water storage busman and sands 2002 these results are consistent with the important and frequent characteristics identified in table 3 and further explain the collective influence of climate trends i e increasing precipitation and land use management i e increasing agricultural land on the streamflow trend there is little question that the increasing precipitation could increase the annual average streamflow in northeast homa et al 2013 typically the increase in precipitation is specified as the primary factor for the increasing streamflow small et al 2006 milly 2005 groisman 2004 which corresponds to the most important variable as given in fig 8d furthermore the hydrologic response to the change in impervious surface from conversion of forest to grassland i e frequent and important attributes in table 3 is pronounced in northeast where humid climate and large forest coverage dominate the landscapes petersen et al 2012 it is generally believed that such an impervious surface conversion would increase streamflow by decreasing soil infiltration capacity price 2011 and decrease et hao et al 2015 the causes of the decreasing streamflow in the southwest us have been widely investigated in previous studies macdonald 2010 maupin et al 2018 ficklin et al 2018 and decreasing precipitation and increasing temperature are primarily responsible for the decreased flow qi et al 2009 maupin et al 2018 combined with the decreasing precipitation the increasing high temperature in the southwest increases evapotranspiration rates and then exacerbates the decrease in streamflow caused by lower precipitation macdonald 2010 garfin et al 2013 in this study the surface water use change is also identified as one primary driver for the streamflow change but the trend of water use is generally decreasing therefore the climate trends are the dominant factors for decreasing streamflow in the southwest while the impacts of decreasing water use would diminish such a decreasing magnitude 4 3 implications for water resources planning and management the important and frequent characteristics are classified into three categories as discussed in section 4 1 these three categories provide implications for not only the application of the important variables to discover the causes of regional streamflow changes as shown in section 4 2 but also for scenario generation for modelling water resources availability and variation particularly the frequent and important role of climate features identified in this study highlights the importance of accurate projections of climate variables in climate models as well as the need for water resource managers to test the system performance over a range of climate scenarios lempert et al 2004 prudhomme et al 2010 brown et al 2012 comparing the important and frequent variables between conus and regional scale the climate trends are not the only drivers of regional streamflow trends the role of human activities identified at the regional scale has some important implications for sustainable water resources management particularly increased understanding of how frequently and importantly the trend in human activities is related to streamflow trends could facilitate detailed and targeted strategies to mediate potential future streamflow changes the influence of land use management on the increase of streamflow has been observed in the dakotas region which has positive implications for water resource availability in the region similarly the rapid urban development with less intensive agricultural practices in the great lakes regions might amplify the magnitude of increasing streamflow trend caused by the climate change green infrastructure such as parks green street corridors and rain gardens is suggested as a cost effective measure to increase water storage in soil and groundwater as well as decrease urban flooding events hopton et al 2015 norton et al 2019 deforestation activities have some positive implications for increasing the total annual streamflow in the northeast however amid reported trends of increasingly erratic and extreme precipitation events wake 2005 nguyen and degaetano 2012 stormwater strategies are suggested to mitigate the likely occurrence of damaging flood risks in the northeast decreasing water use plays an important role to offset the decreasing streamflow trends in the southwest more attention should be given to water conservation measures and effective water utility management for mitigating the decreasing trend in streamflow in the future 5 conclusions in this study the relationships between trends in total annual streamflow and trends in watershed characteristics across the conus from 1981 through 2016 are investigated with a dataset of 2 621 usgs gages the regions of homogenous hydrologic changes i e watersheds that are undergoing similar significant trend magnitude are delineated the results focus on four regions with significant streamflow trends i e the eastern dakotas northeast the great lakes region and the southwest the key driving forces for the streamflow trends in the past and the potential forces for future streamflow changes are specified using a statistical framework of frequent patterns and variable importance in general as expected the trends in streamflow are highly associated with those in precipitation in contrast the influences of anthropogenic factors vary substantially across regions particularly the influence of trends in water use tends to be significant in the regions dominated by agricultural land e g dakotas while the importance of land use change is highlighted in the regions with a relatively large forest coverage e g northeast however these important identified water use changes are not frequently associated with the increasing streamflow in the sub regions and thus the significance of the water use impacts are site specific therefore the climate and land use trends are involved in frequent and important patterns in sub regions with significantly increasing streamflow trend and they are collectively used to discover the major causes of streamflow trends in those regions e g great lakes regions it is found that the agricultural expansion associated with decreasing grassland contribute to increasing streamflow in the dakotas while the rapid urban development with less intensive agricultural policy in the great lakes regions amplifies the increasing streamflow trend through the increase of impervious surface furthermore the increasing streamflow trend in the northeast is mainly attributed to the frequent and important pattern of increasing precipitation and deforestation activities although the importance of the water use changes are highlighted in the southwest the climate trends are mainly responsible for the decreasing streamflow therefore streamflow restoration efforts in the southwest should focus on water conservation measures in general this study follows the direction of streamflow assessment especially its change over time which has had a rich literature e g zanardo et al 2012 mu et al 2020 yao et al 2020 specially this study takes land use and water use as explicit factors to the trends of streamflow change and the results add to the quantification and understanding of the human dimension of hydrology vogel et al 2015 the regions of homogenous hydrologic changes identified from this study and particular sites where human activities such as land uses and water users should be taken into consideration will be useful information for future hydrologic model and data analysis gupta and nearing 2014 tarasova et al 2020 especially for regions with heavy human interferences vogel et al 2015 studies on the relationships between streamflow and land and or water use are used to validate the findings of this study particularly the impacts of land use and water use on annual streamflow with limited explanatory variables more anthropogenic factors e g changes in dam storage and influencing area of human activities and watershed characteristics e g topography could be taken into consideration in future work another limitation of this study is that we employ a binary classification of trends in watershed characteristics for frequent pattern analysis i e increasing or decreasing refined classification methods could be employed to provide more quantitative information of frequent patterns in changing watersheds due to some short data records possible uncertainty and lag effects might exist with the trend analysis and the subsequent results consecutive long term data records could be collected in the future to mitigate these effects and provide better understanding about streamflow change attribution in spite of these limitations with the powerful data analysis tools of frequent pattern mining and machine learning the data driven analytical framework proposed in this study can be extended to derive valuable information on streamflow changes such as a step change or a gradual change and explore the causes from very large datasets contribution spencer schnier and ximing cai designed the study xiang zeng and spencer schnier performed research and analyzed dataset xiang zeng ximing cai and spencer schnier wrote the manuscript declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research is supported by the national natural science foundation of china 91647204 51609174 51909083 and china postdoctoral science foundation 2016m602359 the corresponding author would like to thank thomas over tushar apurv ruijie zeng xiao zhang wuhan university murugesu sivapalan and praveen kumar for their valuable comments on early versions of this manuscript supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103799 appendix supplementary materials image application 1 
356,conventional macroscale two phase flow equations for porous media such as darcy s law and richards equation require a constitutive relation for capillary pressure pc the capillary pressure relation significantly impacts the behavior and prediction of fluid flow in porous media and needs to accurately characterize the capillary forces in a typical laboratory experiment a functional macroscopic capillary pressure saturation pc sw relationship is measured as the difference between the pressures of the non wetting phase reservoir at the inlet pnw and wetting phase reservoir at the outlet pw of a porous medium it is well known that this traditional macroscopic capillary pressure definition is valid only at equilibrium conditions and if the phases are connected under non equilibrium dynamic conditions when the fluids are moving the macroscopic capillary pressure measured in experiments implicitly includes the pressure head caused by viscous effects the goal of the present effort is to understand how well the traditional macroscopic capillary pressure definition represents the pore scale capillary forces under different flow conditions using direct numerical simulations dns of two phase flow in a porous medium we evaluate the capillary pressure at the pore scale and compare it to the macroscopic capillary pressure pc sw that is typically measured in experiments using pressure transducers the pore scale capillary pressure is the pressure difference across the interface between two fluids as the fluids move through a porous medium the interface pressure differences at fluid fluid invasion front are averaged across all the pores of the porous medium to yield a representative pore scale capillary pressure curve referred to as the interface capillary pressure the pore scale interface capillary pressure represents the true capillary forces in the system since depends only on the pore morphology shape and interfacial energy of the two fluids and does not account for the viscous dissipation in experiments it is difficult to measure the interface capillary pressure jump without accounting for the viscous pressure head which is at least an order of magnitude larger upscaling the pore scale capillary pressure is an essential step for complete characterization of capillary dominant two phase flow in a porous medium at the laboratory scale drainage is simulated under equilibrium quasi static and non equilibrium dynamic conditions for various capillary numbers the navier stokes ns equations are solved in the pore space using the open source finite volume computational fluid dynamics cfd code openfoam the volume of fluid vof method is employed to track the evolution of the fluid fluid interfaces and a contact angle is used to account for the effect of wall adhesion the simulations are first validated with published experimental data for dynamic and quasi static drainage in a micromodel from the microscale simulations the interface capillary pressure is determined and compared to the macroscopic capillary pressure under equilibrium and non equilibrium conditions our results show the traditionally measured macroscopic capillary pressure curves exhibit a strong dependence on the capillary number under dynamic flow conditions in contrast the interface capillary pressure saturation relation which relies on pore scale pressure differences at the invasion front is almost invariant of flow conditions dynamic and quasi static keywords capillary flow dynamic capillary pressure young laplace equation drainage volume of fluid vof method 1 introduction understanding the physics of immiscible two phase flow in porous media is imperative for a number of applications such as oil and gas recovery ground water redistribution carbon dioxide sequestration and drug delivery to name a few mcclure et al 2018 porous media flows are an inherently multiscale problem in which complex physical phenomena drive the fluid flow at the pore scale whereas the processes of applied interest occur at the macroscale system or continuum scale the challenge is to understand what drives the flow at the smallest scales pore scale and find a way to up scale this information in a manner that it can be used for successful product design and development at the macroscale or continuum scale since it is computationally infeasible to explicitly predict the flow in each and every pore in a porous medium up scaled equations based on averaged properties that are defined over a representative elementary volume rev are needed to predict the flow at the macroscale m th van genuchten 1980 conventional macroscale two phase flow equations for porous media darcy s law and richards equation require three empirical constitutive relations that are nonlinear functions of saturation two relative permeability saturation kr relations for each fluid phase and one capillary pressure saturation pc relation these constitutive relations represent the point at which physical measurements are incorporated into mathematical and numerical models reeves celia 1996 capillary pressure pc is inherently a pore scale phenomenon and is defined as the difference in pressure across a curved interface separating two immiscible fluids at equilibrium armstrong porter wildenschild 2012 bear 1972 and is expressed as 1 p c p nw p w in eq 1 pnw is the non wetting phase pressure and pw is the wetting phase pressure pc is attributed to the normal component of interfacial forces due to the surface tension at the interfacial boundaries if we consider a small segment of a curved interface between two fluids and balance the pressure and interfacial tension at static equilibrium then we arrive at the young laplace which is written as 2 p c p nw p w  k where  is the interfacial tension and k is the mean curvature of the interface for a simple capillary tube with a known mean curvature k eq 2 can be re written as the well known laplace s equation 3 p c 2  cos  r where  is the contact angle measured as the angle between the fluid fluid interface and the solid surface and r is the radius of the capillary tube a phase is considered as wetting when the contact angle is acute i e  90o and as non wetting for an obtuse contact angle  90o the contact angle is an important parameter that is used to quantify wettability which dictates the movement of fluids in sub surface flows such as oil and gas recovery and carbon sequestration verma icardi prodanovi 2018 in a porous medium the situation is more complex due to the intricate geometry of the solid matrix and the morphology of the fluid fluid interfaces ferrari lunati 2013 this problem is overcome by using macroscopic also known as continuum or darcy scale models which ignore the fine details by averaging over a large number of pores traditionally capillary pressure is defined at the macroscale using the empirical relationship 4 p c s w p nw p w where pnw is the average non wetting phase pressure pw is the average wetting phase pressure and pc is the average macroscopic capillary pressure typically measured as a function of wetting phase saturation sw here the wetting phase saturation sw is defined at the macroscale as the ratio of the average wetting phase volume to the total open volume of the porous medium and is written as 5 s w 1 v v  dv where  is the volume fraction of a phase and v is the pore volume from eq 5 it follows that the saturation of the non wetting phase is snw 1 sw it is obvious that the traditional pc sw relationship in eq 4 is analogous to its universal counterpart in eq 1 and provides a simple relationship between the phase pressures and the saturation starnoni pokrajac 2019 the traditional empirical pc sw relationship is based on the assumption that pc is a function of saturation only other pore scale properties such as interfacial configuration interfacial curvature pore morphology etc are ignored due to experimental limitations armstrong et al 2012 it is often assumed that all pore scale properties are lumped into the saturation sw thereby overlooking their individual effects in conventional porous media flow theory the difference in the average phase pressures is presumed to be equal to the capillary pressure under all conditions and at all times joekar niasar majid hassanizadeh 2011 in laboratory experiments the pressure is conveniently available at the reservoirs containing the non wetting and the wetting fluids outside the porous medium the reservoir pressures can be measured using pressure transducers while the wetting phase saturation is measured inside the porous medium majid hassanizadeh gray 1993 consequently the average macroscopic capillary pressure in eq 4 is calculated as the difference between the pressures of the non wetting phase reservoir at the inlet pinlet or pnw and wetting phase reservoir at the outlet poutlet or pw of a porous medium thus eq 4 can be re written as 6  p io p inlet p outlet p c s w where pio represents the total pressure drop across the porous medium between the inlet and outlet reservoirs it is customary to assume that the macroscopic capillary pressure pc sw in eq 6 based on the total pressure drop is equal to the pore scale capillary pressure at the fluid fluid invasion front laplace s pressure due to the curvature of the menisci defined in eq 2 under all conditions many recent theoretical and experimental studies have stated that the macroscopic capillary pressure can agree with the true pore scale static capillary pressure jump due to the curvature at the menisci only when the pressure is constant within each phase camps roach o carroll newson sakaki illangasekare 2010 hassanizadeh celia dahle 2002 in other words the macroscopic pressure definition in eq 6 is valid only at equilibrium i e when the fluid phases are not moving dahle celia majid hassanizadeh 2005 karadimitriou hassanizadeh joekar niasar kleingeld 2014 and only if the phases are connected ferrari lunati 2013 when the fluids are moving the fluid pressures within the pores vary with time and space thus the capillary pressures at different interfaces will be different from each other and will not be equal to the difference in boundary reservoir pressures karadimitriou et al 2014 this is known as non equilibrium or dynamic transient flow conditions the term dynamic or non equilibrium covers a broad spectrum of porous media flows which includes but is not limited to cases where the flow rate is high or when the permeability of the medium is low li et al 2020 an important facet of non equilibrium or dynamic flows is the absence of interfacial relaxation towards equilibrium saturation meisenheimer mcclure rivers wildenschild 2020 non equilibrium dynamics in multiphase flows can lead to different production behaviors in a reservoir as compared to equilibrium flows li et al 2020 along with differences in interfacial shapes contact angles fluid saturation distribution etc in a dynamic or transient flow scenario a macroscopic capillary pressure definition based on the averaged reservoir phase pressures or the total pressure drop implicitly includes the contribution from the pore scale capillary pressure at the fluid fluid invasion front and the pressure head caused by viscous effects lovoll et al 2011 washburn 1921 resulting in 7  p io  p interface p viscous in eq 7 pinterface represents the pore scale capillary pressure at the invasion front and pviscous is the pressure head loss caused by the viscous effects viscous dissipation this principle was incorporated into the macroscopic capillary pressure theory in the form of an extended capillary pressure saturation relationship that included an additional term to account for dynamic effects hassanizadeh et al 2002 manthey hassanizadeh helmig hilfer 2008 this is referred to as the non equilibrium capillarity effect the dynamic effects on capillary pressure result in a dependence on the rate at which the phase saturations change in response to changes in phase pressures camps roach et al 2010 industrial and environmental porous media flows typically occur under non equilibrium or dynamic conditions when the fluids are constantly moving since eq 6 is only valid at equilibrium it is typical to measure the macroscopic capillary pressure saturation relationship pc sw for a given porous medium under quasi equilibrium conditions aka quasi static conditions in a quasi static experiment an injection phase is followed by a relaxation phase when the fluids allowed to equilibrate the pressure is then measured at the fluid reservoirs in the equilibrium phase and the difference is treated as the macroscale capillary pressure the relaxation and rearrangement of interfaces from dynamic to static conditions and the time required for equilibration are prerequisite to warrant the equilibrium assumption armstrong et al 2012 the measurement of macroscale quasi static pc sw curve requires hours or even days for each porous sample bear 1972 the measured quasi static pc sw data is supplied as a constitutive relation to a macroscale continuum based models such as darcy s law to study complex dynamic flow processes which occur in time scales of the order of seconds to minutes dahle et al 2005 under dynamic flow conditions the total pressure drop implicitly includes the effect of viscous pressure head second term in eq 7 which in turn depends strongly on the invasion velocity of the flow and the system size in contrast to the viscous pressure losses the pore scale capillary pressure at the fluid fluid interface first term in eq 7 remains almost constant it only depends on the interfacial energy and the geometry topology of the pore lovoll et al 2011 the pore scale interface capillary pressure represents the true capillary forces in the porous medium and should be up scaled or averaged using an appropriate definition to obtain the macroscopic pc sw relation for a porous medium in experiments it is difficult to measure the interface capillary pressure jump without accounting for the viscous pressure head which is at least an order of magnitude larger this difficulty can be circumvented in direct numerical simulations dns in which the conservation equations are solved explicitly in the pore space without making assumptions thereby permitting us to carefully investigate pore scale processes and their impact on macroscale processes ferrari lunati 2013 using direct simulations of microscale capillary flows it is possible to distinguish the interface capillary forces from the viscous forces upscaling the interface capillary pressure is an essential step for complete characterization of capillary dominant two phase flow in a porous medium at the darcy scale in literature few studies have attempted to estimate the pore scale interface capillary pressure under static conditions nolte and co researchers chen pyrak nolte griffin giordano 2007 cheng pyrak nolte nolte giordano 2004 pyrak nolte nolte chen giordano 2008 used image analysis to calculate the interfacial length and thereby the mean curvature in two dimensional 2d transparent micromodels the curvature is then used in young laplace equation to calculate the capillary pressure armstrong et al 2012 and herring middleton walsh kingston sheppard 2017 used a novel curvature measurement algorithm to determine microscopic image based capillary pressure saturation curves from computed x ray micro tomography cmt experiments of quasi static drainage and imbibition experiments in a 3d porous medium and compared this to macroscopic transducer based capillary pressure measurements under transient conditions to the authors knowledge the only experimental attempts to determine the interface capillary pressure is the work of karadimitriou et al godinez brizuela karadimitriou joekar niasar shore oostrom 2017 karadimitriou et al 2014 who used image analysis to determine the interface capillary pressure in their experiments they measured the planar contact angle which is then used to calculate the local pore scale capillary pressure lastly using direct numerical simulations with the volume of fluid vof method ferrari et al ferrari lunati 2013 and recently starnoni et al starnoni pokrajac 2019 investigated different definitions of macroscopic capillary pressure ferrari et al concluded that a definition based on total interfacial helmholtz energy allows for better separation of the viscous forces starnoni et al derived a novel macroscopic capillary pressure definition based on sub surface pressure averages and showed that it corresponds well to a definition based on interface curvature in this study we use direct simulations with the vof method to explicitly measure the pore scale capillary pressure in a porous medium and compare the pore scale capillary pressure to the macroscopic capillary pressure pc sw under equilibrium quasi static and non equilibrium dynamic conditions the pore scale capillary pressure is the pressure difference at the interface between two fluids as the fluids move through the porous medium for a system with a single pore such as a capillary tube a pore scale capillary pressure value is computed by averaging the fluid pressure differences at the interface between the two fluids in the tube by extension for a porous sample with multiple pores a representative pore scale interface capillary pressure value is calculated by averaging the pressure differences across all the menisci between the wetting and non wetting fluids this pore scale average pressure difference is referred to as the interface capillary pressure pinterface the goal is to understand the link between the macroscopic capillary pressure pc sw and the pore scale interface capillary pressure pinterface direct numerical simulations of microscale two phase flows in a porous medium are conducted from these simulations the pore scale interface capillary pressure acting at the fluid fluid interfaces is computed under dynamic and quasi static flow conditions the interface capillary pressure pinterface is compared to the macroscale capillary pressure corresponding to the total pressure drop pio in eq 6 that is typically measured in experiments using pressure transducers this approach allows for a direct comparison between an intrinsic interfacial property computed at the pore scale to a macroscale averaged property this comparison is crucial to understand how well the conventional macroscale capillary pressure definition represents the pore scale interfacial properties under different flow conditions that may include unstable interfaces in order to study the interface capillary pressure drainage or desaturation is chosen as the preferred displacement process in drainage a porous medium is assumed to be saturated with a wetting phase which acts as the defending fluid and is displaced by the invading phase or the non wetting fluid direct two phase flow simulations are performed by solving the navier stokes ns equations in the pore space using the open source finite volume computational fluid dynamics cfd code openfoam open field operation and manipulation greenshields 2015 the volume of fluid vof method is employed to track the evolution of the fluid fluid interfaces and a contact angle is used to account for the effect of wall adhesion direct simulations with the vof method allow for high resolution description of the geometry and time evolution of interfaces thereby permitting us to investigate the pc sw relationship as a first step to validate our calculations the simulation results are compared to available experimental data drainage under an applied pressure drop corresponding to experimental conditions is simulated in a micromodel and the simulation results are compared to experimental results published in kunz et al 2016 on establishing the physics modeling capability the next step is to use the two phase flow solver to understand the interface capillary pressure to accomplish this as a first step we study a cylindrical capillary tube which is a simple test case with only one known pore size dynamic and quasi static drainage are simulated for different capillary numbers in the capillary tube and the interface capillary pressure is calculated using both simulation and analytical solution laplace s equation eq 3 here the capillary number is defined as ca v  where v is the velocity of injection next in order to increase the complexity drainage is simulated in a porous medium with multiple pores from these microscale simulations the pore scale interface capillary pressure is directly determined at the fluid fluid invasion front this capillary pressure depends on the pore morphology shape and interfacial energy of the two fluids at the interface without accounting for the viscous dissipation the interface capillary pressure is compared to the macroscopic capillary pressure under equilibrium and non equilibrium conditions this paper is organized as follows section 2 describes the governing equations and the vof method the results of the drainage experiments along with the interface capillary pressure calculations are presented in section 3 the conclusions are discussed in section 4 2 methodology as stated in the previous section we utilize direct simulations with the vof method to investigate the pore scale capillary pressure under equilibrium quasi static and non equilibrium dynamic conditions dns coupled with vof has emerged as a powerful tool for diagnosing pore scale multiphase flow problems with complex boundary conditions enabling parameterization of macroscale quantities rabbani or et al 2018 the vof method relies only on conservation principles and solves a system of equations for the flow field evolution of two immiscible fluids nikhil kumar palakurthi konangi kishore comer ghia 2018 in the recent past the vof method has been successfully used by many researchers to study capillary dominant flows aboukhedr georgoulas marengo gavaises vogiatzaki 2018 aslannejad fathi hassanizadeh raoof tomozeiu 2018 deshpande anumolu trujillo 2012 fathi raoof mansouri 2017 ferrari lunati 2013 2014 hu wan kim tokunaga 2017 n k palakurthi konangi kishore comer ghia 2018 rabbani joekar niasar shokri 2016 rabbani joekar niasar pak shokri 2017 rabbani or et al 2018 rabbani seers 2019 rabbani zhao juanes shokri 2018 raeini bijeljic blunt 2015 saha mitra tweedie roy mclaughlin 2009 starnoni pokrajac 2019 suo liu gan 2019 verma et al 2018 in the vof method the effect of surface tension at the fluid fluid interface and wall adhesion in the form of a contact angle between the wetting liquid and solid matrix are accounted for n k palakurthi et al 2018 since no modeling assumptions are made on the geometry of the pore structure and flow propagation direct numerical simulations with vof method can serve as a means to gain valuable insights into the multi phase flow dynamics at the pore scale one of the major drawbacks of the vof method is the presence of parasitic or spurious currents owing to the pressure imbalance at the interface however it should be noted that other direct simulation methods such as particle based methods like lattice boltzmann lbm and smoothed particle hydrodynamics sph and continuum methods like level set ls also suffer from the presence of parasitic currents around the interface pavuluri maes doster 2018 berberovic berberovic 2010 presents the advantages of the vof method as compared to other particle and continuum methods in his dissertation the first part of this section describes the conservation equations of the vof method following this the results of a validation case are presented to verify the modeling accuracy of the two phase flow solver with published experimental results 2 1 governing equations and volume of fluid vof method the vof method is a fluid fraction based interface capturing technique used for modeling the flow of a system of two incompressible immiscible fluids nikhil kumar palakurthi et al 2018 it is based on a whole domain formulation that treats a two fluid system as a single fluid system with space dependent physical properties ferrari lunati 2013 in the conventional vof method the continuity and momentum conservation equations are solved along with an additional transport equation for the fluid fraction of one phase the governing equations are the 3d unsteady incompressible isothermal navier stokes equations along with a fluid fraction equation and are shown here in the vector form 2 1 1 fluid fraction advection equation the fluid fraction equation is written as 8 f t f u 0 where f is the fluid fraction aka volume fraction and lies between 0 and 1 0 f 1 and u is fluid velocity vector which is computed from the momentum equation eq 9 the spatial distribution of a phase is described by a fluid fraction function which carries information about the phase present wetting or non wetting f 0 corresponds to cells filled with the non wetting phase whereas f 1 indicates cells containing the wetting phase the interface is a surface of discontinuity of the fluid fraction function and is identified as the region in which the gradient of the fluid function is non zero gradients of the fluid fraction are encountered only in the region of the interface between the two phases 2 1 2 continuity or mass conservation equation 9 u 0 for incompressible flows the mass conservation equation is expressed as a solenoidal constraint on the fluid velocity u 2 1 3 momentum conservation equation 10  u t  uu p  u u t f  where  and  are density and dynamic viscosity of the fluid respectively and f  is the surface tension force the physical properties of the fluids phases are calculated as weighted averages based on the distribution of the fluid fraction function as shown in eq 10 11   w f  n w 1 f   w f  n w 1 f here the subscripts w and nw indicate the properties of the wetting and non wetting phases respectively the surface tension force f in the momentum conservation equation eq 10 is computed using the continuum surface force csf formulation brackbill kothe zemach 1992 this force is non zero only at the interface and describes the effect of the laplace pressure in the csf method the surface tension force acting at the interface is represented as a body force or volume force over the region occupied by the interface and is formulated as 12 f   k f where  is the surface tension between the wetting and non wetting phases and k is the mean curvature of the free surface which represents the magnitude of the interface normal flux at a specific face of the cell and is formulated as 13 k n c here n c is the unit vector normal to the fluid fluid interface calculated from the fluid fraction field as 14 n c f f in the vof method the interaction between the fluids and the solid surface i e wall adhesion is included as a boundary condition on the surface normal vector at the solid wall 15 n c n s c o s  t s s i n  here n s and t s are the unit vectors in the normal and tangential directions to the solid boundary respectively and  is the equilibrium or static contact angle wall adhesion or the wetting behavior at solid walls is accounted for using the contact angle which is given as an input to the solver the surface normal vector is corrected at the triple contact line to satisfy the specified static contact angle boundary condition the interface curvature in eq 13 is then calculated using this corrected surface normal vector as noted by ferrari lunati 2013 the interface curvature is fixed only in the faces adjacent to the solid walls whereas the interfaces can deform in the other cells in openfoam a modified fluid fraction advection equation is solved to ensure boundedness and conservation of the fluid fraction f an interface compression term is added to the fluid fraction advection equation to reduce the smearing of the interface and is critical for two phase flows with high density ratios berberovi van hinsberg jakirli roisman tropea 2009 readers are referred to berberovi et al 2009 deshpande et al 2012 for additional details of the modified fluid fraction advection equation implemented in openfoam 2 2 solution procedure with openfoam the first step in conventional computational fluid dynamics cfd is the generation of a grid which adequately resolves the pore space in a porous medium an eulerian unstructured hexahedral dominant computational grid is generated using the meshing utility helyxhexmesh which is a part of the enhanced openfoam package engys www engys com in the meshing process a background hexahedral mesh is first created for a desired resolution maintaining a cell aspect ratio of unity subsequently the unwanted cells inside the solid body are removed and a boundary fitted grid is obtained by iteratively refining and snapping the cells to the solid surfaces resulting in split hexahedral cells next the 3d incompressible ns equations eqs 9 and 10 along with the fluid fraction equation eq 8 are discretized using a finite volume discretization scheme a first order time accurate implicit euler scheme is used to integrate the mass and the momentum conservation equations whereas second order accuracy is ensured in the spatial discretization the fluid fraction equation is solved explicitly the piso pressure implicit operator splitting solution algorithm ferrari lunati 2013 is used to solve the coupled system of discretized equations in an iterative fashion until convergence is obtained the equations are solved in parallel using the mpi message passing interface algorithm greenshields 2015 in order to demonstrate the modeling accuracy of our simulations a validation case is presented in the next section 2 3 validation of numerical solution in this section the modeling accuracy of our two phase calculations is tested by simulating a validation case validation addresses the physics modeling accuracy of a simulation by comparing the simulation results with experimental data oberkampf trucano 2007 for the purpose of validation experiments conducted by kunz et al 2016 are computationally replicated kunz et al 2016 performed microfluidic experiments of drainage in a poly dimethyl siloxane pdms micromodel shown in figure 1 the pdms micromodel used in their experiment is hydrophobic quasi two dimensional rectangular channel of dimensions 2 5 1 mm2 in length and breadth respectively a random distribution of cylindrical obstructions shown in black in fig 1 is used to create a pore network with an average pore diameter of 160m the height of the cylindrical pillars is 100 microns in kunz et al 2016 the micromodel is connected to two reservoirs on either side containing the wetting and non wetting phases the immiscible fluids used are fluorinert 43 fc 43 as the wetting phase  1800 kg m3  0 0047 pa s and water dyed with ink  1000 kg m3  0 001 pa s as the non wetting phase the surface tension between the two phases is 55mn m the micromodel is initially saturated with the wetting phase and drainage experiments are conducted by imposing an external pressure on the non wetting phase reservoir the viscosity ratio m of the invading fluid non wetting phase to the defending fluid wetting phase is 0 21 kunz et al 2016 conducted experiments of both dynamic and quasi static drainage in dynamic drainage a fixed external pressure is applied across the micromodel whereas in a quasi static drainage the displacement of the wetting phase is performed in multiple steps with relaxation time in between during which the phases are allowed the equilibrate in order to perform our numerical simulations as a first step the geometry of the micromodel is extracted from the published manuscript of kunz et al 2016 using image analysis the image extraction produces 2d curves which are then extruded for the specified cylinder height of 100 microns to construct the 3d model the 3d geometry of the micromodel is meshed using the helyxhexmesh utility in engys openfoam three uniform computational grids are generated with an average resolution of 10 5 and 2 5 microns resulting in mesh sizes of 46700 293390 and 2 05 million cells respectively in order to choose an appropriate grid size preliminary drainage simulations are conducted using the three aforementioned grid sizes fig s 1 and fig s 2 in the supplementary section show the results of the grid dependence study in fig s 1 for the three grid sizes considered the wetting phase saturation sw s 1a and the interfacial area of the wetting and non wetting fluids awn fig s 1b are plotted as function of flow time fig s 2 shows the non wetting phase water with ink depicted in blue penetrating the wetting phase fc 43 shown in red the mean difference in wetting phase saturation between the finest mesh 2 5 microns and the coarsest mesh 10 microns is 5 5 approx whereas the difference between the finest and the medium mesh 5 microns is 1 similarly the mean deviation between the finest and coarsest mesh in the interfacial area values is 9 while the difference between the finest and medium meshes is 8 7 based on these results and keeping in mind the availability of computational resources it was concluded that the medium mesh with an average mesh size of 5 microns provides results that fall within an acceptable degree of confidence following the grid dependence study dynamic and quasi static drainage are simulated in the micromodel shown in fig 1 using the medium mesh with an average cell resolution of 5 microns dynamic drainage experiment is a one step process in which a total pressure drop of 1 86kpa corresponding to experimental data is applied across the micromodel in the form of a pressure gradient between the inlet and the outlet in the simulation a no slip impermeable wall boundary condition is specified on the top and bottom plates and on the cylindrical obstacles the contact angle is fixed at a constant value of 45o on all the solid surfaces fig 2 shows the simulated flow paths in vof simulation on the left side along with the experimental solution on the right side from fig 2 it can be seen that the simulations are able to closely predict the flow pathways observed in experiments in each image the wetting phase saturation and the corresponding time stamp is presented despite good agreement between the simulated and observed flow paths there is significant deviation in the time scales this discrepancy may be related to the following factors that are not adequately represented in the simulation the first factor is the additional resistance in the experimental set up arising from the connections between the micromodel and the fluid reservoirs this connection is not included in the simulation set up the next source of discrepancy may arise from the modeling of the contact line physics in the simulation in the vof simulations a fixed static contact angle of 45o is imposed on the solid walls to account for the wettability whereas in reality the contact line physics will depend on the local capillary number an appropriate dynamic contact angle model may be required to account for this dependence the present simulations do not take into account contact angle hysteresis and dynamic contact angle effects in addition some roughness may be present on the walls of the micromodel from fabrication resulting in a pinning of the contact line and additional viscous losses in an experiment notwithstanding these deficiencies it is promising to note that the vof simulations are able to adequately capture the invasion pathways that are observed experimentally accurate representation of the displacement pattern is of key importance in the calculation of pore scale capillary pressure see section 3 in order to simulate the quasi static drainage process the micromodel is first fully saturated with the wetting phase fc 43 the non wetting phase is injected until the saturation of the wetting phase is reduced by 5 following which the injection velocity is set to zero and the system is allowed to reach equilibrium the saturation contours of the non wetting phase penetration are compared with the experimental results in fig 3 here again it is evident that pore filling in the simulation largely follows the experimental pathways with some minor differences from the validation results it is evident that the two phase simulations using the vof method are in reasonable agreement with published experimental results in the next section we utilize direct simulations to study the capillary pressure saturation relation at the pore scale and its implications 3 results in this section the two phase flow simulations with the vof method described in section 2 are used to investigate the capillary pressure saturation relation under equilibrium quasi static and non equilibrium dynamic conditions as stated earlier our goal is to provide insight into the behavior of pore scale capillary pressure from direct simulations of drainage from the direct simulations the pore scale capillary pressure acting at the fluid fluid interfaces is calculated directly from the pressure field in the computational domain without making any approximations this is referred to as the interface capillary pressure pinterface the interface capillary pressure that is computed at the invasion front depends only on the pore morphology shape and interfacial energy of the two fluids at the interface this interface capillary pressure is computed for different flow conditions and is compared to the macroscopic total pressure drop based on reservoir pressures that typically measured in experiments the total pressure drop across a porous medium is a combination of both the interface capillary pressure and the pressure head due to viscous effects viscous dissipation under dynamic conditions depending on the capillary number of the flow the viscous losses may dominate the total pressure drop calculation in this paper three pore geometries are considered fig 4 depicts a schematic of the geometric models considered in this article relative to their length scale and pore size variation thereby complexity in fig 4 three porous media are shown in increasing progression of pore size distribution a capillary tube a small micromodel and a porous medium both the micromodel and the porous medium are represented by a flow network of cylindrical obstructions as the first step drainage in a horizontal cylindrical capillary tube is studied as it is perhaps the simplest possible porous medium with only one known pore size the results of the capillary pressure calculations for the capillary tube are presented in section 3 1 next the micromodel used in our validation effort fig 1 is re utilized for the pore scale capillary pressure analysis since the micromodel has multiple pore bodies and pore throats as opposed to the single pore in the capillary tube the interface capillary pressure is an averaged parameter across the interfaces in the various pores of the micromodel once again the macroscale capillary pressure pc sw in eq 6 is computed and compared to the interface capillary pressure under different flow conditions see section 3 2 finally the capillary pressure calculations are performed on a virtual porous medium of a large size to ensure that the averaged values of measured parameters such as capillary pressure and saturation are independent of small scale variations the details of this case are presented in section 3 3 3 1 drainage in a capillary tube dynamic and quasi static drainage are simulated for different capillary numbers in a straight horizontal cylindrical capillary tube shown in fig 4 of length 10mm and radius 1mm in order to perform the drainage simulations the two fluids are fluorinert 43 fc 43 as the wetting phase  1800 kg m3  0 0047 pa s and water dyed with ink  1000 kg m3  0 001 pa s as the non wetting phase the viscosity ratio between these two fluids is m 0 21 the capillary tube is initially saturated with the wetting phase defending fluid which is then displaced by injecting the non wetting phase invading fluid the non wetting phase is injected with a constant velocity at the inlet of the tube corresponding to a fixed volume flow rate by fixing the flow rate we are able to maintain a constant capillary number ca which is defined as 16 c a  w v i n l e t  where the w denotes the wetting phase viscosity vinlet is the inlet injection velocity and  is the surface tension between the two fluids five capillary numbers are considered corresponding to flowrates q of 1 10 100 500 and 1000ml hr the chosen capillary numbers span four orders of magnitude from ca 7 6e 6 to 7 6e 3 at the inlet of the tube a constant velocity is specified along with a zero gradient condition on the pressure the inlet fluid fraction is set to f 0 corresponding to the non wetting phase at the outlet a zero gradient condition is applied to the velocity and the fluid fraction function f along with a constant zero pressure condition a fixed contact angle of 45o is used in all the simulations in the dynamic drainage simulation the flow rate is fixed and the computation is performed until the non wetting phase reaches the wetting phase reservoir at the outlet of the capillary tube at which point the simulation is stopped for quasi static drainage the non wetting phase injection is performed in steps for every 10 decrease in wetting phase saturation the injection velocity is set to zero and the fluids are allowed to equilibrate this process is repeated until the non wetting phase broke through to the wetting phase reservoir at the outlet fig s 3 depicts contours of a drainage simulation taken at the mid section plane in the capillary tube in the figure the non wetting phase water is colored in blue while the wetting phase fc 43 is shown in red the interface between the two fluids is visualized in white as a zero thickness flexible surface from the drainage simulation the interface capillary pressure is calculated as the pressure difference across the fluid fluid interface as shown in fig 5 in direct simulations the pressure field is available throughout the computational domain from the pressure field the capillary pressure can be directly calculated by taking the difference in pressure across the fluid fluid interface this eliminates the need to make any approximations such as estimating the curvature of the interface an issue frequently faced by experimentalists in order to calculate the pressure difference the first step is to identify the fluid fluid interface using the fluid fraction function f it may be recalled that f 0 indicates cells filled with the non wetting phase whereas f 1 denotes the volume occupied by wetting phase thus the interface can be identified as the region in which lies in between 0 and 1 0 f 1 for the purpose of the capillary pressure calculations an isosurface of values f 0 5 is chosen to indicate interface between the two immiscible fluids this called the primary interface next two secondary isosurfaces are created one upstream and another downstream of the f 0 5 primary interface the two secondary interfaces are needed to calculate the difference in fluid pressures across the primary interface and are chosen such that they are in close proximity to primary interface the upstream secondary interface is positioned in the non wetting phase at say values of f 0 01 so that it contains the pressure field of the non wetting phase similarly the downstream secondary interface is placed in the wetting phase at f 0 99 and thereby comprises of the wetting phase pressure field the wetting and non wetting phase pressures at the secondary interfaces are then mapped on to the primary interface on a node by node basis using the post processing visualization tool ansys ensight the number of nodes available on the primary and secondary interfaces correspond to the mesh resolution used in the simulation typically each pore is resolved using 10 20 mesh cells the vertices of these cells are called nodes which represent the point at which the value of each variable such as pressure is stored using the mapped wetting and non wetting phase pressures the pressure difference is computed at each node on the primary interface lastly the node based pressure differences on the primary interface are averaged using the local interfacial area of each node this is approximately the mesh cell area resulting in an average interfacial area weighted capillary pressure in other words this is the interface capillary pressure pinterface mathematically the interface capillary pressure is calculated according to the following equation 17  p interface i 1 n p i c a i i 1 n a i in eq 17 pc is the local interface capillary pressure which is the pressure difference between the fluids at each node on the primary interface and a is the interfacial area of a node i on the primary interface fig 6 a shows the total pressure drop across the capillary tube pio which is the pressure difference between the inlet and outlet of the capillary tube eq 7 plotted for different capillary numbers in a dynamic drainage simulation as noted by ferrari et al ferrari lunati 2013 for a flow with unfavorable viscosity ratio i e m 1 pio initially increases rapidly due to the effects of entry pressure but steadily decreases thereon owing to the low viscosity of the invading fluid which reduces the viscous dissipation of the system in fig 6a it can be observed that total pressure drop is higher for larger ca numbers owing to the increase in viscous forces fig 6b shows the interface capillary pressure pinterface as a function of different ca numbers recall that the interface pressure difference is calculated directly from the pressure field in the vicinity of the fluid fluid interface and is area weighted averaged using the local interfacial area as shown in eq 17 from fig 6b it is clear that pinterface fluctuates over a well defined average or equilibrium value but remains almost constant for all ca numbers the analytical value of the interface capillary pressure is 77pa from laplace s equation eq 3 it is seen that the interface capillary pressure from the simulation falls within 5 of the laplace pressure which is calculated under static conditions in fig 6b the interface capillary pressure is depicted on the same scale as the total pressure drop in fig 6a to highlight that the interface pressure doesn t vary significantly with the capillary number in contrast to the total pressure from fig 6b it can be seen that the interface capillary pressure is unaffected by the speed of flow it should be noted that fluctuations seen in the interface capillary pressure are numerical artifacts that are expected to decrease with an increase in the mesh resolution in contrast the macroscopic total pressure drop value has a tendency to increase with capillary number as the contribution from the pressure head caused by viscous effects increases as a function of the invasion speed an estimate of the viscous pressure head can be obtained from the hagen poiseuille pressure drop equation pviscous 8lq r4 for laminar flow in a cylindrical tube which dictates that the viscous pressure head is directly proportional to the average flow velocity for the highest ca number ca 7 6e 3 case considered pviscous is roughly 33pa as shown in eq 7 the difference between the total pressure drop and the interface capillary pressure corresponds to the viscous pressure head thus under static conditions when the fluids are not moving the viscous forces become zero and the total pressure drop will be equal to the interface capillary pressure next in order to understand the impact of static and dynamic conditions on the pressure calculations pio and pinterface are computed for quasi static drainage in the capillary tube in quasi static drainage an injection phase is followed by a relaxation phase in which the meniscus moves until it reaches an equilibrium fig 7 shows a plot of the total pressure drop from a quasi static drainage experiment compared to the dynamic and quasi static interface capillary pressures for the same capillary number ca 7 6e 4 in fig 7 note that the total pressure drop equals the interface capillary pressure in the relaxation stages of the quasi static drainage in the relaxation phases the total pressure drop equals the interface capillary pressure since the fluids are stationary resulting in zero viscous forces however in contrast to the total pressure drop the interface capillary pressure calculated from eq 17 is observed to be close to the equilibrium capillary pressure value under both dynamic and quasi static conditions in other words the interface capillary pressure remains close to the equilibrium capillary pressure under all flow conditions the total pressure drop depends strongly on the flow velocity or ca number and agrees with the interface capillary pressure only under equilibrium conditions in the next section we investigate the capillary pressure calculations for a micromodel with multiple pores here again the total pressure drop is computed and compared to the pore scale interface capillary pressure under different flow conditions 3 2 drainage in a micromodel the quasi two dimensional pdms micromodel used in the validation study is re utilized here to study the capillary pressure saturation relation under dynamic and quasi static conditions here again the two fluids used are fc 43 as the wetting phase and water dyed with ink as the non wetting phase with a viscosity ratio of m 0 21 from the original micromodel shown in fig 1 the inlet and outlet channels are removed and a frit is added near the entrance and exit of the micromodel in a drainage experiment the purpose of the frit consisting of 25 small equally spaced cylinders of diameter 30m and separated by a distance of 10m is to prevent the non wetting phase from reaching the wetting phase reservoir at the outlet the frit represents a semi permeable filter that is typically used in experiments to present the non wetting fluid from breaking through to the wetting fluid reservoir a top view of the modified micromodel is shown in fig s 4 with the cylindrical pore network depicted in black drainage is simulated for four capillary numbers ca 2 4e 5 1 2e 4 2 4e 4 and 2 4e 3 corresponding to volume flow rates of 0 1 0 5 1 and 10 ml hr respectively for all capillary numbers both the dynamic and quasi static flow conditions are considered as stated earlier in a dynamic drainage simulation the flow rate is fixed and the computation is performed until the non wetting phase reaches the wetting phase reservoir at the outlet of the micromodel under quasi static drainage conditions the non wetting phase injection is performed such that for every 10 decrease in wetting phase volume the injection velocity is set to zero and the fluids are allowed to equilibrate this process is repeated until the non wetting phase broke through to the wetting phase reservoir at the outlet a relatively uniform computational mesh of size 391 350 cells with an average resolution of 5 microns is utilized for all the simulations the third dimension orthogonal to the plane of the micromodel is discretized into twenty cells at the inlet of the micromodel a constant velocity based on the flow rate is specified along with a zero gradient condition on the pressure the inlet fluid fraction is set to f 0 corresponding to the non wetting phase at the outlet a zero gradient condition is applied to the velocity and the fluid fraction function f along with a constant zero pressure condition on all the solid surfaces a no slip impermeable wall boundary condition is specified along with a constant contact angle of 45o the frit near the inlet boundary is given a slip wall boundary condition such that it does not impact the incoming flow whereas the outlet frit which is used to contain the non wetting phase is given a no slip boundary condition with a contact angle of 0 degrees fully wetted for the quasi static drainage from preliminary simulations the relaxation time period is chosen to be three times the injection time in order to allow the system to reach equilibrium such that there is no significant change in saturation and fluid properties in each quasi static drainage simulation the specific interfacial area awn which is defined as the fluid fluid interfacial area between fc 43 and water divided by the volume of the micromodel is monitored such that during the relaxation phases the interfacial area reaches an equilibrium value before the next injection phase is started this confirms that the relaxation time used in the quasi static simulation is sufficient to ensure that the phases have reached an equilibrium configuration fig 8 depicts the contours of drainage at a flow rate of 1ml hr in the figure the top panel shows the non wetting phase pathways in a dynamic flow scenario whereas the bottom panel shows the quasi static flow at approximately the same saturation levels fig 9 shows a comparison of the dynamic and quasi static flow patterns for flow rates of 1ml hr and 10ml hr in fig 9 it can be seen that for the same flow rate or capillary number the displacement pattern can depend on the type of injection i e dynamic or quasi static in addition a change in capillary number will trigger variance in flow pathways resulting in different final states from the pressure field obtained in the dynamic and quasi static drainage simulations the interface capillary pressure is calculated using eq 17 following the steps described in section 3 1 the computed interface capillary pressure is compared to the total boundary pressure drop pio for all capillary numbers under dynamic and quasi static conditions fig 10 shows the total pressure drop across the micromodel pio which is the pressure difference between the inlet and outlet and the interface capillary pressure pinterface from eq 17 for different capillary numbers for dynamic drainage in fig 10a it can be observed that total pressure drop is highest for the largest capillary number flow of ca 2 3e 3 at a flow rate of 10ml hr as the capillary number is reduced the contribution of the viscous pressure head to the total pressure drop decreases an estimate of the viscous pressure losses due to the presence of the upper and lower plates of the micromodel can be obtained from the hagen poiseuille pressure drop equation pviscous 12lu h2 where h is the distance between the two plates gap height recall that the gap height for the micromodel under consideration is h 100m thus for the highest ca number ca 2 4e 3 case considered pviscous is 548pa approx it is evident from the hagen poiseuille equation that pviscous depends directly on the invasion velocity of the flow next in order to compare the viscous losses to the capillary forces in the micromodel we estimate the driving capillary force between the two horizontal parallel plates using the laplace s equation pc 2cos  h this capillary force is a result of the vertical curvature of the meniscus arising from the wall adhesion and the surface tension between the two fluids the capillary force arising from this vertical curvature is constant and can be calculated for the micromodel under consideration the fluid fluid interface makes a contact angle of 45o with the horizontal plates in the vertical direction resulting in a vertical capillary pressure of approximately pc 778pa thus for the largest flow rate case highest ca the viscous and capillary forces are of the same order of magnitude as the flow rate is reduced the viscous forces decrease in magnitude and effect whilst the capillary force remains constant in addition to the capillary pressure due to the vertical curvature there exists an in plane capillary pressure due to the interface curvature in the horizontal direction this capillary pressure is a variable that depends on the size of the pores between the obstacles in the porous medium the total capillary pressure acting in the porous medium can be estimated by calculating the mean curvature of the interface i e an average of the two principle radii of curvature in the horizontal and vertical directions the interface capillary pressure calculated in our simulations is a direct estimate of the total capillary pressure since it is computed in the three dimensional space fig 10b shows the interface capillary pressure pinterface as a function of different ca numbers from fig 10 b it can be observed that the pinterface remains bounded for all ca numbers and is not noticeably affected by the flow rate fig 11 depicts a comparison between the total pressure drop and the interface capillary pressure under static and dynamic conditions for a flow rate of 0 5ml hr ca 1 2e 4 fig 11a show the total pressure drop and the interface capillary pressure under dynamic flow conditions whereas in fig 11b the total pressure drop and the interface capillary pressure are compared under quasi static flow conditions in all the figures the fluctuations seen in capillary pressure values are due to the variability of the entry pressure necessary to invade pores of different sizes in fig 11 the difference between pio and pinterface can emanate from two causes the first is the viscous pressure head under dynamic conditions when the phases are constantly moving the viscous pressure losses are non zero however in a quasi static flow in the relaxation phases we expect the total pressure drop to equal the interface capillary pressure since the fluids are stationary resulting in zero viscous forces in fig 11b we see that this is not the case the total pressure drop deviates from the interface capillary pressure even in the relaxation stages this interesting difference is due to the effect of trapped wetting phase aka bubbles unlike a capillary tube in a porous medium with multiple pores the fluid phases may not always be connected at the pore scale the interfaces may snap off and result in trapped bubbles or blobs of the wetting phase that have high phase pressures the presence of these bubbles impact the pore scale capillary pressure calculations fig 12 illustrates a case of disconnected blobs that are trapped during drainage in the micromodel in the figure two scenarios are depicted on the left is a stable interface with connected fluid phases and on the right is a case of disconnected phases with a trapped wetting phase circled and highlighted in an ideal immiscible displacement scenario when the fluid phases are connected and are at equilibrium such as in the relaxation stages of a quasi static experiment the total boundary pressure drop will be equal to the interface capillary pressure however in reality flows in most heterogeneous porous media result in disconnected fluid phases with distribution of trapped blobs bubbles that have their own high capillary pressures in fig 12 the trapped wetting phase has a pressure similar to that of the surrounding non wetting phase and when its volume becomes comparable to the volume of the connected phases its effect on the capillary pressure measurement becomes significant in addition the reservoir pressure based total pressure drop does not account for the presence of these trapped bubbles even under equilibrium conditions ferrari lunati 2013 our interface pressure calculation based on eq 17 relies on the pressure differences across fluid interfaces at pore scale and explicitly includes the capillary pressure of all phases connected or otherwise and their local interfacial areas thus in fig 11b the difference between the total pressure drop and the interface capillary pressure in the equilibrium stages of a quasi static flow is due to the presence of the trapped wetting phase thus even under static conditions when the fluids are not moving and the viscous forces are zero the total pressure drop may not always be equal to the interface capillary pressure lastly it should be noted that a wetting phase blob that has lost its connection to the outlet completely may not be drained from the porous medium this may result in a non zero saturation at the end of the drainage step and is referred to as residual saturation from fig 11c it can be seen that for capillary numbers of ca 1 2e 4 the dynamic and quasi static interface capillary pressure curves are almost equivalent to one another this shows that the interface capillary pressure relation is a unique parameter that is independent of flow conditions dynamic and quasi static as long as the flow pathways invasion patterns remain the same if the non wetting phase invasion varies under dynamic and quasi static conditions the interface capillary pressure is no longer invariant this is demonstrated in the results for cases of flow rate 1ml hr and 10ml hr ca 2 3e 4 and 2 3e 3 respectively the snapshots of dynamic and quasi static drainage for these flow rates are compared in fig 9 from fig 9 it can be seen that the non wetting phase invasion patterns are not identical in the dynamic and quasi static conditions thus different interface capillary pressure curves are obtained for the dynamic and quasi static drainage for flow rates of 1ml hr and 10ml hr the total pressure drop and interface capillary pressure curves for the 1ml hr case is presented in fig 13 in conclusion the results from our micromodel simulations show that the interface capillary pressure saturation relation remains bounded for all ca numbers and is not noticeably affected by the flow rate or capillary number contrastingly the total pressure drop heavily depends on the flow rate or capillary number as it implicitly includes the viscous losses in the domain this dependence on the viscous losses can skew capillary pressure measurements and result in a mischaracterization the capillary forces in the system next in a micromodel as opposed to the immiscible displacement in a capillary tube the fluid phases are not always connected to the reservoirs and disconnected interfaces are obtained finally the results show that the interface capillary pressure is invariant of transient flow conditions i e dynamic and quasi static as long as the invasion patterns are identical however we demonstrate that the displacement patterns can vary as a function of the flow conditions and this will in turn impact the capillary pressure saturation relation 3 3 drainage in a porous medium in this section the pc sw relation is studied using a large micromodel at the representative elementary volume rev scale such that average properties can be calculated from the simulations without being influenced by small scale variations for this purpose a horizontal elongated quasi two dimensional micromodel shown in the top right corner of fig 4 an enhanced view is depicted in fig s 5 is chosen as the representative porous medium this is a hele shaw cell of two fixed parallel plates with a random distribution of cylindrical obstructions in between the pore network is three dimensional but with a small thickness in the vertical direction thus gravity has no influence on the displacement in recent years such an artificial microfluidic device made of a transparent plate material have been used by numerous researchers to study the displacement of immiscible fluids chen et al 2007 godinez brizuela et al 2017 hu et al 2017 karadimitriou hassanizadeh 2012 karadimitriou et al 2014 liu nolte nolte 2011 mehmani tchelepi 2017 oostrom et al 2016 pyrak nolte et al 2008 wang xiong liu peng 2018 in order to avoid confusion with the micromodel used in the previous section section 3 2 the pore geometry used in this section is referred to as a porous medium the porous medium used in our simulations is a pdms micromodel of size 50 10 0 04 mm3 with a three dimensional pore network of 12132 cylindrical obstacles the mean obstacle size is 130m and the minimum and maximum obstacle diameters are 58m and 242m with a standard deviation of 62 5m the depth is constant everywhere and is measured to be 40m the porous medium has roughly 8 revs in the x direction and almost 2 revs in the y direction details of the rev calculation are presented in appendix a representative elementary volume rev an autocad drawing dwg format of the pore network is used to generate the triangulated stereolithography stl files required for openfoam meshing meshing is performed by imposing a uniform cartesian grid and removing regions intersecting the solid phase using the helyxhexmesh utility in engys openfoam this results in a body fitted mesh with hexahedral and split hexahedral cells on the stl geometries an example of the mesh around the obstacles is shown in fig s 6 based on grid dependence tests not shown here a mesh with an average cell size of 20 microns in the horizontal plane total mesh size 3 2 mil cells is utilized in all the following drainage simulations to investigate the pore scale capillary pressure saturation relation at the inlet and outlet of the porous medium a frit is included which acts as a semi permeable filter that prevents the non wetting fluid from reaching the wetting phase reservoir the frit consists of 250 small cylinders d 30m spaced by 10m the flow in the thickness direction is resolved using a cell size of 10microns the same vertical resolution was used in a recent publication sby hu et al hu et al 2017 who pursued computational fluid dynamics cfd simulations with openfoam primary drainage is simulated for five capillary numbers ca 1 2e 5 2 3e 5 5 8e 4 1 2e 4 and 2 3e 4 corresponding to flow rates of 0 5 1 2 5 5 and 10ml hr respectively at low flow rates capillary forces dominate the displacement structure whereas at the higher capillary numbers the invasion is viscosity dominated in order to perform the drainage simulations the wetting and non wetting phases chosen are water dyed with ink  1000 kg m3  0 001 pa s and poly dimethly siloxane pdms oil  913 kg m3  0 0045 pa s respectively the viscosity and density ratios during the drainage process are m 4 5 and h 0 913 respectively accordingly the non wetting phase pdms oil is 4 5 times more viscous and 1 1 times lighter than the wetting phase water the choice of these fluids is driven by occurrence in published literature godinez brizuela et al 2017 initially the porous medium is saturated with water which is then displaced by the pdms oil during drainage in the simulations the flow rate is specified at the inlet boundary thereby keeping the global capillary number a constant a static constant angle of 30 degrees is imposed on all the solid surfaces to account for wall adhesion and the surface tension between the two fluids is 30mn m from the drainage simulations the average up scaled interface capillary pressure pinterface is computed across the various pores and compared to the total pressure drop across the porous medium pio recall that the total pressure drop across the porous medium is the pressure difference between the non wetting and wetting phase reservoirs at the inlet and outlet boundaries of the porous medium respectively fig 14 shows the total pressure drop across the porous medium pio plotted for different capillary numbers for dynamic drainage for flows with a favorable viscosity ratio i e m 1 pio increases with the saturation of the non wetting fluid owing to the higher viscosity of the invading phase also the total pressure drop is higher for larger ca numbers as the viscous forces are higher in magnitude and decreases as the capillary number or the flow rate is lowered a similar behavior has been observed in published literature in drainage experiments with 2d cylindrical obstacles ferrari lunati 2013 and glass bead monolayers lovoll et al 2011 next using the pressure field at the fluid fluid interfaces from the simulations the pore scale interface capillary pressure pinterface is computed pinterface is a measure of the capillary forces acting at the invasion front and is computed from the pore scale pressure differences across the multiple menisci in the porous medium fig 15 shows the interface capillary pressure pinterface as a function of different ca numbers in fig 15 the same scale is used on the ordinate as fig 14 in order to compare the interface capillary pressure with the total pressure drop plotted in fig 14 in contrast to the total pressure drop it is clear that pinterface remains closely bounded for all ca numbers this observation is consistent with the results of the micromodel presented in section 3 2 the inset in fig 15 presents a zoomed in view of the interface capillary pressure curves shown in fig 15 from the inset it is evident that the pinterface values for highest flow rate of 10ml hr ca 2 3e 4 are higher than those of the other four lower capillary numbers the capillary pressure values for lower capillary numbers do not vary significantly from each other this behavior is explained by the understanding the different mechanisms that drive interface propagation at high and low capillary numbers during drainage fig 16 shows the fluid distribution for the highest flow rate case of 10ml hr and a lower flow rate case of 1ml hr at a wetting phase saturation of approximately 33 i e sw 0 33 in fig 16 the first image shows the snapshot of drainage at the highest flow rate of 10ml hr corresponding to ca 2 3e 4 at a high capillary number the viscous forces are dominant and the viscosity ratio dictates the front morphology for the chosen fluid pair the viscosity ratio m is greater than 1 whereby the invading fluid is more viscous than the defending fluid and the front is stable this stable front is clearly visible in the first image in fig 16 at a lower capillary number the viscous forces are weak with respect to capillary forces weakening of the viscous forces reduces the dependence on the viscosity ratio and leads to a less stable regime even for m 1 thus for lower capillary numbers the viscous pressure drop is negligible with respect to capillary pressure and the pore size variability dominates the interface behavior which results in an increased front roughness ferrari lunati 2013 at a lower capillary number the drainage front is controlled by capillary forces and displays a typical pattern that can be described by invasion percolation the second image in fig 16 shows the invasion front for a lower capillary number of ca 2 3e 5 flow rate 1ml hr from fig 16 it can be seen that for the highest capillary number case ca 2 3e 4 only a very small volume of the wetting fluid water blue is left behind the compact front in contrast for the lower capillary number case ca 2 3e 5 a larger amount of defending wetting fluid remains trapped in form of disconnected clusters recall that the interface capillary pressure calculations take into account the local capillary pressures of the trapped wetting phase clusters and their interfacial areas this results in higher interface capillary pressure values for the case of flow rate 10ml hr ca 2 3e 4 that has a stable front and lower capillary pressure values for the lower flow rate cases where disconnected clusters are dominant fig 17 shows a comparison of the total pressure drop across the porous medium pio with the interface capillary pressure pinterface computed at the fluid fluid interfaces at the pore scale for the lowest capillary number considered ca 1 2e 5 flow rate 0 5ml hr even for the lowest flow rate considered it is evident that the total pressure drop is dominated by the viscous effects which in turn are a function of the system size and invasion speed lovoll et al 2011 in contrast the pore scale interface capillary pressure does not account for the viscous losses and thereby truly characterizes the capillary forces in the porous medium lastly we present a comparison of the viscous and capillary forces in the porous medium the macroscopic total pressure drop has a tendency to increase with capillary number since the contribution from the pressure head caused by viscous effects increases as a function of the invasion speed an estimate of the viscous pressure head from the presence of top and bottom plates can be obtained from the hagen poiseuille pressure drop equation pviscous 12lu h2 in this equation  is the non wetting phase viscosity for drainage u is invasion speed l is the length of the model and h is the gap height or the distance between the two plates h 40m assuming l to be the total length of the porous medium i e the non wetting has completely forced out the wetting phase we can easily obtain an estimate of viscous pressure losses another estimate of the viscous pressure head can be obtained from darcy s law p ql ka where q is the flow rate k is permeability of the medium and a is the inlet cross sectional area we calculated the absolute permeability of the medium k to be 4 95e 11m2 from single phase flow calculations not included here from table 1 we can see that viscous losses estimated using darcy s law is always higher that the estimate from the hagen poiseuille hp law this is because the hp equation represents only the pressure drop from the presence of the two parallel plates whereas darcy s law includes the effect of the cylindrical obstacles by taking into account the permeability of the medium note that in both the viscous pressure losses estimates the presence of the wetting phase has been ignored next an estimate of the capillary force is obtained using the laplace s equation pc 2cos  r which relates the capillary pressure to the surface tension between the two fluids the contact angle and the radius of curvature of the interface the driving capillary force arises from two sources the first is the presence of the two flat horizontal plates here the capillary pressure is a consequence of the curvature of the interface in the vertical thickness direction the capillary force arising from this vertical curvature is constant and can be calculated by assuming radius of curvature in laplace s equation to be equal to the gap height of 40m this vertical capillary pressure is approximately pc 1299pa the next source of capillary driving force is the in plane curvature of the interfaces in the horizontal direction this capillary pressure is a variable that depends on the size of the pores between the obstacles in the porous medium an estimate of the horizontal capillary pressure is obtained using the mean cylinder diameter of 130m in laplace s equation the resulting average horizontal capillary pressure is 399pa the last column in table 1 shows the ratio of the viscous darcy pressure drop and vertical capillary forces for all capillary numbers or flow rates it is evident that the viscous pressure losses are an order of magnitude higher than the driving capillary pressure for the flow rates of 5ml hr and 10ml hr as the flow rate is reduced the viscous forces decrease in magnitude however unless the flow rate is sufficiently low the viscous losses may not be negligible as they depend on both the system size and the invasion velocity i e both parameters need to be small for the viscous effects to be truly negligible for the case of the lowest flow rate considered 0 5ml hr the viscous and capillary forces are of the same order of magnitude finally it should be noted that total capillary pressure acting in the porous medium can be estimated using the mean curvature of the interface which is an average of the two principle radii of curvature in the horizontal and vertical directions the pore scale interface capillary pressure calculated from our simulations using eq 17 is an direct estimate of the total capillary pressure acting at the invasion front since it is computed in the three dimensional plane 4 summary and conclusions in this study we use direct numerical simulations with the volume of fluid vof method to explicitly measure the pore scale capillary pressure in a porous medium and compare the pore scale capillary pressure to the macroscale capillary pressure pc sw under equilibrium quasi static and non equilibrium dynamic conditions the pore scale capillary pressure is the pressure difference at the interface between two fluids as the fluids move through the pores of a porous medium the main objective of this study is to understand how well a conventional macroscale capillary pressure measurement that is typically based on the pressure drop across a porous medium represents the pore scale capillary pressure under different flow conditions in order to understand the link between the pore scale and macroscale capillary pressure we chose drainage in a porous medium as the representative immiscible displacement flow process direct simulations of dynamic and quasi static drainage are conducted in three geometries capillary tube micromodel and a porous medium by solving the 3d navier stokes equations in the pore space using the cfd code openfoam the vof method is utilized to track the evolution of the fluid fluid interfaces and takes into account fluid adhesion at the solid walls and the effects of surface tension as a first step dynamic and quasi static drainage are simulated for different capillary numbers in a horizontal cylindrical capillary tube following this drainage is studied in a micromodel and a porous medium both having multiple pores of different sizes from these microscale simulations the total pressure drop across the domain and the interface capillary pressure at the fluid fluid interfaces are calculated for all flow rates or capillary numbers for a simple capillary tube the pore scale capillary pressure is the pressure difference across the fluid fluid interface whereas for a porous medium with multiple pores a representative pore scale capillary pressure is calculated by averaging the pressure differences across all the menisci resulting in an average interface capillary pressure pinterface the interface capillary pressure pinterface is compared to the macroscale capillary pressure corresponding to the total pressure drop pio across the porous medium that is typically measured in experiments using pressure transducers under equilibrium and non equilibrium conditions the results from the capillary tube simulations show that the conventionally measured macroscopic total pressure drop strongly depends on the flow rate or capillary number the total pressure drop increases with capillary number as the contribution from the pressure head caused by viscous effects increases with the invasion speed thus larger the flow rate or capillary number the higher is the total pressure drop in contrast the interface capillary pressure is almost invariant of capillary number and flow conditions equilibrium and non equilibrium it remains close to the equilibrium curvature based capillary pressure value for a tube laplace pressure under all flow conditions next our micromodel simulations predicted that the interface capillary pressure saturation relation remains bounded for all capillary numbers i e the interface capillary pressure is not noticeably affected by changing the capillary number in comparison to immiscible displacement in a capillary tube during drainage in a micromodel the fluid phases are not always connected to the reservoirs and disconnected interfaces can be obtained the interface capillary pressure accounts for the pressures of disconnected fluid phases such as trapped blobs having high phase pressures which is not reflected in the total pressure drop pio even at equilibrium additionally in a micromodel different displacement patterns can result depending on the capillary number and transient flow conditions dynamic and quasi static and this will in turn impact the capillary pressure saturation relation we show that the interface capillary pressure saturation is invariant of transient flow conditions but only as long as the invasion patterns are identical here again the total pressure drop heavily depends on the viscous losses in the domain which can greatly skew laboratory measurements as a last step dynamic drainage is simulated in a large porous medium rev scale for five capillary numbers spanning three orders of magnitude from the drainage simulations the average interface capillary pressure pinterface is computed and compared to the total pressure drop across the porous medium pio even for the lowest capillary number considered ca 1 2e 5 the total pressure drop is dominated by the viscous pressure head owing to the large size of the domain this demonstrates that the viscous pressure losses are not only a function of the invasion speed but can be a significant factor in large domains thus the total pressure drop varies significantly with a change in capillary number increasing as a function of the injection velocity in contrast the interface capillary pressure saturation relation did not exhibit a direct dependence on the capillary number traditionally the pc sw relationship is measured under equilibrium conditions from quasi static flow experiments and is used as a constitutive relation in darcy scale simulators to model dynamic non equilibrium porous media flows this approach is only valid if the pc sw relation is independent of the flow conditions joekar niasar hassanizadeh 2012 in literature theoretical and pore network modeling studies have always regarded that the non equilibrium capillary pressure saturation curves are not unique and depend on capillary number hassanizadeh et al 2002 joekar niasar hassanizadeh 2012 in this study using high resolution direct numerical simulations dns a pore scale interface capillary pressure saturation relation is calculated as a direct measure of the capillary forces at a fluid fluid invasion front this pore scale interface capillary pressure depends only on the pore morphology shape and interfacial energy of the two fluids at an interface and ignores the viscous dissipation such a calculation is made possible by the readily available pressure field throughout the computational domain in a dns which eliminates the need to make any approximations in estimating the curvature of an interface a challenge faced by experimentalists we show that the interface capillary pressure saturation relation is almost invariant of flow conditions dynamic and quasi static for a given flow process drainage if the fluid fluid interface pressure differences are measured at the pore scale and averaged appropriately that is the interface capillary pressure saturation relation will not depend upon the flow conditions dynamic and quasi static as long as the invasion patterns are identical however immiscible displacement patterns in a porous medium can vary depending on not only the capillary number but also the flow conditions dynamic and quasi static if the dynamic and quasi static flows yield different invasion patterns this will in turn impact the interface capillary pressure saturation relationship because the fluids invade a different set of pores this is an important insight and questions the traditional practice of using quasi static equilibrium based macroscopic pc sw curves for dynamic simulations also in stark contrast to the traditionally measured macroscale capillary pressure saturation relation the interface capillary pressure relation does not exhibit a direct dependence on the capillary number and the flow conditions this may eliminate the need for separate capillary pressure saturation curves under non equilibrium and equilibrium conditions finally it is important to note that the interface capillary pressure saturation relation can be computed from a numerical simulation instead of experiments and utilized directly in existing macroscale continuum based solvers while the porous media considered in this study are quasi two dimensional and may not have all the complexities found in a real porous medium we expect the fundamental learnings from this study to extend to real porous media as well credit authorship contribution statement santosh konangi conceptualization methodology investigation data curation writing original draft nikhil k palakurthi conceptualization methodology writing review editing nikolaos k karadimitriou conceptualization writing review editing ken comer conceptualization supervision writing review editing urmila ghia supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments nikolaos karadimitriou was funded by deutsche forschungsgemeinschaft dfg german research foundation under germany s excellence strategy exc 2075 390740016 nikolaos karadimitriou would also like to thank the deutsche forschungsgemeinschaft dfg german research foundation for supporting his work by funding sfb 1313 project number 327154368 the authors would like to thank the anonymous reviewers for their insightful questions and feedback which have helped improve this manuscript supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103792 appendix b supplementary materials image application 1 image application 2 appendix a representative elementary volume rev in order to determine if the domain is a representative elementary volume rev starting from the center of the domain the porosity of square lattices is computed by increasing the length of the lattice by a factor of 1 5 each time fig a 1 shows the variation of porosity as a function of lattice size volume next the permeability is calculated for three lattices of size 5mm x 5mm 10mm x 10mm and 50mm x 10mm the variation of permeability between the three lattices is less than 1 indicating that a lattice of size 5mm x 5mm may represent an rev based on both the porosity and permeability calculations it is determined that a lattice of dimensions 6mm x 6mm approx will be a rev thus the porous medium has about 8 revs in the x direction and almost 2 revs in the y direction any average properties calculated from this domain will apply to the darcy scale lastly based on the permeability k 4 95e 11m2 this porous medium corresponds to a highly fractured rock 
356,conventional macroscale two phase flow equations for porous media such as darcy s law and richards equation require a constitutive relation for capillary pressure pc the capillary pressure relation significantly impacts the behavior and prediction of fluid flow in porous media and needs to accurately characterize the capillary forces in a typical laboratory experiment a functional macroscopic capillary pressure saturation pc sw relationship is measured as the difference between the pressures of the non wetting phase reservoir at the inlet pnw and wetting phase reservoir at the outlet pw of a porous medium it is well known that this traditional macroscopic capillary pressure definition is valid only at equilibrium conditions and if the phases are connected under non equilibrium dynamic conditions when the fluids are moving the macroscopic capillary pressure measured in experiments implicitly includes the pressure head caused by viscous effects the goal of the present effort is to understand how well the traditional macroscopic capillary pressure definition represents the pore scale capillary forces under different flow conditions using direct numerical simulations dns of two phase flow in a porous medium we evaluate the capillary pressure at the pore scale and compare it to the macroscopic capillary pressure pc sw that is typically measured in experiments using pressure transducers the pore scale capillary pressure is the pressure difference across the interface between two fluids as the fluids move through a porous medium the interface pressure differences at fluid fluid invasion front are averaged across all the pores of the porous medium to yield a representative pore scale capillary pressure curve referred to as the interface capillary pressure the pore scale interface capillary pressure represents the true capillary forces in the system since depends only on the pore morphology shape and interfacial energy of the two fluids and does not account for the viscous dissipation in experiments it is difficult to measure the interface capillary pressure jump without accounting for the viscous pressure head which is at least an order of magnitude larger upscaling the pore scale capillary pressure is an essential step for complete characterization of capillary dominant two phase flow in a porous medium at the laboratory scale drainage is simulated under equilibrium quasi static and non equilibrium dynamic conditions for various capillary numbers the navier stokes ns equations are solved in the pore space using the open source finite volume computational fluid dynamics cfd code openfoam the volume of fluid vof method is employed to track the evolution of the fluid fluid interfaces and a contact angle is used to account for the effect of wall adhesion the simulations are first validated with published experimental data for dynamic and quasi static drainage in a micromodel from the microscale simulations the interface capillary pressure is determined and compared to the macroscopic capillary pressure under equilibrium and non equilibrium conditions our results show the traditionally measured macroscopic capillary pressure curves exhibit a strong dependence on the capillary number under dynamic flow conditions in contrast the interface capillary pressure saturation relation which relies on pore scale pressure differences at the invasion front is almost invariant of flow conditions dynamic and quasi static keywords capillary flow dynamic capillary pressure young laplace equation drainage volume of fluid vof method 1 introduction understanding the physics of immiscible two phase flow in porous media is imperative for a number of applications such as oil and gas recovery ground water redistribution carbon dioxide sequestration and drug delivery to name a few mcclure et al 2018 porous media flows are an inherently multiscale problem in which complex physical phenomena drive the fluid flow at the pore scale whereas the processes of applied interest occur at the macroscale system or continuum scale the challenge is to understand what drives the flow at the smallest scales pore scale and find a way to up scale this information in a manner that it can be used for successful product design and development at the macroscale or continuum scale since it is computationally infeasible to explicitly predict the flow in each and every pore in a porous medium up scaled equations based on averaged properties that are defined over a representative elementary volume rev are needed to predict the flow at the macroscale m th van genuchten 1980 conventional macroscale two phase flow equations for porous media darcy s law and richards equation require three empirical constitutive relations that are nonlinear functions of saturation two relative permeability saturation kr relations for each fluid phase and one capillary pressure saturation pc relation these constitutive relations represent the point at which physical measurements are incorporated into mathematical and numerical models reeves celia 1996 capillary pressure pc is inherently a pore scale phenomenon and is defined as the difference in pressure across a curved interface separating two immiscible fluids at equilibrium armstrong porter wildenschild 2012 bear 1972 and is expressed as 1 p c p nw p w in eq 1 pnw is the non wetting phase pressure and pw is the wetting phase pressure pc is attributed to the normal component of interfacial forces due to the surface tension at the interfacial boundaries if we consider a small segment of a curved interface between two fluids and balance the pressure and interfacial tension at static equilibrium then we arrive at the young laplace which is written as 2 p c p nw p w  k where  is the interfacial tension and k is the mean curvature of the interface for a simple capillary tube with a known mean curvature k eq 2 can be re written as the well known laplace s equation 3 p c 2  cos  r where  is the contact angle measured as the angle between the fluid fluid interface and the solid surface and r is the radius of the capillary tube a phase is considered as wetting when the contact angle is acute i e  90o and as non wetting for an obtuse contact angle  90o the contact angle is an important parameter that is used to quantify wettability which dictates the movement of fluids in sub surface flows such as oil and gas recovery and carbon sequestration verma icardi prodanovi 2018 in a porous medium the situation is more complex due to the intricate geometry of the solid matrix and the morphology of the fluid fluid interfaces ferrari lunati 2013 this problem is overcome by using macroscopic also known as continuum or darcy scale models which ignore the fine details by averaging over a large number of pores traditionally capillary pressure is defined at the macroscale using the empirical relationship 4 p c s w p nw p w where pnw is the average non wetting phase pressure pw is the average wetting phase pressure and pc is the average macroscopic capillary pressure typically measured as a function of wetting phase saturation sw here the wetting phase saturation sw is defined at the macroscale as the ratio of the average wetting phase volume to the total open volume of the porous medium and is written as 5 s w 1 v v  dv where  is the volume fraction of a phase and v is the pore volume from eq 5 it follows that the saturation of the non wetting phase is snw 1 sw it is obvious that the traditional pc sw relationship in eq 4 is analogous to its universal counterpart in eq 1 and provides a simple relationship between the phase pressures and the saturation starnoni pokrajac 2019 the traditional empirical pc sw relationship is based on the assumption that pc is a function of saturation only other pore scale properties such as interfacial configuration interfacial curvature pore morphology etc are ignored due to experimental limitations armstrong et al 2012 it is often assumed that all pore scale properties are lumped into the saturation sw thereby overlooking their individual effects in conventional porous media flow theory the difference in the average phase pressures is presumed to be equal to the capillary pressure under all conditions and at all times joekar niasar majid hassanizadeh 2011 in laboratory experiments the pressure is conveniently available at the reservoirs containing the non wetting and the wetting fluids outside the porous medium the reservoir pressures can be measured using pressure transducers while the wetting phase saturation is measured inside the porous medium majid hassanizadeh gray 1993 consequently the average macroscopic capillary pressure in eq 4 is calculated as the difference between the pressures of the non wetting phase reservoir at the inlet pinlet or pnw and wetting phase reservoir at the outlet poutlet or pw of a porous medium thus eq 4 can be re written as 6  p io p inlet p outlet p c s w where pio represents the total pressure drop across the porous medium between the inlet and outlet reservoirs it is customary to assume that the macroscopic capillary pressure pc sw in eq 6 based on the total pressure drop is equal to the pore scale capillary pressure at the fluid fluid invasion front laplace s pressure due to the curvature of the menisci defined in eq 2 under all conditions many recent theoretical and experimental studies have stated that the macroscopic capillary pressure can agree with the true pore scale static capillary pressure jump due to the curvature at the menisci only when the pressure is constant within each phase camps roach o carroll newson sakaki illangasekare 2010 hassanizadeh celia dahle 2002 in other words the macroscopic pressure definition in eq 6 is valid only at equilibrium i e when the fluid phases are not moving dahle celia majid hassanizadeh 2005 karadimitriou hassanizadeh joekar niasar kleingeld 2014 and only if the phases are connected ferrari lunati 2013 when the fluids are moving the fluid pressures within the pores vary with time and space thus the capillary pressures at different interfaces will be different from each other and will not be equal to the difference in boundary reservoir pressures karadimitriou et al 2014 this is known as non equilibrium or dynamic transient flow conditions the term dynamic or non equilibrium covers a broad spectrum of porous media flows which includes but is not limited to cases where the flow rate is high or when the permeability of the medium is low li et al 2020 an important facet of non equilibrium or dynamic flows is the absence of interfacial relaxation towards equilibrium saturation meisenheimer mcclure rivers wildenschild 2020 non equilibrium dynamics in multiphase flows can lead to different production behaviors in a reservoir as compared to equilibrium flows li et al 2020 along with differences in interfacial shapes contact angles fluid saturation distribution etc in a dynamic or transient flow scenario a macroscopic capillary pressure definition based on the averaged reservoir phase pressures or the total pressure drop implicitly includes the contribution from the pore scale capillary pressure at the fluid fluid invasion front and the pressure head caused by viscous effects lovoll et al 2011 washburn 1921 resulting in 7  p io  p interface p viscous in eq 7 pinterface represents the pore scale capillary pressure at the invasion front and pviscous is the pressure head loss caused by the viscous effects viscous dissipation this principle was incorporated into the macroscopic capillary pressure theory in the form of an extended capillary pressure saturation relationship that included an additional term to account for dynamic effects hassanizadeh et al 2002 manthey hassanizadeh helmig hilfer 2008 this is referred to as the non equilibrium capillarity effect the dynamic effects on capillary pressure result in a dependence on the rate at which the phase saturations change in response to changes in phase pressures camps roach et al 2010 industrial and environmental porous media flows typically occur under non equilibrium or dynamic conditions when the fluids are constantly moving since eq 6 is only valid at equilibrium it is typical to measure the macroscopic capillary pressure saturation relationship pc sw for a given porous medium under quasi equilibrium conditions aka quasi static conditions in a quasi static experiment an injection phase is followed by a relaxation phase when the fluids allowed to equilibrate the pressure is then measured at the fluid reservoirs in the equilibrium phase and the difference is treated as the macroscale capillary pressure the relaxation and rearrangement of interfaces from dynamic to static conditions and the time required for equilibration are prerequisite to warrant the equilibrium assumption armstrong et al 2012 the measurement of macroscale quasi static pc sw curve requires hours or even days for each porous sample bear 1972 the measured quasi static pc sw data is supplied as a constitutive relation to a macroscale continuum based models such as darcy s law to study complex dynamic flow processes which occur in time scales of the order of seconds to minutes dahle et al 2005 under dynamic flow conditions the total pressure drop implicitly includes the effect of viscous pressure head second term in eq 7 which in turn depends strongly on the invasion velocity of the flow and the system size in contrast to the viscous pressure losses the pore scale capillary pressure at the fluid fluid interface first term in eq 7 remains almost constant it only depends on the interfacial energy and the geometry topology of the pore lovoll et al 2011 the pore scale interface capillary pressure represents the true capillary forces in the porous medium and should be up scaled or averaged using an appropriate definition to obtain the macroscopic pc sw relation for a porous medium in experiments it is difficult to measure the interface capillary pressure jump without accounting for the viscous pressure head which is at least an order of magnitude larger this difficulty can be circumvented in direct numerical simulations dns in which the conservation equations are solved explicitly in the pore space without making assumptions thereby permitting us to carefully investigate pore scale processes and their impact on macroscale processes ferrari lunati 2013 using direct simulations of microscale capillary flows it is possible to distinguish the interface capillary forces from the viscous forces upscaling the interface capillary pressure is an essential step for complete characterization of capillary dominant two phase flow in a porous medium at the darcy scale in literature few studies have attempted to estimate the pore scale interface capillary pressure under static conditions nolte and co researchers chen pyrak nolte griffin giordano 2007 cheng pyrak nolte nolte giordano 2004 pyrak nolte nolte chen giordano 2008 used image analysis to calculate the interfacial length and thereby the mean curvature in two dimensional 2d transparent micromodels the curvature is then used in young laplace equation to calculate the capillary pressure armstrong et al 2012 and herring middleton walsh kingston sheppard 2017 used a novel curvature measurement algorithm to determine microscopic image based capillary pressure saturation curves from computed x ray micro tomography cmt experiments of quasi static drainage and imbibition experiments in a 3d porous medium and compared this to macroscopic transducer based capillary pressure measurements under transient conditions to the authors knowledge the only experimental attempts to determine the interface capillary pressure is the work of karadimitriou et al godinez brizuela karadimitriou joekar niasar shore oostrom 2017 karadimitriou et al 2014 who used image analysis to determine the interface capillary pressure in their experiments they measured the planar contact angle which is then used to calculate the local pore scale capillary pressure lastly using direct numerical simulations with the volume of fluid vof method ferrari et al ferrari lunati 2013 and recently starnoni et al starnoni pokrajac 2019 investigated different definitions of macroscopic capillary pressure ferrari et al concluded that a definition based on total interfacial helmholtz energy allows for better separation of the viscous forces starnoni et al derived a novel macroscopic capillary pressure definition based on sub surface pressure averages and showed that it corresponds well to a definition based on interface curvature in this study we use direct simulations with the vof method to explicitly measure the pore scale capillary pressure in a porous medium and compare the pore scale capillary pressure to the macroscopic capillary pressure pc sw under equilibrium quasi static and non equilibrium dynamic conditions the pore scale capillary pressure is the pressure difference at the interface between two fluids as the fluids move through the porous medium for a system with a single pore such as a capillary tube a pore scale capillary pressure value is computed by averaging the fluid pressure differences at the interface between the two fluids in the tube by extension for a porous sample with multiple pores a representative pore scale interface capillary pressure value is calculated by averaging the pressure differences across all the menisci between the wetting and non wetting fluids this pore scale average pressure difference is referred to as the interface capillary pressure pinterface the goal is to understand the link between the macroscopic capillary pressure pc sw and the pore scale interface capillary pressure pinterface direct numerical simulations of microscale two phase flows in a porous medium are conducted from these simulations the pore scale interface capillary pressure acting at the fluid fluid interfaces is computed under dynamic and quasi static flow conditions the interface capillary pressure pinterface is compared to the macroscale capillary pressure corresponding to the total pressure drop pio in eq 6 that is typically measured in experiments using pressure transducers this approach allows for a direct comparison between an intrinsic interfacial property computed at the pore scale to a macroscale averaged property this comparison is crucial to understand how well the conventional macroscale capillary pressure definition represents the pore scale interfacial properties under different flow conditions that may include unstable interfaces in order to study the interface capillary pressure drainage or desaturation is chosen as the preferred displacement process in drainage a porous medium is assumed to be saturated with a wetting phase which acts as the defending fluid and is displaced by the invading phase or the non wetting fluid direct two phase flow simulations are performed by solving the navier stokes ns equations in the pore space using the open source finite volume computational fluid dynamics cfd code openfoam open field operation and manipulation greenshields 2015 the volume of fluid vof method is employed to track the evolution of the fluid fluid interfaces and a contact angle is used to account for the effect of wall adhesion direct simulations with the vof method allow for high resolution description of the geometry and time evolution of interfaces thereby permitting us to investigate the pc sw relationship as a first step to validate our calculations the simulation results are compared to available experimental data drainage under an applied pressure drop corresponding to experimental conditions is simulated in a micromodel and the simulation results are compared to experimental results published in kunz et al 2016 on establishing the physics modeling capability the next step is to use the two phase flow solver to understand the interface capillary pressure to accomplish this as a first step we study a cylindrical capillary tube which is a simple test case with only one known pore size dynamic and quasi static drainage are simulated for different capillary numbers in the capillary tube and the interface capillary pressure is calculated using both simulation and analytical solution laplace s equation eq 3 here the capillary number is defined as ca v  where v is the velocity of injection next in order to increase the complexity drainage is simulated in a porous medium with multiple pores from these microscale simulations the pore scale interface capillary pressure is directly determined at the fluid fluid invasion front this capillary pressure depends on the pore morphology shape and interfacial energy of the two fluids at the interface without accounting for the viscous dissipation the interface capillary pressure is compared to the macroscopic capillary pressure under equilibrium and non equilibrium conditions this paper is organized as follows section 2 describes the governing equations and the vof method the results of the drainage experiments along with the interface capillary pressure calculations are presented in section 3 the conclusions are discussed in section 4 2 methodology as stated in the previous section we utilize direct simulations with the vof method to investigate the pore scale capillary pressure under equilibrium quasi static and non equilibrium dynamic conditions dns coupled with vof has emerged as a powerful tool for diagnosing pore scale multiphase flow problems with complex boundary conditions enabling parameterization of macroscale quantities rabbani or et al 2018 the vof method relies only on conservation principles and solves a system of equations for the flow field evolution of two immiscible fluids nikhil kumar palakurthi konangi kishore comer ghia 2018 in the recent past the vof method has been successfully used by many researchers to study capillary dominant flows aboukhedr georgoulas marengo gavaises vogiatzaki 2018 aslannejad fathi hassanizadeh raoof tomozeiu 2018 deshpande anumolu trujillo 2012 fathi raoof mansouri 2017 ferrari lunati 2013 2014 hu wan kim tokunaga 2017 n k palakurthi konangi kishore comer ghia 2018 rabbani joekar niasar shokri 2016 rabbani joekar niasar pak shokri 2017 rabbani or et al 2018 rabbani seers 2019 rabbani zhao juanes shokri 2018 raeini bijeljic blunt 2015 saha mitra tweedie roy mclaughlin 2009 starnoni pokrajac 2019 suo liu gan 2019 verma et al 2018 in the vof method the effect of surface tension at the fluid fluid interface and wall adhesion in the form of a contact angle between the wetting liquid and solid matrix are accounted for n k palakurthi et al 2018 since no modeling assumptions are made on the geometry of the pore structure and flow propagation direct numerical simulations with vof method can serve as a means to gain valuable insights into the multi phase flow dynamics at the pore scale one of the major drawbacks of the vof method is the presence of parasitic or spurious currents owing to the pressure imbalance at the interface however it should be noted that other direct simulation methods such as particle based methods like lattice boltzmann lbm and smoothed particle hydrodynamics sph and continuum methods like level set ls also suffer from the presence of parasitic currents around the interface pavuluri maes doster 2018 berberovic berberovic 2010 presents the advantages of the vof method as compared to other particle and continuum methods in his dissertation the first part of this section describes the conservation equations of the vof method following this the results of a validation case are presented to verify the modeling accuracy of the two phase flow solver with published experimental results 2 1 governing equations and volume of fluid vof method the vof method is a fluid fraction based interface capturing technique used for modeling the flow of a system of two incompressible immiscible fluids nikhil kumar palakurthi et al 2018 it is based on a whole domain formulation that treats a two fluid system as a single fluid system with space dependent physical properties ferrari lunati 2013 in the conventional vof method the continuity and momentum conservation equations are solved along with an additional transport equation for the fluid fraction of one phase the governing equations are the 3d unsteady incompressible isothermal navier stokes equations along with a fluid fraction equation and are shown here in the vector form 2 1 1 fluid fraction advection equation the fluid fraction equation is written as 8 f t f u 0 where f is the fluid fraction aka volume fraction and lies between 0 and 1 0 f 1 and u is fluid velocity vector which is computed from the momentum equation eq 9 the spatial distribution of a phase is described by a fluid fraction function which carries information about the phase present wetting or non wetting f 0 corresponds to cells filled with the non wetting phase whereas f 1 indicates cells containing the wetting phase the interface is a surface of discontinuity of the fluid fraction function and is identified as the region in which the gradient of the fluid function is non zero gradients of the fluid fraction are encountered only in the region of the interface between the two phases 2 1 2 continuity or mass conservation equation 9 u 0 for incompressible flows the mass conservation equation is expressed as a solenoidal constraint on the fluid velocity u 2 1 3 momentum conservation equation 10  u t  uu p  u u t f  where  and  are density and dynamic viscosity of the fluid respectively and f  is the surface tension force the physical properties of the fluids phases are calculated as weighted averages based on the distribution of the fluid fraction function as shown in eq 10 11   w f  n w 1 f   w f  n w 1 f here the subscripts w and nw indicate the properties of the wetting and non wetting phases respectively the surface tension force f in the momentum conservation equation eq 10 is computed using the continuum surface force csf formulation brackbill kothe zemach 1992 this force is non zero only at the interface and describes the effect of the laplace pressure in the csf method the surface tension force acting at the interface is represented as a body force or volume force over the region occupied by the interface and is formulated as 12 f   k f where  is the surface tension between the wetting and non wetting phases and k is the mean curvature of the free surface which represents the magnitude of the interface normal flux at a specific face of the cell and is formulated as 13 k n c here n c is the unit vector normal to the fluid fluid interface calculated from the fluid fraction field as 14 n c f f in the vof method the interaction between the fluids and the solid surface i e wall adhesion is included as a boundary condition on the surface normal vector at the solid wall 15 n c n s c o s  t s s i n  here n s and t s are the unit vectors in the normal and tangential directions to the solid boundary respectively and  is the equilibrium or static contact angle wall adhesion or the wetting behavior at solid walls is accounted for using the contact angle which is given as an input to the solver the surface normal vector is corrected at the triple contact line to satisfy the specified static contact angle boundary condition the interface curvature in eq 13 is then calculated using this corrected surface normal vector as noted by ferrari lunati 2013 the interface curvature is fixed only in the faces adjacent to the solid walls whereas the interfaces can deform in the other cells in openfoam a modified fluid fraction advection equation is solved to ensure boundedness and conservation of the fluid fraction f an interface compression term is added to the fluid fraction advection equation to reduce the smearing of the interface and is critical for two phase flows with high density ratios berberovi van hinsberg jakirli roisman tropea 2009 readers are referred to berberovi et al 2009 deshpande et al 2012 for additional details of the modified fluid fraction advection equation implemented in openfoam 2 2 solution procedure with openfoam the first step in conventional computational fluid dynamics cfd is the generation of a grid which adequately resolves the pore space in a porous medium an eulerian unstructured hexahedral dominant computational grid is generated using the meshing utility helyxhexmesh which is a part of the enhanced openfoam package engys www engys com in the meshing process a background hexahedral mesh is first created for a desired resolution maintaining a cell aspect ratio of unity subsequently the unwanted cells inside the solid body are removed and a boundary fitted grid is obtained by iteratively refining and snapping the cells to the solid surfaces resulting in split hexahedral cells next the 3d incompressible ns equations eqs 9 and 10 along with the fluid fraction equation eq 8 are discretized using a finite volume discretization scheme a first order time accurate implicit euler scheme is used to integrate the mass and the momentum conservation equations whereas second order accuracy is ensured in the spatial discretization the fluid fraction equation is solved explicitly the piso pressure implicit operator splitting solution algorithm ferrari lunati 2013 is used to solve the coupled system of discretized equations in an iterative fashion until convergence is obtained the equations are solved in parallel using the mpi message passing interface algorithm greenshields 2015 in order to demonstrate the modeling accuracy of our simulations a validation case is presented in the next section 2 3 validation of numerical solution in this section the modeling accuracy of our two phase calculations is tested by simulating a validation case validation addresses the physics modeling accuracy of a simulation by comparing the simulation results with experimental data oberkampf trucano 2007 for the purpose of validation experiments conducted by kunz et al 2016 are computationally replicated kunz et al 2016 performed microfluidic experiments of drainage in a poly dimethyl siloxane pdms micromodel shown in figure 1 the pdms micromodel used in their experiment is hydrophobic quasi two dimensional rectangular channel of dimensions 2 5 1 mm2 in length and breadth respectively a random distribution of cylindrical obstructions shown in black in fig 1 is used to create a pore network with an average pore diameter of 160m the height of the cylindrical pillars is 100 microns in kunz et al 2016 the micromodel is connected to two reservoirs on either side containing the wetting and non wetting phases the immiscible fluids used are fluorinert 43 fc 43 as the wetting phase  1800 kg m3  0 0047 pa s and water dyed with ink  1000 kg m3  0 001 pa s as the non wetting phase the surface tension between the two phases is 55mn m the micromodel is initially saturated with the wetting phase and drainage experiments are conducted by imposing an external pressure on the non wetting phase reservoir the viscosity ratio m of the invading fluid non wetting phase to the defending fluid wetting phase is 0 21 kunz et al 2016 conducted experiments of both dynamic and quasi static drainage in dynamic drainage a fixed external pressure is applied across the micromodel whereas in a quasi static drainage the displacement of the wetting phase is performed in multiple steps with relaxation time in between during which the phases are allowed the equilibrate in order to perform our numerical simulations as a first step the geometry of the micromodel is extracted from the published manuscript of kunz et al 2016 using image analysis the image extraction produces 2d curves which are then extruded for the specified cylinder height of 100 microns to construct the 3d model the 3d geometry of the micromodel is meshed using the helyxhexmesh utility in engys openfoam three uniform computational grids are generated with an average resolution of 10 5 and 2 5 microns resulting in mesh sizes of 46700 293390 and 2 05 million cells respectively in order to choose an appropriate grid size preliminary drainage simulations are conducted using the three aforementioned grid sizes fig s 1 and fig s 2 in the supplementary section show the results of the grid dependence study in fig s 1 for the three grid sizes considered the wetting phase saturation sw s 1a and the interfacial area of the wetting and non wetting fluids awn fig s 1b are plotted as function of flow time fig s 2 shows the non wetting phase water with ink depicted in blue penetrating the wetting phase fc 43 shown in red the mean difference in wetting phase saturation between the finest mesh 2 5 microns and the coarsest mesh 10 microns is 5 5 approx whereas the difference between the finest and the medium mesh 5 microns is 1 similarly the mean deviation between the finest and coarsest mesh in the interfacial area values is 9 while the difference between the finest and medium meshes is 8 7 based on these results and keeping in mind the availability of computational resources it was concluded that the medium mesh with an average mesh size of 5 microns provides results that fall within an acceptable degree of confidence following the grid dependence study dynamic and quasi static drainage are simulated in the micromodel shown in fig 1 using the medium mesh with an average cell resolution of 5 microns dynamic drainage experiment is a one step process in which a total pressure drop of 1 86kpa corresponding to experimental data is applied across the micromodel in the form of a pressure gradient between the inlet and the outlet in the simulation a no slip impermeable wall boundary condition is specified on the top and bottom plates and on the cylindrical obstacles the contact angle is fixed at a constant value of 45o on all the solid surfaces fig 2 shows the simulated flow paths in vof simulation on the left side along with the experimental solution on the right side from fig 2 it can be seen that the simulations are able to closely predict the flow pathways observed in experiments in each image the wetting phase saturation and the corresponding time stamp is presented despite good agreement between the simulated and observed flow paths there is significant deviation in the time scales this discrepancy may be related to the following factors that are not adequately represented in the simulation the first factor is the additional resistance in the experimental set up arising from the connections between the micromodel and the fluid reservoirs this connection is not included in the simulation set up the next source of discrepancy may arise from the modeling of the contact line physics in the simulation in the vof simulations a fixed static contact angle of 45o is imposed on the solid walls to account for the wettability whereas in reality the contact line physics will depend on the local capillary number an appropriate dynamic contact angle model may be required to account for this dependence the present simulations do not take into account contact angle hysteresis and dynamic contact angle effects in addition some roughness may be present on the walls of the micromodel from fabrication resulting in a pinning of the contact line and additional viscous losses in an experiment notwithstanding these deficiencies it is promising to note that the vof simulations are able to adequately capture the invasion pathways that are observed experimentally accurate representation of the displacement pattern is of key importance in the calculation of pore scale capillary pressure see section 3 in order to simulate the quasi static drainage process the micromodel is first fully saturated with the wetting phase fc 43 the non wetting phase is injected until the saturation of the wetting phase is reduced by 5 following which the injection velocity is set to zero and the system is allowed to reach equilibrium the saturation contours of the non wetting phase penetration are compared with the experimental results in fig 3 here again it is evident that pore filling in the simulation largely follows the experimental pathways with some minor differences from the validation results it is evident that the two phase simulations using the vof method are in reasonable agreement with published experimental results in the next section we utilize direct simulations to study the capillary pressure saturation relation at the pore scale and its implications 3 results in this section the two phase flow simulations with the vof method described in section 2 are used to investigate the capillary pressure saturation relation under equilibrium quasi static and non equilibrium dynamic conditions as stated earlier our goal is to provide insight into the behavior of pore scale capillary pressure from direct simulations of drainage from the direct simulations the pore scale capillary pressure acting at the fluid fluid interfaces is calculated directly from the pressure field in the computational domain without making any approximations this is referred to as the interface capillary pressure pinterface the interface capillary pressure that is computed at the invasion front depends only on the pore morphology shape and interfacial energy of the two fluids at the interface this interface capillary pressure is computed for different flow conditions and is compared to the macroscopic total pressure drop based on reservoir pressures that typically measured in experiments the total pressure drop across a porous medium is a combination of both the interface capillary pressure and the pressure head due to viscous effects viscous dissipation under dynamic conditions depending on the capillary number of the flow the viscous losses may dominate the total pressure drop calculation in this paper three pore geometries are considered fig 4 depicts a schematic of the geometric models considered in this article relative to their length scale and pore size variation thereby complexity in fig 4 three porous media are shown in increasing progression of pore size distribution a capillary tube a small micromodel and a porous medium both the micromodel and the porous medium are represented by a flow network of cylindrical obstructions as the first step drainage in a horizontal cylindrical capillary tube is studied as it is perhaps the simplest possible porous medium with only one known pore size the results of the capillary pressure calculations for the capillary tube are presented in section 3 1 next the micromodel used in our validation effort fig 1 is re utilized for the pore scale capillary pressure analysis since the micromodel has multiple pore bodies and pore throats as opposed to the single pore in the capillary tube the interface capillary pressure is an averaged parameter across the interfaces in the various pores of the micromodel once again the macroscale capillary pressure pc sw in eq 6 is computed and compared to the interface capillary pressure under different flow conditions see section 3 2 finally the capillary pressure calculations are performed on a virtual porous medium of a large size to ensure that the averaged values of measured parameters such as capillary pressure and saturation are independent of small scale variations the details of this case are presented in section 3 3 3 1 drainage in a capillary tube dynamic and quasi static drainage are simulated for different capillary numbers in a straight horizontal cylindrical capillary tube shown in fig 4 of length 10mm and radius 1mm in order to perform the drainage simulations the two fluids are fluorinert 43 fc 43 as the wetting phase  1800 kg m3  0 0047 pa s and water dyed with ink  1000 kg m3  0 001 pa s as the non wetting phase the viscosity ratio between these two fluids is m 0 21 the capillary tube is initially saturated with the wetting phase defending fluid which is then displaced by injecting the non wetting phase invading fluid the non wetting phase is injected with a constant velocity at the inlet of the tube corresponding to a fixed volume flow rate by fixing the flow rate we are able to maintain a constant capillary number ca which is defined as 16 c a  w v i n l e t  where the w denotes the wetting phase viscosity vinlet is the inlet injection velocity and  is the surface tension between the two fluids five capillary numbers are considered corresponding to flowrates q of 1 10 100 500 and 1000ml hr the chosen capillary numbers span four orders of magnitude from ca 7 6e 6 to 7 6e 3 at the inlet of the tube a constant velocity is specified along with a zero gradient condition on the pressure the inlet fluid fraction is set to f 0 corresponding to the non wetting phase at the outlet a zero gradient condition is applied to the velocity and the fluid fraction function f along with a constant zero pressure condition a fixed contact angle of 45o is used in all the simulations in the dynamic drainage simulation the flow rate is fixed and the computation is performed until the non wetting phase reaches the wetting phase reservoir at the outlet of the capillary tube at which point the simulation is stopped for quasi static drainage the non wetting phase injection is performed in steps for every 10 decrease in wetting phase saturation the injection velocity is set to zero and the fluids are allowed to equilibrate this process is repeated until the non wetting phase broke through to the wetting phase reservoir at the outlet fig s 3 depicts contours of a drainage simulation taken at the mid section plane in the capillary tube in the figure the non wetting phase water is colored in blue while the wetting phase fc 43 is shown in red the interface between the two fluids is visualized in white as a zero thickness flexible surface from the drainage simulation the interface capillary pressure is calculated as the pressure difference across the fluid fluid interface as shown in fig 5 in direct simulations the pressure field is available throughout the computational domain from the pressure field the capillary pressure can be directly calculated by taking the difference in pressure across the fluid fluid interface this eliminates the need to make any approximations such as estimating the curvature of the interface an issue frequently faced by experimentalists in order to calculate the pressure difference the first step is to identify the fluid fluid interface using the fluid fraction function f it may be recalled that f 0 indicates cells filled with the non wetting phase whereas f 1 denotes the volume occupied by wetting phase thus the interface can be identified as the region in which lies in between 0 and 1 0 f 1 for the purpose of the capillary pressure calculations an isosurface of values f 0 5 is chosen to indicate interface between the two immiscible fluids this called the primary interface next two secondary isosurfaces are created one upstream and another downstream of the f 0 5 primary interface the two secondary interfaces are needed to calculate the difference in fluid pressures across the primary interface and are chosen such that they are in close proximity to primary interface the upstream secondary interface is positioned in the non wetting phase at say values of f 0 01 so that it contains the pressure field of the non wetting phase similarly the downstream secondary interface is placed in the wetting phase at f 0 99 and thereby comprises of the wetting phase pressure field the wetting and non wetting phase pressures at the secondary interfaces are then mapped on to the primary interface on a node by node basis using the post processing visualization tool ansys ensight the number of nodes available on the primary and secondary interfaces correspond to the mesh resolution used in the simulation typically each pore is resolved using 10 20 mesh cells the vertices of these cells are called nodes which represent the point at which the value of each variable such as pressure is stored using the mapped wetting and non wetting phase pressures the pressure difference is computed at each node on the primary interface lastly the node based pressure differences on the primary interface are averaged using the local interfacial area of each node this is approximately the mesh cell area resulting in an average interfacial area weighted capillary pressure in other words this is the interface capillary pressure pinterface mathematically the interface capillary pressure is calculated according to the following equation 17  p interface i 1 n p i c a i i 1 n a i in eq 17 pc is the local interface capillary pressure which is the pressure difference between the fluids at each node on the primary interface and a is the interfacial area of a node i on the primary interface fig 6 a shows the total pressure drop across the capillary tube pio which is the pressure difference between the inlet and outlet of the capillary tube eq 7 plotted for different capillary numbers in a dynamic drainage simulation as noted by ferrari et al ferrari lunati 2013 for a flow with unfavorable viscosity ratio i e m 1 pio initially increases rapidly due to the effects of entry pressure but steadily decreases thereon owing to the low viscosity of the invading fluid which reduces the viscous dissipation of the system in fig 6a it can be observed that total pressure drop is higher for larger ca numbers owing to the increase in viscous forces fig 6b shows the interface capillary pressure pinterface as a function of different ca numbers recall that the interface pressure difference is calculated directly from the pressure field in the vicinity of the fluid fluid interface and is area weighted averaged using the local interfacial area as shown in eq 17 from fig 6b it is clear that pinterface fluctuates over a well defined average or equilibrium value but remains almost constant for all ca numbers the analytical value of the interface capillary pressure is 77pa from laplace s equation eq 3 it is seen that the interface capillary pressure from the simulation falls within 5 of the laplace pressure which is calculated under static conditions in fig 6b the interface capillary pressure is depicted on the same scale as the total pressure drop in fig 6a to highlight that the interface pressure doesn t vary significantly with the capillary number in contrast to the total pressure from fig 6b it can be seen that the interface capillary pressure is unaffected by the speed of flow it should be noted that fluctuations seen in the interface capillary pressure are numerical artifacts that are expected to decrease with an increase in the mesh resolution in contrast the macroscopic total pressure drop value has a tendency to increase with capillary number as the contribution from the pressure head caused by viscous effects increases as a function of the invasion speed an estimate of the viscous pressure head can be obtained from the hagen poiseuille pressure drop equation pviscous 8lq r4 for laminar flow in a cylindrical tube which dictates that the viscous pressure head is directly proportional to the average flow velocity for the highest ca number ca 7 6e 3 case considered pviscous is roughly 33pa as shown in eq 7 the difference between the total pressure drop and the interface capillary pressure corresponds to the viscous pressure head thus under static conditions when the fluids are not moving the viscous forces become zero and the total pressure drop will be equal to the interface capillary pressure next in order to understand the impact of static and dynamic conditions on the pressure calculations pio and pinterface are computed for quasi static drainage in the capillary tube in quasi static drainage an injection phase is followed by a relaxation phase in which the meniscus moves until it reaches an equilibrium fig 7 shows a plot of the total pressure drop from a quasi static drainage experiment compared to the dynamic and quasi static interface capillary pressures for the same capillary number ca 7 6e 4 in fig 7 note that the total pressure drop equals the interface capillary pressure in the relaxation stages of the quasi static drainage in the relaxation phases the total pressure drop equals the interface capillary pressure since the fluids are stationary resulting in zero viscous forces however in contrast to the total pressure drop the interface capillary pressure calculated from eq 17 is observed to be close to the equilibrium capillary pressure value under both dynamic and quasi static conditions in other words the interface capillary pressure remains close to the equilibrium capillary pressure under all flow conditions the total pressure drop depends strongly on the flow velocity or ca number and agrees with the interface capillary pressure only under equilibrium conditions in the next section we investigate the capillary pressure calculations for a micromodel with multiple pores here again the total pressure drop is computed and compared to the pore scale interface capillary pressure under different flow conditions 3 2 drainage in a micromodel the quasi two dimensional pdms micromodel used in the validation study is re utilized here to study the capillary pressure saturation relation under dynamic and quasi static conditions here again the two fluids used are fc 43 as the wetting phase and water dyed with ink as the non wetting phase with a viscosity ratio of m 0 21 from the original micromodel shown in fig 1 the inlet and outlet channels are removed and a frit is added near the entrance and exit of the micromodel in a drainage experiment the purpose of the frit consisting of 25 small equally spaced cylinders of diameter 30m and separated by a distance of 10m is to prevent the non wetting phase from reaching the wetting phase reservoir at the outlet the frit represents a semi permeable filter that is typically used in experiments to present the non wetting fluid from breaking through to the wetting fluid reservoir a top view of the modified micromodel is shown in fig s 4 with the cylindrical pore network depicted in black drainage is simulated for four capillary numbers ca 2 4e 5 1 2e 4 2 4e 4 and 2 4e 3 corresponding to volume flow rates of 0 1 0 5 1 and 10 ml hr respectively for all capillary numbers both the dynamic and quasi static flow conditions are considered as stated earlier in a dynamic drainage simulation the flow rate is fixed and the computation is performed until the non wetting phase reaches the wetting phase reservoir at the outlet of the micromodel under quasi static drainage conditions the non wetting phase injection is performed such that for every 10 decrease in wetting phase volume the injection velocity is set to zero and the fluids are allowed to equilibrate this process is repeated until the non wetting phase broke through to the wetting phase reservoir at the outlet a relatively uniform computational mesh of size 391 350 cells with an average resolution of 5 microns is utilized for all the simulations the third dimension orthogonal to the plane of the micromodel is discretized into twenty cells at the inlet of the micromodel a constant velocity based on the flow rate is specified along with a zero gradient condition on the pressure the inlet fluid fraction is set to f 0 corresponding to the non wetting phase at the outlet a zero gradient condition is applied to the velocity and the fluid fraction function f along with a constant zero pressure condition on all the solid surfaces a no slip impermeable wall boundary condition is specified along with a constant contact angle of 45o the frit near the inlet boundary is given a slip wall boundary condition such that it does not impact the incoming flow whereas the outlet frit which is used to contain the non wetting phase is given a no slip boundary condition with a contact angle of 0 degrees fully wetted for the quasi static drainage from preliminary simulations the relaxation time period is chosen to be three times the injection time in order to allow the system to reach equilibrium such that there is no significant change in saturation and fluid properties in each quasi static drainage simulation the specific interfacial area awn which is defined as the fluid fluid interfacial area between fc 43 and water divided by the volume of the micromodel is monitored such that during the relaxation phases the interfacial area reaches an equilibrium value before the next injection phase is started this confirms that the relaxation time used in the quasi static simulation is sufficient to ensure that the phases have reached an equilibrium configuration fig 8 depicts the contours of drainage at a flow rate of 1ml hr in the figure the top panel shows the non wetting phase pathways in a dynamic flow scenario whereas the bottom panel shows the quasi static flow at approximately the same saturation levels fig 9 shows a comparison of the dynamic and quasi static flow patterns for flow rates of 1ml hr and 10ml hr in fig 9 it can be seen that for the same flow rate or capillary number the displacement pattern can depend on the type of injection i e dynamic or quasi static in addition a change in capillary number will trigger variance in flow pathways resulting in different final states from the pressure field obtained in the dynamic and quasi static drainage simulations the interface capillary pressure is calculated using eq 17 following the steps described in section 3 1 the computed interface capillary pressure is compared to the total boundary pressure drop pio for all capillary numbers under dynamic and quasi static conditions fig 10 shows the total pressure drop across the micromodel pio which is the pressure difference between the inlet and outlet and the interface capillary pressure pinterface from eq 17 for different capillary numbers for dynamic drainage in fig 10a it can be observed that total pressure drop is highest for the largest capillary number flow of ca 2 3e 3 at a flow rate of 10ml hr as the capillary number is reduced the contribution of the viscous pressure head to the total pressure drop decreases an estimate of the viscous pressure losses due to the presence of the upper and lower plates of the micromodel can be obtained from the hagen poiseuille pressure drop equation pviscous 12lu h2 where h is the distance between the two plates gap height recall that the gap height for the micromodel under consideration is h 100m thus for the highest ca number ca 2 4e 3 case considered pviscous is 548pa approx it is evident from the hagen poiseuille equation that pviscous depends directly on the invasion velocity of the flow next in order to compare the viscous losses to the capillary forces in the micromodel we estimate the driving capillary force between the two horizontal parallel plates using the laplace s equation pc 2cos  h this capillary force is a result of the vertical curvature of the meniscus arising from the wall adhesion and the surface tension between the two fluids the capillary force arising from this vertical curvature is constant and can be calculated for the micromodel under consideration the fluid fluid interface makes a contact angle of 45o with the horizontal plates in the vertical direction resulting in a vertical capillary pressure of approximately pc 778pa thus for the largest flow rate case highest ca the viscous and capillary forces are of the same order of magnitude as the flow rate is reduced the viscous forces decrease in magnitude and effect whilst the capillary force remains constant in addition to the capillary pressure due to the vertical curvature there exists an in plane capillary pressure due to the interface curvature in the horizontal direction this capillary pressure is a variable that depends on the size of the pores between the obstacles in the porous medium the total capillary pressure acting in the porous medium can be estimated by calculating the mean curvature of the interface i e an average of the two principle radii of curvature in the horizontal and vertical directions the interface capillary pressure calculated in our simulations is a direct estimate of the total capillary pressure since it is computed in the three dimensional space fig 10b shows the interface capillary pressure pinterface as a function of different ca numbers from fig 10 b it can be observed that the pinterface remains bounded for all ca numbers and is not noticeably affected by the flow rate fig 11 depicts a comparison between the total pressure drop and the interface capillary pressure under static and dynamic conditions for a flow rate of 0 5ml hr ca 1 2e 4 fig 11a show the total pressure drop and the interface capillary pressure under dynamic flow conditions whereas in fig 11b the total pressure drop and the interface capillary pressure are compared under quasi static flow conditions in all the figures the fluctuations seen in capillary pressure values are due to the variability of the entry pressure necessary to invade pores of different sizes in fig 11 the difference between pio and pinterface can emanate from two causes the first is the viscous pressure head under dynamic conditions when the phases are constantly moving the viscous pressure losses are non zero however in a quasi static flow in the relaxation phases we expect the total pressure drop to equal the interface capillary pressure since the fluids are stationary resulting in zero viscous forces in fig 11b we see that this is not the case the total pressure drop deviates from the interface capillary pressure even in the relaxation stages this interesting difference is due to the effect of trapped wetting phase aka bubbles unlike a capillary tube in a porous medium with multiple pores the fluid phases may not always be connected at the pore scale the interfaces may snap off and result in trapped bubbles or blobs of the wetting phase that have high phase pressures the presence of these bubbles impact the pore scale capillary pressure calculations fig 12 illustrates a case of disconnected blobs that are trapped during drainage in the micromodel in the figure two scenarios are depicted on the left is a stable interface with connected fluid phases and on the right is a case of disconnected phases with a trapped wetting phase circled and highlighted in an ideal immiscible displacement scenario when the fluid phases are connected and are at equilibrium such as in the relaxation stages of a quasi static experiment the total boundary pressure drop will be equal to the interface capillary pressure however in reality flows in most heterogeneous porous media result in disconnected fluid phases with distribution of trapped blobs bubbles that have their own high capillary pressures in fig 12 the trapped wetting phase has a pressure similar to that of the surrounding non wetting phase and when its volume becomes comparable to the volume of the connected phases its effect on the capillary pressure measurement becomes significant in addition the reservoir pressure based total pressure drop does not account for the presence of these trapped bubbles even under equilibrium conditions ferrari lunati 2013 our interface pressure calculation based on eq 17 relies on the pressure differences across fluid interfaces at pore scale and explicitly includes the capillary pressure of all phases connected or otherwise and their local interfacial areas thus in fig 11b the difference between the total pressure drop and the interface capillary pressure in the equilibrium stages of a quasi static flow is due to the presence of the trapped wetting phase thus even under static conditions when the fluids are not moving and the viscous forces are zero the total pressure drop may not always be equal to the interface capillary pressure lastly it should be noted that a wetting phase blob that has lost its connection to the outlet completely may not be drained from the porous medium this may result in a non zero saturation at the end of the drainage step and is referred to as residual saturation from fig 11c it can be seen that for capillary numbers of ca 1 2e 4 the dynamic and quasi static interface capillary pressure curves are almost equivalent to one another this shows that the interface capillary pressure relation is a unique parameter that is independent of flow conditions dynamic and quasi static as long as the flow pathways invasion patterns remain the same if the non wetting phase invasion varies under dynamic and quasi static conditions the interface capillary pressure is no longer invariant this is demonstrated in the results for cases of flow rate 1ml hr and 10ml hr ca 2 3e 4 and 2 3e 3 respectively the snapshots of dynamic and quasi static drainage for these flow rates are compared in fig 9 from fig 9 it can be seen that the non wetting phase invasion patterns are not identical in the dynamic and quasi static conditions thus different interface capillary pressure curves are obtained for the dynamic and quasi static drainage for flow rates of 1ml hr and 10ml hr the total pressure drop and interface capillary pressure curves for the 1ml hr case is presented in fig 13 in conclusion the results from our micromodel simulations show that the interface capillary pressure saturation relation remains bounded for all ca numbers and is not noticeably affected by the flow rate or capillary number contrastingly the total pressure drop heavily depends on the flow rate or capillary number as it implicitly includes the viscous losses in the domain this dependence on the viscous losses can skew capillary pressure measurements and result in a mischaracterization the capillary forces in the system next in a micromodel as opposed to the immiscible displacement in a capillary tube the fluid phases are not always connected to the reservoirs and disconnected interfaces are obtained finally the results show that the interface capillary pressure is invariant of transient flow conditions i e dynamic and quasi static as long as the invasion patterns are identical however we demonstrate that the displacement patterns can vary as a function of the flow conditions and this will in turn impact the capillary pressure saturation relation 3 3 drainage in a porous medium in this section the pc sw relation is studied using a large micromodel at the representative elementary volume rev scale such that average properties can be calculated from the simulations without being influenced by small scale variations for this purpose a horizontal elongated quasi two dimensional micromodel shown in the top right corner of fig 4 an enhanced view is depicted in fig s 5 is chosen as the representative porous medium this is a hele shaw cell of two fixed parallel plates with a random distribution of cylindrical obstructions in between the pore network is three dimensional but with a small thickness in the vertical direction thus gravity has no influence on the displacement in recent years such an artificial microfluidic device made of a transparent plate material have been used by numerous researchers to study the displacement of immiscible fluids chen et al 2007 godinez brizuela et al 2017 hu et al 2017 karadimitriou hassanizadeh 2012 karadimitriou et al 2014 liu nolte nolte 2011 mehmani tchelepi 2017 oostrom et al 2016 pyrak nolte et al 2008 wang xiong liu peng 2018 in order to avoid confusion with the micromodel used in the previous section section 3 2 the pore geometry used in this section is referred to as a porous medium the porous medium used in our simulations is a pdms micromodel of size 50 10 0 04 mm3 with a three dimensional pore network of 12132 cylindrical obstacles the mean obstacle size is 130m and the minimum and maximum obstacle diameters are 58m and 242m with a standard deviation of 62 5m the depth is constant everywhere and is measured to be 40m the porous medium has roughly 8 revs in the x direction and almost 2 revs in the y direction details of the rev calculation are presented in appendix a representative elementary volume rev an autocad drawing dwg format of the pore network is used to generate the triangulated stereolithography stl files required for openfoam meshing meshing is performed by imposing a uniform cartesian grid and removing regions intersecting the solid phase using the helyxhexmesh utility in engys openfoam this results in a body fitted mesh with hexahedral and split hexahedral cells on the stl geometries an example of the mesh around the obstacles is shown in fig s 6 based on grid dependence tests not shown here a mesh with an average cell size of 20 microns in the horizontal plane total mesh size 3 2 mil cells is utilized in all the following drainage simulations to investigate the pore scale capillary pressure saturation relation at the inlet and outlet of the porous medium a frit is included which acts as a semi permeable filter that prevents the non wetting fluid from reaching the wetting phase reservoir the frit consists of 250 small cylinders d 30m spaced by 10m the flow in the thickness direction is resolved using a cell size of 10microns the same vertical resolution was used in a recent publication sby hu et al hu et al 2017 who pursued computational fluid dynamics cfd simulations with openfoam primary drainage is simulated for five capillary numbers ca 1 2e 5 2 3e 5 5 8e 4 1 2e 4 and 2 3e 4 corresponding to flow rates of 0 5 1 2 5 5 and 10ml hr respectively at low flow rates capillary forces dominate the displacement structure whereas at the higher capillary numbers the invasion is viscosity dominated in order to perform the drainage simulations the wetting and non wetting phases chosen are water dyed with ink  1000 kg m3  0 001 pa s and poly dimethly siloxane pdms oil  913 kg m3  0 0045 pa s respectively the viscosity and density ratios during the drainage process are m 4 5 and h 0 913 respectively accordingly the non wetting phase pdms oil is 4 5 times more viscous and 1 1 times lighter than the wetting phase water the choice of these fluids is driven by occurrence in published literature godinez brizuela et al 2017 initially the porous medium is saturated with water which is then displaced by the pdms oil during drainage in the simulations the flow rate is specified at the inlet boundary thereby keeping the global capillary number a constant a static constant angle of 30 degrees is imposed on all the solid surfaces to account for wall adhesion and the surface tension between the two fluids is 30mn m from the drainage simulations the average up scaled interface capillary pressure pinterface is computed across the various pores and compared to the total pressure drop across the porous medium pio recall that the total pressure drop across the porous medium is the pressure difference between the non wetting and wetting phase reservoirs at the inlet and outlet boundaries of the porous medium respectively fig 14 shows the total pressure drop across the porous medium pio plotted for different capillary numbers for dynamic drainage for flows with a favorable viscosity ratio i e m 1 pio increases with the saturation of the non wetting fluid owing to the higher viscosity of the invading phase also the total pressure drop is higher for larger ca numbers as the viscous forces are higher in magnitude and decreases as the capillary number or the flow rate is lowered a similar behavior has been observed in published literature in drainage experiments with 2d cylindrical obstacles ferrari lunati 2013 and glass bead monolayers lovoll et al 2011 next using the pressure field at the fluid fluid interfaces from the simulations the pore scale interface capillary pressure pinterface is computed pinterface is a measure of the capillary forces acting at the invasion front and is computed from the pore scale pressure differences across the multiple menisci in the porous medium fig 15 shows the interface capillary pressure pinterface as a function of different ca numbers in fig 15 the same scale is used on the ordinate as fig 14 in order to compare the interface capillary pressure with the total pressure drop plotted in fig 14 in contrast to the total pressure drop it is clear that pinterface remains closely bounded for all ca numbers this observation is consistent with the results of the micromodel presented in section 3 2 the inset in fig 15 presents a zoomed in view of the interface capillary pressure curves shown in fig 15 from the inset it is evident that the pinterface values for highest flow rate of 10ml hr ca 2 3e 4 are higher than those of the other four lower capillary numbers the capillary pressure values for lower capillary numbers do not vary significantly from each other this behavior is explained by the understanding the different mechanisms that drive interface propagation at high and low capillary numbers during drainage fig 16 shows the fluid distribution for the highest flow rate case of 10ml hr and a lower flow rate case of 1ml hr at a wetting phase saturation of approximately 33 i e sw 0 33 in fig 16 the first image shows the snapshot of drainage at the highest flow rate of 10ml hr corresponding to ca 2 3e 4 at a high capillary number the viscous forces are dominant and the viscosity ratio dictates the front morphology for the chosen fluid pair the viscosity ratio m is greater than 1 whereby the invading fluid is more viscous than the defending fluid and the front is stable this stable front is clearly visible in the first image in fig 16 at a lower capillary number the viscous forces are weak with respect to capillary forces weakening of the viscous forces reduces the dependence on the viscosity ratio and leads to a less stable regime even for m 1 thus for lower capillary numbers the viscous pressure drop is negligible with respect to capillary pressure and the pore size variability dominates the interface behavior which results in an increased front roughness ferrari lunati 2013 at a lower capillary number the drainage front is controlled by capillary forces and displays a typical pattern that can be described by invasion percolation the second image in fig 16 shows the invasion front for a lower capillary number of ca 2 3e 5 flow rate 1ml hr from fig 16 it can be seen that for the highest capillary number case ca 2 3e 4 only a very small volume of the wetting fluid water blue is left behind the compact front in contrast for the lower capillary number case ca 2 3e 5 a larger amount of defending wetting fluid remains trapped in form of disconnected clusters recall that the interface capillary pressure calculations take into account the local capillary pressures of the trapped wetting phase clusters and their interfacial areas this results in higher interface capillary pressure values for the case of flow rate 10ml hr ca 2 3e 4 that has a stable front and lower capillary pressure values for the lower flow rate cases where disconnected clusters are dominant fig 17 shows a comparison of the total pressure drop across the porous medium pio with the interface capillary pressure pinterface computed at the fluid fluid interfaces at the pore scale for the lowest capillary number considered ca 1 2e 5 flow rate 0 5ml hr even for the lowest flow rate considered it is evident that the total pressure drop is dominated by the viscous effects which in turn are a function of the system size and invasion speed lovoll et al 2011 in contrast the pore scale interface capillary pressure does not account for the viscous losses and thereby truly characterizes the capillary forces in the porous medium lastly we present a comparison of the viscous and capillary forces in the porous medium the macroscopic total pressure drop has a tendency to increase with capillary number since the contribution from the pressure head caused by viscous effects increases as a function of the invasion speed an estimate of the viscous pressure head from the presence of top and bottom plates can be obtained from the hagen poiseuille pressure drop equation pviscous 12lu h2 in this equation  is the non wetting phase viscosity for drainage u is invasion speed l is the length of the model and h is the gap height or the distance between the two plates h 40m assuming l to be the total length of the porous medium i e the non wetting has completely forced out the wetting phase we can easily obtain an estimate of viscous pressure losses another estimate of the viscous pressure head can be obtained from darcy s law p ql ka where q is the flow rate k is permeability of the medium and a is the inlet cross sectional area we calculated the absolute permeability of the medium k to be 4 95e 11m2 from single phase flow calculations not included here from table 1 we can see that viscous losses estimated using darcy s law is always higher that the estimate from the hagen poiseuille hp law this is because the hp equation represents only the pressure drop from the presence of the two parallel plates whereas darcy s law includes the effect of the cylindrical obstacles by taking into account the permeability of the medium note that in both the viscous pressure losses estimates the presence of the wetting phase has been ignored next an estimate of the capillary force is obtained using the laplace s equation pc 2cos  r which relates the capillary pressure to the surface tension between the two fluids the contact angle and the radius of curvature of the interface the driving capillary force arises from two sources the first is the presence of the two flat horizontal plates here the capillary pressure is a consequence of the curvature of the interface in the vertical thickness direction the capillary force arising from this vertical curvature is constant and can be calculated by assuming radius of curvature in laplace s equation to be equal to the gap height of 40m this vertical capillary pressure is approximately pc 1299pa the next source of capillary driving force is the in plane curvature of the interfaces in the horizontal direction this capillary pressure is a variable that depends on the size of the pores between the obstacles in the porous medium an estimate of the horizontal capillary pressure is obtained using the mean cylinder diameter of 130m in laplace s equation the resulting average horizontal capillary pressure is 399pa the last column in table 1 shows the ratio of the viscous darcy pressure drop and vertical capillary forces for all capillary numbers or flow rates it is evident that the viscous pressure losses are an order of magnitude higher than the driving capillary pressure for the flow rates of 5ml hr and 10ml hr as the flow rate is reduced the viscous forces decrease in magnitude however unless the flow rate is sufficiently low the viscous losses may not be negligible as they depend on both the system size and the invasion velocity i e both parameters need to be small for the viscous effects to be truly negligible for the case of the lowest flow rate considered 0 5ml hr the viscous and capillary forces are of the same order of magnitude finally it should be noted that total capillary pressure acting in the porous medium can be estimated using the mean curvature of the interface which is an average of the two principle radii of curvature in the horizontal and vertical directions the pore scale interface capillary pressure calculated from our simulations using eq 17 is an direct estimate of the total capillary pressure acting at the invasion front since it is computed in the three dimensional plane 4 summary and conclusions in this study we use direct numerical simulations with the volume of fluid vof method to explicitly measure the pore scale capillary pressure in a porous medium and compare the pore scale capillary pressure to the macroscale capillary pressure pc sw under equilibrium quasi static and non equilibrium dynamic conditions the pore scale capillary pressure is the pressure difference at the interface between two fluids as the fluids move through the pores of a porous medium the main objective of this study is to understand how well a conventional macroscale capillary pressure measurement that is typically based on the pressure drop across a porous medium represents the pore scale capillary pressure under different flow conditions in order to understand the link between the pore scale and macroscale capillary pressure we chose drainage in a porous medium as the representative immiscible displacement flow process direct simulations of dynamic and quasi static drainage are conducted in three geometries capillary tube micromodel and a porous medium by solving the 3d navier stokes equations in the pore space using the cfd code openfoam the vof method is utilized to track the evolution of the fluid fluid interfaces and takes into account fluid adhesion at the solid walls and the effects of surface tension as a first step dynamic and quasi static drainage are simulated for different capillary numbers in a horizontal cylindrical capillary tube following this drainage is studied in a micromodel and a porous medium both having multiple pores of different sizes from these microscale simulations the total pressure drop across the domain and the interface capillary pressure at the fluid fluid interfaces are calculated for all flow rates or capillary numbers for a simple capillary tube the pore scale capillary pressure is the pressure difference across the fluid fluid interface whereas for a porous medium with multiple pores a representative pore scale capillary pressure is calculated by averaging the pressure differences across all the menisci resulting in an average interface capillary pressure pinterface the interface capillary pressure pinterface is compared to the macroscale capillary pressure corresponding to the total pressure drop pio across the porous medium that is typically measured in experiments using pressure transducers under equilibrium and non equilibrium conditions the results from the capillary tube simulations show that the conventionally measured macroscopic total pressure drop strongly depends on the flow rate or capillary number the total pressure drop increases with capillary number as the contribution from the pressure head caused by viscous effects increases with the invasion speed thus larger the flow rate or capillary number the higher is the total pressure drop in contrast the interface capillary pressure is almost invariant of capillary number and flow conditions equilibrium and non equilibrium it remains close to the equilibrium curvature based capillary pressure value for a tube laplace pressure under all flow conditions next our micromodel simulations predicted that the interface capillary pressure saturation relation remains bounded for all capillary numbers i e the interface capillary pressure is not noticeably affected by changing the capillary number in comparison to immiscible displacement in a capillary tube during drainage in a micromodel the fluid phases are not always connected to the reservoirs and disconnected interfaces can be obtained the interface capillary pressure accounts for the pressures of disconnected fluid phases such as trapped blobs having high phase pressures which is not reflected in the total pressure drop pio even at equilibrium additionally in a micromodel different displacement patterns can result depending on the capillary number and transient flow conditions dynamic and quasi static and this will in turn impact the capillary pressure saturation relation we show that the interface capillary pressure saturation is invariant of transient flow conditions but only as long as the invasion patterns are identical here again the total pressure drop heavily depends on the viscous losses in the domain which can greatly skew laboratory measurements as a last step dynamic drainage is simulated in a large porous medium rev scale for five capillary numbers spanning three orders of magnitude from the drainage simulations the average interface capillary pressure pinterface is computed and compared to the total pressure drop across the porous medium pio even for the lowest capillary number considered ca 1 2e 5 the total pressure drop is dominated by the viscous pressure head owing to the large size of the domain this demonstrates that the viscous pressure losses are not only a function of the invasion speed but can be a significant factor in large domains thus the total pressure drop varies significantly with a change in capillary number increasing as a function of the injection velocity in contrast the interface capillary pressure saturation relation did not exhibit a direct dependence on the capillary number traditionally the pc sw relationship is measured under equilibrium conditions from quasi static flow experiments and is used as a constitutive relation in darcy scale simulators to model dynamic non equilibrium porous media flows this approach is only valid if the pc sw relation is independent of the flow conditions joekar niasar hassanizadeh 2012 in literature theoretical and pore network modeling studies have always regarded that the non equilibrium capillary pressure saturation curves are not unique and depend on capillary number hassanizadeh et al 2002 joekar niasar hassanizadeh 2012 in this study using high resolution direct numerical simulations dns a pore scale interface capillary pressure saturation relation is calculated as a direct measure of the capillary forces at a fluid fluid invasion front this pore scale interface capillary pressure depends only on the pore morphology shape and interfacial energy of the two fluids at an interface and ignores the viscous dissipation such a calculation is made possible by the readily available pressure field throughout the computational domain in a dns which eliminates the need to make any approximations in estimating the curvature of an interface a challenge faced by experimentalists we show that the interface capillary pressure saturation relation is almost invariant of flow conditions dynamic and quasi static for a given flow process drainage if the fluid fluid interface pressure differences are measured at the pore scale and averaged appropriately that is the interface capillary pressure saturation relation will not depend upon the flow conditions dynamic and quasi static as long as the invasion patterns are identical however immiscible displacement patterns in a porous medium can vary depending on not only the capillary number but also the flow conditions dynamic and quasi static if the dynamic and quasi static flows yield different invasion patterns this will in turn impact the interface capillary pressure saturation relationship because the fluids invade a different set of pores this is an important insight and questions the traditional practice of using quasi static equilibrium based macroscopic pc sw curves for dynamic simulations also in stark contrast to the traditionally measured macroscale capillary pressure saturation relation the interface capillary pressure relation does not exhibit a direct dependence on the capillary number and the flow conditions this may eliminate the need for separate capillary pressure saturation curves under non equilibrium and equilibrium conditions finally it is important to note that the interface capillary pressure saturation relation can be computed from a numerical simulation instead of experiments and utilized directly in existing macroscale continuum based solvers while the porous media considered in this study are quasi two dimensional and may not have all the complexities found in a real porous medium we expect the fundamental learnings from this study to extend to real porous media as well credit authorship contribution statement santosh konangi conceptualization methodology investigation data curation writing original draft nikhil k palakurthi conceptualization methodology writing review editing nikolaos k karadimitriou conceptualization writing review editing ken comer conceptualization supervision writing review editing urmila ghia supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments nikolaos karadimitriou was funded by deutsche forschungsgemeinschaft dfg german research foundation under germany s excellence strategy exc 2075 390740016 nikolaos karadimitriou would also like to thank the deutsche forschungsgemeinschaft dfg german research foundation for supporting his work by funding sfb 1313 project number 327154368 the authors would like to thank the anonymous reviewers for their insightful questions and feedback which have helped improve this manuscript supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103792 appendix b supplementary materials image application 1 image application 2 appendix a representative elementary volume rev in order to determine if the domain is a representative elementary volume rev starting from the center of the domain the porosity of square lattices is computed by increasing the length of the lattice by a factor of 1 5 each time fig a 1 shows the variation of porosity as a function of lattice size volume next the permeability is calculated for three lattices of size 5mm x 5mm 10mm x 10mm and 50mm x 10mm the variation of permeability between the three lattices is less than 1 indicating that a lattice of size 5mm x 5mm may represent an rev based on both the porosity and permeability calculations it is determined that a lattice of dimensions 6mm x 6mm approx will be a rev thus the porous medium has about 8 revs in the x direction and almost 2 revs in the y direction any average properties calculated from this domain will apply to the darcy scale lastly based on the permeability k 4 95e 11m2 this porous medium corresponds to a highly fractured rock 
357,in this paper we identify cropping pattern as a major policy variable a framework for the generation of alternative cropping patterns acps in arid regions called acpar is developed for assessing water and food security acpar is applied to the case study of egypt for which a simulation based national water food and trade nwft model exists acpar is formulated to minimize the agricultural water demand food imports and the economic cost of imports as well as maximize the national gross margin of agriculture these four objective functions are optimized to generate acps that have different tradeoffs additional filtering criteria are employed to account for fertilizer use as well as the stability of the set objectives the acps are generated and evaluated for the baseline period 1986 2013 as well as under future conditions up to the year 2050 the results show that acpar is useful for proposing acps that could have worked better for egypt during the baseline period but also acps that outperform the historical cropping pattern in each objective function for wide future conditions some of the generated future acps can perform well regarding irrigation water use and cost of imports without compromising food self sufficiency the quantified tradeoffs between the identified objective functions are the key contributions of this study representing important information for policymakers to aid in water resources planning the acpar framework connects national water resource management decisions to global food production consumption and trade dynamics keywords cropping pattern planning global food trade food production virtual water trade national water resources management egypt 1 introduction globally agriculture utilizes 50 of the habitable land area and 70 of the freshwater withdrawals for irrigation bruinsma 2017 the growing population and global economy are leading to stresses on the limited natural resources available for agriculture the increasing food demand necessitates the exploitation of more resources which are challenged by increasing urbanization and pollution rates that lead to deterioration of both the quantity and quality of land and water resources degefu et al 2018 these finite resources are further subjected to increasing competition for different uses projecting a world that is more susceptible to water and food shortages climate change poses additional threats pastor et al 2019 steffen et al 2015 as it might increase water demand and decrease water supply in various regions agricultural growth in arid and semi arid regions where land reclamation for agriculture is conditional on water availability is subjected to the greatest water constraints in these areas water is already insufficient to cover various national uses as a result agricultural production is less likely to meet consumption demands resulting in food gaps and creation of economic burdens that hinder the socioeconomic growth of developing countries schmitz et al 2013 d odorico et al 2019 developing countries around the world are challenged in this way with 48 of the land area of struggling economies lying in hyper arid and arid areas figure s1 1 in the last century the increased food production and liberated trade policies contributed to significant increase in global food trade d odorico et al 2014 which in turn benefited arid and water poor countries as for those countries importing food from the global market represents a better option when compared to the economic and physical constraints of transferring physical water to increase their local food production when food is traded the water consumed to produce this food is virtually traded as well tamea et al 2014 around 22 of global water used in agriculture is traded in virtual form hoekstra and chapagain 2008 dalin et al 2012 virtual water trade vwt participates in filling the persistent water and food gaps of water poor countries which is thought to reduce conflicts famines and massive emigrations allan 1998 however the increasing dependency on food trade vwt increases the risks of food shortage at times of market disruptions puma et al 2015 there is a strong need to consider food and virtual water trade dynamics when planning for national water resources abdelkader et al 2018 the invisibility of virtual water and the difficulty of connecting it to its consequences on the national scale remains a major challenge gawel and bernsen 2013 on the global scale the potential for expansion in agricultural land area is very limited tilman 1999 as it comes with significant environmental costs foley et al 2005 states might enhance and maximize the benefits of currently cultivated land garnett et al 2013 hence the optimal use of scarce water resources to maximize economic gains and strengthen food security without compromising other water uses including environmental considerations is important for future agricultural planning falkenmark 2006 jgermeyr et al 2016 unfortunately many water scarce countries suffer from lack of proper agricultural planning and resource management dalin et al 2017 show how some water scarce countries overexploit their non renewable water resources for short term economic gains through crop exports moreover the lack of basin cooperation and mismanagement of rainfall water in transboundary river basins such as the nile basin prevents the basin countries from achieving greater basin wide economic gains and better food self sufficiency siderius et al 2016 several studies show that more food production with higher profits can be achieved vico and porporato 2011 and in some cases with less water use smilovic et al 2018 davis et al 2017 water scarce nations desperately need to manage their limited water resources wisely while enhancing agricultural benefits but these are seemingly conflicting objectives as the agricultural sector is usually the major water user cropping pattern is a critical agricultural variable that is connected to different socioeconomic and environmental aspects crops differ in their water requirements profitability use of fertilizers and relative demand thus selecting one cropping pattern over others could have multiple consequences that should be considered while making planning decisions cropping pattern planning refers to the problem of distributing crops over a specified land area while considering three essential components i representation of the biophysical processes underlying crop production system ii definition for the objectives of the stakeholders under consideration and iii inclusion of constraints that exist on the crop production system dury et al 2012 the problem is extensively discussed in diverse forms but mostly simplified in the form of linear relationships between the decision variables and the objectives and constraints jothiprakash et al 2011 however other studies argued that non linear forms provide results that are more accurate and consistent with reality benli and kodal 2003 in early formulations of the problem only a single monetary objective to maximize economic profits or minimize production costs was considered heady 1948 louhichi et al 2010 benli and kodal 2003 lately as stakeholders became more interested in other non economic objectives the problem was formulated by considering various objectives usually in a bi objective form as to maximize the irrigation water saving and to maximize the economic returns ghazali et al 2018 wang et al 2012 reddy and kumar 2008 highlighted the possibilities of maximizing irrigation net benefit while maximizing irrigated area under water supply deficit nouri et al 2020 indicated that cropping pattern changes for the litani basin in lebanon would decrease the water demand for agriculture increase food production and increase agriculture economic returns davis et al 2019 showed that shifting the indian cropping pattern to increase cereal production would increase the nutrition value of food supply reduce the demand for water and other resources reduce greenhouse gas emissions and enhance the resilience to climate change without the need to increase the cropland area schyns and hoekstra 2014 concluded that partial relocation of crops would significantly save water compared to national water demand reduction plans in morocco other studies incorporated the growing awareness of environmental aspects in the cropping pattern planning problem karandish et al 2020 dogliotti et al 2005 minimized the environment exposure to pesticides and nitrogen surplus and femeena et al 2018 minimized the nutrient load reaching the freshwater system while minimizing crop production costs interestingly in the reviewed literature it was noted that there is less focus on multiobjective problem formulations sarker and ray 2009 in such complex problems neglecting the higher dimensionality of conflicting objectives i e considering fewer objectives than required would result in several types of decision bias hogarth 1981 gettys and fisher 1979 hence considering the cropping pattern planning in a multiobjective context would minimize the possibilities of misleading decisions brill et al 1990 the cropping pattern planning problem is typically solved using numerous methods but mostly optimization dury et al 2012 linear programming lp was commonly used to solve single objective problems because of its simplicity however it fails to solve non linear and discontinuous problems vedula and rogers 1981 lp was extended into goal programming gp which is commonly used to solve multiobjective linear problems however it requires selecting multiplier weights or target values for the objective functions before optimizing them which is always challenging to decision makers sarker and quadus 2002 recently many modifications were considered for lp and gp to improve their performance and reduce their limitations but more importantly evolutionary optimization algorithms eas were introduced as a substitute that can overcome deficiencies of lp and other traditional methods nicklow et al 2009 eas are not limited to a specific mathematical formulation as the case of lp but can even solve non linear discontinuous and non differentiable functions yao 2002 in contrast to gp multiobjective evolutionary optimization algorithms moeas are considered a posteriori decision support tools as they adopt the concept of pareto optimal solutions that present the explicit tradeoffs between the conflicting objective functions before the decision makers express their priorities and preferences moreover they use a population of evolving solutions thus perform simultaneous optimization of conflicting objective functions and generate many solutions in a single run king and rughooputh 2003 accordingly moeas are powerful tools that can be used in solving multiobjective cropping pattern planning problems there is a large body of literature and models available for cropping pattern planning nevertheless the majority of them are concerned with bi objective formulations in the form of direct economic benefits of crop production while maximizing irrigation water saving at a small scale i e farm or district level however in arid countries future cropping pattern planning is crucial not only to save water and maximize direct profit but also to enhance food security and economic stability at the national level all the while not compromising the environment and other water users e g municipal industrial power generation therefore the objective of this study is to introduce a more comprehensive national cropping pattern planning framework that adopts the understanding that water is a global resource that is being virtually traded there are implications of such trade on national water and food security and the complex interrelationships between food security and other national development plans that rely on water the framework for the generation analysis and assessment of alternative cropping patterns in arid regions acpar is introduced in this paper as a multiobjective framework that aids policymakers in water and food security assessment and management acpar takes into account the major non agricultural water uses that might be associated with national development scenarios the globalization of water through the food virtual water trade and the performance of the proposed solutions under possible national and global changes 2 egypt the imbalance of supply and demand egypt is located in northeast africa and has a total land area of 1 106 km2 94 of which is uninhabited desert and the remaining 6 is cultivated agricultural and urbanized land egypt s climate is characterized by hot dry summers and mild winters internal water resources are very limited and rainfall is irregular and very low with an annual average of 50 mm year leading to rainwater harvesting of only 1 3 109 m3 year fao 2018a mwri 2010 in addition egypt withdraws 2 109 m3 year from its fossil deep groundwater aquifers and desalinates 0 2 109 m3 year of seawater the majority of egypt s freshwater resources 97 flow from upstream countries into egypt via the nile river in 1960 egypt built the high aswan dam to control its nile water share of 55 5 109 m3 year mwri 2010 under the pressure of water insufficiency egypt recently increased its water uses by increasing both the reuse of agricultural drainage water and abstraction from shallow groundwater aquifers egypt currently reuses a total of 16 109 m3 year and withdraws 6 2 109 m3 year of its 8 4 109 m3 year shallow groundwater safe yield abdelkader et al 2018 mwri 2010 according to the egyptian ministry of water resources and irrigation mwri agriculture is the biggest water user amounting to 67 109 m3 year followed by municipal water uses of 9 109 m3 year and industry withdrawals of 2 109 m3 year mwri 2010 agriculture is an important sector of the egyptian economy that contributes 14 5 of the gross domestic product of 287 billion usd and employs 25 of available egyptian manpower capms 2017 fao 2018a the major part of egyptian agriculture aims to produce food where 94 of the cultivated land is used for food production that is mainly supplied locally as only 3 of the national food production is exported fao 2018b in recent decades crop yields have increased significantly leading to an increase in national food production from 40 106 tonnes year in 1986 to 95 106 tonnes year in 2013 despite these increases egypt s food self sufficiency i e the ratio of food produced domestically to the total food consumed in egypt for the period between 1986 and 2013 was kept fixed at 80 but with a drop in the national water self sufficiency i e the ratio of national water supplied for all uses to all national water demands including net virtual water import from 81 to 70 over the same period abdelkader et al 2018 2003 fao 2018b however the national water food and trade nwft model developed by abdelkader et al 2018 projects alarming levels of deteriorating water and food security in egypt to an average level of 50 self sufficiency by 2050 due to sharp increases in population and water demand clearly the agriculture sector that is currently constrained by water availability is incapable of fulfilling the exponential increase in national food demand which will lead to an increase in the nation s food virtual water imports the egyptian food consumption pattern is highly reliant on agriculture based food where 98 of the per capita daily calorie intake comes from agriculture sources fao 2018b accordingly population growth has a compounding effect that causes the water and food gaps to increase non linearly that is the demand for food will increase while agriculture food production decreases due to the decrease in water availability caused by withdrawing more water for municipal and industrial uses which have higher priority for water allocation mwri 2010 egypt now depends heavily on imported food mainly cereals to fill its growing food gap the country is one of the world s biggest importers of wheat with such imports covering 40 of its wheat consumption fao 2018b improving food self sufficiency in egypt will be challenging in the future as it might require more water availability the potential for increasing internal water resources in egypt is very limited and increasing external water resources through the transboundary nile flows is an issue lying at the heart of a difficult debate and diplomacy given the growing competition over the utilization of nile water resources among all riparian countries swain 2011 egypt s dependence on food imports could alleviate the water food security problem however it comes with high risks associated with domestic and global economics e g price shocks and global trade reliability and stability egypt can seek solutions by managing and planning some of its agricultural sector variables cropping pattern is a major decision variable in agriculture that influences economic and water conditions in the country hence considering cropping pattern planning should take priority in remediating the anticipated water and food crises of egypt egypt is an ideal case to demonstrate the proposed acpar framework due to its aridity and the effect thereof on national water and food security the nation s position at the heart of the conflict over nile river water the availability of three documented national target water resources scenarios up to 2050 developed by the egyptian government mwri 2010 tables s1 1 and s1 2 and the ability of the nwft model to handle egypt s water food nexus abdelkader et al 2018 and its connection to the global virtual water trade although the government does not have full control over the cultivated crops suitable policy instruments and awareness programs could motivate farmers to adopt crop changes for example in 2018 the government regulated the cultivation of rice as a water intensive crop however the extended and long term impact of such policies on economic and water resources conditions has not been addressed 3 methodology acpar is a hybrid policy driven optimization simulation framework that aims to assist decision makers in policies that shape the national cropping pattern the framework incorporates an approach for cropping pattern planning process which can be used to investigate policy change consequences on the national long term hydro economic and water food security states while taking into considerations the national water development plans and the global food trade dynamics it consists of i identifying the objective functions to be optimized in a multiobjective functions approach ii generating initial random population of alternative cropping patterns acps that represent diverse feasible cropping patterns iii executing the simulation based nwft model to evaluate the objective functions iv using multiobjective optimization algorithm in an iterative mode to keep perturbing and evaluating the acps until a preset maximum number of iterations is met and a set of pareto optimal acps are finalized over the baseline period 1986 2013 in our case study 200 pareto optimal acps were generated v identifying additional filtering criteria that can be specified by decision makers to narrow down the acps into a smaller and more manageable set this filtering process provides decision makers with flexibility regarding their criteria of choice and their threshold values and it aims to allow them to intervene in making selections fig 1 depicts the acpar procedures as outlined above the framework is configured to be executed under baseline conditions to understand the system under consideration and repeated under future conditions to identify changes from the baseline and make planning decisions different types of analyses were used under both conditions as explained in more details in the sub sections below the optimization method explanation and its parameterization process are provided in section s1 3 of the supplemental file 3 1 the national water food and trade nwft model the nwft model fig 2 is a national water and food supply and demand model in which the economic and population growth rates along with per capita water demands are considered while estimating the annual water demands of municipal and industrial sectors the model allocates available water annually according to supply priority rules in which municipal followed by industrial sectors are allocated water first then the agriculture sector can access the remaining water the model considers the cropping pattern as a sole decision variable and once it is determined the nwft model estimates water demand for agriculture taking into consideration crop water requirements and annual irrigation efficiency subsequently this water demand for agriculture is compared against the annual water available for agriculture and accordingly crop yields are revaluated to account for water deficit s effect on crop yield doorenbos and kassam 1979 using this estimated crop yields and the cropping pattern the nwft model calculates the annual national food production on the other hand the national food consumption demand is estimated based on per capita food consumption pattern population and economic growth rates at this step the national food trade can be calculated by comparing the national food production and consumption quantities where food imports are estimated as the deficit in demand compared to production and the food exports as the surpluses of production compared to demand those traded food quantities are translated to virtual water import and export in addition the model considers also the economic and environmental consequences of a cropping pattern change the agriculture gross margin and economic costs of imports are evaluated while the national fertilizer application rate is calculated within the environmental component of the nwft model in performing the above mentioned calculations the model uses a group of key variables some of them were inevitably constrained to account for resources availability limitations those variables and their constraints are explained in section s2 1 and table s2 1 moreover sections 3 2 and 3 4 present the major calculations performed in the nwft to estimate the values of all objective functions and filtering criteria while all the detailed methods and equations used in nwft calculations along with the model validation can be found in abdelkader et al 2018 3 2 objective functions and decision variables four hydro economic objectives were selected to reflect the interests of decision makers in the conflicting objectives of maximizing national economic benefits while saving more water and maximizing food security as follows 1 gross margin gm usd year within the agriculture sector which is defined as the difference between the revenue of a crop market price and the variable production costs brink and mccarl 1978 in this study the gm objective function was evaluated annually and maximized eq 1 based on the average value over the entire simulation period the gm was calculated as the summation of the national product of crops tonnes multiplied by the net revenue usd tonne based on the local market price the global market price was used for the portion of crops that was exported data related to local and global prices of crops consumed and produced in egypt were gathered from the faostat database fao 2018b the variable costs of crop production were retrieved from the egyptian ministry of agriculture and land reclamation malr 2016 2 economic cost of imports eci usd year which is the cost of imports of each crop expressed as the price of each crop in the global market multiplied by the quantity of the imported crop then summed over all crops the simulation period average eci was minimized in this study eq 2 this excludes transportation costs and any taxes or duties 3 the national annual water demand for agriculture wda m3 which was calculated as the crop water requirement multiplied by the crop area summed over all crops this objective function was minimized eq 3 to rationalize the water use in egypt and 4 the virtual water import vwi m3 which is the amount of water consumed to produce the imported crops water footprint of imported crops the rationale behind this function is to reflect the country s reliance on imported food and the global trade to maximize egypt s food self sufficiency this objective function was minimized eq 4 it also represents egypt s global responsibility to minimize any overexploitation of global water resources the nwft model can estimate both annual wda and vwi 1 m a x i m i z e g m t t 0 t i 1 n p l i t v c i t y i t a i j t p g i t p l i t e x p i t t t 0 1 2 m i n i m i z e e c i t t 0 t i 1 n i m p i t p g i t t t 0 1 3 m i n i m i z e w d a t t 0 t i 1 n c w r i j a i j t t t 0 1 4 m i n i m i z e v w i t t 0 t i 1 n v w i i t t t 0 1 where t0 and t are the first and the last year of the simulation period respectively n is the total number of crops pli t is the local market price of crop i in year t usd tonne vci t is the variable costs of production for crop i in year t usd tonne yi t is the estimated crop yield subject to the amount of available water for crop i in year t tonnes ha doorenbos and kassam 1979 aij t is the area assigned to crop i in cropping season j in year t expi t is the national exported quantity of crop i in year t tonnes pgi t is the average global market price of crop i in year t usd tonne impi t is the national imported quantity of crop i in year t tonnes and cwrij is crop water requirements for crop i in season j m3 ha the set of decision variables x shown in eq 5 is the cropping pattern which comprises the percentage of each crop area xi of the total land available for a number of crops n which are 14 major crops and crop groups for the case of egypt the land available for agriculture can change from year to year and is affected by urbanization razing and reclamation rates the cropping pattern i e x was assumed fixed throughout the simulation period for a particular simulation run the purpose of optimization was then to find the optimum pattern through the whole simulation period given the predetermined constraints 5 x x i x n x i 0 1 3 3 the optimization method acpar incorporates a method named uniform spacing multiobjective differential evolution usmde chichakly and eppstein 2013 which comprises a synergy of good features compiled from different eas usmde s basic algorithm is differential evolution de which is a single objective search operator that proved to converge significantly faster compared to other eas storn and price 1997 the usmde can solve multiobjective problems as it adopts the features of the well known algorithm of non dominated sorting genetic algorithm ii nsga ii deb et al 2002 however the main advantage of usmde to decision makers is that it expresses the tradeoffs between the objective functions in more diverse and consistent way compared to other methods chichakly and eppstein 2013 accordingly the usmde was considered an appropriate choice for the acpar framework however it requires proper parameterization to generate reliable pareto optimal solutions and in this study we performed a parametrization exercise for acpar and its application to egypt as explained in details in section s1 3 this parameterization process concluded that acpar should produce 200 pareto optimal acps in order to be accurate and well representative of the search space the 200 acps can be reduced further using policy driven filtering criteria 3 4 filtering criteria filtering criteria represent a group of variables that are of specific interest to decision makers however they are less important than objective functions thus rather than including them as objective functions and increase the dimensionality of the problem decision makers would rather be interested in monitoring their values and compare them against satisfaction thresholds i e filtering criteria filtering criteria are meant to be flexible so they can be set after the acps are generated and used to reduce their number to a manageable set that represents the acps of the most interest to decision makers there could be many trials of setting the filtering criteria and filtering the generated acps until the decision makers are satisfied with the resulting ones four variables were selected in this study as filtering criteria due to their significance and relevance two of them secure a pre determined level of economic stability the stability of agricultural gross margin gms and the stability of the costs of food imports ecis which are of high importance for proper economic planning in a country like egypt with a less advanced economy in the objective functions we considered the period averaged gm and eci which represent the average of annual values over the baseline period of 28 years 1986 2013 as well as for the future scenarios 2014 2050 in the filtering criteria we set a threshold table 1 for the coefficient of variation cv of both gm and eci which is the standard deviation divided by the average value gms and ecis lower gms and ecis values indicate less inter annual variability which reflects less uncertainty the third filtering criterion is national food self sufficiency nfss kcal kcal which is defined according to eqs 6 and 7 given the increasing food imports of egypt abdelkader et al 2018 it is important to select cropping patterns that do not lead to significant deterioration of egypt s nfss table 1 the last variable is the nation s average fertilizer application per unit area nfar kg ha which is estimated using eq 8 the fertilizer application rate in egypt is one of the highest in the world potter et al 2010 and this has negative effects on surface water quality and therefore human and aquaculture health hence selecting cropping patterns that have lower fertilizer rates is environmentally desirable 6 n f s s t n a t i o n a l f o o d c o n s u m p t i o n t i m p o r t e d f o o d t n a t i o n a l f o o d c o n s u m p t i o n t 7 n f s s t t 0 t n f s s t t t 0 1 8 n f a r t t 0 t k 1 3 i 1 n f a r i j k t a i j t t t 0 t a i j t where farijk t is the fertilizer application rate tonne ha fao 2005 of fertilizer nutrient k for crop i in cropping season j in year t n is the total number of crops and aij t is the cultivated area ha of crop i in cropping season j in year t the values in table 1 were selected somewhat arbitrarily in this study to demonstrate the method however the values were meant to avoid major or unrealistic changes in the current agricultural practices in egypt the national fertilizer application rate kg ha was set to not exceed the historical level by more than 15 the food self sufficiency to not go below 75 of the historical level and the inter annual variability coefficient of variation of the eci and the gm to not exceed the historical value and 80 thereof respectively 3 5 implementation of the acpar framework the considered 14 crops and crop groups table s2 2 were assigned to two major cropping seasons as practiced in egypt so they can compete with their realistic substitutes during the implementation of the acpar framework the framework was applied for the baseline period 1986 2013 and generated 200 acps whose performances were normalized i e scaled between 0 and 1 relative to the maximum and minimum objective function values to easily evaluate them against each other the normalized value of an objective function was estimated to ensure that improvements to the objective functions occur when the value approaches 1 0 eq 9 thus the calculation method depends on whether the objective function is minimized i e wda eci and vwi or maximized i e gm the normalized acps were then analyzed clustered into groups and compared with historical cropping patterns hcps in egypt the acps were reduced further using the filtering criteria and were analyzed to understand how cropping pattern changes affect the national hydro economic state 9 n u y max u u y max u min u i f u i s m i n i m i z e d u y min u max u min u i f u i s m a x i m i z e d where n uy is the normalized value of objective function u for pareto optimal solution y  1 2 200 n uy  0 1 the acpar framework was also implemented under future scenarios of change considering both national and global change conditions three different national target scenarios that represent three possible combinations of national water resource availability water supply and demand socioeconomic development plans improvements in infrastructure and population growth up to year 2050 were used critical balanced and optimistic abdelkader et al 2018 modified the per capita food consumption pattern of the balanced and optimistic scenarios to reflect the impact of socioeconomic changes on food demand in egypt in this study we added the changes to the crop yield and crop production losses to match the degrees of economic growth reflected by each scenario and its impact on the food production system details of the three scenarios as well as the baseline scenario are provided in tables s1 1 and s1 2 the study required future global and local crop prices projected until the year 2050 which were available through the international food policy research institute ifpri 2017 the ifpri used the international model for policy analysis of agricultural commodities and trade impact robinson et al 2015 model which connects global shared socioeconomic pathways ssps and the ipcc s climate change scenarios to water availability and food supply and their effect on market prices to project future scenarios of global crop prices table s1 1 and s1 3 show the scenarios available through impact and considered in this study along with their major assumptions other scenarios are available through impact but those adopted in this study cover the whole range combining the three national scenarios of egypt with the four global scenarios considered resulted in a total of 12 different future scenarios to be investigated table s1 4 projections of local prices in egypt are not available however based on correlations detected between the local and global prices over the baseline period regression models were developed to project the local prices of various crops in the future based on the projected global prices examples of the regression models are presented in section s2 3 figure s2 1 acpar implementation under future conditions included similar steps as for the baseline but repeated for the 12 scenarios through optimization under each of the 12 scenarios the pareto optimal 200 acps for each scenario were identified those acps were further narrowed down by applying the filtering criteria to the 200 solutions of each scenario separately the filtered acps of the future from all scenarios were grouped with the filtered acps of the baseline period to form one group of acps to select an acp while addressing future uncertainty we adopted the concept of planning under uncertainty which is widely used in water resources research e g maier et al 2016 the evaluation and selection of any acp would not be based on its performance under any single scenario but under all 12 scenarios in particular each acp was evaluated based on the mean of its objective function value calculated across the 12 scenarios and based on the robustness of each objective function under those future scenarios this process necessitated that each of the filtered acps be simulated in the nwft model to estimate its objective functions under each of the 12 future scenarios then for an acp y the mean of its objective function u y across scenarios i e m uy was calculated using eq 10 there are many ways to define and estimate the robustness herman et al 2015 however all of them reflect that robust plans should be insensitive to future conditions maier et al 2016 we evaluated the robustness r u y of an acp y for each objective function u according to eq 11 as the number of scenarios under which the performance of y is satisfactory for objective u sn uy relative to the total number of scenarios under consideration st which is similar to the measure used by paton et al 2014 under any scenario s an acp y is considered to have satisfactory performance in objective function u only if the value of u y under this scenario us y does not violate a global threshold determined by decision makers valid for all scenarios i e uth this threshold could be a desired future value for this objective e g a minimum target gross margin of 35 billion usd year 10 m u y s 1 s t u s y s t 11 r u y s n u y s t 12 s n u y s 1 s t 1 u s y u t h i f u i s m i n i m i z e d s 1 s t 1 u s y u t h i f u i s m a x i m i z e d where us y is the objective function of acp y evaluated under scenario s st is the number of scenarios under consideration i e 12 scenarios sn uy is the number of scenarios under which the objective function u of an acp y meets a threshold criterion uth 4 results and analysis 4 1 baseline application of the acpar framework the optimization of cropping patterns during the baseline period 1986 2013 resulted in 200 pareto optimal solutions acps the normalized values of the objective functions were used for comparison of the 200 acps where 1 0 and 0 0 denote the best and worst outcomes respectively the absolute values of objective functions were used to express the differences in magnitudes between the filtered acps 4 1 1 the objective functions tradeoffs fig 3 illustrates the tradeoffs among cropping pattern objectives for the case of egypt during the baseline period and it shows that the normalized gross margin improvement approaches 1 0 can be achieved with improvement of water demand for agriculture approaches 1 0 meaning less water demand and more water savings nevertheless bubble colors turning into red and sizes become bigger meaning higher eci and more vwi respectively thus water saving cropping patterns are those that can come with high agriculture gross margin but they lead to higher costs of food imports and higher virtual water of imports which means less food self sufficiency 4 1 2 clustering analysis to understand the link between various cropping pattern compositions and their corresponding objective function tradeoffs the pareto optimal acps were clustered into three distinguished groups using the k means clustering method the k means started by randomly assigning centroid values for the three clusters i e random location in the 4 dimensional objective function space then based on the acps objective function values they were assigned to their nearest cluster identified by its centroid iteratively the new cluster centroids were recalculated and then the 200 acps are reassigned to the nearest cluster until the centroids do not change the dashed lines on fig 3 indicate the three acp groups where each group represents a tail end condition in at least one of the objective functions fig 4 is complementary to fig 3 as it shows the corresponding crop compositions of each group both figures implicitly reflect the existence of three thematic alternatives with some exceptions that characterize cropping pattern planning for egypt the first cluster contains more wheat than fodder crops both are competing for land as they are cultivated in the same season while maintaining a balanced ratio distribution of other crops group 1 this enhances food self sufficiency lowers vwi and decreases eci but also leads to higher wda and lower gm the second cluster contains cropping patterns that have more fodder crops than wheat and significantly higher percentages of other cereals group 2 this would yield the maximum water savings as other cereals and fodder crops require relatively less wda while maintaining moderate gm because of the relative higher profitability of fodder crops in the local and global markets the last cluster contains cropping pattern similar to the second one but rather than the relatively high ratio of other cereals it contains significant vegetables ratio group 3 this would yield the highest gm because of fodders and vegetables high profitability while maintain moderate water savings however the undesirable aspects of groups 2 and 3 are the increase in vwi and eci meaning more costs of food imports and less national food self sufficiency as figs 3 and fig 4 show the first group was practiced during the historical period 1986 2013 the historical cropping pattern hcp of egypt falls in group 1 and has the lowest eci when compared with the 200 acps this reflects that the collective decisions of stakeholders i e farmers and decision makers in selecting historical cropping patterns in egypt seem to have been influenced by local market food demands and prices leading to cropping patterns that favor reduced food import costs and maintain high food self sufficiency even though it required high wda and yielded lower gm compared to other acps 4 1 3 narrowing down the set of feasible alternatives the 200 acps produced are considered equally good unless decision makers preference structure is identified as it might be difficult to select from this large number of solutions additional filtering criteria explained in detail in section 3 were used to keep only the acps that are of most interest applying the filters resulted in 19 solutions presented in figure s3 1 which all turned to belong to group 1 as the hcp the filtering criteria ensured that the acps show economic stability and acceptable fertilizer application and food self sufficiency a visual comparison between the 19 filtered acps and the hcp is given in fig 5 and figure s3 2 in the supplemental file which show that the hcp is superior with respect to its low eci and vwi values but moderate with regard to the wda and is the worst with respect to both the gm and gms this can be attributed to the fact that unlike the generated acps the hcp is not a fixed cropping pattern through the 28 years of the baseline period the major change was the gradual replacement of cotton i e part of non food by vegetables because of their relatively higher profitability leading to higher variation in the gm thus making it a less stable option with a lower period averaged value the filtered acps reflect different levels of tradeoffs between the objective functions but acp 18 in particular has interesting characteristics this alternative would have been a good substitute for the hcp acp 18 has food self sufficiency nfss and eci that are comparable to the hcp it could have slightly improved the food self sufficiency form 80 to 82 and slightly increased the eci from 4 3 to 5 4 billion usd year however it would have significantly increased the gm from 17 2 to 19 9 billion usd year i e net gain of 1 6 billion usd year and maintained better stability for gm and eci two disadvantages for this acp are the increased demand for water increase of 5 109 m3 year and the slightly higher fertilizer application rate increase of 35 kg ha year see figure s3 2 the major difference between acp 18 and the hcp is more wheat and fodder crops and less non food crops and pulses details of the cropping patterns are provided in table s3 1 acp 2 is another remarkable acp it would have been desired if the gm and saving water were given priority over having a high food self sufficiency and low eci acp 2 would have increased the gm of the hcp from 17 2 to 22 6 billion usd year but also increased eci from 4 3 to 8 5 billion usd year and maintained better stability for gm and eci moreover it would have saved 1 3 109 m3 year of agriculture water but at the cost of increasing the vwi by 6 5 109 m3 year there are two major disadvantages of this acp it would have decreased food self sufficiency from 80 to 69 and increased fertilizer application rate by 26 kg ha year the major changes of this cropping pattern compared to the hcp are the significant increase in fodder crops and other cereals and the decrease of wheat rice non food fruits and pulses table s3 1 analyzing cropping patterns in the baseline period provides information on what could have been done in the past to reach desired water economic environmental and food self sufficiency states 4 2 application of the acpar framework under future scenarios the 19 filtered acps of the baseline period as well as the hcp are not necessarily suitable solutions for the future thus to search for acps that might be superior under future conditions the simulation optimization framework was repeated under the 12 future scenarios for the period between 2014 and 2050 through optimization there were 200 future acps generated under each scenario i e 2400 in total those 2400 acps were further narrowed down by applying the filtering criteria on each scenario separately consequently a total of 460 filtered acps were finalized from all 12 scenarios those 460 acps were grouped with the 19 baseline acps and the hcp to form one group of 480 acps finally each of those 480 acps was simulated in the nwft model to quantify their objective function values under the 12 future scenarios for each acp the mean of each objective function across the 12 scenarios was calculated moreover to assess their response to future changes the robustness of each objective function for each acp was calculated using eq 11 in the remaining part of this section a comparison between the baseline acps including the hcp versus the 460 filtered acps of the future is provided then the impact of future scenarios on the four objective functions of the different acps is discussed finally we show how future decisions could be made to select one of the acps for consideration in future policies 4 2 1 comparison between filtered alternative cropping patterns fig 6 shows a comparison between 20 acps the hcp and 19 baseline acps versus the 460 acps found under future conditions i e future acps interestingly under future conditions the baseline acps and the hcp have lost their major advantage of having low eci and vwi the majority of the baseline acps have relatively good gm and wda values however all of them have poor vwi and eci values compared with the future acps fig 6a the reasons behind these changes are revealed by analyzing the differences in cropping patterns between the baseline and future acps our modeling framework recognizes wheat as an important crop whose area should increase in the future to maintain the superiority of an acp in the objective functions of eci and vwi wheat is an important crop for egyptians it constitutes 30 to 40 of the daily calorie intake however egypt currently has a significant shortage in its wheat production and it imports 40 of its demand under the three future national development scenarios egypt s population grows sharply table s1 2 driving egypt s demand of its most consumed and imported crop i e wheat to increase if this increase in demand is met by increasing wheat import this would negatively affect the eci and vwi accordingly to help lower the eci and vwi the local production of wheat should increase the acpar framework shows that the agriculture area allocated to wheat still needs to increase fig 6b to maintain the low levels of eci and vwi minimize cost of import and maximize food self sufficiency increasing the area of wheat would have some disadvantages wheat has a considerable water footprint some other crops require less water to produce the same tonnage and moderate profitability significantly increased in the future table s1 3 but still some other crops have higher profitability accordingly increasing wheat would likely increase the wda and decrease gm to substitute for this negative impact and keep the acps of the future able to compete on minimizing wda and maximizing gm acpar balances the increase of wheat area by decreasing the area of crops with high water footprint and less profitability such as other cereals and non food and expands the area of highly profitable crops with less water footprint such as vegetables fig 6b the only advantages of the baseline acps in the future are their low wda and high gm which do not seem to be exclusive characteristics as there are some of the future acps that have comparable or even better gm and wda values with even better eci and vwi values this comparison indicates that decision makers are less likely to favor any of the baseline acps nor the hcp in the future most probably they would increase the area of wheat among other changes indicated in fig 6b to shift toward one of the 460 acps generated under the future conditions 4 2 2 future changes in the values of egypt s objectives it is important to understand how the objective functions of the acps respond to the different future scenarios used in this study and how their values might change from their baseline conditions fig 7 reflects the average response of all the filtered 480 acps for egypt the gm seems to increase under all future scenarios compared to its baseline value this is mainly because the prices increase under all considered scenarios assuming fixed cost to price ratio section s1 2 table s1 3 additionally gm is also influenced by the quantities produced of each crop which is also increased under all future scenarios under future national development scenarios the average agricultural area crop yields and water availability increase in comparison with the baseline leading to higher crop production the greatest improvement in gm occurred under the optimistic national scenarios scenarios 9 to 12 due to the relatively greater availability of water for agriculture the largest expansion in agricultural land area and the highest improvement in crop yields interestingly the effect of climate change on gm can offset the effects of some national future developments for example the gm values under the critical scenario combined with climate change scenario 4 is as high as the national balanced scenarios without climate change scenarios 5 6 and 7 this can be attributed to the fact that food prices under the climate change scenario ssp2 hgem as predicted by the impact model are higher than other price scenarios leading to higher gm values it is important to note that the gm of the agriculture sector improved under all scenarios however before considering this as a positive outcome decision makers should also consider how the increase in crop prices are factored in this improvement and how this might affect future food affordability the increase in all four global price scenarios would increase the eci relative to the baseline the sharp increase in egypt s population embedded in all three national scenarios leads to an increase in the eci due to the increase in the food gap abdelkader et al 2018 importantly however these scenarios feature variations in food consumption patterns population growth rate and increased demand for crops while crop production is constrained by varying levels of water availability under the balanced scenario eci increases the most possibly because of the change in the food consumption pattern from a cereals based diet to one with more vegetables and meat which are more expensive climate change scenarios 4 8 and 12 always results in additional negative impacts on the eci of egypt as food prices are higher than scenarios with unchanged climate the influence of national development scenarios on the eci is higher than their effects on gm which means population growth and food consumption affect the eci more than prices fig 7 shows that the best eci future values are associated with the optimistic scenario due to the greater water availability for agriculture in egypt and the least population growth compared to other scenarios leading to lower costs of food imports the vwi and wda vary only in national development scenarios and remain unchanged under global price scenarios which is an outcome of the formulation of our model assuming that their values depend only on the national conditions development scenarios which is logical this formulation was meant to allow for investigating the effect of cropping pattern as a national policy variable on the objective functions egypt s future is obviously and significantly better under the national optimistic scenario where the key variables are a lower population growth rate which makes more water available for agricultural land expansion and a consumption diet that is less dependent on meat table s1 2 egypt s conditions are also worse under the so called balanced scenario than the critical scenario which can be attributed to a more water intensive food diet and more municipal and industrial water use under the balanced scenario that makes less water available for agriculture although future scenarios might affect the objective functions of all the 480 filtered acps in a similar direction e g make an objective function increase for all the acps the magnitude of this effect can vary largely among the acps according to their cropping pattern composition accordingly decision makers would be interested in acps that are less sensitive to deterioration under the widest portion of future conditions which we express by the robustness measure of an acp as presented in eq 11 decision makers would determine a threshold or a target for each objective function such that the robustness would measure the ability of an acp to surpass this target under the widest spectrum of future conditions for this study we determined the mean objective function values of the hcp under future scenarios see fig 6a as the threshold values of 30 2 billion usd year 75 109 m3 year 34 billion usd year and 73 109 m3 year for gm vwi eci and wda respectively in this regard the acp that is more robust in a specific objective is the one that surpasses the mean future value of the hcp in this objective for the widest future conditions more future scenarios as explained in eq 12 the robustness of acps can be investigated for each objective function separately however we found that a considerable number of the 480 acps has good robustness in all four objective functions simultaneously accordingly those acps with good robustness were isolated and considered for further analyses as they are of much higher utility for decision making this was achieved by dividing the 480 filtered acps into three groups according to their robustness i the highly robust acps which includes the acps that surpass the hcp in all objectives for more than 70 of the future scenarios robustness 0 7 for all objectives ii the moderately robust acps which includes the acps that surpass the hcp in all objectives for more than 50 of the future scenarios i e robustness 0 5 for all objectives and iii the low robust acps which includes acps not surpassing the hcp for more than 50 of the future scenarios in at least one objective only the first two groups were considered for further analyses interestingly the 19 filtered acps of the baseline were all part of the third group i e low robustness which gives an additional reason for decision makers to unfavor them for future selection fig 8 shows these two groups with good robustness both groups have acps with good performance in gross margin gm and water use wda but group 1 highly robust has lower cost of import eci while group 2 moderately robust has higher food self sufficiency lower vwi to understand what could have made an acp more robust than the other the cropping pattern of the three groups was investigated see figure s3 3 as the figure shows there is a clear overlap between the cropping patterns of the three groups thus it does not seem that there is a definite relationship between a specific cropping pattern compositions and the robustness of an acp rather robust acps are cropping patterns that come from different regions of the domain of cropping patterns 4 2 3 future planning decisions policymakers can use the acpar framework proposed in this study for crop pattern planning based on two major criteria i their preference structure regarding the objective functions and ii the consideration of future uncertainty by selecting robust acps that performs well under the widest range of scenarios for example the eci seems to have been the main decision factor in egypt fig 5 as inferred from the hcp if this situation continues in the future fig 8 can be used to select one of the acps from the two robust groups while considering this preference of low eci acp 234 is one of the possible selections under this criterion this acp is characterized by low eci value of 24 4 billion usd year compared with the hcp s 34 0 billion usd year if it continues in the future moreover acp 234 has a gm that is higher than the hcp by 6 3 billion usd year besides these economic gains this acp could also save water as it has wda value that is lower than that of the hcp by 8 0 109 m3 year and the vwi also could be decreased by 1 2 109 m3 year more importantly this acp belongs to the highly robust acps group group 1 in fig 8 meaning that its superiority over the hcp in the four objective functions is maintained for at least 70 of the future scenarios reflecting higher chances of being superior should the future come in different forms the major changes required to shift the hcp to acp 234 are a significant increase in the cultivated areas of wheat fodder and non food from 19 15 and 6 in the hcp to 26 22 and 10 while reducing fruits maize and pulses from 9 16 and 4 to 6 10 and 1 table 2 5 discussion some of the acps that we analyzed reveal crop compositions that might not be acceptable to farmers and policymakers e g eliminating particular crops as shown in tables 2 and s3 1 sudden and significant changes like this could lead to local socioeconomic costs to small farmers and industries that rely on these crops some of the crops also have multi dimensional benefits such as rice cultivation in the nile delta of egypt which is important for reducing seawater intrusion and balancing soil salinity sudden changes to rice areas could lead to severe environmental problems other crops would have an irreversibility problem for example some fruit trees once their area is reduced cannot easily increase again because it takes years to grow and become fully productive in addition shifting cropping patterns could seriously affect the nutritional health of the population in developing countries making imported crops affordable and accessible might be challenging accordingly maintaining a certain level of diversity in the cropping pattern is necessary to make diverse food find its way to small markets and to preserve the dietary intake of broader range of the population more balanced and healthy moreover cropping patterns that are selected today should be favored if they are adaptive or flexibly accept changes over time with the least negative impacts e g socioeconomic environmental thus while selecting acps it is important to consider how an acp would be easily evolving from the existing cropping pattern and also how easy it accepts multiple changes over time in our study the generated acps met all of the objective functions and the filtering criteria that we selected a priori however this multitude of other considerations can be incorporated by setting cropping area constraints within the nwft model or by adding additional filtering criteria within the acpar framework both of which are easily implementable in the current formulation of acpar we kept the cultivated ratio of each crop constant over the entire simulation period within a particular scenario another possible approach is to allow for periodic changes in the pattern e g every five years in response to changing conditions the acpar framework can be re run every five years with new conditions as a way to use the proposed framework for dynamic decision making and to reduce the uncertainty of long term planning decisions in this study there was less emphasis on the spatial representations related to cropping pattern distribution variations of input variables and model outcomes in particular variables like crop water requirements and crop prices were aggregated as national average values when there is a shortage in the water supply for agriculture it was considered as a uniform water deficit that impacts all crops in reality this shortage might only impact specific crops cultivated at the most downstream part of the water system another implication of spatial aggregation is that acpar would not be able to provide decision makers with spatial information about cropping pattern changes but only changes at the national level in a previous study we showed that such aggregations and assumptions have an ignorable impact on the accuracy of our model results regarding the annual national agriculture water demand and the national production of each crop abdelkader et al 2018 accordingly for this study we trust that this issue has insignificant impact on the calculated national objective functions of egypt however this concern remains valid especially if acpar is applied to other countries that have significant spatial variability in model variables and outcomes in such cases it is crucial to modify the acpar framework to incorporate more explicit spatial representations the filtering criteria used in this study included the coefficient of variation of the gm and eci to maintain acps with relatively more stable gm and eci over the simulation period one disadvantage of this formulation of stability is that it might penalize both the high and low values of gm and eci the use of this formulation did not affect the filtering outcomes for this case study as the filtered acps were significantly dependent on other filtering criteria i e nfss and nfar however we acknowledge the limitation of this formulation and recommend for similar studies an alternative formulation that only penalizes acps that have deviations from the mean i e period average toward undesired directions e g low gm and high eci in this paper we set the objective functions to match with the stated targets of our study which were to provide cropping patterns that can enhance the water and food security states of egypt while increasing the economic benefits our selection of the objective functions also allowed for establishing a connection between the global food trade dynamics and the national water management decisions more specifically the link between the changes of global food prices and national water management within the agriculture sector to meet the set objectives through changing cropping patterns is a key contribution of this work we acknowledge that there is no single way to set the objective functions but different forms could be used to express the same targets for example the gm eci and wda might be combined to form an overall societal utility objective that can be maximized the objective function of vwi was minimized to secure better food self sufficiency conditions and reduce egypt s burden on the global water resources such a criterion shows its importance in circumstances of disconnected world the covid 19 pandemic of 2020 is an example however it might be argued that egypt can import its food from only water rich countries accordingly this objective function can be replaced with an explicit food security metric the evaluation measures of robustness and mean of objective functions across scenarios could have been used within the objective functions rather than just evaluation and selection criteria however as the matter of selecting objective functions would always remain debatable we acknowledge that the process could be performed by including various stakeholders that are interested in national cropping pattern planning i e farmers industries etc in discussions about the determination of those objective functions and how they are formulated the government of egypt is the major stakeholder targeted in this study which is known to have policies to intervene periodically in the national cropping pattern by setting incentives and penalties to direct farmers to cultivate specific crops this might not be valid for other countries where the government has no intervention policy in shaping national cropping patterns however in such a case the acpar can be modified for example to reflect the interest of stakeholders other than the government that would benefit from the cropping pattern planning and has the control of changing it e g farmers industries as part of the future scenarios used in this study a constant price cost ratio was assumed for the estimation of the agriculture sector s gross margin in the future even though this is not an unrealistic assumption it is an important assumption to keep in mind when analyzing and understanding the results derived from the acpar framework the issue of predicting the local crop prices in egypt in the future is also related to the previous point we projected the local market price based on the global market price which is a reasonable assumption given that egypt is moving fast towards free market mechanisms joya 2017 however another option in future studies is to develop a or use an existing computable general equilibrium cge model for egypt that links supply demand and prices noting that cge models also contain several assumptions about the market mechanisms and consumer behavior and in turn the stationarity of such relationships in the future might be questionable arthur 1999 finally one should note the importance of the outcomes presented by this study for integrated water resources management in egypt under scenarios featuring shortages of nile river water flowing into egypt cropping pattern changes can reduce the amount of water needed for agriculture significantly this reduction can be even more than the governmental municipal water demand reduction plans egypt s most optimistic future scenario assumes a reduction in the future water demand for municipal uses by only 5 0 109 m3 year while acpar proposed cropping patterns that can reduce the future demand for irrigation by amounts that exceed this number see fig 8 however reducing irrigation water demands will come with the tradeoffs of increasing the cost of food imports or reducing food self sufficiency acpar was able to avoid such consequences by introducing robust acps that outperform the hcp in these objective functions when reducing irrigation water demands for wide future conditions abdelkader et al 2018 presented a quantitative analysis of the sensitivity of egypt s food gap to the scenario of reduced water availability this scenario of reduced national water availability is critical for egypt s consideration and should receive special attention in light of the heated negotiations within the eastern nile basin regarding the potential consequences of the grand ethiopian renaissance dam gerd the gerd is expected to negatively affect egypt s annual water supply especially during recurring drought periods in the eastern nile basin 6 conclusions in arid regions water security cannot be separated from food security as the requirements of agricultural crop production make the agriculture sector the major water consumer any decrease in crop production leads to a decrease in the national gross margin within the agriculture sector decline in food self sufficiency and increase in the economic cost of food imports therefore efficient management of agricultural water has a multitude of socioeconomic implications and thus is of high priority however such management must take into account the physical and socioeconomic considerations of both water and food security in this study a framework for the generation and assessment of alternative cropping patterns in arid regions acpar was developed acpar is an optimization simulation framework that was introduced to assist decision makers in comprehensive planning for agriculture by changing cropping patterns while considering the impacts on important national variables such as the water demand for agriculture wda agriculture gross margin gm economic costs of import eci and virtual water food imports vwi egypt was considered a representative case of arid regions to apply the framework generate a large number of alternative cropping patterns acps and investigate the tradeoffs among different objectives the national fertilizer application rate desired percent of national food self sufficiency and inter annual variability of the gm and eci were considered as additional criteria with threshold values that can be set by decision makers to filter the generated acps the acpar framework uses the nwft model which simulates water resources availability competing uses agricultural crop production and consumption and the food trade of egypt the framework was implemented for the baseline period 1986 2013 as well as under future uncertainty represented by different scenarios up to 2050 twelve combinations of national water and socioeconomic target scenarios and global projections of food prices subject to different shared socioeconomic pathways ssps were considered the results show that the thematic tradeoff that exists when performing the cropping pattern planning in egypt is that minimizing the economic costs of food import and maximizing food self sufficiency come at the cost of increasing agricultural water use and lowering the gross margin of the agriculture sector in the baseline period however egypt s historical cropping pattern hcp implied preferences to minimize the eci and maximize the food self sufficiency in the future the previously adopted policies of increasing total cultivated land area and improving the yields of different crops might not be enough most likely egypt would need to increase the area allocated for wheat cultivation this action increases the water demand of agriculture and reduces the agricultural gross margin which would require other cropping pattern changes such as reducing the areas of water intensive less profitable crops e g other cereals and increasing the areas of water saving highly profitable crops e g vegetables this type of changes to the hcp should be applied carefully as our results show that the performance of acps is highly dependent on the combination of cropping pattern changes performed small differences between cropping patterns could result in deteriorations or improvements of the objective functions relative to the hcp the acpar framework helps to determine robust cropping patterns that can outperform the hcp in all objective functions under wide future conditions using frameworks like acpar that consider conflicting multi objectives helps to minimize possible negative consequences of planning decisions in addition considering future and its uncertainty in cropping pattern planning proved to be significant as this helps in finding cropping patterns that can perform well under a wide range of conditions tradeoffs are easily quantifiable using the acpar framework which connects national water resource management to global food production prices and trade dynamics credit authorship contribution statement ahmed abdelkader conceptualization methodology software formal analysis writing original draft visualization amin elshorbagy conceptualization methodology writing review editing supervision project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors acknowledge the financial support of the natural sciences and engineering research council nserc of canada through the nserc dg grant 403047 author abdelkader also acknowledges the university of saskatchewan s devolved scholarship fund data used in this study are referenced in the manuscript with links to allow readers access to them the sources of data used in this study are as follows faostat http www fao org faostat en data water footprint https waterfootprint org en resources waterstat product water footprint statistics and the international food policy research institute https dataverse harvard edu dataset xhtml persistentid doi 10 7910 dvn xezxt4 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103809 appendix supplementary materials image application 1 image application 2 
357,in this paper we identify cropping pattern as a major policy variable a framework for the generation of alternative cropping patterns acps in arid regions called acpar is developed for assessing water and food security acpar is applied to the case study of egypt for which a simulation based national water food and trade nwft model exists acpar is formulated to minimize the agricultural water demand food imports and the economic cost of imports as well as maximize the national gross margin of agriculture these four objective functions are optimized to generate acps that have different tradeoffs additional filtering criteria are employed to account for fertilizer use as well as the stability of the set objectives the acps are generated and evaluated for the baseline period 1986 2013 as well as under future conditions up to the year 2050 the results show that acpar is useful for proposing acps that could have worked better for egypt during the baseline period but also acps that outperform the historical cropping pattern in each objective function for wide future conditions some of the generated future acps can perform well regarding irrigation water use and cost of imports without compromising food self sufficiency the quantified tradeoffs between the identified objective functions are the key contributions of this study representing important information for policymakers to aid in water resources planning the acpar framework connects national water resource management decisions to global food production consumption and trade dynamics keywords cropping pattern planning global food trade food production virtual water trade national water resources management egypt 1 introduction globally agriculture utilizes 50 of the habitable land area and 70 of the freshwater withdrawals for irrigation bruinsma 2017 the growing population and global economy are leading to stresses on the limited natural resources available for agriculture the increasing food demand necessitates the exploitation of more resources which are challenged by increasing urbanization and pollution rates that lead to deterioration of both the quantity and quality of land and water resources degefu et al 2018 these finite resources are further subjected to increasing competition for different uses projecting a world that is more susceptible to water and food shortages climate change poses additional threats pastor et al 2019 steffen et al 2015 as it might increase water demand and decrease water supply in various regions agricultural growth in arid and semi arid regions where land reclamation for agriculture is conditional on water availability is subjected to the greatest water constraints in these areas water is already insufficient to cover various national uses as a result agricultural production is less likely to meet consumption demands resulting in food gaps and creation of economic burdens that hinder the socioeconomic growth of developing countries schmitz et al 2013 d odorico et al 2019 developing countries around the world are challenged in this way with 48 of the land area of struggling economies lying in hyper arid and arid areas figure s1 1 in the last century the increased food production and liberated trade policies contributed to significant increase in global food trade d odorico et al 2014 which in turn benefited arid and water poor countries as for those countries importing food from the global market represents a better option when compared to the economic and physical constraints of transferring physical water to increase their local food production when food is traded the water consumed to produce this food is virtually traded as well tamea et al 2014 around 22 of global water used in agriculture is traded in virtual form hoekstra and chapagain 2008 dalin et al 2012 virtual water trade vwt participates in filling the persistent water and food gaps of water poor countries which is thought to reduce conflicts famines and massive emigrations allan 1998 however the increasing dependency on food trade vwt increases the risks of food shortage at times of market disruptions puma et al 2015 there is a strong need to consider food and virtual water trade dynamics when planning for national water resources abdelkader et al 2018 the invisibility of virtual water and the difficulty of connecting it to its consequences on the national scale remains a major challenge gawel and bernsen 2013 on the global scale the potential for expansion in agricultural land area is very limited tilman 1999 as it comes with significant environmental costs foley et al 2005 states might enhance and maximize the benefits of currently cultivated land garnett et al 2013 hence the optimal use of scarce water resources to maximize economic gains and strengthen food security without compromising other water uses including environmental considerations is important for future agricultural planning falkenmark 2006 jgermeyr et al 2016 unfortunately many water scarce countries suffer from lack of proper agricultural planning and resource management dalin et al 2017 show how some water scarce countries overexploit their non renewable water resources for short term economic gains through crop exports moreover the lack of basin cooperation and mismanagement of rainfall water in transboundary river basins such as the nile basin prevents the basin countries from achieving greater basin wide economic gains and better food self sufficiency siderius et al 2016 several studies show that more food production with higher profits can be achieved vico and porporato 2011 and in some cases with less water use smilovic et al 2018 davis et al 2017 water scarce nations desperately need to manage their limited water resources wisely while enhancing agricultural benefits but these are seemingly conflicting objectives as the agricultural sector is usually the major water user cropping pattern is a critical agricultural variable that is connected to different socioeconomic and environmental aspects crops differ in their water requirements profitability use of fertilizers and relative demand thus selecting one cropping pattern over others could have multiple consequences that should be considered while making planning decisions cropping pattern planning refers to the problem of distributing crops over a specified land area while considering three essential components i representation of the biophysical processes underlying crop production system ii definition for the objectives of the stakeholders under consideration and iii inclusion of constraints that exist on the crop production system dury et al 2012 the problem is extensively discussed in diverse forms but mostly simplified in the form of linear relationships between the decision variables and the objectives and constraints jothiprakash et al 2011 however other studies argued that non linear forms provide results that are more accurate and consistent with reality benli and kodal 2003 in early formulations of the problem only a single monetary objective to maximize economic profits or minimize production costs was considered heady 1948 louhichi et al 2010 benli and kodal 2003 lately as stakeholders became more interested in other non economic objectives the problem was formulated by considering various objectives usually in a bi objective form as to maximize the irrigation water saving and to maximize the economic returns ghazali et al 2018 wang et al 2012 reddy and kumar 2008 highlighted the possibilities of maximizing irrigation net benefit while maximizing irrigated area under water supply deficit nouri et al 2020 indicated that cropping pattern changes for the litani basin in lebanon would decrease the water demand for agriculture increase food production and increase agriculture economic returns davis et al 2019 showed that shifting the indian cropping pattern to increase cereal production would increase the nutrition value of food supply reduce the demand for water and other resources reduce greenhouse gas emissions and enhance the resilience to climate change without the need to increase the cropland area schyns and hoekstra 2014 concluded that partial relocation of crops would significantly save water compared to national water demand reduction plans in morocco other studies incorporated the growing awareness of environmental aspects in the cropping pattern planning problem karandish et al 2020 dogliotti et al 2005 minimized the environment exposure to pesticides and nitrogen surplus and femeena et al 2018 minimized the nutrient load reaching the freshwater system while minimizing crop production costs interestingly in the reviewed literature it was noted that there is less focus on multiobjective problem formulations sarker and ray 2009 in such complex problems neglecting the higher dimensionality of conflicting objectives i e considering fewer objectives than required would result in several types of decision bias hogarth 1981 gettys and fisher 1979 hence considering the cropping pattern planning in a multiobjective context would minimize the possibilities of misleading decisions brill et al 1990 the cropping pattern planning problem is typically solved using numerous methods but mostly optimization dury et al 2012 linear programming lp was commonly used to solve single objective problems because of its simplicity however it fails to solve non linear and discontinuous problems vedula and rogers 1981 lp was extended into goal programming gp which is commonly used to solve multiobjective linear problems however it requires selecting multiplier weights or target values for the objective functions before optimizing them which is always challenging to decision makers sarker and quadus 2002 recently many modifications were considered for lp and gp to improve their performance and reduce their limitations but more importantly evolutionary optimization algorithms eas were introduced as a substitute that can overcome deficiencies of lp and other traditional methods nicklow et al 2009 eas are not limited to a specific mathematical formulation as the case of lp but can even solve non linear discontinuous and non differentiable functions yao 2002 in contrast to gp multiobjective evolutionary optimization algorithms moeas are considered a posteriori decision support tools as they adopt the concept of pareto optimal solutions that present the explicit tradeoffs between the conflicting objective functions before the decision makers express their priorities and preferences moreover they use a population of evolving solutions thus perform simultaneous optimization of conflicting objective functions and generate many solutions in a single run king and rughooputh 2003 accordingly moeas are powerful tools that can be used in solving multiobjective cropping pattern planning problems there is a large body of literature and models available for cropping pattern planning nevertheless the majority of them are concerned with bi objective formulations in the form of direct economic benefits of crop production while maximizing irrigation water saving at a small scale i e farm or district level however in arid countries future cropping pattern planning is crucial not only to save water and maximize direct profit but also to enhance food security and economic stability at the national level all the while not compromising the environment and other water users e g municipal industrial power generation therefore the objective of this study is to introduce a more comprehensive national cropping pattern planning framework that adopts the understanding that water is a global resource that is being virtually traded there are implications of such trade on national water and food security and the complex interrelationships between food security and other national development plans that rely on water the framework for the generation analysis and assessment of alternative cropping patterns in arid regions acpar is introduced in this paper as a multiobjective framework that aids policymakers in water and food security assessment and management acpar takes into account the major non agricultural water uses that might be associated with national development scenarios the globalization of water through the food virtual water trade and the performance of the proposed solutions under possible national and global changes 2 egypt the imbalance of supply and demand egypt is located in northeast africa and has a total land area of 1 106 km2 94 of which is uninhabited desert and the remaining 6 is cultivated agricultural and urbanized land egypt s climate is characterized by hot dry summers and mild winters internal water resources are very limited and rainfall is irregular and very low with an annual average of 50 mm year leading to rainwater harvesting of only 1 3 109 m3 year fao 2018a mwri 2010 in addition egypt withdraws 2 109 m3 year from its fossil deep groundwater aquifers and desalinates 0 2 109 m3 year of seawater the majority of egypt s freshwater resources 97 flow from upstream countries into egypt via the nile river in 1960 egypt built the high aswan dam to control its nile water share of 55 5 109 m3 year mwri 2010 under the pressure of water insufficiency egypt recently increased its water uses by increasing both the reuse of agricultural drainage water and abstraction from shallow groundwater aquifers egypt currently reuses a total of 16 109 m3 year and withdraws 6 2 109 m3 year of its 8 4 109 m3 year shallow groundwater safe yield abdelkader et al 2018 mwri 2010 according to the egyptian ministry of water resources and irrigation mwri agriculture is the biggest water user amounting to 67 109 m3 year followed by municipal water uses of 9 109 m3 year and industry withdrawals of 2 109 m3 year mwri 2010 agriculture is an important sector of the egyptian economy that contributes 14 5 of the gross domestic product of 287 billion usd and employs 25 of available egyptian manpower capms 2017 fao 2018a the major part of egyptian agriculture aims to produce food where 94 of the cultivated land is used for food production that is mainly supplied locally as only 3 of the national food production is exported fao 2018b in recent decades crop yields have increased significantly leading to an increase in national food production from 40 106 tonnes year in 1986 to 95 106 tonnes year in 2013 despite these increases egypt s food self sufficiency i e the ratio of food produced domestically to the total food consumed in egypt for the period between 1986 and 2013 was kept fixed at 80 but with a drop in the national water self sufficiency i e the ratio of national water supplied for all uses to all national water demands including net virtual water import from 81 to 70 over the same period abdelkader et al 2018 2003 fao 2018b however the national water food and trade nwft model developed by abdelkader et al 2018 projects alarming levels of deteriorating water and food security in egypt to an average level of 50 self sufficiency by 2050 due to sharp increases in population and water demand clearly the agriculture sector that is currently constrained by water availability is incapable of fulfilling the exponential increase in national food demand which will lead to an increase in the nation s food virtual water imports the egyptian food consumption pattern is highly reliant on agriculture based food where 98 of the per capita daily calorie intake comes from agriculture sources fao 2018b accordingly population growth has a compounding effect that causes the water and food gaps to increase non linearly that is the demand for food will increase while agriculture food production decreases due to the decrease in water availability caused by withdrawing more water for municipal and industrial uses which have higher priority for water allocation mwri 2010 egypt now depends heavily on imported food mainly cereals to fill its growing food gap the country is one of the world s biggest importers of wheat with such imports covering 40 of its wheat consumption fao 2018b improving food self sufficiency in egypt will be challenging in the future as it might require more water availability the potential for increasing internal water resources in egypt is very limited and increasing external water resources through the transboundary nile flows is an issue lying at the heart of a difficult debate and diplomacy given the growing competition over the utilization of nile water resources among all riparian countries swain 2011 egypt s dependence on food imports could alleviate the water food security problem however it comes with high risks associated with domestic and global economics e g price shocks and global trade reliability and stability egypt can seek solutions by managing and planning some of its agricultural sector variables cropping pattern is a major decision variable in agriculture that influences economic and water conditions in the country hence considering cropping pattern planning should take priority in remediating the anticipated water and food crises of egypt egypt is an ideal case to demonstrate the proposed acpar framework due to its aridity and the effect thereof on national water and food security the nation s position at the heart of the conflict over nile river water the availability of three documented national target water resources scenarios up to 2050 developed by the egyptian government mwri 2010 tables s1 1 and s1 2 and the ability of the nwft model to handle egypt s water food nexus abdelkader et al 2018 and its connection to the global virtual water trade although the government does not have full control over the cultivated crops suitable policy instruments and awareness programs could motivate farmers to adopt crop changes for example in 2018 the government regulated the cultivation of rice as a water intensive crop however the extended and long term impact of such policies on economic and water resources conditions has not been addressed 3 methodology acpar is a hybrid policy driven optimization simulation framework that aims to assist decision makers in policies that shape the national cropping pattern the framework incorporates an approach for cropping pattern planning process which can be used to investigate policy change consequences on the national long term hydro economic and water food security states while taking into considerations the national water development plans and the global food trade dynamics it consists of i identifying the objective functions to be optimized in a multiobjective functions approach ii generating initial random population of alternative cropping patterns acps that represent diverse feasible cropping patterns iii executing the simulation based nwft model to evaluate the objective functions iv using multiobjective optimization algorithm in an iterative mode to keep perturbing and evaluating the acps until a preset maximum number of iterations is met and a set of pareto optimal acps are finalized over the baseline period 1986 2013 in our case study 200 pareto optimal acps were generated v identifying additional filtering criteria that can be specified by decision makers to narrow down the acps into a smaller and more manageable set this filtering process provides decision makers with flexibility regarding their criteria of choice and their threshold values and it aims to allow them to intervene in making selections fig 1 depicts the acpar procedures as outlined above the framework is configured to be executed under baseline conditions to understand the system under consideration and repeated under future conditions to identify changes from the baseline and make planning decisions different types of analyses were used under both conditions as explained in more details in the sub sections below the optimization method explanation and its parameterization process are provided in section s1 3 of the supplemental file 3 1 the national water food and trade nwft model the nwft model fig 2 is a national water and food supply and demand model in which the economic and population growth rates along with per capita water demands are considered while estimating the annual water demands of municipal and industrial sectors the model allocates available water annually according to supply priority rules in which municipal followed by industrial sectors are allocated water first then the agriculture sector can access the remaining water the model considers the cropping pattern as a sole decision variable and once it is determined the nwft model estimates water demand for agriculture taking into consideration crop water requirements and annual irrigation efficiency subsequently this water demand for agriculture is compared against the annual water available for agriculture and accordingly crop yields are revaluated to account for water deficit s effect on crop yield doorenbos and kassam 1979 using this estimated crop yields and the cropping pattern the nwft model calculates the annual national food production on the other hand the national food consumption demand is estimated based on per capita food consumption pattern population and economic growth rates at this step the national food trade can be calculated by comparing the national food production and consumption quantities where food imports are estimated as the deficit in demand compared to production and the food exports as the surpluses of production compared to demand those traded food quantities are translated to virtual water import and export in addition the model considers also the economic and environmental consequences of a cropping pattern change the agriculture gross margin and economic costs of imports are evaluated while the national fertilizer application rate is calculated within the environmental component of the nwft model in performing the above mentioned calculations the model uses a group of key variables some of them were inevitably constrained to account for resources availability limitations those variables and their constraints are explained in section s2 1 and table s2 1 moreover sections 3 2 and 3 4 present the major calculations performed in the nwft to estimate the values of all objective functions and filtering criteria while all the detailed methods and equations used in nwft calculations along with the model validation can be found in abdelkader et al 2018 3 2 objective functions and decision variables four hydro economic objectives were selected to reflect the interests of decision makers in the conflicting objectives of maximizing national economic benefits while saving more water and maximizing food security as follows 1 gross margin gm usd year within the agriculture sector which is defined as the difference between the revenue of a crop market price and the variable production costs brink and mccarl 1978 in this study the gm objective function was evaluated annually and maximized eq 1 based on the average value over the entire simulation period the gm was calculated as the summation of the national product of crops tonnes multiplied by the net revenue usd tonne based on the local market price the global market price was used for the portion of crops that was exported data related to local and global prices of crops consumed and produced in egypt were gathered from the faostat database fao 2018b the variable costs of crop production were retrieved from the egyptian ministry of agriculture and land reclamation malr 2016 2 economic cost of imports eci usd year which is the cost of imports of each crop expressed as the price of each crop in the global market multiplied by the quantity of the imported crop then summed over all crops the simulation period average eci was minimized in this study eq 2 this excludes transportation costs and any taxes or duties 3 the national annual water demand for agriculture wda m3 which was calculated as the crop water requirement multiplied by the crop area summed over all crops this objective function was minimized eq 3 to rationalize the water use in egypt and 4 the virtual water import vwi m3 which is the amount of water consumed to produce the imported crops water footprint of imported crops the rationale behind this function is to reflect the country s reliance on imported food and the global trade to maximize egypt s food self sufficiency this objective function was minimized eq 4 it also represents egypt s global responsibility to minimize any overexploitation of global water resources the nwft model can estimate both annual wda and vwi 1 m a x i m i z e g m t t 0 t i 1 n p l i t v c i t y i t a i j t p g i t p l i t e x p i t t t 0 1 2 m i n i m i z e e c i t t 0 t i 1 n i m p i t p g i t t t 0 1 3 m i n i m i z e w d a t t 0 t i 1 n c w r i j a i j t t t 0 1 4 m i n i m i z e v w i t t 0 t i 1 n v w i i t t t 0 1 where t0 and t are the first and the last year of the simulation period respectively n is the total number of crops pli t is the local market price of crop i in year t usd tonne vci t is the variable costs of production for crop i in year t usd tonne yi t is the estimated crop yield subject to the amount of available water for crop i in year t tonnes ha doorenbos and kassam 1979 aij t is the area assigned to crop i in cropping season j in year t expi t is the national exported quantity of crop i in year t tonnes pgi t is the average global market price of crop i in year t usd tonne impi t is the national imported quantity of crop i in year t tonnes and cwrij is crop water requirements for crop i in season j m3 ha the set of decision variables x shown in eq 5 is the cropping pattern which comprises the percentage of each crop area xi of the total land available for a number of crops n which are 14 major crops and crop groups for the case of egypt the land available for agriculture can change from year to year and is affected by urbanization razing and reclamation rates the cropping pattern i e x was assumed fixed throughout the simulation period for a particular simulation run the purpose of optimization was then to find the optimum pattern through the whole simulation period given the predetermined constraints 5 x x i x n x i 0 1 3 3 the optimization method acpar incorporates a method named uniform spacing multiobjective differential evolution usmde chichakly and eppstein 2013 which comprises a synergy of good features compiled from different eas usmde s basic algorithm is differential evolution de which is a single objective search operator that proved to converge significantly faster compared to other eas storn and price 1997 the usmde can solve multiobjective problems as it adopts the features of the well known algorithm of non dominated sorting genetic algorithm ii nsga ii deb et al 2002 however the main advantage of usmde to decision makers is that it expresses the tradeoffs between the objective functions in more diverse and consistent way compared to other methods chichakly and eppstein 2013 accordingly the usmde was considered an appropriate choice for the acpar framework however it requires proper parameterization to generate reliable pareto optimal solutions and in this study we performed a parametrization exercise for acpar and its application to egypt as explained in details in section s1 3 this parameterization process concluded that acpar should produce 200 pareto optimal acps in order to be accurate and well representative of the search space the 200 acps can be reduced further using policy driven filtering criteria 3 4 filtering criteria filtering criteria represent a group of variables that are of specific interest to decision makers however they are less important than objective functions thus rather than including them as objective functions and increase the dimensionality of the problem decision makers would rather be interested in monitoring their values and compare them against satisfaction thresholds i e filtering criteria filtering criteria are meant to be flexible so they can be set after the acps are generated and used to reduce their number to a manageable set that represents the acps of the most interest to decision makers there could be many trials of setting the filtering criteria and filtering the generated acps until the decision makers are satisfied with the resulting ones four variables were selected in this study as filtering criteria due to their significance and relevance two of them secure a pre determined level of economic stability the stability of agricultural gross margin gms and the stability of the costs of food imports ecis which are of high importance for proper economic planning in a country like egypt with a less advanced economy in the objective functions we considered the period averaged gm and eci which represent the average of annual values over the baseline period of 28 years 1986 2013 as well as for the future scenarios 2014 2050 in the filtering criteria we set a threshold table 1 for the coefficient of variation cv of both gm and eci which is the standard deviation divided by the average value gms and ecis lower gms and ecis values indicate less inter annual variability which reflects less uncertainty the third filtering criterion is national food self sufficiency nfss kcal kcal which is defined according to eqs 6 and 7 given the increasing food imports of egypt abdelkader et al 2018 it is important to select cropping patterns that do not lead to significant deterioration of egypt s nfss table 1 the last variable is the nation s average fertilizer application per unit area nfar kg ha which is estimated using eq 8 the fertilizer application rate in egypt is one of the highest in the world potter et al 2010 and this has negative effects on surface water quality and therefore human and aquaculture health hence selecting cropping patterns that have lower fertilizer rates is environmentally desirable 6 n f s s t n a t i o n a l f o o d c o n s u m p t i o n t i m p o r t e d f o o d t n a t i o n a l f o o d c o n s u m p t i o n t 7 n f s s t t 0 t n f s s t t t 0 1 8 n f a r t t 0 t k 1 3 i 1 n f a r i j k t a i j t t t 0 t a i j t where farijk t is the fertilizer application rate tonne ha fao 2005 of fertilizer nutrient k for crop i in cropping season j in year t n is the total number of crops and aij t is the cultivated area ha of crop i in cropping season j in year t the values in table 1 were selected somewhat arbitrarily in this study to demonstrate the method however the values were meant to avoid major or unrealistic changes in the current agricultural practices in egypt the national fertilizer application rate kg ha was set to not exceed the historical level by more than 15 the food self sufficiency to not go below 75 of the historical level and the inter annual variability coefficient of variation of the eci and the gm to not exceed the historical value and 80 thereof respectively 3 5 implementation of the acpar framework the considered 14 crops and crop groups table s2 2 were assigned to two major cropping seasons as practiced in egypt so they can compete with their realistic substitutes during the implementation of the acpar framework the framework was applied for the baseline period 1986 2013 and generated 200 acps whose performances were normalized i e scaled between 0 and 1 relative to the maximum and minimum objective function values to easily evaluate them against each other the normalized value of an objective function was estimated to ensure that improvements to the objective functions occur when the value approaches 1 0 eq 9 thus the calculation method depends on whether the objective function is minimized i e wda eci and vwi or maximized i e gm the normalized acps were then analyzed clustered into groups and compared with historical cropping patterns hcps in egypt the acps were reduced further using the filtering criteria and were analyzed to understand how cropping pattern changes affect the national hydro economic state 9 n u y max u u y max u min u i f u i s m i n i m i z e d u y min u max u min u i f u i s m a x i m i z e d where n uy is the normalized value of objective function u for pareto optimal solution y  1 2 200 n uy  0 1 the acpar framework was also implemented under future scenarios of change considering both national and global change conditions three different national target scenarios that represent three possible combinations of national water resource availability water supply and demand socioeconomic development plans improvements in infrastructure and population growth up to year 2050 were used critical balanced and optimistic abdelkader et al 2018 modified the per capita food consumption pattern of the balanced and optimistic scenarios to reflect the impact of socioeconomic changes on food demand in egypt in this study we added the changes to the crop yield and crop production losses to match the degrees of economic growth reflected by each scenario and its impact on the food production system details of the three scenarios as well as the baseline scenario are provided in tables s1 1 and s1 2 the study required future global and local crop prices projected until the year 2050 which were available through the international food policy research institute ifpri 2017 the ifpri used the international model for policy analysis of agricultural commodities and trade impact robinson et al 2015 model which connects global shared socioeconomic pathways ssps and the ipcc s climate change scenarios to water availability and food supply and their effect on market prices to project future scenarios of global crop prices table s1 1 and s1 3 show the scenarios available through impact and considered in this study along with their major assumptions other scenarios are available through impact but those adopted in this study cover the whole range combining the three national scenarios of egypt with the four global scenarios considered resulted in a total of 12 different future scenarios to be investigated table s1 4 projections of local prices in egypt are not available however based on correlations detected between the local and global prices over the baseline period regression models were developed to project the local prices of various crops in the future based on the projected global prices examples of the regression models are presented in section s2 3 figure s2 1 acpar implementation under future conditions included similar steps as for the baseline but repeated for the 12 scenarios through optimization under each of the 12 scenarios the pareto optimal 200 acps for each scenario were identified those acps were further narrowed down by applying the filtering criteria to the 200 solutions of each scenario separately the filtered acps of the future from all scenarios were grouped with the filtered acps of the baseline period to form one group of acps to select an acp while addressing future uncertainty we adopted the concept of planning under uncertainty which is widely used in water resources research e g maier et al 2016 the evaluation and selection of any acp would not be based on its performance under any single scenario but under all 12 scenarios in particular each acp was evaluated based on the mean of its objective function value calculated across the 12 scenarios and based on the robustness of each objective function under those future scenarios this process necessitated that each of the filtered acps be simulated in the nwft model to estimate its objective functions under each of the 12 future scenarios then for an acp y the mean of its objective function u y across scenarios i e m uy was calculated using eq 10 there are many ways to define and estimate the robustness herman et al 2015 however all of them reflect that robust plans should be insensitive to future conditions maier et al 2016 we evaluated the robustness r u y of an acp y for each objective function u according to eq 11 as the number of scenarios under which the performance of y is satisfactory for objective u sn uy relative to the total number of scenarios under consideration st which is similar to the measure used by paton et al 2014 under any scenario s an acp y is considered to have satisfactory performance in objective function u only if the value of u y under this scenario us y does not violate a global threshold determined by decision makers valid for all scenarios i e uth this threshold could be a desired future value for this objective e g a minimum target gross margin of 35 billion usd year 10 m u y s 1 s t u s y s t 11 r u y s n u y s t 12 s n u y s 1 s t 1 u s y u t h i f u i s m i n i m i z e d s 1 s t 1 u s y u t h i f u i s m a x i m i z e d where us y is the objective function of acp y evaluated under scenario s st is the number of scenarios under consideration i e 12 scenarios sn uy is the number of scenarios under which the objective function u of an acp y meets a threshold criterion uth 4 results and analysis 4 1 baseline application of the acpar framework the optimization of cropping patterns during the baseline period 1986 2013 resulted in 200 pareto optimal solutions acps the normalized values of the objective functions were used for comparison of the 200 acps where 1 0 and 0 0 denote the best and worst outcomes respectively the absolute values of objective functions were used to express the differences in magnitudes between the filtered acps 4 1 1 the objective functions tradeoffs fig 3 illustrates the tradeoffs among cropping pattern objectives for the case of egypt during the baseline period and it shows that the normalized gross margin improvement approaches 1 0 can be achieved with improvement of water demand for agriculture approaches 1 0 meaning less water demand and more water savings nevertheless bubble colors turning into red and sizes become bigger meaning higher eci and more vwi respectively thus water saving cropping patterns are those that can come with high agriculture gross margin but they lead to higher costs of food imports and higher virtual water of imports which means less food self sufficiency 4 1 2 clustering analysis to understand the link between various cropping pattern compositions and their corresponding objective function tradeoffs the pareto optimal acps were clustered into three distinguished groups using the k means clustering method the k means started by randomly assigning centroid values for the three clusters i e random location in the 4 dimensional objective function space then based on the acps objective function values they were assigned to their nearest cluster identified by its centroid iteratively the new cluster centroids were recalculated and then the 200 acps are reassigned to the nearest cluster until the centroids do not change the dashed lines on fig 3 indicate the three acp groups where each group represents a tail end condition in at least one of the objective functions fig 4 is complementary to fig 3 as it shows the corresponding crop compositions of each group both figures implicitly reflect the existence of three thematic alternatives with some exceptions that characterize cropping pattern planning for egypt the first cluster contains more wheat than fodder crops both are competing for land as they are cultivated in the same season while maintaining a balanced ratio distribution of other crops group 1 this enhances food self sufficiency lowers vwi and decreases eci but also leads to higher wda and lower gm the second cluster contains cropping patterns that have more fodder crops than wheat and significantly higher percentages of other cereals group 2 this would yield the maximum water savings as other cereals and fodder crops require relatively less wda while maintaining moderate gm because of the relative higher profitability of fodder crops in the local and global markets the last cluster contains cropping pattern similar to the second one but rather than the relatively high ratio of other cereals it contains significant vegetables ratio group 3 this would yield the highest gm because of fodders and vegetables high profitability while maintain moderate water savings however the undesirable aspects of groups 2 and 3 are the increase in vwi and eci meaning more costs of food imports and less national food self sufficiency as figs 3 and fig 4 show the first group was practiced during the historical period 1986 2013 the historical cropping pattern hcp of egypt falls in group 1 and has the lowest eci when compared with the 200 acps this reflects that the collective decisions of stakeholders i e farmers and decision makers in selecting historical cropping patterns in egypt seem to have been influenced by local market food demands and prices leading to cropping patterns that favor reduced food import costs and maintain high food self sufficiency even though it required high wda and yielded lower gm compared to other acps 4 1 3 narrowing down the set of feasible alternatives the 200 acps produced are considered equally good unless decision makers preference structure is identified as it might be difficult to select from this large number of solutions additional filtering criteria explained in detail in section 3 were used to keep only the acps that are of most interest applying the filters resulted in 19 solutions presented in figure s3 1 which all turned to belong to group 1 as the hcp the filtering criteria ensured that the acps show economic stability and acceptable fertilizer application and food self sufficiency a visual comparison between the 19 filtered acps and the hcp is given in fig 5 and figure s3 2 in the supplemental file which show that the hcp is superior with respect to its low eci and vwi values but moderate with regard to the wda and is the worst with respect to both the gm and gms this can be attributed to the fact that unlike the generated acps the hcp is not a fixed cropping pattern through the 28 years of the baseline period the major change was the gradual replacement of cotton i e part of non food by vegetables because of their relatively higher profitability leading to higher variation in the gm thus making it a less stable option with a lower period averaged value the filtered acps reflect different levels of tradeoffs between the objective functions but acp 18 in particular has interesting characteristics this alternative would have been a good substitute for the hcp acp 18 has food self sufficiency nfss and eci that are comparable to the hcp it could have slightly improved the food self sufficiency form 80 to 82 and slightly increased the eci from 4 3 to 5 4 billion usd year however it would have significantly increased the gm from 17 2 to 19 9 billion usd year i e net gain of 1 6 billion usd year and maintained better stability for gm and eci two disadvantages for this acp are the increased demand for water increase of 5 109 m3 year and the slightly higher fertilizer application rate increase of 35 kg ha year see figure s3 2 the major difference between acp 18 and the hcp is more wheat and fodder crops and less non food crops and pulses details of the cropping patterns are provided in table s3 1 acp 2 is another remarkable acp it would have been desired if the gm and saving water were given priority over having a high food self sufficiency and low eci acp 2 would have increased the gm of the hcp from 17 2 to 22 6 billion usd year but also increased eci from 4 3 to 8 5 billion usd year and maintained better stability for gm and eci moreover it would have saved 1 3 109 m3 year of agriculture water but at the cost of increasing the vwi by 6 5 109 m3 year there are two major disadvantages of this acp it would have decreased food self sufficiency from 80 to 69 and increased fertilizer application rate by 26 kg ha year the major changes of this cropping pattern compared to the hcp are the significant increase in fodder crops and other cereals and the decrease of wheat rice non food fruits and pulses table s3 1 analyzing cropping patterns in the baseline period provides information on what could have been done in the past to reach desired water economic environmental and food self sufficiency states 4 2 application of the acpar framework under future scenarios the 19 filtered acps of the baseline period as well as the hcp are not necessarily suitable solutions for the future thus to search for acps that might be superior under future conditions the simulation optimization framework was repeated under the 12 future scenarios for the period between 2014 and 2050 through optimization there were 200 future acps generated under each scenario i e 2400 in total those 2400 acps were further narrowed down by applying the filtering criteria on each scenario separately consequently a total of 460 filtered acps were finalized from all 12 scenarios those 460 acps were grouped with the 19 baseline acps and the hcp to form one group of 480 acps finally each of those 480 acps was simulated in the nwft model to quantify their objective function values under the 12 future scenarios for each acp the mean of each objective function across the 12 scenarios was calculated moreover to assess their response to future changes the robustness of each objective function for each acp was calculated using eq 11 in the remaining part of this section a comparison between the baseline acps including the hcp versus the 460 filtered acps of the future is provided then the impact of future scenarios on the four objective functions of the different acps is discussed finally we show how future decisions could be made to select one of the acps for consideration in future policies 4 2 1 comparison between filtered alternative cropping patterns fig 6 shows a comparison between 20 acps the hcp and 19 baseline acps versus the 460 acps found under future conditions i e future acps interestingly under future conditions the baseline acps and the hcp have lost their major advantage of having low eci and vwi the majority of the baseline acps have relatively good gm and wda values however all of them have poor vwi and eci values compared with the future acps fig 6a the reasons behind these changes are revealed by analyzing the differences in cropping patterns between the baseline and future acps our modeling framework recognizes wheat as an important crop whose area should increase in the future to maintain the superiority of an acp in the objective functions of eci and vwi wheat is an important crop for egyptians it constitutes 30 to 40 of the daily calorie intake however egypt currently has a significant shortage in its wheat production and it imports 40 of its demand under the three future national development scenarios egypt s population grows sharply table s1 2 driving egypt s demand of its most consumed and imported crop i e wheat to increase if this increase in demand is met by increasing wheat import this would negatively affect the eci and vwi accordingly to help lower the eci and vwi the local production of wheat should increase the acpar framework shows that the agriculture area allocated to wheat still needs to increase fig 6b to maintain the low levels of eci and vwi minimize cost of import and maximize food self sufficiency increasing the area of wheat would have some disadvantages wheat has a considerable water footprint some other crops require less water to produce the same tonnage and moderate profitability significantly increased in the future table s1 3 but still some other crops have higher profitability accordingly increasing wheat would likely increase the wda and decrease gm to substitute for this negative impact and keep the acps of the future able to compete on minimizing wda and maximizing gm acpar balances the increase of wheat area by decreasing the area of crops with high water footprint and less profitability such as other cereals and non food and expands the area of highly profitable crops with less water footprint such as vegetables fig 6b the only advantages of the baseline acps in the future are their low wda and high gm which do not seem to be exclusive characteristics as there are some of the future acps that have comparable or even better gm and wda values with even better eci and vwi values this comparison indicates that decision makers are less likely to favor any of the baseline acps nor the hcp in the future most probably they would increase the area of wheat among other changes indicated in fig 6b to shift toward one of the 460 acps generated under the future conditions 4 2 2 future changes in the values of egypt s objectives it is important to understand how the objective functions of the acps respond to the different future scenarios used in this study and how their values might change from their baseline conditions fig 7 reflects the average response of all the filtered 480 acps for egypt the gm seems to increase under all future scenarios compared to its baseline value this is mainly because the prices increase under all considered scenarios assuming fixed cost to price ratio section s1 2 table s1 3 additionally gm is also influenced by the quantities produced of each crop which is also increased under all future scenarios under future national development scenarios the average agricultural area crop yields and water availability increase in comparison with the baseline leading to higher crop production the greatest improvement in gm occurred under the optimistic national scenarios scenarios 9 to 12 due to the relatively greater availability of water for agriculture the largest expansion in agricultural land area and the highest improvement in crop yields interestingly the effect of climate change on gm can offset the effects of some national future developments for example the gm values under the critical scenario combined with climate change scenario 4 is as high as the national balanced scenarios without climate change scenarios 5 6 and 7 this can be attributed to the fact that food prices under the climate change scenario ssp2 hgem as predicted by the impact model are higher than other price scenarios leading to higher gm values it is important to note that the gm of the agriculture sector improved under all scenarios however before considering this as a positive outcome decision makers should also consider how the increase in crop prices are factored in this improvement and how this might affect future food affordability the increase in all four global price scenarios would increase the eci relative to the baseline the sharp increase in egypt s population embedded in all three national scenarios leads to an increase in the eci due to the increase in the food gap abdelkader et al 2018 importantly however these scenarios feature variations in food consumption patterns population growth rate and increased demand for crops while crop production is constrained by varying levels of water availability under the balanced scenario eci increases the most possibly because of the change in the food consumption pattern from a cereals based diet to one with more vegetables and meat which are more expensive climate change scenarios 4 8 and 12 always results in additional negative impacts on the eci of egypt as food prices are higher than scenarios with unchanged climate the influence of national development scenarios on the eci is higher than their effects on gm which means population growth and food consumption affect the eci more than prices fig 7 shows that the best eci future values are associated with the optimistic scenario due to the greater water availability for agriculture in egypt and the least population growth compared to other scenarios leading to lower costs of food imports the vwi and wda vary only in national development scenarios and remain unchanged under global price scenarios which is an outcome of the formulation of our model assuming that their values depend only on the national conditions development scenarios which is logical this formulation was meant to allow for investigating the effect of cropping pattern as a national policy variable on the objective functions egypt s future is obviously and significantly better under the national optimistic scenario where the key variables are a lower population growth rate which makes more water available for agricultural land expansion and a consumption diet that is less dependent on meat table s1 2 egypt s conditions are also worse under the so called balanced scenario than the critical scenario which can be attributed to a more water intensive food diet and more municipal and industrial water use under the balanced scenario that makes less water available for agriculture although future scenarios might affect the objective functions of all the 480 filtered acps in a similar direction e g make an objective function increase for all the acps the magnitude of this effect can vary largely among the acps according to their cropping pattern composition accordingly decision makers would be interested in acps that are less sensitive to deterioration under the widest portion of future conditions which we express by the robustness measure of an acp as presented in eq 11 decision makers would determine a threshold or a target for each objective function such that the robustness would measure the ability of an acp to surpass this target under the widest spectrum of future conditions for this study we determined the mean objective function values of the hcp under future scenarios see fig 6a as the threshold values of 30 2 billion usd year 75 109 m3 year 34 billion usd year and 73 109 m3 year for gm vwi eci and wda respectively in this regard the acp that is more robust in a specific objective is the one that surpasses the mean future value of the hcp in this objective for the widest future conditions more future scenarios as explained in eq 12 the robustness of acps can be investigated for each objective function separately however we found that a considerable number of the 480 acps has good robustness in all four objective functions simultaneously accordingly those acps with good robustness were isolated and considered for further analyses as they are of much higher utility for decision making this was achieved by dividing the 480 filtered acps into three groups according to their robustness i the highly robust acps which includes the acps that surpass the hcp in all objectives for more than 70 of the future scenarios robustness 0 7 for all objectives ii the moderately robust acps which includes the acps that surpass the hcp in all objectives for more than 50 of the future scenarios i e robustness 0 5 for all objectives and iii the low robust acps which includes acps not surpassing the hcp for more than 50 of the future scenarios in at least one objective only the first two groups were considered for further analyses interestingly the 19 filtered acps of the baseline were all part of the third group i e low robustness which gives an additional reason for decision makers to unfavor them for future selection fig 8 shows these two groups with good robustness both groups have acps with good performance in gross margin gm and water use wda but group 1 highly robust has lower cost of import eci while group 2 moderately robust has higher food self sufficiency lower vwi to understand what could have made an acp more robust than the other the cropping pattern of the three groups was investigated see figure s3 3 as the figure shows there is a clear overlap between the cropping patterns of the three groups thus it does not seem that there is a definite relationship between a specific cropping pattern compositions and the robustness of an acp rather robust acps are cropping patterns that come from different regions of the domain of cropping patterns 4 2 3 future planning decisions policymakers can use the acpar framework proposed in this study for crop pattern planning based on two major criteria i their preference structure regarding the objective functions and ii the consideration of future uncertainty by selecting robust acps that performs well under the widest range of scenarios for example the eci seems to have been the main decision factor in egypt fig 5 as inferred from the hcp if this situation continues in the future fig 8 can be used to select one of the acps from the two robust groups while considering this preference of low eci acp 234 is one of the possible selections under this criterion this acp is characterized by low eci value of 24 4 billion usd year compared with the hcp s 34 0 billion usd year if it continues in the future moreover acp 234 has a gm that is higher than the hcp by 6 3 billion usd year besides these economic gains this acp could also save water as it has wda value that is lower than that of the hcp by 8 0 109 m3 year and the vwi also could be decreased by 1 2 109 m3 year more importantly this acp belongs to the highly robust acps group group 1 in fig 8 meaning that its superiority over the hcp in the four objective functions is maintained for at least 70 of the future scenarios reflecting higher chances of being superior should the future come in different forms the major changes required to shift the hcp to acp 234 are a significant increase in the cultivated areas of wheat fodder and non food from 19 15 and 6 in the hcp to 26 22 and 10 while reducing fruits maize and pulses from 9 16 and 4 to 6 10 and 1 table 2 5 discussion some of the acps that we analyzed reveal crop compositions that might not be acceptable to farmers and policymakers e g eliminating particular crops as shown in tables 2 and s3 1 sudden and significant changes like this could lead to local socioeconomic costs to small farmers and industries that rely on these crops some of the crops also have multi dimensional benefits such as rice cultivation in the nile delta of egypt which is important for reducing seawater intrusion and balancing soil salinity sudden changes to rice areas could lead to severe environmental problems other crops would have an irreversibility problem for example some fruit trees once their area is reduced cannot easily increase again because it takes years to grow and become fully productive in addition shifting cropping patterns could seriously affect the nutritional health of the population in developing countries making imported crops affordable and accessible might be challenging accordingly maintaining a certain level of diversity in the cropping pattern is necessary to make diverse food find its way to small markets and to preserve the dietary intake of broader range of the population more balanced and healthy moreover cropping patterns that are selected today should be favored if they are adaptive or flexibly accept changes over time with the least negative impacts e g socioeconomic environmental thus while selecting acps it is important to consider how an acp would be easily evolving from the existing cropping pattern and also how easy it accepts multiple changes over time in our study the generated acps met all of the objective functions and the filtering criteria that we selected a priori however this multitude of other considerations can be incorporated by setting cropping area constraints within the nwft model or by adding additional filtering criteria within the acpar framework both of which are easily implementable in the current formulation of acpar we kept the cultivated ratio of each crop constant over the entire simulation period within a particular scenario another possible approach is to allow for periodic changes in the pattern e g every five years in response to changing conditions the acpar framework can be re run every five years with new conditions as a way to use the proposed framework for dynamic decision making and to reduce the uncertainty of long term planning decisions in this study there was less emphasis on the spatial representations related to cropping pattern distribution variations of input variables and model outcomes in particular variables like crop water requirements and crop prices were aggregated as national average values when there is a shortage in the water supply for agriculture it was considered as a uniform water deficit that impacts all crops in reality this shortage might only impact specific crops cultivated at the most downstream part of the water system another implication of spatial aggregation is that acpar would not be able to provide decision makers with spatial information about cropping pattern changes but only changes at the national level in a previous study we showed that such aggregations and assumptions have an ignorable impact on the accuracy of our model results regarding the annual national agriculture water demand and the national production of each crop abdelkader et al 2018 accordingly for this study we trust that this issue has insignificant impact on the calculated national objective functions of egypt however this concern remains valid especially if acpar is applied to other countries that have significant spatial variability in model variables and outcomes in such cases it is crucial to modify the acpar framework to incorporate more explicit spatial representations the filtering criteria used in this study included the coefficient of variation of the gm and eci to maintain acps with relatively more stable gm and eci over the simulation period one disadvantage of this formulation of stability is that it might penalize both the high and low values of gm and eci the use of this formulation did not affect the filtering outcomes for this case study as the filtered acps were significantly dependent on other filtering criteria i e nfss and nfar however we acknowledge the limitation of this formulation and recommend for similar studies an alternative formulation that only penalizes acps that have deviations from the mean i e period average toward undesired directions e g low gm and high eci in this paper we set the objective functions to match with the stated targets of our study which were to provide cropping patterns that can enhance the water and food security states of egypt while increasing the economic benefits our selection of the objective functions also allowed for establishing a connection between the global food trade dynamics and the national water management decisions more specifically the link between the changes of global food prices and national water management within the agriculture sector to meet the set objectives through changing cropping patterns is a key contribution of this work we acknowledge that there is no single way to set the objective functions but different forms could be used to express the same targets for example the gm eci and wda might be combined to form an overall societal utility objective that can be maximized the objective function of vwi was minimized to secure better food self sufficiency conditions and reduce egypt s burden on the global water resources such a criterion shows its importance in circumstances of disconnected world the covid 19 pandemic of 2020 is an example however it might be argued that egypt can import its food from only water rich countries accordingly this objective function can be replaced with an explicit food security metric the evaluation measures of robustness and mean of objective functions across scenarios could have been used within the objective functions rather than just evaluation and selection criteria however as the matter of selecting objective functions would always remain debatable we acknowledge that the process could be performed by including various stakeholders that are interested in national cropping pattern planning i e farmers industries etc in discussions about the determination of those objective functions and how they are formulated the government of egypt is the major stakeholder targeted in this study which is known to have policies to intervene periodically in the national cropping pattern by setting incentives and penalties to direct farmers to cultivate specific crops this might not be valid for other countries where the government has no intervention policy in shaping national cropping patterns however in such a case the acpar can be modified for example to reflect the interest of stakeholders other than the government that would benefit from the cropping pattern planning and has the control of changing it e g farmers industries as part of the future scenarios used in this study a constant price cost ratio was assumed for the estimation of the agriculture sector s gross margin in the future even though this is not an unrealistic assumption it is an important assumption to keep in mind when analyzing and understanding the results derived from the acpar framework the issue of predicting the local crop prices in egypt in the future is also related to the previous point we projected the local market price based on the global market price which is a reasonable assumption given that egypt is moving fast towards free market mechanisms joya 2017 however another option in future studies is to develop a or use an existing computable general equilibrium cge model for egypt that links supply demand and prices noting that cge models also contain several assumptions about the market mechanisms and consumer behavior and in turn the stationarity of such relationships in the future might be questionable arthur 1999 finally one should note the importance of the outcomes presented by this study for integrated water resources management in egypt under scenarios featuring shortages of nile river water flowing into egypt cropping pattern changes can reduce the amount of water needed for agriculture significantly this reduction can be even more than the governmental municipal water demand reduction plans egypt s most optimistic future scenario assumes a reduction in the future water demand for municipal uses by only 5 0 109 m3 year while acpar proposed cropping patterns that can reduce the future demand for irrigation by amounts that exceed this number see fig 8 however reducing irrigation water demands will come with the tradeoffs of increasing the cost of food imports or reducing food self sufficiency acpar was able to avoid such consequences by introducing robust acps that outperform the hcp in these objective functions when reducing irrigation water demands for wide future conditions abdelkader et al 2018 presented a quantitative analysis of the sensitivity of egypt s food gap to the scenario of reduced water availability this scenario of reduced national water availability is critical for egypt s consideration and should receive special attention in light of the heated negotiations within the eastern nile basin regarding the potential consequences of the grand ethiopian renaissance dam gerd the gerd is expected to negatively affect egypt s annual water supply especially during recurring drought periods in the eastern nile basin 6 conclusions in arid regions water security cannot be separated from food security as the requirements of agricultural crop production make the agriculture sector the major water consumer any decrease in crop production leads to a decrease in the national gross margin within the agriculture sector decline in food self sufficiency and increase in the economic cost of food imports therefore efficient management of agricultural water has a multitude of socioeconomic implications and thus is of high priority however such management must take into account the physical and socioeconomic considerations of both water and food security in this study a framework for the generation and assessment of alternative cropping patterns in arid regions acpar was developed acpar is an optimization simulation framework that was introduced to assist decision makers in comprehensive planning for agriculture by changing cropping patterns while considering the impacts on important national variables such as the water demand for agriculture wda agriculture gross margin gm economic costs of import eci and virtual water food imports vwi egypt was considered a representative case of arid regions to apply the framework generate a large number of alternative cropping patterns acps and investigate the tradeoffs among different objectives the national fertilizer application rate desired percent of national food self sufficiency and inter annual variability of the gm and eci were considered as additional criteria with threshold values that can be set by decision makers to filter the generated acps the acpar framework uses the nwft model which simulates water resources availability competing uses agricultural crop production and consumption and the food trade of egypt the framework was implemented for the baseline period 1986 2013 as well as under future uncertainty represented by different scenarios up to 2050 twelve combinations of national water and socioeconomic target scenarios and global projections of food prices subject to different shared socioeconomic pathways ssps were considered the results show that the thematic tradeoff that exists when performing the cropping pattern planning in egypt is that minimizing the economic costs of food import and maximizing food self sufficiency come at the cost of increasing agricultural water use and lowering the gross margin of the agriculture sector in the baseline period however egypt s historical cropping pattern hcp implied preferences to minimize the eci and maximize the food self sufficiency in the future the previously adopted policies of increasing total cultivated land area and improving the yields of different crops might not be enough most likely egypt would need to increase the area allocated for wheat cultivation this action increases the water demand of agriculture and reduces the agricultural gross margin which would require other cropping pattern changes such as reducing the areas of water intensive less profitable crops e g other cereals and increasing the areas of water saving highly profitable crops e g vegetables this type of changes to the hcp should be applied carefully as our results show that the performance of acps is highly dependent on the combination of cropping pattern changes performed small differences between cropping patterns could result in deteriorations or improvements of the objective functions relative to the hcp the acpar framework helps to determine robust cropping patterns that can outperform the hcp in all objective functions under wide future conditions using frameworks like acpar that consider conflicting multi objectives helps to minimize possible negative consequences of planning decisions in addition considering future and its uncertainty in cropping pattern planning proved to be significant as this helps in finding cropping patterns that can perform well under a wide range of conditions tradeoffs are easily quantifiable using the acpar framework which connects national water resource management to global food production prices and trade dynamics credit authorship contribution statement ahmed abdelkader conceptualization methodology software formal analysis writing original draft visualization amin elshorbagy conceptualization methodology writing review editing supervision project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors acknowledge the financial support of the natural sciences and engineering research council nserc of canada through the nserc dg grant 403047 author abdelkader also acknowledges the university of saskatchewan s devolved scholarship fund data used in this study are referenced in the manuscript with links to allow readers access to them the sources of data used in this study are as follows faostat http www fao org faostat en data water footprint https waterfootprint org en resources waterstat product water footprint statistics and the international food policy research institute https dataverse harvard edu dataset xhtml persistentid doi 10 7910 dvn xezxt4 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103809 appendix supplementary materials image application 1 image application 2 
358,understanding fluid flow in complex fractured porous media requires an accurate representation of the pore space especially in the presence of both granular pores and fractures which significantly differ in their geometries the effect of such a complex fluid pathway is prominent in fractured sandstones and carbonates which store a significant amount of energy resources digital core analysis allows three dimensional imaging of rock cores at high resolutions to capture essential features such as granular pores fractures and minerals these features are represented by a multi modal grey level histogram later segmentation techniques are applied to these images to uniquely differentiate pores fractures and granular pores from minerals however these segmentation routines are purely based on grey level intensities and hence are incapable of automatically segregating the pore space into granular pores and fractures this paper applies a computer vision technique called contour detection for structural analysis of the entire pore space since fractures are mainly considered planar features we carry out a slice by slice analysis on 3d segmented images of fractured sandstones and carbonates contours of pores granular pores and fractures and their structural properties are read into a principal component analysis followed by a k means clustering algorithm to segregate granular pores from fractures the exploratory analysis showed that the optimum number of principal components required for segregation is 2 for both sandstones and carbonates the test for generalization used the above information for k means clustering in x y and z directions the voxels identified as fractures and granular pores are then merged to give a 3d representation of fractures showing an accuracy greater than 89 when compared to the ground truth labels the permeability differences between reconstructed and labelled fractures for digitally fractured samples were less than 9 for all the directions this analysis provides pathways to better understand competing fluid flow phenomena in pores and fractures and aids in the extraction of pore network models for complex fractured porous media keywords contour detection micro ct porous media fractures clustering digital rock computer vision unsupervised learning 1 introduction fractured rocks store vast amounts of hydrocarbon resources however their complex structure and the presence of granular pores present a unique challenge to the energy industry the importance of these rocks is not limited to the petroleum industry but extends to groundwater resources renewable sources of energy such as geothermal energy and co2 geo sequestration finkbeiner et al 2019 two of the most important lithologies encountered for the above are sandstones and carbonates barker et al 1988 cooke et al 2006 jenkins et al 2009 olson et al 2009 ouenes 2000 ozkaya and richard 2006 to reliably store and extract energy from these sources it is important to characterize granular pores and fractures accurately and model fluid flow in such a complex medium blunt 2001 blunt et al 2013 sahimi 2011 this paper will carry out a novel pore scale structural analysis for fractured porous media by applying a computer vision and unsupervised machine learning framework characterizing and modelling flow in fractured rocks presents a unique challenge because both fractures and granular pores have significant differences in their geometries and conductivity characteristics blunt 2001 blunt et al 2013 sahimi 2011 jing et al 2017 su et al 2015 fractures are considered planar structures with rough walls adler et al 2013 mostaghimi et al 2017 sahimi 2011 their geometry differs in various ways from pores 1 fractures are elongated structures 2 they have an orientation 3 their width is much lower than their length and 4 their length can reach the domain size of the investigated porous medium berre et al 2019 these differences in the geometries profoundly affect the flow simulations mostaghimi et al 2015 in the context of a pore scale flow fractures improve connectivity and hence significantly increase the permeability of the porous medium adler et al 2013 however this also means that competing fluid flow processes occur in a porous medium through both fractures and granular pores in addition to quantifying this physical effect pore network extraction for fast computation of permeabilities requires a distinction between pores and fractures so that appropriate extraction techniques such as maximum ball and the medial surface algorithm can be applied jiang et al 2017 jing et al 2020 have recently developed a pipe network model to address the issues regarding the extraction of pnms for fractured media information regarding pores fractures and mineral phases of rock samples can be obtained from high resolution micro ct tomography based on variations in the grey level intensities cnudde and boone 2013 iassonov et al 2009 leu et al 2014 li et al 2017 mostaghimi et al 2017 schlter et al 2014 wildenschild and sheppard 2013 low grey level intensities represent the low density pores and kaolinites whereas the high density minerals phases such as quartz ankerite and zircon are represented by high grey level intensities singh et al 2019 these differences in variation can be captured in frequency based grey level histograms cnudde and boone 2013 iassonov et al 2009 mostaghimi et al 2017 schlter et al 2014 wildenschild and sheppard 2013 or second order statistical maps singh et al 2019 singh et al 2020 as a common practice the original micro ct images or greyscale images are segmented by thresholding techniques such as otsu thresholding watershed segmentation or converging active contours cnudde and boone 2013 iassonov et al 2009 rezaei et al 2019 schlter et al 2014 wildenschild and sheppard 2013 for a system composed of either fractures or granular pores the segmentation technique provides a means to segregate pores and mineral phases such that the fluid flow approximations can be applied directly to the pore phase for accurate permeability estimations chung et al 2019 elkhoury et al 2019 rabbani et al 2019 wang et al 2019 however for complex fractured porous media where there are both fractured and granular pore spaces there is no such distinction based on pore geometry type thresholding using grey level intensities does not provide a direct method to segregate fractures and granular pores in a micro ct image an in depth structural and shape analysis of the pore space is required to differentiate pore structures computer vision can assist in this process by using the contour detection method duda et al 2012 horaud and brady 1988 loncaric 1998 nabizadeh and kubat 2017 pavlidis 1980 different shape descriptors have been then applied to contours for further analysis celebi and aslandogan 2005 these shape descriptors include fourier descriptors chun peng et al 2016 folkers and samet 2002 iwata and ukai 2002 persoon and fu 1977 and image moments such as raw or spatial moments central moments and hu moments flusser et al 1996 kotoulas and andreadis 2005 teh and chin 1988 while computer vision provides a means to calculate granular pores and fractures structural properties an additional method to segregate these into different classes is necessary for this task machine learning can be used in recent times both supervised and unsupervised machine learning have been extensively used in porous media applications tahmasebi et al 2020 these applications include predicting porous media properties alqahtani et al 2020 kamrava et al 2020 rabbani et al 2020 santos et al 2020 sudakov et al 2019 yesiloglu gultekin et al 2013 segmenting grayscale rock images niu et al 2020 reconstructing 3d porous media mosser et al 2017 providing super resolution rock images from low resolution images wang et al 2020 niu et al 2020 classification of rocks based on petrophysical properties da silva et al 2015 identifying sweet spots in shale reservoirs tahmasebi et al 2017 and characterizing flow regimes in core flooding data ni and benson 2020 despite its extensive use in the domain of rock micro ct images machine learning techniques have not yet been employed to differentiate granular pores from fractures using the structural properties obtained via computer vision algorithms this paper presents a novel application of contour detection a computer vision based technique coupled with k means clustering an unsupervised machine learning algorithm to distinguish between fractures and granular pores in a 3d segmented image we use experimentally induced and digitally induced fractured samples of sandstone and carbonate in this study the paper starts by describing granular pore and fracture geometries as contours with 20 unique structural properties these properties are subsequently analysed using the principal component analysis to transform and reduce the high dimensionality feature space this is followed by a k means clustering based identification and segregation of contours into two main classes fractures and granular pores the results of the clustering analysis are then compared against ground truth images to estimate the accuracy and reliability of the proposed clustering workflow 2 materials and methods 2 1 digital images we use segmented images of four fractured rocks bentheimer sandstone s4 sandstone indiana limestone and portland carbonate fig 1 the fractures in bentheimer sandstone and indiana limestone were induced in the laboratory and by a mechanical press respectively and later the rocks were imaged at tyree x ray micro ct facility the original micro ct images or greyscale images were then segmented using a watershed algorithm in avizo 9 0 software to benchmark the algorithm developed here segmented images for s4 sandstone dong and blunt 2009 and portland carbonate saurabh et al 2014 were sourced from a tomography image database of imperial college london and then fractures were digitally induced in the image appendix a the location of these fractures is therefore known and can be used to test the proposed technique s reliability the resolution size of the micro ct images investigated and fracture apertures are described in table 1 2 2 proposed approach for fracture identification in digital micro ct images fractures are 2d features that generally occur as long thin structures in at least two directions depending on their orientation in the x y and z directions while this inherent definition of a fracture should allow us to tell it apart from the granular pores there are challenges when 1 rocks are highly porous even in the absence of a fracture because of the wide range of granular pore structures that could be highly connected and 2 the fractures exhibit more complex shapes and structures such as branches or curved shapes this study proposes a plane by plane analysis independently in the x y and z directions such a plane by plane analysis in which the pore space appears to be composed of many disconnected pieces allows a per piece shape analysis here we follow a three step approach to identify fractures in rock micro ct images as shown in fig 2 the first step fig 2a is to find contours of pores and calculate contour properties by taking advantage of the opencv library and its contour detection functionality the second step fig 2b is to analyse pore contour shapes and cluster it into fractures and non fractures or granular pores using the principal component analysis pca and k means clustering the third step fig 2c is to merge data from all the directions to reconstruct a distinctly labelled 3d fractured micro ct image the proposed approach uses the strength of unsupervised machine learning algorithms such as k means clustering this is a highly scalable technique that utilizes contours underlying structural properties to segregate them into granular pores and fractures clusters such a combination of pca and k means clustering allows us to explain the results of the clustering in addition to this this approach does not require long hours of training and manually labelled data for the analyses given that the number of fractures is significantly lower than the granular pores we are faced with an imbalanced class problem using supervised machine learning techniques such as random forests in such a case would emphasize on achieving higher accuracy of identifying granular pores than fractures this problem is in addition to the fact that a large amount of training data of labelled contours will be required to avoid overfitting when using supervised machine learning techniques considering the above challenges we propose the fracture identification analyses using unsupervised machine learning techniques such as principal component analysis and k means clustering the three step approach is further explained below step 1 contour detection and structural analysis of pore space contour detection is a 2 d topological based border following algorithm rosenfeld and kak 1982 suzuki and abe 1985 appendix b explains the contour detection algorithm and conditions that must be satisfied by a pixel to be called a border pixel this contour detection is implemented via the findcontours function in opencv bradski 2000 and is carried out in each direction independently to find contours of the pore space region including fractures fig 2a once the contours or the borders of pores in the image are detected a structural analysis is carried out by calculating properties for each of the contour identified these properties are calculated directly on the contours or by fitting an ellipse or a bounding rectangle around the contour the properties include i perimeter ii aspect ratio for ellipses iii aspect ratios for rectangles iv spatial moments and v central moments bradski 2000 there are ten spatial moments and seven central moments the zeroth order moment describes the contour area the first order moment describes the centre of mass the second order moment describes the moment of inertia and the remaining higher order moments describe projection skewness and kurtosis rahman et al 2019 both spatial and central moments are scale dependant whereas the aspect ratios are scale independent features it is important to have both classes of features so that the most distinguishing feature that segregates the fractures and pores is identified used by the clustering algorithm thus for every contour identified there are 20 properties calculated the formulas to calculate contour properties are listed below aspect ratio for a fitted ellipse and bounding rectangle of a contour is calculated as 1 a s p e c t r a t i o e l l i p s e m a j o r a x i s l e n g t h m i n o r a x i s l e n g t h 2 a s p e c t r a t i o b o u n d i n g r e c t a n g l e w i d t h h e i g h t spatial moments mji are calculated as 3 m ji x y a x y x j y i central moments muji are calculated as 4 m u j i x y a x y x x j y y i where a x y is a 2d binary image representing image intensities 0 s and 1 s and x y is the centroid of the contours step 2 segregating pore contours into clusters of granular pores and fractures step 2a principal component analysis principal component analysis pca is an unsupervised learning technique that finds new axes or new variables a review of the basic method and recent developments can be found in jolliffe and cadima 2016 in this application s context the pca transforms the original feature space of contour properties such that when projected onto the new axes the clusters of granular pores and fractures are well separated wold et al 1987 the set of 20 contour properties for every contour in a sample form the original feature space also known as the high dimensional feature space therefore the high dimensional feature space is a p q matrix where p is the number of contours and q is the number of contour properties 20 this is used as an input to the pca after pca is applied there are two main outputs a principal components and b principal component scores and principal component loadings lever et al 2017 principal component axes are linear combinations of contour property variables such as contour perimeter aspect ratios spatial moments and central moments and are orthogonal i e uncorrelated to each other the maximum number of pcs that can be found equals the number of contour properties i e 20 pcs can be found each pc is associated with a variance variance describes how much information is captured by each pc the first pc has the highest variance the second pc has the second highest variance and so on the total variance captured by all pcs together is 100 using pcs with higher variance allows better segregation contours into clusters of granular pores and fractures while retaining most of the high dimensional feature space information principal component loadings is a weight matrix that transforms the high dimensional feature space into principal component scores that can be projected onto the principal component axes these principal component scores form the transformed data matrix these principal component scores zk are given by 5 z k i p i w i where k 1 m and i 1 n w represents the weights that transform each row contour properties into principal component scores m represents the dimensions or the total number of pcs such that the total variances captured by all the pcs is 100 for practical cases the number of pcs chosen is less than m thus the advantage of using pca is three fold a allows better segregation of clusters by projecting it onto axes that capture high variances b lower number of pcs or new variables can be used to achieve the better segregation still and c pcs allows more insights into better understanding about which combination of contour properties is the most important for segregating fracture and granular pore contours in this study the pca technique is implemented using scikit learn pedregosa et al 2011 once the pcs are calculated the k means clustering algorithm is applied to cluster contours macqueen 1967 k means clustering is applied for all combinations of pcs ranging from the minimum of two pcs up until all the 20 pcs are used then the optimum number of pcs is found by analysing clustering metrics that allow the best segregation while using the lowest number of pcs step 2b k means clustering k means clustering is an unsupervised machine learning technique that identifies a pre defined number of centroids and clusters a data points close to a centroid by minimizing inertia or squared euclidean distances to the closest centroid lloyd 1982 macqueen 1967 k means clustering is an iterative process with the stop criteria being minimum inertia the number of clusters r is a priori for the k means clustering algorithm and hence it needs to be estimated before the implementation for the clustering analysis in this study the k means algorithm is implemented using scikit learn pedregosa et al 2011 the input data to k means clustering is the principal component scores of all the contours for each sample the number of clusters r is chosen to be two because we aim to segregate fractures from granular pores first the k means algorithm assigns each contour granular pore and fracture to a cluster with a particular centroid second the square of euclidean distances of each data point from the centroid is computed and averaged third this average or mean is the new centroid of the cluster and the points are reassigned to each cluster this three step iterative process is repeated until the centroid does not move or the stop criteria is reached the mathematical description of the stop criteria or inertia minimization can be described as below 6 i 0 a min  j c a x i  j 2 where xi are the data points within the cluster whose centroid is given by ca and  j is the mean of all the data points in every cluster fracture and granular pores the output of k means clustering is the centroid location for each cluster of granular pores and fractures as well as the contours labels assigned to each cluster the output of the k means analysis is visualized using the pc axes fig 2b the main reason to group all the fracture contours in one cluster is that the geometry of fractures in the samples used in this study is relatively simple with no branched networks if there are more complex shapes then a more in depth analysis of the optimum number of clusters needs to be carried out we have provided a discussion regarding this in section 3 3 k means clustering for fractures with varied aperture sizes and complex fracture networks step 3 merge criteria for 3d analysis since fractures are 2d planar structures steps 1 and 2 are carried out independently for all three directions x y and z direction and then the labelled data of fractures and granular pores are merged for all three directions fig 2c shows an example of how the merge criterion works for the case of bentheimer sandstone to reconstruct the 3d image of the pore space with fractures labelled differently to granular pores fractures contours are first identified in x y and z directions with discretization i e slicing kept constant 1 voxel in the three directions if a voxel is identified as a fracture in more than 2 directions it is labelled as a fracture in the 3d reconstructed image 2 3 robustness of fracture identification workflow we categorized the digital images in table 1 for two main purposes i exploratory analysis and ii test for generalization 2 3 1 exploratory analysis fractured bentheimer sandstone and fractured indiana limestone are used for exploratory analysis fig 3 this exploratory analysis serves as the first checkpoint to test the robustness of the fracture identification workflow the purpose of carrying out exploratory analysis is to answer the following questions does the proposed approach with contour properties contour perimeter aspect ratios spatial and central moments pca and k means clustering help in identifying fracture contours and granular pore contours what is the optimum number of principal components necessary to achieve good segregation between fracture and granular pore clusters for this purpose we carry out an analysis of experimentally fractured samples bentheimer sandstone and indiana limestone the fracture identification for the exploratory analysis is purely 2d and is carried out in a slice by slice fashion in the z direction for both samples independently to test the clustering analysis and answer the above questions we have manually labelled all the pore contours fracture and granular pores in z direction for both bentheimer sandstone and indiana limestone which serves as the ground truth of this study 2 3 2 evaluation metrics exploratory analysis we use two main metrics i adjusted rand index ari hubert and arabie 1985 and ii homogeneity rosenberg and hirschberg 2007 to test the accuracy of the proposed approach and identify the optimum number of pcs needed to achieve the highest accuracy ari measures the clustering algorithm s accuracy and is adjusted for chance hubert and arabie 1985 rand 1971 its expected value is between 0 and 1 while accuracy is a well known metric used to validate the results of a machine learning algorithm it assumes that there are balanced classes of the entities we are trying to cluster i e we have the same number of granular pores and fractures however we have imbalanced classes for the samples used here because the number of fracture contours is significantly less than the number of granular pore contours therefore to complement the accuracy metric and overcome its drawback we use homogeneity homogeneity is an entropy based metric that measures if the entities of the same class are assigned to the same cluster rosenberg and hirschberg 2007 i e all contours that belong to the classes of fractures are assigned to a cluster of all fractures and all contours that belong classes of granular pores are assigned to a cluster of all granular pores this ensures that contours with similar structural properties are grouped and are well differentiated from the clusters that significantly differ in the properties similar to ari homogeneity has a value ranging between 0 and 1 a high value close to 1 for both ari and homogeneity confirms that the proposed approach of using contour properties pca and k means clustering can be used to identify fracture and granular pore clusters then the lowest number of pcs for which both ari and homogeneity have the highest value gives us the optimum number of pcs required to achieve good segregation of contours for both sandstone and carbonate samples 2 3 3 test for generalization once the optimum number of pcs required for fracture identification in experimentally fractured samples bentheimer sandstone and indiana limestone is estimated we extend the approach to identify fractures in digitally fractured samples in 3d this is the primary objective of the test for generalization for the 3d fracture analysis we use s4 sandstone and portland carbonate fig 3 the main reason for using digitally fractured samples and not experimentally fractured samples is that the voxel by voxel location of the fracture for the 3d image is known only in the case of the digitally fractured samples we identify fractures independently in x y and z directions and then merge the voxels that have been identified as fractures the criteria used to merge voxels is shown in step 3 merge criteria which states that if the voxel is identified as a fracture in two or more than two directions then it is a fracture voxel otherwise it is labelled as a pore voxel the optimum number of pcs and parameters for k means clustering used for s4 sandstone and portland carbonate is the same as that of bentheimer sandstone and indiana limestone respectively the rationale behind this assumption is that both bentheimer and s4 sandstone belong to the broader class of sandstones while indiana limestone and portland carbonate belong to the broader class of carbonates hence the geometrical properties of fractures in comparison to pores will show unique distinctions for each lithology such an analysis will also serve as a test for generalization 2 3 4 evaluation metrics test for generalization for the 3d fracture analysis we present a voxel by voxel accuracy test based on a confusion matrix the confusion matrix considers the voxel location and the type of pore it represents i e granular pore or fracture a positive outcome is when a voxel is identified as contributing to the fracture and a negative outcome is a case where a pore is identified as contributing to the granular pore in such a case we have four main categories true positives tp both clustering based voxel label true and ground truth label true indicate that the voxel is a part of the fracture true negative tn both clustering based voxel label false and ground truth label false indicate that the voxel is a part of the granular pore false positive fp clustering based voxel label true indicates that the voxel is a part of the fracture and ground truth label false indicates that the voxel is a part of the granular pore false negative fn clustering based voxel label false indicates that the voxel is a part of the granular pore and ground truth label true indicates that the voxel is a fracture we then calculate the accuracy precision and recall metrics as follows 7 a c c u r a c y t p t n t p t n f p f n 8 p r e c i s i o n t p t p f p 9 r e c a l l t p t p f n accuracy is a measure of the overall performance i e it considers both fractures and granular pores that have been identified correctly and incorrectly precision emphasizes the impact of false positives while recall highlights the impact of false negatives for fractured porous media samples where there is a competing flow pathway provided by both fractures and granular pores recall and precision play an important role if the fractures are the main flow channels for the media it is advisable to have a higher recall over precision higher recall means the number of fracture voxels is over predicted ensuring that most fracture voxels are identified and there is no loss of fracture connectivity similarly if the granular pores provide the main pathway for fluid flow it is advisable to have higher precision over recall 3 results and discussion 3 1 exploratory analysis the experimentally fractured samples bentheimer sandstone b1 b2 b3 and indiana limestone l1 l2 l3 are investigated in a slice by slice fashion in the z direction to identify contours and calculate contour properties for the bentheimer sandstone the high dimensional feature space is a 117 270 20 data matrix whereas for indiana limestone the high dimensional feature space is 12 069 20 data matrix fig 4 shows the results of pca when applied to the high dimensional feature space of fractured bentheimer sandstone and fractured indiana limestone the transformed data matric for both samples will have the same dimensions as the high dimensional feature space except that the columns now represent 20 pcs fig 4 a b shows pcs with the amount of variance they capture the sum of the variances captured by these pcs is equal to 100 fig 4 c d is a heatmap showing the weights of the contour properties contributing to each of the principal components understanding the weights and their contributions to pcs tells us which properties allow the best segregation of granular pore contours and fracture contours for both bentheimer sandstone and indiana limestone pc1 highlighted in red box contributes almost equally from contour perimeter spatial moments and a few central moments fig 4 c d the contribution of aspect ratios ellipse and rectangle is only prominent for the fractured indiana limestone in pc2 while central moments are a major contributor to pc2 for the bentheimer sandstone for the case of fractured bentheimer sandstone it is interesting to note that both aspect ratio for a fitted ellipse or rectangle does not contribute to the first few pcs that capture a large proportion of the variance this is because bentheimer sandstone is a high porosity rock with pores of varied sizes some of these pores are thin and elongated and appear to have similar structural contour properties as that of the fracture before we apply k means clustering we choose the first two principal components because they capture high variance and should segregate the granular pore and fracture clusters relatively well for the fractured bentheimer sandstone the sum of the variances captured by pc1 and pc2 is 66 8 whereas it is 87 1 for indiana limestone using only the first two pcs then reduces the high dimensional feature space to 117 270 2 data matrix and 12 069 2 data matrix for bentheimer sandstone and indiana limestone respectively fig 5 shows the result of k means clustering for both bentheimer sandstone and indiana limestone two main clusters can be identified from both the scatter plots one representing pores in orange and the other representing fractures in green to further understand the reasoning behind using 2 pcs and whether using a higher number of pcs would lead to better clustering we use evaluation metrics ari and homogeneity as mentioned previously we choose a different number of pcs carry out k means clustering for each pc combination and calculate the 2 metrics by comparing it to the contours ground truth labels fig 6 shows the value of ari and homogeneity for different numbers of pcs for fractured bentheimer sandstone ari and homogeneity remain constant at 99 7 and 99 1 respectively except for when 9 pcs are used the values are insignificantly higher for fractured indiana limestone ari and homogeneity remain constant at 96 and 89 6 respectively the optimum number of pcs is the lowest value of pc for which the highest ari and homogeneity are achieved thus the optimum number of pcs required to achieve the best segregation between pores and fractures is 2 for both sandstones and carbonates the above exploratory analysis show that using a combination of pca and k means clustering allows segregation of contours granular pores and fractures with high accuracy of greater than 96 using pca provides insights for which contour properties have good differentiating power and play an important role in the clustering algorithm in addition to this pca reduces the high dimensional feature space to a low dimensional feature space with just 2 pcs while retaining the most important information to achieve the highest value for the evaluation metrics k means clustering can be performed without the pca step however without the pca analysis k means clustering is less efficient in creating well separated clusters which means the granular pores and fractures will be misidentified pca provides new and reduced dimensions for better segregation ding and he 2004 and hence we chose to use it 3 2 test for generalization learning from the exploratory analysis we now use two principal components for k means clustering to identify fractures in digitally fractured samples s4 sandstone and portland carbonate in x y and z directions fig 7 shows the scatter plots generated from the k means clustering algorithm using two principal components and two clusters one representing pores and second representing fractures the use of two clusters to achieve a good fracture and pore segregation is supported by an objective analysis using the silhouette score appendix c provides an in depth discussion for determining the number of clusters for the k means algorithm for s4 sandstone ss1 sample fig 1d we can see that the clustering results for x and z direction fig 7a c show two well distinguished clusters while for the y direction fig 7b the clusters are rather sparse and show large deviations this is because x and z directions are parallel to the fracture plane and hence the fracture geometry is well captured on the contrary the y direction is perpendicular to the fracture plane wherein the fracture can be represented by an entire slice in a 3d image for s4 sandstone ss2 sample fig 1e x and y directions fig 7d e are parallel to the fracture plane because clusters of fractures and pores are well segregated the z direction of the ss2 sample fig 7f is an exception where three clusters were introduced instead of the usual two clusters determined by the silhouette score analysis this is because the two fractures in the ss2 sample are orientated differently which affects how they are perceived in the z direction one of the fracture planes is orientated at an angle 45 to the z direction however the other fracture plane is perpendicular to the z direction both the fractures have vastly different structural properties when the direction of investigation is the z direction therefore to capture both these fractures and granular pores we introduced another cluster this also ensures that we capture connectivity of fractures in all the directions especially for the fracture orientated at an angle 45 to the z direction for the case of portland carbonate both the samples p1 and p2 fig 7g h j k show well separated clusters for x and y directions because these directions are parallel to the fracture plane however clusters for p1 and p2 fig 7i l for the z direction are sparse for the case of fractures which indicate that the z direction is perpendicular to the fracture plane thus k means clustering enables identification of fracture versus granular pores and allows the identification of directions that are parallel to the fracture plane once the fractures are identified in x y and z directions for each of the samples we merge all the voxels that are highlighted by the fracture contours and granular pore contours to give a 3d fracture and granular pore identification fig 8 the confusion matrix shows the details regarding the performance of the merge criteria and clustering algorithm the evaluation metrics calculated from the confusion matrix accuracy precision and recall are shown in the graph on the right for all the samples the voxel by voxel accuracy is greater than 89 for both s4 sandstone and portland carbonate fractures provide the main pathway for fluid flow so it is preferred to have a higher recall than precision in such a case refer to section 2 3 4 evaluation metrics test for generalization this is consistent with recall and precision metrics in fig 8 for both the samples where recall is higher than precision while the confusion matrix and the corresponding metrics allow comparison of fracture and granular voxels it does not measure whether connectivity is preserved for this we calculate fracture permeability chung et al 2019 of the reconstructed fracture fig 8 green region vs the fracture permeability of the labelled fractured image the left column in fig 8 shows the permeability analysis results as the percentage difference in the permeability for different directions for most samples where two clusters were used for fracture identification the difference in permeability is less than 5 indicating that most of the conductivity is preserved when using the merge criteria even for the z direction of ss2 sandstone fig 7f if only two clusters similar to other samples were used we are still able to segregate fractures from pores with a reasonable accuracy wherein the permeability differences are about 25 36 in the x and y direction however use of three clusters based on an additional visual analysis provided more accurate results with permeability difference reduced to 4 5 8 8 fig 8b on the other hand there is a minor loss of connectivity in x direction permeability for p1 carbonate fig 8c as seen in the percentage difference of 7 4 this loss of connectivity occurs because the clustering algorithm misclassified some of the fracture contours and hence the subsequent merging labelled it as granular pores 4 k means clustering for fractures with varied aperture sizes and complex fracture networks the analyses in the previous sections illustrated the robustness of the proposed fracture identification workflow fractures can often have varied aperture sizes or have more complex structures such as branched networks and curved shapes as shown in fig 9 the fractures in bentheimer sandstone fig 9a show aperture sizes of 1 8 and 3 7 compared to the thinnest fracture when the fracture identification workflow is applied fracture contours are well separated from the granular pores in fig 9b and are identified as a part of the single cluster cluster 2 fig 9c shows the fractures highlighted in green after being identified using k means clustering on the other hand fig 9d shows complex fracture systems for the case of doddington sandstone both branched and curved fractures are identified by the k means clustering as seen by green clusters in fig 9e and green fracture regions in fig 9f one noticeable feature of the k means clustering is that the fracture cluster points are very dispersed because of the large variety in the fracture geometries encountered in fig 9d overall for both cases the predetermined setting of 2 pcs and 2 clusters inferred from silhouette score analysis identified fractures with reasonable accuracy with only one misclassification highlighted in a red circle in fig 9f 5 improvements for the fracture identification workflow the methodologies used in this paper prove to have high accuracy in identifying voxels that are a part of fracture or granular pores the small inaccuracies in both fracture and granular pore voxel identification in section 3 2 arise from two main reasons 1 the fracture contours were not identified in the x y or z direction by k means clustering and 2 the fracture identification is a 2d slice by slice process for the 3d volume the second reason encapsulates the first some of the fractures in a single 2d slice extend laterally because they connect large pores however the fractures might not extend laterally in the subsequent slices this is particularly noticeable in high porosity systems such as sandstones an important aspect for future work is extending this work into a fully automated 3 d fracture identification framework where fracture contours are identified in 3d rather than slice by slice then a sensitivity analysis needs to be carried out to determine the number of clusters in complex fracture networks 6 conclusions the application of contour detection and k means clustering for fracture identification is a significant advancement for the characterization of fractured porous media images a combination of three key steps was used to identify the fractures and segregate them from granular pores 1 contour detection computer vision concept and 2 pca and k means clustering unsupervised machine learning method 3 merge criteria the number of principal components for fracture contour identification was chosen using a sensitivity study and calculating adjusted rand index and homogeneity metrics for experimentally fractured samples this was a part of the 2d exploratory study carried out on fractured bentheimer sandstone and indiana limestone in the z direction on a slice by slice basis once the optimum number of pcs was identified the analysis was extended to 3d and tested for generalization by applying the parameters of pc contour detection and k means to other sandstones and carbonate rock images two digitally fractured samples fractured s4 sandstone and portland carbonate were used to test for generalization the k means clustering algorithm identified fractures in x y and z directions and also provided insights about the fracture for most of the samples the use of two clusters provided a good segregation between granular pores and fractures an objective analysis using the silhouette score also supported the use of two clusters for fracture identification when the fracture voxels from the three directions were combined and compared to the ground truth labels the accuracy was over 89 for all samples the permeability differences between reconstructed and labelled fractures for digitally fractured samples were less than 9 for all the directions the slight inaccuracies in the fracture identification were attributed to two main factors 1 the fracture contours were not identified in the x y or z direction by k means clustering and 2 the fracture identification is a 2d slice by slice process for the 3d volume extending the fracture workflow to a fully automated 3d search such that the contour detection is performed as a volume compared to the slice by slice approach as currently carried out will help alleviate the inaccuracies additional analysis to understand the impact of the number of clusters for complex fracture networks will also need to be incorporated credit authorship contribution statement ankita singh conceptualization methodology software validation formal analysis data curation visualization writing original draft arash rabbani data curation visualization writing review editing klaus regenauer lieb visualization writing review editing supervision ryan t armstrong writing review editing supervision peyman mostaghimi conceptualization methodology resources writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the jupyter notebooks for the fracture identification analysis are available via https github com ankitaeclipse fracture pore identification we would like to acknowledge the contributions of adelina lv for sample preparation and the tyree x ray ct facility a unsw network lab funded by the unsw research infrastructure scheme for the acquisition of the 3d micro ct images the micro ct images of portland carbonate are courtesy of qatar carbonates and carbon storage research centre at imperial college london we would also like to thank the editor and anonymous reviewers for their valuable comments that improved the contents of this manuscript appendix appendix a workflow to induce fracture digitally in micro ct images the pseudo fractures are created based on the min cut theorem with an energy minimization approach as described by boykov and kolmogorov 2001 kolmogorov and zabin 2004 initially we draw the flat surface of a fracture with the desired orientation and through an iterative optimization we gradually deform the plane to cut the geometry at the locations in which cohesive energy is minimal fig a1 a for example in sandstones such locations would be the touching interfaces of grains in which they are partially fused due to the subsurface overburden pressure if we introduce a tensile force on such a structure the min cut theorem states that the sample is more likely to be detached at those weak bonds after detecting the minimal energy path two segments of the sample at both sides of that path are displaced to satisfy the favourable fracture aperture fig a1b appendix b contour detection or border following algorithm in opencv the contour detection or border following algorithm was first introduced by rosenfeld and kak 1982 to detect outer borders of objects and later modified by suzuki and abe 1985 to include additional conditions to both detect outer borders and hole borders in an object fig b1 the terms border and contour are used interchangeably and mean the same the algorithm proposed by suzuki and abe 1985 is implemented in the findcontours functionality of opencv the border following algorithm identifies contours of objects labelled as 1 s as against the background labelled as 0 s by scanning the entire intensity image or segmented image in a pixel by pixel manner in an 8 connected neighbourhood if a i j is the intensity image with i and j representing the rows and columns then the border identification algorithm only applies to every non zero pixel values the algorithm scans the intensity image pixel by pixel until a pixel meets the conditions of the the starting point of the outer or the hole border a outer border condition and b hole border condition suzuki and abe 1985 fig b2 for example in fig b3 a the starting point is a 1 3 1 in red once the starting point is determined the algorithm memorizes every new found border with a unique number called the new border or nbd the first pixel by pixel investigation of the intensity image gives us the complete border or contour for the outer region fig b3 b indicated by 2 or 2 the and signs are based on the marking policy outlined by suzuki and abe 1985 the second scan of the intensity image starts at the pixel that first satisfies the condition of the hole border fig b3 c for the second scan nbd is updated to 3 or 3 the pixel by pixel investigation is again repeated until the lowermost pixel of the image is reached and the resulting hole border identified is shown in fig b3 d appendix c silhouette score analysis to determine the number of clusters for k means clustering the number of clusters r is determined using the silhouette score analysis silhouette score measures the separation between clusters and how likely a data point is assigned to the correct cluster rousseeuw 1987 the value of silhouette score ranges between 1 1 and is calculated using the euclidean distance metric the formula to calculate the silhouette score is c1 s i l h o u e t t e s c o r e s t m a x s t where s is the mean of pairwise distances between points of the same cluster or intra cluster distance and t is the mean of pairwise distance of each point of one cluster to another point of the nearest cluster or nearest cluster distance pedregosa et al 2011 rousseeuw 1987 a value of 1 indicates that the clusters are well separated while a value of 1 indicates the clusters are not well separated and that data points are assigned to the wrong clusters the k means algorithm is carried out with different number of clusters and a silhouette score is calculated for each scenario the number of clusters for which the silhouette score has the highest value is the optimum number of clusters to be used for k means clustering analysis for the case of digitally fractured samples the number of clusters can be determined for each sample and for every direction x y and z using the silhouette score analysis the graph showing the silhouette score for different number of clusters is shown in fig c1 silhouette score analysis indicated that for four cases we needed a third cluster instead of two clusters as proposed in fig 7 a third cluster was needed for the following rock samples 1 ss2 sandstone x direction fig c1b blue 2 ss2 sandstone y direction fig c1b orange 3 p1 carbonate z direction fig c1c grey 4 p2 carbonate z direction fig c1d grey fig c2 shows the differences in clustering when number of clusters 2 used in fig 7 vs number of clusters 3 based on silhouette score analysis the reason why we see another cluster representing the fractures in s4 sandstone fig c2a d is because one fracture is orientated at 45 to x y and z direction whereas the other fracture is orientated parallel to x and y direction as for the z direction of portland carbonate fig c2e h the fracture plane is perpendicular to the direction of investigation and hence the variation in the structural properties is quite large the main aim of this study is to segregate granular pores and fractures into well separated clusters based on the above analysis the use of two cluster gives us the same accuracy level as three clusters in identifying fracture contours from granular pore contours therefore the use of two clusters for this is fully sufficient 
358,understanding fluid flow in complex fractured porous media requires an accurate representation of the pore space especially in the presence of both granular pores and fractures which significantly differ in their geometries the effect of such a complex fluid pathway is prominent in fractured sandstones and carbonates which store a significant amount of energy resources digital core analysis allows three dimensional imaging of rock cores at high resolutions to capture essential features such as granular pores fractures and minerals these features are represented by a multi modal grey level histogram later segmentation techniques are applied to these images to uniquely differentiate pores fractures and granular pores from minerals however these segmentation routines are purely based on grey level intensities and hence are incapable of automatically segregating the pore space into granular pores and fractures this paper applies a computer vision technique called contour detection for structural analysis of the entire pore space since fractures are mainly considered planar features we carry out a slice by slice analysis on 3d segmented images of fractured sandstones and carbonates contours of pores granular pores and fractures and their structural properties are read into a principal component analysis followed by a k means clustering algorithm to segregate granular pores from fractures the exploratory analysis showed that the optimum number of principal components required for segregation is 2 for both sandstones and carbonates the test for generalization used the above information for k means clustering in x y and z directions the voxels identified as fractures and granular pores are then merged to give a 3d representation of fractures showing an accuracy greater than 89 when compared to the ground truth labels the permeability differences between reconstructed and labelled fractures for digitally fractured samples were less than 9 for all the directions this analysis provides pathways to better understand competing fluid flow phenomena in pores and fractures and aids in the extraction of pore network models for complex fractured porous media keywords contour detection micro ct porous media fractures clustering digital rock computer vision unsupervised learning 1 introduction fractured rocks store vast amounts of hydrocarbon resources however their complex structure and the presence of granular pores present a unique challenge to the energy industry the importance of these rocks is not limited to the petroleum industry but extends to groundwater resources renewable sources of energy such as geothermal energy and co2 geo sequestration finkbeiner et al 2019 two of the most important lithologies encountered for the above are sandstones and carbonates barker et al 1988 cooke et al 2006 jenkins et al 2009 olson et al 2009 ouenes 2000 ozkaya and richard 2006 to reliably store and extract energy from these sources it is important to characterize granular pores and fractures accurately and model fluid flow in such a complex medium blunt 2001 blunt et al 2013 sahimi 2011 this paper will carry out a novel pore scale structural analysis for fractured porous media by applying a computer vision and unsupervised machine learning framework characterizing and modelling flow in fractured rocks presents a unique challenge because both fractures and granular pores have significant differences in their geometries and conductivity characteristics blunt 2001 blunt et al 2013 sahimi 2011 jing et al 2017 su et al 2015 fractures are considered planar structures with rough walls adler et al 2013 mostaghimi et al 2017 sahimi 2011 their geometry differs in various ways from pores 1 fractures are elongated structures 2 they have an orientation 3 their width is much lower than their length and 4 their length can reach the domain size of the investigated porous medium berre et al 2019 these differences in the geometries profoundly affect the flow simulations mostaghimi et al 2015 in the context of a pore scale flow fractures improve connectivity and hence significantly increase the permeability of the porous medium adler et al 2013 however this also means that competing fluid flow processes occur in a porous medium through both fractures and granular pores in addition to quantifying this physical effect pore network extraction for fast computation of permeabilities requires a distinction between pores and fractures so that appropriate extraction techniques such as maximum ball and the medial surface algorithm can be applied jiang et al 2017 jing et al 2020 have recently developed a pipe network model to address the issues regarding the extraction of pnms for fractured media information regarding pores fractures and mineral phases of rock samples can be obtained from high resolution micro ct tomography based on variations in the grey level intensities cnudde and boone 2013 iassonov et al 2009 leu et al 2014 li et al 2017 mostaghimi et al 2017 schlter et al 2014 wildenschild and sheppard 2013 low grey level intensities represent the low density pores and kaolinites whereas the high density minerals phases such as quartz ankerite and zircon are represented by high grey level intensities singh et al 2019 these differences in variation can be captured in frequency based grey level histograms cnudde and boone 2013 iassonov et al 2009 mostaghimi et al 2017 schlter et al 2014 wildenschild and sheppard 2013 or second order statistical maps singh et al 2019 singh et al 2020 as a common practice the original micro ct images or greyscale images are segmented by thresholding techniques such as otsu thresholding watershed segmentation or converging active contours cnudde and boone 2013 iassonov et al 2009 rezaei et al 2019 schlter et al 2014 wildenschild and sheppard 2013 for a system composed of either fractures or granular pores the segmentation technique provides a means to segregate pores and mineral phases such that the fluid flow approximations can be applied directly to the pore phase for accurate permeability estimations chung et al 2019 elkhoury et al 2019 rabbani et al 2019 wang et al 2019 however for complex fractured porous media where there are both fractured and granular pore spaces there is no such distinction based on pore geometry type thresholding using grey level intensities does not provide a direct method to segregate fractures and granular pores in a micro ct image an in depth structural and shape analysis of the pore space is required to differentiate pore structures computer vision can assist in this process by using the contour detection method duda et al 2012 horaud and brady 1988 loncaric 1998 nabizadeh and kubat 2017 pavlidis 1980 different shape descriptors have been then applied to contours for further analysis celebi and aslandogan 2005 these shape descriptors include fourier descriptors chun peng et al 2016 folkers and samet 2002 iwata and ukai 2002 persoon and fu 1977 and image moments such as raw or spatial moments central moments and hu moments flusser et al 1996 kotoulas and andreadis 2005 teh and chin 1988 while computer vision provides a means to calculate granular pores and fractures structural properties an additional method to segregate these into different classes is necessary for this task machine learning can be used in recent times both supervised and unsupervised machine learning have been extensively used in porous media applications tahmasebi et al 2020 these applications include predicting porous media properties alqahtani et al 2020 kamrava et al 2020 rabbani et al 2020 santos et al 2020 sudakov et al 2019 yesiloglu gultekin et al 2013 segmenting grayscale rock images niu et al 2020 reconstructing 3d porous media mosser et al 2017 providing super resolution rock images from low resolution images wang et al 2020 niu et al 2020 classification of rocks based on petrophysical properties da silva et al 2015 identifying sweet spots in shale reservoirs tahmasebi et al 2017 and characterizing flow regimes in core flooding data ni and benson 2020 despite its extensive use in the domain of rock micro ct images machine learning techniques have not yet been employed to differentiate granular pores from fractures using the structural properties obtained via computer vision algorithms this paper presents a novel application of contour detection a computer vision based technique coupled with k means clustering an unsupervised machine learning algorithm to distinguish between fractures and granular pores in a 3d segmented image we use experimentally induced and digitally induced fractured samples of sandstone and carbonate in this study the paper starts by describing granular pore and fracture geometries as contours with 20 unique structural properties these properties are subsequently analysed using the principal component analysis to transform and reduce the high dimensionality feature space this is followed by a k means clustering based identification and segregation of contours into two main classes fractures and granular pores the results of the clustering analysis are then compared against ground truth images to estimate the accuracy and reliability of the proposed clustering workflow 2 materials and methods 2 1 digital images we use segmented images of four fractured rocks bentheimer sandstone s4 sandstone indiana limestone and portland carbonate fig 1 the fractures in bentheimer sandstone and indiana limestone were induced in the laboratory and by a mechanical press respectively and later the rocks were imaged at tyree x ray micro ct facility the original micro ct images or greyscale images were then segmented using a watershed algorithm in avizo 9 0 software to benchmark the algorithm developed here segmented images for s4 sandstone dong and blunt 2009 and portland carbonate saurabh et al 2014 were sourced from a tomography image database of imperial college london and then fractures were digitally induced in the image appendix a the location of these fractures is therefore known and can be used to test the proposed technique s reliability the resolution size of the micro ct images investigated and fracture apertures are described in table 1 2 2 proposed approach for fracture identification in digital micro ct images fractures are 2d features that generally occur as long thin structures in at least two directions depending on their orientation in the x y and z directions while this inherent definition of a fracture should allow us to tell it apart from the granular pores there are challenges when 1 rocks are highly porous even in the absence of a fracture because of the wide range of granular pore structures that could be highly connected and 2 the fractures exhibit more complex shapes and structures such as branches or curved shapes this study proposes a plane by plane analysis independently in the x y and z directions such a plane by plane analysis in which the pore space appears to be composed of many disconnected pieces allows a per piece shape analysis here we follow a three step approach to identify fractures in rock micro ct images as shown in fig 2 the first step fig 2a is to find contours of pores and calculate contour properties by taking advantage of the opencv library and its contour detection functionality the second step fig 2b is to analyse pore contour shapes and cluster it into fractures and non fractures or granular pores using the principal component analysis pca and k means clustering the third step fig 2c is to merge data from all the directions to reconstruct a distinctly labelled 3d fractured micro ct image the proposed approach uses the strength of unsupervised machine learning algorithms such as k means clustering this is a highly scalable technique that utilizes contours underlying structural properties to segregate them into granular pores and fractures clusters such a combination of pca and k means clustering allows us to explain the results of the clustering in addition to this this approach does not require long hours of training and manually labelled data for the analyses given that the number of fractures is significantly lower than the granular pores we are faced with an imbalanced class problem using supervised machine learning techniques such as random forests in such a case would emphasize on achieving higher accuracy of identifying granular pores than fractures this problem is in addition to the fact that a large amount of training data of labelled contours will be required to avoid overfitting when using supervised machine learning techniques considering the above challenges we propose the fracture identification analyses using unsupervised machine learning techniques such as principal component analysis and k means clustering the three step approach is further explained below step 1 contour detection and structural analysis of pore space contour detection is a 2 d topological based border following algorithm rosenfeld and kak 1982 suzuki and abe 1985 appendix b explains the contour detection algorithm and conditions that must be satisfied by a pixel to be called a border pixel this contour detection is implemented via the findcontours function in opencv bradski 2000 and is carried out in each direction independently to find contours of the pore space region including fractures fig 2a once the contours or the borders of pores in the image are detected a structural analysis is carried out by calculating properties for each of the contour identified these properties are calculated directly on the contours or by fitting an ellipse or a bounding rectangle around the contour the properties include i perimeter ii aspect ratio for ellipses iii aspect ratios for rectangles iv spatial moments and v central moments bradski 2000 there are ten spatial moments and seven central moments the zeroth order moment describes the contour area the first order moment describes the centre of mass the second order moment describes the moment of inertia and the remaining higher order moments describe projection skewness and kurtosis rahman et al 2019 both spatial and central moments are scale dependant whereas the aspect ratios are scale independent features it is important to have both classes of features so that the most distinguishing feature that segregates the fractures and pores is identified used by the clustering algorithm thus for every contour identified there are 20 properties calculated the formulas to calculate contour properties are listed below aspect ratio for a fitted ellipse and bounding rectangle of a contour is calculated as 1 a s p e c t r a t i o e l l i p s e m a j o r a x i s l e n g t h m i n o r a x i s l e n g t h 2 a s p e c t r a t i o b o u n d i n g r e c t a n g l e w i d t h h e i g h t spatial moments mji are calculated as 3 m ji x y a x y x j y i central moments muji are calculated as 4 m u j i x y a x y x x j y y i where a x y is a 2d binary image representing image intensities 0 s and 1 s and x y is the centroid of the contours step 2 segregating pore contours into clusters of granular pores and fractures step 2a principal component analysis principal component analysis pca is an unsupervised learning technique that finds new axes or new variables a review of the basic method and recent developments can be found in jolliffe and cadima 2016 in this application s context the pca transforms the original feature space of contour properties such that when projected onto the new axes the clusters of granular pores and fractures are well separated wold et al 1987 the set of 20 contour properties for every contour in a sample form the original feature space also known as the high dimensional feature space therefore the high dimensional feature space is a p q matrix where p is the number of contours and q is the number of contour properties 20 this is used as an input to the pca after pca is applied there are two main outputs a principal components and b principal component scores and principal component loadings lever et al 2017 principal component axes are linear combinations of contour property variables such as contour perimeter aspect ratios spatial moments and central moments and are orthogonal i e uncorrelated to each other the maximum number of pcs that can be found equals the number of contour properties i e 20 pcs can be found each pc is associated with a variance variance describes how much information is captured by each pc the first pc has the highest variance the second pc has the second highest variance and so on the total variance captured by all pcs together is 100 using pcs with higher variance allows better segregation contours into clusters of granular pores and fractures while retaining most of the high dimensional feature space information principal component loadings is a weight matrix that transforms the high dimensional feature space into principal component scores that can be projected onto the principal component axes these principal component scores form the transformed data matrix these principal component scores zk are given by 5 z k i p i w i where k 1 m and i 1 n w represents the weights that transform each row contour properties into principal component scores m represents the dimensions or the total number of pcs such that the total variances captured by all the pcs is 100 for practical cases the number of pcs chosen is less than m thus the advantage of using pca is three fold a allows better segregation of clusters by projecting it onto axes that capture high variances b lower number of pcs or new variables can be used to achieve the better segregation still and c pcs allows more insights into better understanding about which combination of contour properties is the most important for segregating fracture and granular pore contours in this study the pca technique is implemented using scikit learn pedregosa et al 2011 once the pcs are calculated the k means clustering algorithm is applied to cluster contours macqueen 1967 k means clustering is applied for all combinations of pcs ranging from the minimum of two pcs up until all the 20 pcs are used then the optimum number of pcs is found by analysing clustering metrics that allow the best segregation while using the lowest number of pcs step 2b k means clustering k means clustering is an unsupervised machine learning technique that identifies a pre defined number of centroids and clusters a data points close to a centroid by minimizing inertia or squared euclidean distances to the closest centroid lloyd 1982 macqueen 1967 k means clustering is an iterative process with the stop criteria being minimum inertia the number of clusters r is a priori for the k means clustering algorithm and hence it needs to be estimated before the implementation for the clustering analysis in this study the k means algorithm is implemented using scikit learn pedregosa et al 2011 the input data to k means clustering is the principal component scores of all the contours for each sample the number of clusters r is chosen to be two because we aim to segregate fractures from granular pores first the k means algorithm assigns each contour granular pore and fracture to a cluster with a particular centroid second the square of euclidean distances of each data point from the centroid is computed and averaged third this average or mean is the new centroid of the cluster and the points are reassigned to each cluster this three step iterative process is repeated until the centroid does not move or the stop criteria is reached the mathematical description of the stop criteria or inertia minimization can be described as below 6 i 0 a min  j c a x i  j 2 where xi are the data points within the cluster whose centroid is given by ca and  j is the mean of all the data points in every cluster fracture and granular pores the output of k means clustering is the centroid location for each cluster of granular pores and fractures as well as the contours labels assigned to each cluster the output of the k means analysis is visualized using the pc axes fig 2b the main reason to group all the fracture contours in one cluster is that the geometry of fractures in the samples used in this study is relatively simple with no branched networks if there are more complex shapes then a more in depth analysis of the optimum number of clusters needs to be carried out we have provided a discussion regarding this in section 3 3 k means clustering for fractures with varied aperture sizes and complex fracture networks step 3 merge criteria for 3d analysis since fractures are 2d planar structures steps 1 and 2 are carried out independently for all three directions x y and z direction and then the labelled data of fractures and granular pores are merged for all three directions fig 2c shows an example of how the merge criterion works for the case of bentheimer sandstone to reconstruct the 3d image of the pore space with fractures labelled differently to granular pores fractures contours are first identified in x y and z directions with discretization i e slicing kept constant 1 voxel in the three directions if a voxel is identified as a fracture in more than 2 directions it is labelled as a fracture in the 3d reconstructed image 2 3 robustness of fracture identification workflow we categorized the digital images in table 1 for two main purposes i exploratory analysis and ii test for generalization 2 3 1 exploratory analysis fractured bentheimer sandstone and fractured indiana limestone are used for exploratory analysis fig 3 this exploratory analysis serves as the first checkpoint to test the robustness of the fracture identification workflow the purpose of carrying out exploratory analysis is to answer the following questions does the proposed approach with contour properties contour perimeter aspect ratios spatial and central moments pca and k means clustering help in identifying fracture contours and granular pore contours what is the optimum number of principal components necessary to achieve good segregation between fracture and granular pore clusters for this purpose we carry out an analysis of experimentally fractured samples bentheimer sandstone and indiana limestone the fracture identification for the exploratory analysis is purely 2d and is carried out in a slice by slice fashion in the z direction for both samples independently to test the clustering analysis and answer the above questions we have manually labelled all the pore contours fracture and granular pores in z direction for both bentheimer sandstone and indiana limestone which serves as the ground truth of this study 2 3 2 evaluation metrics exploratory analysis we use two main metrics i adjusted rand index ari hubert and arabie 1985 and ii homogeneity rosenberg and hirschberg 2007 to test the accuracy of the proposed approach and identify the optimum number of pcs needed to achieve the highest accuracy ari measures the clustering algorithm s accuracy and is adjusted for chance hubert and arabie 1985 rand 1971 its expected value is between 0 and 1 while accuracy is a well known metric used to validate the results of a machine learning algorithm it assumes that there are balanced classes of the entities we are trying to cluster i e we have the same number of granular pores and fractures however we have imbalanced classes for the samples used here because the number of fracture contours is significantly less than the number of granular pore contours therefore to complement the accuracy metric and overcome its drawback we use homogeneity homogeneity is an entropy based metric that measures if the entities of the same class are assigned to the same cluster rosenberg and hirschberg 2007 i e all contours that belong to the classes of fractures are assigned to a cluster of all fractures and all contours that belong classes of granular pores are assigned to a cluster of all granular pores this ensures that contours with similar structural properties are grouped and are well differentiated from the clusters that significantly differ in the properties similar to ari homogeneity has a value ranging between 0 and 1 a high value close to 1 for both ari and homogeneity confirms that the proposed approach of using contour properties pca and k means clustering can be used to identify fracture and granular pore clusters then the lowest number of pcs for which both ari and homogeneity have the highest value gives us the optimum number of pcs required to achieve good segregation of contours for both sandstone and carbonate samples 2 3 3 test for generalization once the optimum number of pcs required for fracture identification in experimentally fractured samples bentheimer sandstone and indiana limestone is estimated we extend the approach to identify fractures in digitally fractured samples in 3d this is the primary objective of the test for generalization for the 3d fracture analysis we use s4 sandstone and portland carbonate fig 3 the main reason for using digitally fractured samples and not experimentally fractured samples is that the voxel by voxel location of the fracture for the 3d image is known only in the case of the digitally fractured samples we identify fractures independently in x y and z directions and then merge the voxels that have been identified as fractures the criteria used to merge voxels is shown in step 3 merge criteria which states that if the voxel is identified as a fracture in two or more than two directions then it is a fracture voxel otherwise it is labelled as a pore voxel the optimum number of pcs and parameters for k means clustering used for s4 sandstone and portland carbonate is the same as that of bentheimer sandstone and indiana limestone respectively the rationale behind this assumption is that both bentheimer and s4 sandstone belong to the broader class of sandstones while indiana limestone and portland carbonate belong to the broader class of carbonates hence the geometrical properties of fractures in comparison to pores will show unique distinctions for each lithology such an analysis will also serve as a test for generalization 2 3 4 evaluation metrics test for generalization for the 3d fracture analysis we present a voxel by voxel accuracy test based on a confusion matrix the confusion matrix considers the voxel location and the type of pore it represents i e granular pore or fracture a positive outcome is when a voxel is identified as contributing to the fracture and a negative outcome is a case where a pore is identified as contributing to the granular pore in such a case we have four main categories true positives tp both clustering based voxel label true and ground truth label true indicate that the voxel is a part of the fracture true negative tn both clustering based voxel label false and ground truth label false indicate that the voxel is a part of the granular pore false positive fp clustering based voxel label true indicates that the voxel is a part of the fracture and ground truth label false indicates that the voxel is a part of the granular pore false negative fn clustering based voxel label false indicates that the voxel is a part of the granular pore and ground truth label true indicates that the voxel is a fracture we then calculate the accuracy precision and recall metrics as follows 7 a c c u r a c y t p t n t p t n f p f n 8 p r e c i s i o n t p t p f p 9 r e c a l l t p t p f n accuracy is a measure of the overall performance i e it considers both fractures and granular pores that have been identified correctly and incorrectly precision emphasizes the impact of false positives while recall highlights the impact of false negatives for fractured porous media samples where there is a competing flow pathway provided by both fractures and granular pores recall and precision play an important role if the fractures are the main flow channels for the media it is advisable to have a higher recall over precision higher recall means the number of fracture voxels is over predicted ensuring that most fracture voxels are identified and there is no loss of fracture connectivity similarly if the granular pores provide the main pathway for fluid flow it is advisable to have higher precision over recall 3 results and discussion 3 1 exploratory analysis the experimentally fractured samples bentheimer sandstone b1 b2 b3 and indiana limestone l1 l2 l3 are investigated in a slice by slice fashion in the z direction to identify contours and calculate contour properties for the bentheimer sandstone the high dimensional feature space is a 117 270 20 data matrix whereas for indiana limestone the high dimensional feature space is 12 069 20 data matrix fig 4 shows the results of pca when applied to the high dimensional feature space of fractured bentheimer sandstone and fractured indiana limestone the transformed data matric for both samples will have the same dimensions as the high dimensional feature space except that the columns now represent 20 pcs fig 4 a b shows pcs with the amount of variance they capture the sum of the variances captured by these pcs is equal to 100 fig 4 c d is a heatmap showing the weights of the contour properties contributing to each of the principal components understanding the weights and their contributions to pcs tells us which properties allow the best segregation of granular pore contours and fracture contours for both bentheimer sandstone and indiana limestone pc1 highlighted in red box contributes almost equally from contour perimeter spatial moments and a few central moments fig 4 c d the contribution of aspect ratios ellipse and rectangle is only prominent for the fractured indiana limestone in pc2 while central moments are a major contributor to pc2 for the bentheimer sandstone for the case of fractured bentheimer sandstone it is interesting to note that both aspect ratio for a fitted ellipse or rectangle does not contribute to the first few pcs that capture a large proportion of the variance this is because bentheimer sandstone is a high porosity rock with pores of varied sizes some of these pores are thin and elongated and appear to have similar structural contour properties as that of the fracture before we apply k means clustering we choose the first two principal components because they capture high variance and should segregate the granular pore and fracture clusters relatively well for the fractured bentheimer sandstone the sum of the variances captured by pc1 and pc2 is 66 8 whereas it is 87 1 for indiana limestone using only the first two pcs then reduces the high dimensional feature space to 117 270 2 data matrix and 12 069 2 data matrix for bentheimer sandstone and indiana limestone respectively fig 5 shows the result of k means clustering for both bentheimer sandstone and indiana limestone two main clusters can be identified from both the scatter plots one representing pores in orange and the other representing fractures in green to further understand the reasoning behind using 2 pcs and whether using a higher number of pcs would lead to better clustering we use evaluation metrics ari and homogeneity as mentioned previously we choose a different number of pcs carry out k means clustering for each pc combination and calculate the 2 metrics by comparing it to the contours ground truth labels fig 6 shows the value of ari and homogeneity for different numbers of pcs for fractured bentheimer sandstone ari and homogeneity remain constant at 99 7 and 99 1 respectively except for when 9 pcs are used the values are insignificantly higher for fractured indiana limestone ari and homogeneity remain constant at 96 and 89 6 respectively the optimum number of pcs is the lowest value of pc for which the highest ari and homogeneity are achieved thus the optimum number of pcs required to achieve the best segregation between pores and fractures is 2 for both sandstones and carbonates the above exploratory analysis show that using a combination of pca and k means clustering allows segregation of contours granular pores and fractures with high accuracy of greater than 96 using pca provides insights for which contour properties have good differentiating power and play an important role in the clustering algorithm in addition to this pca reduces the high dimensional feature space to a low dimensional feature space with just 2 pcs while retaining the most important information to achieve the highest value for the evaluation metrics k means clustering can be performed without the pca step however without the pca analysis k means clustering is less efficient in creating well separated clusters which means the granular pores and fractures will be misidentified pca provides new and reduced dimensions for better segregation ding and he 2004 and hence we chose to use it 3 2 test for generalization learning from the exploratory analysis we now use two principal components for k means clustering to identify fractures in digitally fractured samples s4 sandstone and portland carbonate in x y and z directions fig 7 shows the scatter plots generated from the k means clustering algorithm using two principal components and two clusters one representing pores and second representing fractures the use of two clusters to achieve a good fracture and pore segregation is supported by an objective analysis using the silhouette score appendix c provides an in depth discussion for determining the number of clusters for the k means algorithm for s4 sandstone ss1 sample fig 1d we can see that the clustering results for x and z direction fig 7a c show two well distinguished clusters while for the y direction fig 7b the clusters are rather sparse and show large deviations this is because x and z directions are parallel to the fracture plane and hence the fracture geometry is well captured on the contrary the y direction is perpendicular to the fracture plane wherein the fracture can be represented by an entire slice in a 3d image for s4 sandstone ss2 sample fig 1e x and y directions fig 7d e are parallel to the fracture plane because clusters of fractures and pores are well segregated the z direction of the ss2 sample fig 7f is an exception where three clusters were introduced instead of the usual two clusters determined by the silhouette score analysis this is because the two fractures in the ss2 sample are orientated differently which affects how they are perceived in the z direction one of the fracture planes is orientated at an angle 45 to the z direction however the other fracture plane is perpendicular to the z direction both the fractures have vastly different structural properties when the direction of investigation is the z direction therefore to capture both these fractures and granular pores we introduced another cluster this also ensures that we capture connectivity of fractures in all the directions especially for the fracture orientated at an angle 45 to the z direction for the case of portland carbonate both the samples p1 and p2 fig 7g h j k show well separated clusters for x and y directions because these directions are parallel to the fracture plane however clusters for p1 and p2 fig 7i l for the z direction are sparse for the case of fractures which indicate that the z direction is perpendicular to the fracture plane thus k means clustering enables identification of fracture versus granular pores and allows the identification of directions that are parallel to the fracture plane once the fractures are identified in x y and z directions for each of the samples we merge all the voxels that are highlighted by the fracture contours and granular pore contours to give a 3d fracture and granular pore identification fig 8 the confusion matrix shows the details regarding the performance of the merge criteria and clustering algorithm the evaluation metrics calculated from the confusion matrix accuracy precision and recall are shown in the graph on the right for all the samples the voxel by voxel accuracy is greater than 89 for both s4 sandstone and portland carbonate fractures provide the main pathway for fluid flow so it is preferred to have a higher recall than precision in such a case refer to section 2 3 4 evaluation metrics test for generalization this is consistent with recall and precision metrics in fig 8 for both the samples where recall is higher than precision while the confusion matrix and the corresponding metrics allow comparison of fracture and granular voxels it does not measure whether connectivity is preserved for this we calculate fracture permeability chung et al 2019 of the reconstructed fracture fig 8 green region vs the fracture permeability of the labelled fractured image the left column in fig 8 shows the permeability analysis results as the percentage difference in the permeability for different directions for most samples where two clusters were used for fracture identification the difference in permeability is less than 5 indicating that most of the conductivity is preserved when using the merge criteria even for the z direction of ss2 sandstone fig 7f if only two clusters similar to other samples were used we are still able to segregate fractures from pores with a reasonable accuracy wherein the permeability differences are about 25 36 in the x and y direction however use of three clusters based on an additional visual analysis provided more accurate results with permeability difference reduced to 4 5 8 8 fig 8b on the other hand there is a minor loss of connectivity in x direction permeability for p1 carbonate fig 8c as seen in the percentage difference of 7 4 this loss of connectivity occurs because the clustering algorithm misclassified some of the fracture contours and hence the subsequent merging labelled it as granular pores 4 k means clustering for fractures with varied aperture sizes and complex fracture networks the analyses in the previous sections illustrated the robustness of the proposed fracture identification workflow fractures can often have varied aperture sizes or have more complex structures such as branched networks and curved shapes as shown in fig 9 the fractures in bentheimer sandstone fig 9a show aperture sizes of 1 8 and 3 7 compared to the thinnest fracture when the fracture identification workflow is applied fracture contours are well separated from the granular pores in fig 9b and are identified as a part of the single cluster cluster 2 fig 9c shows the fractures highlighted in green after being identified using k means clustering on the other hand fig 9d shows complex fracture systems for the case of doddington sandstone both branched and curved fractures are identified by the k means clustering as seen by green clusters in fig 9e and green fracture regions in fig 9f one noticeable feature of the k means clustering is that the fracture cluster points are very dispersed because of the large variety in the fracture geometries encountered in fig 9d overall for both cases the predetermined setting of 2 pcs and 2 clusters inferred from silhouette score analysis identified fractures with reasonable accuracy with only one misclassification highlighted in a red circle in fig 9f 5 improvements for the fracture identification workflow the methodologies used in this paper prove to have high accuracy in identifying voxels that are a part of fracture or granular pores the small inaccuracies in both fracture and granular pore voxel identification in section 3 2 arise from two main reasons 1 the fracture contours were not identified in the x y or z direction by k means clustering and 2 the fracture identification is a 2d slice by slice process for the 3d volume the second reason encapsulates the first some of the fractures in a single 2d slice extend laterally because they connect large pores however the fractures might not extend laterally in the subsequent slices this is particularly noticeable in high porosity systems such as sandstones an important aspect for future work is extending this work into a fully automated 3 d fracture identification framework where fracture contours are identified in 3d rather than slice by slice then a sensitivity analysis needs to be carried out to determine the number of clusters in complex fracture networks 6 conclusions the application of contour detection and k means clustering for fracture identification is a significant advancement for the characterization of fractured porous media images a combination of three key steps was used to identify the fractures and segregate them from granular pores 1 contour detection computer vision concept and 2 pca and k means clustering unsupervised machine learning method 3 merge criteria the number of principal components for fracture contour identification was chosen using a sensitivity study and calculating adjusted rand index and homogeneity metrics for experimentally fractured samples this was a part of the 2d exploratory study carried out on fractured bentheimer sandstone and indiana limestone in the z direction on a slice by slice basis once the optimum number of pcs was identified the analysis was extended to 3d and tested for generalization by applying the parameters of pc contour detection and k means to other sandstones and carbonate rock images two digitally fractured samples fractured s4 sandstone and portland carbonate were used to test for generalization the k means clustering algorithm identified fractures in x y and z directions and also provided insights about the fracture for most of the samples the use of two clusters provided a good segregation between granular pores and fractures an objective analysis using the silhouette score also supported the use of two clusters for fracture identification when the fracture voxels from the three directions were combined and compared to the ground truth labels the accuracy was over 89 for all samples the permeability differences between reconstructed and labelled fractures for digitally fractured samples were less than 9 for all the directions the slight inaccuracies in the fracture identification were attributed to two main factors 1 the fracture contours were not identified in the x y or z direction by k means clustering and 2 the fracture identification is a 2d slice by slice process for the 3d volume extending the fracture workflow to a fully automated 3d search such that the contour detection is performed as a volume compared to the slice by slice approach as currently carried out will help alleviate the inaccuracies additional analysis to understand the impact of the number of clusters for complex fracture networks will also need to be incorporated credit authorship contribution statement ankita singh conceptualization methodology software validation formal analysis data curation visualization writing original draft arash rabbani data curation visualization writing review editing klaus regenauer lieb visualization writing review editing supervision ryan t armstrong writing review editing supervision peyman mostaghimi conceptualization methodology resources writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the jupyter notebooks for the fracture identification analysis are available via https github com ankitaeclipse fracture pore identification we would like to acknowledge the contributions of adelina lv for sample preparation and the tyree x ray ct facility a unsw network lab funded by the unsw research infrastructure scheme for the acquisition of the 3d micro ct images the micro ct images of portland carbonate are courtesy of qatar carbonates and carbon storage research centre at imperial college london we would also like to thank the editor and anonymous reviewers for their valuable comments that improved the contents of this manuscript appendix appendix a workflow to induce fracture digitally in micro ct images the pseudo fractures are created based on the min cut theorem with an energy minimization approach as described by boykov and kolmogorov 2001 kolmogorov and zabin 2004 initially we draw the flat surface of a fracture with the desired orientation and through an iterative optimization we gradually deform the plane to cut the geometry at the locations in which cohesive energy is minimal fig a1 a for example in sandstones such locations would be the touching interfaces of grains in which they are partially fused due to the subsurface overburden pressure if we introduce a tensile force on such a structure the min cut theorem states that the sample is more likely to be detached at those weak bonds after detecting the minimal energy path two segments of the sample at both sides of that path are displaced to satisfy the favourable fracture aperture fig a1b appendix b contour detection or border following algorithm in opencv the contour detection or border following algorithm was first introduced by rosenfeld and kak 1982 to detect outer borders of objects and later modified by suzuki and abe 1985 to include additional conditions to both detect outer borders and hole borders in an object fig b1 the terms border and contour are used interchangeably and mean the same the algorithm proposed by suzuki and abe 1985 is implemented in the findcontours functionality of opencv the border following algorithm identifies contours of objects labelled as 1 s as against the background labelled as 0 s by scanning the entire intensity image or segmented image in a pixel by pixel manner in an 8 connected neighbourhood if a i j is the intensity image with i and j representing the rows and columns then the border identification algorithm only applies to every non zero pixel values the algorithm scans the intensity image pixel by pixel until a pixel meets the conditions of the the starting point of the outer or the hole border a outer border condition and b hole border condition suzuki and abe 1985 fig b2 for example in fig b3 a the starting point is a 1 3 1 in red once the starting point is determined the algorithm memorizes every new found border with a unique number called the new border or nbd the first pixel by pixel investigation of the intensity image gives us the complete border or contour for the outer region fig b3 b indicated by 2 or 2 the and signs are based on the marking policy outlined by suzuki and abe 1985 the second scan of the intensity image starts at the pixel that first satisfies the condition of the hole border fig b3 c for the second scan nbd is updated to 3 or 3 the pixel by pixel investigation is again repeated until the lowermost pixel of the image is reached and the resulting hole border identified is shown in fig b3 d appendix c silhouette score analysis to determine the number of clusters for k means clustering the number of clusters r is determined using the silhouette score analysis silhouette score measures the separation between clusters and how likely a data point is assigned to the correct cluster rousseeuw 1987 the value of silhouette score ranges between 1 1 and is calculated using the euclidean distance metric the formula to calculate the silhouette score is c1 s i l h o u e t t e s c o r e s t m a x s t where s is the mean of pairwise distances between points of the same cluster or intra cluster distance and t is the mean of pairwise distance of each point of one cluster to another point of the nearest cluster or nearest cluster distance pedregosa et al 2011 rousseeuw 1987 a value of 1 indicates that the clusters are well separated while a value of 1 indicates the clusters are not well separated and that data points are assigned to the wrong clusters the k means algorithm is carried out with different number of clusters and a silhouette score is calculated for each scenario the number of clusters for which the silhouette score has the highest value is the optimum number of clusters to be used for k means clustering analysis for the case of digitally fractured samples the number of clusters can be determined for each sample and for every direction x y and z using the silhouette score analysis the graph showing the silhouette score for different number of clusters is shown in fig c1 silhouette score analysis indicated that for four cases we needed a third cluster instead of two clusters as proposed in fig 7 a third cluster was needed for the following rock samples 1 ss2 sandstone x direction fig c1b blue 2 ss2 sandstone y direction fig c1b orange 3 p1 carbonate z direction fig c1c grey 4 p2 carbonate z direction fig c1d grey fig c2 shows the differences in clustering when number of clusters 2 used in fig 7 vs number of clusters 3 based on silhouette score analysis the reason why we see another cluster representing the fractures in s4 sandstone fig c2a d is because one fracture is orientated at 45 to x y and z direction whereas the other fracture is orientated parallel to x and y direction as for the z direction of portland carbonate fig c2e h the fracture plane is perpendicular to the direction of investigation and hence the variation in the structural properties is quite large the main aim of this study is to segregate granular pores and fractures into well separated clusters based on the above analysis the use of two cluster gives us the same accuracy level as three clusters in identifying fracture contours from granular pore contours therefore the use of two clusters for this is fully sufficient 
359,water shortages pose significant threats to local water security and food production around the world water managers have resorted to various water resources planning measures to overcome these challenges for the first time and for a case study in iran we provide a comparative analysis of two such measures physical and virtual inter basin water transfers ibwt we evaluate green and blue water footprints wf associated with the production of 39 crops grown in humid mazandaran and arid semnan provinces under i current production patterns and current local water availability ii current production patterns and a planned physical ibwt scheme between mazandaran donor and receiving semnan province to provide water to water intensive crops in the latter iii modified cropping patterns such that surplus production of water intensive crops in mazandaran abates production in semnan province coupled with interprovincial trade i e a virtual ibwt scheme we find that crops currently produced in mazandaran have considerably lower blue wfs per unit of production m3 t 1 and a higher economic blue water productivity ebwp m 1 than in semnan province a physical ibwt would reduce blue water scarcity bws in semnan province by 34 but at the cost of reduced ebwp by up to 46 of crops irrigated with the more costly transferred water a virtual ibwt would reduce bws in semnan province to the same degree while only modestly increasing bws in mazandaran province from 0 15 to 0 21 indicating that mazandaran water resources can sustainably support the proposed increase in production moreover mazandaran s provincial average ebwp is even raised by 7 in the virtual ibwt scenario keywords blue water scarcity economic blue water productivity inter basin water transfer virtual water trade water footprint assessment 1 introduction shortages of freshwater are mainly a human made challenge thatthat pose significant threats to water security and food production in many places around the world reimer 2014 fao 2017a chouchane et al 2019 widespread water scarcity indicates that more water has already been appropriated for human use than can be sustained in the long run mekonnen and hoekstra 2016 meanwhile demand for freshwater resources is expected to grow particularly in agriculture fao 2012 moreover natural fluctuations in levels of regional water availability are expected to be amplified by climate change thereby further impeding local food production koutroulis et al 2019 a common water resources planning measure to overcome regional water shortages is the construction of inter basin water transfers ibwt these infrastructure works physically transport freshwater from water abundant regions to those with lower endowments and or a higher demand development of physical ibwts dates back to at least 2400 bce when ancient egypt diverted water from the nile river to south ethiopia for irrigation and navigation purposes fang 2005 today local water shortages are still the main driver for developing physical ibwt projects with over 160 major physical ibwts currently operational around the world zhuang 2016 six countries the united states canada russia india pakistan and china are home to over 80 of these physical ibwts with china s south to north water transfer being the largest physical ibwt in the world wang et al 2008 this latter megaproject transfers 50 109 m3 of water annually from the southern to the northern regions in the country securing water supply to over 300 million people li et al 2016 zhao et al 2017 beside increasing local freshwater supply physical ibwts can bring additional advantages for the receiving regions including the promotion of biodiversity and restoration of ecosystems dadaser celik et al 2009 monroy et al 2013 wang et al 2014 prevention of land subsidence larsona et al 2001 and improving water quality and nutrient content li et al 2003 for the exporting regions flood control is a potential benefit of physical ibwts wang 2004 the practice of developing physical ibwts has been widely criticized as well on the basis of their numerous potential negative side effects reported environmental downsides in the receiving regions include the prolongation or even worsening of inefficient water use schemes chen 2004 the spread of new pollutants and diseases kristopher 2013 sible et al 2015 gupta and van der zaag 2008 and soil salinization and fertility loss zhao et al 2008 liu et al 2013 donor regions may experience diminished aquatic life in response to water level reduction li et al 2015 and reduced water flow to the sea davies et al 1992 ma and wang 2011 physical ibwts also bring substantial social and economic costs that are associated with the possible displacement of residents the construction of pre treatment plants transport infrastructure works and system s operation and maintenance costs li et al 2015 these negative side effects drove the development of alternatives to constructing physical ibwts zhao et al 2017 including demand side measures such as boosting water use efficiency and improving water conveyance and distribution systems in the importing regions and supply side measures such as artificial groundwater recharge and developing unconventional water resources such as reclaimed wastewater seawater desalination and rainwater harvesting zhuang 2016 here we discuss another promising alternative to traditional physical ibwts namely virtual water vw trade in conjunction with altered cropping patterns this virtual ibwt measure may overcome some of the social and economic costs associated with physical ibwts but it is particularly promising regarding the improvement of water use efficiency if agricultural products are produced in water abundant regions with high water productivities and exported to water scarce regions with low water productivity abating local production water can be saved water scarcity alleviated and food security improved hogeboom 2020 research on the concept of virtual water trade revealed a potential to achieve higher levels of overall water saving and food security through trade compared to localized food production hoekstra and mekonnen 2012 hoekstra and chapagain 2008 in another study reimer 2014 developed an international agricultural trade model to address the role of trade in water intensive agricultural products given changing water availability levels developed with a focus on water as the main input he demonstrated that trade could help countries face shocks which they could not otherwise bear themselves at the same time they postulate that trade liberalization and subsequent changes in global production patterns are unlikely to save water but do improve economic welfare while virtual water trade studies abound there are no studies to our knowledge that explicitly juxtapose virtual and physical ibwts the aim of this study therefore is to provide a comparative analysis of virtual and physical ibwts to explore their potential to overcome water shortages in agriculture and thereby improve national food security for a case study in iran we illustrate how a virtual and a proposed physical ibwt vary in terms of their i resulting unit water footprints per crop ii total water consumption related to crop production iii economic water productivity of crop production iv and their water scarcity alleviation potential from the results we try to distil general lessons for other geographical settings where policy makers are contemplating developing physical ibwt schemes please note that while the physical ibwt is actually proposed by iranian water planners our analysis does not constitute a before and after analysis rather we designed hypothetical scenarios for both physical and virtual ibwt that we deem plausible in this case study setting as a consequence we do not include relative costs of interventions needed to achieve these scenarios nor do we study their feasibility in our comparison of impacts 2 method and data 2 1 study area iran is one of the most water scarce countries in the world and suffers from both depleted surface water and groundwater resources karandish et al 2018 2020 water scarcity is most pronounced in the semi arid provinces of the country with intensive agriculture which includes semnan province fig 1 in order to increase water availability in semnan province iran s national water planners recently proposed a series of physical ibwt projects the most controversial of which aspires to desalinate 220 106 m3 from the caspian sea annually to transfer it to semnan province iprci 2014 since the intake of seawater is located in the humid and water abundant mazandaran province the project is called the mazandaran semnan ms ibwt project for convenience therefore we will refer to mazandaran province as the donor province in this research agriculture is the main freshwater user in both provinces imaj 2017 the ministry of agriculture distinguishes agricultural crop groups acgs and horticultural crop groups hcgs for this study we selected 39 crops that are commonly grown in both provinces and classified them into six acgs cereals legumes industrial crops vegetables cucumber family and forages and six hcgs grained fruits nutrient fruits fine grained fruits dried fruits semi tropical fruits and greenhouse crops mazandaran and semnan province contributed 3 4 and 0 8 to national production of agricultural crops and 17 and 1 3 to national production of horticultural crops respectively in the year 2015 imaj 2017 the higher production in mazandaran province compared to semnan province can be explained by the larger area under cultivation in the former province and differences in cropping patterns table 1 the two provinces are currently trading partners with a reported net virtual water trade from mazandaran to semnan province over the past two decades karandish and hoekstra 2017 2 2 comparative analysis we considered the following three scenarios for our comparative analysis base case reflecting current cropping patterns meaning the composition of the crop mix and the share of each crop in total harvested area and total production in both provinces current provincial water availability levels and current virtual water trade between mazandaran and semnan provinces physical ibwt case reflecting current cropping patterns in both provinces and current water availability levels in mazandaran province semnan province in this case has access to an additional 220 106 m3 y 1 of desalinated water i e anticipating the planned ms ibwt project we allocated this transferred water over the various semnan grown crops based on their 10 year weighted average of unit blue water footprint blue wfprod m3t 1 see section 2 2 1 the crop with the largest unit blue water footprint in semnan is thus assigned its full blue water requirement first then the second largest and so on until the amount of 220 106 m3 has been fully allocated virtual ibwt case reflecting modified cropping patterns in both provinces and current provincial water availability levels in semnan province mazandaran province in this case is assigned an additional 220 106 m3 y 1 of water water that is currently undeveloped but that we assume could become available for agricultural purposes if it were developed cropping patterns in mazandaran were modified such that the annual total production t that could be achieved in semnan province on account of the additional 220 106 m3 of transferred desalinated water as proposed in the physical ibwt case i e the crops with the largest total blue wf in semnan province would now be produced in mazandaran province instead this modification implies that the harvested area of these crops is increased in mazandaran province as a function of this additional production accordingly the harvested area of these crops in semnan province is reduced hence the rationale behind these modifications is that the water rich mazandaran province can and should yield surplus production of chiefly water intensive crops to abate production of these crops in water scarce semnan province through interprovincial trade mazandaran grown crops and their virtual water content are then exported to semnan province for final consumption the harvested area of the other less water intensive crops remains unaltered in both provinces we analyzed these three scenarios in terms of their i resulting unit water footprints per crop ii total water consumption related to crop production iii economic blue water productivity of crop production iv and their blue water scarcity alleviation potential 2 2 1 unit water footprints of crop production for the period 2006 2015 we calculated annual green blue water footprints related to crop production wfprod m3 t 1 of 39 crops per province per year based on the accounting framework of hoekstra et al 2011 this calculation followed similar procedures as karandish and hoekstra 2017 but we improve on their study by including more crops in our assessment and considering a longer time period for each crop green and blue wfprod were calculated by dividing seasonal green and blue evapotranspiration m3 ha 1 by provincial crop yield t ha 1 respectively we employed fao s aquacrop model to estimate seasonal evapotranspiration hsiao et al 2009 steduto et al 2009 the model was first run for a 5 year period to set initial values of soil moisture content aquacrop simulates a daily soil water balance for the crop s rooting zone a follows 1 s t s t 1 p t i t c r t e t t r o t d p t here s is the soil water content at the end of day t or t 1 respectively p precipitation i irrigation applied cr capillary rise et evapotranspiration ro surface runoff and dp deep percolation all units are in mm d 1 since groundwater levels are generally deeper than one metre below the rooting zone cr was assumed to be zero karandish and hoekstra 2017 to differentiate between the green and blue soil moisture content s we followed the procedure proposed by hoekstra 2019 2 s g r e e n t s g r e e n t 1 p t r o t p t p t i t d p t e t t s g r e e n t 1 s t 1 s b l u e t s b l u e t 1 i t r o t i t p t i t d p t e t t s b l u e t 1 s t 1 for each acg and hcg category the weighted average wfprod for every year in the period 2006 2015 was calculated based on the production of different crops within that category thereafter the 10 year production weighted average wfprod was calculated for each crop category over the period 2006 2015 agricultural data including crop type annual irrigated and rain fed harvested area annual total production and yield cropping calendars and agricultural practices were obtained from iran s ministry of agricultural jihad imaj 2017 provincial averages of climate data were taken from irimo 2020 2 2 2 total water footprints of crop production the total crop water footprint wftot m3 reflects the aggregate claim on water resources associated with the production of that particular crop in a given year to obtain annual wftot we multiplied reported annual crop total production from imaj 2017 with annual unit wfprod per crop category 2 2 3 economic blue water productivity the economic blue water productivity ebwp m 3 reflects the monetary revenue of water consumption hogeboom and hoekstra 2017 per crop province and year we estimated ebwp as 3 e b w p p c r o p t p c w a t e r w f p r o d b l u e t p w f p r o d b l u e t p where pcrop is the crop s unit price t 1 cwater is unit blue water cost m 3 tp is total production t the 10 year average of ebwp was then calculated as a production weighted average over each year in the period 2006 2015 crop unit prices are taken from fao 2017b the unit blue water cost in iran s agricultural sector is estimated by karandish 2016 at 0 02 m 3 representative for the period 2006 2015 for the physical ibwt case addition costs related to developing the physical infrastructure for both the desalination plant and the transfer works need to be included which are estimated at 116 107 iprci 2014 assuming a 50 year life span an average capacity of 220 106 m3 y 1 and excluding maintenance costs we presumptively estimate the physical ibwt associated cwater at 0 10 m 3 2 2 4 water scarcity alleviation potential differences in wftot amongst the scenarios result in different levels of blue water scarcity bws at the provincial level per province bws is calculated by dividing the blue wftot m3 per crop and year by local water availability m3 local water availability is calculated as the local annual natural runoff minus environmental flow requirements data on natural runoff at the province scale was taken from iran s water resource management company wrm 2016 environmental flow requirements were assumed at 80 of natural runoff following richter et al 2012 a bws 1 indicates that water consumption exceeds sustainably available water availability levels creating a water scarcity hotspot 3 results 3 1 base case the 10 year average of green blue wfprod over the period 2006 2015 given current cropping patterns and current local water availability is shown in fig 2 we observe that for most crop groups wfprod is noticeably larger in the arid semnan than in the humid mazandaran province indicating more water efficient production in mazandaran province except for the greenhouse crops which are fully reliant on blue water in both provinces the share of blue water in green blue unit water footprints is larger in semnan province for all crops with this share ranging between 73 3 for industrial crops to 94 0 for nutrient fruits versus 15 3 for legumes to 40 6 for nutrient fruits in mazandaran province in semnan province industrial crops legumes dried fruits semi tropical fruits and cereals rank first to fifth in terms of the largest blue wfprod greenhouse crops and vegetables have the lowest blue wfprod mainly due to their higher yields per hectare in semnan province cereals have the largest green blue wftot as well as the largest blue wftot table 2 on average 17 107 m3 of blue water is consumed annually in mazandaran province to produce 60 104 t aggregated over 39 crops and 66 107 m3 to produce 93 104 t of selected crops in semnan province ebwp in mazandaran province vary from 0 91 m 3 for forages to 23 m 3 for greenhouse crops ebwp is considerably higher in mazandaran compared to semnan province with particularly pronounced differences for legumes the cucumber family and industrial crops both provinces have a higher ebwp for crops in hcgs compared to crops in acgs provincial averages of current ebwp in mazandaran and semnan province are 1 84 m 3 and 0 57 m 3 respectively the ten year average bws over the period 2005 2015 is 0 15 in mazandaran indicating the province does not suffer from water scarcity and 3 72 in semnan province indicating severe water scarcity 3 2 physical ibwt case our analysis for the base case revealed which crops are relatively most blue water intensive to produce in semnan province according to the allocation procedure described in the method the desalinized water annually transferred from mazandaran province 220 106 m3 can supply the full blue water demand for producing industrial crops 21 106 m3 dried fruits 18 106 m3 legumes 1 0 106 m3 and semi tropical fruits 13 107 m3 the remaining 48 106 m3 is assigned to cereal production for which it accounts for 32 of its blue wftot the remaining 68 of cereal production is produced by locally available blue water resources in this case the total production wfprod wftot and its blue share for both provinces do not change for any of the crops compared to the base case table 3 for semnan province however the costs associated with the transferred blue water and thus its ebwp do differ ebwp of affected crops is down considerably from 5 for dried fruits to 46 for industrial crops costs and ebwp in mazandaran province remain unaltered the positive effect of the transferred water is that it reduces the strain on semnan s local water resources we found that as a result bws is reduced by 34 in semnan province to 2 48 however at this level the province is still classified as severely water scarce bws in mazandaran province remains unaltered at 0 15 3 3 virtual ibwt case in this case all production of industrial crops dried fruits legumes semi tropical fruits and 32 of cereals which in the physical ibwt case were supposed to be produced in semnan province using the 220 106 m3 of the transferred water will now be produced in mazandaran province using local freshwater assumed to be developed there these mazandaran grown crops abate their production in semnan to which they will be exported through interprovincial trade table 4 shows that wfprod in both province is unaltered with respect to the base case however annual blue wftot increases by 40 to 23 107 m3 in mazandaran province while in semnan province requires 220 106 m3 blue water less 33 compared to the base case the provincial average ebwp in mazandaran province will increase to 1 97 m3 which is 7 higher than in the base case this increase can be explained by the increasing relative share of crops with high ebwp in mazandaran s crop mix i e legumes semi tropical fruits and dried fruits on account of the same reason provincial average ebwp in semnan province is reduced by 10 to 0 51 m3 bws in semnan province decreases as in the physical ibtw case by 34 to 2 48 due to the additional water use bws in mazandaran increases by 40 to 0 21 however this value indicates local water resources can still sustainably support the increased demand table 5 summarizes the most important indices calculated for the three cases 4 discussion we compared a physical and a virtual ibwt scheme with current cropping patterns and local water availability across several criteria in calculating unit water footprints we used default crop parameters of the aquacrop model because observations or measurements of both crop parameters or actual unit water footprints are lacking simulated wfs could not be calibrated or validated although this introduces uncertainty in our estimated unit wfs they mainly serve to illustrate the dynamics associated with the two ibwt schemes in this regard a more questionable aspect of our assessment probably lies in the implicit assumption that in the virtual ibtw case it is practically feasible to accommodate additional production in mazandaran province however we reckoned this assumption is acceptable based on the relative abundance of water resources as indicated by a low bws index and a large acreage of undeveloped suitable lands mesgaran et al 2017 moreover our list of assessment criteria is only partial and excludes various other important economic social and environmental considerations that are needed towards the actual planning of a virtual versus a physical ibwt regarding economic considerations we found that the relatively high unit blue water cost by agricultural standards in the physical ibwt case 0 10 m 3 drives down ebwp this might support the argument that a physical ibwt might still be economically viable for industrial use as industrial users may be willing and able to cover higher tariffs the current unit blue water price is 0 59 m 3 according to iprci 2014 however the water to be physically transferred is not earmarked for any particular sector per se it can be used to complement either industry or households or agriculture water shortages moreover our estimate for the water cost is likely an underestimation as we excluded energy and infrastructure maintenance costs as well as potential costs of externalities incurred by environmental degradation around the physical ibwt inlet due to desalination on the other hand our analysis also excluded additional marginal costs that are incurred by the trading of products in the virtual ibwt case such costs eventually are borne by consumers in the importing province however we expect these additional costs to be lower than the substantial costs associated to the physical ibwt regarding potential social considerations expanding agricultural lands and producing more crops in mazandaran province under a virtual ibwt setting may provide increased job opportunities for local residents and reduce the unemployment rate there currently the unemployment rate in mazandaran province is roughly 21 higher than that in semnan province sci 2020 which is a compelling argument to the iranian government to initiate the labor intensive physical ibwt project in the first place iprc 2014 on the other hand reduced agriculture production in semnan province under the virtual ibtw case may increase unemployment there regarding environmental considerations we looked at some water aspects related to the three cases but an analogous assessment complementary to ours may be carried out for the amount of energy required for the physical ibwt case the energy needed to transfer the desalinated water from mazandaran province to semnan province is estimated at 39 103 gj iprc 2014 5 0 103 gj of this number is planned to be supplied by hydropower the additional blue water consumption associated with this hydropower generation has not been accounted for in our analysis of the physical ibwt scenario however based on iran s national average blue wf of hydropower of 0 91 m3 gj 1 as estimated by hogeboom and hoekstra 2018 we can cautiously estimate that this generation will come at the cost of another 4 6 103 m3 of blue water annually moreover there is a risk of salination near the desalination plant s outlets national reports show that the envisioned desalination process will produce wastewater with a salinity of 25 g l 1 which is two time higher than the ambient concentrations iprc 2014 such salinity levels are expected to pose serious threats to local fish habitats and stocks in the caspian sea particularly the area in close proximity to the effluent outlet is running the risk of turning into an ecological dead zone iprc 2014 another consideration in the planning of a physical ibwt is its inflexibility after all while water requirement in the recipient region may change over time e g due to population growth economic development and climate change the volume of transferred water is largely fixed by the number of pumps gauging stations and dimensions of the channels a virtual ibwt scheme in contrast offers more flexibility in that it can adapt and evolve to changing needs the main rationale to employ an ibwt either physical or virtual is typically a persistent shortage of water such shortages arise either because the region is physically water scarce or because of overuse and mismanagement of available water resources in semnan province both are the case however an strong argument can be made to consider addressing the latter issue first before resorting to an ibtw both the relatively large blue wfprod in semnan province and their high variability over the years suggests that there is indeed a large potential of blue water savings through improving water use efficiency 5 conclusion physical ibwts are commonly used planning measures to overcome water shortages in one location by physically transferring water from water abundant regions to those that lack the resource since these physical ibwts are heavily criticized because of the social economic and environmental costs they may incur we set out to explore the merits of an alternative ibwt to overcome local water shortages namely a virtual ibwt using a comparative analysis for a case study in iran we illustrate how both physical and virtual ibwts have the potential to reduce blue water scarcity in the receiving region however the physical ibwt was found to potentially reinforce inefficient farming practices in already water scarce regions a virtual ibwt in contrast might abate production in low water productivity regions by increasing production in more water efficient regions coupled with trade while it was not the case in our case analysis for iran careful attention should be given to the exporting region to assure that the added production will not increase blue water scarcity levels beyond locally sustainable thresholds this study also found that a virtual ibwt can increase economic water productivities while a physical ibwt reduces them on account of the large costs incurred by their construction we recommend water planners contemplating the development of physical ibwts to also consider the merits of virtual alternatives author statement f k and a y h conceived and designed the research f k performed the modeling work f k a y h and r j h wrote the paper declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement during the revision stages of this manuscript our esteemed co author prof dr arjen y hoekstra suddenly and unexpectedly passed away his passing demarcates a great loss both to us personally and to science at large we acknowledge his contributions to this piece of work and dedicate it to him this project has received funding from the european research council erc under the european union s horizon 2020 research and innovation programme earth lternatives project grant agreement no 834716 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103811 appendix supplementary materials image application 1 
359,water shortages pose significant threats to local water security and food production around the world water managers have resorted to various water resources planning measures to overcome these challenges for the first time and for a case study in iran we provide a comparative analysis of two such measures physical and virtual inter basin water transfers ibwt we evaluate green and blue water footprints wf associated with the production of 39 crops grown in humid mazandaran and arid semnan provinces under i current production patterns and current local water availability ii current production patterns and a planned physical ibwt scheme between mazandaran donor and receiving semnan province to provide water to water intensive crops in the latter iii modified cropping patterns such that surplus production of water intensive crops in mazandaran abates production in semnan province coupled with interprovincial trade i e a virtual ibwt scheme we find that crops currently produced in mazandaran have considerably lower blue wfs per unit of production m3 t 1 and a higher economic blue water productivity ebwp m 1 than in semnan province a physical ibwt would reduce blue water scarcity bws in semnan province by 34 but at the cost of reduced ebwp by up to 46 of crops irrigated with the more costly transferred water a virtual ibwt would reduce bws in semnan province to the same degree while only modestly increasing bws in mazandaran province from 0 15 to 0 21 indicating that mazandaran water resources can sustainably support the proposed increase in production moreover mazandaran s provincial average ebwp is even raised by 7 in the virtual ibwt scenario keywords blue water scarcity economic blue water productivity inter basin water transfer virtual water trade water footprint assessment 1 introduction shortages of freshwater are mainly a human made challenge thatthat pose significant threats to water security and food production in many places around the world reimer 2014 fao 2017a chouchane et al 2019 widespread water scarcity indicates that more water has already been appropriated for human use than can be sustained in the long run mekonnen and hoekstra 2016 meanwhile demand for freshwater resources is expected to grow particularly in agriculture fao 2012 moreover natural fluctuations in levels of regional water availability are expected to be amplified by climate change thereby further impeding local food production koutroulis et al 2019 a common water resources planning measure to overcome regional water shortages is the construction of inter basin water transfers ibwt these infrastructure works physically transport freshwater from water abundant regions to those with lower endowments and or a higher demand development of physical ibwts dates back to at least 2400 bce when ancient egypt diverted water from the nile river to south ethiopia for irrigation and navigation purposes fang 2005 today local water shortages are still the main driver for developing physical ibwt projects with over 160 major physical ibwts currently operational around the world zhuang 2016 six countries the united states canada russia india pakistan and china are home to over 80 of these physical ibwts with china s south to north water transfer being the largest physical ibwt in the world wang et al 2008 this latter megaproject transfers 50 109 m3 of water annually from the southern to the northern regions in the country securing water supply to over 300 million people li et al 2016 zhao et al 2017 beside increasing local freshwater supply physical ibwts can bring additional advantages for the receiving regions including the promotion of biodiversity and restoration of ecosystems dadaser celik et al 2009 monroy et al 2013 wang et al 2014 prevention of land subsidence larsona et al 2001 and improving water quality and nutrient content li et al 2003 for the exporting regions flood control is a potential benefit of physical ibwts wang 2004 the practice of developing physical ibwts has been widely criticized as well on the basis of their numerous potential negative side effects reported environmental downsides in the receiving regions include the prolongation or even worsening of inefficient water use schemes chen 2004 the spread of new pollutants and diseases kristopher 2013 sible et al 2015 gupta and van der zaag 2008 and soil salinization and fertility loss zhao et al 2008 liu et al 2013 donor regions may experience diminished aquatic life in response to water level reduction li et al 2015 and reduced water flow to the sea davies et al 1992 ma and wang 2011 physical ibwts also bring substantial social and economic costs that are associated with the possible displacement of residents the construction of pre treatment plants transport infrastructure works and system s operation and maintenance costs li et al 2015 these negative side effects drove the development of alternatives to constructing physical ibwts zhao et al 2017 including demand side measures such as boosting water use efficiency and improving water conveyance and distribution systems in the importing regions and supply side measures such as artificial groundwater recharge and developing unconventional water resources such as reclaimed wastewater seawater desalination and rainwater harvesting zhuang 2016 here we discuss another promising alternative to traditional physical ibwts namely virtual water vw trade in conjunction with altered cropping patterns this virtual ibwt measure may overcome some of the social and economic costs associated with physical ibwts but it is particularly promising regarding the improvement of water use efficiency if agricultural products are produced in water abundant regions with high water productivities and exported to water scarce regions with low water productivity abating local production water can be saved water scarcity alleviated and food security improved hogeboom 2020 research on the concept of virtual water trade revealed a potential to achieve higher levels of overall water saving and food security through trade compared to localized food production hoekstra and mekonnen 2012 hoekstra and chapagain 2008 in another study reimer 2014 developed an international agricultural trade model to address the role of trade in water intensive agricultural products given changing water availability levels developed with a focus on water as the main input he demonstrated that trade could help countries face shocks which they could not otherwise bear themselves at the same time they postulate that trade liberalization and subsequent changes in global production patterns are unlikely to save water but do improve economic welfare while virtual water trade studies abound there are no studies to our knowledge that explicitly juxtapose virtual and physical ibwts the aim of this study therefore is to provide a comparative analysis of virtual and physical ibwts to explore their potential to overcome water shortages in agriculture and thereby improve national food security for a case study in iran we illustrate how a virtual and a proposed physical ibwt vary in terms of their i resulting unit water footprints per crop ii total water consumption related to crop production iii economic water productivity of crop production iv and their water scarcity alleviation potential from the results we try to distil general lessons for other geographical settings where policy makers are contemplating developing physical ibwt schemes please note that while the physical ibwt is actually proposed by iranian water planners our analysis does not constitute a before and after analysis rather we designed hypothetical scenarios for both physical and virtual ibwt that we deem plausible in this case study setting as a consequence we do not include relative costs of interventions needed to achieve these scenarios nor do we study their feasibility in our comparison of impacts 2 method and data 2 1 study area iran is one of the most water scarce countries in the world and suffers from both depleted surface water and groundwater resources karandish et al 2018 2020 water scarcity is most pronounced in the semi arid provinces of the country with intensive agriculture which includes semnan province fig 1 in order to increase water availability in semnan province iran s national water planners recently proposed a series of physical ibwt projects the most controversial of which aspires to desalinate 220 106 m3 from the caspian sea annually to transfer it to semnan province iprci 2014 since the intake of seawater is located in the humid and water abundant mazandaran province the project is called the mazandaran semnan ms ibwt project for convenience therefore we will refer to mazandaran province as the donor province in this research agriculture is the main freshwater user in both provinces imaj 2017 the ministry of agriculture distinguishes agricultural crop groups acgs and horticultural crop groups hcgs for this study we selected 39 crops that are commonly grown in both provinces and classified them into six acgs cereals legumes industrial crops vegetables cucumber family and forages and six hcgs grained fruits nutrient fruits fine grained fruits dried fruits semi tropical fruits and greenhouse crops mazandaran and semnan province contributed 3 4 and 0 8 to national production of agricultural crops and 17 and 1 3 to national production of horticultural crops respectively in the year 2015 imaj 2017 the higher production in mazandaran province compared to semnan province can be explained by the larger area under cultivation in the former province and differences in cropping patterns table 1 the two provinces are currently trading partners with a reported net virtual water trade from mazandaran to semnan province over the past two decades karandish and hoekstra 2017 2 2 comparative analysis we considered the following three scenarios for our comparative analysis base case reflecting current cropping patterns meaning the composition of the crop mix and the share of each crop in total harvested area and total production in both provinces current provincial water availability levels and current virtual water trade between mazandaran and semnan provinces physical ibwt case reflecting current cropping patterns in both provinces and current water availability levels in mazandaran province semnan province in this case has access to an additional 220 106 m3 y 1 of desalinated water i e anticipating the planned ms ibwt project we allocated this transferred water over the various semnan grown crops based on their 10 year weighted average of unit blue water footprint blue wfprod m3t 1 see section 2 2 1 the crop with the largest unit blue water footprint in semnan is thus assigned its full blue water requirement first then the second largest and so on until the amount of 220 106 m3 has been fully allocated virtual ibwt case reflecting modified cropping patterns in both provinces and current provincial water availability levels in semnan province mazandaran province in this case is assigned an additional 220 106 m3 y 1 of water water that is currently undeveloped but that we assume could become available for agricultural purposes if it were developed cropping patterns in mazandaran were modified such that the annual total production t that could be achieved in semnan province on account of the additional 220 106 m3 of transferred desalinated water as proposed in the physical ibwt case i e the crops with the largest total blue wf in semnan province would now be produced in mazandaran province instead this modification implies that the harvested area of these crops is increased in mazandaran province as a function of this additional production accordingly the harvested area of these crops in semnan province is reduced hence the rationale behind these modifications is that the water rich mazandaran province can and should yield surplus production of chiefly water intensive crops to abate production of these crops in water scarce semnan province through interprovincial trade mazandaran grown crops and their virtual water content are then exported to semnan province for final consumption the harvested area of the other less water intensive crops remains unaltered in both provinces we analyzed these three scenarios in terms of their i resulting unit water footprints per crop ii total water consumption related to crop production iii economic blue water productivity of crop production iv and their blue water scarcity alleviation potential 2 2 1 unit water footprints of crop production for the period 2006 2015 we calculated annual green blue water footprints related to crop production wfprod m3 t 1 of 39 crops per province per year based on the accounting framework of hoekstra et al 2011 this calculation followed similar procedures as karandish and hoekstra 2017 but we improve on their study by including more crops in our assessment and considering a longer time period for each crop green and blue wfprod were calculated by dividing seasonal green and blue evapotranspiration m3 ha 1 by provincial crop yield t ha 1 respectively we employed fao s aquacrop model to estimate seasonal evapotranspiration hsiao et al 2009 steduto et al 2009 the model was first run for a 5 year period to set initial values of soil moisture content aquacrop simulates a daily soil water balance for the crop s rooting zone a follows 1 s t s t 1 p t i t c r t e t t r o t d p t here s is the soil water content at the end of day t or t 1 respectively p precipitation i irrigation applied cr capillary rise et evapotranspiration ro surface runoff and dp deep percolation all units are in mm d 1 since groundwater levels are generally deeper than one metre below the rooting zone cr was assumed to be zero karandish and hoekstra 2017 to differentiate between the green and blue soil moisture content s we followed the procedure proposed by hoekstra 2019 2 s g r e e n t s g r e e n t 1 p t r o t p t p t i t d p t e t t s g r e e n t 1 s t 1 s b l u e t s b l u e t 1 i t r o t i t p t i t d p t e t t s b l u e t 1 s t 1 for each acg and hcg category the weighted average wfprod for every year in the period 2006 2015 was calculated based on the production of different crops within that category thereafter the 10 year production weighted average wfprod was calculated for each crop category over the period 2006 2015 agricultural data including crop type annual irrigated and rain fed harvested area annual total production and yield cropping calendars and agricultural practices were obtained from iran s ministry of agricultural jihad imaj 2017 provincial averages of climate data were taken from irimo 2020 2 2 2 total water footprints of crop production the total crop water footprint wftot m3 reflects the aggregate claim on water resources associated with the production of that particular crop in a given year to obtain annual wftot we multiplied reported annual crop total production from imaj 2017 with annual unit wfprod per crop category 2 2 3 economic blue water productivity the economic blue water productivity ebwp m 3 reflects the monetary revenue of water consumption hogeboom and hoekstra 2017 per crop province and year we estimated ebwp as 3 e b w p p c r o p t p c w a t e r w f p r o d b l u e t p w f p r o d b l u e t p where pcrop is the crop s unit price t 1 cwater is unit blue water cost m 3 tp is total production t the 10 year average of ebwp was then calculated as a production weighted average over each year in the period 2006 2015 crop unit prices are taken from fao 2017b the unit blue water cost in iran s agricultural sector is estimated by karandish 2016 at 0 02 m 3 representative for the period 2006 2015 for the physical ibwt case addition costs related to developing the physical infrastructure for both the desalination plant and the transfer works need to be included which are estimated at 116 107 iprci 2014 assuming a 50 year life span an average capacity of 220 106 m3 y 1 and excluding maintenance costs we presumptively estimate the physical ibwt associated cwater at 0 10 m 3 2 2 4 water scarcity alleviation potential differences in wftot amongst the scenarios result in different levels of blue water scarcity bws at the provincial level per province bws is calculated by dividing the blue wftot m3 per crop and year by local water availability m3 local water availability is calculated as the local annual natural runoff minus environmental flow requirements data on natural runoff at the province scale was taken from iran s water resource management company wrm 2016 environmental flow requirements were assumed at 80 of natural runoff following richter et al 2012 a bws 1 indicates that water consumption exceeds sustainably available water availability levels creating a water scarcity hotspot 3 results 3 1 base case the 10 year average of green blue wfprod over the period 2006 2015 given current cropping patterns and current local water availability is shown in fig 2 we observe that for most crop groups wfprod is noticeably larger in the arid semnan than in the humid mazandaran province indicating more water efficient production in mazandaran province except for the greenhouse crops which are fully reliant on blue water in both provinces the share of blue water in green blue unit water footprints is larger in semnan province for all crops with this share ranging between 73 3 for industrial crops to 94 0 for nutrient fruits versus 15 3 for legumes to 40 6 for nutrient fruits in mazandaran province in semnan province industrial crops legumes dried fruits semi tropical fruits and cereals rank first to fifth in terms of the largest blue wfprod greenhouse crops and vegetables have the lowest blue wfprod mainly due to their higher yields per hectare in semnan province cereals have the largest green blue wftot as well as the largest blue wftot table 2 on average 17 107 m3 of blue water is consumed annually in mazandaran province to produce 60 104 t aggregated over 39 crops and 66 107 m3 to produce 93 104 t of selected crops in semnan province ebwp in mazandaran province vary from 0 91 m 3 for forages to 23 m 3 for greenhouse crops ebwp is considerably higher in mazandaran compared to semnan province with particularly pronounced differences for legumes the cucumber family and industrial crops both provinces have a higher ebwp for crops in hcgs compared to crops in acgs provincial averages of current ebwp in mazandaran and semnan province are 1 84 m 3 and 0 57 m 3 respectively the ten year average bws over the period 2005 2015 is 0 15 in mazandaran indicating the province does not suffer from water scarcity and 3 72 in semnan province indicating severe water scarcity 3 2 physical ibwt case our analysis for the base case revealed which crops are relatively most blue water intensive to produce in semnan province according to the allocation procedure described in the method the desalinized water annually transferred from mazandaran province 220 106 m3 can supply the full blue water demand for producing industrial crops 21 106 m3 dried fruits 18 106 m3 legumes 1 0 106 m3 and semi tropical fruits 13 107 m3 the remaining 48 106 m3 is assigned to cereal production for which it accounts for 32 of its blue wftot the remaining 68 of cereal production is produced by locally available blue water resources in this case the total production wfprod wftot and its blue share for both provinces do not change for any of the crops compared to the base case table 3 for semnan province however the costs associated with the transferred blue water and thus its ebwp do differ ebwp of affected crops is down considerably from 5 for dried fruits to 46 for industrial crops costs and ebwp in mazandaran province remain unaltered the positive effect of the transferred water is that it reduces the strain on semnan s local water resources we found that as a result bws is reduced by 34 in semnan province to 2 48 however at this level the province is still classified as severely water scarce bws in mazandaran province remains unaltered at 0 15 3 3 virtual ibwt case in this case all production of industrial crops dried fruits legumes semi tropical fruits and 32 of cereals which in the physical ibwt case were supposed to be produced in semnan province using the 220 106 m3 of the transferred water will now be produced in mazandaran province using local freshwater assumed to be developed there these mazandaran grown crops abate their production in semnan to which they will be exported through interprovincial trade table 4 shows that wfprod in both province is unaltered with respect to the base case however annual blue wftot increases by 40 to 23 107 m3 in mazandaran province while in semnan province requires 220 106 m3 blue water less 33 compared to the base case the provincial average ebwp in mazandaran province will increase to 1 97 m3 which is 7 higher than in the base case this increase can be explained by the increasing relative share of crops with high ebwp in mazandaran s crop mix i e legumes semi tropical fruits and dried fruits on account of the same reason provincial average ebwp in semnan province is reduced by 10 to 0 51 m3 bws in semnan province decreases as in the physical ibtw case by 34 to 2 48 due to the additional water use bws in mazandaran increases by 40 to 0 21 however this value indicates local water resources can still sustainably support the increased demand table 5 summarizes the most important indices calculated for the three cases 4 discussion we compared a physical and a virtual ibwt scheme with current cropping patterns and local water availability across several criteria in calculating unit water footprints we used default crop parameters of the aquacrop model because observations or measurements of both crop parameters or actual unit water footprints are lacking simulated wfs could not be calibrated or validated although this introduces uncertainty in our estimated unit wfs they mainly serve to illustrate the dynamics associated with the two ibwt schemes in this regard a more questionable aspect of our assessment probably lies in the implicit assumption that in the virtual ibtw case it is practically feasible to accommodate additional production in mazandaran province however we reckoned this assumption is acceptable based on the relative abundance of water resources as indicated by a low bws index and a large acreage of undeveloped suitable lands mesgaran et al 2017 moreover our list of assessment criteria is only partial and excludes various other important economic social and environmental considerations that are needed towards the actual planning of a virtual versus a physical ibwt regarding economic considerations we found that the relatively high unit blue water cost by agricultural standards in the physical ibwt case 0 10 m 3 drives down ebwp this might support the argument that a physical ibwt might still be economically viable for industrial use as industrial users may be willing and able to cover higher tariffs the current unit blue water price is 0 59 m 3 according to iprci 2014 however the water to be physically transferred is not earmarked for any particular sector per se it can be used to complement either industry or households or agriculture water shortages moreover our estimate for the water cost is likely an underestimation as we excluded energy and infrastructure maintenance costs as well as potential costs of externalities incurred by environmental degradation around the physical ibwt inlet due to desalination on the other hand our analysis also excluded additional marginal costs that are incurred by the trading of products in the virtual ibwt case such costs eventually are borne by consumers in the importing province however we expect these additional costs to be lower than the substantial costs associated to the physical ibwt regarding potential social considerations expanding agricultural lands and producing more crops in mazandaran province under a virtual ibwt setting may provide increased job opportunities for local residents and reduce the unemployment rate there currently the unemployment rate in mazandaran province is roughly 21 higher than that in semnan province sci 2020 which is a compelling argument to the iranian government to initiate the labor intensive physical ibwt project in the first place iprc 2014 on the other hand reduced agriculture production in semnan province under the virtual ibtw case may increase unemployment there regarding environmental considerations we looked at some water aspects related to the three cases but an analogous assessment complementary to ours may be carried out for the amount of energy required for the physical ibwt case the energy needed to transfer the desalinated water from mazandaran province to semnan province is estimated at 39 103 gj iprc 2014 5 0 103 gj of this number is planned to be supplied by hydropower the additional blue water consumption associated with this hydropower generation has not been accounted for in our analysis of the physical ibwt scenario however based on iran s national average blue wf of hydropower of 0 91 m3 gj 1 as estimated by hogeboom and hoekstra 2018 we can cautiously estimate that this generation will come at the cost of another 4 6 103 m3 of blue water annually moreover there is a risk of salination near the desalination plant s outlets national reports show that the envisioned desalination process will produce wastewater with a salinity of 25 g l 1 which is two time higher than the ambient concentrations iprc 2014 such salinity levels are expected to pose serious threats to local fish habitats and stocks in the caspian sea particularly the area in close proximity to the effluent outlet is running the risk of turning into an ecological dead zone iprc 2014 another consideration in the planning of a physical ibwt is its inflexibility after all while water requirement in the recipient region may change over time e g due to population growth economic development and climate change the volume of transferred water is largely fixed by the number of pumps gauging stations and dimensions of the channels a virtual ibwt scheme in contrast offers more flexibility in that it can adapt and evolve to changing needs the main rationale to employ an ibwt either physical or virtual is typically a persistent shortage of water such shortages arise either because the region is physically water scarce or because of overuse and mismanagement of available water resources in semnan province both are the case however an strong argument can be made to consider addressing the latter issue first before resorting to an ibtw both the relatively large blue wfprod in semnan province and their high variability over the years suggests that there is indeed a large potential of blue water savings through improving water use efficiency 5 conclusion physical ibwts are commonly used planning measures to overcome water shortages in one location by physically transferring water from water abundant regions to those that lack the resource since these physical ibwts are heavily criticized because of the social economic and environmental costs they may incur we set out to explore the merits of an alternative ibwt to overcome local water shortages namely a virtual ibwt using a comparative analysis for a case study in iran we illustrate how both physical and virtual ibwts have the potential to reduce blue water scarcity in the receiving region however the physical ibwt was found to potentially reinforce inefficient farming practices in already water scarce regions a virtual ibwt in contrast might abate production in low water productivity regions by increasing production in more water efficient regions coupled with trade while it was not the case in our case analysis for iran careful attention should be given to the exporting region to assure that the added production will not increase blue water scarcity levels beyond locally sustainable thresholds this study also found that a virtual ibwt can increase economic water productivities while a physical ibwt reduces them on account of the large costs incurred by their construction we recommend water planners contemplating the development of physical ibwts to also consider the merits of virtual alternatives author statement f k and a y h conceived and designed the research f k performed the modeling work f k a y h and r j h wrote the paper declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement during the revision stages of this manuscript our esteemed co author prof dr arjen y hoekstra suddenly and unexpectedly passed away his passing demarcates a great loss both to us personally and to science at large we acknowledge his contributions to this piece of work and dedicate it to him this project has received funding from the european research council erc under the european union s horizon 2020 research and innovation programme earth lternatives project grant agreement no 834716 supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103811 appendix supplementary materials image application 1 
