index,text
2055,for flood simulation in small and medium sized catchments discharge observations may be used to update model states of a distributed hydrological model to improve performance the ensemble kalman filter enkf has been widely used for hydrological assimilation due to its relative simplicity and robustness an advantage of the enkf is that it is easy to include different sources of uncertainty therefore the choice of error model is crucial for the application of the enkf assimilation this paper describes an enkf assimilation scheme for estimating error models using the maximum a posteriori estimation method map we test this scheme in two small and medium sized catchments in china with different characteristics and in addition compared the performance differences under two kinds of rainfall forcing we show that map is beneficial in specifying error models and providing reliable ensemble spread the assimilation scheme can effectively ameliorate the degradation of distributed hydrological model performance due to uncalibrated model parameters and or poor quality of input data keywords flood hydrological assimilation ensemble kalman filtering maximum a posteriori estimation distributed hydrological model data availability data will be made available on request 1 introduction flooding imposes huge costs on society causing damage to infrastructure and crops and at worst loss of life brázdil et al 2005 yiou et al 2006 thielen et al 2009 in particular the floods occurring in small and medium sized catchments are characterized by rapidity and suddenness usually with short flood duration and rapid rise of flood peak pilon 2002 it has been reported that more than 70 of economic losses and approximately 2 3rd of deaths from flood disasters in china are related to flood in small and medium sized catchments liu et al 2015 gong et al 2021 the two factors affecting flood forecasting most are the rainfall runoff update hydrological model simulation with measured or estimated evapotranspiration and measured rainfall until start of forecast and the quantitative weather prediction weerts el serafy 2006 a large number of researches focuses on the use of quantitative weather prediction output to produce flood forecasts e g gouweleeuw et al 2005 ming et al 2020 speight et al 2021 on the other hand research in rainfall runoff updating concerns focus on the uncertainty of hydrological model simulation e g wood et al 2016 piazzi et al 2021 it is widely accepted that the uncertainty in hydrological model simulation comes from several different sources including uncertainty in model input model structure and model parameters beven binley 1992 beven 1993 vrugt et al 2003 ajami et al 2007 mcmillan et al 2011 a plausible approach to reduce uncertainties in hydrological model simulation is to correct the states or parameters of the hydrological model for operational flood forecasting it reduces the accumulation of past errors in the initial conditions at the start of the forecast which has been shown to be a dominant source of uncertainty at the start of the forecast period shukla lettenmaier 2011 yossef et al 2013 thiboult et al 2016 manual modifications of the model states by human forecasters seo et al 2003 smith et al 2003 thiboult and anctil 2015 is a popular approach alternatively automatic state correction procedures by observed data in a data assimilation framework are also widely used techniques liu gupta 2007 liu et al 2012 lee et al 2012 available observed data can come from state variable observations from satellite remote sensing usually soil moisture evapotranspiration etc crow ryu 2009 zhang et al 2009 pezij et al 2019 or discharge observations clark et al 2008a ricci et al 2011 rakovec et al 2012 2015 sun et al 2020 in operational application the use of discharge observations is often a more convenient and reliable option as it is more directly related to flood forecasting li et al 2014 one of the well known hydrological assimilation techniques is the ensemble kalman filter enkf evensen 1994 burgers et al 1998 the enkf approximates and propagates probability distribution functions by a monte carlo sampling strategy which does not need a linearized model operator hydrological model required by extended kalman filter ekf jazwinski 1970 or an adjoint model required by variational methods reichle et al 2001 seo et al 2003 in addition it has been shown that enkf requires a smaller number of ensembles and show less sensitivity to the misspecification of the model and input uncertainties than the particle filtering pf methods weerts el serafy 2006 another advantage of the enkf is that the ensemble members are generated by randomly perturbing model inputs and states so it is easy to include different sources of uncertainty in the data assimilation system clark et al 2008a due to these advantages enkf is attracting a lot of attention in the field of hydrological data assimilation for distributed hydrological models the more complex structure usually means introducing greater uncertainty than lumped hydrological models fatichi et al 2016 therefore distributed models usually do not perform better overall than lumped models in small and medium sized catchments reed et al 2004 mai et al 2022 however distributed hydrological models allow a more detailed spatial representation of processes parameters and prediction they can use spatially measured forcing and they can handle the observation and simulation of hydrological variables at internal locations within the catchment beven 1985 maidment 1993 beven 2014 fatichi et al 2016 these properties make distributed models attractive for hydrological assimilation such as the adequate use of distributed rainfall data obtained through telemetry as well as they can also easily incorporate observations from locations within the catchment into the assimilation scheme which has been proved beneficial to improve the performance rakovec et al 2012 given that distributed hydrological models have been extensively used in flood simulation forecasting and have demonstrated reliability and robustness koren et al 2004 uhlenbrook et al 2004 reed et al 2004 smith et al 2004 xie and zhang 2010 unduche et al 2018 it is interesting to test the application potential of enkf in distributed hydrological models especially for small and medium sized catchments in the loess plateau spatially inhomogeneous features are significant due to human activity impacts fatichi et al 2015 zhang et al 2019 shi et al 2019 yuan et al 2022 furthermore in a large number of previous studies e g pauwels and de lannoy 2006 weerts el serafy 2006 li et al 2014 the lumped model with a unit hydrograph of channel delay widely used in hydrological assimilation suffers from a time delay issue where the discharge at the current time step depends on the discharge at several previous time steps and therefore requires techniques like retrospective ensemble kalman filtering renkf pauwels and de lannoy 2006 or ensemble kalman smoother enks li et al 2014 to overcome the time delay in contrast a grid based hydrological model allows for a more realistic modeling of time delay and the hydrological variables can be assumed to be markovian the value at the current time step depends only on the previous time step as commented by rakovec et al 2012 the simulated discharge is represented by the spatially distributed simulated states that quantify the volumes of the channel water thus any time delay between model state and discharge during assimilation does not need to be addressed explicitly enkf modifies the model state by a weighted average of the observations and the model results as such the success of this approach is strongly dependent on the accurate characterization of the uncertainties of model and observation liu et al 2012 several studies have attempted to analyze the individual and interactive effects of various uncertainties on hydrologic data assimilation e g fan et al 2022 concluded that uncertainties in discharge observations would have a visible effect on the particle filtering algorithm and its variants wang et al 2017 found that the most significant effect on enkf performance is the pairwise interaction between uncertainties in precipitation and discharge observation thiboult et al 2016 evaluated uncertainties in quantitative precipitation forecasts hydrological model structures and initial conditions through a combination of meteorological ensemble prediction multimodel approaches and ensemble kalman filtering enkf inappropriate estimation of these uncertainties has been reported to reduce the performance of the ensemble based kalman filter crow van loon 2006 reichle et al 2008 pathiraja et al 2018 one attempt to quantify those uncertainties is an adaptive filtering algorithm which estimates error covariances during the filter analysis procedure crow reichle 2008 however such algorithm relies on a number of strict assumptions and limitations including a required assumption of the serial independence of assimilated observation which limits its widely application and testing crow van den berg 2010 an alternative and more popular way to quantify uncertainties is the bayesian error analysis algorithm it explains the difference between model results and observations as the combined effect of several different sources of uncertainty such algorithms have been widely used for hydrological model parameter estimation quantifying uncertainty in hydrological model structure estimation of model forcing errors beven and binley 1992 vrugt et al 2003 kavetski et al 2006a kavetski et al 2006b kuczera et al 2006 clark et al 2008b vrugt et al 2008 teweldebrhan et al 2018 li et al 2021 however the bayesian error analysis skill has not been widely tested in applications that quantify the error parameters required by data assimilation techniques such as enkf an ensemble based maximum a posteriori map method is detailed by li et al 2014 which is a bayesian inference procedure adapted to ensemble based kalman filter it does not require the independence of the observation series and allows simultaneous estimation of errors from different sources also it is relatively simple to implement and easy to couple with the enkf method compared to other bayesian error analysis algorithm however a limitation of the map method is that it does not offer an objective selection of the error distribution and requires a priori assumptions about the error structure e g gaussian or log normal distribution which may not be entirely correct and may introduce unintended biases ryu et al 2009 liu et al 2012 several recent studies have attempted to fill this gap slater and clark 2006 introduced a cross validation method to estimate the uncertainty of forcing data without a presupposition of the forcing error distribution pathiraja et al 2018 proposed a data driven approach for estimating the model state error using kernel conditional density estimation to avoid predefining the state error distribution the approach assumes that the observation error is much smaller than the model state error and requires lengthy period of data to capture the full range of errors over the possible states such extensive data are often not available in flood event simulation in addition these studies focus on only a fraction of the total error sources model state error or forcing error and ignore or simplify other uncertainty these assumptions and conditions limit their application to the hydrological assimilation in comparison the map method has been applied in assimilation of remotely sensed soil moisture data sm da to correct soil water stores of lumped and semi distributed hydrological model alvarez garreton et al 2015 similarly the use of the map method to quantify model and observation errors in the correction of model states by observed discharge in lumped hydrological models demonstrates the potential li et al 2014 however the ability of the map method to quantify errors of distributed models has not been tested in previous research the objective of this study is to construct an enkf assimilation scheme for estimating errors of distributed hydrological model and observations using the bayesian based map method subsequently these error parameters are applied to correct hydrological model states by assimilating observed discharge in a distributed hydrological model with the aim of reducing the accumulation of errors in the initial conditions of the hydrological model at the start of the forecast period we tested the potential of this assimilation scheme for application in two catchments with different climatic conditions and different human activity impact in addition two different sources of rainfall forcing were tested to examine the potential of the assimilation scheme with different input data quality in this paper we use historical rainfall data as a perfect proxy for weather prediction with the aim of assessing temporal persistence of the assimilation effect without introducing uncertainty from numerical rainfall prediction 2 methodology 2 1 ensemble kalman filter the central idea of data assimilation is to incorporate new observed information during the dynamic operation of the numerical model to produce a posterior probability density function pdf of model state the enkf samples and predicts the pdf with a monte carlo method which provides the great benefit of being free from linearity and gaussian constraints on the model in this study the dimensionality of the state space observation space ensemble space and time space are denoted as n x n y n e n t respectively hereafter the subscript t t 1 n t is time index and the subscript n n 1 n e is ensemble index the enkf is formalized by the following equation the model states to be assimilated is denoted as vectors x 1 x t x 1 t x n x t r n x let x be an ensemble matrix of model states 2 x t x 1 t t x n e t t r n x n e the initial x t 0 r n x n e is obtained by the monte carlo method at the forecast step the state transfer equation is given as 3 x n t 1 f m x n t a u t v t where m r n x r n x is the dynamical model nonlinear hydrological model u is the model forcing v t r n x is the system or process gaussian noise with a covariance matrix q t the superscript f denotes the model forecast and superscript a denotes the analysis value of enkf the ensemble mean of model prediction vector in state space is given by 4 x t f 1 n e n 1 n e x n t f r n x and the ensemble mean of model prediction vector in the observation space e g discharge in this study is calculated with 5 h x t f 1 n e n 1 n e h x n t f r n y where h r n x r n y is the measurement operator also nonlinear hydrological model in this study that maps the state space to observation space at the analysis step the observation vector y t y 1 t y n y t r n y is distributed by a gaussian noise η t r n y with a covariance matrix r t 6 y n t y t η t where y t r n y n e is the perturbed observation vector in this study we assumed that the observation errors are independent in space so that r t is a diagonal matrix then the update equation is given as 7 x n t a x n t f k t y n t h x n t f where k is the kalman gain matrix calculated by the following 8 k t p t h t h p t h t r t 1 9 p t 1 n e 1 n 1 n e x n t f x t f x n t f x t f t r n x n x 10 p t h t 1 n e 1 n 1 n e x n t f x t f h x n t f h x t f t r n x n y 11 h p t h t 1 n e 1 n 1 n e h x n t f h x t f h x n t f h x t f t r n y n y when the dimensionality of the state space n x is large it is a better solution to calculate p t h t and h p t h t directly from the ensemble members instead of calculating p t houtekamer mitchell 2001 nerger hiller 2013 in this study the scheme proposed by clark et al 2008a was used in which the simulated discharge at gauging locations were included in the state vector but they were treated as diagnostic variables rather than state variables and were therefore not updated in addition the one step prediction in this study is described as follows the corrected model states x n t a at time step t is obtained by enkf which is used as the initial states of the hydrological model at time step t 1 and the simulated states x n t 1 f and simulated discharge h x n t 1 f at time step t 1 is obtained by the forward hydrological model 2 2 error parameter estimation from eq 8 it can be shown that the enkf corrects the model state by a weighted average of the observations and the model predictions therefore appropriate specification of model and observation errors is a necessary requirement for employing the enkf 2 2 1 uncertainty in discharge measurements uncertainty in discharge measurements can be obtained by comparing the velocity meter measurements with the values obtained from the water level discharge rating curve mcmillan et al 2013 sorooshian dracup 1980 pointed out that the uncertainty in discharge measurements at high water levels is larger than at low water levels due to the increased uncertainty in the rating curve at high water levels to represent the uncertainty in discharge measurement following the scheme used in clark et al 2008a and weerts el serafy 2006 we parameterized observation error as a function of discharge observation the measured discharge was imposed with the following perturbation 12 y n t y t i δ t y where i r n y n y is identity matrix δ t y is gaussian perturbation matrix assuming that the observation errors are independent at each flow gauging station δ t y r n y n y is a diagonal matrix 13 δ t y δ 1 t y 0 0 0 0 0 0 δ n y t y where δ i t y i 1 n y is the perturbation at flow gauging station i and δ y n 0 σ y in addition the temporal correlation of streamflow error is relatively high so we included a first order autoregressive model the perturbation δ i t y at time step t is modified as 14 δ i t y μ y α y δ i t 1 y μ y φ σ y 1 α y 2 0 5 where μ y 0 φ is a standard gaussian noise α y is autocorrelation coefficient for streamflow error the standard deviation σ y and coefficient α y are the error parameters that need to be estimated 2 2 2 uncertainty in hydrological model the uncertainty in hydrological model can usually be divided into several different sources including forcing errors structure errors and parameter errors to represent the uncertainty in model forcing we adopt the widely used lognormal multiplicative error function mcmillan et al 2011 dechant moradkhani 2012 15 p n t δ t p p t where p t p 1 t p n p t r n p is the rainfall observation vector n p is the dimensionality of the forcing space δ t p is lognormal perturbation matrix for station data we assume that the errors in the precipitation measurement are spatially independent thus δ t p is represented as a diagonal matrix 16 δ t p δ 1 t p 0 0 0 0 0 0 δ n p t p where δ i t p i 1 n p is the perturbation at rainfall gauging station i and δ p follows a lognormal distribution with the mean of 1 0 and standard deviation of σ p it means ln δ p n μ lnp σ lnp where μ lnp 0 5 σ lnp 2 and the standard deviation σ p e x p σ lnp 2 1 for era5 data the same lognormal perturbation is implemented but we assume fully correlated errors in space so that the same perturbation is applied to the whole precipitation field we included a first order autoregressive model based on lognormal perturbations to characterize the temporal correlation of rainfall errors li et al 2014 the perturbation δ i t p at time step t is modified as 17 ln δ i t p μ lnp α lnp ln δ i t 1 p μ lnp φ σ lnp 1 α lnp 2 0 5 where φ is a standard gaussian noise α lnp is autocorrelation coefficient the hyper parameter σ lnp and coefficient α lnp are the error parameters that need to be estimated the perturbations to the model state reflect the accumulation of uncertainties in the model structure and parameters the model state variables selected for assimilation in this study were soil moisture content and reservoir storage rs soil moisture was represented through the variable s named free water storage in grid xaj flex as the model states in the diffident spatial cell may not be the identical the gaussian multiplicative error function was used to perturb both the soil moisture and reservoir storage 18 x n t δ t x x n t where x n t s n t 1 s n t n s rs n t 1 rs n t n r r n x is model state vector mentioned in section 2 1 n s and n r are the dimensions of the two kind of model states respectively and n x n s n r δ t x is diagonal gaussian perturbation matrix the elements on the diagonal are δ 1 t s δ n s t s δ 1 t r δ n r t r δ s n 1 σ s and δ r n 1 σ r are the perturbations of soil moisture and reservoir storage respectively the standard deviation σ s and σ r are the error parameters it is important to note that σ s needs to be kept quite small to avoid rapid changes of soil moisture between continuous time steps liu et al 2017 deterministic run of the hydrological model is hereafter noted as dr ensemble prediction of hydrological model obtained by adding the above unbiased perturbations eq 15 and eq 18 to the model forcing and states are hereafter called open loop ol besides adding these perturbations to model the enkf is then applied to correct the model states and the consequent ensemble prediction are hereafter called enkf assimilation mode enkf the subscripts sr and er were used to denote station forcing and era5 forcing respectively for example the enkf assimilation mode under station rainfall forcing is noted as enkfsr 2 2 3 map method the maximum a posteriori estimation method map is used to estimate the global optimum of the error parameters that need to be specified in the assimilation system the goal of map is to maximize the probability density of the error parameters with given the observing historical flood events this set of error parameters ψ σ y σ s σ r σ lnp α y α lnp is the global optimal estimate according to bayesian theory this posterior probability density can be expressed as 19 p ψ y χ ψ p ψ p y ψ where ψ is error parameters ψ σ y σ s σ r σ lnp α y α lnp p ψ is a posteriori probability density of ψ p y ψ is the conditional probability density of the observing historical discharge y given ψ p ψ is calculated by the following 20 p ψ p σ y p σ s p σ r p σ lnp p α y p α lnp where p σ y p σ s p σ r p σ lnp p α y p α lnp respectively represent a prior probability density of the corresponding error parameter following li et al 2014 σ y is assumed to follow a gaussian prior distribution σ y n 9 25 0 925 the prior for standard deviation σ s and σ r of gaussian perturbation follows the reference prior 1 σ s and 1 σ r berger et al 2009 the prior for hyper parameter σ lnp of lognormal perturbation follows the reference prior 1 σ lnp 1 2 σ lnp 2 harvey van der merwe 2012 the autocorrelation coefficient α y and α lnp are assumed to follow a uniform prior distribution the conditional probability density p y ψ is calculated by the following 21 p y ψ i 1 n y t 1 n t p y i t ψ where p y i t ψ is the conditional probability density of the observed discharge of i th flow gauging station at time t with given ψ the sce ua duan et al 1992 is used to operate the optimization process the objective function is defined as 22 f obj 1 n f m 1 n f l n χ ψ where n f is number of historical flood events and then the optimal error parameters ψ is obtained by minimizing f obj 23 m i n f obj ψ in one evaluation of sce ua f obj can be calculated as follows before running hydrological model a set of specific error parameters ψ is sampled from predefined error parameter space a prior probability density p ψ of sampled ψ is computed by eq 20 then the hydrological model runs temporally forward in an ensemble mode and at time step t the ensemble prediction of model states and discharges were given as 24 m x t 1 p t 1 x t q t i where m is hydrological model with ensemble mode q t i i 1 n y is ensemble prediction of discharges the model states at the previous time step x t 1 can be obtained from open loop or assimilation prediction the perturbation as shown in eq 12 is further added to q t i to get the perturbed ensemble prediction of discharges q t i we calculate the mean and standard deviation of q t i for each flow gauging station denoted as μ t i and σ t i and fit q t i to a gaussian distribution n μ t i σ t i the p y i t ψ is then obtained by calculating the probability density of y i t from n μ t i σ t i finally χ ψ can be obtained from eq 19 repeating the above process in all flood events the objective function f obj and the corresponding error parameters can be obtained by eq 22 it should be noted that p ψ y in eq 19 do not need to be computed χ ψ suffices to compute the objective function indeed if p ψ y was substituted for χ ψ in eq 22 the objective function would simply be shifted by a constant 2 3 evaluation metrics we use five different metrics to evaluate the performance of hydrological assimilation scheme including both optimal single value i e the ensemble mean and ensemble simulation performance all metrics used in this study are for a single flood event and the flood event indicator is omitted below 2 3 1 ensemble mean the ensemble mean of discharge for a flood event is evaluated through root mean squared error rmse and nash sutcliffe efficiency coefficient nse which are described as follows 25 rmse 1 n t t 1 n t y t sim y t 2 26 nse 1 t y t sim y t 2 t y t y ave 2 where y t is the observed discharge at time step t y ave is the temporal mean of the observed discharge in the flood event y t sim is the simulated discharge here ensemble mean discharge for the ensemble run or the simulated discharge of the hydrological model for the deterministic run the ratio of rmse of the simulated discharge and the persistence forecasting pf defined as the most recent observations as prediction discharge denoted as π rmse 27 π rmse rmse sim rmse pf the event average of nse and π rmse are respectively denoted as n s e and π rmse 2 3 2 ensemble performance following mcinerney et al 2020 we consider a climatological discharge distribution for each hour of year as a reference for the ensemble evaluation it is constructed using a sliding window approach and the window half width n clim 12 h on dates when hourly observations are not available we interpolate the daily observations to obtain hourly data given the importance of both the reliability and sharpness of forecasts gneiting et al 2007 gneiting and katzfuss 2014 evin et al 2014 three metrics are used to evaluate ensemble performance overall performance about ensemble simulation is assessed using the continuous ranked probability score crps hersbach 2000 mcinerney et al 2020 the crps is regarded as the integral of the brier score brier 1950 over all possible threshold values for the variable the crps provides information about both the ensemble reliability and ensemble uncertainty as the crps quantified the simulation for a single time step the crps ave is defined as the temporal average crps over the entire period in a flood event for detailed about crps ave please refer to hersbach 2000 the ratio of crps ave of the simulated discharge distribution here the ensemble discharge from enkf or ol and the climatological discharge distribution denoted as π crps 28 π crps crps ave s i m crps ave c l i m r e f where subscript sim indicates the simulated discharge distribution being evaluated and subscript climref indicates the climatological discharge distribution the event average of π crps is denoted as π crps sharpness about ensemble simulation is quantified by the metric π s h a r p it quantifies ratio of interquartile ranges iqrs of the simulated discharge distribution and the climatological discharge distribution 29 π sharp s h a r p n e s s φ sim φ climref 1 n t t 1 n t φ sim t 1 1 p φ sim t 1 p 1 n t t 1 n t φ climref t 1 1 p φ climref t 1 p where p is the distribution quantile p 0 05 in this study φ t 1 p is the inverse cumulative distribution function of a predictive distribution at time step t for detailed about the sharpness metric please refer to mcinerney et al 2020 the event average of π sharp is denoted as π sharp the predictive quantile quantile pqq plot displays the empirical frequency of discharge observations within the simulated discharge distribution evin et al 2014 following mcinerney et al 2017 the reliability about ensemble simulation is quantified by the metric reli which represents the discrepancy between the pqq plot and the 1 1 line 30 reli 2 n t t 1 n t f u fy t sim y t f ω fy t sim y t where f u is the cumulative distribution function cdf of the uniform distribution u 0 1 f ω is the empirical cdf of the set ω and the set ω fy t sim y t t 1 n t fy t sim is the cdf of the simulated discharge distribution at time step t and y t is the observed discharge at time step t the event average of reli is denoted as r e l i 3 distributed hydrological model in this study a flexible distributed hydrological model grid xaj flex flexible grid xinanjiang model is used to perform flood simulation experiments in the study catchments the structure of the model is shown in fig 1 the grid xaj flex model is a modified variant of the grid xinanjiang model grid xaj yao et al 2009 yao et al 2012 yao et al 2019 which is developed from the well known xinanjiang model xaj zhao et al 1980 zhao 1992 the primary computational elements of grid xaj flex are identical square grids based on the dem the fundamental assumption is that model forcing parameters and topography and soil and vegetation types are spatially uniform inside each grid however they may differ between each grid which depends on the thematic maps the major hydrological processes involved in the model include canopy interception direct channel precipitation evapotranspiration runoff generation overland flow routing and channel routing all of which are calculated within each grid the potential evaporation estimated from pan evaporation soil evaporation is calculated from potential evaporation by the three layer soil moisture module zhao and liu 1995 the runoff generation module is designed based on the saturation excess mechanism in the overland and channel routing module grid xaj flex routes water over a d8 network the 8 direction steepest descent algorithm by kinematic wave model which is solved with a nonlinear scheme using newton s method chow et al 1988 van verseveld et al 2022 it has been shown that most of the grid xaj flex parameters are spatially heterogeneous and a priori parameter estimates can be obtained from digital elevation map soil type map and vegetation map yao et al 2012 the time step of the hydrological model in this study is 1 h 3 1 improved method of calculating runoff generation the method of calculating the runoff generation in grid xaj is derived from saturation excess mechanism which is the major feature of the xaj model the runoff in each grid is not produced until the soil moisture of the unsaturated zone reaches field capacity after which the excess rainfall generates runoff the method has demonstrated superior simulation skills in humid and semi humid areas in china and has been widely used in streamflow simulation and operational flood forecasting in those areas zhao liu 1995 jayawardena zhou 2000 chen et al 2007 li zhang 2008 therefore the runoff generation calculation module of grid xaj is used directly in tunxi catchment in this study however in semi arid and arid catchments the dominant hydrological process will no longer be saturation excess runoff generation but infiltration excess runoff generation or the combination of the two as such the original method of grid xaj may not be applicable to those catchments the flexible modeling framework clark et al 2011 has provided new ideas for flood simulation in semi arid and arid areas in the latest work huang et al 2016 and liu et al 2020 proposed the spatial combination modeling framework based on the concept of dominant runoff processes which means that different runoff generation mechanisms are adopted in different regions within a catchment in grid xaj flex model the grids within a semi arid or arid catchment are divided into saturation excess grids seg and infiltration excess grids ieg based on topographic index using the skill detailed by huang et al 2016 on the seg the original runoff generation module of grid xaj is still used but we replace it in the ieg with the green ampt model green ampt 1911 huo et al 2020 liu et al 2020 to calculate infiltration excess surface runoff where the infiltrated water refills the soil moisture and generates subsurface runoff only when the soil moisture is saturated fig 1 b the a priori parameters of the green ampt model can also be obtained from soil type map rawls et al 1983 3 2 reservoirs the original grid xaj yao et al 2012 does not have a calculation module for reservoirs therefore its application is limited in areas with large number of reservoirs in this study a point reservoir module zhao et al 2016 is integrated into channel routing in the grid xaj flex to reduce this limitation first we divide reservoirs into several pools with different functions see fig 1 c in the study regions most reservoirs are check dams or small reservoirs without gates which are referred to as uncontrolled reservoirs the release of such reservoirs is simplified by passing through two spillways the principal spillway and the emergency spillway shi et al 2019 the emergency flood control pool is the part of the reservoir that is above the emergency spillway the part between the two spillways is called the flood control pool and these two pools are used for flood control tasks the part below the primary spillway is referred to as the conservation pool and the inactive pool the conservation pool is used for regular water supply such as urban water supply agricultural irrigation and hydropower it should be noted that the all reservoirs in two study catchments are used only for flood control i e the water stored in the conservation pool will not be utilized after defining the reservoir structure the grids where the reservoir is located are recorded as the reservoir grids the reservoir grid received inflow q in from the outflow of adjacent upstream grids and the outflow q out of the reservoir grid means the calculated reservoir release the reservoir storage and release are calculated depending on the operation rules previous storage values evaporation and release amounts the reservoir evaporation e r is obtained from the potential evaporation calculated in the grid xaj flex the operating scheme of the reservoir is as follows 31 q t out 0 rs t rs c α γ rs t rs c δ t rs c rs t rs f a n d q t 1 outlet q max outlet 0 rs c rs t rs f a n d q t 1 outlet q max outlet rs t rs f δ t rs t rs f and based on the mass balance the reservoir storage is calculated as follows 32 rs t rs t 1 δ t q t in e t r a q t out where r s c and r s f are the storage values when the water level reaches the top of the conservation and flood control pool respectively m3 rs t is the reservoir storage value at time step t m3 α is the flooding condition multiplier which is equal to 1 during the non flood period and is greater than 1 during the flood period γ is the discharge coefficient depending on the dam structure q max outlet is the alarm flow at the basin outlet m3 s q t 1 outlet is the flow at the basin outlet at previous time step t 1 m3 s a is the water area m2 3 3 model calibration table 1 summarizes the parameters of the distributed hydrological model used in this study a priori estimates of most model parameters were obtained from the underlying surface data as explained above the sensitive parameters are optimized by the sce ua method duan et al 1992 to update the a priori estimates with the aim of obtaining their global optimal values for tunxi catchment the internal station yt that was treated as ungauged but where measured discharge is available was not used for parameter calibration to evaluate model performance in uncalibrated areas 4 study areas and data 4 1 study areas in this study two small and medium sized catchments in china with significantly different climatic and underlying surface are selected to test the performance of the assimilation scheme as shown in fig 2 the tunxi catchment 117 38 118 29 e 29 27 30 5 n is located in the south of anhui province china the drainage area is 2 693 km2 with the elevation ranging from 96 to 1 622 m fig 2a the average annual temperature is about 17 0 c the average annual precipitation is about 1 800 mm more than 60 of precipitation occurs during may to august this region is well vegetated over 70 vegetation cover including evergreen coniferous forest deciduous broadleaf forest mixed forest forest land woodland grassland pasture and crop land fig 2b the dominant soil is clay loam fig 2c there are a lot of small reservoirs in the catchment fig 2a but compared to the abundant amount of runoff the role of reservoirs in adjusting runoff is not strong as such the tunxi catchment has a typical humid climate without strong human activity impacts the suide catchment 109 14 110 13 e 37 30 37 56 n is located in the loess plateau china the drainage area is 3906 km2 with the elevation ranging from 796 to 1744 m fig 2d the average annual temperature varies from 7 8 to 9 6 c the average annual precipitation is about 450 mm of which 80 falls in the summer months from june to september mainly as intense rainstorms the vegetation cover in the catchment is less than 30 and the dominant vegetation are herbs and shrubs fig 2e the dominant soil is loam and clay loam fig 2f the large area of bare loess and the intense rainstorms have caused severe soil erosion in order to intercept sediment and reduce flood peaks a large number of check dams have been built in channel fig 2d a check dam usually has no gates and is composed of a dam body and a spillway or a drainage canal a large number of these hydrological engineering structures strongly change the natural runoff process xu et al 2013 polyakov et al 2014 li et al 2017 shi et al 2019 thus in contrast to the tunxi catchment the suide catchment has a typical semiarid continental climate with strong human activity impacts 4 2 data basis the 1 km 1 km digital elevation model dem of the study areas fig 2a d were obtained from the united states geological survey usgs http edc usgs gov products elevation gtopo30 gtopo30 html the 1 km 1 km land use map fig 2b e was derived from global land cover facility glcf https geog umd edu feature global land cover facility glcf the soil maps at the 10 km grid cell resolution were from the food and agriculture organization of the united nations fao https www fao org soils portal data hub soil maps and databases harmonized world soil database v12 en the soil maps were resampled to the 1 km 1 km grids by the nearest neighbor method to match other underlying surface data fig 2c f reservoir data for the tunxi catchment were from hydrology bureau of anhui province check dam data for the suide catchment were from the yellow river conservancy commission the hydrometeorological data for the two catchments were provided by the hydrology bureau of anhui province and shaanxi province including evaporation precipitation and discharge there are 9 rainfall gauging stations within the tunxi catchment and 14 in the suide catchment fig 2a and fig 2d based on these rainfall gauging stations in a catchment hourly gauge precipitation data were interpolated using inverse distance squared weighting method in each grid to produce spatial rainfall distribution pattern in order to evaluate the performance of the assimilation scheme under different model forcing era5 https cds climate copernicus eu the hourly rainfall reanalysis data with a resolution of 0 25 were also used and resampled to 1 km 1 km grids to match the model spatial computational cells evaporation data obtained from the daily pan evaporation with the e 601 pan hourly pan evaporation is calculated as 1 24 of the daily pan evaporation since there is one evaporation observation station in each of the two study catchments the pan evaporation is considered to be spatially homogeneous within each catchment daily discharge data are available from 2008 to 2016 for tunxi catchment and 2010 to 2017 for suide catchment hourly observations are discontinuous and only available during flood events in these years flood events were selected using the method of peaks over threshold huang et al 2016 for the tunxi catchment there are two discharge gauging stations tunxi station tx at the catchment outlet and the nested yuetan station yt fig 2a seventeen flood events between 2008 and 2016 were selected of which eight flood events from 2010 to 2013 were used for model calibration and the remaining nine were used for validation for the suide catchment 13 flood events recorded from 2010 to 2017 at the discharge gauging station named suide hereinafter referred to as sd fig 2d located at the catchment outlet were selected including the extreme flood peak flow of 3 280 m3 s that occurred on july 26 2017 which is the largest observed flood since the station was established eight of the flood events from 2010 to 2013 were used for model calibration and five flood events from 2013 to 2017 were used for model validation the flood events used in this study are listed in table s1 5 results 5 1 rainfall forcing two different rainfall datasets are used in this study with the aim of assessing the potential of the assimilation scheme with different input data quality station rainfall forcing is from gauging stations within the catchment era5 is the fifth generation ecmwf reanalysis data set which has been applied in china e g jiang et al 2021 fig 3 shows the differences between the two rainfall datasets as shown in fig 3 a era5 usually underestimates or misses the extreme rainfall more points lie below the 1 1 line implying that most of the time era5 records less hourly rainfall than site observations as examples the rainfall during two flood events are shown in fig 3b c era5 data show lower rainfall peaks and temporally more uniform rainfall distributions in the study basins and total rainfall is generally underestimated during a flood event 5 2 hydrological model performance the hydrological model performance of the two study catchments is shown in table 2 and fig 4 first we focus on the two observation locations within the tunxi catchment overall the grid xaj flex model shows high discharge simulation performance in the tunxi catchment it can be seen that the model performance of the validation location yt is just slightly degraded compared to the calibration location tx under both kinds of rainfall forcing however the model performance i e nse of the suide catchment is significantly poorer to that in the tunxi catchment this is because the tunxi catchment is a humid catchment and less influenced by human activities showing natural streamflow and the dominance of saturation excess mechanism that make it easy to simulate discharge in contrast suide catchment is located in the semi arid area and runoff in these areas is usually dominated by the complex coexistence and spatial combination of saturation excess and infiltration excess mechanism rather than by a single mechanism liu et al 2020 also human activities have greatly changed the streamflow these properties may limit the accuracy of discharge simulation by the hydrological model in suide catchment therefore these two catchments are selected to compare the correction effect of the assimilation scheme under different hydrological model performance in addition model performance under station rainfall forcing is significantly better than that under era5 rainfall forcing in both catchments underestimation of rainfall by era5 has led to generally low simulated discharges under era5 forcing and a significant underestimation of peak discharge fig 5 compares the simulated discharge for the ol and the deterministic run dr for all flood events in two study catchments we find that the ensemble mean of the discharge produced by the ol will be similar to the simulated discharge from the dr in all cases the event median values of nse for ol and dr are almost the same at both two locations tx and yt in tunxi catchment the n s e for ol and dr are also almost the same however the n s e of ol and dr differ in suide catchment mainly due to the effect of different outlier outlier 26 53 for drer and 29 53 for oler are not shown in fig 5 5 3 error parameter estimation and assimilation performance in the ensemble operation mode the ensemble size is set to 50 for the tunxi catchment and 100 for the suide catchment the sensitivity test on the ensemble size is provided in supplementary material 5 3 1 error parameter estimation the error parameters estimated using the map method are shown in table 3 since different rainfall forcing leads to changes in the uncertainty in hydrological model the four error parameters σ s σ r σ lnp α lnp associated with it were re calibrated under the era5 forcing it can be seen that σ s σ r and σ lnp under era5 forcing are larger than those under station forcing suggesting that the errors in hydrological model simulation under era5 forcing are greater and that enkfer requires a larger ensemble spread generated by those perturbations for discharge observation errors the two parameters σ y α y under the era5 forcing remain the same as those under station rainfall forcing since the errors in runoff observations are not affected by the changes of rainfall forcing both under station forcing and era5 forcing σ y 0 10 and α y 0 35 in tunxi catchment σ y 0 08 and α y 0 31 in suide catchment 5 3 2 one step prediction performance of enkf we show one step prediction performance of enkf with the aim of assessing the role of enkf in reducing the accumulation of errors in the initial conditions of the hydrological model at the beginning of flood forecasting the accuracy of simulated discharge is the focus of one step prediction performance the optimal error parameters estimated by the map method are employed to run the assimilation scheme in each of the two catchments fig 6 shows the optimal single value prediction performance the ensemble mean and compares the differences between enkf ol and persistence forecast pf as shown in fig 6a the best performance in one step prediction has been achieved with persistence forecast and n s e at tx yt and sd are 0 99 0 99 and 0 76 respectively under station forcing the performance of enkfsr e g n s e at tx is 0 99 and n s e at yt is 0 98 almost matches that of pf in tunxi catchment however a difference is found in suide catchment where enkfsr e g n s e at sd is 0 68 does not perform as well as pf under era5 forcing enkfer performs slightly poorer than pf in tunxi catchment and significantly poorer in suide catchment even though enkf does not perform better than pf both the corrected peak discharge and hydrograph shape improve compared to the ol in all cases under station forcing the n s e improve from 0 93 0 90 0 01 olsr in fig 5 to 0 99 0 98 0 68 under era5 forcing the n s e improve from 0 08 0 03 2 49 oler in fig 5 to 0 94 0 92 0 17 at tx yt and sd respectively as shown in fig 6b the π rmse of enkfsr at the three locations are 1 27 1 76 and 1 01 less than those of olsr the π rmse of enkfer are 6 57 7 21 and 1 71 less than those of oler on the other hand the event quantile of π rmse shows that enkfsr outperforms the persistence forecast in approximately half of the flood events at tx while this number is about a quarter at sd and less than a quarter at yt under era5 forcing enkfer does not perform as well as persistence forecast in almost all flood events at all three locations overall the optimal single value performance in one step prediction is ranked from highest to lowest as pf enkfsr enkfer olsr and oler for station forcing enkfsr can increase the simulation accuracy of olsr to a level close to pf and for era5 forcing enkfer can increase the simulation accuracy of oler to a level close to olsr it means that enkf can reduce the errors in the hydrological model states and can also improve the simulation performance of the distributed hydrological model driven by relatively poor forcing data e g era5 forcing however it should be noted that a fraction of the flood events is not simulated with satisfactory accuracy under era5 forcing even if they have been corrected moreover let us consider the ensemble performance fig 7 shows the ratios of overall ensemble performance π crps reliability reli and sharpness π sharp of the ensemble simulation and the climatological discharge distribution fig 7a shows that for crps enkf performs better than climatological discharge distribution in almost all cases except for one flood event in the suide catchment actually the ol also outperformed the climatological discharge distribution in the majority of flood events in the tunxi catchment both tx and yt in contrast olsr outperforms climatological discharge distribution in less than half of the flood events in suide catchment and this number drops to less than a quarter for oler in suide catchment on the other hand the overall ensemble performance of enkf is better than that of ol in all cases under station forcing the π crps decreases from 0 19 0 25 1 01 to 0 09 0 10 0 57 at tx yt and sd under era5 forcing the π crps decreases from 0 80 0 83 1 60 to 0 15 0 19 0 76 the enkfer demonstrates greater ensemble performance improvement than enkfsr in particular enkfer improves from inferior π crps is greater than 1 0 to better π crps is less than 1 0 than climatological discharge distribution at sd overall the overall ensemble performance is ranked from highest to lowest as enkfsr enkfer olsr and oler fig 7b shows the reliability through the metric reli comparing enkf and ol the reliability of enkf is better than ol in all flood events in tunxi catchment both tx and yt correspondingly it outperforms ol in more than half of flood events in suide catchment under station forcing the r e l i decreases from 0 29 0 50 0 58 to 0 21 0 32 0 57 at tx yt and sd under era5 forcing the r e l i decreases from 0 56 0 63 0 58 to 0 25 0 38 0 57 similar to overall ensemble performance the reliability ranking from highest to lowest is enkfsr enkfer olsr and oler in tunxi catchment the situation in suide catchment changes and the reliability r e l i of the four modes are pretty close fig 7c presents the sharpness of ensemble enkf and ol have smaller ensemble spread than climatological discharge distribution except for a few flood events in the suide catchment under era5 forcing the ensemble spread of enkf shows smaller differences across flood events compared to ol narrower box and whisker for enkf under station forcing the enkf in addition to the above differences also reduces the π sharp 5 3 3 discussion of specific flood events in order to analyze the effect of enkf under different rainfall forcing we chose the two flood events in tunxi catchment for discussion which have the largest differences in ensemble mean discharge between oler and olsr fig 8 illustrates the hydrographs during the two flood events tx 2010051608 and tx 2015080908 at the outlet tx and internal yt location focusing on station forcing left panel in fig 8 the olsr shows good discharge simulation performance at tx and the enkfsr reduces ensemble spread and further improves simulation accuracy the performance of the olsr at yt is not as good as that at tx due to the fact that the internal location was not used for calibration but the enkf assimilation can significantly ameliorate the degradation of the hydrological model performance on the other hand the scenario of era5 forcing is discussed right panel in fig 8 during flood event tx 2010051608 rainfall around the flood peak was underestimated while rainfall after the peak was overestimated which led to incorrect timing of peak flow during tx 2015080908 the underestimated rainfall leads to completely missing peak flows in the oler moreover oler does not produce sufficient ensemble spread around the flood peak during the two flood events those defects can be expected to be corrected by enkf assimilation to some extent in the tunxi catchment where all grid cells are saturation excess grids seg runoff generation is determined by whether the soil moisture is saturated or not and therefore it is sensitive to the correction of the soil moisture states in this way the continuous positive correction of soil moisture and reservoir storage can compensate for the underestimated rainfall input fig 9 shows the hydrographs during the two extreme flood events sd 2013072608 and sd 2017072308 at the outlet location sd of the suide catchment where sd 2017072308 is the largest observed flood since the hydrological station was established as can be expected the enkfsr also improves the simulation accuracy and reduces the ensemble spread during the extreme flood events left panel in fig 9 moreover let us consider the era5 forcing right panel in fig 9 the oler does not respond to the very low rainfall provided by era5 that is that is basically no flood peak appears in the hydrograph comparatively the flood peaks appear in the hydrographs of enkfer even though the peak flow still differs significantly from the observed peak flow on the other hand the oler does not produce sufficient ensemble spread near the timing of the observed flood peak narrower gray bands especially for sd 2017072308 comparatively enkfer increases the ensemble spread 5 4 temporal persistence of the assimilation effect this section discusses the temporal persistence of the effect of enkf on the correction of the distributed hydrological model states that is how long the gain from the update of the initial states at the start of the forecast period can persist in flood forecasting for this purpose we use gauged rainfall or era5 as a perfect weather prediction and focus on the difference in the ensemble mean discharge between enkf and ol under various lead time the calibration locations tx and sd of the two catchments are discussed and compared fig 10 a b shows how the assimilation scheme differs under incremental lead time in tunxi catchment nearly all floods benefit from enkf assimilation during the lead time of 40 h and the simulation accuracy decreases with increasing lead time until a stable level is reached fig 10 c d illustrates the results in the suide catchment the temporal persistence of the benefit is only 2 6 h in about half of flood events both under station forcing and era5 forcing fig 11 shows the event average of rmse enkf rmse ol under various lead time it can be clearly seen that the assimilation effect of both enkfsr and enkfer decrease with increasing lead time in tunxi catchment and reach stability after 15 h where the rmse enkf rmse ol is stable at 0 77 for enkfsr and 0 88 for enkfer it indicates that the temporal persistence of the assimilation effect will keep at least 40 h in suide catchment the temporal persistence of enkf under different rainfall forcing behaves similarly all of them decayed rapidly to a level similar to ol within 7 h of lead time 6 discussion this paper describes the distributed hydrological assimilation scheme based on the map method for error estimation which is tested comprehensively in different areas based on historical observations most contemporary assimilation techniques are suboptimal for complex hydrological processes but it should be acknowledged that they often provide reliable results under reasonable uncertainty characterization we follow a way of error characterization that is currently widely used in hydrology i e perturbations of model forcing observations and model states from some assumed distribution e g weerts el serafy 2006 clark et al 2008a renard et al 2010 pathiraja et al 2016 in these studies the distribution of errors and the corresponding error parameters are usually selected subjectively based on expert experience extensive research has shown that poorly estimated error parameters degrade the performance of an assimilation scheme even making it worse than that without assimilation crow van loon 2006 reichle et al 2008 pathiraja et al 2018 the estimation of the error parameters in this study using the map method provided objective and reasonable results as shown in table 3 the values of σ y are 0 10 and 0 08 in the two catchments respectively which is consistent with some previous research li et al 2014 clark et al 2008a under station rainfall forcing the σ lnp of rainfall errors in two catchments are 0 19 and 0 23 which is consistent with willems recommendations willems 2001 due to the accuracy deficiencies of the era5 rainfall dataset in the study catchments fig 4 the uncertainty of the hydrological model increases and therefore all three error parameters σ s σ r σ lnp associated with it increase compared to under station forcing the higher autocorrelation coefficient α lnp of rainfall errors in the tunxi catchment than in the suide catchment may be due to the fact that tunxi catchment has abundant long duration rainfall compared to the suide catchment which is usually erratic and short duration heavy storms it should be underlined that since only a few flood events were used for parameter calibration the error parameter optimization similar to model parameter calibration may also be uncertain and there may be many combinations of error parameters that can produce similar ensemble simulation i e also suffering from parameter equifinality in the one step prediction figs 5 7 the performance is ranked from highest to lowest as enkfsr enkfer olsr and oler it can be seen that enkf reduces the accumulation of past errors in the initial conditions of the hydrological model at the start of the flood forecasting it improves the accuracy of the ensemble mean discharge the overall ensemble performance and the ensemble reliability in most cases the enkf reduces the ensemble spread but enkf can also increase it when ol does not generate enough ensemble spread e g right panel in fig 8 and fig 9 in fig 6 the ensemble mean of enkfsr at validation location yt are close to those at the calibration location tx in tunxi catchment indicating that the assimilation system can compensate for the degradation of hydrological model performance due to uncalibrated model parameters on the other hand comparing the two types of rainfall forcing oler performs much worse than olsr in terms of ensemble mean ensemble reliability and overall ensemble performance indicating that the low quality forcing e g era5 in the study catchments greatly limits the performance of the hydrological model the state correction by enkf can alleviate this limitation and improve the performance to a level slightly better than olsr but still inferior to enkfsr in tunxi catchment the ensemble mean performance of enkfsr can largely achieve the level of persistence forecast in one step prediction fig 6 and the benefits from enkf can be maintained for 40 h fig 11 but shows different results in suide catchment where enkfsr cannot match the persistence forecast and the temporal persistence of assimilation effect may less than 7 h the suide catchment is located on china s loess plateau one of the largest and thickest in the world with the average thickness of the loess ranging from 50 to 80 m and up to several hundred meters ding et al 2001 it has been shown that many existing models perform generally poor for flood simulation in this area e g huang et al 2016 huo et al 2020 liu et al 2020 in this study the ieg grids away from the river channel are practically difficult to saturation the flood discharge depends mainly on the rainfall intensity that exceeds the infiltration so the correction of soil moisture content on ieg grids are not significant which may be one of the reasons for the degradation of performance and the shorter lead time for benefit in the suide catchment as we all know hydrological models are built based on a set of principles coupled with a number of assumptions and imperfectly defined parameters the results in suide catchment indicate that the complex runoff generation mechanisms and the influence of human activities on natural runoff may make the principles and assumptions no longer totally appropriate and this structural deficiency is fatal for the assimilated systems this study focuses on the role of map and enkf in reducing uncertainty in simulation of the distributed hydrological model in order to avoid introduce uncertainty from numerical rainfall prediction we use gauged rainfall or era5 as a perfect proxy for weather prediction since numerical weather prediction products were not used the results of this study do not give a complete picture of the prediction performance in an operational flood forecasting system but they are sufficient for analyzing the effect of enkf on the errors in the initial states of the hydrological model at the start of flood forecasting it will be very interesting to test the performance of map and enkf in operational flood forecasting systems in our future research in addition the limited test samples thirty flood events in two catchments are also one of the limitations of this study and the applicability of map method and enkf in distributed hydrological models needs to be further investigated in wider areas in our case study which did not include synthetic experiments simulated discharge was compared with observation instead of the truth value the effectiveness with synthetic data needs to be further investigated 7 conclusions this paper presents an integrated assimilation scheme with automated error estimation and ensemble kalman filtering which assimilates observed discharge into a distributed hydrological model with the aim of reducing the accumulation of errors in the initial states of the distributed hydrological model at the beginning of flood forecasting the assimilation system was tested in two small and medium sized catchments in china with different climatic and underlying surface characteristics it is also tested under two kinds of rainfall forcing station observation data and hourly era5 reanalysis data the most challenging part of applying the assimilation system to real flood events is getting appropriate estimates of the error models the choice of error parameters is crucial to obtain a better estimate of the model states we show that the maximum a posteriori estimation method map can be beneficial in specifying error models more logically and providing reliable ensemble spread the estimation errors under era5 forcing are larger than those under station forcing which is closely related to the typically lower rainfall records in the era5 dataset in the one step ahead prediction the performance is ranked from highest to lowest as enkfsr enkfer olsr and oler enkf can improve the accuracy of the ensemble mean discharge the overall ensemble performance and the ensemble reliability compared to the open loop run ol results at validation location yt show that the assimilation system effectively ameliorates the degradation of hydrological model performance due to uncalibrated model parameters the assimilation system also improves the underestimated discharge due to underestimated rainfall under era5 forcing suggesting that hydrological assimilation is also one of the potential solutions to overcome poor rainfall forcing however the assimilation performance gradually decreases as the lead time increases and the discharge under era5 forcing always gains more from the assimilation due to its lower level performance in oler in the semi arid catchment suide catchment with strong human activity impacts the performance of both the hydrological model and the assimilation system degrade compared to the humid catchment tunxi catchment with natural underlying surface this phenomenon occurs for all lead time involved in this study in the tunxi catchment temporal persistence of the benefit from the assimilation system lasts 40 h while in the suide catchment this time persistence is less than 7 h credit authorship contribution statement junfu gong conceptualization methodology software visualization writing original draft albrecht h weerts conceptualization resources writing review editing cheng yao data curation software funding acquisition writing review editing zhijia li project administration funding acquisition yingchun huang validation funding acquisition yuanfang chen supervision yifei chang investigation pengnian huang writing review editing funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by the national natural science foundation of china grant numbers 51979070 52079035 51909059 and 41901036 the natural science foundation of jiangsu province grant number bk20190492 and the china scholarship council we thank deltares for providing the office space and the hardware and software for the study the hydrometeorological data were provided by the hydrology bureau of anhui province and shaanxi province including evaporation precipitation and discharge the check dam data were provided by the yellow river conservancy commission the code of enkf used in this study was developed from the parallel data assimilation framework pdfa http pdaf awi de trac wiki and openda www openda org the sce ua algorithm implemented via uncertainty quantification python laboratory uq pyl http www uq pyl com we thank these organizations for granting permission to use their data and software appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129450 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 supplementary data 2 
2055,for flood simulation in small and medium sized catchments discharge observations may be used to update model states of a distributed hydrological model to improve performance the ensemble kalman filter enkf has been widely used for hydrological assimilation due to its relative simplicity and robustness an advantage of the enkf is that it is easy to include different sources of uncertainty therefore the choice of error model is crucial for the application of the enkf assimilation this paper describes an enkf assimilation scheme for estimating error models using the maximum a posteriori estimation method map we test this scheme in two small and medium sized catchments in china with different characteristics and in addition compared the performance differences under two kinds of rainfall forcing we show that map is beneficial in specifying error models and providing reliable ensemble spread the assimilation scheme can effectively ameliorate the degradation of distributed hydrological model performance due to uncalibrated model parameters and or poor quality of input data keywords flood hydrological assimilation ensemble kalman filtering maximum a posteriori estimation distributed hydrological model data availability data will be made available on request 1 introduction flooding imposes huge costs on society causing damage to infrastructure and crops and at worst loss of life brázdil et al 2005 yiou et al 2006 thielen et al 2009 in particular the floods occurring in small and medium sized catchments are characterized by rapidity and suddenness usually with short flood duration and rapid rise of flood peak pilon 2002 it has been reported that more than 70 of economic losses and approximately 2 3rd of deaths from flood disasters in china are related to flood in small and medium sized catchments liu et al 2015 gong et al 2021 the two factors affecting flood forecasting most are the rainfall runoff update hydrological model simulation with measured or estimated evapotranspiration and measured rainfall until start of forecast and the quantitative weather prediction weerts el serafy 2006 a large number of researches focuses on the use of quantitative weather prediction output to produce flood forecasts e g gouweleeuw et al 2005 ming et al 2020 speight et al 2021 on the other hand research in rainfall runoff updating concerns focus on the uncertainty of hydrological model simulation e g wood et al 2016 piazzi et al 2021 it is widely accepted that the uncertainty in hydrological model simulation comes from several different sources including uncertainty in model input model structure and model parameters beven binley 1992 beven 1993 vrugt et al 2003 ajami et al 2007 mcmillan et al 2011 a plausible approach to reduce uncertainties in hydrological model simulation is to correct the states or parameters of the hydrological model for operational flood forecasting it reduces the accumulation of past errors in the initial conditions at the start of the forecast which has been shown to be a dominant source of uncertainty at the start of the forecast period shukla lettenmaier 2011 yossef et al 2013 thiboult et al 2016 manual modifications of the model states by human forecasters seo et al 2003 smith et al 2003 thiboult and anctil 2015 is a popular approach alternatively automatic state correction procedures by observed data in a data assimilation framework are also widely used techniques liu gupta 2007 liu et al 2012 lee et al 2012 available observed data can come from state variable observations from satellite remote sensing usually soil moisture evapotranspiration etc crow ryu 2009 zhang et al 2009 pezij et al 2019 or discharge observations clark et al 2008a ricci et al 2011 rakovec et al 2012 2015 sun et al 2020 in operational application the use of discharge observations is often a more convenient and reliable option as it is more directly related to flood forecasting li et al 2014 one of the well known hydrological assimilation techniques is the ensemble kalman filter enkf evensen 1994 burgers et al 1998 the enkf approximates and propagates probability distribution functions by a monte carlo sampling strategy which does not need a linearized model operator hydrological model required by extended kalman filter ekf jazwinski 1970 or an adjoint model required by variational methods reichle et al 2001 seo et al 2003 in addition it has been shown that enkf requires a smaller number of ensembles and show less sensitivity to the misspecification of the model and input uncertainties than the particle filtering pf methods weerts el serafy 2006 another advantage of the enkf is that the ensemble members are generated by randomly perturbing model inputs and states so it is easy to include different sources of uncertainty in the data assimilation system clark et al 2008a due to these advantages enkf is attracting a lot of attention in the field of hydrological data assimilation for distributed hydrological models the more complex structure usually means introducing greater uncertainty than lumped hydrological models fatichi et al 2016 therefore distributed models usually do not perform better overall than lumped models in small and medium sized catchments reed et al 2004 mai et al 2022 however distributed hydrological models allow a more detailed spatial representation of processes parameters and prediction they can use spatially measured forcing and they can handle the observation and simulation of hydrological variables at internal locations within the catchment beven 1985 maidment 1993 beven 2014 fatichi et al 2016 these properties make distributed models attractive for hydrological assimilation such as the adequate use of distributed rainfall data obtained through telemetry as well as they can also easily incorporate observations from locations within the catchment into the assimilation scheme which has been proved beneficial to improve the performance rakovec et al 2012 given that distributed hydrological models have been extensively used in flood simulation forecasting and have demonstrated reliability and robustness koren et al 2004 uhlenbrook et al 2004 reed et al 2004 smith et al 2004 xie and zhang 2010 unduche et al 2018 it is interesting to test the application potential of enkf in distributed hydrological models especially for small and medium sized catchments in the loess plateau spatially inhomogeneous features are significant due to human activity impacts fatichi et al 2015 zhang et al 2019 shi et al 2019 yuan et al 2022 furthermore in a large number of previous studies e g pauwels and de lannoy 2006 weerts el serafy 2006 li et al 2014 the lumped model with a unit hydrograph of channel delay widely used in hydrological assimilation suffers from a time delay issue where the discharge at the current time step depends on the discharge at several previous time steps and therefore requires techniques like retrospective ensemble kalman filtering renkf pauwels and de lannoy 2006 or ensemble kalman smoother enks li et al 2014 to overcome the time delay in contrast a grid based hydrological model allows for a more realistic modeling of time delay and the hydrological variables can be assumed to be markovian the value at the current time step depends only on the previous time step as commented by rakovec et al 2012 the simulated discharge is represented by the spatially distributed simulated states that quantify the volumes of the channel water thus any time delay between model state and discharge during assimilation does not need to be addressed explicitly enkf modifies the model state by a weighted average of the observations and the model results as such the success of this approach is strongly dependent on the accurate characterization of the uncertainties of model and observation liu et al 2012 several studies have attempted to analyze the individual and interactive effects of various uncertainties on hydrologic data assimilation e g fan et al 2022 concluded that uncertainties in discharge observations would have a visible effect on the particle filtering algorithm and its variants wang et al 2017 found that the most significant effect on enkf performance is the pairwise interaction between uncertainties in precipitation and discharge observation thiboult et al 2016 evaluated uncertainties in quantitative precipitation forecasts hydrological model structures and initial conditions through a combination of meteorological ensemble prediction multimodel approaches and ensemble kalman filtering enkf inappropriate estimation of these uncertainties has been reported to reduce the performance of the ensemble based kalman filter crow van loon 2006 reichle et al 2008 pathiraja et al 2018 one attempt to quantify those uncertainties is an adaptive filtering algorithm which estimates error covariances during the filter analysis procedure crow reichle 2008 however such algorithm relies on a number of strict assumptions and limitations including a required assumption of the serial independence of assimilated observation which limits its widely application and testing crow van den berg 2010 an alternative and more popular way to quantify uncertainties is the bayesian error analysis algorithm it explains the difference between model results and observations as the combined effect of several different sources of uncertainty such algorithms have been widely used for hydrological model parameter estimation quantifying uncertainty in hydrological model structure estimation of model forcing errors beven and binley 1992 vrugt et al 2003 kavetski et al 2006a kavetski et al 2006b kuczera et al 2006 clark et al 2008b vrugt et al 2008 teweldebrhan et al 2018 li et al 2021 however the bayesian error analysis skill has not been widely tested in applications that quantify the error parameters required by data assimilation techniques such as enkf an ensemble based maximum a posteriori map method is detailed by li et al 2014 which is a bayesian inference procedure adapted to ensemble based kalman filter it does not require the independence of the observation series and allows simultaneous estimation of errors from different sources also it is relatively simple to implement and easy to couple with the enkf method compared to other bayesian error analysis algorithm however a limitation of the map method is that it does not offer an objective selection of the error distribution and requires a priori assumptions about the error structure e g gaussian or log normal distribution which may not be entirely correct and may introduce unintended biases ryu et al 2009 liu et al 2012 several recent studies have attempted to fill this gap slater and clark 2006 introduced a cross validation method to estimate the uncertainty of forcing data without a presupposition of the forcing error distribution pathiraja et al 2018 proposed a data driven approach for estimating the model state error using kernel conditional density estimation to avoid predefining the state error distribution the approach assumes that the observation error is much smaller than the model state error and requires lengthy period of data to capture the full range of errors over the possible states such extensive data are often not available in flood event simulation in addition these studies focus on only a fraction of the total error sources model state error or forcing error and ignore or simplify other uncertainty these assumptions and conditions limit their application to the hydrological assimilation in comparison the map method has been applied in assimilation of remotely sensed soil moisture data sm da to correct soil water stores of lumped and semi distributed hydrological model alvarez garreton et al 2015 similarly the use of the map method to quantify model and observation errors in the correction of model states by observed discharge in lumped hydrological models demonstrates the potential li et al 2014 however the ability of the map method to quantify errors of distributed models has not been tested in previous research the objective of this study is to construct an enkf assimilation scheme for estimating errors of distributed hydrological model and observations using the bayesian based map method subsequently these error parameters are applied to correct hydrological model states by assimilating observed discharge in a distributed hydrological model with the aim of reducing the accumulation of errors in the initial conditions of the hydrological model at the start of the forecast period we tested the potential of this assimilation scheme for application in two catchments with different climatic conditions and different human activity impact in addition two different sources of rainfall forcing were tested to examine the potential of the assimilation scheme with different input data quality in this paper we use historical rainfall data as a perfect proxy for weather prediction with the aim of assessing temporal persistence of the assimilation effect without introducing uncertainty from numerical rainfall prediction 2 methodology 2 1 ensemble kalman filter the central idea of data assimilation is to incorporate new observed information during the dynamic operation of the numerical model to produce a posterior probability density function pdf of model state the enkf samples and predicts the pdf with a monte carlo method which provides the great benefit of being free from linearity and gaussian constraints on the model in this study the dimensionality of the state space observation space ensemble space and time space are denoted as n x n y n e n t respectively hereafter the subscript t t 1 n t is time index and the subscript n n 1 n e is ensemble index the enkf is formalized by the following equation the model states to be assimilated is denoted as vectors x 1 x t x 1 t x n x t r n x let x be an ensemble matrix of model states 2 x t x 1 t t x n e t t r n x n e the initial x t 0 r n x n e is obtained by the monte carlo method at the forecast step the state transfer equation is given as 3 x n t 1 f m x n t a u t v t where m r n x r n x is the dynamical model nonlinear hydrological model u is the model forcing v t r n x is the system or process gaussian noise with a covariance matrix q t the superscript f denotes the model forecast and superscript a denotes the analysis value of enkf the ensemble mean of model prediction vector in state space is given by 4 x t f 1 n e n 1 n e x n t f r n x and the ensemble mean of model prediction vector in the observation space e g discharge in this study is calculated with 5 h x t f 1 n e n 1 n e h x n t f r n y where h r n x r n y is the measurement operator also nonlinear hydrological model in this study that maps the state space to observation space at the analysis step the observation vector y t y 1 t y n y t r n y is distributed by a gaussian noise η t r n y with a covariance matrix r t 6 y n t y t η t where y t r n y n e is the perturbed observation vector in this study we assumed that the observation errors are independent in space so that r t is a diagonal matrix then the update equation is given as 7 x n t a x n t f k t y n t h x n t f where k is the kalman gain matrix calculated by the following 8 k t p t h t h p t h t r t 1 9 p t 1 n e 1 n 1 n e x n t f x t f x n t f x t f t r n x n x 10 p t h t 1 n e 1 n 1 n e x n t f x t f h x n t f h x t f t r n x n y 11 h p t h t 1 n e 1 n 1 n e h x n t f h x t f h x n t f h x t f t r n y n y when the dimensionality of the state space n x is large it is a better solution to calculate p t h t and h p t h t directly from the ensemble members instead of calculating p t houtekamer mitchell 2001 nerger hiller 2013 in this study the scheme proposed by clark et al 2008a was used in which the simulated discharge at gauging locations were included in the state vector but they were treated as diagnostic variables rather than state variables and were therefore not updated in addition the one step prediction in this study is described as follows the corrected model states x n t a at time step t is obtained by enkf which is used as the initial states of the hydrological model at time step t 1 and the simulated states x n t 1 f and simulated discharge h x n t 1 f at time step t 1 is obtained by the forward hydrological model 2 2 error parameter estimation from eq 8 it can be shown that the enkf corrects the model state by a weighted average of the observations and the model predictions therefore appropriate specification of model and observation errors is a necessary requirement for employing the enkf 2 2 1 uncertainty in discharge measurements uncertainty in discharge measurements can be obtained by comparing the velocity meter measurements with the values obtained from the water level discharge rating curve mcmillan et al 2013 sorooshian dracup 1980 pointed out that the uncertainty in discharge measurements at high water levels is larger than at low water levels due to the increased uncertainty in the rating curve at high water levels to represent the uncertainty in discharge measurement following the scheme used in clark et al 2008a and weerts el serafy 2006 we parameterized observation error as a function of discharge observation the measured discharge was imposed with the following perturbation 12 y n t y t i δ t y where i r n y n y is identity matrix δ t y is gaussian perturbation matrix assuming that the observation errors are independent at each flow gauging station δ t y r n y n y is a diagonal matrix 13 δ t y δ 1 t y 0 0 0 0 0 0 δ n y t y where δ i t y i 1 n y is the perturbation at flow gauging station i and δ y n 0 σ y in addition the temporal correlation of streamflow error is relatively high so we included a first order autoregressive model the perturbation δ i t y at time step t is modified as 14 δ i t y μ y α y δ i t 1 y μ y φ σ y 1 α y 2 0 5 where μ y 0 φ is a standard gaussian noise α y is autocorrelation coefficient for streamflow error the standard deviation σ y and coefficient α y are the error parameters that need to be estimated 2 2 2 uncertainty in hydrological model the uncertainty in hydrological model can usually be divided into several different sources including forcing errors structure errors and parameter errors to represent the uncertainty in model forcing we adopt the widely used lognormal multiplicative error function mcmillan et al 2011 dechant moradkhani 2012 15 p n t δ t p p t where p t p 1 t p n p t r n p is the rainfall observation vector n p is the dimensionality of the forcing space δ t p is lognormal perturbation matrix for station data we assume that the errors in the precipitation measurement are spatially independent thus δ t p is represented as a diagonal matrix 16 δ t p δ 1 t p 0 0 0 0 0 0 δ n p t p where δ i t p i 1 n p is the perturbation at rainfall gauging station i and δ p follows a lognormal distribution with the mean of 1 0 and standard deviation of σ p it means ln δ p n μ lnp σ lnp where μ lnp 0 5 σ lnp 2 and the standard deviation σ p e x p σ lnp 2 1 for era5 data the same lognormal perturbation is implemented but we assume fully correlated errors in space so that the same perturbation is applied to the whole precipitation field we included a first order autoregressive model based on lognormal perturbations to characterize the temporal correlation of rainfall errors li et al 2014 the perturbation δ i t p at time step t is modified as 17 ln δ i t p μ lnp α lnp ln δ i t 1 p μ lnp φ σ lnp 1 α lnp 2 0 5 where φ is a standard gaussian noise α lnp is autocorrelation coefficient the hyper parameter σ lnp and coefficient α lnp are the error parameters that need to be estimated the perturbations to the model state reflect the accumulation of uncertainties in the model structure and parameters the model state variables selected for assimilation in this study were soil moisture content and reservoir storage rs soil moisture was represented through the variable s named free water storage in grid xaj flex as the model states in the diffident spatial cell may not be the identical the gaussian multiplicative error function was used to perturb both the soil moisture and reservoir storage 18 x n t δ t x x n t where x n t s n t 1 s n t n s rs n t 1 rs n t n r r n x is model state vector mentioned in section 2 1 n s and n r are the dimensions of the two kind of model states respectively and n x n s n r δ t x is diagonal gaussian perturbation matrix the elements on the diagonal are δ 1 t s δ n s t s δ 1 t r δ n r t r δ s n 1 σ s and δ r n 1 σ r are the perturbations of soil moisture and reservoir storage respectively the standard deviation σ s and σ r are the error parameters it is important to note that σ s needs to be kept quite small to avoid rapid changes of soil moisture between continuous time steps liu et al 2017 deterministic run of the hydrological model is hereafter noted as dr ensemble prediction of hydrological model obtained by adding the above unbiased perturbations eq 15 and eq 18 to the model forcing and states are hereafter called open loop ol besides adding these perturbations to model the enkf is then applied to correct the model states and the consequent ensemble prediction are hereafter called enkf assimilation mode enkf the subscripts sr and er were used to denote station forcing and era5 forcing respectively for example the enkf assimilation mode under station rainfall forcing is noted as enkfsr 2 2 3 map method the maximum a posteriori estimation method map is used to estimate the global optimum of the error parameters that need to be specified in the assimilation system the goal of map is to maximize the probability density of the error parameters with given the observing historical flood events this set of error parameters ψ σ y σ s σ r σ lnp α y α lnp is the global optimal estimate according to bayesian theory this posterior probability density can be expressed as 19 p ψ y χ ψ p ψ p y ψ where ψ is error parameters ψ σ y σ s σ r σ lnp α y α lnp p ψ is a posteriori probability density of ψ p y ψ is the conditional probability density of the observing historical discharge y given ψ p ψ is calculated by the following 20 p ψ p σ y p σ s p σ r p σ lnp p α y p α lnp where p σ y p σ s p σ r p σ lnp p α y p α lnp respectively represent a prior probability density of the corresponding error parameter following li et al 2014 σ y is assumed to follow a gaussian prior distribution σ y n 9 25 0 925 the prior for standard deviation σ s and σ r of gaussian perturbation follows the reference prior 1 σ s and 1 σ r berger et al 2009 the prior for hyper parameter σ lnp of lognormal perturbation follows the reference prior 1 σ lnp 1 2 σ lnp 2 harvey van der merwe 2012 the autocorrelation coefficient α y and α lnp are assumed to follow a uniform prior distribution the conditional probability density p y ψ is calculated by the following 21 p y ψ i 1 n y t 1 n t p y i t ψ where p y i t ψ is the conditional probability density of the observed discharge of i th flow gauging station at time t with given ψ the sce ua duan et al 1992 is used to operate the optimization process the objective function is defined as 22 f obj 1 n f m 1 n f l n χ ψ where n f is number of historical flood events and then the optimal error parameters ψ is obtained by minimizing f obj 23 m i n f obj ψ in one evaluation of sce ua f obj can be calculated as follows before running hydrological model a set of specific error parameters ψ is sampled from predefined error parameter space a prior probability density p ψ of sampled ψ is computed by eq 20 then the hydrological model runs temporally forward in an ensemble mode and at time step t the ensemble prediction of model states and discharges were given as 24 m x t 1 p t 1 x t q t i where m is hydrological model with ensemble mode q t i i 1 n y is ensemble prediction of discharges the model states at the previous time step x t 1 can be obtained from open loop or assimilation prediction the perturbation as shown in eq 12 is further added to q t i to get the perturbed ensemble prediction of discharges q t i we calculate the mean and standard deviation of q t i for each flow gauging station denoted as μ t i and σ t i and fit q t i to a gaussian distribution n μ t i σ t i the p y i t ψ is then obtained by calculating the probability density of y i t from n μ t i σ t i finally χ ψ can be obtained from eq 19 repeating the above process in all flood events the objective function f obj and the corresponding error parameters can be obtained by eq 22 it should be noted that p ψ y in eq 19 do not need to be computed χ ψ suffices to compute the objective function indeed if p ψ y was substituted for χ ψ in eq 22 the objective function would simply be shifted by a constant 2 3 evaluation metrics we use five different metrics to evaluate the performance of hydrological assimilation scheme including both optimal single value i e the ensemble mean and ensemble simulation performance all metrics used in this study are for a single flood event and the flood event indicator is omitted below 2 3 1 ensemble mean the ensemble mean of discharge for a flood event is evaluated through root mean squared error rmse and nash sutcliffe efficiency coefficient nse which are described as follows 25 rmse 1 n t t 1 n t y t sim y t 2 26 nse 1 t y t sim y t 2 t y t y ave 2 where y t is the observed discharge at time step t y ave is the temporal mean of the observed discharge in the flood event y t sim is the simulated discharge here ensemble mean discharge for the ensemble run or the simulated discharge of the hydrological model for the deterministic run the ratio of rmse of the simulated discharge and the persistence forecasting pf defined as the most recent observations as prediction discharge denoted as π rmse 27 π rmse rmse sim rmse pf the event average of nse and π rmse are respectively denoted as n s e and π rmse 2 3 2 ensemble performance following mcinerney et al 2020 we consider a climatological discharge distribution for each hour of year as a reference for the ensemble evaluation it is constructed using a sliding window approach and the window half width n clim 12 h on dates when hourly observations are not available we interpolate the daily observations to obtain hourly data given the importance of both the reliability and sharpness of forecasts gneiting et al 2007 gneiting and katzfuss 2014 evin et al 2014 three metrics are used to evaluate ensemble performance overall performance about ensemble simulation is assessed using the continuous ranked probability score crps hersbach 2000 mcinerney et al 2020 the crps is regarded as the integral of the brier score brier 1950 over all possible threshold values for the variable the crps provides information about both the ensemble reliability and ensemble uncertainty as the crps quantified the simulation for a single time step the crps ave is defined as the temporal average crps over the entire period in a flood event for detailed about crps ave please refer to hersbach 2000 the ratio of crps ave of the simulated discharge distribution here the ensemble discharge from enkf or ol and the climatological discharge distribution denoted as π crps 28 π crps crps ave s i m crps ave c l i m r e f where subscript sim indicates the simulated discharge distribution being evaluated and subscript climref indicates the climatological discharge distribution the event average of π crps is denoted as π crps sharpness about ensemble simulation is quantified by the metric π s h a r p it quantifies ratio of interquartile ranges iqrs of the simulated discharge distribution and the climatological discharge distribution 29 π sharp s h a r p n e s s φ sim φ climref 1 n t t 1 n t φ sim t 1 1 p φ sim t 1 p 1 n t t 1 n t φ climref t 1 1 p φ climref t 1 p where p is the distribution quantile p 0 05 in this study φ t 1 p is the inverse cumulative distribution function of a predictive distribution at time step t for detailed about the sharpness metric please refer to mcinerney et al 2020 the event average of π sharp is denoted as π sharp the predictive quantile quantile pqq plot displays the empirical frequency of discharge observations within the simulated discharge distribution evin et al 2014 following mcinerney et al 2017 the reliability about ensemble simulation is quantified by the metric reli which represents the discrepancy between the pqq plot and the 1 1 line 30 reli 2 n t t 1 n t f u fy t sim y t f ω fy t sim y t where f u is the cumulative distribution function cdf of the uniform distribution u 0 1 f ω is the empirical cdf of the set ω and the set ω fy t sim y t t 1 n t fy t sim is the cdf of the simulated discharge distribution at time step t and y t is the observed discharge at time step t the event average of reli is denoted as r e l i 3 distributed hydrological model in this study a flexible distributed hydrological model grid xaj flex flexible grid xinanjiang model is used to perform flood simulation experiments in the study catchments the structure of the model is shown in fig 1 the grid xaj flex model is a modified variant of the grid xinanjiang model grid xaj yao et al 2009 yao et al 2012 yao et al 2019 which is developed from the well known xinanjiang model xaj zhao et al 1980 zhao 1992 the primary computational elements of grid xaj flex are identical square grids based on the dem the fundamental assumption is that model forcing parameters and topography and soil and vegetation types are spatially uniform inside each grid however they may differ between each grid which depends on the thematic maps the major hydrological processes involved in the model include canopy interception direct channel precipitation evapotranspiration runoff generation overland flow routing and channel routing all of which are calculated within each grid the potential evaporation estimated from pan evaporation soil evaporation is calculated from potential evaporation by the three layer soil moisture module zhao and liu 1995 the runoff generation module is designed based on the saturation excess mechanism in the overland and channel routing module grid xaj flex routes water over a d8 network the 8 direction steepest descent algorithm by kinematic wave model which is solved with a nonlinear scheme using newton s method chow et al 1988 van verseveld et al 2022 it has been shown that most of the grid xaj flex parameters are spatially heterogeneous and a priori parameter estimates can be obtained from digital elevation map soil type map and vegetation map yao et al 2012 the time step of the hydrological model in this study is 1 h 3 1 improved method of calculating runoff generation the method of calculating the runoff generation in grid xaj is derived from saturation excess mechanism which is the major feature of the xaj model the runoff in each grid is not produced until the soil moisture of the unsaturated zone reaches field capacity after which the excess rainfall generates runoff the method has demonstrated superior simulation skills in humid and semi humid areas in china and has been widely used in streamflow simulation and operational flood forecasting in those areas zhao liu 1995 jayawardena zhou 2000 chen et al 2007 li zhang 2008 therefore the runoff generation calculation module of grid xaj is used directly in tunxi catchment in this study however in semi arid and arid catchments the dominant hydrological process will no longer be saturation excess runoff generation but infiltration excess runoff generation or the combination of the two as such the original method of grid xaj may not be applicable to those catchments the flexible modeling framework clark et al 2011 has provided new ideas for flood simulation in semi arid and arid areas in the latest work huang et al 2016 and liu et al 2020 proposed the spatial combination modeling framework based on the concept of dominant runoff processes which means that different runoff generation mechanisms are adopted in different regions within a catchment in grid xaj flex model the grids within a semi arid or arid catchment are divided into saturation excess grids seg and infiltration excess grids ieg based on topographic index using the skill detailed by huang et al 2016 on the seg the original runoff generation module of grid xaj is still used but we replace it in the ieg with the green ampt model green ampt 1911 huo et al 2020 liu et al 2020 to calculate infiltration excess surface runoff where the infiltrated water refills the soil moisture and generates subsurface runoff only when the soil moisture is saturated fig 1 b the a priori parameters of the green ampt model can also be obtained from soil type map rawls et al 1983 3 2 reservoirs the original grid xaj yao et al 2012 does not have a calculation module for reservoirs therefore its application is limited in areas with large number of reservoirs in this study a point reservoir module zhao et al 2016 is integrated into channel routing in the grid xaj flex to reduce this limitation first we divide reservoirs into several pools with different functions see fig 1 c in the study regions most reservoirs are check dams or small reservoirs without gates which are referred to as uncontrolled reservoirs the release of such reservoirs is simplified by passing through two spillways the principal spillway and the emergency spillway shi et al 2019 the emergency flood control pool is the part of the reservoir that is above the emergency spillway the part between the two spillways is called the flood control pool and these two pools are used for flood control tasks the part below the primary spillway is referred to as the conservation pool and the inactive pool the conservation pool is used for regular water supply such as urban water supply agricultural irrigation and hydropower it should be noted that the all reservoirs in two study catchments are used only for flood control i e the water stored in the conservation pool will not be utilized after defining the reservoir structure the grids where the reservoir is located are recorded as the reservoir grids the reservoir grid received inflow q in from the outflow of adjacent upstream grids and the outflow q out of the reservoir grid means the calculated reservoir release the reservoir storage and release are calculated depending on the operation rules previous storage values evaporation and release amounts the reservoir evaporation e r is obtained from the potential evaporation calculated in the grid xaj flex the operating scheme of the reservoir is as follows 31 q t out 0 rs t rs c α γ rs t rs c δ t rs c rs t rs f a n d q t 1 outlet q max outlet 0 rs c rs t rs f a n d q t 1 outlet q max outlet rs t rs f δ t rs t rs f and based on the mass balance the reservoir storage is calculated as follows 32 rs t rs t 1 δ t q t in e t r a q t out where r s c and r s f are the storage values when the water level reaches the top of the conservation and flood control pool respectively m3 rs t is the reservoir storage value at time step t m3 α is the flooding condition multiplier which is equal to 1 during the non flood period and is greater than 1 during the flood period γ is the discharge coefficient depending on the dam structure q max outlet is the alarm flow at the basin outlet m3 s q t 1 outlet is the flow at the basin outlet at previous time step t 1 m3 s a is the water area m2 3 3 model calibration table 1 summarizes the parameters of the distributed hydrological model used in this study a priori estimates of most model parameters were obtained from the underlying surface data as explained above the sensitive parameters are optimized by the sce ua method duan et al 1992 to update the a priori estimates with the aim of obtaining their global optimal values for tunxi catchment the internal station yt that was treated as ungauged but where measured discharge is available was not used for parameter calibration to evaluate model performance in uncalibrated areas 4 study areas and data 4 1 study areas in this study two small and medium sized catchments in china with significantly different climatic and underlying surface are selected to test the performance of the assimilation scheme as shown in fig 2 the tunxi catchment 117 38 118 29 e 29 27 30 5 n is located in the south of anhui province china the drainage area is 2 693 km2 with the elevation ranging from 96 to 1 622 m fig 2a the average annual temperature is about 17 0 c the average annual precipitation is about 1 800 mm more than 60 of precipitation occurs during may to august this region is well vegetated over 70 vegetation cover including evergreen coniferous forest deciduous broadleaf forest mixed forest forest land woodland grassland pasture and crop land fig 2b the dominant soil is clay loam fig 2c there are a lot of small reservoirs in the catchment fig 2a but compared to the abundant amount of runoff the role of reservoirs in adjusting runoff is not strong as such the tunxi catchment has a typical humid climate without strong human activity impacts the suide catchment 109 14 110 13 e 37 30 37 56 n is located in the loess plateau china the drainage area is 3906 km2 with the elevation ranging from 796 to 1744 m fig 2d the average annual temperature varies from 7 8 to 9 6 c the average annual precipitation is about 450 mm of which 80 falls in the summer months from june to september mainly as intense rainstorms the vegetation cover in the catchment is less than 30 and the dominant vegetation are herbs and shrubs fig 2e the dominant soil is loam and clay loam fig 2f the large area of bare loess and the intense rainstorms have caused severe soil erosion in order to intercept sediment and reduce flood peaks a large number of check dams have been built in channel fig 2d a check dam usually has no gates and is composed of a dam body and a spillway or a drainage canal a large number of these hydrological engineering structures strongly change the natural runoff process xu et al 2013 polyakov et al 2014 li et al 2017 shi et al 2019 thus in contrast to the tunxi catchment the suide catchment has a typical semiarid continental climate with strong human activity impacts 4 2 data basis the 1 km 1 km digital elevation model dem of the study areas fig 2a d were obtained from the united states geological survey usgs http edc usgs gov products elevation gtopo30 gtopo30 html the 1 km 1 km land use map fig 2b e was derived from global land cover facility glcf https geog umd edu feature global land cover facility glcf the soil maps at the 10 km grid cell resolution were from the food and agriculture organization of the united nations fao https www fao org soils portal data hub soil maps and databases harmonized world soil database v12 en the soil maps were resampled to the 1 km 1 km grids by the nearest neighbor method to match other underlying surface data fig 2c f reservoir data for the tunxi catchment were from hydrology bureau of anhui province check dam data for the suide catchment were from the yellow river conservancy commission the hydrometeorological data for the two catchments were provided by the hydrology bureau of anhui province and shaanxi province including evaporation precipitation and discharge there are 9 rainfall gauging stations within the tunxi catchment and 14 in the suide catchment fig 2a and fig 2d based on these rainfall gauging stations in a catchment hourly gauge precipitation data were interpolated using inverse distance squared weighting method in each grid to produce spatial rainfall distribution pattern in order to evaluate the performance of the assimilation scheme under different model forcing era5 https cds climate copernicus eu the hourly rainfall reanalysis data with a resolution of 0 25 were also used and resampled to 1 km 1 km grids to match the model spatial computational cells evaporation data obtained from the daily pan evaporation with the e 601 pan hourly pan evaporation is calculated as 1 24 of the daily pan evaporation since there is one evaporation observation station in each of the two study catchments the pan evaporation is considered to be spatially homogeneous within each catchment daily discharge data are available from 2008 to 2016 for tunxi catchment and 2010 to 2017 for suide catchment hourly observations are discontinuous and only available during flood events in these years flood events were selected using the method of peaks over threshold huang et al 2016 for the tunxi catchment there are two discharge gauging stations tunxi station tx at the catchment outlet and the nested yuetan station yt fig 2a seventeen flood events between 2008 and 2016 were selected of which eight flood events from 2010 to 2013 were used for model calibration and the remaining nine were used for validation for the suide catchment 13 flood events recorded from 2010 to 2017 at the discharge gauging station named suide hereinafter referred to as sd fig 2d located at the catchment outlet were selected including the extreme flood peak flow of 3 280 m3 s that occurred on july 26 2017 which is the largest observed flood since the station was established eight of the flood events from 2010 to 2013 were used for model calibration and five flood events from 2013 to 2017 were used for model validation the flood events used in this study are listed in table s1 5 results 5 1 rainfall forcing two different rainfall datasets are used in this study with the aim of assessing the potential of the assimilation scheme with different input data quality station rainfall forcing is from gauging stations within the catchment era5 is the fifth generation ecmwf reanalysis data set which has been applied in china e g jiang et al 2021 fig 3 shows the differences between the two rainfall datasets as shown in fig 3 a era5 usually underestimates or misses the extreme rainfall more points lie below the 1 1 line implying that most of the time era5 records less hourly rainfall than site observations as examples the rainfall during two flood events are shown in fig 3b c era5 data show lower rainfall peaks and temporally more uniform rainfall distributions in the study basins and total rainfall is generally underestimated during a flood event 5 2 hydrological model performance the hydrological model performance of the two study catchments is shown in table 2 and fig 4 first we focus on the two observation locations within the tunxi catchment overall the grid xaj flex model shows high discharge simulation performance in the tunxi catchment it can be seen that the model performance of the validation location yt is just slightly degraded compared to the calibration location tx under both kinds of rainfall forcing however the model performance i e nse of the suide catchment is significantly poorer to that in the tunxi catchment this is because the tunxi catchment is a humid catchment and less influenced by human activities showing natural streamflow and the dominance of saturation excess mechanism that make it easy to simulate discharge in contrast suide catchment is located in the semi arid area and runoff in these areas is usually dominated by the complex coexistence and spatial combination of saturation excess and infiltration excess mechanism rather than by a single mechanism liu et al 2020 also human activities have greatly changed the streamflow these properties may limit the accuracy of discharge simulation by the hydrological model in suide catchment therefore these two catchments are selected to compare the correction effect of the assimilation scheme under different hydrological model performance in addition model performance under station rainfall forcing is significantly better than that under era5 rainfall forcing in both catchments underestimation of rainfall by era5 has led to generally low simulated discharges under era5 forcing and a significant underestimation of peak discharge fig 5 compares the simulated discharge for the ol and the deterministic run dr for all flood events in two study catchments we find that the ensemble mean of the discharge produced by the ol will be similar to the simulated discharge from the dr in all cases the event median values of nse for ol and dr are almost the same at both two locations tx and yt in tunxi catchment the n s e for ol and dr are also almost the same however the n s e of ol and dr differ in suide catchment mainly due to the effect of different outlier outlier 26 53 for drer and 29 53 for oler are not shown in fig 5 5 3 error parameter estimation and assimilation performance in the ensemble operation mode the ensemble size is set to 50 for the tunxi catchment and 100 for the suide catchment the sensitivity test on the ensemble size is provided in supplementary material 5 3 1 error parameter estimation the error parameters estimated using the map method are shown in table 3 since different rainfall forcing leads to changes in the uncertainty in hydrological model the four error parameters σ s σ r σ lnp α lnp associated with it were re calibrated under the era5 forcing it can be seen that σ s σ r and σ lnp under era5 forcing are larger than those under station forcing suggesting that the errors in hydrological model simulation under era5 forcing are greater and that enkfer requires a larger ensemble spread generated by those perturbations for discharge observation errors the two parameters σ y α y under the era5 forcing remain the same as those under station rainfall forcing since the errors in runoff observations are not affected by the changes of rainfall forcing both under station forcing and era5 forcing σ y 0 10 and α y 0 35 in tunxi catchment σ y 0 08 and α y 0 31 in suide catchment 5 3 2 one step prediction performance of enkf we show one step prediction performance of enkf with the aim of assessing the role of enkf in reducing the accumulation of errors in the initial conditions of the hydrological model at the beginning of flood forecasting the accuracy of simulated discharge is the focus of one step prediction performance the optimal error parameters estimated by the map method are employed to run the assimilation scheme in each of the two catchments fig 6 shows the optimal single value prediction performance the ensemble mean and compares the differences between enkf ol and persistence forecast pf as shown in fig 6a the best performance in one step prediction has been achieved with persistence forecast and n s e at tx yt and sd are 0 99 0 99 and 0 76 respectively under station forcing the performance of enkfsr e g n s e at tx is 0 99 and n s e at yt is 0 98 almost matches that of pf in tunxi catchment however a difference is found in suide catchment where enkfsr e g n s e at sd is 0 68 does not perform as well as pf under era5 forcing enkfer performs slightly poorer than pf in tunxi catchment and significantly poorer in suide catchment even though enkf does not perform better than pf both the corrected peak discharge and hydrograph shape improve compared to the ol in all cases under station forcing the n s e improve from 0 93 0 90 0 01 olsr in fig 5 to 0 99 0 98 0 68 under era5 forcing the n s e improve from 0 08 0 03 2 49 oler in fig 5 to 0 94 0 92 0 17 at tx yt and sd respectively as shown in fig 6b the π rmse of enkfsr at the three locations are 1 27 1 76 and 1 01 less than those of olsr the π rmse of enkfer are 6 57 7 21 and 1 71 less than those of oler on the other hand the event quantile of π rmse shows that enkfsr outperforms the persistence forecast in approximately half of the flood events at tx while this number is about a quarter at sd and less than a quarter at yt under era5 forcing enkfer does not perform as well as persistence forecast in almost all flood events at all three locations overall the optimal single value performance in one step prediction is ranked from highest to lowest as pf enkfsr enkfer olsr and oler for station forcing enkfsr can increase the simulation accuracy of olsr to a level close to pf and for era5 forcing enkfer can increase the simulation accuracy of oler to a level close to olsr it means that enkf can reduce the errors in the hydrological model states and can also improve the simulation performance of the distributed hydrological model driven by relatively poor forcing data e g era5 forcing however it should be noted that a fraction of the flood events is not simulated with satisfactory accuracy under era5 forcing even if they have been corrected moreover let us consider the ensemble performance fig 7 shows the ratios of overall ensemble performance π crps reliability reli and sharpness π sharp of the ensemble simulation and the climatological discharge distribution fig 7a shows that for crps enkf performs better than climatological discharge distribution in almost all cases except for one flood event in the suide catchment actually the ol also outperformed the climatological discharge distribution in the majority of flood events in the tunxi catchment both tx and yt in contrast olsr outperforms climatological discharge distribution in less than half of the flood events in suide catchment and this number drops to less than a quarter for oler in suide catchment on the other hand the overall ensemble performance of enkf is better than that of ol in all cases under station forcing the π crps decreases from 0 19 0 25 1 01 to 0 09 0 10 0 57 at tx yt and sd under era5 forcing the π crps decreases from 0 80 0 83 1 60 to 0 15 0 19 0 76 the enkfer demonstrates greater ensemble performance improvement than enkfsr in particular enkfer improves from inferior π crps is greater than 1 0 to better π crps is less than 1 0 than climatological discharge distribution at sd overall the overall ensemble performance is ranked from highest to lowest as enkfsr enkfer olsr and oler fig 7b shows the reliability through the metric reli comparing enkf and ol the reliability of enkf is better than ol in all flood events in tunxi catchment both tx and yt correspondingly it outperforms ol in more than half of flood events in suide catchment under station forcing the r e l i decreases from 0 29 0 50 0 58 to 0 21 0 32 0 57 at tx yt and sd under era5 forcing the r e l i decreases from 0 56 0 63 0 58 to 0 25 0 38 0 57 similar to overall ensemble performance the reliability ranking from highest to lowest is enkfsr enkfer olsr and oler in tunxi catchment the situation in suide catchment changes and the reliability r e l i of the four modes are pretty close fig 7c presents the sharpness of ensemble enkf and ol have smaller ensemble spread than climatological discharge distribution except for a few flood events in the suide catchment under era5 forcing the ensemble spread of enkf shows smaller differences across flood events compared to ol narrower box and whisker for enkf under station forcing the enkf in addition to the above differences also reduces the π sharp 5 3 3 discussion of specific flood events in order to analyze the effect of enkf under different rainfall forcing we chose the two flood events in tunxi catchment for discussion which have the largest differences in ensemble mean discharge between oler and olsr fig 8 illustrates the hydrographs during the two flood events tx 2010051608 and tx 2015080908 at the outlet tx and internal yt location focusing on station forcing left panel in fig 8 the olsr shows good discharge simulation performance at tx and the enkfsr reduces ensemble spread and further improves simulation accuracy the performance of the olsr at yt is not as good as that at tx due to the fact that the internal location was not used for calibration but the enkf assimilation can significantly ameliorate the degradation of the hydrological model performance on the other hand the scenario of era5 forcing is discussed right panel in fig 8 during flood event tx 2010051608 rainfall around the flood peak was underestimated while rainfall after the peak was overestimated which led to incorrect timing of peak flow during tx 2015080908 the underestimated rainfall leads to completely missing peak flows in the oler moreover oler does not produce sufficient ensemble spread around the flood peak during the two flood events those defects can be expected to be corrected by enkf assimilation to some extent in the tunxi catchment where all grid cells are saturation excess grids seg runoff generation is determined by whether the soil moisture is saturated or not and therefore it is sensitive to the correction of the soil moisture states in this way the continuous positive correction of soil moisture and reservoir storage can compensate for the underestimated rainfall input fig 9 shows the hydrographs during the two extreme flood events sd 2013072608 and sd 2017072308 at the outlet location sd of the suide catchment where sd 2017072308 is the largest observed flood since the hydrological station was established as can be expected the enkfsr also improves the simulation accuracy and reduces the ensemble spread during the extreme flood events left panel in fig 9 moreover let us consider the era5 forcing right panel in fig 9 the oler does not respond to the very low rainfall provided by era5 that is that is basically no flood peak appears in the hydrograph comparatively the flood peaks appear in the hydrographs of enkfer even though the peak flow still differs significantly from the observed peak flow on the other hand the oler does not produce sufficient ensemble spread near the timing of the observed flood peak narrower gray bands especially for sd 2017072308 comparatively enkfer increases the ensemble spread 5 4 temporal persistence of the assimilation effect this section discusses the temporal persistence of the effect of enkf on the correction of the distributed hydrological model states that is how long the gain from the update of the initial states at the start of the forecast period can persist in flood forecasting for this purpose we use gauged rainfall or era5 as a perfect weather prediction and focus on the difference in the ensemble mean discharge between enkf and ol under various lead time the calibration locations tx and sd of the two catchments are discussed and compared fig 10 a b shows how the assimilation scheme differs under incremental lead time in tunxi catchment nearly all floods benefit from enkf assimilation during the lead time of 40 h and the simulation accuracy decreases with increasing lead time until a stable level is reached fig 10 c d illustrates the results in the suide catchment the temporal persistence of the benefit is only 2 6 h in about half of flood events both under station forcing and era5 forcing fig 11 shows the event average of rmse enkf rmse ol under various lead time it can be clearly seen that the assimilation effect of both enkfsr and enkfer decrease with increasing lead time in tunxi catchment and reach stability after 15 h where the rmse enkf rmse ol is stable at 0 77 for enkfsr and 0 88 for enkfer it indicates that the temporal persistence of the assimilation effect will keep at least 40 h in suide catchment the temporal persistence of enkf under different rainfall forcing behaves similarly all of them decayed rapidly to a level similar to ol within 7 h of lead time 6 discussion this paper describes the distributed hydrological assimilation scheme based on the map method for error estimation which is tested comprehensively in different areas based on historical observations most contemporary assimilation techniques are suboptimal for complex hydrological processes but it should be acknowledged that they often provide reliable results under reasonable uncertainty characterization we follow a way of error characterization that is currently widely used in hydrology i e perturbations of model forcing observations and model states from some assumed distribution e g weerts el serafy 2006 clark et al 2008a renard et al 2010 pathiraja et al 2016 in these studies the distribution of errors and the corresponding error parameters are usually selected subjectively based on expert experience extensive research has shown that poorly estimated error parameters degrade the performance of an assimilation scheme even making it worse than that without assimilation crow van loon 2006 reichle et al 2008 pathiraja et al 2018 the estimation of the error parameters in this study using the map method provided objective and reasonable results as shown in table 3 the values of σ y are 0 10 and 0 08 in the two catchments respectively which is consistent with some previous research li et al 2014 clark et al 2008a under station rainfall forcing the σ lnp of rainfall errors in two catchments are 0 19 and 0 23 which is consistent with willems recommendations willems 2001 due to the accuracy deficiencies of the era5 rainfall dataset in the study catchments fig 4 the uncertainty of the hydrological model increases and therefore all three error parameters σ s σ r σ lnp associated with it increase compared to under station forcing the higher autocorrelation coefficient α lnp of rainfall errors in the tunxi catchment than in the suide catchment may be due to the fact that tunxi catchment has abundant long duration rainfall compared to the suide catchment which is usually erratic and short duration heavy storms it should be underlined that since only a few flood events were used for parameter calibration the error parameter optimization similar to model parameter calibration may also be uncertain and there may be many combinations of error parameters that can produce similar ensemble simulation i e also suffering from parameter equifinality in the one step prediction figs 5 7 the performance is ranked from highest to lowest as enkfsr enkfer olsr and oler it can be seen that enkf reduces the accumulation of past errors in the initial conditions of the hydrological model at the start of the flood forecasting it improves the accuracy of the ensemble mean discharge the overall ensemble performance and the ensemble reliability in most cases the enkf reduces the ensemble spread but enkf can also increase it when ol does not generate enough ensemble spread e g right panel in fig 8 and fig 9 in fig 6 the ensemble mean of enkfsr at validation location yt are close to those at the calibration location tx in tunxi catchment indicating that the assimilation system can compensate for the degradation of hydrological model performance due to uncalibrated model parameters on the other hand comparing the two types of rainfall forcing oler performs much worse than olsr in terms of ensemble mean ensemble reliability and overall ensemble performance indicating that the low quality forcing e g era5 in the study catchments greatly limits the performance of the hydrological model the state correction by enkf can alleviate this limitation and improve the performance to a level slightly better than olsr but still inferior to enkfsr in tunxi catchment the ensemble mean performance of enkfsr can largely achieve the level of persistence forecast in one step prediction fig 6 and the benefits from enkf can be maintained for 40 h fig 11 but shows different results in suide catchment where enkfsr cannot match the persistence forecast and the temporal persistence of assimilation effect may less than 7 h the suide catchment is located on china s loess plateau one of the largest and thickest in the world with the average thickness of the loess ranging from 50 to 80 m and up to several hundred meters ding et al 2001 it has been shown that many existing models perform generally poor for flood simulation in this area e g huang et al 2016 huo et al 2020 liu et al 2020 in this study the ieg grids away from the river channel are practically difficult to saturation the flood discharge depends mainly on the rainfall intensity that exceeds the infiltration so the correction of soil moisture content on ieg grids are not significant which may be one of the reasons for the degradation of performance and the shorter lead time for benefit in the suide catchment as we all know hydrological models are built based on a set of principles coupled with a number of assumptions and imperfectly defined parameters the results in suide catchment indicate that the complex runoff generation mechanisms and the influence of human activities on natural runoff may make the principles and assumptions no longer totally appropriate and this structural deficiency is fatal for the assimilated systems this study focuses on the role of map and enkf in reducing uncertainty in simulation of the distributed hydrological model in order to avoid introduce uncertainty from numerical rainfall prediction we use gauged rainfall or era5 as a perfect proxy for weather prediction since numerical weather prediction products were not used the results of this study do not give a complete picture of the prediction performance in an operational flood forecasting system but they are sufficient for analyzing the effect of enkf on the errors in the initial states of the hydrological model at the start of flood forecasting it will be very interesting to test the performance of map and enkf in operational flood forecasting systems in our future research in addition the limited test samples thirty flood events in two catchments are also one of the limitations of this study and the applicability of map method and enkf in distributed hydrological models needs to be further investigated in wider areas in our case study which did not include synthetic experiments simulated discharge was compared with observation instead of the truth value the effectiveness with synthetic data needs to be further investigated 7 conclusions this paper presents an integrated assimilation scheme with automated error estimation and ensemble kalman filtering which assimilates observed discharge into a distributed hydrological model with the aim of reducing the accumulation of errors in the initial states of the distributed hydrological model at the beginning of flood forecasting the assimilation system was tested in two small and medium sized catchments in china with different climatic and underlying surface characteristics it is also tested under two kinds of rainfall forcing station observation data and hourly era5 reanalysis data the most challenging part of applying the assimilation system to real flood events is getting appropriate estimates of the error models the choice of error parameters is crucial to obtain a better estimate of the model states we show that the maximum a posteriori estimation method map can be beneficial in specifying error models more logically and providing reliable ensemble spread the estimation errors under era5 forcing are larger than those under station forcing which is closely related to the typically lower rainfall records in the era5 dataset in the one step ahead prediction the performance is ranked from highest to lowest as enkfsr enkfer olsr and oler enkf can improve the accuracy of the ensemble mean discharge the overall ensemble performance and the ensemble reliability compared to the open loop run ol results at validation location yt show that the assimilation system effectively ameliorates the degradation of hydrological model performance due to uncalibrated model parameters the assimilation system also improves the underestimated discharge due to underestimated rainfall under era5 forcing suggesting that hydrological assimilation is also one of the potential solutions to overcome poor rainfall forcing however the assimilation performance gradually decreases as the lead time increases and the discharge under era5 forcing always gains more from the assimilation due to its lower level performance in oler in the semi arid catchment suide catchment with strong human activity impacts the performance of both the hydrological model and the assimilation system degrade compared to the humid catchment tunxi catchment with natural underlying surface this phenomenon occurs for all lead time involved in this study in the tunxi catchment temporal persistence of the benefit from the assimilation system lasts 40 h while in the suide catchment this time persistence is less than 7 h credit authorship contribution statement junfu gong conceptualization methodology software visualization writing original draft albrecht h weerts conceptualization resources writing review editing cheng yao data curation software funding acquisition writing review editing zhijia li project administration funding acquisition yingchun huang validation funding acquisition yuanfang chen supervision yifei chang investigation pengnian huang writing review editing funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by the national natural science foundation of china grant numbers 51979070 52079035 51909059 and 41901036 the natural science foundation of jiangsu province grant number bk20190492 and the china scholarship council we thank deltares for providing the office space and the hardware and software for the study the hydrometeorological data were provided by the hydrology bureau of anhui province and shaanxi province including evaporation precipitation and discharge the check dam data were provided by the yellow river conservancy commission the code of enkf used in this study was developed from the parallel data assimilation framework pdfa http pdaf awi de trac wiki and openda www openda org the sce ua algorithm implemented via uncertainty quantification python laboratory uq pyl http www uq pyl com we thank these organizations for granting permission to use their data and software appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129450 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 supplementary data 2 
2056,vegetation exists widely in natural rivers resulting in unique characteristics of flow movement affecting river flood processes and water quality the flow movement of vegetated channels is defined as vegetated flow and is currently receiving close attention influenced by vegetation the classical logarithmic velocity profile turn into a more complex function according to the vegetation morphology and flow pattern several research teams have studied analytical models for simple cylinder type vegetation however few studies have been conducted on analytical velocity models for vegetation with spherical canopy and previous models cannot make accurate prediction of velocity profile in this case to address this issue new analytical models are proposed adopting the power series exponential and trigonometric models a comparison between the measured velocity profile and the analytical solution confirms that the newly proposed models are suitable for vegetation with spherical canopy this analytical model can capture the vertical non monotonic characteristics of velocity profile which is what the previous models lack moreover in contrast to numerical models which require a lot of computational cost this analytical model allows a quick and intuitive description of the flow profile which provides hydrodynamic support for the restoration of vegetated channels keywords vegetation channel flow analytical methods velocity profile penetrated depth data availability data will be made available on request 1 introduction river ecosystems are one of the most important ecosystems in nature with multiple functions such as water supply power generation shipping landscape ecology and drainage with the rapid development of global climate change and urbanization the sustainable management of rivers faces more challenges for example the over channelization of urban river channels and drainage channels has changed the natural form of rivers resulting in the decline of biodiversity and the weakening of the self purification capacity of water bodies agricultural and industrial pollutants are discharged into rivers along with urban floods and drainage channels putting unprecedented pressure on the ecological environment of rivers resulting in serious deterioration of river water quality sharp decline of aquatic organisms and degradation of water ecosystems restoring the ecological function of river flow has become an important goal in river management water ecological protection and restoration river ecological restoration arises at a historic moment to guide us in the selection and implementation of appropriate engineering biological and ecological measures to restore natural water characteristics these measures help restore and strengthen water s self healing and purification ability repair the damaged water ecological system establish limits for human use and achieve a water ecological system that is self sustaining a thorough understanding of river hydrodynamic sediment and pollutant transport processes is needed for ecological restoration wu and chen 2014 wu et al 2021 jiang et al 2022 vegetation is an important part of river ecosystem which can improve water quality provide a good habitat for aquatic organisms and microorganisms increase biodiversity restore the function of ecosystems and affect sediment transport huai et al 2019 huai et al 2021 from the perspective of hydrodynamics the vegetation in the riparian zone can resist the scour of the current and play a role in protecting the riverbank slope and maintaining the stability of the riverbed bauer et al 2018 yang et al 2018 however the presence of vegetation increases the resistance of the river raises the water level and has adverse effects on flood discharge classical vegetated flow models usually adopt generalized cylindrical bars for flume experiments where the velocity profile is calculated according to the concept of stratification in which the velocity profile is divided according to the flow structure and vegetation status such as single two three and multiple layer models for a single layer model of vegetated flow cheng 2015 proposed a model for submerged vegetation by adopting a new concept of hydraulic radius without evaluating the vegetation drag coefficient and hydrodynamic height of roughness elements which are always involved in two layer or multiple layer models the single layer model for the bulk velocity cross sectional average velocity is expressed as 1 u b 2 1 r 1 10 g s f ν 2 1 30 h w h v 3 4 gr s f where ub is the bulk velocity g is the gravity acceleration sf is the energy slope hw is the flow depth hv is the vegetation height sf is the energy slope and r is the hydraulic radius defined as the ratio of the volume of fluid to the area of the wetted boundary r b h s b h v 1 λ b 1 λ 2 h w 4 λ b h v d where surface height hs hw hv λ is the vegetation planar concentration and d is the diameter of the vegetation stem as single layer model cannot accurately describe the vertical variation of velocity multiply layer velocity model were investigated by many researchers the velocity profile is derived by solving the governing equation i e the planar averaged momentum equation for vegetated flow huai et al 2009 katul et al 2011 poggi et al 2009 wang et al 2019 2 1 ρ τ z g s o δ f d 0 where τ is the reynolds stress ignoring viscous stress in turbulent flow gso is the gravity in the streamwise direction ρ is the density of water fd is the vegetation drag gives 3 f d 1 2 ρ c d m d u 2 where δ 1 indicates the vegetation layer and δ 0 indicates the surface layer cd is the drag force coefficient m is the amount of vegetation per unit area d is the diameter of vegetation there are several closure schemes for reynolds stress 1 the reynolds stress model can be established using the boussinesq s eddy viscosity as τ ρ υ t u z where νt is the eddy viscosity and can be expressed using the standard kármán prandtl mixing length theory embracing the squared mixing length l as kubrak et al 2008 υ t l 2 u z moreover a modified mixing length theory using 1st power of mixing length is also proven to be suitable for vegetated flow giving υ t l u where u is shear velocity from another point of view when eddy viscosity is linked with velocity in the vegetation layer klopstra et al 1996 then υ t ω u where ω is a constant determined by the flow condition 2 moreover the formula of shear stress can be established according to turbulence structures of boundary layer mixing layer and kármán streets layer adopting different theories nikora et al 2013 poggi et al 2009 the above research mainly focused on rigid non deformable cylinders in fact vegetation of certain toughness will undergo morphological changes under the action of water flow caroppi et al 2021 in this case the resistance of vegetation to water flow is the resultant force of the friction drag and the form drag in the flow direction huai et al 2013b from another point of view when the vegetation layer is assumed to be a porous medium of permeability kp the darcy brinkman equation of the horizontal direction can be adopted for the mean velocity battiato and rubol 2014 katul et al 2011 stephan and gutknecht 2002 expressed as 4 μ e u 2 2 z μ e k p 1 u ρ g s o 0 where μe is the effective viscosity which can be calculated using μ e k o ρ h w u the analytical solution for eq 4 in the vegetation layer can be derived as 5 u ρ g s o h v 2 μ e k p h v 2 p 0 exp z k p p 0 exp z k p with parameter p 0 h s k p 2 h v 2 csch h v k p previous studies of analytical models have been conducted for simple cylinder type rigid or flexible vegetation by several research groups but few studies have been conducted on analytical models of velocity distribution for vegetation with spherical canopy to address this issue new analytical models are proposed in this paper and the verification and discussion are presented the research route of this paper is as follows chapter 1 summarizes the research background chapter 2 focuses on the theoretical and analytical modelling approach section 2 1 illustrates the scientific problem that the previous models cannot give accurate prediction of flow velocity distribution and then we build new analytical models for different layers in section 2 2 chapter 3 describes the experiments chapter 4 discusses the experimental results along with model verification comparisons and limitations where 4 1 gives the determination of analytical model parameters 4 2 shows the verification of the model 4 3 illustrates the comparison between present model and previous models of other research groups 4 4 states the limitation of this study finally chapter 5 gives the conclusion of this paper 2 theory 2 1 problem statement influenced by vegetation with a canopy the classical logarithmic velocity profile turn into a more complicated function according to vegetation categories and flow patterns the scientific problem is that previous studies on analytical models cannot give satisfactory calculation for cylinders with spherical canopy the classical velocity distribution models for vegetated flow are introduced in the following 2 1 1 previous model 1 the study of nikuradse 1930 showed that the roughness of riverbed was influenced by the roughness length z 0 of log velocity profile derived by prandtl and von kármán for completely rough riverbed essentially when using a single roughness equation such as the white cole brook formula vegetation is treated as a large riverbed structure with logarithmic flow profiles on it however water flows through submerged vegetation and the vertical flow profile deviates from the logarithmic profile vegetation drag is modeled as the drag on a rigid cylinder with uniform properties arranged randomly or staggeringly the uniform velocity in vertical of non submerged vegetation follows momentum balance and the typical time average velocity profile of submerged plants is given by the following equation baptist et al 2007 proposed that the velocity of vegetation layer can be calculated as 6 u h w s f 1 c b 2 c d m d h v 2 g where the bed roughness coefficient cb can be estimated as 60 m1 2 s and velocity in the surface layer expressed as 7 u u κ ln z h v z 0 u c where z 0 is the momentum roughness height and κ is von kármán constant 2 1 2 previous model 2 actually velocity distribution is not uniform for vegetation layer when adopting the first order closure model with the mixing length concept constant in the vegetation layer and varied linearly as l κ z d in the surface layer where κ is kármán constant and d is the zero plane displacement the velocity profile can be calculated using numerical method particularly when variations in vegetation drag length scale lc lc 1 cdmd where cd is the vegetation drag coefficient and m is the vegetation density with z are small an analytical model can be derived to predict the velocity profile finnigan and belcher 2004 harman and finnigan 2007 katul et al 2011 massman 1997 massman and weil 1999 for the vegetation layer the velocity profile is 8 u u β exp β z h v l where the mixing length in vegetation layer can be approximately expressed as l 2β 3 lc and the momentum absorption coefficient β u uv and uv is the velocity at the vegetation top the velocity in the surface layer can be expressed as logarithmic velocity distribution formula 9 u u κ ln z d z o 2 1 3 calculation of previous models the comparison of calculated and measured flow velocity values for different cases is shown in fig 1 see chapter 3 for experimental settings where vegetation top and flow surface are marked with horizontal dotted red and black lines in particular the circles are the measured values of flow velocity distribution the blue line is the calculation result of model 1 and the black line is result of model 2 it can be seen that both previous models cannot make accurate predictions especially for vegetation layer therefore a new model to predict flow velocity in such condition is urgently needed 2 2 new analytical velocity model establishment for vegetation with spherical canopy the frontal width first increases and then decreases for canopy layer fig 2 and the velocity along the vertical direction shows non monotonic behavior illustrating a significant low velocity zone in the vegetation layer see the velocity profile with red dashed line in fig 2 detailed velocity data can be found in sections 3 under these conditions traditional analytical velocity solutions as discussed in section 2 can only increase monotonically along the vertical direction and cannot illustrate other types of velocity characteristics to solve this problem a new analytical model is established in this section and the velocity distribution is derived according to different layers including the stem layer spherical canopy layer and surface layer 2 2 1 stem layer the stem layer can be divided into two zones uniform velocity zone and penetrated velocity zone the flow velocity calculation methods in different zones are described in detail below 1 uniform velocity zone in this zone the reynolds stress can be ignored compared with the vegetation drag here the momentum equation in the streamwise direction can be reduced to illustrate the balance between the gravity component and vegetation drag as huai et al 2009 nepf 2012 10 ρ g s o 1 2 ρ c d m d z u 2 0 where dz d 0 is the stem diameter then one can obtain the velocity in this zone 11 u 0 2 g s o c d m d 0 2 penetrated velocity zone considering the interface between the stem and canopy layers the flow velocity in the canopy layer tends to be smaller than that in the stem layer because of the larger frontal width the velocity decreases in this zone indicating that the reynolds stress is negative based on the vertical coordinate system z 1 fig 2 which starts from the interface between the uniform and penetration zones the momentum equation gives 12 τ z 1 ρ g s o 1 2 ρ c d m d z u 2 0 considering the solvability of the analytical solution of the governing equation the classic 2 order closure formula is adopted 13 τ ρ k z 1 2 du d z 1 du d z 1 as du dz 1 0 in this zone the reynolds stress can be evaluated by 14 τ ρ k z 1 2 du d z 1 2 0 the governing equation can be expressed as follows by substituting eq 14 into 12 15 2 k 2 z 1 2 u z 1 2 u z 1 2 2 k 2 z 1 u z 1 2 g s o 1 2 c d m d 0 u 2 where 0 z 1 hp the power series method is adopted to solve eq 15 where the terms associated with the flow velocity can be expressed as 16 u n 0 a n z 1 n a 0 a 1 z 1 a 2 z 1 2 a 3 z 1 3 one can get 17 u z 1 n 1 n a n z 1 n 1 a 1 2 a 2 z 1 3 a 3 z 1 2 and 18 2 u z 1 2 n 2 n n 1 a n z 1 n 2 2 a 2 6 a 3 z 1 12 a 4 z 1 2 adopting the power series method by substituting eqs 12 18 into 15 gives 19 2 k 2 z 1 2 n 1 n a n z 1 n 1 n 2 n n 1 a n z 1 n 2 2 k 2 z 1 n 1 n a n z 1 n 1 2 g s o 1 2 c d m d 0 n 0 a n z 1 n 2 compare the item z 1 n n 0 1 2 3 for both sides of the eq 19 one can get the following eqs 20 23 20 g s o 1 2 c d m d 0 a 0 2 21 2 k 1 2 z 1 a 1 2 1 2 c d m d 0 2 a 0 a 1 z 1 22 2 k 1 2 z 1 2 6 a 1 a 2 1 2 c d m d 0 z 1 2 2 a 0 a 2 a 1 2 23 2 k 1 2 z 1 3 8 a 2 2 12 a 1 a 3 1 2 c d m d 0 z 1 3 2 a 0 a 3 2 a 1 a 2 then 24 a 0 u 0 2 g s o c d m d 0 25 a 1 1 2 c d m d 0 k 1 2 u 0 26 a 2 1 40 c d m d 0 k 1 2 2 u 0 27 a 3 1 4400 c d m d 0 k 1 2 3 u 0 the solution of velocity profile 0 z 1 h p gives 28 u p u 0 1 ϕ 1 2 ϕ 1 2 40 ϕ 1 3 4400 where u0 is 29 u 0 2 g s o c d m d 0 which is suitable for zones with a du dz 0 and the key parameter gives 30 ϕ 1 c d m d 0 k 1 2 z 1 2 2 2 spherical canopy layer for flow in the canopy layer there are several models for reynolds stress such as 1st and 2nd models adopting boussinesq s eddy viscosity concept and kármán prandtl mixing length theory considering the solvability of momentum eq 3 when dealing with spherical morphology of canopy the exponential form of reynolds stress dijkstra and uittenbogaard 2010 huai et al 2013a shimizu et al 1991 is adopted with improvement in the canopy layer gives 31 τ ρ u w ρ u w z c h c exp η z c h c where zc is calculated from the interface between uniform velocity zone and penetration velocity zone fig 2 η is a constant that can be determined later and u and w are the temporal fluctuations from the means of longitudinal and vertical velocities respectively this formula indicates that the shear stress reaches its maximum value at the vegetation top zc hc from the momentum balance of the flow above the vegetation the interfacial shear stress between the vegetation and free water layers can be obtained by yang and choi 2010 32 ρ u w z c h c ρ u 2 where u g s o h s is the shear velocity at the top of the plant and hs is the water depth above the vegetation top i e hs hw hv from eqs 31 and 32 the reynolds shear stress yields 33 τ ρ u 2 exp η z c h c for spherical canopies the shape function can be built according to the frontal direction along with the vertical direction which can be expressed as a function of zc i e dz zc then uc can expressed as 34 u c 2 η g s o h s exp η z c h c 2 g s o c d m d z therefore the velocity profile in this canopy layer is derived when all the parameters are determined which will be discussed in the next section 2 2 3 surface layer in the surface layer where there are no vegetation drag components the momentum equation gives 35 τ z s ρ g s o 0 and reynolds stress adopts 2nd order scheme 36 τ ρ k z s 2 du d z s 2 where zs is calculated starting from the plane where the boundary vortex can penetrate into the canopy layer fig 2 which is located behind the vegetation with a distance of hsp the subscript sp denotes the penetration of the surface layer this plane is treated as the modified zero plane displacement and the mixing length is calculated based on zs by adopting the analytical solution the analytical velocity profile in the surface layer can be derived as follows 37 u s 2 g s o k s h ssp z s h ssp arctanh h ssp z s h ssp c 1 where the function arctanh is inverse hyperbolic tangent defined as 38 artanh δ 1 2 ln 1 δ 1 δ and 39 h ssp h s h sp the parameters hssp and c 1 in eq 37 can be determined by two boundary conditions 1 the velocity in the canopy top equals the one in the bottom of the surface layer 40 u s z s h sp u vtop where uvtop is the velocity at vegetation top 2 the derivative of the velocity is zero at the water surface 41 u s z s z s h ssp 0 3 experiments 3 1 experimental setup experiments were conducted in a 16 m long 0 5 m wide and 0 5 m deep glass made flume the bottom slope of the sink is 0 001 in the laboratory of applied hydraulics department of water resources and environmental engineering national technical university of athens greece in the experiment process the inlet valve and electromagnetic flowmeter control the flow and the end of the tank is installed with a thin wall gate that can adjust the height to control the water depth the water flow can be regarded as a steady uniform flow the experimental setup is shown in fig 3 3 2 vegetation arrangement the vegetation canopy was approximately spherical to simulate the dense vegetation group fig 4 the elements of the vegetation model were composed of rigid strips and plastic balls where the rigid strip simulated the vegetation stem and the plastic balls indicated a dense canopy zhao et al 2018 this simulated vegetation model is 8 cm in height where the stem height hstem 5 cm stem diameter do 0 8 cm and ball diameter d 0 hc 3 cm the vegetation area is 6 m long 0 5 m wide with a vegetation spacing of 10 cm 10 cm the vegetation area is 5 m from both the front and the end of the flume x direction is defined as the flow direction y direction as the lateral direction z direction as the vertical direction and the origin of the coordinates is 4 m from the front edge of the vegetation area the adv measurement area is centrally located 4 m downstream from the beginning of the vegetation the vertical measurement line was mainly distributed between the four vegetation plants the experiment uses micro adv acoustic doppler velocimeter measurements micro adv is often used for laboratory scale three dimensional flow velocity field measurements and its working principle is based on the doppler effect when the signal is emitted from the generator and encounters a moving object the signal is reflected and the frequency of the reflected back acoustic wave and the original signal frequency will have a the three signal receivers at the front of the adv probe are oriented to intersect in an area that is the flow rate test area which is a cylinder of 5 6 cm in height and 4 5 mm in diameter the generator is arranged in the middle of the three probes and the micro adv emits three beams of 16 mhz frequency through the transmitting transducer which are conducted through the water body and reach the sampling point 5 cm away from the transmitting transducer and are reflected back by the tracer particles and other particles in the water body since the spatial resolution of the micro adv sampling point is 4 5 mm the sampling point is required to be at least 10 mm away from the side wall to avoid overlap between the sampling point and the wall the first sampling point in the near wall area is at a minimum distance of 5 mm from the bottom of the sink in this experiment and the second point is 10 mm away from the wall to minimize the influence of the flume walls on the measurements and to ensure that the flow is fully developed and turbulent the adv measurement area was located 4 m downstream of the entrance to the vegetated area where turbulence was fully developed by experimental measurements each measurement line was sampled at 25 hz with a sampling time of 120 s for each measurement point for a total of 3000 the layout of the vertical measurement lines is shown in figs 5 and 6 in this paper the velocity values of these lines were averaged for the same depth in order to validate the analytical velocity model a total of four more typical working conditions were selected for the experiments with experimental flow rates of 22 42 40 94 l s reynolds numbers of 44533 81313 and froude numbers of 0 115 0 433 for subcritical flow the experimental parameters of each working condition are shown in table 1 with a certain vegetation density and mainly varying flow rate and water depth 4 results and discussions 4 1 parameter determination for a canopy with spherical morphology the shape function represents the variation in the frontal width of the canopy for a single plant along the vertical direction for the vegetation modeled in the experiments where the canopy is spherical the shape function can be expressed as 42 d z 2 d 0 2 4 z c d 0 2 2 where zc was calculated in the canopy layer fig 2 this function shows that the canopy width first increased and then decreased along the vertical direction for the canopy layer this situation is more complicated than previous experiments with uniform width or width with monotonically increasing characteristics liu et al 2012 wang et al 2019 wang et al 2015 for the velocity in the stem layer the key issue is to determine the vortex penetration depth for simplified cylinder vegetation nepf et al 2007 proposed a penetration length scale for a submerged canopy 43 δ e 0 23 c d m d 0 the stem diameter is used here for the stem layer however this formula may not be applicable to vegetation with complex conditions owing to the different stages of vortex development huai et al 2014 modified this penetration formula with an adjustable parameter ƞ for vegetation with different height combinations giving a new penetration length scale as follows 44 δ e ω c d m d 0 the parameter ω 0 02 for a double layer vegetation array with two heights which is much shallower than vegetation with a single height for the vegetation with spherical canopy adopted here this parameter may be smaller for canopy sheltering effect because the vortex becomes harder to develop into the stem layer by regression the best value for this parameter is obtained as ω 0 009 with a drag coefficient cd 1 13 which is commonly adopted by many research groups dunn et al 1996 huai et al 2013a li and shen 1973 lópez and garcía 2001 yang and choi 2009 for reynolds stress the exponential formula is adopted which has been used by several research groups with an adjustable parameter ƞ dijkstra and uittenbogaard 2010 huai et al 2013b shimizu et al 1991 gives 45 η c d m d 0 03 h w h v which is derived from experiments adopting simplified cylinders but is not suitable for vegetation with a spherical canopy as our study is the first to address vegetation with spherical shape we try to build a new empirical formula to determine the parameter ƞ as the reynolds stress in the canopy layer is both affected by surface layer and stem layer it is natural to associate the parameter ƞ with the velocity gradient ω 46 ω u v u min δ z where uv is the velocity at the vegetation top u min is the minimum velocity in the canopy layer and δz is the vertical distance between these two velocities then an empirical formula for ƞ is proposed by regression 47 η 1 8613 ω 1 173 the comparison between the measured data and the prediction of eq 47 is illustrated in fig 7 the correlation coefficient is 0 95 indicating this equation is suitable for calculating the parameter ƞ for the adjusted kármán coefficient in the canopy layer please note this adjusted kármán coefficient is not equal to 0 41 due to presence of vegetation the best fitting value is 0 16 here which is in the range of 0 12 0 33 derived from wang et al 2015 who showing its effectiveness in the analytical solution for the surface layer the traditional kármán constant of 0 41 is adopted for the new zero plane displacement hsp which can be proportional to the thickness of the surface layer the value of 0 04 m is adopted for runs 1 2 and value of 0 06 m is used for runs 3 4 all parameters used in this analytical solution are listed in table 2 4 2 models verification analytical predictions can be calculated using several equations as follows 1 the velocity of the stem layer is calculated by eq 11 uniform velocity zone and eq 28 penetrated velocity zone 2 the velocity of the canopy layer is calculated by eq 34 3 the velocity of the surface layer is calculated by eq 37 as penetration is common for the fast flow layer into the low flow layer 10 of the stem layer is penetrated by the canopy layer fig 8 shows the comparison between the measured and predicted velocities for each case where good agreement indicates that the newly proposed analytical models are effective for predicting velocity in flow through vegetation model with spherical canopy comparison between calculated and measured data for all four runs is shown in fig 9 it can be seen that the new analytical model perform excellent for vegetation with canopy in flow 4 3 model comparison from fig 8 it can be seen from the measured velocity profile that a minimum velocity in the canopy layer is observed which is different from the velocity profile in flow with simplified cylinder vegetation in flow through simplified cylinder vegetation the velocity increases along the vertical position which is a common phenomenon found in previous research aberle and järvelä 2013 dunn et al 1996 katul et al 2011 poggi et al 2009 compared with formulae of previous model 1 and model 2 the new proposed model has the best accuracy fig 10 the accuracy of velocity model can be evaluated by taylor diagram taylor 2001 using standard deviation sd centered root mean square difference rmsd and correlation coefficient r a comparison of the simulated and measured values for each experimental condition is given in table 3 and fig 11 it can been seen that the newly proposed model performs best for all four runs for vegetation with different shapes some research groups have conducted studies to investigate the flow resistance and velocity models rubol et al 2018 proposed a universal scaling law for flow resistance over canopies with various morphologies and analytical velocity solutions have been proposed where the velocity increases monotonically along the vertical direction with this feature of the velocity solution their models cannot be applied to the experiments here to conclude previous models have several limitations and cannot be directly applied to the vegetation with spherical canopy for the newly proposed models the shape function of eq 42 can be changed to another form according to the vegetation we consider indicating a larger range of application of the newly proposed analytical models compared with that of previous analytical models 5 limitation although the newly established analytical solution model can predict well the flow movement under the influence of vegetation forms some limitations remain to be addressed in future studies the parameters established in our study were determined using a limited number of experimental conditions consequently the empirical formulas that we established were based mainly on the vegetation morphology used in the experiments i e this paper mainly provides a method for calculating water flow under vegetation with spherical canopy for different vegetation morphologies parameters such as the adjusted kármán coefficient and penetration depth require modification with further investigation for our experiments we selected a solid ball to simulate a very dense canopy further research should be conducted to determine flow velocity distribution for different vegetation sizes with different canopy densities therefore when solving the governing equations to derive the velocity solution canopy permeability indicating different sparse dense canopies can be inserted to further improve the analytical model of velocity distribution 6 conclusion this study focuses on building analytical solutions for flow through vegetation a more detailed stratification method is proposed and a complete set of analytical solution models of velocity distribution is proposed based on different mathematical methods such as the power series mathematical solution exponential reynolds stress model calculation method and inverse hyperbolic tangent mathematical calculation method by comparing the experimental data with model calculations the validity of the model proposed in this study is verified the main conclusions are summarized as follows 1 according to the vegetation shape the flow regime is divided into stem canopy and surface layers the governing equation was established according to the force analysis considering that the width of the canopy first increased and then decreased in the vertical direction the velocity distribution formulas of different layers were linked together to show the velocity distribution of the entire water depth in addition the relative parameters of the analytical solutions are discussed 2 the stem layer is divided into two zones one is the uniform velocity zone at the bottom of the stem layer this is due to the influence of viscosity and the reynolds stress in this area can be ignored leading to an approximately uniform velocity distribution in the upper part of the stem layer the penetration depth is formed owing to the influence of the high speed flow in the upper layer the velocity in this zone can be derived based on a new power series solution 3 for the canopy layer the change in the width of the vegetation canopy in this layer can be accurately considered because the exponential reynolds stress was adopted in the governing equation with the accurate shape function for the frontal with of the canopy the distribution of flow velocity in this layer can be obtained by solving the governing equation analytically the advantage of adopting the exponential reynolds stress into governing equation is that it is not necessary to fit the shape of the vegetation canopy in a fixed mathematical form therefore the shape function can more closely represent the real conditions and the calculation results of the flow velocity are more accurate 4 for the surface layer a new analytical solution of the velocity distribution in the form of an inverse hyperbolic tangent function is obtained by using the second order reynolds stress expression method which is a new expression for the velocity distribution of the free water layer and provides a new idea for enriching the expression method of the velocity movement of the free water layer 5 from the experimental data it was found that the flow velocity has a minimum value near the bottom of the canopy layer and the existing analytical solution model could not capture and display this flow velocity distribution in this study a new calculation method for the analytical velocity distribution is proposed which is fully consistent with the characteristics of velocity moreover for future studies on other types of vegetation the shape function can be changed directly without having to consider the solvability of the governing equation with exponential reynolds stress which is one of the important advantages of this model enriched environmental fluid mechanics in the vegetated flow providing a solving framework for subsequent simulation of flow through various shapes of vegetation credit authorship contribution statement wei jie wang conceptualization methodology investigation software writing original draft writing review editing fang zhao investigation software writing review editing aristotelis mavrommatis investigation george christodoulou investigation anastasios stamou investigation feng cong jia writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors acknowledge the support of the national key research and development program of china 2021yfc3200903 the national natural science foundation of china 51809286 the talent program of china institute of water resources and hydropower research we0199a052021 and the national water pollution control and treatment science and technology major project of china 2018zx07105 002 
2056,vegetation exists widely in natural rivers resulting in unique characteristics of flow movement affecting river flood processes and water quality the flow movement of vegetated channels is defined as vegetated flow and is currently receiving close attention influenced by vegetation the classical logarithmic velocity profile turn into a more complex function according to the vegetation morphology and flow pattern several research teams have studied analytical models for simple cylinder type vegetation however few studies have been conducted on analytical velocity models for vegetation with spherical canopy and previous models cannot make accurate prediction of velocity profile in this case to address this issue new analytical models are proposed adopting the power series exponential and trigonometric models a comparison between the measured velocity profile and the analytical solution confirms that the newly proposed models are suitable for vegetation with spherical canopy this analytical model can capture the vertical non monotonic characteristics of velocity profile which is what the previous models lack moreover in contrast to numerical models which require a lot of computational cost this analytical model allows a quick and intuitive description of the flow profile which provides hydrodynamic support for the restoration of vegetated channels keywords vegetation channel flow analytical methods velocity profile penetrated depth data availability data will be made available on request 1 introduction river ecosystems are one of the most important ecosystems in nature with multiple functions such as water supply power generation shipping landscape ecology and drainage with the rapid development of global climate change and urbanization the sustainable management of rivers faces more challenges for example the over channelization of urban river channels and drainage channels has changed the natural form of rivers resulting in the decline of biodiversity and the weakening of the self purification capacity of water bodies agricultural and industrial pollutants are discharged into rivers along with urban floods and drainage channels putting unprecedented pressure on the ecological environment of rivers resulting in serious deterioration of river water quality sharp decline of aquatic organisms and degradation of water ecosystems restoring the ecological function of river flow has become an important goal in river management water ecological protection and restoration river ecological restoration arises at a historic moment to guide us in the selection and implementation of appropriate engineering biological and ecological measures to restore natural water characteristics these measures help restore and strengthen water s self healing and purification ability repair the damaged water ecological system establish limits for human use and achieve a water ecological system that is self sustaining a thorough understanding of river hydrodynamic sediment and pollutant transport processes is needed for ecological restoration wu and chen 2014 wu et al 2021 jiang et al 2022 vegetation is an important part of river ecosystem which can improve water quality provide a good habitat for aquatic organisms and microorganisms increase biodiversity restore the function of ecosystems and affect sediment transport huai et al 2019 huai et al 2021 from the perspective of hydrodynamics the vegetation in the riparian zone can resist the scour of the current and play a role in protecting the riverbank slope and maintaining the stability of the riverbed bauer et al 2018 yang et al 2018 however the presence of vegetation increases the resistance of the river raises the water level and has adverse effects on flood discharge classical vegetated flow models usually adopt generalized cylindrical bars for flume experiments where the velocity profile is calculated according to the concept of stratification in which the velocity profile is divided according to the flow structure and vegetation status such as single two three and multiple layer models for a single layer model of vegetated flow cheng 2015 proposed a model for submerged vegetation by adopting a new concept of hydraulic radius without evaluating the vegetation drag coefficient and hydrodynamic height of roughness elements which are always involved in two layer or multiple layer models the single layer model for the bulk velocity cross sectional average velocity is expressed as 1 u b 2 1 r 1 10 g s f ν 2 1 30 h w h v 3 4 gr s f where ub is the bulk velocity g is the gravity acceleration sf is the energy slope hw is the flow depth hv is the vegetation height sf is the energy slope and r is the hydraulic radius defined as the ratio of the volume of fluid to the area of the wetted boundary r b h s b h v 1 λ b 1 λ 2 h w 4 λ b h v d where surface height hs hw hv λ is the vegetation planar concentration and d is the diameter of the vegetation stem as single layer model cannot accurately describe the vertical variation of velocity multiply layer velocity model were investigated by many researchers the velocity profile is derived by solving the governing equation i e the planar averaged momentum equation for vegetated flow huai et al 2009 katul et al 2011 poggi et al 2009 wang et al 2019 2 1 ρ τ z g s o δ f d 0 where τ is the reynolds stress ignoring viscous stress in turbulent flow gso is the gravity in the streamwise direction ρ is the density of water fd is the vegetation drag gives 3 f d 1 2 ρ c d m d u 2 where δ 1 indicates the vegetation layer and δ 0 indicates the surface layer cd is the drag force coefficient m is the amount of vegetation per unit area d is the diameter of vegetation there are several closure schemes for reynolds stress 1 the reynolds stress model can be established using the boussinesq s eddy viscosity as τ ρ υ t u z where νt is the eddy viscosity and can be expressed using the standard kármán prandtl mixing length theory embracing the squared mixing length l as kubrak et al 2008 υ t l 2 u z moreover a modified mixing length theory using 1st power of mixing length is also proven to be suitable for vegetated flow giving υ t l u where u is shear velocity from another point of view when eddy viscosity is linked with velocity in the vegetation layer klopstra et al 1996 then υ t ω u where ω is a constant determined by the flow condition 2 moreover the formula of shear stress can be established according to turbulence structures of boundary layer mixing layer and kármán streets layer adopting different theories nikora et al 2013 poggi et al 2009 the above research mainly focused on rigid non deformable cylinders in fact vegetation of certain toughness will undergo morphological changes under the action of water flow caroppi et al 2021 in this case the resistance of vegetation to water flow is the resultant force of the friction drag and the form drag in the flow direction huai et al 2013b from another point of view when the vegetation layer is assumed to be a porous medium of permeability kp the darcy brinkman equation of the horizontal direction can be adopted for the mean velocity battiato and rubol 2014 katul et al 2011 stephan and gutknecht 2002 expressed as 4 μ e u 2 2 z μ e k p 1 u ρ g s o 0 where μe is the effective viscosity which can be calculated using μ e k o ρ h w u the analytical solution for eq 4 in the vegetation layer can be derived as 5 u ρ g s o h v 2 μ e k p h v 2 p 0 exp z k p p 0 exp z k p with parameter p 0 h s k p 2 h v 2 csch h v k p previous studies of analytical models have been conducted for simple cylinder type rigid or flexible vegetation by several research groups but few studies have been conducted on analytical models of velocity distribution for vegetation with spherical canopy to address this issue new analytical models are proposed in this paper and the verification and discussion are presented the research route of this paper is as follows chapter 1 summarizes the research background chapter 2 focuses on the theoretical and analytical modelling approach section 2 1 illustrates the scientific problem that the previous models cannot give accurate prediction of flow velocity distribution and then we build new analytical models for different layers in section 2 2 chapter 3 describes the experiments chapter 4 discusses the experimental results along with model verification comparisons and limitations where 4 1 gives the determination of analytical model parameters 4 2 shows the verification of the model 4 3 illustrates the comparison between present model and previous models of other research groups 4 4 states the limitation of this study finally chapter 5 gives the conclusion of this paper 2 theory 2 1 problem statement influenced by vegetation with a canopy the classical logarithmic velocity profile turn into a more complicated function according to vegetation categories and flow patterns the scientific problem is that previous studies on analytical models cannot give satisfactory calculation for cylinders with spherical canopy the classical velocity distribution models for vegetated flow are introduced in the following 2 1 1 previous model 1 the study of nikuradse 1930 showed that the roughness of riverbed was influenced by the roughness length z 0 of log velocity profile derived by prandtl and von kármán for completely rough riverbed essentially when using a single roughness equation such as the white cole brook formula vegetation is treated as a large riverbed structure with logarithmic flow profiles on it however water flows through submerged vegetation and the vertical flow profile deviates from the logarithmic profile vegetation drag is modeled as the drag on a rigid cylinder with uniform properties arranged randomly or staggeringly the uniform velocity in vertical of non submerged vegetation follows momentum balance and the typical time average velocity profile of submerged plants is given by the following equation baptist et al 2007 proposed that the velocity of vegetation layer can be calculated as 6 u h w s f 1 c b 2 c d m d h v 2 g where the bed roughness coefficient cb can be estimated as 60 m1 2 s and velocity in the surface layer expressed as 7 u u κ ln z h v z 0 u c where z 0 is the momentum roughness height and κ is von kármán constant 2 1 2 previous model 2 actually velocity distribution is not uniform for vegetation layer when adopting the first order closure model with the mixing length concept constant in the vegetation layer and varied linearly as l κ z d in the surface layer where κ is kármán constant and d is the zero plane displacement the velocity profile can be calculated using numerical method particularly when variations in vegetation drag length scale lc lc 1 cdmd where cd is the vegetation drag coefficient and m is the vegetation density with z are small an analytical model can be derived to predict the velocity profile finnigan and belcher 2004 harman and finnigan 2007 katul et al 2011 massman 1997 massman and weil 1999 for the vegetation layer the velocity profile is 8 u u β exp β z h v l where the mixing length in vegetation layer can be approximately expressed as l 2β 3 lc and the momentum absorption coefficient β u uv and uv is the velocity at the vegetation top the velocity in the surface layer can be expressed as logarithmic velocity distribution formula 9 u u κ ln z d z o 2 1 3 calculation of previous models the comparison of calculated and measured flow velocity values for different cases is shown in fig 1 see chapter 3 for experimental settings where vegetation top and flow surface are marked with horizontal dotted red and black lines in particular the circles are the measured values of flow velocity distribution the blue line is the calculation result of model 1 and the black line is result of model 2 it can be seen that both previous models cannot make accurate predictions especially for vegetation layer therefore a new model to predict flow velocity in such condition is urgently needed 2 2 new analytical velocity model establishment for vegetation with spherical canopy the frontal width first increases and then decreases for canopy layer fig 2 and the velocity along the vertical direction shows non monotonic behavior illustrating a significant low velocity zone in the vegetation layer see the velocity profile with red dashed line in fig 2 detailed velocity data can be found in sections 3 under these conditions traditional analytical velocity solutions as discussed in section 2 can only increase monotonically along the vertical direction and cannot illustrate other types of velocity characteristics to solve this problem a new analytical model is established in this section and the velocity distribution is derived according to different layers including the stem layer spherical canopy layer and surface layer 2 2 1 stem layer the stem layer can be divided into two zones uniform velocity zone and penetrated velocity zone the flow velocity calculation methods in different zones are described in detail below 1 uniform velocity zone in this zone the reynolds stress can be ignored compared with the vegetation drag here the momentum equation in the streamwise direction can be reduced to illustrate the balance between the gravity component and vegetation drag as huai et al 2009 nepf 2012 10 ρ g s o 1 2 ρ c d m d z u 2 0 where dz d 0 is the stem diameter then one can obtain the velocity in this zone 11 u 0 2 g s o c d m d 0 2 penetrated velocity zone considering the interface between the stem and canopy layers the flow velocity in the canopy layer tends to be smaller than that in the stem layer because of the larger frontal width the velocity decreases in this zone indicating that the reynolds stress is negative based on the vertical coordinate system z 1 fig 2 which starts from the interface between the uniform and penetration zones the momentum equation gives 12 τ z 1 ρ g s o 1 2 ρ c d m d z u 2 0 considering the solvability of the analytical solution of the governing equation the classic 2 order closure formula is adopted 13 τ ρ k z 1 2 du d z 1 du d z 1 as du dz 1 0 in this zone the reynolds stress can be evaluated by 14 τ ρ k z 1 2 du d z 1 2 0 the governing equation can be expressed as follows by substituting eq 14 into 12 15 2 k 2 z 1 2 u z 1 2 u z 1 2 2 k 2 z 1 u z 1 2 g s o 1 2 c d m d 0 u 2 where 0 z 1 hp the power series method is adopted to solve eq 15 where the terms associated with the flow velocity can be expressed as 16 u n 0 a n z 1 n a 0 a 1 z 1 a 2 z 1 2 a 3 z 1 3 one can get 17 u z 1 n 1 n a n z 1 n 1 a 1 2 a 2 z 1 3 a 3 z 1 2 and 18 2 u z 1 2 n 2 n n 1 a n z 1 n 2 2 a 2 6 a 3 z 1 12 a 4 z 1 2 adopting the power series method by substituting eqs 12 18 into 15 gives 19 2 k 2 z 1 2 n 1 n a n z 1 n 1 n 2 n n 1 a n z 1 n 2 2 k 2 z 1 n 1 n a n z 1 n 1 2 g s o 1 2 c d m d 0 n 0 a n z 1 n 2 compare the item z 1 n n 0 1 2 3 for both sides of the eq 19 one can get the following eqs 20 23 20 g s o 1 2 c d m d 0 a 0 2 21 2 k 1 2 z 1 a 1 2 1 2 c d m d 0 2 a 0 a 1 z 1 22 2 k 1 2 z 1 2 6 a 1 a 2 1 2 c d m d 0 z 1 2 2 a 0 a 2 a 1 2 23 2 k 1 2 z 1 3 8 a 2 2 12 a 1 a 3 1 2 c d m d 0 z 1 3 2 a 0 a 3 2 a 1 a 2 then 24 a 0 u 0 2 g s o c d m d 0 25 a 1 1 2 c d m d 0 k 1 2 u 0 26 a 2 1 40 c d m d 0 k 1 2 2 u 0 27 a 3 1 4400 c d m d 0 k 1 2 3 u 0 the solution of velocity profile 0 z 1 h p gives 28 u p u 0 1 ϕ 1 2 ϕ 1 2 40 ϕ 1 3 4400 where u0 is 29 u 0 2 g s o c d m d 0 which is suitable for zones with a du dz 0 and the key parameter gives 30 ϕ 1 c d m d 0 k 1 2 z 1 2 2 2 spherical canopy layer for flow in the canopy layer there are several models for reynolds stress such as 1st and 2nd models adopting boussinesq s eddy viscosity concept and kármán prandtl mixing length theory considering the solvability of momentum eq 3 when dealing with spherical morphology of canopy the exponential form of reynolds stress dijkstra and uittenbogaard 2010 huai et al 2013a shimizu et al 1991 is adopted with improvement in the canopy layer gives 31 τ ρ u w ρ u w z c h c exp η z c h c where zc is calculated from the interface between uniform velocity zone and penetration velocity zone fig 2 η is a constant that can be determined later and u and w are the temporal fluctuations from the means of longitudinal and vertical velocities respectively this formula indicates that the shear stress reaches its maximum value at the vegetation top zc hc from the momentum balance of the flow above the vegetation the interfacial shear stress between the vegetation and free water layers can be obtained by yang and choi 2010 32 ρ u w z c h c ρ u 2 where u g s o h s is the shear velocity at the top of the plant and hs is the water depth above the vegetation top i e hs hw hv from eqs 31 and 32 the reynolds shear stress yields 33 τ ρ u 2 exp η z c h c for spherical canopies the shape function can be built according to the frontal direction along with the vertical direction which can be expressed as a function of zc i e dz zc then uc can expressed as 34 u c 2 η g s o h s exp η z c h c 2 g s o c d m d z therefore the velocity profile in this canopy layer is derived when all the parameters are determined which will be discussed in the next section 2 2 3 surface layer in the surface layer where there are no vegetation drag components the momentum equation gives 35 τ z s ρ g s o 0 and reynolds stress adopts 2nd order scheme 36 τ ρ k z s 2 du d z s 2 where zs is calculated starting from the plane where the boundary vortex can penetrate into the canopy layer fig 2 which is located behind the vegetation with a distance of hsp the subscript sp denotes the penetration of the surface layer this plane is treated as the modified zero plane displacement and the mixing length is calculated based on zs by adopting the analytical solution the analytical velocity profile in the surface layer can be derived as follows 37 u s 2 g s o k s h ssp z s h ssp arctanh h ssp z s h ssp c 1 where the function arctanh is inverse hyperbolic tangent defined as 38 artanh δ 1 2 ln 1 δ 1 δ and 39 h ssp h s h sp the parameters hssp and c 1 in eq 37 can be determined by two boundary conditions 1 the velocity in the canopy top equals the one in the bottom of the surface layer 40 u s z s h sp u vtop where uvtop is the velocity at vegetation top 2 the derivative of the velocity is zero at the water surface 41 u s z s z s h ssp 0 3 experiments 3 1 experimental setup experiments were conducted in a 16 m long 0 5 m wide and 0 5 m deep glass made flume the bottom slope of the sink is 0 001 in the laboratory of applied hydraulics department of water resources and environmental engineering national technical university of athens greece in the experiment process the inlet valve and electromagnetic flowmeter control the flow and the end of the tank is installed with a thin wall gate that can adjust the height to control the water depth the water flow can be regarded as a steady uniform flow the experimental setup is shown in fig 3 3 2 vegetation arrangement the vegetation canopy was approximately spherical to simulate the dense vegetation group fig 4 the elements of the vegetation model were composed of rigid strips and plastic balls where the rigid strip simulated the vegetation stem and the plastic balls indicated a dense canopy zhao et al 2018 this simulated vegetation model is 8 cm in height where the stem height hstem 5 cm stem diameter do 0 8 cm and ball diameter d 0 hc 3 cm the vegetation area is 6 m long 0 5 m wide with a vegetation spacing of 10 cm 10 cm the vegetation area is 5 m from both the front and the end of the flume x direction is defined as the flow direction y direction as the lateral direction z direction as the vertical direction and the origin of the coordinates is 4 m from the front edge of the vegetation area the adv measurement area is centrally located 4 m downstream from the beginning of the vegetation the vertical measurement line was mainly distributed between the four vegetation plants the experiment uses micro adv acoustic doppler velocimeter measurements micro adv is often used for laboratory scale three dimensional flow velocity field measurements and its working principle is based on the doppler effect when the signal is emitted from the generator and encounters a moving object the signal is reflected and the frequency of the reflected back acoustic wave and the original signal frequency will have a the three signal receivers at the front of the adv probe are oriented to intersect in an area that is the flow rate test area which is a cylinder of 5 6 cm in height and 4 5 mm in diameter the generator is arranged in the middle of the three probes and the micro adv emits three beams of 16 mhz frequency through the transmitting transducer which are conducted through the water body and reach the sampling point 5 cm away from the transmitting transducer and are reflected back by the tracer particles and other particles in the water body since the spatial resolution of the micro adv sampling point is 4 5 mm the sampling point is required to be at least 10 mm away from the side wall to avoid overlap between the sampling point and the wall the first sampling point in the near wall area is at a minimum distance of 5 mm from the bottom of the sink in this experiment and the second point is 10 mm away from the wall to minimize the influence of the flume walls on the measurements and to ensure that the flow is fully developed and turbulent the adv measurement area was located 4 m downstream of the entrance to the vegetated area where turbulence was fully developed by experimental measurements each measurement line was sampled at 25 hz with a sampling time of 120 s for each measurement point for a total of 3000 the layout of the vertical measurement lines is shown in figs 5 and 6 in this paper the velocity values of these lines were averaged for the same depth in order to validate the analytical velocity model a total of four more typical working conditions were selected for the experiments with experimental flow rates of 22 42 40 94 l s reynolds numbers of 44533 81313 and froude numbers of 0 115 0 433 for subcritical flow the experimental parameters of each working condition are shown in table 1 with a certain vegetation density and mainly varying flow rate and water depth 4 results and discussions 4 1 parameter determination for a canopy with spherical morphology the shape function represents the variation in the frontal width of the canopy for a single plant along the vertical direction for the vegetation modeled in the experiments where the canopy is spherical the shape function can be expressed as 42 d z 2 d 0 2 4 z c d 0 2 2 where zc was calculated in the canopy layer fig 2 this function shows that the canopy width first increased and then decreased along the vertical direction for the canopy layer this situation is more complicated than previous experiments with uniform width or width with monotonically increasing characteristics liu et al 2012 wang et al 2019 wang et al 2015 for the velocity in the stem layer the key issue is to determine the vortex penetration depth for simplified cylinder vegetation nepf et al 2007 proposed a penetration length scale for a submerged canopy 43 δ e 0 23 c d m d 0 the stem diameter is used here for the stem layer however this formula may not be applicable to vegetation with complex conditions owing to the different stages of vortex development huai et al 2014 modified this penetration formula with an adjustable parameter ƞ for vegetation with different height combinations giving a new penetration length scale as follows 44 δ e ω c d m d 0 the parameter ω 0 02 for a double layer vegetation array with two heights which is much shallower than vegetation with a single height for the vegetation with spherical canopy adopted here this parameter may be smaller for canopy sheltering effect because the vortex becomes harder to develop into the stem layer by regression the best value for this parameter is obtained as ω 0 009 with a drag coefficient cd 1 13 which is commonly adopted by many research groups dunn et al 1996 huai et al 2013a li and shen 1973 lópez and garcía 2001 yang and choi 2009 for reynolds stress the exponential formula is adopted which has been used by several research groups with an adjustable parameter ƞ dijkstra and uittenbogaard 2010 huai et al 2013b shimizu et al 1991 gives 45 η c d m d 0 03 h w h v which is derived from experiments adopting simplified cylinders but is not suitable for vegetation with a spherical canopy as our study is the first to address vegetation with spherical shape we try to build a new empirical formula to determine the parameter ƞ as the reynolds stress in the canopy layer is both affected by surface layer and stem layer it is natural to associate the parameter ƞ with the velocity gradient ω 46 ω u v u min δ z where uv is the velocity at the vegetation top u min is the minimum velocity in the canopy layer and δz is the vertical distance between these two velocities then an empirical formula for ƞ is proposed by regression 47 η 1 8613 ω 1 173 the comparison between the measured data and the prediction of eq 47 is illustrated in fig 7 the correlation coefficient is 0 95 indicating this equation is suitable for calculating the parameter ƞ for the adjusted kármán coefficient in the canopy layer please note this adjusted kármán coefficient is not equal to 0 41 due to presence of vegetation the best fitting value is 0 16 here which is in the range of 0 12 0 33 derived from wang et al 2015 who showing its effectiveness in the analytical solution for the surface layer the traditional kármán constant of 0 41 is adopted for the new zero plane displacement hsp which can be proportional to the thickness of the surface layer the value of 0 04 m is adopted for runs 1 2 and value of 0 06 m is used for runs 3 4 all parameters used in this analytical solution are listed in table 2 4 2 models verification analytical predictions can be calculated using several equations as follows 1 the velocity of the stem layer is calculated by eq 11 uniform velocity zone and eq 28 penetrated velocity zone 2 the velocity of the canopy layer is calculated by eq 34 3 the velocity of the surface layer is calculated by eq 37 as penetration is common for the fast flow layer into the low flow layer 10 of the stem layer is penetrated by the canopy layer fig 8 shows the comparison between the measured and predicted velocities for each case where good agreement indicates that the newly proposed analytical models are effective for predicting velocity in flow through vegetation model with spherical canopy comparison between calculated and measured data for all four runs is shown in fig 9 it can be seen that the new analytical model perform excellent for vegetation with canopy in flow 4 3 model comparison from fig 8 it can be seen from the measured velocity profile that a minimum velocity in the canopy layer is observed which is different from the velocity profile in flow with simplified cylinder vegetation in flow through simplified cylinder vegetation the velocity increases along the vertical position which is a common phenomenon found in previous research aberle and järvelä 2013 dunn et al 1996 katul et al 2011 poggi et al 2009 compared with formulae of previous model 1 and model 2 the new proposed model has the best accuracy fig 10 the accuracy of velocity model can be evaluated by taylor diagram taylor 2001 using standard deviation sd centered root mean square difference rmsd and correlation coefficient r a comparison of the simulated and measured values for each experimental condition is given in table 3 and fig 11 it can been seen that the newly proposed model performs best for all four runs for vegetation with different shapes some research groups have conducted studies to investigate the flow resistance and velocity models rubol et al 2018 proposed a universal scaling law for flow resistance over canopies with various morphologies and analytical velocity solutions have been proposed where the velocity increases monotonically along the vertical direction with this feature of the velocity solution their models cannot be applied to the experiments here to conclude previous models have several limitations and cannot be directly applied to the vegetation with spherical canopy for the newly proposed models the shape function of eq 42 can be changed to another form according to the vegetation we consider indicating a larger range of application of the newly proposed analytical models compared with that of previous analytical models 5 limitation although the newly established analytical solution model can predict well the flow movement under the influence of vegetation forms some limitations remain to be addressed in future studies the parameters established in our study were determined using a limited number of experimental conditions consequently the empirical formulas that we established were based mainly on the vegetation morphology used in the experiments i e this paper mainly provides a method for calculating water flow under vegetation with spherical canopy for different vegetation morphologies parameters such as the adjusted kármán coefficient and penetration depth require modification with further investigation for our experiments we selected a solid ball to simulate a very dense canopy further research should be conducted to determine flow velocity distribution for different vegetation sizes with different canopy densities therefore when solving the governing equations to derive the velocity solution canopy permeability indicating different sparse dense canopies can be inserted to further improve the analytical model of velocity distribution 6 conclusion this study focuses on building analytical solutions for flow through vegetation a more detailed stratification method is proposed and a complete set of analytical solution models of velocity distribution is proposed based on different mathematical methods such as the power series mathematical solution exponential reynolds stress model calculation method and inverse hyperbolic tangent mathematical calculation method by comparing the experimental data with model calculations the validity of the model proposed in this study is verified the main conclusions are summarized as follows 1 according to the vegetation shape the flow regime is divided into stem canopy and surface layers the governing equation was established according to the force analysis considering that the width of the canopy first increased and then decreased in the vertical direction the velocity distribution formulas of different layers were linked together to show the velocity distribution of the entire water depth in addition the relative parameters of the analytical solutions are discussed 2 the stem layer is divided into two zones one is the uniform velocity zone at the bottom of the stem layer this is due to the influence of viscosity and the reynolds stress in this area can be ignored leading to an approximately uniform velocity distribution in the upper part of the stem layer the penetration depth is formed owing to the influence of the high speed flow in the upper layer the velocity in this zone can be derived based on a new power series solution 3 for the canopy layer the change in the width of the vegetation canopy in this layer can be accurately considered because the exponential reynolds stress was adopted in the governing equation with the accurate shape function for the frontal with of the canopy the distribution of flow velocity in this layer can be obtained by solving the governing equation analytically the advantage of adopting the exponential reynolds stress into governing equation is that it is not necessary to fit the shape of the vegetation canopy in a fixed mathematical form therefore the shape function can more closely represent the real conditions and the calculation results of the flow velocity are more accurate 4 for the surface layer a new analytical solution of the velocity distribution in the form of an inverse hyperbolic tangent function is obtained by using the second order reynolds stress expression method which is a new expression for the velocity distribution of the free water layer and provides a new idea for enriching the expression method of the velocity movement of the free water layer 5 from the experimental data it was found that the flow velocity has a minimum value near the bottom of the canopy layer and the existing analytical solution model could not capture and display this flow velocity distribution in this study a new calculation method for the analytical velocity distribution is proposed which is fully consistent with the characteristics of velocity moreover for future studies on other types of vegetation the shape function can be changed directly without having to consider the solvability of the governing equation with exponential reynolds stress which is one of the important advantages of this model enriched environmental fluid mechanics in the vegetated flow providing a solving framework for subsequent simulation of flow through various shapes of vegetation credit authorship contribution statement wei jie wang conceptualization methodology investigation software writing original draft writing review editing fang zhao investigation software writing review editing aristotelis mavrommatis investigation george christodoulou investigation anastasios stamou investigation feng cong jia writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors acknowledge the support of the national key research and development program of china 2021yfc3200903 the national natural science foundation of china 51809286 the talent program of china institute of water resources and hydropower research we0199a052021 and the national water pollution control and treatment science and technology major project of china 2018zx07105 002 
2057,the hillslope and channel dynamics that govern streamflow permanence in headwater systems have important implications for ecosystem functioning and downstream water quality recent advancements in process based semi distributed hydrologic models that build upon empirical studies of streamflow permanence in well monitored headwater catchments show promise for characterizing the dynamics of streamflow permanence in headwater systems however few process based models consider the continuum of hillslope stream network connectivity as a control on streamflow permanence in headwater systems the objective of this study was to expand a process based catchment scale hydrologic model to better understand the spatiotemporal dynamics of headwater streamflow permanence and to identify controls of streamflow expansion and contraction in a headwater network further we aimed to develop an approach that enhanced the fidelity of model simulations yet required little additional data with the intent that the model might be later transferred to catchments with limited long term and spatially explicit measurements this approach facilitated network scale estimates of the controls of streamflow expansion and contraction albeit with higher degrees of uncertainty in individual reaches due to data constraints our model simulated that streamflow permanence was highly dynamic in first order reaches with steep slopes and variable contributing areas the simulated stream network length ranged from nearly 98 2 of the geomorphic channel extent during wet periods to nearly 50 10 during dry periods the model identified a discharge threshold of approximately 1 mm d 1 above which the rate of streamflow expansion decreases by nearly an order of magnitude indicating a lack of sensitivity of streamflow expansion to hydrologic forcing during high flow periods overall we demonstrate that process based catchment scale models offer important insights on the controls of streamflow permanence despite uncertainties and limitations of the model we encourage researchers to increase data collection efforts and develop benchmarks to better evaluate such models keywords streamflow permanence expansion and contraction modeling hydrologic connectivity data availability data will be made available on request 1 introduction streamflow permanence defined as the frequency magnitude duration and timing of surface streamflow presence in headwater streams impacts ecosystem function and downstream water quality wohl 2017 headwater streams account for approximately 53 of total river network length in the united states nadeau and rains 2007 providing services such as runoff storage nutrient retention and regional biodiversity boulton 2014 datry et al 2018 colvin et al 2019 these networks expand and contract as a function of interacting hydrologic forcings hillslope stream network connectivity and structural watershed properties bracken et al 2013 wohl 2017 ward et al 2018 durighetto and botter 2022 importantly streamflow permanence dictates habitat suitability for a variety of freshwater taxa such as benthic macroinvertebrates clarke et al 2010 karaouzas et al 2019 and fish davey and kelly 2007 which exhibit varying tolerances for stream channel wetting and drying characterization of streamflow permanence in headwater systems remains elusive despite the recognized services such systems provide for the entire river network koundouri et al 2017 colvin et al 2019 ruiz et al 2021 this is largely attributed to scarce data on and mapping of headwater systems poff et al 2006 which has led to their limited federal protection under the clean water act cwa e g creed et al 2017 quantification of the watershed scale function of headwater systems is one way to enhance their protection johnson et al 2010 and this approach would benefit from the improved understanding of streamflow permanence dynamics at the catchment scale the presence or absence of streamflow in headwater streams results from multi scale multi dimensional hydrologic processes hammond et al 2021 shanafield et al 2021 botter et al 2021 empirical studies focused on understanding streamflow permanence have made significant strides in elucidating the mechanisms of streamflow expansion and contraction see review in senatore et al 2021 these include the use of biological and physical indicators as surrogate measures of hydroperiod classification e g perennial intermittent ephemeral see review in fritz et al 2020 repeated mapping of the flowing extent of the stream network e g godsey and kirchner 2014 whiting and godsey 2016 jensen et al 2017 shaw et al 2017 zimmer and mcglynn 2017 lovill et al 2018 meerveld et al 2019 durighetto et al 2020 senatore et al 2021 and implementation of highly instrumented networks of flow state sensors goulsbra et al 2014 zimmer and mcglynn 2017 jensen et al 2019 kaplan et al 2020 botter et al 2021 to understand streamflow expansion and contraction prancevic and kirchner 2019 flow state sensors measure the presence or absence of surface water and when strategically placed within riffles can infer the presence or absence of streamflow i e flowing or not flowing fritz et al 2006 furthermore extensive literature has leveraged long term discharge measurements to derive hydrologic metrics that have been used to classify streamflow duration throughout the united states and europe see review in christensen et al 2022 such field based methods from highly instrumented and studied catchments are the most reliable measures of the extent of surface streamflow within headwater systems jensen et al 2018 which in essence is the response variable of connectivity from upstream surface and subsurface pathways e g godsey and kirchner 2014 statistical and analytical models built from measured data have also been used to classify flow permanence and the extent of perennial intermittent and ephemeral streams svec et al 2005 russell et al 2015 villines et al 2015 jensen et al 2018 jaeger et al 2019 botter and durighetto 2020 durighetto and botter 2022 durighetto et al 2022 despite the reliability of these empirical methods to classify streamflow permanence they face challenges pertaining to data acquisition transferability and projection of dynamics beyond the measured data godsey and kirchner 2014 ward et al 2018 for example mapping the flowing extent of the stream network is infeasible over large areas and repeated field surveys are often time prohibitive recent advancements in process based hydrologic models show promise for characterizing streamflow permanence in headwater systems and overcoming the logistical limitations of empirical classification methods williamson et al 2015 ward et al 2018 ward et al 2020 process based models simulate fluxes and storage of water over spatiotemporal scales that are often difficult to measure in the field thus facilitating investigation of dynamics and controls of hydrologic processes at scales that otherwise would not be possible albeit with some degree of uncertainty clark et al 2015b ward et al 2018 recently developed a reduced complexity process based modeling framework that considers in stream continuity and net upwelling and downwelling processes to simulate high resolution dynamics of streamflow expansion and contraction longitudinally along the stream network williamson et al 2015 used a regional topmodel approach beven and kirkby 1979 and the saturation deficit representing soil water storage within catchment hillslopes to predict landscape units with surface streamflow present findings from both studies demonstrate the efficacy of using process based models to estimate streamflow permanence the spatial and temporal trends of streamflow expansion and contraction and controls of hydrologic connectivity within headwater networks these studies resulted in new methods to simulate headwater stream network extent however to our knowledge few studies consider hillslope stream network connectivity within a process based hydrologic modeling context for example several studies treat lateral inflow as an area weighted fraction of the outflow from the catchment godsey and kirchner 2014 ward et al 2018 prancevic and kirchner 2019 which does not consider the within hillslope and hillslope stream network connectivity that affects variability of streamflow permanence in first and second order reaches bracken et al 2013 shanafield et al 2021 furthermore models that simulate hillslope hydrologic connectivity such as dynamic topmodel beven and freer 2001 and the visualizing ecosystems for land management assessment velma model abdelnour et al 2011 do not include subroutines to simulate longitudinal hydrologic connectivity or streamflow permanence the improved simulation of the dynamics of streamflow permanence currently is limited by a number of uncertainties namely verifying model fidelity is a well known challenge with process based hydrologic models because continuous channel monitoring in both space and time is rare and often requires increased data collection to reduce uncertainty of simulations stadnyk et al 2013 furthermore such high resolution models are often over parameterized and computationally burdensome using hydrologic response units hrus to group landscape components behaving in a hydrologically similar manner and calculating transport at the reach scale i e on the order of tens to hundreds of meters may reduce required input data and model run times while retaining important information regarding reach scale streamflow permanence further leveraging data collected on moderately and highly instrumented headwater networks is a viable yet unharnessed approach to reduce equifinality of streamflow permanence simulations the objective of this study was to develop a process based catchment scale hydrologic model to investigate the spatiotemporal dynamics of headwater streamflow permanence and identify controls of headwater streamflow expansion and contraction we apply the model to a headwater catchment on the central appalachian plateau in kentucky united states usa a site with adequate data to simulate streamflow permanence yet less spatial and temporal hydrological monitoring and instrumentation than long term catchment study sites e g goulsbra et al 2014 senatore et al 2021 therefore we provide a framework from which to upscale simulated streamflow permanence to larger watersheds and regions throughout the united states that typically have limited available data in headwaters our model also explicitly considers within hillslope connectivity similar to williamson et al 2015 hillslope stream network connectivity and interactions between the surface stream and subsurface permeable zone similar to ward et al 2018 we investigate the spatiotemporal dynamics and controls of headwater streamflow permanence with maps showing the variability of surface streamflow and timeseries of the flowing stream length within the catchment our approach characterizes headwater streamflow permanence using a process based hydrologic model at the reach and catchment spatial scale as opposed to upwelling and downwelling of individual features at sub meter spatial scales which may assist with quantifying the function of headwater streams within larger watersheds creed et al 2017 2 study site and materials 2 1 study site the falling rock catchment 0 96 km2 is a moderately well monitored headwater system in the university of kentucky s robinson forest located on the central appalachian plateau of kentucky u s a fig 1 the system is used as a control basin for silviculture management experiments and has been relatively undisturbed since the early 1900s when timber was last harvested in the catchment overstreet 1984 land use in falling rock is almost entirely second growth forest with an overstory consisting of primarily hardwood trees e g oak quercus sp hickory carya sp yellow poplar liriodendron tulipifera american beech fagus grandifolia moriarty and mccomb 1985 phillippi and boebinger 1986 climate is classified as temperate humid with mean annual rainfall equal to 1121 mm sena et al 2021 minimum and maximum temperature ranges between 5 c and 8 c in the winter and 17 c and 31 c in the summer elevation ranges between 294 m and 459 m above sea level navd 88 fig 1b and d the study period spanned from approximately december 1 2003 until september 30 2006 robinson forest received 1 490 mm of precipitation in 2004 1002 mm in 2005 and 1156 mm in 2006 thus this study spans a relatively wet year a relatively dry year and a year with approximately average precipitation the depth of the soil above bedrock is estimated to be less than 1 0 m surrounding streams and to range between 0 7 m and 2 2 m on hillslopes fritz et al 2008 fig 1a soils are shallow and well drained sloan et al 1983 williamson et al 2015 with saturated hydraulic conductivities estimated to range between 0 02 and 0 50 m hr 1 catchment lithology consists primarily of sandstone shale and siltstone fig 1c kentucky geological survey 1998 surface streamflow responds rapidly to precipitation which is largely attributed to the presence of subsurface macropore pathways shallow depths to confining bedrock and steep hillslopes williamson et al 2015 consequently little overland runoff has been observed on hillslopes in this region mahoney et al 2021 the topography of falling rock is classified by steep dissected hillslopes and a dendritic drainage network stream slopes span nearly an order of magnitude table s1 with flattest slopes in higher order reaches and steepest slopes in first order reaches 2 2 materials used to simulate streamflow permanence falling rock was chosen for this study because of its relative abundance of data dating from 1971 a substantial collection compared to catchments with limited or no hydrologic instrumentation in the region the ecology and geomorphology of perennial intermittent and ephemeral reaches have been described and modeled in falling rock via a number of field and modeling investigations cherry 2006 mapped the extent of perennial and non perennial reaches within the catchment fig 1c using methods developed by fritz et al 2006 several studies have classified flow duration and perennial intermittent and ephemeral extent of streams within falling rock using models svec et al 2005 villines et al 2015 williamson et al 2015 fritz et al 2008 surveyed physical and biological indicators of streamflow permanence including stream morphology sediment properties habitat and bioassessments discharge and water quality johnson et al 2010 used a similar dataset to investigate the downstream effects of headwater stream disturbance locally collected environmental datasets were used to either parameterize or evaluate our model beginning in 1971 precipitation and air temperature were measured with weighted buckets strip charts and thermometers until being replaced with tipping buckets and electronic data loggers in 2005 sena et al 2021 weather stations were installed at the ridge and bottom of falling rock and approximately 2 5 km to the southwest camp weather station of the watershed outlet see fig 1c potential evapotranspiration rates were estimated using temperature data an estimate of daylight length and the hamon 1961 formula which was previously implemented to simulate pet in falling rock by williamson et al 2015 further williamson and barton 2020 corroborated findings from lu et al 2005 using the hamon formula further supporting its use herein we used data primarily collected from camp weather station to drive the model due to gaps in data at the weather stations located within falling rock during the study period catchment morphologic properties were quantified using a 1 5 m digital elevation model dem fig 1d and table s1 kyaped 2014 morphometry data collected by fritz et al 2008 and regional regression analysis of stream bathymetry vesely et al 2008 discharge has been monitored at the catchment outlet using a v notched weir since 1971 sena et al 2020 flow state was recorded in four reaches see fig 1a identified by cherry 2006 as perennial fc1 intermittent fc2 and ephemeral fc3 fc4 between late 2003 and late 2006 using ecological indicators and an onset hobo flow state sensor onset submersible case and an encased cable fritz et al 2006 care was taken to position the flow state sensor in the thalweg of stream reaches in erosional riffle or run habitats representative of the reach with the logger contacts set within slotted stilling wells at the streambed surface several interruptions to data collection occurred due to sensor maintenance or malfunction which contributes to uncertainty of the stream dynamics observed and simulated in falling rock therefore it was necessary to additionally evaluate our model using qualitative estimates of hydroperiod from field maps and surveys as well as biological assessments cherry 2006 fritz et al 2006 which inherently manifest from system dynamics available flow state and discharge data used to validate the model are shown in fig s1 additional flow state data were collected in the catchment between 2011 and 2012 williamson et al 2015 but were not used herein since little variability of flow state was observed in falling rock during this period most sensors reported wet conditions and given computational constraints of running the model for approximately 10 years falling rock was chosen for study over other highly instrumented headwater networks e g goulsbra et al 2014 ward et al 2020 for several reasons although not extensively published or instrumented like other headwater catchments and watersheds throughout the western united states and europe e g goulsbra et al 2014 senatore et al 2021 the catchment has flow data on small perennial intermittent and ephemeral streams dating back to the 1970s including continuous discharge gage data flow state data at multiple locations as well as maps and surveys of the extent of perennial intermittent and ephemeral streams streamflow permanence descriptions in this catchment have been related to ecological niches providing an additional means of model validation fritz et al 2013 falling rock is therefore one of the most instrumented and studied watersheds in the central appalachian ecoregion of the united states sena et al 2021 and few studies to our knowledge contain the necessary data to simulate models to investigate streamflow permanence in this region williamson et al 2015 this paucity of headwater modeling studies in central appalachia gives credence to choosing falling rock as the study site given 1 the importance of appalachian headwaters for structuring habitats and biodiversity price et al 2012 drayer and richter 2016 and 2 the enhanced vulnerability that such systems face due to widespread land use change from strip mining and timber harvest as well as climate change zégre et al 2013 witt et al 2016 williamson barton 2020 furthermore falling rock is nested within a larger headwater network that contains streamflow permanence data and discharge data in this regard we considered the study catchment to be an ideal testbed to develop a process based hydrologic model that requires relatively low data inputs yet can be leveraged to simulate streamflow permanence by focusing on model fidelity at the reach scale further application of the model to falling rock will facilitate future comparisons of streamflow expansion and contraction in catchments with variable structural watershed configurations and limited long term high spatial and temporal resolution streamflow permanence measurements 3 methods 3 1 model formulation we utilize dynamic topmodel to simulate hydrologic fluxes and connectivity from hillslopes to the stream network see reviews of dynamic topmodel in beven and freer 2001 beven 2011 metcalfe et al 2015 dynamic topmodel is a process based hydrologic model that simulates hillslope hydrology using the variable upslope contributing area approach building upon its widely applied predecessor topmodel beven and kirkby 1979 by incorporating an additional parameter s d max to represent disconnectivity of upland hillslope units during periods of extensive drying and abandoning the original assumption of a quasi steady water table metcalfe et al 2015 dynamic topmodel solves a time varying mass balance to simulate the change in subsurface and lateral flow between hydrologic response units hrus as 1 s t q x r where s is the subsurface storage deficit q is the downslope flow per unit plan area and r is the recharge from the unsaturated zone lateral flow over the surface and through the subsurface is assumed in this study to follow the catchment topography which likely holds true in systems with relatively steep slopes and shallow soil depths beven 1997 albeit with some degree of uncertainty lateral connectivity to the stream network can be conceptualized using a weighted flow matrix which maintains the structural contiguity of the hillslope by representing the proportion of flow from one landscape unit that flows into downstream landscape units as discussed in beven and freer 2001 and metcalfe et al 2015 this matrix is defined as 2 w p 11 p 1 n p ij p n 1 p nn where each element of the matrix represents a landscape unit assumed to behave in a hydrologically similar manner i e an hru and i represents the hru which contributes flow to receiving hru j the sum across columns is equal to unity which represents the total flow from hru i that is redistributed downstream such that j 1 n p ij 1 and p ij is the fraction of flow out of hru i that redistributes to hru j or alternatively stream reach j the fraction of flow that is redistributed from one hru to another represents the structural connectivity of an hru to a receiving landscape unit p ii thus represents the fraction of cells with a given hru designation that flow downstream to a cell with the same hru designation as the upstream cell in this regard a portion of hru flux will be redistributed to the same hru which reflects the downslope transfer of water through the hru until reaching the boundary with another hru or the stream network in catchments where flow follows topography it is assumed that the fraction of flow redistributed to a downstream hru is equal to the areal fraction of landscape units directly downstream of the hru this is expected to hold true in the study catchment but is one limitation of the approach used herein elements along the diagonal of the matrix represent landscape units that flow into downstream landscape units with the same hru designation it is expected that weighting matrices will shift over geomorphic decadal timescales but will be constant at yearly timescales wainwright et al 2011 the matrix may be parameterized using a flow direction raster as discussed in section 3 3 water is passed from upstream to downstream hrus using a kinematic wave routing approach metcalfe et al 2015 until flow from upland hrus exfiltrates into the stream network inflow to a reach for a specific timestep is equal to the sum of flow entering the reach from upstream hillslope hrus which considers the unique upstream contiguity of the hillslope as well as flow entering from upstream reaches as 3 q tota l i j q la t i j q u p i j where q tota l i j is the total amount of flow in a unique reach j during a specific time step i q la t i j is the total amount of flow entering the reach from uniquely connected hrus as defined by eq 2 and q u p i j is the flow entering reach j from an upstream reach during a time step in this regard at the most upstream end of the stream network q up is expected to be nil because there are no upstream reaches flow is then routed to downstream reaches as described in section 3 2 while dynamic topmodel is well recognized to adequately simulate hydrologic fluxes on hillslopes the instream routing component is not currently equipped to simulate streamflow permanence in headwater reaches and we have modified the model to include this feature we conceptualize surface streamflow permanence by building off of findings from both field based and modeling studies from godsey and kirchner 2014 ward et al 2018 prancevic and kirchner 2019 and durighetto and botter 2022 fig 2 adapted from beven and freer 2001 ward et al 2018 wherever the total discharge supplied from upstream sources i e upstream reaches and lateral hillslopes is greater than the subsurface transport capacity of the permeable zone coincident with the geomorphic stream channel surface flow is possible this is written as a binary probability as 4 p f i j 1 q tota l i j q sub c j 0 q tota l i j q sub c j where i and j represent a unique temporal and spatial step respectively p f represents the probability of streamflow presence within a reach equal to 1 if surface streamflow is present 0 if surface streamflow is absent q total is the total discharge in a reach contributed from the hillslope and upstream reaches and q sub c is the subsurface capacity of the permeable sediment and bedrock surrounding the geomorphic stream channel in a particular reach q sub c is conceptualized to be a reach dependent structural watershed property that represents the total amount of subsurface flow that the reach can carry prior to streamflow emerging at the surface in this regard the model implicitly accounts for upwelling downwelling assuming that if the amount of flow in a reach during a time step is less than the q sub c j threshold then downwelling occurs otherwise upwelling will occur in the reach we expand upon this assumption in section 3 2 the subsurface capacity of the permeable zone is conceptualized using the darcy equation similar to several recent field based studies e g godsey and kirchner 2014 prancevic and kirchner 2019 as 5 q sub c j t j s j and 6 t j a j k j where j is the reach t is the subsurface transmissivity l 3 t 1 s is the slope of the hydraulic gradient of the reach assumed to be equal to its slope l l 1 a is the cross sectional area of the permeable zone l 2 and k is the hydraulic conductivity of the permeable zone l t 1 the total flowing length of the surface stream network during a timestep l to t i is thus the sum of the total number of reaches within the catchment which are predicted to have surface streamflow multiplied by the length of the active reaches as 7 l to t i j 1 m p f i j l j where l j is the length of stream reach j and m is the total number of reaches in the catchment the underlying assumptions utilized to formulate these equations have largely been informed by empirical data previously collected by others and analytical models applied in headwater catchments where streamflow permanence was monitored or simulated at relatively high temporal resolutions e g goulsbra et al 2014 ward et al 2016 prancevic and kirchner 2019 durighetto et al 2022 3 2 model application this version of dynamic topmodel parameterizes several surface and subsurface storage zones to represent transport of water between an hru and downstream landscape units beven and freer 2001 these include the root zone unsaturated zone saturated zone and an excess storage zone to represent overland flow fig 2 during instances of prolonged drying it is assumed that upstream hrus may be disconnected from downstream hrus or the stream network when storage in the saturated zone is less than the s d max parameter a kinematic wave approximation is then used to estimate the flux of water exiting the saturated zone of the hru as total base flow metcalfe et al 2015 overland flow is routed to downstream landscape units similarly to base flow with the possibility to reinfiltrate if the capacity of the downstream subsurface store is not filled i e the saturation deficit is greater than zero at the end of the simulation a water balance check is conducted to ensure that the hydrologic outputs match inputs metcalfe et al 2015 an overview of dynamic topmodel its implementation and its limitations are given in the si with more in depth information found in beven and freer 2001 and metcalfe et al 2015 we modified the source code of dynamic topmodel to explicitly define connectivity from hillslopes to individual reaches route flow from individual reaches to the outlet of the catchment and simulate whether surface streamflow was present or absent in each reach discharge is routed to the catchment outlet by first defining strahler order within each reach and sequentially routing flow from first order reaches to sequentially higher order reaches using either a network width approach beven 2011 or a finite difference kinematic wave approach e g ward et al 2018 depending on the user s specification within each reach total discharge is uniquely calculated as the sum of discharge from upstream reaches and lateral inflow from the hillslope the model compares the total discharge in an individual reach to the estimated subsurface capacity of the reach to simulate the presence or absence of surface streamflow as shown in eq 4 surface streamflow presence absence is estimated for each reach within falling rock for each timestep which is discussed below we do not separate total flow into subsurface and surface flow in the instream routing subroutine instead flow through the permeable zone is lumped with surface flow and thus upwelling downwelling is implicitly simulated as part of eq 4 and via the instream routing algorithm implemented herein while this is one limitation and source of uncertainty of our approach ward et al 2018 suggests that downstream flow in the surface stream is expected to be highly variable while flow through the subsurface permeable zone is controlled by the subsurface capacity of the reach thus subsurface flow is expected to be relatively constant in time but variable in space due to differences in reach morphology and saturated conductivity this simplification improved the computational efficiency of the instream routing subroutine thus allowing for more robust parameter uncertainty analysis 3 3 model parameterization we parameterized properties of the geomorphic stream network with several datasets the geomorphic stream channel defined here as the visibly identifiable network formed by channelized erosion and deposition godsey and kirchner 2014 was digitized with a 1 5 m digital elevation model and an area threshold approach within taudem tarboton 2005 we iteratively chose area thresholds such that the geomorphic stream network created with taudem closely matched the extent of perennial intermittent and ephemeral streams identified during field reconnaissance by cherry 2006 and fritz et al 2013 the geomorphic stream channel consisted of 3 154 m of first and second order reaches 70 of the total length table s1 we used the dynatopmodel package in r to parameterize the hillslope component of dynamic topmodel metcalfe et al 2015 we calculated contiguous topographic wetness indices twi beven and kirkby 1979 from a 1 5 m dem and combined these with landscape soil characteristics ssurgo u s department of agriculture natural resource conservation service 2012 to generate 20 hrus within falling rock fig s2 we iteratively adjusted the number of times each layer was discretized thus changing the number of hrus generated to ensure prominent landscape features were captured and to minimize the number of hrus generated to optimize model run times we additionally determined the total within hru sum of squares to estimate the variability of twi and soil of each hru beyond 20 hrus little variability of the landscape was captured by the discretization fig s3 average hru area was 0 05 km2 we routed water through the stream network using the network width approach similar to the implementation of dynamic topmodel specified in metcalfe et al 2015 we estimated slope and transmissivity of each reach to parameterize the subsurface transport capacity to simplify computational complexity and limit the number of additional parameters added to the model we initially assumed a constant subsurface transmissivity t within all reaches which was later calibrated while hydraulic conductivity and cross sectional area of the permeable zone are likely to vary within reaches at the catchment scale the constant t assumption should hold in systems where subsurface flow capacity varies as a linear function of reach slope prancevic and kirchner 2019 shanafield et al 2021 we emphasize that this assumption results in a fundamentally reduced complexity simulation of stream network dynamics similar to the approach of ward et al 2018 which may hinder the model s capacity to predict instream disconnectivity and system fragmentation while this assumption is one limitation of our approach as transmissivity likely varies from reach to reach our intention was to parameterize the subsurface using at least a reduced complexity approach rather than disregarding it completely given the previous data collection efforts in falling rock it would have been possible to calibrate a unique t for each stream order in this catchment however this would have added four new parameters to the model instead of one we initially parameterized the model with parsimony in mind rather than complexity which led to the choice of using a single t to simulate subsurface transmissivity future studies may parameterize subsurface capacity of the permeable zone explicitly after conducting field campaigns to measure saturated hydraulic conductivity and depth to bedrock within each reach the presence absence of surface streamflow was predicted in each reach using eq 4 for each time step after total flow and the subsurface capacity had been determined parameter ranges for the dynamic topmodel and instream routing model are recorded in table 1 we derived ranges for several parameters in table 1 from previous application of dynamic topmodel in headwater catchments beven and freer 2001 metcalfe et al 2015 these parameters described the overland flow velocity initial root zone storage channel routing velocity lateral saturated transmissivity maximum effective deficit of the saturated zone and unsaturated zone time delay manning s n values were chosen to represent the range from bedrock and heavily forested channels we used three parameters to simulate the exponential decline of conductivity in falling rock corresponding to the three soil types identified by the u s department of agriculture usda soil survey see fig 1 we extended the lower range of the m parameters defined in this study to better capture the behavior of the rapidly draining soils present in the catchment williamson et al 2015 previous studies have varied m between 0 and 0 1 beven 1997 suggesting that the range used herein is physically plausible we note that the addition of the surface streamflow presence absence subroutine only added one parameter to the model t which represented network wide transmissivity the range of potential t values was derived by determining the range of potential hydraulic conductivities 0 02 0 51 m hr 1 depths to bedrock 0 1 2 2 m and width of the valley bottom 2 0 10 0 m surrounding stream reaches from the usda soil survey and field reconnaissance u s department of agriculture natural resource conservation service 2012 fritz et al 2008 additional information on model formulation application and parameterization is included in the si our objective during model formulation application and parameterization was to discretize the model to simulate catchment scale discharge and surface streamflow presence absence to investigate trends in streamflow permanence over a three year study period to fulfill this objective while maintaining computational efficiency we ran the model at two hour time steps at the reach scale mean length equaled 137 m while upwelling downwelling of streamflow between the surface and subsurface flow is likely to occur at sub meter spatial resolutions and sub second temporal resolutions for example due to turbulent bursting ward et al 2016 using this fine scale temporal resolution for model parameterization would be computationally prohibitive for long term assessment of streamflow permanence within the stream network and would preclude model evaluation and uncertainty analysis thus we did not adopt this highly resolved approach our approach facilitated evaluation of the probability that each reach contained surface streamflow during the three year study period the discharge within reaches and the total stream network with surface streamflow for each time step of the study period at the cost of potentially being unable to capture sub reach scale disconnectivity and system fragmentation because this approach does not focus on simulated exfiltration upwelling or downwelling at a sub meter spatial resolution our simulations are instead representative of streamflow permanence processes at reach and longer spatial scales similar to the approach of ward et al 2018 we discretized our model to balance the assumptions of local scale runoff generation with the ability to apply the model at a catchment scale 3 4 model calibration and evaluation model calibration was carried out using discharge data at the outlet of the watershed to verify model accuracy clark et al 2015a and flow state sensor data collected in four reaches one perennial one intermittent and two ephemeral reaches coupled with maps and surveys of the extent of perennial intermittent and ephemeral reaches throughout the network to assess model fidelity clark et al 2015b holmes et al 2020 additional data in ephemeral tributaries would be required to more comprehensively evaluate the ability of the model to represent stream network dynamics however our objective with model calibration was to develop a model that could give reasonable flow estimates at the reach and catchment scale while simultaneously using adequate data to balance model fidelity and complexity keeping in mind our research questions we used a two stage calibration approach to evaluate discharge and flow permanence predictions in falling rock fig 3 the two stage approach assisted in verifying both model accuracy at the watershed outlet and model fidelity in lower order reaches e g clark et al 2015b holmes et al 2020 in the first stage of evaluation our objective function was to maximize the kling gupta efficiency kge score of the natural logarithm of two hour discharge simulations at the catchment outlet we used the natural logarithm of discharge to better capture variability of low flow periods during calibration given that such periods are critical for many ecosystem services in the central appalachian plateau e g price et al 2012 drayer and richter 2016 and stream drying during low flow periods helped define the hydroperiod of a stream reach shanafield et al 2021 realizations with kge score greater than 0 3 were considered behavioral which represents the midpoint between the kge calculated by the mean of the discharge time series kge 0 41 and a kge score where the simulation matches the observed data perfectly kge 1 knoben et al 2019 we chose a relatively low benchmark in stage one to better understand how variable hydrologic states as predicted with different model realizations impacted the prediction of streamflow permanence within falling rock estimates of reach scale discharge are used as inputs to stage two of model evaluation in the second stage of evaluation we calibrated the network wide transmissivity parameter t by minimizing the overall error between observed and predicted flow state at the four sites where flow state data were collected with sensors for each behavioral parameter set from stage one which included one reach classified as perennial one reach classified as intermittent and two reaches classified as ephemeral fc1 fc4 fig 1 fig s1b we did not classify model realizations as non behavioral in the second stage of evaluation since we were unable to find existing lower benchmarks to assess performance of streamflow presence absence and because the available data in falling rock only facilitated evaluation of our model in two ephemeral reaches stage two produced reach scale estimates of surface streamflow presence absence for each timestep and for each behavioral parameter set identified in stage one of calibration which we then visually compared to maps and surveys of the perennial intermittent and ephemeral extent of stream networks derived from field reconnaissance for additional verification cherry 2006 we then calculated the average flowing length of the network for each time step across behavioral parameterizations to account for potential uncertainty propagated from stage one of evaluation and uncertainty of subsurface transmissivity while these data may not be adequate to evaluate small scale exfiltration upwelling and downwelling processes we found these data facilitated the investigation of streamflow permanence in the catchment at the reach scale the scale at which our questions are relevant additional information on model evaluation is included in the si 4 results and discussion 4 1 model evaluation 4 1 1 simulated discharge evaluation comparison of simulated and observed discharge at the watershed outlet indicated that the model predicted discharge relatively well throughout the study period model evaluation identified 454 parameter sets as behavioral with the optimal parameterization having a kge value of 0 78 fig 4 a and b see optimal parameter values in table 1 the p factor and r factor of the 95 percent parameter uncertainty ppu were 0 67 and 0 47 respectively suggesting adequate model performance dotty plots see fig s4 for the dynamic topmodel parameters shown in table 1 indicated that simulated discharge was sensitive to the exponential decline in conductivity and maximum root zone storage parameters which is consistent with findings from previous topmodel and dynamic topmodel studies beven 1997 beven and freer 2001 metcalfe et al 2015 visual inspection of the simulated time series fig 4a indicated that the model tended to underpredict base flow during late winter early spring and failed to capture several large storm events during summer months we offer several potential explanations for both occurrences first our model is calibrated using the natural logarithm of simulated and observed discharge to better predict recession periods which places greater weight on low flow periods second the implementation of dynamic topmodel in r does not currently consider infiltration excess overland flow metcalfe et al 2015 which may be important during high intensity storm events third convective thunderstorms with spatially variable precipitation rates are common during summer months in kentucky naylor and kennedy 2021 thus the weather station located 2 5 km to the southwest may not have accurately captured the total precipitation in falling rock during several events providing additional rainfall data and calibrating the model to both low and high flow periods may resolve some of these deficiencies however we emphasize the importance of optimizing low flow given recent findings that streamflow expansion and contraction is most variable during low and moderate flow conditions ward et al 2018 additionally given that our modeling objective is to simulate surface flow presence absence we prioritized model performance during low flow periods 4 1 2 flow permanence evaluation we compared simulated and observed flow state in four reaches with variable strahler order which assisted with improving model fidelity of flow permanence simulations see fig 5 simulated flow state in reaches fc1 fc3 was predicted with greater than 95 accuracy over the study period fig 5a c for all parameterizations the performance of the model had little variability in reaches fc1 fc3 despite changes in the calibrated transmissivity parameter and variable model realizations we attribute this to the relative stability of flow state observed throughout the study period in these reaches flow state sensors indicated that fc1 fc3 were generally wet during this period see fig s1 and note that the fc3 sensor was only active during the wet year which we acknowledge is suboptimal for simulating dynamic expansion and contraction at the reach scale however the performance statistics also underscore the model s capacity to accurately predict the presence or absence of surface streamflow in reaches with strahler orders greater than 1 that show the beginning of channelized streamflow see table 2 and fig s5 conversely we observed a trade off between the model s ability to predict flow state in the most distal reach fc4 and the ability to predict discharge at the catchment outlet fig 5d specifically the model realization that predicted fc4 s flow state optimally 87 of the study period had a kge value of 0 45 while the realization with the optimum kge kge 0 78 at the catchment outlet predicted fc4 s flow state correctly 69 of the study period this finding underscores recent sentiment noting the difficulty of validating model performance of semi distributed process based hydrologic models with singular discharge measurements at the catchment outlet and emphasizes that increased data are necessary to verify model fidelity as in this approach ebel and loague 2006 ebel et al 2008 holmes et al 2020 we found that lower predicted transmissivity values in fc4 coincided with high discharge kge values fig 5d and e mean calibrated transmissivity across all behavioral parameterizations was equal to 1 06 m3 hr 1 which agrees with potential transmissivity values estimated from measured saturated hydraulic conductivity and soil depth u s department of agriculture natural resource conservation service 2012 and estimated reach width vesely et al 2008 and likely is representative of the average system transmissivity throughout the headwater network the calibrated transmissivity values likely represent the potential range of transmissivities found in reaches throughout falling rock despite the model s variability in predicting fc4 s flow state flow state was predicted correctly on average 74 of the study period across all behavioral parameterizations in fc4 which confirms the model s relatively strong performance even in this distal reach while the second stage of model calibration did not quantifiably reduce equifinality beven 2006 the pareto front showing the trade off between model performance of simulated discharge and simulated flow state in fig 5d assisted with identification of parameterizations that best represented internal states of the system ebel et al 2008 gupta et al 2009 holmes et al 2020 we were unable to find any existing benchmarks within the literature to classify simulations as behavioral for flow state other than noting that a prediction of 50 would be no better than chance model results indicated that the minimum percentage flow state was correctly predicted in first order and higher order reaches was 64 and 82 respectively across all parameterizations we suggest that these numbers may serve as lower benchmarks of model performance for future modeling efforts in the central appalachian plateau seibert et al 2018 given the importance of understanding headwater streamflow permanence with respect to the federal protection of waterways creed et al 2017 wohl 2017 the vast number of metrics that have been used to assess streamflow permanence e g gallart et al 2012 fritz et al 2020 hammond et al 2021 and the feasibility of utilizing models to simulate such processes as shown here and in previous studies williamson et al 2015 jensen et al 2018 ward et al 2018 botter and durighetto 2020 durighetto and botter 2022 we encourage researchers to further investigate benchmarks to evaluate simulations of streamflow permanence the model evaluation also gives insight into the hydrological processes and controls of streamflow permanence in falling rock our model simulations imply that variability of the subsurface transport capacity within reaches q sub c see eq 5 is controlled primarily by the slope of individual reaches and less by the subsurface transmissivity t see eq 6 this finding was perhaps surprising given that width depth and saturated hydraulic conductivity of the permeable zone were presumed to change throughout the system and thus affect subsurface flow capacity ultimately this result is related to our assumption of a constant subsurface transmissivity used for the stream network which is corroborated by svec et al 2005 who found that stream slope explained the majority of variability when predicting flow duration in eastern kentucky streams recent literature suggests that transmissivity is proportional to upstream contributing area prancevic and kirchner 2019 shanafield et al 2021 as t a γ where γ is an exponent varying between 0 6 and 13 8 determined in mountain ranges located throughout the united states and a is the upstream contributing area in catchments where γ approaches zero transmissivity becomes relatively constant such that the subsurface capacity of the permeable zone throughout the network is a linear function of slope our relatively successful use of a constant simulated transmissivity parameter throughout the stream network suggests that t varies relatively weakly with upstream contributing area in falling rock as evidenced by the consistent model performance in higher order reaches though with variable model performance in fc4 this result also suggests that the γ for falling rock falls towards the lower end of γ values throughout the united states and corroborates findings from prancevic and kirchner 2019 that transmissivity can generally be predicted as a function of geomorphic catchment properties however field reconnaissance could verify this finding and values of t in the catchment the two stage calibration approach did indeed improve our confidence in model fidelity however uncertainty is present to different degrees in reaches where no streamflow permanence data were collected namely our assessment of streamflow dynamics is constrained in other first order reaches given the lack of streamflow permanence data collected in such reaches it was therefore necessary to supplement these data with maps and surveys of hydroperiods derived from field studies as well as assessment of hydroperiod using biological assessments as described below in section 4 2 cherry 2006 fritz et al 2013 data scarcity is a common and perpetual issue in catchment scale hydrologic models and this study further highlights that long term data collection is crucial to better understanding and simulating headwater streamflow permanence our approach does however show promise for transferability to other catchments by potentially using alternative validation approaches to verify model fidelity 4 2 simulated spatiotemporal dynamics of streamflow expansion and contraction the simulated active stream network length varied between 50 4 and 98 2 μ 74 of the geomorphic stream channel throughout the study period see fig 4c to derive the simulated active stream network length we averaged the simulated wetted channel length across all behavioral parameterizations from stage two of model calibration thus accounting for parameter uncertainty propagated from stage one of calibration visual inspection of the simulated time series of the percent of the stream network predicted to have streamflow fig 4c indicated that periods with the lowest flowing stream network length coincided with low flow periods in the late summer and fall which is generally the period with the least amount of precipitation in robinson forest sena et al 2021 the percentage of stream network with simulated surface flow appears to approach an asymptotic limit during low flow periods approximately equal to 50 of the geomorphic stream network length as observed around october 6 2005 fig 4b and c fig 6 a this is likely related to increased residuum lower slope and increased base flow surrounding higher order reaches maintaining surface streamflow annually whereas steeper slopes in low order reaches promote rapid transmission of flow downstream see table 2 shaw et al 2017 antonelli et al 2020 we anticipated that a stepwise decline in simulated surface streamflow length may occur beyond the approximately 50 minimum predicted by the model given sufficient drying of the system especially if flow from fracture conduits is interrupted specifically for third order streams to dry in this system the total volumetric flow rate must be less than a simulated value of approximately 0 06 m3 hr 1 within reaches table 2 fig s5 which our model did not simulate during the study period this flow was observed however for nearly 1 4 of the period between 2000 and 2015 outside of the study period suggesting not only that predicting low flow dynamics over longer periods may improve the model s capability to simulate surface streamflow contraction but that longer duration simulations may be key to characterizing the true end member conditions and likelihood of stream channel drying the model outputs were used to map simulated streamflow expansion and contraction dynamics as hydrologic conditions varied in the catchment fig 6 five events corresponded to approximately the 1st 25th 50th 75th and 98th exceedance percentiles of simulated discharge and the associated percentage of the network with simulated surface streamflow fig 4 and fig 6 respectively simulated streamflow expansion and contraction maps are derived from one behavioral parameterization of the system where the percent of the study period with flow state correctly predicted was greater than 75 and the kge of discharge was greater than 0 7 magenta circle in fig 5d fig 6 the maps suggest that first and to a lesser degree second order reaches generally are surficially inactive during the lowest flow regimes 98 and 75 exceedance discharges but become variably connected via surface streamflow during higher flow regimes for example we found that the 50 exceedance discharge corresponds with a simulated flowing stream network length equal to approximately 68 of the geomorphic stream network 3 49 km we found that 61 and 100 of first and second order streams were predicted to be connected to downstream reaches during this event respectively the ability of the model to map simulated streamflow permanence is important given recent emphasis on procuring data to quantify the frequency and duration of flow in temporary streams jensen et al 2017 creed et al 2017 large variability of simulated streamflow permanence in first order reaches reflects the importance of representing hillslope stream network connectivity in the structure of the model we calculated the average percentage of the study period when simulated surface flow was present within each reach in falling rock across all behavioral parameterizations from stage one fig 7 a higher order stream reaches were predicted to be connected between 85 and 100 of the study period first order streams had the largest variability in simulated streamflow permanence and individual reaches were predicted to have surface streamflow between less than 1 and 71 of the study period we attribute the variability of modeled surface streamflow to the range of slopes within first order streams upstream contributing area of reaches the soil type of hillslopes upstream of reaches and the proximity of hillslopes to the stream network e g bracken et al 2013 fritz et al 2018 leibowitz et al 2018 mahoney et al 2020 the importance of hillslope stream network connectivity is demonstrated in reach 27 and 31 which had similar slope and upstream contributing area but were predicted to have surface streamflow for 37 and 71 of the study period respectively table 2 fig s5 model outputs indicate that first order streams are important contributors to total simulated discharge at the catchment outlet the optimal parameterization resulted in 39 of simulated discharge emanating from first order streams in falling rock previous studies have indicated that quick flow contributes nearly 44 of total discharge in falling rock coltharp and springer 1980 which corroborates our results given that quick flow is generally expected to occur when ephemeral reaches are active the model exemplifies one method to quantify the watershed scale function of headwater systems which in turn may assist with enhancement of headwater protection in future years johnson et al 2010 furthermore this result underscores the importance of hydrologically effective restoration practices of disturbed lands including the forestry reclamation approach williamson and barton 2020 and may be one reason why water quality can be disproportionately affected by disturbance of these small streams fritz et al 2010 we compared the probability of simulated surface streamflow within individual reaches fig 7a table 2 to the national hydrography dataset nhd plus high resolution map which is a coarser and vastly larger mapping effort than ours fig 7b u s geological survey 2018 the nhd plus map overlapped with 27 of the geomorphic stream network from taudem model outputs indicated that nearly 100 of the network coincident with the nhd segment flowed perennially but that an additional 1 215 m of stream length 26 of the geomorphic channel was predicted to flow for 98 of the study period yet was not depicted by nhd nhd plus classified the mapped stream fig 7b as being entirely intermittent we additionally compared simulated streamflow permanence results to localized hydroperiod classification from cherry 2006 fig 7c which further validated model results our model indicated that reaches identified as perennial by cherry 2006 were simulated to have surface flow for 100 of the study period reaches identified as intermittent were simulated to have surface flow between 100 and 56 6 of the study period reaches identified as ephemeral were simulated to have surface flow between 86 5 and 1 0 of the study period while the mapped results from cherry 2006 generally agree with our model outputs our results tended to indicate slightly wetter conditions than the classification from cherry 2006 likely this can be attributed to mapping during a singular instance versus the three year study period which spanned a relatively wet relatively dry and an average year with respect to annual precipitation sena et al 2021 regardless our model results support recent sentiment to improve inventories and understanding of perennial intermittent and ephemeral streams in headwater networks fritz et al 2013 creed et al 2017 leibowitz et al 2018 shanafield et al 2021 4 3 simulated controls of streamflow permanence we plotted average simulated stream length across behavioral parameterizations versus the optimum simulated discharge and fit power functions to the data to evaluate the rate at which the network expands and contracts fig 8 recent literature suggests that the rate of stream network expansion can be measured with reference to discharge at the catchment outlet using a power function linear in log log space godsey and kirchner 2014 shaw et al 2017 whiting and godsey 2016 prancevic and kirchner 2019 antonelli et al 2020 equal to l q β where l is the length of the flowing stream network km q is the discharge mm day 1 and β is an exponent representing the rate at which the stream network expands as a function of discharge at the watershed outlet visual inspection of model results indicated that two distinct patterns of stream wetting and drying occur within falling rock depending on the hydrologic regime of the system fig 8 we developed two regression equations to represent the rate of simulated streamflow expansion and contraction and optimized a threshold discharge q t 1 mm d 1 to maximize the r2 of the two power functions r2 0 93 and r2 0 47 respectively as 8 l 4 33 q 0 17 q q t 4 12 q 0 02 q q t this result indicates that simulated surface streamflow expands relatively quickly during low flow conditions until the threshold of 1 mm d 1 is reached at which point the rate of streamflow expansion decreases by approximately one order of magnitude the active extent of the stream network is predicted to increase by approximately 2 3 km as discharge increases from 0 01 mm d 1 to 1 mm d 1 but only increase by 0 5 km when discharge increases from 1 mm day 1 to 100 mm day 1 this result is supported both experimentally and theoretically by several studies that also found a plateau in the rate of stream expansion above a threshold discharge ward et al 2018 jensen et al 2019 durighetto and botter 2022 we note that we used a static realization of the geomorphic stream network to represent the domain of stream expansion and contraction within falling rock thus channel evolution and channel head migration are not accounted for within the model structure this means that while overland runoff is accounted for with dynamic topmodel metcalfe et al 2015 the instream subroutine does not simulate instances when channelized flow occurs upstream of the geomorphic stream channel future iterations of the model might incorporate sediment transport subroutines that simulate channel head migration to realize a fully dynamic stream network our results indicate that a combination of structural and functional watershed properties control simulated surface streamflow permanence and stream expansion contraction during low flow periods while functional hydrologic influence of stream expansion decreases during high flow periods one potential reason for this is that as the water table rises during low flow periods due to increased precipitation and lateral inflow the subsurface capacity in higher order streams with low slope and large upstream contributing area is initially filled sustaining surface streamflow generally little variability of streamflow permanence was simulated in streams with strahler order greater than 2 fig 7a table 2 suggesting that increasing upstream connectivity of hillslopes and upstream reaches stabilizes streamflow permanence ward et al 2018 jensen et al 2019 prancevic and kirchner 2019 durighetto and botter 2022 perennial reaches tended to coincide with upstream contributing areas of at least 9 2 ha on the other hand significantly more variability in predicted streamflow permanence was simulated in reaches with low strahler order low upstream contributing area and high slope fig 7a table 2 which we attribute to a relatively increased subsurface flow capacity and variable connectivity of heterogeneous upstream hrus these results suggest that during low flow periods a combination of functional processes e g water storage precipitation evapotranspiration and the unique structural properties within a reach e g watershed configuration subsurface flow capacity control the simulated presence absence of streamflow within falling rock we largely attribute the lack of sensitivity of the stream network expansion to hydrologic forcings during high flow periods to the subsurface already being at or above its transport capacity specifically at a simulated outlet discharge of 1 mm d 1 nearly 85 of the geomorphic stream network was predicted to contain surface flow indicating that the subsurface is already at capacity and thus limiting further expansion of the simulated active stream length this result is corroborated by a recent study conducted by ward et al 2018 who found that the flowing length of the stream network was limited despite catchment outlet discharge varying nearly three orders of magnitude during wet conditions notably ward et al 2018 found that the degree of stream network expansion and connectivity greatly decreased for outlet discharges greater than approximately 28 8 m3 hr 1 reported as 8 l s 1 in a 96 ha catchment within the h j andrews experimental forest in the western cascade mountains of oregon usa our results suggest that a similar threshold exists in falling rock at a simulated discharge of 1 mm d 1 which corresponds to a volumetric flow rate of 39 6 m3 hr 1 at the 96 ha catchment outlet we found this result rather surprising given that our studies were conducted in different physiographic regions at opposite ends of the conterminous united states while further investigation could confirm if such thresholds hold true in other headwater catchments this perhaps is one piece of evidence supporting the claim from godsey and kirchner 2014 that despite varying geology topography and climate stream expansion and contraction are phenomena that may be generalizable across systems additionally this corroborates early findings from strahler 1957 suggesting that similar order stream networks behave in a hydrologically similar manner the model outputs suggested that expansion of the simulated active stream length in falling rock falls between systems identified as stable and rapidly expanding in recent literature as represented by the power function exponent β equal to 0 17 during low flow periods e g godsey and kirchner 2014 whiting and godsey 2016 jensen et al 2017 shaw et al 2017 prancevic and kirchner 2019 prancevic and kirchner 2019 summarized β parameters calculated via repeated field mappings of the flowing extent of the stream network and found that β varied between 0 04 and 0 59 μ 0 19 throughout headwater systems in the united states comparatively during low flow periods falling rock was simulated to wet up slightly less quickly than the mean β identified by prancevic and kirchner 2019 indicating that the system is predicted to not be particularly flashy or stable compared to other systems this is consistent with the relatively rapid drainage of sandy soils withing falling rock with sustained surface streamflow attributed to the presence of subsoils with increased fractions of silt and clay during high flow periods the simulated stream network in falling rock expands slower than all other catchments discussed by prancevic and kirchner 2019 as represented by the power function exponent β equal to 0 02 during high flow periods our finding that variable rates of expansion and contraction exist within the network is consistent with results from several recent studies e g ward et al 2018 jensen et al 2019 durighetto and botter 2022 but has been discussed less frequently in studies that determine the rate of expansion via field surveys e g godsey and kirchner 2014 whiting and godsey 2016 jensen et al 2017 shaw et al 2017 it is likely that the shift to a lower magnitude β or an overall nonlinear relationship between l q is typical in most systems given that theoretically there is an upper limit to the amount of discharge that can exist within the geomorphic stream channel during a given hydrologic event however this phenomenon is likely reported less frequently because measurement of flowing stream length is logistically constrained during high flow periods which often only exist over short time scales and are infeasible to map from ground observations for watersheds the size of falling rock or larger these constraints can be overcome by using aerial imagery to characterize stream length at regular intervals e g hooshyar et al 2015 or by applying extensive networks of flow state sensors which extend well into ephemeral reaches e g jensen et al 2019 durighetto and botter 2022 we note that the static realization of the geomorphic stream network to represent the domain of stream expansion and contraction within falling rock is a necessary structural constraint of the model and this relation may be further explored by explicitly considering channel evolution and channel head migration in the model structure we should note that while the power law function fits the l q data well below the 1 mm d 1 threshold the fit of the power law above the threshold is less adequate one particular issue with the application of a power function to represent l q data above the 1 mm d 1 threshold is that the function is monotonically increasing which indicates that at large flows the stream length continues to grow towards infinity albeit at a slow rate we posit however that there is an upper limit to streamflow expansion in the study catchment given that by definition once the geomorphic channel is completely wetted up the network can expand no further noting that we conceptualize overland runoff from hillslopes separately from channelized flow in this context the ability of the power law function to describe the l q relationship begins to break down at higher flow regimes we should note that we used the power law equation to model the l q relationship to compare β coefficients representing stream expansion rates among falling rock and the extensive literature using power laws to represent l q dynamics roberts and klingeman 1972 godsey and kirchner 2014 shaw 2016 whiting and godsey 2016 jensen et al 2017 prancevic and kirchner 2019 antonelli et al 2020 further we applied the power law for both the low and high flow regimes because we wanted to emphasize the change in l q expansion rates above the 1 mm d 1 threshold discharge value recent studies have suggested the use of sigmoid type functions to better represent this l q relationship e g durighetto and botter 2022 and we fitted a four parameter weibull function to the l q data from falling rock with r2 0 97 which corroborates this notion see fig s6 4 4 model limitations and opportunities streamflow expansion and contraction are inherently complex processes resulting from fine scale multi dimensional fluxes godsey and kirchner 2014 ward et al 2016 ward et al 2018 while we emphasize the efficacy of the catchment scale process based modeling approach it is often epistemologically and computationally challenging to discretize models at physically realistic spatial or temporal scales for example increasing the temporal discretization of our model from a two hour timestep to a 15 minute timestep increased the computational time by approximately eight fold and calibrating the model once resulted in nearly 15 gigabytes of data we recognize that high spatiotemporal resolution simulations that capture fine scale processes such as upwelling downwelling flow through alluvial deposits exfiltration from springs and sub reach scale disconnectivity are particularly important for identification of the directionality of streamflow expansion e g bottom up top down or converging goulsbra et al 2014 peirce and lindsay 2015 shanafield et al 2021 and within reach variability of flow state for example minute scale measurements simulations might be required to fully capture rapid stream expansion in flashy systems goulsbra et al 2014 jensen et al 2019 or ephemeral reach dynamics and upwelling downwelling fluxes between the surface and subsurface yet our model simulated low flow dynamics and streamflow permanence relatively well using on average 0 05 km2 hrus fig s3 and approximately 130 m stream reaches at a two hour time step underscoring that investigating various components of streamflow permanence and runoff generation might require variable spatially and temporally scaled models however we should state this model is reliant upon findings from relatively well instrumented hillslope and sub meter streamflow permanence studies to inform the necessary assumptions required to run the model for example as discussed by godsey and kirchner 2014 goulsbra et al 2014 and peirce and lindsay 2015 future streamflow expansion and contraction simulations would benefit from explicitly defined timescales hydrologic processes and model objectives relative to trade offs in model accuracy fidelity and complexity clark et al 2015b golden et al 2017 we aimed to develop a modular framework to simulate headwater streamflow permanence that might eventually be upscaled regionally throughout the united states and are currently testing this framework s applicability in catchments with variable geologic and morphologic properties a key model development opportunity is to improve flow routing in regions with modified or complex subsurface flow e g in tile or ditch drained networks or karst systems e g ford et al 2019 husic et al 2019 evenson et al 2021 additionally the hydrologic dynamics of small surface storage systems e g geographically isolated wetlands or non floodplain wetlands see perspectives for modeling these systems in evenson et al 2015 golden et al 2017 jones et al 2019 which are important for the proper functioning of hydrological and ecological systems globally cohen et al 2016 creed et al 2017 evenson et al 2018 need to be integrated into the model discharge data for first and second order systems is scarce poff et al 2006 nadeau and rains 2007 and likely will remain scarce as the u s geological survey shift focus of hydrologic monitoring to population centers to support infrastructure rather than to headwaters hodgkins et al 2019 u s geological survey 2020 golden et al 2021 we integrated field reconnaissance discharge measurements and flow state monitoring in perennial intermittent and ephemeral reaches to verify our model s streamflow expansion and contraction dynamics however only two of the 12 ephemeral flow reaches identified by cherry 2006 had flow state sensors and thus equifinality and parameter uncertainty indeed are present in the model the use of supplementary validation data such as additional flow sensor measurements and ecological descriptions may improve the fidelity of streamflow permanence simulations seibert and mcdonnell 2002 ebel and loague 2006 clark et al 2015b for example remotely sensed data svec et al 2005 vanderhoof et al 2017 wu and lane 2017 field surveys e g prancevic and kirchner 2019 physiochemical and biological indicators fritz et al 2008 johnson et al 2010 stable isotope tracing stadnyk et al 2013 brooks et al 2018 holmes et al 2020 and estimates of transmissivity via topographic catchment properties e g prancevic and kirchner 2019 shanafield et al 2021 have elucidated the dynamics of hydrologic connectivity and streamflow permanence in recent years and could be integrated as soft data verifying model behavior the procurement and application of such data could be prioritized for future research in coming years and will be especially important for upscaling this model to larger watersheds and regions of the united states with invariably less data than falling rock 5 conclusions we developed a process based catchment scale hydrologic model to investigate the dynamics of surface streamflow permanence and the controls of streamflow expansion and contraction in headwater reaches the framework considered explicit hillslope stream network connectivity using a modified dynamic topmodel approach and estimated the subsurface transport capacity of reaches to simulate the presence or absence of surface streamflow we applied the model to a moderately well monitored catchment in the central appalachian plateau of eastern kentucky usa we found that 1 the model simulated discharge at the catchment outlet and streamflow presence absence within perennial intermittent and ephemeral reaches relatively well albeit with some uncertainty considering hillslope stream network connectivity in the model was particularly important for classifying streamflow in first order reaches where streamflow permanence was most variable in the study catchment 2 model outputs helped to create maps representing surface streamflow extents within the headwater network and to quantify first order reach contributions to total discharge at the catchment outlet model outputs indicate that nearly 39 of total discharge is contributed by ephemeral reaches when comparing model generated maps of streamflow permanence probabilities to current headwater stream inventories in the united states we predicted that 1 215 m of stream length 26 of the headwater network was flowing for at least 98 of the three year study period yet this part of the stream network was not mapped by national inventories this finding underscores the need for improved stream mapping across the united states 3 our model outputs suggested that the interaction of a rising water table upstream hydrologic connectivity and structural properties defining a reach s subsurface capacity control streamflow permanence during low flow conditions but that simulated sensitivity of stream network expansion to hydrologic forcing diminishes during high flow periods recent experimental and modeling studies in headwater systems corroborate this finding despite being geographically dissimilar suggesting that headwater expansion and contraction may have similar controls across systems 4 flow state data interpreted as the presence or absence of surface streamflow assisted with model verification however continuous data to verify streamflow permanence in headwater systems is typically scarce poff et al 2006 and it was necessary to supplement our model verification with field maps and surveys of the extent of perennial intermittent and ephemeral streams prioritizing the procurement and application of data to classify headwater streamflow will enable researchers to quantify the function of headwaters within the context of larger watershed systems this advancement has the potential to enhance the protection of headwater systems in coming years credit authorship contribution statement d t mahoney conceptualization methodology software validation formal analysis investigation writing original draft writing review editing visualization j r christensen conceptualization methodology investigation writing original draft writing review editing visualization supervision h e golden conceptualization methodology investigation writing original draft writing review editing visualization supervision c r lane conceptualization methodology investigation writing original draft writing review editing visualization supervision g r evenson conceptualization methodology investigation writing original draft visualization supervision e white conceptualization methodology investigation writing original draft writing review editing visualization supervision k m fritz conceptualization writing original draft writing review editing visualization data curation e d amico conceptualization methodology software writing original draft c d barton conceptualization methodology writing original draft writing review editing data curation t n williamson conceptualization methodology software writing original draft writing review editing data curation k l sena conceptualization methodology writing original draft writing review editing data curation c t agouridis conceptualization methodology writing original draft writing review editing data curation declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this paper has been reviewed in accordance with the u s environmental protection agency s peer and administrative review policies and approved for publication any use of trade firm or product names is for descriptive purposes only and does not imply endorsement by the u s government statements in this publication reflect the authors professional views and opinions and should not be construed to represent any determination or policy of the u s environmental protection agency usepa this paper has been peer reviewed and approved for publication consistent with usgs fundamental science practices https pubs usgs gov circ 1367 this project was supported in part by an appointment to the research participation program at the office of research and development usepa administered by the oak ridge institute for science and education through an interagency agreement between the u s department of energy and usepa we appreciate helpful suggestions from two internal reviewers at the usepa as well as a colleague reviewer at usgs we also thank gianluca botter and an anonymous reviewer for comments that helped us greatly improve the quality of this work appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129422 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2057,the hillslope and channel dynamics that govern streamflow permanence in headwater systems have important implications for ecosystem functioning and downstream water quality recent advancements in process based semi distributed hydrologic models that build upon empirical studies of streamflow permanence in well monitored headwater catchments show promise for characterizing the dynamics of streamflow permanence in headwater systems however few process based models consider the continuum of hillslope stream network connectivity as a control on streamflow permanence in headwater systems the objective of this study was to expand a process based catchment scale hydrologic model to better understand the spatiotemporal dynamics of headwater streamflow permanence and to identify controls of streamflow expansion and contraction in a headwater network further we aimed to develop an approach that enhanced the fidelity of model simulations yet required little additional data with the intent that the model might be later transferred to catchments with limited long term and spatially explicit measurements this approach facilitated network scale estimates of the controls of streamflow expansion and contraction albeit with higher degrees of uncertainty in individual reaches due to data constraints our model simulated that streamflow permanence was highly dynamic in first order reaches with steep slopes and variable contributing areas the simulated stream network length ranged from nearly 98 2 of the geomorphic channel extent during wet periods to nearly 50 10 during dry periods the model identified a discharge threshold of approximately 1 mm d 1 above which the rate of streamflow expansion decreases by nearly an order of magnitude indicating a lack of sensitivity of streamflow expansion to hydrologic forcing during high flow periods overall we demonstrate that process based catchment scale models offer important insights on the controls of streamflow permanence despite uncertainties and limitations of the model we encourage researchers to increase data collection efforts and develop benchmarks to better evaluate such models keywords streamflow permanence expansion and contraction modeling hydrologic connectivity data availability data will be made available on request 1 introduction streamflow permanence defined as the frequency magnitude duration and timing of surface streamflow presence in headwater streams impacts ecosystem function and downstream water quality wohl 2017 headwater streams account for approximately 53 of total river network length in the united states nadeau and rains 2007 providing services such as runoff storage nutrient retention and regional biodiversity boulton 2014 datry et al 2018 colvin et al 2019 these networks expand and contract as a function of interacting hydrologic forcings hillslope stream network connectivity and structural watershed properties bracken et al 2013 wohl 2017 ward et al 2018 durighetto and botter 2022 importantly streamflow permanence dictates habitat suitability for a variety of freshwater taxa such as benthic macroinvertebrates clarke et al 2010 karaouzas et al 2019 and fish davey and kelly 2007 which exhibit varying tolerances for stream channel wetting and drying characterization of streamflow permanence in headwater systems remains elusive despite the recognized services such systems provide for the entire river network koundouri et al 2017 colvin et al 2019 ruiz et al 2021 this is largely attributed to scarce data on and mapping of headwater systems poff et al 2006 which has led to their limited federal protection under the clean water act cwa e g creed et al 2017 quantification of the watershed scale function of headwater systems is one way to enhance their protection johnson et al 2010 and this approach would benefit from the improved understanding of streamflow permanence dynamics at the catchment scale the presence or absence of streamflow in headwater streams results from multi scale multi dimensional hydrologic processes hammond et al 2021 shanafield et al 2021 botter et al 2021 empirical studies focused on understanding streamflow permanence have made significant strides in elucidating the mechanisms of streamflow expansion and contraction see review in senatore et al 2021 these include the use of biological and physical indicators as surrogate measures of hydroperiod classification e g perennial intermittent ephemeral see review in fritz et al 2020 repeated mapping of the flowing extent of the stream network e g godsey and kirchner 2014 whiting and godsey 2016 jensen et al 2017 shaw et al 2017 zimmer and mcglynn 2017 lovill et al 2018 meerveld et al 2019 durighetto et al 2020 senatore et al 2021 and implementation of highly instrumented networks of flow state sensors goulsbra et al 2014 zimmer and mcglynn 2017 jensen et al 2019 kaplan et al 2020 botter et al 2021 to understand streamflow expansion and contraction prancevic and kirchner 2019 flow state sensors measure the presence or absence of surface water and when strategically placed within riffles can infer the presence or absence of streamflow i e flowing or not flowing fritz et al 2006 furthermore extensive literature has leveraged long term discharge measurements to derive hydrologic metrics that have been used to classify streamflow duration throughout the united states and europe see review in christensen et al 2022 such field based methods from highly instrumented and studied catchments are the most reliable measures of the extent of surface streamflow within headwater systems jensen et al 2018 which in essence is the response variable of connectivity from upstream surface and subsurface pathways e g godsey and kirchner 2014 statistical and analytical models built from measured data have also been used to classify flow permanence and the extent of perennial intermittent and ephemeral streams svec et al 2005 russell et al 2015 villines et al 2015 jensen et al 2018 jaeger et al 2019 botter and durighetto 2020 durighetto and botter 2022 durighetto et al 2022 despite the reliability of these empirical methods to classify streamflow permanence they face challenges pertaining to data acquisition transferability and projection of dynamics beyond the measured data godsey and kirchner 2014 ward et al 2018 for example mapping the flowing extent of the stream network is infeasible over large areas and repeated field surveys are often time prohibitive recent advancements in process based hydrologic models show promise for characterizing streamflow permanence in headwater systems and overcoming the logistical limitations of empirical classification methods williamson et al 2015 ward et al 2018 ward et al 2020 process based models simulate fluxes and storage of water over spatiotemporal scales that are often difficult to measure in the field thus facilitating investigation of dynamics and controls of hydrologic processes at scales that otherwise would not be possible albeit with some degree of uncertainty clark et al 2015b ward et al 2018 recently developed a reduced complexity process based modeling framework that considers in stream continuity and net upwelling and downwelling processes to simulate high resolution dynamics of streamflow expansion and contraction longitudinally along the stream network williamson et al 2015 used a regional topmodel approach beven and kirkby 1979 and the saturation deficit representing soil water storage within catchment hillslopes to predict landscape units with surface streamflow present findings from both studies demonstrate the efficacy of using process based models to estimate streamflow permanence the spatial and temporal trends of streamflow expansion and contraction and controls of hydrologic connectivity within headwater networks these studies resulted in new methods to simulate headwater stream network extent however to our knowledge few studies consider hillslope stream network connectivity within a process based hydrologic modeling context for example several studies treat lateral inflow as an area weighted fraction of the outflow from the catchment godsey and kirchner 2014 ward et al 2018 prancevic and kirchner 2019 which does not consider the within hillslope and hillslope stream network connectivity that affects variability of streamflow permanence in first and second order reaches bracken et al 2013 shanafield et al 2021 furthermore models that simulate hillslope hydrologic connectivity such as dynamic topmodel beven and freer 2001 and the visualizing ecosystems for land management assessment velma model abdelnour et al 2011 do not include subroutines to simulate longitudinal hydrologic connectivity or streamflow permanence the improved simulation of the dynamics of streamflow permanence currently is limited by a number of uncertainties namely verifying model fidelity is a well known challenge with process based hydrologic models because continuous channel monitoring in both space and time is rare and often requires increased data collection to reduce uncertainty of simulations stadnyk et al 2013 furthermore such high resolution models are often over parameterized and computationally burdensome using hydrologic response units hrus to group landscape components behaving in a hydrologically similar manner and calculating transport at the reach scale i e on the order of tens to hundreds of meters may reduce required input data and model run times while retaining important information regarding reach scale streamflow permanence further leveraging data collected on moderately and highly instrumented headwater networks is a viable yet unharnessed approach to reduce equifinality of streamflow permanence simulations the objective of this study was to develop a process based catchment scale hydrologic model to investigate the spatiotemporal dynamics of headwater streamflow permanence and identify controls of headwater streamflow expansion and contraction we apply the model to a headwater catchment on the central appalachian plateau in kentucky united states usa a site with adequate data to simulate streamflow permanence yet less spatial and temporal hydrological monitoring and instrumentation than long term catchment study sites e g goulsbra et al 2014 senatore et al 2021 therefore we provide a framework from which to upscale simulated streamflow permanence to larger watersheds and regions throughout the united states that typically have limited available data in headwaters our model also explicitly considers within hillslope connectivity similar to williamson et al 2015 hillslope stream network connectivity and interactions between the surface stream and subsurface permeable zone similar to ward et al 2018 we investigate the spatiotemporal dynamics and controls of headwater streamflow permanence with maps showing the variability of surface streamflow and timeseries of the flowing stream length within the catchment our approach characterizes headwater streamflow permanence using a process based hydrologic model at the reach and catchment spatial scale as opposed to upwelling and downwelling of individual features at sub meter spatial scales which may assist with quantifying the function of headwater streams within larger watersheds creed et al 2017 2 study site and materials 2 1 study site the falling rock catchment 0 96 km2 is a moderately well monitored headwater system in the university of kentucky s robinson forest located on the central appalachian plateau of kentucky u s a fig 1 the system is used as a control basin for silviculture management experiments and has been relatively undisturbed since the early 1900s when timber was last harvested in the catchment overstreet 1984 land use in falling rock is almost entirely second growth forest with an overstory consisting of primarily hardwood trees e g oak quercus sp hickory carya sp yellow poplar liriodendron tulipifera american beech fagus grandifolia moriarty and mccomb 1985 phillippi and boebinger 1986 climate is classified as temperate humid with mean annual rainfall equal to 1121 mm sena et al 2021 minimum and maximum temperature ranges between 5 c and 8 c in the winter and 17 c and 31 c in the summer elevation ranges between 294 m and 459 m above sea level navd 88 fig 1b and d the study period spanned from approximately december 1 2003 until september 30 2006 robinson forest received 1 490 mm of precipitation in 2004 1002 mm in 2005 and 1156 mm in 2006 thus this study spans a relatively wet year a relatively dry year and a year with approximately average precipitation the depth of the soil above bedrock is estimated to be less than 1 0 m surrounding streams and to range between 0 7 m and 2 2 m on hillslopes fritz et al 2008 fig 1a soils are shallow and well drained sloan et al 1983 williamson et al 2015 with saturated hydraulic conductivities estimated to range between 0 02 and 0 50 m hr 1 catchment lithology consists primarily of sandstone shale and siltstone fig 1c kentucky geological survey 1998 surface streamflow responds rapidly to precipitation which is largely attributed to the presence of subsurface macropore pathways shallow depths to confining bedrock and steep hillslopes williamson et al 2015 consequently little overland runoff has been observed on hillslopes in this region mahoney et al 2021 the topography of falling rock is classified by steep dissected hillslopes and a dendritic drainage network stream slopes span nearly an order of magnitude table s1 with flattest slopes in higher order reaches and steepest slopes in first order reaches 2 2 materials used to simulate streamflow permanence falling rock was chosen for this study because of its relative abundance of data dating from 1971 a substantial collection compared to catchments with limited or no hydrologic instrumentation in the region the ecology and geomorphology of perennial intermittent and ephemeral reaches have been described and modeled in falling rock via a number of field and modeling investigations cherry 2006 mapped the extent of perennial and non perennial reaches within the catchment fig 1c using methods developed by fritz et al 2006 several studies have classified flow duration and perennial intermittent and ephemeral extent of streams within falling rock using models svec et al 2005 villines et al 2015 williamson et al 2015 fritz et al 2008 surveyed physical and biological indicators of streamflow permanence including stream morphology sediment properties habitat and bioassessments discharge and water quality johnson et al 2010 used a similar dataset to investigate the downstream effects of headwater stream disturbance locally collected environmental datasets were used to either parameterize or evaluate our model beginning in 1971 precipitation and air temperature were measured with weighted buckets strip charts and thermometers until being replaced with tipping buckets and electronic data loggers in 2005 sena et al 2021 weather stations were installed at the ridge and bottom of falling rock and approximately 2 5 km to the southwest camp weather station of the watershed outlet see fig 1c potential evapotranspiration rates were estimated using temperature data an estimate of daylight length and the hamon 1961 formula which was previously implemented to simulate pet in falling rock by williamson et al 2015 further williamson and barton 2020 corroborated findings from lu et al 2005 using the hamon formula further supporting its use herein we used data primarily collected from camp weather station to drive the model due to gaps in data at the weather stations located within falling rock during the study period catchment morphologic properties were quantified using a 1 5 m digital elevation model dem fig 1d and table s1 kyaped 2014 morphometry data collected by fritz et al 2008 and regional regression analysis of stream bathymetry vesely et al 2008 discharge has been monitored at the catchment outlet using a v notched weir since 1971 sena et al 2020 flow state was recorded in four reaches see fig 1a identified by cherry 2006 as perennial fc1 intermittent fc2 and ephemeral fc3 fc4 between late 2003 and late 2006 using ecological indicators and an onset hobo flow state sensor onset submersible case and an encased cable fritz et al 2006 care was taken to position the flow state sensor in the thalweg of stream reaches in erosional riffle or run habitats representative of the reach with the logger contacts set within slotted stilling wells at the streambed surface several interruptions to data collection occurred due to sensor maintenance or malfunction which contributes to uncertainty of the stream dynamics observed and simulated in falling rock therefore it was necessary to additionally evaluate our model using qualitative estimates of hydroperiod from field maps and surveys as well as biological assessments cherry 2006 fritz et al 2006 which inherently manifest from system dynamics available flow state and discharge data used to validate the model are shown in fig s1 additional flow state data were collected in the catchment between 2011 and 2012 williamson et al 2015 but were not used herein since little variability of flow state was observed in falling rock during this period most sensors reported wet conditions and given computational constraints of running the model for approximately 10 years falling rock was chosen for study over other highly instrumented headwater networks e g goulsbra et al 2014 ward et al 2020 for several reasons although not extensively published or instrumented like other headwater catchments and watersheds throughout the western united states and europe e g goulsbra et al 2014 senatore et al 2021 the catchment has flow data on small perennial intermittent and ephemeral streams dating back to the 1970s including continuous discharge gage data flow state data at multiple locations as well as maps and surveys of the extent of perennial intermittent and ephemeral streams streamflow permanence descriptions in this catchment have been related to ecological niches providing an additional means of model validation fritz et al 2013 falling rock is therefore one of the most instrumented and studied watersheds in the central appalachian ecoregion of the united states sena et al 2021 and few studies to our knowledge contain the necessary data to simulate models to investigate streamflow permanence in this region williamson et al 2015 this paucity of headwater modeling studies in central appalachia gives credence to choosing falling rock as the study site given 1 the importance of appalachian headwaters for structuring habitats and biodiversity price et al 2012 drayer and richter 2016 and 2 the enhanced vulnerability that such systems face due to widespread land use change from strip mining and timber harvest as well as climate change zégre et al 2013 witt et al 2016 williamson barton 2020 furthermore falling rock is nested within a larger headwater network that contains streamflow permanence data and discharge data in this regard we considered the study catchment to be an ideal testbed to develop a process based hydrologic model that requires relatively low data inputs yet can be leveraged to simulate streamflow permanence by focusing on model fidelity at the reach scale further application of the model to falling rock will facilitate future comparisons of streamflow expansion and contraction in catchments with variable structural watershed configurations and limited long term high spatial and temporal resolution streamflow permanence measurements 3 methods 3 1 model formulation we utilize dynamic topmodel to simulate hydrologic fluxes and connectivity from hillslopes to the stream network see reviews of dynamic topmodel in beven and freer 2001 beven 2011 metcalfe et al 2015 dynamic topmodel is a process based hydrologic model that simulates hillslope hydrology using the variable upslope contributing area approach building upon its widely applied predecessor topmodel beven and kirkby 1979 by incorporating an additional parameter s d max to represent disconnectivity of upland hillslope units during periods of extensive drying and abandoning the original assumption of a quasi steady water table metcalfe et al 2015 dynamic topmodel solves a time varying mass balance to simulate the change in subsurface and lateral flow between hydrologic response units hrus as 1 s t q x r where s is the subsurface storage deficit q is the downslope flow per unit plan area and r is the recharge from the unsaturated zone lateral flow over the surface and through the subsurface is assumed in this study to follow the catchment topography which likely holds true in systems with relatively steep slopes and shallow soil depths beven 1997 albeit with some degree of uncertainty lateral connectivity to the stream network can be conceptualized using a weighted flow matrix which maintains the structural contiguity of the hillslope by representing the proportion of flow from one landscape unit that flows into downstream landscape units as discussed in beven and freer 2001 and metcalfe et al 2015 this matrix is defined as 2 w p 11 p 1 n p ij p n 1 p nn where each element of the matrix represents a landscape unit assumed to behave in a hydrologically similar manner i e an hru and i represents the hru which contributes flow to receiving hru j the sum across columns is equal to unity which represents the total flow from hru i that is redistributed downstream such that j 1 n p ij 1 and p ij is the fraction of flow out of hru i that redistributes to hru j or alternatively stream reach j the fraction of flow that is redistributed from one hru to another represents the structural connectivity of an hru to a receiving landscape unit p ii thus represents the fraction of cells with a given hru designation that flow downstream to a cell with the same hru designation as the upstream cell in this regard a portion of hru flux will be redistributed to the same hru which reflects the downslope transfer of water through the hru until reaching the boundary with another hru or the stream network in catchments where flow follows topography it is assumed that the fraction of flow redistributed to a downstream hru is equal to the areal fraction of landscape units directly downstream of the hru this is expected to hold true in the study catchment but is one limitation of the approach used herein elements along the diagonal of the matrix represent landscape units that flow into downstream landscape units with the same hru designation it is expected that weighting matrices will shift over geomorphic decadal timescales but will be constant at yearly timescales wainwright et al 2011 the matrix may be parameterized using a flow direction raster as discussed in section 3 3 water is passed from upstream to downstream hrus using a kinematic wave routing approach metcalfe et al 2015 until flow from upland hrus exfiltrates into the stream network inflow to a reach for a specific timestep is equal to the sum of flow entering the reach from upstream hillslope hrus which considers the unique upstream contiguity of the hillslope as well as flow entering from upstream reaches as 3 q tota l i j q la t i j q u p i j where q tota l i j is the total amount of flow in a unique reach j during a specific time step i q la t i j is the total amount of flow entering the reach from uniquely connected hrus as defined by eq 2 and q u p i j is the flow entering reach j from an upstream reach during a time step in this regard at the most upstream end of the stream network q up is expected to be nil because there are no upstream reaches flow is then routed to downstream reaches as described in section 3 2 while dynamic topmodel is well recognized to adequately simulate hydrologic fluxes on hillslopes the instream routing component is not currently equipped to simulate streamflow permanence in headwater reaches and we have modified the model to include this feature we conceptualize surface streamflow permanence by building off of findings from both field based and modeling studies from godsey and kirchner 2014 ward et al 2018 prancevic and kirchner 2019 and durighetto and botter 2022 fig 2 adapted from beven and freer 2001 ward et al 2018 wherever the total discharge supplied from upstream sources i e upstream reaches and lateral hillslopes is greater than the subsurface transport capacity of the permeable zone coincident with the geomorphic stream channel surface flow is possible this is written as a binary probability as 4 p f i j 1 q tota l i j q sub c j 0 q tota l i j q sub c j where i and j represent a unique temporal and spatial step respectively p f represents the probability of streamflow presence within a reach equal to 1 if surface streamflow is present 0 if surface streamflow is absent q total is the total discharge in a reach contributed from the hillslope and upstream reaches and q sub c is the subsurface capacity of the permeable sediment and bedrock surrounding the geomorphic stream channel in a particular reach q sub c is conceptualized to be a reach dependent structural watershed property that represents the total amount of subsurface flow that the reach can carry prior to streamflow emerging at the surface in this regard the model implicitly accounts for upwelling downwelling assuming that if the amount of flow in a reach during a time step is less than the q sub c j threshold then downwelling occurs otherwise upwelling will occur in the reach we expand upon this assumption in section 3 2 the subsurface capacity of the permeable zone is conceptualized using the darcy equation similar to several recent field based studies e g godsey and kirchner 2014 prancevic and kirchner 2019 as 5 q sub c j t j s j and 6 t j a j k j where j is the reach t is the subsurface transmissivity l 3 t 1 s is the slope of the hydraulic gradient of the reach assumed to be equal to its slope l l 1 a is the cross sectional area of the permeable zone l 2 and k is the hydraulic conductivity of the permeable zone l t 1 the total flowing length of the surface stream network during a timestep l to t i is thus the sum of the total number of reaches within the catchment which are predicted to have surface streamflow multiplied by the length of the active reaches as 7 l to t i j 1 m p f i j l j where l j is the length of stream reach j and m is the total number of reaches in the catchment the underlying assumptions utilized to formulate these equations have largely been informed by empirical data previously collected by others and analytical models applied in headwater catchments where streamflow permanence was monitored or simulated at relatively high temporal resolutions e g goulsbra et al 2014 ward et al 2016 prancevic and kirchner 2019 durighetto et al 2022 3 2 model application this version of dynamic topmodel parameterizes several surface and subsurface storage zones to represent transport of water between an hru and downstream landscape units beven and freer 2001 these include the root zone unsaturated zone saturated zone and an excess storage zone to represent overland flow fig 2 during instances of prolonged drying it is assumed that upstream hrus may be disconnected from downstream hrus or the stream network when storage in the saturated zone is less than the s d max parameter a kinematic wave approximation is then used to estimate the flux of water exiting the saturated zone of the hru as total base flow metcalfe et al 2015 overland flow is routed to downstream landscape units similarly to base flow with the possibility to reinfiltrate if the capacity of the downstream subsurface store is not filled i e the saturation deficit is greater than zero at the end of the simulation a water balance check is conducted to ensure that the hydrologic outputs match inputs metcalfe et al 2015 an overview of dynamic topmodel its implementation and its limitations are given in the si with more in depth information found in beven and freer 2001 and metcalfe et al 2015 we modified the source code of dynamic topmodel to explicitly define connectivity from hillslopes to individual reaches route flow from individual reaches to the outlet of the catchment and simulate whether surface streamflow was present or absent in each reach discharge is routed to the catchment outlet by first defining strahler order within each reach and sequentially routing flow from first order reaches to sequentially higher order reaches using either a network width approach beven 2011 or a finite difference kinematic wave approach e g ward et al 2018 depending on the user s specification within each reach total discharge is uniquely calculated as the sum of discharge from upstream reaches and lateral inflow from the hillslope the model compares the total discharge in an individual reach to the estimated subsurface capacity of the reach to simulate the presence or absence of surface streamflow as shown in eq 4 surface streamflow presence absence is estimated for each reach within falling rock for each timestep which is discussed below we do not separate total flow into subsurface and surface flow in the instream routing subroutine instead flow through the permeable zone is lumped with surface flow and thus upwelling downwelling is implicitly simulated as part of eq 4 and via the instream routing algorithm implemented herein while this is one limitation and source of uncertainty of our approach ward et al 2018 suggests that downstream flow in the surface stream is expected to be highly variable while flow through the subsurface permeable zone is controlled by the subsurface capacity of the reach thus subsurface flow is expected to be relatively constant in time but variable in space due to differences in reach morphology and saturated conductivity this simplification improved the computational efficiency of the instream routing subroutine thus allowing for more robust parameter uncertainty analysis 3 3 model parameterization we parameterized properties of the geomorphic stream network with several datasets the geomorphic stream channel defined here as the visibly identifiable network formed by channelized erosion and deposition godsey and kirchner 2014 was digitized with a 1 5 m digital elevation model and an area threshold approach within taudem tarboton 2005 we iteratively chose area thresholds such that the geomorphic stream network created with taudem closely matched the extent of perennial intermittent and ephemeral streams identified during field reconnaissance by cherry 2006 and fritz et al 2013 the geomorphic stream channel consisted of 3 154 m of first and second order reaches 70 of the total length table s1 we used the dynatopmodel package in r to parameterize the hillslope component of dynamic topmodel metcalfe et al 2015 we calculated contiguous topographic wetness indices twi beven and kirkby 1979 from a 1 5 m dem and combined these with landscape soil characteristics ssurgo u s department of agriculture natural resource conservation service 2012 to generate 20 hrus within falling rock fig s2 we iteratively adjusted the number of times each layer was discretized thus changing the number of hrus generated to ensure prominent landscape features were captured and to minimize the number of hrus generated to optimize model run times we additionally determined the total within hru sum of squares to estimate the variability of twi and soil of each hru beyond 20 hrus little variability of the landscape was captured by the discretization fig s3 average hru area was 0 05 km2 we routed water through the stream network using the network width approach similar to the implementation of dynamic topmodel specified in metcalfe et al 2015 we estimated slope and transmissivity of each reach to parameterize the subsurface transport capacity to simplify computational complexity and limit the number of additional parameters added to the model we initially assumed a constant subsurface transmissivity t within all reaches which was later calibrated while hydraulic conductivity and cross sectional area of the permeable zone are likely to vary within reaches at the catchment scale the constant t assumption should hold in systems where subsurface flow capacity varies as a linear function of reach slope prancevic and kirchner 2019 shanafield et al 2021 we emphasize that this assumption results in a fundamentally reduced complexity simulation of stream network dynamics similar to the approach of ward et al 2018 which may hinder the model s capacity to predict instream disconnectivity and system fragmentation while this assumption is one limitation of our approach as transmissivity likely varies from reach to reach our intention was to parameterize the subsurface using at least a reduced complexity approach rather than disregarding it completely given the previous data collection efforts in falling rock it would have been possible to calibrate a unique t for each stream order in this catchment however this would have added four new parameters to the model instead of one we initially parameterized the model with parsimony in mind rather than complexity which led to the choice of using a single t to simulate subsurface transmissivity future studies may parameterize subsurface capacity of the permeable zone explicitly after conducting field campaigns to measure saturated hydraulic conductivity and depth to bedrock within each reach the presence absence of surface streamflow was predicted in each reach using eq 4 for each time step after total flow and the subsurface capacity had been determined parameter ranges for the dynamic topmodel and instream routing model are recorded in table 1 we derived ranges for several parameters in table 1 from previous application of dynamic topmodel in headwater catchments beven and freer 2001 metcalfe et al 2015 these parameters described the overland flow velocity initial root zone storage channel routing velocity lateral saturated transmissivity maximum effective deficit of the saturated zone and unsaturated zone time delay manning s n values were chosen to represent the range from bedrock and heavily forested channels we used three parameters to simulate the exponential decline of conductivity in falling rock corresponding to the three soil types identified by the u s department of agriculture usda soil survey see fig 1 we extended the lower range of the m parameters defined in this study to better capture the behavior of the rapidly draining soils present in the catchment williamson et al 2015 previous studies have varied m between 0 and 0 1 beven 1997 suggesting that the range used herein is physically plausible we note that the addition of the surface streamflow presence absence subroutine only added one parameter to the model t which represented network wide transmissivity the range of potential t values was derived by determining the range of potential hydraulic conductivities 0 02 0 51 m hr 1 depths to bedrock 0 1 2 2 m and width of the valley bottom 2 0 10 0 m surrounding stream reaches from the usda soil survey and field reconnaissance u s department of agriculture natural resource conservation service 2012 fritz et al 2008 additional information on model formulation application and parameterization is included in the si our objective during model formulation application and parameterization was to discretize the model to simulate catchment scale discharge and surface streamflow presence absence to investigate trends in streamflow permanence over a three year study period to fulfill this objective while maintaining computational efficiency we ran the model at two hour time steps at the reach scale mean length equaled 137 m while upwelling downwelling of streamflow between the surface and subsurface flow is likely to occur at sub meter spatial resolutions and sub second temporal resolutions for example due to turbulent bursting ward et al 2016 using this fine scale temporal resolution for model parameterization would be computationally prohibitive for long term assessment of streamflow permanence within the stream network and would preclude model evaluation and uncertainty analysis thus we did not adopt this highly resolved approach our approach facilitated evaluation of the probability that each reach contained surface streamflow during the three year study period the discharge within reaches and the total stream network with surface streamflow for each time step of the study period at the cost of potentially being unable to capture sub reach scale disconnectivity and system fragmentation because this approach does not focus on simulated exfiltration upwelling or downwelling at a sub meter spatial resolution our simulations are instead representative of streamflow permanence processes at reach and longer spatial scales similar to the approach of ward et al 2018 we discretized our model to balance the assumptions of local scale runoff generation with the ability to apply the model at a catchment scale 3 4 model calibration and evaluation model calibration was carried out using discharge data at the outlet of the watershed to verify model accuracy clark et al 2015a and flow state sensor data collected in four reaches one perennial one intermittent and two ephemeral reaches coupled with maps and surveys of the extent of perennial intermittent and ephemeral reaches throughout the network to assess model fidelity clark et al 2015b holmes et al 2020 additional data in ephemeral tributaries would be required to more comprehensively evaluate the ability of the model to represent stream network dynamics however our objective with model calibration was to develop a model that could give reasonable flow estimates at the reach and catchment scale while simultaneously using adequate data to balance model fidelity and complexity keeping in mind our research questions we used a two stage calibration approach to evaluate discharge and flow permanence predictions in falling rock fig 3 the two stage approach assisted in verifying both model accuracy at the watershed outlet and model fidelity in lower order reaches e g clark et al 2015b holmes et al 2020 in the first stage of evaluation our objective function was to maximize the kling gupta efficiency kge score of the natural logarithm of two hour discharge simulations at the catchment outlet we used the natural logarithm of discharge to better capture variability of low flow periods during calibration given that such periods are critical for many ecosystem services in the central appalachian plateau e g price et al 2012 drayer and richter 2016 and stream drying during low flow periods helped define the hydroperiod of a stream reach shanafield et al 2021 realizations with kge score greater than 0 3 were considered behavioral which represents the midpoint between the kge calculated by the mean of the discharge time series kge 0 41 and a kge score where the simulation matches the observed data perfectly kge 1 knoben et al 2019 we chose a relatively low benchmark in stage one to better understand how variable hydrologic states as predicted with different model realizations impacted the prediction of streamflow permanence within falling rock estimates of reach scale discharge are used as inputs to stage two of model evaluation in the second stage of evaluation we calibrated the network wide transmissivity parameter t by minimizing the overall error between observed and predicted flow state at the four sites where flow state data were collected with sensors for each behavioral parameter set from stage one which included one reach classified as perennial one reach classified as intermittent and two reaches classified as ephemeral fc1 fc4 fig 1 fig s1b we did not classify model realizations as non behavioral in the second stage of evaluation since we were unable to find existing lower benchmarks to assess performance of streamflow presence absence and because the available data in falling rock only facilitated evaluation of our model in two ephemeral reaches stage two produced reach scale estimates of surface streamflow presence absence for each timestep and for each behavioral parameter set identified in stage one of calibration which we then visually compared to maps and surveys of the perennial intermittent and ephemeral extent of stream networks derived from field reconnaissance for additional verification cherry 2006 we then calculated the average flowing length of the network for each time step across behavioral parameterizations to account for potential uncertainty propagated from stage one of evaluation and uncertainty of subsurface transmissivity while these data may not be adequate to evaluate small scale exfiltration upwelling and downwelling processes we found these data facilitated the investigation of streamflow permanence in the catchment at the reach scale the scale at which our questions are relevant additional information on model evaluation is included in the si 4 results and discussion 4 1 model evaluation 4 1 1 simulated discharge evaluation comparison of simulated and observed discharge at the watershed outlet indicated that the model predicted discharge relatively well throughout the study period model evaluation identified 454 parameter sets as behavioral with the optimal parameterization having a kge value of 0 78 fig 4 a and b see optimal parameter values in table 1 the p factor and r factor of the 95 percent parameter uncertainty ppu were 0 67 and 0 47 respectively suggesting adequate model performance dotty plots see fig s4 for the dynamic topmodel parameters shown in table 1 indicated that simulated discharge was sensitive to the exponential decline in conductivity and maximum root zone storage parameters which is consistent with findings from previous topmodel and dynamic topmodel studies beven 1997 beven and freer 2001 metcalfe et al 2015 visual inspection of the simulated time series fig 4a indicated that the model tended to underpredict base flow during late winter early spring and failed to capture several large storm events during summer months we offer several potential explanations for both occurrences first our model is calibrated using the natural logarithm of simulated and observed discharge to better predict recession periods which places greater weight on low flow periods second the implementation of dynamic topmodel in r does not currently consider infiltration excess overland flow metcalfe et al 2015 which may be important during high intensity storm events third convective thunderstorms with spatially variable precipitation rates are common during summer months in kentucky naylor and kennedy 2021 thus the weather station located 2 5 km to the southwest may not have accurately captured the total precipitation in falling rock during several events providing additional rainfall data and calibrating the model to both low and high flow periods may resolve some of these deficiencies however we emphasize the importance of optimizing low flow given recent findings that streamflow expansion and contraction is most variable during low and moderate flow conditions ward et al 2018 additionally given that our modeling objective is to simulate surface flow presence absence we prioritized model performance during low flow periods 4 1 2 flow permanence evaluation we compared simulated and observed flow state in four reaches with variable strahler order which assisted with improving model fidelity of flow permanence simulations see fig 5 simulated flow state in reaches fc1 fc3 was predicted with greater than 95 accuracy over the study period fig 5a c for all parameterizations the performance of the model had little variability in reaches fc1 fc3 despite changes in the calibrated transmissivity parameter and variable model realizations we attribute this to the relative stability of flow state observed throughout the study period in these reaches flow state sensors indicated that fc1 fc3 were generally wet during this period see fig s1 and note that the fc3 sensor was only active during the wet year which we acknowledge is suboptimal for simulating dynamic expansion and contraction at the reach scale however the performance statistics also underscore the model s capacity to accurately predict the presence or absence of surface streamflow in reaches with strahler orders greater than 1 that show the beginning of channelized streamflow see table 2 and fig s5 conversely we observed a trade off between the model s ability to predict flow state in the most distal reach fc4 and the ability to predict discharge at the catchment outlet fig 5d specifically the model realization that predicted fc4 s flow state optimally 87 of the study period had a kge value of 0 45 while the realization with the optimum kge kge 0 78 at the catchment outlet predicted fc4 s flow state correctly 69 of the study period this finding underscores recent sentiment noting the difficulty of validating model performance of semi distributed process based hydrologic models with singular discharge measurements at the catchment outlet and emphasizes that increased data are necessary to verify model fidelity as in this approach ebel and loague 2006 ebel et al 2008 holmes et al 2020 we found that lower predicted transmissivity values in fc4 coincided with high discharge kge values fig 5d and e mean calibrated transmissivity across all behavioral parameterizations was equal to 1 06 m3 hr 1 which agrees with potential transmissivity values estimated from measured saturated hydraulic conductivity and soil depth u s department of agriculture natural resource conservation service 2012 and estimated reach width vesely et al 2008 and likely is representative of the average system transmissivity throughout the headwater network the calibrated transmissivity values likely represent the potential range of transmissivities found in reaches throughout falling rock despite the model s variability in predicting fc4 s flow state flow state was predicted correctly on average 74 of the study period across all behavioral parameterizations in fc4 which confirms the model s relatively strong performance even in this distal reach while the second stage of model calibration did not quantifiably reduce equifinality beven 2006 the pareto front showing the trade off between model performance of simulated discharge and simulated flow state in fig 5d assisted with identification of parameterizations that best represented internal states of the system ebel et al 2008 gupta et al 2009 holmes et al 2020 we were unable to find any existing benchmarks within the literature to classify simulations as behavioral for flow state other than noting that a prediction of 50 would be no better than chance model results indicated that the minimum percentage flow state was correctly predicted in first order and higher order reaches was 64 and 82 respectively across all parameterizations we suggest that these numbers may serve as lower benchmarks of model performance for future modeling efforts in the central appalachian plateau seibert et al 2018 given the importance of understanding headwater streamflow permanence with respect to the federal protection of waterways creed et al 2017 wohl 2017 the vast number of metrics that have been used to assess streamflow permanence e g gallart et al 2012 fritz et al 2020 hammond et al 2021 and the feasibility of utilizing models to simulate such processes as shown here and in previous studies williamson et al 2015 jensen et al 2018 ward et al 2018 botter and durighetto 2020 durighetto and botter 2022 we encourage researchers to further investigate benchmarks to evaluate simulations of streamflow permanence the model evaluation also gives insight into the hydrological processes and controls of streamflow permanence in falling rock our model simulations imply that variability of the subsurface transport capacity within reaches q sub c see eq 5 is controlled primarily by the slope of individual reaches and less by the subsurface transmissivity t see eq 6 this finding was perhaps surprising given that width depth and saturated hydraulic conductivity of the permeable zone were presumed to change throughout the system and thus affect subsurface flow capacity ultimately this result is related to our assumption of a constant subsurface transmissivity used for the stream network which is corroborated by svec et al 2005 who found that stream slope explained the majority of variability when predicting flow duration in eastern kentucky streams recent literature suggests that transmissivity is proportional to upstream contributing area prancevic and kirchner 2019 shanafield et al 2021 as t a γ where γ is an exponent varying between 0 6 and 13 8 determined in mountain ranges located throughout the united states and a is the upstream contributing area in catchments where γ approaches zero transmissivity becomes relatively constant such that the subsurface capacity of the permeable zone throughout the network is a linear function of slope our relatively successful use of a constant simulated transmissivity parameter throughout the stream network suggests that t varies relatively weakly with upstream contributing area in falling rock as evidenced by the consistent model performance in higher order reaches though with variable model performance in fc4 this result also suggests that the γ for falling rock falls towards the lower end of γ values throughout the united states and corroborates findings from prancevic and kirchner 2019 that transmissivity can generally be predicted as a function of geomorphic catchment properties however field reconnaissance could verify this finding and values of t in the catchment the two stage calibration approach did indeed improve our confidence in model fidelity however uncertainty is present to different degrees in reaches where no streamflow permanence data were collected namely our assessment of streamflow dynamics is constrained in other first order reaches given the lack of streamflow permanence data collected in such reaches it was therefore necessary to supplement these data with maps and surveys of hydroperiods derived from field studies as well as assessment of hydroperiod using biological assessments as described below in section 4 2 cherry 2006 fritz et al 2013 data scarcity is a common and perpetual issue in catchment scale hydrologic models and this study further highlights that long term data collection is crucial to better understanding and simulating headwater streamflow permanence our approach does however show promise for transferability to other catchments by potentially using alternative validation approaches to verify model fidelity 4 2 simulated spatiotemporal dynamics of streamflow expansion and contraction the simulated active stream network length varied between 50 4 and 98 2 μ 74 of the geomorphic stream channel throughout the study period see fig 4c to derive the simulated active stream network length we averaged the simulated wetted channel length across all behavioral parameterizations from stage two of model calibration thus accounting for parameter uncertainty propagated from stage one of calibration visual inspection of the simulated time series of the percent of the stream network predicted to have streamflow fig 4c indicated that periods with the lowest flowing stream network length coincided with low flow periods in the late summer and fall which is generally the period with the least amount of precipitation in robinson forest sena et al 2021 the percentage of stream network with simulated surface flow appears to approach an asymptotic limit during low flow periods approximately equal to 50 of the geomorphic stream network length as observed around october 6 2005 fig 4b and c fig 6 a this is likely related to increased residuum lower slope and increased base flow surrounding higher order reaches maintaining surface streamflow annually whereas steeper slopes in low order reaches promote rapid transmission of flow downstream see table 2 shaw et al 2017 antonelli et al 2020 we anticipated that a stepwise decline in simulated surface streamflow length may occur beyond the approximately 50 minimum predicted by the model given sufficient drying of the system especially if flow from fracture conduits is interrupted specifically for third order streams to dry in this system the total volumetric flow rate must be less than a simulated value of approximately 0 06 m3 hr 1 within reaches table 2 fig s5 which our model did not simulate during the study period this flow was observed however for nearly 1 4 of the period between 2000 and 2015 outside of the study period suggesting not only that predicting low flow dynamics over longer periods may improve the model s capability to simulate surface streamflow contraction but that longer duration simulations may be key to characterizing the true end member conditions and likelihood of stream channel drying the model outputs were used to map simulated streamflow expansion and contraction dynamics as hydrologic conditions varied in the catchment fig 6 five events corresponded to approximately the 1st 25th 50th 75th and 98th exceedance percentiles of simulated discharge and the associated percentage of the network with simulated surface streamflow fig 4 and fig 6 respectively simulated streamflow expansion and contraction maps are derived from one behavioral parameterization of the system where the percent of the study period with flow state correctly predicted was greater than 75 and the kge of discharge was greater than 0 7 magenta circle in fig 5d fig 6 the maps suggest that first and to a lesser degree second order reaches generally are surficially inactive during the lowest flow regimes 98 and 75 exceedance discharges but become variably connected via surface streamflow during higher flow regimes for example we found that the 50 exceedance discharge corresponds with a simulated flowing stream network length equal to approximately 68 of the geomorphic stream network 3 49 km we found that 61 and 100 of first and second order streams were predicted to be connected to downstream reaches during this event respectively the ability of the model to map simulated streamflow permanence is important given recent emphasis on procuring data to quantify the frequency and duration of flow in temporary streams jensen et al 2017 creed et al 2017 large variability of simulated streamflow permanence in first order reaches reflects the importance of representing hillslope stream network connectivity in the structure of the model we calculated the average percentage of the study period when simulated surface flow was present within each reach in falling rock across all behavioral parameterizations from stage one fig 7 a higher order stream reaches were predicted to be connected between 85 and 100 of the study period first order streams had the largest variability in simulated streamflow permanence and individual reaches were predicted to have surface streamflow between less than 1 and 71 of the study period we attribute the variability of modeled surface streamflow to the range of slopes within first order streams upstream contributing area of reaches the soil type of hillslopes upstream of reaches and the proximity of hillslopes to the stream network e g bracken et al 2013 fritz et al 2018 leibowitz et al 2018 mahoney et al 2020 the importance of hillslope stream network connectivity is demonstrated in reach 27 and 31 which had similar slope and upstream contributing area but were predicted to have surface streamflow for 37 and 71 of the study period respectively table 2 fig s5 model outputs indicate that first order streams are important contributors to total simulated discharge at the catchment outlet the optimal parameterization resulted in 39 of simulated discharge emanating from first order streams in falling rock previous studies have indicated that quick flow contributes nearly 44 of total discharge in falling rock coltharp and springer 1980 which corroborates our results given that quick flow is generally expected to occur when ephemeral reaches are active the model exemplifies one method to quantify the watershed scale function of headwater systems which in turn may assist with enhancement of headwater protection in future years johnson et al 2010 furthermore this result underscores the importance of hydrologically effective restoration practices of disturbed lands including the forestry reclamation approach williamson and barton 2020 and may be one reason why water quality can be disproportionately affected by disturbance of these small streams fritz et al 2010 we compared the probability of simulated surface streamflow within individual reaches fig 7a table 2 to the national hydrography dataset nhd plus high resolution map which is a coarser and vastly larger mapping effort than ours fig 7b u s geological survey 2018 the nhd plus map overlapped with 27 of the geomorphic stream network from taudem model outputs indicated that nearly 100 of the network coincident with the nhd segment flowed perennially but that an additional 1 215 m of stream length 26 of the geomorphic channel was predicted to flow for 98 of the study period yet was not depicted by nhd nhd plus classified the mapped stream fig 7b as being entirely intermittent we additionally compared simulated streamflow permanence results to localized hydroperiod classification from cherry 2006 fig 7c which further validated model results our model indicated that reaches identified as perennial by cherry 2006 were simulated to have surface flow for 100 of the study period reaches identified as intermittent were simulated to have surface flow between 100 and 56 6 of the study period reaches identified as ephemeral were simulated to have surface flow between 86 5 and 1 0 of the study period while the mapped results from cherry 2006 generally agree with our model outputs our results tended to indicate slightly wetter conditions than the classification from cherry 2006 likely this can be attributed to mapping during a singular instance versus the three year study period which spanned a relatively wet relatively dry and an average year with respect to annual precipitation sena et al 2021 regardless our model results support recent sentiment to improve inventories and understanding of perennial intermittent and ephemeral streams in headwater networks fritz et al 2013 creed et al 2017 leibowitz et al 2018 shanafield et al 2021 4 3 simulated controls of streamflow permanence we plotted average simulated stream length across behavioral parameterizations versus the optimum simulated discharge and fit power functions to the data to evaluate the rate at which the network expands and contracts fig 8 recent literature suggests that the rate of stream network expansion can be measured with reference to discharge at the catchment outlet using a power function linear in log log space godsey and kirchner 2014 shaw et al 2017 whiting and godsey 2016 prancevic and kirchner 2019 antonelli et al 2020 equal to l q β where l is the length of the flowing stream network km q is the discharge mm day 1 and β is an exponent representing the rate at which the stream network expands as a function of discharge at the watershed outlet visual inspection of model results indicated that two distinct patterns of stream wetting and drying occur within falling rock depending on the hydrologic regime of the system fig 8 we developed two regression equations to represent the rate of simulated streamflow expansion and contraction and optimized a threshold discharge q t 1 mm d 1 to maximize the r2 of the two power functions r2 0 93 and r2 0 47 respectively as 8 l 4 33 q 0 17 q q t 4 12 q 0 02 q q t this result indicates that simulated surface streamflow expands relatively quickly during low flow conditions until the threshold of 1 mm d 1 is reached at which point the rate of streamflow expansion decreases by approximately one order of magnitude the active extent of the stream network is predicted to increase by approximately 2 3 km as discharge increases from 0 01 mm d 1 to 1 mm d 1 but only increase by 0 5 km when discharge increases from 1 mm day 1 to 100 mm day 1 this result is supported both experimentally and theoretically by several studies that also found a plateau in the rate of stream expansion above a threshold discharge ward et al 2018 jensen et al 2019 durighetto and botter 2022 we note that we used a static realization of the geomorphic stream network to represent the domain of stream expansion and contraction within falling rock thus channel evolution and channel head migration are not accounted for within the model structure this means that while overland runoff is accounted for with dynamic topmodel metcalfe et al 2015 the instream subroutine does not simulate instances when channelized flow occurs upstream of the geomorphic stream channel future iterations of the model might incorporate sediment transport subroutines that simulate channel head migration to realize a fully dynamic stream network our results indicate that a combination of structural and functional watershed properties control simulated surface streamflow permanence and stream expansion contraction during low flow periods while functional hydrologic influence of stream expansion decreases during high flow periods one potential reason for this is that as the water table rises during low flow periods due to increased precipitation and lateral inflow the subsurface capacity in higher order streams with low slope and large upstream contributing area is initially filled sustaining surface streamflow generally little variability of streamflow permanence was simulated in streams with strahler order greater than 2 fig 7a table 2 suggesting that increasing upstream connectivity of hillslopes and upstream reaches stabilizes streamflow permanence ward et al 2018 jensen et al 2019 prancevic and kirchner 2019 durighetto and botter 2022 perennial reaches tended to coincide with upstream contributing areas of at least 9 2 ha on the other hand significantly more variability in predicted streamflow permanence was simulated in reaches with low strahler order low upstream contributing area and high slope fig 7a table 2 which we attribute to a relatively increased subsurface flow capacity and variable connectivity of heterogeneous upstream hrus these results suggest that during low flow periods a combination of functional processes e g water storage precipitation evapotranspiration and the unique structural properties within a reach e g watershed configuration subsurface flow capacity control the simulated presence absence of streamflow within falling rock we largely attribute the lack of sensitivity of the stream network expansion to hydrologic forcings during high flow periods to the subsurface already being at or above its transport capacity specifically at a simulated outlet discharge of 1 mm d 1 nearly 85 of the geomorphic stream network was predicted to contain surface flow indicating that the subsurface is already at capacity and thus limiting further expansion of the simulated active stream length this result is corroborated by a recent study conducted by ward et al 2018 who found that the flowing length of the stream network was limited despite catchment outlet discharge varying nearly three orders of magnitude during wet conditions notably ward et al 2018 found that the degree of stream network expansion and connectivity greatly decreased for outlet discharges greater than approximately 28 8 m3 hr 1 reported as 8 l s 1 in a 96 ha catchment within the h j andrews experimental forest in the western cascade mountains of oregon usa our results suggest that a similar threshold exists in falling rock at a simulated discharge of 1 mm d 1 which corresponds to a volumetric flow rate of 39 6 m3 hr 1 at the 96 ha catchment outlet we found this result rather surprising given that our studies were conducted in different physiographic regions at opposite ends of the conterminous united states while further investigation could confirm if such thresholds hold true in other headwater catchments this perhaps is one piece of evidence supporting the claim from godsey and kirchner 2014 that despite varying geology topography and climate stream expansion and contraction are phenomena that may be generalizable across systems additionally this corroborates early findings from strahler 1957 suggesting that similar order stream networks behave in a hydrologically similar manner the model outputs suggested that expansion of the simulated active stream length in falling rock falls between systems identified as stable and rapidly expanding in recent literature as represented by the power function exponent β equal to 0 17 during low flow periods e g godsey and kirchner 2014 whiting and godsey 2016 jensen et al 2017 shaw et al 2017 prancevic and kirchner 2019 prancevic and kirchner 2019 summarized β parameters calculated via repeated field mappings of the flowing extent of the stream network and found that β varied between 0 04 and 0 59 μ 0 19 throughout headwater systems in the united states comparatively during low flow periods falling rock was simulated to wet up slightly less quickly than the mean β identified by prancevic and kirchner 2019 indicating that the system is predicted to not be particularly flashy or stable compared to other systems this is consistent with the relatively rapid drainage of sandy soils withing falling rock with sustained surface streamflow attributed to the presence of subsoils with increased fractions of silt and clay during high flow periods the simulated stream network in falling rock expands slower than all other catchments discussed by prancevic and kirchner 2019 as represented by the power function exponent β equal to 0 02 during high flow periods our finding that variable rates of expansion and contraction exist within the network is consistent with results from several recent studies e g ward et al 2018 jensen et al 2019 durighetto and botter 2022 but has been discussed less frequently in studies that determine the rate of expansion via field surveys e g godsey and kirchner 2014 whiting and godsey 2016 jensen et al 2017 shaw et al 2017 it is likely that the shift to a lower magnitude β or an overall nonlinear relationship between l q is typical in most systems given that theoretically there is an upper limit to the amount of discharge that can exist within the geomorphic stream channel during a given hydrologic event however this phenomenon is likely reported less frequently because measurement of flowing stream length is logistically constrained during high flow periods which often only exist over short time scales and are infeasible to map from ground observations for watersheds the size of falling rock or larger these constraints can be overcome by using aerial imagery to characterize stream length at regular intervals e g hooshyar et al 2015 or by applying extensive networks of flow state sensors which extend well into ephemeral reaches e g jensen et al 2019 durighetto and botter 2022 we note that the static realization of the geomorphic stream network to represent the domain of stream expansion and contraction within falling rock is a necessary structural constraint of the model and this relation may be further explored by explicitly considering channel evolution and channel head migration in the model structure we should note that while the power law function fits the l q data well below the 1 mm d 1 threshold the fit of the power law above the threshold is less adequate one particular issue with the application of a power function to represent l q data above the 1 mm d 1 threshold is that the function is monotonically increasing which indicates that at large flows the stream length continues to grow towards infinity albeit at a slow rate we posit however that there is an upper limit to streamflow expansion in the study catchment given that by definition once the geomorphic channel is completely wetted up the network can expand no further noting that we conceptualize overland runoff from hillslopes separately from channelized flow in this context the ability of the power law function to describe the l q relationship begins to break down at higher flow regimes we should note that we used the power law equation to model the l q relationship to compare β coefficients representing stream expansion rates among falling rock and the extensive literature using power laws to represent l q dynamics roberts and klingeman 1972 godsey and kirchner 2014 shaw 2016 whiting and godsey 2016 jensen et al 2017 prancevic and kirchner 2019 antonelli et al 2020 further we applied the power law for both the low and high flow regimes because we wanted to emphasize the change in l q expansion rates above the 1 mm d 1 threshold discharge value recent studies have suggested the use of sigmoid type functions to better represent this l q relationship e g durighetto and botter 2022 and we fitted a four parameter weibull function to the l q data from falling rock with r2 0 97 which corroborates this notion see fig s6 4 4 model limitations and opportunities streamflow expansion and contraction are inherently complex processes resulting from fine scale multi dimensional fluxes godsey and kirchner 2014 ward et al 2016 ward et al 2018 while we emphasize the efficacy of the catchment scale process based modeling approach it is often epistemologically and computationally challenging to discretize models at physically realistic spatial or temporal scales for example increasing the temporal discretization of our model from a two hour timestep to a 15 minute timestep increased the computational time by approximately eight fold and calibrating the model once resulted in nearly 15 gigabytes of data we recognize that high spatiotemporal resolution simulations that capture fine scale processes such as upwelling downwelling flow through alluvial deposits exfiltration from springs and sub reach scale disconnectivity are particularly important for identification of the directionality of streamflow expansion e g bottom up top down or converging goulsbra et al 2014 peirce and lindsay 2015 shanafield et al 2021 and within reach variability of flow state for example minute scale measurements simulations might be required to fully capture rapid stream expansion in flashy systems goulsbra et al 2014 jensen et al 2019 or ephemeral reach dynamics and upwelling downwelling fluxes between the surface and subsurface yet our model simulated low flow dynamics and streamflow permanence relatively well using on average 0 05 km2 hrus fig s3 and approximately 130 m stream reaches at a two hour time step underscoring that investigating various components of streamflow permanence and runoff generation might require variable spatially and temporally scaled models however we should state this model is reliant upon findings from relatively well instrumented hillslope and sub meter streamflow permanence studies to inform the necessary assumptions required to run the model for example as discussed by godsey and kirchner 2014 goulsbra et al 2014 and peirce and lindsay 2015 future streamflow expansion and contraction simulations would benefit from explicitly defined timescales hydrologic processes and model objectives relative to trade offs in model accuracy fidelity and complexity clark et al 2015b golden et al 2017 we aimed to develop a modular framework to simulate headwater streamflow permanence that might eventually be upscaled regionally throughout the united states and are currently testing this framework s applicability in catchments with variable geologic and morphologic properties a key model development opportunity is to improve flow routing in regions with modified or complex subsurface flow e g in tile or ditch drained networks or karst systems e g ford et al 2019 husic et al 2019 evenson et al 2021 additionally the hydrologic dynamics of small surface storage systems e g geographically isolated wetlands or non floodplain wetlands see perspectives for modeling these systems in evenson et al 2015 golden et al 2017 jones et al 2019 which are important for the proper functioning of hydrological and ecological systems globally cohen et al 2016 creed et al 2017 evenson et al 2018 need to be integrated into the model discharge data for first and second order systems is scarce poff et al 2006 nadeau and rains 2007 and likely will remain scarce as the u s geological survey shift focus of hydrologic monitoring to population centers to support infrastructure rather than to headwaters hodgkins et al 2019 u s geological survey 2020 golden et al 2021 we integrated field reconnaissance discharge measurements and flow state monitoring in perennial intermittent and ephemeral reaches to verify our model s streamflow expansion and contraction dynamics however only two of the 12 ephemeral flow reaches identified by cherry 2006 had flow state sensors and thus equifinality and parameter uncertainty indeed are present in the model the use of supplementary validation data such as additional flow sensor measurements and ecological descriptions may improve the fidelity of streamflow permanence simulations seibert and mcdonnell 2002 ebel and loague 2006 clark et al 2015b for example remotely sensed data svec et al 2005 vanderhoof et al 2017 wu and lane 2017 field surveys e g prancevic and kirchner 2019 physiochemical and biological indicators fritz et al 2008 johnson et al 2010 stable isotope tracing stadnyk et al 2013 brooks et al 2018 holmes et al 2020 and estimates of transmissivity via topographic catchment properties e g prancevic and kirchner 2019 shanafield et al 2021 have elucidated the dynamics of hydrologic connectivity and streamflow permanence in recent years and could be integrated as soft data verifying model behavior the procurement and application of such data could be prioritized for future research in coming years and will be especially important for upscaling this model to larger watersheds and regions of the united states with invariably less data than falling rock 5 conclusions we developed a process based catchment scale hydrologic model to investigate the dynamics of surface streamflow permanence and the controls of streamflow expansion and contraction in headwater reaches the framework considered explicit hillslope stream network connectivity using a modified dynamic topmodel approach and estimated the subsurface transport capacity of reaches to simulate the presence or absence of surface streamflow we applied the model to a moderately well monitored catchment in the central appalachian plateau of eastern kentucky usa we found that 1 the model simulated discharge at the catchment outlet and streamflow presence absence within perennial intermittent and ephemeral reaches relatively well albeit with some uncertainty considering hillslope stream network connectivity in the model was particularly important for classifying streamflow in first order reaches where streamflow permanence was most variable in the study catchment 2 model outputs helped to create maps representing surface streamflow extents within the headwater network and to quantify first order reach contributions to total discharge at the catchment outlet model outputs indicate that nearly 39 of total discharge is contributed by ephemeral reaches when comparing model generated maps of streamflow permanence probabilities to current headwater stream inventories in the united states we predicted that 1 215 m of stream length 26 of the headwater network was flowing for at least 98 of the three year study period yet this part of the stream network was not mapped by national inventories this finding underscores the need for improved stream mapping across the united states 3 our model outputs suggested that the interaction of a rising water table upstream hydrologic connectivity and structural properties defining a reach s subsurface capacity control streamflow permanence during low flow conditions but that simulated sensitivity of stream network expansion to hydrologic forcing diminishes during high flow periods recent experimental and modeling studies in headwater systems corroborate this finding despite being geographically dissimilar suggesting that headwater expansion and contraction may have similar controls across systems 4 flow state data interpreted as the presence or absence of surface streamflow assisted with model verification however continuous data to verify streamflow permanence in headwater systems is typically scarce poff et al 2006 and it was necessary to supplement our model verification with field maps and surveys of the extent of perennial intermittent and ephemeral streams prioritizing the procurement and application of data to classify headwater streamflow will enable researchers to quantify the function of headwaters within the context of larger watershed systems this advancement has the potential to enhance the protection of headwater systems in coming years credit authorship contribution statement d t mahoney conceptualization methodology software validation formal analysis investigation writing original draft writing review editing visualization j r christensen conceptualization methodology investigation writing original draft writing review editing visualization supervision h e golden conceptualization methodology investigation writing original draft writing review editing visualization supervision c r lane conceptualization methodology investigation writing original draft writing review editing visualization supervision g r evenson conceptualization methodology investigation writing original draft visualization supervision e white conceptualization methodology investigation writing original draft writing review editing visualization supervision k m fritz conceptualization writing original draft writing review editing visualization data curation e d amico conceptualization methodology software writing original draft c d barton conceptualization methodology writing original draft writing review editing data curation t n williamson conceptualization methodology software writing original draft writing review editing data curation k l sena conceptualization methodology writing original draft writing review editing data curation c t agouridis conceptualization methodology writing original draft writing review editing data curation declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this paper has been reviewed in accordance with the u s environmental protection agency s peer and administrative review policies and approved for publication any use of trade firm or product names is for descriptive purposes only and does not imply endorsement by the u s government statements in this publication reflect the authors professional views and opinions and should not be construed to represent any determination or policy of the u s environmental protection agency usepa this paper has been peer reviewed and approved for publication consistent with usgs fundamental science practices https pubs usgs gov circ 1367 this project was supported in part by an appointment to the research participation program at the office of research and development usepa administered by the oak ridge institute for science and education through an interagency agreement between the u s department of energy and usepa we appreciate helpful suggestions from two internal reviewers at the usepa as well as a colleague reviewer at usgs we also thank gianluca botter and an anonymous reviewer for comments that helped us greatly improve the quality of this work appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129422 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2058,soil erosion is a hydro geomorphic process occurring over the earth surface the observation of soil surface morphology during ongoing rainfall at fine spatial and temporal scales are critical for the study of soil erosion a digital close range photogrammetric observation system based on wireless networking technology was explored and established in this study through wireless networking multi cameras were concurrently controlled solving the problems of synchronous acquisition of underlying digital image big data transmission and storage image sensors collected data in parallel based on network command and noise on the images such as raindrops was eliminated based on the k means clustering algorithm by serialization technology during data acquisition after parallel preprocessing high density 3d point clouds and digital elevation models dems were reconstructed the evolution of soil surface topography was dynamically monitored by instantaneous image acquisition at different time intervals during ongoing rainfall the results showed that the measurement precision of the established system could reach a sub millimeter level with the minimum single measurement error being 0 0069 mm the maximum error between check point coordinates generated by photogrammetry and those generated by a total station was 5 7 mm on the horizontal axes and 9 6 mm on the vertical axis the temporal and spatial resolutions of the observation system were 1 min and 2 mm respectively compared with a runoff sediment collection method the average relative error of the system for estimating soil loss was 5 63 and the accuracy of single observation was up to 99 58 the observation methods explored in our study provided a reliable way to monitor soil erosion processes which was also helpful to analyze the role and influence mechanism of soil erosion in surface hydrological process keywords digital close range photogrammetry system soil surface morphology soil erosion digital point cloud camera calibration accuracy evaluation data availability the data that has been used is confidential 1 introduction soil erosion is a hydrological geomorphic process occurring on the earth surface it not only shapes landforms but also strongly interacts with global carbon cycle and climate processes becoming a key factor affecting ecological and hydrological processes the visualization and quantification of soil surface morphology during ongoing rainfall at fine spatial and temporal scales are of great significance to the study of soil erosion soil erosion is a ubiquitous environmental problem with significant impacts on agricultural production water quality hydraulic structure and biogeochemical cycles of the earth heng et al 2010 oz et al 2017 balaguer puig et al 2018 it is also a natural process of detachment transportation and deposition of soil particles lal 2003 guo et al 2016 during an erosion event the soil surface is continuously forming and the erosion processes are usually manifested as changes in the soil surface topography balaguer puig et al 2017 oz et al 2017 quantification of soil surface topography and estimation of its changes in each erosive stage can be conducted by digital elevation model dem analysis takken et al 2001 balaguer puig et al 2017 oz et al 2017 as sequential differencing of dems allows for robust estimation of space time averaged transport rates and the distribution of erosion and deposition brasington smart 2003 to obtain and generate dems with sufficient resolution for micro topographic analysis techniques and such as laser scanning and photogrammetry have been developed abd elbasit et al 2009 nouwakpo huang 2012 vinci et al 2015 while laser scanners have proven their usefulness and high spatial resolution in many experiments each scan takes a long time and data may be missed due to the linear laser transmission govers et al 2000 guo et al 2016 in addition the laser scanner cannot be used to monitor the surface during going rainfall consequently the temporal resolution of laser scanning devices is not sufficient to produce time sequences of rapidly changing soil surfaces rieke zapp et al 2001 by contrast a photogrammetric system allows for more rapid data acquisition enabling the possibility of instantaneous data capture furthermore the emergence of digital close range photogrammetric technology has significantly improved the efficiency of photogrammetric dem generation by allowing the use of inexpensive high resolution digital cameras and highly automated data processing leduc et al 2019 within the last few years studies have been conducted that make use of the advantages of photogrammetric technique which is fast flexible and simple to use in terms of data acquisition and post processing to achieve sequences of the continuous process monitoring of landforms the photogrammetric technique for example has been utilized in soil erosion observations eltner et al 2017 rockfall detection blanch et al 2021 snow depth measurement filhol et al 2019 land slide tracking gabrieli et al 2016 and volcanology galland et al 2016 the study presented in this paper relies upon photogrammetric techniques to generate soil surface dems during rainfall events soil erosion is a continuous process to observe the evolution of erosion and monitor soil surface topography at both fine temporal and spatial scales digital close range photogrammetric observation technology has been widely used brasington smart 2003 rieke zapp nearing 2005 heng et al 2010 momm et al 2018 yet few studies have been able to monitor ongoing soil erosion processes during rainfall events to address this issue our research group developed a hand held digital close range photogrammetry system v1 0 to observe a soil surface during ongoing rainfall in which raindrop interference during image acquisition was avoided by constraining the field of view guo et al 2016 an industrial camera having a high frame rate was used to acquire highly overlapping images and noise caused by raindrops was mostly deleted as it represented unstable homologous points in different images this hand held observation system mostly avoided raindrop noise but it did not fully solve the raindrop issue in addition the hand held scanning approach constrained the observation area and the resolution of the photogrammetric observation at the temporal scale as an observation of a 1 5 m soil bin needed 2 min this time was used to bring the camera into position and walk around the soil bin but the soil surface could change greatly within this 2 min therefore how to capture instantaneous images of the underlying soil surface without the interference of raindrops become a new issue in addition matching many highly overlapping images required a large computing effort so parallel computing techniques were used which restricted its utilization by the ordinary users therefore how to transmit store large data and calculate three dimensional point cloud information quickly and easily became our focal issue in soil erosion monitoring based on a previous study by guo et al 2016 the objective of this study was to develop an improved digital close range photogrammetric observation system v2 0 to monitor soil surface morphology at both fine temporal seconds level and spatial mm level scales during ongoing rainfall specifically we aimed to 1 capture instantaneous images concurrently and remove the noise caused by raindrops 2 assess the precision and accuracy of our new developed photogrammetric observation system and 3 monitor soil erosion and morphological evolution during ongoing rainfall 2 material and methods 2 1 design of a digital photogrammetric observation system the digital photogrammetric observation system employed in this study is coupled with close range photography technology and wireless networking technology which can instantly capture the surface microgeomorphology with high spatiotemporal resolution during ongoing rainfall jiang et al 2019 this system realizes the visualization of rill evolution process thus providing a new technical means for the study of soil erosion process mechanism the digital photogrammetric observation system is composed of three subsystems the image acquisition subsystem the data transmission subsystem and the image calculation subsystem fig 1 all functional subsystems of the system are run under the control of a high capacity pico participant intervention comparison outcome computer with windows 7 operating environment the corresponding software system is developed for each functional subsystem named z map fig 2 which includes camera working condition diagnosis image acquisition image calculation and other functional interfaces 2 1 1 image acquisition subsystem the image acquisition subsystem is responsible for the acquisition of digital images of the underlying eroding soil surface the reception of trigger signals and the removal of raindrops the hardware part of the system is mainly composed of n cameras and industrial control units dc power supply target waterproof adapters and other components fig 3 a and 3b the software part is composed of the image acquisitions unit of z map software on the pico computer after triggering the image acquisition signal all n cameras collect the soil surface digital images in parallel here n is the number of cameras and control units which is determined by the observation area and the required observation resolution of the soil surface by means of the wireless router all groups of digital image collectors are networked through a transmission control protocol internet protocol tcp ip network to synchronize the operation of image collectors and obtain soil surface information at concurrent time intervals each group of digital image collectors includes one digital camera and a dedicated industrial computer the camera used in this system is a sony cmos camera with a resolution of 3264 2448 and its specific parameters appear in table 1 the power supply is responsible for power supply to the camera and industrial computer the industrial computer controls the image acquisition and raindrop removal of the camera 2 1 2 image calculation subsystem the image processing system is mainly responsible for image digital point cloud matching three dimensional reconstruction and point cloud reparation a custom computer system consisting of a host computer and nine parallel computers designed by guo et al 2016 was used the host computer is responsible for assigning tasks to parallel computers monitoring parallel computer processes optimizing schedules on parallel computers and collecting results from parallel computers the software of the image calculation subsystem consists of three modules a parallel computing management module a point cloud matching and editing module and a point cloud reparation module fig 2 during the development process of each module algorithm python language was used to cooperate with the numpy numerical python computing library to conduct prototype research and development and then c language was used to re implement the program 2 1 3 image transmission subsystem the image transmission subsystem plays a connecting role between the acquisition system and the solution system it is mainly responsible for the control of command sending signal receiving and image data transmission a wireless router tcp ip and gigabit network hardware interface are the main hardware units of the image transmission subsystem each subsystem constitutes a local area network through the wireless router the control and calculation units issue concurrent acquisition commands through the wireless network the image acquisition system collects images and works concurrently the collected images are then transmitted to the image processing system through the transmission subsystem 2 2 camera calibration the correspondence between the coordinates of the target surface points and their pixel coordinates in the two dimensional image is determined by the geometric imaging model of the image collector zhang 2000 camera calibration is the process of solving the parameters of the imaging model the parameters of the camera include internal and external parameters the internal parameters include the focal length f of the camera the and y coordinates of the main point of the image cx cy and the distortion parameters distortion parameters are generated by a certain deviation and deformation between the camera image and the actual image including radial distortion coefficients k1 k2 and k3 tangential distortion coefficients p1 p2 and other transformation coefficients b1 b2 the external parameters include the projection center x0 y0 z0 and three rotation angles ψ ω κ of the camera when the image is taken in this paper the calibration test was carried out in the experimental hall of the state key laboratory of soil erosion and dryland agriculture on the loess plateau the test site is a hydraulic adjustable gradient steel soil tank of 10 m long 4 m wide based on the theoretical basis of a pinhole imaging model with the help of a checkerboard fig s1a the initial values of the camera s internal parameters and distortion parameters are calculated by the linear imaging target model and nonlinear imaging model respectively and then they are continuously optimized through continuous iterative operation then the external parameters of the camera were calculated based on the internal parameters of the camera and 102 control points fig s1b the development platform of microsoft visual studio and open source computer vision library opencv were used to write camera calibration program of solving the camera parameters 2 3 raindrop removal during image acquisition during rainfall the spatial distribution of raindrops is similar to that of random fields the images taken by the camera mix two kinds of information including raindrops and underlying objects over a short period such as a few seconds the underlying surface can be regarded as a stable spatial object the main change is the highly random rainfall therefore raindrops can be removed by serialization observation technology to take a sequence of images of the underlying surface in a short time and raindrop noise can be removed from the sequence of images specifically there are three kinds of data comprising the sequence image the brightness data of the underlying surface itself the random brightness data of the rain field and the noise data of the camera system considering that the noise data of the camera is a kind of white noise we only classify the data of sequential images into the brightness data of the underlying surface itself and the random brightness data of the rain field through an industrial computer the digital images collected by each group of sensors are sorted by time and the gray value of each pixel is processed by ternary classifications the noise generated by raindrops on the digital images is removed by the k means algorithm wang et al 2018 wangchamhan et al 2017 the specific algorithm process is as follows 1 the construction of a pixel dataset in the digital close range photogrammetry observation system each camera collects 60 raw pictures within 5 s for each shooting the pixels pix i j in the image sequence of a single camera in one shooting constitute a pixel dataset d p i x i j 1 p i x i j 2 pix i j m m 1 2 3 60 i 1 2 3 3264 j 1 2 3 2448 fig 4 here m is the number of images from one camera with one shot i is the row number of the pixel j is the column number of the pixel and d is the dataset 2 assigning the number of clusters k in this study k was assumed to be 3 due to the brightness of the pixels cluster 1 is the darkest pixels on the image cluster 2 is the brightest pixels on the images due to rain and fog interference which shines on the image after light reflection and cluster 3 is the middle brightness pixel between the darkest cluster 1 and the brightest cluster 2 3 determining the centroid for each cluster the centroid for each cluster is determined as c 1 n c 2 n and c 3 n where the superscript n is the number of iterations and the subscript 1 2 and 3 are the clusters the initial centroid for each cluster was calculated as follows 1 c 1 0 min pix i j 1 p i x i j 2 p i x i j m 2 c 2 0 max pix i j 1 p i x i j 2 p i x i j m 3 c 3 0 max pix i j 1 p i x i j 2 p i x i j n min pix i j 1 p i x i j 2 p i x i j m 2 4 grouping the pixels into clusters for each pixel pix i j in dataset d the euclidean distance that described the difference between pixel values and was calculated to measure the distance from the data point to the centroid and each pixel pix i j was assigned to the nearest centroid to form new clusters 4 d 1 p i x i j c 1 0 5 d 2 p i x i j c 2 0 6 d 3 p i x i j c 3 0 7 d 1 pix p i x min d 1 d 2 d 3 here d 1 is the distance between pixel and c 1 0 d 2 is the distance between pixel and c 2 0 d 3 is the distance between pixel and c 3 0 d 1 is the dataset with the updated clusters 5 recalculating the centroids for all clusters all data points of each cluster were summarized and then averaged to construct new centroids 8 c 1 1 p i x 1 1 p i x 1 1 9 c 2 1 p i x 2 1 p i x 2 1 10 c 3 1 p i x 3 1 p i x 3 1 11 c k n p i x i n p i x i n here c k n is the centroid of cluster k n is the number of iteration 6 convergence the steps in 4 and 5 were repeated until convergence or c k n c k n 1 10 6 or n 2000 finally the data points were classified into 3 clusters and the clusters with the highest and lowest values were removed as the noise the gray value of the intermediate clusters was assigned to the computed pixel cell to obtain the clean images after removal of raindrops noise 2 4 3d reconstruction the process of reconstructing three dimensional 3d information of a soil erosion surface from multiple overlapping two dimensional 2d images of the soil surface is known as 3d reconstruction in this study since the soil surface was reconstructed based on multi camera fixed field thus camera parameters calibrated in advance were directly applied to 3d reconstruction image feature extraction and point cloud matching were the first step in 3d reconstruction before point matching calculation moravec 1981 and sift scale invariant feature transform operators were used as two tools to extract features moravec was a corner detection operator based on gray level variance that calculated the gray level variance of a pixel in an image along the horizontal vertical diagonal and anti diagonal directions the minimum gray variance value was generally selected as the pixel interest value the sift operator was an image local feature description operator which remained unchanged even after the image was scaled rotated or affine transformed lowe 2004 due to the high efficiency and fast speed of the moravec operator it could provide the initial value for the feature point extraction sift however had better performance in terms of accuracy density anti rotation and resistance to brightness changes and could further densify the initial value point cloud matching was a process of matching homologous points based on the similarity of feature points and their descriptors and the strategy of coarse to fine was adopted in the matching process we first used the correlation coefficient algorithm of the image to roughly match a batch of homologous points based on the feature points obtained by the moravec operator after the sift feature points were optimized for matching the random sample consensus ransac algorithm fischler and bolles 1981 was used to eliminate the wrong matching points the best image arrangement was found in multiple images through block adjustment after obtaining homologous points thereby acquiring the position information of the image and the spatial coordinate information of the homologous points the block adjustment was an air triangulation adjustment method that used the area formed by multiple routes to carry out overall adjustment since the point cloud reconstructed was too sparse the multi view stereo mvs based on semi global optimization was used to reconstruct the dense point cloud zhao et al 2018 hirschmüller 2008 under actual rainfall conditions point cloud matching encountered many difficulties when a soil erosion channel appeared runoff accumulated along the channel resulting in a sparse point cloud at those locations in the flow channel to resolve this issue inverse distance weighted idw interpolation watson and philip 1985 was used to repair the sparse point cloud in flooded or vacant areas before the construction of dems cyclone 6 0 3 software wu et al 2018 was used to identify and remove outliers and noise points at the edge of the soil bed by visual inspection dems were generated with 3d analyst tools in esri arcgis 10 2 software based on the digital point clouds jiang et al 2020 the ground sample distance gsd worked out to be approximately 1 5 mm rill networks at different time points were extracted from the dems based on the d8 eight direction algorithm o callaghan and mark 1984 using the arcgis hydrological analyst tools in arcgis 10 2 fig 5 2 5 precision and accuracy test for the established system to test the precision of the established photogrammetric observation instrument the length of a selected ruler was measured 60 times under the same light conditions the standard deviation δ was calculated to reflect the measurement precision the accuracy was the deviation between the measured value and the actual value which was measured by the relative error ω physical observations were conducted by setting three grooves of known length width and depth actual value and the digital photogrammetric observation method was used to acquire the images of the grooves under different rainfall intensities 30 60 90 and 120 mm h 1 to measure and calculate their geometric size measured value the formulas of standard deviation and relative error are as follows 12 δ i 1 n x i x 2 n 1 13 ω i x i x x 100 where ω i is the relative error of observation i x i is the observed value x is the average of all observations x is the actual value and n is the number of observations 2 6 dem quality assessment 50 control points were placed on the soil surface 6 of which were randomly selected to participate in the 3d reconstruction of photogrammetry and the remaining 44 independent points were used as check points the quality of the dem was assessed by comparing modelled elevations to a set of independently surveyed check points the quality of a dem depends not only on the local morphology complexity aguilar et al 2005 but also on the number and distribution of matching feature points also known as mass points identified by the image matching algorithm the coordinates of all point on the slope were measured at two sites using a total station and the 44 check points were used as references to illustrate the suitability of the digital photogrammetric observation system fig s2 the two sets of measurements were then combined in a least square coordinate system transformation procedure to yield the best coordinate estimate meanwhile the digital photogrammetric observation system was used to observe the slope and generate a dem the measurement results of the check points obtained from the two observation methods were compared 2 7 application of the established photogrammetric observation system 2 7 1 laboratory experimental design 2 7 1 1 rainfall simulator system all experiments were conducted in the state key laboratory of soil erosion and dryland farming on the loess plateau we used the digital photographic observation system to monitor the slope erosion morphology in a set of long time series simulated rainfall experiments the artificial rainfall simulation system is composed of 56 group nozzles and mounted at 18 m above the flume bed to ensure the terminal velocity of rain drops zheng and zhao 2004 fig s3a each group of nozzles is composed of three nozzles with diameters of 6 35 mm 12 7 mm and 19 05 mm respectively fig s3b the adjustable range of rainfall intensity is 30 350 mm h 1 before the start of each rainfall experiment we conducted the rainfall intensity of the rainfall simulator was calibrated to make it close to the designed rainfall intensity zhang et al 2016 fig s3c the rainfall intensities in the experiments were 30 mm h 1 and the nozzle size and pump pressure were adjusted to 41 and 22 kpa and 26 and 250 kpa respectively moreover the uniformity coefficient k of rainfall was calculated using the following formula 14 k 1 p m 15 p m a m n where m is the average rainfall amount m a is the rainfall amount at a given rainfall collection point and n is the total number of rainfall collection points 2 7 1 2 experimental procedure the experimental plots were 10 m 1 5 m 0 7 m steel soil bins set at a gradient of 10 to the horizontal fig 6 the lower end of the bins was equipped with instruments to measure the real time runoff and sediment concentration in surface flow soil used in the two experiments was loess which is common in the loess plateau of china the soil texture was composed of 23 1 sand 62 0 silt and 15 9 clay in order to keep consistent with the field soil as far as possible an in situ investigation was conducted to measure the soil bulk density and moisture content of the natural soil of ansai county of the loess plateau before the test soil samples were collected from 6 sampling points and the sampling depths of each point were 10 cm 20 cm 30 cm 40 cm 50 cm and 60 cm each sampling was repeated twice the soil bulk density and moisture content in the 0 60 cm soil layer ranged from 1 03 to 1 44 g cm 3 and from 3 47 to 14 24 respectively fig s4 vertically the soil moisture increased with an increase of soil depth as a whole therefore the bulk density of the upper 20 cm and lower 30 cm of the test soil was set as 1 1 g cm 3 and 1 2 g cm 3 respectively and the soil moisture was set at about 10 to be consistent with natural soil before filling the soil bins the crushed dry loess soil was passed through a 10 mm sieve to remove large particles of debris such as organic matter and gravel shen et al 2015 rainfall intensity was measured using rain gauges at regularly spaced points on the soil surface before each experiment ran giving us information on the spatial and temporal variations in rainfall before the formal experiments the soil surface was subjected to 30 min rainfall with a rainfall intensity of 30 mm h 1 every day for 7 days to pre wet the soil surface after standing still for 7 days to allow the soil moisture to penetrate fully inside the soil bin the soil surface was subjected to five simulated rains at an intensity of 30 mm h 1 for about 640 min 2 7 2 data collection runoff and sediment were monitored in real time and synchronously calculated by the runoff and sediment measuring instrument fig 3a the accuracy test results of the monitoring instrument showed that the average relative error between the real value of sediment concentration and the measured value was 3 67 and the detailed descriptions about this instrument were shown in zhan et al 2017 and zhan et al 2021 in order to ensure the data reliability of the monitoring instrument the sediment concentration precision was evaluated using the results obtained by drying and weighing method in this study the comparison results showed that the error between the two observation methods was less than 3 at the same time of collecting runoff and sediment the erosion morphology of the soil surface was monitored by the digital close range photogrammetry system at five minute intervals until the end of rainfall the overlapping degree of the collected image was at least 4 and the frame rate was no less than 15f s the time for each image acquisition was about 1 min six targets were placed around the soil bin to constrain the length of each observation additionally before the beginning of rainfall and after the end of rainfall the underlying surface terrains were acquired by a 3d laser scanner leica scanstation 2 manufactured by leica in switzerland to independently evaluate the accuracy of the digital close range photogrammetric observation system after the image collection of the entire rainfall process was completed the data processing followed the entire technical flow chart is shown in fig 7 2 7 3 defining rill morphological indicators in order to quantify the rill morphological characteristics and reveal the development process of the rill on the slope we extracted the rill networks from the dem using the arcgis hydrological analyst tools the density of the derived flow network was determined by a confluence threshold which was calculated by the confluence function after multiple attempts the optimal confluence threshold chosen in this study was 400 in addition to the rill density another six morphological indicators were also defined to describe rill morphology including maximum rill length maximum rill depth rill density splitting degree plane area of the rill rill width depth ratio and fractal dimension the parameters of rill density splitting degree plane area of the rill and rill width depth ratio were extracted by the profile analyst module of the surface analyst tool rill density is the total length of all rills in the unit study area bewket and sterk 2003 reflecting the degree of slope fragmentation the calculation formula is as follows 16 ε n 1 m l tn a 0 where ε is the density of the rill m m 2 a 0 is the surface area m2 of the study slope l tn is the total length m of the n th rill and its bifurcation on the slope n is the rill number n 1 2 m and m is the total number of rills the splitting degree is defined according to the ground cleavage degree which refers to the sum of the total surface area of all rills in the unit study area it is a dimensionless parameter and can reflect the distribution of rills intuitively the calculation formula is as follows 17 ω n 1 m a n a 0 where ω is splitting degree and a n is the surface area of the n th rill on the slope m2 rill width depth ratio refers to the ratio of rill width to the corresponding depth this parameter is a dimensionless parameter the calculation formula is as follows 18 r w d i 1 n w i i 1 n d i where r w d is the rill width to depth ratio w i is the width of the rill at the i th monitoring point and d i is the depth of the rill at i th monitoring point n is the total number of monitoring points on the slope the fractal dimension is a morphological parameter that describes the degree of complexity and organization of the rill network zhang et al 2017 zhang et al 2019 the box counting dimension is defined as 19 n θ g θ d 20 d lim θ 0 ln n θ ln 1 θ where n θ is the number of a box covered by rill grids θ mm is the box size d is the fractal dimension and g is a constant the number of box covered rill grids changed with the value of θ so an ordinal pair of the form ln n θ ln 1 θ could be obtained the least square method was used to fit a straight line and the box counting dimension d was the slope of the straight line the fishnet tool in arcgis10 2 software was used to create boxes of different sizes and the box sizes chosen in this study were 2 mm 4 mm 6 mm 8 mm 10 mm 20 mm 40 mm 60 mm 80 mm 100 mm 120 mm 140 mm 160 mm 180 mm 200 mm 220 mm 240 mm 260 mm 280 mm and 300 mm respectively the number of boxes covered by rill grids was determined through the intersection of the fishnet layer and rill grid layer feature position which was counted by using the attribute query function in the attribute table of arcgis 10 2 fig 8 shows the procedure for creating a fishnet 2 7 4 hack profile and gradient hack profile describes the overall change characteristics of river longitudinal profile we used the hack profile in this study to characteristic the longitudinal profile of the main erosion rills on the slope to analysis the sedimentation and erosion process of well developed rills during the rainfall the hack logarithmic equation was used to convert the longitudinal profile to the balanced profile hack 1973 the hack logarithmic equation was expressed as follows 21 h c k log l k 0 where l is the distance from the monitoring point to rill head h was the elevation of hack profile and c and k are constants that are calculated based on the coordinates of the maximum and minimum elevations on the longitudinal profile the gradient g is used to reflect the evolution of the rill and characterize the hydrodynamic conditions and sediment transport capacity of water flow the gradient is defined as follows 22 g δ h δ l where δ h is the change in altitude and δ l is the change in length 3 results 3 1 evaluation of raindrop removal fig 9 shows 59 raw images and 1 image after raindrop removal of the same area obtained during ongoing rainfall we randomly selected the brightness values of the same pixel position in 60 images for statistical analysis fig 10 the results showed that the brightness values on the three channels r g and b of the 59 raw images were all different which indicated that raindrops interfered with the acquisition of images moreover the overall change trend of brightness value in the 59 raw images was to first increase then decrease and increase again fig 11 shows the variance of the pixel values on each image which was similar to the trend of the single pixel brightness value described above the variance of the brightness value first increased then decreased and then increased with the increase of image number but notably in the images numbered 30 45 the peaks appeared on all three channels of a single pixel while the variance of each image had the lowest value combined with the brightness of the raw images in fig 9 the brightness in images 30 40 gradually increased and then gradually decreased in images 40 45 due to the interference of raindrops the brightness turned at the 40th image resulting in a brightness peak and the camera captured the most raindrop information which made the brightness value of the whole image relatively concentrated resulting in the lowest variance therefore the interference of raindrops increased the brightness of the images furthermore the variation ranges of a single pixel value on the three channels r g and b of these 59 raw images were 111 159 110 193 and 77 186 respectively while they were 110 106 and 73 respectively in the pixel after raindrop removal which was lower than the raw images therefore the k means algorithm is an effective method for removing raindrop noise 3 2 precision and accuracy assessment of the photogrammetric system 3 2 1 precision of the photogrammetric system to test the precision of the newly developed digital photographic observation instrument 60 length measurements of a selected ruler were conducted fig 12 the results showed that the average length of the ruler was 407 58 mm and the standard deviation was 1 42 mm the results showed that the measurement precision of the established system could reach a sub millimeter level and the minimum single measurement error is 0 0069 mm the histogram and normal qq plot of the observed value showed a normal distribution skewness 0 334 kurtosis 1 287 indicating high precision of the designed observation instrument 3 2 2 accuracy of the photogrammetric system to test the accuracy of the newly developed digital photographic observation instrument the length width and depth of three grooves with fixed dimensions and known size actual value were observed under different rainfall intensities and slope gradients the observation results showed that relative error between the measured value and the actual value ranged from 0 01 to 3 12 under 90 mm h 1 rainfall intensity on gradients of 0 5 10 and 15 with the observation accuracy in all cases being 96 table s1 the average relative errors under the four different slopes were 0 59 0 64 0 66 and 0 67 the frequency distribution histogram showed that the relative error of observation was mainly distributed in the range of 0 1 which accounted for about 77 7 fig 13 a in addition the observation results under the conditions of slope of 15 and rainfall intensity of 30 60 90 and 120 mm h 1 showed that the minimum relative error and maximum error were 0 and 4 62 respectively and the observation accuracy in all cases was 95 table s2 the average relative errors under the four different rainfall intensities were 0 72 0 76 0 67 and 0 97 the proportion of relative error between 0 and 1 also accounted for 77 7 fig 13b the above results showed that the digital photographic observation system was accurate in the observation of the geometric dimensions of the soil erosion slope and the rain intensity and slope had no significant effect on the observation accuracy of the system 3 3 dem accuracy fig 14 shows the comparison between the check point coordinates obtained using our developed photogrammetric observation method and those obtained using the total station the residuals of the check point transformation from the photogrammetric coordinate system to the total station coordinate system are a measure of the differences between the two technologies the residuals on the x axis were within 5 mm on the y axis were within 4 mm and on the z axis were within 10 mm the rmse values of the residuals for the x y and z axes were 2 072 1 741 and 4 507 mm respectively the histogram of differences is approximately normally distributed with a relatively narrow spread and high kurtosis fig 15 this result is confirmed by the low standard deviation of errors sde 4 51 mm and the maximum absolute error 9 6 mm these results are encouraging as the sde compares well with the maximum theoretical vertical precision 1 4 mm afforded by the image resolution however the distribution of errors is not centered about zero and the mean error of 0 907 mm suggests that the photogrammetric elevations are systematically higher than observed 3 4 soil erosion and morphological evolution 3 4 1 rill development morphology fig 16 shows the digital point cloud of the erosion surface at different intervals which clearly demonstrated the evolution process of the erosion landscape at different intervals even after the soil bed surface was subjected to 210 min of rainfall with an intensity of 30 mm h 1 during the pre wetting period no significant changes in the topography of the soil bed surface were observed fig 16a when the rainfall lasted for 255 min only a small and shallow drop appeared on the slope but it was not obvious in the point cloud fig 16b the erosion rills that were 1 4 m away from the bottom appeared after 10 min and the dimension of the erosion rills was 0 17 m long and 0 16 m wide fig 16c when the rainfall had lasted for 285 min the rills developed slowly along the slope and the erosion pattern gradually became obvious fig 16e with rainfall proceeding the rills on the slope surface gradually retreated along the opposite direction of water flow under the action of retrogressive erosion at 330 min a branch was formed at the head of the rill fig 16g the rills and its branch not only extended upstream but also branched into multiple rill branches along both sides fig 16i subsequently the rill branches developed and gradually crossed and merged as rain continued and finally formed three main rill branches in 570 min fig 16j the three branches gradually underwent traceable erosion and reached a stable state until the end of the rainfall fig 16k m during the period of 570 850 min although the rill morphology increased insignificantly along the slope and horizontal direction the erosion depth increased due to the occurrence of undercut erosion 3 4 2 quantitative description of rill morphology different statistical indicators of rill morphology at different time intervals are presented in table 2 the rill networks extracted from dems at different time intervals are illustrated in fig 17 the rill density ε maximum rill length mrl the splitting degree ω the rill plane area pa and the fractal dimension d gradually increased as the rainfall proceeded while the rill width depth ratio r w d decreased with time table 2 moreover the maximum rill depth mrd increased first and then decreased and then increased again and decreased the uniformity and density of rill network distribution were enhanced with time and the cross merging phenomenon between the rills became more obvious resulting in the rill network becoming gradually more complex fig 17 the rill density increased from 0 279 m m 2 to 6 658 m m 2 from 255 to 640 min which was consistent with the changing trend of rill network morphology at the end of the rainfall the mrl and mrd were 1 078 m and 0 249 m and they accounted for 10 78 and 49 8 of the slope length and depth respectively the pa of the rill was 2 169 m2 which accounted for 14 44 of the total slope area however the r w d decreased from 3 636 to 1 870 with time which indicated the increment of rill width was less than that of depth moreover the fractal dimensions of the rill patterns varied from 1 218 to 1 436 from the beginning to the end of the rainfall showing that the rill networks had obvious fractal characteristics 3 4 3 the longitudinal profiles of the main rill at the end of rainfall the rills developed slowly and gradually stabilized and the erosion and deposition basically reached a balanced state therefore in order to describe the sedimentation and erosion process of well developed rills during the rainfall in this study we extracted the longitudinal profile of the main rill between the rill head and rill outlet in the slope fig 18 as the rainfall duration increased the rill length increased and the distance between the rill head and lowest point of the main rill increased the length of longitudinal profile along the slope gradually increases and the elevation of the longitudinal profile at each time point decreased first and then increased furthermore the maximum elevation of the balanced longitudinal profile gradually increased and the arc of the depression became larger over time the gradient curve from the rill head to the outlet fluctuated and decreased continuously the overall trend of the gradient curve was very close to the hack profile 3 5 laser scanning and photogrammetric observation table 3 and table 4 are the comparison results of point cloud and elevation differences between two observation methods point cloud density and dem resolution obtained by photogrammetric observation and laser scanning are 0 525 mm2 and 2 05 mm 0 347 mm2 and 2 37 mm respectively which indicates that the object size represented by each single point cloud obtained from photogrammetric observation method is smaller moreover it can be seen from the maximum and minimum values of the point cloud density that the point cloud obtained by the photogrammetry is more evenly distributed than the laser scanner table 3 from our results in table 4 the mean error standard deviation of error and maximum absolute error of the elevation differences between the two observation method increase gradually with the application of rainfall which yield the best agreement before rainfall is applied between the laser scanner and digital photogrammetry 4 discussion 4 1 performance of the methodology 4 1 1 raindrop removal we used the photogrammetric observation system to obtain point clouds of soil erosion slopes and monitor the evolution patterns of rills during ongoing rains rieke zapp et al 2009 and nouwakpo et al 2012 also proposed a photogrammetric technique for generating dems of soil surfaces with high spatial and temporal resolution however the methods they proposed were developed for different experimental background conditions than the one proposed in this study the method proposed in this study was intended to solve the problem of difficult observation during ongoing rainfall while their methodology could only obtain a dem in the absence of rainfall raindrop interference was the main factor affecting the observation accuracy so raindrop removal from images was of great significance to restore image quality the brightness value in the clean image after raindrop removal was smaller than that in raw images before raindrop removal fig 9 which demonstrated the k means algorithm can remove raindrop noise furthermore the development of a raindrop removal method in images enables unrestricted access to soil surface morphology during continuous rainfall and it circumvents the former limitation of observing soil surface morphology by interrupting rainfall thereby avoiding changes in soil bulk density and internal structure caused by the interruption of experimental rainfall therefore the technology of raindrop noise removal based on the k means algorithm not only solves a major limitation in the research of soil erosion processes but also provides a new technology for the future study of soil erosion mechanisms 4 1 2 precision and accuracy the results of 60 observations of a ruler with fixed dimensions and multiple observations of the side lengths of grooves under different rain intensities and slope conditions showed the photogrammetric observation system had high precision and accuracy in the horizontal direction moreover the dem quality assessment with check points and a total station fully demonstrated the high accuracy of the photogrammetric observation system in the vertical direction therefore the high observation accuracy of the system in the vertical and horizontal directions provided sufficient technical support for the accurate observation of soil loss in a scouring experiment of a soil slope the precision of photogrammetric observation was also tested by sediment yield data collected from runoff and sediment monitor with the extension of rainfall duration despite the decrease of relative errors is due to an increased total amount of change towards the end of the accuracy the absolute errors between the runoff and sediment collection method and the photogrammetric observation method also decreased in general table 5 in the early period of rainfall the absolute errors of the two observation methods were 4000 cm3 while they were less than 4000 cm3 after 265 min our assumption was that the soil bulk density changed constantly due to water infiltration in the early stage of rainfall and the observation results of photogrammetry observation method were calculated by subtracting the dems on two consecutive time nodes which contained the volume change caused by the soil bulk density resulting in the larger observation values of the photogrammetry observation method nevertheless once the soil water content was saturated the influence of soil bulk density on the calculation of soil loss automatically decreased hence as the rainfall proceeded the observation accuracy of the digital photogrammetry observation method increased with the significant change of rill morphology and the highest precision for a single observation was 99 58 the dem grid size we used represented the accuracy of the terrain surface approximation obtained from grid data and the density of the digital point cloud represented how accurately the point cloud described the terrain guo et al 2016 thus the density of points in the cloud determined the cell size of the dem grid in this study the point cloud density obtained by photogrammetric observation was greater than laser scanning table 3 and the dem grid size obtained by photogrammetric observation was smaller than laser scanning which showed that the object size represented by each single point cloud obtained from the photogrammetric observation method was smaller as a result the photogrammetric observation method was better at expressing the 3d information of the erosion surface however in practice the ground sample distance gsd derived from the photogrammetric method can be reduced simply by shortening the distance between the soil bin and the cameras or increasing the resolution of the cmos sensor similarly other commercial laser scanners that might be capable of producing denser point clouds than the photogrammetric method used in our experiments in the point cloud scanned by the laser scanner the areas with low point cloud density were generally distributed at the bottom of the rill channel for example the point cloud in the red circle in the upper region of the rill illustrates the sparse or missing data from laser scanning fig 19 resulting in a smaller density of the point cloud while the point cloud obtained by the photogrammetric observation method is uniform whether in rills or in the area between rills the 3d laser scanner was fixed to a tripod and generally placed in front of the plots to obtain the soil surface morphology and consequently the beam could not reach all parts of the channels bottom due to the linear laser transmission resulting in sparse or even missing point cloud data this is also the main reason for the increase of the elevation differences between the two observation methods as rainfall proceeded table 4 in this study due to the instantaneous observation of multiple cameras set perpendicular to the soil surface and 8 fold image overlapping across the observation area the photogrammetric observation method ensured the integrity of the image and avoided missing important data even deep within rill channels both the laser scanner and the digital close range photogrammetry are quite efficient in capturing soil microrelief aguilar et al 2009 installing the laser scanner vertically above the soil bins may have enabled a more consistent comparison but was not possible due to water proofing issues 4 2 application to rill erosion based on our proposed photogrammetric technique not only the sediment volume at different time intervals was accurately estimated table 4 but also the point clouds and rill networks were extracted at different time intervals during ongoing rainfall to realize the visualization of the underlying surface morphology change process figs 16 17 compared with the photographic observation technology used for intermittent rainfall berger et al 2010 nouwakpo et al 2012 the use of raindrop noise removal algorithm allows real time monitoring of the surface evolution process during rainfall application without interrupting the rainfall in addition this system has a wider range of applications than technologies that avoid most raindrops rather than removing raindrops from images during the process of rainfall guo et al 2016 momm et al 2018 the development of rills is a complex and long process which starts from the small drop sill on the slope fig 16b when the soil infiltration rate is far less than the rainfall intensity the runoff on the slope begins to appear under the action of gravity raindrops strongly impact the soil surface causing the ground depression with this runoff is relatively concentrated and the erosivity is relatively enhanced driven by headward erosion rill erosion is gradually formed the quantitative indicators of rill erosion morphology are useful for understanding the rill morphology evolution process and erosion mechanism the gradual increase of ε ω pa and d indicates that rill development tends to be complex and networked at the same time the soil erosion volume also increases significantly table 5 indicating that a close relationship between the soil erosion volume and the rill morphology the rapid increase of mrl and mrd and the decrease of the r w d indicate that the rills develop rapidly along the slope length direction while extend less along both sides and the development shape of the rills tends to be slender furthermore the alternation of the increase and decrease of the mrd shows that the behaviors of erosion and deposition change continuously the increase of mrd means that the bottom of the rill is eroded while the decrease of mrd means that it is deposited the alternation of erosion and deposition continuously shapes the topography of the surface bed thus contributing to the evolution of the bed landscape over time each behavior is an indispensable part of rill development which is crucial to the analysis of erosion mechanism additionally the hack profile reflects the overall change of the main rill profile morphology the increase in the length of longitudinal profile along the slope and the maximum elevation indicates that the erosion gradually recedes along the slope direction fig 18 the gradual decreasing of rill gradient indicates that the erosion rate is slowing down the ability of downward erosion is reduced and the rill development slows down gradually the continuous erosion and accumulation of rills make the riverbed continuously decline gradually smooth and close to a smooth and concave hack curve at the end of rainfall indicating that the erosion and accumulation of rills gradually approach the balance stage and the rill development tends to be complete the dynamic monitoring of rill morphology evolution is helpful to understand the erosion mechanism in short the proposal of this technology provided a new technical method for the study of soil erosion process and more analytical perspectives for the in depth study of erosion mechanisms moreover it has important significance for analyzing the role and influence mechanism of soil erosion in surface hydrological process 4 3 suggestions for future studies in this study only one set of long term experiments was conducted under only one slope slope length and rain intensity condition more repetitions with different gradients slope lengths and rainfall intensities should be used in future experiments the size and distribution of raindrops are important parameters to describe rainfall characteristics which can be observed by current observation technology such as the use of a particle imaging transient measurement instrument guo et al 2015 in the near future we aim to use digital close range photogrammetry technology to digitize the size and distribution of raindrops the time required for data acquisition is about 1 min which is fine for capturing the morphology of the erosion surface but constrains the resolution of the photogrammetric observation at the temporal scale in the small scale study of raindrop size and distribution although indoor artificial rainfall experiments are critical to simulating erosion processes in the field field erosion monitoring is more convincing for exploring the mechanisms of soil erosion experimental field plots equipped with this photogrammetric system for temporal monitoring of the evolution of soil microtopography would be of great value for the testing and validation of new erosion control methods e g efficacy of conservation tillage methods therefore in future research we will install the close range photogrammetry technology in field runoff plots to automatically monitor erosion patterns when natural rainfall occurs 5 conclusions this study proposed a digital close range photographic observation method for dynamic monitoring of soil erosion during ongoing rainfall through wireless networking multiple cameras were concurrently controlled solving problems associated with synchronous acquisition of underlying digital images big data transmission and storage raindrops and fogs on the images were removed using the k means clustering algorithm during data acquisition we used the digital close range photogrammetric observation system in a set of long time series experiments to monitor erosion morphology at different time intervals point clouds and dems were reconstructed and the rill networks were extracted from dems and the main parameters of the erosion rills were extracted to quantify the development morphology of erosion rills the established digital photogrammetric observation system could accurately calculate the digital point cloud from the underlying surface with a 1 min time interval and a 2 mm spatial resolution in the precision and accuracy test of photogrammetric steps the measurement precision of the established system could reach a sub millimeter level with the minimum measurement error being 0 0069 mm compared with the error from the runoff sediment measurement method the average error of soil loss was 5 63 the density distribution of point cloud on the same slope obtained by the photogrammetric observation method was more even than that of the laser scanner and the photographic observation system more accurately expressed the 3d information of the erosion surface this study has important practical significance for research into soil erosion mechanisms and the establishment of erosion prediction models especially under ongoing rainfall conditions in future studies the close range photogrammetry technology needs to be considered carefully in field runoff plots to automatically monitor erosion patterns during natural rainfall for new insights regarding hydrological process mechanism credit authorship contribution statement yanmin jiang conceptualization investigation methodology writing original draft visualization haijing shi supervision project administration methodology minghang guo conceptualization funding acquisition jun zhao resources funding acquisition xiaoping cao investigation writing review editing junfeng shui investigation software david paull writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was supported by the strategic priority research program of the chinese academy of sciences pan third pole environment study for a green silk road xda20040202 the national natural science foundation of china 41977077 41571269 the cas light of west china program xab2020yn04 and the innovation capability support program of shaanxi 2022pt 23 we gratefully acknowledge the data support from the loess plateau science data center national earth system science data sharing infrastructure national science technology infrastructure of china http loess geodata cn appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129427 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2058,soil erosion is a hydro geomorphic process occurring over the earth surface the observation of soil surface morphology during ongoing rainfall at fine spatial and temporal scales are critical for the study of soil erosion a digital close range photogrammetric observation system based on wireless networking technology was explored and established in this study through wireless networking multi cameras were concurrently controlled solving the problems of synchronous acquisition of underlying digital image big data transmission and storage image sensors collected data in parallel based on network command and noise on the images such as raindrops was eliminated based on the k means clustering algorithm by serialization technology during data acquisition after parallel preprocessing high density 3d point clouds and digital elevation models dems were reconstructed the evolution of soil surface topography was dynamically monitored by instantaneous image acquisition at different time intervals during ongoing rainfall the results showed that the measurement precision of the established system could reach a sub millimeter level with the minimum single measurement error being 0 0069 mm the maximum error between check point coordinates generated by photogrammetry and those generated by a total station was 5 7 mm on the horizontal axes and 9 6 mm on the vertical axis the temporal and spatial resolutions of the observation system were 1 min and 2 mm respectively compared with a runoff sediment collection method the average relative error of the system for estimating soil loss was 5 63 and the accuracy of single observation was up to 99 58 the observation methods explored in our study provided a reliable way to monitor soil erosion processes which was also helpful to analyze the role and influence mechanism of soil erosion in surface hydrological process keywords digital close range photogrammetry system soil surface morphology soil erosion digital point cloud camera calibration accuracy evaluation data availability the data that has been used is confidential 1 introduction soil erosion is a hydrological geomorphic process occurring on the earth surface it not only shapes landforms but also strongly interacts with global carbon cycle and climate processes becoming a key factor affecting ecological and hydrological processes the visualization and quantification of soil surface morphology during ongoing rainfall at fine spatial and temporal scales are of great significance to the study of soil erosion soil erosion is a ubiquitous environmental problem with significant impacts on agricultural production water quality hydraulic structure and biogeochemical cycles of the earth heng et al 2010 oz et al 2017 balaguer puig et al 2018 it is also a natural process of detachment transportation and deposition of soil particles lal 2003 guo et al 2016 during an erosion event the soil surface is continuously forming and the erosion processes are usually manifested as changes in the soil surface topography balaguer puig et al 2017 oz et al 2017 quantification of soil surface topography and estimation of its changes in each erosive stage can be conducted by digital elevation model dem analysis takken et al 2001 balaguer puig et al 2017 oz et al 2017 as sequential differencing of dems allows for robust estimation of space time averaged transport rates and the distribution of erosion and deposition brasington smart 2003 to obtain and generate dems with sufficient resolution for micro topographic analysis techniques and such as laser scanning and photogrammetry have been developed abd elbasit et al 2009 nouwakpo huang 2012 vinci et al 2015 while laser scanners have proven their usefulness and high spatial resolution in many experiments each scan takes a long time and data may be missed due to the linear laser transmission govers et al 2000 guo et al 2016 in addition the laser scanner cannot be used to monitor the surface during going rainfall consequently the temporal resolution of laser scanning devices is not sufficient to produce time sequences of rapidly changing soil surfaces rieke zapp et al 2001 by contrast a photogrammetric system allows for more rapid data acquisition enabling the possibility of instantaneous data capture furthermore the emergence of digital close range photogrammetric technology has significantly improved the efficiency of photogrammetric dem generation by allowing the use of inexpensive high resolution digital cameras and highly automated data processing leduc et al 2019 within the last few years studies have been conducted that make use of the advantages of photogrammetric technique which is fast flexible and simple to use in terms of data acquisition and post processing to achieve sequences of the continuous process monitoring of landforms the photogrammetric technique for example has been utilized in soil erosion observations eltner et al 2017 rockfall detection blanch et al 2021 snow depth measurement filhol et al 2019 land slide tracking gabrieli et al 2016 and volcanology galland et al 2016 the study presented in this paper relies upon photogrammetric techniques to generate soil surface dems during rainfall events soil erosion is a continuous process to observe the evolution of erosion and monitor soil surface topography at both fine temporal and spatial scales digital close range photogrammetric observation technology has been widely used brasington smart 2003 rieke zapp nearing 2005 heng et al 2010 momm et al 2018 yet few studies have been able to monitor ongoing soil erosion processes during rainfall events to address this issue our research group developed a hand held digital close range photogrammetry system v1 0 to observe a soil surface during ongoing rainfall in which raindrop interference during image acquisition was avoided by constraining the field of view guo et al 2016 an industrial camera having a high frame rate was used to acquire highly overlapping images and noise caused by raindrops was mostly deleted as it represented unstable homologous points in different images this hand held observation system mostly avoided raindrop noise but it did not fully solve the raindrop issue in addition the hand held scanning approach constrained the observation area and the resolution of the photogrammetric observation at the temporal scale as an observation of a 1 5 m soil bin needed 2 min this time was used to bring the camera into position and walk around the soil bin but the soil surface could change greatly within this 2 min therefore how to capture instantaneous images of the underlying soil surface without the interference of raindrops become a new issue in addition matching many highly overlapping images required a large computing effort so parallel computing techniques were used which restricted its utilization by the ordinary users therefore how to transmit store large data and calculate three dimensional point cloud information quickly and easily became our focal issue in soil erosion monitoring based on a previous study by guo et al 2016 the objective of this study was to develop an improved digital close range photogrammetric observation system v2 0 to monitor soil surface morphology at both fine temporal seconds level and spatial mm level scales during ongoing rainfall specifically we aimed to 1 capture instantaneous images concurrently and remove the noise caused by raindrops 2 assess the precision and accuracy of our new developed photogrammetric observation system and 3 monitor soil erosion and morphological evolution during ongoing rainfall 2 material and methods 2 1 design of a digital photogrammetric observation system the digital photogrammetric observation system employed in this study is coupled with close range photography technology and wireless networking technology which can instantly capture the surface microgeomorphology with high spatiotemporal resolution during ongoing rainfall jiang et al 2019 this system realizes the visualization of rill evolution process thus providing a new technical means for the study of soil erosion process mechanism the digital photogrammetric observation system is composed of three subsystems the image acquisition subsystem the data transmission subsystem and the image calculation subsystem fig 1 all functional subsystems of the system are run under the control of a high capacity pico participant intervention comparison outcome computer with windows 7 operating environment the corresponding software system is developed for each functional subsystem named z map fig 2 which includes camera working condition diagnosis image acquisition image calculation and other functional interfaces 2 1 1 image acquisition subsystem the image acquisition subsystem is responsible for the acquisition of digital images of the underlying eroding soil surface the reception of trigger signals and the removal of raindrops the hardware part of the system is mainly composed of n cameras and industrial control units dc power supply target waterproof adapters and other components fig 3 a and 3b the software part is composed of the image acquisitions unit of z map software on the pico computer after triggering the image acquisition signal all n cameras collect the soil surface digital images in parallel here n is the number of cameras and control units which is determined by the observation area and the required observation resolution of the soil surface by means of the wireless router all groups of digital image collectors are networked through a transmission control protocol internet protocol tcp ip network to synchronize the operation of image collectors and obtain soil surface information at concurrent time intervals each group of digital image collectors includes one digital camera and a dedicated industrial computer the camera used in this system is a sony cmos camera with a resolution of 3264 2448 and its specific parameters appear in table 1 the power supply is responsible for power supply to the camera and industrial computer the industrial computer controls the image acquisition and raindrop removal of the camera 2 1 2 image calculation subsystem the image processing system is mainly responsible for image digital point cloud matching three dimensional reconstruction and point cloud reparation a custom computer system consisting of a host computer and nine parallel computers designed by guo et al 2016 was used the host computer is responsible for assigning tasks to parallel computers monitoring parallel computer processes optimizing schedules on parallel computers and collecting results from parallel computers the software of the image calculation subsystem consists of three modules a parallel computing management module a point cloud matching and editing module and a point cloud reparation module fig 2 during the development process of each module algorithm python language was used to cooperate with the numpy numerical python computing library to conduct prototype research and development and then c language was used to re implement the program 2 1 3 image transmission subsystem the image transmission subsystem plays a connecting role between the acquisition system and the solution system it is mainly responsible for the control of command sending signal receiving and image data transmission a wireless router tcp ip and gigabit network hardware interface are the main hardware units of the image transmission subsystem each subsystem constitutes a local area network through the wireless router the control and calculation units issue concurrent acquisition commands through the wireless network the image acquisition system collects images and works concurrently the collected images are then transmitted to the image processing system through the transmission subsystem 2 2 camera calibration the correspondence between the coordinates of the target surface points and their pixel coordinates in the two dimensional image is determined by the geometric imaging model of the image collector zhang 2000 camera calibration is the process of solving the parameters of the imaging model the parameters of the camera include internal and external parameters the internal parameters include the focal length f of the camera the and y coordinates of the main point of the image cx cy and the distortion parameters distortion parameters are generated by a certain deviation and deformation between the camera image and the actual image including radial distortion coefficients k1 k2 and k3 tangential distortion coefficients p1 p2 and other transformation coefficients b1 b2 the external parameters include the projection center x0 y0 z0 and three rotation angles ψ ω κ of the camera when the image is taken in this paper the calibration test was carried out in the experimental hall of the state key laboratory of soil erosion and dryland agriculture on the loess plateau the test site is a hydraulic adjustable gradient steel soil tank of 10 m long 4 m wide based on the theoretical basis of a pinhole imaging model with the help of a checkerboard fig s1a the initial values of the camera s internal parameters and distortion parameters are calculated by the linear imaging target model and nonlinear imaging model respectively and then they are continuously optimized through continuous iterative operation then the external parameters of the camera were calculated based on the internal parameters of the camera and 102 control points fig s1b the development platform of microsoft visual studio and open source computer vision library opencv were used to write camera calibration program of solving the camera parameters 2 3 raindrop removal during image acquisition during rainfall the spatial distribution of raindrops is similar to that of random fields the images taken by the camera mix two kinds of information including raindrops and underlying objects over a short period such as a few seconds the underlying surface can be regarded as a stable spatial object the main change is the highly random rainfall therefore raindrops can be removed by serialization observation technology to take a sequence of images of the underlying surface in a short time and raindrop noise can be removed from the sequence of images specifically there are three kinds of data comprising the sequence image the brightness data of the underlying surface itself the random brightness data of the rain field and the noise data of the camera system considering that the noise data of the camera is a kind of white noise we only classify the data of sequential images into the brightness data of the underlying surface itself and the random brightness data of the rain field through an industrial computer the digital images collected by each group of sensors are sorted by time and the gray value of each pixel is processed by ternary classifications the noise generated by raindrops on the digital images is removed by the k means algorithm wang et al 2018 wangchamhan et al 2017 the specific algorithm process is as follows 1 the construction of a pixel dataset in the digital close range photogrammetry observation system each camera collects 60 raw pictures within 5 s for each shooting the pixels pix i j in the image sequence of a single camera in one shooting constitute a pixel dataset d p i x i j 1 p i x i j 2 pix i j m m 1 2 3 60 i 1 2 3 3264 j 1 2 3 2448 fig 4 here m is the number of images from one camera with one shot i is the row number of the pixel j is the column number of the pixel and d is the dataset 2 assigning the number of clusters k in this study k was assumed to be 3 due to the brightness of the pixels cluster 1 is the darkest pixels on the image cluster 2 is the brightest pixels on the images due to rain and fog interference which shines on the image after light reflection and cluster 3 is the middle brightness pixel between the darkest cluster 1 and the brightest cluster 2 3 determining the centroid for each cluster the centroid for each cluster is determined as c 1 n c 2 n and c 3 n where the superscript n is the number of iterations and the subscript 1 2 and 3 are the clusters the initial centroid for each cluster was calculated as follows 1 c 1 0 min pix i j 1 p i x i j 2 p i x i j m 2 c 2 0 max pix i j 1 p i x i j 2 p i x i j m 3 c 3 0 max pix i j 1 p i x i j 2 p i x i j n min pix i j 1 p i x i j 2 p i x i j m 2 4 grouping the pixels into clusters for each pixel pix i j in dataset d the euclidean distance that described the difference between pixel values and was calculated to measure the distance from the data point to the centroid and each pixel pix i j was assigned to the nearest centroid to form new clusters 4 d 1 p i x i j c 1 0 5 d 2 p i x i j c 2 0 6 d 3 p i x i j c 3 0 7 d 1 pix p i x min d 1 d 2 d 3 here d 1 is the distance between pixel and c 1 0 d 2 is the distance between pixel and c 2 0 d 3 is the distance between pixel and c 3 0 d 1 is the dataset with the updated clusters 5 recalculating the centroids for all clusters all data points of each cluster were summarized and then averaged to construct new centroids 8 c 1 1 p i x 1 1 p i x 1 1 9 c 2 1 p i x 2 1 p i x 2 1 10 c 3 1 p i x 3 1 p i x 3 1 11 c k n p i x i n p i x i n here c k n is the centroid of cluster k n is the number of iteration 6 convergence the steps in 4 and 5 were repeated until convergence or c k n c k n 1 10 6 or n 2000 finally the data points were classified into 3 clusters and the clusters with the highest and lowest values were removed as the noise the gray value of the intermediate clusters was assigned to the computed pixel cell to obtain the clean images after removal of raindrops noise 2 4 3d reconstruction the process of reconstructing three dimensional 3d information of a soil erosion surface from multiple overlapping two dimensional 2d images of the soil surface is known as 3d reconstruction in this study since the soil surface was reconstructed based on multi camera fixed field thus camera parameters calibrated in advance were directly applied to 3d reconstruction image feature extraction and point cloud matching were the first step in 3d reconstruction before point matching calculation moravec 1981 and sift scale invariant feature transform operators were used as two tools to extract features moravec was a corner detection operator based on gray level variance that calculated the gray level variance of a pixel in an image along the horizontal vertical diagonal and anti diagonal directions the minimum gray variance value was generally selected as the pixel interest value the sift operator was an image local feature description operator which remained unchanged even after the image was scaled rotated or affine transformed lowe 2004 due to the high efficiency and fast speed of the moravec operator it could provide the initial value for the feature point extraction sift however had better performance in terms of accuracy density anti rotation and resistance to brightness changes and could further densify the initial value point cloud matching was a process of matching homologous points based on the similarity of feature points and their descriptors and the strategy of coarse to fine was adopted in the matching process we first used the correlation coefficient algorithm of the image to roughly match a batch of homologous points based on the feature points obtained by the moravec operator after the sift feature points were optimized for matching the random sample consensus ransac algorithm fischler and bolles 1981 was used to eliminate the wrong matching points the best image arrangement was found in multiple images through block adjustment after obtaining homologous points thereby acquiring the position information of the image and the spatial coordinate information of the homologous points the block adjustment was an air triangulation adjustment method that used the area formed by multiple routes to carry out overall adjustment since the point cloud reconstructed was too sparse the multi view stereo mvs based on semi global optimization was used to reconstruct the dense point cloud zhao et al 2018 hirschmüller 2008 under actual rainfall conditions point cloud matching encountered many difficulties when a soil erosion channel appeared runoff accumulated along the channel resulting in a sparse point cloud at those locations in the flow channel to resolve this issue inverse distance weighted idw interpolation watson and philip 1985 was used to repair the sparse point cloud in flooded or vacant areas before the construction of dems cyclone 6 0 3 software wu et al 2018 was used to identify and remove outliers and noise points at the edge of the soil bed by visual inspection dems were generated with 3d analyst tools in esri arcgis 10 2 software based on the digital point clouds jiang et al 2020 the ground sample distance gsd worked out to be approximately 1 5 mm rill networks at different time points were extracted from the dems based on the d8 eight direction algorithm o callaghan and mark 1984 using the arcgis hydrological analyst tools in arcgis 10 2 fig 5 2 5 precision and accuracy test for the established system to test the precision of the established photogrammetric observation instrument the length of a selected ruler was measured 60 times under the same light conditions the standard deviation δ was calculated to reflect the measurement precision the accuracy was the deviation between the measured value and the actual value which was measured by the relative error ω physical observations were conducted by setting three grooves of known length width and depth actual value and the digital photogrammetric observation method was used to acquire the images of the grooves under different rainfall intensities 30 60 90 and 120 mm h 1 to measure and calculate their geometric size measured value the formulas of standard deviation and relative error are as follows 12 δ i 1 n x i x 2 n 1 13 ω i x i x x 100 where ω i is the relative error of observation i x i is the observed value x is the average of all observations x is the actual value and n is the number of observations 2 6 dem quality assessment 50 control points were placed on the soil surface 6 of which were randomly selected to participate in the 3d reconstruction of photogrammetry and the remaining 44 independent points were used as check points the quality of the dem was assessed by comparing modelled elevations to a set of independently surveyed check points the quality of a dem depends not only on the local morphology complexity aguilar et al 2005 but also on the number and distribution of matching feature points also known as mass points identified by the image matching algorithm the coordinates of all point on the slope were measured at two sites using a total station and the 44 check points were used as references to illustrate the suitability of the digital photogrammetric observation system fig s2 the two sets of measurements were then combined in a least square coordinate system transformation procedure to yield the best coordinate estimate meanwhile the digital photogrammetric observation system was used to observe the slope and generate a dem the measurement results of the check points obtained from the two observation methods were compared 2 7 application of the established photogrammetric observation system 2 7 1 laboratory experimental design 2 7 1 1 rainfall simulator system all experiments were conducted in the state key laboratory of soil erosion and dryland farming on the loess plateau we used the digital photographic observation system to monitor the slope erosion morphology in a set of long time series simulated rainfall experiments the artificial rainfall simulation system is composed of 56 group nozzles and mounted at 18 m above the flume bed to ensure the terminal velocity of rain drops zheng and zhao 2004 fig s3a each group of nozzles is composed of three nozzles with diameters of 6 35 mm 12 7 mm and 19 05 mm respectively fig s3b the adjustable range of rainfall intensity is 30 350 mm h 1 before the start of each rainfall experiment we conducted the rainfall intensity of the rainfall simulator was calibrated to make it close to the designed rainfall intensity zhang et al 2016 fig s3c the rainfall intensities in the experiments were 30 mm h 1 and the nozzle size and pump pressure were adjusted to 41 and 22 kpa and 26 and 250 kpa respectively moreover the uniformity coefficient k of rainfall was calculated using the following formula 14 k 1 p m 15 p m a m n where m is the average rainfall amount m a is the rainfall amount at a given rainfall collection point and n is the total number of rainfall collection points 2 7 1 2 experimental procedure the experimental plots were 10 m 1 5 m 0 7 m steel soil bins set at a gradient of 10 to the horizontal fig 6 the lower end of the bins was equipped with instruments to measure the real time runoff and sediment concentration in surface flow soil used in the two experiments was loess which is common in the loess plateau of china the soil texture was composed of 23 1 sand 62 0 silt and 15 9 clay in order to keep consistent with the field soil as far as possible an in situ investigation was conducted to measure the soil bulk density and moisture content of the natural soil of ansai county of the loess plateau before the test soil samples were collected from 6 sampling points and the sampling depths of each point were 10 cm 20 cm 30 cm 40 cm 50 cm and 60 cm each sampling was repeated twice the soil bulk density and moisture content in the 0 60 cm soil layer ranged from 1 03 to 1 44 g cm 3 and from 3 47 to 14 24 respectively fig s4 vertically the soil moisture increased with an increase of soil depth as a whole therefore the bulk density of the upper 20 cm and lower 30 cm of the test soil was set as 1 1 g cm 3 and 1 2 g cm 3 respectively and the soil moisture was set at about 10 to be consistent with natural soil before filling the soil bins the crushed dry loess soil was passed through a 10 mm sieve to remove large particles of debris such as organic matter and gravel shen et al 2015 rainfall intensity was measured using rain gauges at regularly spaced points on the soil surface before each experiment ran giving us information on the spatial and temporal variations in rainfall before the formal experiments the soil surface was subjected to 30 min rainfall with a rainfall intensity of 30 mm h 1 every day for 7 days to pre wet the soil surface after standing still for 7 days to allow the soil moisture to penetrate fully inside the soil bin the soil surface was subjected to five simulated rains at an intensity of 30 mm h 1 for about 640 min 2 7 2 data collection runoff and sediment were monitored in real time and synchronously calculated by the runoff and sediment measuring instrument fig 3a the accuracy test results of the monitoring instrument showed that the average relative error between the real value of sediment concentration and the measured value was 3 67 and the detailed descriptions about this instrument were shown in zhan et al 2017 and zhan et al 2021 in order to ensure the data reliability of the monitoring instrument the sediment concentration precision was evaluated using the results obtained by drying and weighing method in this study the comparison results showed that the error between the two observation methods was less than 3 at the same time of collecting runoff and sediment the erosion morphology of the soil surface was monitored by the digital close range photogrammetry system at five minute intervals until the end of rainfall the overlapping degree of the collected image was at least 4 and the frame rate was no less than 15f s the time for each image acquisition was about 1 min six targets were placed around the soil bin to constrain the length of each observation additionally before the beginning of rainfall and after the end of rainfall the underlying surface terrains were acquired by a 3d laser scanner leica scanstation 2 manufactured by leica in switzerland to independently evaluate the accuracy of the digital close range photogrammetric observation system after the image collection of the entire rainfall process was completed the data processing followed the entire technical flow chart is shown in fig 7 2 7 3 defining rill morphological indicators in order to quantify the rill morphological characteristics and reveal the development process of the rill on the slope we extracted the rill networks from the dem using the arcgis hydrological analyst tools the density of the derived flow network was determined by a confluence threshold which was calculated by the confluence function after multiple attempts the optimal confluence threshold chosen in this study was 400 in addition to the rill density another six morphological indicators were also defined to describe rill morphology including maximum rill length maximum rill depth rill density splitting degree plane area of the rill rill width depth ratio and fractal dimension the parameters of rill density splitting degree plane area of the rill and rill width depth ratio were extracted by the profile analyst module of the surface analyst tool rill density is the total length of all rills in the unit study area bewket and sterk 2003 reflecting the degree of slope fragmentation the calculation formula is as follows 16 ε n 1 m l tn a 0 where ε is the density of the rill m m 2 a 0 is the surface area m2 of the study slope l tn is the total length m of the n th rill and its bifurcation on the slope n is the rill number n 1 2 m and m is the total number of rills the splitting degree is defined according to the ground cleavage degree which refers to the sum of the total surface area of all rills in the unit study area it is a dimensionless parameter and can reflect the distribution of rills intuitively the calculation formula is as follows 17 ω n 1 m a n a 0 where ω is splitting degree and a n is the surface area of the n th rill on the slope m2 rill width depth ratio refers to the ratio of rill width to the corresponding depth this parameter is a dimensionless parameter the calculation formula is as follows 18 r w d i 1 n w i i 1 n d i where r w d is the rill width to depth ratio w i is the width of the rill at the i th monitoring point and d i is the depth of the rill at i th monitoring point n is the total number of monitoring points on the slope the fractal dimension is a morphological parameter that describes the degree of complexity and organization of the rill network zhang et al 2017 zhang et al 2019 the box counting dimension is defined as 19 n θ g θ d 20 d lim θ 0 ln n θ ln 1 θ where n θ is the number of a box covered by rill grids θ mm is the box size d is the fractal dimension and g is a constant the number of box covered rill grids changed with the value of θ so an ordinal pair of the form ln n θ ln 1 θ could be obtained the least square method was used to fit a straight line and the box counting dimension d was the slope of the straight line the fishnet tool in arcgis10 2 software was used to create boxes of different sizes and the box sizes chosen in this study were 2 mm 4 mm 6 mm 8 mm 10 mm 20 mm 40 mm 60 mm 80 mm 100 mm 120 mm 140 mm 160 mm 180 mm 200 mm 220 mm 240 mm 260 mm 280 mm and 300 mm respectively the number of boxes covered by rill grids was determined through the intersection of the fishnet layer and rill grid layer feature position which was counted by using the attribute query function in the attribute table of arcgis 10 2 fig 8 shows the procedure for creating a fishnet 2 7 4 hack profile and gradient hack profile describes the overall change characteristics of river longitudinal profile we used the hack profile in this study to characteristic the longitudinal profile of the main erosion rills on the slope to analysis the sedimentation and erosion process of well developed rills during the rainfall the hack logarithmic equation was used to convert the longitudinal profile to the balanced profile hack 1973 the hack logarithmic equation was expressed as follows 21 h c k log l k 0 where l is the distance from the monitoring point to rill head h was the elevation of hack profile and c and k are constants that are calculated based on the coordinates of the maximum and minimum elevations on the longitudinal profile the gradient g is used to reflect the evolution of the rill and characterize the hydrodynamic conditions and sediment transport capacity of water flow the gradient is defined as follows 22 g δ h δ l where δ h is the change in altitude and δ l is the change in length 3 results 3 1 evaluation of raindrop removal fig 9 shows 59 raw images and 1 image after raindrop removal of the same area obtained during ongoing rainfall we randomly selected the brightness values of the same pixel position in 60 images for statistical analysis fig 10 the results showed that the brightness values on the three channels r g and b of the 59 raw images were all different which indicated that raindrops interfered with the acquisition of images moreover the overall change trend of brightness value in the 59 raw images was to first increase then decrease and increase again fig 11 shows the variance of the pixel values on each image which was similar to the trend of the single pixel brightness value described above the variance of the brightness value first increased then decreased and then increased with the increase of image number but notably in the images numbered 30 45 the peaks appeared on all three channels of a single pixel while the variance of each image had the lowest value combined with the brightness of the raw images in fig 9 the brightness in images 30 40 gradually increased and then gradually decreased in images 40 45 due to the interference of raindrops the brightness turned at the 40th image resulting in a brightness peak and the camera captured the most raindrop information which made the brightness value of the whole image relatively concentrated resulting in the lowest variance therefore the interference of raindrops increased the brightness of the images furthermore the variation ranges of a single pixel value on the three channels r g and b of these 59 raw images were 111 159 110 193 and 77 186 respectively while they were 110 106 and 73 respectively in the pixel after raindrop removal which was lower than the raw images therefore the k means algorithm is an effective method for removing raindrop noise 3 2 precision and accuracy assessment of the photogrammetric system 3 2 1 precision of the photogrammetric system to test the precision of the newly developed digital photographic observation instrument 60 length measurements of a selected ruler were conducted fig 12 the results showed that the average length of the ruler was 407 58 mm and the standard deviation was 1 42 mm the results showed that the measurement precision of the established system could reach a sub millimeter level and the minimum single measurement error is 0 0069 mm the histogram and normal qq plot of the observed value showed a normal distribution skewness 0 334 kurtosis 1 287 indicating high precision of the designed observation instrument 3 2 2 accuracy of the photogrammetric system to test the accuracy of the newly developed digital photographic observation instrument the length width and depth of three grooves with fixed dimensions and known size actual value were observed under different rainfall intensities and slope gradients the observation results showed that relative error between the measured value and the actual value ranged from 0 01 to 3 12 under 90 mm h 1 rainfall intensity on gradients of 0 5 10 and 15 with the observation accuracy in all cases being 96 table s1 the average relative errors under the four different slopes were 0 59 0 64 0 66 and 0 67 the frequency distribution histogram showed that the relative error of observation was mainly distributed in the range of 0 1 which accounted for about 77 7 fig 13 a in addition the observation results under the conditions of slope of 15 and rainfall intensity of 30 60 90 and 120 mm h 1 showed that the minimum relative error and maximum error were 0 and 4 62 respectively and the observation accuracy in all cases was 95 table s2 the average relative errors under the four different rainfall intensities were 0 72 0 76 0 67 and 0 97 the proportion of relative error between 0 and 1 also accounted for 77 7 fig 13b the above results showed that the digital photographic observation system was accurate in the observation of the geometric dimensions of the soil erosion slope and the rain intensity and slope had no significant effect on the observation accuracy of the system 3 3 dem accuracy fig 14 shows the comparison between the check point coordinates obtained using our developed photogrammetric observation method and those obtained using the total station the residuals of the check point transformation from the photogrammetric coordinate system to the total station coordinate system are a measure of the differences between the two technologies the residuals on the x axis were within 5 mm on the y axis were within 4 mm and on the z axis were within 10 mm the rmse values of the residuals for the x y and z axes were 2 072 1 741 and 4 507 mm respectively the histogram of differences is approximately normally distributed with a relatively narrow spread and high kurtosis fig 15 this result is confirmed by the low standard deviation of errors sde 4 51 mm and the maximum absolute error 9 6 mm these results are encouraging as the sde compares well with the maximum theoretical vertical precision 1 4 mm afforded by the image resolution however the distribution of errors is not centered about zero and the mean error of 0 907 mm suggests that the photogrammetric elevations are systematically higher than observed 3 4 soil erosion and morphological evolution 3 4 1 rill development morphology fig 16 shows the digital point cloud of the erosion surface at different intervals which clearly demonstrated the evolution process of the erosion landscape at different intervals even after the soil bed surface was subjected to 210 min of rainfall with an intensity of 30 mm h 1 during the pre wetting period no significant changes in the topography of the soil bed surface were observed fig 16a when the rainfall lasted for 255 min only a small and shallow drop appeared on the slope but it was not obvious in the point cloud fig 16b the erosion rills that were 1 4 m away from the bottom appeared after 10 min and the dimension of the erosion rills was 0 17 m long and 0 16 m wide fig 16c when the rainfall had lasted for 285 min the rills developed slowly along the slope and the erosion pattern gradually became obvious fig 16e with rainfall proceeding the rills on the slope surface gradually retreated along the opposite direction of water flow under the action of retrogressive erosion at 330 min a branch was formed at the head of the rill fig 16g the rills and its branch not only extended upstream but also branched into multiple rill branches along both sides fig 16i subsequently the rill branches developed and gradually crossed and merged as rain continued and finally formed three main rill branches in 570 min fig 16j the three branches gradually underwent traceable erosion and reached a stable state until the end of the rainfall fig 16k m during the period of 570 850 min although the rill morphology increased insignificantly along the slope and horizontal direction the erosion depth increased due to the occurrence of undercut erosion 3 4 2 quantitative description of rill morphology different statistical indicators of rill morphology at different time intervals are presented in table 2 the rill networks extracted from dems at different time intervals are illustrated in fig 17 the rill density ε maximum rill length mrl the splitting degree ω the rill plane area pa and the fractal dimension d gradually increased as the rainfall proceeded while the rill width depth ratio r w d decreased with time table 2 moreover the maximum rill depth mrd increased first and then decreased and then increased again and decreased the uniformity and density of rill network distribution were enhanced with time and the cross merging phenomenon between the rills became more obvious resulting in the rill network becoming gradually more complex fig 17 the rill density increased from 0 279 m m 2 to 6 658 m m 2 from 255 to 640 min which was consistent with the changing trend of rill network morphology at the end of the rainfall the mrl and mrd were 1 078 m and 0 249 m and they accounted for 10 78 and 49 8 of the slope length and depth respectively the pa of the rill was 2 169 m2 which accounted for 14 44 of the total slope area however the r w d decreased from 3 636 to 1 870 with time which indicated the increment of rill width was less than that of depth moreover the fractal dimensions of the rill patterns varied from 1 218 to 1 436 from the beginning to the end of the rainfall showing that the rill networks had obvious fractal characteristics 3 4 3 the longitudinal profiles of the main rill at the end of rainfall the rills developed slowly and gradually stabilized and the erosion and deposition basically reached a balanced state therefore in order to describe the sedimentation and erosion process of well developed rills during the rainfall in this study we extracted the longitudinal profile of the main rill between the rill head and rill outlet in the slope fig 18 as the rainfall duration increased the rill length increased and the distance between the rill head and lowest point of the main rill increased the length of longitudinal profile along the slope gradually increases and the elevation of the longitudinal profile at each time point decreased first and then increased furthermore the maximum elevation of the balanced longitudinal profile gradually increased and the arc of the depression became larger over time the gradient curve from the rill head to the outlet fluctuated and decreased continuously the overall trend of the gradient curve was very close to the hack profile 3 5 laser scanning and photogrammetric observation table 3 and table 4 are the comparison results of point cloud and elevation differences between two observation methods point cloud density and dem resolution obtained by photogrammetric observation and laser scanning are 0 525 mm2 and 2 05 mm 0 347 mm2 and 2 37 mm respectively which indicates that the object size represented by each single point cloud obtained from photogrammetric observation method is smaller moreover it can be seen from the maximum and minimum values of the point cloud density that the point cloud obtained by the photogrammetry is more evenly distributed than the laser scanner table 3 from our results in table 4 the mean error standard deviation of error and maximum absolute error of the elevation differences between the two observation method increase gradually with the application of rainfall which yield the best agreement before rainfall is applied between the laser scanner and digital photogrammetry 4 discussion 4 1 performance of the methodology 4 1 1 raindrop removal we used the photogrammetric observation system to obtain point clouds of soil erosion slopes and monitor the evolution patterns of rills during ongoing rains rieke zapp et al 2009 and nouwakpo et al 2012 also proposed a photogrammetric technique for generating dems of soil surfaces with high spatial and temporal resolution however the methods they proposed were developed for different experimental background conditions than the one proposed in this study the method proposed in this study was intended to solve the problem of difficult observation during ongoing rainfall while their methodology could only obtain a dem in the absence of rainfall raindrop interference was the main factor affecting the observation accuracy so raindrop removal from images was of great significance to restore image quality the brightness value in the clean image after raindrop removal was smaller than that in raw images before raindrop removal fig 9 which demonstrated the k means algorithm can remove raindrop noise furthermore the development of a raindrop removal method in images enables unrestricted access to soil surface morphology during continuous rainfall and it circumvents the former limitation of observing soil surface morphology by interrupting rainfall thereby avoiding changes in soil bulk density and internal structure caused by the interruption of experimental rainfall therefore the technology of raindrop noise removal based on the k means algorithm not only solves a major limitation in the research of soil erosion processes but also provides a new technology for the future study of soil erosion mechanisms 4 1 2 precision and accuracy the results of 60 observations of a ruler with fixed dimensions and multiple observations of the side lengths of grooves under different rain intensities and slope conditions showed the photogrammetric observation system had high precision and accuracy in the horizontal direction moreover the dem quality assessment with check points and a total station fully demonstrated the high accuracy of the photogrammetric observation system in the vertical direction therefore the high observation accuracy of the system in the vertical and horizontal directions provided sufficient technical support for the accurate observation of soil loss in a scouring experiment of a soil slope the precision of photogrammetric observation was also tested by sediment yield data collected from runoff and sediment monitor with the extension of rainfall duration despite the decrease of relative errors is due to an increased total amount of change towards the end of the accuracy the absolute errors between the runoff and sediment collection method and the photogrammetric observation method also decreased in general table 5 in the early period of rainfall the absolute errors of the two observation methods were 4000 cm3 while they were less than 4000 cm3 after 265 min our assumption was that the soil bulk density changed constantly due to water infiltration in the early stage of rainfall and the observation results of photogrammetry observation method were calculated by subtracting the dems on two consecutive time nodes which contained the volume change caused by the soil bulk density resulting in the larger observation values of the photogrammetry observation method nevertheless once the soil water content was saturated the influence of soil bulk density on the calculation of soil loss automatically decreased hence as the rainfall proceeded the observation accuracy of the digital photogrammetry observation method increased with the significant change of rill morphology and the highest precision for a single observation was 99 58 the dem grid size we used represented the accuracy of the terrain surface approximation obtained from grid data and the density of the digital point cloud represented how accurately the point cloud described the terrain guo et al 2016 thus the density of points in the cloud determined the cell size of the dem grid in this study the point cloud density obtained by photogrammetric observation was greater than laser scanning table 3 and the dem grid size obtained by photogrammetric observation was smaller than laser scanning which showed that the object size represented by each single point cloud obtained from the photogrammetric observation method was smaller as a result the photogrammetric observation method was better at expressing the 3d information of the erosion surface however in practice the ground sample distance gsd derived from the photogrammetric method can be reduced simply by shortening the distance between the soil bin and the cameras or increasing the resolution of the cmos sensor similarly other commercial laser scanners that might be capable of producing denser point clouds than the photogrammetric method used in our experiments in the point cloud scanned by the laser scanner the areas with low point cloud density were generally distributed at the bottom of the rill channel for example the point cloud in the red circle in the upper region of the rill illustrates the sparse or missing data from laser scanning fig 19 resulting in a smaller density of the point cloud while the point cloud obtained by the photogrammetric observation method is uniform whether in rills or in the area between rills the 3d laser scanner was fixed to a tripod and generally placed in front of the plots to obtain the soil surface morphology and consequently the beam could not reach all parts of the channels bottom due to the linear laser transmission resulting in sparse or even missing point cloud data this is also the main reason for the increase of the elevation differences between the two observation methods as rainfall proceeded table 4 in this study due to the instantaneous observation of multiple cameras set perpendicular to the soil surface and 8 fold image overlapping across the observation area the photogrammetric observation method ensured the integrity of the image and avoided missing important data even deep within rill channels both the laser scanner and the digital close range photogrammetry are quite efficient in capturing soil microrelief aguilar et al 2009 installing the laser scanner vertically above the soil bins may have enabled a more consistent comparison but was not possible due to water proofing issues 4 2 application to rill erosion based on our proposed photogrammetric technique not only the sediment volume at different time intervals was accurately estimated table 4 but also the point clouds and rill networks were extracted at different time intervals during ongoing rainfall to realize the visualization of the underlying surface morphology change process figs 16 17 compared with the photographic observation technology used for intermittent rainfall berger et al 2010 nouwakpo et al 2012 the use of raindrop noise removal algorithm allows real time monitoring of the surface evolution process during rainfall application without interrupting the rainfall in addition this system has a wider range of applications than technologies that avoid most raindrops rather than removing raindrops from images during the process of rainfall guo et al 2016 momm et al 2018 the development of rills is a complex and long process which starts from the small drop sill on the slope fig 16b when the soil infiltration rate is far less than the rainfall intensity the runoff on the slope begins to appear under the action of gravity raindrops strongly impact the soil surface causing the ground depression with this runoff is relatively concentrated and the erosivity is relatively enhanced driven by headward erosion rill erosion is gradually formed the quantitative indicators of rill erosion morphology are useful for understanding the rill morphology evolution process and erosion mechanism the gradual increase of ε ω pa and d indicates that rill development tends to be complex and networked at the same time the soil erosion volume also increases significantly table 5 indicating that a close relationship between the soil erosion volume and the rill morphology the rapid increase of mrl and mrd and the decrease of the r w d indicate that the rills develop rapidly along the slope length direction while extend less along both sides and the development shape of the rills tends to be slender furthermore the alternation of the increase and decrease of the mrd shows that the behaviors of erosion and deposition change continuously the increase of mrd means that the bottom of the rill is eroded while the decrease of mrd means that it is deposited the alternation of erosion and deposition continuously shapes the topography of the surface bed thus contributing to the evolution of the bed landscape over time each behavior is an indispensable part of rill development which is crucial to the analysis of erosion mechanism additionally the hack profile reflects the overall change of the main rill profile morphology the increase in the length of longitudinal profile along the slope and the maximum elevation indicates that the erosion gradually recedes along the slope direction fig 18 the gradual decreasing of rill gradient indicates that the erosion rate is slowing down the ability of downward erosion is reduced and the rill development slows down gradually the continuous erosion and accumulation of rills make the riverbed continuously decline gradually smooth and close to a smooth and concave hack curve at the end of rainfall indicating that the erosion and accumulation of rills gradually approach the balance stage and the rill development tends to be complete the dynamic monitoring of rill morphology evolution is helpful to understand the erosion mechanism in short the proposal of this technology provided a new technical method for the study of soil erosion process and more analytical perspectives for the in depth study of erosion mechanisms moreover it has important significance for analyzing the role and influence mechanism of soil erosion in surface hydrological process 4 3 suggestions for future studies in this study only one set of long term experiments was conducted under only one slope slope length and rain intensity condition more repetitions with different gradients slope lengths and rainfall intensities should be used in future experiments the size and distribution of raindrops are important parameters to describe rainfall characteristics which can be observed by current observation technology such as the use of a particle imaging transient measurement instrument guo et al 2015 in the near future we aim to use digital close range photogrammetry technology to digitize the size and distribution of raindrops the time required for data acquisition is about 1 min which is fine for capturing the morphology of the erosion surface but constrains the resolution of the photogrammetric observation at the temporal scale in the small scale study of raindrop size and distribution although indoor artificial rainfall experiments are critical to simulating erosion processes in the field field erosion monitoring is more convincing for exploring the mechanisms of soil erosion experimental field plots equipped with this photogrammetric system for temporal monitoring of the evolution of soil microtopography would be of great value for the testing and validation of new erosion control methods e g efficacy of conservation tillage methods therefore in future research we will install the close range photogrammetry technology in field runoff plots to automatically monitor erosion patterns when natural rainfall occurs 5 conclusions this study proposed a digital close range photographic observation method for dynamic monitoring of soil erosion during ongoing rainfall through wireless networking multiple cameras were concurrently controlled solving problems associated with synchronous acquisition of underlying digital images big data transmission and storage raindrops and fogs on the images were removed using the k means clustering algorithm during data acquisition we used the digital close range photogrammetric observation system in a set of long time series experiments to monitor erosion morphology at different time intervals point clouds and dems were reconstructed and the rill networks were extracted from dems and the main parameters of the erosion rills were extracted to quantify the development morphology of erosion rills the established digital photogrammetric observation system could accurately calculate the digital point cloud from the underlying surface with a 1 min time interval and a 2 mm spatial resolution in the precision and accuracy test of photogrammetric steps the measurement precision of the established system could reach a sub millimeter level with the minimum measurement error being 0 0069 mm compared with the error from the runoff sediment measurement method the average error of soil loss was 5 63 the density distribution of point cloud on the same slope obtained by the photogrammetric observation method was more even than that of the laser scanner and the photographic observation system more accurately expressed the 3d information of the erosion surface this study has important practical significance for research into soil erosion mechanisms and the establishment of erosion prediction models especially under ongoing rainfall conditions in future studies the close range photogrammetry technology needs to be considered carefully in field runoff plots to automatically monitor erosion patterns during natural rainfall for new insights regarding hydrological process mechanism credit authorship contribution statement yanmin jiang conceptualization investigation methodology writing original draft visualization haijing shi supervision project administration methodology minghang guo conceptualization funding acquisition jun zhao resources funding acquisition xiaoping cao investigation writing review editing junfeng shui investigation software david paull writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was supported by the strategic priority research program of the chinese academy of sciences pan third pole environment study for a green silk road xda20040202 the national natural science foundation of china 41977077 41571269 the cas light of west china program xab2020yn04 and the innovation capability support program of shaanxi 2022pt 23 we gratefully acknowledge the data support from the loess plateau science data center national earth system science data sharing infrastructure national science technology infrastructure of china http loess geodata cn appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129427 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2059,a stochastic export coefficient ec model is needed to predict variation in annual diffuse or nonpoint source nutrient loads and develop realistic river basin management plans this study aimed to develop such a model by using observed discharge occurrence probability to a select ec values from a probabilistic database covering all us river basins and b adjust the delivery ratio value transforming edge of field loads into basin outlet loads via riverine storage the model was tested in three river basins from colorado new york and ohio with sizes ranging from 742 to 3450 km2 where observed loads of total phosphorus had been recorded for 27 to 38 years the first three years of data were used to calibrate a single parameter the base delivery ratio in the new model the stochastic ec model was compared to the standard ec model i e deterministic and temporally static the stochastic ec model outperformed the standard ec model with on average 74 lower root mean square error rmse and had better coefficients of determination r2 and statistically significant temporal correlation with observed loads p 0 01 the stochastic ec model has flexibility with observed discharge inputs and based on statistical tests its predictions were equally accurate using discharge data from any representative tributary in a multi tributary basin and were only slightly less accurate when using annual in place of daily discharge time series the stochastic ec model is within the i tree buffer toolkit to assist river basin nutrient management plans by automating simulations bounding estimates with uncertainty providing default parameters and allowing inputs of observed or predicted discharge time series research impact statement this study presents a stochastic export coefficient model within the i tree buffer model to assist with nutrient management plans for river basins this research is the first to utilize the high spatial resolution us federal dataset of export coefficients to generate variation in annual loading and match time series observations keywords total maximum daily load total phosphorus nonpoint source pollution land cover export coefficient temporal heterogeneity data availability data will be made available on request 1 introduction excessive nutrient loading to waters from diffuse or nonpoint source runoff is a problem impairing human and ecosystem health globally often dominated by phosphorus and nitrogen pollution leaving agricultural lands beman et al 2005 oecd 2017 to manage diffuse runoff pollution modeling has been used to represent how land use decisions impact water quality usepa 2001 while the hydrology research community has several advanced models to simulate the many details of diffuse runoff the simplicity of the export coefficient model has been promoted for its public accessibility and hence greater utilization in efforts to remedy the serious costs of excessive nutrient loads white et al 2015a in the following paragraphs we describe how the export coefficient model can be improved to represent interannual variation in phosphorus loading by stochastically utilizing outputs from a more advanced hydrology model the export coefficient model has typically predicted annual nutrient loads kg yr 1 from diffuse nitrogen or phosphorus runoff as the sum of the products of the basin area ha in each land cover category and their associated nutrient export coefficient ec values kg ha 1 yr 1 these ec values represent the diffuse pollutant export to the edge of field i e entering the drainage network while the diffuse delivery ratio describes the fraction of that load reaching a downstream receiving water the ec values have been historically determined using empirical data from regional runoff monitoring reckhow et al 1980 more recently ec values have been estimated using the soil water assessment tool swat arnold et al 1998 a mechanistic numerical model of rainfall runoff and land use the us department of agriculture agricultural research service usda ars used swat simulations to create an ec values database for sediment yield total nitrogen and total phosphorus across the entire us divided spatially into 2270 river basins known as 8 digit hydrologic unit codes or river basins white et al 2015a the usda ars ec values database was generated with a probabilistic approach assigning the likelihood for each scenario i e combination of swat input values was based on an expansion factor defined as the relative size of land area under those conditions white et al 2015a the order of selection progressed as follows first the 8 digit river basin next the land use next a combination of soils and topography based on pairings in the conservation effects and assessment project ceap database and finally the management and conservation practices the probabilistic sampling treated the co dependence of local conditions to create realistic scenarios for each simulation each scenario when selected for swat simulation was then randomly assigned a simulation start year between 1965 and 2004 and was given a two year spin up before completing the five year run to generate the ec values the expansion factor approach resulted in the more common scenarios receiving a larger share of the approximately 45 million total swat simulations these simulations resulted in ec values for the diffuse pollutants of total suspended sediment total nitrogen and total phosphorus the usda ars ec values database represented nutrient loading across many years thereby addressing concerns that export coefficient models had neglected interannual variability for each 8 digit river basin and land cover category the usda ars ec databases allows for creation of an empirical cumulative distribution graph of ec value vs occurrence probability referred to as an ec value duration curve this ec value duration curve represents the likelihood for diffuse runoff from the edge of field and entry into the river basin drainage network similarly for each 8 digit river basin the observed record of daily average discharge or flow allows for creation of a flow duration curve the method by which flow duration curves were used for discharge prediction in ungauged basins might help in nutrient load prediction this discharge information gap at ungauged sites was closed through use of the innovative qppq transform method lorenz and ziegeweid 2016 as follows 1 obtain the measured daily average discharge qg for each day from a gauged site 2 determine the probability pg for that measured discharge value using the site s flow duration curve 3 assume within the same hydrologic region the pg equals the ungauged site daily average discharge probability pu and 4 determine the ungauged site daily average discharge qu associated with pu from a synthetic flow duration curve for the ungauged site extensive regional testing of the qppq transform have failed to reject the hypothesis that the daily average discharge probabilities are equivalent for the gauged and ungauged sites farmer et al 2014 scott and freise 2018 the aim of this project was to develop a stochastic and temporally dynamic export coefficient model capable of predicting the interannual variability in total phosphorus tp nutrient loading the research objectives were to use discharge probability to determine temporal variation in 1 export coefficient values for diffuse pollutant load from land to drainage networks 2 delivery ratio values for transport of diffuse pollutant load through the drainage network to the basin outlet and 3 retention rates of diffuse pollutant storage within the drainage network the hypotheses examined in this research were 1 diffuse pollutant loads were better estimated by the stochastic and temporally dynamic export coefficient model than the deterministic and temporally static export coefficient model 2 temporal variation in loading probability could be predicted equally well with daily or annual average discharge time series and 3 temporal variation in loading probability could be predicted with discharge data from any representative tributary in a multi tributary basin this stochastic and temporally dynamic export coefficient model is placed within the i tree buffer freeware tool to help design healthier landscapes so that receiving waters become swimmable fishable and drinkable 2 methods 2 1 stochastic export coefficient algorithm with daily average discharge data this research modified the qppq discharge exceedance probability discharge transform method lorenz and ziegeweid 2016 to stochastically select daily average ec values that enter the river network introducing the qppec discharge exceedance probability export coefficient transform method see fig 1 the qppec transform method works as follows 1 obtain the measured daily average discharge qg for each day from a gauged site within an 8 digit river basin fig 1a 2 determine the probability pg for that measured discharge value using the site s flow duration curve fig 1b 3 assume the pg equals the same 8 digit river basin site daily average ec value probability pu fig 1c and 4 determine the site daily average export coefficient value ecu associated with pu from the ec duration curve for the site and associated land cover which enters into the drainage network as an diffuse pollutant load fig 1c given the 8 digit river basin may have multiple land cover types there may be multiple ec value duration curves to create a stochastic delivery ratio algorithm that converts the daily average diffuse pollutant load to the drainage network fig 1c into the diffuse pollutant load leaving the river basin fig 1e this research introduces probabilistic storage and transport functions in the river network fig 1d the flow duration curve fig 1b is created with observed daily discharge data across the stationary period of record and binned into 20 cumulative probability intervals between 0 and 1 equally sized at 0 05 the ec value duration curve fig 1c is created from the usda ars ec database white et al 2015b which contained ec values for 7 bins of cumulative probability at 0 05 0 1 0 25 0 5 0 75 0 9 and 0 95 this research used linear interpolation to create ec values for the remaining cumulative probability bins between 0 1 and 0 25 between 0 25 and 0 5 between 0 5 and 0 75 and between 0 75 and 0 9 this research subsequently used the slope relating discharge and cumulative probability from the flow duration curve to generate ec values for the two remaining cumulative probabilities of 0 and 1 implementing the following linear interpolation 1a e c p 0 q p 0 q p 0 05 e c p 0 05 quantile x q 0 quantile x q 0 05 e c p 0 05 1b e c p 1 q p 1 q p 0 95 e c p 0 95 quantile x q 1 quantile x q 0 95 e c p 0 95 where subscript p fraction is the cumulative probability subscript q m3 s 1 is the daily average discharge value from a gage ec kg ha 1 yr 1 is the export coefficient value from the usda ars ec national database x q is the numeric vector of daily average discharge for a decadal record i e tens of years sorted from lowest to largest quantile x q p is the quantile function which samples from the x q vector at p to return q p once the ec values for p 0 and p 1 were computed for each land cover type within the 8 digit river basin using eqs 1a and 1b the ec value duration curves fig 1c were ready for use in the qppec transform to find the ec value with a cumulative probability equal to the daily average discharge probability involved implementing the qppec transform the average daily discharge q t at time step t is treated as a discharge realization with cumulative probability p x q t where x is the random variable sampling space less than or equal to q t a quantile function is then used to select the ec value with the equivalent cumulative probability e c l t 2 e c l t q u a n t i l e x ec l p x q t where subscript l indicates land cover and t is the day x ec l is a vector of sorted ec values with cumulative probabilities p p x q t the land cover assigned to each ec value come from the national land cover database nlcd classes identified within the 8 digit river basin these nlcd classes equate to the original land cover types in the usda ars ec database based on sharing similar land cover descriptions see table s1 the sample quantiles are defined as weighted averages of consecutive order statistics as illustrated with a generic numeric vector x x 1 x 2 x n the quantile function quantile x p is an estimation of the distribution quantile based on the supplied statistics x at the cumulative probability p in this research we used the continuous sample quantile known as type 7 within the r project for statistical computing quantile function rdocumentation stats version 3 6 2 3 quantile x p 1 γ x j γ x j 1 where x j is the j th order statistic i e the 1st order is mean the 2nd order is variance n is the sample size m 1 p j np m j m n p j m 1 n and γ n p m j the diffuse pollutant load entering the drainage network l e t kg day 1 is then computed for each daily time step collecting the runoff from each land cover class 4 l e t 1 t y l 1 k e c l t a l a a where e c l t kg ha 1 yr 1 is ec value for land cover class l at day t t y is the number of days in the simulated year k represents the total number of nlcd classes in the river basin a l ha is the area of the basin in land cover class l a ha is the total river basin drainage area the variable l e t is optionally referred to as the edge of field diffuse load implying it is entering the drainage network and is the final output of the stochastic export coefficient algorithm fig 1c the algorithm for a stochastic delivery ratio d p t then determines the partitioning of diffuse pollutant into storage and transport within the river basin drainage network fig 1d the stochastic delivery ratio algorithm generates a probability based delivery ratio for the diffuse pollutant p at each daily time step t d p t fraction using an exponential probability distribution function 5 d p t max d p b λ e λ 1 1 p 1 p b 1 1 where d p b fraction is the base delivery ratio value typically specific to the pollutant and 8 digit river basin site λ is the exponential distribution rate parameter defined in this work as 2 p is the cumulative probability of the daily average discharge at time step t defined as p x q t and p b is the cumulative probability base typically set to 0 98 and above which a small number of extreme events result in much higher delivery ratios the diffuse pollutant load released to the basin outlet from the edge of field runoff at the time step t l o t kg day 1 is 6 l o t l e t d p t the diffuse pollutant load entering storage within the drainage network at each time step s e t kg day 1 is 7 s e t 1 d p t l e t where l e t kg day 1 is computed with eq 4 and d p t is computed with eq 5 the value of the unavailable storage for each time step t s u t kg day 1 is computed as 8 s u t s t t a where s t kg is total diffuse pollutant in storage within the river network and t a days is a model parameter called time active which in this research was set to 730 days equivalent to 2 years t a represents the time for the diffuse pollutant to be incorporated in the system the variable s t is updated at each time step as 9 s t s t 1 δ s t the variable δst kg is the change in storage during the time step and is computed as a function of the cumulative probability for the daily average discharge at time step t defined as p x q t 10 δ s t s e t s u t p p b δ s t s e t s u t s o t p p b where s o t kg is the diffuse pollutant from storage that is released to the basin outlet and explicitly defined as 11 s o t d p t s t 1 r a t r where r m is total main channel length for the river basin derived from streamstats in this research and r a t m is the length of channel generating pollutant loading from drainage network storage for the time step t the variable r a t is estimated using an exponential distribution function 12 r a t c r 1 p b e λ 1 1 p 1 p b where c is the active river length fitting coefficient typically set to 5e 4 and all other terms are defined above the exponential distribution function is modified from eq 8 37 chin 2021 the value of active storage available at the start of the simulation s t 0 can be obtained by using a model spin up to find the steady state value in this research s t 0 s t t a where the average daily active storage s t kg is obtained by making an initial guess using that guess to start a model simulation of duration t a and then computing the error between the guess and the modeling result ε s t t a s t t a s t t a to determine if the initial guess was suitable we set an error threshold of ε 1 start from the second iteration we no longer guess s t but use the computed value s t t a t a the iterations stop once the error threshold is satisfied the total diffuse pollutant load to the river basin outlet for the year lo kg is then computed as the sum of all daily loads for the duration of the year ty by using the daily delivery ratio to release load from two sources 13 l o t 1 t y l o t s o t where t y is the number of days in the simulated year l o t kg day 1 is computed with eq 6 s o t kg day 1 is computed with eq 11 the diffuse pollutant storage within the river network resides in two compartments an active storage compartment that will release a fraction to the basin outlet and an inactive storage compartment that is unavailable for release to the outlet due to uptake into deeper sediment layers or organic storage i e the diffuse pollutant is incorporated into the system 2 2 extending model for use of annual average discharge data the stochastic and temporally dynamic export coefficient model was extended to also use annual average discharge by modifying the above equations this required changing time step variable references in eqs 1 to 14 denoted with subscript t from day to year and changing variable t a from 730 days to 2 years further the annual data model adjusted eq 4 to estimate the terrestrial diffuse pollutant runoff into the drainage network l e t kg yr 1 by removing summation across all days of the year as 14 l e t l 1 k e c l t a l t a a where terms are defined in eq 4 and subscript t is assigned a time step of year 2 3 study sites for export coefficient model testing the stochastic and temporally dynamic export coefficient model was tested in three us drainage basins onondaga lake of new york plum creek of colorado and sandusky river of ohio each with more than 20 years of observed diffuse total phosphorus annual loading data the model used nlcd 2016 data for land cover and parameters p b d p b c and s t 0 are provided in table 1 details on area land cover river networks discharge and nutrient monitoring for each basin are provided next onondaga lake basin has a drainage area of 742 km2 within onondaga county of new york and diffuse pollutant loading was measured for 27 years at the outlet of six tributaries which comprise 94 4 of the total drainage area see fig 2 a arranged in descending size the six tributaries are ninemile creek 299 2 km2 onondaga creek 285 1 km2 ley creek 79 0 km2 harbor brook 34 8 km2 east flume 1 9 km2 and trib 5a 0 1 km2 water resources professionals are managing onondaga lake basin to reduce nutrient loading and meet total maximum daily load targets the total phosphorus data were collected as part of the onondaga county water environment protection wep ambient monitoring program amp and made public through annual onondaga county wep amp reports mcmahon 2020 given the presence of 6 tributaries this site was able to test the hypothesis that a discharge data from a single tributary could be used to obtain representative probabilities for the ec values and delivery ratios of an entire basin this hypothesis was tested for the period 1991 to 2017 using discharge records from ninemile creek at usgs gage 04240300 which is 40 3 of the basin and from onondaga creek at usgs gage 04240010 which is 38 5 of the basin fig 2a the ec values for the basin were obtained from the usda ars ec database for the spatially overlapping 8 digit river basin 04140201 the dominant land cover types in this basin include urban 26 8 mostly surrounding the receiving water and forest 32 4 and agricultural 29 8 concentrated in the upper valley and headwaters see fig 2a and table 1 the main channel length for the basin is 57 km based on national hydrography data analyzed by streamstats with the pour point at the lake outlet plum creek basin has a drainage area of 961 km2 and flows into chatfield reservoir in denver colorado and diffuse pollutant loading was measured for 29 years upstream of the creek outlet at titan road near louviers see fig 2b plum creek comprises 73 of the chatfield reservoir drainage and the basin is managed to meet a total maximum daily load due to excess phosphorus loads via agricultural runoff septic system drainage and soil erosion triggered by wildfire and channel evolution the total phosphorus data were collected as part of the nonpoint source pollution control program for chatfield watershed chatfieldwatershedauthority 2015 the model was run for the period 1986 to 2014 using discharge records from the usgs gage 06709530 at titan road near louviers the ec values for the basin were obtained from the usda ars ec database for the spatially overlapping 8 digit river basin 10190002 the dominant land cover types in this basin include urban 9 8 mostly surrounding the receiving water and forest 37 1 shrub and scrub 22 5 and grassland 28 5 distributed throughout main valley and the headwaters see fig 2b and table 1 plum creek comprises 73 of chatfield reservoir drainage area is the main contributor of total phosphorus load and receives phosphorus runoff from septic systems point discharges from wastewater treatment facilities as well as diffuse pollution from agricultural activities which fluctuates across time due to disruptive streambank erosion and wildfires the main channel length for the basin is 72 km based on national hydrography data analyzed by streamstats with the pour point at the diffuse monitoring site and overlapping usgs gauge sandusky river basin has a drainage area of 3450 km2 and flows into lake erie in ohio and diffuse pollutant loading was measured for 38 years upstream of the river outlet near fremont see fig 2c started from 1960s excessive phosphorus became a major problem of lake erie although programs were implemented to reduce tp load from its tributaries through the years tp mean concentration of sandusky river was decreased slightly and the tp load experienced an increase baker et al 2014 professionals are making progresses in achieving the target tp load for sandusky river basin the total phosphorus data were collected as part of a larger study about phosphorus loading into lake erie baker et al 2014 the model was run for the period 1975 to 2012 using discharge records from the usgs gage 04198000 near fremont the ec values for the basin were obtained from the usda ars ec database for the spatially overlapping 8 digit river basin 04100011 the dominant land cover types in this basin include urban 7 9 in clusters along the river and forest 9 2 and agricultural 80 7 distributed throughout main valley and the headwaters see fig 2c and table 1 the main channel length for the basin is 240 km based on national hydrography data analyzed by streamstats with the pour point at the diffuse monitoring site and overlapping usgs gauge 2 4 model sensitivity calibration and uncertainty analysis the stochastic and temporally dynamic export coefficient model estimates of diffuse pollutant load were most sensitive to the following parameters with greatest sensitivity in decreasing order 1 base phosphorus delivery ratio d p b 2 base cumulative probability p b and 3 the active river length fitting coefficient c to maintain model suitability across basins we limited calibration to a single parameter base total phosphorus delivery ratio d p b and only calibrated to the first three years of observed diffuse total phosphorus loading data for each basin the i tree buffer tool will optionally adjust the most sensitive three model parameters during a run to represent uncertainty in the load due to epistemic uncertainty in the model using this approach model central estimates were bracketed by lower and upper estimates of diffuse total phosphorus load with 1 base cumulative probability p b adjusted up and down by 2 but never exceeding a total value of unity 2 base total phosphorus delivery ratio d p b adjusted up and down by 20 and 3 active river length fitting coefficient c adjusted up and down by 20 2 5 deterministic and temporally static export coefficient and delivery ratio model the i tree buffer tool was also coded to contain the deterministic temporally static export coefficient model reckhow et al 1980 which was run for the same study sites the static export coefficient model operated is limited to a single median ec value selected for each land use within the 8 digit river basin obtained from the usda ars ec database the static export coefficient model also used the static phosphorus delivery ratio ds fraction based on the basin ecoregion see table 1 these static delivery ratio values were obtained from the usda small watershed nutrient forecasting tool usda 2018 based on research by chinnasamy et al 2010 the ecoregions surrounding each study site are eastern great lakes lowlands for onondaga lake colorado plateau for plum creek and huron erie lake plains for sandusky river for each basin the temporally static export coefficient model predicted once the total phosphorus load which contrasts with the temporally dynamic approach of newly formulated stochastic export coefficient model which predicted daily or yearly loads using daily or annual discharge probabilities 3 results addressing hypothesis 1 the diffuse total phosphorus loads were better estimated by the stochastic and temporally dynamic export coefficient model than the deterministic and temporally static export coefficient model see fig 3 where the static export coefficient model predicted once and generated a fixed value horizontal line of estimated load the two versions of the dynamic model predicted daily and yearly loads and captured the annual variation in the observed load the stochastic and temporally dynamic export coefficient model predicted a temporal pattern in annual total diffuse phosphorus loading that correlated with the observed data see vertical bars fig 3a to c while loads predicted by the deterministic and temporally static export coefficient and delivery ratio model had no variation across time see dashed horizontal lines in fig 3 model predictions in fig 3 contain the central estimate as histogram bar height and bounding uncertainty as whiskers due to varying model parameters p b by 2 d p b by 20 and c by 20 related to hypothesis 1 the temporally static export coefficient model had goodness of fit metrics that were consistently worse than the stochastic temporally dynamic model using daily average discharge goodness of fit metrics for model predictions using daily average discharge data are presented in this paragraph see table of metrics within figs 3 and 4 the nash sutcliffe efficiency nse was 0 13 for onondaga lake using onondaga creek discharge and 0 10 using ninemile creek discharge was 0 88 for plum creek and was 0 81 for sandusky river the nse subtracts from 1 the ratio of model error to observed mean error where a value of 1 is a perfect model fit while values below 0 suggest the observed mean is a better predicter than the model the percent bias pbias of the model was 0 6 for onondaga lake using onondaga creek discharge and 1 8 using ninemile creek discharge was 1 2 for plum creek and was 1 6 for sandusky river the pbias measures the average departure of the model prediction from the observed value the root mean square error rmse was 9 14 t yr 1 for onondaga lake using onondaga creek discharge and 9 34 t yr 1 using ninemile creek data was 1 09 t yr 1 for plum creek and was 92 09 t yr 1 for sandusky river the rmse measures the standard deviation of the residuals and is relative to the magnitude of the load making comparisons within basins easier than between basins the rmse standard deviation ratio rsr was 0 91 for onondaga lake using onondaga creek discharge and 0 93 using ninemile creek discharge was 0 35 for plum creek and was 0 43 for sandusky river the rsr normalizes rmse values where a value of 0 indicates a perfect fit and larger positive values extending to infinity demonstrate increasingly poor fit the coefficient of determination r2 was 0 44 for onondaga lake using onondaga creek discharge and 0 40 using ninemile creek discharge was 0 89 for plum creek and was 0 87 for sandusky river the r2 has a range from 0 to 1 where 1 is perfect correspondence a scatter plot addressing hypothesis 2 the results will show that annual variation in loading was better predicted with the stochastic and temporally dynamic export coefficient model using daily average discharge rather than with annual average discharge the use of annual average discharge data within stochastic temporally dynamic export coefficient model caused prediction goodness of fit values to degrade compared with predictions using daily discharge data see table of metrics within figs 3 and 4 the nse degraded by approximately 1 5 and became negative for onondaga lake and the average of the plum creek and sandusky river nse values degraded by 75 the pbias degraded to values averaging 32 for the four basins from values within 2 of a perfect zero the rmse degraded by 67 for onondaga lake 170 for plum creek and 89 for sandusky river close to doubling in value for all four basins similarly the rsr degraded with values increasing on average by 85 or nearly doubling in size the r2 had a mixed change when predictions used daily vs annual average discharge degrading by an average of 0 2 units for three basins but increasing by 0 02 units for onondaga lake using ninemile creek discharge model predictions experienced a degradation of the r2 when changing model inputs from daily to annual average discharge most notably in scatterplots in plum creek and sandusky river fig 4 the i tree buffer stochastic and temporally dynamic export coefficient model loads had a statistically significant correlation with observed loads regression coefficients p 0 001 addressing hypothesis 3 the results also show annual variation in loading was predicted equally well with discharge data from either tributary in the multi tributary onondaga lake basin onondaga creek or ninemile creek the goodness of fit data along with a statistical t test were used in the onondaga lake basin to examine the hypothesis that the discharge data from a single tributary i e onondaga creek or ninemile creek can be used to obtain representative probabilities for ec values and delivery ratios of a multi tributary basin fig s1 the goodness of fit metrics for diffuse loads predicted with onondaga creek vs ninemile creek discharge data were similar using daily average discharge the two tributaries nse values were within 0 03 units the pbias values were within 2 4 the rmse values were within 0 3 t yr 1 the rsr values were within 0 02 units and the r2 values were within 0 04 units while the goodness of fit metrics worsened when changing from daily to annual average discharge the metrics remained comparably close for annual loads estimated using each tributary the paired two tailed equal variance t test was used to examine the hypothesis for the period of record in onondaga lake basin the paired sample t test p values were p 0 25 for both of the tributary discharge inputs indicating no statistical difference between 2 groups of the modeled loading values notched box plots with whiskers set to 1 5 times the interquartile range were used to analyze the diffuse load time series including differences between i tree buffer stochastic and temporally dynamic export coefficient model predicted and observed medians outliers and skew see fig 5 the box plot analysis used the metric of relative diffuse load defined as the actual load t yr 1 divided by the maximum value in the respective modeled or observed time series such that 1 is the largest value the fig 5 box plots included the central prediction and the uncertainty predictions from fig 3 using daily average discharge data the i tree buffer stochastic and temporally dynamic export coefficient model predictions for each of the three basins had 1 statistically similar median loads to the observed values see notches overlapping in fig 5 2 a similar number of outlier loads see open circles above the upper whisker in fig 5 and 3 a similar statistical skew based on the relative distance of box quartiles and whiskers from the median see fig 5 by contrast using annual average discharge in the i tree buffer stochastic and temporally dynamic export coefficient model degraded all but skew regarding the box plot fit between modeled and observed loads with 1 median loads for onondaga lake statistically different than observed loads and lower for all three basins and 2 estimates of outlier with errors of omission commission or dramatically different magnitude 4 discussion 4 1 improved performance of stochastic export coefficient model the use of discharge probability to simulate interannual variation in diffuse pollution loads in this research is supported by observations linking precipitation and runoff as drivers to diffuse pollutant transport with loading rates increasing with discharge hanrahan et al 2001 haygarth et al 1998 hill 1981 kalkhoff et al 2016 to examine the effectiveness of this approach the new model was tested on basins with observed diffuse total phosphorus loads extending across at least one decade which allowed for interannual variability the three basins used in testing had observed diffuse loading for 27 29 and 38 years drainage areas of 742 km2 961 km2 and 3450 km2 located in different us ecoregions and 2 digit hucs of 02 04 and 10 with different climate and land cover use for each basin calibration was used with the first three years of observed data to select a single parameter the base delivery ratio d p b in an effort to uphold the nature of i tree tools and export coefficient models as first order and parsimonious in all cases the new stochastic and temporally dynamic export coefficient model was a much better predictor of observed loading than the temporally static export coefficient model the goodness of fit metrics and statistical tests between model predictions and observed data show the stochastic and temporally dynamic export coefficient model when used with daily or annual average discharge performed better than the static export coefficient model while a key benefit of the export coefficient model is its simplicity and lack of need for calibration multi parameter calibration is an option in cases where observed data were available and users wished to maximize fit to demonstrate the impact of such calibration on model fit the first three years of observed data were used to calibrate the two parameters p b and c which slightly improved goodness of fit metrics see table s2 vs metrics in fig 3 rather than attempt exact agreement between observed diffuse pollutant load and any singular estimate by the new export coefficient model we instead encourage predictions are bounded by uncertainty using a 20 range in two model inputs created a predictive range capturing 65 of all observations box plots constructed from many years of annual loads also provide a central estimate bounded by uncertainty see fig 5 export coefficient models provide first order estimates i e they do not simulate all complexities in diffuse pollutant loading hence uncertainty should always be considered uncertainties may arise due to specific characteristics of the basin total phosphorus loads for the onondaga lake basin are known to be affected by the large amount of nutrient and sediment detention occurring in the headwater otisco lake and by urban area combined sewer overflows coon et al 2009 interestingly the plum creek basin provided the best performance for the i tree buffer stochastic and temporally dynamic export coefficient model despite this creek receiving an unspecified load from wastewater treatment plants given the close match between predicted and observed loading it is likely those wastewater discharges were proportional to discharge or were insignificant the model captured the timing and magnitude of observed loads ranging from 0 47 metric tons in 2002 to nearly 10 metric tons in 1999 and 2007 based on our three simulated basins we determined model performance is affected by the land cover types and variation in the land development i e human footprint across the basin in plum creek basin there was less than 0 1 agricultural land and less than 10 urban land by contrast the onondaga lake basin had 30 in agriculture land and 27 in developed land while sandusky river basin had 81 agriculture land and 8 in urban land cover this larger human footprint in the onondaga lake and sandusky river basins seems to be revealed in the box and whiskers plots fig 5 which have a greater spread about the inter quartile range and whiskers their observed tp load data is more symmetrically distributed and less skewed which does not align with the typical precipitation distributions that tend to be positively skewed under global warming watterson and whetton 2011 the plum creek basin has a relatively tight box and whiskers its discharge and observed tp load share a similar positively skewed distribution and the coefficient of determination r2 0 93 showed that this area has the strongest discharge tp load relationship fig 4c 4f and 4i 4 2 flexibility of i tree buffer tool for stochastic export coefficient model flexibility was built into the discharge data options for the stochastic and temporally dynamic export coefficient model through the i tree buffer tool this tool allows for multiple adjustments to the model including use of daily or annual average discharge for generating probability estimates some users may not have access to daily average discharge data e g gages are not installed or can be damaged during flood events tencaliec et al 2015 and can then use annual average discharge time series to make estimates of temporal variation in loading degrading the temporal resolution of discharge data from daily to annual was shown to degrade the goodness of fit of model predictions causing underestimation of loads in years with high loading these predictions were still much better than those of the static model degradation in estimates when using annual vs daily average discharge data was evident in the pbias with its large negative values for the three study basins e g 42 35 and 7 where pbias was computed as predicted minus observed loads this degradation is attributed to annual resolution discharge missing the storm events delivering high daily flows and containing the kinetic energy that drive the processes associated with large nutrient loads flexibility was also designed into this stochastic and temporally dynamic export coefficient model representation of nps pollutant storage within the drainage network the user can turn off the storage function represented by eqs 7 through 12 which then removes the 2nd right hand side term in eq 13 the calibration of the base delivery ratio should then be performed for this model option tests of a storage free formulation of the model generated goodness of fit metrics that degraded pbias by 0 3 for plum creek and by 1 3 for sandusky river and for sandusky river degraded nse by 1 7 rmse by 3 7 and rsr by 3 8 compared with the predictions based on simulated storage table s3 it should be noted as long as the delivery ratio is less than 1 with this model formulation storage is still occurring within the drainage network even if eqs 7 through 12 are inactive a delivery ratio 1 indicates the basin outlet only yields a fraction of the edge of field load in the three study basins tested in this research greater than 50 of the load entering the drainage network was stored and did not reach the outlet for the multidecadal simulation the mean storage capacity was 81 for onondaga lake basin 67 for plum creek basin and 40 for sandusky river basin this storage is either implicitly resolved in the model delivery ratio parameter or can be explicitly tracked with the drainage network storage module finally this research demonstrates the new export coefficient model accuracy was insensitive and hence flexible with respect to use of any representative discharge time series in lake basins where there are multiple large tributaries this robustness was demonstrated in the onondaga lake basin were we swapped onondaga creek and ninemile creek time series of discharge it is presumed this flexibility is limited to tributaries with a similar climate and a similar response to the precipitation events and hence similar flow duration curves 4 3 sensitivity of stochastic export coefficient model parameters sensitivity of the new export coefficient model was greatest for the base delivery ratio parameter d p b which determines the fraction of diffuse pollution passing from the river network into the receiving water clearly it is challenging to collapse the many processes affecting such transport and fate into a single parameter and it was not well estimated by regional databases provided by the usda ars the usda ars small watershed nutrient forecasting tool swift provides pollutant delivery ratios for all us ecoregions usda 2018 which are computed by taking the quotient of two swift outputs the delivered from watershed load and the edge of field load usda 2018 the swift prediction of the delivery ratio varies with the probability of the event providing a 10 50 average and 90 value the average swift delivery ratios d p s see table 1 were on average 4 7 times larger than calibrated base delivery ratio d p b values for onondaga lake and plum creek basin which were used in the i tree buffer stochastic and temporally dynamic export coefficient model the temporally static export coefficient model using swift generated delivery ratio values had total phosphorus loads that were larger than both the observed and predicted loads from the i tree buffer stochastic and temporally dynamic export coefficient model by 5 3 times for onondaga lake basin and by 2 6 times for plum creek basin the usda ars ec database does capture how changes in land cover and management between river basins leads to large variations in diffuse loading and ec values when diffuse loading is simulated with the temporally static export coefficient model using median ec values this can lead to rather extreme variations in model performance for example the temporally static export coefficient model performed 100 worse in onondaga lake basin than in plum creek basin where delivery ratios d p s only differed by 30 a cause for this large predictive error between basins is attributed to the ec values for nlcd class 82 cultivated crops in onondaga lake basin this land cover occupied 18 of the area and had median ec values that were nearly an order larger than all other nlcd class median ec values combining the ec value with the large d p s value resulted in nlcd class 82 generating 58 6 of the total phosphorus load for the temporally static export coefficient model by contrast in the plum creek basin no single nlcd class had relatively large median ec values which protected the model from estimating high loads despite the relatively high d p s value in the sandusky river basin the d p s value was within 0 15 units of the calibrated d p b value which constrained overprediction of loads by the temporally static export coefficient model despite relatively large median ec values for nlcd class 82 see tables 1 and 2 4 4 generation of delivery ratio values accurate methods for delivery ratio estimation are needed to improve use of both stochastic and deterministic export coefficient models this recommendation extends to export coefficient models which run without delivery ratios such as pload where ec values are treated as basin outlet loads and not edge of field loads when ec values represent river basin transport accurate estimates for drainage network storage are needed angello et al 2020 demonstrated such an application and their use of an in situ method to select properly sized ec values with pload might work to select delivery ratios the in situ method of angello et al 2020 used an upstream and downstream sample of loads to perform a chemical mass balance and find representative ec values as might be expected most users of a first order export coefficient model are looking for a low cost or a priori method to estimate delivery ratios and their effect on ec values the use of basin characteristics assessment might provide an a priori alternative to estimation of the delivery ratios coon and reddy 2008 implemented this approach for onondaga lake basin and determined a headwater reservoir otisco lake contributed to large nutrient and sediment retention combining basin characteristics with a literature review coon and reddy 2008 estimated delivery ratios for onondaga lake basin near in the range of 0 21 to 0 29 which is closer to the calibrated value of 0 13 than the regional value of 0 61 provided by swift swat simulation was used by hua et al 2019 to assign delivery ratios for nitrogen and phosphorus diffuse runoff fate and transport creating parameters called pollutant migration coefficients for each reach of the drainage network hua et al 2019 found the downstream reaches had smaller delivery ratio values than headwater reaches which aligns with other research showing delivery ratios have an inverse relation with drainage area and decay with distance from the pollution source birkinshaw and bathurst 2006 coon and reddy 2008 jim and yang 2006 perhaps swat or comparable model simulations at the national or international scale with inputs such as national hydrograph data on drainage network characteristics could be used to generate a reliable database of deliver ratios to complement the usda ars national ec database 4 5 considering global export coefficient value databases this study built the stochastic and temporally dynamic export coefficient model functions around the usda ars ec values database available in the us previous efforts to introduce variability in ec values have come with either regional specificity or relatively laborious effort and there is no global database currently available in the us an alternative ec database is manage for measured annual nutrient loads from agricultural environments harmel et al 2008 which contains empirically derived ec values that represent nearly 300 us basins the database has 1700 basin years of ec values for the most common agricultural land cover types e g corn fallow pasture wheat and management practices e g crop rotation tillage harmel et al 2008 the 100 s of basins with ec values in the manage database are simply too few relative to the 1000 s of basins across the us in need of estimated diffuse loads for total maximum daily loads similar to the work of the usda ars white et al 2015a others use the swat simulation to address the economic burden of deriving basin ec values through monitoring ahmad et al 2011 almendinger and ulrich 2017 cheng et al 2008 jiang et al 2014 liu et al 2017 the swat uses local weather soil land use management and conservation inputs and therefore makes more accurate estimates of diffuse loads than the export coefficient model using non local ec values delkash et al 2014 wang et al 2020 proposed selecting ec values based on factors of rainfall slope soil and land use for each sub catchment area in the three gorges region of china which effectively leads to a higher complexity model like swat needing to be run in order to parameterize the first order export coefficient model with similar complexity liu et al 2017 recommended deriving ec values from field experiments with artificial rainfall which led to use of swat for calibration which may not be feasible for some users trying to manage their river basins for total maximum daily loads others have attempted to generate interannual variability in ec values ding et al 2010 developed an interannual variation impact factor αt to use with the export coefficient model based on spatial and temporal heterogeneity in precipitation across the pixels in their simulated river basin wu et al 2016 and cheng et al 2018 simulated interannual variability in total phosphorus loading for the beilouhe and luanhe river basins of china by using quadratic polynomial regressions between observed annual loads and total precipitation the cubic polynomial regression worked for the locally fitted range of precipitation however this quadratic regression would likely fail in other basins or years if precipitation exceeded the fitted range due to local concavity or convexity in the polynomial such curvature is typically inconsistent with monotonicity of total phosphorus load increasing with runoff increasing and could even result in negative value of predicted loads seasonal variation in ec values was achieved by hanrahan et al 2001 when weighting ec values by monthly discharge the discharge values were obtained by subtracting baseflow from the total discharge it is important to note this generated intra annual or seasonal variation and was not used to simulate interannual variation in diffuse loading each of these models used variation in weather data to configure temporal variance in the export coefficient model estimate of nutrient loads under steady land cover a promising next step ec model development is to revisit these existing international swat simulations replicating the work of white et al 2015a and generating a global database of ec values for use in qppec transform method to enable temporally dynamic simulation beyond the us it is likely important to allow river basin managers non swat options given swat simulations can require many hours of data preparation and simulation time 4 6 spatially dynamic export coefficient modeling the next goal for the export coefficient model is to represent spatial variation in diffuse runoff nutrient loads while the usda ars ec values database of white et al 2015a provides a first pass at spatial heterogeneity in ec values by representing changes in topographic slope soils and management additional spatial refinement for ec values is possible additional spatial refinement in ec values can be obtained by considering the localized runoff and buffering likelihood that initiates and directs diffuse runoff this idea was pursued by endreny and wood 2003 with an ec valuespatial weighting algorithm based on topography and buffers in the runoffcontributing areas and dispersal areas endreny and wood 2003 also used a range of animal stocking densities and manure spreading i e land management to represent uncertainty in ec values and model predictions reckhow et al 1980 based on this contributing areas and dispersal areas theory stephan and endreny 2016 developed an i tree buffer spatially dynamic export coefficient model that can generate maps of weighted ec values that identify diffuse pollutant loading hotspots the temporally dynamic i tree buffer export coefficient model provides rapid functionality with simulation times 1 min when coded in c or slightly longer in rstudio the proposed updates to create databases with accurate delivery ratio values and expand the usda ars ec value database to international basins will improve the accuracy and range of applications for this i tree buffer model 5 conclusions the i tree buffer tool and its stochastic and temporally dynamic export coefficient model was developed to generate diffuse pollutant loading estimates that can vary across time and match observed trends by contrast the deterministic and temporally static export coefficient model generates a single load across years and is unable to estimate of interannual variation the i tree buffer model is now capable of providing temporal and spatial variation in export coefficient values and provides a more accurate estimation of diffuse pollutant loads across the study sites used in this research it was shown when daily discharge time series are not available the i tree buffer model can use annual average discharge data at the cost of degradation in goodness of fit metrics for predicted loads yet still correlate strongly with observed temporal variation in loading further for those multi tributary basins this research shows the model makes accurate predictions using discharge data from a single representative tributary the temporally dynamic i tree buffer model is meant for river basin managers who had previously used the static export coefficient model providing them with data driven selection of ec values from a proven database generated by detailed probabilistic swat simulations the new model demonstrates a significant improvement in predictive capacity of diffuse pollutant loads for river basins of different sizes ecoregions climate and land cover the usage of this model can be extended by creating an international ec value and delivery ratio database for global applications this model can also be used in conjunction with other i tree models for example it can work with the i tree hydroplus to simulate the complete water circle from precipitation to interception evaporation infiltration runoff diffuse pollution and then delivered to receiving water it also can be incorporated into other modules within i tree buffer to create a diffuse pollutant hotspot mapping tool for strategically guiding tree planting and water quality improvements may this model help us discover ways to improve our world and make our waters more fishable swimmable and drinkable credit authorship contribution statement li zhang conceptualization methodology software visualization data curation writing original draft theodore a endreny conceptualization methodology funding acquisition supervision writing review editing emily a stephan conceptualization methodology declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests theodore a endreny reports financial support was provided by us department of agriculture forest service theodore a endreny reports a relationship with suny college of environmental science and forestry department of environment resources engineering that includes employment and non financial support theodore a endreny reports a relationship with i tree consortium that includes non financial support li zhang reports a relationship with suny college of environmental science and forestry department of environment resources engineering that includes non financial support li zhang reports a relationship with i tree consortium that includes non financial support emily a stephan reports a relationship with noaa national weather service that includes employment acknowledgements this research was supported by two agreements with the usda forest service including a research joint venture 21 jv 11242305 069 and 21 dg 11094200 242 the suny esf department of environmental resources engineering provided computing facilities and logistical support the i tree consortium provided technical support appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129447 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2059,a stochastic export coefficient ec model is needed to predict variation in annual diffuse or nonpoint source nutrient loads and develop realistic river basin management plans this study aimed to develop such a model by using observed discharge occurrence probability to a select ec values from a probabilistic database covering all us river basins and b adjust the delivery ratio value transforming edge of field loads into basin outlet loads via riverine storage the model was tested in three river basins from colorado new york and ohio with sizes ranging from 742 to 3450 km2 where observed loads of total phosphorus had been recorded for 27 to 38 years the first three years of data were used to calibrate a single parameter the base delivery ratio in the new model the stochastic ec model was compared to the standard ec model i e deterministic and temporally static the stochastic ec model outperformed the standard ec model with on average 74 lower root mean square error rmse and had better coefficients of determination r2 and statistically significant temporal correlation with observed loads p 0 01 the stochastic ec model has flexibility with observed discharge inputs and based on statistical tests its predictions were equally accurate using discharge data from any representative tributary in a multi tributary basin and were only slightly less accurate when using annual in place of daily discharge time series the stochastic ec model is within the i tree buffer toolkit to assist river basin nutrient management plans by automating simulations bounding estimates with uncertainty providing default parameters and allowing inputs of observed or predicted discharge time series research impact statement this study presents a stochastic export coefficient model within the i tree buffer model to assist with nutrient management plans for river basins this research is the first to utilize the high spatial resolution us federal dataset of export coefficients to generate variation in annual loading and match time series observations keywords total maximum daily load total phosphorus nonpoint source pollution land cover export coefficient temporal heterogeneity data availability data will be made available on request 1 introduction excessive nutrient loading to waters from diffuse or nonpoint source runoff is a problem impairing human and ecosystem health globally often dominated by phosphorus and nitrogen pollution leaving agricultural lands beman et al 2005 oecd 2017 to manage diffuse runoff pollution modeling has been used to represent how land use decisions impact water quality usepa 2001 while the hydrology research community has several advanced models to simulate the many details of diffuse runoff the simplicity of the export coefficient model has been promoted for its public accessibility and hence greater utilization in efforts to remedy the serious costs of excessive nutrient loads white et al 2015a in the following paragraphs we describe how the export coefficient model can be improved to represent interannual variation in phosphorus loading by stochastically utilizing outputs from a more advanced hydrology model the export coefficient model has typically predicted annual nutrient loads kg yr 1 from diffuse nitrogen or phosphorus runoff as the sum of the products of the basin area ha in each land cover category and their associated nutrient export coefficient ec values kg ha 1 yr 1 these ec values represent the diffuse pollutant export to the edge of field i e entering the drainage network while the diffuse delivery ratio describes the fraction of that load reaching a downstream receiving water the ec values have been historically determined using empirical data from regional runoff monitoring reckhow et al 1980 more recently ec values have been estimated using the soil water assessment tool swat arnold et al 1998 a mechanistic numerical model of rainfall runoff and land use the us department of agriculture agricultural research service usda ars used swat simulations to create an ec values database for sediment yield total nitrogen and total phosphorus across the entire us divided spatially into 2270 river basins known as 8 digit hydrologic unit codes or river basins white et al 2015a the usda ars ec values database was generated with a probabilistic approach assigning the likelihood for each scenario i e combination of swat input values was based on an expansion factor defined as the relative size of land area under those conditions white et al 2015a the order of selection progressed as follows first the 8 digit river basin next the land use next a combination of soils and topography based on pairings in the conservation effects and assessment project ceap database and finally the management and conservation practices the probabilistic sampling treated the co dependence of local conditions to create realistic scenarios for each simulation each scenario when selected for swat simulation was then randomly assigned a simulation start year between 1965 and 2004 and was given a two year spin up before completing the five year run to generate the ec values the expansion factor approach resulted in the more common scenarios receiving a larger share of the approximately 45 million total swat simulations these simulations resulted in ec values for the diffuse pollutants of total suspended sediment total nitrogen and total phosphorus the usda ars ec values database represented nutrient loading across many years thereby addressing concerns that export coefficient models had neglected interannual variability for each 8 digit river basin and land cover category the usda ars ec databases allows for creation of an empirical cumulative distribution graph of ec value vs occurrence probability referred to as an ec value duration curve this ec value duration curve represents the likelihood for diffuse runoff from the edge of field and entry into the river basin drainage network similarly for each 8 digit river basin the observed record of daily average discharge or flow allows for creation of a flow duration curve the method by which flow duration curves were used for discharge prediction in ungauged basins might help in nutrient load prediction this discharge information gap at ungauged sites was closed through use of the innovative qppq transform method lorenz and ziegeweid 2016 as follows 1 obtain the measured daily average discharge qg for each day from a gauged site 2 determine the probability pg for that measured discharge value using the site s flow duration curve 3 assume within the same hydrologic region the pg equals the ungauged site daily average discharge probability pu and 4 determine the ungauged site daily average discharge qu associated with pu from a synthetic flow duration curve for the ungauged site extensive regional testing of the qppq transform have failed to reject the hypothesis that the daily average discharge probabilities are equivalent for the gauged and ungauged sites farmer et al 2014 scott and freise 2018 the aim of this project was to develop a stochastic and temporally dynamic export coefficient model capable of predicting the interannual variability in total phosphorus tp nutrient loading the research objectives were to use discharge probability to determine temporal variation in 1 export coefficient values for diffuse pollutant load from land to drainage networks 2 delivery ratio values for transport of diffuse pollutant load through the drainage network to the basin outlet and 3 retention rates of diffuse pollutant storage within the drainage network the hypotheses examined in this research were 1 diffuse pollutant loads were better estimated by the stochastic and temporally dynamic export coefficient model than the deterministic and temporally static export coefficient model 2 temporal variation in loading probability could be predicted equally well with daily or annual average discharge time series and 3 temporal variation in loading probability could be predicted with discharge data from any representative tributary in a multi tributary basin this stochastic and temporally dynamic export coefficient model is placed within the i tree buffer freeware tool to help design healthier landscapes so that receiving waters become swimmable fishable and drinkable 2 methods 2 1 stochastic export coefficient algorithm with daily average discharge data this research modified the qppq discharge exceedance probability discharge transform method lorenz and ziegeweid 2016 to stochastically select daily average ec values that enter the river network introducing the qppec discharge exceedance probability export coefficient transform method see fig 1 the qppec transform method works as follows 1 obtain the measured daily average discharge qg for each day from a gauged site within an 8 digit river basin fig 1a 2 determine the probability pg for that measured discharge value using the site s flow duration curve fig 1b 3 assume the pg equals the same 8 digit river basin site daily average ec value probability pu fig 1c and 4 determine the site daily average export coefficient value ecu associated with pu from the ec duration curve for the site and associated land cover which enters into the drainage network as an diffuse pollutant load fig 1c given the 8 digit river basin may have multiple land cover types there may be multiple ec value duration curves to create a stochastic delivery ratio algorithm that converts the daily average diffuse pollutant load to the drainage network fig 1c into the diffuse pollutant load leaving the river basin fig 1e this research introduces probabilistic storage and transport functions in the river network fig 1d the flow duration curve fig 1b is created with observed daily discharge data across the stationary period of record and binned into 20 cumulative probability intervals between 0 and 1 equally sized at 0 05 the ec value duration curve fig 1c is created from the usda ars ec database white et al 2015b which contained ec values for 7 bins of cumulative probability at 0 05 0 1 0 25 0 5 0 75 0 9 and 0 95 this research used linear interpolation to create ec values for the remaining cumulative probability bins between 0 1 and 0 25 between 0 25 and 0 5 between 0 5 and 0 75 and between 0 75 and 0 9 this research subsequently used the slope relating discharge and cumulative probability from the flow duration curve to generate ec values for the two remaining cumulative probabilities of 0 and 1 implementing the following linear interpolation 1a e c p 0 q p 0 q p 0 05 e c p 0 05 quantile x q 0 quantile x q 0 05 e c p 0 05 1b e c p 1 q p 1 q p 0 95 e c p 0 95 quantile x q 1 quantile x q 0 95 e c p 0 95 where subscript p fraction is the cumulative probability subscript q m3 s 1 is the daily average discharge value from a gage ec kg ha 1 yr 1 is the export coefficient value from the usda ars ec national database x q is the numeric vector of daily average discharge for a decadal record i e tens of years sorted from lowest to largest quantile x q p is the quantile function which samples from the x q vector at p to return q p once the ec values for p 0 and p 1 were computed for each land cover type within the 8 digit river basin using eqs 1a and 1b the ec value duration curves fig 1c were ready for use in the qppec transform to find the ec value with a cumulative probability equal to the daily average discharge probability involved implementing the qppec transform the average daily discharge q t at time step t is treated as a discharge realization with cumulative probability p x q t where x is the random variable sampling space less than or equal to q t a quantile function is then used to select the ec value with the equivalent cumulative probability e c l t 2 e c l t q u a n t i l e x ec l p x q t where subscript l indicates land cover and t is the day x ec l is a vector of sorted ec values with cumulative probabilities p p x q t the land cover assigned to each ec value come from the national land cover database nlcd classes identified within the 8 digit river basin these nlcd classes equate to the original land cover types in the usda ars ec database based on sharing similar land cover descriptions see table s1 the sample quantiles are defined as weighted averages of consecutive order statistics as illustrated with a generic numeric vector x x 1 x 2 x n the quantile function quantile x p is an estimation of the distribution quantile based on the supplied statistics x at the cumulative probability p in this research we used the continuous sample quantile known as type 7 within the r project for statistical computing quantile function rdocumentation stats version 3 6 2 3 quantile x p 1 γ x j γ x j 1 where x j is the j th order statistic i e the 1st order is mean the 2nd order is variance n is the sample size m 1 p j np m j m n p j m 1 n and γ n p m j the diffuse pollutant load entering the drainage network l e t kg day 1 is then computed for each daily time step collecting the runoff from each land cover class 4 l e t 1 t y l 1 k e c l t a l a a where e c l t kg ha 1 yr 1 is ec value for land cover class l at day t t y is the number of days in the simulated year k represents the total number of nlcd classes in the river basin a l ha is the area of the basin in land cover class l a ha is the total river basin drainage area the variable l e t is optionally referred to as the edge of field diffuse load implying it is entering the drainage network and is the final output of the stochastic export coefficient algorithm fig 1c the algorithm for a stochastic delivery ratio d p t then determines the partitioning of diffuse pollutant into storage and transport within the river basin drainage network fig 1d the stochastic delivery ratio algorithm generates a probability based delivery ratio for the diffuse pollutant p at each daily time step t d p t fraction using an exponential probability distribution function 5 d p t max d p b λ e λ 1 1 p 1 p b 1 1 where d p b fraction is the base delivery ratio value typically specific to the pollutant and 8 digit river basin site λ is the exponential distribution rate parameter defined in this work as 2 p is the cumulative probability of the daily average discharge at time step t defined as p x q t and p b is the cumulative probability base typically set to 0 98 and above which a small number of extreme events result in much higher delivery ratios the diffuse pollutant load released to the basin outlet from the edge of field runoff at the time step t l o t kg day 1 is 6 l o t l e t d p t the diffuse pollutant load entering storage within the drainage network at each time step s e t kg day 1 is 7 s e t 1 d p t l e t where l e t kg day 1 is computed with eq 4 and d p t is computed with eq 5 the value of the unavailable storage for each time step t s u t kg day 1 is computed as 8 s u t s t t a where s t kg is total diffuse pollutant in storage within the river network and t a days is a model parameter called time active which in this research was set to 730 days equivalent to 2 years t a represents the time for the diffuse pollutant to be incorporated in the system the variable s t is updated at each time step as 9 s t s t 1 δ s t the variable δst kg is the change in storage during the time step and is computed as a function of the cumulative probability for the daily average discharge at time step t defined as p x q t 10 δ s t s e t s u t p p b δ s t s e t s u t s o t p p b where s o t kg is the diffuse pollutant from storage that is released to the basin outlet and explicitly defined as 11 s o t d p t s t 1 r a t r where r m is total main channel length for the river basin derived from streamstats in this research and r a t m is the length of channel generating pollutant loading from drainage network storage for the time step t the variable r a t is estimated using an exponential distribution function 12 r a t c r 1 p b e λ 1 1 p 1 p b where c is the active river length fitting coefficient typically set to 5e 4 and all other terms are defined above the exponential distribution function is modified from eq 8 37 chin 2021 the value of active storage available at the start of the simulation s t 0 can be obtained by using a model spin up to find the steady state value in this research s t 0 s t t a where the average daily active storage s t kg is obtained by making an initial guess using that guess to start a model simulation of duration t a and then computing the error between the guess and the modeling result ε s t t a s t t a s t t a to determine if the initial guess was suitable we set an error threshold of ε 1 start from the second iteration we no longer guess s t but use the computed value s t t a t a the iterations stop once the error threshold is satisfied the total diffuse pollutant load to the river basin outlet for the year lo kg is then computed as the sum of all daily loads for the duration of the year ty by using the daily delivery ratio to release load from two sources 13 l o t 1 t y l o t s o t where t y is the number of days in the simulated year l o t kg day 1 is computed with eq 6 s o t kg day 1 is computed with eq 11 the diffuse pollutant storage within the river network resides in two compartments an active storage compartment that will release a fraction to the basin outlet and an inactive storage compartment that is unavailable for release to the outlet due to uptake into deeper sediment layers or organic storage i e the diffuse pollutant is incorporated into the system 2 2 extending model for use of annual average discharge data the stochastic and temporally dynamic export coefficient model was extended to also use annual average discharge by modifying the above equations this required changing time step variable references in eqs 1 to 14 denoted with subscript t from day to year and changing variable t a from 730 days to 2 years further the annual data model adjusted eq 4 to estimate the terrestrial diffuse pollutant runoff into the drainage network l e t kg yr 1 by removing summation across all days of the year as 14 l e t l 1 k e c l t a l t a a where terms are defined in eq 4 and subscript t is assigned a time step of year 2 3 study sites for export coefficient model testing the stochastic and temporally dynamic export coefficient model was tested in three us drainage basins onondaga lake of new york plum creek of colorado and sandusky river of ohio each with more than 20 years of observed diffuse total phosphorus annual loading data the model used nlcd 2016 data for land cover and parameters p b d p b c and s t 0 are provided in table 1 details on area land cover river networks discharge and nutrient monitoring for each basin are provided next onondaga lake basin has a drainage area of 742 km2 within onondaga county of new york and diffuse pollutant loading was measured for 27 years at the outlet of six tributaries which comprise 94 4 of the total drainage area see fig 2 a arranged in descending size the six tributaries are ninemile creek 299 2 km2 onondaga creek 285 1 km2 ley creek 79 0 km2 harbor brook 34 8 km2 east flume 1 9 km2 and trib 5a 0 1 km2 water resources professionals are managing onondaga lake basin to reduce nutrient loading and meet total maximum daily load targets the total phosphorus data were collected as part of the onondaga county water environment protection wep ambient monitoring program amp and made public through annual onondaga county wep amp reports mcmahon 2020 given the presence of 6 tributaries this site was able to test the hypothesis that a discharge data from a single tributary could be used to obtain representative probabilities for the ec values and delivery ratios of an entire basin this hypothesis was tested for the period 1991 to 2017 using discharge records from ninemile creek at usgs gage 04240300 which is 40 3 of the basin and from onondaga creek at usgs gage 04240010 which is 38 5 of the basin fig 2a the ec values for the basin were obtained from the usda ars ec database for the spatially overlapping 8 digit river basin 04140201 the dominant land cover types in this basin include urban 26 8 mostly surrounding the receiving water and forest 32 4 and agricultural 29 8 concentrated in the upper valley and headwaters see fig 2a and table 1 the main channel length for the basin is 57 km based on national hydrography data analyzed by streamstats with the pour point at the lake outlet plum creek basin has a drainage area of 961 km2 and flows into chatfield reservoir in denver colorado and diffuse pollutant loading was measured for 29 years upstream of the creek outlet at titan road near louviers see fig 2b plum creek comprises 73 of the chatfield reservoir drainage and the basin is managed to meet a total maximum daily load due to excess phosphorus loads via agricultural runoff septic system drainage and soil erosion triggered by wildfire and channel evolution the total phosphorus data were collected as part of the nonpoint source pollution control program for chatfield watershed chatfieldwatershedauthority 2015 the model was run for the period 1986 to 2014 using discharge records from the usgs gage 06709530 at titan road near louviers the ec values for the basin were obtained from the usda ars ec database for the spatially overlapping 8 digit river basin 10190002 the dominant land cover types in this basin include urban 9 8 mostly surrounding the receiving water and forest 37 1 shrub and scrub 22 5 and grassland 28 5 distributed throughout main valley and the headwaters see fig 2b and table 1 plum creek comprises 73 of chatfield reservoir drainage area is the main contributor of total phosphorus load and receives phosphorus runoff from septic systems point discharges from wastewater treatment facilities as well as diffuse pollution from agricultural activities which fluctuates across time due to disruptive streambank erosion and wildfires the main channel length for the basin is 72 km based on national hydrography data analyzed by streamstats with the pour point at the diffuse monitoring site and overlapping usgs gauge sandusky river basin has a drainage area of 3450 km2 and flows into lake erie in ohio and diffuse pollutant loading was measured for 38 years upstream of the river outlet near fremont see fig 2c started from 1960s excessive phosphorus became a major problem of lake erie although programs were implemented to reduce tp load from its tributaries through the years tp mean concentration of sandusky river was decreased slightly and the tp load experienced an increase baker et al 2014 professionals are making progresses in achieving the target tp load for sandusky river basin the total phosphorus data were collected as part of a larger study about phosphorus loading into lake erie baker et al 2014 the model was run for the period 1975 to 2012 using discharge records from the usgs gage 04198000 near fremont the ec values for the basin were obtained from the usda ars ec database for the spatially overlapping 8 digit river basin 04100011 the dominant land cover types in this basin include urban 7 9 in clusters along the river and forest 9 2 and agricultural 80 7 distributed throughout main valley and the headwaters see fig 2c and table 1 the main channel length for the basin is 240 km based on national hydrography data analyzed by streamstats with the pour point at the diffuse monitoring site and overlapping usgs gauge 2 4 model sensitivity calibration and uncertainty analysis the stochastic and temporally dynamic export coefficient model estimates of diffuse pollutant load were most sensitive to the following parameters with greatest sensitivity in decreasing order 1 base phosphorus delivery ratio d p b 2 base cumulative probability p b and 3 the active river length fitting coefficient c to maintain model suitability across basins we limited calibration to a single parameter base total phosphorus delivery ratio d p b and only calibrated to the first three years of observed diffuse total phosphorus loading data for each basin the i tree buffer tool will optionally adjust the most sensitive three model parameters during a run to represent uncertainty in the load due to epistemic uncertainty in the model using this approach model central estimates were bracketed by lower and upper estimates of diffuse total phosphorus load with 1 base cumulative probability p b adjusted up and down by 2 but never exceeding a total value of unity 2 base total phosphorus delivery ratio d p b adjusted up and down by 20 and 3 active river length fitting coefficient c adjusted up and down by 20 2 5 deterministic and temporally static export coefficient and delivery ratio model the i tree buffer tool was also coded to contain the deterministic temporally static export coefficient model reckhow et al 1980 which was run for the same study sites the static export coefficient model operated is limited to a single median ec value selected for each land use within the 8 digit river basin obtained from the usda ars ec database the static export coefficient model also used the static phosphorus delivery ratio ds fraction based on the basin ecoregion see table 1 these static delivery ratio values were obtained from the usda small watershed nutrient forecasting tool usda 2018 based on research by chinnasamy et al 2010 the ecoregions surrounding each study site are eastern great lakes lowlands for onondaga lake colorado plateau for plum creek and huron erie lake plains for sandusky river for each basin the temporally static export coefficient model predicted once the total phosphorus load which contrasts with the temporally dynamic approach of newly formulated stochastic export coefficient model which predicted daily or yearly loads using daily or annual discharge probabilities 3 results addressing hypothesis 1 the diffuse total phosphorus loads were better estimated by the stochastic and temporally dynamic export coefficient model than the deterministic and temporally static export coefficient model see fig 3 where the static export coefficient model predicted once and generated a fixed value horizontal line of estimated load the two versions of the dynamic model predicted daily and yearly loads and captured the annual variation in the observed load the stochastic and temporally dynamic export coefficient model predicted a temporal pattern in annual total diffuse phosphorus loading that correlated with the observed data see vertical bars fig 3a to c while loads predicted by the deterministic and temporally static export coefficient and delivery ratio model had no variation across time see dashed horizontal lines in fig 3 model predictions in fig 3 contain the central estimate as histogram bar height and bounding uncertainty as whiskers due to varying model parameters p b by 2 d p b by 20 and c by 20 related to hypothesis 1 the temporally static export coefficient model had goodness of fit metrics that were consistently worse than the stochastic temporally dynamic model using daily average discharge goodness of fit metrics for model predictions using daily average discharge data are presented in this paragraph see table of metrics within figs 3 and 4 the nash sutcliffe efficiency nse was 0 13 for onondaga lake using onondaga creek discharge and 0 10 using ninemile creek discharge was 0 88 for plum creek and was 0 81 for sandusky river the nse subtracts from 1 the ratio of model error to observed mean error where a value of 1 is a perfect model fit while values below 0 suggest the observed mean is a better predicter than the model the percent bias pbias of the model was 0 6 for onondaga lake using onondaga creek discharge and 1 8 using ninemile creek discharge was 1 2 for plum creek and was 1 6 for sandusky river the pbias measures the average departure of the model prediction from the observed value the root mean square error rmse was 9 14 t yr 1 for onondaga lake using onondaga creek discharge and 9 34 t yr 1 using ninemile creek data was 1 09 t yr 1 for plum creek and was 92 09 t yr 1 for sandusky river the rmse measures the standard deviation of the residuals and is relative to the magnitude of the load making comparisons within basins easier than between basins the rmse standard deviation ratio rsr was 0 91 for onondaga lake using onondaga creek discharge and 0 93 using ninemile creek discharge was 0 35 for plum creek and was 0 43 for sandusky river the rsr normalizes rmse values where a value of 0 indicates a perfect fit and larger positive values extending to infinity demonstrate increasingly poor fit the coefficient of determination r2 was 0 44 for onondaga lake using onondaga creek discharge and 0 40 using ninemile creek discharge was 0 89 for plum creek and was 0 87 for sandusky river the r2 has a range from 0 to 1 where 1 is perfect correspondence a scatter plot addressing hypothesis 2 the results will show that annual variation in loading was better predicted with the stochastic and temporally dynamic export coefficient model using daily average discharge rather than with annual average discharge the use of annual average discharge data within stochastic temporally dynamic export coefficient model caused prediction goodness of fit values to degrade compared with predictions using daily discharge data see table of metrics within figs 3 and 4 the nse degraded by approximately 1 5 and became negative for onondaga lake and the average of the plum creek and sandusky river nse values degraded by 75 the pbias degraded to values averaging 32 for the four basins from values within 2 of a perfect zero the rmse degraded by 67 for onondaga lake 170 for plum creek and 89 for sandusky river close to doubling in value for all four basins similarly the rsr degraded with values increasing on average by 85 or nearly doubling in size the r2 had a mixed change when predictions used daily vs annual average discharge degrading by an average of 0 2 units for three basins but increasing by 0 02 units for onondaga lake using ninemile creek discharge model predictions experienced a degradation of the r2 when changing model inputs from daily to annual average discharge most notably in scatterplots in plum creek and sandusky river fig 4 the i tree buffer stochastic and temporally dynamic export coefficient model loads had a statistically significant correlation with observed loads regression coefficients p 0 001 addressing hypothesis 3 the results also show annual variation in loading was predicted equally well with discharge data from either tributary in the multi tributary onondaga lake basin onondaga creek or ninemile creek the goodness of fit data along with a statistical t test were used in the onondaga lake basin to examine the hypothesis that the discharge data from a single tributary i e onondaga creek or ninemile creek can be used to obtain representative probabilities for ec values and delivery ratios of a multi tributary basin fig s1 the goodness of fit metrics for diffuse loads predicted with onondaga creek vs ninemile creek discharge data were similar using daily average discharge the two tributaries nse values were within 0 03 units the pbias values were within 2 4 the rmse values were within 0 3 t yr 1 the rsr values were within 0 02 units and the r2 values were within 0 04 units while the goodness of fit metrics worsened when changing from daily to annual average discharge the metrics remained comparably close for annual loads estimated using each tributary the paired two tailed equal variance t test was used to examine the hypothesis for the period of record in onondaga lake basin the paired sample t test p values were p 0 25 for both of the tributary discharge inputs indicating no statistical difference between 2 groups of the modeled loading values notched box plots with whiskers set to 1 5 times the interquartile range were used to analyze the diffuse load time series including differences between i tree buffer stochastic and temporally dynamic export coefficient model predicted and observed medians outliers and skew see fig 5 the box plot analysis used the metric of relative diffuse load defined as the actual load t yr 1 divided by the maximum value in the respective modeled or observed time series such that 1 is the largest value the fig 5 box plots included the central prediction and the uncertainty predictions from fig 3 using daily average discharge data the i tree buffer stochastic and temporally dynamic export coefficient model predictions for each of the three basins had 1 statistically similar median loads to the observed values see notches overlapping in fig 5 2 a similar number of outlier loads see open circles above the upper whisker in fig 5 and 3 a similar statistical skew based on the relative distance of box quartiles and whiskers from the median see fig 5 by contrast using annual average discharge in the i tree buffer stochastic and temporally dynamic export coefficient model degraded all but skew regarding the box plot fit between modeled and observed loads with 1 median loads for onondaga lake statistically different than observed loads and lower for all three basins and 2 estimates of outlier with errors of omission commission or dramatically different magnitude 4 discussion 4 1 improved performance of stochastic export coefficient model the use of discharge probability to simulate interannual variation in diffuse pollution loads in this research is supported by observations linking precipitation and runoff as drivers to diffuse pollutant transport with loading rates increasing with discharge hanrahan et al 2001 haygarth et al 1998 hill 1981 kalkhoff et al 2016 to examine the effectiveness of this approach the new model was tested on basins with observed diffuse total phosphorus loads extending across at least one decade which allowed for interannual variability the three basins used in testing had observed diffuse loading for 27 29 and 38 years drainage areas of 742 km2 961 km2 and 3450 km2 located in different us ecoregions and 2 digit hucs of 02 04 and 10 with different climate and land cover use for each basin calibration was used with the first three years of observed data to select a single parameter the base delivery ratio d p b in an effort to uphold the nature of i tree tools and export coefficient models as first order and parsimonious in all cases the new stochastic and temporally dynamic export coefficient model was a much better predictor of observed loading than the temporally static export coefficient model the goodness of fit metrics and statistical tests between model predictions and observed data show the stochastic and temporally dynamic export coefficient model when used with daily or annual average discharge performed better than the static export coefficient model while a key benefit of the export coefficient model is its simplicity and lack of need for calibration multi parameter calibration is an option in cases where observed data were available and users wished to maximize fit to demonstrate the impact of such calibration on model fit the first three years of observed data were used to calibrate the two parameters p b and c which slightly improved goodness of fit metrics see table s2 vs metrics in fig 3 rather than attempt exact agreement between observed diffuse pollutant load and any singular estimate by the new export coefficient model we instead encourage predictions are bounded by uncertainty using a 20 range in two model inputs created a predictive range capturing 65 of all observations box plots constructed from many years of annual loads also provide a central estimate bounded by uncertainty see fig 5 export coefficient models provide first order estimates i e they do not simulate all complexities in diffuse pollutant loading hence uncertainty should always be considered uncertainties may arise due to specific characteristics of the basin total phosphorus loads for the onondaga lake basin are known to be affected by the large amount of nutrient and sediment detention occurring in the headwater otisco lake and by urban area combined sewer overflows coon et al 2009 interestingly the plum creek basin provided the best performance for the i tree buffer stochastic and temporally dynamic export coefficient model despite this creek receiving an unspecified load from wastewater treatment plants given the close match between predicted and observed loading it is likely those wastewater discharges were proportional to discharge or were insignificant the model captured the timing and magnitude of observed loads ranging from 0 47 metric tons in 2002 to nearly 10 metric tons in 1999 and 2007 based on our three simulated basins we determined model performance is affected by the land cover types and variation in the land development i e human footprint across the basin in plum creek basin there was less than 0 1 agricultural land and less than 10 urban land by contrast the onondaga lake basin had 30 in agriculture land and 27 in developed land while sandusky river basin had 81 agriculture land and 8 in urban land cover this larger human footprint in the onondaga lake and sandusky river basins seems to be revealed in the box and whiskers plots fig 5 which have a greater spread about the inter quartile range and whiskers their observed tp load data is more symmetrically distributed and less skewed which does not align with the typical precipitation distributions that tend to be positively skewed under global warming watterson and whetton 2011 the plum creek basin has a relatively tight box and whiskers its discharge and observed tp load share a similar positively skewed distribution and the coefficient of determination r2 0 93 showed that this area has the strongest discharge tp load relationship fig 4c 4f and 4i 4 2 flexibility of i tree buffer tool for stochastic export coefficient model flexibility was built into the discharge data options for the stochastic and temporally dynamic export coefficient model through the i tree buffer tool this tool allows for multiple adjustments to the model including use of daily or annual average discharge for generating probability estimates some users may not have access to daily average discharge data e g gages are not installed or can be damaged during flood events tencaliec et al 2015 and can then use annual average discharge time series to make estimates of temporal variation in loading degrading the temporal resolution of discharge data from daily to annual was shown to degrade the goodness of fit of model predictions causing underestimation of loads in years with high loading these predictions were still much better than those of the static model degradation in estimates when using annual vs daily average discharge data was evident in the pbias with its large negative values for the three study basins e g 42 35 and 7 where pbias was computed as predicted minus observed loads this degradation is attributed to annual resolution discharge missing the storm events delivering high daily flows and containing the kinetic energy that drive the processes associated with large nutrient loads flexibility was also designed into this stochastic and temporally dynamic export coefficient model representation of nps pollutant storage within the drainage network the user can turn off the storage function represented by eqs 7 through 12 which then removes the 2nd right hand side term in eq 13 the calibration of the base delivery ratio should then be performed for this model option tests of a storage free formulation of the model generated goodness of fit metrics that degraded pbias by 0 3 for plum creek and by 1 3 for sandusky river and for sandusky river degraded nse by 1 7 rmse by 3 7 and rsr by 3 8 compared with the predictions based on simulated storage table s3 it should be noted as long as the delivery ratio is less than 1 with this model formulation storage is still occurring within the drainage network even if eqs 7 through 12 are inactive a delivery ratio 1 indicates the basin outlet only yields a fraction of the edge of field load in the three study basins tested in this research greater than 50 of the load entering the drainage network was stored and did not reach the outlet for the multidecadal simulation the mean storage capacity was 81 for onondaga lake basin 67 for plum creek basin and 40 for sandusky river basin this storage is either implicitly resolved in the model delivery ratio parameter or can be explicitly tracked with the drainage network storage module finally this research demonstrates the new export coefficient model accuracy was insensitive and hence flexible with respect to use of any representative discharge time series in lake basins where there are multiple large tributaries this robustness was demonstrated in the onondaga lake basin were we swapped onondaga creek and ninemile creek time series of discharge it is presumed this flexibility is limited to tributaries with a similar climate and a similar response to the precipitation events and hence similar flow duration curves 4 3 sensitivity of stochastic export coefficient model parameters sensitivity of the new export coefficient model was greatest for the base delivery ratio parameter d p b which determines the fraction of diffuse pollution passing from the river network into the receiving water clearly it is challenging to collapse the many processes affecting such transport and fate into a single parameter and it was not well estimated by regional databases provided by the usda ars the usda ars small watershed nutrient forecasting tool swift provides pollutant delivery ratios for all us ecoregions usda 2018 which are computed by taking the quotient of two swift outputs the delivered from watershed load and the edge of field load usda 2018 the swift prediction of the delivery ratio varies with the probability of the event providing a 10 50 average and 90 value the average swift delivery ratios d p s see table 1 were on average 4 7 times larger than calibrated base delivery ratio d p b values for onondaga lake and plum creek basin which were used in the i tree buffer stochastic and temporally dynamic export coefficient model the temporally static export coefficient model using swift generated delivery ratio values had total phosphorus loads that were larger than both the observed and predicted loads from the i tree buffer stochastic and temporally dynamic export coefficient model by 5 3 times for onondaga lake basin and by 2 6 times for plum creek basin the usda ars ec database does capture how changes in land cover and management between river basins leads to large variations in diffuse loading and ec values when diffuse loading is simulated with the temporally static export coefficient model using median ec values this can lead to rather extreme variations in model performance for example the temporally static export coefficient model performed 100 worse in onondaga lake basin than in plum creek basin where delivery ratios d p s only differed by 30 a cause for this large predictive error between basins is attributed to the ec values for nlcd class 82 cultivated crops in onondaga lake basin this land cover occupied 18 of the area and had median ec values that were nearly an order larger than all other nlcd class median ec values combining the ec value with the large d p s value resulted in nlcd class 82 generating 58 6 of the total phosphorus load for the temporally static export coefficient model by contrast in the plum creek basin no single nlcd class had relatively large median ec values which protected the model from estimating high loads despite the relatively high d p s value in the sandusky river basin the d p s value was within 0 15 units of the calibrated d p b value which constrained overprediction of loads by the temporally static export coefficient model despite relatively large median ec values for nlcd class 82 see tables 1 and 2 4 4 generation of delivery ratio values accurate methods for delivery ratio estimation are needed to improve use of both stochastic and deterministic export coefficient models this recommendation extends to export coefficient models which run without delivery ratios such as pload where ec values are treated as basin outlet loads and not edge of field loads when ec values represent river basin transport accurate estimates for drainage network storage are needed angello et al 2020 demonstrated such an application and their use of an in situ method to select properly sized ec values with pload might work to select delivery ratios the in situ method of angello et al 2020 used an upstream and downstream sample of loads to perform a chemical mass balance and find representative ec values as might be expected most users of a first order export coefficient model are looking for a low cost or a priori method to estimate delivery ratios and their effect on ec values the use of basin characteristics assessment might provide an a priori alternative to estimation of the delivery ratios coon and reddy 2008 implemented this approach for onondaga lake basin and determined a headwater reservoir otisco lake contributed to large nutrient and sediment retention combining basin characteristics with a literature review coon and reddy 2008 estimated delivery ratios for onondaga lake basin near in the range of 0 21 to 0 29 which is closer to the calibrated value of 0 13 than the regional value of 0 61 provided by swift swat simulation was used by hua et al 2019 to assign delivery ratios for nitrogen and phosphorus diffuse runoff fate and transport creating parameters called pollutant migration coefficients for each reach of the drainage network hua et al 2019 found the downstream reaches had smaller delivery ratio values than headwater reaches which aligns with other research showing delivery ratios have an inverse relation with drainage area and decay with distance from the pollution source birkinshaw and bathurst 2006 coon and reddy 2008 jim and yang 2006 perhaps swat or comparable model simulations at the national or international scale with inputs such as national hydrograph data on drainage network characteristics could be used to generate a reliable database of deliver ratios to complement the usda ars national ec database 4 5 considering global export coefficient value databases this study built the stochastic and temporally dynamic export coefficient model functions around the usda ars ec values database available in the us previous efforts to introduce variability in ec values have come with either regional specificity or relatively laborious effort and there is no global database currently available in the us an alternative ec database is manage for measured annual nutrient loads from agricultural environments harmel et al 2008 which contains empirically derived ec values that represent nearly 300 us basins the database has 1700 basin years of ec values for the most common agricultural land cover types e g corn fallow pasture wheat and management practices e g crop rotation tillage harmel et al 2008 the 100 s of basins with ec values in the manage database are simply too few relative to the 1000 s of basins across the us in need of estimated diffuse loads for total maximum daily loads similar to the work of the usda ars white et al 2015a others use the swat simulation to address the economic burden of deriving basin ec values through monitoring ahmad et al 2011 almendinger and ulrich 2017 cheng et al 2008 jiang et al 2014 liu et al 2017 the swat uses local weather soil land use management and conservation inputs and therefore makes more accurate estimates of diffuse loads than the export coefficient model using non local ec values delkash et al 2014 wang et al 2020 proposed selecting ec values based on factors of rainfall slope soil and land use for each sub catchment area in the three gorges region of china which effectively leads to a higher complexity model like swat needing to be run in order to parameterize the first order export coefficient model with similar complexity liu et al 2017 recommended deriving ec values from field experiments with artificial rainfall which led to use of swat for calibration which may not be feasible for some users trying to manage their river basins for total maximum daily loads others have attempted to generate interannual variability in ec values ding et al 2010 developed an interannual variation impact factor αt to use with the export coefficient model based on spatial and temporal heterogeneity in precipitation across the pixels in their simulated river basin wu et al 2016 and cheng et al 2018 simulated interannual variability in total phosphorus loading for the beilouhe and luanhe river basins of china by using quadratic polynomial regressions between observed annual loads and total precipitation the cubic polynomial regression worked for the locally fitted range of precipitation however this quadratic regression would likely fail in other basins or years if precipitation exceeded the fitted range due to local concavity or convexity in the polynomial such curvature is typically inconsistent with monotonicity of total phosphorus load increasing with runoff increasing and could even result in negative value of predicted loads seasonal variation in ec values was achieved by hanrahan et al 2001 when weighting ec values by monthly discharge the discharge values were obtained by subtracting baseflow from the total discharge it is important to note this generated intra annual or seasonal variation and was not used to simulate interannual variation in diffuse loading each of these models used variation in weather data to configure temporal variance in the export coefficient model estimate of nutrient loads under steady land cover a promising next step ec model development is to revisit these existing international swat simulations replicating the work of white et al 2015a and generating a global database of ec values for use in qppec transform method to enable temporally dynamic simulation beyond the us it is likely important to allow river basin managers non swat options given swat simulations can require many hours of data preparation and simulation time 4 6 spatially dynamic export coefficient modeling the next goal for the export coefficient model is to represent spatial variation in diffuse runoff nutrient loads while the usda ars ec values database of white et al 2015a provides a first pass at spatial heterogeneity in ec values by representing changes in topographic slope soils and management additional spatial refinement for ec values is possible additional spatial refinement in ec values can be obtained by considering the localized runoff and buffering likelihood that initiates and directs diffuse runoff this idea was pursued by endreny and wood 2003 with an ec valuespatial weighting algorithm based on topography and buffers in the runoffcontributing areas and dispersal areas endreny and wood 2003 also used a range of animal stocking densities and manure spreading i e land management to represent uncertainty in ec values and model predictions reckhow et al 1980 based on this contributing areas and dispersal areas theory stephan and endreny 2016 developed an i tree buffer spatially dynamic export coefficient model that can generate maps of weighted ec values that identify diffuse pollutant loading hotspots the temporally dynamic i tree buffer export coefficient model provides rapid functionality with simulation times 1 min when coded in c or slightly longer in rstudio the proposed updates to create databases with accurate delivery ratio values and expand the usda ars ec value database to international basins will improve the accuracy and range of applications for this i tree buffer model 5 conclusions the i tree buffer tool and its stochastic and temporally dynamic export coefficient model was developed to generate diffuse pollutant loading estimates that can vary across time and match observed trends by contrast the deterministic and temporally static export coefficient model generates a single load across years and is unable to estimate of interannual variation the i tree buffer model is now capable of providing temporal and spatial variation in export coefficient values and provides a more accurate estimation of diffuse pollutant loads across the study sites used in this research it was shown when daily discharge time series are not available the i tree buffer model can use annual average discharge data at the cost of degradation in goodness of fit metrics for predicted loads yet still correlate strongly with observed temporal variation in loading further for those multi tributary basins this research shows the model makes accurate predictions using discharge data from a single representative tributary the temporally dynamic i tree buffer model is meant for river basin managers who had previously used the static export coefficient model providing them with data driven selection of ec values from a proven database generated by detailed probabilistic swat simulations the new model demonstrates a significant improvement in predictive capacity of diffuse pollutant loads for river basins of different sizes ecoregions climate and land cover the usage of this model can be extended by creating an international ec value and delivery ratio database for global applications this model can also be used in conjunction with other i tree models for example it can work with the i tree hydroplus to simulate the complete water circle from precipitation to interception evaporation infiltration runoff diffuse pollution and then delivered to receiving water it also can be incorporated into other modules within i tree buffer to create a diffuse pollutant hotspot mapping tool for strategically guiding tree planting and water quality improvements may this model help us discover ways to improve our world and make our waters more fishable swimmable and drinkable credit authorship contribution statement li zhang conceptualization methodology software visualization data curation writing original draft theodore a endreny conceptualization methodology funding acquisition supervision writing review editing emily a stephan conceptualization methodology declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests theodore a endreny reports financial support was provided by us department of agriculture forest service theodore a endreny reports a relationship with suny college of environmental science and forestry department of environment resources engineering that includes employment and non financial support theodore a endreny reports a relationship with i tree consortium that includes non financial support li zhang reports a relationship with suny college of environmental science and forestry department of environment resources engineering that includes non financial support li zhang reports a relationship with i tree consortium that includes non financial support emily a stephan reports a relationship with noaa national weather service that includes employment acknowledgements this research was supported by two agreements with the usda forest service including a research joint venture 21 jv 11242305 069 and 21 dg 11094200 242 the suny esf department of environmental resources engineering provided computing facilities and logistical support the i tree consortium provided technical support appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129447 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
