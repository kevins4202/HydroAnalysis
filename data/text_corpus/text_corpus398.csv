index,text
1990,organic pollution in river systems is a key indicator of river water quality identifying organic pollution sources and quantifying source contributions are important in improving water quality planning and management however basin scale patterns in riverine organic pollution sources and yields to predict water quality remain poorly understood here we propose an urban disturbed index udi coupled with riverine hydrology to quantify the current and potential impacts of urbanization on riverine organic pollution at the basin scale we identified the source contribution from urban point sources and non point sources by using monthly riverine discharge and monthly monitored data in chemical oxygen demand cod and biological oxygen demand bod concentrations from 2016 to 2018 there were significant spatial differences in the river codmn and bod5 fields across the whole basin and the urban point source contribution of codmn and bod5 increased from 19 to 79 and from 18 to 76 respectively from the river source area to the river mouth the urban point source yields of codmn and bod5 increased as the udi increased our study suggests that basin scale udi together with riverine discharge determine the river organic pollution source and yield in the entire changjiang river network our results are useful for riverine water quality planning and management data availability data will be made available on request 1 introduction climate change biodiversity loss and chemical pollution are considered threats to humankind and the global environment but the chemical pollution crisis has not been sufficiently addressed by global and national policies bai et al 2021 brack et al 2022 organic pollution in river systems is a key indicator of river water quality impacting both the safety of drinking water supply and dissolved organic matter dom transfer fuhrmeister et al 2015 tang et al 2019 vigiak et al 2019 vorosmarty et al 2010 wen et al 2017 the dom content consists of a complex mixture of distinct chemical species the two basic measurements of the organic paollution level are the chemical oxygen demand cod mg l 1 and biochemical oxygen demand bod mg l 1 the codcr and bod5 represent two integrated processes of organic pollution organic pollutant loading and microbial degradation the quantity and quality of river cod and bod have the potential to influence the suitability of water quality for human use chen et al 2006 lee et al 2016 as well as the health of the non human components of the ecosystem that depend on the river for example the amount i e concentration and or mass and chemical quality i e composition of cod in surface water has been shown to influence metal binding yamashita and jaffé 2008 production of disinfection byproducts during drinking water treatment beggs et al 2009 freshwater ecosystems malaj et al 2014 and electron transfer reactions i e redox processes ratasuk and nanny 2007 which influence downstream energy transfer miller et al 2006 the organic pollution of rivers originates from urban point sources of wastewater discharge and non point sources of livestock waste sewer overflows wetlands and aquatic creature emissions williams subiza et al 2022 quantifying bod loads into rivers has drawn more attention at both regional and global scales fuhrmeister et al 2015 vigiak et al 2019 voss et al 2012 wen et al 2017 progress in qualitative bod and doc measures can thus effectively complement global and regional modelling efforts based on quantitative bod and doc export data alvarez cobelas et al 2012 lv et al 2019 wen et al 2017 these studies emphasize the effects of climate change on in river bod levels but are less focused on the spatial patterns in source loads of organic pollutants into rivers within river networks such as point and non point sources how bod spatial patterns determine riverine organic pollution remains unclear at the basin scale water safety still faces challenges in terms of water quality deterioration and an increase in water demand both in china and globally under human activities and climate change mainali and chang 2018 mcdonald et al 2011 with increasing urbanization and urban population growth both sources of organic pollution will vary greatly vigiak et al 2020 furthermore compared with bod studies few studies have reported in river cod pollution dubber and gray 2010 it is necessary to integrate cod into organic river pollution particularly in those regions where cod instead of bod is listed as a routine monitoring index of organic river pollution such as in china third when transported through the river network organic matter can be removed by degradation also called self purification and dilution before it is exported to estuaries or coastal seas although some studies have focused on organic degradation and dilution studies on in river organic matter removal by coupling biochemical and hydrological processes at network scales are still rare given the spatially heterogeneous variation the amount of cod loading in rivers and the in river removal processes have not been systematically integrated identifying organic pollution sources and quantifying the source contributions are important for water quality planning and management because of degradation and dilution the impact of organic matter load from each urban point on riverine yield can vary greatly when considering the specific location of cities in the river network in particular the accumulated negative environmental effects of urbanization produce huge disturbances in riverine organic pollution however due to a lack of high frequency spatio temporal observations to gather monitoring data and drivers the variations in riverine cod and bod and its biogeochemical processes under increasing anthropogenic interference and climate change remain poorly understood putro et al 2016 wilson and xenopoulos 2009 china has experienced rapidurbanizationduring the past half century which has resulted in wide disruptions to the environment including regional climates quan et al 2021 ren et al 2008 wang and ge 2012 2015 extreme temperatures xiao et al 2019 vegetation degradation li et al 2015 precipitation and flood intensification ertan and çelik 2021 farid et al 2010 and winter haze zhong et al 2018 in particular rapid urbanizationhas been recognized as the primary cause of deterioratingsurface waterquality ren et al 2014 wang et al 2021b including coastal waters wang et al 2021a however quantifying the effects of urbanization on water quality remains a challenge here we propose an urban disturbed index udi to quantify the current and potential impacts of urbanization on riverine organic pollution on the whole basin scale in china s largest changjiang river basin udi values were calculated using three parameters regarding urban disturbances see methods section we further hypothesized that a shift in the sources of riverine organic pollution could be determined by udi on the whole basin scale using monthly monitored data on cod and bod concentrations from 2016 to 2018 as a riverine organic pollution index we studied seasonal variations in cod and bod yields along the key hydrological stations of the changjiang river the main objectives of the study were i to analyze spatial and monthly patterns in organic pollution trends in terms of cod and bod in the changjiang river ii to identify the source contribution of riverine cod and bod from both urban point emission and non point discharges iii to propose the udi concept and to develop links between riverine cod bod yield and urban point load and iv to predict scenario changes in future urbanization in the changjiang basin 2 materials and methods 2 1 study area and site collection the study was conducted in the changjiang river basin 24 27 35 54 n 90 13 122 19 e the third largest river in the world with an average annual discharge of 10 1011 m3 monthly water discharge and concentrations of cod and bod for three years 2016 2018 were monitored at 11 key national hydrological stations nhss along the changjiang river of which seven nhss were along the main stem of the river from the source area of the river zhimenda zmd nhs to the river mouth datong dt nhs fig 1 and table 1 the other four nhss represent the main tributaries of the river the dt nhs located at the upper limit of the river mouth is free from the influence of both tidal cycles and industrial waste from nearby cities the stretch of the changjiang river above the dt nhs drains 94 of the entire basin and delivers more than 95 of the water to the estuary yan et al 2003 2 2 monthly water discharge and concentrations of codmn and bod5 data at each nhs data on monthly water discharge at 11 key nhss along the changjiang river were compiled from the water resources information center ministry of water resources china changjiang river yearbook 2017 2019 the monthly concentrations of codmn and bod5 were monitored by the china national environmental monitoring centre china national environmental monitoring centre 2017 2019 the monthly concentrations of codmn were measured continuously for three years from january 2016 to december 2018 and the monthly concentrations of bod5 were measured continuously for two years from january 2017 to december 2018 monthly riverine codmn bod5 fluxes were estimated based on the monthly discharge weighted data by multiplying the monthly concentration of codmn bod5 by the monthly river discharge rate 2 3 point source data and socio economic data at prefecture level city scale data of point sources of codmn and bod5 wastewater discharge were compiled from the china statistical yearbooks on environment 2016 2018 chinese national bureau of statistics 2017 2019a which contains annual values but not monthly values annual codmn and bod5 loads into the river from point sources were then calculated based on prefecture level cities within each sub basin in the current study the urban point source of cod was expressed as codcr and the riverine cod monitored was expressed as codmn the conversion ratio of codcr codmn is reported to range from 1 5 to 4 he et al 2016 jing et al 2016 siwiec et al 2018 wu et al 2019 yin et al 2022 zhao et al 2022 and an average ratio of two was used when comparing the point source contribution of cod to riverine cod flux in the current study the urban construction land data used in this study were based on landsat remote sensing images combined with land cover data and interpreted and drawn from the national annual scale long term series data li et al 2018 the spatial resolution of the data was 30 m 30 m and the length of time was 1985 2018 the data of urban population and gross domestic product gdp were compiled from the statistical bulletin of national economic and social development of each city in 2016 2018 chinese national bureau of statistics 2017 2019b 2 4 concept and calculation the key steps to assessing temporal and spatial patterns in riverine organic pollution and the impact of urban disturbance included evaluating urban distribution patterns and the urban disturbance index udi section 2 4 1 quantifying organic pollution source contributions section 2 4 2 and future scenario analysis section 2 4 3 2 4 1 evaluating urban distribution pattern and urban disturbance index udi we considered three factors in constructing the udi a urban density in the basin b length of rivers affected by urban source pollution and c the number of urban populations that may cause organic pollution the udi was calculated using the following formula 1 udi a 100 a ub b 100 l rv c p ub where a ub represents the area of urban construction land per unit area 100 km2 of the sub basin l rv represents the area of urban construction land per unit river length using the ratio of urban construction land area to the length of the river in each sub basin p ub represents the urban population per unit area of the sub basin i e the ratio of the urban population in each sub basin to the sub basin area a coefficient of 100 was used to adjust the different orders of magnitude of the three parameters the magnitudes of a ub and l rv are between 10 2 and 100 and the magnitude of p ub is between 100 and 102 the letters a b and c denote the ratio coefficients associated with each variable and the total ratio sum is 1 i e a b c 1 we ran the calculation with different ratio data the process produced 10 000 bootstrapped samples to obtain the final values of udi with the highest frequency fig s1 thus a udi for each sub basin was constructed furthermore the relationship between udi and organic pollution codmn and bod5 was established using statistical correlation and regression analyses we analyzed how urban organic matter output responded to changes in the udi 2 4 2 quantifying organic pollution source contribution urban point source vs non point source section 2 3 mentioned the annual urban point source data but did not cover monthly urban point source data therefore the monthly riverine organic pollution sources of point and non point could be separated based on the so called emission or transport approach at each of the 11 nhss of the river i e the low flow conditions dry season reflect the dominance of point sources while the high flow conditions flood season reflect the signal of non point emissions putro et al 2016 wilson and xenopoulos 2009 therefore organic pollution loading from non point sources is carried into the river by surface runoff during the flood season and thus the river flux includes both non point sources and urban point sources from industrial wastewater and domestic sewage emissions in the dry season the riverine organic pollution flux includes only point source organic loading in the basin which is strongly related to urbanization in the basin putro et al 2016 wilson and xenopoulos 2009 therefore by analyzing the changes in organic pollution flux in river sections during flood and dry periods the contribution of point and non point sources of organic pollution in river sections can be modeled using the following formulae 2 r np e np e year i 1 12 c i f i c dry f dry i 1 12 c i f i 3 r p e p e year e year e np e year where r np is the proportion of non point source organic pollution in the total organic matter of each nhs r p is the proportion of point source organic pollution e year is the total annual flux of organic matter at each nhs e np is the annual flux of non point source organic pollution and e p is the annual flux of organic pollution from point sources c i is the monthly concentration of organic pollution f i is the monthly discharge i is the month from january to december c dry represents the concentration of organic pollution in the dry season and f dry represents the flux in the dry season the dry and wet seasons were divided based on the monthly discharge changes of the selected 11 nhss using the data of the recent ten year period in addition we compared the results of different periods such as 10 year 20 year or 30 year and there was no significant difference between the dry and wet seasons fig s2 we compared the modeled and monitored data for codmn and bod5 loads from urban point sources across the entire changjiang river network fig s3 overall the modeled values were comparable to the monitored values after considering riverine removal 2 4 3 future scenario analysis we predicted the scenario change in export yield of point source organic pollution under future urbanization three udi scenarios were established table s1 and each input parameter was set by a different percentage relative to the 2018 level when referring to the change in these parameters over the past 20 years 1998 2018 for example the change rate of urban construction land area from 1998 to 2018 was an average of 5 per year maximum of 8 4 per year and the urban population growth rate was an average of 3 5 per year maximum of 5 per year thus we assumed three udi scenarios as follows scenario 1 a ub and l rv increased by 15 p ub increased by 10 3 years of growth and point source cod treatment rate r sw for sewage treatment plant was at current level scenario 2 a ub and l rv increased by 40 p ub increased by 20 7 8 years of growth and r sw was at current level scenario 3 a ub and l rv increased by 40 p ub increased by 20 7 8 years of growth and r sw increased by 5 considering that the current cod treatment rate of sewage has reached 83 3 national average of the cod inflow 3 results 3 1 spatial patterns of river discharge and codmn and bod5 concentrations the annual river discharge 2016 2018 at nhss showed substantial spatial variations with the lowest 1 63 1010 m3 yr 1 at zmd and the highest 9 29 1011 m3 yr 1 at dt in the changjiang river basin fig 2 the lowest discharge at wl of the tributary wu river was 4 87 1010 m3 yr 1 and the highest discharge at clj of the tributary dongting lake was 2 63 1010 m3 yr 1 the monthly average concentration of codmn at the nhss varied greatly in the changjiang river basin fig 2 both the highest concentrations of codmn 2 47 mg l 1 and bod5 1 72 mg l 1 were observed at hk while the lowest concentrations of codmn 1 02 mg l 1 and bod5 0 64 mg l 1 were at zmd and yc respectively 3 2 urban distribution pattern there are approximately 336 prefecture level and county level cities located in the changjiang river basin fig 3 these cities generally locate on the rivers of higher order 5th to 8th strahler river order approach dubber and gray 2010 the three important urban indicators a ub l rv p ub are presented in table 1 significant spatial variation of a ub existed in the whole river basin with values ranging from 0 01 to 1 94 a ub values increased from upstream to downstream along the main stem of the changjiang river in addition the three sub basins hk dt and clj had high values of a ub with the highest value of 1 94 at the hk sub basin the values of l rv varied from 0 02 to 3 27 with the highest value at the hk sub basin p ub also showed great spatial variation with the lowest 1 89 at zmd and the highest 157 45 at clj the change in p ub was the strongest of all three indicators as the population represented by p ub varied greatly among cities we integrated the three indicators to obtain the udi table 1 the udi showed a similar spatial pattern to those of the three indicators the values varied from 1 68 to 215 26 with the highest value at the hk of the poyang lake sub basin 3 3 codmn and bod yields from urban point and non point sources the annual codmn and bod5 yields were estimated by multiplying the monthly concentration and water discharge the annual codmn and bod5 yields demonstrated different patterns from those of discharge and concentration fig 2 codmn and bod5 yields were 1018 73 and 562 99 kg km 2 yr 1 respectively for the whole changjiang river basin the highest yields of codmn and bod5 were 2461 22 and 1494 67 kg km 2 yr 1 respectively at hk representing codmn and bod5 yields from the ganjiang river tributary the lowest yields of codmn and bod5 were 148 04 and 140 41 kg km 2 yr 1 respectively at zmd representing codmn and bod5 yields from the source area of the changjiang river the point source codmn and bod5 yields increased from 27 02 kg km 2 yr 1 to 1930 52 kg km 2 yr 1 and from 23 28 kg km 2 yr 1 to 1070 80 kg km 2 yr 1 respectively from the river source area to the river mouth fig 4 a the urban point source yields of codmn and bod5 at the upper river source area zmd more than 4800 km from the river estuary were the lowest 27 02 and 23 28 kg km 2 yr 1 respectively and these data reached the highest near the river mouth 500 750 km from the river estuary the non point source yields of codmn and bod5 at upper river source area zmd were the lowest 121 01 and 116 90 kg km 2 yr 1 respectively and the non point source yields of codmn reached the highest at clj of the dongting lake sub basin is 816 79 kg km 2 yr 1 the non point source of bod5 yields reached the highest at hk of the ganjiang river tributary at 423 86 kg km 2 yr 1 fig 4b 3 4 urbanization effect on organic river pollution we further evaluated the relationship between the udi and the urban point source yield in the changjiang river fig 4c d the relationship between each indicator and the point source yield of organic pollution codmn and bod5 at the sub basin scale is shown in fig s4 we found that urban point source yields of codmn and bod5 increased as the udi increased codmn r2 0 82 at p 0 01 bod5 r2 0 81 at p 0 01 indicating that urbanization controlled the point source yield we identified the source contribution from both urban point emission and non point discharge the urban point source contribution of codmn increased from 19 to 79 and bod5 from 18 to 76 from the river source area to the river mouth fig 5 in contrast the non point source contribution of codmn decreased from 81 to 21 and bod5 from 82 to 24 this demonstrated that the urban point source had a similar impact on riverine codmn and bod5 fluxes across the whole river basin indicating that source loading was more important than transportation considering that the point source dominated the river yield we suggest that urbanization has a strong effects on riverine codmn and bod5 yields 4 discussion 4 1 dilution and degradation effects two important processes influence the riverine codmn and bod5 yields dilution and degradation effects voss et al 2012 wen et al 2017 wright and mcdonnell 1979 there was a significant dilution effect resulting from increasing water discharge in the changjiang river basin we analyzed the dilution effect on codmn and bod5 transport using the ratio of codmn and bod5 concentrations against river discharge fig s5a b we found that codmn and bod5 concentrations decreased substantially as river discharge increased the dilution effect of the urban point source portion in codmn and bod5 concentrations with riverine water discharge was analyzed fig s5c d this indicated that the point source and total source had a similar dilution effect our results suggest that both urban point source loading and water discharge influence riverine codmn and bod5 concentrations in addition water discharge influences the river hydraulic load such as the retention time in the channel which further influences codmn and bod5 degradation and removal in the channel lv et al 2019 wilson et al 2010 4 2 riverine dam effect on hydrology and codmn and bod5 removal dam reservoirs in watersheds are vital components of large river networks currently there are more than 58 400 large dam reservoirs globally icold 2019 and more than 90 of the global river systems will be impounded by dam reservoirs by 2030 grill et al 2015 in the changjiang river network there are more than 130 large and medium artificial reservoirs capacity 106 m3 in main streams with higher river orders 5th to 8th zhang et al 2022 these dam reservoirs have changed hydrological characteristics such as water depth and retention time which further influences codmn and bod5 removal our results further illustrated that higher udi but lower codmn and bod5 yields were due to cascaded mainstream dam reservoir removal removal efficiency of 44 in the wl basin 4 3 city location influence on point source load this study found that city location influenced point source codmn and bod5 loads at the basin scale the sub basin udi representing the input has a positive correlation with the sub basin point source yield representing the output fig 4c d in the middle and lower reaches of the changjiang river riverine exports from point source yields increased greatly for those sub basins with highly intensified urbanization however there was still inconsistency between the urban point source loading and the river codmn and bod5 yields for other sub basins fig 3 taking the wujiang sub basin at wl as an example its udi value was high but the riverine codmn and bod5 yields were low this can be attributed to riverine cascade reservoir dams influencing hydrological processes riverine retention and yield butman et al 2016 gardner et al 2019 zhang et al 2022 4 4 scenario analysis of urban disturbance on organic matter we predicted future scenario changes in codmn and bod5 concentrations under future urbanization expansion fig 6 table s1 we developed three scenarios according to the urban area expansion speed population growth rate and urban sewage cod treatment rate and assumed the 2018 level as the baseline scenario under udi scenarios 1 and 2 codmn and bod5 concentrations were projected to increase at all nhss with increasing udi values fig 6 in scenario 1 when the three input parameters of udi increased by 15 a ub 15 l rv and 10 p ub the corresponding codmn concentrations were estimated to increase by 4 66 121 86 for the 11 nhss on the entire changjiang river in scenario 2 when the three parameters increased by 40 a ub 40 l rv and 20 p ub the corresponding codmn concentrations were estimated to increase by 12 97 297 99 for the 11 nhss in scenario 3 when the three udi parameters increased in the same proportion as scenario 2 but r sw increased by 5 the corresponding codmn concentrations were estimated to increase by 4 08 208 83 for the 11 nhss which was lower than that in scenario 2 compared with codmn the bod5 increase rate was slightly lower table s1 fig 6 we compared the codmn and bod5 concentration changes with five classes of water quality standards the colored horizontal lines in fig 6 represent different water quality standards fig 6 shows that under scenario 2 the codmn concentration at hk will exceed the class iii water quality standard the codmn concentration at dt will be close to the class iii standard and the codmn concentrations at bb wl clj whg will exceed the class ii standard under scenario 3 codmn concentrations at most stations will be obviously reduced compared to scenario 2 due to the improved cod treatment rate of point source sewage in addition bod5 concentrations will vary little compared to codmn concentrations the three parameters of the udi are available from many public data sources and the udi indicators can be easily quantified for other basins thus it is convenient to apply the udi to other basins 4 5 uncertainty of the underground water discharge underground water discharge might be a possible contribution to organic pollution in the river which has long been overlooked in the study of river and lake hydrological cycles the contribution of groundwater discharge to gulf water and matter flux has been widely studied in recent years but its contribution to inland water and matter flux remains unclear recent investigations have shown that lacustrine groundwater discharge can exert strong effects on the water budget and eutrophic status of lakes dabrowski et al 2020 liao et al 2018 meinikmann et al 2013 rosenberry et al 2015 schmidt et al 2010 sun et al 2022 however whether groundwater discharge exists only locally or exists widely in inland rivers is debatable therefore it is challenging to quantify the organic pollution contribution from underground water discharge in river waters 5 conclusions 1 this study analyzed spatial and monthly patterns in riverine discharge and organic pollution in terms of codmn and bod5 in the changjiang river basin the river codmn and bod5 fields showed significant spatial differences across the entire basin and both codmn and bod5 loads generally increased upstream to downstream 2 we identified the source contribution of riverine codmn and bod5 from both urban point source and non point sources and showed that the urban point source contribution of codmn and bod5 increased from 19 to 79 and from 18 to 76 respectively from the river source area to the river mouth 3 we proposed the udi concept coupled with hydrological characteristics to develop links between riverine codmn and bod5 yields and urban point loads we found that urban point source yields of codmn and bod5 increased as the udi increased and urbanization controlled the point source yield 4 we produced scenario changes in codmn and bod5 concentrations under future urbanization in the changjiang basin and found that the codmn concentrations at hk and dt would approach or exceed the class iii water quality standard under udi scenario 2 overall our study shows how urbanization and riverine discharge determine the organic pollution source and yield in the entire changjiang river network the results are useful for riverine water quality planning and management credit authorship contribution statement fang wang writing original draft investigation methodology peipei zhang investigation methodology weijin yan funding acquisition conceptualization writing original draft methodology project administration investigation mingrui jia investigation methodology xiaokang su investigation methodology jianing wang investigation methodology siyu tian investigation methodology declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was supported by the national natural science foundation of china 42077304 41877483 the data that support the findings of this study are available from the corresponding author upon reasonable request appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129544 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
1990,organic pollution in river systems is a key indicator of river water quality identifying organic pollution sources and quantifying source contributions are important in improving water quality planning and management however basin scale patterns in riverine organic pollution sources and yields to predict water quality remain poorly understood here we propose an urban disturbed index udi coupled with riverine hydrology to quantify the current and potential impacts of urbanization on riverine organic pollution at the basin scale we identified the source contribution from urban point sources and non point sources by using monthly riverine discharge and monthly monitored data in chemical oxygen demand cod and biological oxygen demand bod concentrations from 2016 to 2018 there were significant spatial differences in the river codmn and bod5 fields across the whole basin and the urban point source contribution of codmn and bod5 increased from 19 to 79 and from 18 to 76 respectively from the river source area to the river mouth the urban point source yields of codmn and bod5 increased as the udi increased our study suggests that basin scale udi together with riverine discharge determine the river organic pollution source and yield in the entire changjiang river network our results are useful for riverine water quality planning and management data availability data will be made available on request 1 introduction climate change biodiversity loss and chemical pollution are considered threats to humankind and the global environment but the chemical pollution crisis has not been sufficiently addressed by global and national policies bai et al 2021 brack et al 2022 organic pollution in river systems is a key indicator of river water quality impacting both the safety of drinking water supply and dissolved organic matter dom transfer fuhrmeister et al 2015 tang et al 2019 vigiak et al 2019 vorosmarty et al 2010 wen et al 2017 the dom content consists of a complex mixture of distinct chemical species the two basic measurements of the organic paollution level are the chemical oxygen demand cod mg l 1 and biochemical oxygen demand bod mg l 1 the codcr and bod5 represent two integrated processes of organic pollution organic pollutant loading and microbial degradation the quantity and quality of river cod and bod have the potential to influence the suitability of water quality for human use chen et al 2006 lee et al 2016 as well as the health of the non human components of the ecosystem that depend on the river for example the amount i e concentration and or mass and chemical quality i e composition of cod in surface water has been shown to influence metal binding yamashita and jaffé 2008 production of disinfection byproducts during drinking water treatment beggs et al 2009 freshwater ecosystems malaj et al 2014 and electron transfer reactions i e redox processes ratasuk and nanny 2007 which influence downstream energy transfer miller et al 2006 the organic pollution of rivers originates from urban point sources of wastewater discharge and non point sources of livestock waste sewer overflows wetlands and aquatic creature emissions williams subiza et al 2022 quantifying bod loads into rivers has drawn more attention at both regional and global scales fuhrmeister et al 2015 vigiak et al 2019 voss et al 2012 wen et al 2017 progress in qualitative bod and doc measures can thus effectively complement global and regional modelling efforts based on quantitative bod and doc export data alvarez cobelas et al 2012 lv et al 2019 wen et al 2017 these studies emphasize the effects of climate change on in river bod levels but are less focused on the spatial patterns in source loads of organic pollutants into rivers within river networks such as point and non point sources how bod spatial patterns determine riverine organic pollution remains unclear at the basin scale water safety still faces challenges in terms of water quality deterioration and an increase in water demand both in china and globally under human activities and climate change mainali and chang 2018 mcdonald et al 2011 with increasing urbanization and urban population growth both sources of organic pollution will vary greatly vigiak et al 2020 furthermore compared with bod studies few studies have reported in river cod pollution dubber and gray 2010 it is necessary to integrate cod into organic river pollution particularly in those regions where cod instead of bod is listed as a routine monitoring index of organic river pollution such as in china third when transported through the river network organic matter can be removed by degradation also called self purification and dilution before it is exported to estuaries or coastal seas although some studies have focused on organic degradation and dilution studies on in river organic matter removal by coupling biochemical and hydrological processes at network scales are still rare given the spatially heterogeneous variation the amount of cod loading in rivers and the in river removal processes have not been systematically integrated identifying organic pollution sources and quantifying the source contributions are important for water quality planning and management because of degradation and dilution the impact of organic matter load from each urban point on riverine yield can vary greatly when considering the specific location of cities in the river network in particular the accumulated negative environmental effects of urbanization produce huge disturbances in riverine organic pollution however due to a lack of high frequency spatio temporal observations to gather monitoring data and drivers the variations in riverine cod and bod and its biogeochemical processes under increasing anthropogenic interference and climate change remain poorly understood putro et al 2016 wilson and xenopoulos 2009 china has experienced rapidurbanizationduring the past half century which has resulted in wide disruptions to the environment including regional climates quan et al 2021 ren et al 2008 wang and ge 2012 2015 extreme temperatures xiao et al 2019 vegetation degradation li et al 2015 precipitation and flood intensification ertan and çelik 2021 farid et al 2010 and winter haze zhong et al 2018 in particular rapid urbanizationhas been recognized as the primary cause of deterioratingsurface waterquality ren et al 2014 wang et al 2021b including coastal waters wang et al 2021a however quantifying the effects of urbanization on water quality remains a challenge here we propose an urban disturbed index udi to quantify the current and potential impacts of urbanization on riverine organic pollution on the whole basin scale in china s largest changjiang river basin udi values were calculated using three parameters regarding urban disturbances see methods section we further hypothesized that a shift in the sources of riverine organic pollution could be determined by udi on the whole basin scale using monthly monitored data on cod and bod concentrations from 2016 to 2018 as a riverine organic pollution index we studied seasonal variations in cod and bod yields along the key hydrological stations of the changjiang river the main objectives of the study were i to analyze spatial and monthly patterns in organic pollution trends in terms of cod and bod in the changjiang river ii to identify the source contribution of riverine cod and bod from both urban point emission and non point discharges iii to propose the udi concept and to develop links between riverine cod bod yield and urban point load and iv to predict scenario changes in future urbanization in the changjiang basin 2 materials and methods 2 1 study area and site collection the study was conducted in the changjiang river basin 24 27 35 54 n 90 13 122 19 e the third largest river in the world with an average annual discharge of 10 1011 m3 monthly water discharge and concentrations of cod and bod for three years 2016 2018 were monitored at 11 key national hydrological stations nhss along the changjiang river of which seven nhss were along the main stem of the river from the source area of the river zhimenda zmd nhs to the river mouth datong dt nhs fig 1 and table 1 the other four nhss represent the main tributaries of the river the dt nhs located at the upper limit of the river mouth is free from the influence of both tidal cycles and industrial waste from nearby cities the stretch of the changjiang river above the dt nhs drains 94 of the entire basin and delivers more than 95 of the water to the estuary yan et al 2003 2 2 monthly water discharge and concentrations of codmn and bod5 data at each nhs data on monthly water discharge at 11 key nhss along the changjiang river were compiled from the water resources information center ministry of water resources china changjiang river yearbook 2017 2019 the monthly concentrations of codmn and bod5 were monitored by the china national environmental monitoring centre china national environmental monitoring centre 2017 2019 the monthly concentrations of codmn were measured continuously for three years from january 2016 to december 2018 and the monthly concentrations of bod5 were measured continuously for two years from january 2017 to december 2018 monthly riverine codmn bod5 fluxes were estimated based on the monthly discharge weighted data by multiplying the monthly concentration of codmn bod5 by the monthly river discharge rate 2 3 point source data and socio economic data at prefecture level city scale data of point sources of codmn and bod5 wastewater discharge were compiled from the china statistical yearbooks on environment 2016 2018 chinese national bureau of statistics 2017 2019a which contains annual values but not monthly values annual codmn and bod5 loads into the river from point sources were then calculated based on prefecture level cities within each sub basin in the current study the urban point source of cod was expressed as codcr and the riverine cod monitored was expressed as codmn the conversion ratio of codcr codmn is reported to range from 1 5 to 4 he et al 2016 jing et al 2016 siwiec et al 2018 wu et al 2019 yin et al 2022 zhao et al 2022 and an average ratio of two was used when comparing the point source contribution of cod to riverine cod flux in the current study the urban construction land data used in this study were based on landsat remote sensing images combined with land cover data and interpreted and drawn from the national annual scale long term series data li et al 2018 the spatial resolution of the data was 30 m 30 m and the length of time was 1985 2018 the data of urban population and gross domestic product gdp were compiled from the statistical bulletin of national economic and social development of each city in 2016 2018 chinese national bureau of statistics 2017 2019b 2 4 concept and calculation the key steps to assessing temporal and spatial patterns in riverine organic pollution and the impact of urban disturbance included evaluating urban distribution patterns and the urban disturbance index udi section 2 4 1 quantifying organic pollution source contributions section 2 4 2 and future scenario analysis section 2 4 3 2 4 1 evaluating urban distribution pattern and urban disturbance index udi we considered three factors in constructing the udi a urban density in the basin b length of rivers affected by urban source pollution and c the number of urban populations that may cause organic pollution the udi was calculated using the following formula 1 udi a 100 a ub b 100 l rv c p ub where a ub represents the area of urban construction land per unit area 100 km2 of the sub basin l rv represents the area of urban construction land per unit river length using the ratio of urban construction land area to the length of the river in each sub basin p ub represents the urban population per unit area of the sub basin i e the ratio of the urban population in each sub basin to the sub basin area a coefficient of 100 was used to adjust the different orders of magnitude of the three parameters the magnitudes of a ub and l rv are between 10 2 and 100 and the magnitude of p ub is between 100 and 102 the letters a b and c denote the ratio coefficients associated with each variable and the total ratio sum is 1 i e a b c 1 we ran the calculation with different ratio data the process produced 10 000 bootstrapped samples to obtain the final values of udi with the highest frequency fig s1 thus a udi for each sub basin was constructed furthermore the relationship between udi and organic pollution codmn and bod5 was established using statistical correlation and regression analyses we analyzed how urban organic matter output responded to changes in the udi 2 4 2 quantifying organic pollution source contribution urban point source vs non point source section 2 3 mentioned the annual urban point source data but did not cover monthly urban point source data therefore the monthly riverine organic pollution sources of point and non point could be separated based on the so called emission or transport approach at each of the 11 nhss of the river i e the low flow conditions dry season reflect the dominance of point sources while the high flow conditions flood season reflect the signal of non point emissions putro et al 2016 wilson and xenopoulos 2009 therefore organic pollution loading from non point sources is carried into the river by surface runoff during the flood season and thus the river flux includes both non point sources and urban point sources from industrial wastewater and domestic sewage emissions in the dry season the riverine organic pollution flux includes only point source organic loading in the basin which is strongly related to urbanization in the basin putro et al 2016 wilson and xenopoulos 2009 therefore by analyzing the changes in organic pollution flux in river sections during flood and dry periods the contribution of point and non point sources of organic pollution in river sections can be modeled using the following formulae 2 r np e np e year i 1 12 c i f i c dry f dry i 1 12 c i f i 3 r p e p e year e year e np e year where r np is the proportion of non point source organic pollution in the total organic matter of each nhs r p is the proportion of point source organic pollution e year is the total annual flux of organic matter at each nhs e np is the annual flux of non point source organic pollution and e p is the annual flux of organic pollution from point sources c i is the monthly concentration of organic pollution f i is the monthly discharge i is the month from january to december c dry represents the concentration of organic pollution in the dry season and f dry represents the flux in the dry season the dry and wet seasons were divided based on the monthly discharge changes of the selected 11 nhss using the data of the recent ten year period in addition we compared the results of different periods such as 10 year 20 year or 30 year and there was no significant difference between the dry and wet seasons fig s2 we compared the modeled and monitored data for codmn and bod5 loads from urban point sources across the entire changjiang river network fig s3 overall the modeled values were comparable to the monitored values after considering riverine removal 2 4 3 future scenario analysis we predicted the scenario change in export yield of point source organic pollution under future urbanization three udi scenarios were established table s1 and each input parameter was set by a different percentage relative to the 2018 level when referring to the change in these parameters over the past 20 years 1998 2018 for example the change rate of urban construction land area from 1998 to 2018 was an average of 5 per year maximum of 8 4 per year and the urban population growth rate was an average of 3 5 per year maximum of 5 per year thus we assumed three udi scenarios as follows scenario 1 a ub and l rv increased by 15 p ub increased by 10 3 years of growth and point source cod treatment rate r sw for sewage treatment plant was at current level scenario 2 a ub and l rv increased by 40 p ub increased by 20 7 8 years of growth and r sw was at current level scenario 3 a ub and l rv increased by 40 p ub increased by 20 7 8 years of growth and r sw increased by 5 considering that the current cod treatment rate of sewage has reached 83 3 national average of the cod inflow 3 results 3 1 spatial patterns of river discharge and codmn and bod5 concentrations the annual river discharge 2016 2018 at nhss showed substantial spatial variations with the lowest 1 63 1010 m3 yr 1 at zmd and the highest 9 29 1011 m3 yr 1 at dt in the changjiang river basin fig 2 the lowest discharge at wl of the tributary wu river was 4 87 1010 m3 yr 1 and the highest discharge at clj of the tributary dongting lake was 2 63 1010 m3 yr 1 the monthly average concentration of codmn at the nhss varied greatly in the changjiang river basin fig 2 both the highest concentrations of codmn 2 47 mg l 1 and bod5 1 72 mg l 1 were observed at hk while the lowest concentrations of codmn 1 02 mg l 1 and bod5 0 64 mg l 1 were at zmd and yc respectively 3 2 urban distribution pattern there are approximately 336 prefecture level and county level cities located in the changjiang river basin fig 3 these cities generally locate on the rivers of higher order 5th to 8th strahler river order approach dubber and gray 2010 the three important urban indicators a ub l rv p ub are presented in table 1 significant spatial variation of a ub existed in the whole river basin with values ranging from 0 01 to 1 94 a ub values increased from upstream to downstream along the main stem of the changjiang river in addition the three sub basins hk dt and clj had high values of a ub with the highest value of 1 94 at the hk sub basin the values of l rv varied from 0 02 to 3 27 with the highest value at the hk sub basin p ub also showed great spatial variation with the lowest 1 89 at zmd and the highest 157 45 at clj the change in p ub was the strongest of all three indicators as the population represented by p ub varied greatly among cities we integrated the three indicators to obtain the udi table 1 the udi showed a similar spatial pattern to those of the three indicators the values varied from 1 68 to 215 26 with the highest value at the hk of the poyang lake sub basin 3 3 codmn and bod yields from urban point and non point sources the annual codmn and bod5 yields were estimated by multiplying the monthly concentration and water discharge the annual codmn and bod5 yields demonstrated different patterns from those of discharge and concentration fig 2 codmn and bod5 yields were 1018 73 and 562 99 kg km 2 yr 1 respectively for the whole changjiang river basin the highest yields of codmn and bod5 were 2461 22 and 1494 67 kg km 2 yr 1 respectively at hk representing codmn and bod5 yields from the ganjiang river tributary the lowest yields of codmn and bod5 were 148 04 and 140 41 kg km 2 yr 1 respectively at zmd representing codmn and bod5 yields from the source area of the changjiang river the point source codmn and bod5 yields increased from 27 02 kg km 2 yr 1 to 1930 52 kg km 2 yr 1 and from 23 28 kg km 2 yr 1 to 1070 80 kg km 2 yr 1 respectively from the river source area to the river mouth fig 4 a the urban point source yields of codmn and bod5 at the upper river source area zmd more than 4800 km from the river estuary were the lowest 27 02 and 23 28 kg km 2 yr 1 respectively and these data reached the highest near the river mouth 500 750 km from the river estuary the non point source yields of codmn and bod5 at upper river source area zmd were the lowest 121 01 and 116 90 kg km 2 yr 1 respectively and the non point source yields of codmn reached the highest at clj of the dongting lake sub basin is 816 79 kg km 2 yr 1 the non point source of bod5 yields reached the highest at hk of the ganjiang river tributary at 423 86 kg km 2 yr 1 fig 4b 3 4 urbanization effect on organic river pollution we further evaluated the relationship between the udi and the urban point source yield in the changjiang river fig 4c d the relationship between each indicator and the point source yield of organic pollution codmn and bod5 at the sub basin scale is shown in fig s4 we found that urban point source yields of codmn and bod5 increased as the udi increased codmn r2 0 82 at p 0 01 bod5 r2 0 81 at p 0 01 indicating that urbanization controlled the point source yield we identified the source contribution from both urban point emission and non point discharge the urban point source contribution of codmn increased from 19 to 79 and bod5 from 18 to 76 from the river source area to the river mouth fig 5 in contrast the non point source contribution of codmn decreased from 81 to 21 and bod5 from 82 to 24 this demonstrated that the urban point source had a similar impact on riverine codmn and bod5 fluxes across the whole river basin indicating that source loading was more important than transportation considering that the point source dominated the river yield we suggest that urbanization has a strong effects on riverine codmn and bod5 yields 4 discussion 4 1 dilution and degradation effects two important processes influence the riverine codmn and bod5 yields dilution and degradation effects voss et al 2012 wen et al 2017 wright and mcdonnell 1979 there was a significant dilution effect resulting from increasing water discharge in the changjiang river basin we analyzed the dilution effect on codmn and bod5 transport using the ratio of codmn and bod5 concentrations against river discharge fig s5a b we found that codmn and bod5 concentrations decreased substantially as river discharge increased the dilution effect of the urban point source portion in codmn and bod5 concentrations with riverine water discharge was analyzed fig s5c d this indicated that the point source and total source had a similar dilution effect our results suggest that both urban point source loading and water discharge influence riverine codmn and bod5 concentrations in addition water discharge influences the river hydraulic load such as the retention time in the channel which further influences codmn and bod5 degradation and removal in the channel lv et al 2019 wilson et al 2010 4 2 riverine dam effect on hydrology and codmn and bod5 removal dam reservoirs in watersheds are vital components of large river networks currently there are more than 58 400 large dam reservoirs globally icold 2019 and more than 90 of the global river systems will be impounded by dam reservoirs by 2030 grill et al 2015 in the changjiang river network there are more than 130 large and medium artificial reservoirs capacity 106 m3 in main streams with higher river orders 5th to 8th zhang et al 2022 these dam reservoirs have changed hydrological characteristics such as water depth and retention time which further influences codmn and bod5 removal our results further illustrated that higher udi but lower codmn and bod5 yields were due to cascaded mainstream dam reservoir removal removal efficiency of 44 in the wl basin 4 3 city location influence on point source load this study found that city location influenced point source codmn and bod5 loads at the basin scale the sub basin udi representing the input has a positive correlation with the sub basin point source yield representing the output fig 4c d in the middle and lower reaches of the changjiang river riverine exports from point source yields increased greatly for those sub basins with highly intensified urbanization however there was still inconsistency between the urban point source loading and the river codmn and bod5 yields for other sub basins fig 3 taking the wujiang sub basin at wl as an example its udi value was high but the riverine codmn and bod5 yields were low this can be attributed to riverine cascade reservoir dams influencing hydrological processes riverine retention and yield butman et al 2016 gardner et al 2019 zhang et al 2022 4 4 scenario analysis of urban disturbance on organic matter we predicted future scenario changes in codmn and bod5 concentrations under future urbanization expansion fig 6 table s1 we developed three scenarios according to the urban area expansion speed population growth rate and urban sewage cod treatment rate and assumed the 2018 level as the baseline scenario under udi scenarios 1 and 2 codmn and bod5 concentrations were projected to increase at all nhss with increasing udi values fig 6 in scenario 1 when the three input parameters of udi increased by 15 a ub 15 l rv and 10 p ub the corresponding codmn concentrations were estimated to increase by 4 66 121 86 for the 11 nhss on the entire changjiang river in scenario 2 when the three parameters increased by 40 a ub 40 l rv and 20 p ub the corresponding codmn concentrations were estimated to increase by 12 97 297 99 for the 11 nhss in scenario 3 when the three udi parameters increased in the same proportion as scenario 2 but r sw increased by 5 the corresponding codmn concentrations were estimated to increase by 4 08 208 83 for the 11 nhss which was lower than that in scenario 2 compared with codmn the bod5 increase rate was slightly lower table s1 fig 6 we compared the codmn and bod5 concentration changes with five classes of water quality standards the colored horizontal lines in fig 6 represent different water quality standards fig 6 shows that under scenario 2 the codmn concentration at hk will exceed the class iii water quality standard the codmn concentration at dt will be close to the class iii standard and the codmn concentrations at bb wl clj whg will exceed the class ii standard under scenario 3 codmn concentrations at most stations will be obviously reduced compared to scenario 2 due to the improved cod treatment rate of point source sewage in addition bod5 concentrations will vary little compared to codmn concentrations the three parameters of the udi are available from many public data sources and the udi indicators can be easily quantified for other basins thus it is convenient to apply the udi to other basins 4 5 uncertainty of the underground water discharge underground water discharge might be a possible contribution to organic pollution in the river which has long been overlooked in the study of river and lake hydrological cycles the contribution of groundwater discharge to gulf water and matter flux has been widely studied in recent years but its contribution to inland water and matter flux remains unclear recent investigations have shown that lacustrine groundwater discharge can exert strong effects on the water budget and eutrophic status of lakes dabrowski et al 2020 liao et al 2018 meinikmann et al 2013 rosenberry et al 2015 schmidt et al 2010 sun et al 2022 however whether groundwater discharge exists only locally or exists widely in inland rivers is debatable therefore it is challenging to quantify the organic pollution contribution from underground water discharge in river waters 5 conclusions 1 this study analyzed spatial and monthly patterns in riverine discharge and organic pollution in terms of codmn and bod5 in the changjiang river basin the river codmn and bod5 fields showed significant spatial differences across the entire basin and both codmn and bod5 loads generally increased upstream to downstream 2 we identified the source contribution of riverine codmn and bod5 from both urban point source and non point sources and showed that the urban point source contribution of codmn and bod5 increased from 19 to 79 and from 18 to 76 respectively from the river source area to the river mouth 3 we proposed the udi concept coupled with hydrological characteristics to develop links between riverine codmn and bod5 yields and urban point loads we found that urban point source yields of codmn and bod5 increased as the udi increased and urbanization controlled the point source yield 4 we produced scenario changes in codmn and bod5 concentrations under future urbanization in the changjiang basin and found that the codmn concentrations at hk and dt would approach or exceed the class iii water quality standard under udi scenario 2 overall our study shows how urbanization and riverine discharge determine the organic pollution source and yield in the entire changjiang river network the results are useful for riverine water quality planning and management credit authorship contribution statement fang wang writing original draft investigation methodology peipei zhang investigation methodology weijin yan funding acquisition conceptualization writing original draft methodology project administration investigation mingrui jia investigation methodology xiaokang su investigation methodology jianing wang investigation methodology siyu tian investigation methodology declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was supported by the national natural science foundation of china 42077304 41877483 the data that support the findings of this study are available from the corresponding author upon reasonable request appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129544 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
1991,stochastic conditional geomodelling requires effective integration of geological patterns and various types of data which is crucial but challenging to address this we propose a deep learning framework gansim surrogate for conditioning geomodels to static well facies data facies probability maps and non spatial global features as well as dynamic time dependent pressure or flow rate data observed at wells the framework consists of a convolutional neural network cnn generator trained from gansim a generative adversarial network based geomodelling simulation approach a cnn based surrogate and options for searching appropriate input latent vectors for the generator the four search methods investigated are markov chain monte carlo iterative ensemble smoother gradient descent and gradual deformation the framework is validated with channelized reservoirs first a generator is trained using gansim to generate geological facies models in addition a flow simulation surrogate is trained using a physics informed approach then given well facies data facies probability maps global facies proportions and dynamic bottomhole pressure data bhp the trained generator takes the first three static conditioning data and a latent vector as inputs and produces a random realistic facies model conditioned to the three static data to condition to the dynamic data the produced facies model is converted to permeability property and mapped to bhp data by the trained surrogate finally the mismatch between the surrogate produced and the observed bhp data is minimized to obtain appropriate input latent vectors which are further mapped into appropriate facies models through the generator these facies models prove to be realistic and consistent with all of the conditioning data and the framework is computationally efficient keywords gansim stochastic geomodelling uncertainty quantification surrogate generative adversarial networks gans convolutional neural networks cnns physics informed neural networks pinns data availability data will be made available on request 1 introduction geomodelling i e characterizing spatial distribution of subsurface reservoirs is of great significance for the exploitation of underground water and hydrocarbon resources and the geological storage of co2 e g pawar et al 2016 however the perpetual issue of insufficient data and knowledge about the subsurface leads to great uncertainty in geomodelling which is further transmitted into reserve evaluation well production prediction determination of new well locations and other decision making processes due to the high dimensionality of geomodelling such uncertainty cannot be explicitly characterized and is generally represented by multiple stochastic geomodel realizations as samples of the uncertainty space to decrease the uncertainty as many types of information as possible about the subsurface reservoir should be integrated into the geomodelling process see e g caers 2011 various types of information commonly include spatial geological structures or patterns global features e g facies proportion well facies data i e facies type at well locations geophysical data and temporal dynamic data observed at wells e g daily measurements of bottomhole pressure these types of information are presented in different forms and relate to reservoirs through different ways 1 high resolution well facies data are direct representation of reservoirs yet very sparse in geological space 2 geophysical data covers the complete three dimensional geo space of subsurface reservoirs but is subject to limited resolution fidelity and complicated relationship with reservoir properties e g porosity it relates to reservoir properties through a rock physics model linking reservoir properties with rock properties e g acoustic velocity and a partial differential equations pdes dominated process taking rock properties into geophysical data bosch et al 2010 3 as a type of spatiotemporal data dynamic data relates to reservoir properties also through a pdes dominated process that governs fluid flow 4 geological patterns describe the shapes and contact relations of different reservoir facies types there is no mathematical expression of complete geological patterns although the 3 d variogram function as a relaxed 2 point statistics approximation object based methods spatial markov random fields process mimicking algorithms and training images implicitly capturing multiple point spatial statistics are used to partially represent it in many cases deutsch 2002 mariethoz and caers 2014 5 global features as scalars describe the non spatial global geometrical or quantitative features of reservoirs such as the facies proportion channel width channel sinuosity etc traditionally geostatistical approaches are used to integrate partial geological patterns and well facies data to simulate multiple stochastic reservoir realizations e g variogram based or multiple point statistics mps based methods deutsch 2002 mariethoz and caers 2014 to further condition to measured temporal dynamic flow data observed at wells the above simulation process is perturbed to search for appropriate reservoir realizations these realizations are not only conditioned to the given well facies data and partial geological patterns but also are consistent with the measured dynamic data through a simulator which is capable of flow simulation see e g caers 2003a such a process centered on historical dynamic data is also called history matching in recent decades various aspects of history matching have been explored including perturbation methods of the sequential simulation process caers 2003a 2003b hu et al 2001 development of surrogate based simulators e g the polynomial chaos expansion surrogate proposed by li and zhang 2009 and search methods for appropriate realizations e g gradual deformation caers 2003a hu 2000 probability perturbation methods caers and hoffman 2006 hu 2008 probability conditioning methods jafarpour and khodabakhshi 2011 ensemble based methods chang et al 2017 chen and oliver 2013 and markov chain monte carlo mcmc based methods efendiev et al 2015 liao et al 2019 ma et al 2008 two approaches have been used to condition reservoir simulations to geophysical data joint inversion and sequential inversion the joint inversion process is very similar to history matching except a rock physics model is inserted to transform simulated reservoir realizations into physical properties which are then used to forward simulate geophysical data in sequential inversion probability maps of different reservoir facies types are first obtained using for example statistical rock physics and quantitative interpretation workflows e g avseth et al 2005 then these probability maps are taken as soft constraining data in geostatistical simulation approaches to produce reservoir realizations bosch et al 2010 gives a review of both workflows through all the above processes the produced reservoir realizations can honor the given global features well facies data dynamic data geophysical data and expected geological patterns to some extent however the variograms or multiple points statistics of a training image can only partially represent the complicated geological patterns thus there is a lack of realism in the simulated reservoir realizations to different extents e g discontinuous channels produced by mps based methods additionally traditional simulators applied in history matching and geophysical inversion processes are relatively slow compared to the requirement of a large number of simulator iterations in the two processes making it computationally expensive to achieve conditioning of the produced reservoir realizations to the given geophysical and dynamic data in practice generative adversarial networks gans goodfellow et al 2014 in deep learning can capture complicated spatial patterns of 2d images or 3d objects using a generator composed of convolutional neural networks cnns with the captured pattern knowledge the generator can produce realistic images or 3d objects from low dimensional latent vectors wu et al 2016 researchers combined gans with geomodelling on different aspects chan and elsheikh 2019 chen et al 2022 laloy et al 2018 mosser et al 2020 nesvold and mukerji 2021 song et al 2021a 2021b 2022a 2022b sun et al 2023 yang et al 2022 zhang et al 2019 chan and elsheikh 2017 dupont et al 2018 for unconditional geomodelling the generator of gans is first trained to learn geological patterns from a training set of many conceptual facies models then with the learned geological patterns the generator can quickly map random latent vectors into multiple realistic reservoir realizations see e g song et al 2021a to achieve conditioning appropriate latent vectors are searched so that they can be mapped by the trained generator into realizations that are consistent with the given conditioning data laloy et al 2018 2019 mosser et al 2020 nesvold and mukerji 2021 zhang et al 2019 this process is similar to history matching and geophysical inversion except the original geostatistical simulation process of facies models is replaced by the trained generator various latent vector search approaches e g gradient descent gradual deformation ensemble methods and mcmc methods can be used here recently song et al 2021b 2022a proposed a new gans based workflow for direct conditional geomodelling called gansim where the trained generator takes the given global feature values well facies data geophysics interpreted facies probability maps and random latent vectors as inputs and directly produces various realistic reservoir realizations consistent with all of the input conditioning data there is no need for an expensive latent vector search process in gansim song et al 2022b applied gansim for stochastic geomodelling of 3d karst cave field reservoirs conditioned to well facies data and 3d facies probability cubes interpreted from seismic data with excellent performance however gansim cannot achieve direct conditioning to the original geophysical data and dynamic data in which case the latent vector search process may still be needed to be combined however compared to using the trained unconditional generator i e generator only taking a latent vector as input for the latent vector search process here with the trained conditional generator of gansim the computational resources and time required by the search process should be largely reduced because the appropriate latent vectors only need to be consistent with the geophysical or dynamic data instead of all the given conditioning data types forward simulators are required in all forms of history matching and geophysical inversion processes including the aforementioned ones involving trained generators caers 2003a grana et al 2022 laloy et al 2018 to improve the running speed of simulators cnn based surrogates i e approximate mathematical model of simulators are largely studied using either data driven tang et al 2021 or physics informed e g wang et al 2021 xu et al 2022 approaches the data driven approach enables the learning of pde dominated relationships between geophysical dynamic data and rock reservoir properties from training input output labelled data pairs while the physics informed approach i e physics informed neural networks pinns karniadakis et al 2021 enforces cnns to directly learn knowledge from pdes indeed the cnn based surrogate is relatively easy to train with data driven method but the trained surrogate may violate physics locally in contrast physics informed training is slow and may involve problems like tunning of weight hyperparameters but ensures consistency with physics constraints and does not require a great many of input output labelled data pairs for training wang et al 2021 proves largely improved accuracy of physics informed approach compared to purely data driven approach and reduced running time of the cnn based flow surrogate compared to a traditional finite difference based simulator modflow mo et al 2020 proposed to combine variational auto encoder another type of generative model comparable to gans a cnn based surrogate and iterative ensemble smoother for geomodelling conditioned to dynamic flow data but the well facies data global features and probability maps are not honored additionally conditioning to these types of data may be achieved by a more elaborate latent vector search process but takes longer time in this paper we propose the gansim surrogate framework by combining gansim and cnn based surrogate together to quickly produce stochastic reservoir realizations that are consistent with expected geological patterns as well as the given global features well facies data geophysical data or its interpreted facies probability maps and dynamic flow data with this framework the uncertainty of the generated reservoir realizations would be significantly reduced while the speed of geomodelling would be largely increased section 2 introduces the general gansim surrogate framework then to showcase the procedures of this framework and validate its effectiveness we apply this framework for stochastic geomodelling of channel reservoirs in section 3 we concretize the framework by constructing a generator and a surrogate specifically for channel reservoirs in section 4 the concretized gansim surrogate framework is used for stochastic geomodelling of channel reservoirs in two test cases conditioned to given facies proportion value as a type of global feature well facies data geophysics interpreted probability map and dynamic data finally sections 5 and 6 give discussions and conclusions of this study respectively 2 gansim surrogate framework in this section first we present the general workflow of gansim surrogate framework and then three important components of this workflow are described 2 1 general gansim surrogate workflow the proposed gansim surrogate framework is illustrated as in fig 1 for a specific class of reservoir the first step of the framework is to train a cnn based generator using the standard gansim approach described in section 2 2 briefly and appendix a in detail and a cnn based surrogate using either the data driven or the physics informed approach described in sections 2 2 and 3 2 for this reservoir class the trained generator can then take well facies data global features facies probability maps and a latent vector as inputs and produce a random reservoir facies model that is consistent with the three types of input conditioning data as well as the expected geological patterns of the reservoir class of interest as a substitution of the forward simulator involved in history matching or geophysical inversion the trained surrogate can map reservoir properties e g permeability distribution into dynamic data in history matching process or map rock properties e g acoustic velocity into geophysical data in geophysical inversion process for a new reservoir given its well facies global feature values facies probability maps original geophysical data and dynamic data as conditioning data first the trained generator takes the first three conditioning data and random latent vectors as inputs and produces multiple realistic and conditional facies model realizations second these realizations are transformed into reservoir property distributions with geostatistical approaches in history matching or rock property distributions with rock physics models in geophysical inversion next the trained surrogate takes the transformed reservoir rock property distributions and other related parameters e g initial and boundary conditions seismic wavelet as inputs and produces dynamic geophysical data then the mismatch between the produced dynamic geophysical data and the field measured one is minimized by perturbing and searching for appropriate latent vectors four latent vector search approaches are investigated here viz mcmc iterative ensemble smoother ies gradient descent and gradual deformation appendix b gives a brief description of these search approaches used in this paper finally the pretrained generator takes as inputs these appropriate latent vectors as well as the given well facies data global features and probability maps and produces different facies model realizations that are consistent with the expected geological patterns the three types of input conditioning data as well as the field measured dynamic or geophysical data once the generator and the surrogate are trained this workflow is computationally very fast for stochastic geomodelling note that the three types of input conditioning data are not necessarily all needed as inputs of the generator 2 2 components of gansim surrogate framework 1 gansim based on gans gansim song et al 2021b 2022a aims at training a cnn based generator which takes as inputs various types of conditioning data as well as a latent vector and produces facies model realizations that are consistent with the expected geological patterns and the input conditioning data different input latent vectors generate different facies realizations compared to the conventional gans based unconditional geomodelling workflow e g song et al 2021a in gansim the architecture of the generator is improved to take different types of conditioning data as inputs and an additional type of loss function called condition based loss is introduced to enforce the generator to learn the relationship between the input conditioning data and the output facies model in addition a progressive training approach karras et al 2017 is used in gansim where the generator is trained progressively from shallow coarse resolution to deep fine resolution layers after training with fixed input conditioning data and varying input latent vectors the generator can produce diverse realistic facies model realizations all conditioned to the input conditioning data appendix a presents more details about gansim including the generator architecture the condition based loss function and the progressive training process 2 cnn based surrogate construction in recent years different cnn configurations for surrogate models for porous media flow have been researched depending on specific requirements e g decoder encoder wang et al 2021 u net and convlstm where u net and lstm are combined tang et al 2021 in addition researchers also used cycle gans zhu et al 2017 to construct cnn based surrogate sun 2018 when training the surrogate with a purely data driven supervised approach a large number of input output labelled data pairs are required as the training data the loss function of this approach can be formulated as 1 l data e m c d p m c d d i s t s u r m c d where m c d represents a combination of reservoir rock property distributions m simulation related parameters c and the corresponding dynamic geophysical data d p m c d is the joint distribution of m c d dist refers to a certain form of distance and sur is the cnn based surrogate that takes as inputs the rock property distributions and simulation related parameters and outputs the corresponding dynamic geophysical data thus m c d constitutes one input output data pair for the surrogate sur by minimizing l data the surrogate is trained to learn the mapping from reservoir rock properties into dynamic geophysical data as stored inside the training data pairs however with a physics informed approach raissi et al 2019 the surrogate is trained to directly learn the physical knowledge expressed by the governing pdes its loss function minimizes the residual of the governing pdes and can be expressed as 2 l physics e m c p m c p d e s s u r m c m c p where p represents the l p norm in this equation we take reservoir rock property distributions m related parameters c and the dynamic geophysical data produced from the surrogate s u r m c all as inputs into the governing pdes of which the right hand side is zero in the above equation pdes symbolizes the residuals of the governing pdes by minimizing l physics the surrogate is forced to be consistent with the given pdes 3 latent vector search approaches among the four latent vector search algorithms explored in this work i e mcmc ies gradient descent and gradual deformation the former two methods try to sample a bayesian inferenced posterior probability distribution while the latter two directly minimize the mismatch between the surrogate produced and the measured dynamic geophysical data so as to search for the optimum input latent vector each time for the two minimization methods multiple runs with different starting points are needed to obtain different appropriate latent vectors and different conditional facies models to approximate the uncertainty of subsurface reservoirs appendix b briefly describes the steps of the four search approaches in the context of gansim surrogate framework 3 gansim surrogate framework setup for channel reservoirs to demonstrate how gansim surrogate framework works and validate its effectiveness we use it for stochastic geomodelling of a common category of reservoir channelized reservoir in 2d here only the conditioning of dynamic flow data is considered for illustration although the workflow can potentially integrate conditioning of geophysical data as well three types of sedimentary facies are considered in the reservoir channel center sand channel bank sand and inter channel mud the former two facies types are lumped together as channel complex one or multiple channel complexes may exist in one reservoir facies model having similar features such as orientation sinuosity and width this study only considers channels within 25 degrees deviation from the north south direction fig 2 shows several conceptual facies model examples obtained by object based simulation to illustrate the sedimentary facies types and the geological patterns of this reservoir class each facies model has an area of 3200 m 3200 m and is equally divided into 64 64 cells according to the gansim surrogate framework in this section we mainly focus on training a cnn based generator producing channel reservoir facies models and a cnn based surrogate mapping reservoir property distributions into dynamic data then in section 4 the prepared gansim surrogate framework including the trained generator and the trained surrogate is used for stochastic conditional geomodelling we simulate single phase water flow from north to south through the channel reservoir facies model the daily bottomhole pressure values bhp of different wells are regarded as the dynamic data the surrogate uses permeability maps converted from facies models as inputs to predict the pressure distribution maps within the domain at different time steps and finally the bhp data at different wells are obtained by sampling these pressure maps at well locations following section 3 1 and section 3 2 describe how the generator and the surrogate are constructed respectively 3 1 construction of the generator song et al 2022a used the gansim approach to train a generator for 2d channel reservoirs the architecture of the generator is shown in fig a1 in appendix a the inputs include a probability map of channel complex two indicator maps of well facies data one for well locations and the other for facies types at well locations see song et al 2021b for detail the facies proportion of channel complex or mud facies type as a type of global feature and a latent vector consisting of 128 elements each following a standard gaussian distribution the training data include 35 640 conceptual facies models resulting from object based geomodelling and the corresponding probability maps well facies data and facies proportion values these conceptual facies models have the same size resolution sedimentary facies types and geological patterns as in fig 2 except that the channels are along all directions after training given a random group of probability map well facies data and facies proportion value the generator can map them into multiple reservoir realizations which are consistent with the geological patterns of channel reservoirs and the input conditioning data in this study we use the same architecture as in song et al 2022a among the 35 640 conceptual channel reservoir facies models of that study 11 880 facies models have channel directions ranging within 25 degrees deviating from the north direction and are used here the reason to limit the channel direction is to alleviate the training burden of the surrogate constructed in the next section we use 11 000 facies models and the corresponding probability maps well facies data and channel complex proportions as the training dataset another 440 as the development dataset for hyperparameter tunning and the remaining 440 as the test dataset for evaluation of the results other settings are the same as in song et al 2022a including the architecture of the discriminator training schedule weights for different losses etc we train the generator for 10 h with 4 gpus nvidia tesla v100 pcie 32 gb 20 cpus and 160g ram in parallel after training the trained generator can map a random group of channel complex proportion value well facies data and probability map as well as a random latent vector into a conditional reservoir facies model realization by changing the input latent vector various conditional realizations can be produced in fig 3 a we randomly choose 5 facies models from the test dataset and take their corresponding probability maps well facies data and channel complex proportions into the trained generator to produce various facies model realizations the channel complexes of these realizations are around the north direction and their geological patterns are similar to that of the training facies models see fig 2 the input probability maps have a marked conditioning effect on these realizations fig 3 b shows the produced facies models as we gradually decrease increase the input channel complex proportion value by 10 and 20 with other inputs fixed indicating the influence of the input channel complex proportion on the output facies model in addition the reproduction accuracy of the input well facies data are 100 the average running time for the trained generator to produce one facies model realization is about 0 0005 s from these brief evaluations we can see that the trained generator can take the given probability map well facies data and channel complex proportion quickly into multiple realistic and conditional facies model realizations and thus can be used for the gansim surrogate framework in the next step more complete evaluation metrics are presented in song et al 2021b 2022a 3 2 construction of the flow surrogate the surrogate aims to predict the pressure distribution map at a time step given a channel reservoir permeability map the boundary and initial pressure values and the time step each permeability map is converted from a channel reservoir facies model by specifying a constant permeability value for each facies type the permeability of channel center facies is specified as a value randomly sampled from 1000 md to 4000 md the permeability of channel bank facies is calculated by multiplying the permeability of channel center of the same permeability map with a coefficient randomly sampled from 0 6 to 0 85 and the permeability of inter channel mud is specified as a value randomly sampled from 5 md to 40 md different facies models correspond to different specifications of permeability values for the flow boundary conditions we set the east and the west boundaries of the reservoir domain as closed boundaries the south boundary pressure is set at a constant value randomly sampled from 270 bar to 330 bar and the north boundary pressure at a constant value is 2 bar to 30 bar greater than the pressure at the south boundary the initial pressure within the domain equals the south boundary pressure the time step ranges from 1 day to 10 days with an interval of 1 day the reservoir is fully saturated with brine having a viscosity of 2 c p and a density of 1038 k g m 3 the compression coefficient of the reservoir including the water inside is 1 8 10 5 bar 1 the water flows from north to south and the surrogate can produce subsurface pressure maps from 1 day to 10 days the dynamic bhp data at different wells can be obtained by sampling these produced pressure maps at well locations 3 2 1 cnn architecture the architecture of the surrogate is shown in fig 4 the inputs include a permeability map a boundary pressure map of which the northernmost and the southernmost rows are respectively repeated by the north and the south boundary pressure values and other cells are set to 0 an initial pressure map with the initial pressure value and a time step map filled with the time step value the output is a pressure map each input or output map of the surrogate has 64 64 cells inside the surrogate is a u net cnn configuration the four types of input maps are first concatenated and convolved to form a feature cube of 64 64 32 then that feature cube goes through five combined operations of downsampling and convolution to form a feature cube of 2 2 1024 containing the most abstract information of the inputs each downsampling operation uses an averaging method to halve the height and width of its corresponding feature cube next this 2 2 1024 feature cube sequentially goes through five combined operations of upsampling concatenation and convolution to produce a feature cube of 64 64 32 the upsampling operations dilate the heights and widths of feature cubes by a factor of 2 using the nearest neighbor upsampling method each concatenation operation combines the newly upsampled feature cube e g 8 8 512 feature cube after upsamling of the 4 4 512 feature cube with the feature cube of the same height and width produced by previous combined operations of downsampling and convolution e g 8 8 256 feature cube finally the 64 64 32 feature cube is converted into a pressure map of 64 64 1 as the output using a convolution operation all convolutions have a kernel size of 3 3 except the last one for which the kernel size is 1 1 the stride length for these convolutions is 1 1 we use the leaky rectified linear unit function lrelu with a leaky value of 0 2 as the activation function after all convolutional layers except the last one where no activation function is applied instead of the pure encoder decoder configuration i e u net without skip connections used by wang et al 2021 to predict the pressure map we chose to use the u net configuration since the encoder decoder configuration gave poor results for the channelized reservoirs with strong permeability heterogeneity 3 2 2 loss here the surrogate is trained using a physics informed approach in many studies centered on physics informed approach a small number of input output or input label data pairs are also used as the training data in a semi supervised approach to alleviate the training burden karniadakis et al 2021 in this study we only use the pde dominated physical law to train the surrogate and no input output labelled data pair is used the governing equation of single phase fluid flow in a porous reservoir media is 3 a k x y p x y t x x k x y p x y t y y μ c p x y t t where x and y are coordinates along east west and north south directions m t refers to the time step in unit of days p x y t is the pressure in bars k x y is the permeability in md μ is the viscosity of the fluid in cp c is the compression coefficient of the rock and the fluid inside in bar 1 and a is a unit conversion factor 0 00852702 appropriate for these mixed units we use f k p n p s p i t φ to denote the output pressure map of the surrogate at t day where k is the input permeability map p n p s and p i denotes the north boundary the south boundary and the initial pressure value and φ are the trainable parameters of the surrogate note that the input permeability map and the output pressure map of the surrogate each consists of 64 64 cells we substitute the pressure term p x y t in equation 3 with f k p n p s p i t φ as a map and use the finite difference method to discretize that equation as in wang et al 2021 the residual for each cell except the northernmost and southernmost rows at each time step is constructed as 4 r k p n p s p i φ i j t a k i 1 i 2 j f k p n p s p i t φ i 1 j f k p n p s p i t φ i j k i i 1 2 j f k p n p s p i t φ i j f k p n p s p i t φ i 1 j δ x 2 k i j 1 j 2 f k p n p s p i t φ i j 1 f k p n p s p i t φ i j k i j j 1 2 f k p n p s p i t φ i j f k p n p s p i t φ i j 1 δ y 2 μ c f k p n p s p i t φ i j f k p n p s p i t δ t φ i j δ t in this equation i and j are indexes of cells along eastward and northward directions 1 i 64 2 j 63 1 t 10 δ x and δ y are the length of each cell along the two directions δ x δ y 50 m δ t is the interval of the time step i e δ t 1 day k i 1 i 2 j denotes the harmonic mean of permeability values at cell i j and cell i 1 j 5 k i 1 i 2 j 2 k i j k i 1 j k i j k i 1 j the viscosity μ and the compression coefficient c are 2 cp and 1 8 10 5 bar 1 respectively in equation 4 the given boundary pressure values are directly used i e f i j 1 t p s f i j 64 t p n since the east and west boundaries are closed boundaries we set f i 0 j t f i 1 j t and f i 65 j t f i 64 j t in equation 4 the initial pressure value is also directly used in the equation i e f i j t 0 p i for each input data group k p n p s p i of the surrogate we expect the residual term for each cell except the northernmost and southernmost rows to be as close to 0 as possible after training thus a physics informed loss function for each input data group k p n p s p i is formulated as 6 l k p n p s p i 1 64 62 10 1 i 64 2 j 63 1 t 10 r k p n p s p i φ i j t 2 given many such input data groups as the training data the final loss function is 7 l e k p n p s p i p k p n p s p i l k p n p s p i where p k p n p s p i refers to the distribution of training input data groups 3 2 3 training based on the 11 000 training 440 development and 440 test facies models used when constructing the generator we build 11 000 training 440 development and 440 test input data groups for the surrogate in each group the permeability map is transformed from a facies model using the rules described in the paragraph before section 3 2 1 and the boundary and initial pressure values are randomly sampled also according to the rules described in that paragraph we use 4 gpus nvidia tesla v100 pcie 32gb 20 cpus and 160g ram to train the surrogate in parallel the minibatch gradient descent and the adam optimizer with default parameters kingma and ba 2014 are used each minibatch includes 32 training input data groups the training is stopped after 24 h the loss function equation 7 does not inform any constraint on the northernmost and the southernmost rows of the domain where the pressure boundary conditions are specified thus the two rows of each output pressure map of the surrogate are assigned with the input north and south boundary pressure values 3 2 4 evaluation we sample two input data groups each including a permeability map and boundary and initial pressure values from the test dataset in the first input data group the permeability values of the channel center channel bank and inter channel mud facies are 2554 md 1632 md and 16 md respectively fig 5 and the north boundary south boundary and initial pressure values are 320 6 bar 296 6 bar and 296 6 bar respectively in the second input data group the permeability values for the channel center channel bank and inter channel mud are 1422 md 1117 md and 29 md respectively fig 6 and the north boundary south boundary and initial pressure values are 319 6 bar 297 1 bar and 297 1 bar respectively we formalize the boundary and initial pressure values and a time step varying from 1 to 10 days into 2d maps as shown in fig 4 these maps as well as the permeability map are then taken as inputs into the trained surrogate to predict pressure maps after 1 to 10 days of water flow from the north to south we also use eclipse a commercial software based on finite volume pde solutions to compute the pressure maps for the two input data groups fig 5 and fig 6 show the comparisons of the pressure maps produced by the trained surrogate and eclipse after various days for the two cases the absolute relative error of the surrogate predicted results with eclipse results as the references are also shown in the two figures in the form of both maps and average values from fig 5 and fig 6 we can see that the surrogate predicted pressure maps are very similar to the eclipse calculated references in both spatial patterns and numerical magnitude the relative error is also quite small fig 7 cross plots and compares the surrogate predicted and the eclipse calculated values at 1000 points randomly sampled from the pressure maps of 1 to 10 days for the two input data groups the least square fit lines red lines of these points are very close to the one is to one lines black lines further proving the closeness between the surrogate predicted values and the eclipse calculated references in addition we randomly sample 100 input data groups from the test dataset and compare the surrogate predicted pressure maps of 1 to 10 days with the eclipse calculated references fig 8 shows the histogram of the average absolute relative error for the 100 cases we can see that the average relative error mainly ranges from 0 03 to 0 5 with a mean of 0 19 as we can see in fig 5 fig 6 fig 7 and fig 8 the accuracy of the surrogate predictions is rather high especially given the strong heterogeneity of channel reservoirs the surrogate takes only 0 005 s to produce 10 pressure maps of 10 days for one permeability map using 1 gpu while eclipse uses 2 6 s to simulate the same number of pressure maps using a 14 cores based computer the speed of the trained generator and the trained surrogate is of great significance for the success of the search of appropriate latent vectors 4 geomodelling of channel reservoirs with prepared gansim surrogate framework in this section first we randomly select two test channel reservoir facies models as the ground truth and obtain the four types of conditioning data i e well facies data channel complex proportion values probability maps of channel complex and bhp of different wells from the two ground truth facies models then we use the prepared gansim surrogate framework including the generator and the surrogate trained in section 3 and the four latent vector search approaches to produce multiple posterior facies model realizations conditioned to the above four types of conditioning data for the two test cases finally the posterior realizations are evaluated and the four latent vector search approaches are compared 4 1 conditioning data 1 test case 1 as shown in fig 9 the ground truth facies model includes several channel complexes around the north direction we use gaussian kernel smoothing approach with kernel size of 39 39 cells to obtain the probability map of channel complex to mimic the interpretation of field geophysical data fig 9 b nine wells are assumed to be equally distributed in the domain and the well facies data is obtained by sampling the facies type from the ground truth facies model at the nine well locations fig 9 d in field cases the channel complex proportion may be obtained by comprehensive analyses of well data geophysical data and geological analogy here we directly calculate that proportion from the ground truth facies model 41 2 and use it as another type of conditioning data the permeability map of the domain is obtained by setting the permeability values of the channel center channel bank and inter channel mud facies as 2134 md 1465 md and 20 md respectively the constant north and south boundary pressure values of the domain are set as 308 9 bar and 293 9 bar respectively the initial pressure value of the whole domain equals to the south boundary pressure value based on the permeability map we use eclipse to simulate the pressure maps of the domain for 1 to 10 days from which the real bhp data of the nine wells are sampled considering a field observation error of the field bhp data following a gaussian distribution with the mean of 0 and standard deviation of 0 1 i e e n 0 0 1 the observed bhp data are obtained as in fig 9 e 2 test case 2 the selected ground truth facies model of test case 2 is shown in fig 10 a following the same procedures as in test case 1 the probability map of channel complex and the well facies data of nine equally spaced wells are obtained from the ground truth facies model i e b and d of fig 10 the channel complex proportion of the ground truth 35 5 is used as another type of conditioning data the permeability values of the channel center channel bank and inter channel mud facies are set as 2309 md 1405 md and 35 md respectively in this case the north boundary the south boundary and the initial pressure value of the domain are set as 301 5 bar 285 7 bar and 285 7 bar respectively with the same method as in test case 1 the observed bhp data of the nine wells are obtained as in fig 10 e 4 2 conditional geomodelling given the conditioning data of the two test cases we follow the procedures of gansim surrogate framework fig 1 and apply the four latent vector search approaches i e mcmc ies gradient descent and gradual deformation to find appropriate latent vectors which can then be mapped into conditional facies models in this process each facies model produced by the generator is converted into a permeability map by assigning a constant permeability value into each facies type we assume the permeability values for each facies to be known and hence for test case 1 we assign 2134 md 1465 md and 20 md into the channel center channel bank and inter channel mud facies respectively while for test case 2 we assign 2309 md 1405 md and 35 md into the three facies types basic steps of the four latent vector search approaches are described in appendix b and are followed here 4 2 1 mcmc the 128 elements of each latent vector are independent and follow a standard gaussian distribution as described in appendix b 1 when proposing a new latent vector candidate z 1 each of its element z 1 m m 1 2 128 is sampled from a proposal gaussian distribution centered at the element of the same order of the current latent vector z 0 i e z 1 m n z 0 m 0 06 each bhp data has 90 elements i e ten daily bhp values for each well multiplied by nine wells given a random latent vector z the likelihood of each bhp element bhp s s 1 2 90 is assumed to follow a gaussian distribution bhp s z n g z s 0 1 where g is the combined forward process of the pretrained generator the pretrained surrogate and the sampling of the corresponding pressure maps for bhp data at the nine well locations five markov chains each starting from a different initial latent vector and including 20 000 inner loops are performed for the two test cases respectively each taking 1258 s for each markov chain some initial latent vector samples during the burn in period may not follow the posterior probability distribution and are excluded thus for each sampled latent vector we first use the trained generator and the trained surrogate to produce its bhp data bhp sur then we calculate the distance d bhp between bhp sur and the given observed bhp data bhp obs according to 8 d bhp 1 9 10 n 1 n 9 t 1 t 10 bhp sur t n bhp obs t n 2 where n refers to well order and t refers to time step in days this distance is called bhp distance hereafter in this paper based on the bhp distance we can clearly recognize and exclude the initial burn in latent vectors of each markov chain for example fig 11 a shows the change of bhp distance to the measured bhp data of the initial 600 latent vector samples of one markov chain of test case 1 in which the first 50 samples with apparently large bhp distance values are the transient samples and are excluded while the remaining ones are rather steady and should approximately follow the posterior probability distribution given the conditioning data finally we obtain 69 212 and 48 587 latent vector samples in the two test cases respectively as is shown in fig 11 b and c the bhp distances of these steady state latent vectors to the measured bhp data are basically smaller than 0 35 and 0 4 in test case 1 and 2 for a quick evaluation we randomly sampled 1000 latent vectors as representatives from the sampled posterior latent vectors for both test cases respectively these latent vector representatives are then mapped into facies models using the trained generator and further mapped into bhp curves of the nine wells using the trained surrogate as a benchmark for comparison we use gansim alone to produce 1000 random facies models that are only conditioned to the probability maps channel complex proportions and well facies data but are not conditioned to the measured bhp data i e purely using the trained generator to map 1000 completely random latent vectors into 1000 facies models without combining the trained surrogate and the latent vector search approaches and map these facies models into bhp curves using the trained surrogate the observed measured bhp data are not used in this pure gansim process fig 12 and fig 13 shows five gansim produced and five gansim surrogate mcmc produced facies models for both test cases fig 14 and fig 15 compares the bhp curves of the 100 gansim produced and 100 gansim surrogate mcmc produced facies models for the two test cases 4 2 2 ies following appendix b 2 we set each ensemble to include 1000 latent vectors the parameter λ l is set as 200 constantly for all iteration steps we perform 5 ies runs for both test cases each ies run is stopped once the difference of each latent vector s average bhp distance to the measured bhp data between two successive iteration steps becomes smaller than 0 01 i e reaching convergence or when 500 total iterations are reached finally it takes 162 s and 151 s to get 5000 converged latent vector samples in test case 1 and 2 these latent vectors are then mapped into facies models using the trained generator fig 12 and fig 13 shows five random facies models for the two test cases fig 16 and fig 17 compares the bhp curves of 100 gansim produced and 100 gansim surrogate ies produced facies models for the two test cases 4 2 3 gradient descent in gradient descent approach for a random latent vector we define its bhp distance to the measured bhp data as a loss the loss is minimized with respect to the latent vector using adam optimizer with the default parameters kingma and ba 2014 and the learning rate of 0 01 we perform 500 rounds of gradient descent for both test cases and in each round each element of the initial latent vector is sampled from a standard gaussian distribution the gradient descent stops once the latent vector converges i e the loss difference between two successive iterations becomes smaller than 0 0002 or 20 000 iteration steps are reached it takes 4619 s and 7194 s to finish the 500 rounds in test case 1 and 2 respectively the latent vector in each round converges either to the global or to a local minimum the bhp distances to the measured bhp data of the latent vectors sampled using mcmc approach are smaller than 0 35 and 0 4 in test case 1 and 2 respectively see fig 11 b and c here we set the two values as the thresholds to distinguish local from global minima the obtained convergent latent vectors having losses bhp distances larger than the thresholds are regarded as converging to local minima and excluded finally 457 and 422 latent vectors remain in test case 1 and 2 these latent vectors are then mapped into facies models and fig 12 and fig 13 shows some random samples of them fig 18 and fig 19 shows the bhp curves of 100 gansim produced and 100 gansim surrogate gradient descent produced facies models for the two test cases 4 2 4 gradual deformation according to the steps described in appendix b 4 given latent vectors z 1 and z 2 when finding the optimum r value r opt from π to π we first equally sample 37 r values from π to π i e r π 35 π 36 π then for each sampled r value we calculate the corresponding latent vector z z 1 cos r z 2 sin r and the bhp distance to the measured bhp data equation 8 and finally the r value having the minimal bhp distance is determined as r opt we perform 500 rounds of gradual deformation for each case each round stops once the latent vector converges i e the differences of bhp distances of four successive r opt all become smaller than 0 0002 or 800 inner iterations of finding r opt are reached it takes 3866 s and 4155 s to finish the 500 rounds in test case 1 and 2 each round produces one final latent vector the bhp distances of the 500 produced latent vectors are all smaller than 0 4 and 0 35 the thresholds to distinguish between global and local minimum in test case 1 and 2 these latent vectors are mapped into facies models through the trained generator and several random ones of them are shown in in fig 12 and fig 13 for the two test cases fig 20 and fig 21 compares the bhp curves of 100 gansim produced and 100 gansim surrogate gradual deformation produced facies models for the two test cases 4 3 evaluation of conditional facies models as we can see from fig 12 and fig 13 all facies models produced by the trained generator are realistic i e having similar geological patterns as the training facies models in fig 2 and diverse the locations of the produced channel complexes in these facies models are consistent with the distribution of the high value areas in the given probability maps by calculation the reproduction accuracy of the input well facies data in all produced facies models is 100 in both test cases we calculate the channel complex proportions for the produced facies models and compare the calculated proportion values with the given conditioning one for both cases in fig 22 it is clear that the channel complex proportions of these produced facies models are very close to the expected conditioning one in both test cases these features of facies models i e realism variety and conditioning to the given probability map well facies data and facies proportion are inherent requirements of gansim for the trained generator i e all facies models produced by the trained gansim generator possess these features however as we can see from figs 14 21 without combining the trained surrogate the bhp data from the gansim alone produced facies model realizations are far away from the measured bhp data instead with gansim surrogate framework where the trained surrogate is used no matter which latent vector search approach is combined the final obtained facies models are all consistent with the measured bhp data note the range differences of vertical axis among the nine subfigures of figs 14 21 to further validate such consistency we randomly choose 200 facies models resulting from gansim surrogate framework i e 50 random facies models from each search approach use eclipse to simulate bhp data for these 200 facies models and compare the distributions of the bhp data produced by eclipse and the trained surrogate fig 23 shows box plots of bhp distributions calculated from eclipse and from the trained surrogate for well w1 w2 and w3 of both test cases the measured bhp data of these three wells change most obviously over time we can see that the bhp distributions calculated from eclipse are very close to that calculated from the trained surrogate and close to the measured bhp data 5 discussions 5 1 posterior distribution of conditional facies models we use multi dimensional scaling mds de leeuw 2005 to visually inspect the distribution change of the facies models after conditioning to the measured bhp data first we randomly select 100 gansim produced and 60 gansim surrogate mcmc produced facies models and put them together with the ground truth facies model to form one ensemble then we calculate the pairwise bhp distance between every pair of the 161 facies models of the ensemble next with the calculated bhp distance as the criterion mds maps the ensemble of facies models into a 2d space since the sampling results of mcmc approximately follow the posterior probability distribution given the four types of conditioning data here we only visualize the mcmc s results as points among the results of the four latent vector search approaches the facies model distributions of other search approaches are evaluated in the next section as is shown in fig 24 each point of the left scatter subplots represents one facies model and the right density contours are calculated from the scatter plots using gaussian kernel smoothing method compared to the distribution of gansim produced facies models which are conditioned only to probability maps well facies data and facies proportions the distribution of facies models resulting from gansim surrogate mcmc where the measured bhp data are further honored is largely shrunk towards the vicinity of the ground truth facies model this indicates that by further conditioning to the measured bhp data using the trained surrogate the prediction uncertainty of the subsurface reservoir is reduced and the prediction accuracy is increased this can also be seen from the comparison of the frequency and variance maps of channel complexes resulting from pure gansim and gansim surrogate framework in fig 12 and fig 13 from gansim to gansim surrogate framework the high value areas shrink inside or closely around the ground truth channel complexes in the frequency map and the variance map globally becomes smaller especially around the middle of the ground truth channel complexes the distribution difference between the gansim produced and the gansim surrogate mcmc produced facies models of fig 24 represents the information value of the measured bhp data for the aim of predicting the distribution of subsurface reservoir inverse problems are non unique and many solutions are possible that honor the conditioning data fig 25 shows the facies models closest to the ground truth among all the facies model results produced by different search approaches for both cases based on the pixel by pixel similarity of facies type although these closest facies models are very similar to the ground truth it is still difficult to exactly reconstruct the ground truth using the gansim surrogate framework for the south east corner of test case 2 the channel complexes of most produced facies models are very far from the ground truth see the produced facies models and frequency maps in fig 13 even including some of the produced closest facies models see facies models produced by mcmc and gradient descent in test case 2 of fig 25 it is possibly because the one to many mapping feature of the given probability map according to the shape of the high value area the south east corner of the given probability map may correspond to either an nnw striking channel complex consistent with the ground truth e g the closest facies models produced by ies and gradual deformation in fig 25 or an nne striking channel complex e g the closest facies models produced by mcmc and gradient descent in fig 25 this shows the non uniqueness of the problem 5 2 comparison of different latent vector search approaches in this study all of the four latent vector search approaches produce satisfactory facies models to compare the distribution of their results we again use mds with bhp distance as in fig 24 to map into 2d space the ground truth facies model and a few random facies model realizations resulting from different search approaches fig 26 as the approximate representation of the posterior probability distribution given all the conditioning data the mcmc produced facies models 200 samples blue crosses in fig 26 occupy the largest 2d space called solution space in this paper among the four search approaches the facies models of ies 200 samples gradient descent 200 samples and gradual deformation 160 samples fewer than the aforementioned three search methods because the samples here are more concentrated each only occupies a portion of the mcmc s solution space the solution spaces of the three search approaches are inclined to be located around the center of the mcmc s solution space see density contour maps of fig 26 gradual deformation produces the smallest solution space among the four approaches table 1 compares the number of satisfactory facies models produced and the time consumed for the four search approaches for the two test cases as optimization methods gradient descent and gradual deformation take longer average time about 10 s to obtain each satisfactory conditional facies model realization compared to the two sampling methods i e mcmc and ies where each conditional facies model takes less than 0 03 s on average however the two sampling methods do not produce conditional facies models one by one instead a large number of samples are concurrently produced within a relatively long time for example although mcmc gives samples one after another successive resulting samples are closely related and are very similar therefore if only a few conditional facies models are required then gradient descent and gradual deformation approaches may be tried especially if facies models with high posterior probability are required gradual deformation may be a good option because its solution space is small and has relatively high posterior probability see the cyan contours of fig 26 if on the other hand a large number of conditional facies models are required for uncertainty evaluation then mcmc or ies may be more efficient than the two optimization approaches 6 conclusions this study proposes a gansim surrogate framework for stochastic geomodelling conditioned to non spatial global features e g facies proportion sparse well facies data low resolution probability maps of facies e g resulting from geophysical interpretation and spatiotemporal dynamic flow data or original geophysical data for a category of reservoirs of interest the first step of the framework is to train i a convolutional neural network cnn based generator using the gansim approach and ii a cnn based surrogate for the dynamic flow data or the geophysical data using data driven or physics informed neural network pinn approach then for a new reservoir the trained generator takes its given well facies data global features probability maps and latent vectors as inputs and produces random realistic and conditional facies models next the produced facies models are converted into spatial distributions of rock properties e g permeability density acoustic velocity that are relevant for the data simulation then the trained surrogate maps the reservoir or rock property distributions into dynamic flow data or geophysical data finally by minimizing the mismatch between the surrogate produced flow or geophysical data and the actual observed ones appropriate latent vectors are searched to give facies models that are realistic and conditioned to not only the given well facies data global features and probability maps but also the given dynamic flow data or geophysical data four latent vector search approaches are explored as options in the framework markov chain monte karlo mcmc iterative ensemble smoother ies gradient descent and gradual deformation we apply this framework for synthetic 2d channel reservoirs to validate its effectiveness conditioning data types include facies proportion well facies data probability maps and dynamic flow data bottomhole pressure data bhp the method of conditioning to geophysical data is similar to that of dynamic flow data and is thus not considered in this example a surrogate capable of flow simulation is trained using partial differential equations pdes through the pinn approach given the above four types of conditioning data the gansim surrogate framework combined with any one of the four latent vector search approaches produces realistic diverse and conditional facies model realizations the average consumed time for each realization varies from 0 02 s to 17 s with different search approaches for two test cases compared to the facies models resulting from pure gansim which are only conditioned to the given well facies data probability map and facies proportion by further conditioning to the measured bhp data the distribution of the gansim surrogate produced facies models largely shrinks towards the vicinity of the ground truth indicating an increased prediction accuracy and a decreased uncertainty among the four latent vector search approaches the facies models resulting from mcmc approximately follow the posterior distribution while the results of other three search approaches may only occupy a portion of the complete posterior distribution when a large number of conditional facies models are required for uncertainty evaluation mcmc or ies are more efficient than gradient descent and gradual deformation however when only a few conditional facies models are required the latter two methods may be better building a large realistic training dataset is a significant yet challenging aspect of applying machine learning models in geosciences including the gansim and flow surrogate discussed here one possible solution is to first build a large library of training datasets for different geological scenarios using object based process based process mimicking or rule based simulation approaches for example song et al 2022b built a training dataset for field karst cave reservoirs using a process mimicking approach based on outcrop measurements analyses of well and seismic data and geological understanding second use the datasets in the library to train one or multiple fundamental deep learning models third for a specific reservoir only build a small training dataset and use it to conduct transfer learning with the pretrained deep learning models this process involves building industrial scale datasets and requires abundant computational resources for training thus necessitating joint efforts from academia and industry the pre trained fundamental deep learning models may be comparable to fundamental models of natural language processing e g chatgpt and computer vision area e g yolo credit authorship contribution statement suihong song conceptualization methodology software validation formal analysis investigation data curation writing original draft writing review editing visualization dongxiao zhang conceptualization methodology resources writing original draft writing review editing supervision project administration funding acquisition tapan mukerji conceptualization methodology validation resources formal analysis writing original draft writing review editing nanzhe wang methodology software writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was supported by the national natural science foundation of china 52288101 we acknowledge the sponsors of the stanford center for earth resources forecasting scerf and support from prof steve graham the former dean of the stanford school of earth energy and environmental sciences now the stanford doerr school of sustainability some of the computing for this project was performed on the sherlock cluster at stanford university we would like to thank stanford university and the stanford research computing center for providing computational resources and support that contributed to these research results appendix a gansim gans includes two neural networks called generator g and discriminator d which are generally designed as cnns in gans based unconditional geomodelling e g song et al 2021a given a number of training conceptual facies models the discriminator and generator are alternatively trained by maximizing and minimizing a loss function given as a1 l g θ d φ e x r p data l o g d φ x r e z p z log 1 d φ g θ z where l is the gans loss θ and φ are the trainable parameters of g and d p data is the distribution of training facies models x r is one random sample of p data z is a low dimensional latent vector p z is the distribution of z and e is the expectation operator after training the generator learns spatial geological patterns from the training data and can thus map a random latent vector into a realistic facies model compared to the gans for unconditional geomodelling gansim song et al 2021b 2022a has two features first the generator takes global features well facies data and facies probability maps as input conditioning data in addition to the original random latent vector second additional condition based loss functions are introduced for the three types of input conditioning data fig a1 shows the architecture of the generator used for geomodelling of 2d channel reservoirs song et al 2022a which is also used in this paper see section 3 1 the generator includes two types of pipelines main pipeline as the backbone and input pipelines for the three types of input conditioning data gansim uses the progressive training approach where the generator and the discriminator are trained layer by layer or block of layers by block of layers from shallow coarse resolution to deep finer resolution karras et al 2017 in the input pipeline of the facies probability map the input probability map 64 64 is first downsampled into various coarser resolutions e g 4 4 8 8 etc and then converted into feature cubes with the same resolution e g the feature cube with size of 4 4 16 and 8 8 16 through 1 1 convolutional kernels next these feature cubes are concatenated with the feature cubes having the same size of the main pipeline the input pipeline for the well facies data is the same as that of the probability maps the global feature values are directly concatenated with the input latent vector and their combination goes through all layers of the main pipeline the architecture of the discriminator is basically symmetrical to the main pipeline of the generator song et al 2022a in gansim the condition based loss function for the input global features is defined as a2 l g θ g e z p z g w p p g w p f g g z g w p g 2 where g w and p represent input global features well facies data and probability maps respectively and p g w p is their joint distribution function f g maps a generated facies model into its true global feature values while 2 refers to the euclidean l2 distance the condition based loss function for the input well facies data is a3 l g θ w e z p z g w p p g w p i wloc g z g w p w 2 where i wloc is the indicator of well locations and is the element wise product operator the condition based loss function for the input probability maps is a4 l g p e z 1 z 2 z m p z g w p p g w p f p g z 1 g w p g z m g w p p 2 where z 1 z 2 z m are random latent vectors sampled from p z and f p calculates the frequency map for each facies type from the m generated facies models g z i g w p i 1 m by calculating the percentage of each facies type at each point parameter m is a predefined hyperparameter each time when the generator is trained a weighted combination of these condition based losses and the gans loss equation a1 is minimized to enable the generator to learn the relationship between the three types of input conditioning data and the output facies model as well as expected geological patterns while when the discriminator is trained only the gans loss is maximized after training the generator can produce reservoir facies models consistent with expected geological patterns as represented in the training set as well as the three types of input conditioning data changing the input latent vector values produces multiple different conditional reservoir realizations for uncertainty assessment the three types of conditioning data are not necessarily always included in which case the input pipeline and the condition based loss of that excluded conditioning data are deleted karras t aila t laine s lehtinen j 2017 progressive growing of gans for improved quality stability and variation arxiv preprint arxiv 1710 10196 song s mukerji t hou j 2021a gansim conditional facies simulation using an improved progressive growing of generative adversarial networks gans mathematical geosciences https https doi org 10 1007 s11004 021 09934 0 song s mukerji t hou j 2021b geological facies modeling based on progressive growing of generative adversarial networks gans computational geosciences https https doi org 10 1007 s10596 021 10059 w song s mukerji t hou j 2022 bridging the gap between geophysics and geology with generative adversarial networks gans ieee transactions on geoscience and remote sensing 60 1 11 https doi org 10 1109 tgrs 2021 3066975 appendix b latent vector search approaches b 1 mcmc different mcmc variants have been developed brooks et al 2011 in this study we use a straightforward variant the metropolis hastings framework we denote by d as the variable of geophysical or dynamic data and d obs as the field measurement mcmc aims to sample a series of latent vectors from the posterior probability distribution p z d d obs based on bayes rule p z d is proportional to p z p d z both the prior p z and the likelihood p d z are assumed as gaussian distributions p z n 0 c z p d z n g z c d where n refers to a gaussian distribution c z and c d are predefined covariance matrixes and g is the combined process of the pretrained generator and the pretrained surrogate basic steps of metropolis hastings framework include 1 randomly sample an initial latent vector z 0 from its prior distribution p z 2 inner loop step 1 randomly sample a new latent vector candidate z 1 based on a proposal distribution p z 1 z 0 which is predefined as a gaussian distribution centered at the current latent vector sample z 0 step 2 calculate the probability to accept the candidate z 1 ρ p z 1 p d obs z 1 p z 0 p d obs z 0 step 3 based on ρ determine whether candidate z 1 is accepted if so keep z 1 and replace z 0 with z 1 after some burn in initial iterations the accepted latent vector samples approximately follow the posterior probability distribution p z d d obs and are the appropriate latent vectors to be used as inputs to the gansim surrogate network multiple markov chains may be performed to improve the variety of the samples especially in a multi modal posterior probability distribution b 2 iterative ensemble smoother ies ies deriving from ensemble smoother methods is commonly used for history matching evensen 2018 it updates an ensemble of reservoir geomodels iteratively so that the ensemble gradually matches the given historical data here we use the levenberg marquardt form of ies developed by chen oliver 2013 as described in appendix b 1 both the prior p z and the likelihood p d z are assumed as gaussian distributions the latent vector ensemble updating equation can be formulated as b1 z l 1 j z l j 1 λ l c z l z l c z l d l 1 λ l c d c d l d l 1 c d l z l c z 1 z l j z j pr c z l d l 1 λ l c d c d l d l 1 g z l j d j obs in this equation j is the latent vector index of the ensemble z j pr is a sample from the prior and d j obs is a sample from the gaussian distribution n d obs c d parameter l denotes the iteration step z l denotes the latent vector ensemble at the iteration step l d l is the ensemble of the simulated geophysical dynamic data calculated from z l through the combination of the pretrained generator and the pretrained surrogate i e g c z l z l is the covariance matrix of z l c z l d l is the cross covariance matrix of z l and d l c d l d l is the covariance matrix of d l c d l z l is the cross covariance matrix of d l and z l and λ l is a predefined hyperparameter the initial ensemble of latent vectors are randomly sampled from the prior in cases of multi modal posterior probability distribution the finally obtained ensemble may converge to one of these modes leading to a reduced diversity of the sampled latent vectors multiple rounds of ies program may be performed to alleviate this problem other variants of ies may also address this problem e g the iterative local updating ensemble smoother proposed by zhang et al 2018 b 3 gradient descent in the proposed gansim surrogate framework when fixing the trained generator and the trained surrogate the mismatch between the simulated and measured dynamic geophysical data is purely a function of the input latent vector the mismatch term can then be defined as a loss and by minimizing the loss through gradient descent algorithm the best latent vector consistent with the field measured data can be found multiple runs of gradient descent with random starts result in different optimal latent vectors it is worth nothing that the gradient descent approach cannot guarantee a globally minimal loss b 4 gradual deformation gradual deformation was originally proposed by hu 2000 and hu et al 2001 to search for the optimal reservoir model for history matching here we specify it as follows to search for optimal latent vectors 1 sample a latent vector z 1 from the prior distribution p z 2 inner loop step 1 sample another latent vector z 2 from the prior distribution p z step 2 based on a variable r π r π define z z 1 cos r z 2 sin r and find the optimal value r opt so that the mismatch between the simulated data g z and the measure data is minimized step 3 replace z 1 with z 1 cos r opt z 2 sin r opt similar to gradient descent multiple rounds of gradual deformation program can be performed to obtain different appropriate latent vectors brooks s gelman a jones g l meng x l 2011 handbook of markov chain monte carlo https doi org 10 1201 b10905 chen y oliver d s 2013 levenberg marquardt forms of the iterative ensemble smoother for efficient history matching and uncertainty quantification computational geosciences https doi org 10 1007 s10596 013 9351 5 evensen g 2018 analysis of iterative ensemble smoothers for solving inverse problems computational geosciences https doi org 10 1007 s10596 018 9731 y hu l y 2000 gradual deformation and iterative calibration of gaussian related stochastic models mathematical geology https doi org 10 1023 a 1007506918588 hu l y blanc g noetinger b 2001 gradual deformation and iterative calibration of sequential stochastic simulations mathematical geology https doi org 10 1023 a 1011088913233 zhang j lin g li w wu l zeng l 2018 an iterative local updating ensemble smoother for estimation and uncertainty assessment of hydrologic model parameters with multimodal distributions water resources research https doi org 10 1002 2017wr020906 
1991,stochastic conditional geomodelling requires effective integration of geological patterns and various types of data which is crucial but challenging to address this we propose a deep learning framework gansim surrogate for conditioning geomodels to static well facies data facies probability maps and non spatial global features as well as dynamic time dependent pressure or flow rate data observed at wells the framework consists of a convolutional neural network cnn generator trained from gansim a generative adversarial network based geomodelling simulation approach a cnn based surrogate and options for searching appropriate input latent vectors for the generator the four search methods investigated are markov chain monte carlo iterative ensemble smoother gradient descent and gradual deformation the framework is validated with channelized reservoirs first a generator is trained using gansim to generate geological facies models in addition a flow simulation surrogate is trained using a physics informed approach then given well facies data facies probability maps global facies proportions and dynamic bottomhole pressure data bhp the trained generator takes the first three static conditioning data and a latent vector as inputs and produces a random realistic facies model conditioned to the three static data to condition to the dynamic data the produced facies model is converted to permeability property and mapped to bhp data by the trained surrogate finally the mismatch between the surrogate produced and the observed bhp data is minimized to obtain appropriate input latent vectors which are further mapped into appropriate facies models through the generator these facies models prove to be realistic and consistent with all of the conditioning data and the framework is computationally efficient keywords gansim stochastic geomodelling uncertainty quantification surrogate generative adversarial networks gans convolutional neural networks cnns physics informed neural networks pinns data availability data will be made available on request 1 introduction geomodelling i e characterizing spatial distribution of subsurface reservoirs is of great significance for the exploitation of underground water and hydrocarbon resources and the geological storage of co2 e g pawar et al 2016 however the perpetual issue of insufficient data and knowledge about the subsurface leads to great uncertainty in geomodelling which is further transmitted into reserve evaluation well production prediction determination of new well locations and other decision making processes due to the high dimensionality of geomodelling such uncertainty cannot be explicitly characterized and is generally represented by multiple stochastic geomodel realizations as samples of the uncertainty space to decrease the uncertainty as many types of information as possible about the subsurface reservoir should be integrated into the geomodelling process see e g caers 2011 various types of information commonly include spatial geological structures or patterns global features e g facies proportion well facies data i e facies type at well locations geophysical data and temporal dynamic data observed at wells e g daily measurements of bottomhole pressure these types of information are presented in different forms and relate to reservoirs through different ways 1 high resolution well facies data are direct representation of reservoirs yet very sparse in geological space 2 geophysical data covers the complete three dimensional geo space of subsurface reservoirs but is subject to limited resolution fidelity and complicated relationship with reservoir properties e g porosity it relates to reservoir properties through a rock physics model linking reservoir properties with rock properties e g acoustic velocity and a partial differential equations pdes dominated process taking rock properties into geophysical data bosch et al 2010 3 as a type of spatiotemporal data dynamic data relates to reservoir properties also through a pdes dominated process that governs fluid flow 4 geological patterns describe the shapes and contact relations of different reservoir facies types there is no mathematical expression of complete geological patterns although the 3 d variogram function as a relaxed 2 point statistics approximation object based methods spatial markov random fields process mimicking algorithms and training images implicitly capturing multiple point spatial statistics are used to partially represent it in many cases deutsch 2002 mariethoz and caers 2014 5 global features as scalars describe the non spatial global geometrical or quantitative features of reservoirs such as the facies proportion channel width channel sinuosity etc traditionally geostatistical approaches are used to integrate partial geological patterns and well facies data to simulate multiple stochastic reservoir realizations e g variogram based or multiple point statistics mps based methods deutsch 2002 mariethoz and caers 2014 to further condition to measured temporal dynamic flow data observed at wells the above simulation process is perturbed to search for appropriate reservoir realizations these realizations are not only conditioned to the given well facies data and partial geological patterns but also are consistent with the measured dynamic data through a simulator which is capable of flow simulation see e g caers 2003a such a process centered on historical dynamic data is also called history matching in recent decades various aspects of history matching have been explored including perturbation methods of the sequential simulation process caers 2003a 2003b hu et al 2001 development of surrogate based simulators e g the polynomial chaos expansion surrogate proposed by li and zhang 2009 and search methods for appropriate realizations e g gradual deformation caers 2003a hu 2000 probability perturbation methods caers and hoffman 2006 hu 2008 probability conditioning methods jafarpour and khodabakhshi 2011 ensemble based methods chang et al 2017 chen and oliver 2013 and markov chain monte carlo mcmc based methods efendiev et al 2015 liao et al 2019 ma et al 2008 two approaches have been used to condition reservoir simulations to geophysical data joint inversion and sequential inversion the joint inversion process is very similar to history matching except a rock physics model is inserted to transform simulated reservoir realizations into physical properties which are then used to forward simulate geophysical data in sequential inversion probability maps of different reservoir facies types are first obtained using for example statistical rock physics and quantitative interpretation workflows e g avseth et al 2005 then these probability maps are taken as soft constraining data in geostatistical simulation approaches to produce reservoir realizations bosch et al 2010 gives a review of both workflows through all the above processes the produced reservoir realizations can honor the given global features well facies data dynamic data geophysical data and expected geological patterns to some extent however the variograms or multiple points statistics of a training image can only partially represent the complicated geological patterns thus there is a lack of realism in the simulated reservoir realizations to different extents e g discontinuous channels produced by mps based methods additionally traditional simulators applied in history matching and geophysical inversion processes are relatively slow compared to the requirement of a large number of simulator iterations in the two processes making it computationally expensive to achieve conditioning of the produced reservoir realizations to the given geophysical and dynamic data in practice generative adversarial networks gans goodfellow et al 2014 in deep learning can capture complicated spatial patterns of 2d images or 3d objects using a generator composed of convolutional neural networks cnns with the captured pattern knowledge the generator can produce realistic images or 3d objects from low dimensional latent vectors wu et al 2016 researchers combined gans with geomodelling on different aspects chan and elsheikh 2019 chen et al 2022 laloy et al 2018 mosser et al 2020 nesvold and mukerji 2021 song et al 2021a 2021b 2022a 2022b sun et al 2023 yang et al 2022 zhang et al 2019 chan and elsheikh 2017 dupont et al 2018 for unconditional geomodelling the generator of gans is first trained to learn geological patterns from a training set of many conceptual facies models then with the learned geological patterns the generator can quickly map random latent vectors into multiple realistic reservoir realizations see e g song et al 2021a to achieve conditioning appropriate latent vectors are searched so that they can be mapped by the trained generator into realizations that are consistent with the given conditioning data laloy et al 2018 2019 mosser et al 2020 nesvold and mukerji 2021 zhang et al 2019 this process is similar to history matching and geophysical inversion except the original geostatistical simulation process of facies models is replaced by the trained generator various latent vector search approaches e g gradient descent gradual deformation ensemble methods and mcmc methods can be used here recently song et al 2021b 2022a proposed a new gans based workflow for direct conditional geomodelling called gansim where the trained generator takes the given global feature values well facies data geophysics interpreted facies probability maps and random latent vectors as inputs and directly produces various realistic reservoir realizations consistent with all of the input conditioning data there is no need for an expensive latent vector search process in gansim song et al 2022b applied gansim for stochastic geomodelling of 3d karst cave field reservoirs conditioned to well facies data and 3d facies probability cubes interpreted from seismic data with excellent performance however gansim cannot achieve direct conditioning to the original geophysical data and dynamic data in which case the latent vector search process may still be needed to be combined however compared to using the trained unconditional generator i e generator only taking a latent vector as input for the latent vector search process here with the trained conditional generator of gansim the computational resources and time required by the search process should be largely reduced because the appropriate latent vectors only need to be consistent with the geophysical or dynamic data instead of all the given conditioning data types forward simulators are required in all forms of history matching and geophysical inversion processes including the aforementioned ones involving trained generators caers 2003a grana et al 2022 laloy et al 2018 to improve the running speed of simulators cnn based surrogates i e approximate mathematical model of simulators are largely studied using either data driven tang et al 2021 or physics informed e g wang et al 2021 xu et al 2022 approaches the data driven approach enables the learning of pde dominated relationships between geophysical dynamic data and rock reservoir properties from training input output labelled data pairs while the physics informed approach i e physics informed neural networks pinns karniadakis et al 2021 enforces cnns to directly learn knowledge from pdes indeed the cnn based surrogate is relatively easy to train with data driven method but the trained surrogate may violate physics locally in contrast physics informed training is slow and may involve problems like tunning of weight hyperparameters but ensures consistency with physics constraints and does not require a great many of input output labelled data pairs for training wang et al 2021 proves largely improved accuracy of physics informed approach compared to purely data driven approach and reduced running time of the cnn based flow surrogate compared to a traditional finite difference based simulator modflow mo et al 2020 proposed to combine variational auto encoder another type of generative model comparable to gans a cnn based surrogate and iterative ensemble smoother for geomodelling conditioned to dynamic flow data but the well facies data global features and probability maps are not honored additionally conditioning to these types of data may be achieved by a more elaborate latent vector search process but takes longer time in this paper we propose the gansim surrogate framework by combining gansim and cnn based surrogate together to quickly produce stochastic reservoir realizations that are consistent with expected geological patterns as well as the given global features well facies data geophysical data or its interpreted facies probability maps and dynamic flow data with this framework the uncertainty of the generated reservoir realizations would be significantly reduced while the speed of geomodelling would be largely increased section 2 introduces the general gansim surrogate framework then to showcase the procedures of this framework and validate its effectiveness we apply this framework for stochastic geomodelling of channel reservoirs in section 3 we concretize the framework by constructing a generator and a surrogate specifically for channel reservoirs in section 4 the concretized gansim surrogate framework is used for stochastic geomodelling of channel reservoirs in two test cases conditioned to given facies proportion value as a type of global feature well facies data geophysics interpreted probability map and dynamic data finally sections 5 and 6 give discussions and conclusions of this study respectively 2 gansim surrogate framework in this section first we present the general workflow of gansim surrogate framework and then three important components of this workflow are described 2 1 general gansim surrogate workflow the proposed gansim surrogate framework is illustrated as in fig 1 for a specific class of reservoir the first step of the framework is to train a cnn based generator using the standard gansim approach described in section 2 2 briefly and appendix a in detail and a cnn based surrogate using either the data driven or the physics informed approach described in sections 2 2 and 3 2 for this reservoir class the trained generator can then take well facies data global features facies probability maps and a latent vector as inputs and produce a random reservoir facies model that is consistent with the three types of input conditioning data as well as the expected geological patterns of the reservoir class of interest as a substitution of the forward simulator involved in history matching or geophysical inversion the trained surrogate can map reservoir properties e g permeability distribution into dynamic data in history matching process or map rock properties e g acoustic velocity into geophysical data in geophysical inversion process for a new reservoir given its well facies global feature values facies probability maps original geophysical data and dynamic data as conditioning data first the trained generator takes the first three conditioning data and random latent vectors as inputs and produces multiple realistic and conditional facies model realizations second these realizations are transformed into reservoir property distributions with geostatistical approaches in history matching or rock property distributions with rock physics models in geophysical inversion next the trained surrogate takes the transformed reservoir rock property distributions and other related parameters e g initial and boundary conditions seismic wavelet as inputs and produces dynamic geophysical data then the mismatch between the produced dynamic geophysical data and the field measured one is minimized by perturbing and searching for appropriate latent vectors four latent vector search approaches are investigated here viz mcmc iterative ensemble smoother ies gradient descent and gradual deformation appendix b gives a brief description of these search approaches used in this paper finally the pretrained generator takes as inputs these appropriate latent vectors as well as the given well facies data global features and probability maps and produces different facies model realizations that are consistent with the expected geological patterns the three types of input conditioning data as well as the field measured dynamic or geophysical data once the generator and the surrogate are trained this workflow is computationally very fast for stochastic geomodelling note that the three types of input conditioning data are not necessarily all needed as inputs of the generator 2 2 components of gansim surrogate framework 1 gansim based on gans gansim song et al 2021b 2022a aims at training a cnn based generator which takes as inputs various types of conditioning data as well as a latent vector and produces facies model realizations that are consistent with the expected geological patterns and the input conditioning data different input latent vectors generate different facies realizations compared to the conventional gans based unconditional geomodelling workflow e g song et al 2021a in gansim the architecture of the generator is improved to take different types of conditioning data as inputs and an additional type of loss function called condition based loss is introduced to enforce the generator to learn the relationship between the input conditioning data and the output facies model in addition a progressive training approach karras et al 2017 is used in gansim where the generator is trained progressively from shallow coarse resolution to deep fine resolution layers after training with fixed input conditioning data and varying input latent vectors the generator can produce diverse realistic facies model realizations all conditioned to the input conditioning data appendix a presents more details about gansim including the generator architecture the condition based loss function and the progressive training process 2 cnn based surrogate construction in recent years different cnn configurations for surrogate models for porous media flow have been researched depending on specific requirements e g decoder encoder wang et al 2021 u net and convlstm where u net and lstm are combined tang et al 2021 in addition researchers also used cycle gans zhu et al 2017 to construct cnn based surrogate sun 2018 when training the surrogate with a purely data driven supervised approach a large number of input output labelled data pairs are required as the training data the loss function of this approach can be formulated as 1 l data e m c d p m c d d i s t s u r m c d where m c d represents a combination of reservoir rock property distributions m simulation related parameters c and the corresponding dynamic geophysical data d p m c d is the joint distribution of m c d dist refers to a certain form of distance and sur is the cnn based surrogate that takes as inputs the rock property distributions and simulation related parameters and outputs the corresponding dynamic geophysical data thus m c d constitutes one input output data pair for the surrogate sur by minimizing l data the surrogate is trained to learn the mapping from reservoir rock properties into dynamic geophysical data as stored inside the training data pairs however with a physics informed approach raissi et al 2019 the surrogate is trained to directly learn the physical knowledge expressed by the governing pdes its loss function minimizes the residual of the governing pdes and can be expressed as 2 l physics e m c p m c p d e s s u r m c m c p where p represents the l p norm in this equation we take reservoir rock property distributions m related parameters c and the dynamic geophysical data produced from the surrogate s u r m c all as inputs into the governing pdes of which the right hand side is zero in the above equation pdes symbolizes the residuals of the governing pdes by minimizing l physics the surrogate is forced to be consistent with the given pdes 3 latent vector search approaches among the four latent vector search algorithms explored in this work i e mcmc ies gradient descent and gradual deformation the former two methods try to sample a bayesian inferenced posterior probability distribution while the latter two directly minimize the mismatch between the surrogate produced and the measured dynamic geophysical data so as to search for the optimum input latent vector each time for the two minimization methods multiple runs with different starting points are needed to obtain different appropriate latent vectors and different conditional facies models to approximate the uncertainty of subsurface reservoirs appendix b briefly describes the steps of the four search approaches in the context of gansim surrogate framework 3 gansim surrogate framework setup for channel reservoirs to demonstrate how gansim surrogate framework works and validate its effectiveness we use it for stochastic geomodelling of a common category of reservoir channelized reservoir in 2d here only the conditioning of dynamic flow data is considered for illustration although the workflow can potentially integrate conditioning of geophysical data as well three types of sedimentary facies are considered in the reservoir channel center sand channel bank sand and inter channel mud the former two facies types are lumped together as channel complex one or multiple channel complexes may exist in one reservoir facies model having similar features such as orientation sinuosity and width this study only considers channels within 25 degrees deviation from the north south direction fig 2 shows several conceptual facies model examples obtained by object based simulation to illustrate the sedimentary facies types and the geological patterns of this reservoir class each facies model has an area of 3200 m 3200 m and is equally divided into 64 64 cells according to the gansim surrogate framework in this section we mainly focus on training a cnn based generator producing channel reservoir facies models and a cnn based surrogate mapping reservoir property distributions into dynamic data then in section 4 the prepared gansim surrogate framework including the trained generator and the trained surrogate is used for stochastic conditional geomodelling we simulate single phase water flow from north to south through the channel reservoir facies model the daily bottomhole pressure values bhp of different wells are regarded as the dynamic data the surrogate uses permeability maps converted from facies models as inputs to predict the pressure distribution maps within the domain at different time steps and finally the bhp data at different wells are obtained by sampling these pressure maps at well locations following section 3 1 and section 3 2 describe how the generator and the surrogate are constructed respectively 3 1 construction of the generator song et al 2022a used the gansim approach to train a generator for 2d channel reservoirs the architecture of the generator is shown in fig a1 in appendix a the inputs include a probability map of channel complex two indicator maps of well facies data one for well locations and the other for facies types at well locations see song et al 2021b for detail the facies proportion of channel complex or mud facies type as a type of global feature and a latent vector consisting of 128 elements each following a standard gaussian distribution the training data include 35 640 conceptual facies models resulting from object based geomodelling and the corresponding probability maps well facies data and facies proportion values these conceptual facies models have the same size resolution sedimentary facies types and geological patterns as in fig 2 except that the channels are along all directions after training given a random group of probability map well facies data and facies proportion value the generator can map them into multiple reservoir realizations which are consistent with the geological patterns of channel reservoirs and the input conditioning data in this study we use the same architecture as in song et al 2022a among the 35 640 conceptual channel reservoir facies models of that study 11 880 facies models have channel directions ranging within 25 degrees deviating from the north direction and are used here the reason to limit the channel direction is to alleviate the training burden of the surrogate constructed in the next section we use 11 000 facies models and the corresponding probability maps well facies data and channel complex proportions as the training dataset another 440 as the development dataset for hyperparameter tunning and the remaining 440 as the test dataset for evaluation of the results other settings are the same as in song et al 2022a including the architecture of the discriminator training schedule weights for different losses etc we train the generator for 10 h with 4 gpus nvidia tesla v100 pcie 32 gb 20 cpus and 160g ram in parallel after training the trained generator can map a random group of channel complex proportion value well facies data and probability map as well as a random latent vector into a conditional reservoir facies model realization by changing the input latent vector various conditional realizations can be produced in fig 3 a we randomly choose 5 facies models from the test dataset and take their corresponding probability maps well facies data and channel complex proportions into the trained generator to produce various facies model realizations the channel complexes of these realizations are around the north direction and their geological patterns are similar to that of the training facies models see fig 2 the input probability maps have a marked conditioning effect on these realizations fig 3 b shows the produced facies models as we gradually decrease increase the input channel complex proportion value by 10 and 20 with other inputs fixed indicating the influence of the input channel complex proportion on the output facies model in addition the reproduction accuracy of the input well facies data are 100 the average running time for the trained generator to produce one facies model realization is about 0 0005 s from these brief evaluations we can see that the trained generator can take the given probability map well facies data and channel complex proportion quickly into multiple realistic and conditional facies model realizations and thus can be used for the gansim surrogate framework in the next step more complete evaluation metrics are presented in song et al 2021b 2022a 3 2 construction of the flow surrogate the surrogate aims to predict the pressure distribution map at a time step given a channel reservoir permeability map the boundary and initial pressure values and the time step each permeability map is converted from a channel reservoir facies model by specifying a constant permeability value for each facies type the permeability of channel center facies is specified as a value randomly sampled from 1000 md to 4000 md the permeability of channel bank facies is calculated by multiplying the permeability of channel center of the same permeability map with a coefficient randomly sampled from 0 6 to 0 85 and the permeability of inter channel mud is specified as a value randomly sampled from 5 md to 40 md different facies models correspond to different specifications of permeability values for the flow boundary conditions we set the east and the west boundaries of the reservoir domain as closed boundaries the south boundary pressure is set at a constant value randomly sampled from 270 bar to 330 bar and the north boundary pressure at a constant value is 2 bar to 30 bar greater than the pressure at the south boundary the initial pressure within the domain equals the south boundary pressure the time step ranges from 1 day to 10 days with an interval of 1 day the reservoir is fully saturated with brine having a viscosity of 2 c p and a density of 1038 k g m 3 the compression coefficient of the reservoir including the water inside is 1 8 10 5 bar 1 the water flows from north to south and the surrogate can produce subsurface pressure maps from 1 day to 10 days the dynamic bhp data at different wells can be obtained by sampling these produced pressure maps at well locations 3 2 1 cnn architecture the architecture of the surrogate is shown in fig 4 the inputs include a permeability map a boundary pressure map of which the northernmost and the southernmost rows are respectively repeated by the north and the south boundary pressure values and other cells are set to 0 an initial pressure map with the initial pressure value and a time step map filled with the time step value the output is a pressure map each input or output map of the surrogate has 64 64 cells inside the surrogate is a u net cnn configuration the four types of input maps are first concatenated and convolved to form a feature cube of 64 64 32 then that feature cube goes through five combined operations of downsampling and convolution to form a feature cube of 2 2 1024 containing the most abstract information of the inputs each downsampling operation uses an averaging method to halve the height and width of its corresponding feature cube next this 2 2 1024 feature cube sequentially goes through five combined operations of upsampling concatenation and convolution to produce a feature cube of 64 64 32 the upsampling operations dilate the heights and widths of feature cubes by a factor of 2 using the nearest neighbor upsampling method each concatenation operation combines the newly upsampled feature cube e g 8 8 512 feature cube after upsamling of the 4 4 512 feature cube with the feature cube of the same height and width produced by previous combined operations of downsampling and convolution e g 8 8 256 feature cube finally the 64 64 32 feature cube is converted into a pressure map of 64 64 1 as the output using a convolution operation all convolutions have a kernel size of 3 3 except the last one for which the kernel size is 1 1 the stride length for these convolutions is 1 1 we use the leaky rectified linear unit function lrelu with a leaky value of 0 2 as the activation function after all convolutional layers except the last one where no activation function is applied instead of the pure encoder decoder configuration i e u net without skip connections used by wang et al 2021 to predict the pressure map we chose to use the u net configuration since the encoder decoder configuration gave poor results for the channelized reservoirs with strong permeability heterogeneity 3 2 2 loss here the surrogate is trained using a physics informed approach in many studies centered on physics informed approach a small number of input output or input label data pairs are also used as the training data in a semi supervised approach to alleviate the training burden karniadakis et al 2021 in this study we only use the pde dominated physical law to train the surrogate and no input output labelled data pair is used the governing equation of single phase fluid flow in a porous reservoir media is 3 a k x y p x y t x x k x y p x y t y y μ c p x y t t where x and y are coordinates along east west and north south directions m t refers to the time step in unit of days p x y t is the pressure in bars k x y is the permeability in md μ is the viscosity of the fluid in cp c is the compression coefficient of the rock and the fluid inside in bar 1 and a is a unit conversion factor 0 00852702 appropriate for these mixed units we use f k p n p s p i t φ to denote the output pressure map of the surrogate at t day where k is the input permeability map p n p s and p i denotes the north boundary the south boundary and the initial pressure value and φ are the trainable parameters of the surrogate note that the input permeability map and the output pressure map of the surrogate each consists of 64 64 cells we substitute the pressure term p x y t in equation 3 with f k p n p s p i t φ as a map and use the finite difference method to discretize that equation as in wang et al 2021 the residual for each cell except the northernmost and southernmost rows at each time step is constructed as 4 r k p n p s p i φ i j t a k i 1 i 2 j f k p n p s p i t φ i 1 j f k p n p s p i t φ i j k i i 1 2 j f k p n p s p i t φ i j f k p n p s p i t φ i 1 j δ x 2 k i j 1 j 2 f k p n p s p i t φ i j 1 f k p n p s p i t φ i j k i j j 1 2 f k p n p s p i t φ i j f k p n p s p i t φ i j 1 δ y 2 μ c f k p n p s p i t φ i j f k p n p s p i t δ t φ i j δ t in this equation i and j are indexes of cells along eastward and northward directions 1 i 64 2 j 63 1 t 10 δ x and δ y are the length of each cell along the two directions δ x δ y 50 m δ t is the interval of the time step i e δ t 1 day k i 1 i 2 j denotes the harmonic mean of permeability values at cell i j and cell i 1 j 5 k i 1 i 2 j 2 k i j k i 1 j k i j k i 1 j the viscosity μ and the compression coefficient c are 2 cp and 1 8 10 5 bar 1 respectively in equation 4 the given boundary pressure values are directly used i e f i j 1 t p s f i j 64 t p n since the east and west boundaries are closed boundaries we set f i 0 j t f i 1 j t and f i 65 j t f i 64 j t in equation 4 the initial pressure value is also directly used in the equation i e f i j t 0 p i for each input data group k p n p s p i of the surrogate we expect the residual term for each cell except the northernmost and southernmost rows to be as close to 0 as possible after training thus a physics informed loss function for each input data group k p n p s p i is formulated as 6 l k p n p s p i 1 64 62 10 1 i 64 2 j 63 1 t 10 r k p n p s p i φ i j t 2 given many such input data groups as the training data the final loss function is 7 l e k p n p s p i p k p n p s p i l k p n p s p i where p k p n p s p i refers to the distribution of training input data groups 3 2 3 training based on the 11 000 training 440 development and 440 test facies models used when constructing the generator we build 11 000 training 440 development and 440 test input data groups for the surrogate in each group the permeability map is transformed from a facies model using the rules described in the paragraph before section 3 2 1 and the boundary and initial pressure values are randomly sampled also according to the rules described in that paragraph we use 4 gpus nvidia tesla v100 pcie 32gb 20 cpus and 160g ram to train the surrogate in parallel the minibatch gradient descent and the adam optimizer with default parameters kingma and ba 2014 are used each minibatch includes 32 training input data groups the training is stopped after 24 h the loss function equation 7 does not inform any constraint on the northernmost and the southernmost rows of the domain where the pressure boundary conditions are specified thus the two rows of each output pressure map of the surrogate are assigned with the input north and south boundary pressure values 3 2 4 evaluation we sample two input data groups each including a permeability map and boundary and initial pressure values from the test dataset in the first input data group the permeability values of the channel center channel bank and inter channel mud facies are 2554 md 1632 md and 16 md respectively fig 5 and the north boundary south boundary and initial pressure values are 320 6 bar 296 6 bar and 296 6 bar respectively in the second input data group the permeability values for the channel center channel bank and inter channel mud are 1422 md 1117 md and 29 md respectively fig 6 and the north boundary south boundary and initial pressure values are 319 6 bar 297 1 bar and 297 1 bar respectively we formalize the boundary and initial pressure values and a time step varying from 1 to 10 days into 2d maps as shown in fig 4 these maps as well as the permeability map are then taken as inputs into the trained surrogate to predict pressure maps after 1 to 10 days of water flow from the north to south we also use eclipse a commercial software based on finite volume pde solutions to compute the pressure maps for the two input data groups fig 5 and fig 6 show the comparisons of the pressure maps produced by the trained surrogate and eclipse after various days for the two cases the absolute relative error of the surrogate predicted results with eclipse results as the references are also shown in the two figures in the form of both maps and average values from fig 5 and fig 6 we can see that the surrogate predicted pressure maps are very similar to the eclipse calculated references in both spatial patterns and numerical magnitude the relative error is also quite small fig 7 cross plots and compares the surrogate predicted and the eclipse calculated values at 1000 points randomly sampled from the pressure maps of 1 to 10 days for the two input data groups the least square fit lines red lines of these points are very close to the one is to one lines black lines further proving the closeness between the surrogate predicted values and the eclipse calculated references in addition we randomly sample 100 input data groups from the test dataset and compare the surrogate predicted pressure maps of 1 to 10 days with the eclipse calculated references fig 8 shows the histogram of the average absolute relative error for the 100 cases we can see that the average relative error mainly ranges from 0 03 to 0 5 with a mean of 0 19 as we can see in fig 5 fig 6 fig 7 and fig 8 the accuracy of the surrogate predictions is rather high especially given the strong heterogeneity of channel reservoirs the surrogate takes only 0 005 s to produce 10 pressure maps of 10 days for one permeability map using 1 gpu while eclipse uses 2 6 s to simulate the same number of pressure maps using a 14 cores based computer the speed of the trained generator and the trained surrogate is of great significance for the success of the search of appropriate latent vectors 4 geomodelling of channel reservoirs with prepared gansim surrogate framework in this section first we randomly select two test channel reservoir facies models as the ground truth and obtain the four types of conditioning data i e well facies data channel complex proportion values probability maps of channel complex and bhp of different wells from the two ground truth facies models then we use the prepared gansim surrogate framework including the generator and the surrogate trained in section 3 and the four latent vector search approaches to produce multiple posterior facies model realizations conditioned to the above four types of conditioning data for the two test cases finally the posterior realizations are evaluated and the four latent vector search approaches are compared 4 1 conditioning data 1 test case 1 as shown in fig 9 the ground truth facies model includes several channel complexes around the north direction we use gaussian kernel smoothing approach with kernel size of 39 39 cells to obtain the probability map of channel complex to mimic the interpretation of field geophysical data fig 9 b nine wells are assumed to be equally distributed in the domain and the well facies data is obtained by sampling the facies type from the ground truth facies model at the nine well locations fig 9 d in field cases the channel complex proportion may be obtained by comprehensive analyses of well data geophysical data and geological analogy here we directly calculate that proportion from the ground truth facies model 41 2 and use it as another type of conditioning data the permeability map of the domain is obtained by setting the permeability values of the channel center channel bank and inter channel mud facies as 2134 md 1465 md and 20 md respectively the constant north and south boundary pressure values of the domain are set as 308 9 bar and 293 9 bar respectively the initial pressure value of the whole domain equals to the south boundary pressure value based on the permeability map we use eclipse to simulate the pressure maps of the domain for 1 to 10 days from which the real bhp data of the nine wells are sampled considering a field observation error of the field bhp data following a gaussian distribution with the mean of 0 and standard deviation of 0 1 i e e n 0 0 1 the observed bhp data are obtained as in fig 9 e 2 test case 2 the selected ground truth facies model of test case 2 is shown in fig 10 a following the same procedures as in test case 1 the probability map of channel complex and the well facies data of nine equally spaced wells are obtained from the ground truth facies model i e b and d of fig 10 the channel complex proportion of the ground truth 35 5 is used as another type of conditioning data the permeability values of the channel center channel bank and inter channel mud facies are set as 2309 md 1405 md and 35 md respectively in this case the north boundary the south boundary and the initial pressure value of the domain are set as 301 5 bar 285 7 bar and 285 7 bar respectively with the same method as in test case 1 the observed bhp data of the nine wells are obtained as in fig 10 e 4 2 conditional geomodelling given the conditioning data of the two test cases we follow the procedures of gansim surrogate framework fig 1 and apply the four latent vector search approaches i e mcmc ies gradient descent and gradual deformation to find appropriate latent vectors which can then be mapped into conditional facies models in this process each facies model produced by the generator is converted into a permeability map by assigning a constant permeability value into each facies type we assume the permeability values for each facies to be known and hence for test case 1 we assign 2134 md 1465 md and 20 md into the channel center channel bank and inter channel mud facies respectively while for test case 2 we assign 2309 md 1405 md and 35 md into the three facies types basic steps of the four latent vector search approaches are described in appendix b and are followed here 4 2 1 mcmc the 128 elements of each latent vector are independent and follow a standard gaussian distribution as described in appendix b 1 when proposing a new latent vector candidate z 1 each of its element z 1 m m 1 2 128 is sampled from a proposal gaussian distribution centered at the element of the same order of the current latent vector z 0 i e z 1 m n z 0 m 0 06 each bhp data has 90 elements i e ten daily bhp values for each well multiplied by nine wells given a random latent vector z the likelihood of each bhp element bhp s s 1 2 90 is assumed to follow a gaussian distribution bhp s z n g z s 0 1 where g is the combined forward process of the pretrained generator the pretrained surrogate and the sampling of the corresponding pressure maps for bhp data at the nine well locations five markov chains each starting from a different initial latent vector and including 20 000 inner loops are performed for the two test cases respectively each taking 1258 s for each markov chain some initial latent vector samples during the burn in period may not follow the posterior probability distribution and are excluded thus for each sampled latent vector we first use the trained generator and the trained surrogate to produce its bhp data bhp sur then we calculate the distance d bhp between bhp sur and the given observed bhp data bhp obs according to 8 d bhp 1 9 10 n 1 n 9 t 1 t 10 bhp sur t n bhp obs t n 2 where n refers to well order and t refers to time step in days this distance is called bhp distance hereafter in this paper based on the bhp distance we can clearly recognize and exclude the initial burn in latent vectors of each markov chain for example fig 11 a shows the change of bhp distance to the measured bhp data of the initial 600 latent vector samples of one markov chain of test case 1 in which the first 50 samples with apparently large bhp distance values are the transient samples and are excluded while the remaining ones are rather steady and should approximately follow the posterior probability distribution given the conditioning data finally we obtain 69 212 and 48 587 latent vector samples in the two test cases respectively as is shown in fig 11 b and c the bhp distances of these steady state latent vectors to the measured bhp data are basically smaller than 0 35 and 0 4 in test case 1 and 2 for a quick evaluation we randomly sampled 1000 latent vectors as representatives from the sampled posterior latent vectors for both test cases respectively these latent vector representatives are then mapped into facies models using the trained generator and further mapped into bhp curves of the nine wells using the trained surrogate as a benchmark for comparison we use gansim alone to produce 1000 random facies models that are only conditioned to the probability maps channel complex proportions and well facies data but are not conditioned to the measured bhp data i e purely using the trained generator to map 1000 completely random latent vectors into 1000 facies models without combining the trained surrogate and the latent vector search approaches and map these facies models into bhp curves using the trained surrogate the observed measured bhp data are not used in this pure gansim process fig 12 and fig 13 shows five gansim produced and five gansim surrogate mcmc produced facies models for both test cases fig 14 and fig 15 compares the bhp curves of the 100 gansim produced and 100 gansim surrogate mcmc produced facies models for the two test cases 4 2 2 ies following appendix b 2 we set each ensemble to include 1000 latent vectors the parameter λ l is set as 200 constantly for all iteration steps we perform 5 ies runs for both test cases each ies run is stopped once the difference of each latent vector s average bhp distance to the measured bhp data between two successive iteration steps becomes smaller than 0 01 i e reaching convergence or when 500 total iterations are reached finally it takes 162 s and 151 s to get 5000 converged latent vector samples in test case 1 and 2 these latent vectors are then mapped into facies models using the trained generator fig 12 and fig 13 shows five random facies models for the two test cases fig 16 and fig 17 compares the bhp curves of 100 gansim produced and 100 gansim surrogate ies produced facies models for the two test cases 4 2 3 gradient descent in gradient descent approach for a random latent vector we define its bhp distance to the measured bhp data as a loss the loss is minimized with respect to the latent vector using adam optimizer with the default parameters kingma and ba 2014 and the learning rate of 0 01 we perform 500 rounds of gradient descent for both test cases and in each round each element of the initial latent vector is sampled from a standard gaussian distribution the gradient descent stops once the latent vector converges i e the loss difference between two successive iterations becomes smaller than 0 0002 or 20 000 iteration steps are reached it takes 4619 s and 7194 s to finish the 500 rounds in test case 1 and 2 respectively the latent vector in each round converges either to the global or to a local minimum the bhp distances to the measured bhp data of the latent vectors sampled using mcmc approach are smaller than 0 35 and 0 4 in test case 1 and 2 respectively see fig 11 b and c here we set the two values as the thresholds to distinguish local from global minima the obtained convergent latent vectors having losses bhp distances larger than the thresholds are regarded as converging to local minima and excluded finally 457 and 422 latent vectors remain in test case 1 and 2 these latent vectors are then mapped into facies models and fig 12 and fig 13 shows some random samples of them fig 18 and fig 19 shows the bhp curves of 100 gansim produced and 100 gansim surrogate gradient descent produced facies models for the two test cases 4 2 4 gradual deformation according to the steps described in appendix b 4 given latent vectors z 1 and z 2 when finding the optimum r value r opt from π to π we first equally sample 37 r values from π to π i e r π 35 π 36 π then for each sampled r value we calculate the corresponding latent vector z z 1 cos r z 2 sin r and the bhp distance to the measured bhp data equation 8 and finally the r value having the minimal bhp distance is determined as r opt we perform 500 rounds of gradual deformation for each case each round stops once the latent vector converges i e the differences of bhp distances of four successive r opt all become smaller than 0 0002 or 800 inner iterations of finding r opt are reached it takes 3866 s and 4155 s to finish the 500 rounds in test case 1 and 2 each round produces one final latent vector the bhp distances of the 500 produced latent vectors are all smaller than 0 4 and 0 35 the thresholds to distinguish between global and local minimum in test case 1 and 2 these latent vectors are mapped into facies models through the trained generator and several random ones of them are shown in in fig 12 and fig 13 for the two test cases fig 20 and fig 21 compares the bhp curves of 100 gansim produced and 100 gansim surrogate gradual deformation produced facies models for the two test cases 4 3 evaluation of conditional facies models as we can see from fig 12 and fig 13 all facies models produced by the trained generator are realistic i e having similar geological patterns as the training facies models in fig 2 and diverse the locations of the produced channel complexes in these facies models are consistent with the distribution of the high value areas in the given probability maps by calculation the reproduction accuracy of the input well facies data in all produced facies models is 100 in both test cases we calculate the channel complex proportions for the produced facies models and compare the calculated proportion values with the given conditioning one for both cases in fig 22 it is clear that the channel complex proportions of these produced facies models are very close to the expected conditioning one in both test cases these features of facies models i e realism variety and conditioning to the given probability map well facies data and facies proportion are inherent requirements of gansim for the trained generator i e all facies models produced by the trained gansim generator possess these features however as we can see from figs 14 21 without combining the trained surrogate the bhp data from the gansim alone produced facies model realizations are far away from the measured bhp data instead with gansim surrogate framework where the trained surrogate is used no matter which latent vector search approach is combined the final obtained facies models are all consistent with the measured bhp data note the range differences of vertical axis among the nine subfigures of figs 14 21 to further validate such consistency we randomly choose 200 facies models resulting from gansim surrogate framework i e 50 random facies models from each search approach use eclipse to simulate bhp data for these 200 facies models and compare the distributions of the bhp data produced by eclipse and the trained surrogate fig 23 shows box plots of bhp distributions calculated from eclipse and from the trained surrogate for well w1 w2 and w3 of both test cases the measured bhp data of these three wells change most obviously over time we can see that the bhp distributions calculated from eclipse are very close to that calculated from the trained surrogate and close to the measured bhp data 5 discussions 5 1 posterior distribution of conditional facies models we use multi dimensional scaling mds de leeuw 2005 to visually inspect the distribution change of the facies models after conditioning to the measured bhp data first we randomly select 100 gansim produced and 60 gansim surrogate mcmc produced facies models and put them together with the ground truth facies model to form one ensemble then we calculate the pairwise bhp distance between every pair of the 161 facies models of the ensemble next with the calculated bhp distance as the criterion mds maps the ensemble of facies models into a 2d space since the sampling results of mcmc approximately follow the posterior probability distribution given the four types of conditioning data here we only visualize the mcmc s results as points among the results of the four latent vector search approaches the facies model distributions of other search approaches are evaluated in the next section as is shown in fig 24 each point of the left scatter subplots represents one facies model and the right density contours are calculated from the scatter plots using gaussian kernel smoothing method compared to the distribution of gansim produced facies models which are conditioned only to probability maps well facies data and facies proportions the distribution of facies models resulting from gansim surrogate mcmc where the measured bhp data are further honored is largely shrunk towards the vicinity of the ground truth facies model this indicates that by further conditioning to the measured bhp data using the trained surrogate the prediction uncertainty of the subsurface reservoir is reduced and the prediction accuracy is increased this can also be seen from the comparison of the frequency and variance maps of channel complexes resulting from pure gansim and gansim surrogate framework in fig 12 and fig 13 from gansim to gansim surrogate framework the high value areas shrink inside or closely around the ground truth channel complexes in the frequency map and the variance map globally becomes smaller especially around the middle of the ground truth channel complexes the distribution difference between the gansim produced and the gansim surrogate mcmc produced facies models of fig 24 represents the information value of the measured bhp data for the aim of predicting the distribution of subsurface reservoir inverse problems are non unique and many solutions are possible that honor the conditioning data fig 25 shows the facies models closest to the ground truth among all the facies model results produced by different search approaches for both cases based on the pixel by pixel similarity of facies type although these closest facies models are very similar to the ground truth it is still difficult to exactly reconstruct the ground truth using the gansim surrogate framework for the south east corner of test case 2 the channel complexes of most produced facies models are very far from the ground truth see the produced facies models and frequency maps in fig 13 even including some of the produced closest facies models see facies models produced by mcmc and gradient descent in test case 2 of fig 25 it is possibly because the one to many mapping feature of the given probability map according to the shape of the high value area the south east corner of the given probability map may correspond to either an nnw striking channel complex consistent with the ground truth e g the closest facies models produced by ies and gradual deformation in fig 25 or an nne striking channel complex e g the closest facies models produced by mcmc and gradient descent in fig 25 this shows the non uniqueness of the problem 5 2 comparison of different latent vector search approaches in this study all of the four latent vector search approaches produce satisfactory facies models to compare the distribution of their results we again use mds with bhp distance as in fig 24 to map into 2d space the ground truth facies model and a few random facies model realizations resulting from different search approaches fig 26 as the approximate representation of the posterior probability distribution given all the conditioning data the mcmc produced facies models 200 samples blue crosses in fig 26 occupy the largest 2d space called solution space in this paper among the four search approaches the facies models of ies 200 samples gradient descent 200 samples and gradual deformation 160 samples fewer than the aforementioned three search methods because the samples here are more concentrated each only occupies a portion of the mcmc s solution space the solution spaces of the three search approaches are inclined to be located around the center of the mcmc s solution space see density contour maps of fig 26 gradual deformation produces the smallest solution space among the four approaches table 1 compares the number of satisfactory facies models produced and the time consumed for the four search approaches for the two test cases as optimization methods gradient descent and gradual deformation take longer average time about 10 s to obtain each satisfactory conditional facies model realization compared to the two sampling methods i e mcmc and ies where each conditional facies model takes less than 0 03 s on average however the two sampling methods do not produce conditional facies models one by one instead a large number of samples are concurrently produced within a relatively long time for example although mcmc gives samples one after another successive resulting samples are closely related and are very similar therefore if only a few conditional facies models are required then gradient descent and gradual deformation approaches may be tried especially if facies models with high posterior probability are required gradual deformation may be a good option because its solution space is small and has relatively high posterior probability see the cyan contours of fig 26 if on the other hand a large number of conditional facies models are required for uncertainty evaluation then mcmc or ies may be more efficient than the two optimization approaches 6 conclusions this study proposes a gansim surrogate framework for stochastic geomodelling conditioned to non spatial global features e g facies proportion sparse well facies data low resolution probability maps of facies e g resulting from geophysical interpretation and spatiotemporal dynamic flow data or original geophysical data for a category of reservoirs of interest the first step of the framework is to train i a convolutional neural network cnn based generator using the gansim approach and ii a cnn based surrogate for the dynamic flow data or the geophysical data using data driven or physics informed neural network pinn approach then for a new reservoir the trained generator takes its given well facies data global features probability maps and latent vectors as inputs and produces random realistic and conditional facies models next the produced facies models are converted into spatial distributions of rock properties e g permeability density acoustic velocity that are relevant for the data simulation then the trained surrogate maps the reservoir or rock property distributions into dynamic flow data or geophysical data finally by minimizing the mismatch between the surrogate produced flow or geophysical data and the actual observed ones appropriate latent vectors are searched to give facies models that are realistic and conditioned to not only the given well facies data global features and probability maps but also the given dynamic flow data or geophysical data four latent vector search approaches are explored as options in the framework markov chain monte karlo mcmc iterative ensemble smoother ies gradient descent and gradual deformation we apply this framework for synthetic 2d channel reservoirs to validate its effectiveness conditioning data types include facies proportion well facies data probability maps and dynamic flow data bottomhole pressure data bhp the method of conditioning to geophysical data is similar to that of dynamic flow data and is thus not considered in this example a surrogate capable of flow simulation is trained using partial differential equations pdes through the pinn approach given the above four types of conditioning data the gansim surrogate framework combined with any one of the four latent vector search approaches produces realistic diverse and conditional facies model realizations the average consumed time for each realization varies from 0 02 s to 17 s with different search approaches for two test cases compared to the facies models resulting from pure gansim which are only conditioned to the given well facies data probability map and facies proportion by further conditioning to the measured bhp data the distribution of the gansim surrogate produced facies models largely shrinks towards the vicinity of the ground truth indicating an increased prediction accuracy and a decreased uncertainty among the four latent vector search approaches the facies models resulting from mcmc approximately follow the posterior distribution while the results of other three search approaches may only occupy a portion of the complete posterior distribution when a large number of conditional facies models are required for uncertainty evaluation mcmc or ies are more efficient than gradient descent and gradual deformation however when only a few conditional facies models are required the latter two methods may be better building a large realistic training dataset is a significant yet challenging aspect of applying machine learning models in geosciences including the gansim and flow surrogate discussed here one possible solution is to first build a large library of training datasets for different geological scenarios using object based process based process mimicking or rule based simulation approaches for example song et al 2022b built a training dataset for field karst cave reservoirs using a process mimicking approach based on outcrop measurements analyses of well and seismic data and geological understanding second use the datasets in the library to train one or multiple fundamental deep learning models third for a specific reservoir only build a small training dataset and use it to conduct transfer learning with the pretrained deep learning models this process involves building industrial scale datasets and requires abundant computational resources for training thus necessitating joint efforts from academia and industry the pre trained fundamental deep learning models may be comparable to fundamental models of natural language processing e g chatgpt and computer vision area e g yolo credit authorship contribution statement suihong song conceptualization methodology software validation formal analysis investigation data curation writing original draft writing review editing visualization dongxiao zhang conceptualization methodology resources writing original draft writing review editing supervision project administration funding acquisition tapan mukerji conceptualization methodology validation resources formal analysis writing original draft writing review editing nanzhe wang methodology software writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was supported by the national natural science foundation of china 52288101 we acknowledge the sponsors of the stanford center for earth resources forecasting scerf and support from prof steve graham the former dean of the stanford school of earth energy and environmental sciences now the stanford doerr school of sustainability some of the computing for this project was performed on the sherlock cluster at stanford university we would like to thank stanford university and the stanford research computing center for providing computational resources and support that contributed to these research results appendix a gansim gans includes two neural networks called generator g and discriminator d which are generally designed as cnns in gans based unconditional geomodelling e g song et al 2021a given a number of training conceptual facies models the discriminator and generator are alternatively trained by maximizing and minimizing a loss function given as a1 l g θ d φ e x r p data l o g d φ x r e z p z log 1 d φ g θ z where l is the gans loss θ and φ are the trainable parameters of g and d p data is the distribution of training facies models x r is one random sample of p data z is a low dimensional latent vector p z is the distribution of z and e is the expectation operator after training the generator learns spatial geological patterns from the training data and can thus map a random latent vector into a realistic facies model compared to the gans for unconditional geomodelling gansim song et al 2021b 2022a has two features first the generator takes global features well facies data and facies probability maps as input conditioning data in addition to the original random latent vector second additional condition based loss functions are introduced for the three types of input conditioning data fig a1 shows the architecture of the generator used for geomodelling of 2d channel reservoirs song et al 2022a which is also used in this paper see section 3 1 the generator includes two types of pipelines main pipeline as the backbone and input pipelines for the three types of input conditioning data gansim uses the progressive training approach where the generator and the discriminator are trained layer by layer or block of layers by block of layers from shallow coarse resolution to deep finer resolution karras et al 2017 in the input pipeline of the facies probability map the input probability map 64 64 is first downsampled into various coarser resolutions e g 4 4 8 8 etc and then converted into feature cubes with the same resolution e g the feature cube with size of 4 4 16 and 8 8 16 through 1 1 convolutional kernels next these feature cubes are concatenated with the feature cubes having the same size of the main pipeline the input pipeline for the well facies data is the same as that of the probability maps the global feature values are directly concatenated with the input latent vector and their combination goes through all layers of the main pipeline the architecture of the discriminator is basically symmetrical to the main pipeline of the generator song et al 2022a in gansim the condition based loss function for the input global features is defined as a2 l g θ g e z p z g w p p g w p f g g z g w p g 2 where g w and p represent input global features well facies data and probability maps respectively and p g w p is their joint distribution function f g maps a generated facies model into its true global feature values while 2 refers to the euclidean l2 distance the condition based loss function for the input well facies data is a3 l g θ w e z p z g w p p g w p i wloc g z g w p w 2 where i wloc is the indicator of well locations and is the element wise product operator the condition based loss function for the input probability maps is a4 l g p e z 1 z 2 z m p z g w p p g w p f p g z 1 g w p g z m g w p p 2 where z 1 z 2 z m are random latent vectors sampled from p z and f p calculates the frequency map for each facies type from the m generated facies models g z i g w p i 1 m by calculating the percentage of each facies type at each point parameter m is a predefined hyperparameter each time when the generator is trained a weighted combination of these condition based losses and the gans loss equation a1 is minimized to enable the generator to learn the relationship between the three types of input conditioning data and the output facies model as well as expected geological patterns while when the discriminator is trained only the gans loss is maximized after training the generator can produce reservoir facies models consistent with expected geological patterns as represented in the training set as well as the three types of input conditioning data changing the input latent vector values produces multiple different conditional reservoir realizations for uncertainty assessment the three types of conditioning data are not necessarily always included in which case the input pipeline and the condition based loss of that excluded conditioning data are deleted karras t aila t laine s lehtinen j 2017 progressive growing of gans for improved quality stability and variation arxiv preprint arxiv 1710 10196 song s mukerji t hou j 2021a gansim conditional facies simulation using an improved progressive growing of generative adversarial networks gans mathematical geosciences https https doi org 10 1007 s11004 021 09934 0 song s mukerji t hou j 2021b geological facies modeling based on progressive growing of generative adversarial networks gans computational geosciences https https doi org 10 1007 s10596 021 10059 w song s mukerji t hou j 2022 bridging the gap between geophysics and geology with generative adversarial networks gans ieee transactions on geoscience and remote sensing 60 1 11 https doi org 10 1109 tgrs 2021 3066975 appendix b latent vector search approaches b 1 mcmc different mcmc variants have been developed brooks et al 2011 in this study we use a straightforward variant the metropolis hastings framework we denote by d as the variable of geophysical or dynamic data and d obs as the field measurement mcmc aims to sample a series of latent vectors from the posterior probability distribution p z d d obs based on bayes rule p z d is proportional to p z p d z both the prior p z and the likelihood p d z are assumed as gaussian distributions p z n 0 c z p d z n g z c d where n refers to a gaussian distribution c z and c d are predefined covariance matrixes and g is the combined process of the pretrained generator and the pretrained surrogate basic steps of metropolis hastings framework include 1 randomly sample an initial latent vector z 0 from its prior distribution p z 2 inner loop step 1 randomly sample a new latent vector candidate z 1 based on a proposal distribution p z 1 z 0 which is predefined as a gaussian distribution centered at the current latent vector sample z 0 step 2 calculate the probability to accept the candidate z 1 ρ p z 1 p d obs z 1 p z 0 p d obs z 0 step 3 based on ρ determine whether candidate z 1 is accepted if so keep z 1 and replace z 0 with z 1 after some burn in initial iterations the accepted latent vector samples approximately follow the posterior probability distribution p z d d obs and are the appropriate latent vectors to be used as inputs to the gansim surrogate network multiple markov chains may be performed to improve the variety of the samples especially in a multi modal posterior probability distribution b 2 iterative ensemble smoother ies ies deriving from ensemble smoother methods is commonly used for history matching evensen 2018 it updates an ensemble of reservoir geomodels iteratively so that the ensemble gradually matches the given historical data here we use the levenberg marquardt form of ies developed by chen oliver 2013 as described in appendix b 1 both the prior p z and the likelihood p d z are assumed as gaussian distributions the latent vector ensemble updating equation can be formulated as b1 z l 1 j z l j 1 λ l c z l z l c z l d l 1 λ l c d c d l d l 1 c d l z l c z 1 z l j z j pr c z l d l 1 λ l c d c d l d l 1 g z l j d j obs in this equation j is the latent vector index of the ensemble z j pr is a sample from the prior and d j obs is a sample from the gaussian distribution n d obs c d parameter l denotes the iteration step z l denotes the latent vector ensemble at the iteration step l d l is the ensemble of the simulated geophysical dynamic data calculated from z l through the combination of the pretrained generator and the pretrained surrogate i e g c z l z l is the covariance matrix of z l c z l d l is the cross covariance matrix of z l and d l c d l d l is the covariance matrix of d l c d l z l is the cross covariance matrix of d l and z l and λ l is a predefined hyperparameter the initial ensemble of latent vectors are randomly sampled from the prior in cases of multi modal posterior probability distribution the finally obtained ensemble may converge to one of these modes leading to a reduced diversity of the sampled latent vectors multiple rounds of ies program may be performed to alleviate this problem other variants of ies may also address this problem e g the iterative local updating ensemble smoother proposed by zhang et al 2018 b 3 gradient descent in the proposed gansim surrogate framework when fixing the trained generator and the trained surrogate the mismatch between the simulated and measured dynamic geophysical data is purely a function of the input latent vector the mismatch term can then be defined as a loss and by minimizing the loss through gradient descent algorithm the best latent vector consistent with the field measured data can be found multiple runs of gradient descent with random starts result in different optimal latent vectors it is worth nothing that the gradient descent approach cannot guarantee a globally minimal loss b 4 gradual deformation gradual deformation was originally proposed by hu 2000 and hu et al 2001 to search for the optimal reservoir model for history matching here we specify it as follows to search for optimal latent vectors 1 sample a latent vector z 1 from the prior distribution p z 2 inner loop step 1 sample another latent vector z 2 from the prior distribution p z step 2 based on a variable r π r π define z z 1 cos r z 2 sin r and find the optimal value r opt so that the mismatch between the simulated data g z and the measure data is minimized step 3 replace z 1 with z 1 cos r opt z 2 sin r opt similar to gradient descent multiple rounds of gradual deformation program can be performed to obtain different appropriate latent vectors brooks s gelman a jones g l meng x l 2011 handbook of markov chain monte carlo https doi org 10 1201 b10905 chen y oliver d s 2013 levenberg marquardt forms of the iterative ensemble smoother for efficient history matching and uncertainty quantification computational geosciences https doi org 10 1007 s10596 013 9351 5 evensen g 2018 analysis of iterative ensemble smoothers for solving inverse problems computational geosciences https doi org 10 1007 s10596 018 9731 y hu l y 2000 gradual deformation and iterative calibration of gaussian related stochastic models mathematical geology https doi org 10 1023 a 1007506918588 hu l y blanc g noetinger b 2001 gradual deformation and iterative calibration of sequential stochastic simulations mathematical geology https doi org 10 1023 a 1011088913233 zhang j lin g li w wu l zeng l 2018 an iterative local updating ensemble smoother for estimation and uncertainty assessment of hydrologic model parameters with multimodal distributions water resources research https doi org 10 1002 2017wr020906 
1992,china leads the world in vegetation greening and accounts for one fourth of the global net increase in leaf area over the past two decades however it remains elusive on the relative importance of vegetation greening and climate change on china s hydrological cycle due to the lack of observational based constraints on notorious model uncertainties here we developed a process based distributed hydrological model that couples a nonlinear runoff generation mechanism with a remotely sensed evapotranspiration et module this model could well capture the spatiotemporal patterns of the main hydrological components runoff et and soil moisture at grid scale and streamflow at watershed scale during 1982 2012 over the mainland china we show that the changes in climatic factors precipitation and potential et dominated hydrologic change at the national scale with climate induced runoff decrease by 7 6 mm year 1 compared to 0 6 mm year 1 caused by vegetation change vegetation effect was primarily notable in water limited regions as a higher correlation between vegetation contribution to runoff change and absolute leaf area index lai trend in water limited regions r 0 52 p 0 01 than energy limited regions r 0 19 p 0 01 our results highlight the significance of region dependent differential measures for sustainable water resources management and climate change adaptation under a changing climate keywords vegetation greening climate change china hydrologic cycle data availability data will be made available on request 1 introduction china leads the world in vegetation greening and has contributed 25 of the global net increase in leaf area chen et al 2019 peng et al 2011 piao et al 2015 mainly through croplands and large scale ecosystem restoration programs such as the three north forest shelterbelt program the natural forest conservation program and the grain for green program chen et al 2015 zhang et al 2016 this anthropogenic revegetation could enhance carbon sequestration by increasing net primary productivity npp du et al 2021 which is beneficial to carbon neutrality before 2060 in china wang et al 2021 but evidence is emerging that vegetation greening could also lead to a decline in runoff and soil moisture due to increased evapotranspiration et especially in the arid region of china bai et al 2020 brown et al 2005 li et al 2018 liu et al 2016 zeng et al 2018a zeng et al 2018b this negative effect of vegetation greening on the hydrological water cycle could potentially enhance conflicting demands for water between the ecosystem and human feng et al 2016 and exacerbate water scarcity in these arid regions resulting in a more uneven distribution of water resources in china bai et al 2019 bai et al 2020 liu et al 2016 sun et al 2006 zhang et al 2017 zhou et al 2015 therefore it is crucial to assess the impacts of vegetation greening on regional hydrology for water sources management and sustainable social development in china previous studies using land surface models lsms ivanov et al 2008 li et al 2018 xi et al 2018 zeng et al 2018a zeng et al 2018b to investigate the vegetation effects on hydrologic processes have difficulties in model parameterization calibration and validation due to high model complexity and computational cost model complexity is an important issue that hinders such models from being applied on a large scale ma and szilagyi 2019 therefore it is valuable to develop simple conceptual hydrological model incorporated vegetation dynamics to accurately simulate hydrologic processes in response to climate and vegetation changes moreover previous researches have been mostly restricted to assessing vegetation impacts without simultaneously considering the effects of climate change including precipitation and potential evapotranspiration and there is high spatial heterogeneity in vegetation impacts on hydrologic cycle across china bai et al 2019 li et al 2018 for example in the past several decades there is a strong warming over china featuring a faster warming rate in northern china than in southern china and precipitation changes instead showed an increased contrast between northeastern and southern china ding et al 2007 piao et al 2010 it remains unexplored whether and where the vegetation greening has a greater control on regional hydrology compared to the drastic climatic change occurring in the past several decades here we developed a process based distributed hydrological model that couples a time variant nonlinear runoff generation mechanism with a remotely sensing et module to quantify the respective effects of climate change and vegetation greening on terrestrial water cycle across china we implemented the model at a high spatial resolution 0 25 with model validation pertaining to runoff et and soil moisture at grid scale and streamflow at watershed scale on the basis of the well parameterized model we performed eight simulation experiments with observed or detrended forcing data climate forcing data and land surface data from 1982 to 2012 to quantify the contribution of climatic factors precipitation and potential et and vegetation lai to regional hydrology in china 2 materials and methods 2 1 forcing datasets the forcing datasets driving the hydrological model include climate data and land surface data the daily climate forcing variables were derived from the global land data assimilation system gldas rodell et al 2004 with a spatial resolution of 0 25 including wind speed temperature specific humidity pressure downward short wave and long wave radiation the precipitation we used in this study was the 0 25 gridded daily scale dataset of cn05 1 wu and gao 2013 based on interpolation from 2416 station observations in china the land surface variables leaf area index lai and albedo were derived from the 8 day composite 0 05 0 05 global land surface satellite glass product we resampled the 8 day composite data into the daily data by a piecewise cubic hermite polynomial and then smoothed by the savitzky golay filtering method fang et al 2008 li et al 2009 ruffin et al 2008 we used the monthly runoff data from the institute of geographic sciences and natural resources research igsnrr dataset for china produced by zhang et al 2014 and monthly et data from the global land evaporation amsterdam model gleam product martens et al 2017 for model calibration see model and experiments additionally we obtained observed daily streamflow from 30 watersheds for model validation over china fig 1 the observed streamflow data were derived from china s hydrological year book the observational soil moisture data were derived from gleam martens et al 2017 the saturate moisture content data used to calculate soil moisture in this study were obtained from liu et al 2020 we also used a global gridded runoff product called linear optimal runoff aggregate lora hobeichi et al 2019 to evaluate the performance of our simulation in producing the interannual variation in runoff at the country scale 2 2 model and experiments in our previous work song et al 2022 we have developed a hydrological model by incorporating the penman monteith leuning pml equation leuning et al 2008 into the distributed time variant gain model dtvgm wang et al 2009 xia et al 2005 named dtvgm pml figure s2 the dtvgm pml contains snow routine interception routine evapotranspiration routine and runoff routine and the gridded runoff simulated by the dtvgm pml was routed by the lohmann routing model lohmann et al 1996 for specific watersheds we performed a multi variable calibration framework to obtain optimal spatial parameters and ran the model at a daily time step for 1982 2012 with 1998 2012 as the calibration period and 1982 1997 as the validation period with a spatial resolution of 0 25 we used the shuffled complex evolution sce ua algorithm duan et al 1994 for model calibration see the detailed information in song et al 2022 in this study we switched the forcing data to the gldas forcing dataset combined with the precipitation from cn05 1 dataset to achieve better model performance especially in arid regions see results the dtvgm pml estimates et with full use of remote sensing vegetation information i e leaf area index and constrains et estimates within the water balance framework we performed the factor separation methodology bai et al 2019 zhang et al 2015 and designed eight simulation experiments table 1 to assess the contribution of climate and vegetation to the water cycle in china we selected three driving factors leaf area index lai precipitation p and potential evapotranspiration pet to represent the impact of vegetation and climate on hydrological variables the precipitation is the main supply of atmospheric water playing a key role in promoting global water cycle the pet was used to determine the combined impacts of temperature wind speed air vapor pressure and solar radiation on atmospheric demand for et zhang et al 2015 we applied the fao 56 penman monteith method allan et al 1998 recommended by the food and agriculture organisation of the united nations fao for pet estimation the lai describing plant canopy structure is an important indicator of radiation and precipitation interception energy conversion and water balance we generated detrended forcing data see detrending method in the supplementary material and then separately ran the hydrological model using the original and detrended forcing data to design different simulation experiments the control simulation sctl was the simulation driven by detrended variables following previous studies bai et al 2019 luo et al 2008 we examined main and interactive effects of three factors p pet and lai the main effects referred to changes in hydrological variables et or runoff in response to treatments of single factor for example the main effect of lai e lai is 1 e lai f l a i f c o n t r o l the two way interactive effect was the subtraction of the main effects from the effect of the joint treatment between two factors for example the two way interactive effect of lai and p e lai p is calculated as formula 2 the two way interactive effect and the three way interactive effect could be interpreted as the second order or higher order terms in multi point taylor expansion bai et al 2019 for instance the positive interactive effect on et between p and lai assuming both increasing trends can be explained by the fact that rising p increased water availability and increasing lai intensified vegetation transpiration the joint treatment would reinforce the evapotranspiration leading to positive interaction 2 e lai p f l a i p f c o n t r o l e lai e p the three way interactive effect among p pet and lai is the subtraction of the effect of the joint p pet and lai treatment from all the combined two way interactive effects and main effects of the three factors and was calculated by 3 e lai p p e t f l a i p p e t f c o n t r o l e lai e p e pet e lai p e lai p e t e p p e t the contribution of vegetation greening c veg to hydrological changes is estimated as the percentage of absolute e lai of the sum of absolute main effects and interactive effects on annual mean hydrological variables at each grid cell 4 c veg f l a i f c o n t r o l f l a i p p e t f c o n t r o l e lai e lai e p e pet e lai p e lai p e t e p p e t e lai p p e t 3 results 3 1 model evaluation we compared the performance in grid by grid runoff and evapotranspiration et simulation between models driven by china meteorological forcing dataset cmfd and global land data assimilation system gldas combined with gauge based cn05 1 precipitation figure s3 presents the cumulative density function cdf plots of the kling gupta efficiency kge metric values for runoff and et simulation using the two forcing datasets in the validation period over four climatic zones the gldas forcing data apparently outperformed the cmfd data in runoff simulation especially in arid regions fig s3a the performance in et simulation was also slightly improved when driving the dtvgm pml with gldas data compared with the cmfd data in the previous work song et al 2022 additionally we used observational streamflow on 30 hydrological stations fig 1 to validate the performance of simulated runoff and et by the gldas driven dtvgm pml fig 2 a d we calculated three statistical criteria nse kge and pbias on each hydrological station for monthly streamflow validation the results showed good agreement between the simulated and observed streamflow and the median statistical metrics were nse 0 84 kge 0 78 and pbias 6 55 respectively fig 2a c regarding the et simulation we applied the water balance method to obtain the mean annual et i e the difference between mean annual precipitation and runoff in each watershed corresponding to the station the model could reasonably estimate the mean annual et in the 30 watersheds as the statistical metrics were nse 0 76 kge 0 75 and pbias 6 3 fig 2d moreover we specifically evaluated our model performance in estimating the soil moisture fig 2e which was not generally implemented in hydrological simulations the modeled soil moisture contents in our study were calculated as θ sat w w m where θ sat and w w m are the saturated moisture content and the relative soil moisture respectively at each gridcell our results could well reproduce the spatial pattern of soil moisture derived from the global land evaporation amsterdam model gleam product with a high spatial correlation coefficient of 0 73 p 0 01 in addition the ratio of spatial standard deviations sdr between dtvgm pml simulated and gleam derived soil moisture is 0 94 approaching 1 0 means better with a spatial taylor skill score tss of 0 56 demonstrating good modeling performance kwon et al 2018 taylor 2001 overall the dtvgm pml can reasonably simulate the spatiotemporal dynamics of various hydrological variables in china including runoff streamflow et and soil moisture which constitute a cornerstone for the subsequent attribution analyses we further validated the interannual variation in hydrological variables over china the dtvgm pml could reasonably reproduce the observed trend in hydrological variables runoff et and soil moisture over china from 1982 to 2012 fig 3 the simulated annual runoff anomalies closely followed the observed ones from runoff products r 0 96 p 0 001 for the igsnrr dataset r 0 84 p 0 001 for the lora dataset fig 3a at the inter annual timescale the model could generally capture the decreasing trend in annual runoff 1 06 mm year 2 p 0 07 from igsnrr dataset in contrast to runoff trends both the global land evaporation amsterdam model gleam product based 0 94 mm year 2 p 0 001 and simulated et 0 86 mm year 2 p 0 001 showed a significant increasing trend over china the dtvgm pml simulation could well reproduce the interannual variation of et from the gleam product r 0 69 p 0 001 fig 3b meanwhile the simulated soil moisture from dtvgm pml shows a significantly high correlation with the root zone gleam soil moisture dataset r 0 71 p 0 001 fig 3c the significant decreasing trend in annual soil moisture of the dtvgm pml simulation 0 07 m3m 3decade 1 p 0 001 was also consistent with that of the root zone gleam dataset 0 04 m3m 3decade 1 p 0 001 3 2 contribution of climate change and vegetation greening to regional hydrology across china we assessed the hydrological responses to changes in climate and vegetation across china fig 4 a shows the relative change in et and runoff between single factor simulations sl sp or se denoting actual lai precipitation p or potential et pet data and the control simulation sctl driven by detrended forcing data the lai changes contributed to around 15 increases in et and around 15 decreases in runoff in the yellow river basin and the p changes would result in a decrease of et and runoff by around 5 and above 15 in the yangtze river basin and the songliao river basin respectively the pet changes led to increases in et and decreases in runoff by around 10 across almost the whole country the spatial correspondence of changes in hydrological variables et or runoff and drivers lai p or pet is shown in fig 4b lai has a positive effect on et in the majority of grid cells including 62 1 of the grid cells having an increase in both lai and et and 26 0 having a decrease in both lai and et while the p and pet showed a positive effect on et across the whole region in contrast to et the impact of lai on runoff was negative in 86 5 of grid cells the runoff increases only appeared in 12 3 of areas with an increase in lai the p and pet showed a positive and negative effect on runoff over the whole region respectively we then summarized the contribution of climate change and vegetation greening to regional hydrology over the nine major basins of china we computed the main effect see materials and methods of the three driving factors lai p and pet on hydrological variables at each grid cell and the median contribution in each basin was shown in fig 5 in terms of the p induced hydrological changes a slight decline in p 7 5 mm year 1 table s1 contributed to decreases in both et 0 7 mm year 1 and runoff 2 2 mm year 1 the response of runoff to p changes was more sensitive than that of et for example in the pearl river basin in south china p change 19 6 mm year 1 led to a large decrease in runoff 26 5 mm year 1 but a slight decrease in et 1 7 mm year 1 similar results could also be found in humid and semi humid regions such as the yangtze river basin the southeast river basin the songliao river basin and the huai river basin the pet markedly increased across all river basins around 49 mm year 1 on average table s1 resulting in an increase in et and reduction in runoff especially in the southeast river basin 25 1 mm year 1 for et and 23 7 mm year 1 for runoff the contribution of pet changes to et was comparable to that to runoff as for the vegetation effects on hydrological variables increased lai 0 05 m3 m 3 enhanced the et by about 0 8 mm year 1 and decreased the runoff by 0 6 mm year 1 at the country level far less than the climate induced hydrological changes increased et by 6 7 mm year 1 and reduced runoff by 7 6 mm year 1 by changes in p and pet however the magnitude of vegetation impact was comparable to that of climate impact on runoff changes in both the yellow river basin 1 5 mm year 1 vs 1 2 mm year 1 and the hai river basin 3 1 mm year 1 vs 3 3 mm year 1 in the huai river basin with the largest lai changes 0 211 m3 m 3 table s1 among all the river basins the vegetation changes caused a relatively strong et increase 6 1 mm year 1 and runoff decrease 5 6 mm year 1 while the negative effect of vegetation greening on runoff could be totally offset by the increase in runoff 12 3 mm year 1 predominantly attributed to a large increase in precipitation leading to an overall increase in runoff the interactive effects on et and runoff were quite lower than the main effects figure s5 overall climate and vegetation impacts on regional hydrology showed strong spatial heterogeneity and the vegetation effect was relatively smaller than the climate impact at the country level and in most of river basins here we further assess the contribution of vegetation greening to hydrological changes over china using the percent contribution of lai that is estimated as the percentage of absolute elai of the sum of absolute main effects and interactive effects on annual mean hydrological variables at the grid cell scale fig 6 in general the vegetation greening played a dominant role in changes of et and runoff in north china including the yellow hai and huai river basins the increases in lai have led to a decline in runoff due to increased et however the vegetation effects on runoff appeared to be less sensitive than that on et as shown in southwest china with higher percent contribution of vegetation to et than that to runoff fig 6 there were 15 6 grid cells over the whole country with relatively high vegetation contribution 40 to interannual variation of et whereas the corresponding regions for runoff were 8 5 over china the regions with high vegetation contribution to et and runoff have also shown a significant greening trend during the growing season from april to october figure s4 as shown in fig 6 the regions with high impact of vegetation on runoff were mainly located in semi arid regions the humid regions with significant greening trend figure s4 did not show high vegetation contribution most 20 to runoff changes yet such as the yangtze pearl and southeast river basins the divergent response of runoff to vegetation change in different climatic zones indicated the vegetation greening appeared to have greater impacts on runoff in drier regions 4 discussion 4 1 evaluation results our simulation experiments showed that climate change is the main driver of hydrologic change at the national scale during the period 1982 2012 with vegetation effect being notable at the regional scale fig 5 at the pixel scale precipitation had a positive effect on et and runoff while the pet exhibited a positive effect on et but a negative impact on runoff fig 4b the vegetation also showed a positive effect on et but a negative impact on runoff over nearly 87 of grid cells fig 4b over china which is consistent with previous findings bai et al 2020 liu et al 2016 at regional scale the vegetation impacts on hydrologic cycle could be offset by climate effects fig 5 we found that the precipitation induced increase in runoff canceled out the runoff reduction due to vegetation induced et enhancement in the huai river basin fig 5 we suggest that the vegetation and climate impacts on the regional hydrology is spatial scale dependent and show high spatial heterogeneity li et al 2018 liu et al 2016 the regions in which vegetation change has a relatively high contribution 40 fig 6b to hydrologic cycle were mainly located in the yellow hai huai river basins north plain loess plateau and parts of southwest china having a drastic change in lai this was likely attributed to the implementation of multiple large scale ecosystem restoration programs by chinese government such as the three north forest shelterbelt program the natural forest conservation program and the grain for green program chen et al 2015 zhang et al 2016 however the percent contributions of vegetation to hydrologic cycle were remarkably lower in parts of the humid region southeast china fig 6 having a substantial vegetation greening figure s4 the vegetation effects on hydrologic cycle are more sensitive in water limited areas ai aridity index 1 figure s6 for example it was concluded that land cover changes in non humid regions ai 1 can result in greater hydrological responses our simulations showed a significant correlation r 0 52 p 0 01 between percent contribution of vegetation to runoff change and the absolute linear trend of lai in water limited regions ai 1 while the correlation turned to be relatively low r 0 19 p 0 01 in energy limited regions ai 1 our findings highlighted that vegetation change plays a greater role in regulating the water cycle in water limited regions bai et al 2019 bai et al 2020 liu et al 2016 sun et al 2006 zhang et al 2017 zhou et al 2015 in water limited environments with low precipitation but high atmospheric evaporation demand forests normally develop deeper and larger root systems to access more soil water to survive zhou et al 2015 potentially leading to exacerbation of water scarcity bai et al 2020 this finding has important implications for developing ecological restoration policy in water limited regions we therefore suggest that afforestation should be undertaken by accounting for the potential negative effects of vegetation on water resources availability especially in water limited regions in light of the model parameterization and validation with a variety of observation based constrains our findings of differentiated effects of climate change and vegetation greening on the hydrological cycle across the mainland china provide crucial information for water resources management and ecological restoration at the regional scale 4 2 limitations there are several limitations worth mentioning in this study first the hydrological model used in this study did not account for the anthropogenic effect on water cycle such as reservoir operation and human water withdrawals this may lead to uncertainties to the hydrological simulation in areas with strong anthropogenic impacts then the pml model used in this study did not address the effect of co2 on canopy resistance which may underestimate canopy resistance as the rising co2 could cause increases in canopy resistance milly and dunne 2016 yang et al 2019 but the effect could be relatively slight when it is reflected in the change in hydrologic process bai et al 2020 the detrending experiment was conducted with the assumption that other landscape properties other than vegetation are constant during the study period that is we hypothesized that vegetation was the only landscape factor that influenced the spatiotemporal variability of hydrological variables however this assumption may not valid in areas with dramatic changes in land use such as the burned forest lands and degraded permafrost areas which could significantly alter the soil and or topographic characteristics resulting in changes in hydrological process nevertheless it was reported that areas where land use has changes substantially over the last three decades accounted for only a small portion about 3 of china s land area liu et al 2014 it should be noted that it is impossible to completely decouple the effects of climate change and vegetation greening on hydrologic cycle due to the close biophysical interactions and feedbacks between climate and vegetation zhang et al 2021 recent studies argued that the vegetation feedbacks to climate precipitation could partly offset a greening induced dramatic reduction in water yield and soil moisture li et al 2018 zeng et al 2018a zeng et al 2018b the greening induced et enhancement increases atmospheric water vapor content resulting in promotion of downwind precipitation teuling et al 2017 van der ent et al 2010 the increased precipitation from vegetation greening supplied enough water to offset enhanced et and consequently weakening the soil dryness in north china li et al 2018 we also provided the contribution of climate and vegetation to hydrologic cycle including the soil moisture content figure s7 over four sub regions used in li et al 2018 in north china the annual mean precipitation has increased by 8 2 mm table s2 here we found the reduction of soil moisture 2 3 mm by lai and 2 1 mm by pet figure s7b due to increased lai 0 123 m3 m3 table s2 and pet 53 9 mm table s2 could not be offset by the positive soil moisture response 0 6 mm figure s7b to increased precipitation our study implemented a distributed hydrological modeling using the dtvgm pml model at a high spatial resolution 0 25 with satisfied model validation performance pertaining to runoff et and soil moisture at grid scale and streamflow at watershed scale this boosts confidence in our national wide hydrological modeling and subsequent attribution analyses we recognize that our offline model simulations could not disentangle the feedback effects from vegetation greening on climate compared with the coupled land atmosphere global climate models however the incorporation of the hydrological model with the remotely sensed et algorithm simplified the parameter estimation of the model avoiding some issues involved by complex hydrological models such as overparameterization and high requirements on memory and forcing data to further address the complex interactions and feedbacks between climate and vegetation future land atmosphere coupled modeling could also be strengthened by achieving more accurate modeling of precipitation and soil moisture credit authorship contribution statement zhihong song conceptualization software writing original draft jun xia supervision resources writing review editing gangsheng wang conceptualization methodology writing review editing dunxian she supervision investigation writing review editing chen hu software validation shilong piao writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was funded by the national natural science foundation of china grant no 41890823 the fundamental research funds for central public welfare research institutes grant no cksf2023298 sz the national key r d program of china grant no 2017yfa0603702 the excellent young scientists fund and the national natural science foundation of china grant no u21a20156 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129519 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
1992,china leads the world in vegetation greening and accounts for one fourth of the global net increase in leaf area over the past two decades however it remains elusive on the relative importance of vegetation greening and climate change on china s hydrological cycle due to the lack of observational based constraints on notorious model uncertainties here we developed a process based distributed hydrological model that couples a nonlinear runoff generation mechanism with a remotely sensed evapotranspiration et module this model could well capture the spatiotemporal patterns of the main hydrological components runoff et and soil moisture at grid scale and streamflow at watershed scale during 1982 2012 over the mainland china we show that the changes in climatic factors precipitation and potential et dominated hydrologic change at the national scale with climate induced runoff decrease by 7 6 mm year 1 compared to 0 6 mm year 1 caused by vegetation change vegetation effect was primarily notable in water limited regions as a higher correlation between vegetation contribution to runoff change and absolute leaf area index lai trend in water limited regions r 0 52 p 0 01 than energy limited regions r 0 19 p 0 01 our results highlight the significance of region dependent differential measures for sustainable water resources management and climate change adaptation under a changing climate keywords vegetation greening climate change china hydrologic cycle data availability data will be made available on request 1 introduction china leads the world in vegetation greening and has contributed 25 of the global net increase in leaf area chen et al 2019 peng et al 2011 piao et al 2015 mainly through croplands and large scale ecosystem restoration programs such as the three north forest shelterbelt program the natural forest conservation program and the grain for green program chen et al 2015 zhang et al 2016 this anthropogenic revegetation could enhance carbon sequestration by increasing net primary productivity npp du et al 2021 which is beneficial to carbon neutrality before 2060 in china wang et al 2021 but evidence is emerging that vegetation greening could also lead to a decline in runoff and soil moisture due to increased evapotranspiration et especially in the arid region of china bai et al 2020 brown et al 2005 li et al 2018 liu et al 2016 zeng et al 2018a zeng et al 2018b this negative effect of vegetation greening on the hydrological water cycle could potentially enhance conflicting demands for water between the ecosystem and human feng et al 2016 and exacerbate water scarcity in these arid regions resulting in a more uneven distribution of water resources in china bai et al 2019 bai et al 2020 liu et al 2016 sun et al 2006 zhang et al 2017 zhou et al 2015 therefore it is crucial to assess the impacts of vegetation greening on regional hydrology for water sources management and sustainable social development in china previous studies using land surface models lsms ivanov et al 2008 li et al 2018 xi et al 2018 zeng et al 2018a zeng et al 2018b to investigate the vegetation effects on hydrologic processes have difficulties in model parameterization calibration and validation due to high model complexity and computational cost model complexity is an important issue that hinders such models from being applied on a large scale ma and szilagyi 2019 therefore it is valuable to develop simple conceptual hydrological model incorporated vegetation dynamics to accurately simulate hydrologic processes in response to climate and vegetation changes moreover previous researches have been mostly restricted to assessing vegetation impacts without simultaneously considering the effects of climate change including precipitation and potential evapotranspiration and there is high spatial heterogeneity in vegetation impacts on hydrologic cycle across china bai et al 2019 li et al 2018 for example in the past several decades there is a strong warming over china featuring a faster warming rate in northern china than in southern china and precipitation changes instead showed an increased contrast between northeastern and southern china ding et al 2007 piao et al 2010 it remains unexplored whether and where the vegetation greening has a greater control on regional hydrology compared to the drastic climatic change occurring in the past several decades here we developed a process based distributed hydrological model that couples a time variant nonlinear runoff generation mechanism with a remotely sensing et module to quantify the respective effects of climate change and vegetation greening on terrestrial water cycle across china we implemented the model at a high spatial resolution 0 25 with model validation pertaining to runoff et and soil moisture at grid scale and streamflow at watershed scale on the basis of the well parameterized model we performed eight simulation experiments with observed or detrended forcing data climate forcing data and land surface data from 1982 to 2012 to quantify the contribution of climatic factors precipitation and potential et and vegetation lai to regional hydrology in china 2 materials and methods 2 1 forcing datasets the forcing datasets driving the hydrological model include climate data and land surface data the daily climate forcing variables were derived from the global land data assimilation system gldas rodell et al 2004 with a spatial resolution of 0 25 including wind speed temperature specific humidity pressure downward short wave and long wave radiation the precipitation we used in this study was the 0 25 gridded daily scale dataset of cn05 1 wu and gao 2013 based on interpolation from 2416 station observations in china the land surface variables leaf area index lai and albedo were derived from the 8 day composite 0 05 0 05 global land surface satellite glass product we resampled the 8 day composite data into the daily data by a piecewise cubic hermite polynomial and then smoothed by the savitzky golay filtering method fang et al 2008 li et al 2009 ruffin et al 2008 we used the monthly runoff data from the institute of geographic sciences and natural resources research igsnrr dataset for china produced by zhang et al 2014 and monthly et data from the global land evaporation amsterdam model gleam product martens et al 2017 for model calibration see model and experiments additionally we obtained observed daily streamflow from 30 watersheds for model validation over china fig 1 the observed streamflow data were derived from china s hydrological year book the observational soil moisture data were derived from gleam martens et al 2017 the saturate moisture content data used to calculate soil moisture in this study were obtained from liu et al 2020 we also used a global gridded runoff product called linear optimal runoff aggregate lora hobeichi et al 2019 to evaluate the performance of our simulation in producing the interannual variation in runoff at the country scale 2 2 model and experiments in our previous work song et al 2022 we have developed a hydrological model by incorporating the penman monteith leuning pml equation leuning et al 2008 into the distributed time variant gain model dtvgm wang et al 2009 xia et al 2005 named dtvgm pml figure s2 the dtvgm pml contains snow routine interception routine evapotranspiration routine and runoff routine and the gridded runoff simulated by the dtvgm pml was routed by the lohmann routing model lohmann et al 1996 for specific watersheds we performed a multi variable calibration framework to obtain optimal spatial parameters and ran the model at a daily time step for 1982 2012 with 1998 2012 as the calibration period and 1982 1997 as the validation period with a spatial resolution of 0 25 we used the shuffled complex evolution sce ua algorithm duan et al 1994 for model calibration see the detailed information in song et al 2022 in this study we switched the forcing data to the gldas forcing dataset combined with the precipitation from cn05 1 dataset to achieve better model performance especially in arid regions see results the dtvgm pml estimates et with full use of remote sensing vegetation information i e leaf area index and constrains et estimates within the water balance framework we performed the factor separation methodology bai et al 2019 zhang et al 2015 and designed eight simulation experiments table 1 to assess the contribution of climate and vegetation to the water cycle in china we selected three driving factors leaf area index lai precipitation p and potential evapotranspiration pet to represent the impact of vegetation and climate on hydrological variables the precipitation is the main supply of atmospheric water playing a key role in promoting global water cycle the pet was used to determine the combined impacts of temperature wind speed air vapor pressure and solar radiation on atmospheric demand for et zhang et al 2015 we applied the fao 56 penman monteith method allan et al 1998 recommended by the food and agriculture organisation of the united nations fao for pet estimation the lai describing plant canopy structure is an important indicator of radiation and precipitation interception energy conversion and water balance we generated detrended forcing data see detrending method in the supplementary material and then separately ran the hydrological model using the original and detrended forcing data to design different simulation experiments the control simulation sctl was the simulation driven by detrended variables following previous studies bai et al 2019 luo et al 2008 we examined main and interactive effects of three factors p pet and lai the main effects referred to changes in hydrological variables et or runoff in response to treatments of single factor for example the main effect of lai e lai is 1 e lai f l a i f c o n t r o l the two way interactive effect was the subtraction of the main effects from the effect of the joint treatment between two factors for example the two way interactive effect of lai and p e lai p is calculated as formula 2 the two way interactive effect and the three way interactive effect could be interpreted as the second order or higher order terms in multi point taylor expansion bai et al 2019 for instance the positive interactive effect on et between p and lai assuming both increasing trends can be explained by the fact that rising p increased water availability and increasing lai intensified vegetation transpiration the joint treatment would reinforce the evapotranspiration leading to positive interaction 2 e lai p f l a i p f c o n t r o l e lai e p the three way interactive effect among p pet and lai is the subtraction of the effect of the joint p pet and lai treatment from all the combined two way interactive effects and main effects of the three factors and was calculated by 3 e lai p p e t f l a i p p e t f c o n t r o l e lai e p e pet e lai p e lai p e t e p p e t the contribution of vegetation greening c veg to hydrological changes is estimated as the percentage of absolute e lai of the sum of absolute main effects and interactive effects on annual mean hydrological variables at each grid cell 4 c veg f l a i f c o n t r o l f l a i p p e t f c o n t r o l e lai e lai e p e pet e lai p e lai p e t e p p e t e lai p p e t 3 results 3 1 model evaluation we compared the performance in grid by grid runoff and evapotranspiration et simulation between models driven by china meteorological forcing dataset cmfd and global land data assimilation system gldas combined with gauge based cn05 1 precipitation figure s3 presents the cumulative density function cdf plots of the kling gupta efficiency kge metric values for runoff and et simulation using the two forcing datasets in the validation period over four climatic zones the gldas forcing data apparently outperformed the cmfd data in runoff simulation especially in arid regions fig s3a the performance in et simulation was also slightly improved when driving the dtvgm pml with gldas data compared with the cmfd data in the previous work song et al 2022 additionally we used observational streamflow on 30 hydrological stations fig 1 to validate the performance of simulated runoff and et by the gldas driven dtvgm pml fig 2 a d we calculated three statistical criteria nse kge and pbias on each hydrological station for monthly streamflow validation the results showed good agreement between the simulated and observed streamflow and the median statistical metrics were nse 0 84 kge 0 78 and pbias 6 55 respectively fig 2a c regarding the et simulation we applied the water balance method to obtain the mean annual et i e the difference between mean annual precipitation and runoff in each watershed corresponding to the station the model could reasonably estimate the mean annual et in the 30 watersheds as the statistical metrics were nse 0 76 kge 0 75 and pbias 6 3 fig 2d moreover we specifically evaluated our model performance in estimating the soil moisture fig 2e which was not generally implemented in hydrological simulations the modeled soil moisture contents in our study were calculated as θ sat w w m where θ sat and w w m are the saturated moisture content and the relative soil moisture respectively at each gridcell our results could well reproduce the spatial pattern of soil moisture derived from the global land evaporation amsterdam model gleam product with a high spatial correlation coefficient of 0 73 p 0 01 in addition the ratio of spatial standard deviations sdr between dtvgm pml simulated and gleam derived soil moisture is 0 94 approaching 1 0 means better with a spatial taylor skill score tss of 0 56 demonstrating good modeling performance kwon et al 2018 taylor 2001 overall the dtvgm pml can reasonably simulate the spatiotemporal dynamics of various hydrological variables in china including runoff streamflow et and soil moisture which constitute a cornerstone for the subsequent attribution analyses we further validated the interannual variation in hydrological variables over china the dtvgm pml could reasonably reproduce the observed trend in hydrological variables runoff et and soil moisture over china from 1982 to 2012 fig 3 the simulated annual runoff anomalies closely followed the observed ones from runoff products r 0 96 p 0 001 for the igsnrr dataset r 0 84 p 0 001 for the lora dataset fig 3a at the inter annual timescale the model could generally capture the decreasing trend in annual runoff 1 06 mm year 2 p 0 07 from igsnrr dataset in contrast to runoff trends both the global land evaporation amsterdam model gleam product based 0 94 mm year 2 p 0 001 and simulated et 0 86 mm year 2 p 0 001 showed a significant increasing trend over china the dtvgm pml simulation could well reproduce the interannual variation of et from the gleam product r 0 69 p 0 001 fig 3b meanwhile the simulated soil moisture from dtvgm pml shows a significantly high correlation with the root zone gleam soil moisture dataset r 0 71 p 0 001 fig 3c the significant decreasing trend in annual soil moisture of the dtvgm pml simulation 0 07 m3m 3decade 1 p 0 001 was also consistent with that of the root zone gleam dataset 0 04 m3m 3decade 1 p 0 001 3 2 contribution of climate change and vegetation greening to regional hydrology across china we assessed the hydrological responses to changes in climate and vegetation across china fig 4 a shows the relative change in et and runoff between single factor simulations sl sp or se denoting actual lai precipitation p or potential et pet data and the control simulation sctl driven by detrended forcing data the lai changes contributed to around 15 increases in et and around 15 decreases in runoff in the yellow river basin and the p changes would result in a decrease of et and runoff by around 5 and above 15 in the yangtze river basin and the songliao river basin respectively the pet changes led to increases in et and decreases in runoff by around 10 across almost the whole country the spatial correspondence of changes in hydrological variables et or runoff and drivers lai p or pet is shown in fig 4b lai has a positive effect on et in the majority of grid cells including 62 1 of the grid cells having an increase in both lai and et and 26 0 having a decrease in both lai and et while the p and pet showed a positive effect on et across the whole region in contrast to et the impact of lai on runoff was negative in 86 5 of grid cells the runoff increases only appeared in 12 3 of areas with an increase in lai the p and pet showed a positive and negative effect on runoff over the whole region respectively we then summarized the contribution of climate change and vegetation greening to regional hydrology over the nine major basins of china we computed the main effect see materials and methods of the three driving factors lai p and pet on hydrological variables at each grid cell and the median contribution in each basin was shown in fig 5 in terms of the p induced hydrological changes a slight decline in p 7 5 mm year 1 table s1 contributed to decreases in both et 0 7 mm year 1 and runoff 2 2 mm year 1 the response of runoff to p changes was more sensitive than that of et for example in the pearl river basin in south china p change 19 6 mm year 1 led to a large decrease in runoff 26 5 mm year 1 but a slight decrease in et 1 7 mm year 1 similar results could also be found in humid and semi humid regions such as the yangtze river basin the southeast river basin the songliao river basin and the huai river basin the pet markedly increased across all river basins around 49 mm year 1 on average table s1 resulting in an increase in et and reduction in runoff especially in the southeast river basin 25 1 mm year 1 for et and 23 7 mm year 1 for runoff the contribution of pet changes to et was comparable to that to runoff as for the vegetation effects on hydrological variables increased lai 0 05 m3 m 3 enhanced the et by about 0 8 mm year 1 and decreased the runoff by 0 6 mm year 1 at the country level far less than the climate induced hydrological changes increased et by 6 7 mm year 1 and reduced runoff by 7 6 mm year 1 by changes in p and pet however the magnitude of vegetation impact was comparable to that of climate impact on runoff changes in both the yellow river basin 1 5 mm year 1 vs 1 2 mm year 1 and the hai river basin 3 1 mm year 1 vs 3 3 mm year 1 in the huai river basin with the largest lai changes 0 211 m3 m 3 table s1 among all the river basins the vegetation changes caused a relatively strong et increase 6 1 mm year 1 and runoff decrease 5 6 mm year 1 while the negative effect of vegetation greening on runoff could be totally offset by the increase in runoff 12 3 mm year 1 predominantly attributed to a large increase in precipitation leading to an overall increase in runoff the interactive effects on et and runoff were quite lower than the main effects figure s5 overall climate and vegetation impacts on regional hydrology showed strong spatial heterogeneity and the vegetation effect was relatively smaller than the climate impact at the country level and in most of river basins here we further assess the contribution of vegetation greening to hydrological changes over china using the percent contribution of lai that is estimated as the percentage of absolute elai of the sum of absolute main effects and interactive effects on annual mean hydrological variables at the grid cell scale fig 6 in general the vegetation greening played a dominant role in changes of et and runoff in north china including the yellow hai and huai river basins the increases in lai have led to a decline in runoff due to increased et however the vegetation effects on runoff appeared to be less sensitive than that on et as shown in southwest china with higher percent contribution of vegetation to et than that to runoff fig 6 there were 15 6 grid cells over the whole country with relatively high vegetation contribution 40 to interannual variation of et whereas the corresponding regions for runoff were 8 5 over china the regions with high vegetation contribution to et and runoff have also shown a significant greening trend during the growing season from april to october figure s4 as shown in fig 6 the regions with high impact of vegetation on runoff were mainly located in semi arid regions the humid regions with significant greening trend figure s4 did not show high vegetation contribution most 20 to runoff changes yet such as the yangtze pearl and southeast river basins the divergent response of runoff to vegetation change in different climatic zones indicated the vegetation greening appeared to have greater impacts on runoff in drier regions 4 discussion 4 1 evaluation results our simulation experiments showed that climate change is the main driver of hydrologic change at the national scale during the period 1982 2012 with vegetation effect being notable at the regional scale fig 5 at the pixel scale precipitation had a positive effect on et and runoff while the pet exhibited a positive effect on et but a negative impact on runoff fig 4b the vegetation also showed a positive effect on et but a negative impact on runoff over nearly 87 of grid cells fig 4b over china which is consistent with previous findings bai et al 2020 liu et al 2016 at regional scale the vegetation impacts on hydrologic cycle could be offset by climate effects fig 5 we found that the precipitation induced increase in runoff canceled out the runoff reduction due to vegetation induced et enhancement in the huai river basin fig 5 we suggest that the vegetation and climate impacts on the regional hydrology is spatial scale dependent and show high spatial heterogeneity li et al 2018 liu et al 2016 the regions in which vegetation change has a relatively high contribution 40 fig 6b to hydrologic cycle were mainly located in the yellow hai huai river basins north plain loess plateau and parts of southwest china having a drastic change in lai this was likely attributed to the implementation of multiple large scale ecosystem restoration programs by chinese government such as the three north forest shelterbelt program the natural forest conservation program and the grain for green program chen et al 2015 zhang et al 2016 however the percent contributions of vegetation to hydrologic cycle were remarkably lower in parts of the humid region southeast china fig 6 having a substantial vegetation greening figure s4 the vegetation effects on hydrologic cycle are more sensitive in water limited areas ai aridity index 1 figure s6 for example it was concluded that land cover changes in non humid regions ai 1 can result in greater hydrological responses our simulations showed a significant correlation r 0 52 p 0 01 between percent contribution of vegetation to runoff change and the absolute linear trend of lai in water limited regions ai 1 while the correlation turned to be relatively low r 0 19 p 0 01 in energy limited regions ai 1 our findings highlighted that vegetation change plays a greater role in regulating the water cycle in water limited regions bai et al 2019 bai et al 2020 liu et al 2016 sun et al 2006 zhang et al 2017 zhou et al 2015 in water limited environments with low precipitation but high atmospheric evaporation demand forests normally develop deeper and larger root systems to access more soil water to survive zhou et al 2015 potentially leading to exacerbation of water scarcity bai et al 2020 this finding has important implications for developing ecological restoration policy in water limited regions we therefore suggest that afforestation should be undertaken by accounting for the potential negative effects of vegetation on water resources availability especially in water limited regions in light of the model parameterization and validation with a variety of observation based constrains our findings of differentiated effects of climate change and vegetation greening on the hydrological cycle across the mainland china provide crucial information for water resources management and ecological restoration at the regional scale 4 2 limitations there are several limitations worth mentioning in this study first the hydrological model used in this study did not account for the anthropogenic effect on water cycle such as reservoir operation and human water withdrawals this may lead to uncertainties to the hydrological simulation in areas with strong anthropogenic impacts then the pml model used in this study did not address the effect of co2 on canopy resistance which may underestimate canopy resistance as the rising co2 could cause increases in canopy resistance milly and dunne 2016 yang et al 2019 but the effect could be relatively slight when it is reflected in the change in hydrologic process bai et al 2020 the detrending experiment was conducted with the assumption that other landscape properties other than vegetation are constant during the study period that is we hypothesized that vegetation was the only landscape factor that influenced the spatiotemporal variability of hydrological variables however this assumption may not valid in areas with dramatic changes in land use such as the burned forest lands and degraded permafrost areas which could significantly alter the soil and or topographic characteristics resulting in changes in hydrological process nevertheless it was reported that areas where land use has changes substantially over the last three decades accounted for only a small portion about 3 of china s land area liu et al 2014 it should be noted that it is impossible to completely decouple the effects of climate change and vegetation greening on hydrologic cycle due to the close biophysical interactions and feedbacks between climate and vegetation zhang et al 2021 recent studies argued that the vegetation feedbacks to climate precipitation could partly offset a greening induced dramatic reduction in water yield and soil moisture li et al 2018 zeng et al 2018a zeng et al 2018b the greening induced et enhancement increases atmospheric water vapor content resulting in promotion of downwind precipitation teuling et al 2017 van der ent et al 2010 the increased precipitation from vegetation greening supplied enough water to offset enhanced et and consequently weakening the soil dryness in north china li et al 2018 we also provided the contribution of climate and vegetation to hydrologic cycle including the soil moisture content figure s7 over four sub regions used in li et al 2018 in north china the annual mean precipitation has increased by 8 2 mm table s2 here we found the reduction of soil moisture 2 3 mm by lai and 2 1 mm by pet figure s7b due to increased lai 0 123 m3 m3 table s2 and pet 53 9 mm table s2 could not be offset by the positive soil moisture response 0 6 mm figure s7b to increased precipitation our study implemented a distributed hydrological modeling using the dtvgm pml model at a high spatial resolution 0 25 with satisfied model validation performance pertaining to runoff et and soil moisture at grid scale and streamflow at watershed scale this boosts confidence in our national wide hydrological modeling and subsequent attribution analyses we recognize that our offline model simulations could not disentangle the feedback effects from vegetation greening on climate compared with the coupled land atmosphere global climate models however the incorporation of the hydrological model with the remotely sensed et algorithm simplified the parameter estimation of the model avoiding some issues involved by complex hydrological models such as overparameterization and high requirements on memory and forcing data to further address the complex interactions and feedbacks between climate and vegetation future land atmosphere coupled modeling could also be strengthened by achieving more accurate modeling of precipitation and soil moisture credit authorship contribution statement zhihong song conceptualization software writing original draft jun xia supervision resources writing review editing gangsheng wang conceptualization methodology writing review editing dunxian she supervision investigation writing review editing chen hu software validation shilong piao writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was funded by the national natural science foundation of china grant no 41890823 the fundamental research funds for central public welfare research institutes grant no cksf2023298 sz the national key r d program of china grant no 2017yfa0603702 the excellent young scientists fund and the national natural science foundation of china grant no u21a20156 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129519 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
1993,sustainable aquifer management in coastal cities is becoming critically important due to the challenges of climate variability amidst population growth study of the aquifer heterogeneity is effective in highlighting the aquifer behavior in this study we took the case of beihai to explore the heterogeneity of its subsurface system 8629 samples from 111 boreholes were divided into four hydrofacies units as discrete geological variables according to their hydraulic conductivities k and used as input datasets for the models sequential indicator simulation sisim and transition probability geostatistical simulation t progs were employed to construct 3d hydrofacies stochastic models the simulated results realistically represent horizontal river driven sediment distribution and vertical deposition processes of k in the aquifer where the northeastern part is mainly composed of low k and the southern part forms the main multi layered aquifer system with progressively increasing medium and high k with a comparative analysis on the ability of capturing geological characteristics using both sisim and t progs it highlighted that sisim reduces initial data requirements without the need of gaussian transformation and is more broadly applicable while t progs prefers considering the internal correlation of hydrofacies units and is applicable in environments where lateral accumulation is prevalent this study demonstrates the credibility of stochastic simulation methods in recreating complex costal sedimentary environments which provide environment for further groundwater modeling and exploration multi interleaved source data and more accurate algorithms will be integrated in aquifer heterogeneity as subsequent research priorities keywords coastal aquifer heterogeneity geostatistical techniques hydrofacies units sedimentation processes beihai city data availability data will be made available on request 1 introduction coastal aquifers are major sources of freshwater in many parts of the world to better utilize this valuable resource there has been an increasing interest in research on the interpretation evaluation and vulnerability of coastal aquifers sung et al 2012 himi et al 2016 sahour et al 2020 stanly et al 2020 an important issue during these studies is the characterization of heterogeneity e g regional k caused by complex coastal sedimentation accurate portrayal of heterogeneity is of great significance because extensive studies have confirmed that from the micron scale to site scale dominant channels and low permeability zones produced by heterogeneity of sediments profoundly influence groundwater flow trends and velocities and also play a decisive role in solute diffusion and sorption serrano 1995 voutilainen et al 2017 allen king et al 1998 ma et al 2014 tinesh et al 2023 regrettably the consideration of aquifer heterogeneity is superficial in most cases eramian et al 1999 attempts have been made to include heterogeneity by equivalent homogenization or assigning typical parameters to the respective stratified zoning which may result in misinterpretation of groundwater resources nevertheless in areas with complex hydrogeological conditions jiang et al 2021 generally only a small portion of geologic information can be collected at regional scale due to high expenses and limited subsurface technology it is therefore essential to develop geo interpretation technique to characterize the regional heterogeneity accurately based on limited data geostatistical methods have been widely used to estimate the value of a particular attribute at complex hydrogeological conditions where high precision is required kitanidis and vomvoris 1983 illman et al 2009 2010 the methods mainly quantify the spatial distribution of geological parameters through spatial interpolation which accounts for the uncertainty of the estimated regionalized variables two prominent techniques which can generate a number of results in equal probability were employed in this work the sequential indicator simulation sisim and the transition probability geostatistical simulation t progs deutsch 1998 almeida 2010 the sequential indicator simulation sisim is a stochastic simulation method based on indicator variables with the advantage of effective statistical control on the geological setting at various local scales and satisfactory simulation accuracy this simulation has been successfully applied to simulate the geology of sedimentary basins and other environments such as alluvial deposits volcanic materials and deltaic deposits alabert 1987 gego et al 2001 ouellon et al 2008 serrano et al 2014 medina ortega et al 2019 xue et al 2022 to correct the sporadic and unstructured small scale variations that may present in the results of sisim method deutsch and journel 1997 the post processing method such as categorical transformation algorithm transcat lukjan and chalermyanont 2017 and maximum a posteriori selection goovaerts 1996 has been developed furthermore the transition probability geostatistical simulation t progs is becoming more popular because of its ability to describe complex transition relationships among different facies langousis et al 2018 it was first proposed by carle and fogg 1996 1997 and extended by weissmann et al 1999 while other theoretical improvements continued in the following decades park et al 2007 2010 this method has been widely used in the simulation of braided river space distribution felletti et al 2006 alluvial fans facies distribution fleckenstein et al 2010 as well as glacial riverine depositional systems proce et al 2004 in china t progs has been employed to explore in the downstream alluvial catchment of the yellow river alluvial and the west liao he plain jin 2009 sun 2019 both sisim and t progs have their own advantages on the simulation process and applicable environment dell arciprete 2012 and efforts have been made to compare the results obtained from different simulation methods lee et al 2007 bastante et al 2008 some studies have shown that the t progs can capture some key spatial features that are missed by sisim with the same accuracy despite their wide use in the characterization of different scales for various catchment areas reports on their application for three dimensional 3d characterization of aquifer heterogeneity on coastal regional scale is limited amadi et al 2014 kurunc et al 2016 accordingly a coastal aquifer situated in beihai city in south china is the focus of this study the study location is underlain by a typical coastal aquifer with surface deltas and other coastal geomorphic settings it is important to note that large scale groundwater abstraction in beihai city has led to some environmental challenges such as depleting groundwater supply deteriorating water quality and seawater intrusion zhou et al 1997 wu et al 2018 in addition poor attention to the heterogeneity of the aquifer in this area has made the results of groundwater resources estimation unreliable xia and li 2009 consequently geostatistical techniques are proposed to elucidate and characterize the heterogeneity of the aquifer as well as the depositional environment to provide a reliable basis for sustainable groundwater protection and management in this study 3d models showing the heterogeneity of the hydrofacies were constructed using sisim and t progs the models were employed to reveal the spatial structure of the aquifer system in beihai city to provide an extensive dataset for making informed groundwater investigations by combining the model results with the actual deposition processes in the study area this study validates the simulation results and highlights the significance of 3d geological modeling based on geostatistical methods in exploring the complex sedimentary environment of coastal areas moreover in depth comparative analysis is performed for the two methods utilized we further elucidate the applicable environments for the t progs in conjunction with sedimentological principles all of these results and analyses can support a relatively accurate heterogeneity environment for beihai in depth groundwater flow and solute transport studies as well as the decision making processes in the applications of stochastic based geostatistical methods in similar coastal and sedimentary environments around the world 2 location and geology 2 1 location and geographic setting beihai is located in guangxi zhuang autonomous region southern china with geographical coordinates between 108 49 109 77 e longitude and 20 39 21 92 n latitude fig 1 a the region covers a land area of about 3989 km2 and a sea area of 3008 km2 located near the eastern parts of the north bay beihai is an important port city and fishery breeding base in south china as being surrounded by the sea on three sides the average altitude of beihai is 10 15 m which is highest in the northeast and lowest in the southwest the northeast is bounded mainly by hills 100 120 m a s l the middle catchment comprises of alluvia diluvial plains and river terraces where rivers such as the nanliu river the main river of beihai flow across and discharge into the sea depositing mixed alluvial marine mixing sediments the coastal areas to the south are overlain by deltas forming floodplains which are defined by the impact of fluvial and tidal action this interaction generates the formation of mixed sediments in coastal zones fig 1b the terrain is generally flat and slopes slightly towards the sea zhou 1997 the nankang basin is a sub catchment of beihai city that is the focus area of this study nankang basin is approximately 1021 km2 comprising of a series of hydrologic subdomains traversed by fengjia nankang and other rivers trending downstream towards the sea these rivers and strong tidal action contribute to the formation of a complex sedimentary strata in the study area fig 1b 2 2 geological and hydrogeological conditions almost all of the surface exposures in the study area are mixed alluvial marine quaternary sediments qhg most of the cretaceous quartz sandstone as basement rock strata serve as a relative water barrier substrate and only sporadically sporadic outcrops on the southwest side as a bedrock shore the upper part of the substrate is covered by a loose multi layered structure of neoproterozoic quaternary with an unconfined aquifer qp 2 b and three confined aquifers i qp 1 z ii n 2 sh and iii n 1 h superimposed from top to bottom the aquifers are mainly composed of sand and gravelly sand and interspersed with aquitard and aquiclude composed of sandy clay and clayey soil the basic information of several aquifers is shown in table 1 note that confined aquifers i qp 1 z and ii n 2 sh have similar characteristics and close hydraulic connections which are the most important pumping aquifers with the maximum rate of a single well output of 5000 m3 d the confined aquifer iii n 1 h exists mainly as a reservoir aquifer because it becomes less permeable compared to the upper aquifer xue 1983 zhou et al 2007 the groundwater distribution in the study area shows an overall trend of scarcity in the north and abundance in the south fig 1c the source of groundwater recharge here includes mainly precipitation and lateral recharge from surface water during the flood season from june to september controlled by the regional topography the groundwater is confined while the phreatic aquifers have similar directions to the surface water i e generally from the north to the south with discharge to the north bay it should be noted that compared to the natural discharge pumping has contributed to most of the local groundwater discharge 3 materials and methods 3 1 dataset for this work borehole data were collected from the wuhan geological survey center of china geological survey cgs including lithological information from 8 629 samples taken from 111 boreholes fig 2 b for the geostatistical modeling 10 geologic types are identified and coded according to grain gradation and plasticity index and are listed in table 2 in which unconsolidated sediments were further simplified into three hydrofacies units according to the hydraulic conductivity k hydrofacies unit 1 hfu 1 2 hfu 2 and 3 hfu 3 represent the classes with high moderate and low k which are specified as 1 m d 1 10 3 m d and 10 3 m d respectively cgs 2012 hydrofacies unit 4 hfu 4 is the base mainly hard and compact quartz sandstone of the cretaceous for the only cemented geologic types in fig 2b the vertical resolution in the definition of hydrofacies units was set to be equal to 1 m subsequent simulations were all based on the above hydrofacies units classification results 3 2 methods 3 2 1 sequential indicator simulation sisim the sisim is implemented by following these steps 1 collating and analyzing the data required for the simulation 2 fitting the applicable theoretical model to the experimental indicator semi variogram 3 rendering of models and proper post processing it should be noted that the organization of our data and the rational division of the hydrofacies units were introduced in the previous section the fitting of the experimental and theoretical semi variogram functions provides the necessary parametric basis for sisim as their structural and stochastic nature can also reflect the distribution characteristics of k here the horizontal and vertical experimental semi variogram were used to assess the spatial effect of each hydrofacies unit except for the basement hfu 4 and to quantify its spatial variability the basic formula for computing the experimental indicator semi variogram is expressed as 1 γ h 1 2 n h i 1 n h z x i z x i h 2 where γ h is the experimental variogram n h is the pair number h is the lag distance between two sample points z xi stands for hydrofacies units the calculated indicator semi variogram is then fitted to theoretical semi variogram functions gaussian gs spherical sp and exponential ex model to obtain deterministic parameters nugget effect c0 sill cs and correlation length λ h with the above parameters the sequential indicator simulation can be rendered and equation 2 shows the computational code for the simulation process where huf k stands for 4 hydrofacies unit mentioned previously the coupling of the four indicator simulation results constitutes the overall spatial geometry of the stratigraphic sedimentary facies 2 i u hfu k 1 if u i u hfu k 0 otherwise for k 1 2 3 4 the grid needed for the simulation has a total size of 60 km 40 km 200 m a fine configuration grid was used as 600 400 200 in the y and z directions respectively 48 000 000 cells and each cell size is 100 100 1 m this grid resolution was chosen to ensure maximum reproduction of the true conditions within the borehole to make the model results more realistic transcat was used as a post processor to fit the features that apply to the riverine impact deposition and coastal plains as well as to match the initial proportions while preserving the simulated patterns 3 2 2 transition probability geostatistical simulation t progs the t progs simulation is typically implemented by following these steps 1 calculating the vertical transfer probability 2 constructing the 3d markov model 3 visualizing the model and post processing of the simulated annealing the dataset is organized following the classification method of the hydrofacies units described above the calculation of the vertical transfer between hydrofacies units from the bottom to the top of the borehole is the basis of the simulation to balance the simulation efficiency and accuracy calculations were performed with an interval of 5 m next a 3d markov chain model was constructed by combining the vertical transfer probability chain with the fitted vertical markov chain in which the horizontal markov chain was obtained by walter s law li 2011 in the process of fitting the vertical markov chain the discrete transfer probability method was selected because of the large quantity and high accuracy of vertical upward drilling data the error of subjective factors caused by human intervention was also reduced the computational formula for it is presented as 3 t jk h p k i 1 k 1 z jk j 1 e ln β i 1 δ h δ h h due to the lack of horizontal links between boreholes the horizontal markov chains were obtained by a parsimonious and efficient embedding transfer ratio matrix once the 3d markov chain model is constructed three dimensional hydrofacies unit structure models can be constructed simulated annealing algorithm iterations are used simultaneously to improve the accuracy of simulations the formulation is 4 min o l 1 m j 1 k k 1 k t jk h l sim t jk h l mod 2 where o is the objective function hl denotes the determined step vector sim and mod represent the measured and simulated transfer probabilities respectively the grid was set at 200 200 80 cells in the y and z directions 3 200 000 cells with limitations from the software running memory all the procedures described above including the exploratory data analysis and simulations running and post processing were implemented using a group of software arcgis arcgis 10 5 gslib matlab matlab 2018b sgems sgems x64 t progs gms gms 10 4 deutsch and journel 1997 carle 1999 remy et al 2009 4 results and discussion 4 1 modeling hydrofacies models by sisim 4 1 1 indicator semi variograms experimental indicator semi variograms were calculated for each hydrofacies unit except for the hfu 4 in the horizontal 0 and 90 and vertical directions which were then fitted to three theoretical semi variograms ex gs and sp from fig 3 and table 3 the hfu 3 has the longest spatial correlation 2210 m compared to 750 m of hfu 1 and 1900 m of hfu 2 in λ h as well as the smallest spatial variability 0 12 comparing 0 2 for hfu 1 and 0 13 for hfu 2 in cs in the 0 direction this indicates that the low permeability layer clay layer extends stably in this direction the spatial correlation between hfu 1 and hfu 2 in the 90 direction and is greater than that of hfu 3 1400 m of hfu 1 and 1450 m of hfu 2 compared to 1000 for hfu 3 in λ h while in spatial variability hfu 1 0 3 hfu 2 0 2 hfu 3 0 14 which indicates that in this direction the low permeability layer clay layer is more stable but less continuous than hfu 1 and hfu 2 it is also inferred that the influence range and the degree of spatial variability of each hydrofacies unit differed significantly in different directions to better reflect the spatial variability in the horizontal direction anisotropic rose diagrams were plotted based on the calculated λ h and cs as shown in fig 4 and table 4 all three hydrofacies units exhibit significant anisotropy with hfu 1 and hfu 2 characterized by zonal anisotropy while hfu 3 exhibits geometric anisotropy besides all three hydrofacies units have two sets of main directions the primary direction is near n s and the secondary one is near e w and the degree of variation cs in the n s direction is lower than that in the e w direction indicating that the n s direction is more stable than the e w direction fig 1b shows that n20w s20e is the main direction of the rivers flowing into the sea in the study area impacts of dynamic changes in geological conditions on the properties of hydrofacies units are expected to be stronger along the direction of the river on the other hand n80e s80e is approximately in the seaward direction of nanliu river the main surface water system of beihai fig 1b and it affects the sedimentary environment of the study area as well moreover in the rose diagram of cs the variability of hfu 3 is the lowest and almost equally spreads in all directions presumably because the clay and silt particles have large coefficients of viscosity and are therefore resistant to hydrodynamic effects the variability of λ h in the vertical variance function curves among different hydrofacies units is mainly influenced by the aquifer thickness and lithological position the results of the experimental semi variograms and the fitted theoretical models in the vertical direction are shown in fig 5 and table 3 all three semi variogram curves exhibit the hole effect while hfu 2 presents a pore effect model without sill which may be caused by the periodic alternation of sedimentary sequences the period of the deposition rhyme can be seen to fluctuate between 5 m and 30 m or even more with a large degree in fig 5 such drastic fluctuations prove the complexity of the depositional environment in the area 4 1 2 stochastic simulation of hydrofacies based on the parameters obtained from the indicator semi variogram function models multiple equiprobable realizations of hydrofacies models were simulated using sisim from fig 6 and table 5 the output percentage of hfu 2 hfu 3 and hfu 4 18 6 22 63 and 13 83 is higher than the input data 14 521 20 767 and 9 642 except for hfu 1 44 94 whose proportion is smaller than the input one 55 07 such disagreement indicates that the model results differ from the initial input the poor connectivity and disorderly structure among the hydrofacies units also make it difficult to accurately reflect the complex sediment distribution of the coastal aquifer in the study area therefore there was a need to conduct post processing to make the simulation more compatible with the original hard data and the actual deposition conditions by combining sisim with the post processing operation transcat simulation results closely matched to the original input ratio with improved connectivity than previous ones without post processing fig 7 and table 5 the percentage of hfu 1 in the optimized model results increased from 44 94 to 54 01 and the other three hydrofacies units decreased moderately decreased by 3 28 2 52 and 3 28 of hfu 2 hfu 3 and hfu 4 the resulting error between input and output is a maximum of 1 06 4 2 modeling hydrofacies models by t progs given the indicator semi variogram function and simulation principle sisim targets at spatial reproduction of a single hydrofacies unit and neglects the transition process of each hydrofacies unit in the stratigraphic space which is exactly what the transfer probability geostatistical simulation t progs can solve 4 2 1 three dimensional markov chain the transfer probabilities of the 5 m interval were chosen as parameters and the terms in the transfer probability matrix were elliptically interpolated in the vertical direction and fitted with vertical markov chains as shown in fig 8 and table 6 as the self transfer the results of the average thickness of the hydrofacies units reflected by the simulation in the vertical direction are more specifically represented hfu 4 representing the foundation rocks was the thickest within the borehole accessible range as for the sediments there is a general pattern that hfu 1 is the thickest followed by hfu 2 and hfu 3 is the thinnest according to the calculated vertical transfer probability the transfer from these hydrofacies units to hfu 4 is trivial this implies that there is very little transition from other sediments to solidification in the upward vertical direction which is consistent with the actual depositional processes additionally the horizontal markov chain as well as the parameters such as the average extension length were obtained in table 7 the transfer probability did not differ much in the x direction from the y direction in the same direction except for the diagonal element the transfer of the hydrofacies unit itself the sum of the three horizontal elements in each group is equal to 1 hfu 2 hfu 3 have a clear transfer preference to hfu 1 0 6883 and 0 9133 in the horizontal direction and there is no transfer to hfu 4 4 2 2 stochastic simulation of hydrofacies units after obtaining three dimensional markov chain models and decision information the conditional simulation is performed to generate the hydrogeological structure model one of the representative results is shown in fig 9 the results show that the hydrofacies units in the model are well connected which can represent the heterogeneity of the region very well the reflected sedimentary environment results are similar to the above results indicating that the 3d geological model obtained based on transfer probability geostatistics can also reflect the sedimentary characteristics of the strata it is worth mentioning that although the mesh profile of this simulation is coarse the error of the obtained results is also within a manageable range 4 3 discussion on the veracity of model results the results of the simulation were compared against the descriptive geological information of this area such as the historical depositional environment and the external dynamic geology in the vertical deposition process the crust rose and the seawater withdrew from the area due to neotectonic movement at the late neoproterozoic to the quaternary cang et al 1992 influenced by the distinctly wet and dry pattern of the paleoclimate the surface water runoff is highly variable which exacerbates the complexity of sedimentary processes and sedimentation rate firstly it should be noted that during the neoproterozoic to middle quaternary the climate experienced a shift from relatively dry to humid and then back to dry environments which led to a dramatic increase followed by a slow decrease in the intensity of surface runoff as the modeling results indicate hfu 2 and hfu 3 middle low permeability layer occupy a large proportion in the bottom of the model mainly watertight top plates of n 1 h upward n 2 sh qp 1 z hfu 1 high permeability layer increases and gradually becomes the dominant aquifer structure then it gradually decreases figs 7 and 9 and in this aquifer system hfu 2 and hfu 3 exist intermittently as aquitard and aquiclude respectively secondly there are some specific depositional characteristics during each depositional period for example qp 1 z forms multiple coarse lower and fine upper sedimentary rhythms and qp 2 b has binary structure which is visible in simulation results that hfu 1 is gradually interbedded in hfu 2 and hfu 3 last but not least the late pleistocene strata is missing in beihai because of the external dynamic geological effects and by the holocene the deposition rate becomes faster due to wetter climate greater runoff and stronger hydrochemical weathering as the resulting well sorted fine sand layers were formed which is why the top uniform layer is the hfu 1 mainly exists in models the modeling results accurately reflect the historical depositional characteristics which proves that the vertical simulation results are trustworthy fig 10 in the horizontal direction simulation results match the local depositional environment as well firstly the hilly region in northeastern beihai has thick bedrock and unconsolidated sediments of clay due to the strong external dynamic geological effects such as weathering erosion and transport this part is almost impermeable due to bedrock fractures with a small and irregular hydraulic conductivity the modeling results indicate that hfu 4 distributes mainly over a large area in the northeastern part covered with thick layers of hfu 3 as unconsolidated sediments and gradually becomes thinning out from north to south besides in the central south plain area lateral accumulation is prevalent due to river impact resulting in stratigraphic and hydrofacies unit changes in different extensional directions exhibiting significant differences and time penetration the anisotropy of the horizontal indicator semi variogram function is visible and it can also be seen that hydrofacies units all tend to tilt towards the sea fig 11 last the closer to the sea the stronger the tidal energy geology and near the coast hydrodynamic geology action is intense resulting in coarser and poorer sorting of the sediment layer particles the model results show hfu 2 and hfu 3 is widely distributed in the whole study region but gradually becomes thinner from inland to coastal areas while hfu 1 is gradually becoming thicker toward the seaside and most developed in the southwest part of the study area figs 7 and 9 4 4 comparison of two simulation methods results both sisim and t progs can effectively reproduce the aquifer characteristics and ensure the continuity of the relatively scarce units however there are differences between the two methods in terms of intrinsic mechanism applicable environment and grid dissection first of all sisim mainly describes the variable length and variability distribution of a single hydrofacies unit in a complex space while t progs focuses on the transfer probability migration rate and juxtaposition between different hydrofacies units vertically speaking of the simulation processes sisim uses the semi variogram function to provide a preliminary interpretation of the regional spatial distribution characteristics and reduces the requirement for raw data by no need for a gaussian transformation the anisotropy study of the semi variogram function in the horizontal direction can reflect the main deposition direction characterized by lateral accumulation which cannot be captured by markov chain simulations in t progs fig 4 in the vertical direction the vertical indicator semi variogram in sisim qualitatively describes the periodic nature of the hydrofacies units spatial correlation while the vertical markov chain in t progs can reflect the single layer thickness and the interconversion of each hydrofacies unit in the sedimentary strata fig 8 the two methods also differ in terms of their applicable environment sisim has a wider range of applicability because the indicator semi variogram function mainly defines primarily the correlation of regional variables being more integrated with sedimentological principles t progs has more limitations regarding the applicable environment the basic principle used in fitting the horizontal markov chain is the walther facies law which is based on lateral accumulation hence t progs is suitable for scenarios where lateral accumulation is prevalent like coastal lakeside riparian zone delta and continental slopes on the other hand in areas with vertical accumulation the superposition and adjacency of the formed sedimentary facies do not obey the walther facies law and t progs is not recommended in these areas because the horizontal markov chain principle no longer holds sisim and t progs use different scale of grids during the simulation due to different maximum computation loads of software mentioned in materials and methods for better comparison dell arciprete et al 2012 introduced a critical parameter in simulations which was the ratio between the number of samples and the number of simulated grids with a large number of simulations with both coarse grids t progs with a ratio of 0 00270 and fine grids sisim with a ratio of 0 00018 it was found that all the simulation hydrofacies units have a realistic spatial continuity and the use of fine grids does not significantly improve the shape and trends of the hydrofacies units in the model from this perspective and combining with the change rate of simulations inputs and outputs tables 5 and 6 link and integration of the geostatistical and other software etc t progs is friendlier to the convenience and operational efficiency in the subsequent water flow and solute transport studies 4 5 limitations and future prospects it is noteworthy that the simulations of regional heterogeneity rely heavily on completeness and accuracy of data nevertheless it is impossible to accurately profile every detail of the actual formation in this study the simulation uncertainty is higher in the northern part of the study area compared to the south due to the decrease of data figs 2 7 and 9 generally compared with deterministic models stochastic simulations e g sisim and t progs provide a variety of equal probability models which largely overcome model uncertainty due to incomplete data assert the probability of occurrence of each hydrofacies unit in the region effectively by means of statistical principles to further reduce the error the number of simulations can be increased while it is inevitable to lead to an increasing computational effort accordingly besides limitations do exist in sisim and t progs based on their principles i e both methods do not reproduce well the special features at small scales e g secondary stratification features erosion bases etc under coarse grained stochastic models they are also difficult to characterize geological bodies with complex spatial structures and nonlinear correlation structures e g curved surfaces folds etc looking beyond the results obtained in this study multi interleaved source site data e g groundwater level data pollutant concentration data etc will be collected to further verify the accuracy of the simulation results non smooth multi point geostatistical methods he 2021 and machine learning which transform the problem of 3d modeling of strata into the problem of classifying attributes of spatial raster cells should receive attention in describing the spatial variability of aquifer in future research in addition regional groundwater flow and contaminant transport simulations will be conducted based on current heterogeneity simulations to validate and calibrate the datasets and deepen regional groundwater interpretation 5 conclusions in this study 8629 samples from 111 boreholes in beihai city were fully utilized and divided into 4 hydrological units with k as the main reference factor multiple 3d hydrological models were established using sisim and t progs a comparative analysis was also performed for the two methods in characterizing the heterogeneity of aquifer the main outcomes of the study are summarized as follows 1 both sisim and t progs can generate multiple realizations with equal probability successfully in alluvial marine depositional systems combined with the deposition environment the modeling results realistically reproduce the spatial distribution of each hydrofacies unit in the study area where exists lateral accumulation due to land sea transition environment and vertical deposition in the form of multi layered formation which verifies the superiority of the simulation methods simulation results show that the northeastern part is bedrock and clay mainly composed of hfu 4 and hfu 3 and the southern part is groundwater enrichment areas the aquifer system is composed of shallow unconfined aquifer mainly hfu 1 and slight hfu 3 intermediate confined aquifer a large amount of hfu 1 and slight hfu 2 and lowermost deep confined aquifer mainly composed of hfu 2 and hfu 3 and slight hfu 1 2 the two simulation methods capture geological characteristics from varying perspectives due to their inherent differences in principle in general sisim accurately defines the sedimentation distribution characteristics and the length of the hydrofacies bodies reduces the requirements of initial data without the need of gaussian transformation which enables it to be applied to varying depositional environments whereas t progs considers the transfer probability among hydrofacies units and is only applicable where lateral accumulation is prevalent due to the limitations of the principle is proposed walter s law 3 in response to the limited data and capability in modelling the heterogeneity of geological bodies at a high resolution aquifer heterogeneity can be developed and applicated in more accurate simulation algorithms combining multi interleaved source site data non stationary geostatistics and machine learning in the future overall the results obtained from this work contribute to improving our understanding of the nature of the subsurface aquifer in beihai city to provide a reliable basis for sustainable groundwater research and protection in addition the comparative analysis of the geostatistical methods supports the decision making processes on the applications of stochastic based geostatistical methods to estimate aquifer heterogeneity in similar coastal and sedimentary environments of the world credit authorship contribution statement keyu gong conceptualization methodology writing original draft zhang wen resources writing review editing qinghua li supervision data curation qi zhu formal analysis writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was partially supported by the national natural science foundation of china grant numbers 42022018 42272290 and 41830862 we would like to thank dr hamza jakada for polishing the english of this paper and we are equally grateful to the editor dr corrado corradini the associate editor and two anonymous reviewers for their constructive comments which helped us improve the quality of the paper 
1993,sustainable aquifer management in coastal cities is becoming critically important due to the challenges of climate variability amidst population growth study of the aquifer heterogeneity is effective in highlighting the aquifer behavior in this study we took the case of beihai to explore the heterogeneity of its subsurface system 8629 samples from 111 boreholes were divided into four hydrofacies units as discrete geological variables according to their hydraulic conductivities k and used as input datasets for the models sequential indicator simulation sisim and transition probability geostatistical simulation t progs were employed to construct 3d hydrofacies stochastic models the simulated results realistically represent horizontal river driven sediment distribution and vertical deposition processes of k in the aquifer where the northeastern part is mainly composed of low k and the southern part forms the main multi layered aquifer system with progressively increasing medium and high k with a comparative analysis on the ability of capturing geological characteristics using both sisim and t progs it highlighted that sisim reduces initial data requirements without the need of gaussian transformation and is more broadly applicable while t progs prefers considering the internal correlation of hydrofacies units and is applicable in environments where lateral accumulation is prevalent this study demonstrates the credibility of stochastic simulation methods in recreating complex costal sedimentary environments which provide environment for further groundwater modeling and exploration multi interleaved source data and more accurate algorithms will be integrated in aquifer heterogeneity as subsequent research priorities keywords coastal aquifer heterogeneity geostatistical techniques hydrofacies units sedimentation processes beihai city data availability data will be made available on request 1 introduction coastal aquifers are major sources of freshwater in many parts of the world to better utilize this valuable resource there has been an increasing interest in research on the interpretation evaluation and vulnerability of coastal aquifers sung et al 2012 himi et al 2016 sahour et al 2020 stanly et al 2020 an important issue during these studies is the characterization of heterogeneity e g regional k caused by complex coastal sedimentation accurate portrayal of heterogeneity is of great significance because extensive studies have confirmed that from the micron scale to site scale dominant channels and low permeability zones produced by heterogeneity of sediments profoundly influence groundwater flow trends and velocities and also play a decisive role in solute diffusion and sorption serrano 1995 voutilainen et al 2017 allen king et al 1998 ma et al 2014 tinesh et al 2023 regrettably the consideration of aquifer heterogeneity is superficial in most cases eramian et al 1999 attempts have been made to include heterogeneity by equivalent homogenization or assigning typical parameters to the respective stratified zoning which may result in misinterpretation of groundwater resources nevertheless in areas with complex hydrogeological conditions jiang et al 2021 generally only a small portion of geologic information can be collected at regional scale due to high expenses and limited subsurface technology it is therefore essential to develop geo interpretation technique to characterize the regional heterogeneity accurately based on limited data geostatistical methods have been widely used to estimate the value of a particular attribute at complex hydrogeological conditions where high precision is required kitanidis and vomvoris 1983 illman et al 2009 2010 the methods mainly quantify the spatial distribution of geological parameters through spatial interpolation which accounts for the uncertainty of the estimated regionalized variables two prominent techniques which can generate a number of results in equal probability were employed in this work the sequential indicator simulation sisim and the transition probability geostatistical simulation t progs deutsch 1998 almeida 2010 the sequential indicator simulation sisim is a stochastic simulation method based on indicator variables with the advantage of effective statistical control on the geological setting at various local scales and satisfactory simulation accuracy this simulation has been successfully applied to simulate the geology of sedimentary basins and other environments such as alluvial deposits volcanic materials and deltaic deposits alabert 1987 gego et al 2001 ouellon et al 2008 serrano et al 2014 medina ortega et al 2019 xue et al 2022 to correct the sporadic and unstructured small scale variations that may present in the results of sisim method deutsch and journel 1997 the post processing method such as categorical transformation algorithm transcat lukjan and chalermyanont 2017 and maximum a posteriori selection goovaerts 1996 has been developed furthermore the transition probability geostatistical simulation t progs is becoming more popular because of its ability to describe complex transition relationships among different facies langousis et al 2018 it was first proposed by carle and fogg 1996 1997 and extended by weissmann et al 1999 while other theoretical improvements continued in the following decades park et al 2007 2010 this method has been widely used in the simulation of braided river space distribution felletti et al 2006 alluvial fans facies distribution fleckenstein et al 2010 as well as glacial riverine depositional systems proce et al 2004 in china t progs has been employed to explore in the downstream alluvial catchment of the yellow river alluvial and the west liao he plain jin 2009 sun 2019 both sisim and t progs have their own advantages on the simulation process and applicable environment dell arciprete 2012 and efforts have been made to compare the results obtained from different simulation methods lee et al 2007 bastante et al 2008 some studies have shown that the t progs can capture some key spatial features that are missed by sisim with the same accuracy despite their wide use in the characterization of different scales for various catchment areas reports on their application for three dimensional 3d characterization of aquifer heterogeneity on coastal regional scale is limited amadi et al 2014 kurunc et al 2016 accordingly a coastal aquifer situated in beihai city in south china is the focus of this study the study location is underlain by a typical coastal aquifer with surface deltas and other coastal geomorphic settings it is important to note that large scale groundwater abstraction in beihai city has led to some environmental challenges such as depleting groundwater supply deteriorating water quality and seawater intrusion zhou et al 1997 wu et al 2018 in addition poor attention to the heterogeneity of the aquifer in this area has made the results of groundwater resources estimation unreliable xia and li 2009 consequently geostatistical techniques are proposed to elucidate and characterize the heterogeneity of the aquifer as well as the depositional environment to provide a reliable basis for sustainable groundwater protection and management in this study 3d models showing the heterogeneity of the hydrofacies were constructed using sisim and t progs the models were employed to reveal the spatial structure of the aquifer system in beihai city to provide an extensive dataset for making informed groundwater investigations by combining the model results with the actual deposition processes in the study area this study validates the simulation results and highlights the significance of 3d geological modeling based on geostatistical methods in exploring the complex sedimentary environment of coastal areas moreover in depth comparative analysis is performed for the two methods utilized we further elucidate the applicable environments for the t progs in conjunction with sedimentological principles all of these results and analyses can support a relatively accurate heterogeneity environment for beihai in depth groundwater flow and solute transport studies as well as the decision making processes in the applications of stochastic based geostatistical methods in similar coastal and sedimentary environments around the world 2 location and geology 2 1 location and geographic setting beihai is located in guangxi zhuang autonomous region southern china with geographical coordinates between 108 49 109 77 e longitude and 20 39 21 92 n latitude fig 1 a the region covers a land area of about 3989 km2 and a sea area of 3008 km2 located near the eastern parts of the north bay beihai is an important port city and fishery breeding base in south china as being surrounded by the sea on three sides the average altitude of beihai is 10 15 m which is highest in the northeast and lowest in the southwest the northeast is bounded mainly by hills 100 120 m a s l the middle catchment comprises of alluvia diluvial plains and river terraces where rivers such as the nanliu river the main river of beihai flow across and discharge into the sea depositing mixed alluvial marine mixing sediments the coastal areas to the south are overlain by deltas forming floodplains which are defined by the impact of fluvial and tidal action this interaction generates the formation of mixed sediments in coastal zones fig 1b the terrain is generally flat and slopes slightly towards the sea zhou 1997 the nankang basin is a sub catchment of beihai city that is the focus area of this study nankang basin is approximately 1021 km2 comprising of a series of hydrologic subdomains traversed by fengjia nankang and other rivers trending downstream towards the sea these rivers and strong tidal action contribute to the formation of a complex sedimentary strata in the study area fig 1b 2 2 geological and hydrogeological conditions almost all of the surface exposures in the study area are mixed alluvial marine quaternary sediments qhg most of the cretaceous quartz sandstone as basement rock strata serve as a relative water barrier substrate and only sporadically sporadic outcrops on the southwest side as a bedrock shore the upper part of the substrate is covered by a loose multi layered structure of neoproterozoic quaternary with an unconfined aquifer qp 2 b and three confined aquifers i qp 1 z ii n 2 sh and iii n 1 h superimposed from top to bottom the aquifers are mainly composed of sand and gravelly sand and interspersed with aquitard and aquiclude composed of sandy clay and clayey soil the basic information of several aquifers is shown in table 1 note that confined aquifers i qp 1 z and ii n 2 sh have similar characteristics and close hydraulic connections which are the most important pumping aquifers with the maximum rate of a single well output of 5000 m3 d the confined aquifer iii n 1 h exists mainly as a reservoir aquifer because it becomes less permeable compared to the upper aquifer xue 1983 zhou et al 2007 the groundwater distribution in the study area shows an overall trend of scarcity in the north and abundance in the south fig 1c the source of groundwater recharge here includes mainly precipitation and lateral recharge from surface water during the flood season from june to september controlled by the regional topography the groundwater is confined while the phreatic aquifers have similar directions to the surface water i e generally from the north to the south with discharge to the north bay it should be noted that compared to the natural discharge pumping has contributed to most of the local groundwater discharge 3 materials and methods 3 1 dataset for this work borehole data were collected from the wuhan geological survey center of china geological survey cgs including lithological information from 8 629 samples taken from 111 boreholes fig 2 b for the geostatistical modeling 10 geologic types are identified and coded according to grain gradation and plasticity index and are listed in table 2 in which unconsolidated sediments were further simplified into three hydrofacies units according to the hydraulic conductivity k hydrofacies unit 1 hfu 1 2 hfu 2 and 3 hfu 3 represent the classes with high moderate and low k which are specified as 1 m d 1 10 3 m d and 10 3 m d respectively cgs 2012 hydrofacies unit 4 hfu 4 is the base mainly hard and compact quartz sandstone of the cretaceous for the only cemented geologic types in fig 2b the vertical resolution in the definition of hydrofacies units was set to be equal to 1 m subsequent simulations were all based on the above hydrofacies units classification results 3 2 methods 3 2 1 sequential indicator simulation sisim the sisim is implemented by following these steps 1 collating and analyzing the data required for the simulation 2 fitting the applicable theoretical model to the experimental indicator semi variogram 3 rendering of models and proper post processing it should be noted that the organization of our data and the rational division of the hydrofacies units were introduced in the previous section the fitting of the experimental and theoretical semi variogram functions provides the necessary parametric basis for sisim as their structural and stochastic nature can also reflect the distribution characteristics of k here the horizontal and vertical experimental semi variogram were used to assess the spatial effect of each hydrofacies unit except for the basement hfu 4 and to quantify its spatial variability the basic formula for computing the experimental indicator semi variogram is expressed as 1 γ h 1 2 n h i 1 n h z x i z x i h 2 where γ h is the experimental variogram n h is the pair number h is the lag distance between two sample points z xi stands for hydrofacies units the calculated indicator semi variogram is then fitted to theoretical semi variogram functions gaussian gs spherical sp and exponential ex model to obtain deterministic parameters nugget effect c0 sill cs and correlation length λ h with the above parameters the sequential indicator simulation can be rendered and equation 2 shows the computational code for the simulation process where huf k stands for 4 hydrofacies unit mentioned previously the coupling of the four indicator simulation results constitutes the overall spatial geometry of the stratigraphic sedimentary facies 2 i u hfu k 1 if u i u hfu k 0 otherwise for k 1 2 3 4 the grid needed for the simulation has a total size of 60 km 40 km 200 m a fine configuration grid was used as 600 400 200 in the y and z directions respectively 48 000 000 cells and each cell size is 100 100 1 m this grid resolution was chosen to ensure maximum reproduction of the true conditions within the borehole to make the model results more realistic transcat was used as a post processor to fit the features that apply to the riverine impact deposition and coastal plains as well as to match the initial proportions while preserving the simulated patterns 3 2 2 transition probability geostatistical simulation t progs the t progs simulation is typically implemented by following these steps 1 calculating the vertical transfer probability 2 constructing the 3d markov model 3 visualizing the model and post processing of the simulated annealing the dataset is organized following the classification method of the hydrofacies units described above the calculation of the vertical transfer between hydrofacies units from the bottom to the top of the borehole is the basis of the simulation to balance the simulation efficiency and accuracy calculations were performed with an interval of 5 m next a 3d markov chain model was constructed by combining the vertical transfer probability chain with the fitted vertical markov chain in which the horizontal markov chain was obtained by walter s law li 2011 in the process of fitting the vertical markov chain the discrete transfer probability method was selected because of the large quantity and high accuracy of vertical upward drilling data the error of subjective factors caused by human intervention was also reduced the computational formula for it is presented as 3 t jk h p k i 1 k 1 z jk j 1 e ln β i 1 δ h δ h h due to the lack of horizontal links between boreholes the horizontal markov chains were obtained by a parsimonious and efficient embedding transfer ratio matrix once the 3d markov chain model is constructed three dimensional hydrofacies unit structure models can be constructed simulated annealing algorithm iterations are used simultaneously to improve the accuracy of simulations the formulation is 4 min o l 1 m j 1 k k 1 k t jk h l sim t jk h l mod 2 where o is the objective function hl denotes the determined step vector sim and mod represent the measured and simulated transfer probabilities respectively the grid was set at 200 200 80 cells in the y and z directions 3 200 000 cells with limitations from the software running memory all the procedures described above including the exploratory data analysis and simulations running and post processing were implemented using a group of software arcgis arcgis 10 5 gslib matlab matlab 2018b sgems sgems x64 t progs gms gms 10 4 deutsch and journel 1997 carle 1999 remy et al 2009 4 results and discussion 4 1 modeling hydrofacies models by sisim 4 1 1 indicator semi variograms experimental indicator semi variograms were calculated for each hydrofacies unit except for the hfu 4 in the horizontal 0 and 90 and vertical directions which were then fitted to three theoretical semi variograms ex gs and sp from fig 3 and table 3 the hfu 3 has the longest spatial correlation 2210 m compared to 750 m of hfu 1 and 1900 m of hfu 2 in λ h as well as the smallest spatial variability 0 12 comparing 0 2 for hfu 1 and 0 13 for hfu 2 in cs in the 0 direction this indicates that the low permeability layer clay layer extends stably in this direction the spatial correlation between hfu 1 and hfu 2 in the 90 direction and is greater than that of hfu 3 1400 m of hfu 1 and 1450 m of hfu 2 compared to 1000 for hfu 3 in λ h while in spatial variability hfu 1 0 3 hfu 2 0 2 hfu 3 0 14 which indicates that in this direction the low permeability layer clay layer is more stable but less continuous than hfu 1 and hfu 2 it is also inferred that the influence range and the degree of spatial variability of each hydrofacies unit differed significantly in different directions to better reflect the spatial variability in the horizontal direction anisotropic rose diagrams were plotted based on the calculated λ h and cs as shown in fig 4 and table 4 all three hydrofacies units exhibit significant anisotropy with hfu 1 and hfu 2 characterized by zonal anisotropy while hfu 3 exhibits geometric anisotropy besides all three hydrofacies units have two sets of main directions the primary direction is near n s and the secondary one is near e w and the degree of variation cs in the n s direction is lower than that in the e w direction indicating that the n s direction is more stable than the e w direction fig 1b shows that n20w s20e is the main direction of the rivers flowing into the sea in the study area impacts of dynamic changes in geological conditions on the properties of hydrofacies units are expected to be stronger along the direction of the river on the other hand n80e s80e is approximately in the seaward direction of nanliu river the main surface water system of beihai fig 1b and it affects the sedimentary environment of the study area as well moreover in the rose diagram of cs the variability of hfu 3 is the lowest and almost equally spreads in all directions presumably because the clay and silt particles have large coefficients of viscosity and are therefore resistant to hydrodynamic effects the variability of λ h in the vertical variance function curves among different hydrofacies units is mainly influenced by the aquifer thickness and lithological position the results of the experimental semi variograms and the fitted theoretical models in the vertical direction are shown in fig 5 and table 3 all three semi variogram curves exhibit the hole effect while hfu 2 presents a pore effect model without sill which may be caused by the periodic alternation of sedimentary sequences the period of the deposition rhyme can be seen to fluctuate between 5 m and 30 m or even more with a large degree in fig 5 such drastic fluctuations prove the complexity of the depositional environment in the area 4 1 2 stochastic simulation of hydrofacies based on the parameters obtained from the indicator semi variogram function models multiple equiprobable realizations of hydrofacies models were simulated using sisim from fig 6 and table 5 the output percentage of hfu 2 hfu 3 and hfu 4 18 6 22 63 and 13 83 is higher than the input data 14 521 20 767 and 9 642 except for hfu 1 44 94 whose proportion is smaller than the input one 55 07 such disagreement indicates that the model results differ from the initial input the poor connectivity and disorderly structure among the hydrofacies units also make it difficult to accurately reflect the complex sediment distribution of the coastal aquifer in the study area therefore there was a need to conduct post processing to make the simulation more compatible with the original hard data and the actual deposition conditions by combining sisim with the post processing operation transcat simulation results closely matched to the original input ratio with improved connectivity than previous ones without post processing fig 7 and table 5 the percentage of hfu 1 in the optimized model results increased from 44 94 to 54 01 and the other three hydrofacies units decreased moderately decreased by 3 28 2 52 and 3 28 of hfu 2 hfu 3 and hfu 4 the resulting error between input and output is a maximum of 1 06 4 2 modeling hydrofacies models by t progs given the indicator semi variogram function and simulation principle sisim targets at spatial reproduction of a single hydrofacies unit and neglects the transition process of each hydrofacies unit in the stratigraphic space which is exactly what the transfer probability geostatistical simulation t progs can solve 4 2 1 three dimensional markov chain the transfer probabilities of the 5 m interval were chosen as parameters and the terms in the transfer probability matrix were elliptically interpolated in the vertical direction and fitted with vertical markov chains as shown in fig 8 and table 6 as the self transfer the results of the average thickness of the hydrofacies units reflected by the simulation in the vertical direction are more specifically represented hfu 4 representing the foundation rocks was the thickest within the borehole accessible range as for the sediments there is a general pattern that hfu 1 is the thickest followed by hfu 2 and hfu 3 is the thinnest according to the calculated vertical transfer probability the transfer from these hydrofacies units to hfu 4 is trivial this implies that there is very little transition from other sediments to solidification in the upward vertical direction which is consistent with the actual depositional processes additionally the horizontal markov chain as well as the parameters such as the average extension length were obtained in table 7 the transfer probability did not differ much in the x direction from the y direction in the same direction except for the diagonal element the transfer of the hydrofacies unit itself the sum of the three horizontal elements in each group is equal to 1 hfu 2 hfu 3 have a clear transfer preference to hfu 1 0 6883 and 0 9133 in the horizontal direction and there is no transfer to hfu 4 4 2 2 stochastic simulation of hydrofacies units after obtaining three dimensional markov chain models and decision information the conditional simulation is performed to generate the hydrogeological structure model one of the representative results is shown in fig 9 the results show that the hydrofacies units in the model are well connected which can represent the heterogeneity of the region very well the reflected sedimentary environment results are similar to the above results indicating that the 3d geological model obtained based on transfer probability geostatistics can also reflect the sedimentary characteristics of the strata it is worth mentioning that although the mesh profile of this simulation is coarse the error of the obtained results is also within a manageable range 4 3 discussion on the veracity of model results the results of the simulation were compared against the descriptive geological information of this area such as the historical depositional environment and the external dynamic geology in the vertical deposition process the crust rose and the seawater withdrew from the area due to neotectonic movement at the late neoproterozoic to the quaternary cang et al 1992 influenced by the distinctly wet and dry pattern of the paleoclimate the surface water runoff is highly variable which exacerbates the complexity of sedimentary processes and sedimentation rate firstly it should be noted that during the neoproterozoic to middle quaternary the climate experienced a shift from relatively dry to humid and then back to dry environments which led to a dramatic increase followed by a slow decrease in the intensity of surface runoff as the modeling results indicate hfu 2 and hfu 3 middle low permeability layer occupy a large proportion in the bottom of the model mainly watertight top plates of n 1 h upward n 2 sh qp 1 z hfu 1 high permeability layer increases and gradually becomes the dominant aquifer structure then it gradually decreases figs 7 and 9 and in this aquifer system hfu 2 and hfu 3 exist intermittently as aquitard and aquiclude respectively secondly there are some specific depositional characteristics during each depositional period for example qp 1 z forms multiple coarse lower and fine upper sedimentary rhythms and qp 2 b has binary structure which is visible in simulation results that hfu 1 is gradually interbedded in hfu 2 and hfu 3 last but not least the late pleistocene strata is missing in beihai because of the external dynamic geological effects and by the holocene the deposition rate becomes faster due to wetter climate greater runoff and stronger hydrochemical weathering as the resulting well sorted fine sand layers were formed which is why the top uniform layer is the hfu 1 mainly exists in models the modeling results accurately reflect the historical depositional characteristics which proves that the vertical simulation results are trustworthy fig 10 in the horizontal direction simulation results match the local depositional environment as well firstly the hilly region in northeastern beihai has thick bedrock and unconsolidated sediments of clay due to the strong external dynamic geological effects such as weathering erosion and transport this part is almost impermeable due to bedrock fractures with a small and irregular hydraulic conductivity the modeling results indicate that hfu 4 distributes mainly over a large area in the northeastern part covered with thick layers of hfu 3 as unconsolidated sediments and gradually becomes thinning out from north to south besides in the central south plain area lateral accumulation is prevalent due to river impact resulting in stratigraphic and hydrofacies unit changes in different extensional directions exhibiting significant differences and time penetration the anisotropy of the horizontal indicator semi variogram function is visible and it can also be seen that hydrofacies units all tend to tilt towards the sea fig 11 last the closer to the sea the stronger the tidal energy geology and near the coast hydrodynamic geology action is intense resulting in coarser and poorer sorting of the sediment layer particles the model results show hfu 2 and hfu 3 is widely distributed in the whole study region but gradually becomes thinner from inland to coastal areas while hfu 1 is gradually becoming thicker toward the seaside and most developed in the southwest part of the study area figs 7 and 9 4 4 comparison of two simulation methods results both sisim and t progs can effectively reproduce the aquifer characteristics and ensure the continuity of the relatively scarce units however there are differences between the two methods in terms of intrinsic mechanism applicable environment and grid dissection first of all sisim mainly describes the variable length and variability distribution of a single hydrofacies unit in a complex space while t progs focuses on the transfer probability migration rate and juxtaposition between different hydrofacies units vertically speaking of the simulation processes sisim uses the semi variogram function to provide a preliminary interpretation of the regional spatial distribution characteristics and reduces the requirement for raw data by no need for a gaussian transformation the anisotropy study of the semi variogram function in the horizontal direction can reflect the main deposition direction characterized by lateral accumulation which cannot be captured by markov chain simulations in t progs fig 4 in the vertical direction the vertical indicator semi variogram in sisim qualitatively describes the periodic nature of the hydrofacies units spatial correlation while the vertical markov chain in t progs can reflect the single layer thickness and the interconversion of each hydrofacies unit in the sedimentary strata fig 8 the two methods also differ in terms of their applicable environment sisim has a wider range of applicability because the indicator semi variogram function mainly defines primarily the correlation of regional variables being more integrated with sedimentological principles t progs has more limitations regarding the applicable environment the basic principle used in fitting the horizontal markov chain is the walther facies law which is based on lateral accumulation hence t progs is suitable for scenarios where lateral accumulation is prevalent like coastal lakeside riparian zone delta and continental slopes on the other hand in areas with vertical accumulation the superposition and adjacency of the formed sedimentary facies do not obey the walther facies law and t progs is not recommended in these areas because the horizontal markov chain principle no longer holds sisim and t progs use different scale of grids during the simulation due to different maximum computation loads of software mentioned in materials and methods for better comparison dell arciprete et al 2012 introduced a critical parameter in simulations which was the ratio between the number of samples and the number of simulated grids with a large number of simulations with both coarse grids t progs with a ratio of 0 00270 and fine grids sisim with a ratio of 0 00018 it was found that all the simulation hydrofacies units have a realistic spatial continuity and the use of fine grids does not significantly improve the shape and trends of the hydrofacies units in the model from this perspective and combining with the change rate of simulations inputs and outputs tables 5 and 6 link and integration of the geostatistical and other software etc t progs is friendlier to the convenience and operational efficiency in the subsequent water flow and solute transport studies 4 5 limitations and future prospects it is noteworthy that the simulations of regional heterogeneity rely heavily on completeness and accuracy of data nevertheless it is impossible to accurately profile every detail of the actual formation in this study the simulation uncertainty is higher in the northern part of the study area compared to the south due to the decrease of data figs 2 7 and 9 generally compared with deterministic models stochastic simulations e g sisim and t progs provide a variety of equal probability models which largely overcome model uncertainty due to incomplete data assert the probability of occurrence of each hydrofacies unit in the region effectively by means of statistical principles to further reduce the error the number of simulations can be increased while it is inevitable to lead to an increasing computational effort accordingly besides limitations do exist in sisim and t progs based on their principles i e both methods do not reproduce well the special features at small scales e g secondary stratification features erosion bases etc under coarse grained stochastic models they are also difficult to characterize geological bodies with complex spatial structures and nonlinear correlation structures e g curved surfaces folds etc looking beyond the results obtained in this study multi interleaved source site data e g groundwater level data pollutant concentration data etc will be collected to further verify the accuracy of the simulation results non smooth multi point geostatistical methods he 2021 and machine learning which transform the problem of 3d modeling of strata into the problem of classifying attributes of spatial raster cells should receive attention in describing the spatial variability of aquifer in future research in addition regional groundwater flow and contaminant transport simulations will be conducted based on current heterogeneity simulations to validate and calibrate the datasets and deepen regional groundwater interpretation 5 conclusions in this study 8629 samples from 111 boreholes in beihai city were fully utilized and divided into 4 hydrological units with k as the main reference factor multiple 3d hydrological models were established using sisim and t progs a comparative analysis was also performed for the two methods in characterizing the heterogeneity of aquifer the main outcomes of the study are summarized as follows 1 both sisim and t progs can generate multiple realizations with equal probability successfully in alluvial marine depositional systems combined with the deposition environment the modeling results realistically reproduce the spatial distribution of each hydrofacies unit in the study area where exists lateral accumulation due to land sea transition environment and vertical deposition in the form of multi layered formation which verifies the superiority of the simulation methods simulation results show that the northeastern part is bedrock and clay mainly composed of hfu 4 and hfu 3 and the southern part is groundwater enrichment areas the aquifer system is composed of shallow unconfined aquifer mainly hfu 1 and slight hfu 3 intermediate confined aquifer a large amount of hfu 1 and slight hfu 2 and lowermost deep confined aquifer mainly composed of hfu 2 and hfu 3 and slight hfu 1 2 the two simulation methods capture geological characteristics from varying perspectives due to their inherent differences in principle in general sisim accurately defines the sedimentation distribution characteristics and the length of the hydrofacies bodies reduces the requirements of initial data without the need of gaussian transformation which enables it to be applied to varying depositional environments whereas t progs considers the transfer probability among hydrofacies units and is only applicable where lateral accumulation is prevalent due to the limitations of the principle is proposed walter s law 3 in response to the limited data and capability in modelling the heterogeneity of geological bodies at a high resolution aquifer heterogeneity can be developed and applicated in more accurate simulation algorithms combining multi interleaved source site data non stationary geostatistics and machine learning in the future overall the results obtained from this work contribute to improving our understanding of the nature of the subsurface aquifer in beihai city to provide a reliable basis for sustainable groundwater research and protection in addition the comparative analysis of the geostatistical methods supports the decision making processes on the applications of stochastic based geostatistical methods to estimate aquifer heterogeneity in similar coastal and sedimentary environments of the world credit authorship contribution statement keyu gong conceptualization methodology writing original draft zhang wen resources writing review editing qinghua li supervision data curation qi zhu formal analysis writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was partially supported by the national natural science foundation of china grant numbers 42022018 42272290 and 41830862 we would like to thank dr hamza jakada for polishing the english of this paper and we are equally grateful to the editor dr corrado corradini the associate editor and two anonymous reviewers for their constructive comments which helped us improve the quality of the paper 
1994,increasing the effective urban water storage capacity is one of a range of solutions to mitigate heat issues and flooding in urban areas and vegetation plays an important role in it in this study the regional scale water storage capacity of four city clusters in china during the period 2009 2018 was estimated based on a four source evapotranspiration et model incorporated with urban water storage capacity s estimated on the basis of daily et recession our results showed that simulated et was consistent with four flux towers r2 0 57 rmse 1 45 mm d the spatial distribution of s was similar to that of et and ranged from 2 to 28 mm the influence of environmental drivers on the spatial pattern of s was explored using a machine learning technique and the relative contribution of lai leaf area index to the spatial pattern of s ranged from 11 59 to 27 56 the effect of vegetation change on s in urban and non urban areas showed an opposite relationship to the lai change however the effect on s in urban and non urban areas was reversed when vegetation was expanded to 1 25 times the existing mean owing to the increase in vegetation dominating the change in urban eb soil evaporation to a greater degree than for non urban eb urban areas in beijing tianjin hebei the yangtze river delta pearl river delta and chengdu chongqing would need to increase existing vegetation by 10 32 32 and 28 respectively to store additional precipitation above the mean annual precipitation in high precipitation years this study provides a new mechanistic understanding of the effects of vegetation change on water consumption in urban ecosystems allowing the role of urban ecological planning in urban flood mitigation to be quantified keywords water storage capacity evapotranspiration urban ecosystem vegetation change impervious surface data availability data will be made available on request 1 introduction unlike natural ecosystems urban ecosystems include a large proportion of artificially modified impervious surfaces such as roofs pavements and concrete or asphalt roads ramamurthy and bou zeid 2014 zhang et al 2018a wang et al 2020 changes in urban impervious surfaces lead to changes in surface energy and water balance bonan et al 2011 shao et al 2022b an increase in impervious surfaces leads to increased surface runoff generation and promotes the rapid passage of surface runoff through ground and drainage systems hollis 1975 arnold and gibbons 1996 smith et al 2005 suriya and mudgal 2012 limiting the water resources available for urban evapotranspiration et avissar 1992 arnold and gibbons 1996 fletcher et al 2013 manoli et al 2020 and producing an indirect urban heat island effect taha 1997 zhao et al 2014 installing impervious services also increases urban flooding which is a serious concern for urban residents and limits sustainable urban development wilby 2007 boggs and sun 2011 hamdi et al 2011 tingsanchali 2012 zhang et al 2018a several solutions have been proposed to address urban water and energy balance including water sensitive urban design wong 2006 low impact development gilroy and mccuen 2009 sponge cities mhurd 2014 gaines 2016 and natural solutions somarakis et al 2019 which all have the ability to promote an increase in urban water storage capacity one of the numerous nature based solutions to enhance urban water storage capacity and mitigate the negative impacts of urban impervious surfaces is to increase urban vegetation or install other green infrastructure li et al 2020 increased urban vegetation can play an important role in improving thermal comfort and regulating the urban hydrological cycle ennos 2010 owing to the fact that canopy transpiration is an important source of atmospheric moisture and one of the key partitions of et pielke 2005 shao et al 2022b in addition vegetation can reduce runoff through interception and improved infiltration and thus vegetation is essential for further improving retention kuehler et al 2017 vegetation restores storage capacity by transferring the stored water back to the atmosphere through et thom et al 2020 given the importance of vegetation to water storage capacity teuling et al 2006 the planning of urban vegetation schemes has become more exacting in an attempt to improve urban water storage capacity therefore it is important to assess the effects of different vegetation characteristics on urban water storage in the context of et to better address the issue of urban water balance estimating urban water storage capacity remains challenging owing to the inherent heterogeneity of the urban surface a method for estimating effective urban water storage using et recession during periods without precipitation was proposed by jongen et al 2022 urban effective water storage is defined as the dynamic water storage available to the atmosphere for et and includes soil moisture intercepted precipitation groundwater and open water from lakes and sinkholes jongen et al 2022 the jongen et al 2022 method is able to overcome the heterogeneity of the urban surface and quantify the urban water storage capacity directly based on et however it uses et measured by urban eddy covariance ec to estimate the effective water storage reflecting all sources of et from impervious surfaces vegetation and open water this cannot isolate differences caused by the proportion of urban vegetation from those caused by climate furthermore the limited number of observation sites makes it difficult to explain differences between cities modelled et offers the possibility to address these limitations the priestley taylor jet propulsion laboratory pt jpl model is widely used to estimate et fisher et al 2008 it is based on a relatively new eco physiological model with advantages including excellent performance and relatively few ground measurement requirements michel et al 2016 shao et al 2019 the pt jpl model is not only applicable to natural surfaces with the ability to simulate transpiration et soil evaporation eb and interception of evaporation ei gu et al 2018 gu et al 2021 but has also been improved by shao et al 2022b so that it can be applied to urban surfaces named pt jplim model therefore et simulated by the pt jplim model can be used to estimate water storage capacity under different urban vegetation conditions and explore the differences between cities in different climate zones the aim of this study is to improve our understanding of the effect of urban vegetation change on urban water storage capacity this work builds on our previous research modelling urban et and combines the approach developed by jongen et al 2022 to estimate regional scale water storage capacity from simulated urban et during the period 2009 2018 by studying four major city clusters in china including the pearl river delta prd yangtze river delta yrd chengdu chongqing cy and beijing tianjin hebei jjj we explore the moderating effects of different vegetation conditions on urban et and urban water storage capacity the ways in which the effects of vegetation change on water storage capacity differ in urban and non urban areas and the ways to recognize these differences finally we estimate the precipitation of the urban areas of the four city clusters in high precipitation years i e the three years with the highest precipitation between 2009 and 2018 and subtract the annual mean precipitation to give the additional water resources needed for urban storage during the period 2009 2018 and estimate the additional urban vegetation required to consume this precipitation the results could help to quantify the role of urban ecological planning in urban flood protection 2 methodology 2 1 study region four city clusters beijing tianjin hebei jjj yangtze river delta yrd pearl river delta prd and chengdu chongqing cy were selected as being representative of urbanization fang 2020 and were used for our study area china has experienced rapid urbanization since the 1980s and jjj yrd prd and cy have become important economic regions the location of these four city clusters and their densities of impervious surface distribution are shown in fig 1 a their impervious surface distributions are shown in fig 1b e 2 2 data we used the china meteorological forcing dataset cmfd yang et al 2010 to simulate et and its partitioning at the regional scale based on the pt jplim model the daily meteorological data from 2009 to 2018 used in this study included precipitation rate air temperature radiation specific humidity and surface pressure soil moisture were sourced from a soil moisture dataset of china based on microwave data assimilation from 2002 to 2011 yang et al 2016 yang et al 2020 soil hydraulic properties i e field capacity plant available water and plant wilt coefficient were derived from a high resolution global map produced by hierarchical parameterization of a physically based water retention model with a spatial resolution of 1 1 km zhang et al 2018b vegetation data included the leaf area index lai enhanced vegetation index evi and normalized difference vegetation index ndvi the lai data were sourced from moderate resolution imaging spectroradiometer modis lai product mod15a2hv006 and the ndvi and evi data were sourced from modis mod13a1v006 new et al 2000 urban land distributions were sourced from high resolution multi temporal mapping of global urban land liu et al 2018 albedo data were derived from global land surface satellite glass products liu et al 2013a qu et al 2016 to evaluate the performance of simulated et the observed flux et global land evaporation amsterdam model gleam v3 2 and penman monteith leuning v2 pml v2 et dataset was used as benchmarks the four observed flux sites daxing miyun guantao and huailai come from the multi scale surface flux observation dataset and are all located in jjj fig 1b table 1 lists some important site characteristics and key references a more detailed description of the four sites is provided by the national cryosphere desert data center liu et al 2013b gleam is a set of algorithms that separately estimate the different components of land evaporation transpiration soil evaporation interception evaporation water surface evaporation and sublimation with a spatial resolution of 0 25 0 25 miralles et al 2010 2011 martens et al 2017 pml v2 terrestrial evapotranspiration dataset including vegetation transpiration soil evaporation interception evaporation evaporation of water snow and ice and sublimation with a spatial resolution of 0 05 0 05 zhang et al 2016 zhang 2020 for a consistent comparison the different resolution data were re gridded to 0 05 0 05 latitude longitude grids 2 3 daily et and its partitioning the pt jpl model is used to estimate actual et and its partitioning with a large number of eco physiological and atmospheric constraint indicators fisher et al 2008 shao et al 2019 impervious surface evaporation eu is not considered in the original pt jpl model fisher et al 2008 in this study we simulated daily et for four major city clusters jjj yrd prd and cy in china from 2009 to 2018 using the pt jplim model shao et al 2022b shao et al 2022c which is a four source et model applicable to both natural and impervious surfaces the pt jplim model is based on dynamic effective rooting depth zr as a covariate to infer the sensitivity of a plant to soil moisture effectiveness replacing canopy height in the pt jplsm model of purdy et al 2018 with other parameter settings following purdy et al 2018 to reconstruct transpiration et simulations and improve the simulated performance of et in the original pt jpl model shao et al 2022c we used the carbon cost benefit model of guswa 2008 to simulate zr see supplementary text s1 for introduction the van dijk model developed by van dijk and bruijnzeel 2001a van dijk and bruijnzeel 2001b is used to calculate evaporation from impervious surfaces eu which approximates the principle of eu to vegetation interception evaporation ei and represents eu by quantifying the impervious surface fraction f u the pt jplim model has been validated as a reliable model on a global scale shao et al 2022c daily et is partitioned as 1 et e t e b e i e u where e t is daily canopy transpiration mm e b is daily soil evaporation mm e i is daily interception evaporation mm and e u is daily impervious surface evaporation mm e t is calculated as 2 e t 1 f wet f g f t f trm α δ δ γ r nc where f wet is the relative surface wetness dimensionless f g is the green canopy fraction dimensionless f t is the plant temperature constraint dimensionless f trm is an eco physiological scalar dimensionless purdy et al 2018 α is the pt coefficient with a value of 1 26 δ is the slope of the saturated vapor pressure curve kpa 1 γ is the psychrometric constant kpa 1 and r nc is the net radiation incident on the surface canopy w m 2 f trm is computed as 3 f trm 1 rh 4 1 v w c 1 r h f m rh 4 1 v w c 1 r h f trew 4 f trew 1 θ cr θ obs θ cr θ wp zr zr scalar 5 θ cr 1 p θ fc θ wp zr θ wp zr 6 p 1 1 p e t a 1 1 z r 7 θ wp zr θ w zr scalar 8 zr scalar zr where rh is the relative humidity vwc is variable water content f m is the plant moisture constraint unitless θ cr is the critical soil moisture at which soil moisture availability limits et θ obs is the mean soil moisture sm cm3 cm 3 averaged over the 0 100 cm soil depth martens et al 2017 θ fc is field capacity cm3 cm 3 pet is potential evaporation mm day 1 zr is effective plant rooting depth m p is a parameter dependent on pet mm day 1 and zr m a represents a weight for the influence of zr on θ cr with a value of 0 1 and θ w is wilting point cm3 cm 3 e b is computed as 9 e b f wet f rew 1 f wet α δ δ γ r ns g 10 f rew θ obs θ w θ fc θ w where f rew is soil moisture constant dimensionless r ns is the net radiation at the soil surface w m 2 and g is the soil heat flux w m 2 e i in pt jplim model is calculated by the van dijk model developed by van dijk and bruijnzeel 2001a van dijk and bruijnzeel 2001b 11 e i f v p r p r p wet f v p wet f er p r p wet p r p wet 12 f v 1 e x p lai lai ref 13 p wet l n 1 f er f v s v f er 14 f er f v f e r 0 15 s v s leaf l a i where p r is rainfall rate mm d 1 p wet is the reference threshold precipitation rate when the canopy is wet mm d 1 f er is the ratio of average evaporation rate to average rainfall intensity during storms s v is the canopy rainfall storage capacity mm which is currently parameterized as water storage in the leaf at canopy level f e r 0 is the specific ratio of evaporation rate to rainfall intensity per unit vegetation cover s leaf is specific canopy rainfall storage capacity per unit leaf area and f v is the fractional area covered by intercepting leaves which is determined from the leaf area index lai and the reference lai lai ref for the specific vegetation type both f e r 0 and s leaf are free parameters and were globally optimized for different land cover types see table s1 in supplementary material shao et al 2022c the pt jplim model uses the modified van dijk model zhang and song 2021 to calculate eu 16 e u f u p r p r p wet f u p wet f er p r p wet p r p wet 17 p wet l n 1 f er f u s u f er 18 f er f u f e r 0 where f u is the fractional area covered by impervious surfaces and s u is the impervious surface storage capacity mm 0 014 a multi temporal global dataset of impervious surfaces at a resolution of 30 m 30 m liu et al 2018 was used to calculate f u at a resolution of 0 05 0 05 shao et al 2022c 2 4 urban water storage capacity according to jongen et al 2022 daily et is related to storage under water limited conditions during multi day drydowns in urban areas without rainfall where impervious surfaces are typically quickly depleted masson 2000 ramamurthy and bou zeid 2014 open water is constant vegetation behaves more linearly dardanelli et al 2004 williams and albertson 2004 peters et al 2011 the storage capacity reflects the sum of water leaving the system as et jongen et al 2022 proposed estimating s by fitting the observed et over time during drying in this study our recession analysis is based on the daily et of four major city clusters in china simulated using the pt jplim model 19 s t 0 e t t d t λ et 0 where s is the total dynamic storage volume mm depleted during a complete drydown t t is the days of complete drydown λ is the e folding timescale day and et 0 is the initial et according to jongen et al 2022 the average daily variation in anthropogenic moisture flux during a drought is negligible therefore the effect of anthropogenic moisture flux is not discussed in this study it is worth noting that the effect of urban irrigation on et could be significant in this study to prevent irrigation from influencing the results irrigation was excluded by limiting drydowns to the first 10 days which also reduced the effect of the smaller signal to noise ratio in the tail of the drydown on et 0 the parameters λ and et 0 were calculated according to the following principles i calculations were based on all periods that had no precipitation for at least three consecutive days jongen et al 2022 ii λ was below 35 days the maximum value found by teuling et al 2006 and et 0 was below 10 mm d 1 iii the average temperature during a drydown must exceed 0 to exclude snow conditions teuling et al 2006 we calculated water storage capacity on the basis of simulated daily et with a resolution of 0 05 0 05 over the period 2009 2018 for four major city clusters in china by determining λ and et 0 we assumed that storage was completely filled after each rainfall event and there was no correlation between parameters λ and et 0 and pre drydown rainfall because available water storage in the atmosphere can vary depending on factors such as phenology we calculated an average s on a decadal timescale to simplify this variation in general it is difficult to measure urban water storage capacity owing to the heterogeneity of urban surfaces and complexity of human activities this study quantifies the urban water storage capacity of four major city clusters in china based on the above described method which was proposed and validated as a reliable method by jongen et al 2022 2 5 analytical method we used the pearson correlation coefficient r and root mean square error rmse to analyze our results 20 r θ i obs o θ i s i m m θ i obs o 2 θ i s i m m 2 21 rmse 1 n i 1 n θ i obs θ i sim 2 where i is the sample number θ obs are the observations θ sim are the simulated values and n is the number of samples o and m are the averages of the observed and simulated values respectively the nonparametric mann kendall statistic mann 1945 kendall 1975 was applied to examine trends in our hydrological and meteorological data series as suggested by goossens and berger 1986 see supplementary text s2 for introduction we applied the regression with boosted decision trees see supplementary text s3 for introduction to the pt jplim model outputs to identify environmental drivers and to assess how they govern the spatial variation in s this is an advanced regression machine learning technique to link driving forces to a target variable that requires prediction the method has been increasingly advocated for hydrological tian et al 2021 zhou et al 2021 and ecological analyses lian et al 2018 due to its strong predictive capability easy interpretability and capacity to handle complex nonlinearities making it a suitable tool for our analysis 2 6 experimental design to investigate the effect of vegetation change on urban s we designed two experiments in experiment 1 we controlled the vegetation parameters in the model so they did not change over time during 2009 while varying other meteorological factors with time hereafter referred to as s without to observe the differences in s with and without vegetation change and to investigate the effect of vegetation change on s in areas with urban regions 5 impervious surface coverage in a grid and other non urban regions in experiment 2 having gained an understanding of the importance of vegetation change to s we increased the vegetation at each grid point in the model by 25 of the mean vegetation across the region hereafter referred to as s 1 25 to explore the sensitivity of s in different city clusters to increased vegetation in urban and other non urban regions table 2 summarizes the different experimental designs a further experiment was designed to assess the vegetation required to store precipitation in the four city clusters first we calculated the additional precipitation for the city clusters precipitation in the urban areas of the four city clusters during high precipitation years the three years with the highest precipitation during the period 2009 2018 minus the annual mean precipitation for each grid cell this additional precipitation represents the additional urban water storage resources that were required from 2009 to 2018 second we used the pt jplim model and jongen et al 2022 s method and assumed that vegetation needs increased by x we multiplied each vegetation parameter by 1 x and substituted the additional precipitation into s to find the value of x this is the increase in vegetation that is required for grid cells that cover impervious surfaces in all city cluster 3 results 3 1 modelled et and water storage capacity for four city clusters we modelled daily et at 0 05 0 05 spatial resolution for four city clusters from 2009 to 2018 fig 2 compares the daily et observed at the four flux sites with the daily et simulated on the corresponding grid at each site the results show that the pt jplim model simulated et is consistent with the observed values average correlation coefficient r2 0 57 and average rmse 1 45 mm d ranging from 1 27 to 1 66 mm d in daxing and guantao the simulated daily et is slightly smaller than the observed et while in huailai the simulated daily et is slightly larger than the observed et the modelled daily et data were compared and validated using gleam and pml v2 at monthly and eight day scales respectively fig 3 the et modelled using the pt jplim model was consistent with gleam r2 0 75 rmse 9 83 mm month and pml v2 r2 0 78 rmse 0 51 mm d for all city clusters comparisons of the simulated et with gleam and pml v2 over the four city clusters are presented in fig 3b e and g j respectively showing that the pt jplim model has the smallest rmse of 15 88 mm month for prd with gleam and 0 48 mm d for jjj with pml v2 we compared the spatial distributions of the annual mean ensemble et average value of gleam and pml v2 and the modelled et fig s1 in supplementary material and found that the spatial distribution for the modelled et is consistent with the ensemble et at yrd prd and cy at the pixel level r 0 5 between the modelled et and ensemble et overall the pt jplim model is shown to be a robust model in terms of simulating daily et fig 4 a shows the spatial distribution of annual mean et from 2009 to 2018 the annual mean et was highest in prd 840 mm and lowest in jjj 540 mm fig 4b shows the spatial distribution of annual mean s which had similar characteristics to et being highest in prd 13 63 mm and lowest in jjj 10 63 mm the distribution of s for the four city clusters ranged from 2 to 28 mm a range similar to that seen in jongen et al 2022 and teuling et al 2006 fig 4c shows the spatial distribution of recession timescales λ the distribution of λ differed from those of et and s having a maximum in jjj 7 63 days and a minimum in cy 4 94 days the spatial distribution of λ correlated with that of precipitation fig s2 in supplementary material while the spatial distributions of et and s were similar to that of vegetation lai fig s3 in supporting information the ways in which vegetation affects et and s in urban and non urban areas are explored below 3 2 impact of vegetation change on water storage capacity in four city clusters water storage capacity is dependent on land surface characteristics land use and soil moisture and atmospheric conditions energy and moisture availability to better understand s we used a machine learning technique augmented decision tree regression to explore the effects of environmental drivers lai rn net radiation sm soil moisture vpd vapor pressure deficit tmax maximum air temperature and fu fractional area covered by impervious surfaces on the spatial pattern of s in the four studied city clusters fig 5 the results show that rn was the most dominant driver of the spatial distribution of s with a relative contribution of 36 43 and had the highest contribution 50 in cy for land surface features lai was the primary driver of s the relative contribution of lai to the spatial pattern of regional s in the four city clusters ranged from 11 59 to 27 56 with an average of 19 68 this finding confirms the important role of terrestrial vegetation structure in controlling s the remaining drivers were ordered tmax sm vpd fu with the relative contribution of tmax to the spatial distribution of s ranging from 13 04 to 21 09 the largest contributor to the spatial pattern of s in jjj was sm the weakest driver of the spatial distribution of s was fu with an average relative contribution of 1 55 this indicates that the proportion of impermeable surfaces has only a small effect on the spatial distribution of s fig 6 a shows the spatial distribution of the changes in lai for the four city clusters and fig 6b compares the changes in lai in urban areas with those in other areas the lai increased significantly in all four city clusters over the period 2009 2018 fig 6a it increased in 91 of the four city clusters during the studied decade with a significant increase in 10 of these areas after clarifying the importance of vegetation on the distribution of s we quantified the effect of vegetation change on s fig 6c shows that the regional mean of s s without was 1 18 mm over the four city clusters and s s without was 0 in 71 of these areas indicating that vegetation changes in the four city clusters increased s by an average of 11 34 over the period 2009 2018 the increase was particularly pronounced in yrd prd and cy with a slight decrease in central and southern jjj fig 6d shows the differences between urban and non urban s s without in contrast to fig 6b the urban s s without was greater than the non urban s s without for all city clusters except yrd the urban s s without was from largest to smallest cy prd yrd jjj while the non urban s s without was from largest to smallest prd cy yrd jjj this indicates that vegetation changes had the greatest effect on s in urban areas of cy and non urban areas of prd the distribution of s s without and the trend in lai showed similar changes among the four city clusters with the change in lai being from large to small cy prd yrd jjj lai increases are lower in urban areas than in non urban areas within the same city cluster however s s without is higher in urban areas than in non urban areas within the same city cluster except yrd could this result mean that the more vegetation increases the greater the driving effect of vegetation on s is in urban areas than in non urban areas we will give the analysis below 3 3 anatomy of the sensitivity of water storage capacity to vegetation change to disentangle the reasons why s with and without vegetation change gives opposing results in response to lai change in urban and non urban areas we modelled a further scenario we increased the vegetation at each grid point in the model by 25 of the mean vegetation across the region s 1 25 fig 7 a shows the spatial distribution of s 1 25 s s in 57 of the four city clusters s 1 25 s s was 0 while in other areas it was 0 fig 7b shows the regional average of s 1 25 s s for urban and non urban areas increased vegetation in cities resulted in a smaller increase in urban s than that in non urban area in yrd prd and cy while in jjj increased vegetation boosted urban s however all city clusters showed an increase in non urban s with increased vegetation similar to fig 6d the magnitude of non urban s decline with increasing vegetation was ranked cy prd yrd to decipher the above modelling results we dissected the ways in which changes in et partitioning et eb and ei changed s fig 8 a displays the distribution of et partitioning that dominate s change showing that in 39 of the four city clusters changes in s were dominated by changes in et we further distinguished the differences in the spatial proportions of dominant factors for s between urban and non urban areas fig 8b changes in eb dominated s change in urban areas more than they did in non urban areas especially in yrd prd and cy however increased vegetation caused a decrease in eb explaining why urban s decreased when vegetation was expanded in other words increased vegetation dominated the change in urban eb more than it did for non urban eb and the decrease in urban eb was greater than the increase in urban et which in turn resulted in a decrease in urban et and s similarly this reasoning explains the larger difference between s with and without vegetation change in urban areas fig 6 the decrease in eb was less in urban areas where the increase in vegetation was not as dramatic as in non urban areas which in turn resulted in a larger s with increased vegetation and a larger s s without 3 4 demand of urban vegetation in terms of precipitation consumption on the basis of the above results we estimated the precipitation for each grid cell covering the impervious surfaces within the four city clusters in high precipitation years i e the three years with the highest precipitation during the period 2009 2018 minus the annual mean precipitation to give a representation of the additional water resources required for urban storage from 2009 to 2018 fig 9 a the additional water resources to be stored were highest in yrd and prd 18 84 and 22 96 mm respectively and lowest in jjj 9 29 mm we further estimated the additional urban vegetation required by assuming that the cities would only store these water resources through vegetation the results in fig 9b indicate that impervious areas in jjj yrd prd and cy would need to add 10 32 32 and 28 respectively to their current vegetation to store the extra precipitation in high precipitation years and secure these urban water resources it should be noted that the additional vegetation increase here refers to the overall increase in a series of vegetation parameters lai ndvi evi vegetation cover ratio of vegetation to impervious surface and others and not to the planted area of urban vegetation 4 discussion this study has estimated urban water storage capacity at the regional scale for four city clusters in china based on the method developed by jongen et al 2022 to estimate urban water storage capacity according to et recession jongen et al 2022 calculated recession timescales and water storage capacities on the basis of et recession observed through eddy covariance they found urban recession timescales of 1 8 20 1 days with the majority below 10 4 days and storage capacities between 1 3 and 28 4 mm with the majority below 13 4 mm the mean recession timescale for the four city clusters in this study calculated on the basis of simulated daily et was 6 1 days and the storage capacity ranged from 2 to 28 mm which is consistent with the results of jongen et al 2022 jongen et al 2022 compared the difference in storage capacity between urban and rural areas and concluded that urban storage capacity is five times smaller than that in rural areas unfortunately the coarse resolution and large area of the satellite data simulations used in our study combined with the large spatial heterogeneity of precipitation made it impossible to clearly identify the effects of vegetation change on s for the city clusters under different climatic conditions however the advantage of estimating regional scale s based on daily et simulated by the pt jplim model is that modelled et is able to provide more data for the estimation of s without the time constraint of et observations more robust empirical relationships are established for the water storage capacity approach proposed by jongen et al 2022 when more et data are provided in addition the pt jplim model as improved by shao et al 2022b not only contains a large number of eco physiological factors to robustly simulate the effect of vegetation on et shao et al 2019 shao et al 2021 shao et al 2022a it also includes parameters such as the proportion of impervious surfaces which can be adapted to urban et simulations of impervious surfaces therefore we were able to explore the effect of urban vegetation characteristics on storage capacity by varying the vegetation factors in the pt jplim model and then analyze how different surface characteristics and climatic conditions affect urban water storage capacity because our method is based on direct extrapolation of modelled daily data the accuracy of the pt jplim model determines the quality of the estimated storage capacity in this study we modelled daily et for four city clusters in china including daily vegetation transpiration soil evaporation interception evaporation and impervious surface evaporation owing to the sparsity of et observations we were only able to validate the modelled daily et on the basis of four observation sites in jjj and were unable to perform a more comprehensive validation for the other three city clusters we could only use vegetation data with temporal resolutions of 8 or 16 d when modelling daily et owing to limitations in the temporal resolution of remote sensing data which introduced some uncertainty into our results however the reliability of the pt jplim model on a global scale has been verified in a previous study shao et al 2022b our comprehensive evaluation of pt jplim model estimated et and its partitioning from the point scale to the global scale included i basin averaged annual et ii eddy covariance flux tower data iii observed eb et iv observed ei p and v inter model comparisons this provided us with confidence in simulating et based on the pt jplim model the results of this study show that energy has a significant effect on et and s in the four city clusters dense urban populations generate large amounts of anthropogenic heat and this plays an important role in the surface energy balance sailor 2011 numerous studies have been conducted to illustrate the effect of anthropogenic heat on urban et cong et al 2017 calculated et in beijing based on an improved sebs surface energy balance system urban model that considered the effect of urban anthropogenic heat and found that anthropogenic heat had a significant effect on urban et faridatul et al 2020 proposed an urban energy balance algorithm usebal urban surface energy balance algorithms for land that took into account urban subsurface types and anthropogenic heat which is superior to the previous sebal model anthropogenic heat was not included in the model used herein which may have had an influence on the daily et simulated in this study however the water storage capacity simulated in this study based on daily et is a long term average moreover our emphasis is on the effect of urban vegetation change on et and water storage capacity thus the method still provides scientific support for our conclusions the daily et simulated in this study based on the pt jplim model includes et from natural land covered by vegetation such as grasses trees and shrubs and evaporation caused by increased impervious surfaces under human activities which gives a natural social binary water cycle character to the urban storage capacity wang et al 2013 qin et al 2014 studies have shown that changes in vegetation cover and impervious surfaces make a significant contribution to urban et zhang et al 2001 ramamurthy and bou zeid 2014 zeng et al 2016 shao et al 2019 shao et al 2022b substantial changes in et and hence urban storage capacity occur when large scale land use cover changes accompany urbanization wetzel and chang 1987 salvucci 2001 jongen et al 2022 therefore founded on et urban storage capacity plays an important role not only in mitigating urban flooding but also in mitigating the heat island effect by influencing urban heat through et peters et al 2011 hao et al 2018 venter et al 2021 huang et al 2022b however the effects of vegetation change on urban storage capacity during urbanization are currently poorly understood current observations and surface modelling based on vegetation and water storage capacity typically exclude urban areas and our understanding of urban ecosystem functioning is rather limited fisher et al 2020 zhao et al 2021 huang et al 2022a this study assessed the effects of vegetation change on water storage and estimated the urban vegetation that is required to consume additional precipitation in urban areas we combined an evapotranspiration model with an urban water storage capacity model to quantify the urban water storage capacity and we used the ecological indicators in the modeling to suggest future plans for urban vegetation the dense distribution of urban buildings makes it particularly important to plan vegetation for urban flood prevention and mitigation in the future higher resolution modeling is needed to analyze and plan vegetation for impervious surfaces so as to optimize urban vegetation management practices and achieve urban scale green infrastructure design under climate change estimates of the vegetation required for precipitation resource consumption such as those provided here are useful for promoting sponge city planning and construction 5 conclusions the urban heat island effect and urban flooding constrain the sustainable development of cities a potential solution to address the urban water and energy balance is the promotion of urban water storage capacity increased urban vegetation often plays an important role in improving thermal comfort and regulating the urban water cycle but the role of vegetation change on urban water storage remains unclear in this study based on our previously constructed pt jplim model which makes the pt jpl model applicable to both natural surface and urban surface et modelling we use an approach based on et recession estimation of urban storage capacity from modelled regional scale urban et to estimate the water storage capacity of four city clusters in china including the pearl river delta prd yangtze river delta yrd chengdu chongqing cy and beijing tianjin hebei jjj our results show that et simulated by the pt jplim model is consistent with four flux towers in urban ecosystems r2 0 57 rmse 1 45 mm d gleam r2 0 75 rmse 9 83 mm month and pml v2 r2 0 78 rmse 0 51 mm d the highest annual mean et among the four city clusters was in the prd 840 mm and the lowest was in jjj 540 mm the spatial distribution of s was similar to that of et with the highest in the prd 13 63 mm and the lowest in jjj 10 63 mm the distribution of s in the four city clusters ranged from 2 to 28 mm with a maximum recession time scale λ in jjj 7 63 d and a minimum in cy 4 94 d a machine learning technique i e augmented decision tree regression was further used to explore the influence of environmental drivers lai rn sm vpd tmax and fu on the s spatial pattern of the four city clusters in china rn was found to be the most dominant driver with a relative contribution of 36 43 lai on the regional s spatial pattern of the four city clusters with a relative contribution of 11 59 27 56 vegetation change in the four city clusters increased s by 11 34 the effect of vegetation change on changes in s s s without and lai change in urban and non urban areas showed opposing relationships furthermore we found that the effect on s of expanding vegetation to 1 25 times the existing average was opposite to the above results for urban and non urban areas this can be explained by the increase in vegetation dominating the change in eb in urban areas to a greater degree than in non urban areas and the decrease in urban eb being greater than the increase in urban et which in turn led to a decrease in urban s urban areas of jjj yrd prd and cy would require a 10 32 32 and 28 increase in existing vegetation respectively to store additional precipitation in high precipitation years this study contributes to the quantification of the role of urban ecological planning in urban flood prevention and mitigation and provides a reference for the planning and construction of sponge cities based on the effect of vegetation change on urban water storage declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was jointly supported by the beijing municipal natural science foundation grant no 8222036 and the national natural science foundation of china grant no 51979285 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129355 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
1994,increasing the effective urban water storage capacity is one of a range of solutions to mitigate heat issues and flooding in urban areas and vegetation plays an important role in it in this study the regional scale water storage capacity of four city clusters in china during the period 2009 2018 was estimated based on a four source evapotranspiration et model incorporated with urban water storage capacity s estimated on the basis of daily et recession our results showed that simulated et was consistent with four flux towers r2 0 57 rmse 1 45 mm d the spatial distribution of s was similar to that of et and ranged from 2 to 28 mm the influence of environmental drivers on the spatial pattern of s was explored using a machine learning technique and the relative contribution of lai leaf area index to the spatial pattern of s ranged from 11 59 to 27 56 the effect of vegetation change on s in urban and non urban areas showed an opposite relationship to the lai change however the effect on s in urban and non urban areas was reversed when vegetation was expanded to 1 25 times the existing mean owing to the increase in vegetation dominating the change in urban eb soil evaporation to a greater degree than for non urban eb urban areas in beijing tianjin hebei the yangtze river delta pearl river delta and chengdu chongqing would need to increase existing vegetation by 10 32 32 and 28 respectively to store additional precipitation above the mean annual precipitation in high precipitation years this study provides a new mechanistic understanding of the effects of vegetation change on water consumption in urban ecosystems allowing the role of urban ecological planning in urban flood mitigation to be quantified keywords water storage capacity evapotranspiration urban ecosystem vegetation change impervious surface data availability data will be made available on request 1 introduction unlike natural ecosystems urban ecosystems include a large proportion of artificially modified impervious surfaces such as roofs pavements and concrete or asphalt roads ramamurthy and bou zeid 2014 zhang et al 2018a wang et al 2020 changes in urban impervious surfaces lead to changes in surface energy and water balance bonan et al 2011 shao et al 2022b an increase in impervious surfaces leads to increased surface runoff generation and promotes the rapid passage of surface runoff through ground and drainage systems hollis 1975 arnold and gibbons 1996 smith et al 2005 suriya and mudgal 2012 limiting the water resources available for urban evapotranspiration et avissar 1992 arnold and gibbons 1996 fletcher et al 2013 manoli et al 2020 and producing an indirect urban heat island effect taha 1997 zhao et al 2014 installing impervious services also increases urban flooding which is a serious concern for urban residents and limits sustainable urban development wilby 2007 boggs and sun 2011 hamdi et al 2011 tingsanchali 2012 zhang et al 2018a several solutions have been proposed to address urban water and energy balance including water sensitive urban design wong 2006 low impact development gilroy and mccuen 2009 sponge cities mhurd 2014 gaines 2016 and natural solutions somarakis et al 2019 which all have the ability to promote an increase in urban water storage capacity one of the numerous nature based solutions to enhance urban water storage capacity and mitigate the negative impacts of urban impervious surfaces is to increase urban vegetation or install other green infrastructure li et al 2020 increased urban vegetation can play an important role in improving thermal comfort and regulating the urban hydrological cycle ennos 2010 owing to the fact that canopy transpiration is an important source of atmospheric moisture and one of the key partitions of et pielke 2005 shao et al 2022b in addition vegetation can reduce runoff through interception and improved infiltration and thus vegetation is essential for further improving retention kuehler et al 2017 vegetation restores storage capacity by transferring the stored water back to the atmosphere through et thom et al 2020 given the importance of vegetation to water storage capacity teuling et al 2006 the planning of urban vegetation schemes has become more exacting in an attempt to improve urban water storage capacity therefore it is important to assess the effects of different vegetation characteristics on urban water storage in the context of et to better address the issue of urban water balance estimating urban water storage capacity remains challenging owing to the inherent heterogeneity of the urban surface a method for estimating effective urban water storage using et recession during periods without precipitation was proposed by jongen et al 2022 urban effective water storage is defined as the dynamic water storage available to the atmosphere for et and includes soil moisture intercepted precipitation groundwater and open water from lakes and sinkholes jongen et al 2022 the jongen et al 2022 method is able to overcome the heterogeneity of the urban surface and quantify the urban water storage capacity directly based on et however it uses et measured by urban eddy covariance ec to estimate the effective water storage reflecting all sources of et from impervious surfaces vegetation and open water this cannot isolate differences caused by the proportion of urban vegetation from those caused by climate furthermore the limited number of observation sites makes it difficult to explain differences between cities modelled et offers the possibility to address these limitations the priestley taylor jet propulsion laboratory pt jpl model is widely used to estimate et fisher et al 2008 it is based on a relatively new eco physiological model with advantages including excellent performance and relatively few ground measurement requirements michel et al 2016 shao et al 2019 the pt jpl model is not only applicable to natural surfaces with the ability to simulate transpiration et soil evaporation eb and interception of evaporation ei gu et al 2018 gu et al 2021 but has also been improved by shao et al 2022b so that it can be applied to urban surfaces named pt jplim model therefore et simulated by the pt jplim model can be used to estimate water storage capacity under different urban vegetation conditions and explore the differences between cities in different climate zones the aim of this study is to improve our understanding of the effect of urban vegetation change on urban water storage capacity this work builds on our previous research modelling urban et and combines the approach developed by jongen et al 2022 to estimate regional scale water storage capacity from simulated urban et during the period 2009 2018 by studying four major city clusters in china including the pearl river delta prd yangtze river delta yrd chengdu chongqing cy and beijing tianjin hebei jjj we explore the moderating effects of different vegetation conditions on urban et and urban water storage capacity the ways in which the effects of vegetation change on water storage capacity differ in urban and non urban areas and the ways to recognize these differences finally we estimate the precipitation of the urban areas of the four city clusters in high precipitation years i e the three years with the highest precipitation between 2009 and 2018 and subtract the annual mean precipitation to give the additional water resources needed for urban storage during the period 2009 2018 and estimate the additional urban vegetation required to consume this precipitation the results could help to quantify the role of urban ecological planning in urban flood protection 2 methodology 2 1 study region four city clusters beijing tianjin hebei jjj yangtze river delta yrd pearl river delta prd and chengdu chongqing cy were selected as being representative of urbanization fang 2020 and were used for our study area china has experienced rapid urbanization since the 1980s and jjj yrd prd and cy have become important economic regions the location of these four city clusters and their densities of impervious surface distribution are shown in fig 1 a their impervious surface distributions are shown in fig 1b e 2 2 data we used the china meteorological forcing dataset cmfd yang et al 2010 to simulate et and its partitioning at the regional scale based on the pt jplim model the daily meteorological data from 2009 to 2018 used in this study included precipitation rate air temperature radiation specific humidity and surface pressure soil moisture were sourced from a soil moisture dataset of china based on microwave data assimilation from 2002 to 2011 yang et al 2016 yang et al 2020 soil hydraulic properties i e field capacity plant available water and plant wilt coefficient were derived from a high resolution global map produced by hierarchical parameterization of a physically based water retention model with a spatial resolution of 1 1 km zhang et al 2018b vegetation data included the leaf area index lai enhanced vegetation index evi and normalized difference vegetation index ndvi the lai data were sourced from moderate resolution imaging spectroradiometer modis lai product mod15a2hv006 and the ndvi and evi data were sourced from modis mod13a1v006 new et al 2000 urban land distributions were sourced from high resolution multi temporal mapping of global urban land liu et al 2018 albedo data were derived from global land surface satellite glass products liu et al 2013a qu et al 2016 to evaluate the performance of simulated et the observed flux et global land evaporation amsterdam model gleam v3 2 and penman monteith leuning v2 pml v2 et dataset was used as benchmarks the four observed flux sites daxing miyun guantao and huailai come from the multi scale surface flux observation dataset and are all located in jjj fig 1b table 1 lists some important site characteristics and key references a more detailed description of the four sites is provided by the national cryosphere desert data center liu et al 2013b gleam is a set of algorithms that separately estimate the different components of land evaporation transpiration soil evaporation interception evaporation water surface evaporation and sublimation with a spatial resolution of 0 25 0 25 miralles et al 2010 2011 martens et al 2017 pml v2 terrestrial evapotranspiration dataset including vegetation transpiration soil evaporation interception evaporation evaporation of water snow and ice and sublimation with a spatial resolution of 0 05 0 05 zhang et al 2016 zhang 2020 for a consistent comparison the different resolution data were re gridded to 0 05 0 05 latitude longitude grids 2 3 daily et and its partitioning the pt jpl model is used to estimate actual et and its partitioning with a large number of eco physiological and atmospheric constraint indicators fisher et al 2008 shao et al 2019 impervious surface evaporation eu is not considered in the original pt jpl model fisher et al 2008 in this study we simulated daily et for four major city clusters jjj yrd prd and cy in china from 2009 to 2018 using the pt jplim model shao et al 2022b shao et al 2022c which is a four source et model applicable to both natural and impervious surfaces the pt jplim model is based on dynamic effective rooting depth zr as a covariate to infer the sensitivity of a plant to soil moisture effectiveness replacing canopy height in the pt jplsm model of purdy et al 2018 with other parameter settings following purdy et al 2018 to reconstruct transpiration et simulations and improve the simulated performance of et in the original pt jpl model shao et al 2022c we used the carbon cost benefit model of guswa 2008 to simulate zr see supplementary text s1 for introduction the van dijk model developed by van dijk and bruijnzeel 2001a van dijk and bruijnzeel 2001b is used to calculate evaporation from impervious surfaces eu which approximates the principle of eu to vegetation interception evaporation ei and represents eu by quantifying the impervious surface fraction f u the pt jplim model has been validated as a reliable model on a global scale shao et al 2022c daily et is partitioned as 1 et e t e b e i e u where e t is daily canopy transpiration mm e b is daily soil evaporation mm e i is daily interception evaporation mm and e u is daily impervious surface evaporation mm e t is calculated as 2 e t 1 f wet f g f t f trm α δ δ γ r nc where f wet is the relative surface wetness dimensionless f g is the green canopy fraction dimensionless f t is the plant temperature constraint dimensionless f trm is an eco physiological scalar dimensionless purdy et al 2018 α is the pt coefficient with a value of 1 26 δ is the slope of the saturated vapor pressure curve kpa 1 γ is the psychrometric constant kpa 1 and r nc is the net radiation incident on the surface canopy w m 2 f trm is computed as 3 f trm 1 rh 4 1 v w c 1 r h f m rh 4 1 v w c 1 r h f trew 4 f trew 1 θ cr θ obs θ cr θ wp zr zr scalar 5 θ cr 1 p θ fc θ wp zr θ wp zr 6 p 1 1 p e t a 1 1 z r 7 θ wp zr θ w zr scalar 8 zr scalar zr where rh is the relative humidity vwc is variable water content f m is the plant moisture constraint unitless θ cr is the critical soil moisture at which soil moisture availability limits et θ obs is the mean soil moisture sm cm3 cm 3 averaged over the 0 100 cm soil depth martens et al 2017 θ fc is field capacity cm3 cm 3 pet is potential evaporation mm day 1 zr is effective plant rooting depth m p is a parameter dependent on pet mm day 1 and zr m a represents a weight for the influence of zr on θ cr with a value of 0 1 and θ w is wilting point cm3 cm 3 e b is computed as 9 e b f wet f rew 1 f wet α δ δ γ r ns g 10 f rew θ obs θ w θ fc θ w where f rew is soil moisture constant dimensionless r ns is the net radiation at the soil surface w m 2 and g is the soil heat flux w m 2 e i in pt jplim model is calculated by the van dijk model developed by van dijk and bruijnzeel 2001a van dijk and bruijnzeel 2001b 11 e i f v p r p r p wet f v p wet f er p r p wet p r p wet 12 f v 1 e x p lai lai ref 13 p wet l n 1 f er f v s v f er 14 f er f v f e r 0 15 s v s leaf l a i where p r is rainfall rate mm d 1 p wet is the reference threshold precipitation rate when the canopy is wet mm d 1 f er is the ratio of average evaporation rate to average rainfall intensity during storms s v is the canopy rainfall storage capacity mm which is currently parameterized as water storage in the leaf at canopy level f e r 0 is the specific ratio of evaporation rate to rainfall intensity per unit vegetation cover s leaf is specific canopy rainfall storage capacity per unit leaf area and f v is the fractional area covered by intercepting leaves which is determined from the leaf area index lai and the reference lai lai ref for the specific vegetation type both f e r 0 and s leaf are free parameters and were globally optimized for different land cover types see table s1 in supplementary material shao et al 2022c the pt jplim model uses the modified van dijk model zhang and song 2021 to calculate eu 16 e u f u p r p r p wet f u p wet f er p r p wet p r p wet 17 p wet l n 1 f er f u s u f er 18 f er f u f e r 0 where f u is the fractional area covered by impervious surfaces and s u is the impervious surface storage capacity mm 0 014 a multi temporal global dataset of impervious surfaces at a resolution of 30 m 30 m liu et al 2018 was used to calculate f u at a resolution of 0 05 0 05 shao et al 2022c 2 4 urban water storage capacity according to jongen et al 2022 daily et is related to storage under water limited conditions during multi day drydowns in urban areas without rainfall where impervious surfaces are typically quickly depleted masson 2000 ramamurthy and bou zeid 2014 open water is constant vegetation behaves more linearly dardanelli et al 2004 williams and albertson 2004 peters et al 2011 the storage capacity reflects the sum of water leaving the system as et jongen et al 2022 proposed estimating s by fitting the observed et over time during drying in this study our recession analysis is based on the daily et of four major city clusters in china simulated using the pt jplim model 19 s t 0 e t t d t λ et 0 where s is the total dynamic storage volume mm depleted during a complete drydown t t is the days of complete drydown λ is the e folding timescale day and et 0 is the initial et according to jongen et al 2022 the average daily variation in anthropogenic moisture flux during a drought is negligible therefore the effect of anthropogenic moisture flux is not discussed in this study it is worth noting that the effect of urban irrigation on et could be significant in this study to prevent irrigation from influencing the results irrigation was excluded by limiting drydowns to the first 10 days which also reduced the effect of the smaller signal to noise ratio in the tail of the drydown on et 0 the parameters λ and et 0 were calculated according to the following principles i calculations were based on all periods that had no precipitation for at least three consecutive days jongen et al 2022 ii λ was below 35 days the maximum value found by teuling et al 2006 and et 0 was below 10 mm d 1 iii the average temperature during a drydown must exceed 0 to exclude snow conditions teuling et al 2006 we calculated water storage capacity on the basis of simulated daily et with a resolution of 0 05 0 05 over the period 2009 2018 for four major city clusters in china by determining λ and et 0 we assumed that storage was completely filled after each rainfall event and there was no correlation between parameters λ and et 0 and pre drydown rainfall because available water storage in the atmosphere can vary depending on factors such as phenology we calculated an average s on a decadal timescale to simplify this variation in general it is difficult to measure urban water storage capacity owing to the heterogeneity of urban surfaces and complexity of human activities this study quantifies the urban water storage capacity of four major city clusters in china based on the above described method which was proposed and validated as a reliable method by jongen et al 2022 2 5 analytical method we used the pearson correlation coefficient r and root mean square error rmse to analyze our results 20 r θ i obs o θ i s i m m θ i obs o 2 θ i s i m m 2 21 rmse 1 n i 1 n θ i obs θ i sim 2 where i is the sample number θ obs are the observations θ sim are the simulated values and n is the number of samples o and m are the averages of the observed and simulated values respectively the nonparametric mann kendall statistic mann 1945 kendall 1975 was applied to examine trends in our hydrological and meteorological data series as suggested by goossens and berger 1986 see supplementary text s2 for introduction we applied the regression with boosted decision trees see supplementary text s3 for introduction to the pt jplim model outputs to identify environmental drivers and to assess how they govern the spatial variation in s this is an advanced regression machine learning technique to link driving forces to a target variable that requires prediction the method has been increasingly advocated for hydrological tian et al 2021 zhou et al 2021 and ecological analyses lian et al 2018 due to its strong predictive capability easy interpretability and capacity to handle complex nonlinearities making it a suitable tool for our analysis 2 6 experimental design to investigate the effect of vegetation change on urban s we designed two experiments in experiment 1 we controlled the vegetation parameters in the model so they did not change over time during 2009 while varying other meteorological factors with time hereafter referred to as s without to observe the differences in s with and without vegetation change and to investigate the effect of vegetation change on s in areas with urban regions 5 impervious surface coverage in a grid and other non urban regions in experiment 2 having gained an understanding of the importance of vegetation change to s we increased the vegetation at each grid point in the model by 25 of the mean vegetation across the region hereafter referred to as s 1 25 to explore the sensitivity of s in different city clusters to increased vegetation in urban and other non urban regions table 2 summarizes the different experimental designs a further experiment was designed to assess the vegetation required to store precipitation in the four city clusters first we calculated the additional precipitation for the city clusters precipitation in the urban areas of the four city clusters during high precipitation years the three years with the highest precipitation during the period 2009 2018 minus the annual mean precipitation for each grid cell this additional precipitation represents the additional urban water storage resources that were required from 2009 to 2018 second we used the pt jplim model and jongen et al 2022 s method and assumed that vegetation needs increased by x we multiplied each vegetation parameter by 1 x and substituted the additional precipitation into s to find the value of x this is the increase in vegetation that is required for grid cells that cover impervious surfaces in all city cluster 3 results 3 1 modelled et and water storage capacity for four city clusters we modelled daily et at 0 05 0 05 spatial resolution for four city clusters from 2009 to 2018 fig 2 compares the daily et observed at the four flux sites with the daily et simulated on the corresponding grid at each site the results show that the pt jplim model simulated et is consistent with the observed values average correlation coefficient r2 0 57 and average rmse 1 45 mm d ranging from 1 27 to 1 66 mm d in daxing and guantao the simulated daily et is slightly smaller than the observed et while in huailai the simulated daily et is slightly larger than the observed et the modelled daily et data were compared and validated using gleam and pml v2 at monthly and eight day scales respectively fig 3 the et modelled using the pt jplim model was consistent with gleam r2 0 75 rmse 9 83 mm month and pml v2 r2 0 78 rmse 0 51 mm d for all city clusters comparisons of the simulated et with gleam and pml v2 over the four city clusters are presented in fig 3b e and g j respectively showing that the pt jplim model has the smallest rmse of 15 88 mm month for prd with gleam and 0 48 mm d for jjj with pml v2 we compared the spatial distributions of the annual mean ensemble et average value of gleam and pml v2 and the modelled et fig s1 in supplementary material and found that the spatial distribution for the modelled et is consistent with the ensemble et at yrd prd and cy at the pixel level r 0 5 between the modelled et and ensemble et overall the pt jplim model is shown to be a robust model in terms of simulating daily et fig 4 a shows the spatial distribution of annual mean et from 2009 to 2018 the annual mean et was highest in prd 840 mm and lowest in jjj 540 mm fig 4b shows the spatial distribution of annual mean s which had similar characteristics to et being highest in prd 13 63 mm and lowest in jjj 10 63 mm the distribution of s for the four city clusters ranged from 2 to 28 mm a range similar to that seen in jongen et al 2022 and teuling et al 2006 fig 4c shows the spatial distribution of recession timescales λ the distribution of λ differed from those of et and s having a maximum in jjj 7 63 days and a minimum in cy 4 94 days the spatial distribution of λ correlated with that of precipitation fig s2 in supplementary material while the spatial distributions of et and s were similar to that of vegetation lai fig s3 in supporting information the ways in which vegetation affects et and s in urban and non urban areas are explored below 3 2 impact of vegetation change on water storage capacity in four city clusters water storage capacity is dependent on land surface characteristics land use and soil moisture and atmospheric conditions energy and moisture availability to better understand s we used a machine learning technique augmented decision tree regression to explore the effects of environmental drivers lai rn net radiation sm soil moisture vpd vapor pressure deficit tmax maximum air temperature and fu fractional area covered by impervious surfaces on the spatial pattern of s in the four studied city clusters fig 5 the results show that rn was the most dominant driver of the spatial distribution of s with a relative contribution of 36 43 and had the highest contribution 50 in cy for land surface features lai was the primary driver of s the relative contribution of lai to the spatial pattern of regional s in the four city clusters ranged from 11 59 to 27 56 with an average of 19 68 this finding confirms the important role of terrestrial vegetation structure in controlling s the remaining drivers were ordered tmax sm vpd fu with the relative contribution of tmax to the spatial distribution of s ranging from 13 04 to 21 09 the largest contributor to the spatial pattern of s in jjj was sm the weakest driver of the spatial distribution of s was fu with an average relative contribution of 1 55 this indicates that the proportion of impermeable surfaces has only a small effect on the spatial distribution of s fig 6 a shows the spatial distribution of the changes in lai for the four city clusters and fig 6b compares the changes in lai in urban areas with those in other areas the lai increased significantly in all four city clusters over the period 2009 2018 fig 6a it increased in 91 of the four city clusters during the studied decade with a significant increase in 10 of these areas after clarifying the importance of vegetation on the distribution of s we quantified the effect of vegetation change on s fig 6c shows that the regional mean of s s without was 1 18 mm over the four city clusters and s s without was 0 in 71 of these areas indicating that vegetation changes in the four city clusters increased s by an average of 11 34 over the period 2009 2018 the increase was particularly pronounced in yrd prd and cy with a slight decrease in central and southern jjj fig 6d shows the differences between urban and non urban s s without in contrast to fig 6b the urban s s without was greater than the non urban s s without for all city clusters except yrd the urban s s without was from largest to smallest cy prd yrd jjj while the non urban s s without was from largest to smallest prd cy yrd jjj this indicates that vegetation changes had the greatest effect on s in urban areas of cy and non urban areas of prd the distribution of s s without and the trend in lai showed similar changes among the four city clusters with the change in lai being from large to small cy prd yrd jjj lai increases are lower in urban areas than in non urban areas within the same city cluster however s s without is higher in urban areas than in non urban areas within the same city cluster except yrd could this result mean that the more vegetation increases the greater the driving effect of vegetation on s is in urban areas than in non urban areas we will give the analysis below 3 3 anatomy of the sensitivity of water storage capacity to vegetation change to disentangle the reasons why s with and without vegetation change gives opposing results in response to lai change in urban and non urban areas we modelled a further scenario we increased the vegetation at each grid point in the model by 25 of the mean vegetation across the region s 1 25 fig 7 a shows the spatial distribution of s 1 25 s s in 57 of the four city clusters s 1 25 s s was 0 while in other areas it was 0 fig 7b shows the regional average of s 1 25 s s for urban and non urban areas increased vegetation in cities resulted in a smaller increase in urban s than that in non urban area in yrd prd and cy while in jjj increased vegetation boosted urban s however all city clusters showed an increase in non urban s with increased vegetation similar to fig 6d the magnitude of non urban s decline with increasing vegetation was ranked cy prd yrd to decipher the above modelling results we dissected the ways in which changes in et partitioning et eb and ei changed s fig 8 a displays the distribution of et partitioning that dominate s change showing that in 39 of the four city clusters changes in s were dominated by changes in et we further distinguished the differences in the spatial proportions of dominant factors for s between urban and non urban areas fig 8b changes in eb dominated s change in urban areas more than they did in non urban areas especially in yrd prd and cy however increased vegetation caused a decrease in eb explaining why urban s decreased when vegetation was expanded in other words increased vegetation dominated the change in urban eb more than it did for non urban eb and the decrease in urban eb was greater than the increase in urban et which in turn resulted in a decrease in urban et and s similarly this reasoning explains the larger difference between s with and without vegetation change in urban areas fig 6 the decrease in eb was less in urban areas where the increase in vegetation was not as dramatic as in non urban areas which in turn resulted in a larger s with increased vegetation and a larger s s without 3 4 demand of urban vegetation in terms of precipitation consumption on the basis of the above results we estimated the precipitation for each grid cell covering the impervious surfaces within the four city clusters in high precipitation years i e the three years with the highest precipitation during the period 2009 2018 minus the annual mean precipitation to give a representation of the additional water resources required for urban storage from 2009 to 2018 fig 9 a the additional water resources to be stored were highest in yrd and prd 18 84 and 22 96 mm respectively and lowest in jjj 9 29 mm we further estimated the additional urban vegetation required by assuming that the cities would only store these water resources through vegetation the results in fig 9b indicate that impervious areas in jjj yrd prd and cy would need to add 10 32 32 and 28 respectively to their current vegetation to store the extra precipitation in high precipitation years and secure these urban water resources it should be noted that the additional vegetation increase here refers to the overall increase in a series of vegetation parameters lai ndvi evi vegetation cover ratio of vegetation to impervious surface and others and not to the planted area of urban vegetation 4 discussion this study has estimated urban water storage capacity at the regional scale for four city clusters in china based on the method developed by jongen et al 2022 to estimate urban water storage capacity according to et recession jongen et al 2022 calculated recession timescales and water storage capacities on the basis of et recession observed through eddy covariance they found urban recession timescales of 1 8 20 1 days with the majority below 10 4 days and storage capacities between 1 3 and 28 4 mm with the majority below 13 4 mm the mean recession timescale for the four city clusters in this study calculated on the basis of simulated daily et was 6 1 days and the storage capacity ranged from 2 to 28 mm which is consistent with the results of jongen et al 2022 jongen et al 2022 compared the difference in storage capacity between urban and rural areas and concluded that urban storage capacity is five times smaller than that in rural areas unfortunately the coarse resolution and large area of the satellite data simulations used in our study combined with the large spatial heterogeneity of precipitation made it impossible to clearly identify the effects of vegetation change on s for the city clusters under different climatic conditions however the advantage of estimating regional scale s based on daily et simulated by the pt jplim model is that modelled et is able to provide more data for the estimation of s without the time constraint of et observations more robust empirical relationships are established for the water storage capacity approach proposed by jongen et al 2022 when more et data are provided in addition the pt jplim model as improved by shao et al 2022b not only contains a large number of eco physiological factors to robustly simulate the effect of vegetation on et shao et al 2019 shao et al 2021 shao et al 2022a it also includes parameters such as the proportion of impervious surfaces which can be adapted to urban et simulations of impervious surfaces therefore we were able to explore the effect of urban vegetation characteristics on storage capacity by varying the vegetation factors in the pt jplim model and then analyze how different surface characteristics and climatic conditions affect urban water storage capacity because our method is based on direct extrapolation of modelled daily data the accuracy of the pt jplim model determines the quality of the estimated storage capacity in this study we modelled daily et for four city clusters in china including daily vegetation transpiration soil evaporation interception evaporation and impervious surface evaporation owing to the sparsity of et observations we were only able to validate the modelled daily et on the basis of four observation sites in jjj and were unable to perform a more comprehensive validation for the other three city clusters we could only use vegetation data with temporal resolutions of 8 or 16 d when modelling daily et owing to limitations in the temporal resolution of remote sensing data which introduced some uncertainty into our results however the reliability of the pt jplim model on a global scale has been verified in a previous study shao et al 2022b our comprehensive evaluation of pt jplim model estimated et and its partitioning from the point scale to the global scale included i basin averaged annual et ii eddy covariance flux tower data iii observed eb et iv observed ei p and v inter model comparisons this provided us with confidence in simulating et based on the pt jplim model the results of this study show that energy has a significant effect on et and s in the four city clusters dense urban populations generate large amounts of anthropogenic heat and this plays an important role in the surface energy balance sailor 2011 numerous studies have been conducted to illustrate the effect of anthropogenic heat on urban et cong et al 2017 calculated et in beijing based on an improved sebs surface energy balance system urban model that considered the effect of urban anthropogenic heat and found that anthropogenic heat had a significant effect on urban et faridatul et al 2020 proposed an urban energy balance algorithm usebal urban surface energy balance algorithms for land that took into account urban subsurface types and anthropogenic heat which is superior to the previous sebal model anthropogenic heat was not included in the model used herein which may have had an influence on the daily et simulated in this study however the water storage capacity simulated in this study based on daily et is a long term average moreover our emphasis is on the effect of urban vegetation change on et and water storage capacity thus the method still provides scientific support for our conclusions the daily et simulated in this study based on the pt jplim model includes et from natural land covered by vegetation such as grasses trees and shrubs and evaporation caused by increased impervious surfaces under human activities which gives a natural social binary water cycle character to the urban storage capacity wang et al 2013 qin et al 2014 studies have shown that changes in vegetation cover and impervious surfaces make a significant contribution to urban et zhang et al 2001 ramamurthy and bou zeid 2014 zeng et al 2016 shao et al 2019 shao et al 2022b substantial changes in et and hence urban storage capacity occur when large scale land use cover changes accompany urbanization wetzel and chang 1987 salvucci 2001 jongen et al 2022 therefore founded on et urban storage capacity plays an important role not only in mitigating urban flooding but also in mitigating the heat island effect by influencing urban heat through et peters et al 2011 hao et al 2018 venter et al 2021 huang et al 2022b however the effects of vegetation change on urban storage capacity during urbanization are currently poorly understood current observations and surface modelling based on vegetation and water storage capacity typically exclude urban areas and our understanding of urban ecosystem functioning is rather limited fisher et al 2020 zhao et al 2021 huang et al 2022a this study assessed the effects of vegetation change on water storage and estimated the urban vegetation that is required to consume additional precipitation in urban areas we combined an evapotranspiration model with an urban water storage capacity model to quantify the urban water storage capacity and we used the ecological indicators in the modeling to suggest future plans for urban vegetation the dense distribution of urban buildings makes it particularly important to plan vegetation for urban flood prevention and mitigation in the future higher resolution modeling is needed to analyze and plan vegetation for impervious surfaces so as to optimize urban vegetation management practices and achieve urban scale green infrastructure design under climate change estimates of the vegetation required for precipitation resource consumption such as those provided here are useful for promoting sponge city planning and construction 5 conclusions the urban heat island effect and urban flooding constrain the sustainable development of cities a potential solution to address the urban water and energy balance is the promotion of urban water storage capacity increased urban vegetation often plays an important role in improving thermal comfort and regulating the urban water cycle but the role of vegetation change on urban water storage remains unclear in this study based on our previously constructed pt jplim model which makes the pt jpl model applicable to both natural surface and urban surface et modelling we use an approach based on et recession estimation of urban storage capacity from modelled regional scale urban et to estimate the water storage capacity of four city clusters in china including the pearl river delta prd yangtze river delta yrd chengdu chongqing cy and beijing tianjin hebei jjj our results show that et simulated by the pt jplim model is consistent with four flux towers in urban ecosystems r2 0 57 rmse 1 45 mm d gleam r2 0 75 rmse 9 83 mm month and pml v2 r2 0 78 rmse 0 51 mm d the highest annual mean et among the four city clusters was in the prd 840 mm and the lowest was in jjj 540 mm the spatial distribution of s was similar to that of et with the highest in the prd 13 63 mm and the lowest in jjj 10 63 mm the distribution of s in the four city clusters ranged from 2 to 28 mm with a maximum recession time scale λ in jjj 7 63 d and a minimum in cy 4 94 d a machine learning technique i e augmented decision tree regression was further used to explore the influence of environmental drivers lai rn sm vpd tmax and fu on the s spatial pattern of the four city clusters in china rn was found to be the most dominant driver with a relative contribution of 36 43 lai on the regional s spatial pattern of the four city clusters with a relative contribution of 11 59 27 56 vegetation change in the four city clusters increased s by 11 34 the effect of vegetation change on changes in s s s without and lai change in urban and non urban areas showed opposing relationships furthermore we found that the effect on s of expanding vegetation to 1 25 times the existing average was opposite to the above results for urban and non urban areas this can be explained by the increase in vegetation dominating the change in eb in urban areas to a greater degree than in non urban areas and the decrease in urban eb being greater than the increase in urban et which in turn led to a decrease in urban s urban areas of jjj yrd prd and cy would require a 10 32 32 and 28 increase in existing vegetation respectively to store additional precipitation in high precipitation years this study contributes to the quantification of the role of urban ecological planning in urban flood prevention and mitigation and provides a reference for the planning and construction of sponge cities based on the effect of vegetation change on urban water storage declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was jointly supported by the beijing municipal natural science foundation grant no 8222036 and the national natural science foundation of china grant no 51979285 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129355 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
