index,text
4430,uncertainties in flood forecasts that result from error propagation in meteorological hydrological simulation processes present spatial and temporal dependences that are the principal sources of risk to real time flood control in a multireservoir system risk analysis models that neglect such dependences potentially yield biased results regarding flood control operations to enhance the accuracy of flood risk analysis and inform decision making regarding real time flood control for a multireservoir system this study proposed an integrated flood risk identification analysis and diagnosis model framework that incorporates the multidimensional dependences of forecast uncertainties the framework includes an uncertainty identification model that uses the copula function to characterize the joint probability function of the mixed dependent uncertainties it also incorporates a real time flood risk analysis module that couples simulation and optimization to convert the complex multiobjective operation under uncertainty into a tractable model capable of flexibly evaluating individual and joint flood risks the third component is a risk diagnosis module that calculates risk contributions using conditional probability and identifies stable and vulnerable reservoirs within the system to alter operational decisions toward risk reduction methodologies were verified through application to a mixed four reservoir system in the pi river basin china the principal findings were as follows 1 positive dominated dependences of forecast uncertainties were identified because of error propagation through the meteorological and rainfall runoff forecasts within the spatial and temporal continuity connection and the copula function accurately described and quantified the multidimensional temporal and spatial dependences of the uncertainties 2 in neglecting the spatial dependences of forecast uncertainties the joint flood risk of the reservoir system was underestimated in ignoring high order temporal dependences individual flood risk was underestimated owing to biased estimation in error variance 3 systematic reorganization of the operational strategies of diagnosed stable and vulnerable reservoirs could provide guidance for reduction and homogenization of flood risks the proposed framework could be used to improve the accuracy of flood risk analysis and support reliable real time flood control operation of a multireservoir system keywords reservoir operation uncertainty flood risk analysis diagnosis copula function markov chain 1 introduction a real time flood forecast is an important and useful source of information that can contribute to the development of operational plans for controlling floods in multireservoir systems chen et al 2015b han and coulibaly 2017 currently such forecasts can be obtained using hydrological models calibrated using precipitation and hydrological data zhu et al 2017 however owing to errors associated with the input variables model structure and parameter calibration of the forecast process chen et al 2015a cloke and pappenberger 2009 si et al 2015 the inevitable related uncertainties that exist in the forecasts are widely regarded as the main sources of risk in flood control operations zhu et al 2018 in real time operation uncertainties in flood forecasts lead to biases in expected and actual reservoir operation indicators that can result in flood risk when an actual indicator e g water level or release process exceeds a safety threshold to enhance the safety and robustness of real time reservoir operation during flood periods analysis of the characteristics and distribution of risk is performed as a precursor to informing decision making regarding flood control recently the overall requirements regarding integrated operation of a multireservoir system to control floods have been extended chen et al 2020 meng et al 2019 zhang et al 2019 resulting in urgent need for improvement in the accuracy and completeness of real time risk analysis the specific challenges associated with accomplishing this goal include the following 1 refinement in characterization of the uncertainties to reduce bias in estimations of the probability distribution of risk sources and 2 consideration of the overall complexity of the hydraulic connectivity and influences of reservoir operation with acceptable demands on computational effort and time especially regarding analysis of the joint risk from combined risky events wherein risk could occur in multiple reservoirs and time periods simultaneously this represents a formulation of a type of structured risk analysis problem with consideration of the influence of interaction in reservoir operation methods for analyzing the risk associated with controlling floods in a single reservoir fall into two main categories 1 analytical methods that derive analytic equations for the probability density function of risk events and 2 numerical methods that develop numerical experiments to simulate risk events analytical methods often assume that error sources preserve symmetric unbiased and independent properties through the derivation process which could limit applicability to real world situations chen et al 2017 among the numerical methods the one used most widely is the monte carlo mc simulation the mc approach considers stochastic simulations of risk sources based on historical flood event data and then calculates the likelihood of a future risk event as a risk probability many simulation methods based on the mc approach have been used to characterize uncertainties lu et al 2020 xu et al 2015 xu et al 2019 for example the markov chain haguma et al 2015 wu et al 2019 and martingale zhao et al 2013 models have been adopted to represent uncertain streamflow processes zhou et al 2017 established an adaptive markov chain to assess the risk caused by uncertainties in a design flood process zhao et al 2013 used an improved martingale model to generate non normal marginal distribution error scenarios with a first order time lag temporal dependence chen et al 2016 modified the martingale model into a copula cue model and using it to consider the uncertainties of fourth order temporal dependences analyzed how forecast uncertainties evolved temporally the above methods and applications mainly considered the temporal dependences of uncertainties regarding time lags and weakening multiple time lag temporal dependences in fact owing to the persistent influences of errors in a rainfall flood forecast chain that propagate through rainfall runoff processes temporal dependences usually occur over multiple time periods as biases in estimation of temporal dependences could directly affect the results of risk analysis thorough characterization of temporal dependence information is important to ensure risk analysis accuracy flood control systems consisting of multiple reservoirs are often operated jointly to mitigate potential flood damage to the entire system and associated protected areas consequently the flood risk of a multireservoir system constitutes a spatially and temporally coupled relationship owing to risk propagation through hydrological and hydraulic interconnection via joint operation of the reservoirs if the coupling relationship is addressed real time risk analysis regarding a system of reservoirs represents a dynamic stochastic simulation problem that necessitates a systematic model formulation based on generating and analyzing dynamic multivariate stochastic processes through forecasts and reservoir operation procedures however being restricted by computational requirements model complexity and information abundance for conducting multistage full process simulations of a multireservoir system related research often simplifies risk analysis modeling by reducing both the dimensionality of risk sources and the complexity of risk events hui and lund 2015 introduced a combined flood control operation model to reduce both the maximum flood peak and the risk within a system of parallel reservoirs gong et al 2020 proposed a two stage method for analyzing flood risk in a multireservoir system with the objective of reducing the total risk associated with flood control chen et al 2017 proposed a decomposition integration method for analyzing the risks associated with controlling floods in real time in a complex multireservoir system that included two reservoirs a downstream channel and a control point that were decomposed into several independent subsystems using an mc simulation based on maximum entropy theory the study evaluated how uncertainties were transmitted through the system although previous studies have provided remarkable support for flood risk analysis of multireservoir systems limitations regarding the integrity accuracy flexibility and dependency of risk analysis hinder informed decision making support first most previous related studies assumed that the forecast uncertainties regarding inflow in different sites or subsystems are spatially independent by neglecting their spatial dependences which could lead to bias in evaluation of the combined flood risk in a multireservoir system in fact the forecast errors of floods among different reservoirs within a closely interconnected system are dependent owing to the propagated influence of forecast error through the meteorological hydrological forecast model chain liu et al 2012 second earlier studies applied either pure simulation based or optimization based models for assessing and controlling the risk which meant they lacked the flexibility available through combining the advantages of both types of model regarding improvement of the interaction and optimization efficiencies real time flood control of a complex reservoir system based on partial and uncertain forecasts represents a multistage multiobjective and risky decision making problem xu et al 2020 the principal difficulties that arise regarding determination of a desirable compromise and robust strategy for balancing risk aversion within the complex system necessitate not only abundant and representative scenario analysis via simulation but also guidance based on the knowledge and preferences of decision makers which is difficult to achieve through global optimization third current knowledge seldom provides diagnosis or analysis of the flood risk of vulnerable components within the system limiting the efficiency in both locating the riskiest components and altering strategies toward risk response to further improve overall accuracy and efficiency of risk analysis in flood control efforts could be devoted to investigation of suitable model design and integration throughout the primary three stages risk identification risk analysis and risk diagnosis at the stage of risk source identification preserving information regarding the spatial and temporal dependences of forecasting errors helps improve risk analysis accuracy by capturing information that is more valid this needs a modeling tool that can formulate the multivariate joint probability function of relevant correlated sources of uncertainty the copula function is an effective tool for defining a joint probability function it can model the dependence structure according to the characteristics of correlation and it provides flexibility in selection of marginal distributions owing to these advantages copula functions are used widely in the fields of hydrology and water science for example in design flood calculations grimaldi and serinaldi 2006 analyses of extreme rainfall zhang and singh 2007 and evaluation of drought frequency zhang et al 2013 the modeling process is simplified by separating the determination of the marginal distribution from the calibration of the dependent structure schulte and schumann 2015 and brunner et al 2019 used the copula function to establish the spatial distribution of a combined flood from different drainage basins and analyzed the risk to the area composition proving the copula function capable of coping with multiple hydrological variables and temporal and spatial dependences at multiple stages chen et al 2015c lee and salas 2011 recently copula functions have been used to address low order temporal dependence structures in individual reservoirs however to the best of our knowledge they have not been used previously to capture spatial and temporal correlations regarding multireservoir systems at the risk analysis stage with the oscillation of forecast uncertainties a coupled simulation optimization model that disaggregates systemwide optimization via refined simulation and decision interaction can provide a reservoir flood control strategy and a risk response corresponding to simulated scenarios this represents a modeling tool that can produce a candidate solution with abundant risk information in a real time and dynamic updating environment that offers the possibility of decision intervention at the risk diagnosis stage decision makers seek the opportunity to change the operational strategy to alter the risk distribution if the current results are considered unsatisfactory this process needs information support for both identification of the most stable or most vulnerable reservoir when the risk is changed and formulation of a conditional probability calculation procedure with a given risk status correspondingly scenario based stochastic simulation and flood risk analysis has advantages in terms of computational flexibility and timeliness in comparison with analytical models chen et al 2015a to bridge these knowledge gaps the aims of this study were to enhance the accuracy of flood risk analysis and to inform decision making in relation to a multireservoir system to achieve these objectives a coupled flood control simulation optimization operation model was established for which the temporal and spatial dependences of uncertainties were captured using the copula function and flood risk diagnosis was performed for strategy alteration distinct from previous related studies through risk analysis and control processes we established a novel integrated framework that includes three modules 1 an uncertainty identification and stochastic inflow simulation module to capture the mixed temporal and spatial dependences of real time flood forecast uncertainties 2 a real time flood risk analysis module that couples the stochastic simulation with scenario optimization and 3 a flood risk diagnosis module based on conditional flood risk analysis to explore the stable or vulnerable components of the system the proposed methodologies were verified through application to a mixed four reservoir system in the pi river basin china 2 methodology a flowchart of the framework of the model proposed in this study is presented in fig 1 section 2 1 reveals the process for identification of real time forecast uncertainties and the method for stochastic inflow scenario simulation real time flood forecast uncertainties are defined and identified and both the temporal and the spatial dependence characteristics of the uncertainties are developed the stochastic simulation method for generating discretized inflow scenarios is also established in this section we describe three sets of comparative experiments 1 employing the copula function to capture the complete temporal and spatial dependences of forecast uncertainties model i 2 applying the copula function to generate uncertainties scenarios with temporally dependent dependences model ii and 3 using a markov chain mc simulation mcmc to preserve information regarding low order temporal dependent dependences model iii all scenarios were used as inputs for real time flood risk analysis section 2 2 establishes a real time flood risk analysis module that couples stochastic simulation with scenario optimization the optimizing scheduling process for each inflow scenario can be obtained and flood risk analysis is conducted based on the scenarios set section 2 3 presents a risk diagnosis for the multireservoir system based on the flood risk analysis results the diagnosis identifies the stable and vulnerable reservoirs within the system and provides feedback for flood control strategies of the reservoirs 2 1 identification of real time forecast uncertainties and stochastic inflow scenario simulation 2 1 1 real time flood forecast uncertainties and dependence characteristics real time flood forecast uncertainties errors are the differences between forecast and observed flow and the dependences of the forecast uncertainties are represented by the correlations of these errors in this section we define the real time forecast uncertainties of a multireservoir system and explain the method used to characterize the temporal and spatial dependences 2 1 1 1 identification of forecast uncertainties of a multireservoir system with precipitation sequences as inputs real time flood forecasts are produced using hydrological models that simulate the streamflow generation and routing processes within river basins uncertainties from the precipitation forecast to the flood forecast evolve and become compounded and the total errors comprise errors from a range of sources that include meteorological inputs computational downscaling and the structure and parameters of the hydrological model among these it is generally considered that uncertainties related to precipitation meteorological input errors contribute most to the total uncertainty liu et al 2012 as the errors evolve over space and time the errors in the flood forecast present temporal and spatial dependences fig 2 for instance bias in the process for forecasting precipitation will eventually affect the flood hydrograph at certain time periods the catchment response time while bias in basin scale precipitation will impact the flood hydrograph at multiple sites within the drainage area as defined forecast uncertainties are quantified as the differences between forecast and observed flow 1 e m t q m t q m t t 1 2 t where qm t qm t and em t are the forecast lateral flow observed lateral flow and forecast error of reservoir m in time period t m3 s respectively and t is the length of the forecast horizon h specifically em t is considered a random variable and the source of flood risk the marginal probability distribution function and parameters of em t can be calibrated using historical samples of forecast and observed lateral flow the vector of the forecast error of reservoir m em can be represented by eq 2 2 e m e m 1 e m 2 e m t if there are m reservoirs within the system the augmented vector of the forecast error of the reservoir system e can be described by eq 3 3 e e 1 e 2 e m e 1 1 e 1 2 e 1 t e 1 e 2 1 e 2 2 e 2 t e 2 e m 1 e m 2 e m t e m similarly the relative forecast error can be defined as erm t 4 e r m t e m t q m t accordingly the vector of the relative forecast error of reservoir m erm and the vector of the relative forecast error of the multireservoir system er can be established 2 1 1 2 characteristics of the temporal and spatial dependences cascade uncertainties that propagate through meteorological hydrological forecasts cause temporal and spatial dependent forecast errors the dependent characteristics can be represented by a correlation coefficient matrix that can provide information for constructing the multivariate joint distribution this study used a correlation matrix cor to describe the temporal and spatial dependences of the forecast uncertainties as expressed by eqs 5 and 6 the full information of the matrix is given by eq 5 while eq 6 describes a simplified formulation by disaggregating the matrix into components of submatrices 5 e 1 1 e 1 t e m 1 e m t e m 1 e m t c o r e 1 1 e 1 t e m 1 e m t e m 1 e m t ρ 1 1 1 1 ρ 1 1 1 t ρ 1 t 1 1 ρ 1 t 1 t ρ 1 1 m 1 ρ 1 1 m t ρ 1 t m 1 ρ 1 t m t ρ 1 1 m 1 ρ 1 1 m t ρ 1 t m 1 ρ 1 t m t ρ m 1 1 1 ρ m 1 1 t ρ m t 1 1 ρ m t 1 t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t ρ m 1 1 1 ρ m 1 1 t ρ m t 1 1 ρ m t 1 t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t 6 cor co r e 1 e 1 co r e m e 1 co r e m e 1 co r e 1 e m co r e m e m co r e m e m co r e 1 e m co r e m e m co r e m e m where ρ m 1 t 1 m 2 t 2 m 1 m 2 1 2 m t 1 t 2 1 2 t denotes the pearson correlation coefficient between forecast error e m 1 t 1 and e m 2 t 2 therefore when m 1 m 2 t 1 t 2 ρ m 1 t 1 m 2 t 2 calculates the temporal dependence of the forecast errors between lead time t 1 and t 2 in reservoir m 1 if m 1 m 2 t 1 t 2 ρ m 1 t 1 m 2 t 2 computes the spatial dependence of the forecast errors at lead time t 1 between reservoir m 1 and m 2 otherwise ρ m 1 t 1 m 2 t 2 represents the mixed spatial and temporal dependences the submatrix in the main diagonal of cor in eqs 5 and 6 represents the temporal dependences i e co r e m e m ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t determines the complex pairwise temporal dependences for all time periods in reservoir m the other submatrices outside the main diagonal determine the mixed spatial and temporal dependences of all time periods between any given two reservoirs i e co r e m e 1 ρ m 1 1 1 ρ m 1 1 t ρ m t 1 1 ρ m t 1 t if the forecast errors of reservoir m and reservoir 1 are assumed spatially independent then co r e m e 1 is a zero matrix a schematic of the dependence relationship of the forecast errors is shown in fig 3 the calibration of cor necessitates abundant data samples which can be realized from databases because real time flood forecasts are frequently made in a rolling horizon with updates moreover data from multiple flood events can also be used by extracting samples at different lead times which could ensure representativeness of the information when samples from different floods with various magnitudes are considered 2 1 2 stochastic simulation of flood forecast uncertainties of a multireservoir system 2 1 2 1 sampling methods based on the copula function in this section the copula function is applied in establishing the joint distribution of the forecast uncertainties and scenario simulation the process involves the following three steps 1 establishing the marginal distribution of the forecast uncertainty series 2 constructing the joint distribution using the copula function and 3 simulating scenarios based on the marginal distribution and joint structure 1 establishing the marginal distribution using the collected data samples of forecast errors a suitable marginal distribution is calibrated using maximum likelihood estimation 2 constructing the joint distribution the copula function is a popular tool in multivariate modeling yan 2007 the joint probability density function f x1 x2 xn of variables x1 x2 xn can be described by eq 7 according to sklar s theorem sklar 1960 7 f x 1 x 2 x n c w 1 w 2 w n f x 1 f x n 8 c w 1 w 2 w n c w 1 w 2 w n w 1 w 2 w n 9 f x i w i i 1 2 n where f x1 f x2 f xn are the marginal probability density functions of variables x1 x2 xn and c w1 w2 wn is the copula function of the various copula functions available members of the archimedean copula family e g the frank gumbel and clayton copulas are often used in bivariate modeling but are unsuitable for multivariate modeling the vine copula and metaelliptical copula are widely employed to establish a multivariate usually greater than two joint probability distribution for multivariable modeling the vine copula introduces a large number of possible pair copula decompositions aas et al 2009 which means that a reasonable copula type can be determined only through massive parameter estimation and structure selection which is computationally complex in addition the vine structure e g the d vine or canonical vine cannot fully address all combinational temporal spatial dependences within the structure formulation stage which potentially causes loss of dependence information in comparison with the vine copula the metaelliptical copula can model multidimensional dependences with cor and in a simple structure therefore owing to the limitations of the vine copula the metaelliptical copula was applied in this study the t copula is a typical metaelliptical copula function that can produce fine descriptions of multidimensional dependences in this study we applied the t copula function to the multidimensional joint distribution of the temporal and spatial dependences of the forecast uncertainties of the reservoir system and eq 10 expresses the connection function of the t copula function 10 c u c o r v t 1 u 1 t 1 u n γ v n v γ v 2 π v n c o r 1 1 v x t c o r 1 x v n 2 d x where cor is the correlation matrix v represents the degrees of freedom and n represents the number of variables 3 scenario simulation based on the marginal and joint distribution the flood forecast uncertainty series was obtained from historical forecasts and observed data and the marginal distribution was established through step 1 the multidimensional joint distribution of the uncertainties was established through step 2 then mc random sampling demarta and mcneil 2005 was used to generate the scenarios of the flood forecast process by generating random vectors with correlations θ 1 l θ 2 l θ 3 l θ d l l 1 2 l based on cor and v the degrees of freedom and l as the total number of scenarios superimposing the error scenarios on the forecast inflow processes yields the simulated observed inflow scenarios with different dependences as shown in fig 4 11 i m l t q m t e o m l t l 1 2 l t 1 2 t m 1 2 m where eol m t are the simulated errors of reservoir m for scenario l m3 s and il m t are the simulated natural flow processes without the influence of reservoir operation of reservoir m at scenario l m3 s 2 1 2 2 sampling methods based on mcmc various practical applications only consider low order time lagged temporal dependences when accounting for uncertainties in forecasts in this section we simulate the stochastic inflow process using a multiorder markov chain as an alternative and to facilitate comparison this method assumes that the uncertainties for a multireservoir system are spatially independent the markov chain is a stochastic model that describes a sequence of possible events wherein the probability of each event depends only on the state attained in previous events as the range of the variation of historical error samples is discretized into several mutually exclusive intervals within different lead time periods the state can be identified as the situation of a given sample that falls within a certain interval raftery 1985 raftery and tavare 1994 the transition of the states follows the given transition probability equation with τ order dependence 12 p r o b g e m t 1 g t 1 g e m t g t g e m t 1 g t 1 g e m 1 g 1 p r o b g e m t 1 g t 1 g e m t g t g e m t τ g t τ where g em t gt is an event where the forecast error s state is gt at lead time t the transition probability describes the probability that the forecast error changes from one state to another after i step moves the i step transition probability matrix tpm i can be obtained from the historical forecast and the observed process had 2010 taking the generation of inflow scenarios of reservoir m as an example the multiorder mcmc simulation can be divided into the following four steps 1 state discretization the relative errors of each lead time in erm are uniformly divided into r intervals states 2 transition probability matrix calculation the i step transition matrix tm i is constructed by calculating the transition steps f α β i from one state α time t to another state β time t i in the sample sequences 13 t m i f 1 1 i f r 1 i f 1 2 i f r 2 i f 1 r i f r r i i 1 2 τ and tpm i can be estimated according to tm i as shown in eqs 14 and 15 14 tp m i p 1 1 i p r 1 i p 1 2 i p r 2 i p 1 r i p r r i i 1 2 τ 15 p α β i f α β i β 1 r f α β i β 1 r f α β i 0 0 β 1 r f α β i 0 3 estimating the weights of the transition steps the state gt τ at lead time t τ depends on the states from lead time t to t τ 1 the corresponding transition probability matrix and weight coefficients are shown in eq 16 16 g t τ i 1 τ λ i t p m i g t τ i where λ i is the weight coefficient of transition probability matrix tpm i the parameter λ i can be estimated by solving the linear programming problem shown in eq 17 ching 2002 17 min ω λ s t ω ω ω x b λ 1 λ 2 λ τ ω 0 i 1 τ λ i 1 λ i 0 i ω ω ω x b λ 1 λ 2 λ τ where x x1 x2 xi t which is the total frequency of each state in the sample sequences and b tpm 1 x tpm 2 x tpm τ x 4 scenario generation relative forecast error scenarios of the first τ times erol m 1 erol m 2 erol m τ l 1 2 l which satisfy eq 18 are randomly generated according to eqs 13 17 the states of the relative forecast errors of a later lead time t τ can be calculated in turn by uniformly sampling in each state we obtain erol m τ erol m τ 1 erol m t l 1 2 l we then obtain the simulation scenarios of the relative forecast errors processes ero1 m t ero2 m t erol m t 18 er o m l 1 u min e r m 1 max e r m 1 e r o m l 2 u min e r m 2 max e r m 2 where u is the uniform distribution the natural inflow forecast scenarios can be simulated as shown in eq 19 19 i m l t q m t 1 e r o m l t l 1 2 l t 1 2 t m 1 2 m where il m t is the simulated natural inflow 2 2 real time flood risk analysis for a multireservoir system 2 2 1 flood control operation model for a multireservoir system the results of flood risk analyses are dependent not only on the characteristics of the uncertainties but also on reservoir operation strategies flood control operations deal with two types of conflicting objective 1 to lower reservoir outflow for the safety of downstream protected regions and 2 to increase reservoir outflow to ensure the safety of the reservoir and upstream area thus formulating a multiobjective operation to coordinate the conflicting objectives and enhance decision making efficiency we established a combined interactive optimization model the model optimizes the highest water level of a reservoir with successive iterations over a series of reservoirs by constraining the reservoir outflow limits which converts the multiobjective optimization modeling into a constrained single objective optimization in each scenario generated from section 2 1 the objective of the optimizing operation is to minimize the highest water level the optimization objective can be expressed as in eq 20 20 min f min max t z m l t t 1 2 t where zl m t is the water level of reservoir m the constraints are given in eqs 21 25 1 mass balance equation 21 v m l t 1 v m l t i n m l t q o m l t δ t where vl m t and vl m t 1 are the reservoir storage at the begin and end of time t for scenario l m3 respectively inl m t is the inflow m3 s qol m t is the reservoir outflow release m3 s and δt is the time interval s 2 hydraulic continuity equation the inflow of reservoir m comprises two parts natural inflow generated in the local catchment area il m t t 1 2 t and water that is released from any upstream reservoir qul m t t 1 2 t m3 s if there is no upstream reservoir qul m t 0 therefore the inflow process of reservoir m under scenario l inl m t can be described by eq 22 22 i n m l t i m l t q u m l t 3 reservoir release limits 23 0 q o m l t q o m where q o m is the release limit m3 s by applying this constraint the optimizing reservoir release does not exceed the set discharge and downstream regions are protected the term q o m is the key parameter for coordinating the multiple risk objectives through integrating the stochastic simulation and scenario optimization changing the value of q o m could yield the following results 1 coordinating the risks of upstream and downstream reservoirs by lowering increasing the risk of the downstream reservoir by reducing increasing q o m and 2 altering the spatial distribution of flood risks among parallel reservoirs finally desirable results can be achieved according to the preferences of decision makers and trial and error 4 reservoir release fluctuation limits 24 q o m l t 1 q o m l t δ q o m where δqom is the permissible maximum release fluctuation of reservoir m m3 s this limits the difference in the water released from the reservoir between two adjacent periods and ensures both the stability of the riverbank and the navigational safety of the downstream river channel 5 initial and boundary conditions 25 z m l 1 z i m z m l t 1 z e m where zim is the initial water level m and zem is the target end water level m parameter zem is usually set as the flood limited water level in the flood season this is because it is usually expected that the water level will fall back to the flood limited level at the end of a planning horizon to deal with possible subsequent flood events thus this is often treated as a soft constraint zhu et al 2017 in a multireservoir system an upstream reservoir is operated with the objective of protecting its own protected areas but it is also managed to lower the risks of downstream reservoirs and their protected regions through reduction of its outflow release thus if the calculated flood risks of downstream reservoirs exceed their tolerance level interactive optimization iterations can be triggered by reducing the release from upstream reservoirs to meet the expectations of decision makers 2 2 2 flood risk analysis during real time reservoir operation any unexpected surplus in inflow caused by forecast uncertainties could be accommodated by either storing the water in the reservoir or releasing it to the downstream river this process could elevate risk in upstream areas when the operational water level exceeds the water level safety threshold or in downstream areas when reservoir release exceeds the safety discharge level owing to the possible catastrophic consequences of downstream events such as inundation damage and losses from levee failure the reservoir release limit is addressed as a hard constraint constraint 3 in section 2 2 1 for minimizing downstream risk consequently the risk is transposed to upstream reservoirs we therefore focus mainly on upstream flood risk which is defined as the probability of the simulated water level exceeding the given threshold as shown in eq 26 26 p z m max t prob z m t z m max t c o u n t l z m l t z m l where pz m is the flood risk of reservoir m z m is the safety threshold of the water level max t prob z m t z m is the maximum probability that z m will be exceeded during the operation horizon l is the total number of scenarios and count is the counting function in a complex reservoir system decision makers are concerned more about the joint flood risk i e where several reservoirs are threatened by flood events than about the risk to individual reservoirs the joint flood risk is the joint probability that multiple reservoirs within a system simultaneously exceed their safety thresholds 27 p z ω max t prob z a 1 t z a 1 z a 2 t z a 2 z a n t z a n max t c o u n t l z a 1 l t z a 1 z a 2 l t z a 2 z a n l t z a n l where ω a1 a2 an pz ω is the set of reservoirs considered in the assessment and a1 a2 an are the indices of the member reservoirs within the set to compare the differences in simulated natural inflows under different dependences of forecast uncertainties we considered the probability that the simulated natural inflow would exceed the set threshold pim eq 28 and used the joint probability that the reservoirs natural inflows would exceed their thresholds piω eq 29 as an index with which to evaluate the frequency that extreme inflow events would occur because of uncertainties 28 p i m max t prob i m t i m max t c o u n t l i m l t i m l where i m is the natural inflow threshold of reservoir m and max t prob i m t i m is the frequency of the maximum probability that the inflow would exceed i m 29 p i ω max t prob i a 1 t i a 1 i a 2 t i a 2 i a n t i a n max t c o u n t l i a 1 l t i a 1 i a 2 l t i a 2 i a n l t i a n l where piω is the joint probability of the natural inflows exceeding their thresholds simultaneously 2 3 flood risk diagnosis flood risk analysis provides abundant information regarding individual and joint risk as risk response is highly affected by the operational strategy of a reservoir system it is critical to seek a reasonable approach for changing the strategy when current risk results are undesirable however owing to system complexity identifying the most effective operational mode is often difficult this is because changing the operational strategy of any reservoir within the system could change the spatial distribution of risk therefore diagnosing stable and vulnerable reservoirs based on their contributions to system risk not only improves decision making efficiency but also helps reduce risk with the scenario based stochastic simulations and flood risk analysis results we established a risk diagnosis module based on conditional probability for application to a complex multireservoir system for example the frequency analysis method was used to calculate the following conditional probabilities for diagnosing stable and vulnerable reservoirs within the multireservoir system 1 identify the most stable reservoir of the system the most stable reservoir means that it is a key component of the entire system if a joint risk event occurs in the system it is most likely influenced by the occurrence of flood risk in this reservoir this could be determined by ranking the value of the conditional probability of a joint risk event in the whole system given an individual flood risk event in one reservoir this conditional probability can be calculated as shown in eq 30 30 c p m ω 1 prob r 1 r m r m r m where c p m ω 1 is the conditional probability of risk event rm given joint risk event r1 rm rm the reservoir with the highest c p m ω 1 is the most stable reservoir within the multireservoir system 2 identify the most vulnerable reservoir of the system the most vulnerable reservoir is a weak component of the system if a general risk event occurs within the system it is highly likely to have been induced by the most vulnerable reservoir this conditional probability is expressed as the risk probability of an individual reservoir given any risk event occurring within the system and it can be calculated as shown in eq 31 31 c p m ω 2 prob r m r 1 r m r m where c p m ω 2 is the conditional probability of reservoir m and r1 rm rm means there is a general flood risk event in one or more reservoirs the reservoir with the highest c p m ω 2 is the most vulnerable reservoir within the multireservoir system when a multireservoir system encounters a system wide flood event the operational strategy should target careful balance between security assurance of vulnerable reservoirs and risk aversion of stable reservoirs to reduce the overall risk and potential losses after identifying the major cause of the considered risk results decision makers could quickly reproduce the risk results by changing the operational strategy of selected reservoirs based on the risk diagnosis 3 case study 3 1 overview of the multireservoir system and data series 3 1 1 the multireservoir system a mixed four reservoir system in the pi river basin which is one of the upper tributaries of the huai river in china was selected as the study area the river basin is within the climatic transition zone from southern china to northern china which is an area affected by the monsoon climate and frequently subjected to rainstorms and floods the four reservoirs in the system comprise the bailianya bly mozitan mzt and foziling fzl reservoirs on the east pi river and the xianghongdian xhd reservoir on the west pi river certain parameters of the multireservoir system are listed in table 1 and the geographical and topological relationships of the system are illustrated in fig 5 3 1 2 data the flood control operation of the multireservoir system is supported by monitored rainfall and flood information data and real time forecasting systems the flood forecast system driven by observed rainfall data and weather forecasts produced by the china meteorological administration using a numerical weather prediction model provides automatic forecasts with forecast horizons of 72 h and a 3 h time step the automatic forecast information is provided at 3 h intervals in the form of a rolling forecast detailed information regarding the forecast and observed data can be found on the anhui water information website http yc wswj net ahsxx lol public public html a flow process flood no 20050809 in 2005 with a return period of approximately 20 years was chosen as the test case 3 2 identification of forecast uncertainties and stochastic scenario simulations 3 2 1 identification of forecast uncertainties this section shows how the forecast uncertainties of each reservoir within the system are calculated based on historical forecasts and observed flow processes and the uncertainties are fitted with a reasonable marginal distribution the results of the data sample verify that a normal distribution could be used as the marginal distribution of the forecast uncertainties with different lead times in different reservoirs maximum likelihood estimation was used to estimate their parameters and the fitted distributions passed the chi square goodness of fit test at the 0 90 confidence level as examples fig 6 presents distributions of the forecast uncertainties for bly and mzt with lead times of 6 and 12 h 3 2 2 stochastic simulation of real time forecast uncertainties of the multireservoir system this section outlines the development of three sets of numerical experiments designed to consider different temporal and spatial dependences describes how the copula function and mcmc are used to generate inflow scenarios based on both spatial and temporal dependences and solely on temporal including low order dependences of the forecast uncertainties preserved within the system and examines how the performance of the simulation methods is verified 3 2 2 1 numerical experiments examining different temporal and spatial dependences three sets of numerical experiments using three models to drive the coupled flood risk analysis models were conducted we were particularly interested in performing pair wise comparisons to determine how the spatial and temporal dependences of forecast uncertainties influence the flood risk model i this model included the joint distribution of the forecast uncertainties that captured the spatial and temporal dependences using the copula function this model provided the actual estimation of flood risk results under full information conditions model ii this model included the joint distribution of the forecast uncertainties that considered only temporal dependences using the copula function model iii this model used a multiorder markov chain and considered only the low order temporal dependences of the forecast uncertainties comparison of the risk analysis results of model ii with those of model i reveals the impact of spatial dependences on flood risk comparison of the results of model iii with those of model ii highlights the impact of temporal dependences on flood risk as numerical experiments based on mc simulations are influenced by randomness the experiment results were tested repeatedly resampling 50 times to examine the significance of the variation in the statistical indices 3 2 2 2 simulation of uncertainties with temporal and spatial dependences model i the t copula function was used to characterize the dependences of the historical forecast and observed flood data the correlation coefficient matrix cor of the real time forecast uncertainties and the degrees of freedom v in the system were estimated by maximum likelihood estimation and used as the input parameter of the t copula function one thousand scenarios were generated graphs of cor for the historical sample statistics and the generated scenarios are shown in fig 7 the forecast uncertainties present significant positive spatial and temporal dependences in the system this is because of the consecutive influence on the flood forecast error caused by the propagation of biases in the precipitation forecast error as shown in fig 7 there are high spatial dependences of forecast uncertainties in bly mzt and fzl in the east pi river and the correlation coefficients are generally 0 5 the spatial dependences are low between the three reservoirs and xhd in the west pi river the temporal dependences of the forecast uncertainties in each reservoir are high and the temporal correlation coefficients are generally 0 8 as shown in fig 7 the matrix of dependences of the stochastic scenarios generated using the t copula function mostly match the actual matrix the joint distribution established by t copula function could pass the goodness of fit test based on probability integral transformation breymann et al 2003 and the kolmogorov smirnov test at the 95 confidence level p value 0 9018 3 2 2 3 simulation of uncertainties with temporal dependences model ii the spatial dependences of the forecast uncertainties are described by the nondiagonal submatrix co r e m 1 e m 2 m1 m2 in cor to simulate scenarios with spatially independent forecast uncertainties we constructed matrix cor that considers only the temporal dependences of uncertainties in each reservoir as shown in eq 32 32 co r co r e 1 e 1 0 0 0 co r e m e m 0 0 0 co r e m e m we assumed it was spatially independent and let the elements in the nondiagonal submatrix co r e m 1 e m 2 m1 m2 be zero to simulate the spatially independent situation one thousand scenarios were generated using the t copula function with cor as the input and v degrees of freedom the simulated correlation matrix is shown in fig 8 the matrix of the simulated dependences agrees well with the benchmark matrix 3 2 2 4 simulation of uncertainties with low order temporal dependences model iii statistical analyses have shown that mcmc preserves significant temporal dependences of forecast uncertainties for a time lag of 18 h the correlation matrices of the benchmark and simulated matrices are presented in fig 9 the characteristics of the dependences within the diagonals of the matrices match well however certain differences can be found between the simulated correlation matrix and the benchmark matrix for areas in which the correlations are low 3 3 real time flood risk analysis for the multireservoir system 3 3 1 flood risk of the multireservoir system the simulated observed inflow scenarios were generated by superimposing the simulated error scenarios on the forecast inflow sequences the flood control operation model was used to optimize the operational strategy under inflow scenarios with variable forecast uncertainties and flood risks were calculated under different models for analysis the safety threshold of water level z m and the safety threshold of natural inflow i m were set as outlined in the conditions of the operational system and hydrology the main parameters of the system are shown in table 2 for comprehensive estimation of the flood risk using the mc simulation sampling for the 1000 inflow scenarios was repeated 50 times then we took the mean risk metrics from the 50 independently run experiments of each model fig 10 the single reservoir risks of bly mzt and xhd are almost equal in model i and ii for an upstream reservoir without any inflow hydraulic connections with other reservoirs the results of the flood risk analysis indicate that neglecting the spatial dependences of the forecast uncertainties has no significant impact on flood risk see comparison of bly mzt and xhd in fig 10 a and 10 b specifically bly mzt and xhd pass the significance test at the 95 confidence level for a downstream reservoir where inflow is affected by water released from upstream reservoirs such as fzl the single reservoir risk in model i is 0 194 while that in model ii is 0 087 the flood risk simulated using model i is significantly higher than that simulated using models ii and iii this is because the inflow of fzl incorporates the influence of the uncertainties regarding release from the bly and mzt reservoirs upstream which is indirectly impacted by the corresponding forecast uncertainties the results also show that the joint flood risk is underestimated when the spatial dependences of the forecast uncertainties are neglected fig 10 a and 10 b the average joint risk of two reservoirs in model i is 1 5 times higher than that in model ii and the average joint risk of three reservoirs in model i is approximately 3 6 times higher than that in model ii the joint risk results for two three and four reservoirs are significantly greater than the results obtained for all cases using a model in which the spatial dependences are neglected the flood risk of an individual reservoir and the joint risks of multiple reservoirs are underestimated when the high order temporal dependences of the forecast uncertainties are neglected fig 10 b and 10 c the results show that the risk results are slightly higher when the high order temporal dependences in the forecast uncertainties are considered than when only low order temporal dependences are considered the differences in flood risk results under different models are affected mainly by two factors 1 differences in the simulation of natural inflow forecast uncertainties and 2 differences in flood control strategies through reservoir operation 3 3 2 differences in natural inflow the probability that the natural inflow exceeds the given threshold is shown in fig 11 and the distribution of the simulated natural inflows is shown in fig 12 these figures highlight the differences in the generated inflow scenarios the following observations can be made through consideration of these figures 1 spatial dependences in the forecast uncertainties have insignificant effect on the distribution of the simulated natural inflows in each reservoir catchment therefore the probability that the natural inflow will exceed the given threshold is almost equal in model i and model ii see bly mzt fzl xhd in fig 11 a and 11 b in contrast the joint probability that the natural inflow of multiple reservoirs will exceed each of the thresholds of the spatially dependent uncertainties is significantly higher than that of the spatially independent uncertainties for example the average joint probability of two reservoirs in model i is 0 5 times higher than in model ii and the average probability of three reservoirs in model i is 1 7 times higher than in model ii the differences in risk responses of the inflow scenarios are consistent therefore the outcome of the flood risk analysis is directly affected by the approach used to represent the sources of uncertainties fig 11 a and 11 b 2 high order temporal dependences of the uncertainties have considerable impact on the distribution of the natural inflow of each reservoir the range of the forecast uncertainties decreases if high order temporal dependences are neglected and the probability of extreme natural inflow events and flood risk decreases for both individual and joint reservoir risks fig 11 b and 11 c to further explore the determination of the distribution of simulated inflow scenarios when using different models the variance of the forecast uncertainties of inflow scenarios var were compared systematically and the differences in the variance for bly and mzt are listed in table 3 as shown in table 3 a under the condition that the variance of bly does not change significantly the total variance of bly and mzt is much greater in model i than in model ii i e the total variance in model i is almost twice that in model ii this is because model ii neglects positive spatial dependences that have the effect of reducing the total variance of the forecast uncertainties in the total inflow to bly and mzt it means that both the total variance and the risk estimated using model ii are lower than obtained using model i see eqs and in appendix a as shown in table 3 b the variance for each reservoir in model iii is lower than in model ii i e the variance of bly in model ii is 1 2 times higher than in model iii as shown by eqs b1 and b2 in appendix b the variance in the total natural inflow of an individual reservoir over the entire planning schedule is underestimated when the positive high order temporal dependences of the forecast uncertainties are underestimated this underestimation results in further underestimations in the variance of the total inflow and both the individual and the joint flood risks 3 3 3 differences in reservoir flood control strategies the release trajectories of each reservoir using the three models plotted in fig 13 show that the reservoir release scenarios are controlled to below the specified thresholds spatial complementarity in the release trajectories can be explored within the bly mzt flz subsystem as the flood control operation model controls the reservoir release below the specified threshold the differences in flood control operation are described by the operational water level trajectories the operational water level trajectories from the different models are shown in fig 14 the differences in the flood control operation can be compared by examining the releases from the upstream reservoirs lateral inflow and total inflow of fzl as shown in fig 15 the results reveal the following 1 the spatial dependences of the forecast uncertainties transit from reservoir inflow to reservoir outflow during flood control operation fig 15 a and 15 d thus the probability of high flow release from bly and mzt in model i is much higher than in model ii 2 spatial dependences of the forecast uncertainties have relatively minor effect on the natural inflow of reservoirs in each subcatchment fig 15 b and 15 c therefore the distributions of lateral inflow to fzl simulated by models i and ii are similar 3 under the comprehensive influences of the uncertainties in the release of the upstream reservoirs and the natural inflows of the reservoirs the uncertainties in the total inflow to fzl reflected in the variances in the flow during the receding flood stage in model i are much higher than in model ii especially between operating period 39 to 60 this is because of the high contribution from the uncertainties propagated through the release and transport processes from the upstream reservoirs 3 4 diagnosis for flood risks risk analysis results under the current operational strategy show that the joint flood risk of the entire system is low 0 5 whereas that of the bly mzt fzl subsystem is moderate 16 9 alteration of reservoir operation aims to lower the joint risk of the subsystem following the flood risk analysis risk diagnosis was conducted for different models based on stochastic simulation and flood risk on the basis of the diagnosis the most stable and the most vulnerable reservoirs within the present situation were analyzed as shown in fig 16 a the value of c p m ω 1 of xhd in model i is much higher than that of other reservoirs it means that if a joint flood risk event occurs for all reservoirs the possibility that the risk event occurs in xhd is up to 0 6502 in comparison with the other reservoirs xhd is the most stable in the system because it is the most likely cause of the joint risk under the present operational strategy as revealed in fig 16 b the value of c p m ω 1 of fzl is approximately twice that of the other reservoirs in model i i e it is up to 0 8696 it demonstrates that fzl is the most stable reservoir in the bly mzt fzl subsystem it can be seen from fig 16 b and 17 d that the value of c p m ω 2 of the entire system and of the bly mzt fzl subsystem for which the values of c p m ω 2 of bly and mzt are nearly equal are much higher than those of fzl or xhd it implies that bly and mzt are the most vulnerable components within the system the values of c p m ω 1 and c p m ω 2 for model ii are also depicted in fig 16 and it can be seen that they are much lower than those for model i in particular in fig 16 a the value of c p m ω 1 of the reservoir system in model ii is zero which means there is no scenario in which the four reservoirs are at risk in this situation obviously although the diagnosis results have the same tendency model ii neglecting the spatial dependences of the forecast uncertainties leads to biased diagnosis results as bly and mzt are diagnosed as vulnerable reservoirs and fzl and xhd are diagnosed as stable reservoirs the operation for lowering down the joint risk of the bly mzt fzl subsystem could be achieved by increasing the outflow of this system while decreasing the outflow of xhd this is because the changed outflow contributed to the most downstream river channel remains approximately the same thus the operational alteration does not significantly change the results of the downstream flood risks of the river channel therefore xhd could use its high storage capacity to store more flood water for reducing the excessive flood risk of the bly mzt fzl subsystem at the low cost of a slight increase in the risk to xhd itself the release limit and flood control risk results before and after adjustment are shown in tables 4 and 5 respectively it can be seen from table 5 that the individual and joint flood control risks of the bly mzt fzl subsystem are generally reduced after adjustment at the expense of increasing the risk to xhd spatially the flood risk is generally distributed homogenously if the results remain unsatisfactory decision makers could change the operation through iterative diagnosis and analysis 4 conclusions real time flood forecasts provide information to support real time flood control operations in a multireservoir system owing to the influence of various errors in the flood forecasting process the uncertainties in the forecast generally have spatial and temporal dependences particularly in small or medium sized watersheds where meteorological conditions are highly similar therefore for accurate analysis of the flood risk it is important to characterize the dependences of the forecast uncertainties accurately the spatial and temporal dependences of forecast uncertainties in multireservoir systems which have generally been neglected in most previous studies potentially yield biased risk assessment results therefore in this study we established an integrated flood risk identification analysis and diagnosis model framework for a complex multireservoir system that considers different types of spatial and temporal dependences using the framework forecast uncertainties were finely characterized with the temporal and spatial dependences preserved in the joint probability function using a copula function discretized scenarios that were generated using the joint probability distribution function served as input to the coupled simulation optimization multireservoir operation model thereafter risk analysis and diagnosis were developed based on the optimizing scheduling scenario set and conditional probability analysis this framework was applied to a multireservoir system in the pi river basin china the following conclusions were based on the results of comparative experiments with models that partially addressed the dependences of forecast uncertainties within typical flood events 1 real time flood forecast uncertainties formed positive spatial and temporal dependences because of the propagation of errors in meteorological forecasts and rainfall runoff propagation effects and the t copula function performed well in quantifying the multidimensional spatial and temporal dependences of the forecast uncertainties 2 the joint flood risk within a multireservoir system will be underestimated if the spatial dependences of the forecast uncertainties are neglected for example the flood risk of two three reservoirs was underestimated by 60 78 3 the variance in the errors in the total inflow forecasts of an individual reservoir are underestimated when high order temporal dependences of the forecast uncertainties are ignored specifically the variance of bly was underestimated by 52 while the variance of bly and mzt was underestimated by 76 it means that both the flood risk of an individual reservoir and the joint flood risk of a multireservoir system are underestimated 4 diagnosis based on flood risk analysis could identify the stable and vulnerable reservoirs of a multireservoir system in terms of resisting risk which could provide guidance regarding adaptive control for changing the risk distribution through real time operation this study established an integrated flood risk identification analysis and diagnosis model framework for a multireservoir system that enables systematic examination of the flood risk response of the reservoir system regarding different dependence information the parameters of the uncertainties and correlation matrices were obtained based on total error analysis of historical floods the optimal selection of the forecast error samples and calibration of the model parameters based on real time information of flood magnitude and meteorological hydrological conditions could be discussed further in future research to improve the accuracy of risk analysis credit authorship contribution statement bin xu supervision methodology software xin huang software writing original draft ran mo investigation ping an zhong conceptualization qingwen lu validation hanwen zhang formal analysis wei si writing review editing jianfeng xiao data curation yu sun declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements we would like to thank the anonymous reviewers for their in depth reviews and constructive suggestions the remarks and summary of reviewer comments provided by the editor and associate editor are also greatly appreciated which have facilitated major improvements in this paper this study is supported by national key technologies r d program of china grant no 2016yfc0400909 the fundamental research funds for the central universities grant no b200202028 b200204038 the china postdoctoral science foundation funded project grant no 2018 t110525 and qing lan project of jiangsu province data will be made available on contacting the first author appendix appendix a influence of spatial dependences on the variance of the errors in the forecast total inflow within a multireservoir system assuming that the forecast inflow volume errors during the entire routing of the control operation are w m3 they can be described by eq a1 a1 w m 1 m t 1 t w m t m 1 m t 1 t e m t δ t where wm t is the error in the inflow volume of reservoir m at time t m3 therefore in the mc simulation the variance in the errors in the forecast inflow of each scenario can be expressed by eq a2 a2 var w var m 1 m t 1 t e m t δ t m 1 m t 1 t var e m t δ t 2 m 1 1 m 1 m 2 m 1 1 m var t 1 t e m 1 t δ t var t 1 t e m 2 t δ t c o v t 1 t e m 1 t δ t t 1 t e m 2 t δ t m 1 1 m co r e m 1 e m 1 2 m 1 1 m 1 m 2 m 1 1 m var t 1 t e m 1 t δ t var t 1 t e m 2 t δ t c o r e m 1 e m 2 when the spatial dependences of the uncertainties are neglected the elements in the nondiagonal submatrix co r e m 1 e m 2 m1 m2 are close to zero however the spatial dependences are mainly positive most of the elements in co r e m 1 e m 2 m1 m2 are 0 and the variance in the inflow volume errors of the spatially independent var w2 is less than that of the spatially dependent var w1 a3 var w 1 var w 2 appendix b influence of high order temporal dependences on the variance in the errors in the inflow forecasts for individual reservoirs if we assume that the forecast inflow volume errors of reservoir m during the entire operation horizon are wm m3 they can be described by eq b1 b1 w m t 1 t w m t t 1 t e m t δ t in the mc simulation the variance in the error of the forecast inflow of reservoir m in each scenario can be expressed as eq b2 b2 var w m var t 1 t e m t δ t t 1 t var e m t δ t 2 t 1 1 t 1 t 2 t 1 1 t var e m t 1 δ t var e m t 2 δ t ρ m t 1 m t 2 when the above τ order temporal dependences are neglected ρ m t 1 m t 2 t 1 t 2 τ is zero therefore the variance in the errors in the inflow volume of reservoir m with τ order temporal dependences var w3 is smaller than that of the total temporal dependences as the above τ order temporal dependences are mainly positive b3 var w 2 var w 3 the dispersion of the error in the inflow volume of reservoir m decreases with each time period and the distribution of the inflow process is relatively centralized by assessing the flood control risk assessment the probability that the natural inflow will exceed the specified threshold decreases significantly by ignoring the high order temporal dependences of the forecast uncertainties both the natural inflow and the flood risk will be underestimated the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
4430,uncertainties in flood forecasts that result from error propagation in meteorological hydrological simulation processes present spatial and temporal dependences that are the principal sources of risk to real time flood control in a multireservoir system risk analysis models that neglect such dependences potentially yield biased results regarding flood control operations to enhance the accuracy of flood risk analysis and inform decision making regarding real time flood control for a multireservoir system this study proposed an integrated flood risk identification analysis and diagnosis model framework that incorporates the multidimensional dependences of forecast uncertainties the framework includes an uncertainty identification model that uses the copula function to characterize the joint probability function of the mixed dependent uncertainties it also incorporates a real time flood risk analysis module that couples simulation and optimization to convert the complex multiobjective operation under uncertainty into a tractable model capable of flexibly evaluating individual and joint flood risks the third component is a risk diagnosis module that calculates risk contributions using conditional probability and identifies stable and vulnerable reservoirs within the system to alter operational decisions toward risk reduction methodologies were verified through application to a mixed four reservoir system in the pi river basin china the principal findings were as follows 1 positive dominated dependences of forecast uncertainties were identified because of error propagation through the meteorological and rainfall runoff forecasts within the spatial and temporal continuity connection and the copula function accurately described and quantified the multidimensional temporal and spatial dependences of the uncertainties 2 in neglecting the spatial dependences of forecast uncertainties the joint flood risk of the reservoir system was underestimated in ignoring high order temporal dependences individual flood risk was underestimated owing to biased estimation in error variance 3 systematic reorganization of the operational strategies of diagnosed stable and vulnerable reservoirs could provide guidance for reduction and homogenization of flood risks the proposed framework could be used to improve the accuracy of flood risk analysis and support reliable real time flood control operation of a multireservoir system keywords reservoir operation uncertainty flood risk analysis diagnosis copula function markov chain 1 introduction a real time flood forecast is an important and useful source of information that can contribute to the development of operational plans for controlling floods in multireservoir systems chen et al 2015b han and coulibaly 2017 currently such forecasts can be obtained using hydrological models calibrated using precipitation and hydrological data zhu et al 2017 however owing to errors associated with the input variables model structure and parameter calibration of the forecast process chen et al 2015a cloke and pappenberger 2009 si et al 2015 the inevitable related uncertainties that exist in the forecasts are widely regarded as the main sources of risk in flood control operations zhu et al 2018 in real time operation uncertainties in flood forecasts lead to biases in expected and actual reservoir operation indicators that can result in flood risk when an actual indicator e g water level or release process exceeds a safety threshold to enhance the safety and robustness of real time reservoir operation during flood periods analysis of the characteristics and distribution of risk is performed as a precursor to informing decision making regarding flood control recently the overall requirements regarding integrated operation of a multireservoir system to control floods have been extended chen et al 2020 meng et al 2019 zhang et al 2019 resulting in urgent need for improvement in the accuracy and completeness of real time risk analysis the specific challenges associated with accomplishing this goal include the following 1 refinement in characterization of the uncertainties to reduce bias in estimations of the probability distribution of risk sources and 2 consideration of the overall complexity of the hydraulic connectivity and influences of reservoir operation with acceptable demands on computational effort and time especially regarding analysis of the joint risk from combined risky events wherein risk could occur in multiple reservoirs and time periods simultaneously this represents a formulation of a type of structured risk analysis problem with consideration of the influence of interaction in reservoir operation methods for analyzing the risk associated with controlling floods in a single reservoir fall into two main categories 1 analytical methods that derive analytic equations for the probability density function of risk events and 2 numerical methods that develop numerical experiments to simulate risk events analytical methods often assume that error sources preserve symmetric unbiased and independent properties through the derivation process which could limit applicability to real world situations chen et al 2017 among the numerical methods the one used most widely is the monte carlo mc simulation the mc approach considers stochastic simulations of risk sources based on historical flood event data and then calculates the likelihood of a future risk event as a risk probability many simulation methods based on the mc approach have been used to characterize uncertainties lu et al 2020 xu et al 2015 xu et al 2019 for example the markov chain haguma et al 2015 wu et al 2019 and martingale zhao et al 2013 models have been adopted to represent uncertain streamflow processes zhou et al 2017 established an adaptive markov chain to assess the risk caused by uncertainties in a design flood process zhao et al 2013 used an improved martingale model to generate non normal marginal distribution error scenarios with a first order time lag temporal dependence chen et al 2016 modified the martingale model into a copula cue model and using it to consider the uncertainties of fourth order temporal dependences analyzed how forecast uncertainties evolved temporally the above methods and applications mainly considered the temporal dependences of uncertainties regarding time lags and weakening multiple time lag temporal dependences in fact owing to the persistent influences of errors in a rainfall flood forecast chain that propagate through rainfall runoff processes temporal dependences usually occur over multiple time periods as biases in estimation of temporal dependences could directly affect the results of risk analysis thorough characterization of temporal dependence information is important to ensure risk analysis accuracy flood control systems consisting of multiple reservoirs are often operated jointly to mitigate potential flood damage to the entire system and associated protected areas consequently the flood risk of a multireservoir system constitutes a spatially and temporally coupled relationship owing to risk propagation through hydrological and hydraulic interconnection via joint operation of the reservoirs if the coupling relationship is addressed real time risk analysis regarding a system of reservoirs represents a dynamic stochastic simulation problem that necessitates a systematic model formulation based on generating and analyzing dynamic multivariate stochastic processes through forecasts and reservoir operation procedures however being restricted by computational requirements model complexity and information abundance for conducting multistage full process simulations of a multireservoir system related research often simplifies risk analysis modeling by reducing both the dimensionality of risk sources and the complexity of risk events hui and lund 2015 introduced a combined flood control operation model to reduce both the maximum flood peak and the risk within a system of parallel reservoirs gong et al 2020 proposed a two stage method for analyzing flood risk in a multireservoir system with the objective of reducing the total risk associated with flood control chen et al 2017 proposed a decomposition integration method for analyzing the risks associated with controlling floods in real time in a complex multireservoir system that included two reservoirs a downstream channel and a control point that were decomposed into several independent subsystems using an mc simulation based on maximum entropy theory the study evaluated how uncertainties were transmitted through the system although previous studies have provided remarkable support for flood risk analysis of multireservoir systems limitations regarding the integrity accuracy flexibility and dependency of risk analysis hinder informed decision making support first most previous related studies assumed that the forecast uncertainties regarding inflow in different sites or subsystems are spatially independent by neglecting their spatial dependences which could lead to bias in evaluation of the combined flood risk in a multireservoir system in fact the forecast errors of floods among different reservoirs within a closely interconnected system are dependent owing to the propagated influence of forecast error through the meteorological hydrological forecast model chain liu et al 2012 second earlier studies applied either pure simulation based or optimization based models for assessing and controlling the risk which meant they lacked the flexibility available through combining the advantages of both types of model regarding improvement of the interaction and optimization efficiencies real time flood control of a complex reservoir system based on partial and uncertain forecasts represents a multistage multiobjective and risky decision making problem xu et al 2020 the principal difficulties that arise regarding determination of a desirable compromise and robust strategy for balancing risk aversion within the complex system necessitate not only abundant and representative scenario analysis via simulation but also guidance based on the knowledge and preferences of decision makers which is difficult to achieve through global optimization third current knowledge seldom provides diagnosis or analysis of the flood risk of vulnerable components within the system limiting the efficiency in both locating the riskiest components and altering strategies toward risk response to further improve overall accuracy and efficiency of risk analysis in flood control efforts could be devoted to investigation of suitable model design and integration throughout the primary three stages risk identification risk analysis and risk diagnosis at the stage of risk source identification preserving information regarding the spatial and temporal dependences of forecasting errors helps improve risk analysis accuracy by capturing information that is more valid this needs a modeling tool that can formulate the multivariate joint probability function of relevant correlated sources of uncertainty the copula function is an effective tool for defining a joint probability function it can model the dependence structure according to the characteristics of correlation and it provides flexibility in selection of marginal distributions owing to these advantages copula functions are used widely in the fields of hydrology and water science for example in design flood calculations grimaldi and serinaldi 2006 analyses of extreme rainfall zhang and singh 2007 and evaluation of drought frequency zhang et al 2013 the modeling process is simplified by separating the determination of the marginal distribution from the calibration of the dependent structure schulte and schumann 2015 and brunner et al 2019 used the copula function to establish the spatial distribution of a combined flood from different drainage basins and analyzed the risk to the area composition proving the copula function capable of coping with multiple hydrological variables and temporal and spatial dependences at multiple stages chen et al 2015c lee and salas 2011 recently copula functions have been used to address low order temporal dependence structures in individual reservoirs however to the best of our knowledge they have not been used previously to capture spatial and temporal correlations regarding multireservoir systems at the risk analysis stage with the oscillation of forecast uncertainties a coupled simulation optimization model that disaggregates systemwide optimization via refined simulation and decision interaction can provide a reservoir flood control strategy and a risk response corresponding to simulated scenarios this represents a modeling tool that can produce a candidate solution with abundant risk information in a real time and dynamic updating environment that offers the possibility of decision intervention at the risk diagnosis stage decision makers seek the opportunity to change the operational strategy to alter the risk distribution if the current results are considered unsatisfactory this process needs information support for both identification of the most stable or most vulnerable reservoir when the risk is changed and formulation of a conditional probability calculation procedure with a given risk status correspondingly scenario based stochastic simulation and flood risk analysis has advantages in terms of computational flexibility and timeliness in comparison with analytical models chen et al 2015a to bridge these knowledge gaps the aims of this study were to enhance the accuracy of flood risk analysis and to inform decision making in relation to a multireservoir system to achieve these objectives a coupled flood control simulation optimization operation model was established for which the temporal and spatial dependences of uncertainties were captured using the copula function and flood risk diagnosis was performed for strategy alteration distinct from previous related studies through risk analysis and control processes we established a novel integrated framework that includes three modules 1 an uncertainty identification and stochastic inflow simulation module to capture the mixed temporal and spatial dependences of real time flood forecast uncertainties 2 a real time flood risk analysis module that couples the stochastic simulation with scenario optimization and 3 a flood risk diagnosis module based on conditional flood risk analysis to explore the stable or vulnerable components of the system the proposed methodologies were verified through application to a mixed four reservoir system in the pi river basin china 2 methodology a flowchart of the framework of the model proposed in this study is presented in fig 1 section 2 1 reveals the process for identification of real time forecast uncertainties and the method for stochastic inflow scenario simulation real time flood forecast uncertainties are defined and identified and both the temporal and the spatial dependence characteristics of the uncertainties are developed the stochastic simulation method for generating discretized inflow scenarios is also established in this section we describe three sets of comparative experiments 1 employing the copula function to capture the complete temporal and spatial dependences of forecast uncertainties model i 2 applying the copula function to generate uncertainties scenarios with temporally dependent dependences model ii and 3 using a markov chain mc simulation mcmc to preserve information regarding low order temporal dependent dependences model iii all scenarios were used as inputs for real time flood risk analysis section 2 2 establishes a real time flood risk analysis module that couples stochastic simulation with scenario optimization the optimizing scheduling process for each inflow scenario can be obtained and flood risk analysis is conducted based on the scenarios set section 2 3 presents a risk diagnosis for the multireservoir system based on the flood risk analysis results the diagnosis identifies the stable and vulnerable reservoirs within the system and provides feedback for flood control strategies of the reservoirs 2 1 identification of real time forecast uncertainties and stochastic inflow scenario simulation 2 1 1 real time flood forecast uncertainties and dependence characteristics real time flood forecast uncertainties errors are the differences between forecast and observed flow and the dependences of the forecast uncertainties are represented by the correlations of these errors in this section we define the real time forecast uncertainties of a multireservoir system and explain the method used to characterize the temporal and spatial dependences 2 1 1 1 identification of forecast uncertainties of a multireservoir system with precipitation sequences as inputs real time flood forecasts are produced using hydrological models that simulate the streamflow generation and routing processes within river basins uncertainties from the precipitation forecast to the flood forecast evolve and become compounded and the total errors comprise errors from a range of sources that include meteorological inputs computational downscaling and the structure and parameters of the hydrological model among these it is generally considered that uncertainties related to precipitation meteorological input errors contribute most to the total uncertainty liu et al 2012 as the errors evolve over space and time the errors in the flood forecast present temporal and spatial dependences fig 2 for instance bias in the process for forecasting precipitation will eventually affect the flood hydrograph at certain time periods the catchment response time while bias in basin scale precipitation will impact the flood hydrograph at multiple sites within the drainage area as defined forecast uncertainties are quantified as the differences between forecast and observed flow 1 e m t q m t q m t t 1 2 t where qm t qm t and em t are the forecast lateral flow observed lateral flow and forecast error of reservoir m in time period t m3 s respectively and t is the length of the forecast horizon h specifically em t is considered a random variable and the source of flood risk the marginal probability distribution function and parameters of em t can be calibrated using historical samples of forecast and observed lateral flow the vector of the forecast error of reservoir m em can be represented by eq 2 2 e m e m 1 e m 2 e m t if there are m reservoirs within the system the augmented vector of the forecast error of the reservoir system e can be described by eq 3 3 e e 1 e 2 e m e 1 1 e 1 2 e 1 t e 1 e 2 1 e 2 2 e 2 t e 2 e m 1 e m 2 e m t e m similarly the relative forecast error can be defined as erm t 4 e r m t e m t q m t accordingly the vector of the relative forecast error of reservoir m erm and the vector of the relative forecast error of the multireservoir system er can be established 2 1 1 2 characteristics of the temporal and spatial dependences cascade uncertainties that propagate through meteorological hydrological forecasts cause temporal and spatial dependent forecast errors the dependent characteristics can be represented by a correlation coefficient matrix that can provide information for constructing the multivariate joint distribution this study used a correlation matrix cor to describe the temporal and spatial dependences of the forecast uncertainties as expressed by eqs 5 and 6 the full information of the matrix is given by eq 5 while eq 6 describes a simplified formulation by disaggregating the matrix into components of submatrices 5 e 1 1 e 1 t e m 1 e m t e m 1 e m t c o r e 1 1 e 1 t e m 1 e m t e m 1 e m t ρ 1 1 1 1 ρ 1 1 1 t ρ 1 t 1 1 ρ 1 t 1 t ρ 1 1 m 1 ρ 1 1 m t ρ 1 t m 1 ρ 1 t m t ρ 1 1 m 1 ρ 1 1 m t ρ 1 t m 1 ρ 1 t m t ρ m 1 1 1 ρ m 1 1 t ρ m t 1 1 ρ m t 1 t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t ρ m 1 1 1 ρ m 1 1 t ρ m t 1 1 ρ m t 1 t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t 6 cor co r e 1 e 1 co r e m e 1 co r e m e 1 co r e 1 e m co r e m e m co r e m e m co r e 1 e m co r e m e m co r e m e m where ρ m 1 t 1 m 2 t 2 m 1 m 2 1 2 m t 1 t 2 1 2 t denotes the pearson correlation coefficient between forecast error e m 1 t 1 and e m 2 t 2 therefore when m 1 m 2 t 1 t 2 ρ m 1 t 1 m 2 t 2 calculates the temporal dependence of the forecast errors between lead time t 1 and t 2 in reservoir m 1 if m 1 m 2 t 1 t 2 ρ m 1 t 1 m 2 t 2 computes the spatial dependence of the forecast errors at lead time t 1 between reservoir m 1 and m 2 otherwise ρ m 1 t 1 m 2 t 2 represents the mixed spatial and temporal dependences the submatrix in the main diagonal of cor in eqs 5 and 6 represents the temporal dependences i e co r e m e m ρ m 1 m 1 ρ m 1 m t ρ m t m 1 ρ m t m t determines the complex pairwise temporal dependences for all time periods in reservoir m the other submatrices outside the main diagonal determine the mixed spatial and temporal dependences of all time periods between any given two reservoirs i e co r e m e 1 ρ m 1 1 1 ρ m 1 1 t ρ m t 1 1 ρ m t 1 t if the forecast errors of reservoir m and reservoir 1 are assumed spatially independent then co r e m e 1 is a zero matrix a schematic of the dependence relationship of the forecast errors is shown in fig 3 the calibration of cor necessitates abundant data samples which can be realized from databases because real time flood forecasts are frequently made in a rolling horizon with updates moreover data from multiple flood events can also be used by extracting samples at different lead times which could ensure representativeness of the information when samples from different floods with various magnitudes are considered 2 1 2 stochastic simulation of flood forecast uncertainties of a multireservoir system 2 1 2 1 sampling methods based on the copula function in this section the copula function is applied in establishing the joint distribution of the forecast uncertainties and scenario simulation the process involves the following three steps 1 establishing the marginal distribution of the forecast uncertainty series 2 constructing the joint distribution using the copula function and 3 simulating scenarios based on the marginal distribution and joint structure 1 establishing the marginal distribution using the collected data samples of forecast errors a suitable marginal distribution is calibrated using maximum likelihood estimation 2 constructing the joint distribution the copula function is a popular tool in multivariate modeling yan 2007 the joint probability density function f x1 x2 xn of variables x1 x2 xn can be described by eq 7 according to sklar s theorem sklar 1960 7 f x 1 x 2 x n c w 1 w 2 w n f x 1 f x n 8 c w 1 w 2 w n c w 1 w 2 w n w 1 w 2 w n 9 f x i w i i 1 2 n where f x1 f x2 f xn are the marginal probability density functions of variables x1 x2 xn and c w1 w2 wn is the copula function of the various copula functions available members of the archimedean copula family e g the frank gumbel and clayton copulas are often used in bivariate modeling but are unsuitable for multivariate modeling the vine copula and metaelliptical copula are widely employed to establish a multivariate usually greater than two joint probability distribution for multivariable modeling the vine copula introduces a large number of possible pair copula decompositions aas et al 2009 which means that a reasonable copula type can be determined only through massive parameter estimation and structure selection which is computationally complex in addition the vine structure e g the d vine or canonical vine cannot fully address all combinational temporal spatial dependences within the structure formulation stage which potentially causes loss of dependence information in comparison with the vine copula the metaelliptical copula can model multidimensional dependences with cor and in a simple structure therefore owing to the limitations of the vine copula the metaelliptical copula was applied in this study the t copula is a typical metaelliptical copula function that can produce fine descriptions of multidimensional dependences in this study we applied the t copula function to the multidimensional joint distribution of the temporal and spatial dependences of the forecast uncertainties of the reservoir system and eq 10 expresses the connection function of the t copula function 10 c u c o r v t 1 u 1 t 1 u n γ v n v γ v 2 π v n c o r 1 1 v x t c o r 1 x v n 2 d x where cor is the correlation matrix v represents the degrees of freedom and n represents the number of variables 3 scenario simulation based on the marginal and joint distribution the flood forecast uncertainty series was obtained from historical forecasts and observed data and the marginal distribution was established through step 1 the multidimensional joint distribution of the uncertainties was established through step 2 then mc random sampling demarta and mcneil 2005 was used to generate the scenarios of the flood forecast process by generating random vectors with correlations θ 1 l θ 2 l θ 3 l θ d l l 1 2 l based on cor and v the degrees of freedom and l as the total number of scenarios superimposing the error scenarios on the forecast inflow processes yields the simulated observed inflow scenarios with different dependences as shown in fig 4 11 i m l t q m t e o m l t l 1 2 l t 1 2 t m 1 2 m where eol m t are the simulated errors of reservoir m for scenario l m3 s and il m t are the simulated natural flow processes without the influence of reservoir operation of reservoir m at scenario l m3 s 2 1 2 2 sampling methods based on mcmc various practical applications only consider low order time lagged temporal dependences when accounting for uncertainties in forecasts in this section we simulate the stochastic inflow process using a multiorder markov chain as an alternative and to facilitate comparison this method assumes that the uncertainties for a multireservoir system are spatially independent the markov chain is a stochastic model that describes a sequence of possible events wherein the probability of each event depends only on the state attained in previous events as the range of the variation of historical error samples is discretized into several mutually exclusive intervals within different lead time periods the state can be identified as the situation of a given sample that falls within a certain interval raftery 1985 raftery and tavare 1994 the transition of the states follows the given transition probability equation with τ order dependence 12 p r o b g e m t 1 g t 1 g e m t g t g e m t 1 g t 1 g e m 1 g 1 p r o b g e m t 1 g t 1 g e m t g t g e m t τ g t τ where g em t gt is an event where the forecast error s state is gt at lead time t the transition probability describes the probability that the forecast error changes from one state to another after i step moves the i step transition probability matrix tpm i can be obtained from the historical forecast and the observed process had 2010 taking the generation of inflow scenarios of reservoir m as an example the multiorder mcmc simulation can be divided into the following four steps 1 state discretization the relative errors of each lead time in erm are uniformly divided into r intervals states 2 transition probability matrix calculation the i step transition matrix tm i is constructed by calculating the transition steps f α β i from one state α time t to another state β time t i in the sample sequences 13 t m i f 1 1 i f r 1 i f 1 2 i f r 2 i f 1 r i f r r i i 1 2 τ and tpm i can be estimated according to tm i as shown in eqs 14 and 15 14 tp m i p 1 1 i p r 1 i p 1 2 i p r 2 i p 1 r i p r r i i 1 2 τ 15 p α β i f α β i β 1 r f α β i β 1 r f α β i 0 0 β 1 r f α β i 0 3 estimating the weights of the transition steps the state gt τ at lead time t τ depends on the states from lead time t to t τ 1 the corresponding transition probability matrix and weight coefficients are shown in eq 16 16 g t τ i 1 τ λ i t p m i g t τ i where λ i is the weight coefficient of transition probability matrix tpm i the parameter λ i can be estimated by solving the linear programming problem shown in eq 17 ching 2002 17 min ω λ s t ω ω ω x b λ 1 λ 2 λ τ ω 0 i 1 τ λ i 1 λ i 0 i ω ω ω x b λ 1 λ 2 λ τ where x x1 x2 xi t which is the total frequency of each state in the sample sequences and b tpm 1 x tpm 2 x tpm τ x 4 scenario generation relative forecast error scenarios of the first τ times erol m 1 erol m 2 erol m τ l 1 2 l which satisfy eq 18 are randomly generated according to eqs 13 17 the states of the relative forecast errors of a later lead time t τ can be calculated in turn by uniformly sampling in each state we obtain erol m τ erol m τ 1 erol m t l 1 2 l we then obtain the simulation scenarios of the relative forecast errors processes ero1 m t ero2 m t erol m t 18 er o m l 1 u min e r m 1 max e r m 1 e r o m l 2 u min e r m 2 max e r m 2 where u is the uniform distribution the natural inflow forecast scenarios can be simulated as shown in eq 19 19 i m l t q m t 1 e r o m l t l 1 2 l t 1 2 t m 1 2 m where il m t is the simulated natural inflow 2 2 real time flood risk analysis for a multireservoir system 2 2 1 flood control operation model for a multireservoir system the results of flood risk analyses are dependent not only on the characteristics of the uncertainties but also on reservoir operation strategies flood control operations deal with two types of conflicting objective 1 to lower reservoir outflow for the safety of downstream protected regions and 2 to increase reservoir outflow to ensure the safety of the reservoir and upstream area thus formulating a multiobjective operation to coordinate the conflicting objectives and enhance decision making efficiency we established a combined interactive optimization model the model optimizes the highest water level of a reservoir with successive iterations over a series of reservoirs by constraining the reservoir outflow limits which converts the multiobjective optimization modeling into a constrained single objective optimization in each scenario generated from section 2 1 the objective of the optimizing operation is to minimize the highest water level the optimization objective can be expressed as in eq 20 20 min f min max t z m l t t 1 2 t where zl m t is the water level of reservoir m the constraints are given in eqs 21 25 1 mass balance equation 21 v m l t 1 v m l t i n m l t q o m l t δ t where vl m t and vl m t 1 are the reservoir storage at the begin and end of time t for scenario l m3 respectively inl m t is the inflow m3 s qol m t is the reservoir outflow release m3 s and δt is the time interval s 2 hydraulic continuity equation the inflow of reservoir m comprises two parts natural inflow generated in the local catchment area il m t t 1 2 t and water that is released from any upstream reservoir qul m t t 1 2 t m3 s if there is no upstream reservoir qul m t 0 therefore the inflow process of reservoir m under scenario l inl m t can be described by eq 22 22 i n m l t i m l t q u m l t 3 reservoir release limits 23 0 q o m l t q o m where q o m is the release limit m3 s by applying this constraint the optimizing reservoir release does not exceed the set discharge and downstream regions are protected the term q o m is the key parameter for coordinating the multiple risk objectives through integrating the stochastic simulation and scenario optimization changing the value of q o m could yield the following results 1 coordinating the risks of upstream and downstream reservoirs by lowering increasing the risk of the downstream reservoir by reducing increasing q o m and 2 altering the spatial distribution of flood risks among parallel reservoirs finally desirable results can be achieved according to the preferences of decision makers and trial and error 4 reservoir release fluctuation limits 24 q o m l t 1 q o m l t δ q o m where δqom is the permissible maximum release fluctuation of reservoir m m3 s this limits the difference in the water released from the reservoir between two adjacent periods and ensures both the stability of the riverbank and the navigational safety of the downstream river channel 5 initial and boundary conditions 25 z m l 1 z i m z m l t 1 z e m where zim is the initial water level m and zem is the target end water level m parameter zem is usually set as the flood limited water level in the flood season this is because it is usually expected that the water level will fall back to the flood limited level at the end of a planning horizon to deal with possible subsequent flood events thus this is often treated as a soft constraint zhu et al 2017 in a multireservoir system an upstream reservoir is operated with the objective of protecting its own protected areas but it is also managed to lower the risks of downstream reservoirs and their protected regions through reduction of its outflow release thus if the calculated flood risks of downstream reservoirs exceed their tolerance level interactive optimization iterations can be triggered by reducing the release from upstream reservoirs to meet the expectations of decision makers 2 2 2 flood risk analysis during real time reservoir operation any unexpected surplus in inflow caused by forecast uncertainties could be accommodated by either storing the water in the reservoir or releasing it to the downstream river this process could elevate risk in upstream areas when the operational water level exceeds the water level safety threshold or in downstream areas when reservoir release exceeds the safety discharge level owing to the possible catastrophic consequences of downstream events such as inundation damage and losses from levee failure the reservoir release limit is addressed as a hard constraint constraint 3 in section 2 2 1 for minimizing downstream risk consequently the risk is transposed to upstream reservoirs we therefore focus mainly on upstream flood risk which is defined as the probability of the simulated water level exceeding the given threshold as shown in eq 26 26 p z m max t prob z m t z m max t c o u n t l z m l t z m l where pz m is the flood risk of reservoir m z m is the safety threshold of the water level max t prob z m t z m is the maximum probability that z m will be exceeded during the operation horizon l is the total number of scenarios and count is the counting function in a complex reservoir system decision makers are concerned more about the joint flood risk i e where several reservoirs are threatened by flood events than about the risk to individual reservoirs the joint flood risk is the joint probability that multiple reservoirs within a system simultaneously exceed their safety thresholds 27 p z ω max t prob z a 1 t z a 1 z a 2 t z a 2 z a n t z a n max t c o u n t l z a 1 l t z a 1 z a 2 l t z a 2 z a n l t z a n l where ω a1 a2 an pz ω is the set of reservoirs considered in the assessment and a1 a2 an are the indices of the member reservoirs within the set to compare the differences in simulated natural inflows under different dependences of forecast uncertainties we considered the probability that the simulated natural inflow would exceed the set threshold pim eq 28 and used the joint probability that the reservoirs natural inflows would exceed their thresholds piω eq 29 as an index with which to evaluate the frequency that extreme inflow events would occur because of uncertainties 28 p i m max t prob i m t i m max t c o u n t l i m l t i m l where i m is the natural inflow threshold of reservoir m and max t prob i m t i m is the frequency of the maximum probability that the inflow would exceed i m 29 p i ω max t prob i a 1 t i a 1 i a 2 t i a 2 i a n t i a n max t c o u n t l i a 1 l t i a 1 i a 2 l t i a 2 i a n l t i a n l where piω is the joint probability of the natural inflows exceeding their thresholds simultaneously 2 3 flood risk diagnosis flood risk analysis provides abundant information regarding individual and joint risk as risk response is highly affected by the operational strategy of a reservoir system it is critical to seek a reasonable approach for changing the strategy when current risk results are undesirable however owing to system complexity identifying the most effective operational mode is often difficult this is because changing the operational strategy of any reservoir within the system could change the spatial distribution of risk therefore diagnosing stable and vulnerable reservoirs based on their contributions to system risk not only improves decision making efficiency but also helps reduce risk with the scenario based stochastic simulations and flood risk analysis results we established a risk diagnosis module based on conditional probability for application to a complex multireservoir system for example the frequency analysis method was used to calculate the following conditional probabilities for diagnosing stable and vulnerable reservoirs within the multireservoir system 1 identify the most stable reservoir of the system the most stable reservoir means that it is a key component of the entire system if a joint risk event occurs in the system it is most likely influenced by the occurrence of flood risk in this reservoir this could be determined by ranking the value of the conditional probability of a joint risk event in the whole system given an individual flood risk event in one reservoir this conditional probability can be calculated as shown in eq 30 30 c p m ω 1 prob r 1 r m r m r m where c p m ω 1 is the conditional probability of risk event rm given joint risk event r1 rm rm the reservoir with the highest c p m ω 1 is the most stable reservoir within the multireservoir system 2 identify the most vulnerable reservoir of the system the most vulnerable reservoir is a weak component of the system if a general risk event occurs within the system it is highly likely to have been induced by the most vulnerable reservoir this conditional probability is expressed as the risk probability of an individual reservoir given any risk event occurring within the system and it can be calculated as shown in eq 31 31 c p m ω 2 prob r m r 1 r m r m where c p m ω 2 is the conditional probability of reservoir m and r1 rm rm means there is a general flood risk event in one or more reservoirs the reservoir with the highest c p m ω 2 is the most vulnerable reservoir within the multireservoir system when a multireservoir system encounters a system wide flood event the operational strategy should target careful balance between security assurance of vulnerable reservoirs and risk aversion of stable reservoirs to reduce the overall risk and potential losses after identifying the major cause of the considered risk results decision makers could quickly reproduce the risk results by changing the operational strategy of selected reservoirs based on the risk diagnosis 3 case study 3 1 overview of the multireservoir system and data series 3 1 1 the multireservoir system a mixed four reservoir system in the pi river basin which is one of the upper tributaries of the huai river in china was selected as the study area the river basin is within the climatic transition zone from southern china to northern china which is an area affected by the monsoon climate and frequently subjected to rainstorms and floods the four reservoirs in the system comprise the bailianya bly mozitan mzt and foziling fzl reservoirs on the east pi river and the xianghongdian xhd reservoir on the west pi river certain parameters of the multireservoir system are listed in table 1 and the geographical and topological relationships of the system are illustrated in fig 5 3 1 2 data the flood control operation of the multireservoir system is supported by monitored rainfall and flood information data and real time forecasting systems the flood forecast system driven by observed rainfall data and weather forecasts produced by the china meteorological administration using a numerical weather prediction model provides automatic forecasts with forecast horizons of 72 h and a 3 h time step the automatic forecast information is provided at 3 h intervals in the form of a rolling forecast detailed information regarding the forecast and observed data can be found on the anhui water information website http yc wswj net ahsxx lol public public html a flow process flood no 20050809 in 2005 with a return period of approximately 20 years was chosen as the test case 3 2 identification of forecast uncertainties and stochastic scenario simulations 3 2 1 identification of forecast uncertainties this section shows how the forecast uncertainties of each reservoir within the system are calculated based on historical forecasts and observed flow processes and the uncertainties are fitted with a reasonable marginal distribution the results of the data sample verify that a normal distribution could be used as the marginal distribution of the forecast uncertainties with different lead times in different reservoirs maximum likelihood estimation was used to estimate their parameters and the fitted distributions passed the chi square goodness of fit test at the 0 90 confidence level as examples fig 6 presents distributions of the forecast uncertainties for bly and mzt with lead times of 6 and 12 h 3 2 2 stochastic simulation of real time forecast uncertainties of the multireservoir system this section outlines the development of three sets of numerical experiments designed to consider different temporal and spatial dependences describes how the copula function and mcmc are used to generate inflow scenarios based on both spatial and temporal dependences and solely on temporal including low order dependences of the forecast uncertainties preserved within the system and examines how the performance of the simulation methods is verified 3 2 2 1 numerical experiments examining different temporal and spatial dependences three sets of numerical experiments using three models to drive the coupled flood risk analysis models were conducted we were particularly interested in performing pair wise comparisons to determine how the spatial and temporal dependences of forecast uncertainties influence the flood risk model i this model included the joint distribution of the forecast uncertainties that captured the spatial and temporal dependences using the copula function this model provided the actual estimation of flood risk results under full information conditions model ii this model included the joint distribution of the forecast uncertainties that considered only temporal dependences using the copula function model iii this model used a multiorder markov chain and considered only the low order temporal dependences of the forecast uncertainties comparison of the risk analysis results of model ii with those of model i reveals the impact of spatial dependences on flood risk comparison of the results of model iii with those of model ii highlights the impact of temporal dependences on flood risk as numerical experiments based on mc simulations are influenced by randomness the experiment results were tested repeatedly resampling 50 times to examine the significance of the variation in the statistical indices 3 2 2 2 simulation of uncertainties with temporal and spatial dependences model i the t copula function was used to characterize the dependences of the historical forecast and observed flood data the correlation coefficient matrix cor of the real time forecast uncertainties and the degrees of freedom v in the system were estimated by maximum likelihood estimation and used as the input parameter of the t copula function one thousand scenarios were generated graphs of cor for the historical sample statistics and the generated scenarios are shown in fig 7 the forecast uncertainties present significant positive spatial and temporal dependences in the system this is because of the consecutive influence on the flood forecast error caused by the propagation of biases in the precipitation forecast error as shown in fig 7 there are high spatial dependences of forecast uncertainties in bly mzt and fzl in the east pi river and the correlation coefficients are generally 0 5 the spatial dependences are low between the three reservoirs and xhd in the west pi river the temporal dependences of the forecast uncertainties in each reservoir are high and the temporal correlation coefficients are generally 0 8 as shown in fig 7 the matrix of dependences of the stochastic scenarios generated using the t copula function mostly match the actual matrix the joint distribution established by t copula function could pass the goodness of fit test based on probability integral transformation breymann et al 2003 and the kolmogorov smirnov test at the 95 confidence level p value 0 9018 3 2 2 3 simulation of uncertainties with temporal dependences model ii the spatial dependences of the forecast uncertainties are described by the nondiagonal submatrix co r e m 1 e m 2 m1 m2 in cor to simulate scenarios with spatially independent forecast uncertainties we constructed matrix cor that considers only the temporal dependences of uncertainties in each reservoir as shown in eq 32 32 co r co r e 1 e 1 0 0 0 co r e m e m 0 0 0 co r e m e m we assumed it was spatially independent and let the elements in the nondiagonal submatrix co r e m 1 e m 2 m1 m2 be zero to simulate the spatially independent situation one thousand scenarios were generated using the t copula function with cor as the input and v degrees of freedom the simulated correlation matrix is shown in fig 8 the matrix of the simulated dependences agrees well with the benchmark matrix 3 2 2 4 simulation of uncertainties with low order temporal dependences model iii statistical analyses have shown that mcmc preserves significant temporal dependences of forecast uncertainties for a time lag of 18 h the correlation matrices of the benchmark and simulated matrices are presented in fig 9 the characteristics of the dependences within the diagonals of the matrices match well however certain differences can be found between the simulated correlation matrix and the benchmark matrix for areas in which the correlations are low 3 3 real time flood risk analysis for the multireservoir system 3 3 1 flood risk of the multireservoir system the simulated observed inflow scenarios were generated by superimposing the simulated error scenarios on the forecast inflow sequences the flood control operation model was used to optimize the operational strategy under inflow scenarios with variable forecast uncertainties and flood risks were calculated under different models for analysis the safety threshold of water level z m and the safety threshold of natural inflow i m were set as outlined in the conditions of the operational system and hydrology the main parameters of the system are shown in table 2 for comprehensive estimation of the flood risk using the mc simulation sampling for the 1000 inflow scenarios was repeated 50 times then we took the mean risk metrics from the 50 independently run experiments of each model fig 10 the single reservoir risks of bly mzt and xhd are almost equal in model i and ii for an upstream reservoir without any inflow hydraulic connections with other reservoirs the results of the flood risk analysis indicate that neglecting the spatial dependences of the forecast uncertainties has no significant impact on flood risk see comparison of bly mzt and xhd in fig 10 a and 10 b specifically bly mzt and xhd pass the significance test at the 95 confidence level for a downstream reservoir where inflow is affected by water released from upstream reservoirs such as fzl the single reservoir risk in model i is 0 194 while that in model ii is 0 087 the flood risk simulated using model i is significantly higher than that simulated using models ii and iii this is because the inflow of fzl incorporates the influence of the uncertainties regarding release from the bly and mzt reservoirs upstream which is indirectly impacted by the corresponding forecast uncertainties the results also show that the joint flood risk is underestimated when the spatial dependences of the forecast uncertainties are neglected fig 10 a and 10 b the average joint risk of two reservoirs in model i is 1 5 times higher than that in model ii and the average joint risk of three reservoirs in model i is approximately 3 6 times higher than that in model ii the joint risk results for two three and four reservoirs are significantly greater than the results obtained for all cases using a model in which the spatial dependences are neglected the flood risk of an individual reservoir and the joint risks of multiple reservoirs are underestimated when the high order temporal dependences of the forecast uncertainties are neglected fig 10 b and 10 c the results show that the risk results are slightly higher when the high order temporal dependences in the forecast uncertainties are considered than when only low order temporal dependences are considered the differences in flood risk results under different models are affected mainly by two factors 1 differences in the simulation of natural inflow forecast uncertainties and 2 differences in flood control strategies through reservoir operation 3 3 2 differences in natural inflow the probability that the natural inflow exceeds the given threshold is shown in fig 11 and the distribution of the simulated natural inflows is shown in fig 12 these figures highlight the differences in the generated inflow scenarios the following observations can be made through consideration of these figures 1 spatial dependences in the forecast uncertainties have insignificant effect on the distribution of the simulated natural inflows in each reservoir catchment therefore the probability that the natural inflow will exceed the given threshold is almost equal in model i and model ii see bly mzt fzl xhd in fig 11 a and 11 b in contrast the joint probability that the natural inflow of multiple reservoirs will exceed each of the thresholds of the spatially dependent uncertainties is significantly higher than that of the spatially independent uncertainties for example the average joint probability of two reservoirs in model i is 0 5 times higher than in model ii and the average probability of three reservoirs in model i is 1 7 times higher than in model ii the differences in risk responses of the inflow scenarios are consistent therefore the outcome of the flood risk analysis is directly affected by the approach used to represent the sources of uncertainties fig 11 a and 11 b 2 high order temporal dependences of the uncertainties have considerable impact on the distribution of the natural inflow of each reservoir the range of the forecast uncertainties decreases if high order temporal dependences are neglected and the probability of extreme natural inflow events and flood risk decreases for both individual and joint reservoir risks fig 11 b and 11 c to further explore the determination of the distribution of simulated inflow scenarios when using different models the variance of the forecast uncertainties of inflow scenarios var were compared systematically and the differences in the variance for bly and mzt are listed in table 3 as shown in table 3 a under the condition that the variance of bly does not change significantly the total variance of bly and mzt is much greater in model i than in model ii i e the total variance in model i is almost twice that in model ii this is because model ii neglects positive spatial dependences that have the effect of reducing the total variance of the forecast uncertainties in the total inflow to bly and mzt it means that both the total variance and the risk estimated using model ii are lower than obtained using model i see eqs and in appendix a as shown in table 3 b the variance for each reservoir in model iii is lower than in model ii i e the variance of bly in model ii is 1 2 times higher than in model iii as shown by eqs b1 and b2 in appendix b the variance in the total natural inflow of an individual reservoir over the entire planning schedule is underestimated when the positive high order temporal dependences of the forecast uncertainties are underestimated this underestimation results in further underestimations in the variance of the total inflow and both the individual and the joint flood risks 3 3 3 differences in reservoir flood control strategies the release trajectories of each reservoir using the three models plotted in fig 13 show that the reservoir release scenarios are controlled to below the specified thresholds spatial complementarity in the release trajectories can be explored within the bly mzt flz subsystem as the flood control operation model controls the reservoir release below the specified threshold the differences in flood control operation are described by the operational water level trajectories the operational water level trajectories from the different models are shown in fig 14 the differences in the flood control operation can be compared by examining the releases from the upstream reservoirs lateral inflow and total inflow of fzl as shown in fig 15 the results reveal the following 1 the spatial dependences of the forecast uncertainties transit from reservoir inflow to reservoir outflow during flood control operation fig 15 a and 15 d thus the probability of high flow release from bly and mzt in model i is much higher than in model ii 2 spatial dependences of the forecast uncertainties have relatively minor effect on the natural inflow of reservoirs in each subcatchment fig 15 b and 15 c therefore the distributions of lateral inflow to fzl simulated by models i and ii are similar 3 under the comprehensive influences of the uncertainties in the release of the upstream reservoirs and the natural inflows of the reservoirs the uncertainties in the total inflow to fzl reflected in the variances in the flow during the receding flood stage in model i are much higher than in model ii especially between operating period 39 to 60 this is because of the high contribution from the uncertainties propagated through the release and transport processes from the upstream reservoirs 3 4 diagnosis for flood risks risk analysis results under the current operational strategy show that the joint flood risk of the entire system is low 0 5 whereas that of the bly mzt fzl subsystem is moderate 16 9 alteration of reservoir operation aims to lower the joint risk of the subsystem following the flood risk analysis risk diagnosis was conducted for different models based on stochastic simulation and flood risk on the basis of the diagnosis the most stable and the most vulnerable reservoirs within the present situation were analyzed as shown in fig 16 a the value of c p m ω 1 of xhd in model i is much higher than that of other reservoirs it means that if a joint flood risk event occurs for all reservoirs the possibility that the risk event occurs in xhd is up to 0 6502 in comparison with the other reservoirs xhd is the most stable in the system because it is the most likely cause of the joint risk under the present operational strategy as revealed in fig 16 b the value of c p m ω 1 of fzl is approximately twice that of the other reservoirs in model i i e it is up to 0 8696 it demonstrates that fzl is the most stable reservoir in the bly mzt fzl subsystem it can be seen from fig 16 b and 17 d that the value of c p m ω 2 of the entire system and of the bly mzt fzl subsystem for which the values of c p m ω 2 of bly and mzt are nearly equal are much higher than those of fzl or xhd it implies that bly and mzt are the most vulnerable components within the system the values of c p m ω 1 and c p m ω 2 for model ii are also depicted in fig 16 and it can be seen that they are much lower than those for model i in particular in fig 16 a the value of c p m ω 1 of the reservoir system in model ii is zero which means there is no scenario in which the four reservoirs are at risk in this situation obviously although the diagnosis results have the same tendency model ii neglecting the spatial dependences of the forecast uncertainties leads to biased diagnosis results as bly and mzt are diagnosed as vulnerable reservoirs and fzl and xhd are diagnosed as stable reservoirs the operation for lowering down the joint risk of the bly mzt fzl subsystem could be achieved by increasing the outflow of this system while decreasing the outflow of xhd this is because the changed outflow contributed to the most downstream river channel remains approximately the same thus the operational alteration does not significantly change the results of the downstream flood risks of the river channel therefore xhd could use its high storage capacity to store more flood water for reducing the excessive flood risk of the bly mzt fzl subsystem at the low cost of a slight increase in the risk to xhd itself the release limit and flood control risk results before and after adjustment are shown in tables 4 and 5 respectively it can be seen from table 5 that the individual and joint flood control risks of the bly mzt fzl subsystem are generally reduced after adjustment at the expense of increasing the risk to xhd spatially the flood risk is generally distributed homogenously if the results remain unsatisfactory decision makers could change the operation through iterative diagnosis and analysis 4 conclusions real time flood forecasts provide information to support real time flood control operations in a multireservoir system owing to the influence of various errors in the flood forecasting process the uncertainties in the forecast generally have spatial and temporal dependences particularly in small or medium sized watersheds where meteorological conditions are highly similar therefore for accurate analysis of the flood risk it is important to characterize the dependences of the forecast uncertainties accurately the spatial and temporal dependences of forecast uncertainties in multireservoir systems which have generally been neglected in most previous studies potentially yield biased risk assessment results therefore in this study we established an integrated flood risk identification analysis and diagnosis model framework for a complex multireservoir system that considers different types of spatial and temporal dependences using the framework forecast uncertainties were finely characterized with the temporal and spatial dependences preserved in the joint probability function using a copula function discretized scenarios that were generated using the joint probability distribution function served as input to the coupled simulation optimization multireservoir operation model thereafter risk analysis and diagnosis were developed based on the optimizing scheduling scenario set and conditional probability analysis this framework was applied to a multireservoir system in the pi river basin china the following conclusions were based on the results of comparative experiments with models that partially addressed the dependences of forecast uncertainties within typical flood events 1 real time flood forecast uncertainties formed positive spatial and temporal dependences because of the propagation of errors in meteorological forecasts and rainfall runoff propagation effects and the t copula function performed well in quantifying the multidimensional spatial and temporal dependences of the forecast uncertainties 2 the joint flood risk within a multireservoir system will be underestimated if the spatial dependences of the forecast uncertainties are neglected for example the flood risk of two three reservoirs was underestimated by 60 78 3 the variance in the errors in the total inflow forecasts of an individual reservoir are underestimated when high order temporal dependences of the forecast uncertainties are ignored specifically the variance of bly was underestimated by 52 while the variance of bly and mzt was underestimated by 76 it means that both the flood risk of an individual reservoir and the joint flood risk of a multireservoir system are underestimated 4 diagnosis based on flood risk analysis could identify the stable and vulnerable reservoirs of a multireservoir system in terms of resisting risk which could provide guidance regarding adaptive control for changing the risk distribution through real time operation this study established an integrated flood risk identification analysis and diagnosis model framework for a multireservoir system that enables systematic examination of the flood risk response of the reservoir system regarding different dependence information the parameters of the uncertainties and correlation matrices were obtained based on total error analysis of historical floods the optimal selection of the forecast error samples and calibration of the model parameters based on real time information of flood magnitude and meteorological hydrological conditions could be discussed further in future research to improve the accuracy of risk analysis credit authorship contribution statement bin xu supervision methodology software xin huang software writing original draft ran mo investigation ping an zhong conceptualization qingwen lu validation hanwen zhang formal analysis wei si writing review editing jianfeng xiao data curation yu sun declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements we would like to thank the anonymous reviewers for their in depth reviews and constructive suggestions the remarks and summary of reviewer comments provided by the editor and associate editor are also greatly appreciated which have facilitated major improvements in this paper this study is supported by national key technologies r d program of china grant no 2016yfc0400909 the fundamental research funds for the central universities grant no b200202028 b200204038 the china postdoctoral science foundation funded project grant no 2018 t110525 and qing lan project of jiangsu province data will be made available on contacting the first author appendix appendix a influence of spatial dependences on the variance of the errors in the forecast total inflow within a multireservoir system assuming that the forecast inflow volume errors during the entire routing of the control operation are w m3 they can be described by eq a1 a1 w m 1 m t 1 t w m t m 1 m t 1 t e m t δ t where wm t is the error in the inflow volume of reservoir m at time t m3 therefore in the mc simulation the variance in the errors in the forecast inflow of each scenario can be expressed by eq a2 a2 var w var m 1 m t 1 t e m t δ t m 1 m t 1 t var e m t δ t 2 m 1 1 m 1 m 2 m 1 1 m var t 1 t e m 1 t δ t var t 1 t e m 2 t δ t c o v t 1 t e m 1 t δ t t 1 t e m 2 t δ t m 1 1 m co r e m 1 e m 1 2 m 1 1 m 1 m 2 m 1 1 m var t 1 t e m 1 t δ t var t 1 t e m 2 t δ t c o r e m 1 e m 2 when the spatial dependences of the uncertainties are neglected the elements in the nondiagonal submatrix co r e m 1 e m 2 m1 m2 are close to zero however the spatial dependences are mainly positive most of the elements in co r e m 1 e m 2 m1 m2 are 0 and the variance in the inflow volume errors of the spatially independent var w2 is less than that of the spatially dependent var w1 a3 var w 1 var w 2 appendix b influence of high order temporal dependences on the variance in the errors in the inflow forecasts for individual reservoirs if we assume that the forecast inflow volume errors of reservoir m during the entire operation horizon are wm m3 they can be described by eq b1 b1 w m t 1 t w m t t 1 t e m t δ t in the mc simulation the variance in the error of the forecast inflow of reservoir m in each scenario can be expressed as eq b2 b2 var w m var t 1 t e m t δ t t 1 t var e m t δ t 2 t 1 1 t 1 t 2 t 1 1 t var e m t 1 δ t var e m t 2 δ t ρ m t 1 m t 2 when the above τ order temporal dependences are neglected ρ m t 1 m t 2 t 1 t 2 τ is zero therefore the variance in the errors in the inflow volume of reservoir m with τ order temporal dependences var w3 is smaller than that of the total temporal dependences as the above τ order temporal dependences are mainly positive b3 var w 2 var w 3 the dispersion of the error in the inflow volume of reservoir m decreases with each time period and the distribution of the inflow process is relatively centralized by assessing the flood control risk assessment the probability that the natural inflow will exceed the specified threshold decreases significantly by ignoring the high order temporal dependences of the forecast uncertainties both the natural inflow and the flood risk will be underestimated the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
4431,this study presents the potential of hydrological ensemble forecasts over south korea for medium range forecast lead times 1 7 days to generate hydrological forecasts this study utilizes a framework based on stacking ensemble learning an emerging machine learning technique that includes a two level structure base learner and meta learner models in particular the present research contributes to hydrological post processing techniques by 1 introducing a penalized quantile regression based meta learner to generate probabilistic predictions 2 considering modeled climate predictions and antecedent hydrologic conditions simultaneously for regional hydrological forecast development and 3 quantifying the skill enhancements from the multi model forecasts under the stacking generalization the proposed model is evaluated in massive 473 grid cells along with nine additional simpler models to test the specific hypotheses introduced in this study results indicate that our proposed forecasts can be used for relatively short lead times in addition results demonstrate that utilizing a penalized probabilistic meta learner and antecedent conditions contributes to the forecast skill improvements lastly we find that base model diversity outperforms increased ensemble size alone in enhancing the forecast abilities under the stacking ensemble generalization we conclude this paper with a discussion of possible forecast model improvements from an adaptation of additional information from input and model structures under the stacking generalization keywords stacking generalization hydrological forecast south korea medium range forecast hydrological post processing 1 introduction forecast informed policy decisions have enormous potential to enhance the efficient use of water resources especially in areas where streamflows are highly variable across timescales ahmad and hossain 2020 anghileri et al 2016 scheuerer et al 2017 turner et al 2017 forecast informed policies are often developed using hydrological forecasts e g river discharge predictions determined by the outputs from hydrologic models in particular flooding related forecasting is valuable as it offers sufficient time for flood warnings and flood emergency responses kuriqi et al 2021 li et al 2017 economic benefits are also expected from reservoir operations by maintaining high head for longer periods thanks to more reliable release schedules fan et al 2016a accordingly there have been considerable efforts to improve hydrological forecasts over the past few decades e g abaza et al 2017 bourgin et al 2014 clark and hay 2004 najafi and moradkhani 2016 uncertainty in hydrological forecasts arises from diverse sources including forcing data hydrologic model structures boundary conditions and initial conditions to achieve more reliable forecasts each uncertainty source should be properly addressed hence various remedies have been proposed in many studies e g bisselink et al 2016 wang et al 2009 yan et al 2015 the accuracy of forecasts can also be improved through post processing using statistical techniques bogner et al 2016 madadgar et al 2014 post processing techniques have been developed within a comprehensive framework of probabilistic predictions e g brown and seo 2013 tyralis and koutsoyiannis 2017 since the framework offers the forecast of most likely values and uncertainty information tao et al 2014 the understanding of uncertainty information which could particularly lead to reliable decision making joslyn and leclerc 2012 ramos et al 2013 some techniques have been utilized for probability based post processing including bayesian model averaging bma li et al 2019 sharma et al 2019 general linear model post processer ye et al 2015 ye et al 2014 heteroscedastic extended logistic regression helr messner et al 2014 yang et al 2017 and quantile regression papacharalampous et al 2019 with advancements in technology and computing power various machine learning techniques have been developed and introduced in the field of hydrology e g ahn 2020 kratzert et al 2019 petty and dhingra 2018 shabani et al 2016 among machine learning techniques a competent approach is to combine the outputs of multiple prediction models hereafter referred to as base learners alpaydin 2020 in a manner that the advantages of each model can be incorporated into an integrated framework sun and trevor 2018 one example of this approach is the stacking ensemble model which feeds the outputs of base learners into one combiner ngo 2018 the combiner hereafter referred to as meta learner is used again to improve the predictions of the base learners see fig 1 we note that the term ensemble in the stacking ensemble model is slightly different from the general term ensemble in hydrology and can be explained as the estimated quantities obtained from the spread of the ensemble members originating from diverse prediction models gneiting et al 2005 the stacking ensemble model has been applied to various fields of hydrological and climatological modeling such as river ice breakup timing sun 2018 sun and trevor 2018 daily streamflow prediction li et al 2020 tyralis et al 2019 low flow frequency analysis worland et al 2018 and suspended sediment yield estimation shamaei and kaedi 2016 the above studies commonly reported that the stacked ensemble learning is effective because it allows for the correction of forecast biases based on the usefulness of the stacking ensemble model and the need to produce probabilistic forecasts tyralis et al 2019 have proposed a novel probability based stacking approach to improve streamflow predictions derived from quantile regression algorithm hereafter referred to as conventional quantile regression cqr they combined ensemble predictions without obtaining explicit expressions for the predictive distribution of the base learners here the cqr algorithm has an advantage since it properly represents the error heteroscedasticity identifying the variation of each quantile of the predictive density biondi and todini 2018 in this sense the algorithm is considered to be a substantially flexible approach koenker and bassett 1978 therefore it has been extensively utilized in the field of hydrology for various purposes fan et al 2016b tareghian and rasmussen 2013 villarini and slater 2018 while cqr is promising one challenge that can emerge but has not been previously discussed is overfitting when outputs from the base learners are significantly correlated with each other in this situation the meta learner model may provide false weights to less important covariates which could eventually lead to poor predictions especially from the theoretical underpinning of stacking learning all predictors are often correlated with each other although the structure of cqr is potentially favorable to build probabilistic forecasts a modified model structure is required to determine the proper weights of covariates therefore we develop the meta learner by adopting a penalized quantile regression to construct probabilistic forecasts it provides a penalty that can optimally adjust weights to covariates the usefulness of the probability based stacking approach with a penalized quantile regression is explored in this study to be specific the approach is compared to the stacking ensemble model with cqr using streamflow forecasts developed by a land surface model with an ensemble of climate reforecasts from the global ensemble forecast system reforecast version 2 gefsrv2 provided by the national oceanic and atmospheric administration s noaa s national centers for environmental prediction ncep the datasets are useful in assessing the performance of different post processing techniques since gefsrv2 has been operated based on a consistent underlying model structure over a long term period siddique et al 2015 moreover stacking ensemble learning is primarily used to improve the skill and reliability of hydrological forecasts by reducing model uncertainties based on this many studies have used the outputs from a model for post processing e g sun 2018 tyralis et al 2020 tyralis et al 2019 xenochristou and kapelan 2020 however antecedent streamflow conditions may also provide valuable information for forecasting for example if the day prior to the rain event is extremely dry then soils would be dry and baseflow would be low under these conditions a heavy rain event would result in high infiltration rates and a smaller amount of direct runoff which would not likely cause extreme flooding in contrast if conditions prior to the heavy rainfall event were abnormally wet then a larger initial baseflow can be expected therefore as also presented in duan et al 2019 antecedent hydrologic conditions are crucial although quite useful the joint effects of modeled outputs and currently available data have received less attention particularly in stacked ensemble modeling this augmentation may be quite effective because streamflow data are typically autocorrelated as shown by other studies papacharalampous and tyralis 2018 sonali and kumar 2013 therefore one of the objectives of this study is to explore if forecasting ability could be further improved by adopting the available antecedent information under a stacking generalization there are two possible approaches to maximize the benefits under the stacking generalization framework one approach is to use diverse base learners the property of which is referred to as base model diversity in machine learning science a number of modeling techniques are available that are used to illustrate base model diversity such as neural networks and parametric and nonparametric regressive models an alternative approach to provide diverse information to the meta learner is to increase the ensemble size within a given number of base learners the difference between the two is that model structure uncertainty is embedded in the model diversity while parametric uncertainty is embedded in the increased ensemble size approach it has not been empirically tested as to which approach would outperform in improving the performance of hydrological forecasts therefore it would be necessary to identify the superior approach by quantifying the effectiveness between the two for practical use in decision making which is the final objective of this study summing up the objective of this research is to explore the possibility of hydrological forecasts in medium range forecasts 1 7 days over south korea using a stacked ensemble model with an emphasis on implications for forecast informed water management while addressing the following questions 1 how do the proposed stacking generalization forecasts perform through forecast lead times over south korea 2 are stacking generalization forecasts with a penalized quantile regression more reliable than those from a conventional quantile regression as a meta learner over the study area 3 can a simultaneous utilization of antecedent hydrologic conditions and modeled predictions substantially improve hydrological forecasts over modeled only predictions in stacking generalization 4 does base model diversity or increased ensemble size contribute more to enhancing forecast performance of a stacking ensemble generalization the third question is particularly relevant to operating policies for water resource infrastructures because more reliable predictions may be achieved through the utilization of the two although this is beyond the original purpose of the hydrological post processing to reduce modeled biases these questions are reposed as hypotheses tested through massive hydrologic experiments and evaluated over a large study area using high performance computing the remainder of this article is organized as follows section 2 illustrates the experimental setup including the study area and datasets section 3 describes the methodologies and evaluation framework the results and their implications are demonstrated in section 4 finally the key findings of this work are summarized in section 5 2 experimental setup 2 1 study area south korea the country that occupies the southern portion of the korean peninsula is employed as the study area fig 2 this country tends to have a humid continental and a subtropical climate the annual precipitation generally spans from 1200 to 1500 mm with the exception of the southern coast and the northern inland region also the annual mean temperature ranges from 10 to 16 c the entire country is affected by the east asian monsoon with precipitation heavier in the summer months of june through september often called the flooding season ahn and kim 2019 in this season extraordinarily high rainfall is often generated by typhoons alcantara and ahn 2020 climate conditions in the flooding season yield approximately two thirds of the annual rainfall whereas rainfall in winter contributes 10 of the annual rainfall variability in intra annual rainfall periodically causes floods and droughts to the country therefore in the viewpoint of water resource management both flooding and drought hazards are an important concern highlighting the need to urgently build a hydrological forecast system over the korean peninsula particularly for medium range forecasts 2 2 data sets this study employs four observational datasets gridded daily precipitation maximum and minimum temperatures and streamflow these datasets were utilized to calibrate and validate the hydrological model implement hydrological model simulations and acquire antecedent conditions three daily climate datasets precipitation maximum and minimum temperatures within the geographical boundaries of the korean peninsula were gathered from the 0 15 0 15 k hidra version 2020 product noh and ahn 2021 the region is approximately 100 032 k m 2 in size and comprises 473 different grid cells fig 1 the k hidra dataset was developed from 390 stations and corrected systematic bias from missing values noh and ahn 2021 noh and ahn 2021 assessed the created dataset by generating reconstructed datasets of observations without the infilling process and confirmed that k hidra properly represents the spatial and temporal variabilities particularly in areas consisting of complex mountain topography for our study the climate products were used from 1 january 1991 to 31 december 2019 while the original k hidra dataset is available for the period of 47 years 1973 2019 moreover to calibrate and validate streamflow simulations and forecasts daily unregulated streamflow observations at 26 gauges located upstream of dams and reservoirs or tributaries without regulation were gathered from the water resources management information system webpage http www wamis go kr wkd mn dammain do for the longest period 15 years 2005 2019 of consecutive observations were used although two gauges only have data for a subset of this period see fig 2 the database for land covers is obtained from the environmental geographic information service ministry of environment 2011 while soil types of our study area are provided by the harmonized world soil database v1 2 wieder et al 2014 figs s1 and s2 summarize the distributions of the hydro climatic conditions over the study area reforecast data were retrieved from gefsrv2 noaa s latest global medium range ensemble reforecast dataset ebisuzaki et al 2002 these 1 1 reforecasts are based on an 11 member ensemble generated by stochastically perturbing the initial condition of the numerical weather prediction model using the ensemble transform technique with rescaling wei et al 2008 the gefsrv2 reforecasts are based on a single version of the model initialized at 0000 coordinate universal time utc on each day in the reforecast period which allows itself the categorization of bias and error since incremental changes to the model are not a confounding factor hamill et al 2013 the lead times of the gefsrv2 are available from 1 to 16 days while the forecast cycle consists of 3 hourly accumulations for the first 3 days and 6 hourly accumulations from day 4 to day 16 this study utilized 24 hour accumulation from day 1 to day 7 over the period of 1 january 1991 to 31 december 2019 to be specific to generate the ensemble streamflow forecasts we utilized the following gefsrv2 variables precipitation and maximum and minimum temperatures the gefsrv2 data were bilinearly interpolated onto the regularly spaced grid corresponding to the hydrological model further details of the gefsrv2 dataset can be obtained elsewhere hamill et al 2016 hamill et al 2013 2 3 land surface model to generate hydrological forecasts over the entire south korean territory we develop a land surface model lsm using a semi physically based lumped model variable source area vsa watershed model archibald et al 2014 this model has previously been utilized to explore daily behaviors of surface runoff in a large scale domain e g knighton et al 2019 the model estimates surface runoff through the curve number cn approach modified to simulated vsa hydrology as in easton et al 2008 here daily potential evapotranspiration pet is estimated via the priestly taylor equation by using daily maximum and minimum temperatures and the days of the year priestley and taylor 1972 previous studies have shown that the priestly taylor equation properly performs compared to the penman monteith equation sentelhas et al 2010 stannard 1993 actual evapotranspiration shallow soil water storage and percolation are determined by the thornthwaite mather soil moisture procedure archibald et al 2014 this study simulates five soil layers where the depths of the first four layers are determined by the average available water capacity obtained from the soil database while the fifth layer represents the remaining soil depth to the confining layer also percent of the impervious area and average land surface albedo wang et al 2015 are extracted from the land cover database the model is developed at a spatial resolution of 0 15 0 15 which is similar to the grid size of the climate forcing data see fig 2 to calibrate the model we first carry out a sensitivity analysis using global variance based sensitivity analysis sobol 2001 to reduce the number of parameters not shown the final set of parameters see table 1 are then optimized to maximize daily nash sutcliffe efficiency nse by using the dynamically dimensioned search dds algorithm tolson and shoemaker 2007 in the optimization processes the models for each gauge are calibrated validated from the period of january 2011 to december 2019 january 2005 to december 2010 as noted in section 2 2 two gauges see fig 2 are validated from the period of january 2006 to december 2010 or january 2007 to december 2010 due to data availability subsequently optimized parameters for each cell containing a streamflow gauge are redistributed to the remaining grid cells through the extreme gradient boosting xgboost technique chen and guestrin 2016 their usefulness is also confirmed in the leave one out cross validation framework over the validation period fig 3 a and b summarize the model performance for the 26 streamflow gauges for the validation period the median nse and modified nash sutcliffe efficiency mnse scores are 0 688 and 0 490 respectively while the 10th percentile scores are 0 531 and 0 181 the details of both the metrics are presented in section 3 4 in particular the nse results suggest that the performances can be considered as satisfactory based on the performance evaluation suggested by martinez and gupta 2010 fig 3c shows the nse scores when the regionalized parameters are applied to simulate validation streamflow in general the model performances are adequate as the median nse score is 0 657 we also note that the performances are slightly decreased compared to those for the at site parameter optimization process see fig 3a the lower accuracies are somewhat expected in the regionalization process especially over the validation period overall the results indicate that our lsm simulations properly represent streamflow behaviors across south korea 3 methodology to develop hydrological forecasts the methodology is based on a stacking ensemble learning framework the stacking framework has a two level structure which includes base learners and meta learner see fig 1 in the methodology section we first describe four machine learning techniques used for base learner models section 3 1 next a meta learner model for probability based stacking generalization is described in section 3 2 section 3 3 shows the overall framework employed in this study to generate hydrologic forecasts in medium range forecasts finally a series of nested models are presented in section 3 4 that will be used to explore our research hypotheses see introduction 3 1 base learner models the proposed stacking based ensemble model requires multiple base learners that could perform properly for streamflow predictions in addition as suggested by alpaydin 2020 the base learners should be informative and diverse so that they complement each other in this study we select four diverse modeling techniques including support vector machines svm gradient boosting machine gbm cubist and bayesian regularized neural networks brnns so as to represent various structures of the modeling techniques such as parametric and nonparametric models a brief overview of the methods is described below 3 1 1 support vector machines svm the svm model is built using a kernel function to map the 11 member hydrological forecasts into a high dimensional feature space via a nonlinear mapping and then performs linear regression in the space vapnik 2013 here the model fits a regression line using the subset of data which fall within a defined threshold denoted as the residuals within the threshold provide a linear scaled amount to the model fit whereas residuals outside of the threshold do not contribute to the model fit thus svm is also considered an intensive regression model the effect of the large residuals is controlled by a cost parameter which has a regularized function similar to ridge regression various kernel functions such as gaussian polynomial sigmoid spline and radial basis function rbf can be used with different effects on the model performance while this study adopts a gaussian kernel incorporating the stages of a comprehensive investigation on kernel selection sachindra et al 2018 would add rigor to the present study 3 1 2 gradient boosting machine gbm the gbm model is implemented based on an ensemble of decision trees it employs the residuals from the previous tree to subsequently fit new trees that are augmented to the model touzani et al 2018 in total four hyper parameters shrinkage rate number of trees interaction depth and minimum number of observations in each node are used to optimize the model to be specific a tree with an assigned number of terminal nodes interaction depth is employed to data its residuals are computed and a second tree is built utilizing the residuals from the first tree as the dependent variable and the predictions from the second tree are added to the predictions from the first tree resulting in a new model this process is iterated a certain number of times the number of trees here the shrinkage rate is also adopted to handle the fraction of the new prediction added to the previous model for decision trees there is also an additional parameter that ensures the minimum number of observations that exist within each node minimum number of observations in each node which can mitigate overfitting for the model 3 1 3 cubist cubist is a type of regression tree with a potential to demonstrate the nonlinear relationship between ensemble hydrological forecasts and observed streamflow kuhn et al 2013 it creates an initial tree and segments it into a sequence of rules the main difference of a cubist model from a regression tree is how predictions are created with the nodes a regression tree produces a single value prediction for each node whereas this cubist model produces a prediction using a linear regression model quinlan 1993 to build the regression model in each node the data only from the split directly above the node are employed therefore the final prediction from a single tree is estimated on the regression model in the terminal node but can be adjusted by a weighting scheme based on estimations from an arbitrary number of nodes within the subtree here two hyper parameters the number of nodes and number of trees are optimized to further enhance the model the number of nodes can be determined in the smoothing process which is referred to as neighbors moreover the prediction can be improved by generating several ensemble models referred to as committees by means of boosting 3 1 4 bayesian regularized neural networks brnn neural networks are comprised of nodes organized in layers each node receives information with a certain weight from another node and pass it to the next node or transfer it as external output brnn is developed to handle overfitting problems often existing in a conventional artificial neural network abrahart et al 2012 in this study the brnn adopts a typical three layer structure i e input hidden and output layers with logistic and linear transfer functions the first layer contains the 11 member hydrological forecasts while the last years represents observed streamflow here the number of neurons for the input and hidden layers are decided by minimizing the sum squared error between the model output and target value in the objective function brnn adds regularization as an additional term using two regularization parameters ψ and φ therefore the relative sizes of ψ and φ demonstrate that the emphasis is on model performance or reducing weight values the brnn uses bayes theorem to determine the posterior probability distribution of ψ and φ when the weights and hyper parameters are determined the distributions of the network outputs can be derived according to the rule of conditional probability 3 2 meta learner model although this study utilizes base learners known as effective post processing models the forecasts of hydrological processes are restricted by the ability of the forecasting dataset adopted in this study also individual base learner models may be limited to producing the forecasts in their structures to further improve the performance a meta learner is adopted using a regularized quantile regression model quantile regression initially introduced by koenker and bassett 1978 can estimate the various quantiles of the target variable conditional on the covariates to be specific the τ th quantile of a target variable y i e observed streamflow can be characterized as follows 1 q y τ f y 1 τ inf y f y y τ where f y τ p y y is the distribution function of y and τ 0 1 in the regression structure y x β the coefficients β τ for given the quantile τ are determined based on the following objective function 2 arg min β 1 n i 1 n ρ τ y i x i β τ where i 1 n and ρ τ is calculated as follows 3 ρ τ y i x i β τ τ 1 i f y i x i β τ 0 y i x i β τ τ if y i x i β τ 0 to implement regularization to the estimated coefficients a penalty term λ can be added as shown below 4 arg min β 1 n i 1 n ρ τ y i x i β τ λ p 1 p β τ p the regularized approach provides an effective solution with better fit by shrinking the coefficients toward zero hastie et al 2015 however regularization has some limitations when used in severe multicollinearity zou and hastie 2005 in addition it does not properly deal with the subset of covariates as if only the truly influential variables are included in the model asymptotically audrino and camponovo 2013 thus other regularizations such as smoothly clipped absolute deviation scad fan and li 2001 and minimax concave penalty mcp zhang 2010 have been developed in particular the effectiveness of scad has been shown to prevent over penalizing e g peng and wang 2014 scad can be defined as a quadratic spline function with knots at λ and α λ based on the following objective function 5 arg min β 1 n i 1 n ρ τ y i x i β τ p 1 p ρ λ β τ p where the penalty is defined as following ρ λ β τ λ β τ 0 β τ λ α λ β τ β τ 2 λ 2 2 α 1 λ β τ α λ α 1 λ 2 2 β τ α λ because of the advantages of the scad penalty it is employed for the regularized quantile regression model in this study 3 3 framework to develop hydrologic forecasts under the stacking generalization m 2 the overall framework to generate hydrologic forecasts is summarized in fig 4 we use the terminology training period to indicate the time period t train in which the model parameters are estimated and test period to refer to the time period t test over which hydrologic forecasts are generated in addition we use a tilde to refer to the transformed data the procedure for implementing hydrologic forecasts is as follows 1 past climate forecasts for lead time l and location j are employed to generate streamflow forecasts at time t using the land surface model described in section 2 3 2 generated past streamflow forecasts x j t l and corresponding observational streamflows y j t are transformed via the cubic root to improve the normality note that we tried other transformations e g squared root but the cubic root performed better 3 each of the k base learners f k is trained independently by using 10 years of x j t l and y j t i e the t train period based on the leave two years out cross validation framework here the grid search algorithm is utilized to optimize the hyper parameters of each base learner the obtained predictions from the cross validation framework are then employed to train the meta learner model f m i e the regularized quantile regression model here the last observational streamflow y j t l is added to consider the temporal dependence i e y j t f m x j t l y j t l 4 the trained base learners are used to predict y j t by using the subsequent 1 year of transformed x j t l at time t t test after that the predictive quantile y j t τ at time t t test is estimated using the meta learner model with the obtained k predictions from the base learners and y j t l 5 the obtained quantiles are cubed to transform them back into real space in this analysis we follow a 10 year moving window scheme to represent real predictions by training all models for each year that is the predictive performance in year t was evaluated by training all models using the period between t 11 and t 1 because the past climate forecast data were available from january 1991 as mentioned in section 2 2 we implement the hydrological forecasts from 2001 by training models with the 1991 2000 data 2002 with the 1992 2001 data and so on therefore hydrological forecasts were generated over the period from 1 january 2001 to 31 december 2019 19 years note that a moving window of 10 years is adopted since it provides sufficient samples to train the learners the moving window calibration scheme is further discussed in section 5 6 steps 1 5 are repeated for all lead times and locations 3 4 hypothesis assessment using additional models nine additional models m svm m gbm m cubist m brnn m 0 m 1 m 1 m 1 and m cqr are developed to provide a basis for evaluating the four hypotheses described in the introduction the first four models m svm m gbm m cubist and m brnn indicate the base learner models employed in this study also the fifth model m 0 presents unweighted mean streamflow predictions in which any post processing has not been applied by comparing the five models to m 2 we are able to explore the usefulness of the stacking generalization the sixth model m 1 adopts a stacking generalization structure similar to m 2 but excludes the last available streamflow y j t l a comparison between m 1 and m 2 highlights the differences that emerge when the utility of antecedent streamflow information is used for developing forecasts the differences are explored upon the season and lead time for the seasonal analysis two distinct seasons the flooding season june september and dry season other months are considered the last model m cqr utilizes the conventional quantile regression technique to construct a meta learner for the probability based stacking generalization we note that the m cqr model is comparable to that proposed by tyralis et al 2019 as a hydrological post processing technique to determine the coefficients for the selected quantile m cqr utilizes eq 2 instead of eq 5 as its objective function by comparing m cqr with m 2 the potentials of cqr and a penalized quantile regression will be addressed to evaluate their usefulness as a meta learner model in terms of improving hydrological forecasts moreover to investigate the dominant approach under the stacking framework two additional models m 1 and m 1 are further developed both the models are built based on m 1 without adopting the last available observation since we focus on the forecast performance induced by changes in the base model diversity and ensemble size in m 1 two base learners are employed to provide diverse information of base model structures under the stacking generalization this two base learner based stacking model is generated as follows 1 two base learners are randomly selected and then combined under the stacking generalization 2 repeat step 1 for all the possible combinations of two base learners and 3 evaluate the m 1 performance by averaging the predictions from multiple realizations similarly m 1 is developed based on two base learners however instead of using two independent base learners each base learner model is now paired with the model itself whose parameter set was trained differently in t train here m 1 is designed to increase the ensemble size within the given base learner by comparing m 1 and m 1 we can assess the effect of base model diversity on the other hand a comparison between m 1 and m 1 enables a direct test for the effect of increased ensemble size without adding another base learner model more specifically if the accuracies between m 1 and m 1 are sufficiently close compared to those between m 1 and m 1 the base model diversity is more dominated to enhance forecast skills than the increased ensemble size two different types deterministic and probabilistic metrics are used to assess the robustness and reliability of the diverse techniques in particular a deterministic framework would be favorable to evaluate the performance since some of our additional models e g m 0 do not deliver the predictive distributions in their predictions for the deterministic metrics we utilize three common deterministic metrics scores nse mnse and normalized root mean square error nrmse the mnse is particularly valuable since it alleviates the potential drawback of nse or nrmse that could lead to overestimating model performance during high flows and underestimation during low flows ahn and merwade 2016 for the probability based models i e m 1 m 2 and m cqr three deterministic metrics are calculated based on the median value y j t 0 5 6 ns e j 1 t t test y j t 0 5 y j t 0 5 2 t t test y j t 0 5 y j t 0 5 2 7 mns e j 1 t t test y j t 0 5 y j t 0 5 t t test y j t 0 5 y j t 0 5 8 nrms e j 1 σ y j 2 t test t t test y j t 0 5 y j t 0 5 2 where σ y j 2 is the variance of observations and indicates vector length to assess the forecast skill of the probability based models a continuous form of the rank probability score i e crps wilks 2006 and the related continuous ranked probability skill score crpss are employed for a given forecast cdf f y j t and their observation y j t the crps is defined as follows 9 crp s j t f y j t f h y j t 2 d y where 10 f h y j t h y j t y j t 0 if y j t y j t 0 1 if y j t y j t 0 is the heaviside function subsequently the crpss can be calculated to compare the crps for two models for instance the crpss for m 1 and m 2 is given by 11 crps s j m 2 m 1 1 t t test c r p s j t m 2 t t test c r p s j t m 1 if c rpss j m 2 m 1 is positive this suggests that m 2 outperforms m 1 on average this study defines the set of quantiles by including seven quantiles τ 0 05 0 10 0 30 0 50 0 70 0 90 0 95 4 results 4 1 inter model comparison under the stacking ensemble model in this section the forecasting performance of six models m 0 m svm m gbm m cubist m brnn and m 1 is first compared using the deterministic metrics fig 5 shows the nse metric values of the six models across lead times 1 7 days over the study area recall that the values are computed over the period of 2001 2019 19 years based on a 10 year moving window scheme overall the nse values tend to decline with increasing lead time as might be expected because the weather uncertainties become more pronounced on forecast skills as the lead time progresses sharma et al 2019 in particular forecast skills after the two day lead time significantly decrease indicating that the gefsrv2 reforecast data may be useful for our study area only for relatively short lead times to be specific the nse values for m 1 are 0 481 and 0 389 across all the grids in the first two lead times while the model has 0 053 for the three day lead time accordingly those for the first two day lead times are employed for further analysis in this section fig 6 fig s3 shows observed versus forecast streamflows across all the grid cells for one day two day lead time to be specific fig 6a illustrates a scatterplot of m 0 whereas fig 6b e show scatterplots of the simulated streamflows from the base learners against the observations respectively lastly fig 6f presents a scatterplot of m 1 here the dashed lines indicate the monotonic regression lines between forecasts and observations and the solid lines are for the identity lines the most significant underestimations are observed in fig 6a and they are somewhat moderated while having relatively smaller rmses when the base learners are applied see fig 6b e the results confirm the effectiveness of hydrological post processing in comparison to the base learners m gbm produces the lowest nrmse with underestimated biases whereas the m brnn presents highest nrmse with overestimated biases in other words the original hydrologic forecasts i e m 0 turn to be overestimated in some cases while the others yield underestimations through the base learners the under and overestimated forecasts contribute to the meta learner model by reducing the biases which in turn outperforms the baseline model see fig 6f therefore m 1 results in the lowest nrmse a similar inference can be found in fig s3 showing the simulation performances for a two day lead time in addition the outperformance of m 1 can be confirmed by the results of the nse metric of the individual grids for the first two day lead times see fig s4 4 2 comparison between m 1 and m c q r in this study we develop the stacking based model m 1 by adopting the penalized quantile regression as a meta learner model the model in this section is compared to m cqr to demonstrate the usefulness of the meta leaner model in m 1 two stacking ensemble models are trained separately for each grid each ensemble is subjected to the first two lead times and predictions of the seven quantiles described in section 3 4 results of the nse mnse nrmse and averaged crps metrics across all grids over the test period are presented in table 2 the distributions of the crpss scores across the grids are presented in table 3 maps of crpss scores for the forecasts over the first two day lead times across all grids are illustrated in fig 7 to provide spatial information in the performance metrics when the crpss is calculated m 1 is compared against a simpler model i e m cqr overall a penalized approach offers a more reliable prediction over the simple quantile regression approach in all deterministic metrics see table 2 m 1 consistently outperforms m cqr at times to a large degree rather in most cases the stacking model developed by adopting the conventional quantile regression m cqr yields less reliable accuracies than the base learners presented in fig 6b e this is because predictions from the base learners are commonly correlated with each other i e severe multicollinearity which may not be properly handled by quantile regression in which the stacking generalization is built as a meta learner for the crpss fig 7 m 1 again shows improvement over m cqr for most grids to be specific the predictive performance of the model outperforms m cqr at most grids with 25 of the improvements being rather substantial the 75th percentile of crpss 0 068 0 073 for one day two day lead time these results confirm that a penalized quantile regression is promising as a meta learner to build a probability based stacking approach 4 3 use of antecedent conditions to improve forecasting skills although m 1 provides substantially improved prediction skills through the stacking generalization the simulated predictions are significantly autocorrelated particularly for short lead time forecasts see fig 8 a also significant positive correlations are found in observed streamflows between y j t and y j t l in the test period see fig 8b and can thus be used for streamflow forecasting note that similar temporal dependences are obtained for observed streamflow over the training period not shown accordingly we try to add the last observational streamflow y j t l for the proposed forecasting model m 2 as one of the covariates to remedy the temporal dependence the spatial distributions of crpss scores for the first two day lead times over the test period are illustrated in fig 9 here the crpss is calculated by m 2 against a simpler model i e m 1 the results demonstrate that m 2 provides more reliable predictions on average than m 1 across lead times indicating that antecedent streamflow conditions are quite effective this analysis derives several interesting findings many grids showing low crpss values are in agricultural low elevated lands see fig 2 while the mountainous eastern parts of the central region show significant improvements we contemplate that this might be because the observed streamflow is related to the groundwater memory which is strongly effective in mountainous regions previous studies have revealed that topography plays a critical role in controlling the effect of groundwater mcguire et al 2005 price 2011 this specific hypothesis is further explored in the following seasonal investigation the differences in the mnse between m 2 and m 1 across all the grid cells and lead times over the test period are presented in fig 10 in this analysis two district seasons the dry and flooding seasons are considered the significant differences between the two models for the two seasons are also confirmed when the student t test is applied p value 0 001 taken together we can conclude that the forecast skills of m 2 substantially improved compared to m 1 in particular the forecast skills become considerably improved during the dry season compared to the flooding season it informs that adding antecedent streamflow conditions as one of the covariates in stacking generalization is vital for improving the prediction accuracy for low flows these results support our hypothesis since the effect of groundwater memory is greater for low flows than for high flows 4 4 skill improvement from increased ensemble size and base model diversity we finally investigate whether the forecasting skills of the stacking generalization are dominated by base model diversity or increased ensemble size for this purpose three models m 1 m 1 and m 1 are first compared in terms of their predictive abilities recall that m 1 is employed as a benchmark since we focus on the forecast skills based on the changes in the base model diversity and modeling size results of the nse and mnse metrics of all the grids for the first two day lead times during the test period are presented in fig 11 also a map of crpss values comparing the three models m 1 m 1 and m 1 in pairs is presented in fig 12 to provide further evidence useful for answering our motivating question in fig 12 the crpss is calculated using two additional models m 1 and m 1 as the reference several insights emerge from figs 11 and 12 first the predictions based on the four base learners i e m 1 outperform those produced by the other models suggesting that the four base learners employed in this study properly contributed to the proposed model next it is clear that the single base learner model i e m 1 produces larger differences from the metrics for m 1 than the multiple base learners model m 1 for both one day and two day lead times for example the median nse scores are 0 474 and 0 466 for m 1 and m 1 whereas m 1 has 0 481 for the predictions for a one day lead time these results imply that any of the single base learner forecasts can be improved by combining them with those from the other models the improvements show that the base model diversity contributes more to enhancing the forecast performance of a stacking ensemble generalization than the increased ensemble size similar conclusions can be drawn from the crpss results while this is true for both one day and two day lead times the tendency of crpss improvement is more notable for short lead time forecast we suggest that the base model diversity may be beneficial in such case and this leaves room for future investigation to further investigate our hypothesis that the enhancement of the forecast skills is dominantly contributed by the base model diversity rather than the increased ensemble size the metrics values from m 1 are compared in the additional analysis see fig s5 for this analysis twelve base learners are used for the stacking learning model wherein four base learner ensembles from m 1 are combined with an eight base learner ensembles obtained from the same four base learners the two ensembles are generated by each base learner with differently trained sets of parameters therefore the ensemble size is additionally increased within the given four base learners in m 1 the distribution of the nse and mnse values for the two models are overall very similar for the study area this further indicates that incorporating additional information based on the other model structures by adding new types of models is critical in improving the skill of the stacking based forecasts 5 conclusions this study explored the possibility of hydrological forecasts in medium range forecasts 1 7 days for south korea based on a stacking ensemble learning framework to do so we built a land surface model with an 11 member forecast data from gefsrv2 over the period of 1991 2019 the ensemble of daily streamflows from 473 grid cells was employed to train four base learners and a probabilistic meta learner in the final model forecasting outputs from four base learners were coupled with antecedent conditions to improve the predictive abilities our results confirmed that the hydrological forecasts we proposed can be used for relatively short lead times i e the first two day lead times while developing the forecasts we also formally evaluated the model hypotheses using a series of nested formulations and a 10 year moving window calibration scheme results from our study area showed that ensemble learning of base learners results in improved performance of probabilistic predictions in the analysis it was found that despite significant correlations in the outputs of the base learners the existing probability based stacking approach requires nontrivial independent assumptions leading to poor predictions instead this study developed a meta learner by adopting a penalized quantile regression to improve predictive abilities furthermore an accounting of antecedent conditions in m 2 substantially improved forecasts at most grids and reduced the magnitude of significantly underperforming forecasts as compared against a simpler model improvements were particularly evident for low flow periods lastly we examined the source of the improvements for the stacking ensemble generalization as a result skill enhancements across lead times were dominated by base model diversity while increased ensemble size has a lesser influence on the forecast performance this inference may be crucial because it highlights that there is no single base model that can be considered best under stacking generalization instead adopting diverse base models with the ability of each model to supply additional information from its own model s structure may play an important role in producing the best forecast which is also supported by the findings from recent studies mashhadi et al 2020 wang et al 2019 while the results are promising the approach has some limitations that require further discussion and exploration due to the accuracies the proposed hydrological forecasts for the study area are applicable mainly for relatively short lead times 2 days improving the predictions for longer lead times is an apparent next step for further model development as one of the key findings from this study additional information from diverse structures will be critical for producing reliable forecasts diverse information can be pursued by adopting other climate forcing data and hydrologic models for example the recently developed global ensemble prediction system park et al 2017 is a promising dataset for considering other climate datasets also predictive skills could vary substantially by using different hydrologic model structures as shown in sharma et al 2019 by considering a different type of hydrologic model e g a physically based land surface model forecast skill could be improved further if this is the case it will be worthwhile to quantify the degree of contribution between the base model diversity and hydrologic model diversity and determine which is more contributive in providing reliable predictions this exploration is crucial to operational forecasting since generating many ensemble members in real time is often cumbersome based on the understanding it would be more efficient and effective if ensemble members are generated using more contributive diversities moreover future research could focus on determining the optimal training length for the moving window calibration scheme in this study we adopt a 10 year moving window scheme to mimic real predictions by training all models for the target year if the length of the calibration window is too short or too long predictive performance can become suboptimal or less skillful otherwise the calibration scheme can be developed on a seasonal or monthly basis however all such future model developments should balance additional complexity against the risk of overfitting and computational expense as additional calibration schemes are added the time for the model optimization process grows making it more difficult to determine which optimization process provides robust improvements to prediction the added time for model training and testing could also reduce the practicality of model implementation providing support for the current calibration scheme presented in this paper credit authorship contribution statement dong gi lee data curation software investigation visualization writing original draft kuk hyun ahn conceptualization data curation formal analysis funding acquisition methodology project administration resources supervision validation writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors would like to acknowledge dr james knighton for his help in developing a land surface model during the development of this paper this work was supported by the national research foundation of korea nrf grant funded by the korean government msit no 2019r1c1c1002438 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2021 126681 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
4431,this study presents the potential of hydrological ensemble forecasts over south korea for medium range forecast lead times 1 7 days to generate hydrological forecasts this study utilizes a framework based on stacking ensemble learning an emerging machine learning technique that includes a two level structure base learner and meta learner models in particular the present research contributes to hydrological post processing techniques by 1 introducing a penalized quantile regression based meta learner to generate probabilistic predictions 2 considering modeled climate predictions and antecedent hydrologic conditions simultaneously for regional hydrological forecast development and 3 quantifying the skill enhancements from the multi model forecasts under the stacking generalization the proposed model is evaluated in massive 473 grid cells along with nine additional simpler models to test the specific hypotheses introduced in this study results indicate that our proposed forecasts can be used for relatively short lead times in addition results demonstrate that utilizing a penalized probabilistic meta learner and antecedent conditions contributes to the forecast skill improvements lastly we find that base model diversity outperforms increased ensemble size alone in enhancing the forecast abilities under the stacking ensemble generalization we conclude this paper with a discussion of possible forecast model improvements from an adaptation of additional information from input and model structures under the stacking generalization keywords stacking generalization hydrological forecast south korea medium range forecast hydrological post processing 1 introduction forecast informed policy decisions have enormous potential to enhance the efficient use of water resources especially in areas where streamflows are highly variable across timescales ahmad and hossain 2020 anghileri et al 2016 scheuerer et al 2017 turner et al 2017 forecast informed policies are often developed using hydrological forecasts e g river discharge predictions determined by the outputs from hydrologic models in particular flooding related forecasting is valuable as it offers sufficient time for flood warnings and flood emergency responses kuriqi et al 2021 li et al 2017 economic benefits are also expected from reservoir operations by maintaining high head for longer periods thanks to more reliable release schedules fan et al 2016a accordingly there have been considerable efforts to improve hydrological forecasts over the past few decades e g abaza et al 2017 bourgin et al 2014 clark and hay 2004 najafi and moradkhani 2016 uncertainty in hydrological forecasts arises from diverse sources including forcing data hydrologic model structures boundary conditions and initial conditions to achieve more reliable forecasts each uncertainty source should be properly addressed hence various remedies have been proposed in many studies e g bisselink et al 2016 wang et al 2009 yan et al 2015 the accuracy of forecasts can also be improved through post processing using statistical techniques bogner et al 2016 madadgar et al 2014 post processing techniques have been developed within a comprehensive framework of probabilistic predictions e g brown and seo 2013 tyralis and koutsoyiannis 2017 since the framework offers the forecast of most likely values and uncertainty information tao et al 2014 the understanding of uncertainty information which could particularly lead to reliable decision making joslyn and leclerc 2012 ramos et al 2013 some techniques have been utilized for probability based post processing including bayesian model averaging bma li et al 2019 sharma et al 2019 general linear model post processer ye et al 2015 ye et al 2014 heteroscedastic extended logistic regression helr messner et al 2014 yang et al 2017 and quantile regression papacharalampous et al 2019 with advancements in technology and computing power various machine learning techniques have been developed and introduced in the field of hydrology e g ahn 2020 kratzert et al 2019 petty and dhingra 2018 shabani et al 2016 among machine learning techniques a competent approach is to combine the outputs of multiple prediction models hereafter referred to as base learners alpaydin 2020 in a manner that the advantages of each model can be incorporated into an integrated framework sun and trevor 2018 one example of this approach is the stacking ensemble model which feeds the outputs of base learners into one combiner ngo 2018 the combiner hereafter referred to as meta learner is used again to improve the predictions of the base learners see fig 1 we note that the term ensemble in the stacking ensemble model is slightly different from the general term ensemble in hydrology and can be explained as the estimated quantities obtained from the spread of the ensemble members originating from diverse prediction models gneiting et al 2005 the stacking ensemble model has been applied to various fields of hydrological and climatological modeling such as river ice breakup timing sun 2018 sun and trevor 2018 daily streamflow prediction li et al 2020 tyralis et al 2019 low flow frequency analysis worland et al 2018 and suspended sediment yield estimation shamaei and kaedi 2016 the above studies commonly reported that the stacked ensemble learning is effective because it allows for the correction of forecast biases based on the usefulness of the stacking ensemble model and the need to produce probabilistic forecasts tyralis et al 2019 have proposed a novel probability based stacking approach to improve streamflow predictions derived from quantile regression algorithm hereafter referred to as conventional quantile regression cqr they combined ensemble predictions without obtaining explicit expressions for the predictive distribution of the base learners here the cqr algorithm has an advantage since it properly represents the error heteroscedasticity identifying the variation of each quantile of the predictive density biondi and todini 2018 in this sense the algorithm is considered to be a substantially flexible approach koenker and bassett 1978 therefore it has been extensively utilized in the field of hydrology for various purposes fan et al 2016b tareghian and rasmussen 2013 villarini and slater 2018 while cqr is promising one challenge that can emerge but has not been previously discussed is overfitting when outputs from the base learners are significantly correlated with each other in this situation the meta learner model may provide false weights to less important covariates which could eventually lead to poor predictions especially from the theoretical underpinning of stacking learning all predictors are often correlated with each other although the structure of cqr is potentially favorable to build probabilistic forecasts a modified model structure is required to determine the proper weights of covariates therefore we develop the meta learner by adopting a penalized quantile regression to construct probabilistic forecasts it provides a penalty that can optimally adjust weights to covariates the usefulness of the probability based stacking approach with a penalized quantile regression is explored in this study to be specific the approach is compared to the stacking ensemble model with cqr using streamflow forecasts developed by a land surface model with an ensemble of climate reforecasts from the global ensemble forecast system reforecast version 2 gefsrv2 provided by the national oceanic and atmospheric administration s noaa s national centers for environmental prediction ncep the datasets are useful in assessing the performance of different post processing techniques since gefsrv2 has been operated based on a consistent underlying model structure over a long term period siddique et al 2015 moreover stacking ensemble learning is primarily used to improve the skill and reliability of hydrological forecasts by reducing model uncertainties based on this many studies have used the outputs from a model for post processing e g sun 2018 tyralis et al 2020 tyralis et al 2019 xenochristou and kapelan 2020 however antecedent streamflow conditions may also provide valuable information for forecasting for example if the day prior to the rain event is extremely dry then soils would be dry and baseflow would be low under these conditions a heavy rain event would result in high infiltration rates and a smaller amount of direct runoff which would not likely cause extreme flooding in contrast if conditions prior to the heavy rainfall event were abnormally wet then a larger initial baseflow can be expected therefore as also presented in duan et al 2019 antecedent hydrologic conditions are crucial although quite useful the joint effects of modeled outputs and currently available data have received less attention particularly in stacked ensemble modeling this augmentation may be quite effective because streamflow data are typically autocorrelated as shown by other studies papacharalampous and tyralis 2018 sonali and kumar 2013 therefore one of the objectives of this study is to explore if forecasting ability could be further improved by adopting the available antecedent information under a stacking generalization there are two possible approaches to maximize the benefits under the stacking generalization framework one approach is to use diverse base learners the property of which is referred to as base model diversity in machine learning science a number of modeling techniques are available that are used to illustrate base model diversity such as neural networks and parametric and nonparametric regressive models an alternative approach to provide diverse information to the meta learner is to increase the ensemble size within a given number of base learners the difference between the two is that model structure uncertainty is embedded in the model diversity while parametric uncertainty is embedded in the increased ensemble size approach it has not been empirically tested as to which approach would outperform in improving the performance of hydrological forecasts therefore it would be necessary to identify the superior approach by quantifying the effectiveness between the two for practical use in decision making which is the final objective of this study summing up the objective of this research is to explore the possibility of hydrological forecasts in medium range forecasts 1 7 days over south korea using a stacked ensemble model with an emphasis on implications for forecast informed water management while addressing the following questions 1 how do the proposed stacking generalization forecasts perform through forecast lead times over south korea 2 are stacking generalization forecasts with a penalized quantile regression more reliable than those from a conventional quantile regression as a meta learner over the study area 3 can a simultaneous utilization of antecedent hydrologic conditions and modeled predictions substantially improve hydrological forecasts over modeled only predictions in stacking generalization 4 does base model diversity or increased ensemble size contribute more to enhancing forecast performance of a stacking ensemble generalization the third question is particularly relevant to operating policies for water resource infrastructures because more reliable predictions may be achieved through the utilization of the two although this is beyond the original purpose of the hydrological post processing to reduce modeled biases these questions are reposed as hypotheses tested through massive hydrologic experiments and evaluated over a large study area using high performance computing the remainder of this article is organized as follows section 2 illustrates the experimental setup including the study area and datasets section 3 describes the methodologies and evaluation framework the results and their implications are demonstrated in section 4 finally the key findings of this work are summarized in section 5 2 experimental setup 2 1 study area south korea the country that occupies the southern portion of the korean peninsula is employed as the study area fig 2 this country tends to have a humid continental and a subtropical climate the annual precipitation generally spans from 1200 to 1500 mm with the exception of the southern coast and the northern inland region also the annual mean temperature ranges from 10 to 16 c the entire country is affected by the east asian monsoon with precipitation heavier in the summer months of june through september often called the flooding season ahn and kim 2019 in this season extraordinarily high rainfall is often generated by typhoons alcantara and ahn 2020 climate conditions in the flooding season yield approximately two thirds of the annual rainfall whereas rainfall in winter contributes 10 of the annual rainfall variability in intra annual rainfall periodically causes floods and droughts to the country therefore in the viewpoint of water resource management both flooding and drought hazards are an important concern highlighting the need to urgently build a hydrological forecast system over the korean peninsula particularly for medium range forecasts 2 2 data sets this study employs four observational datasets gridded daily precipitation maximum and minimum temperatures and streamflow these datasets were utilized to calibrate and validate the hydrological model implement hydrological model simulations and acquire antecedent conditions three daily climate datasets precipitation maximum and minimum temperatures within the geographical boundaries of the korean peninsula were gathered from the 0 15 0 15 k hidra version 2020 product noh and ahn 2021 the region is approximately 100 032 k m 2 in size and comprises 473 different grid cells fig 1 the k hidra dataset was developed from 390 stations and corrected systematic bias from missing values noh and ahn 2021 noh and ahn 2021 assessed the created dataset by generating reconstructed datasets of observations without the infilling process and confirmed that k hidra properly represents the spatial and temporal variabilities particularly in areas consisting of complex mountain topography for our study the climate products were used from 1 january 1991 to 31 december 2019 while the original k hidra dataset is available for the period of 47 years 1973 2019 moreover to calibrate and validate streamflow simulations and forecasts daily unregulated streamflow observations at 26 gauges located upstream of dams and reservoirs or tributaries without regulation were gathered from the water resources management information system webpage http www wamis go kr wkd mn dammain do for the longest period 15 years 2005 2019 of consecutive observations were used although two gauges only have data for a subset of this period see fig 2 the database for land covers is obtained from the environmental geographic information service ministry of environment 2011 while soil types of our study area are provided by the harmonized world soil database v1 2 wieder et al 2014 figs s1 and s2 summarize the distributions of the hydro climatic conditions over the study area reforecast data were retrieved from gefsrv2 noaa s latest global medium range ensemble reforecast dataset ebisuzaki et al 2002 these 1 1 reforecasts are based on an 11 member ensemble generated by stochastically perturbing the initial condition of the numerical weather prediction model using the ensemble transform technique with rescaling wei et al 2008 the gefsrv2 reforecasts are based on a single version of the model initialized at 0000 coordinate universal time utc on each day in the reforecast period which allows itself the categorization of bias and error since incremental changes to the model are not a confounding factor hamill et al 2013 the lead times of the gefsrv2 are available from 1 to 16 days while the forecast cycle consists of 3 hourly accumulations for the first 3 days and 6 hourly accumulations from day 4 to day 16 this study utilized 24 hour accumulation from day 1 to day 7 over the period of 1 january 1991 to 31 december 2019 to be specific to generate the ensemble streamflow forecasts we utilized the following gefsrv2 variables precipitation and maximum and minimum temperatures the gefsrv2 data were bilinearly interpolated onto the regularly spaced grid corresponding to the hydrological model further details of the gefsrv2 dataset can be obtained elsewhere hamill et al 2016 hamill et al 2013 2 3 land surface model to generate hydrological forecasts over the entire south korean territory we develop a land surface model lsm using a semi physically based lumped model variable source area vsa watershed model archibald et al 2014 this model has previously been utilized to explore daily behaviors of surface runoff in a large scale domain e g knighton et al 2019 the model estimates surface runoff through the curve number cn approach modified to simulated vsa hydrology as in easton et al 2008 here daily potential evapotranspiration pet is estimated via the priestly taylor equation by using daily maximum and minimum temperatures and the days of the year priestley and taylor 1972 previous studies have shown that the priestly taylor equation properly performs compared to the penman monteith equation sentelhas et al 2010 stannard 1993 actual evapotranspiration shallow soil water storage and percolation are determined by the thornthwaite mather soil moisture procedure archibald et al 2014 this study simulates five soil layers where the depths of the first four layers are determined by the average available water capacity obtained from the soil database while the fifth layer represents the remaining soil depth to the confining layer also percent of the impervious area and average land surface albedo wang et al 2015 are extracted from the land cover database the model is developed at a spatial resolution of 0 15 0 15 which is similar to the grid size of the climate forcing data see fig 2 to calibrate the model we first carry out a sensitivity analysis using global variance based sensitivity analysis sobol 2001 to reduce the number of parameters not shown the final set of parameters see table 1 are then optimized to maximize daily nash sutcliffe efficiency nse by using the dynamically dimensioned search dds algorithm tolson and shoemaker 2007 in the optimization processes the models for each gauge are calibrated validated from the period of january 2011 to december 2019 january 2005 to december 2010 as noted in section 2 2 two gauges see fig 2 are validated from the period of january 2006 to december 2010 or january 2007 to december 2010 due to data availability subsequently optimized parameters for each cell containing a streamflow gauge are redistributed to the remaining grid cells through the extreme gradient boosting xgboost technique chen and guestrin 2016 their usefulness is also confirmed in the leave one out cross validation framework over the validation period fig 3 a and b summarize the model performance for the 26 streamflow gauges for the validation period the median nse and modified nash sutcliffe efficiency mnse scores are 0 688 and 0 490 respectively while the 10th percentile scores are 0 531 and 0 181 the details of both the metrics are presented in section 3 4 in particular the nse results suggest that the performances can be considered as satisfactory based on the performance evaluation suggested by martinez and gupta 2010 fig 3c shows the nse scores when the regionalized parameters are applied to simulate validation streamflow in general the model performances are adequate as the median nse score is 0 657 we also note that the performances are slightly decreased compared to those for the at site parameter optimization process see fig 3a the lower accuracies are somewhat expected in the regionalization process especially over the validation period overall the results indicate that our lsm simulations properly represent streamflow behaviors across south korea 3 methodology to develop hydrological forecasts the methodology is based on a stacking ensemble learning framework the stacking framework has a two level structure which includes base learners and meta learner see fig 1 in the methodology section we first describe four machine learning techniques used for base learner models section 3 1 next a meta learner model for probability based stacking generalization is described in section 3 2 section 3 3 shows the overall framework employed in this study to generate hydrologic forecasts in medium range forecasts finally a series of nested models are presented in section 3 4 that will be used to explore our research hypotheses see introduction 3 1 base learner models the proposed stacking based ensemble model requires multiple base learners that could perform properly for streamflow predictions in addition as suggested by alpaydin 2020 the base learners should be informative and diverse so that they complement each other in this study we select four diverse modeling techniques including support vector machines svm gradient boosting machine gbm cubist and bayesian regularized neural networks brnns so as to represent various structures of the modeling techniques such as parametric and nonparametric models a brief overview of the methods is described below 3 1 1 support vector machines svm the svm model is built using a kernel function to map the 11 member hydrological forecasts into a high dimensional feature space via a nonlinear mapping and then performs linear regression in the space vapnik 2013 here the model fits a regression line using the subset of data which fall within a defined threshold denoted as the residuals within the threshold provide a linear scaled amount to the model fit whereas residuals outside of the threshold do not contribute to the model fit thus svm is also considered an intensive regression model the effect of the large residuals is controlled by a cost parameter which has a regularized function similar to ridge regression various kernel functions such as gaussian polynomial sigmoid spline and radial basis function rbf can be used with different effects on the model performance while this study adopts a gaussian kernel incorporating the stages of a comprehensive investigation on kernel selection sachindra et al 2018 would add rigor to the present study 3 1 2 gradient boosting machine gbm the gbm model is implemented based on an ensemble of decision trees it employs the residuals from the previous tree to subsequently fit new trees that are augmented to the model touzani et al 2018 in total four hyper parameters shrinkage rate number of trees interaction depth and minimum number of observations in each node are used to optimize the model to be specific a tree with an assigned number of terminal nodes interaction depth is employed to data its residuals are computed and a second tree is built utilizing the residuals from the first tree as the dependent variable and the predictions from the second tree are added to the predictions from the first tree resulting in a new model this process is iterated a certain number of times the number of trees here the shrinkage rate is also adopted to handle the fraction of the new prediction added to the previous model for decision trees there is also an additional parameter that ensures the minimum number of observations that exist within each node minimum number of observations in each node which can mitigate overfitting for the model 3 1 3 cubist cubist is a type of regression tree with a potential to demonstrate the nonlinear relationship between ensemble hydrological forecasts and observed streamflow kuhn et al 2013 it creates an initial tree and segments it into a sequence of rules the main difference of a cubist model from a regression tree is how predictions are created with the nodes a regression tree produces a single value prediction for each node whereas this cubist model produces a prediction using a linear regression model quinlan 1993 to build the regression model in each node the data only from the split directly above the node are employed therefore the final prediction from a single tree is estimated on the regression model in the terminal node but can be adjusted by a weighting scheme based on estimations from an arbitrary number of nodes within the subtree here two hyper parameters the number of nodes and number of trees are optimized to further enhance the model the number of nodes can be determined in the smoothing process which is referred to as neighbors moreover the prediction can be improved by generating several ensemble models referred to as committees by means of boosting 3 1 4 bayesian regularized neural networks brnn neural networks are comprised of nodes organized in layers each node receives information with a certain weight from another node and pass it to the next node or transfer it as external output brnn is developed to handle overfitting problems often existing in a conventional artificial neural network abrahart et al 2012 in this study the brnn adopts a typical three layer structure i e input hidden and output layers with logistic and linear transfer functions the first layer contains the 11 member hydrological forecasts while the last years represents observed streamflow here the number of neurons for the input and hidden layers are decided by minimizing the sum squared error between the model output and target value in the objective function brnn adds regularization as an additional term using two regularization parameters ψ and φ therefore the relative sizes of ψ and φ demonstrate that the emphasis is on model performance or reducing weight values the brnn uses bayes theorem to determine the posterior probability distribution of ψ and φ when the weights and hyper parameters are determined the distributions of the network outputs can be derived according to the rule of conditional probability 3 2 meta learner model although this study utilizes base learners known as effective post processing models the forecasts of hydrological processes are restricted by the ability of the forecasting dataset adopted in this study also individual base learner models may be limited to producing the forecasts in their structures to further improve the performance a meta learner is adopted using a regularized quantile regression model quantile regression initially introduced by koenker and bassett 1978 can estimate the various quantiles of the target variable conditional on the covariates to be specific the τ th quantile of a target variable y i e observed streamflow can be characterized as follows 1 q y τ f y 1 τ inf y f y y τ where f y τ p y y is the distribution function of y and τ 0 1 in the regression structure y x β the coefficients β τ for given the quantile τ are determined based on the following objective function 2 arg min β 1 n i 1 n ρ τ y i x i β τ where i 1 n and ρ τ is calculated as follows 3 ρ τ y i x i β τ τ 1 i f y i x i β τ 0 y i x i β τ τ if y i x i β τ 0 to implement regularization to the estimated coefficients a penalty term λ can be added as shown below 4 arg min β 1 n i 1 n ρ τ y i x i β τ λ p 1 p β τ p the regularized approach provides an effective solution with better fit by shrinking the coefficients toward zero hastie et al 2015 however regularization has some limitations when used in severe multicollinearity zou and hastie 2005 in addition it does not properly deal with the subset of covariates as if only the truly influential variables are included in the model asymptotically audrino and camponovo 2013 thus other regularizations such as smoothly clipped absolute deviation scad fan and li 2001 and minimax concave penalty mcp zhang 2010 have been developed in particular the effectiveness of scad has been shown to prevent over penalizing e g peng and wang 2014 scad can be defined as a quadratic spline function with knots at λ and α λ based on the following objective function 5 arg min β 1 n i 1 n ρ τ y i x i β τ p 1 p ρ λ β τ p where the penalty is defined as following ρ λ β τ λ β τ 0 β τ λ α λ β τ β τ 2 λ 2 2 α 1 λ β τ α λ α 1 λ 2 2 β τ α λ because of the advantages of the scad penalty it is employed for the regularized quantile regression model in this study 3 3 framework to develop hydrologic forecasts under the stacking generalization m 2 the overall framework to generate hydrologic forecasts is summarized in fig 4 we use the terminology training period to indicate the time period t train in which the model parameters are estimated and test period to refer to the time period t test over which hydrologic forecasts are generated in addition we use a tilde to refer to the transformed data the procedure for implementing hydrologic forecasts is as follows 1 past climate forecasts for lead time l and location j are employed to generate streamflow forecasts at time t using the land surface model described in section 2 3 2 generated past streamflow forecasts x j t l and corresponding observational streamflows y j t are transformed via the cubic root to improve the normality note that we tried other transformations e g squared root but the cubic root performed better 3 each of the k base learners f k is trained independently by using 10 years of x j t l and y j t i e the t train period based on the leave two years out cross validation framework here the grid search algorithm is utilized to optimize the hyper parameters of each base learner the obtained predictions from the cross validation framework are then employed to train the meta learner model f m i e the regularized quantile regression model here the last observational streamflow y j t l is added to consider the temporal dependence i e y j t f m x j t l y j t l 4 the trained base learners are used to predict y j t by using the subsequent 1 year of transformed x j t l at time t t test after that the predictive quantile y j t τ at time t t test is estimated using the meta learner model with the obtained k predictions from the base learners and y j t l 5 the obtained quantiles are cubed to transform them back into real space in this analysis we follow a 10 year moving window scheme to represent real predictions by training all models for each year that is the predictive performance in year t was evaluated by training all models using the period between t 11 and t 1 because the past climate forecast data were available from january 1991 as mentioned in section 2 2 we implement the hydrological forecasts from 2001 by training models with the 1991 2000 data 2002 with the 1992 2001 data and so on therefore hydrological forecasts were generated over the period from 1 january 2001 to 31 december 2019 19 years note that a moving window of 10 years is adopted since it provides sufficient samples to train the learners the moving window calibration scheme is further discussed in section 5 6 steps 1 5 are repeated for all lead times and locations 3 4 hypothesis assessment using additional models nine additional models m svm m gbm m cubist m brnn m 0 m 1 m 1 m 1 and m cqr are developed to provide a basis for evaluating the four hypotheses described in the introduction the first four models m svm m gbm m cubist and m brnn indicate the base learner models employed in this study also the fifth model m 0 presents unweighted mean streamflow predictions in which any post processing has not been applied by comparing the five models to m 2 we are able to explore the usefulness of the stacking generalization the sixth model m 1 adopts a stacking generalization structure similar to m 2 but excludes the last available streamflow y j t l a comparison between m 1 and m 2 highlights the differences that emerge when the utility of antecedent streamflow information is used for developing forecasts the differences are explored upon the season and lead time for the seasonal analysis two distinct seasons the flooding season june september and dry season other months are considered the last model m cqr utilizes the conventional quantile regression technique to construct a meta learner for the probability based stacking generalization we note that the m cqr model is comparable to that proposed by tyralis et al 2019 as a hydrological post processing technique to determine the coefficients for the selected quantile m cqr utilizes eq 2 instead of eq 5 as its objective function by comparing m cqr with m 2 the potentials of cqr and a penalized quantile regression will be addressed to evaluate their usefulness as a meta learner model in terms of improving hydrological forecasts moreover to investigate the dominant approach under the stacking framework two additional models m 1 and m 1 are further developed both the models are built based on m 1 without adopting the last available observation since we focus on the forecast performance induced by changes in the base model diversity and ensemble size in m 1 two base learners are employed to provide diverse information of base model structures under the stacking generalization this two base learner based stacking model is generated as follows 1 two base learners are randomly selected and then combined under the stacking generalization 2 repeat step 1 for all the possible combinations of two base learners and 3 evaluate the m 1 performance by averaging the predictions from multiple realizations similarly m 1 is developed based on two base learners however instead of using two independent base learners each base learner model is now paired with the model itself whose parameter set was trained differently in t train here m 1 is designed to increase the ensemble size within the given base learner by comparing m 1 and m 1 we can assess the effect of base model diversity on the other hand a comparison between m 1 and m 1 enables a direct test for the effect of increased ensemble size without adding another base learner model more specifically if the accuracies between m 1 and m 1 are sufficiently close compared to those between m 1 and m 1 the base model diversity is more dominated to enhance forecast skills than the increased ensemble size two different types deterministic and probabilistic metrics are used to assess the robustness and reliability of the diverse techniques in particular a deterministic framework would be favorable to evaluate the performance since some of our additional models e g m 0 do not deliver the predictive distributions in their predictions for the deterministic metrics we utilize three common deterministic metrics scores nse mnse and normalized root mean square error nrmse the mnse is particularly valuable since it alleviates the potential drawback of nse or nrmse that could lead to overestimating model performance during high flows and underestimation during low flows ahn and merwade 2016 for the probability based models i e m 1 m 2 and m cqr three deterministic metrics are calculated based on the median value y j t 0 5 6 ns e j 1 t t test y j t 0 5 y j t 0 5 2 t t test y j t 0 5 y j t 0 5 2 7 mns e j 1 t t test y j t 0 5 y j t 0 5 t t test y j t 0 5 y j t 0 5 8 nrms e j 1 σ y j 2 t test t t test y j t 0 5 y j t 0 5 2 where σ y j 2 is the variance of observations and indicates vector length to assess the forecast skill of the probability based models a continuous form of the rank probability score i e crps wilks 2006 and the related continuous ranked probability skill score crpss are employed for a given forecast cdf f y j t and their observation y j t the crps is defined as follows 9 crp s j t f y j t f h y j t 2 d y where 10 f h y j t h y j t y j t 0 if y j t y j t 0 1 if y j t y j t 0 is the heaviside function subsequently the crpss can be calculated to compare the crps for two models for instance the crpss for m 1 and m 2 is given by 11 crps s j m 2 m 1 1 t t test c r p s j t m 2 t t test c r p s j t m 1 if c rpss j m 2 m 1 is positive this suggests that m 2 outperforms m 1 on average this study defines the set of quantiles by including seven quantiles τ 0 05 0 10 0 30 0 50 0 70 0 90 0 95 4 results 4 1 inter model comparison under the stacking ensemble model in this section the forecasting performance of six models m 0 m svm m gbm m cubist m brnn and m 1 is first compared using the deterministic metrics fig 5 shows the nse metric values of the six models across lead times 1 7 days over the study area recall that the values are computed over the period of 2001 2019 19 years based on a 10 year moving window scheme overall the nse values tend to decline with increasing lead time as might be expected because the weather uncertainties become more pronounced on forecast skills as the lead time progresses sharma et al 2019 in particular forecast skills after the two day lead time significantly decrease indicating that the gefsrv2 reforecast data may be useful for our study area only for relatively short lead times to be specific the nse values for m 1 are 0 481 and 0 389 across all the grids in the first two lead times while the model has 0 053 for the three day lead time accordingly those for the first two day lead times are employed for further analysis in this section fig 6 fig s3 shows observed versus forecast streamflows across all the grid cells for one day two day lead time to be specific fig 6a illustrates a scatterplot of m 0 whereas fig 6b e show scatterplots of the simulated streamflows from the base learners against the observations respectively lastly fig 6f presents a scatterplot of m 1 here the dashed lines indicate the monotonic regression lines between forecasts and observations and the solid lines are for the identity lines the most significant underestimations are observed in fig 6a and they are somewhat moderated while having relatively smaller rmses when the base learners are applied see fig 6b e the results confirm the effectiveness of hydrological post processing in comparison to the base learners m gbm produces the lowest nrmse with underestimated biases whereas the m brnn presents highest nrmse with overestimated biases in other words the original hydrologic forecasts i e m 0 turn to be overestimated in some cases while the others yield underestimations through the base learners the under and overestimated forecasts contribute to the meta learner model by reducing the biases which in turn outperforms the baseline model see fig 6f therefore m 1 results in the lowest nrmse a similar inference can be found in fig s3 showing the simulation performances for a two day lead time in addition the outperformance of m 1 can be confirmed by the results of the nse metric of the individual grids for the first two day lead times see fig s4 4 2 comparison between m 1 and m c q r in this study we develop the stacking based model m 1 by adopting the penalized quantile regression as a meta learner model the model in this section is compared to m cqr to demonstrate the usefulness of the meta leaner model in m 1 two stacking ensemble models are trained separately for each grid each ensemble is subjected to the first two lead times and predictions of the seven quantiles described in section 3 4 results of the nse mnse nrmse and averaged crps metrics across all grids over the test period are presented in table 2 the distributions of the crpss scores across the grids are presented in table 3 maps of crpss scores for the forecasts over the first two day lead times across all grids are illustrated in fig 7 to provide spatial information in the performance metrics when the crpss is calculated m 1 is compared against a simpler model i e m cqr overall a penalized approach offers a more reliable prediction over the simple quantile regression approach in all deterministic metrics see table 2 m 1 consistently outperforms m cqr at times to a large degree rather in most cases the stacking model developed by adopting the conventional quantile regression m cqr yields less reliable accuracies than the base learners presented in fig 6b e this is because predictions from the base learners are commonly correlated with each other i e severe multicollinearity which may not be properly handled by quantile regression in which the stacking generalization is built as a meta learner for the crpss fig 7 m 1 again shows improvement over m cqr for most grids to be specific the predictive performance of the model outperforms m cqr at most grids with 25 of the improvements being rather substantial the 75th percentile of crpss 0 068 0 073 for one day two day lead time these results confirm that a penalized quantile regression is promising as a meta learner to build a probability based stacking approach 4 3 use of antecedent conditions to improve forecasting skills although m 1 provides substantially improved prediction skills through the stacking generalization the simulated predictions are significantly autocorrelated particularly for short lead time forecasts see fig 8 a also significant positive correlations are found in observed streamflows between y j t and y j t l in the test period see fig 8b and can thus be used for streamflow forecasting note that similar temporal dependences are obtained for observed streamflow over the training period not shown accordingly we try to add the last observational streamflow y j t l for the proposed forecasting model m 2 as one of the covariates to remedy the temporal dependence the spatial distributions of crpss scores for the first two day lead times over the test period are illustrated in fig 9 here the crpss is calculated by m 2 against a simpler model i e m 1 the results demonstrate that m 2 provides more reliable predictions on average than m 1 across lead times indicating that antecedent streamflow conditions are quite effective this analysis derives several interesting findings many grids showing low crpss values are in agricultural low elevated lands see fig 2 while the mountainous eastern parts of the central region show significant improvements we contemplate that this might be because the observed streamflow is related to the groundwater memory which is strongly effective in mountainous regions previous studies have revealed that topography plays a critical role in controlling the effect of groundwater mcguire et al 2005 price 2011 this specific hypothesis is further explored in the following seasonal investigation the differences in the mnse between m 2 and m 1 across all the grid cells and lead times over the test period are presented in fig 10 in this analysis two district seasons the dry and flooding seasons are considered the significant differences between the two models for the two seasons are also confirmed when the student t test is applied p value 0 001 taken together we can conclude that the forecast skills of m 2 substantially improved compared to m 1 in particular the forecast skills become considerably improved during the dry season compared to the flooding season it informs that adding antecedent streamflow conditions as one of the covariates in stacking generalization is vital for improving the prediction accuracy for low flows these results support our hypothesis since the effect of groundwater memory is greater for low flows than for high flows 4 4 skill improvement from increased ensemble size and base model diversity we finally investigate whether the forecasting skills of the stacking generalization are dominated by base model diversity or increased ensemble size for this purpose three models m 1 m 1 and m 1 are first compared in terms of their predictive abilities recall that m 1 is employed as a benchmark since we focus on the forecast skills based on the changes in the base model diversity and modeling size results of the nse and mnse metrics of all the grids for the first two day lead times during the test period are presented in fig 11 also a map of crpss values comparing the three models m 1 m 1 and m 1 in pairs is presented in fig 12 to provide further evidence useful for answering our motivating question in fig 12 the crpss is calculated using two additional models m 1 and m 1 as the reference several insights emerge from figs 11 and 12 first the predictions based on the four base learners i e m 1 outperform those produced by the other models suggesting that the four base learners employed in this study properly contributed to the proposed model next it is clear that the single base learner model i e m 1 produces larger differences from the metrics for m 1 than the multiple base learners model m 1 for both one day and two day lead times for example the median nse scores are 0 474 and 0 466 for m 1 and m 1 whereas m 1 has 0 481 for the predictions for a one day lead time these results imply that any of the single base learner forecasts can be improved by combining them with those from the other models the improvements show that the base model diversity contributes more to enhancing the forecast performance of a stacking ensemble generalization than the increased ensemble size similar conclusions can be drawn from the crpss results while this is true for both one day and two day lead times the tendency of crpss improvement is more notable for short lead time forecast we suggest that the base model diversity may be beneficial in such case and this leaves room for future investigation to further investigate our hypothesis that the enhancement of the forecast skills is dominantly contributed by the base model diversity rather than the increased ensemble size the metrics values from m 1 are compared in the additional analysis see fig s5 for this analysis twelve base learners are used for the stacking learning model wherein four base learner ensembles from m 1 are combined with an eight base learner ensembles obtained from the same four base learners the two ensembles are generated by each base learner with differently trained sets of parameters therefore the ensemble size is additionally increased within the given four base learners in m 1 the distribution of the nse and mnse values for the two models are overall very similar for the study area this further indicates that incorporating additional information based on the other model structures by adding new types of models is critical in improving the skill of the stacking based forecasts 5 conclusions this study explored the possibility of hydrological forecasts in medium range forecasts 1 7 days for south korea based on a stacking ensemble learning framework to do so we built a land surface model with an 11 member forecast data from gefsrv2 over the period of 1991 2019 the ensemble of daily streamflows from 473 grid cells was employed to train four base learners and a probabilistic meta learner in the final model forecasting outputs from four base learners were coupled with antecedent conditions to improve the predictive abilities our results confirmed that the hydrological forecasts we proposed can be used for relatively short lead times i e the first two day lead times while developing the forecasts we also formally evaluated the model hypotheses using a series of nested formulations and a 10 year moving window calibration scheme results from our study area showed that ensemble learning of base learners results in improved performance of probabilistic predictions in the analysis it was found that despite significant correlations in the outputs of the base learners the existing probability based stacking approach requires nontrivial independent assumptions leading to poor predictions instead this study developed a meta learner by adopting a penalized quantile regression to improve predictive abilities furthermore an accounting of antecedent conditions in m 2 substantially improved forecasts at most grids and reduced the magnitude of significantly underperforming forecasts as compared against a simpler model improvements were particularly evident for low flow periods lastly we examined the source of the improvements for the stacking ensemble generalization as a result skill enhancements across lead times were dominated by base model diversity while increased ensemble size has a lesser influence on the forecast performance this inference may be crucial because it highlights that there is no single base model that can be considered best under stacking generalization instead adopting diverse base models with the ability of each model to supply additional information from its own model s structure may play an important role in producing the best forecast which is also supported by the findings from recent studies mashhadi et al 2020 wang et al 2019 while the results are promising the approach has some limitations that require further discussion and exploration due to the accuracies the proposed hydrological forecasts for the study area are applicable mainly for relatively short lead times 2 days improving the predictions for longer lead times is an apparent next step for further model development as one of the key findings from this study additional information from diverse structures will be critical for producing reliable forecasts diverse information can be pursued by adopting other climate forcing data and hydrologic models for example the recently developed global ensemble prediction system park et al 2017 is a promising dataset for considering other climate datasets also predictive skills could vary substantially by using different hydrologic model structures as shown in sharma et al 2019 by considering a different type of hydrologic model e g a physically based land surface model forecast skill could be improved further if this is the case it will be worthwhile to quantify the degree of contribution between the base model diversity and hydrologic model diversity and determine which is more contributive in providing reliable predictions this exploration is crucial to operational forecasting since generating many ensemble members in real time is often cumbersome based on the understanding it would be more efficient and effective if ensemble members are generated using more contributive diversities moreover future research could focus on determining the optimal training length for the moving window calibration scheme in this study we adopt a 10 year moving window scheme to mimic real predictions by training all models for the target year if the length of the calibration window is too short or too long predictive performance can become suboptimal or less skillful otherwise the calibration scheme can be developed on a seasonal or monthly basis however all such future model developments should balance additional complexity against the risk of overfitting and computational expense as additional calibration schemes are added the time for the model optimization process grows making it more difficult to determine which optimization process provides robust improvements to prediction the added time for model training and testing could also reduce the practicality of model implementation providing support for the current calibration scheme presented in this paper credit authorship contribution statement dong gi lee data curation software investigation visualization writing original draft kuk hyun ahn conceptualization data curation formal analysis funding acquisition methodology project administration resources supervision validation writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors would like to acknowledge dr james knighton for his help in developing a land surface model during the development of this paper this work was supported by the national research foundation of korea nrf grant funded by the korean government msit no 2019r1c1c1002438 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2021 126681 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
4432,in peri urban catchments where treated wastewater effluents are released into surface waters knowledge of water sources and partitioning is important for mitigating water quality impacts particularly during warm and dry periods with low discharge rates useful tools for the identification of water sources and flow paths under different wetness conditions are isotope tracers however very few studies have been carried out so far in urbanized catchments with complex land use distributions where natural headwaters interact with engineered components e g effluent discharge we undertook spatio temporal sampling of isotopes combined with water quality measurements to complement climatic and hydrometric data across the 220 km2 peri urban erpe catchment near berlin and assess seasonal changes in water sources during two exceptionally warm and dry years 2018 and 2019 the study showed a deterioration of water quality downstream of two municipal wastewater treatment plants and the depletion of groundwater storage along with isotopic enrichment of the stream in summer 2019 the second consecutive year with above average temperatures and marked precipitation deficits streamflow in the upper reaches of the catchment was dominated by groundwater fed tributaries in winter but became increasingly dominated by wastewater in summer in the lower catchment flows were dominated by effluent from a large wastewater treatment plant especially in summer young water from precipitation and urban storm runoff accounted for 10 of streamflow despite the catchment being 20 urban similarities in the composition of wastewater and other runoff sources resulted in high uncertainties in end member separation and highlight the need for monitoring of other tracers to better characterize water impacts given climate change projections for the region are for drier warmer summers wastewater is likely to become a more dominant component of streams which may have implications for environmental quality and ecosystem services keywords ecohydrology stable isotopes hydrogeochemistry tracers peri urban catchments wastewater effluents 1 introduction freshwater resources around the world are under increasing stress resulting from a changing climate and growing populations in increasingly urbanized areas subsequent increases in water distribution conflicts between urban and agricultural sectors flörke et al 2018 call for more integrated water management strategies that extend across catchment and administrative boundaries munia et al 2020 implementing such strategies is especially challenging for peri urban catchments which are often characterized by a complex distribution and rapidly evolving mosaic of rural urban and agricultural components fletcher et al 2013 and for catchments where processes in upstream areas significantly impact downstream water availability kuhlemann et al 2020 munia et al 2020 in germany a common example for such impacts is the discharge of treated wastewater into surface waters umweltbundesamt uba 2018 that can increase a stream s nutrient load gücker et al 2006 gücker and pusch 2006 and release mixtures of trace organic compounds like pharmaceuticals or personal care products which are insufficiently retained in wastewater treatment plants petrie et al 2015 schirmer et al 2013 mccance et al 2018 nutrients and pollutants can be transported to downstream areas over long distances gessner et al 2014 mcgrane 2016 and have significant impacts on the ecosystems of receiving streams especially when effluents are discharged into smaller streams during low flow conditions in dry periods yang et al 2019 uba 2018 in recent years drier spring and summer periods along with increasing temperatures have started to significantly affect agriculture forestry and water resource management in central europe hänsel et al 2019 in germany in particular the years 2018 and 2019 were amongst the warmest and driest in recorded history leading to widespread drying of soils and plant water stress friedrich and kaspar 2019 imbery et al 2018 kaspar and friedrich 2020 as well as low flows in many river systems bundesamt für gewässerkunde bfg 2020 especially in urbanized areas kuhlemann et al 2020 the long term effects of these unprecedented persistent warm and dry conditions on water fluxes and ecosystems in temperate regions like germany which are not adapted to frequent drought conditions are not well studied buras et al 2020 especially where urban streams receive wastewater effluents more detailed knowledge about the contributions of treated wastewater to streamflow during dry periods and its dilution by other water inputs e g groundwater is required this knowledge will be crucial to maintain dilution rates and regulate the effects of increased nutrient loads on stream ecosystems during changing climate conditions in the future gücker et al 2006 while traditional hydrometric measurements can provide useful insights into quantitative contributions of different water sources to streams their application can be limited in urbanized areas where not all pathways within the complex network of natural and engineered water fluxes are well monitored pataki et al 2011 and where gauges have a higher risk for outage from vandalism in such cases the use of stable isotopes of water as environmental tracers ideally combined with water quality data can provide more nuanced insights into both temporal and spatial variations in water partitioning and routing through a catchment but also into the individual processes and sources contributing to stream runoff kendall mcdonnell 1998 tetzlaff et al 2015 stable isotopes are naturally occurring in the water cycle and behave conservatively however as isotope ratios can be altered by mixing and fractionation processes they can provide valuable insights into water cycling mixing and partitioning e g clark and fritz 1997 kendall and mcdonnell 1998 it has recently been suggested that application to urban problems is a major new research frontier in isotope hydrology ehleringer et al 2016 however urban catchments are highly under represented in the literature slowly recent studies have emerged where stable isotopes often combined with hydrochemical or hydrometric data have been applied in urban impacted landscapes for example isotopes have been used to investigate municipal tap water sources and distribution networks at various spatio temporal scales across the united states bowen et al 2007 jameel et al 2016 landwehr et al 2014 tipple et al 2017 other studies used them to study urban groundwater systems e g demlie et al 2008 their interactions with streamwater delgado et al 2020 or sewer networks houhou et al 2010 kracht et al 2007 wastewater irrigation li et al 2016 or flow structures in effluent impacted wetlands ronkanen and kløve 2007 isotopes have further been used to infer water ages and transit times in urban watersheds grande et al 2020 morales and oswald 2020 parajulee et al 2018 soulsby et al 2015 soulsby et al 2014 other applications include using isotopes in hydrograph separation techniques jefferson et al 2015 meriano et al 2011 and end member mixing models follstad shah et al 2019 jefferson et al 2015 kracht et al 2007 sánchez murillo et al 2020 torres martínez et al 2020 for more quantitative insights into water sources and mixing in the urban water cycle however there is an urgent need for more testing of such approaches to improve process understanding in many different urban and geographic settings especially in the context of climate change and new urban growth berlin the capital city of germany has a population of 3 7 million and is growing with an annual increase of 25 000 amt für statistik berlin brandenburg 2021 with extensive plans for new urban development and re development the city is in a relatively dry region with 600 mm of precipitation p dwd 2021 by 2050 it is expected that p will further decrease while mean annual air temperature tair will increase by up to 2 5 c potentially leading to decreases in stream discharge and deterioration of water quality especially during dry summers gerstengarbe et al 2003 lotze campen et al 2009 water supplies for the city are derived from a combination of local lake water and groundwater extracted conjunctively by various bank filtration plants around the city limberg 2007 möller and burgschweiger 2008 and there are concerns over the sustainability of such supplies especially regarding water quality given projections of climate change and urban growth lotze campen et al 2009 considering the projected climatic changes there is also a need to understand how water withdrawals will be affected by potentially increasing wastewater fractions that can impact the quantity and quality of flows in berlin s water courses uba 2018 in the past numerous studies have investigated runoff sources in berlin s surface waters with some using isotopes e g to assess the city wide response to the 2018 drought kuhlemann et al 2020 especially the impacts of wastewater effluents and combined sewer overflows csos on berlin s surface water system have been a focus for past work e g riechel 2009 riechel et al 2016 weyrauch et al 2010 some of these studies already used isotopes and other wastewater indicators e g massmann et al 2007 massmann et al 2004 however there has not been a systematic catchment scale assessment of spatio temporal variations in stable isotopes in one of berlin s water courses indeed there have been few in many urban settings in other non urban catchments such isotope based studies have been able to provide quantitative insights understanding the dynamics of runoff sources e g smith et al 2021 to address this research gap we used stable water isotopes and water quality measurements to complement climatic and hydrometric data to investigate seasonal patterns of water flow paths and sources in the lowland peri urban erpe catchment in the east of berlin in ne germany the study coincided with the exceptionally warm and dry 2018 2020 period our specific objectives were to a investigate temporal dynamics in climate hydrometrics and isotopes in precipitation and stream flow b characterize spatio temporal dynamics in isotopic composition and water quality characteristics of stream flow and potential source waters e g precipitation urban storm runoff groundwater effluents on a seasonal basis and c assess the applicability of isotope based methods to quantify source water contributions and ages of stream discharge at the catchment scale through this approach we were able to observe how peri urban catchments with complex land use distributions and constant effluent inputs function and release water during persistently dry conditions and discuss some wider implications including limitations and ways forward using an isotope based approach in complex peri urban catchments with limited isotopic variability 2 study site the catchment of the river erpe covers an area of 220 km2 along a 31 km long flow path in ne germany lugv 2011 senstadtum 2013 fig 1 the erpe lies within the northern european plain whose near surface geology was formed by pleistocene glaciations and primarily consists of quaternary unconsolidated sediments lbgr 2010 fig 2 a the catchment s rather flat topography develops from 100 m a s l near its spring on the barnim plateau in the ne to 32 m a s l in the berlin warsaw glacial spillway in the sw where it flows into the river spree lugv 2011 senstadtum 2013 fig 2b while the deposits on the barnim plateau are dominated by subglacial till the abundance of sand deposits gradually increases towards the glacial valley fig 2a in the subsurface an upper freshwater aquifer system comprises a 100 200 m thick sequence of sand and gravel deposits lbgr 2010 limberg and thierbach 1997 limberg and thierbach 2002 groundwater flow follows the topographic gradient and is directed from ne 77 m a s l to sw 30 m a s l lugv 2011 in the glacial valley to the south of the catchment where the groundwater table is only few meters below the surface groundwater abstractions for berlin s drinking water supply partly through bank filtration from the nearby surface waters i e the müggelsee möller and burgschweiger 2008 and the subsequent cone of depression have reversed the natural hydraulic gradient in the lower valley there the erpe is known to be a losing stream in some reaches with surface water infiltration into the subsurface verleger and schuhmacher 2012 in the erpe catchment the long term 10 year mean annual tair reported by the german weather service is 10 7 c and long term mean annual p is 615 mm cf dwd 2020 across the whole catchment land use comprises 60 agriculture 21 urban and 14 forestry senstadtum 2013 we estimate the population living in the catchment to be around 65 000 land use types are heterogeneously distributed across the catchment the northern 96 of the catchment is located in the more rural state of brandenburg lugv 2011 where agriculture and forestry are the major land use types fig 2c the downstream 4 of the catchment is located at the eastern edge of the city of berlin germany s capital lugv 2011 fig 1 consequently urbanization increases from ne to sw with coherent settlements and surface sealing primarily occurring towards the berlin side of the catchment lugv 2011 fig 2c however even the more urbanized areas in berlin contain a significant amount of green space fig 2c and the stream receives little direct runoff from sealed surfaces and connected storm drains from 1 of the catchment area senate department for urban planning senstadt 2004 as the area is connected to a separate sewer system senstadtwoh 2018 influences of csos can be neglected along most of its flow path the stream is surrounded by undeveloped green spaces given that the river would be naturally groundwater dominated and drains a flat landscape with numerous wetlands and lakes high surface and subsurface storage capacities dictate that the stream is generally characterized by very damped and delayed rainfall runoff responses lugv 2011 fig 2 the subsequent low natural stream discharge of the erpe is enhanced by two municipal wastewater treatment plants tps discharging treated effluents the first inflow of the tp werneuchen occurs in the northern catchment with 1400 m3 d stadtwerke werneuchen 2020 fig 1 after the water mixes with inflows from several tributaries entering the stream along its lower course the tp münchehofe discharges 40400 m3 d bwb 2020b into the stream near the berlin brandenburg border fig 1 consequently this leads to an effluent dominated flow regime in the southern catchment especially during dry summers with low natural flows relative contributions of effluents to the discharge of all of berlin s surface waters can be high möller and burgschweiger 2008 uba 2018 for the erpe catchment several previous studies have assessed the impact of effluents on nutrient and micropollutant loads and hyporheic exchange e g gücker et al 2006 gücker and pusch 2006 lewandowski et al 2011 schaper et al 2018 however while these studies were carried out downstream of the tp münchehofe there are few studies that encompass whole catchment approaches that extend further into the rural state of brandenburg 3 methods climatic and hydrometric data were available from several local authorities operating monitoring stations throughout the upstream rural catchment urc which we defined as the catchment upstream of the inflow of the tp münchehofe and the downstream urban catchment duc which we defined as the part of the catchment downstream of the tp münchehofe fig 1 table 1 p data were available from a dwd station in the central catchment fig 1 table 1 stream discharge was monitored at a station 10 km downstream of the tp werneuchen in the urc and a station 3 km downstream of the tp münchehofe in the duc fig 1 table 1 effluent discharge data were available for both tps table 1 groundwater levels were available for two wells in the northern urc with 30 400 m distance to the stream and water levels 3 6 m b s and four wells with 20 750 m distance to the stream and water levels 4 7 m b s in the duc field work was carried out over the course of two years for stable isotope analysis daily p samples were collected near the catchment outlet from august 2018 to august 2020 fig 1 using a hdpe deposition sampler with 100 cm2 opening umwelt geräte technik gmbh and surface water was sampled from december 2018 to august 2020 from the midpoint of the stream near the catchment outlet on a weekly basis fig 1 cf kuhlemann et al 2020 additionally five seasonal spatially distributed synoptic sampling campaigns were undertaken across the 220 km2 catchment over the course of one year in august and october 2018 and in january april and july 2019 during each campaign samples were taken distributed along the course of the stream network from the catchment outlet to the upper catchment near the spring source fig 1 sampling included different sections and stream types i presumably groundwater fed tributaries unaffected by effluents tributaries 2 5 locations ii the main stream after the inflow of the tp werneuchen but upstream of tp münchehofe mixed 7 locations iii the stream downstream of the tp münchehofe effluent dominated 3 5 locations and iv the effluents of the tps themselves effluent 1 2 locations besides the isotope sampling water quality parameters were measured on site at each seasonal sampling location using a wtw multi 3630 ids set with probes for ph sentix940 accuracy 0 004 dissolved oxygen do fdo925 accuracy 1 5 for do precision 0 2 c for water temperature tw and electrical conductivity ec tetracon925 accuracy 0 5 groundwater sampling was undertaken in the urc 1 2 wells and duc 1 5 wells including the wells for which water level data were available in the days following the surface water campaigns fig 1 after measuring the initial water level with an electric contact gauge water was pumped from the wells using a comet geo duplos plus submersible pump and channeled through a bucket where the water quality parameters were monitored until stabilization before samples were taken all samples were filtered 0 2 μm cellulose acetate into 1 5 ml vials llg labware they were subsequently analysed by cavity ring down spectroscopy using a picarro l2130 i isotopic water analyzer analyzed values were linearly corrected with four lab standards and calibrated using standards of the international atomic energy agency iaea after quality checking the averaged results for each sample they were expressed in δ notation analytical precision was 0 04 standard deviation sd for δ18o and 0 14 for δ2h all data analyses and plotting used r studio version 1 2 1335 external climatic and hydrometric data were quality checked removing potentially faulty data points and omitting missing values for the urc processed stream discharge data were available from august 2018 to april 2019 for the remaining study period discharge was estimated from water level data of the same station through linear regression of the previous water level discharge relationship for the duc processed stream discharge data were available throughout the study period daily groundwater levels of individual wells were averaged and subsequently normalized by subtracting the average over the whole study period and dividing by sd to better illustrate the dynamics for the urc and duc respectively for a first assessment of effluent contributions to stream discharge a simple comparison between mean stream discharge qstream and mean treatment plant discharge qeffluent in the respective sampling months was carried out as a measure for potential fractionation effects on the isotope samples deuterium d excess was calculated as d exc δ2h 8 δ18o dansgaard 1964 daily p isotope data were used in an amount weighted least square regression hughes and crawford 2012 to calculate a local meteoric water line lmwl fractions of young water fyw were estimated through sine wave fitting of seasonal cycles von freyberg et al 2018 using weekly streamwater and p isotope data in the duc with the goodness of fit to data measured by the significance of the regression r2 additionally mean transit times mtt were estimated through lumped convolution method mcguire and mcdonnell 2006 using a one year spin up period estimations of shape α and scale β parameters were used in a gamma transfer function to maximize the kling gupta efficiency kge gupta et al 2009 as model performance metric and fitting the amount weighted weekly p isotope means to the weekly stream water isotopes to illustrate the potential but also limitations of an isotope based assessment of seasonal water sources in the catchment a principal component analysis pca and end member mixing analysis emma were carried out the pca was performed using the data of the 2019 sampling campaigns january april july which had the highest number of sampling points including the effluent of both tps and several groundwater wells the variables with the most robust measurements and highest inter group variability ec tw δ18o and d excess were selected to identify the major causes of variation between samples of different groups to estimate water contributions to the erpe fractions of effluent in the streamwater in the urc and duc during the 2019 sampling campaigns were assessed through emma using the mixsiar model stock and semmens 2016 stock et al 2018 in this bayesian model framework the probability distribution of proportional source contributions to streamflow was estimated while uncertainties in data and sources were included in the framework by defining means and variance parameters for each potential source and tracer moore and semmens 2008 we used uninformative priors indicating equal likelihood of all sources moore and semmens 2008 to generate independent draws using markov chain monte carlo mcmc with 100 000 iterations in the urc wastewater fractions in mixed water at three representative sites were estimated assuming contributions of the tp werneuchen effluent groundwater and selected tributaries in the duc wastewater fractions in effluent dominated samples were estimated assuming contributions of four mixed water samples and one tributary before the confluence and the effluent of the tp münchehofe the selection of sources end members was based on knowledge obtained through literature and water management authorities in the respective parts of the catchment and on our observations during the field campaigns two tracers ec and d excess were selected for emma contributions of groundwater were neglected in the duc assuming groundwater abstractions to have reversed the natural flow conditions cf verleger and schuhmacher 2012 direct contributions of incoming p were assumed to be low in both the urc and duc during periods when the synoptic sampling occurred because of little rainfall during sampling and the damped and delayed rainfall runoff response cf lugv 2011 and therefore were not included in the model 4 results 4 1 climatic hydrometric and isotope dynamics our study was carried out during exceptionally warm and dry climate conditions including part of the 2018 european drought in the berlin brandenburg area the years 2018 and 2019 were 1 5 c warmer than the long term 1981 2010 mean annual tair of 9 3 c and had a p deficit of 30 in 2018 and 10 in 2019 from the long term mean annual p of 577 mm dwd 2021 in the erpe catchment conditions were dry in the beginning of our study period with only 63 mm of p in autumn september november 2018 fig 3 this was followed by wetter periods with p totaling 126 and 109 mm respectively in winter december february 2018 2019 and spring march may 2019 in summer june august 2019 p 116 mm mainly occurred through heavy convective events in autumn and winter 2019 2020 p was higher than the previous year totaling 150 mm respectively in spring 2020 p was again lower than average with only 74 mm fig 3 the erpe showed an overall very stable flow regime however differences could be observed between urc and duc in the urc discharge was low with 0 05 m3 s in summer 2018 increasing to 0 1 m3 s over the winter 2018 2019 fig 3 in summer 2019 discharge was even lower with 0 04 m3 s discharge from the tp werneuchen in the urc was 0 02 m3 s with some daily but no seasonal variability fig 3 groundwater levels in the urc decreased over the summer and increased in winter hovever despite these temporary increases overall groundwater levels constantly declined from 2018 to 2020 with insufficient winter recharge to recover to previous levels fig 3 in the duc stream discharge was higher daily means increased from 0 5 m3 s in summer 2018 to 0 9 m3 s in winter 2018 2019 fig 3 fig 4 afterwards values decreased again to 0 4 m3 s in summer 2019 and only increased back to 0 7 m3 s in spring and 0 8 m3 s in summer 2020 discharge of the tp münchehofe was stable throughout the study period with little seasonal but some daily variability around daily means of 0 5 m3 s fig 3 fig 4 groundwater levels in the duc also constantly declined from summer 2018 until winter 2019 fig 3 with some daily variability likely reflecting the effects of daily pumping in wells south of the lower catchment cf verleger and schuhmacher 2012 towards early 2020 groundwater levels temporarily rose again but did not recover to summer 2018 levels fig 3 during dry low flow conditions in july august 2019 discharge of the tps in both the urc and duc exceeded stream discharge downstream of their inflow fig 3 in both the urc and duc modest increases in stream discharge occured after larger p events comparing qeffluent to qstream in the months of the seasonal sampling campaigns showed that from a hydrometric perspective contributions of effluent to streamflow were likely variable throughout the year as groundwater influxes change between winter and summer in the urc qeffluent was between 38 in august 2018 and 14 in january relative to qstream downstream of the confluence table 2 in the duc qeffluent exceeded qstream measured 3 km downstream of the confluence in august 2018 and july 2019 in the remaining months qeffluent was lower than qstream and gradually decreased in spring and autumn with lowest values in january 2019 when qeffluent was 47 of qstream table 2 daily p isotopes in the duc followed a seasonal pattern being more depleted in heavy isotopes in winter and more enriched in summer particularly during the heavy convective p events in 2019 fig 4 however inter event variability could be large regardless of season in comparison weekly stream water isotope patterns were much more damped exhibiting remarkable consistency with an overall variability of only 10 for δ2h and 2 for δ18o during the two year sampling period fig 4 no clear seasonal variability could be observed strongest variations occured in response to some larger p events when the stream s isotopic signal moved in the direction of recent p the low variability in weekly stream water isotopes even following storm events is consistent with a dominance of older well mixed water in the erpe fyw estimates from δ2h values were small accounting for only 7 of total flow table 3 similarly mtts were estimated at 2 3 years in both cases model performance metrics r2 and p value for fyw and kge for mtt indicate better fit for δ2h than for δ18o though both were low indicating substantial uncertainty of the results table 3 nevertheless it is clear from the analysis that influxes from precipitation and storm drains bringing new water had a very small impact on stream flow generation in the erpe during the study period despite about 21 of the catchment being urban 4 2 seasonal dynamics in isotopic composition and water quality parameters along the stream network the lwml in the duc during the study period was δ2h 8 05 0 13 δ18o 11 19 1 15 fig 5 although the overall isotopic variability across the catchment remained low the five spatially distributed surveys captured some seasonal variability fig 5 in august 2018 samples were more enriched and became gradually more depleted in october 2018 and january 2019 in april 2019 the samples again became more enriched samples taken in july 2019 were the most enriched during the study period exceeding the isotopic enrichment observed during the much drier summer of 2018 sampled groundwater was most depleted throughout the year with effluents intermediate between groundwater and weekly stream samples fig 5 spatial patterns throughout the catchment show subtle variations in the isotopic composition of the stream these revealed important process insights despite the inflow of the two tps fig 6 between the different sampled water types more enriched values were observed in effluent dominated samples from october 2018 to april 2019 and in mixed waters in august 2018 april and particularly july 2019 fig 6a fig 7 throughout the year groundwater and some tributaries were usually more depleted except for tributaries in july 2019 d excess on the other hand showed higher variability across the catchment and ranged from 3 to 10 fig 6b fig 7 in october 2018 january and april 2019 when discharge was higher and more frequent p occurred d excess was highest in groundwater and tributaries and lowest in the effluent and effluent dominated stream section during those times the more fractionated effluent increased d excess downstream of the confluence especially in the duc fig 6b fig 7 vice versa during the low flow period and high tair in july 2019 d excess was highest in groundwater and lowest in the tributaries and mixed waters of the urc the effluent itself also showed variability in its isotopic composition being more depleted with higher d excess in april 2019 fig 7 further variability between seasons and stream sections was evident in the measured water quality parameters ph was circumneutral between 7 2 and 8 1 throughout the year fig 8 within this range slightly lower values were measured in groundwater with the effluent moving towards similar lower values in january and april 2019 and slightly higher values in tributaries and mixed waters in the urc ec was high and ranged from 660 to 1520 μs cm lowest values were measured in the tributaries and groundwater and highest values in the effluents this led to a gradual increase in ec downstream in the mixed waters after the inflow of tp werneuchen and especially in the effluent dominated water after the inflow of tp münchehofe fig 6c fig 8 throughout the year this spatial trend dominated seasonal variations across the catchment tw showed expected seasonality with values 20 c in august 2018 and july 2019 and 6 c in january 2019 fig 6d fig 8 during all seasons effluents were slightly warmer than stream water and the tp münchehofe subsequently elevated tw in the effluent dominated samples downstream of the confluence relative tw differences in the duc were especially pronounced in october 2018 and january 2019 4 c groundwater tw was much more stable 10 16 c throughout the year fig 8 surface water do ranged from 40 to 100 and also showed seasonal variability which was as expected temperature dependent during the warm low flow conditions in august and october 2018 and july 2019 do was lower especially in tributaries and mixed waters in the urc fig 8 during these periods highest do was measured in the effluent fig 8 during higher flows and lower tair and tw in january and april 2019 do was higher occasionally reaching supersaturation groundwater do in most wells was low 10 throughout the year 4 3 contributions of groundwater and effluents to stream discharge under different flow conditions in the pca for the synoptic surveys the first two principal components pc explained 90 of the variability in january and july 2019 and 70 in april 2019 the main contributions to pc1 were d excess and δ18o along with ec january and t july main contributions to pc2 were tw january tw and ec april and ec july during the high flows in january 2019 and low flows in july 2019 the sampled water types could be clearly separated in the biplot fig 9 in january low tair was reflected in the low tw in mixed waters and tributaries which were similar to each other groundwater on the other hand was associated with higher tw effluent and effluent dominated stream samples formed a distinct cluster characterized by higher δ18o lower d excess and higher ec in the warm and dry july 2019 effluent and effluent impacted waters were correlated with high ec and groundwater was characterized by higher d excess and lower tw again mixed waters and tributaries were similar to each other while few samples showed a resemblance to groundwater and effluent most surface water samples plotted away from this contribution towards higher δ18o and lower d excess likely a result of evaporative fractionation in april when tair and stream discharge were intermediate fig 3 the distinction between the sampled waters was less clear again effluent and effluent impacted stream samples were correlated with higher ec and δ18o lower d excess and to some extent higher tw however tributaries were similar to groundwater and showed a correlation with higher d excess mixed samples showed an intermediate composition between tributaries groundwater and effluent in the emma for the sampling campaigns in 2019 the model estimated contributions of 49 groundwater fed tributaries 34 effluent of the tp werneuchen and 18 groundwater to streamflow during the higher flows in january and april in the urc table 4 during the drier conditions in july predicted contributions were 64 effluent 30 tributaries and 6 groundwater however sds were high indicating substantial uncertainty in the duc effluent contributions were estimated as 70 in both the cold high flow periods in january and the warm dry period in july this depicts a strong contrast to the discharge data fig 3 table 2 in april the model estimated effluent contributions of only 5 sds in the duc remained high and exceeded estimates of the contributions of mixed waters table 4 5 discussion 5 1 temporal dynamics in climate hydrometrics and isotopes our sampling period coincided with the drought of 2018 which negatively impacted water balances and ecosystems across central and northern europe buras et al 2020 however this provided a unique opportunity to observe the impacts of exceptionally warm and dry conditions in the erpe as an exemplar of a temperate peri urban lowland catchment impacted by effluent discharge despite differences in land use fig 2c and flow regimes in the urc and duc the substantial p deficits of 34 in 2018 and 21 in 2019 compared to 10 year means cf dwd 2020 decreased summertime stream discharge by 50 in both sub catchments compared to winter fig 3 and long term seasonal means cf senuvk 2020b this contrasts catchments elsewhere where the depletion of water storage following the 2018 drought was restored by the end of 2019 following a period of above average rainfall fennell et al 2020 however such periods of higher rainfall were not sufficient to refill storage in the berlin brandenburg area and despite increased p in winter 2018 2019 stream discharge and groundwater levels remained lower in summer 2019 than during the drier previous year fig 3 this indicates that not the year 2018 alone but rather the continuously warm and dry conditions over two consecutive years have had a strong impact on the water balance of the study catchment our observations are consistent with a similar study following the 2018 2019 drought in a rural catchment 50 km southeast of our study area kleine et al 2021 5 2 seasonal dynamics in isotopic composition and water quality along the stream network the lmwl for the study period fig 5 was similar to kuhlemann et al 2020 but deviates from that of stumpp et al 2014 for berlin and germany by a higher intercept temporal variability in streamwater isotopic signatures in the erpe especially after the heavy convective p events in the summer of 2019 fig 4 was low compared to other streams in the berlin brandenburg area kuhlemann et al 2020 such patterns are typical for well mixed stream waters of groundwater dominated catchments that often coincide with a permeable sub surface large storage and lack of rapid hydrological pathways scheliga et al 2017 smith et al 2020 however the impact of two wastewater treatment plants also contributed to this stability in the berlin brandenburg area wastewater effluents are usually recycled local abstractions from surface water bank filtrate and local groundwater resulting in depleted isotopic signature in the effluent that is similar to groundwater massmann et al 2007 which could be observed in our data however effluents in our study were usually more fractionated than local groundwater fig 5 fig 7 this possibly reflects the fractionation of lake water as well as the effect of domestic water uses for example it is noticeable that in the wettest synoptic sampling period in april the effluent was less fractionated consistent with the winter turnover of berlin s stream and lake waters and the loss of fractionation signals kuhlemann et al 2020 however further data on water supplies and wastewater would be needed to establish this the limited isotopic variability in the erpe was not only evident in the temporal dynamics at the catchment outlet but was also captured by the seasonal spatially distributed sampling campaigns still important new insights were gained based on the isotope analysis which have significance for the future in agreement with the observed depletion of groundwater storage more enriched streamwater isotopes and lower d excess in july 2019 across the catchment figs 5 7 reflected the higher impact of the second consecutive drought year this enrichment may especially be related to the impact of wetlands in the catchment as evaporative fractionation in times of high potential evapotranspiration pet and low stream discharge is quite common in headwaters draining through wetlands sprenger et al 2017 although being less pronounced in the erpe catchment the stronger enrichment in 2019 rather than 2018 is consistent with other local wetland impacted catchments in the berlin area kuhlemann et al 2020 this observation may be a first manifestation of the high vulnerability of wetlands and groundwater dependent ecosystems to climate warming that has long been predicted for the berlin brandenburg area lotze campen et al 2009 it is also indicative of potential long term decreases in natural groundwater contributions to summer baseflows as a result of reduced recharge for the measured water quality parameters downstream changes were more pronounced than temporal variability for example discharge of effluents introduced waters with higher ec fig 8 that increased ec values in downstream areas throughout the year fig 6 other diffuse nutrient inputs e g from agriculture gücker et al 2006 gücker and pusch 2006 or domestic gardening lugv 2011 may have amplified this increase still a clear impact on low flow conditions was observed as the expected increases in tw during times of high tair and subsequent increases in algae growth and oxygen depletion cf lotze campen et al 2009 were clearly visible in the seasonal variability of these parameters and the resulting deterioration of water quality during the warm and dry summers of 2018 and 2019 throughout the catchment fig 8 5 3 estimates of groundwater and effluent contributions to stream discharge under different flow conditions in the past most studies on isotope based source assessment have been carried out in experimental rural or forested catchments with marked spatial and temporal variations in the isotopic signatures of water sources and stream flow recent growth in urban isotope applications seeks to exploit similar characteristics of anthropogenically impacted areas ehleringer et al 2016 here isotope based studies helped to apportion time variant stream flow sources follstad shah et al 2019 jefferson et al 2015 meriano et al 2011 sánchez murillo et al 2020 estimated associated ages and travel time distributions morales and oswald 2020 parajulee et al 2018 soulsby et al 2014 and provided information on how flux dynamics are related to those of stored waters soulsby et al 2015 however the multitude of water and pollution sources in urbanized areas makes source assessments based on isotopes alone more challenging mccance et al 2018 however the erpe clearly has a limited influence of young water in terms of recent rainfall with fyw 10 and indicative mtt in the range 2 3 years table 2 despite 21 of the catchment being urbanized senstadtum 2013 although the fyw is slightly higher the mtts are similar to estimates in small catchments in rural areas of brandenburg kleine et al 2021 and to a 13 urbanized catchment in scotland soulsby et al 2014 the observed low young water contributions were probably exacerbated in the dry study period when precipitation was low and storm drains would be activated less frequently but such conditions will likely become more common in the future moreover in a catchment where soils are freely draining there is little overland flow to transmit rainfall signals rapidly into streams unless conditions are extremely wet smith et al 2020 despite these insights the dominant influence of isotopically stable groundwater and effluents result in uncertain age estimates as both sources are derived from older groundwater and or lake reservoirs with ages likely 4 years which is the limit for stable isotopes to discern ages mcguire and mcdonnell 2006 scheliga et al 2017 tetzlaff et al 2015 for streams in brandenburg recent tritium based tracer studies showed that that deeper groundwater is usually at least decadal due to low recharge massmann et al 2009 and very recent tracer aided modelling smith et al 2020 has shown that shallow groundwater may be similarly decadal in addition our weekly sampling resolution even if high for this spatial scale covered may under represent transient storm events especially summer convectional storms and associated increases in new water fractions in the stream such a sampling bias towards baseflow conditions is a problem encountered by others estimating mtts in flashy urbanized catchments morales and oswald 2020 considering the complexity that anthropogenic impacts and engineered components add to urbanized water cycles the demographics of water ages may need to be re conceptualised for urban settings where effluents could be viewed as being both young and old water cf sprenger et al 2019 the hydrometric assessment indicating higher effluent than stream discharge downstream of the confluence in the duc in both august 2018 and july 2019 table 2 is likely related to the losing nature of the stream cf verleger and schuhmacher 2012 however the results also demonstrate that a quantitative estimation of source contributions from hydrometric data alone may not be possible in anthropogenically altered catchments and underline the utility of tracer based assessment this is especially the case during times of drought and when discharge is not monitored directly at the engineered inflows but rather several kilometers downstream due to logistic reasons except for april when tair was similar to groundwater tw and evaporative fractionation in the stream and effluent was still limited the combination of four isotope and water quality tracers could successfully separate the sampled water types during the highest january and lowest july discharge conditions in the pca fig 9 for quantitative assessment of source contributions through the emma table 3 estimates in the urc although showing high sd values indicated lower contributions of groundwater and groundwater fed tributaries during the dry july 2019 than during higher flows in january and april while in natural environments it would be expected that groundwater contributions dominate during drier periods in absence of new water from incoming p fennell et al 2020 the constant effluent inflow in the erpe may have reduced the relative importance of natural groundwater sources and increased effluent proportions in downstream river sections in the duc high effluent contributions in both january and july show the dominance of effluent regardless of any groundwater exchange that may occur the low estimate in april is implausible likely reflecting the unfractionated nature of the effluent at that time fig 7 fig 9 such overlaps in isotope based mixing analysis have also been reported in previous studies on effluent impacted stream systems e g follstad shah et al 2019 and may be be a problem in many other urbanized catchments with internal re cycling of water 5 4 wider implications challenges and future research regarding the use of isotopes in catchments with urban impacted streams our study indicated that d excess may be the more suitable than δ18o or δ2h alone for assessing spatio temporal variations where effluent waters have a fractionation signal or some stream sections may be subject to evaporation at low flows combining the isotope data with water quality measurements particularly ec and tw facilitated a sufficient qualitative separation of water sources during the periods of highest and lowest flows to distinguish major changes in water sources this underlines the value of integrating stable isotopes with water quality parameters for insights into water and pollution sources and transformation processes in anthropogenically impacted catchments e g kuhlemann et al 2020 torres martínez et al 2020 despite the valuable insights into the functioning of a lowland peri urban effluent impacted catchment we encountered several challenges to realizing the potential of isotope based approaches cf ehleringer et al 2016 in urban impacted landscapes this is especially the case where internal re cycling of isotopically similar local water resources restricts isotopic variability this resulted in problems in estimating water ages as well as quantitative based hydrometric assessment of source contributions to streamflow although our approach conducting five synoptic surveys covered contrasting seasons the drought conditions dictated that temporal variability in hydrology was suppressed obviously higher resolution sampling especially with event sampling e g von freyberg et al 2017 over longer time periods will likely reveal more complex dynamics than observed in our study in addition many urban isotope studies will require a greater focus on the composition of effluent waters and their changing dynamics which can be significant as our april samples show even sub daily sampling may need to be considered to cover diurnal variations in the tp discharge cf ledford and toran 2019 lewandowski et al 2011 although we considered only a limited range of water quality parameters the general deterioration along the stream network with increasing effluent influence in downstream areas was evident throughout the year however as climate change projections for berlin indicate less rainfall and higher temperatures gerstengarbe et al 2003 lotze campen et al 2009 the importance of effluents as a component of stream flow will likely increase in the future more research will be needed to identify adequate dilution rates needed under low flow conditions in a changing climate gücker et al 2006 yang et al 2019 in addition integrating wastewater indicators from treatment plants into tracer studies e g boron fox et al 2002 or anthropogenic gadolinium massmann et al 2007 möller et al 2002 will provide additional information on water quality impacts during low flow periods particularly the combination of emerging contaminants like pharmaceuticals personal care products artificial sweeteners or pesticides with stable isotope and major ion data has recently been highlighted as a very promising approach to overcome limitations of isotope based assessment of water and contaminant sources in complex urban and peri urban areas mccance et al 2018 including these compounds in future research can therefore improve source distinction in methods such as emma as well as better constraining age estimates there is also a general need for more complex and sophisticated modelling approaches that fully account for the heterogeneity in land use distributions especially in peri urban areas and the complex interactions between natural and engineered compartments of the water cycle in urbanized areas fletcher et al 2013 mcgrane 2016 6 conclusions in this study we used isotope tracers and water quality measurements to complement hydrometric and climatic data to assess how the increasingly warm and dry conditions of 2018 2020 affected water cycling in the lowland peri urban erpe catchment in germany that is impacted by treated wastewater effluents in particular we assessed the seasonal patterns of water flow paths and sources at different spatio temporal scales the work provided new insights into how such lowland peri urban catchments with complex land use distributions and substantial effluent influences function hydrologically we gained new understanding how such systems store release and mix water especially under the unprecedented warm and dry conditions of 2018 2020 memory effects of the 2018 drought were evident in lower discharge rates more fractionated isotope signatures and declining groundwater levels in the second consecutive dry year it is clear from hydrometric data and the pca the discharge of effluents maintained rather stable flow conditions during the dry summers especially in the lower catchment our results indicate that streamflow was dominated by inputs of groundwater and groundwater fed tributaries in the upper rural catchment and experienced a downstream deterioration of water quality as effluent contributions gained importance in the more urbanized part of the catchment duc seasonal variability was low but the effects of two consecutive summers with below average precipitation and above average temperatures were reflected in a decrease in streamflow declining groundwater levels and widespread isotopic enrichment indicating higher effluent influences and evaporative losses in streamwater despite these insights lack of variability in the isotopic signatures of effluent and local groundwater resulted in uncertain estimates of water ages and sources contributing to streamflow for more detailed insights into seasonal water sources of anthropogenically altered catchments future research would benefit from longer term higher resolution monitoring and additional tracers e g wastewater indicators such studies will be crucial for ensuring maintenance of sufficient dilution rates for effluent impacted streams and sustainably managing urban water resources during future climate warming and increasing urbanization credit authorship contribution statement lena marie kuhlemann conceptualization formal analysis investigation methodology visualization writing original draft doerthe tetzlaff conceptualization data curation formal analysis funding acquisition methodology supervision writing original draft chris soulsby conceptualization data curation formal analysis methodology supervision writing original draft declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was funded as part of the research training group urban water interfaces uwi grk 2032 by the german research foundation dfg and supported by the einstein foundation through the project modelling surface and groundwater with isotopes in urban catchments mosaic contributions from c s were funded by the leverhulme trust s isoland project we thank n weiß d dubbert e brakkee a wieland and a dahlmann for help with the sampling d dubbert for running the isotope analysis and a smith for help with the data analysis we also thank the bwb berlin senate lfu brandenburg and stadtwerke werneuchen for their assistance in sampling and data provision 
4432,in peri urban catchments where treated wastewater effluents are released into surface waters knowledge of water sources and partitioning is important for mitigating water quality impacts particularly during warm and dry periods with low discharge rates useful tools for the identification of water sources and flow paths under different wetness conditions are isotope tracers however very few studies have been carried out so far in urbanized catchments with complex land use distributions where natural headwaters interact with engineered components e g effluent discharge we undertook spatio temporal sampling of isotopes combined with water quality measurements to complement climatic and hydrometric data across the 220 km2 peri urban erpe catchment near berlin and assess seasonal changes in water sources during two exceptionally warm and dry years 2018 and 2019 the study showed a deterioration of water quality downstream of two municipal wastewater treatment plants and the depletion of groundwater storage along with isotopic enrichment of the stream in summer 2019 the second consecutive year with above average temperatures and marked precipitation deficits streamflow in the upper reaches of the catchment was dominated by groundwater fed tributaries in winter but became increasingly dominated by wastewater in summer in the lower catchment flows were dominated by effluent from a large wastewater treatment plant especially in summer young water from precipitation and urban storm runoff accounted for 10 of streamflow despite the catchment being 20 urban similarities in the composition of wastewater and other runoff sources resulted in high uncertainties in end member separation and highlight the need for monitoring of other tracers to better characterize water impacts given climate change projections for the region are for drier warmer summers wastewater is likely to become a more dominant component of streams which may have implications for environmental quality and ecosystem services keywords ecohydrology stable isotopes hydrogeochemistry tracers peri urban catchments wastewater effluents 1 introduction freshwater resources around the world are under increasing stress resulting from a changing climate and growing populations in increasingly urbanized areas subsequent increases in water distribution conflicts between urban and agricultural sectors flörke et al 2018 call for more integrated water management strategies that extend across catchment and administrative boundaries munia et al 2020 implementing such strategies is especially challenging for peri urban catchments which are often characterized by a complex distribution and rapidly evolving mosaic of rural urban and agricultural components fletcher et al 2013 and for catchments where processes in upstream areas significantly impact downstream water availability kuhlemann et al 2020 munia et al 2020 in germany a common example for such impacts is the discharge of treated wastewater into surface waters umweltbundesamt uba 2018 that can increase a stream s nutrient load gücker et al 2006 gücker and pusch 2006 and release mixtures of trace organic compounds like pharmaceuticals or personal care products which are insufficiently retained in wastewater treatment plants petrie et al 2015 schirmer et al 2013 mccance et al 2018 nutrients and pollutants can be transported to downstream areas over long distances gessner et al 2014 mcgrane 2016 and have significant impacts on the ecosystems of receiving streams especially when effluents are discharged into smaller streams during low flow conditions in dry periods yang et al 2019 uba 2018 in recent years drier spring and summer periods along with increasing temperatures have started to significantly affect agriculture forestry and water resource management in central europe hänsel et al 2019 in germany in particular the years 2018 and 2019 were amongst the warmest and driest in recorded history leading to widespread drying of soils and plant water stress friedrich and kaspar 2019 imbery et al 2018 kaspar and friedrich 2020 as well as low flows in many river systems bundesamt für gewässerkunde bfg 2020 especially in urbanized areas kuhlemann et al 2020 the long term effects of these unprecedented persistent warm and dry conditions on water fluxes and ecosystems in temperate regions like germany which are not adapted to frequent drought conditions are not well studied buras et al 2020 especially where urban streams receive wastewater effluents more detailed knowledge about the contributions of treated wastewater to streamflow during dry periods and its dilution by other water inputs e g groundwater is required this knowledge will be crucial to maintain dilution rates and regulate the effects of increased nutrient loads on stream ecosystems during changing climate conditions in the future gücker et al 2006 while traditional hydrometric measurements can provide useful insights into quantitative contributions of different water sources to streams their application can be limited in urbanized areas where not all pathways within the complex network of natural and engineered water fluxes are well monitored pataki et al 2011 and where gauges have a higher risk for outage from vandalism in such cases the use of stable isotopes of water as environmental tracers ideally combined with water quality data can provide more nuanced insights into both temporal and spatial variations in water partitioning and routing through a catchment but also into the individual processes and sources contributing to stream runoff kendall mcdonnell 1998 tetzlaff et al 2015 stable isotopes are naturally occurring in the water cycle and behave conservatively however as isotope ratios can be altered by mixing and fractionation processes they can provide valuable insights into water cycling mixing and partitioning e g clark and fritz 1997 kendall and mcdonnell 1998 it has recently been suggested that application to urban problems is a major new research frontier in isotope hydrology ehleringer et al 2016 however urban catchments are highly under represented in the literature slowly recent studies have emerged where stable isotopes often combined with hydrochemical or hydrometric data have been applied in urban impacted landscapes for example isotopes have been used to investigate municipal tap water sources and distribution networks at various spatio temporal scales across the united states bowen et al 2007 jameel et al 2016 landwehr et al 2014 tipple et al 2017 other studies used them to study urban groundwater systems e g demlie et al 2008 their interactions with streamwater delgado et al 2020 or sewer networks houhou et al 2010 kracht et al 2007 wastewater irrigation li et al 2016 or flow structures in effluent impacted wetlands ronkanen and kløve 2007 isotopes have further been used to infer water ages and transit times in urban watersheds grande et al 2020 morales and oswald 2020 parajulee et al 2018 soulsby et al 2015 soulsby et al 2014 other applications include using isotopes in hydrograph separation techniques jefferson et al 2015 meriano et al 2011 and end member mixing models follstad shah et al 2019 jefferson et al 2015 kracht et al 2007 sánchez murillo et al 2020 torres martínez et al 2020 for more quantitative insights into water sources and mixing in the urban water cycle however there is an urgent need for more testing of such approaches to improve process understanding in many different urban and geographic settings especially in the context of climate change and new urban growth berlin the capital city of germany has a population of 3 7 million and is growing with an annual increase of 25 000 amt für statistik berlin brandenburg 2021 with extensive plans for new urban development and re development the city is in a relatively dry region with 600 mm of precipitation p dwd 2021 by 2050 it is expected that p will further decrease while mean annual air temperature tair will increase by up to 2 5 c potentially leading to decreases in stream discharge and deterioration of water quality especially during dry summers gerstengarbe et al 2003 lotze campen et al 2009 water supplies for the city are derived from a combination of local lake water and groundwater extracted conjunctively by various bank filtration plants around the city limberg 2007 möller and burgschweiger 2008 and there are concerns over the sustainability of such supplies especially regarding water quality given projections of climate change and urban growth lotze campen et al 2009 considering the projected climatic changes there is also a need to understand how water withdrawals will be affected by potentially increasing wastewater fractions that can impact the quantity and quality of flows in berlin s water courses uba 2018 in the past numerous studies have investigated runoff sources in berlin s surface waters with some using isotopes e g to assess the city wide response to the 2018 drought kuhlemann et al 2020 especially the impacts of wastewater effluents and combined sewer overflows csos on berlin s surface water system have been a focus for past work e g riechel 2009 riechel et al 2016 weyrauch et al 2010 some of these studies already used isotopes and other wastewater indicators e g massmann et al 2007 massmann et al 2004 however there has not been a systematic catchment scale assessment of spatio temporal variations in stable isotopes in one of berlin s water courses indeed there have been few in many urban settings in other non urban catchments such isotope based studies have been able to provide quantitative insights understanding the dynamics of runoff sources e g smith et al 2021 to address this research gap we used stable water isotopes and water quality measurements to complement climatic and hydrometric data to investigate seasonal patterns of water flow paths and sources in the lowland peri urban erpe catchment in the east of berlin in ne germany the study coincided with the exceptionally warm and dry 2018 2020 period our specific objectives were to a investigate temporal dynamics in climate hydrometrics and isotopes in precipitation and stream flow b characterize spatio temporal dynamics in isotopic composition and water quality characteristics of stream flow and potential source waters e g precipitation urban storm runoff groundwater effluents on a seasonal basis and c assess the applicability of isotope based methods to quantify source water contributions and ages of stream discharge at the catchment scale through this approach we were able to observe how peri urban catchments with complex land use distributions and constant effluent inputs function and release water during persistently dry conditions and discuss some wider implications including limitations and ways forward using an isotope based approach in complex peri urban catchments with limited isotopic variability 2 study site the catchment of the river erpe covers an area of 220 km2 along a 31 km long flow path in ne germany lugv 2011 senstadtum 2013 fig 1 the erpe lies within the northern european plain whose near surface geology was formed by pleistocene glaciations and primarily consists of quaternary unconsolidated sediments lbgr 2010 fig 2 a the catchment s rather flat topography develops from 100 m a s l near its spring on the barnim plateau in the ne to 32 m a s l in the berlin warsaw glacial spillway in the sw where it flows into the river spree lugv 2011 senstadtum 2013 fig 2b while the deposits on the barnim plateau are dominated by subglacial till the abundance of sand deposits gradually increases towards the glacial valley fig 2a in the subsurface an upper freshwater aquifer system comprises a 100 200 m thick sequence of sand and gravel deposits lbgr 2010 limberg and thierbach 1997 limberg and thierbach 2002 groundwater flow follows the topographic gradient and is directed from ne 77 m a s l to sw 30 m a s l lugv 2011 in the glacial valley to the south of the catchment where the groundwater table is only few meters below the surface groundwater abstractions for berlin s drinking water supply partly through bank filtration from the nearby surface waters i e the müggelsee möller and burgschweiger 2008 and the subsequent cone of depression have reversed the natural hydraulic gradient in the lower valley there the erpe is known to be a losing stream in some reaches with surface water infiltration into the subsurface verleger and schuhmacher 2012 in the erpe catchment the long term 10 year mean annual tair reported by the german weather service is 10 7 c and long term mean annual p is 615 mm cf dwd 2020 across the whole catchment land use comprises 60 agriculture 21 urban and 14 forestry senstadtum 2013 we estimate the population living in the catchment to be around 65 000 land use types are heterogeneously distributed across the catchment the northern 96 of the catchment is located in the more rural state of brandenburg lugv 2011 where agriculture and forestry are the major land use types fig 2c the downstream 4 of the catchment is located at the eastern edge of the city of berlin germany s capital lugv 2011 fig 1 consequently urbanization increases from ne to sw with coherent settlements and surface sealing primarily occurring towards the berlin side of the catchment lugv 2011 fig 2c however even the more urbanized areas in berlin contain a significant amount of green space fig 2c and the stream receives little direct runoff from sealed surfaces and connected storm drains from 1 of the catchment area senate department for urban planning senstadt 2004 as the area is connected to a separate sewer system senstadtwoh 2018 influences of csos can be neglected along most of its flow path the stream is surrounded by undeveloped green spaces given that the river would be naturally groundwater dominated and drains a flat landscape with numerous wetlands and lakes high surface and subsurface storage capacities dictate that the stream is generally characterized by very damped and delayed rainfall runoff responses lugv 2011 fig 2 the subsequent low natural stream discharge of the erpe is enhanced by two municipal wastewater treatment plants tps discharging treated effluents the first inflow of the tp werneuchen occurs in the northern catchment with 1400 m3 d stadtwerke werneuchen 2020 fig 1 after the water mixes with inflows from several tributaries entering the stream along its lower course the tp münchehofe discharges 40400 m3 d bwb 2020b into the stream near the berlin brandenburg border fig 1 consequently this leads to an effluent dominated flow regime in the southern catchment especially during dry summers with low natural flows relative contributions of effluents to the discharge of all of berlin s surface waters can be high möller and burgschweiger 2008 uba 2018 for the erpe catchment several previous studies have assessed the impact of effluents on nutrient and micropollutant loads and hyporheic exchange e g gücker et al 2006 gücker and pusch 2006 lewandowski et al 2011 schaper et al 2018 however while these studies were carried out downstream of the tp münchehofe there are few studies that encompass whole catchment approaches that extend further into the rural state of brandenburg 3 methods climatic and hydrometric data were available from several local authorities operating monitoring stations throughout the upstream rural catchment urc which we defined as the catchment upstream of the inflow of the tp münchehofe and the downstream urban catchment duc which we defined as the part of the catchment downstream of the tp münchehofe fig 1 table 1 p data were available from a dwd station in the central catchment fig 1 table 1 stream discharge was monitored at a station 10 km downstream of the tp werneuchen in the urc and a station 3 km downstream of the tp münchehofe in the duc fig 1 table 1 effluent discharge data were available for both tps table 1 groundwater levels were available for two wells in the northern urc with 30 400 m distance to the stream and water levels 3 6 m b s and four wells with 20 750 m distance to the stream and water levels 4 7 m b s in the duc field work was carried out over the course of two years for stable isotope analysis daily p samples were collected near the catchment outlet from august 2018 to august 2020 fig 1 using a hdpe deposition sampler with 100 cm2 opening umwelt geräte technik gmbh and surface water was sampled from december 2018 to august 2020 from the midpoint of the stream near the catchment outlet on a weekly basis fig 1 cf kuhlemann et al 2020 additionally five seasonal spatially distributed synoptic sampling campaigns were undertaken across the 220 km2 catchment over the course of one year in august and october 2018 and in january april and july 2019 during each campaign samples were taken distributed along the course of the stream network from the catchment outlet to the upper catchment near the spring source fig 1 sampling included different sections and stream types i presumably groundwater fed tributaries unaffected by effluents tributaries 2 5 locations ii the main stream after the inflow of the tp werneuchen but upstream of tp münchehofe mixed 7 locations iii the stream downstream of the tp münchehofe effluent dominated 3 5 locations and iv the effluents of the tps themselves effluent 1 2 locations besides the isotope sampling water quality parameters were measured on site at each seasonal sampling location using a wtw multi 3630 ids set with probes for ph sentix940 accuracy 0 004 dissolved oxygen do fdo925 accuracy 1 5 for do precision 0 2 c for water temperature tw and electrical conductivity ec tetracon925 accuracy 0 5 groundwater sampling was undertaken in the urc 1 2 wells and duc 1 5 wells including the wells for which water level data were available in the days following the surface water campaigns fig 1 after measuring the initial water level with an electric contact gauge water was pumped from the wells using a comet geo duplos plus submersible pump and channeled through a bucket where the water quality parameters were monitored until stabilization before samples were taken all samples were filtered 0 2 μm cellulose acetate into 1 5 ml vials llg labware they were subsequently analysed by cavity ring down spectroscopy using a picarro l2130 i isotopic water analyzer analyzed values were linearly corrected with four lab standards and calibrated using standards of the international atomic energy agency iaea after quality checking the averaged results for each sample they were expressed in δ notation analytical precision was 0 04 standard deviation sd for δ18o and 0 14 for δ2h all data analyses and plotting used r studio version 1 2 1335 external climatic and hydrometric data were quality checked removing potentially faulty data points and omitting missing values for the urc processed stream discharge data were available from august 2018 to april 2019 for the remaining study period discharge was estimated from water level data of the same station through linear regression of the previous water level discharge relationship for the duc processed stream discharge data were available throughout the study period daily groundwater levels of individual wells were averaged and subsequently normalized by subtracting the average over the whole study period and dividing by sd to better illustrate the dynamics for the urc and duc respectively for a first assessment of effluent contributions to stream discharge a simple comparison between mean stream discharge qstream and mean treatment plant discharge qeffluent in the respective sampling months was carried out as a measure for potential fractionation effects on the isotope samples deuterium d excess was calculated as d exc δ2h 8 δ18o dansgaard 1964 daily p isotope data were used in an amount weighted least square regression hughes and crawford 2012 to calculate a local meteoric water line lmwl fractions of young water fyw were estimated through sine wave fitting of seasonal cycles von freyberg et al 2018 using weekly streamwater and p isotope data in the duc with the goodness of fit to data measured by the significance of the regression r2 additionally mean transit times mtt were estimated through lumped convolution method mcguire and mcdonnell 2006 using a one year spin up period estimations of shape α and scale β parameters were used in a gamma transfer function to maximize the kling gupta efficiency kge gupta et al 2009 as model performance metric and fitting the amount weighted weekly p isotope means to the weekly stream water isotopes to illustrate the potential but also limitations of an isotope based assessment of seasonal water sources in the catchment a principal component analysis pca and end member mixing analysis emma were carried out the pca was performed using the data of the 2019 sampling campaigns january april july which had the highest number of sampling points including the effluent of both tps and several groundwater wells the variables with the most robust measurements and highest inter group variability ec tw δ18o and d excess were selected to identify the major causes of variation between samples of different groups to estimate water contributions to the erpe fractions of effluent in the streamwater in the urc and duc during the 2019 sampling campaigns were assessed through emma using the mixsiar model stock and semmens 2016 stock et al 2018 in this bayesian model framework the probability distribution of proportional source contributions to streamflow was estimated while uncertainties in data and sources were included in the framework by defining means and variance parameters for each potential source and tracer moore and semmens 2008 we used uninformative priors indicating equal likelihood of all sources moore and semmens 2008 to generate independent draws using markov chain monte carlo mcmc with 100 000 iterations in the urc wastewater fractions in mixed water at three representative sites were estimated assuming contributions of the tp werneuchen effluent groundwater and selected tributaries in the duc wastewater fractions in effluent dominated samples were estimated assuming contributions of four mixed water samples and one tributary before the confluence and the effluent of the tp münchehofe the selection of sources end members was based on knowledge obtained through literature and water management authorities in the respective parts of the catchment and on our observations during the field campaigns two tracers ec and d excess were selected for emma contributions of groundwater were neglected in the duc assuming groundwater abstractions to have reversed the natural flow conditions cf verleger and schuhmacher 2012 direct contributions of incoming p were assumed to be low in both the urc and duc during periods when the synoptic sampling occurred because of little rainfall during sampling and the damped and delayed rainfall runoff response cf lugv 2011 and therefore were not included in the model 4 results 4 1 climatic hydrometric and isotope dynamics our study was carried out during exceptionally warm and dry climate conditions including part of the 2018 european drought in the berlin brandenburg area the years 2018 and 2019 were 1 5 c warmer than the long term 1981 2010 mean annual tair of 9 3 c and had a p deficit of 30 in 2018 and 10 in 2019 from the long term mean annual p of 577 mm dwd 2021 in the erpe catchment conditions were dry in the beginning of our study period with only 63 mm of p in autumn september november 2018 fig 3 this was followed by wetter periods with p totaling 126 and 109 mm respectively in winter december february 2018 2019 and spring march may 2019 in summer june august 2019 p 116 mm mainly occurred through heavy convective events in autumn and winter 2019 2020 p was higher than the previous year totaling 150 mm respectively in spring 2020 p was again lower than average with only 74 mm fig 3 the erpe showed an overall very stable flow regime however differences could be observed between urc and duc in the urc discharge was low with 0 05 m3 s in summer 2018 increasing to 0 1 m3 s over the winter 2018 2019 fig 3 in summer 2019 discharge was even lower with 0 04 m3 s discharge from the tp werneuchen in the urc was 0 02 m3 s with some daily but no seasonal variability fig 3 groundwater levels in the urc decreased over the summer and increased in winter hovever despite these temporary increases overall groundwater levels constantly declined from 2018 to 2020 with insufficient winter recharge to recover to previous levels fig 3 in the duc stream discharge was higher daily means increased from 0 5 m3 s in summer 2018 to 0 9 m3 s in winter 2018 2019 fig 3 fig 4 afterwards values decreased again to 0 4 m3 s in summer 2019 and only increased back to 0 7 m3 s in spring and 0 8 m3 s in summer 2020 discharge of the tp münchehofe was stable throughout the study period with little seasonal but some daily variability around daily means of 0 5 m3 s fig 3 fig 4 groundwater levels in the duc also constantly declined from summer 2018 until winter 2019 fig 3 with some daily variability likely reflecting the effects of daily pumping in wells south of the lower catchment cf verleger and schuhmacher 2012 towards early 2020 groundwater levels temporarily rose again but did not recover to summer 2018 levels fig 3 during dry low flow conditions in july august 2019 discharge of the tps in both the urc and duc exceeded stream discharge downstream of their inflow fig 3 in both the urc and duc modest increases in stream discharge occured after larger p events comparing qeffluent to qstream in the months of the seasonal sampling campaigns showed that from a hydrometric perspective contributions of effluent to streamflow were likely variable throughout the year as groundwater influxes change between winter and summer in the urc qeffluent was between 38 in august 2018 and 14 in january relative to qstream downstream of the confluence table 2 in the duc qeffluent exceeded qstream measured 3 km downstream of the confluence in august 2018 and july 2019 in the remaining months qeffluent was lower than qstream and gradually decreased in spring and autumn with lowest values in january 2019 when qeffluent was 47 of qstream table 2 daily p isotopes in the duc followed a seasonal pattern being more depleted in heavy isotopes in winter and more enriched in summer particularly during the heavy convective p events in 2019 fig 4 however inter event variability could be large regardless of season in comparison weekly stream water isotope patterns were much more damped exhibiting remarkable consistency with an overall variability of only 10 for δ2h and 2 for δ18o during the two year sampling period fig 4 no clear seasonal variability could be observed strongest variations occured in response to some larger p events when the stream s isotopic signal moved in the direction of recent p the low variability in weekly stream water isotopes even following storm events is consistent with a dominance of older well mixed water in the erpe fyw estimates from δ2h values were small accounting for only 7 of total flow table 3 similarly mtts were estimated at 2 3 years in both cases model performance metrics r2 and p value for fyw and kge for mtt indicate better fit for δ2h than for δ18o though both were low indicating substantial uncertainty of the results table 3 nevertheless it is clear from the analysis that influxes from precipitation and storm drains bringing new water had a very small impact on stream flow generation in the erpe during the study period despite about 21 of the catchment being urban 4 2 seasonal dynamics in isotopic composition and water quality parameters along the stream network the lwml in the duc during the study period was δ2h 8 05 0 13 δ18o 11 19 1 15 fig 5 although the overall isotopic variability across the catchment remained low the five spatially distributed surveys captured some seasonal variability fig 5 in august 2018 samples were more enriched and became gradually more depleted in october 2018 and january 2019 in april 2019 the samples again became more enriched samples taken in july 2019 were the most enriched during the study period exceeding the isotopic enrichment observed during the much drier summer of 2018 sampled groundwater was most depleted throughout the year with effluents intermediate between groundwater and weekly stream samples fig 5 spatial patterns throughout the catchment show subtle variations in the isotopic composition of the stream these revealed important process insights despite the inflow of the two tps fig 6 between the different sampled water types more enriched values were observed in effluent dominated samples from october 2018 to april 2019 and in mixed waters in august 2018 april and particularly july 2019 fig 6a fig 7 throughout the year groundwater and some tributaries were usually more depleted except for tributaries in july 2019 d excess on the other hand showed higher variability across the catchment and ranged from 3 to 10 fig 6b fig 7 in october 2018 january and april 2019 when discharge was higher and more frequent p occurred d excess was highest in groundwater and tributaries and lowest in the effluent and effluent dominated stream section during those times the more fractionated effluent increased d excess downstream of the confluence especially in the duc fig 6b fig 7 vice versa during the low flow period and high tair in july 2019 d excess was highest in groundwater and lowest in the tributaries and mixed waters of the urc the effluent itself also showed variability in its isotopic composition being more depleted with higher d excess in april 2019 fig 7 further variability between seasons and stream sections was evident in the measured water quality parameters ph was circumneutral between 7 2 and 8 1 throughout the year fig 8 within this range slightly lower values were measured in groundwater with the effluent moving towards similar lower values in january and april 2019 and slightly higher values in tributaries and mixed waters in the urc ec was high and ranged from 660 to 1520 μs cm lowest values were measured in the tributaries and groundwater and highest values in the effluents this led to a gradual increase in ec downstream in the mixed waters after the inflow of tp werneuchen and especially in the effluent dominated water after the inflow of tp münchehofe fig 6c fig 8 throughout the year this spatial trend dominated seasonal variations across the catchment tw showed expected seasonality with values 20 c in august 2018 and july 2019 and 6 c in january 2019 fig 6d fig 8 during all seasons effluents were slightly warmer than stream water and the tp münchehofe subsequently elevated tw in the effluent dominated samples downstream of the confluence relative tw differences in the duc were especially pronounced in october 2018 and january 2019 4 c groundwater tw was much more stable 10 16 c throughout the year fig 8 surface water do ranged from 40 to 100 and also showed seasonal variability which was as expected temperature dependent during the warm low flow conditions in august and october 2018 and july 2019 do was lower especially in tributaries and mixed waters in the urc fig 8 during these periods highest do was measured in the effluent fig 8 during higher flows and lower tair and tw in january and april 2019 do was higher occasionally reaching supersaturation groundwater do in most wells was low 10 throughout the year 4 3 contributions of groundwater and effluents to stream discharge under different flow conditions in the pca for the synoptic surveys the first two principal components pc explained 90 of the variability in january and july 2019 and 70 in april 2019 the main contributions to pc1 were d excess and δ18o along with ec january and t july main contributions to pc2 were tw january tw and ec april and ec july during the high flows in january 2019 and low flows in july 2019 the sampled water types could be clearly separated in the biplot fig 9 in january low tair was reflected in the low tw in mixed waters and tributaries which were similar to each other groundwater on the other hand was associated with higher tw effluent and effluent dominated stream samples formed a distinct cluster characterized by higher δ18o lower d excess and higher ec in the warm and dry july 2019 effluent and effluent impacted waters were correlated with high ec and groundwater was characterized by higher d excess and lower tw again mixed waters and tributaries were similar to each other while few samples showed a resemblance to groundwater and effluent most surface water samples plotted away from this contribution towards higher δ18o and lower d excess likely a result of evaporative fractionation in april when tair and stream discharge were intermediate fig 3 the distinction between the sampled waters was less clear again effluent and effluent impacted stream samples were correlated with higher ec and δ18o lower d excess and to some extent higher tw however tributaries were similar to groundwater and showed a correlation with higher d excess mixed samples showed an intermediate composition between tributaries groundwater and effluent in the emma for the sampling campaigns in 2019 the model estimated contributions of 49 groundwater fed tributaries 34 effluent of the tp werneuchen and 18 groundwater to streamflow during the higher flows in january and april in the urc table 4 during the drier conditions in july predicted contributions were 64 effluent 30 tributaries and 6 groundwater however sds were high indicating substantial uncertainty in the duc effluent contributions were estimated as 70 in both the cold high flow periods in january and the warm dry period in july this depicts a strong contrast to the discharge data fig 3 table 2 in april the model estimated effluent contributions of only 5 sds in the duc remained high and exceeded estimates of the contributions of mixed waters table 4 5 discussion 5 1 temporal dynamics in climate hydrometrics and isotopes our sampling period coincided with the drought of 2018 which negatively impacted water balances and ecosystems across central and northern europe buras et al 2020 however this provided a unique opportunity to observe the impacts of exceptionally warm and dry conditions in the erpe as an exemplar of a temperate peri urban lowland catchment impacted by effluent discharge despite differences in land use fig 2c and flow regimes in the urc and duc the substantial p deficits of 34 in 2018 and 21 in 2019 compared to 10 year means cf dwd 2020 decreased summertime stream discharge by 50 in both sub catchments compared to winter fig 3 and long term seasonal means cf senuvk 2020b this contrasts catchments elsewhere where the depletion of water storage following the 2018 drought was restored by the end of 2019 following a period of above average rainfall fennell et al 2020 however such periods of higher rainfall were not sufficient to refill storage in the berlin brandenburg area and despite increased p in winter 2018 2019 stream discharge and groundwater levels remained lower in summer 2019 than during the drier previous year fig 3 this indicates that not the year 2018 alone but rather the continuously warm and dry conditions over two consecutive years have had a strong impact on the water balance of the study catchment our observations are consistent with a similar study following the 2018 2019 drought in a rural catchment 50 km southeast of our study area kleine et al 2021 5 2 seasonal dynamics in isotopic composition and water quality along the stream network the lmwl for the study period fig 5 was similar to kuhlemann et al 2020 but deviates from that of stumpp et al 2014 for berlin and germany by a higher intercept temporal variability in streamwater isotopic signatures in the erpe especially after the heavy convective p events in the summer of 2019 fig 4 was low compared to other streams in the berlin brandenburg area kuhlemann et al 2020 such patterns are typical for well mixed stream waters of groundwater dominated catchments that often coincide with a permeable sub surface large storage and lack of rapid hydrological pathways scheliga et al 2017 smith et al 2020 however the impact of two wastewater treatment plants also contributed to this stability in the berlin brandenburg area wastewater effluents are usually recycled local abstractions from surface water bank filtrate and local groundwater resulting in depleted isotopic signature in the effluent that is similar to groundwater massmann et al 2007 which could be observed in our data however effluents in our study were usually more fractionated than local groundwater fig 5 fig 7 this possibly reflects the fractionation of lake water as well as the effect of domestic water uses for example it is noticeable that in the wettest synoptic sampling period in april the effluent was less fractionated consistent with the winter turnover of berlin s stream and lake waters and the loss of fractionation signals kuhlemann et al 2020 however further data on water supplies and wastewater would be needed to establish this the limited isotopic variability in the erpe was not only evident in the temporal dynamics at the catchment outlet but was also captured by the seasonal spatially distributed sampling campaigns still important new insights were gained based on the isotope analysis which have significance for the future in agreement with the observed depletion of groundwater storage more enriched streamwater isotopes and lower d excess in july 2019 across the catchment figs 5 7 reflected the higher impact of the second consecutive drought year this enrichment may especially be related to the impact of wetlands in the catchment as evaporative fractionation in times of high potential evapotranspiration pet and low stream discharge is quite common in headwaters draining through wetlands sprenger et al 2017 although being less pronounced in the erpe catchment the stronger enrichment in 2019 rather than 2018 is consistent with other local wetland impacted catchments in the berlin area kuhlemann et al 2020 this observation may be a first manifestation of the high vulnerability of wetlands and groundwater dependent ecosystems to climate warming that has long been predicted for the berlin brandenburg area lotze campen et al 2009 it is also indicative of potential long term decreases in natural groundwater contributions to summer baseflows as a result of reduced recharge for the measured water quality parameters downstream changes were more pronounced than temporal variability for example discharge of effluents introduced waters with higher ec fig 8 that increased ec values in downstream areas throughout the year fig 6 other diffuse nutrient inputs e g from agriculture gücker et al 2006 gücker and pusch 2006 or domestic gardening lugv 2011 may have amplified this increase still a clear impact on low flow conditions was observed as the expected increases in tw during times of high tair and subsequent increases in algae growth and oxygen depletion cf lotze campen et al 2009 were clearly visible in the seasonal variability of these parameters and the resulting deterioration of water quality during the warm and dry summers of 2018 and 2019 throughout the catchment fig 8 5 3 estimates of groundwater and effluent contributions to stream discharge under different flow conditions in the past most studies on isotope based source assessment have been carried out in experimental rural or forested catchments with marked spatial and temporal variations in the isotopic signatures of water sources and stream flow recent growth in urban isotope applications seeks to exploit similar characteristics of anthropogenically impacted areas ehleringer et al 2016 here isotope based studies helped to apportion time variant stream flow sources follstad shah et al 2019 jefferson et al 2015 meriano et al 2011 sánchez murillo et al 2020 estimated associated ages and travel time distributions morales and oswald 2020 parajulee et al 2018 soulsby et al 2014 and provided information on how flux dynamics are related to those of stored waters soulsby et al 2015 however the multitude of water and pollution sources in urbanized areas makes source assessments based on isotopes alone more challenging mccance et al 2018 however the erpe clearly has a limited influence of young water in terms of recent rainfall with fyw 10 and indicative mtt in the range 2 3 years table 2 despite 21 of the catchment being urbanized senstadtum 2013 although the fyw is slightly higher the mtts are similar to estimates in small catchments in rural areas of brandenburg kleine et al 2021 and to a 13 urbanized catchment in scotland soulsby et al 2014 the observed low young water contributions were probably exacerbated in the dry study period when precipitation was low and storm drains would be activated less frequently but such conditions will likely become more common in the future moreover in a catchment where soils are freely draining there is little overland flow to transmit rainfall signals rapidly into streams unless conditions are extremely wet smith et al 2020 despite these insights the dominant influence of isotopically stable groundwater and effluents result in uncertain age estimates as both sources are derived from older groundwater and or lake reservoirs with ages likely 4 years which is the limit for stable isotopes to discern ages mcguire and mcdonnell 2006 scheliga et al 2017 tetzlaff et al 2015 for streams in brandenburg recent tritium based tracer studies showed that that deeper groundwater is usually at least decadal due to low recharge massmann et al 2009 and very recent tracer aided modelling smith et al 2020 has shown that shallow groundwater may be similarly decadal in addition our weekly sampling resolution even if high for this spatial scale covered may under represent transient storm events especially summer convectional storms and associated increases in new water fractions in the stream such a sampling bias towards baseflow conditions is a problem encountered by others estimating mtts in flashy urbanized catchments morales and oswald 2020 considering the complexity that anthropogenic impacts and engineered components add to urbanized water cycles the demographics of water ages may need to be re conceptualised for urban settings where effluents could be viewed as being both young and old water cf sprenger et al 2019 the hydrometric assessment indicating higher effluent than stream discharge downstream of the confluence in the duc in both august 2018 and july 2019 table 2 is likely related to the losing nature of the stream cf verleger and schuhmacher 2012 however the results also demonstrate that a quantitative estimation of source contributions from hydrometric data alone may not be possible in anthropogenically altered catchments and underline the utility of tracer based assessment this is especially the case during times of drought and when discharge is not monitored directly at the engineered inflows but rather several kilometers downstream due to logistic reasons except for april when tair was similar to groundwater tw and evaporative fractionation in the stream and effluent was still limited the combination of four isotope and water quality tracers could successfully separate the sampled water types during the highest january and lowest july discharge conditions in the pca fig 9 for quantitative assessment of source contributions through the emma table 3 estimates in the urc although showing high sd values indicated lower contributions of groundwater and groundwater fed tributaries during the dry july 2019 than during higher flows in january and april while in natural environments it would be expected that groundwater contributions dominate during drier periods in absence of new water from incoming p fennell et al 2020 the constant effluent inflow in the erpe may have reduced the relative importance of natural groundwater sources and increased effluent proportions in downstream river sections in the duc high effluent contributions in both january and july show the dominance of effluent regardless of any groundwater exchange that may occur the low estimate in april is implausible likely reflecting the unfractionated nature of the effluent at that time fig 7 fig 9 such overlaps in isotope based mixing analysis have also been reported in previous studies on effluent impacted stream systems e g follstad shah et al 2019 and may be be a problem in many other urbanized catchments with internal re cycling of water 5 4 wider implications challenges and future research regarding the use of isotopes in catchments with urban impacted streams our study indicated that d excess may be the more suitable than δ18o or δ2h alone for assessing spatio temporal variations where effluent waters have a fractionation signal or some stream sections may be subject to evaporation at low flows combining the isotope data with water quality measurements particularly ec and tw facilitated a sufficient qualitative separation of water sources during the periods of highest and lowest flows to distinguish major changes in water sources this underlines the value of integrating stable isotopes with water quality parameters for insights into water and pollution sources and transformation processes in anthropogenically impacted catchments e g kuhlemann et al 2020 torres martínez et al 2020 despite the valuable insights into the functioning of a lowland peri urban effluent impacted catchment we encountered several challenges to realizing the potential of isotope based approaches cf ehleringer et al 2016 in urban impacted landscapes this is especially the case where internal re cycling of isotopically similar local water resources restricts isotopic variability this resulted in problems in estimating water ages as well as quantitative based hydrometric assessment of source contributions to streamflow although our approach conducting five synoptic surveys covered contrasting seasons the drought conditions dictated that temporal variability in hydrology was suppressed obviously higher resolution sampling especially with event sampling e g von freyberg et al 2017 over longer time periods will likely reveal more complex dynamics than observed in our study in addition many urban isotope studies will require a greater focus on the composition of effluent waters and their changing dynamics which can be significant as our april samples show even sub daily sampling may need to be considered to cover diurnal variations in the tp discharge cf ledford and toran 2019 lewandowski et al 2011 although we considered only a limited range of water quality parameters the general deterioration along the stream network with increasing effluent influence in downstream areas was evident throughout the year however as climate change projections for berlin indicate less rainfall and higher temperatures gerstengarbe et al 2003 lotze campen et al 2009 the importance of effluents as a component of stream flow will likely increase in the future more research will be needed to identify adequate dilution rates needed under low flow conditions in a changing climate gücker et al 2006 yang et al 2019 in addition integrating wastewater indicators from treatment plants into tracer studies e g boron fox et al 2002 or anthropogenic gadolinium massmann et al 2007 möller et al 2002 will provide additional information on water quality impacts during low flow periods particularly the combination of emerging contaminants like pharmaceuticals personal care products artificial sweeteners or pesticides with stable isotope and major ion data has recently been highlighted as a very promising approach to overcome limitations of isotope based assessment of water and contaminant sources in complex urban and peri urban areas mccance et al 2018 including these compounds in future research can therefore improve source distinction in methods such as emma as well as better constraining age estimates there is also a general need for more complex and sophisticated modelling approaches that fully account for the heterogeneity in land use distributions especially in peri urban areas and the complex interactions between natural and engineered compartments of the water cycle in urbanized areas fletcher et al 2013 mcgrane 2016 6 conclusions in this study we used isotope tracers and water quality measurements to complement hydrometric and climatic data to assess how the increasingly warm and dry conditions of 2018 2020 affected water cycling in the lowland peri urban erpe catchment in germany that is impacted by treated wastewater effluents in particular we assessed the seasonal patterns of water flow paths and sources at different spatio temporal scales the work provided new insights into how such lowland peri urban catchments with complex land use distributions and substantial effluent influences function hydrologically we gained new understanding how such systems store release and mix water especially under the unprecedented warm and dry conditions of 2018 2020 memory effects of the 2018 drought were evident in lower discharge rates more fractionated isotope signatures and declining groundwater levels in the second consecutive dry year it is clear from hydrometric data and the pca the discharge of effluents maintained rather stable flow conditions during the dry summers especially in the lower catchment our results indicate that streamflow was dominated by inputs of groundwater and groundwater fed tributaries in the upper rural catchment and experienced a downstream deterioration of water quality as effluent contributions gained importance in the more urbanized part of the catchment duc seasonal variability was low but the effects of two consecutive summers with below average precipitation and above average temperatures were reflected in a decrease in streamflow declining groundwater levels and widespread isotopic enrichment indicating higher effluent influences and evaporative losses in streamwater despite these insights lack of variability in the isotopic signatures of effluent and local groundwater resulted in uncertain estimates of water ages and sources contributing to streamflow for more detailed insights into seasonal water sources of anthropogenically altered catchments future research would benefit from longer term higher resolution monitoring and additional tracers e g wastewater indicators such studies will be crucial for ensuring maintenance of sufficient dilution rates for effluent impacted streams and sustainably managing urban water resources during future climate warming and increasing urbanization credit authorship contribution statement lena marie kuhlemann conceptualization formal analysis investigation methodology visualization writing original draft doerthe tetzlaff conceptualization data curation formal analysis funding acquisition methodology supervision writing original draft chris soulsby conceptualization data curation formal analysis methodology supervision writing original draft declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this study was funded as part of the research training group urban water interfaces uwi grk 2032 by the german research foundation dfg and supported by the einstein foundation through the project modelling surface and groundwater with isotopes in urban catchments mosaic contributions from c s were funded by the leverhulme trust s isoland project we thank n weiß d dubbert e brakkee a wieland and a dahlmann for help with the sampling d dubbert for running the isotope analysis and a smith for help with the data analysis we also thank the bwb berlin senate lfu brandenburg and stadtwerke werneuchen for their assistance in sampling and data provision 
4433,wind tunnel wt experiments were conducted to reproduce the wind induced deviation of rain drop trajectories when approaching the collector of catching type gauges three typical outer shapes of the instrument body cylindrical inverted conical and chimney shapes were tested using full scale models the airflow pattern upstream of and above the collector was measured with a particle image velocimetry technique after injecting a passive tracer in the flow tests were performed by releasing water drops in the wt flow to mimic the raindrops fall the drop trajectories near the gauge collector were tracked and quantitatively measured using a high speed camera the deviation of the trajectories induced by the bluff body aerodynamics of the gauge is interpreted here by comparing the measured airflow pattern around the three instruments to highlight the effect of their different outer shapes the chimney shape that is typical of some weighing type gauges demonstrated lower performance with respect to the cylindrical and inverted conical shape showing the most relevant effect in deviating the trajectories of the approaching drops when immersed in a wind field keywords rainfall rain gauges wind measurement bias wind tunnel piv wind induced bias 1 introduction aiming at the measurement of essential environmental variables atmospheric precipitation is one of the most challenging and accurate measurements are not easily obtained see cauteruccio et al 2021a for a review of in situ precipitation measurement issues both instrumental and environmental sources of bias and uncertainty are inherent of the precipitation measurement process when precipitation occurs in windy conditions a systematic bias in measurements often termed the wind induced undercatch is to be expected for all catching type instruments jevons 1861 was among the first to identify the so called exposure problem which produces underestimation of precipitation measurements due to the vertical velocity component and acceleration that arise in front of and above the gauge collector when the gauge is exposed to the wind since then the problem of the wind induced bias on precipitation measurements was addressed in the literature following different approaches field tests see e g pollock et al 2018 wolff et al 2015 numerical simulations using computational fluid dynamics cfd see e g nešpor and sevruk 1999 colli et al 2015 colli et al 2018 and wind tunnel wt experiments see e g green and helliwell 1972 robinson and rodda 1969 among the influencing factors including e g the particle size distribution precipitation intensity the shape density and fall velocity of hydrometeors etc the outer shape of the gauge was shown to have a prevailing role by acting as a bluff body obstacle to the incoming wind for this reason wind tunnel testing of the aerodynamics of precipitation gauges has been a suitable investigation tool in precipitation measurement studies since the early work of bastamoff and witkiewitch 1926 most studies mainly concentrated on identifying design solutions such as rain gauges shape optimization strangeways 2004 or windshields alter 1937 to minimize the airflow acceleration and updraft and therefore the impact of the gauge body on the surrounding wind field for example sanuki et al 1952 tested two types of windshields for rain gauges conical and hollow ring shaped designs both in a water tank and in the wt the test was conducted at free stream velocity ranging from 1 5 to 20 m s and the flow patterns were photographed after spreading aluminum powder over the water surface of the tank and using wool strings tied to the model in the wt air speed measurements in the wt were taken above the funnel mouth at a height equal to 0 5 times the diameter of the gauge orifice in these experiments the minimum generation of eddies in all parts of the flow field was sought for the assessment of the windshield design robinson and rodda 1969 examined the airflow pattern around four types of rain gauges in a series of wt experiments using tuft indicators smoke trajectories and hot wire anemometer measurements for quantitative assessment of the wind velocity over the gauges two cylindrical gauges one gauge characterized by a bluff shape and one with champagne glass shape were studied all gauges exhibited similar aerodynamic behavior characterized by a separation zone starting from the leading edge and curving over the collector the wind speed reaches a maximum above the separation zone while below it the flow velocity drops and a turbulent zone develops observations identified the wind speed at which a clear lift of the smoke at the top of the gauges is evident the height of the lift of the smoke trajectory above the gauge appeared to increase with increasing diameter of the gauge and with increasing sharpness of the leading edge of the collector for equal wind speed the authors concluded that the two cylindrical gauges appeared to produce the least satisfactory airflow patterns the more complex bluff shape and the champagne glass shape caused less distortion of the wind field in the most recent works of cauteruccio et al 2020 2021b and nešpor and sevruk 1999 wt measurements of the flow velocity were obtained by employing multi hole pressure probes located in selected positions above the investigated gauge geometries at different wind speeds with the objective to validate numerical cfd simulations the wind induced undercatch derives from the impact of the airflow deformation on the trajectories of water drops when approaching the collector once the microphysical characteristics of precipitation particle size distribution precipitation intensity and the deviation of each hydrometeor trajectory from the undisturbed one are known suitable models can be used to derive adjustment curves for operational use see e g cauteruccio and lanza 2020 to provide evidence of this phenomenon more complex wt tests that combines wind speed and the presence of hydrometeors were carried out in the past warnik 1953 injected real dry and low density and sawdust snow into the wt to visualize the airflow pattern and to study the quantitative catch of the model gauges wind speed from 5 to 10 m s were tested for the first time the trajectories of precipitating solid particles under windy conditions and their deviations when approaching the gauge were visualized although not precisely measured just the overall undercatch was quantitatively obtained with the main objective to justify the inconsistencies observed in records of snow catch in the field results were also used to design the geometry of two windshields green and helliwell 1972 measured both airflow velocity profiles and water drop trajectories above a cylindrical rain gauge the flow field was measured using hotwire anemometers positioned on a grid while the trajectories of injected drops were tracked using photographs from a still reflex camera trajectories of water drops with diameters of 1 2 2 2 and 3 5 mm were recorded with low details an apparent catchment area defined by the positions reached by two deflected drop trajectories which in undisturbed conditions would aim to the upwind and downwind edges of the collector was used to calculate the gauge catch this assumption implies that the most deflected trajectory aims in undisturbed conditions to the leeward edge of the collector which is neither known a priori nor necessarily true besides the observed wind induced bias of catching type precipitation gauges in the field and the available technical solutions used to limit its impact on the measurement accuracy there is a need for quantitative experimental evidence obtained in fully controlled conditions laboratory or wt tests of the physical processes acting behind the exposure problem and their respective role this work presents for the first time to the authors knowledge two joint quantitative pieces of evidence of the wind induced bias of catching type gauges in controlled wt conditions the first is a detailed assessment of the airflow configuration upstream of and above the gauge collector and the second is the resulting deviation of drop trajectories when approaching the gauge both obtained by video tracking techniques interpretation of the drop behavior was therefore possible based on the measured airflow pattern and the impact of different outer shapes of commercially available precipitation gauges on the catch efficiency is compared in the following 2 methodology experiments were carried out in the large scale wt facility available at the politecnico di milano hereafter gvpm within the activities of the italian national project prin 20154wx5na reconciling precipitation with runoff the role of understated measurement biases in the modelling of hydrological processes three typical outer shapes of commercial rain gauges were investigated to assess their aerodynamic characteristic and the resulting effect on the trajectories of the approaching hydrometeors namely the cylindrical the chimney and the inverted conical shapes most tipping bucket rain gauges available on the market have indeed a cylindrical geometry the most common weighing gauges have a typical chimney shape due to the large amount of rainwater stored to avoid the need of frequently emptying the gauge while the so called aerodynamic gauges have an innovative inverted conical shape although they too are based on the tipping bucket mechanism the commercial models adopted in this research were therefore the lambrecht rain e h3 although this instrument is actually a hybrid tipping bucket and weighing gauge the geonor t200b and the eml sbs500 assumed as representative specimens for the cylindrical chimney and inverted conical shape respectively the experiments consisted of two steps first a particle image velocimetry piv technique was used to measure the airflow pattern upstream of and above the gauge collector then drops were released in the wt to mimic raindrops falling in a windy environment the drop trajectories near the gauge collector were tracked and quantitatively measured using a high speed camera the piv technique provided the flow velocity pattern on a 2 d x z section of the flow field where x is the stream wise direction and z the vertical coordinate centered on the longitudinal symmetry axis of the collector a castor oil smoke was injected in the wt and used as a passive tracer while the measurement section was illuminated with a light sheet produced by a pulsed laser emitter output energy 200 mj using a cylindrical optics with an aperture of 50 the upper part of the gauges was painted in black to avoid the reflection of light and suitable masking of the captured images was adopted to post process the piv acquisitions pictures were taken using a double shutter camera with a 50 mm optics equipped with a 2 mpx 1953 1112 px ccd sensor positioned at about 2 m from the measurement section the latter had dimensions 435 250 mm with a magnification factor of 4 34 px mm the frame rate of the acquisition was 100 microseconds and two hundred pairs of images were captured to guarantee sufficient statistical significance of the post process analysis images were processed with the pivview 2c software produced by pivtec gmbh in collaboration with the german aerospace center dlr the processing algorithm was set to single correlation analysis on partially 50 overlapping windows of 64 64 pixels therefore obtaining a resolution of about 7 mm per each measurement position the accuracy can be evaluated based on a positioning uncertainty of 0 1 pixels corresponding under the conditions of this test to an uncertainty on the velocity equal to 0 2 m s the outputs of the single acquisitions were averaged over the total number of images to obtain an average flow field under steady flow conditions for each precipitation gauge tests were conducted at wind speeds equal to 5 and 10 m s 1 and the flow velocity fields were discretized into a regular grid with cell size of 7 5 7 5 mm a dedicated experimental setup was designed and realized in the gvpm to measure the deviation of drop trajectories when they are approaching and travelling above the gauge collector water drops were released in the wt flow upstream the gauge and their trajectories were captured with a high speed camera in the vertical 2 d plane centered on the longitudinal symmetry axis of the gauge collector the experimental setup is described in detail in cauteruccio 2020 and cauteruccio et al 2021b the recording speed was set to 1000 fps with an image resolution of 1600 900 pixels the captured footages were about 40 20 cm wide with a pixel size between 0 19 and 0 24 mm depending on the single test the videos recorded by the camera were analyzed in the matlab environment where the path of each drop was identified to improve the visibility of the drops each image was converted to greyscale and gaussian and laplacian filters were applied the image was binarized so as to report the background with zeroes and the position of the drop with ones finally a moving window was used over the image to identify and record the center of the drop from the time interval between two subsequent images and the dimension of each pixels the drop speed was calculated 3 results and discussion results about the airflow velocity fields are shown in the form of color coded maps of the normalized vertical velocity component and plots of the normalized positions of the maximum velocity values obtained from the piv the maps confirm previous literature works colli et al 2016 colli et al 2018 about the scalability low reynolds dependency of the airflow fields except for the chimney shaped gauge for undisturbed wind velocity uref between 5 and 10 m s 1 as detailed below in addition local velocity flow measurements previously obtained at the university of genova and used to validate cfd airflow simulation results cauteruccio et al 2021b show that the normalized velocity components are fairly scalable especially in the range between 10 and 20 m s 1 an example of the low reynolds dependency of the profiles of the normalized vertical flow velocity uz uref along the central stream wise symmetry plane above the gauge collector is reported in fig 1 for the three outer geometries investigated in this work the scalability of the flow field allows us to apply the piv results to a wider range of wind velocities both lower and higher than the experimental range drop trajectories observed at wind speed from 9 to 13 m s 1 are shown and commented according to the piv velocity fields measured at 10 m s 1 together with the derived slope curves in the graphs below the drop trajectories are depicted in the dimensionless plane x d and z d where d is the gauge collector diameter equal to 0 16 m for the lambrecht rain e h3 and the geonort200b gauges and equal to 0 25 m for the eml sbs500 gauge and the gauge collector is centered in 0 0 for each gauge the longitudinal coordinate x d of the drop releasing position was fixed while the elevation z d was set according to the wind speed 3 1 airflow velocity fields the color coded maps of the normalized vertical velocity component uz uref presented in fig 2 show that for the chimney shaped and the cylindrical gauges upward velocity components are present along the entire collector while for the inverted conical gauge downward velocity components prevail in the region above the second half part of the collector it is evident from the graphs that the maximum updraft a bit larger than 0 7 is associated with the geonor t200b gauge due to the chimney shape of the gauge body while the cylindrical gauge the lambrecht rain e h3 has the least pronounced updraft value the eml sbs500 gauge exhibits the maximum downdraft anticipating the influence that these vertical components would have on the trajectories of approaching hydrometeors it must be considered that the balance between the updraft and downdraft above the gauge collector is the relevant takeover information useful to compare different gauge shapes indeed the hydrometeor trajectories will be deflected upward depending on their shape and vertical velocity when the vertical velocity is positive updraft while they will tend to recover their original undisturbed trajectory when the vertical velocity is negative downdraft from the airflow velocity maps it can be noted that the chimney shaped gauge is the one producing the most unbalanced vertical forces with a predominant upward component and a low downward component while consistently with the work of cauteruccio et al 2020 for the inverted conical gauge in uniform free stream conditions the updraft in the upwind part of the collector and the downdraft in the downwind part are comparable in magnitude the behavior of the cylindrical gauge is intermediate fig 3 reports the normalized positions of the maximum velocity values obtained from piv measurements at uref 5 m s 1 for the three geometries investigated this result reveals that these positions are higher and more dispersed for the chimney shaped geonor t200b gauge while they are lower and more bounded for the inverted conical shape the behavior of the cylindrical gauge is intermediate in fig 4 a c the normalized positions of the maximum velocity values for each gauge geometry at uref 5 triangles and 10 circles m s 1 are compared and color coded based on the normalized magnitude of the airflow velocity umag uref the magnitude of flow velocity is larger for the gauge with inverted conical shape and lower for the other two geometries moreover for the chimney shaped gauge the non dimensional maximum velocity patterns show a reynolds number dependency their normalized positions do not overlap upon varying the flow velocity both in terms of normalized velocity magnitude and positions 3 2 observed drop trajectories the wt experimental campaign resulted in capturing 106 trajectories of drops released between z d 0 18 and z d 0 70 above the lambrecht rain e h3 at uref 8 9 to 13 1 m s 1 82 trajectories of drops released between z d 0 05 and z d 0 70 above the geonort200b at uref 8 86 to 13 6 m s 1 and 50 trajectories of drops released between z d 0 15 and z d 0 60 above the eml sbs500 gauge at uref 9 35 to 12 6 m s 1 for each gauge geometry and wind speed drops of different size were generated and the obtained drop diameter ranges between 0 9 and 1 2 mm these values were derived from images captured by the video camera during dedicated tests conducted in still air in this section sample observed drop trajectories are selected and illustrated to discuss their relevant features together with the associated slope curves in the following the prefix ch identifies the geonort200b chimney shaped gauge while cy and ic indicate the cylindrical and inverted conical shape of the lambrecht rain e h3 and eml sbs500 gauges respectively repeatability was checked for trajectories and their deviation having the closest initial positions and for all gauges in fig 5 the root mean square deviation rmsd of pairs of trajectories is reported as a function of the vertical distance between their initial positions only those with very close initial positions are shown trajectories observed for all three gauges are included and differentiated using different markers it is shown that the rmsd is always lower with very few exceptions than the maximum estimated size of the drop in the observed trajectories 1 2 mm highlighted by the dashed horizontal line the markers also show a clear trend towards smaller rmsd while decreasing the distance of the initial position of each pair of trajectories which strongly confirms their repeatability this is an important feature of our experiment since not only it implies that the experimental setup was correctly implemented but also confirms that the deviation induced by wind on the drop trajectory is systematic beside some measurement uncertainties due to the inherent limitations of the video tracking system an example of one observed drop trajectory above the collector of the chimney shaped gauge at uref 12 8 m s 1 is indicated with markers in the top panel of fig 6 the first part of the observed trajectory depicted with triangles is not affected by the aerodynamic response of the gauge and can be linearly extrapolated solid line in the graph to obtain the undisturbed trajectory dashed line in the graph extended to the maximum longitudinal coordinate of the observed trajectory wherever z d 0 the disturbed part of the trajectory depicted with circles was fitted with a third order polynomial dotted line in the graph the slope curve dz dx see the solid line in the bottom panel of fig 6 was obtained as the first derivative of the fitted trajectory and compared in the same plot with the slope curve of the undisturbed trajectory horizontal dashed line when the drop approaches the collector of the gauge it enters the region of the flow field with significant vertical velocity components and its trajectory deviates from the undisturbed one moreover from the comparison between observed and undisturbed trajectories it is evident that the undisturbed trajectory would enter the collector while the observed one overtakes the collector and travels beyond the gauge therefore highlighting the phenomenon of the wind induced undercatch in the following figures some further examples of observed drop trajectories are reported and organized in pairs for each investigated gauge in order to interrelate the drop position with the airflow deformation induced by the gauge body the normalized positions of the maximum velocity values measured by the piv technique are depicted with light blue lines fig 7 reports a pair of observed trajectories for two drops named ch3 and ch6 having the same size as demonstrated by the undisturbed slope and released approximatively at the same initial position above the geonor t200b gauge at uref 10 2 m s 1 similar trajectories and the associated slope curves are reported in fig 8 for two drops cy97 and cy98 having approximatively the same size and travelling above the collector of the gauge with cylindrical shape at uref 13 1 m s 1 in both figures the drops released at a higher elevation start later to deviate from the undisturbed trajectory and are less sensitive to the recirculating zone in the second half part of the collector drops of different size therefore with different undisturbed slope were also observed at the same wind velocity and their trajectories are shown for instance in fig 9 for the inverted conical gauge at uref 11 6 m s 1 as demonstrated by the slope curves continuous lines the drop depicted in red ic84 is larger than the green one ic81 note that for all gauges the deviation of the actual trajectories from the undisturbed ones becomes visually evident when they cross the pattern of the maximum velocity values light blue line 3 3 comparison between piv and observed drop trajectories wind induced deviations of the trajectories vary with the shape of the gauge and are consistent with the analysis of the velocity field of the recirculation zone in the various cases in this section we show and compare three drops named ch11 cy31 and ic83 which in undisturbed conditions should hit the downwind part of the gauge collector but are deviated by the aerodynamic interference of the gauge their disturbed trajectories are commented in relation with the measured piv velocity field the compared drop trajectories were chosen by minimizing the relative difference between the respective starting positions z d at the same free stream airflow velocity uref these data are listed in table 1 the parameters of the best fit curves describing the trajectories of the drops and the associated correlation factors r2 are listed in table 2 figs 10 and 11 report the observed drop trajectories ch11 and cy31 which travel above the collector of the chimney shaped and cylindrical gauges respectively in fig 12 their slopes are compared with the undisturbed ones in both cases when the drop trajectories approach the gauge collector at x d 0 5 they visually deviate from the undisturbed trajectory and their slope decreases moreover the two drops fall outside instead of inside of the collector therefore highlighting the very nature of the wind induced undercatch affecting precipitation measurements the collectors of the chimney shaped and cylindrical gauges have the same size while the collector of the inverted conical gauge is larger therefore the features of trajectories ch11 and cy31 are better comparable the injection system was maintained at a fixed distance from the center of the gauge collector therefore drops were released closer to the gauge with inverted conical shape than for the other two gauges in fig 13 a sample drop trajectory travelling above the inverted conical gauge is depicted together with the associated slope curve the effect of the comparability between the airflow updraft and downdraft for this geometry as discussed above can be observed here by noting that the deviation of the drop trajectory is almost totally bounded within the region delimited by the projection of the collector edges x d 0 5 fig 13 bottom panel consistently with the piv velocity field the slope of the trajectory in the downwind part of the collector increases faster for the cylindrical gauge than for the chimney shaped gauge see fig 12 moreover the wind speed for the trajectory that travels above the collector of the chimney shaped gauge uref 11 4 m s 1 is lower than for the trajectory captured above the cylindrical gauge uref 12 1 m s 1 and the undisturbed slopes suggest that the size of the drop observed above the chimney shaped gauge is larger than the one that travels above the cylindrical gauge these results suggest that the aerodynamic behaviour of the chimney shaped gauge could be the most negatively impactful on the collection performance of the gauge yielding a larger undercatch the normalized deviation dev d of each observed drop trajectory from the undisturbed one is quantitatively measured by calculating the distance from the geometrical position of the drop at each time step to the straight line representing the undisturbed trajectory extrapolated from the initial observed positions of the drop this yields a curve as a function of the longitudinal coordinate departing from zero when the drop starts deviating from the undisturbed trajectory due to the airflow updraft and acceleration and reaching a maximum distance beyond which the drop starts approaching again the original path since the slope of its trajectory increases due to the airflow downdraft and deceleration due to the experimental variability of the obtained drop size and releasing position few trajectories can be found that allow consistent comparison of the three outer shapes investigated in this work i e drops that with the same size and at the same wind speed are released precisely in the same normalized position relative to the upwind edge of the gauge collector one example is provided in fig 14 where the comparison of similar drop trajectories for the three outer shapes investigated is shown in terms of their deviations dev d markers indicate deviations calculated from the measured drop positions while solid lines are calculated from the interpolated polynomial trajectories the graph shows that the deviations are significantly different in the three cases with the chimney shaped gauge having the most relevant deviation throughout the whole trajectory the cylindrical gauge being intermediate and the inverted conical gauge having the least deviated pattern as reported in table 3 the normalised deviations at the downwind edge of the collector x d 0 5 also follow the same order and the longitudinal coordinate at which the drop starts deviating from the undisturbed trajectory increases when moving from the ch to the cy and ic gauge shapes according to the more extended influence of the gauge aerodynamic behaviour this is fully consistent with the previous observations and the airflow velocity patterns revealed by the piv and confirms that the chimney shaped gauge has the worst performance when compared with the cylindrical and inverted conical shapes 4 conclusions the obtained quantitative experimental evidence of the deviation of drop trajectories when approaching the collector of catching type gauges in controlled wt conditions provides insights into the physical processes acting behind the exposure problem and their respective role in affecting the trajectories of hydrometeors having various size and fall velocity this will support the development of both correction algorithms for the wind induced bias of precipitation measurements and optimal gauge windshield geometries for operational use using video tracking techniques contemporary quantitative evidence of the wind induced bias of catching type gauges was indeed provided in this work by means of a detailed assessment of both the airflow pattern upstream and above of the gauge collector and the resulting deviation of the injected drop trajectories when approaching the gauge interpretation of the drop behavior was therefore possible based on the measured airflow pattern and the impact of different outer shapes of commercially available precipitation gauges on the catch efficiency was compared the data collected are also a reliable data set for validation of numerical cfd models of the flow field and the particle trajectories cauteruccio et al 2021b allowing a theoretically based derivation of correction curves and the analysis of the most influencing factors and controlling variables this was hardly possible hitherto based on the experimental evidence obtained from field test sites alone where the many external factors contemporarily acting on the gauge catch usually mask the underlying physical process with a high level of noise to reduce the spreading of experimental data around the expected theoretical behavior better identification of the controlling variables is needed and their effect individually quantified which is only possible in fully controlled experiments using the obtained dataset here provided as supplementary material as a benchmark to validate numerical models is also an added value of the present work indeed the availability of a large size wt facility with a water drop releasing device and a particle tracking system is not usual but it represents an interesting special research infrastructure specifically developed in the framework of the italian national project prin 20154wx5na the present research is part of a wider activity aiming at quantifying the undercatch effect induced by the wind on gauges and to define their collection efficiency the proposed methodology consists in using the experimental wt results to set up and validate numerical cfd simulations under laboratory controlled conditions while investigating more realistic environmental conditions through cfd simulations in order to consider the characteristics of rainfall drop size distribution shape etc and wind in the atmospheric boundary layer velocity turbulence intensity length scale etc the proposed experimental numerical methodology would be useful for the instrument design and calibration allowing for a gauge shape optimization or the adoption of mitigation solution by looking not only at the aerodynamic performance but also at the measuring performance the tests performed in controlled wt experiments allowed to compare instruments with three different outer shapes of the gauge body under the same wind forcing and drop releasing conditions representative specimens for the cylindrical chimney and inverted conical shape were tested confirming the good performance of the aerodynamic solution the chimney shape that is typical of some weighing type gauges demonstrated lower performance with respect to the cylindrical and inverted conical shape showing the most relevant effect in deviating the trajectories of the approaching water drops when immersed in a wind field further developments of this work could be focused on examining additional aerodynamic features of the gauge body such as the sharpness of the collector s rim and the relative dimensions of the various parts of the outer geometry of the gauge also the experimental setup could be improved by developing an injection system able to release drops with an initial velocity component close to their terminal velocity however we believe that numerical simulation properly calibrated using the observations presented in this work would be the most promising approach to address such and similar issues credit authorship contribution statement arianna cauteruccio conceptualization methodology software validation investigation writing original draft writing review editing elia brambilla methodology software investigation writing review editing mattia stagnaro conceptualization methodology investigation writing review editing luca g lanza conceptualization methodology investigation writing review editing supervision project administration daniele rocchi conceptualization methodology investigation writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was developed in the framework of the italian national project prin20154wx5na reconciling precipitation with runoff the role of understated measurement biases in the modelling of hydrological processes and as partial fulfilment of the phd thesis of the first author appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2021 126690 and also at http www precipitation biases it drop trajectories jhydrol2021 php appendix a supplementary data the following are the supplementary data to this article supplementary data 1 supplementary data 2 supplementary data 3 supplementary data 4 supplementary data 5 supplementary data 6 supplementary data 7 supplementary data 8 supplementary data 9 supplementary data 10 supplementary data 11 supplementary data 12 supplementary data 13 supplementary data 14 supplementary data 15 supplementary data 16 
4433,wind tunnel wt experiments were conducted to reproduce the wind induced deviation of rain drop trajectories when approaching the collector of catching type gauges three typical outer shapes of the instrument body cylindrical inverted conical and chimney shapes were tested using full scale models the airflow pattern upstream of and above the collector was measured with a particle image velocimetry technique after injecting a passive tracer in the flow tests were performed by releasing water drops in the wt flow to mimic the raindrops fall the drop trajectories near the gauge collector were tracked and quantitatively measured using a high speed camera the deviation of the trajectories induced by the bluff body aerodynamics of the gauge is interpreted here by comparing the measured airflow pattern around the three instruments to highlight the effect of their different outer shapes the chimney shape that is typical of some weighing type gauges demonstrated lower performance with respect to the cylindrical and inverted conical shape showing the most relevant effect in deviating the trajectories of the approaching drops when immersed in a wind field keywords rainfall rain gauges wind measurement bias wind tunnel piv wind induced bias 1 introduction aiming at the measurement of essential environmental variables atmospheric precipitation is one of the most challenging and accurate measurements are not easily obtained see cauteruccio et al 2021a for a review of in situ precipitation measurement issues both instrumental and environmental sources of bias and uncertainty are inherent of the precipitation measurement process when precipitation occurs in windy conditions a systematic bias in measurements often termed the wind induced undercatch is to be expected for all catching type instruments jevons 1861 was among the first to identify the so called exposure problem which produces underestimation of precipitation measurements due to the vertical velocity component and acceleration that arise in front of and above the gauge collector when the gauge is exposed to the wind since then the problem of the wind induced bias on precipitation measurements was addressed in the literature following different approaches field tests see e g pollock et al 2018 wolff et al 2015 numerical simulations using computational fluid dynamics cfd see e g nešpor and sevruk 1999 colli et al 2015 colli et al 2018 and wind tunnel wt experiments see e g green and helliwell 1972 robinson and rodda 1969 among the influencing factors including e g the particle size distribution precipitation intensity the shape density and fall velocity of hydrometeors etc the outer shape of the gauge was shown to have a prevailing role by acting as a bluff body obstacle to the incoming wind for this reason wind tunnel testing of the aerodynamics of precipitation gauges has been a suitable investigation tool in precipitation measurement studies since the early work of bastamoff and witkiewitch 1926 most studies mainly concentrated on identifying design solutions such as rain gauges shape optimization strangeways 2004 or windshields alter 1937 to minimize the airflow acceleration and updraft and therefore the impact of the gauge body on the surrounding wind field for example sanuki et al 1952 tested two types of windshields for rain gauges conical and hollow ring shaped designs both in a water tank and in the wt the test was conducted at free stream velocity ranging from 1 5 to 20 m s and the flow patterns were photographed after spreading aluminum powder over the water surface of the tank and using wool strings tied to the model in the wt air speed measurements in the wt were taken above the funnel mouth at a height equal to 0 5 times the diameter of the gauge orifice in these experiments the minimum generation of eddies in all parts of the flow field was sought for the assessment of the windshield design robinson and rodda 1969 examined the airflow pattern around four types of rain gauges in a series of wt experiments using tuft indicators smoke trajectories and hot wire anemometer measurements for quantitative assessment of the wind velocity over the gauges two cylindrical gauges one gauge characterized by a bluff shape and one with champagne glass shape were studied all gauges exhibited similar aerodynamic behavior characterized by a separation zone starting from the leading edge and curving over the collector the wind speed reaches a maximum above the separation zone while below it the flow velocity drops and a turbulent zone develops observations identified the wind speed at which a clear lift of the smoke at the top of the gauges is evident the height of the lift of the smoke trajectory above the gauge appeared to increase with increasing diameter of the gauge and with increasing sharpness of the leading edge of the collector for equal wind speed the authors concluded that the two cylindrical gauges appeared to produce the least satisfactory airflow patterns the more complex bluff shape and the champagne glass shape caused less distortion of the wind field in the most recent works of cauteruccio et al 2020 2021b and nešpor and sevruk 1999 wt measurements of the flow velocity were obtained by employing multi hole pressure probes located in selected positions above the investigated gauge geometries at different wind speeds with the objective to validate numerical cfd simulations the wind induced undercatch derives from the impact of the airflow deformation on the trajectories of water drops when approaching the collector once the microphysical characteristics of precipitation particle size distribution precipitation intensity and the deviation of each hydrometeor trajectory from the undisturbed one are known suitable models can be used to derive adjustment curves for operational use see e g cauteruccio and lanza 2020 to provide evidence of this phenomenon more complex wt tests that combines wind speed and the presence of hydrometeors were carried out in the past warnik 1953 injected real dry and low density and sawdust snow into the wt to visualize the airflow pattern and to study the quantitative catch of the model gauges wind speed from 5 to 10 m s were tested for the first time the trajectories of precipitating solid particles under windy conditions and their deviations when approaching the gauge were visualized although not precisely measured just the overall undercatch was quantitatively obtained with the main objective to justify the inconsistencies observed in records of snow catch in the field results were also used to design the geometry of two windshields green and helliwell 1972 measured both airflow velocity profiles and water drop trajectories above a cylindrical rain gauge the flow field was measured using hotwire anemometers positioned on a grid while the trajectories of injected drops were tracked using photographs from a still reflex camera trajectories of water drops with diameters of 1 2 2 2 and 3 5 mm were recorded with low details an apparent catchment area defined by the positions reached by two deflected drop trajectories which in undisturbed conditions would aim to the upwind and downwind edges of the collector was used to calculate the gauge catch this assumption implies that the most deflected trajectory aims in undisturbed conditions to the leeward edge of the collector which is neither known a priori nor necessarily true besides the observed wind induced bias of catching type precipitation gauges in the field and the available technical solutions used to limit its impact on the measurement accuracy there is a need for quantitative experimental evidence obtained in fully controlled conditions laboratory or wt tests of the physical processes acting behind the exposure problem and their respective role this work presents for the first time to the authors knowledge two joint quantitative pieces of evidence of the wind induced bias of catching type gauges in controlled wt conditions the first is a detailed assessment of the airflow configuration upstream of and above the gauge collector and the second is the resulting deviation of drop trajectories when approaching the gauge both obtained by video tracking techniques interpretation of the drop behavior was therefore possible based on the measured airflow pattern and the impact of different outer shapes of commercially available precipitation gauges on the catch efficiency is compared in the following 2 methodology experiments were carried out in the large scale wt facility available at the politecnico di milano hereafter gvpm within the activities of the italian national project prin 20154wx5na reconciling precipitation with runoff the role of understated measurement biases in the modelling of hydrological processes three typical outer shapes of commercial rain gauges were investigated to assess their aerodynamic characteristic and the resulting effect on the trajectories of the approaching hydrometeors namely the cylindrical the chimney and the inverted conical shapes most tipping bucket rain gauges available on the market have indeed a cylindrical geometry the most common weighing gauges have a typical chimney shape due to the large amount of rainwater stored to avoid the need of frequently emptying the gauge while the so called aerodynamic gauges have an innovative inverted conical shape although they too are based on the tipping bucket mechanism the commercial models adopted in this research were therefore the lambrecht rain e h3 although this instrument is actually a hybrid tipping bucket and weighing gauge the geonor t200b and the eml sbs500 assumed as representative specimens for the cylindrical chimney and inverted conical shape respectively the experiments consisted of two steps first a particle image velocimetry piv technique was used to measure the airflow pattern upstream of and above the gauge collector then drops were released in the wt to mimic raindrops falling in a windy environment the drop trajectories near the gauge collector were tracked and quantitatively measured using a high speed camera the piv technique provided the flow velocity pattern on a 2 d x z section of the flow field where x is the stream wise direction and z the vertical coordinate centered on the longitudinal symmetry axis of the collector a castor oil smoke was injected in the wt and used as a passive tracer while the measurement section was illuminated with a light sheet produced by a pulsed laser emitter output energy 200 mj using a cylindrical optics with an aperture of 50 the upper part of the gauges was painted in black to avoid the reflection of light and suitable masking of the captured images was adopted to post process the piv acquisitions pictures were taken using a double shutter camera with a 50 mm optics equipped with a 2 mpx 1953 1112 px ccd sensor positioned at about 2 m from the measurement section the latter had dimensions 435 250 mm with a magnification factor of 4 34 px mm the frame rate of the acquisition was 100 microseconds and two hundred pairs of images were captured to guarantee sufficient statistical significance of the post process analysis images were processed with the pivview 2c software produced by pivtec gmbh in collaboration with the german aerospace center dlr the processing algorithm was set to single correlation analysis on partially 50 overlapping windows of 64 64 pixels therefore obtaining a resolution of about 7 mm per each measurement position the accuracy can be evaluated based on a positioning uncertainty of 0 1 pixels corresponding under the conditions of this test to an uncertainty on the velocity equal to 0 2 m s the outputs of the single acquisitions were averaged over the total number of images to obtain an average flow field under steady flow conditions for each precipitation gauge tests were conducted at wind speeds equal to 5 and 10 m s 1 and the flow velocity fields were discretized into a regular grid with cell size of 7 5 7 5 mm a dedicated experimental setup was designed and realized in the gvpm to measure the deviation of drop trajectories when they are approaching and travelling above the gauge collector water drops were released in the wt flow upstream the gauge and their trajectories were captured with a high speed camera in the vertical 2 d plane centered on the longitudinal symmetry axis of the gauge collector the experimental setup is described in detail in cauteruccio 2020 and cauteruccio et al 2021b the recording speed was set to 1000 fps with an image resolution of 1600 900 pixels the captured footages were about 40 20 cm wide with a pixel size between 0 19 and 0 24 mm depending on the single test the videos recorded by the camera were analyzed in the matlab environment where the path of each drop was identified to improve the visibility of the drops each image was converted to greyscale and gaussian and laplacian filters were applied the image was binarized so as to report the background with zeroes and the position of the drop with ones finally a moving window was used over the image to identify and record the center of the drop from the time interval between two subsequent images and the dimension of each pixels the drop speed was calculated 3 results and discussion results about the airflow velocity fields are shown in the form of color coded maps of the normalized vertical velocity component and plots of the normalized positions of the maximum velocity values obtained from the piv the maps confirm previous literature works colli et al 2016 colli et al 2018 about the scalability low reynolds dependency of the airflow fields except for the chimney shaped gauge for undisturbed wind velocity uref between 5 and 10 m s 1 as detailed below in addition local velocity flow measurements previously obtained at the university of genova and used to validate cfd airflow simulation results cauteruccio et al 2021b show that the normalized velocity components are fairly scalable especially in the range between 10 and 20 m s 1 an example of the low reynolds dependency of the profiles of the normalized vertical flow velocity uz uref along the central stream wise symmetry plane above the gauge collector is reported in fig 1 for the three outer geometries investigated in this work the scalability of the flow field allows us to apply the piv results to a wider range of wind velocities both lower and higher than the experimental range drop trajectories observed at wind speed from 9 to 13 m s 1 are shown and commented according to the piv velocity fields measured at 10 m s 1 together with the derived slope curves in the graphs below the drop trajectories are depicted in the dimensionless plane x d and z d where d is the gauge collector diameter equal to 0 16 m for the lambrecht rain e h3 and the geonort200b gauges and equal to 0 25 m for the eml sbs500 gauge and the gauge collector is centered in 0 0 for each gauge the longitudinal coordinate x d of the drop releasing position was fixed while the elevation z d was set according to the wind speed 3 1 airflow velocity fields the color coded maps of the normalized vertical velocity component uz uref presented in fig 2 show that for the chimney shaped and the cylindrical gauges upward velocity components are present along the entire collector while for the inverted conical gauge downward velocity components prevail in the region above the second half part of the collector it is evident from the graphs that the maximum updraft a bit larger than 0 7 is associated with the geonor t200b gauge due to the chimney shape of the gauge body while the cylindrical gauge the lambrecht rain e h3 has the least pronounced updraft value the eml sbs500 gauge exhibits the maximum downdraft anticipating the influence that these vertical components would have on the trajectories of approaching hydrometeors it must be considered that the balance between the updraft and downdraft above the gauge collector is the relevant takeover information useful to compare different gauge shapes indeed the hydrometeor trajectories will be deflected upward depending on their shape and vertical velocity when the vertical velocity is positive updraft while they will tend to recover their original undisturbed trajectory when the vertical velocity is negative downdraft from the airflow velocity maps it can be noted that the chimney shaped gauge is the one producing the most unbalanced vertical forces with a predominant upward component and a low downward component while consistently with the work of cauteruccio et al 2020 for the inverted conical gauge in uniform free stream conditions the updraft in the upwind part of the collector and the downdraft in the downwind part are comparable in magnitude the behavior of the cylindrical gauge is intermediate fig 3 reports the normalized positions of the maximum velocity values obtained from piv measurements at uref 5 m s 1 for the three geometries investigated this result reveals that these positions are higher and more dispersed for the chimney shaped geonor t200b gauge while they are lower and more bounded for the inverted conical shape the behavior of the cylindrical gauge is intermediate in fig 4 a c the normalized positions of the maximum velocity values for each gauge geometry at uref 5 triangles and 10 circles m s 1 are compared and color coded based on the normalized magnitude of the airflow velocity umag uref the magnitude of flow velocity is larger for the gauge with inverted conical shape and lower for the other two geometries moreover for the chimney shaped gauge the non dimensional maximum velocity patterns show a reynolds number dependency their normalized positions do not overlap upon varying the flow velocity both in terms of normalized velocity magnitude and positions 3 2 observed drop trajectories the wt experimental campaign resulted in capturing 106 trajectories of drops released between z d 0 18 and z d 0 70 above the lambrecht rain e h3 at uref 8 9 to 13 1 m s 1 82 trajectories of drops released between z d 0 05 and z d 0 70 above the geonort200b at uref 8 86 to 13 6 m s 1 and 50 trajectories of drops released between z d 0 15 and z d 0 60 above the eml sbs500 gauge at uref 9 35 to 12 6 m s 1 for each gauge geometry and wind speed drops of different size were generated and the obtained drop diameter ranges between 0 9 and 1 2 mm these values were derived from images captured by the video camera during dedicated tests conducted in still air in this section sample observed drop trajectories are selected and illustrated to discuss their relevant features together with the associated slope curves in the following the prefix ch identifies the geonort200b chimney shaped gauge while cy and ic indicate the cylindrical and inverted conical shape of the lambrecht rain e h3 and eml sbs500 gauges respectively repeatability was checked for trajectories and their deviation having the closest initial positions and for all gauges in fig 5 the root mean square deviation rmsd of pairs of trajectories is reported as a function of the vertical distance between their initial positions only those with very close initial positions are shown trajectories observed for all three gauges are included and differentiated using different markers it is shown that the rmsd is always lower with very few exceptions than the maximum estimated size of the drop in the observed trajectories 1 2 mm highlighted by the dashed horizontal line the markers also show a clear trend towards smaller rmsd while decreasing the distance of the initial position of each pair of trajectories which strongly confirms their repeatability this is an important feature of our experiment since not only it implies that the experimental setup was correctly implemented but also confirms that the deviation induced by wind on the drop trajectory is systematic beside some measurement uncertainties due to the inherent limitations of the video tracking system an example of one observed drop trajectory above the collector of the chimney shaped gauge at uref 12 8 m s 1 is indicated with markers in the top panel of fig 6 the first part of the observed trajectory depicted with triangles is not affected by the aerodynamic response of the gauge and can be linearly extrapolated solid line in the graph to obtain the undisturbed trajectory dashed line in the graph extended to the maximum longitudinal coordinate of the observed trajectory wherever z d 0 the disturbed part of the trajectory depicted with circles was fitted with a third order polynomial dotted line in the graph the slope curve dz dx see the solid line in the bottom panel of fig 6 was obtained as the first derivative of the fitted trajectory and compared in the same plot with the slope curve of the undisturbed trajectory horizontal dashed line when the drop approaches the collector of the gauge it enters the region of the flow field with significant vertical velocity components and its trajectory deviates from the undisturbed one moreover from the comparison between observed and undisturbed trajectories it is evident that the undisturbed trajectory would enter the collector while the observed one overtakes the collector and travels beyond the gauge therefore highlighting the phenomenon of the wind induced undercatch in the following figures some further examples of observed drop trajectories are reported and organized in pairs for each investigated gauge in order to interrelate the drop position with the airflow deformation induced by the gauge body the normalized positions of the maximum velocity values measured by the piv technique are depicted with light blue lines fig 7 reports a pair of observed trajectories for two drops named ch3 and ch6 having the same size as demonstrated by the undisturbed slope and released approximatively at the same initial position above the geonor t200b gauge at uref 10 2 m s 1 similar trajectories and the associated slope curves are reported in fig 8 for two drops cy97 and cy98 having approximatively the same size and travelling above the collector of the gauge with cylindrical shape at uref 13 1 m s 1 in both figures the drops released at a higher elevation start later to deviate from the undisturbed trajectory and are less sensitive to the recirculating zone in the second half part of the collector drops of different size therefore with different undisturbed slope were also observed at the same wind velocity and their trajectories are shown for instance in fig 9 for the inverted conical gauge at uref 11 6 m s 1 as demonstrated by the slope curves continuous lines the drop depicted in red ic84 is larger than the green one ic81 note that for all gauges the deviation of the actual trajectories from the undisturbed ones becomes visually evident when they cross the pattern of the maximum velocity values light blue line 3 3 comparison between piv and observed drop trajectories wind induced deviations of the trajectories vary with the shape of the gauge and are consistent with the analysis of the velocity field of the recirculation zone in the various cases in this section we show and compare three drops named ch11 cy31 and ic83 which in undisturbed conditions should hit the downwind part of the gauge collector but are deviated by the aerodynamic interference of the gauge their disturbed trajectories are commented in relation with the measured piv velocity field the compared drop trajectories were chosen by minimizing the relative difference between the respective starting positions z d at the same free stream airflow velocity uref these data are listed in table 1 the parameters of the best fit curves describing the trajectories of the drops and the associated correlation factors r2 are listed in table 2 figs 10 and 11 report the observed drop trajectories ch11 and cy31 which travel above the collector of the chimney shaped and cylindrical gauges respectively in fig 12 their slopes are compared with the undisturbed ones in both cases when the drop trajectories approach the gauge collector at x d 0 5 they visually deviate from the undisturbed trajectory and their slope decreases moreover the two drops fall outside instead of inside of the collector therefore highlighting the very nature of the wind induced undercatch affecting precipitation measurements the collectors of the chimney shaped and cylindrical gauges have the same size while the collector of the inverted conical gauge is larger therefore the features of trajectories ch11 and cy31 are better comparable the injection system was maintained at a fixed distance from the center of the gauge collector therefore drops were released closer to the gauge with inverted conical shape than for the other two gauges in fig 13 a sample drop trajectory travelling above the inverted conical gauge is depicted together with the associated slope curve the effect of the comparability between the airflow updraft and downdraft for this geometry as discussed above can be observed here by noting that the deviation of the drop trajectory is almost totally bounded within the region delimited by the projection of the collector edges x d 0 5 fig 13 bottom panel consistently with the piv velocity field the slope of the trajectory in the downwind part of the collector increases faster for the cylindrical gauge than for the chimney shaped gauge see fig 12 moreover the wind speed for the trajectory that travels above the collector of the chimney shaped gauge uref 11 4 m s 1 is lower than for the trajectory captured above the cylindrical gauge uref 12 1 m s 1 and the undisturbed slopes suggest that the size of the drop observed above the chimney shaped gauge is larger than the one that travels above the cylindrical gauge these results suggest that the aerodynamic behaviour of the chimney shaped gauge could be the most negatively impactful on the collection performance of the gauge yielding a larger undercatch the normalized deviation dev d of each observed drop trajectory from the undisturbed one is quantitatively measured by calculating the distance from the geometrical position of the drop at each time step to the straight line representing the undisturbed trajectory extrapolated from the initial observed positions of the drop this yields a curve as a function of the longitudinal coordinate departing from zero when the drop starts deviating from the undisturbed trajectory due to the airflow updraft and acceleration and reaching a maximum distance beyond which the drop starts approaching again the original path since the slope of its trajectory increases due to the airflow downdraft and deceleration due to the experimental variability of the obtained drop size and releasing position few trajectories can be found that allow consistent comparison of the three outer shapes investigated in this work i e drops that with the same size and at the same wind speed are released precisely in the same normalized position relative to the upwind edge of the gauge collector one example is provided in fig 14 where the comparison of similar drop trajectories for the three outer shapes investigated is shown in terms of their deviations dev d markers indicate deviations calculated from the measured drop positions while solid lines are calculated from the interpolated polynomial trajectories the graph shows that the deviations are significantly different in the three cases with the chimney shaped gauge having the most relevant deviation throughout the whole trajectory the cylindrical gauge being intermediate and the inverted conical gauge having the least deviated pattern as reported in table 3 the normalised deviations at the downwind edge of the collector x d 0 5 also follow the same order and the longitudinal coordinate at which the drop starts deviating from the undisturbed trajectory increases when moving from the ch to the cy and ic gauge shapes according to the more extended influence of the gauge aerodynamic behaviour this is fully consistent with the previous observations and the airflow velocity patterns revealed by the piv and confirms that the chimney shaped gauge has the worst performance when compared with the cylindrical and inverted conical shapes 4 conclusions the obtained quantitative experimental evidence of the deviation of drop trajectories when approaching the collector of catching type gauges in controlled wt conditions provides insights into the physical processes acting behind the exposure problem and their respective role in affecting the trajectories of hydrometeors having various size and fall velocity this will support the development of both correction algorithms for the wind induced bias of precipitation measurements and optimal gauge windshield geometries for operational use using video tracking techniques contemporary quantitative evidence of the wind induced bias of catching type gauges was indeed provided in this work by means of a detailed assessment of both the airflow pattern upstream and above of the gauge collector and the resulting deviation of the injected drop trajectories when approaching the gauge interpretation of the drop behavior was therefore possible based on the measured airflow pattern and the impact of different outer shapes of commercially available precipitation gauges on the catch efficiency was compared the data collected are also a reliable data set for validation of numerical cfd models of the flow field and the particle trajectories cauteruccio et al 2021b allowing a theoretically based derivation of correction curves and the analysis of the most influencing factors and controlling variables this was hardly possible hitherto based on the experimental evidence obtained from field test sites alone where the many external factors contemporarily acting on the gauge catch usually mask the underlying physical process with a high level of noise to reduce the spreading of experimental data around the expected theoretical behavior better identification of the controlling variables is needed and their effect individually quantified which is only possible in fully controlled experiments using the obtained dataset here provided as supplementary material as a benchmark to validate numerical models is also an added value of the present work indeed the availability of a large size wt facility with a water drop releasing device and a particle tracking system is not usual but it represents an interesting special research infrastructure specifically developed in the framework of the italian national project prin 20154wx5na the present research is part of a wider activity aiming at quantifying the undercatch effect induced by the wind on gauges and to define their collection efficiency the proposed methodology consists in using the experimental wt results to set up and validate numerical cfd simulations under laboratory controlled conditions while investigating more realistic environmental conditions through cfd simulations in order to consider the characteristics of rainfall drop size distribution shape etc and wind in the atmospheric boundary layer velocity turbulence intensity length scale etc the proposed experimental numerical methodology would be useful for the instrument design and calibration allowing for a gauge shape optimization or the adoption of mitigation solution by looking not only at the aerodynamic performance but also at the measuring performance the tests performed in controlled wt experiments allowed to compare instruments with three different outer shapes of the gauge body under the same wind forcing and drop releasing conditions representative specimens for the cylindrical chimney and inverted conical shape were tested confirming the good performance of the aerodynamic solution the chimney shape that is typical of some weighing type gauges demonstrated lower performance with respect to the cylindrical and inverted conical shape showing the most relevant effect in deviating the trajectories of the approaching water drops when immersed in a wind field further developments of this work could be focused on examining additional aerodynamic features of the gauge body such as the sharpness of the collector s rim and the relative dimensions of the various parts of the outer geometry of the gauge also the experimental setup could be improved by developing an injection system able to release drops with an initial velocity component close to their terminal velocity however we believe that numerical simulation properly calibrated using the observations presented in this work would be the most promising approach to address such and similar issues credit authorship contribution statement arianna cauteruccio conceptualization methodology software validation investigation writing original draft writing review editing elia brambilla methodology software investigation writing review editing mattia stagnaro conceptualization methodology investigation writing review editing luca g lanza conceptualization methodology investigation writing review editing supervision project administration daniele rocchi conceptualization methodology investigation writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was developed in the framework of the italian national project prin20154wx5na reconciling precipitation with runoff the role of understated measurement biases in the modelling of hydrological processes and as partial fulfilment of the phd thesis of the first author appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2021 126690 and also at http www precipitation biases it drop trajectories jhydrol2021 php appendix a supplementary data the following are the supplementary data to this article supplementary data 1 supplementary data 2 supplementary data 3 supplementary data 4 supplementary data 5 supplementary data 6 supplementary data 7 supplementary data 8 supplementary data 9 supplementary data 10 supplementary data 11 supplementary data 12 supplementary data 13 supplementary data 14 supplementary data 15 supplementary data 16 
4434,the skillful soil moisture sm for the soil moisture active passive smap l4 product can provide substantial value for many practical applications including ecosystem management and precision agriculture deep learning dl models provide powerful methods for hydrologic variables prediction such as sm however the sample size of daily sm in the smap product is quite small which may lead to overfitting and further impact the accuracy of dl models from this we first tested whether excellent predictive performance can be achieved with limited smap samples by the convolutional neural networks cnn long short term memory lstm and convolutional lstm convlstm models which are frequent used for hydrologic prediction then we pre trained the dl models in the source domain era5 land and fine tuned them in the target domain smap the results show that the transfer convlstm model had the highest r2 ranging from 0 909 to 0 916 and the lowest rmse ranging from 0 0239 to 0 0247 for the lead time of 3 5 and 7 days and the regression lines between the predicted and the observed sm were closer to the ideal line y x than all the other dl models all the performances of transfer dl models were better than those of their corresponding dl models without transfer learning and some regions witnessed an increased explained variation over 20 the predictive ability of different factors i e lagged sm soil temperature season and precipitation has been widely discussed in this paper according the results we advocate for applying cross source transfer learning with dl models for sm prediction in newly built datasets keywords soil moisture deep learning transfer learning small sample smap machine learning 1 introduction soil moisture sm is a key state variable in climatological hydrological and ecological systems coupling atmospheric processes to land surface states entekhabi et al 1996 it also plays a major role in many applications such as weather forecasts koster 2004 and flood potential assessment norbiato et al 2008 thus accurate prediction of sm has substantial value for providing guidance for disaster response irrigation and other scientifically applications dirmeye et al 2006 recently the measurement ability of surface sm has been promoted due to several satellite missions entekhabi et al 2010 thereinto the soil moisture active passive smap has been given considerable attention and significantly improved the measurement capability of surface sm hence many workshave focused on the smap prediction for exploring the predictability of surface sm fang et al 2017 fang and shen 2020 meanwhile sm has the substantial spatiotemporal variability due to its complex dependency on different related hydrologic variables and land surface conditions e g precipitation soil temperature and evapotranspiration currently hydrologic variables are commonly simulated based on process based models such as land surface models hydrology models and earth system models which relies on governing equations with the complex mechanism of land atmosphere feedbacks kalakuntla et al 2013 the limitations for process based models are underrepresentation of key processes and human activities and the high computational costs markus et al 2019 with the help of increasing computation power big data accumulated over decades and wonderful achievements in deep learning dl data driven dl models can be realized without knowledge on complex mechanism of physic model and have great potential in improving the prediction and achieving a better understanding of the land atmosphere interactions irrgang et al 2021 the most relevant dl models for hydrologic prediction are classified as three categories spatial models convolutional neural networks cnn by lecun and bengio 1995 temporal models long short term memory networks lstm by hochreiter and schmidhuber 1997 and spatial temporal models convolutional lstm convlstm by shi et al 2015 cnns are constructed to deal with data in the multiple arrays and excellent in extracting spatial features for hydrologic variables sobayo et al 2018 applied cnn based model to establish the relationship between sm and temperatures of the target plants from the thermal infrared images for in situ sm prediction pan et al 2019a improved the predictive performance of rainfall from weather models by cnn based model lstms are designed to process sequence data and widely applied for predicting time series data in earth system science fang and shen 2020 captured the interannual trends of sm by lstm and improved the smap l3 prediction li et al 2020c combined the units in different steps as the output layer in an lstm structure for improving in situ soil temperature prediction convlstm is a relative novel model for hydrologic variables prediction it can not only get temporal relationship but also extract spatial features through convolution layer in this way convlstm can extract temporal and spatial features spatiotemporal features at the same time and the switching between states is also replaced by convolution operation convlstm model is applied in rainfall nowcasting for the first time by shi et al 2015 and can reproduce the spatiotemporal properties of short term rainfall fields mohamed et al 2021 explored the sm predictivity using the spatial temporal model and demonstrated that convlstm had better predictive performance than cnn based and lstm based models in sm prediction in this study we will assess the capacity of these three models for smap prediction although the smap product is considered as a huge contribution for sm measurement smap observations only have a short revisit time 2 3 days and time span launched in 2015 which make the total number of daily sm samples quite small less than 2300 until 2020 and hardly to observe the longer response of sm as we known in computer sciences the enormous training sets more than ten thousand become necessary which can avoid overfitting and further improve the accuracy of dl models shin et al 2016 zhuang et al 2019 unfortunately smap observations are quite sparse questions arise regarding whether the most relevant dl models can reliably achieve excellent predictive performance for sm and what methods can assist the dl models to get a better predictive ability for sm with insufficient data records transfer learning are commonly dl approaches for the lack of suitable datasets it mainly transfers the knowledge contained in similar but not equivalent source domains for improving the performance of dl model on target domains in this way the excellent dl model is expected to be constructed for predicting the smap observations with limited data size contrast to smap product s limited time span land reanalysis datasets for example cfsr saha et al 2010 saha et al 2014 merra 2 gelaro et al 2017 era interim douville et al 1998 and era5 hersbach et al 2018 can simulate global sm over much longer time spans among these products era5 land combined more historical observations and has a finer resolution for simulating sm which is corrected by an empirical approach meanwhile it covers the period from 1979 to present hersbach et al 2018 as era5 land has higher skills than other products significant improvement over its predecessor and longer time spans li et al 2020b we focus on the era5 land reanalysis dataset as our source domain for exploring the improvement of smap prediction based on transfer learning model although era5 land has played vital roles for exploring climate change significant differences from observations existed the differences are commonly accompanied by soil depths models and systematic patterns in them hence it is noteworthy that whether the information obtained from era5 land can be effective transferred to smap no study to our knowledge explored transfer learning method in sm prediction especially for small data sets such as smap the above studies and discussions motivated our proposal of a transfer deep learning model for the problem of the limited data size for smap sm prediction the basic hypothesis of this study is that with only less than 5 years of daily smap data the number of samples is less than 2300 transfer learning based on era5 land over long time spans and most relevant dl models for hydrologic prediction can improve the predictive performance to a certain extent our contributions are offered as following 1 we verify whether the most relevant dl models for hydrologic prediction cnn lstm and convlstm can reliably achieved excellent predictive performance for daily smap sm with limited data size or not 2 we verify whether the information obtained from era5 land can be effective transferred to smap and further improve the predictive performance for daily smap sm or not 3 we intuitively display and analysis the performance of predictive model with different values of sm precipitation soil temperature and seasons and it is expected to be instructive for the researchers to improve the predictive performance for sm intentionally and strategically the rest of this paper was organized as follows the study area china smap and era5 land were introduced for this study in section 2 the background knowledge of the transfer learning and relevant dl models cnn lstm and convlstm were described in section 3 in section 4 we presented and discussed the experimental results for smap sm based on dl models and transfer dl models finally concluding remarks were presented in the final section 2 data 2 1 study area and smap product china 3 54 n 72 126 w was restricted as the study domain the smap l4 product was selected as the target domain to test the sm predictive ability of transfer dl models it contains top 5 cm sm with a relatively low standard deviation of 4 cm3 cm3 fang et al 2017 and various of related land surface variables e g model parameters and surface meteorological forcing data which are at about 9 km spatial resolution and 3 h temporal resolution reichle et al 2020 the smap l4 product are the merged information of land surface model estimates and smap brightness temperature observations by a spatially distributed ensemble kalman filter entekhabi et al 2010 as the smap brightness temperatures can be effectively propagated into the land surface model during the data assimilation process the smap l4 product is consistent with the available smap satellite observations additionally the smap sm prediction have demonstrated that it had an important impact on forecasting the streamflow response to future rainfall events which is valuable for observing dynamics of generating sm crow et al 2019 the predictability of sm was commonly affected by its own persistence or other external forcing factors hence the sm memory lagged sm precipitation and soil temperature were selected as our input features for dl model due to their frequent usage for sm prediction pan et al 2019b li et al 2018 however it should be noted that there are other features such as air temperature vegetation conditions and soil properties which can be incorporated into dl models for possible improvements we used only three factors for simplicity and efficiency all the applied data in this study is daily time scale during the period from april 1 2015 to december 8 2020 the number of samples is 2080 for our experiment the training dataset is from april 1 2015 to december 7 2018 for fitting the dl model the validation set is from december 8 2018 to december 7 2019 for tuning the hyperparameters for avoiding overfitting to the training dataset the test dataset is from december 8 2019 to december 8 2020 for evaluating the performance of dl models on unseen data during training at the same time the raw dataset had so high resolutions about 0 1 with 617 685 grid points in china domain that cannot be handled for dl models due to the gpu memory constraints previous studies have already demonstrated that the predictive performance at higher resolutions has small difference with that at a coarser resolution rasp et al 2020 considering our gpu memory in training the predictive model we used the dataset at a coarser resolution to the maximum extent possible hence we regridded all variables to lower resolutions about 1 with 52 65 grid points in china domain by the xesmf python package for testing dl models fig 1 a presented the spatially distribution of the average smap sm in addition we also tested dl models with the smap data in two areas at its original resolution which is shown in section 4 5 2 2 era5 land reanalysis dataset the era5 land reanalysis dataset was selected as the source domain to verify our model different from era5 era5 land is generated by reanalysis the land portion of european center for medium weather forecasting ecmwf based on the physical laws the model data is combined with the observation data from all over the world for generating a global complete and consistent data set it can go back decades and give the best suppose in the future time cao et al 2020 due to previous evaluation studies beck et al 2020 era5 land has superior accuracy than most other sm datasets from model outputs remote sensing and reanalysis era5 land and smap have similar characteristics which both generated by similar physical laws and have spatially varying bias which are commonly accompanied by soil depths models and systematic patterns in them these characteristics are proven to be suitable for transfer dl models zhuang et al 2019 the raw data of era5 land for the time period in this study are from january 1 1980 to december 8 2020 the number of daily samples is 14 610 and the spatial resolution is 0 1 in china domain in layer 1 0 7 cm all data are interpolated to the lower resolution about 1 with 52 65 grid points in china domain as the same as smap meanwhile era5 land is split into two parts the training and validation sets as the motivation of our study is to apply the knowledge of era5 land to transfer on data from smap product we don t care about the predictive performance of dl models on era5 land hence the test set of era5 landis not necessary in our study the training dataset is from january 1 1980 to december 7 2019 and the validation dataset is from december 8 2019 to december 8 2020 the spatially distribution of the average era5 land sm from april 1 2015 to december 8 2020 is presented in fig 1 b according to the fig 1 we can conclude that era5 land tends to be underestimated on the arid western and north central china and be overestimated in the wet southern and northeast china theses difference patterns in them could be a basis for improving predictions 2 3 statistical characteristics of sm the statistical characteristics of the sm of smap and era5 land in the eight climatic zones from april 1 2015 to december 8 2020 is presented in table 1 for the minimum sm the lowest value appeared in the arid desert cold climate zone for smap 0 009 m3 m3 but appeared in many climate zones for era5 land 0 0005 m3 m3 which seems to be set as the lower boundary in era5 land for the maximum sm the highest value appeared in the temperate no dry season hot summer climate zone for smap 0 5078 m3 m3 but appeared in the arid steppe cold climate zone for era5 land 0 7598 m3 m3 meanwhile era5 land had higher maximum values and lower minimum values than smap at the same time the standard deviation of the temperate dry winter hot summer climate zone 0 1174 m3 m3 was the largest which indicates a lager annual variation of sm in this climate zone the differences between climate zones are related to the precipitation changes evapotranspiration and land surface conditions it should be noted that era5 land had larger standard deviations than smap for all climate zone except for temperate dry winter warm summer climate zone fig 1 c denotes that most areas had a positive correlation between smap and era5 land sm during the same period indicating that overall the sm in the two datasets had roughly similar trends of temporal variation this may have benefits for improving predictive performance based on transfer learning method 3 methods we explored the transfer dl models for smap sm prediction and the topological structure for sm prediction is represented in fig 2 the presented structure consists of two key pipelines dl models without transfer learning and transfer dl models the first pipeline only focuses on the target domain which aimed at verifying whether the cnn lstm and convlstm can reliably achieved excellent predictive performance for daily smap sm with limited data size or not the highlight of second pipeline is with both the source and target domain which was designed to verify whether the information obtained from era5 land can be effective transferred to smap and further improve the predictive performance or not we first pre trained the dl models based on the source domain era5 land and then fine tuned them in the target domain smap finally the error criteria including bias root mean square rmse and determination coefficient r2 were computed for evaluating the predictive performance of dl models at 3 5 and 7 days lead time r2 denotes the degree of model fitting the extent to which the dl models can interpret the data and rmse shows the ability to predict volatility these criteria are defined as follows 1 rmse i 1 n y i y i 2 n 2 r 2 1 e i 1 n y i y i 2 e i 1 n y i y i 2 where y i is the truth value of the i th timesteps in the dataset era5 land or smap and y i is the predicted value of the i th timesteps by dl models and y i is the average value of the truth value all the variables were normalized to reduce the effects of an absolute scale as follows 3 x norm x x min x min x max where x x max x min x norm are the original maximum minimum and normalized values on the grid from training data we perform the experiments on a server with an intel core i7 10750h cpu with 2 60 ghz ram and geforce rtx 2060 gpu running pycharm 2018 1 4 pytorch is the backend in our experiments 3 1 convolutional neural network cnn is a classical data driven dl model which can extract discriminative spatial features from images with sufficient samples lecun and bengio 1995 in our study we apply the simple dl models since we only focus on exploring whether fine tune method can assist dl models to improve predictive accuracy rather than exploring structural optimization of dl models fig a 1 shows the experimental setup for the simple cnn based predictive model in this study in this setup the input data is consisted of sm precipitation and soil temperature variables at t t 1 and t 2 days meanwhile the variables are feature maps of 52 65 size hence the input size in the predictive model is 9 52 65 the output is the predicted soil moisture on t n day in the future n 3 5 7 represent the predicted sm on 3rd 5th and 7th day in the future and the size is same as the inputs for cnn based model the first convolutional layer has 48 channels the size of kernel the padding and the stride are 3 0 and 3 respectively the default rectified linear unit relu activation function is used in this layer after operation in the convolutional layer the input data is converted to the feature map whose size is 48 17 21 finally the predicted sm on t n day in the future is obtained by the fully connected layer based on the feature map convolution takes local features and fully connected layers is to assemble the previous local features into a complete graph through the weight matrix to fairly compare the predictive performance of all dl models all the top layer is changed from softmax loss layer to euclidean loss layer because of regression task in sm prediction iteration number is empirically set to 50 batch size is set to 128 and the model is trained with adam optimizer because we found that larger iteration and smaller batch size didn t improve the result a lot but with higher computing costs 3 2 long short term memory model lstm is also a classical data driven dl model which can make full use of sequential information hochreiter and schmidhuber 1997 in time series data it can take the output on the previous step as the input allowing information from the previous moment to be stored in the memory gate and further influence the output on the next moment and thus can capture long term trends of sm and further be successfully applied in sm prediction fang and shen 2020 fig a 2 shows the experimental setup for the simple lstm based predictive model in this study in this setup the input is a four dimensional tensor and the input variables are the same as those in cnn based predictive model whose shape is 3 3 52 65 the dimension of each input timestep is 3 t 2 t 1 and t days the input data consist of 3 variables sm precipitation and soil temperature and the variables are feature maps of 52 65 size the output is the same as that in cnn based predictive model the input data is first reshaped as a two dimensional tensor and the size is 3 3 52 65 for lstm based predictive model the hidden size is set to52 65 finally the predicted sm on t n day in the future is obtained by the fully connected layer based on the output at t day of lstm it is expected to capture the long term temporal feature on the previous timestep inputs and the short term temporal feature on the last timestep inputs 3 3 convolution long short term memory model the core of convlstm like lstm takes the output of the previous layer as the input of the next layer the difference is that after adding convolution operation convlstm can not only get temporal relationship but also extract spatial features like convolution layer in cnn model several studies have focused on the spatial and temporal features and proved to be effective in different applications for example shi et al 2015 proposed convlstm model for rainfall nowcasting which can extract both temporal and spatial features at the same time and the switching between states is replaced by convolution operations wang et al 2019 combined 3d cnn with lstm model for video prediction which incorporate the convolutional features into the recurrent state transition over time and they denoted that the proposed method could effectively model the spatial features in a consecutive manner and had better predictive performance than the convlstm model which is proposed by shi et al 2015 hence the 3d cnn with lstm model is also conducted in our study which has similar predictive performance with convlstm model not exhibits in our study the related code of the 3d cnn with lstm model is also publicly available at https github com ljz1228 transfer learning soil moisture prediction the convlstm model is selected as the predictive model due to its sophisticated network structure it is expected to capture both spatial and temporal features in sm and further improve predictive performance fig a 3 shows the experimental setup for the simple convlstm based predictive model in this study in this setup the sm at the future day n t is predicted based on the sequence input features at the days t t 1 and t 2 which is the same as that in lstm based predictive model representing the dimension of each input timestep meanwhile the input and the output data are also the same as that in lstm based model for convlstm based model the number of convlstm layers is 2 and the number of filters in each convlstm layer is 16 and 8 respectively the size of kernel is 3 and the default hyperbolic tangent tanh activation function is used the same padding method is considered for keeping the size of feature maps 52 65 as the same as that of the input sm finally the fully connecting layer is applied to predict sm based on the output data at t day of convlstm 3 4 transfer learning for smap in computer sciences although dl models have achieved amazing performance in various of applications e g image recognition krizhevsky et al 2012 farabet et al 2013 and speech recognition mikolov et al 2011 hinton et al 2012 the limitations exist in certain cases the commonly applied dl models usually need abundant training samples which have the same statistical distribution as the test dataset unfortunately such adequate training samples are unrealistic in many cases due to the time consuming and expensive for collecting samples this may lead to overfitting of the dl models and further affect predictive performance previous studies hu et al 2016 huang et al 2020 bashar and nayak 2021 have proved that transfer learning models can solve this problem which can effectively transfer knowledge of source domain abundant samples to target domain limited samples to our knowledge no studies have been conducted on the transfer learning method in sm prediction especially for small data sets such as smap product in this study we mainly verify the effectiveness of transfer learning for predicting smap sm with limited data size hence the simple fine tune method is applied in our model more complex transfer learning methods such as applying the adversarial extension of generative models li et al 2020d need further investigations for improving the predictive performance the definitions of transfer learning in our study are as follows domain our datasets smap and era5 land are referred as the domain d d x p x which contains feature space x and a marginal distribution p x the x is defined as x x x i x i 1 n which shows a selected dataset the n denoted the total number of the selected dataset task the learning process for dl models can be understood as task t which composed of a label space y sm in the selected dataset and a learning function f dl model the f is aimed at learning the knowledge from selected samples in this study a source domain ds corresponding to a source task ts is basically reviewed by the input feature observed sm pairs in era5 land such as d s x y x i x s y i y s i 1 n s smap is used as the target domain which consists of limited number of samples transfer learning the observations about the source domain era5 land and task can be defined as d s i t s i i 1 m s m s n and the observations corresponding to the target domain smap and task can be defined as d t r i t t r i i 1 m t m t n the knowledge of era5 land is transferred to improve the predictive performance of dl models cnn lstm and convlstm f t r j j 1 m t on smap 4 results and discussion 4 1 overall performance of dl models without transfer learning we first applied cnn lstm and convlstm models to predict smap sm for verifying whether the most relevant dl models for hydrologic prediction can reliably achieved excellent predictive performance for daily smap sm with limited data size or not the performance of cnn lstm and convlstm models without transfer learning at the lead time of 3 5 and 7 days are shown in figs 3 a 4 and a 5 overall convlstm had the lowest bias 0 00186 0 00119 and 0 00148 in average the lowest rmse 0 0297 0 0297 and 0 0283 in average and the highest r2 0 876 0 874 and 0 886 in average compared with cnn and lstm and they had similar spatial patterns of these three metrics all the dl models had low bias for prediction in most area of china within the range of 0 036 similar to era5 land all dl models tended to underestimate in the arid region of northwest china and overestimate in the east and south of china however overestimation also appeared in south china especially for lstm regarding the rmse it is worth pointing out that the northeast and central china had relative larger errors than other regions for convlstm while the northwest china had smaller errors in addition cnn had relative larger error than lstm and convlstm in the southern and northeast china usually the regions with a high r2 had a low rmse and vice versa in general convlstm achieved better predictive performance than cnn and lstm at the lead time of 3 5 and 7 days because convlstm can capture the information of both temporal and spatial dimensions more effectively and according to the rmse and r2 values achieved by dl models we can conclude that the relevant dl models for hydrologic prediction can reliably achieved well predictive performance for daily smap sm with limited data size in computer science such small number of samples will lead to overfitting for training the dl models and further affect the performance zhuang et al 2019 which is different with our smap sm prediction the reason may be that the samples in computer science for training dl models are commonly more complex and diversified than that in earth system science as processes governing the hydrologic variables such as sm are universal taking identifying what animal is depicted in an image as an example due to the large variability in the appearance of different animals sufficient samples are needed to train dl models for learning to discriminate features however in our study training samples for dl models are the map of land surface variables which all have a highly similar appearance hence the large number of samples are not needed for learning to discriminate features of sm but this does not mean that the transfer learning method have no or little impact on smap sm prediction which will be discussed in the next section although a relative good predictive performance can be achieved by dl models certain areas had relatively poor prediction such as the central and northeast china 4 2 improvements of transfer dl models we first pre trained the above dl models based on era5 land and then fine tuned them based on smap for fair comparison all the hyper parameters are set as the same as dl models without transfer learning figs 4 a 6 and a 7 show the density scatter plot of the predicted and observed sm using all the applied dl models from the above figures we can figure out that the best dl models for smap sm prediction was the transfer convlstm model which had the highest r2 ranging from 0 909 to 0 916 the lowest rmse ranging from 0 0239 to 0 0247 at the lead time of 3 5 and 7 days and the regression lines between predicted sm and observed sm were closer to the ideal line y x than the other dl models additionally all the performances of transfer dl models were better than those of corresponding dl models without transfer learning for transfer convlstm at different lead time the general r2 increased about 3 39 to 4 35 and rmse decreased about 15 55 to 18 18 compared with convlstm without transfer learning transfer cnn had more visible improvements than the single cnn the general r2 increased about 10 47 to 12 59 and rmse decreased about 24 11 to 31 48 we can draw the same conclusion for transfer lstm which had 4 36 to 7 99 improvement in r2 and 14 2 to 22 26 in rmse compared with the single lstm dynamic of sm is spatial different in different regions for example strong local positive sm precipitation feedback has impact on the future precipitation and sm li et al 2020a and further influences the sm prediction hence the improvements over different regions were investigated as shown in the above the map of r2 was consistent with the map of rmse we only show the performance variations of r2 in spatial distribution between transfer dl models and dl models without transfer learning in figs 5 and a 8 these figures show that the same predictive dl models have the highly similar variations in spatial distribution at different lead time hence we only discuss the performance variations of r2 in spatial distribution at the lead time of 3 days in fig 5 it is worth noting that even the improvement of the general r2 is limited after the application of transfer learning method the improvement in some area is relative obvious for example transfer convlstm improved the general r2 by less than 5 but it achieved better predictive performance in most regions especially in northeast central and southern china which had increased over 20 of r2 hence sm predicted based on transfer learning method can provide an important reference value for improving sm prediction considering that a simple fine tune strategy was adopted in this work more complex transfer learning methods have good potential in improving the performance further however some regions in north and southwest china witnessed a slight decline in r2 compared with transfer convlstm model cnn and lstm models with transfer learning both had more significant improvements in most regions in general after introducing the transfer learning method relevant dl models for hydrologic prediction can improve predictive performance for smap at different lead time meanwhile although the differences are commonly accompanied by soil depths models and systematic patterns between era5 land and smap we can still demonstrate that the information obtained from era5 land can be effective transferred to smap and further improve the predictive performance 4 3 the sensitivity analysis of different inputs for predictive model to explore the sensitivity of different inputs for predictive model we designed seven experiments to test the predictive performance of convlstm based on different input data seven groups of input variables were applied to fit convlstm for the sm on the 7th day prediction in the future from experiment i to vi the sm precipitation and soil temperature were all selected as our input features for convlstm meanwhile the 1 to 4 lagged input features were applied to test the sensitivity of different lagged inputs in experiment v vi and vii we removed sm soil temperature and precipitation from input data based on the 3 lagged experiment respectively we designed these experiments to investigate the effect of different explaining variables on the predictability of sm fig 6 represents the predictive performance of convlstm based on different input data on the 7th day prediction in the future for experiment i to vi with the increasing of lagged input features the performance increased gradually however when the 4 lagged input features were used to fit the predictive model the predictive performance only varied slightly and even decreases in addtion the numbers of 4 lagged input features for predictive model led to more computational time hence the 3 lagged input features are the best choice for our study on the other hand we also explored the sensitivity of different explaining variables from experiment v to vii for experiment v to vii by reducing one of the three explaining variables the predictive accuracy of convlstm would decrease the predictive accuracy decreased significantly especially for convlstm without sm hence the three explaining variables were all important for predictive performance in sm the reason is that the soil temperature is related to the fluxes of outgoing longwave sensible and ground heat which can further affect the sm venkat et al 2003 strong local positive sm precipitation feedback may further influence the generation of precipitation and sm li et al 2020a sm memory can remember a wet or dry anomaly long after the conditions responsible for the anomaly are forgotten by the atmosphere pan et al 2019b 4 4 the impact on different factors in the previous study pan et al 2019b we could know that the lagged sm precipitation season and soil temperature had the important roles for sm prediction however the uncertainty of these factors can also affect the predictive performance to show the influence of different factors lagged sm precipitation season and soil temperature on smap sm prediction the uncertainty of smap sm predictions related to these factors based on different dl models are shown in figs 7 a 9 we can see that different dl models have their different advantages thus lead to different results under experiments with different factors here we only discuss the transfer convlstm model with the best predictive performance which is shown in fig 7 regarding the impact of sm values on predictive performance sm prediction worsened when sm increased and improved when sm is greater than 36 this result was consistent with figs 1 3 a 4 and a 5 from fig 3 we can see that dl models can achieve better predictive performance over some regions in western and southern china it is noteworthy that the sm in these areas is either high or low corresponding to fig 7 a furthermore the transfer convlstm based sm predictions showed smaller bias ranges than the convlstm based sm predictions without transfer learning especially when sm is larger than 20 and smaller than 36 indicating that the former performed better in terms of the impact of soil temperature on predictive performance generally sm predictions had a little improvement as the soil temperature increased but the predictive performance oscillated a lot when the soil temperature was higher than 19 for convlstm without transfer learning the reason may be that the increasing of soil temperature reduces the viscosity of the water thus allowing more water to infiltrate through the soil profile and further decreasing the sm fierer et al 2005 which make the predictive ability worse however the regions with soil temperatures above 19 c are always located in southern china see fig a 10 where sm is relatively high see fig 1 these regions had a larger bias see fig 3 regarding the impact of season on predictive performance the transfer convlstm based sm predictions outperformed the convlstm based sm predictions due to their similar ranges but lower bias in sm across most seasons however the dl model without transfer learning method had outperformed transfer dl model in winter the reason may be that smap sm cannot describe well about the land in icy conditions during winter seasons but the opposite is true for the era5 land sm this leads to large variations in spatial distribution between the two datasets and further affect the predictive performance of transfer learning methods in terms of the impact of precipitation on predictive performance the predictive performance had increased with the increasing of precipitation the transfer convlstm based sm predictions outperformed the convlstm based sm predictions under most precipitation condition hence the above analysis revealed the differing performances of sm predictions under various levels of factors in general after introducing transfer learning method dl models predictions can achieve better predictive performance in almost all cases 4 5 overall performance of transfer learning predictive models for smap with the original resolution the global sm at a low spatial resolution may restrict its application at local areas wei et al 2019 hence to explore the influence of smap with higher spatial variability on transfer learning predictive models we tested the transfer convlstm model and the convlstm model without transfer learning for smap with the original spatial resolution 0 1 0 1 at the lead time of 3 days in this study we selected a wet coastal area 30 8 35 n 116 122 w and a dry western area 80 5 86 5 n 41 5 46 3 w as our study areas which both have 50 65 grid points in these two domains the experimental setup for the convlstm based predictive model is the same as that in section 3 3 figs 8 and 9 represent the predictive performance of transfer convlstm and convlstm without transfer learning in a dry western area and a wet coastal area fig 8 shows that transfer convlstm with the original spatial resolution achieved a worse rmse 0 025 for the original spatial resolution and 0 023 for the low spatial resolution and r2 0 856 for the original spatial resolution and 0 939 for the low spatial resolution than those for smap with the lower spatial resolution fig 9 shows that transfer convlstm with the original spatial resolution achieved a worse rmse 0 041 for the original spatial resolution and 0 035 for the low spatial resolution but a better r2 0 894 for the original spatial resolution and 0 82 for the low spatial resolution than those for smap with the lower spatial resolution this indicate that the performances of dl models were similar but also varied with different areas at different resolutions moreover from figs 8 to 10 we can still figure out that the transfer predictive model can also achieve the better predictive performance than that without transfer learning even for the smap product with a much higher spatial resolution for transfer convlstm in the wet coastal area the general r2 increased about 6 3 and rmse decreased about 18 compared to convlstm without transfer learning while the general r2 increased about 4 and rmse decreased about 10 in the dry western area from fig 10 we can see that after introducing the transfer learning method convlstm can also achieve the better predictive performance in most regions especially within the purple rectangle which had an increase of over 15 in r2 in general the transfer learning predictive model can also improve the predictive performance for smap with higher spatial resolution 5 conclusion soil moisture active passive smap has significantly improved the measurement capability of surface soil moisture sm the accurate smap sm prediction has a huge challenge due to its insufficient data records in this article we apply the transfer dl models for smap sm prediction for the first time which is expected to use the knowledge of the era5 land reanalysis dataset to effective transfer on data from the smap product and further improve the predictive performance in our study we first test whether the most relevant dl models for hydrologic prediction cnn lstm and convlstm can be reliably achieved excellent predictive performance for daily smap sm with limited data size or not then we pre train the dl models based on the source domain era5 land and fine tune in target domain smap the experimental results indicate that the convlstm model achieved better predictive performance in china at the lead time of 3 5 and 7 days than cnn and lstm models the convlstm model can achieve the lowest rmse 0 0297 0 0297 and 0 0283 and the highest r2 0 876 0 874 and 0 886 than other dl models over 3 5 and 7 days meanwhile the transfer convlstm model had the general r2 increased about 3 39 to 4 35 and rmse decreased about 15 55 to 18 18 compared with convlstm without transfer learning and the regression lines between predicted sm and observed sm were closer to the ideal line y x than all the other dl models additionally all performances of the transfer dl models were better than that of corresponding dl models without transfer learning finally the uncertainty of four factors lagged sm soil temperature season and precipitation were analyzed which can also affect the predictive performance in general sm prediction worsened when sm increases but improved when sm is greater 36 meanwhile when the soil temperature increases sm prediction had a little improvement but the predictive performance oscillated a lot when the soil temperature is higher than 19 moreover sm prediction improved as precipitation increased it is worth noting that the transfer dl model had worse predictive performance than dl model without transfer learning method in winter season finally we also tested transfer convlstm and convlstm without transfer learning for smap with the original spatial resolution at the lead time of 3 days in a wet area and a dry area the same conclusion can be conducted that transfer predictive models could obtain better performance than those without transfer learning this paper is an exploratory study to our knowledge which first explore transfer learning method in sm prediction especially for small data sets such as smap hence only one reanalysis dataset era5 land and simple fine tune method are tested to validate the effectiveness in fact sm related datasets include not only the reanalysis product but also outputs of land surface models such as vic nijssen et al 1999 clsm agnès et al 2000 and mos koster and suarez 1994 they all simulated sm over much longer time spans which are planned to explored for transfer learning method in the future meanwhile for transfer learning models in computer sciences generative models are designed to generate new data on the bias of existing dataset that make their distribution as close as possible and they have been widely used in various applications such as style transfer li et al 2020d chen et al 2019 and image synthesis li and wand 2016 nie et al 2017 hence we will also apply the adversarial extension of generative models as the fine tuning method by a compete process and further improve the predictive performance credit authorship contribution statement qingliang li conceptualization methodology software data curation writing original draft ziyu wang validation investigation software wei shangguan conceptualization formal analysis project administration writing review editing visualization supervision funding acquisition lu li investigation yifei yao investigation fanhua yu funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the study was partially supported by the natural science foundation of china grant number u1811464 and 41975122 in part by the jilin province science and technology development program grant number 2020c019 3 2019c039 1 and 2019c054 8 in part by the jilin province science and technology developing scheme grant number 20180201086sf in part by the provincial science and technology innovation special fund project of jilin province grant number 61604019 in part by the jilin provincial education department grant number jjkh20190499kj and in part by the natural science foundation of changchun normal university grant number 2019006 all resources of this paper including training and testing code and demo data are publicly available at https github com ljz1228 transfer learning soil moisture prediction appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2021 126698 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
4434,the skillful soil moisture sm for the soil moisture active passive smap l4 product can provide substantial value for many practical applications including ecosystem management and precision agriculture deep learning dl models provide powerful methods for hydrologic variables prediction such as sm however the sample size of daily sm in the smap product is quite small which may lead to overfitting and further impact the accuracy of dl models from this we first tested whether excellent predictive performance can be achieved with limited smap samples by the convolutional neural networks cnn long short term memory lstm and convolutional lstm convlstm models which are frequent used for hydrologic prediction then we pre trained the dl models in the source domain era5 land and fine tuned them in the target domain smap the results show that the transfer convlstm model had the highest r2 ranging from 0 909 to 0 916 and the lowest rmse ranging from 0 0239 to 0 0247 for the lead time of 3 5 and 7 days and the regression lines between the predicted and the observed sm were closer to the ideal line y x than all the other dl models all the performances of transfer dl models were better than those of their corresponding dl models without transfer learning and some regions witnessed an increased explained variation over 20 the predictive ability of different factors i e lagged sm soil temperature season and precipitation has been widely discussed in this paper according the results we advocate for applying cross source transfer learning with dl models for sm prediction in newly built datasets keywords soil moisture deep learning transfer learning small sample smap machine learning 1 introduction soil moisture sm is a key state variable in climatological hydrological and ecological systems coupling atmospheric processes to land surface states entekhabi et al 1996 it also plays a major role in many applications such as weather forecasts koster 2004 and flood potential assessment norbiato et al 2008 thus accurate prediction of sm has substantial value for providing guidance for disaster response irrigation and other scientifically applications dirmeye et al 2006 recently the measurement ability of surface sm has been promoted due to several satellite missions entekhabi et al 2010 thereinto the soil moisture active passive smap has been given considerable attention and significantly improved the measurement capability of surface sm hence many workshave focused on the smap prediction for exploring the predictability of surface sm fang et al 2017 fang and shen 2020 meanwhile sm has the substantial spatiotemporal variability due to its complex dependency on different related hydrologic variables and land surface conditions e g precipitation soil temperature and evapotranspiration currently hydrologic variables are commonly simulated based on process based models such as land surface models hydrology models and earth system models which relies on governing equations with the complex mechanism of land atmosphere feedbacks kalakuntla et al 2013 the limitations for process based models are underrepresentation of key processes and human activities and the high computational costs markus et al 2019 with the help of increasing computation power big data accumulated over decades and wonderful achievements in deep learning dl data driven dl models can be realized without knowledge on complex mechanism of physic model and have great potential in improving the prediction and achieving a better understanding of the land atmosphere interactions irrgang et al 2021 the most relevant dl models for hydrologic prediction are classified as three categories spatial models convolutional neural networks cnn by lecun and bengio 1995 temporal models long short term memory networks lstm by hochreiter and schmidhuber 1997 and spatial temporal models convolutional lstm convlstm by shi et al 2015 cnns are constructed to deal with data in the multiple arrays and excellent in extracting spatial features for hydrologic variables sobayo et al 2018 applied cnn based model to establish the relationship between sm and temperatures of the target plants from the thermal infrared images for in situ sm prediction pan et al 2019a improved the predictive performance of rainfall from weather models by cnn based model lstms are designed to process sequence data and widely applied for predicting time series data in earth system science fang and shen 2020 captured the interannual trends of sm by lstm and improved the smap l3 prediction li et al 2020c combined the units in different steps as the output layer in an lstm structure for improving in situ soil temperature prediction convlstm is a relative novel model for hydrologic variables prediction it can not only get temporal relationship but also extract spatial features through convolution layer in this way convlstm can extract temporal and spatial features spatiotemporal features at the same time and the switching between states is also replaced by convolution operation convlstm model is applied in rainfall nowcasting for the first time by shi et al 2015 and can reproduce the spatiotemporal properties of short term rainfall fields mohamed et al 2021 explored the sm predictivity using the spatial temporal model and demonstrated that convlstm had better predictive performance than cnn based and lstm based models in sm prediction in this study we will assess the capacity of these three models for smap prediction although the smap product is considered as a huge contribution for sm measurement smap observations only have a short revisit time 2 3 days and time span launched in 2015 which make the total number of daily sm samples quite small less than 2300 until 2020 and hardly to observe the longer response of sm as we known in computer sciences the enormous training sets more than ten thousand become necessary which can avoid overfitting and further improve the accuracy of dl models shin et al 2016 zhuang et al 2019 unfortunately smap observations are quite sparse questions arise regarding whether the most relevant dl models can reliably achieve excellent predictive performance for sm and what methods can assist the dl models to get a better predictive ability for sm with insufficient data records transfer learning are commonly dl approaches for the lack of suitable datasets it mainly transfers the knowledge contained in similar but not equivalent source domains for improving the performance of dl model on target domains in this way the excellent dl model is expected to be constructed for predicting the smap observations with limited data size contrast to smap product s limited time span land reanalysis datasets for example cfsr saha et al 2010 saha et al 2014 merra 2 gelaro et al 2017 era interim douville et al 1998 and era5 hersbach et al 2018 can simulate global sm over much longer time spans among these products era5 land combined more historical observations and has a finer resolution for simulating sm which is corrected by an empirical approach meanwhile it covers the period from 1979 to present hersbach et al 2018 as era5 land has higher skills than other products significant improvement over its predecessor and longer time spans li et al 2020b we focus on the era5 land reanalysis dataset as our source domain for exploring the improvement of smap prediction based on transfer learning model although era5 land has played vital roles for exploring climate change significant differences from observations existed the differences are commonly accompanied by soil depths models and systematic patterns in them hence it is noteworthy that whether the information obtained from era5 land can be effective transferred to smap no study to our knowledge explored transfer learning method in sm prediction especially for small data sets such as smap the above studies and discussions motivated our proposal of a transfer deep learning model for the problem of the limited data size for smap sm prediction the basic hypothesis of this study is that with only less than 5 years of daily smap data the number of samples is less than 2300 transfer learning based on era5 land over long time spans and most relevant dl models for hydrologic prediction can improve the predictive performance to a certain extent our contributions are offered as following 1 we verify whether the most relevant dl models for hydrologic prediction cnn lstm and convlstm can reliably achieved excellent predictive performance for daily smap sm with limited data size or not 2 we verify whether the information obtained from era5 land can be effective transferred to smap and further improve the predictive performance for daily smap sm or not 3 we intuitively display and analysis the performance of predictive model with different values of sm precipitation soil temperature and seasons and it is expected to be instructive for the researchers to improve the predictive performance for sm intentionally and strategically the rest of this paper was organized as follows the study area china smap and era5 land were introduced for this study in section 2 the background knowledge of the transfer learning and relevant dl models cnn lstm and convlstm were described in section 3 in section 4 we presented and discussed the experimental results for smap sm based on dl models and transfer dl models finally concluding remarks were presented in the final section 2 data 2 1 study area and smap product china 3 54 n 72 126 w was restricted as the study domain the smap l4 product was selected as the target domain to test the sm predictive ability of transfer dl models it contains top 5 cm sm with a relatively low standard deviation of 4 cm3 cm3 fang et al 2017 and various of related land surface variables e g model parameters and surface meteorological forcing data which are at about 9 km spatial resolution and 3 h temporal resolution reichle et al 2020 the smap l4 product are the merged information of land surface model estimates and smap brightness temperature observations by a spatially distributed ensemble kalman filter entekhabi et al 2010 as the smap brightness temperatures can be effectively propagated into the land surface model during the data assimilation process the smap l4 product is consistent with the available smap satellite observations additionally the smap sm prediction have demonstrated that it had an important impact on forecasting the streamflow response to future rainfall events which is valuable for observing dynamics of generating sm crow et al 2019 the predictability of sm was commonly affected by its own persistence or other external forcing factors hence the sm memory lagged sm precipitation and soil temperature were selected as our input features for dl model due to their frequent usage for sm prediction pan et al 2019b li et al 2018 however it should be noted that there are other features such as air temperature vegetation conditions and soil properties which can be incorporated into dl models for possible improvements we used only three factors for simplicity and efficiency all the applied data in this study is daily time scale during the period from april 1 2015 to december 8 2020 the number of samples is 2080 for our experiment the training dataset is from april 1 2015 to december 7 2018 for fitting the dl model the validation set is from december 8 2018 to december 7 2019 for tuning the hyperparameters for avoiding overfitting to the training dataset the test dataset is from december 8 2019 to december 8 2020 for evaluating the performance of dl models on unseen data during training at the same time the raw dataset had so high resolutions about 0 1 with 617 685 grid points in china domain that cannot be handled for dl models due to the gpu memory constraints previous studies have already demonstrated that the predictive performance at higher resolutions has small difference with that at a coarser resolution rasp et al 2020 considering our gpu memory in training the predictive model we used the dataset at a coarser resolution to the maximum extent possible hence we regridded all variables to lower resolutions about 1 with 52 65 grid points in china domain by the xesmf python package for testing dl models fig 1 a presented the spatially distribution of the average smap sm in addition we also tested dl models with the smap data in two areas at its original resolution which is shown in section 4 5 2 2 era5 land reanalysis dataset the era5 land reanalysis dataset was selected as the source domain to verify our model different from era5 era5 land is generated by reanalysis the land portion of european center for medium weather forecasting ecmwf based on the physical laws the model data is combined with the observation data from all over the world for generating a global complete and consistent data set it can go back decades and give the best suppose in the future time cao et al 2020 due to previous evaluation studies beck et al 2020 era5 land has superior accuracy than most other sm datasets from model outputs remote sensing and reanalysis era5 land and smap have similar characteristics which both generated by similar physical laws and have spatially varying bias which are commonly accompanied by soil depths models and systematic patterns in them these characteristics are proven to be suitable for transfer dl models zhuang et al 2019 the raw data of era5 land for the time period in this study are from january 1 1980 to december 8 2020 the number of daily samples is 14 610 and the spatial resolution is 0 1 in china domain in layer 1 0 7 cm all data are interpolated to the lower resolution about 1 with 52 65 grid points in china domain as the same as smap meanwhile era5 land is split into two parts the training and validation sets as the motivation of our study is to apply the knowledge of era5 land to transfer on data from smap product we don t care about the predictive performance of dl models on era5 land hence the test set of era5 landis not necessary in our study the training dataset is from january 1 1980 to december 7 2019 and the validation dataset is from december 8 2019 to december 8 2020 the spatially distribution of the average era5 land sm from april 1 2015 to december 8 2020 is presented in fig 1 b according to the fig 1 we can conclude that era5 land tends to be underestimated on the arid western and north central china and be overestimated in the wet southern and northeast china theses difference patterns in them could be a basis for improving predictions 2 3 statistical characteristics of sm the statistical characteristics of the sm of smap and era5 land in the eight climatic zones from april 1 2015 to december 8 2020 is presented in table 1 for the minimum sm the lowest value appeared in the arid desert cold climate zone for smap 0 009 m3 m3 but appeared in many climate zones for era5 land 0 0005 m3 m3 which seems to be set as the lower boundary in era5 land for the maximum sm the highest value appeared in the temperate no dry season hot summer climate zone for smap 0 5078 m3 m3 but appeared in the arid steppe cold climate zone for era5 land 0 7598 m3 m3 meanwhile era5 land had higher maximum values and lower minimum values than smap at the same time the standard deviation of the temperate dry winter hot summer climate zone 0 1174 m3 m3 was the largest which indicates a lager annual variation of sm in this climate zone the differences between climate zones are related to the precipitation changes evapotranspiration and land surface conditions it should be noted that era5 land had larger standard deviations than smap for all climate zone except for temperate dry winter warm summer climate zone fig 1 c denotes that most areas had a positive correlation between smap and era5 land sm during the same period indicating that overall the sm in the two datasets had roughly similar trends of temporal variation this may have benefits for improving predictive performance based on transfer learning method 3 methods we explored the transfer dl models for smap sm prediction and the topological structure for sm prediction is represented in fig 2 the presented structure consists of two key pipelines dl models without transfer learning and transfer dl models the first pipeline only focuses on the target domain which aimed at verifying whether the cnn lstm and convlstm can reliably achieved excellent predictive performance for daily smap sm with limited data size or not the highlight of second pipeline is with both the source and target domain which was designed to verify whether the information obtained from era5 land can be effective transferred to smap and further improve the predictive performance or not we first pre trained the dl models based on the source domain era5 land and then fine tuned them in the target domain smap finally the error criteria including bias root mean square rmse and determination coefficient r2 were computed for evaluating the predictive performance of dl models at 3 5 and 7 days lead time r2 denotes the degree of model fitting the extent to which the dl models can interpret the data and rmse shows the ability to predict volatility these criteria are defined as follows 1 rmse i 1 n y i y i 2 n 2 r 2 1 e i 1 n y i y i 2 e i 1 n y i y i 2 where y i is the truth value of the i th timesteps in the dataset era5 land or smap and y i is the predicted value of the i th timesteps by dl models and y i is the average value of the truth value all the variables were normalized to reduce the effects of an absolute scale as follows 3 x norm x x min x min x max where x x max x min x norm are the original maximum minimum and normalized values on the grid from training data we perform the experiments on a server with an intel core i7 10750h cpu with 2 60 ghz ram and geforce rtx 2060 gpu running pycharm 2018 1 4 pytorch is the backend in our experiments 3 1 convolutional neural network cnn is a classical data driven dl model which can extract discriminative spatial features from images with sufficient samples lecun and bengio 1995 in our study we apply the simple dl models since we only focus on exploring whether fine tune method can assist dl models to improve predictive accuracy rather than exploring structural optimization of dl models fig a 1 shows the experimental setup for the simple cnn based predictive model in this study in this setup the input data is consisted of sm precipitation and soil temperature variables at t t 1 and t 2 days meanwhile the variables are feature maps of 52 65 size hence the input size in the predictive model is 9 52 65 the output is the predicted soil moisture on t n day in the future n 3 5 7 represent the predicted sm on 3rd 5th and 7th day in the future and the size is same as the inputs for cnn based model the first convolutional layer has 48 channels the size of kernel the padding and the stride are 3 0 and 3 respectively the default rectified linear unit relu activation function is used in this layer after operation in the convolutional layer the input data is converted to the feature map whose size is 48 17 21 finally the predicted sm on t n day in the future is obtained by the fully connected layer based on the feature map convolution takes local features and fully connected layers is to assemble the previous local features into a complete graph through the weight matrix to fairly compare the predictive performance of all dl models all the top layer is changed from softmax loss layer to euclidean loss layer because of regression task in sm prediction iteration number is empirically set to 50 batch size is set to 128 and the model is trained with adam optimizer because we found that larger iteration and smaller batch size didn t improve the result a lot but with higher computing costs 3 2 long short term memory model lstm is also a classical data driven dl model which can make full use of sequential information hochreiter and schmidhuber 1997 in time series data it can take the output on the previous step as the input allowing information from the previous moment to be stored in the memory gate and further influence the output on the next moment and thus can capture long term trends of sm and further be successfully applied in sm prediction fang and shen 2020 fig a 2 shows the experimental setup for the simple lstm based predictive model in this study in this setup the input is a four dimensional tensor and the input variables are the same as those in cnn based predictive model whose shape is 3 3 52 65 the dimension of each input timestep is 3 t 2 t 1 and t days the input data consist of 3 variables sm precipitation and soil temperature and the variables are feature maps of 52 65 size the output is the same as that in cnn based predictive model the input data is first reshaped as a two dimensional tensor and the size is 3 3 52 65 for lstm based predictive model the hidden size is set to52 65 finally the predicted sm on t n day in the future is obtained by the fully connected layer based on the output at t day of lstm it is expected to capture the long term temporal feature on the previous timestep inputs and the short term temporal feature on the last timestep inputs 3 3 convolution long short term memory model the core of convlstm like lstm takes the output of the previous layer as the input of the next layer the difference is that after adding convolution operation convlstm can not only get temporal relationship but also extract spatial features like convolution layer in cnn model several studies have focused on the spatial and temporal features and proved to be effective in different applications for example shi et al 2015 proposed convlstm model for rainfall nowcasting which can extract both temporal and spatial features at the same time and the switching between states is replaced by convolution operations wang et al 2019 combined 3d cnn with lstm model for video prediction which incorporate the convolutional features into the recurrent state transition over time and they denoted that the proposed method could effectively model the spatial features in a consecutive manner and had better predictive performance than the convlstm model which is proposed by shi et al 2015 hence the 3d cnn with lstm model is also conducted in our study which has similar predictive performance with convlstm model not exhibits in our study the related code of the 3d cnn with lstm model is also publicly available at https github com ljz1228 transfer learning soil moisture prediction the convlstm model is selected as the predictive model due to its sophisticated network structure it is expected to capture both spatial and temporal features in sm and further improve predictive performance fig a 3 shows the experimental setup for the simple convlstm based predictive model in this study in this setup the sm at the future day n t is predicted based on the sequence input features at the days t t 1 and t 2 which is the same as that in lstm based predictive model representing the dimension of each input timestep meanwhile the input and the output data are also the same as that in lstm based model for convlstm based model the number of convlstm layers is 2 and the number of filters in each convlstm layer is 16 and 8 respectively the size of kernel is 3 and the default hyperbolic tangent tanh activation function is used the same padding method is considered for keeping the size of feature maps 52 65 as the same as that of the input sm finally the fully connecting layer is applied to predict sm based on the output data at t day of convlstm 3 4 transfer learning for smap in computer sciences although dl models have achieved amazing performance in various of applications e g image recognition krizhevsky et al 2012 farabet et al 2013 and speech recognition mikolov et al 2011 hinton et al 2012 the limitations exist in certain cases the commonly applied dl models usually need abundant training samples which have the same statistical distribution as the test dataset unfortunately such adequate training samples are unrealistic in many cases due to the time consuming and expensive for collecting samples this may lead to overfitting of the dl models and further affect predictive performance previous studies hu et al 2016 huang et al 2020 bashar and nayak 2021 have proved that transfer learning models can solve this problem which can effectively transfer knowledge of source domain abundant samples to target domain limited samples to our knowledge no studies have been conducted on the transfer learning method in sm prediction especially for small data sets such as smap product in this study we mainly verify the effectiveness of transfer learning for predicting smap sm with limited data size hence the simple fine tune method is applied in our model more complex transfer learning methods such as applying the adversarial extension of generative models li et al 2020d need further investigations for improving the predictive performance the definitions of transfer learning in our study are as follows domain our datasets smap and era5 land are referred as the domain d d x p x which contains feature space x and a marginal distribution p x the x is defined as x x x i x i 1 n which shows a selected dataset the n denoted the total number of the selected dataset task the learning process for dl models can be understood as task t which composed of a label space y sm in the selected dataset and a learning function f dl model the f is aimed at learning the knowledge from selected samples in this study a source domain ds corresponding to a source task ts is basically reviewed by the input feature observed sm pairs in era5 land such as d s x y x i x s y i y s i 1 n s smap is used as the target domain which consists of limited number of samples transfer learning the observations about the source domain era5 land and task can be defined as d s i t s i i 1 m s m s n and the observations corresponding to the target domain smap and task can be defined as d t r i t t r i i 1 m t m t n the knowledge of era5 land is transferred to improve the predictive performance of dl models cnn lstm and convlstm f t r j j 1 m t on smap 4 results and discussion 4 1 overall performance of dl models without transfer learning we first applied cnn lstm and convlstm models to predict smap sm for verifying whether the most relevant dl models for hydrologic prediction can reliably achieved excellent predictive performance for daily smap sm with limited data size or not the performance of cnn lstm and convlstm models without transfer learning at the lead time of 3 5 and 7 days are shown in figs 3 a 4 and a 5 overall convlstm had the lowest bias 0 00186 0 00119 and 0 00148 in average the lowest rmse 0 0297 0 0297 and 0 0283 in average and the highest r2 0 876 0 874 and 0 886 in average compared with cnn and lstm and they had similar spatial patterns of these three metrics all the dl models had low bias for prediction in most area of china within the range of 0 036 similar to era5 land all dl models tended to underestimate in the arid region of northwest china and overestimate in the east and south of china however overestimation also appeared in south china especially for lstm regarding the rmse it is worth pointing out that the northeast and central china had relative larger errors than other regions for convlstm while the northwest china had smaller errors in addition cnn had relative larger error than lstm and convlstm in the southern and northeast china usually the regions with a high r2 had a low rmse and vice versa in general convlstm achieved better predictive performance than cnn and lstm at the lead time of 3 5 and 7 days because convlstm can capture the information of both temporal and spatial dimensions more effectively and according to the rmse and r2 values achieved by dl models we can conclude that the relevant dl models for hydrologic prediction can reliably achieved well predictive performance for daily smap sm with limited data size in computer science such small number of samples will lead to overfitting for training the dl models and further affect the performance zhuang et al 2019 which is different with our smap sm prediction the reason may be that the samples in computer science for training dl models are commonly more complex and diversified than that in earth system science as processes governing the hydrologic variables such as sm are universal taking identifying what animal is depicted in an image as an example due to the large variability in the appearance of different animals sufficient samples are needed to train dl models for learning to discriminate features however in our study training samples for dl models are the map of land surface variables which all have a highly similar appearance hence the large number of samples are not needed for learning to discriminate features of sm but this does not mean that the transfer learning method have no or little impact on smap sm prediction which will be discussed in the next section although a relative good predictive performance can be achieved by dl models certain areas had relatively poor prediction such as the central and northeast china 4 2 improvements of transfer dl models we first pre trained the above dl models based on era5 land and then fine tuned them based on smap for fair comparison all the hyper parameters are set as the same as dl models without transfer learning figs 4 a 6 and a 7 show the density scatter plot of the predicted and observed sm using all the applied dl models from the above figures we can figure out that the best dl models for smap sm prediction was the transfer convlstm model which had the highest r2 ranging from 0 909 to 0 916 the lowest rmse ranging from 0 0239 to 0 0247 at the lead time of 3 5 and 7 days and the regression lines between predicted sm and observed sm were closer to the ideal line y x than the other dl models additionally all the performances of transfer dl models were better than those of corresponding dl models without transfer learning for transfer convlstm at different lead time the general r2 increased about 3 39 to 4 35 and rmse decreased about 15 55 to 18 18 compared with convlstm without transfer learning transfer cnn had more visible improvements than the single cnn the general r2 increased about 10 47 to 12 59 and rmse decreased about 24 11 to 31 48 we can draw the same conclusion for transfer lstm which had 4 36 to 7 99 improvement in r2 and 14 2 to 22 26 in rmse compared with the single lstm dynamic of sm is spatial different in different regions for example strong local positive sm precipitation feedback has impact on the future precipitation and sm li et al 2020a and further influences the sm prediction hence the improvements over different regions were investigated as shown in the above the map of r2 was consistent with the map of rmse we only show the performance variations of r2 in spatial distribution between transfer dl models and dl models without transfer learning in figs 5 and a 8 these figures show that the same predictive dl models have the highly similar variations in spatial distribution at different lead time hence we only discuss the performance variations of r2 in spatial distribution at the lead time of 3 days in fig 5 it is worth noting that even the improvement of the general r2 is limited after the application of transfer learning method the improvement in some area is relative obvious for example transfer convlstm improved the general r2 by less than 5 but it achieved better predictive performance in most regions especially in northeast central and southern china which had increased over 20 of r2 hence sm predicted based on transfer learning method can provide an important reference value for improving sm prediction considering that a simple fine tune strategy was adopted in this work more complex transfer learning methods have good potential in improving the performance further however some regions in north and southwest china witnessed a slight decline in r2 compared with transfer convlstm model cnn and lstm models with transfer learning both had more significant improvements in most regions in general after introducing the transfer learning method relevant dl models for hydrologic prediction can improve predictive performance for smap at different lead time meanwhile although the differences are commonly accompanied by soil depths models and systematic patterns between era5 land and smap we can still demonstrate that the information obtained from era5 land can be effective transferred to smap and further improve the predictive performance 4 3 the sensitivity analysis of different inputs for predictive model to explore the sensitivity of different inputs for predictive model we designed seven experiments to test the predictive performance of convlstm based on different input data seven groups of input variables were applied to fit convlstm for the sm on the 7th day prediction in the future from experiment i to vi the sm precipitation and soil temperature were all selected as our input features for convlstm meanwhile the 1 to 4 lagged input features were applied to test the sensitivity of different lagged inputs in experiment v vi and vii we removed sm soil temperature and precipitation from input data based on the 3 lagged experiment respectively we designed these experiments to investigate the effect of different explaining variables on the predictability of sm fig 6 represents the predictive performance of convlstm based on different input data on the 7th day prediction in the future for experiment i to vi with the increasing of lagged input features the performance increased gradually however when the 4 lagged input features were used to fit the predictive model the predictive performance only varied slightly and even decreases in addtion the numbers of 4 lagged input features for predictive model led to more computational time hence the 3 lagged input features are the best choice for our study on the other hand we also explored the sensitivity of different explaining variables from experiment v to vii for experiment v to vii by reducing one of the three explaining variables the predictive accuracy of convlstm would decrease the predictive accuracy decreased significantly especially for convlstm without sm hence the three explaining variables were all important for predictive performance in sm the reason is that the soil temperature is related to the fluxes of outgoing longwave sensible and ground heat which can further affect the sm venkat et al 2003 strong local positive sm precipitation feedback may further influence the generation of precipitation and sm li et al 2020a sm memory can remember a wet or dry anomaly long after the conditions responsible for the anomaly are forgotten by the atmosphere pan et al 2019b 4 4 the impact on different factors in the previous study pan et al 2019b we could know that the lagged sm precipitation season and soil temperature had the important roles for sm prediction however the uncertainty of these factors can also affect the predictive performance to show the influence of different factors lagged sm precipitation season and soil temperature on smap sm prediction the uncertainty of smap sm predictions related to these factors based on different dl models are shown in figs 7 a 9 we can see that different dl models have their different advantages thus lead to different results under experiments with different factors here we only discuss the transfer convlstm model with the best predictive performance which is shown in fig 7 regarding the impact of sm values on predictive performance sm prediction worsened when sm increased and improved when sm is greater than 36 this result was consistent with figs 1 3 a 4 and a 5 from fig 3 we can see that dl models can achieve better predictive performance over some regions in western and southern china it is noteworthy that the sm in these areas is either high or low corresponding to fig 7 a furthermore the transfer convlstm based sm predictions showed smaller bias ranges than the convlstm based sm predictions without transfer learning especially when sm is larger than 20 and smaller than 36 indicating that the former performed better in terms of the impact of soil temperature on predictive performance generally sm predictions had a little improvement as the soil temperature increased but the predictive performance oscillated a lot when the soil temperature was higher than 19 for convlstm without transfer learning the reason may be that the increasing of soil temperature reduces the viscosity of the water thus allowing more water to infiltrate through the soil profile and further decreasing the sm fierer et al 2005 which make the predictive ability worse however the regions with soil temperatures above 19 c are always located in southern china see fig a 10 where sm is relatively high see fig 1 these regions had a larger bias see fig 3 regarding the impact of season on predictive performance the transfer convlstm based sm predictions outperformed the convlstm based sm predictions due to their similar ranges but lower bias in sm across most seasons however the dl model without transfer learning method had outperformed transfer dl model in winter the reason may be that smap sm cannot describe well about the land in icy conditions during winter seasons but the opposite is true for the era5 land sm this leads to large variations in spatial distribution between the two datasets and further affect the predictive performance of transfer learning methods in terms of the impact of precipitation on predictive performance the predictive performance had increased with the increasing of precipitation the transfer convlstm based sm predictions outperformed the convlstm based sm predictions under most precipitation condition hence the above analysis revealed the differing performances of sm predictions under various levels of factors in general after introducing transfer learning method dl models predictions can achieve better predictive performance in almost all cases 4 5 overall performance of transfer learning predictive models for smap with the original resolution the global sm at a low spatial resolution may restrict its application at local areas wei et al 2019 hence to explore the influence of smap with higher spatial variability on transfer learning predictive models we tested the transfer convlstm model and the convlstm model without transfer learning for smap with the original spatial resolution 0 1 0 1 at the lead time of 3 days in this study we selected a wet coastal area 30 8 35 n 116 122 w and a dry western area 80 5 86 5 n 41 5 46 3 w as our study areas which both have 50 65 grid points in these two domains the experimental setup for the convlstm based predictive model is the same as that in section 3 3 figs 8 and 9 represent the predictive performance of transfer convlstm and convlstm without transfer learning in a dry western area and a wet coastal area fig 8 shows that transfer convlstm with the original spatial resolution achieved a worse rmse 0 025 for the original spatial resolution and 0 023 for the low spatial resolution and r2 0 856 for the original spatial resolution and 0 939 for the low spatial resolution than those for smap with the lower spatial resolution fig 9 shows that transfer convlstm with the original spatial resolution achieved a worse rmse 0 041 for the original spatial resolution and 0 035 for the low spatial resolution but a better r2 0 894 for the original spatial resolution and 0 82 for the low spatial resolution than those for smap with the lower spatial resolution this indicate that the performances of dl models were similar but also varied with different areas at different resolutions moreover from figs 8 to 10 we can still figure out that the transfer predictive model can also achieve the better predictive performance than that without transfer learning even for the smap product with a much higher spatial resolution for transfer convlstm in the wet coastal area the general r2 increased about 6 3 and rmse decreased about 18 compared to convlstm without transfer learning while the general r2 increased about 4 and rmse decreased about 10 in the dry western area from fig 10 we can see that after introducing the transfer learning method convlstm can also achieve the better predictive performance in most regions especially within the purple rectangle which had an increase of over 15 in r2 in general the transfer learning predictive model can also improve the predictive performance for smap with higher spatial resolution 5 conclusion soil moisture active passive smap has significantly improved the measurement capability of surface soil moisture sm the accurate smap sm prediction has a huge challenge due to its insufficient data records in this article we apply the transfer dl models for smap sm prediction for the first time which is expected to use the knowledge of the era5 land reanalysis dataset to effective transfer on data from the smap product and further improve the predictive performance in our study we first test whether the most relevant dl models for hydrologic prediction cnn lstm and convlstm can be reliably achieved excellent predictive performance for daily smap sm with limited data size or not then we pre train the dl models based on the source domain era5 land and fine tune in target domain smap the experimental results indicate that the convlstm model achieved better predictive performance in china at the lead time of 3 5 and 7 days than cnn and lstm models the convlstm model can achieve the lowest rmse 0 0297 0 0297 and 0 0283 and the highest r2 0 876 0 874 and 0 886 than other dl models over 3 5 and 7 days meanwhile the transfer convlstm model had the general r2 increased about 3 39 to 4 35 and rmse decreased about 15 55 to 18 18 compared with convlstm without transfer learning and the regression lines between predicted sm and observed sm were closer to the ideal line y x than all the other dl models additionally all performances of the transfer dl models were better than that of corresponding dl models without transfer learning finally the uncertainty of four factors lagged sm soil temperature season and precipitation were analyzed which can also affect the predictive performance in general sm prediction worsened when sm increases but improved when sm is greater 36 meanwhile when the soil temperature increases sm prediction had a little improvement but the predictive performance oscillated a lot when the soil temperature is higher than 19 moreover sm prediction improved as precipitation increased it is worth noting that the transfer dl model had worse predictive performance than dl model without transfer learning method in winter season finally we also tested transfer convlstm and convlstm without transfer learning for smap with the original spatial resolution at the lead time of 3 days in a wet area and a dry area the same conclusion can be conducted that transfer predictive models could obtain better performance than those without transfer learning this paper is an exploratory study to our knowledge which first explore transfer learning method in sm prediction especially for small data sets such as smap hence only one reanalysis dataset era5 land and simple fine tune method are tested to validate the effectiveness in fact sm related datasets include not only the reanalysis product but also outputs of land surface models such as vic nijssen et al 1999 clsm agnès et al 2000 and mos koster and suarez 1994 they all simulated sm over much longer time spans which are planned to explored for transfer learning method in the future meanwhile for transfer learning models in computer sciences generative models are designed to generate new data on the bias of existing dataset that make their distribution as close as possible and they have been widely used in various applications such as style transfer li et al 2020d chen et al 2019 and image synthesis li and wand 2016 nie et al 2017 hence we will also apply the adversarial extension of generative models as the fine tuning method by a compete process and further improve the predictive performance credit authorship contribution statement qingliang li conceptualization methodology software data curation writing original draft ziyu wang validation investigation software wei shangguan conceptualization formal analysis project administration writing review editing visualization supervision funding acquisition lu li investigation yifei yao investigation fanhua yu funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the study was partially supported by the natural science foundation of china grant number u1811464 and 41975122 in part by the jilin province science and technology development program grant number 2020c019 3 2019c039 1 and 2019c054 8 in part by the jilin province science and technology developing scheme grant number 20180201086sf in part by the provincial science and technology innovation special fund project of jilin province grant number 61604019 in part by the jilin provincial education department grant number jjkh20190499kj and in part by the natural science foundation of changchun normal university grant number 2019006 all resources of this paper including training and testing code and demo data are publicly available at https github com ljz1228 transfer learning soil moisture prediction appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2021 126698 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
