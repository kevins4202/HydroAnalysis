index,text
480,characterization of underground porous media parameters at the micro and macro scales is fundamental in geosciences a thorough comprehension of flow phenomena requires analyses and observations at the micro scale through adoption of micromodels as representative as possible of real geological formations in this paper we focus on the analysis of 2d binary images of real rock thin sections to characterize pore network geometry and to estimate effective porosity pore size distribution and tortuosity with the aim of providing suitable information for designing micromodels to this end a geometrical analysis of the pore structure based on the identification and characterization of the set of the shortest geometrical pathways between inlets and outlets pairs was implemented the geometrical analysis is based on a path finding algorithm derived from graph theory results provided by geometrical analysis were validated against hydrodynamic numerical simulation via the lattice boltzmann method lbm results show that the path finding approach provides reasonable and reliable estimates of tortuosity and can be successfully applied for analyzing the distribution of effective pore radius as well as for estimating the effective porosity keywords pore structure tortuosity lattice boltzmann method path finding algorithm effective porosity 1 introduction the characterization of fluid flow in underground porous media at the micro and macro scales is crucial in several areas such as in groundwater environmental and reservoir engineering and geosciences laboratory analyses on rock cores provide fundamental macroscale parameters such as porosity absolute and relative permeability and capillary pressure curves however a thorough comprehension of single and multiphase flow phenomena requires analyses and observations at the micro scale anbari et al 2018 blunt 2001 in this view a great opportunity is given by observation of flow phenomena in microfluidic devices designed as physical micromodels representing pseudo two dimensional capillary networks venturoli and boek 2006 multi scale studies associated with pore network properties are increasingly used to improve understanding of flow behavior in porous media at the phenomenological scale viggiani et al 2012 these include distribution of pores space micropore macropore connectivity constricted porosity by throats hysteresis fluid occupancy during multiphase or displacement processes wettability viggiani et al 2012 pore network rules liquid and gas permeability properties as well as water retention and electro chemical transport viggiani et al 2012 real geological formations are often characterized by high degree of heterogeneities and complexity of the pore network geometry that should be taken into account in the design of the micromodels wu et al 2012 in the current paper we explore the possibility of adopting a path finding algorithm for the characterization of pore structure geometry and connectivity with the aim of analyzing 2d binary images of rock samples representative or real geological formations and providing geometrical parameters that could be used in future works to design microfluidic devices the path finding algorithm has been applied to several real rock images and the results are validated through the application of simple 2d lbm simulations the lattice boltzmann method lbm is well suited for simulating fluid flow at the pore scale in complex geometries several authors used lbm to study the fluid flow at pore scale of micromodels synthetic porous media or real rock samples venturoli and boek 2006 and laleian et al 2015 used 2d lbm with single relaxation time srt to calculate the fluid flow in micromodels taking the third dimension into account by adding a drag force boek and venturoli 2010 used the same approach for studying the fluid flow in a quasi two dimensional micromodel based on the image of a berea sandstone wu et al 2012 compared single and multiphase flow by lbm simulation of a micromodel with results obtained by laboratory experiments koponen et al used the lga method to estimate permeability effective porosity koponen et al 1997 and tortuosity koponen et al 1996 in synthetic 2d porous media ghassemi and pak 2011 used lbm to study the effects of permeability and tortuosity on flow through 2d saturated particulate media and li et al 2018 studied the effect of geometrical properties on saturation and relative permeability in 2d synthetic porous media yang et al 2017 used 3d lbm for permeability assessment in random packed porous media comparison of single and multiple relaxation time mrt lbm for permeability assessment was performed in 2d synthetic porous media pan et al 2006 and 3d synthetic and real porous media eshghinejadfard et al 2016 ferreol and rothman 1995 with lbm simulated single phase and two phase flow through three dimensional tomographic reconstructions of fontainebleau sandstone xu and liu 2018 used lbm to investigate relative permeability and specific interfacial length by simulating immiscible two phase flow in 2d sample of berea sandstone porous media are complex materials characterized by a chaotic structure and tortuous fluid flow with pore and grains dimension varying over a wide range ghanbarian et al 2013a to address the crooked fluid paths of pore structure the concept of tortuosity τ was introduced carman 1937 two main types of tortuosity are defined in the literature geometrical tortuosity τg and hydraulic tortuosity τh geometrical tortuosity is defined as the shortest length between inflow and outflow points that avoids the solid obstacles divided by the distance between inlet and outlet adler 2013 clennell 1997 hydraulic tortuosity is defined as the effective path length taken by the fluid divided by the length of the porous material measured along the flow direction carman 1937 since the fluid flow path is always greater than the shortest geometrical path hydraulic tortuosity is always greater than the geometrical tortuosity clennell 1997 ghanbarian et al 2013a for a complete review on the definitions of tortuosity the reader can refer to clennell 1997 and to ghanbarian et al 2013a to account for pore space interconnections affected by the flow the effective porosity ϕe was introduced this property is defined as the percentage of conductive pore space with respect to the bulk volume ahmed 2010 koponen et al 1997 1 ϕ e v f l o w v b where vflow is the portion of volume contributing to the fluid flow the impact of pore network geometry on flow behavior is well recognized in the literature several analytic expressions have been provided koponen et al 1996 dullien 2012 scheidegger 1974 carman 1937 wyllie and spangler 1952 to link permeability to the pore structure as a function of porosity effective porosity tortuosity and or pore dimension and hydraulic radius rh which gives a measure of the average pore dimension corey et al 1977 bear 2013 several authors discussed the geometrical analysis of the pore structure from 2d and 3d images comparison of three image processing algorithms mean intercept length erosion and dilation watershed segmentation to estimate the grain size distribution of porous rocks from binary 2d images has been performed by rabbani and ayatollahi 2015 lock et al 2002 developed a network model that allows predictions of the permeability of consolidated sedimentary rocks based on image analysis of sections of a rock core sample lindquist et al 1996 discuss the medial axes method to analyze structure properties such as pore throat and pore body size distributions and geometric tortuosity of a 3d digitalized image later sun et al 2011 used a shortest past approach based on dijkstra s algorithm to calculate the geometric tortuosity and connected porosity then they applied a multiscale method approach to upscale the permeability ju et al 2018 proposed an algorithm to predict preferential flow paths based on the topologically equivalent network of a porous structure and the flow resistance of flow paths keller et al 2011 proposed a 3d graph representation to determine the spatial distribution of pore space geometrical properties in ghanbarian et al 2013a 2013b hunt and sahimi 2017 the authors proposed geometric tortuosity models based on concepts from finite size scaling analysis and percolation theory al raoush and madhoun 2017 presented an algorithm for calculating geometric tortuosity from 3d x ray tomography images of real rocks based on a guided search for connected paths utilizing the medial surface of the void space of a 3d segmented image in this paper we focus on methods to estimate from 2d binary images of a rock sample parameters which allows describing the pore structure to this end we applied an approach based on geometrical analysis of the porous media the geometrical approach was developed based on a a path finding procedure taken from the graph theory this approach was validated for the parameters of interest of the study with the more established hydrodynamic based path analysis carried out by numerical simulation via the lattice boltzmann method lbm a preliminary validation of the methodologies was carried out on a set of simplified synthetic cases for which the true value of the parameters of interest was analytically computed successively the methodologies were applied to images of real rock sample thin sections taken from literature 2 material and methods starting point for the presented methodologies is a 2d binary image of a rock section such data can be obtained by image processing of the scanning electron microscopy sem image of a thin section or the slice of an x ray micro tomography image preliminary image processing is beyond the scope of this paper however readers interested on the topic may consult vlahinic et al 2014 hashemi et al 2014 saladra and kopernik 2016 in this paper we analyzed a set of literature images obtained from thin sections of 3d samples of sedimentary rocks when necessary a preliminary image processing was applied to convert gray scale images to binary files see section 4 on the 2d binary image we analyzed the pore structure in terms of pathways accessible by fluid flow in monophase conditions and calculated the associated parameters tortuosity sections 2 3 2 and 2 3 3 and effective porosity section 2 3 4 two different approaches were applied to assess pathways geometrical section 2 1 and hydrodynamic section 2 2 the pore structure analysis was completed by calculation of pore radius variations along the path section 2 3 1 compared with the hydraulic radius which represents the pore radius of an equivalent capillary tube see eq 4 2 1 geometrical path calculation the pore structure of a binary 2d image is analyzed through a path finding method based on graph representation to this end a set of inlets nin and outlets nout are placed along the inner and outer boundaries of the image of the porous domain orthogonal to the main flow direction x or y the centroids of the pixels are used as reference grid node locations these locations represent the points where the fluid enters and potentially leaves the porous system respectively the shortest pathway between each couple of inlet outlet points is obtained through the path finding method a algorithm hart et al 1968 nilsson 1980 2014 a is based on a cost function f n to determine the optimal path between two nodes 2 f n g n h n where n indicates the considered node g n the incremental distance from the considered node to the initial node and h n is a heuristic function used to obtain a prior estimation to reach the target from the considered node the process of obtaining the optimal shortest path is achieved by steps starting at the initial node the cost function f n is calculated at each adjacent nodes in order to identify the one having the minimum cost which will be used as reference for the next calculation this process is progressively repeated until the target is reached the output is represented as a graph g n e with n being a set of nodes with x y coordinates while e the edges connecting the nodes fig 1 the application of a algorithm to the images gives a set of nin nout coordinates of the shortest paths in a fixed direction whose length lsh can be easily calculated by applying the euclidean distance 2 2 hydraulic path calculation hydraulic paths were obtained as a result of numerical simulation of monophase fluid flow at the pore scale to this end we implemented a discrete mesoscopic computational methods based on the lattice boltzmann method lbm the lbm is a relatively new computational fluid dynamics cfd method first appeared in the 1980s mcnamara and zanetti 1988 successively developed by several authors krüger et al 2017 and still subject of research activity the lbm has shown to be a functional technique for the computational modeling of a wide variety of complex fluid flow problems including single and multiphase flows in complex geometries benzi et al 1992 chen and doolen 1998 boek and venturoli 2010 and porous media guo and zhao 2002 use of the lbm to evaluate the hydraulic tortuosity in synthetic porous media was presented by nabovati and sousa 2007 matyka et al 2008 wang 2014 the implementation adopted in this paper for mono phase flow simulation in porous media is based on a single relaxation time srt approximation of the collision operator called the bhatnagar gross krook model bgk bhatnagar et al 1954 the relaxation time was set equal to 1 and the time step was calculated accordingly to guarantee stability conditions krüger et al 2017 the nine velocity square lattice model d2q9 qian et al 1992 was adopted to discretize the domain at the fluid solid interface no slip condition was imposed via halfway bounce back ladd 1994 fixed pressure gradient between inlet and outlet was assumed as the boundary condition which was implemented via non equilibrium bounce back zou and he 1997 no flow boundaries parallel to the main flow direction were assumed to reproduce laboratory conditions they were implemented with halfway bounce back ladd 1994 2 3 characterization of pore structure a quantitative microstructure characterization of the porous medium is carried out through the estimation of a series of parameters pore size section 2 3 1 tortuosity geometrical section 2 3 2 and hydraulic section 2 3 3 and effective porosity section 2 3 4 in the following we will not parametrize pore structure in terms of pore throat and pore body we will refer to the local aperture between the pore walls as pore size or to the semi aperture as pore radius 2 3 1 pore size along the geometrical pathways identified by a algorithm the pore size is calculated at each node location by measuring the extension of the pore section length orthogonal to the local path direction fig 1 the local pore size estimation allows monitoring the pore radius rp evolution along each detected path this information can be used for reconstructing 3d porous geometries øren and bakke 2003 soete et al 2017 or for comparative analysis with hydrodynamic data the output is also analyzed by a statistical representation of the pore radius distribution of the sample which is compared with the hydraulic radius rh defined as bear 2013 3 r h ϕ 3 d v b a w where vb is the bulk volume of the system pore and grain and aw is the wetted surface i e the surface area between grain and void transposing it to a 2d section it becomes 4 r h ϕ a b p w where ab is the bulk area of the sample and pw is the wetted perimeter i e the interface between grains and void which can be easily calculated by image processing routine we used the image processing toolbox of matlab mathworks 2017 the porosity ϕ in the 2d case might be different from the 3d porosity ϕ 3d 2 3 2 geometrical tortuosity the geometrical tortuosity τg within a porous medium in a given flow direction y is calculated through the ratio between the average of the shortest pathway lengths in that direction l sh y by the length of the system domain along the fluid direction ly dias et al 2006 sobieski and lipiński 2017 ghanbarian et al 2013a 5 τ g l s h y l y where l sh y is calculated as the average of the shortest pathway lengths calculated as in section 2 1 for the given flow direction y 2 3 3 hydraulic tortuosity hydraulic tortuosity was defined by carman 1937 as the ratio of the average length of the fluid paths divided by the length of the sample 6 τ h l h l clennell 1997 suggested a kinematical average in which the pathlines are weighted with fluid fluxes koponen et al 1996 suggested an approximated form 7 l h i 1 n l p r i v r i i 1 n v r i where n is a fixed number of streamlines lp ri is the path length of the ith streamline and v ri is the averaged tangential velocity of the fluid at the starting point of the ith streamline koponen et al 1996 suggested also to estimate tortuosity in a fixed direction y from the velocity field simulated with a cfd numerical simulator as 8 τ h v v y where v is the absolute value of the local flow velocity vy is the y component of that velocity and denotes the spatial average over the pore space we made use of a numerical simulator based on the lattice boltzmann method lbm to simulate the fluid flow in the porous media at the pore scale and obtain the velocity field and calculate the hydraulic tortuosity τh with eq 8 we also verified the invariance of calculated tortuosity with respect to the variation of the applied pressure gradient until laminar flow conditions are guaranteed re 2 aminpour et al 2018 where the reynolds number re was calculated as bear 2013 9 r e ρ v d c μ where dc is the characteristic length scale ρ and μ are the density and the dynamic viscosity of the fluid respectively there is not just one way to define the characteristic length in a porous medium which can be equal either to to the grain diameter bear 2013 or to the hydraulic diameter hydraulic radius ergun and orning 1949 ergun 1952 papathanasiou et al 2001 we adopted the image based definition introduced by mostaghimi et al 2012 and later proposed by blunt 2017 10 d c π v b a w π r h ϕ where vb is the total volume of the bulk system pore and grain and aw is the wetted surface eq 10 represents a sort of average grain size diameter 2 3 4 effective porosity for low porosity materials a large part of the total pore space may be nonconducting koponen et al 1996 the effective porosity ϕe is defined as the percentage of interconnected conductive pore space with respect to the bulk volume ahmed 2010 we proposed a purely geometrical calculation based on path finding 11 ϕ e n p p n p x where npp is the number of image pixels belonging to the portion of pore channels crossed by a pathway in x or y direction and npx the total number of image pixels to this end for each pathway all pixels comprised in the pore section orthogonal to the local path direction were considered see fig 1 for comparison the effective porosity can be calculated from a rock image by flow simulation koponen et al 1996 12 ϕ e n s n l where according to koponen et al 1996 ns is the number of grid cells crossed by streamlines and nl is the total number of grid cells to reduce the computational effort we calculated the effective porosity by applying a cutoff on the local velocity v obtained by numerical simulations preliminary analysis on the velocity field distribution showed that the velocities of one order of magnitude lower than average value were not significantly contributing to the flow based on that velocity threshold was fixed for each sample two simulations were performed the first by imposing pressure gradient in the x direction and the second by imposing pressure gradient in the y direction effective porosity was then calculated merging the identified cells contributing to the flow in both the x and y cases in addiction the connected porosity ϕc i e the fraction of pore space actually connected is also obtainable from the hydraulic simulation in fact the isolated pore space is not affected by the imposed pressure difference and remains at the initial pressure condition p p i giving 13 ϕ c ϕ n p i n l where npi is the number of porous grid cells with p p i nl is the total number of grid cells and ϕc represents a first estimate of the pore fraction that can be potentially involved in the fluid flow by definition ϕe ϕc 3 preliminary validation on elementary cases as a preliminary validation step three simple cases were analyzed a thin curved channel case 1 a thick curved channel case 2 and a slanted straight channel inclined of 23 case 3 details are given in table 1 in these cases the hydraulic radius coincides with the radius of the capillary tube the effective porosity coincides with the porosity and the tortuosity is easily calculated as the length of the tube median line divided by the extension in the x direction in particular for case 3 τ 1 cos 23 1 086 the numerical parametrization of the three simple cases is reported in table 2 the fluid used for the numerical simulation has the following properties viscosity 0 5 cp density 1050 kg m3 a pressure gradient of 100 pa m was applied between inlet and outlet laminar flow occurs in all the three cases re 2 the identified geometrical and hydraulic paths are compared in fig 2 a c respectively results are summarized in table 3 the pore radius estimated using the path finding algorithm r p is in good agreement with the hydraulic radius rh which matches the actual channel radius r the estimated tortuosity calculated both with the path finding approach τg and the flow simulation τh are comparable with the theoretical values τ in more detail τh and τg give an excellent estimate of tortuosity in case 3 in the presence of curves i e case 1 and case 2 the computed geometrical tortuosity τg is smaller than the hydraulic tortuosity τh because the shortest path is a slanted line crossing out the bight while the hydraulic path follows the tube curvature the discrepancy becomes more significant at increasing pore radius case 2 notice that in case 1 the hydraulic path follows the channel median line while in case 2 the hydraulic path does not perfectly follow the channel median line as a consequence in case 2 the computed hydraulic tortuosity differs a little from the analytical value as expected effective porosity estimated by the path finding algorithm ϕeg matches the total porosity effective porosity estimated by flow simulation ϕeh is slightly lower due to the combination of no slip effect at the solid fluid interface numerical discretization and velocity field processing 4 case studies 2d images of sedimentary rocks the geometrical and hydrodynamic characterization is carried out on a set of images obtained from thin sections of 3d samples of sedimentary rocks in this study we analyzed two medium to fine grained sandstone and a oolite berea sand d 50 23 µm gao and hu 2015 hostun sand d 50 300 µm vitorge et al 2013 and caicos ooid d 50 420 µm andó et al 2012 the three rocks are characterized by very different pore geometry berea sand is characterized by high difference between pore throat and pore body dimension hostun sand is relatively homogeneous characterized by well sorted predominantly quartz angular grains churcher et al 1991 caicos ooid is relatively homogeneous and characterized by round calcite grains andó et al 2012 their high porosity and permeability values make them a potential source of oil and natural gas therefore they can be used as standard rocks for various applications such as core analysis flooding experiment testing the efficiency of chemical surfactants and studying the drainage capacity in granular soil sato et al 2019 kim et al 2016 sharma et al 2014 literature images of rock samples were used when available multiple samples of the same material were analyzed for berea sand a black and white image of a horizontal sample boek and venturoli 2010 widely used in literature ex gu et al 2018 xu and liu 2018 was adopted the image is shown in fig 3 a and named in the following as case be30 for hostun sand x ray micro tomography images of horizontal sections of three different samples were considered a section with ϕ 49 viggiani et al 2010 named in the following case ho49 a small horizontal section with ϕ 56 andò 2013 named in the following case ho56 a more extended section with ϕ 47 andò 2013 named in the following as case ho47 for caicos ooid x ray micro tomography of two samples were available a small horizontal section andò 2013 named in the following ca52 and a more extended vertical section already segmented andó et al 2012 named in the following ca42 the grayscale x ray micro tomography images were binarized in order to distinguish the solid part from the voids for the following geometrical analysis and hydrodynamic simulation 1 was assigned to the grain while 0 to the porous domain to this end a threshold was applied to the grayscale images based on the histogram of pixels values andò 2013 the obtained binarized images are shown in fig 3b f and the corresponding parameterization is reported in table 4 where the 2d porosity values were calculated from images in order to observe hydrodynamic behavior the smallest pore size should be 4 5 lattice units succi 2001 when the pixel resolution of the rock images did not satisfy the condition above we re sized figures by bi cubic interpolation imposing a number of lattices that guarantees at least 5 lattices in the smallest pore channels the numerical parametrization of the considered case studies is reported in table 5 the fluid used for the numerical simulation has the following properties viscosity 0 5 cp density 1050 kg m3 a pressure gradient of 100 pa m was applied between inlet and outlet laminar flow occurs in all the three cases re 2 case studies were analyzed separately in the x and y directions to assess eventual discrepancy in tortuosity which could be an indicator of permeability anisotropy 5 results results of the geometrical approach proposed for the estimation of tortuosity and effective porosity are summarized in table 6 and compared with hydraulic approach results including the connected porosity in addition the mode of pore radius rp estimated through path finding approach is compared with the calculated hydraulic radius rh we point out that in ca42 there is no connectivity along the x direction thus it was not possible to estimate the tortuosity in x direction τx for this case we reported graphical results for be30 see figs 4 6 and for most interesting comparing cases graphical results comprehend geometrical v s hydraulic paths ex fig 4 comparison of effective porosity map obtained with the two approaches ex fig 5 pore radius analysis conducted by the proposed path finding approach overall pore radius distribution and pore radius evolution along a single path ex fig 6b in all cases tortuosity values calculated with the two methods are comparable discrepancy less than 10 and the geometrical tortuosity is slightly smaller than the hydraulic tortuosity as expected clennell 1997 ghanbarian et al 2013a the only exception is ho47 which shows a discrepancy of around 16 this is due to local significant narrowing of the pore radius along the shortest paths which makes the hydraulic flux choose alternative ways even if longer fig 11 comparing our results with literature berea tortuosity results are coherent with the gamma shaped distribution with a minimum value of 1 07 and a most probable value close to 2 reported in lindquist et al 1996 and just below the range of 1 6 2 8 reported in takahashi et al 2009 the values of tortuosity summarized in table 6 were compared with the geometrical tortuosity calculated adopting the model proposed by ghanbarian et al 2013b and based on percolation theory and finite size scaling approach imposing a fractal dimension equal to 1 13 tortuosity values calculated by the ghanbarian model are τ g 1 24 for berea and τ g 1 16 for hostun when ϕeg is adopted τ h 1 26 for berea and τ h 1 17 when ϕeh is adopted the pore radius distribution obtained by path finding algorithm appears to be reliable for berea scenario for instance the distribution fig 6a is in good agreement with the literature 31 of pore throats diameter of about 10 µm li and horne 2003 5 µm as the most frequent pore throat radius øren and bakke 2003 37 of relative pore volume characterized by 7 10 µm of pore radius shi et al 2011 hostun results are comparable with the pore diameter distribution calculated with mercury intrusion porosity and analysis of scanning electron microscopy images vitorge et al 2013 which shows a mode around 60 90 µm reasonable agreement order of magnitude is observed between the hydraulic radius and the mode of pore radius distribution obtained by the path finding approach in all scenarios table 6 thus suggesting that hydraulic radius formula eq 4 is reasonably representative of the effective pore radius of the sample at least if the pore radius variations are limited the representativeness of rh is poorer when the pore radii is highly variable ex be30 ho47 ca42 in all the cases except for the ca42 the connected porosity approaches the total porosity ϕch ϕ conversely ca42 shows a very poor connection ϕch ϕ limited to y direction fig 9 by way of example fig 7 shows the difference in connected porosity between ho49 and ca42 which both shows an effective porosity significantly lower than the total porosity good agreement is observed in terms of estimated effective porosity in all scenarios table 6 small sections ca57 and ho56 characterized by higher porosities are almost completely fluxed i e ϕ ϕ e 10 conversely in ho49 ho47 and ca42 significant dead zones ϕ ϕ e 30 or greater are clearly identified by both approaches ex fig 8 discrepancies between effective porosity estimated with the two approaches geometrical vs hydraulic is below 5 in most cases these differences are due to the different treatment of meandering zones by the geometrical and hydraulic method as shown in fig 8 trajectories identified by the path finding algorithm agree with the paths shown by the velocity map in ho49 fig 10 h56 ca52 and ca42 and as a consequence the identified dead zones are well comparable ex figs 8 and 9 on the contrary in be30 fig 4 and 5 and ho47 the more complex pore structure and high variability in the pore radius induce local discrepancies between the geometrical and hydraulic path in fact in the presence of a conspicuous narrowing of the pore radius the fluid flow follows a wider pathway even if longer fig 11 6 conclusions in the current paper we explore the possibility of adopting a geometrical analysis based on a path finding algorithm for the characterization of the pore network geometry and connectivity of 2d binary images of rock samples representative of real geological formations in order to validate the results provided by geometrical analysis we implemented and applied a lbm hydrodynamic numerical simulator and compared the results the differences between results provided by the two approaches were more evident in scenarios characterized by the presence of large pores i e case 2 or high variability of pore radius along pathways and multiple available pathways i e berea b30 and hostun ho47 in fact the geometrical approach always selects the shortest way without accounting for realistic fluid ways or pore radius thickness even in the presence of extremely narrow pores results showed that even if hydrodynamic simulation was more accurate in reproducing the flow behavior the path finding approach could give reasonable estimates of tortuosity and could also be successfully applied for analyzing the distribution of effective pore radius as well as for estimating the effective porosity without the use of a time consuming simulator in future work the algorithm for effective pore volume identification via path finding could be developed to exclude meandering zones thus further improving the estimate credit authorship contribution statement dario viberti conceptualization methodology writing original draft writing review editing supervision costanzo peter methodology software writing original draft writing review editing eloisa salina borello methodology software visualization writing original draft writing review editing filippo panini methodology software writing original draft writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
480,characterization of underground porous media parameters at the micro and macro scales is fundamental in geosciences a thorough comprehension of flow phenomena requires analyses and observations at the micro scale through adoption of micromodels as representative as possible of real geological formations in this paper we focus on the analysis of 2d binary images of real rock thin sections to characterize pore network geometry and to estimate effective porosity pore size distribution and tortuosity with the aim of providing suitable information for designing micromodels to this end a geometrical analysis of the pore structure based on the identification and characterization of the set of the shortest geometrical pathways between inlets and outlets pairs was implemented the geometrical analysis is based on a path finding algorithm derived from graph theory results provided by geometrical analysis were validated against hydrodynamic numerical simulation via the lattice boltzmann method lbm results show that the path finding approach provides reasonable and reliable estimates of tortuosity and can be successfully applied for analyzing the distribution of effective pore radius as well as for estimating the effective porosity keywords pore structure tortuosity lattice boltzmann method path finding algorithm effective porosity 1 introduction the characterization of fluid flow in underground porous media at the micro and macro scales is crucial in several areas such as in groundwater environmental and reservoir engineering and geosciences laboratory analyses on rock cores provide fundamental macroscale parameters such as porosity absolute and relative permeability and capillary pressure curves however a thorough comprehension of single and multiphase flow phenomena requires analyses and observations at the micro scale anbari et al 2018 blunt 2001 in this view a great opportunity is given by observation of flow phenomena in microfluidic devices designed as physical micromodels representing pseudo two dimensional capillary networks venturoli and boek 2006 multi scale studies associated with pore network properties are increasingly used to improve understanding of flow behavior in porous media at the phenomenological scale viggiani et al 2012 these include distribution of pores space micropore macropore connectivity constricted porosity by throats hysteresis fluid occupancy during multiphase or displacement processes wettability viggiani et al 2012 pore network rules liquid and gas permeability properties as well as water retention and electro chemical transport viggiani et al 2012 real geological formations are often characterized by high degree of heterogeneities and complexity of the pore network geometry that should be taken into account in the design of the micromodels wu et al 2012 in the current paper we explore the possibility of adopting a path finding algorithm for the characterization of pore structure geometry and connectivity with the aim of analyzing 2d binary images of rock samples representative or real geological formations and providing geometrical parameters that could be used in future works to design microfluidic devices the path finding algorithm has been applied to several real rock images and the results are validated through the application of simple 2d lbm simulations the lattice boltzmann method lbm is well suited for simulating fluid flow at the pore scale in complex geometries several authors used lbm to study the fluid flow at pore scale of micromodels synthetic porous media or real rock samples venturoli and boek 2006 and laleian et al 2015 used 2d lbm with single relaxation time srt to calculate the fluid flow in micromodels taking the third dimension into account by adding a drag force boek and venturoli 2010 used the same approach for studying the fluid flow in a quasi two dimensional micromodel based on the image of a berea sandstone wu et al 2012 compared single and multiphase flow by lbm simulation of a micromodel with results obtained by laboratory experiments koponen et al used the lga method to estimate permeability effective porosity koponen et al 1997 and tortuosity koponen et al 1996 in synthetic 2d porous media ghassemi and pak 2011 used lbm to study the effects of permeability and tortuosity on flow through 2d saturated particulate media and li et al 2018 studied the effect of geometrical properties on saturation and relative permeability in 2d synthetic porous media yang et al 2017 used 3d lbm for permeability assessment in random packed porous media comparison of single and multiple relaxation time mrt lbm for permeability assessment was performed in 2d synthetic porous media pan et al 2006 and 3d synthetic and real porous media eshghinejadfard et al 2016 ferreol and rothman 1995 with lbm simulated single phase and two phase flow through three dimensional tomographic reconstructions of fontainebleau sandstone xu and liu 2018 used lbm to investigate relative permeability and specific interfacial length by simulating immiscible two phase flow in 2d sample of berea sandstone porous media are complex materials characterized by a chaotic structure and tortuous fluid flow with pore and grains dimension varying over a wide range ghanbarian et al 2013a to address the crooked fluid paths of pore structure the concept of tortuosity τ was introduced carman 1937 two main types of tortuosity are defined in the literature geometrical tortuosity τg and hydraulic tortuosity τh geometrical tortuosity is defined as the shortest length between inflow and outflow points that avoids the solid obstacles divided by the distance between inlet and outlet adler 2013 clennell 1997 hydraulic tortuosity is defined as the effective path length taken by the fluid divided by the length of the porous material measured along the flow direction carman 1937 since the fluid flow path is always greater than the shortest geometrical path hydraulic tortuosity is always greater than the geometrical tortuosity clennell 1997 ghanbarian et al 2013a for a complete review on the definitions of tortuosity the reader can refer to clennell 1997 and to ghanbarian et al 2013a to account for pore space interconnections affected by the flow the effective porosity ϕe was introduced this property is defined as the percentage of conductive pore space with respect to the bulk volume ahmed 2010 koponen et al 1997 1 ϕ e v f l o w v b where vflow is the portion of volume contributing to the fluid flow the impact of pore network geometry on flow behavior is well recognized in the literature several analytic expressions have been provided koponen et al 1996 dullien 2012 scheidegger 1974 carman 1937 wyllie and spangler 1952 to link permeability to the pore structure as a function of porosity effective porosity tortuosity and or pore dimension and hydraulic radius rh which gives a measure of the average pore dimension corey et al 1977 bear 2013 several authors discussed the geometrical analysis of the pore structure from 2d and 3d images comparison of three image processing algorithms mean intercept length erosion and dilation watershed segmentation to estimate the grain size distribution of porous rocks from binary 2d images has been performed by rabbani and ayatollahi 2015 lock et al 2002 developed a network model that allows predictions of the permeability of consolidated sedimentary rocks based on image analysis of sections of a rock core sample lindquist et al 1996 discuss the medial axes method to analyze structure properties such as pore throat and pore body size distributions and geometric tortuosity of a 3d digitalized image later sun et al 2011 used a shortest past approach based on dijkstra s algorithm to calculate the geometric tortuosity and connected porosity then they applied a multiscale method approach to upscale the permeability ju et al 2018 proposed an algorithm to predict preferential flow paths based on the topologically equivalent network of a porous structure and the flow resistance of flow paths keller et al 2011 proposed a 3d graph representation to determine the spatial distribution of pore space geometrical properties in ghanbarian et al 2013a 2013b hunt and sahimi 2017 the authors proposed geometric tortuosity models based on concepts from finite size scaling analysis and percolation theory al raoush and madhoun 2017 presented an algorithm for calculating geometric tortuosity from 3d x ray tomography images of real rocks based on a guided search for connected paths utilizing the medial surface of the void space of a 3d segmented image in this paper we focus on methods to estimate from 2d binary images of a rock sample parameters which allows describing the pore structure to this end we applied an approach based on geometrical analysis of the porous media the geometrical approach was developed based on a a path finding procedure taken from the graph theory this approach was validated for the parameters of interest of the study with the more established hydrodynamic based path analysis carried out by numerical simulation via the lattice boltzmann method lbm a preliminary validation of the methodologies was carried out on a set of simplified synthetic cases for which the true value of the parameters of interest was analytically computed successively the methodologies were applied to images of real rock sample thin sections taken from literature 2 material and methods starting point for the presented methodologies is a 2d binary image of a rock section such data can be obtained by image processing of the scanning electron microscopy sem image of a thin section or the slice of an x ray micro tomography image preliminary image processing is beyond the scope of this paper however readers interested on the topic may consult vlahinic et al 2014 hashemi et al 2014 saladra and kopernik 2016 in this paper we analyzed a set of literature images obtained from thin sections of 3d samples of sedimentary rocks when necessary a preliminary image processing was applied to convert gray scale images to binary files see section 4 on the 2d binary image we analyzed the pore structure in terms of pathways accessible by fluid flow in monophase conditions and calculated the associated parameters tortuosity sections 2 3 2 and 2 3 3 and effective porosity section 2 3 4 two different approaches were applied to assess pathways geometrical section 2 1 and hydrodynamic section 2 2 the pore structure analysis was completed by calculation of pore radius variations along the path section 2 3 1 compared with the hydraulic radius which represents the pore radius of an equivalent capillary tube see eq 4 2 1 geometrical path calculation the pore structure of a binary 2d image is analyzed through a path finding method based on graph representation to this end a set of inlets nin and outlets nout are placed along the inner and outer boundaries of the image of the porous domain orthogonal to the main flow direction x or y the centroids of the pixels are used as reference grid node locations these locations represent the points where the fluid enters and potentially leaves the porous system respectively the shortest pathway between each couple of inlet outlet points is obtained through the path finding method a algorithm hart et al 1968 nilsson 1980 2014 a is based on a cost function f n to determine the optimal path between two nodes 2 f n g n h n where n indicates the considered node g n the incremental distance from the considered node to the initial node and h n is a heuristic function used to obtain a prior estimation to reach the target from the considered node the process of obtaining the optimal shortest path is achieved by steps starting at the initial node the cost function f n is calculated at each adjacent nodes in order to identify the one having the minimum cost which will be used as reference for the next calculation this process is progressively repeated until the target is reached the output is represented as a graph g n e with n being a set of nodes with x y coordinates while e the edges connecting the nodes fig 1 the application of a algorithm to the images gives a set of nin nout coordinates of the shortest paths in a fixed direction whose length lsh can be easily calculated by applying the euclidean distance 2 2 hydraulic path calculation hydraulic paths were obtained as a result of numerical simulation of monophase fluid flow at the pore scale to this end we implemented a discrete mesoscopic computational methods based on the lattice boltzmann method lbm the lbm is a relatively new computational fluid dynamics cfd method first appeared in the 1980s mcnamara and zanetti 1988 successively developed by several authors krüger et al 2017 and still subject of research activity the lbm has shown to be a functional technique for the computational modeling of a wide variety of complex fluid flow problems including single and multiphase flows in complex geometries benzi et al 1992 chen and doolen 1998 boek and venturoli 2010 and porous media guo and zhao 2002 use of the lbm to evaluate the hydraulic tortuosity in synthetic porous media was presented by nabovati and sousa 2007 matyka et al 2008 wang 2014 the implementation adopted in this paper for mono phase flow simulation in porous media is based on a single relaxation time srt approximation of the collision operator called the bhatnagar gross krook model bgk bhatnagar et al 1954 the relaxation time was set equal to 1 and the time step was calculated accordingly to guarantee stability conditions krüger et al 2017 the nine velocity square lattice model d2q9 qian et al 1992 was adopted to discretize the domain at the fluid solid interface no slip condition was imposed via halfway bounce back ladd 1994 fixed pressure gradient between inlet and outlet was assumed as the boundary condition which was implemented via non equilibrium bounce back zou and he 1997 no flow boundaries parallel to the main flow direction were assumed to reproduce laboratory conditions they were implemented with halfway bounce back ladd 1994 2 3 characterization of pore structure a quantitative microstructure characterization of the porous medium is carried out through the estimation of a series of parameters pore size section 2 3 1 tortuosity geometrical section 2 3 2 and hydraulic section 2 3 3 and effective porosity section 2 3 4 in the following we will not parametrize pore structure in terms of pore throat and pore body we will refer to the local aperture between the pore walls as pore size or to the semi aperture as pore radius 2 3 1 pore size along the geometrical pathways identified by a algorithm the pore size is calculated at each node location by measuring the extension of the pore section length orthogonal to the local path direction fig 1 the local pore size estimation allows monitoring the pore radius rp evolution along each detected path this information can be used for reconstructing 3d porous geometries øren and bakke 2003 soete et al 2017 or for comparative analysis with hydrodynamic data the output is also analyzed by a statistical representation of the pore radius distribution of the sample which is compared with the hydraulic radius rh defined as bear 2013 3 r h ϕ 3 d v b a w where vb is the bulk volume of the system pore and grain and aw is the wetted surface i e the surface area between grain and void transposing it to a 2d section it becomes 4 r h ϕ a b p w where ab is the bulk area of the sample and pw is the wetted perimeter i e the interface between grains and void which can be easily calculated by image processing routine we used the image processing toolbox of matlab mathworks 2017 the porosity ϕ in the 2d case might be different from the 3d porosity ϕ 3d 2 3 2 geometrical tortuosity the geometrical tortuosity τg within a porous medium in a given flow direction y is calculated through the ratio between the average of the shortest pathway lengths in that direction l sh y by the length of the system domain along the fluid direction ly dias et al 2006 sobieski and lipiński 2017 ghanbarian et al 2013a 5 τ g l s h y l y where l sh y is calculated as the average of the shortest pathway lengths calculated as in section 2 1 for the given flow direction y 2 3 3 hydraulic tortuosity hydraulic tortuosity was defined by carman 1937 as the ratio of the average length of the fluid paths divided by the length of the sample 6 τ h l h l clennell 1997 suggested a kinematical average in which the pathlines are weighted with fluid fluxes koponen et al 1996 suggested an approximated form 7 l h i 1 n l p r i v r i i 1 n v r i where n is a fixed number of streamlines lp ri is the path length of the ith streamline and v ri is the averaged tangential velocity of the fluid at the starting point of the ith streamline koponen et al 1996 suggested also to estimate tortuosity in a fixed direction y from the velocity field simulated with a cfd numerical simulator as 8 τ h v v y where v is the absolute value of the local flow velocity vy is the y component of that velocity and denotes the spatial average over the pore space we made use of a numerical simulator based on the lattice boltzmann method lbm to simulate the fluid flow in the porous media at the pore scale and obtain the velocity field and calculate the hydraulic tortuosity τh with eq 8 we also verified the invariance of calculated tortuosity with respect to the variation of the applied pressure gradient until laminar flow conditions are guaranteed re 2 aminpour et al 2018 where the reynolds number re was calculated as bear 2013 9 r e ρ v d c μ where dc is the characteristic length scale ρ and μ are the density and the dynamic viscosity of the fluid respectively there is not just one way to define the characteristic length in a porous medium which can be equal either to to the grain diameter bear 2013 or to the hydraulic diameter hydraulic radius ergun and orning 1949 ergun 1952 papathanasiou et al 2001 we adopted the image based definition introduced by mostaghimi et al 2012 and later proposed by blunt 2017 10 d c π v b a w π r h ϕ where vb is the total volume of the bulk system pore and grain and aw is the wetted surface eq 10 represents a sort of average grain size diameter 2 3 4 effective porosity for low porosity materials a large part of the total pore space may be nonconducting koponen et al 1996 the effective porosity ϕe is defined as the percentage of interconnected conductive pore space with respect to the bulk volume ahmed 2010 we proposed a purely geometrical calculation based on path finding 11 ϕ e n p p n p x where npp is the number of image pixels belonging to the portion of pore channels crossed by a pathway in x or y direction and npx the total number of image pixels to this end for each pathway all pixels comprised in the pore section orthogonal to the local path direction were considered see fig 1 for comparison the effective porosity can be calculated from a rock image by flow simulation koponen et al 1996 12 ϕ e n s n l where according to koponen et al 1996 ns is the number of grid cells crossed by streamlines and nl is the total number of grid cells to reduce the computational effort we calculated the effective porosity by applying a cutoff on the local velocity v obtained by numerical simulations preliminary analysis on the velocity field distribution showed that the velocities of one order of magnitude lower than average value were not significantly contributing to the flow based on that velocity threshold was fixed for each sample two simulations were performed the first by imposing pressure gradient in the x direction and the second by imposing pressure gradient in the y direction effective porosity was then calculated merging the identified cells contributing to the flow in both the x and y cases in addiction the connected porosity ϕc i e the fraction of pore space actually connected is also obtainable from the hydraulic simulation in fact the isolated pore space is not affected by the imposed pressure difference and remains at the initial pressure condition p p i giving 13 ϕ c ϕ n p i n l where npi is the number of porous grid cells with p p i nl is the total number of grid cells and ϕc represents a first estimate of the pore fraction that can be potentially involved in the fluid flow by definition ϕe ϕc 3 preliminary validation on elementary cases as a preliminary validation step three simple cases were analyzed a thin curved channel case 1 a thick curved channel case 2 and a slanted straight channel inclined of 23 case 3 details are given in table 1 in these cases the hydraulic radius coincides with the radius of the capillary tube the effective porosity coincides with the porosity and the tortuosity is easily calculated as the length of the tube median line divided by the extension in the x direction in particular for case 3 τ 1 cos 23 1 086 the numerical parametrization of the three simple cases is reported in table 2 the fluid used for the numerical simulation has the following properties viscosity 0 5 cp density 1050 kg m3 a pressure gradient of 100 pa m was applied between inlet and outlet laminar flow occurs in all the three cases re 2 the identified geometrical and hydraulic paths are compared in fig 2 a c respectively results are summarized in table 3 the pore radius estimated using the path finding algorithm r p is in good agreement with the hydraulic radius rh which matches the actual channel radius r the estimated tortuosity calculated both with the path finding approach τg and the flow simulation τh are comparable with the theoretical values τ in more detail τh and τg give an excellent estimate of tortuosity in case 3 in the presence of curves i e case 1 and case 2 the computed geometrical tortuosity τg is smaller than the hydraulic tortuosity τh because the shortest path is a slanted line crossing out the bight while the hydraulic path follows the tube curvature the discrepancy becomes more significant at increasing pore radius case 2 notice that in case 1 the hydraulic path follows the channel median line while in case 2 the hydraulic path does not perfectly follow the channel median line as a consequence in case 2 the computed hydraulic tortuosity differs a little from the analytical value as expected effective porosity estimated by the path finding algorithm ϕeg matches the total porosity effective porosity estimated by flow simulation ϕeh is slightly lower due to the combination of no slip effect at the solid fluid interface numerical discretization and velocity field processing 4 case studies 2d images of sedimentary rocks the geometrical and hydrodynamic characterization is carried out on a set of images obtained from thin sections of 3d samples of sedimentary rocks in this study we analyzed two medium to fine grained sandstone and a oolite berea sand d 50 23 µm gao and hu 2015 hostun sand d 50 300 µm vitorge et al 2013 and caicos ooid d 50 420 µm andó et al 2012 the three rocks are characterized by very different pore geometry berea sand is characterized by high difference between pore throat and pore body dimension hostun sand is relatively homogeneous characterized by well sorted predominantly quartz angular grains churcher et al 1991 caicos ooid is relatively homogeneous and characterized by round calcite grains andó et al 2012 their high porosity and permeability values make them a potential source of oil and natural gas therefore they can be used as standard rocks for various applications such as core analysis flooding experiment testing the efficiency of chemical surfactants and studying the drainage capacity in granular soil sato et al 2019 kim et al 2016 sharma et al 2014 literature images of rock samples were used when available multiple samples of the same material were analyzed for berea sand a black and white image of a horizontal sample boek and venturoli 2010 widely used in literature ex gu et al 2018 xu and liu 2018 was adopted the image is shown in fig 3 a and named in the following as case be30 for hostun sand x ray micro tomography images of horizontal sections of three different samples were considered a section with ϕ 49 viggiani et al 2010 named in the following case ho49 a small horizontal section with ϕ 56 andò 2013 named in the following case ho56 a more extended section with ϕ 47 andò 2013 named in the following as case ho47 for caicos ooid x ray micro tomography of two samples were available a small horizontal section andò 2013 named in the following ca52 and a more extended vertical section already segmented andó et al 2012 named in the following ca42 the grayscale x ray micro tomography images were binarized in order to distinguish the solid part from the voids for the following geometrical analysis and hydrodynamic simulation 1 was assigned to the grain while 0 to the porous domain to this end a threshold was applied to the grayscale images based on the histogram of pixels values andò 2013 the obtained binarized images are shown in fig 3b f and the corresponding parameterization is reported in table 4 where the 2d porosity values were calculated from images in order to observe hydrodynamic behavior the smallest pore size should be 4 5 lattice units succi 2001 when the pixel resolution of the rock images did not satisfy the condition above we re sized figures by bi cubic interpolation imposing a number of lattices that guarantees at least 5 lattices in the smallest pore channels the numerical parametrization of the considered case studies is reported in table 5 the fluid used for the numerical simulation has the following properties viscosity 0 5 cp density 1050 kg m3 a pressure gradient of 100 pa m was applied between inlet and outlet laminar flow occurs in all the three cases re 2 case studies were analyzed separately in the x and y directions to assess eventual discrepancy in tortuosity which could be an indicator of permeability anisotropy 5 results results of the geometrical approach proposed for the estimation of tortuosity and effective porosity are summarized in table 6 and compared with hydraulic approach results including the connected porosity in addition the mode of pore radius rp estimated through path finding approach is compared with the calculated hydraulic radius rh we point out that in ca42 there is no connectivity along the x direction thus it was not possible to estimate the tortuosity in x direction τx for this case we reported graphical results for be30 see figs 4 6 and for most interesting comparing cases graphical results comprehend geometrical v s hydraulic paths ex fig 4 comparison of effective porosity map obtained with the two approaches ex fig 5 pore radius analysis conducted by the proposed path finding approach overall pore radius distribution and pore radius evolution along a single path ex fig 6b in all cases tortuosity values calculated with the two methods are comparable discrepancy less than 10 and the geometrical tortuosity is slightly smaller than the hydraulic tortuosity as expected clennell 1997 ghanbarian et al 2013a the only exception is ho47 which shows a discrepancy of around 16 this is due to local significant narrowing of the pore radius along the shortest paths which makes the hydraulic flux choose alternative ways even if longer fig 11 comparing our results with literature berea tortuosity results are coherent with the gamma shaped distribution with a minimum value of 1 07 and a most probable value close to 2 reported in lindquist et al 1996 and just below the range of 1 6 2 8 reported in takahashi et al 2009 the values of tortuosity summarized in table 6 were compared with the geometrical tortuosity calculated adopting the model proposed by ghanbarian et al 2013b and based on percolation theory and finite size scaling approach imposing a fractal dimension equal to 1 13 tortuosity values calculated by the ghanbarian model are τ g 1 24 for berea and τ g 1 16 for hostun when ϕeg is adopted τ h 1 26 for berea and τ h 1 17 when ϕeh is adopted the pore radius distribution obtained by path finding algorithm appears to be reliable for berea scenario for instance the distribution fig 6a is in good agreement with the literature 31 of pore throats diameter of about 10 µm li and horne 2003 5 µm as the most frequent pore throat radius øren and bakke 2003 37 of relative pore volume characterized by 7 10 µm of pore radius shi et al 2011 hostun results are comparable with the pore diameter distribution calculated with mercury intrusion porosity and analysis of scanning electron microscopy images vitorge et al 2013 which shows a mode around 60 90 µm reasonable agreement order of magnitude is observed between the hydraulic radius and the mode of pore radius distribution obtained by the path finding approach in all scenarios table 6 thus suggesting that hydraulic radius formula eq 4 is reasonably representative of the effective pore radius of the sample at least if the pore radius variations are limited the representativeness of rh is poorer when the pore radii is highly variable ex be30 ho47 ca42 in all the cases except for the ca42 the connected porosity approaches the total porosity ϕch ϕ conversely ca42 shows a very poor connection ϕch ϕ limited to y direction fig 9 by way of example fig 7 shows the difference in connected porosity between ho49 and ca42 which both shows an effective porosity significantly lower than the total porosity good agreement is observed in terms of estimated effective porosity in all scenarios table 6 small sections ca57 and ho56 characterized by higher porosities are almost completely fluxed i e ϕ ϕ e 10 conversely in ho49 ho47 and ca42 significant dead zones ϕ ϕ e 30 or greater are clearly identified by both approaches ex fig 8 discrepancies between effective porosity estimated with the two approaches geometrical vs hydraulic is below 5 in most cases these differences are due to the different treatment of meandering zones by the geometrical and hydraulic method as shown in fig 8 trajectories identified by the path finding algorithm agree with the paths shown by the velocity map in ho49 fig 10 h56 ca52 and ca42 and as a consequence the identified dead zones are well comparable ex figs 8 and 9 on the contrary in be30 fig 4 and 5 and ho47 the more complex pore structure and high variability in the pore radius induce local discrepancies between the geometrical and hydraulic path in fact in the presence of a conspicuous narrowing of the pore radius the fluid flow follows a wider pathway even if longer fig 11 6 conclusions in the current paper we explore the possibility of adopting a geometrical analysis based on a path finding algorithm for the characterization of the pore network geometry and connectivity of 2d binary images of rock samples representative of real geological formations in order to validate the results provided by geometrical analysis we implemented and applied a lbm hydrodynamic numerical simulator and compared the results the differences between results provided by the two approaches were more evident in scenarios characterized by the presence of large pores i e case 2 or high variability of pore radius along pathways and multiple available pathways i e berea b30 and hostun ho47 in fact the geometrical approach always selects the shortest way without accounting for realistic fluid ways or pore radius thickness even in the presence of extremely narrow pores results showed that even if hydrodynamic simulation was more accurate in reproducing the flow behavior the path finding approach could give reasonable estimates of tortuosity and could also be successfully applied for analyzing the distribution of effective pore radius as well as for estimating the effective porosity without the use of a time consuming simulator in future work the algorithm for effective pore volume identification via path finding could be developed to exclude meandering zones thus further improving the estimate credit authorship contribution statement dario viberti conceptualization methodology writing original draft writing review editing supervision costanzo peter methodology software writing original draft writing review editing eloisa salina borello methodology software visualization writing original draft writing review editing filippo panini methodology software writing original draft writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
481,data assimilation for parameter and state estimation in subsurface transport problems remains a significant challenge because of the sparsity of measurements the heterogeneity of porous media and the high computational cost of forward numerical models we present a multiphysics informed deep neural network machine learning method for estimating space dependent hydraulic conductivity hydraulic head and concentration fields from sparse measurements in this approach we employ individual deep neural networks dnns to approximate the unknown parameters e g hydraulic conductivity and states e g hydraulic head and concentration of a physical system next we jointly train these dnns by minimizing the loss function that consists of the governing equations residuals in addition to the error with respect to measurement data we apply this approach to assimilate conductivity hydraulic head and concentration measurements for the joint inversion of these parameter and states in a steady state advection dispersion problem we study the accuracy of the proposed data assimilation approach with respect to the data size i e the number of measured variables and the number of measurements of each variable dnn size and the complexity of the parameter field we demonstrate that the physics informed dnns are significantly more accurate than the standard data driven dnns especially when the training set consists of sparse data we also show that the accuracy of parameter estimation increases as more different multiphysics variables are inverted jointly keywords physics informed deep neural networks data assimilation parameter estimation inverse problems subsurface flow and transport 1 introduction modeling of transport in heterogeneous porous media is a part of many environmental and engineering applications including hydrocarbon recovery hartmann and beaumont 1999 hydraulic fracking hubbert and willis 1972 exploitation of geothermal energy barbier 2002 geologic disposal of radioactive waste helton 1993 and groundwater contamination assessment rajib et al 2017 numerical models of transport in porous media require deterministic or statistical knowledge of the subsurface properties e g hydraulic conductivity and initial and boundary conditions bear and cheng 2010 white et al 1995 however because of heterogeneity and data sparsity the parameters of natural systems are often not fully known despite significant research in inverse methods hoeksema and kitanidis 1984 vrugt et al 2008 rajib et al 2017 rajabi et al 2018 parameter estimation at a resolution required for accurate modeling of transport processes remains a challenge parameter estimation is complicated by the fact that the parameters of interest e g hydraulic conductivity are difficult to measure directly most inverse parameter estimation methods use indirect measurements in addition to direct measurements to estimate parameters data assimilation or model data integration has been well recognized as an effective technique to reduce predictive uncertainties and improve model accuracy data assimilation is a process where model parameters and system states are updated using measurements and governing equations rajib et al 2017 evensen 1994 rayner et al 2016 data assimilation has been used in many fields including atmospheric and oceanic sciences evensen 2003 houtekamer and mitchell 2001 hydrology christakos 2005 vrugt et al 2008 subsurface transport rajib et al 2017 rajabi et al 2018 zheng et al 2019 and uncertainty quantification vrugt et al 2005 liu and gupta 2007 data assimilation in subsurface applications is challenging because the subsurface flow and transport equations are highly nonlinear and the states and parameters are non gaussian zheng et al 2019 this nonlinearity poses a difficulty for both the direct inverse methods and bayesian parameter estimation methods recent advances in machine learning ml methods automatic differentiation ad baydin et al 2015 and ml libraries e g tensorflow ramsundar and zadeh 2018 and pytorch paszke et al 2017 have made them potentially powerful tools for parameter estimation and data assimilation for example bongard and lipson 2007 applied symbolic regression to learn conservation laws and brunton et al 2016 used sparse regression to discover equations of nonlinear dynamics directly from data physics informed deep neural networks pinns were used to learn solutions and parameters in partial and ordinary differential equations raissi et al 2019 lagaris et al 1997 weinan and yu 2018 raissi et al 2019 recently pinns were extended for inverse problems associated with partial differential equations pdes with space dependent coefficients e g to estimate hydraulic conductivity using sparse measurements of conductivity and hydraulic head tartakovsky et al 2020 in this study we extend the pinn based parameter estimation method of tartakovsky et al 2020 to assimilate multiphysics measurement and refer to this multiphysics informed neural network approach as mpinn we consider a subsurface transport problem with sparse measurements of hydraulic conductivity hydraulic head and solute concentration in this approach we use the darcy and advection dispersion equations together with data to train deep neural networks dnns that represent space dependent conductivity head and concentration fields during training of the dnns the governing equations and the associated boundary conditions are enforced at the residual points over the domain we demonstrate that for sparse data the mpinn approach significantly improves the accuracy of parameter and state estimation as compared to standard dnns trained with data only the mpinn approach can be easily extended to assimilate other types of variables and physics laws e g geophysical measurements and the corresponding equations that describe the relationships between electrical resistivity current and potential this paper is organized as follows in section 2 we describe the mpinn method and its formulation for transport problems the performance of the mpinn approach for data assimilation including the dependence of estimation errors on the number of measurements is given in section 3 the effects of the neural network size and the conductivity field correlation length on the parameter estimation errors are discussed in section 4 conclusions are given in section 5 2 mpinn for data assimilation in this section we present the mpinn approach for multiphysics data assimilation and its formulation for subsurface transport applications we also discuss the automatic differentiation and two step training algorithm that are used in the mpinn approach 2 1 general mpinn formulation in the pinn approach and its mpinn extension we employ fully connected feed forward networks to approximate unknown variables states and space dependent parameters as described in appendix a and shown in fig a 17 given a sufficiently large number of hidden layers dnns have excellent representative properties but require a lot of data to train them this creates a challenge in applying dnns to subsurface problems where measurements are usually sparse for the purpose of this work we define sparse measurements as those that do not sufficiently cover the computational domain to accurately estimate parameters with the standard data driven dnns method described in appendix a in tartakovsky et al 2020 we demonstrated that the darcy law can be used as a constraint for training a dnn model of conductivity that significantly improves the predictive ability of the dnn model in the rest of this section we extend the pinn parameter estimation method of tartakovsky et al 2020 to a data assimilation problem where different types of measurements are used to estimate parameters and states consider a system of pdes forming the boundary value problem defined on the domain ω r d with the boundary ω 1 l u x p x 0 x ω b u x p x 0 x ω where u is the unknown solution vector can include head concentrations saturation electrical potential and other variables p is the unknown system parameter vector e g hydraulic and electric conductivities l denotes the known nonlinear differential operator and the operator b expresses arbitrary boundary conditions associated with the problem the boundary conditions can be of the dirichlet and neumann types applied on d ω and n ω respectively such that d ω n ω ω and d ω n ω we use the dnns to approximate both state variables and unknown parameters u x u x θ and p x p x γ x ω where θ and γ are weights which need to be estimated or trained in the corresponding dnns to determine these weights we minimize the loss function j θ γ with physics informed penalty terms 2 θ γ arg min θ γ j θ γ where 3 j θ γ j d θ γ ω f j f θ γ ω b j b θ γ here jd θ γ is the loss due to a mismatch with the data i e the measurements of u and p 4 j d θ γ 1 t u x t u u x θ u x 2 1 t p x t p p x θ p x 2 jf θ γ is the loss due to mismatch with the governing pdes l u x p x 0 5 j f θ γ 1 t f x t f l u x θ p x γ 2 and jb θ γ is the loss due to mismatch with the boundary conditions b u x p x 0 6 j b θ γ 1 t b x t b b u x θ p x γ 2 in 3 ωf and ωb are weights that determine how strongly mismatch with the governing pdes and boundary conditions is penalized relative to data mismatch in this work we assume that the measurements and physics model are exact and set ω f ω b 1 the sets t u x 1 x 2 x t u ω and t p x 1 x 2 x t p ω denote the measurement locations of u and p respectively and u x x t u and p x x t p are the measured values of u and p at these locations the sets t f x 1 x 2 x t f ω and t b x 1 x 2 x t b ω denote locations of the residual points where jf θ γ and jb θ γ are respectively minimized the penalty terms jf θ γ and jb θ γ force the dnn approximations of u and p to satisfy the governing eq 1 at the residual points note that while it is preferable to enforce physics over the whole domain the computational cost of estimating and minimizing the loss function 3 increases with the number of residual points in this work we demonstrate convergence of the solution of 2 with an increasing number of residual points meaning that the dnns u x θ and p x γ can be accurately trained using a finite number of residual points similar convergence results for solving pdes with the pinn method were also observed in raissi et al 2019 lu et al 2019 tartakovsky et al 2020 lagaris et al 1997 and rudd et al 2013 the loss jf θ γ is evaluated by computing spatial derivatives of u x θ and p x γ using ad ad is also used to evaluate the normal derivative n in the neumann boundary condition in the loss jb θ γ see details in section 2 2 ad is implemented in most ml libraries including tensorflow and pytorch paszke et al 2017 where it is mainly used to compute derivatives with respect to the dnn weights i e θ and γ in the pinn method ad allows the implementation of any pde and boundary condition constraints without numerically discretizing and solving the pdes another benefit of enforcing pde constraints via the penalty term jf θ γ is that it allows using the corresponding weight ωf to account for the fidelity of the pde model for example we can assign a smaller weight to a low fidelity pde model in general the number of unknown parameters in θ and γ is much larger than the number of measurements and training the dnns requires regularization one can consider the losses jb θ γ and jf θ γ in the minimization problem 2 as physics informed regularization terms tartakovsky et al 2020 nabian and meidani 2020 2 2 application of mpinn for subsurface transport problems for sparsely sampled systems data assimilation can significantly improve the accuracy of parameter and state estimation here we assume that the sparse steady state measurements of a synthetic tracer test in a heterogeneous porous domain ω 0 l 1 0 l 2 are available where the solute is continually injected at the x 1 0 boundary this data includes the measurements of conductivity k i k x i k hydraulic head h i h x i h and concentration c i c x i c at the locations x i k i 1 n k x i h i 1 n h and x i c i 1 n c respectively where nk nh and nc are the number of measurements of each variable our objective is to learn the conductivity head and concentration fields based on these measurements we further assume that the concentration hydraulic head and conductivity data can be accurately modeled by the steady state darcy flow equations 7 v x k x ϕ h x v x 0 x ω h x h 2 x 1 l 1 k x h x x 1 q x 1 0 k x h x x 2 0 x 2 0 or x 2 l 2 and advection dispersion equation 8 v x c x d c x x ω c x c 0 x 2 x 1 0 c x x 1 0 x 1 l 1 c x x 2 0 x 2 0 or x 2 l 2 where ϕ is the effective porosity of the medium v is the average pore velocity and d is the dispersion coefficient 9 d d w τ i α v 2 here i is the identity tensor dw is the diffusion coefficient τ is the tortuosity of the medium and α is the dispersivity tensor with the diagonal components αl and αt the conductivity k x is assumed to be unknown except at the measurement locations x i k i 1 n k in the following simulations we set the parameters as l 1 1 m l 2 0 5 m h 2 0 m q 1 m hr c 0 x 2 c exp x 2 l 2 2 2 ϵ 2 c 1 kg m 3 ϵ 0 25 m ϕ 0 317 d w 0 09 m 2 hr τ ϕ 1 3 0 681 α l 0 01 m and α t 0 001 m we start by defining the dnn representations of k x h x and c x as 10 k x n k x θ k h x n h x θ h c x n c x θ c where θk θh and θc are the vectors of parameters associated with each neural network for the considered two dimensional problem the dimension of the input layers in these dnns is two the k h and c fields are scalar therefore the dimensionality of the output layers in these dnns is one the specific form of the general loss function 3 for training these dnns is given by eqs b 4 b 6 in appendix b in eq b 6 pdes 7 and 8 are enforced at the residual points given by the sets t f h and t f c respectively where t f h n f h and t f c n f c a schematic diagram of the mpinn method for data assimilation in the transport problem described by eqs 7 and 8 is shown in fig 1 in this work we compare three approaches for training k the mpinn approach where we jointly train the dnns k h and c by minimizing the loss function b 4 the pinn darcy approach where we jointly train k and h by only enforcing the darcy equation and boundary conditions 7 and the data driven dnn approach where we separately train k h and c using only data the performance of these three approaches is investigated and compared in sections 3 and 4 given that the loss function is highly nonlinear and non convex with respect to the network parameters θk θh and θc we use the gradient descent minimization algorithms including the adam kingma and ba 2014 and l bfgs b byrd et al 1995 methods in the l bfgs b optimizer the iterative minimization process is terminated once the relative change in the loss function becomes smaller than a prescribed value in the adam method the dnns training stops once the total loss function becomes smaller than a prescribed small value or the predefined number of iterations epochs is completed as suggested in raissi et al 2019 tartakovsky et al 2020 berg and nyström 2018 and le et al 2011 l bfgs b a quasi newtown method shows superior performance with a better rate of convergence lower gradient vanishing and a lower computational cost for problems with a relatively small amount of training data and or residual points in this study we employ the l bfgs b method for the data driven dnn and pinn darcy methods with the default settings from scipy jones et al 2001 however our numerical experiments show that the l bfgs b algorithm has a slow convergence for the mpinn method where a relatively large number of residual points is used we propose a two step training algorithm where the loss function is first minimized by the adam algorithm with a prescribed stop criterion followed by the l bfgs b optimizer in this work we use the two step algorithm in all mpinn simulations unless it is stated otherwise at the beginning of the training process the parameters of the neural networks are randomly initialized using the xavier scheme glorot and bengio 2010 3 data requirements and convergence properties of dnn methods in this section we study properties of the dnn methods including data driven dnn pinn darcy and mpinn for data assimilation in subsurface transport problems described by eqs 7 and 8 we use a synthetic data set where the conductivity field is computed as k x 0 5 sin 4 π x 1 sin 4 π x 2 1 on the 256 128 uniform rectangular mesh the synthetic h x and c x fields are generated on the same mesh as numerical solutions of eqs 7 and 8 these equations are solved using the finite volume subsurface transport over multiple phase stomp code white et al 1995 the k x h x and c x fields are shown in fig 2 and in the following sections we refer to these fields as reference fields and use them to test the accuracy of the considered dnn methods we select nk nh and nc values of the k h and c fields at random locations on the mesh as the measurements training sets of the respective fields the rest of the fields values are used as the testing set to evaluate the accuracy of the dnn approximations in this case all reference fields are nonlinear with the h x and c x fields having the smallest and largest gradients respectively we quantify the accuracy of the dnn methods in terms of point errors and the relative l 2 errors that are defined as 11 ϵ γ 1 ω γ x 2 d x ω γ x γ x θ γ 2 d x for γ k h c where γ x and γ x θ γ denote the reference fields and the dnn approximations respectively we first investigate the effect of the dnn size nh mh on the approximation errors where nh is the number of hidden layers and mh is the number of neurons in each hidden layer note that all dnns have a two dimensional input layer corresponding to x 1 and x 2 and a one dimensional output layer corresponding to scalar quantities k h or c 3 1 data driven dnns for parameter estimation we test the accuracy of the data driven dnn approach i e regression for estimating k x to establish a baseline for comparison with the mpinn and pinn darcy methods the k dnn sizes and the corresponding mean and variance of the l 2 errors are summarized in table 1 the statistics of the l 2 errors are computed from five simulations in which the dnns are randomly initialized using the xavier algorithm the size of the networks is varied by changing the number of hidden layers nh while the number of neurons per layer is set to m h 32 the regression errors decrease from more than 100 for n k 16 to less than 4 for n k 96 we do not see a clear dependence of the errors on nh we attribute large errors for small nk to overfitting of the dnns various regularization methods were introduced to reduce dnn overfitting including dropout srivastava et al 2014 and l 1 and l 2 regularizers hastie et al 2009 goodfellow et al 2016 in the l 1 and l 2 regularization methods the l 1 and l 2 norms of the dnns parameters are added with the weight β in the dnn loss function nabian and meidani 2020 we investigate the effect of the l 1 and l 2 regularizers on the regression errors for the considered examples we test these regularization methods with β 10 5 10 6 and 10 7 and the best results are presented in table 1 the l 1 and l 2 regularizers reduce errors to less than 35 for n k 16 and less than 2 1 for n k 96 we also find that the ϵ k error depends on the choice of a regularization approach and the tuning coefficient β we demonstrate below that the pinn darcy and mpinn methods provide alternative physics based approaches to regularizing dnn training the advantage of using physics constraints is that the resulting solutions satisfy the governing equations while solutions obtained with the l 1 or l 2 regularizations in general do not in addition the pinn darcy and mpinn methods allow using indirect observations in addition or instead of direct observations in the k dnn training 3 2 the pinn darcy method here we examine the accuracy of the pinn darcy approach where the measurements of conductivity and hydraulic head as well as the darcy eq 7 are used to jointly train the k x θ k and h x θ h dnns the mean and standard deviations of ϵ k and ϵ h versus n n k n h are plotted in fig 3 a and c respectively for n f h 0 50 and 400 note that the pinn darcy method reduces to the data driven dnn method for n f h 0 for each case the mean and standard deviation of errors are computed from the errors of five dnns which are randomly initialized with the xavier algorithm in this test the measurements and residual points locations are randomly selected over the domain for comparison we also estimate k and h using the data driven dnn and pinn darcy methods with l 2 regularization the corresponding ϵ k and ϵ h errors are shown in fig 3 b and d respectively as expected the accuracy of the pinn darcy approach improves with increasing n for all considered n f h for a relatively small number of measurements n 80 the accuracy of the k approximation increases with increasing n f h i e both the mean ϵ k and its standard deviation decrease with an increasing number of residual points the effect of enforcing the darcy equation i e having n f h 0 is especially profound for sparse data for example for n 16 ϵ k in the pinn darcy method n f h 400 is 0 2 versus ϵ k 1 2 in the data driven dnn method note that for the same number of measurements the error in the estimated h is more than one order of magnitude smaller than that in k for both the data driven dnn and pinn darcy methods the estimated h field has smaller errors because of near linear behavior still pinn darcy yields a significantly smaller ϵ h than the data driven dnn method notably for a relatively large number of measurements in this case n 80 we observe that the ϵ k errors in pinn darcy are slightly larger than in the data driven dnn approach there are several reasons for this including in this example n 80 measurements are sufficient to accurately train k without any physics constraints as made evident by the small ϵ k the physics constraints in pinn darcy make the loss function more complicated and harder to minimize and the physics model might not be exact the synthetic h and c data are sampled from a weak form solution of the pdes while the strong form of pde constraints are enforced in the loss function which results in model errors we note that in real applications measurements are sparse and for sparse data the model errors are smaller than the regression errors this is made evident by our results for n 80 the l 2 regularization significantly reduces the mean and standard deviation of ϵ k and ϵ h however for n 50 the pinn darcy method with n f h 400 provides more accurate results for both the k and h fields adding l 2 regularization to the pinn method further reduces ϵ k and ϵ h especially for a relatively small number of residual points n f h because the computational cost of pinn darcy and mpinn increases with increasing n f h a combination of l 2 regularization and physics constraints can potentially reduce the computational cost of the pinn darcy and mpinn methods finally we analyze the loss functions decay during the k dnn training in the data driven dnn data driven dnn with l 2 regularization and pinn darcy methods with n k 36 n f h 200 and the l bfgs b optimizer these loss functions are shown in fig 4 the data driven dnn method exhibits overfitting as evident from the small training error and large test error see fig 3 c whereas both pinn darcy and l 2 regularizations prevent overfitting we also see that the l bfgs b optimizer is robust for these three approaches 3 3 the mpinn method here we investigate the mpinn method for jointly training the k x θ k h x θ h and c x θ c dnns fig 5 shows the mean errors of the mpinn estimated fields as functions of nk nh nc and n f c the number of points where the residuals of the darcy equation are minimized is set to n f h 200 in all cases for comparison we also show the pinn darcy mean ϵ k and ϵ h errors for a small number of k and h measurements n 50 the mpinn method reduces ϵ k by approximately 25 and ϵ h by 80 relative to the pinn darcy method the mpinn method leads to an even bigger improvement in the c field estimation relative to the data driven dnn method for example for n c 64 ϵ c is 0 02 in mpinn with n f c 1000 while ϵ c 0 22 in the data driven dnn method in addition the c field estimation improves as nk and nh increase this underscores the advantage of using mpinn instead of data driven dnn for data assimilation because it allows using indirect measurements to estimate quantities of interest e g using k and h measurements for estimating the c field finally we note that the two step adam l bfgs b minimization algorithm must be used in mpinn versus the one step l bfgs b algorithm in the data driven dnn and pinn darcy methods because adding multiphysics constraints makes it more difficult to find a good minimum of the mpinn loss function to illustrate the need for the two step approach in fig 6 we plot the total mpinn loss function and the loss related to the pde residual eq b 1b versus the number of epochs in this case we stop the adam optimizer when the total loss reaches a prescribed value of j 5 10 4 and apply the l bfgs b optimizer to achieve the final convergence of the loss function the stochastic gradient descent method in the adam algorithm causes oscillations in losses that allows a better dnn generalization the quasi newton l bfgs b method enables a higher rate of convergence to the minimum identified by the adam algorithm the small final value of j f c indicates that the c k and h dnns approximately satisfy the advection dispersion eq 8 the distributions of absolute point errors in the k x h x and c x fields learned with the data driven dnn data driven dnn with l 2 regularization pinn darcy and mpinn methods are given in figs 7 9 in this comparison study we use n k n h 36 n c 64 n f h 200 and n f c 1000 as expected from a regression method the data driven dnn method errors increase as distance from the measurement locations increases l 2 regularization helps reduce these errors the pinn darcy and mpinn methods further reduce point errors especially in parts of the domain with no measurements for example the data driven dnn method yields a poor approximation of c near the injection point with absolute point errors on the order of 0 1 in the mpinn method with the same number of c measurements the point errors in the same region are on the order of 0 01 4 dnn methods for estimating conductivity with complex correlation structure here we investigate the performance of the dnn methods for estimating the spatially correlated conductivity field k x exp y x with the exponential covariance function c y x x σ 2 exp x x 2 λ 2 where σ 2 and λ are the variance and correlation length of y x respectively specifically we study the performance of the dnn methods as a function of λ 4 1 optimal dnn size as a function of the correlation length λ in section 3 we showed that the network size affects the accuracy of the dnn predictions especially when the data is sparse in this section we study the dependence of the optimal dnn size on the correlation length of the approximated field we consider three k x fields generated as realizations of lognormal processes with λ 0 2 0 5 and 1 0 see fig 10 here we vary the dnn size by changing the number of neurons in each hidden layer mh the number of tunable parameters as a function of mh for the chosen dnn architecture is given in table 2 the conductivity fields in fig 10 are generated on the domain ω 0 1 0 0 5 on a 256 128 grid with 32 768 grid points here we use the values of k at 20 000 grid points to train k x θ k without any physics constraints and use the remaining k values to evaluate the accuracy of k x θ k for this large number of measurements we find that the l bfgs b algorithm is not efficient for minimizing the loss function especially for the field with λ 0 2 therefore we adopt the adam method with an experimentally determined initial learning rate of 0 0002 and a batch size of 1000 we find that 4 105 iterations are needed to train k x θ k for λ 0 2 3 105 iterations for λ 0 5 and 2 105 iterations for λ 1 0 to achieve a sufficiently low training error our results show that less iterations are needed to train dnns for smoother conductivity fields with larger correlation lengths fig 11 shows the mean and standard deviation of ϵ k as functions of mh for the three correlation lengths the statistical moments of ϵ k are computed from simulations with 10 different dnn initializations initially the approximation error decreases as the dnn size increases because of the improved dnn representation ability we can see that a smaller dnn is sufficient to represent a smoother field with larger correlation length we also see that for fields with the correlation lengths 0 5 and 1 the approximation error increases because of overfitting once the dnn size exceeds the optimal size for example for the k field with λ 0 5 see fig 11 b the smallest relative error of 0 52 is reached at m h 60 dnns with mh 60 are not representative enough and dnns with mh 60 cause overfitting therefore we postulate that for a dnn with three hidden layers m h 60 is optimal for this k field for the k fields with λ 0 2 and λ 1 0 the optimal dnn size is reached at m h 90 and m h 40 respectively for the k field with λ 1 0 the minimum of the mean error function 0 3 is very shallow as shown in fig 11 c therefore we select m h 40 as the optimal dnn width because it results in the ϵ k with the smallest standard deviation fig 12 shows the optimal dnn size as a function of λ for the considered range of λ the dnn size decreases as a power of λ it is important to note that in addition to the correlation length of the modeled field the optimal dnn size depends on many other factors including the type of activation function and the number of hidden layers in this study we fix the number of hidden layers and the activation function therefore the results in fig 12 might not apply to other dnn architectures 4 2 data assimilation next we compare the data driven dnn pinn darcy and mpinn methods for data assimilation as well as parameter and state estimation using the k h and c measurements the k fields shown in fig 10 are used as the ground truth the reference h and c fields are generated as the solutions of the darcy and advection dispersion equations using the stomp code based on the analysis in section 4 1 we use the 3 60 dnn architecture for all three k fields because this network size produces a reasonable fit for these fields we adopt the two step training procedure where the adam algorithm with a learning rate of 0 0002 is followed by the l bfgs b method with the threshold of 0 0005 fig 13 compares the approximation errors in the data driven dnn pinn darcy and mpinn methods as functions of nk for the three conductivity fields in these simulations we use n h 40 n c 100 n f h 1000 and n f c 1000 for all three correlation lengths we see that adding physics constraints improves the accuracy of the dnn approximation of the k field the biggest reduction in the estimation error is achieved by adding h measurements and the darcy equation constraint as shown by the comparison of the data driven dnn and pinn darcy estimation errors adding c measurements and advection dispersion equation constraints further reduces the approximation error the advantage of mpinn is especially pronounced for sparse data small nk and small correlation lengths for example for λ 0 2 and n k 20 the ϵ k errors are 1 8 0 66 and 0 57 in the data driven dnn pinn darcy and mpinn methods respectively table 3 lists ϵ h and ϵ c as functions of nk for the data driven dnn pinn darcy and mpinn methods and the k fields with λ 0 2 0 5 and 1 we can see here that the pinn darcy and mpinn methods provide significantly improved hydraulic head and concentration estimations compared to the data driven dnn method we note that nh and nc are fixed in this comparison study and the data driven dnn hydraulic head and concentration estimates do not depend on nk moreover the pinn darcy and mpinn estimations of h and c improve with increasing nk this demonstrates the capability of the physics informed dnns to learn from indirect measurements the improvements are particularly pronounced for estimating highly nonlinear c x e g for λ 1 and n c 100 ϵ c decreases from 16 72 in the data driven dnn to 1 35 in mpinn figs 14 16 show the k x h x and c x dnns estimated with the data driven dnn pinn darcy and mpinn methods where λ 0 5 n k 40 n h 40 n c 100 n f h 1000 and n f c 1000 in fig 14 the comparison of the estimated and reference k fields shows that pinn darcy significantly improves the data driven dnn prediction mpinn further improves the k estimation as indicated by the smaller ϵ k the data driven dnn approximation near the upper left corner significantly differs from the ground truth k field due to the lack of measurements in this region however the approximation error around this area is greatly reduced in the pinn darcy and mpinn methods which leverages indirect observations i e head and concentration observations located in this area as shown in fig 14 c and d although a relatively good approximation of h can be obtained with all three methods see fig 15 we still observe some improvements using the pinn darcy and mpinn approaches for the highly nonlinear c field the data driven dnn estimate is significantly less accurate than that found using mpinn in terms of both the point and l 2 errors as shown in fig 16 notably mpinn is able to accurately describe the eye of the concentration plume with very few direct measurements near this region once again this demonstrates that mpinn can use sparse direct and indirect measurements in combination with pdes to capture local features that otherwise cannot be described with only direct measurements finally we investigate whether using the optimal size k dnn as determined in section 4 1 would reduce the error in the estimated k h and c fields as an example we choose the case with λ 0 2 according to fig 11 a the optimal k size for a field with λ 0 2 is m h 90 table 4 presents the estimation errors for the k dnns with m h 60 90 and 120 in this comparison study we fix the h and c dnns size at m h 60 and use n k 80 n h 40 n c 100 measurements and n f h 1000 and n f c 1000 residual points we can see that the optimal size k produces the smallest estimation errors not only for the k field but also for the h field in the data driven dnn pinn darcy and mpinn methods for the c field the smallest error is achieved with m h 60 in the k dnn this indicates that a smaller estimation error in k and h does not always translate to a smaller error in c 5 conclusion in this study we presented the mpinn approach for data assimilation with a focus on parameter and state estimation in subsurface transport problems in this approach all unknown space dependent parameters and states are modeled with dnns that are jointly trained by minimizing the loss function containing the multiphysics data e g conductivity hydraulic head and concentration measurements and the associated physics constraints including the darcy and advection dispersion equations as a result the dnns can be trained using indirect measurements and underlying physics in an unsupervised learning fashion which is important when the data is sparse we compared three dnn methods 1 the pure data driven dnn approach which only uses data to train dnns 2 the pinn approach called pinn darcy which utilizes the conductivity and hydraulic head measurements and the darcy equation and 3 the mpinn approach which combines the conductivity head and concentration measurements with the darcy and advection dispersion equations our numerical results show that both physics informed methods pinn darcy and mpinn are significantly more accurate for parameter estimation than the data driven dnn method the physics informed methods provide regularization and reduce the uncertainty in dnn predictions especially when the direct measurements are limited furthermore mpinn yields better parameter and state estimation than pinn darcy we investigated the effect of the neural network size on the accuracy of parameter and state estimation as a function of the correlation length of the modeled k field we demonstrated that in pure data driven regression small and large networks might result in poor representability or overfitting and that an optimal dnn size increases with decreasing correlation length the physics constraints and added measurements reduce dependence of the dnn prediction on the dnn size given that the dnn is large representative enough however for a small number of measurements we demonstrated that an optimal size dnn outperforms both the larger and smaller dnns in subsurface applications data is usually sparse and is often indirect therefore the mpinn approach offers a flexible and unified framework to deal with sparse and multiphysics data because the proposed method involves training dnns by minimizing the loss function the performance of training algorithms is crucial in our study we found that introducing nonlinear pde constraints into the loss function increases the computational cost of training application of the physics informed dnns to large scale problems will require access to multi gpu computers and scalable training algorithms the selection of training algorithms and hyperparameters learning rate architecture of dnns etc should also be studied in more details credit authorship contribution statement qizhi he methodology software formal analysis validation investigation writing original draft david barajas solano formal analysis guzel tartakovsky formal analysis alexandre m tartakovsky conceptualization methodology writing original draft project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement this research was partially supported by the u s department of energy doe advanced scientific computing ascr program pnnl is operated by battelle for the doe under contract de ac05 76rl01830 appendix a dnn approximation in mpinn we use a fully connected feed forward network architecture known as multilayer perceptrons where the basic computing units neurons are stacked in layers as shown in fig a 17 the dnn approximation u x θ of a function u x is given as a 1 u x u x θ y n l 1 y n l y 2 x where denotes the dnn approximation and a 2 y 2 x σ w 1 x b 1 y 3 y 2 σ w 2 y 2 b 2 y n l y n l 1 σ w n l 1 y n l 1 b n l 1 y n l 1 y n l w n l y n l b n l the first layer is called the input layer and the last layer is the output layer while all the intermediate layers are known as hidden layers here nl denotes the number of hidden layers σ is the predefined activation function x r d denotes the input d is the number of spatial dimensions y n l 1 is the output vector and θ denotes all weight and bias parameters in the dnn approximation of u a 3 θ w 1 w 2 w n l b 1 b 2 b n l in the data driven approach θ is directly estimated from the measurements of u by minimizing the loss function l θ x t u u x θ u x 2 a 4 θ arg min θ x t u u x θ u x 2 where t u x 1 x 2 x t u ω denotes a set of measurement locations ω r d is the domain of the function u and u x x t u are the measured values of u at these locations some of the commonly used activation functions include logistic sigmoid hyperbolic tangent relu and leaky relu because the objective of this study is to approximate differentiable functions space dependent parameters and state variables in partial differential equations we adopt the hyperbolic tangent activation function σ x tanh x which is infinitely differentiable appendix b multiphysics informed neural networks for coupled darcy flow and advection dispersion equations next the residuals of eqs 7 and 8 are expressed in terms of θk θh and θc as b 1a f h x θ k θ h k x θ k h x θ h b 1b f c x θ k θ h θ c 1 ϕ k x θ k h x θ h c x θ c d c x θ c to enforce the neumann boundary conditions for eqs 7 and 8 we define dnns that approximate fluxes at the boundaries b 2 f n 1 h x θ k θ h k x h x x 1 q f n 2 h x θ k θ h k x h x x 2 and b 3 f n 1 c x θ c c x x 1 f n 2 c x θ c c x x 2 the loss function is then defined as b 4 j θ k θ h θ c j d θ k θ h θ c j f h θ k θ h j f c θ k θ h θ c j n 1 h θ k θ h j n 2 h θ k θ h j n 1 c θ c j n 2 c θ c j b h θ h j b c θ c where the loss due to mismatch with data is b 5 j d θ k θ h θ c 1 n k i n k k x i k θ k k i 2 1 n h i n h h x i h θ h h i 2 1 n c i n c c x i c θ c c i 2 and the losses due to partial differential equatian pde constraints and boundary conditions are b 6 j f h θ k θ h 1 t f h x t f h f h x θ k θ h 2 j f c θ k θ h θ c 1 t f c x t f c f c x θ k θ h θ c 2 j n 1 h θ k θ h 1 t n 1 h x t n 1 h f n 1 h x θ k θ h 2 j n 2 h θ k θ h 1 t n 2 h x t n 2 h f n 2 h x θ k θ h 2 j n 1 c θ c 1 t n 1 c x t n 1 c f n 1 c x θ c 2 j n 2 c θ c 1 t n 2 c x t n 2 c f n 2 c x θ c 2 j b h θ h 1 t b h x t b h h x θ h h x 2 j b c θ c 1 t b c x t b c c x θ c c x 2 in eq b 6 pdes 7 and 8 are enforced at the residual points given by the sets t f h and t f c respectively where t f h n f h and t f c n f c the terms with the subscripts n 1 or n 2 enforce the neumann boundary conditions and those with the subscript b enforce the dirichlet boundary conditions supplementary material supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103610 appendix c supplementary materials supplementary data s1 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s1 
481,data assimilation for parameter and state estimation in subsurface transport problems remains a significant challenge because of the sparsity of measurements the heterogeneity of porous media and the high computational cost of forward numerical models we present a multiphysics informed deep neural network machine learning method for estimating space dependent hydraulic conductivity hydraulic head and concentration fields from sparse measurements in this approach we employ individual deep neural networks dnns to approximate the unknown parameters e g hydraulic conductivity and states e g hydraulic head and concentration of a physical system next we jointly train these dnns by minimizing the loss function that consists of the governing equations residuals in addition to the error with respect to measurement data we apply this approach to assimilate conductivity hydraulic head and concentration measurements for the joint inversion of these parameter and states in a steady state advection dispersion problem we study the accuracy of the proposed data assimilation approach with respect to the data size i e the number of measured variables and the number of measurements of each variable dnn size and the complexity of the parameter field we demonstrate that the physics informed dnns are significantly more accurate than the standard data driven dnns especially when the training set consists of sparse data we also show that the accuracy of parameter estimation increases as more different multiphysics variables are inverted jointly keywords physics informed deep neural networks data assimilation parameter estimation inverse problems subsurface flow and transport 1 introduction modeling of transport in heterogeneous porous media is a part of many environmental and engineering applications including hydrocarbon recovery hartmann and beaumont 1999 hydraulic fracking hubbert and willis 1972 exploitation of geothermal energy barbier 2002 geologic disposal of radioactive waste helton 1993 and groundwater contamination assessment rajib et al 2017 numerical models of transport in porous media require deterministic or statistical knowledge of the subsurface properties e g hydraulic conductivity and initial and boundary conditions bear and cheng 2010 white et al 1995 however because of heterogeneity and data sparsity the parameters of natural systems are often not fully known despite significant research in inverse methods hoeksema and kitanidis 1984 vrugt et al 2008 rajib et al 2017 rajabi et al 2018 parameter estimation at a resolution required for accurate modeling of transport processes remains a challenge parameter estimation is complicated by the fact that the parameters of interest e g hydraulic conductivity are difficult to measure directly most inverse parameter estimation methods use indirect measurements in addition to direct measurements to estimate parameters data assimilation or model data integration has been well recognized as an effective technique to reduce predictive uncertainties and improve model accuracy data assimilation is a process where model parameters and system states are updated using measurements and governing equations rajib et al 2017 evensen 1994 rayner et al 2016 data assimilation has been used in many fields including atmospheric and oceanic sciences evensen 2003 houtekamer and mitchell 2001 hydrology christakos 2005 vrugt et al 2008 subsurface transport rajib et al 2017 rajabi et al 2018 zheng et al 2019 and uncertainty quantification vrugt et al 2005 liu and gupta 2007 data assimilation in subsurface applications is challenging because the subsurface flow and transport equations are highly nonlinear and the states and parameters are non gaussian zheng et al 2019 this nonlinearity poses a difficulty for both the direct inverse methods and bayesian parameter estimation methods recent advances in machine learning ml methods automatic differentiation ad baydin et al 2015 and ml libraries e g tensorflow ramsundar and zadeh 2018 and pytorch paszke et al 2017 have made them potentially powerful tools for parameter estimation and data assimilation for example bongard and lipson 2007 applied symbolic regression to learn conservation laws and brunton et al 2016 used sparse regression to discover equations of nonlinear dynamics directly from data physics informed deep neural networks pinns were used to learn solutions and parameters in partial and ordinary differential equations raissi et al 2019 lagaris et al 1997 weinan and yu 2018 raissi et al 2019 recently pinns were extended for inverse problems associated with partial differential equations pdes with space dependent coefficients e g to estimate hydraulic conductivity using sparse measurements of conductivity and hydraulic head tartakovsky et al 2020 in this study we extend the pinn based parameter estimation method of tartakovsky et al 2020 to assimilate multiphysics measurement and refer to this multiphysics informed neural network approach as mpinn we consider a subsurface transport problem with sparse measurements of hydraulic conductivity hydraulic head and solute concentration in this approach we use the darcy and advection dispersion equations together with data to train deep neural networks dnns that represent space dependent conductivity head and concentration fields during training of the dnns the governing equations and the associated boundary conditions are enforced at the residual points over the domain we demonstrate that for sparse data the mpinn approach significantly improves the accuracy of parameter and state estimation as compared to standard dnns trained with data only the mpinn approach can be easily extended to assimilate other types of variables and physics laws e g geophysical measurements and the corresponding equations that describe the relationships between electrical resistivity current and potential this paper is organized as follows in section 2 we describe the mpinn method and its formulation for transport problems the performance of the mpinn approach for data assimilation including the dependence of estimation errors on the number of measurements is given in section 3 the effects of the neural network size and the conductivity field correlation length on the parameter estimation errors are discussed in section 4 conclusions are given in section 5 2 mpinn for data assimilation in this section we present the mpinn approach for multiphysics data assimilation and its formulation for subsurface transport applications we also discuss the automatic differentiation and two step training algorithm that are used in the mpinn approach 2 1 general mpinn formulation in the pinn approach and its mpinn extension we employ fully connected feed forward networks to approximate unknown variables states and space dependent parameters as described in appendix a and shown in fig a 17 given a sufficiently large number of hidden layers dnns have excellent representative properties but require a lot of data to train them this creates a challenge in applying dnns to subsurface problems where measurements are usually sparse for the purpose of this work we define sparse measurements as those that do not sufficiently cover the computational domain to accurately estimate parameters with the standard data driven dnns method described in appendix a in tartakovsky et al 2020 we demonstrated that the darcy law can be used as a constraint for training a dnn model of conductivity that significantly improves the predictive ability of the dnn model in the rest of this section we extend the pinn parameter estimation method of tartakovsky et al 2020 to a data assimilation problem where different types of measurements are used to estimate parameters and states consider a system of pdes forming the boundary value problem defined on the domain ω r d with the boundary ω 1 l u x p x 0 x ω b u x p x 0 x ω where u is the unknown solution vector can include head concentrations saturation electrical potential and other variables p is the unknown system parameter vector e g hydraulic and electric conductivities l denotes the known nonlinear differential operator and the operator b expresses arbitrary boundary conditions associated with the problem the boundary conditions can be of the dirichlet and neumann types applied on d ω and n ω respectively such that d ω n ω ω and d ω n ω we use the dnns to approximate both state variables and unknown parameters u x u x θ and p x p x γ x ω where θ and γ are weights which need to be estimated or trained in the corresponding dnns to determine these weights we minimize the loss function j θ γ with physics informed penalty terms 2 θ γ arg min θ γ j θ γ where 3 j θ γ j d θ γ ω f j f θ γ ω b j b θ γ here jd θ γ is the loss due to a mismatch with the data i e the measurements of u and p 4 j d θ γ 1 t u x t u u x θ u x 2 1 t p x t p p x θ p x 2 jf θ γ is the loss due to mismatch with the governing pdes l u x p x 0 5 j f θ γ 1 t f x t f l u x θ p x γ 2 and jb θ γ is the loss due to mismatch with the boundary conditions b u x p x 0 6 j b θ γ 1 t b x t b b u x θ p x γ 2 in 3 ωf and ωb are weights that determine how strongly mismatch with the governing pdes and boundary conditions is penalized relative to data mismatch in this work we assume that the measurements and physics model are exact and set ω f ω b 1 the sets t u x 1 x 2 x t u ω and t p x 1 x 2 x t p ω denote the measurement locations of u and p respectively and u x x t u and p x x t p are the measured values of u and p at these locations the sets t f x 1 x 2 x t f ω and t b x 1 x 2 x t b ω denote locations of the residual points where jf θ γ and jb θ γ are respectively minimized the penalty terms jf θ γ and jb θ γ force the dnn approximations of u and p to satisfy the governing eq 1 at the residual points note that while it is preferable to enforce physics over the whole domain the computational cost of estimating and minimizing the loss function 3 increases with the number of residual points in this work we demonstrate convergence of the solution of 2 with an increasing number of residual points meaning that the dnns u x θ and p x γ can be accurately trained using a finite number of residual points similar convergence results for solving pdes with the pinn method were also observed in raissi et al 2019 lu et al 2019 tartakovsky et al 2020 lagaris et al 1997 and rudd et al 2013 the loss jf θ γ is evaluated by computing spatial derivatives of u x θ and p x γ using ad ad is also used to evaluate the normal derivative n in the neumann boundary condition in the loss jb θ γ see details in section 2 2 ad is implemented in most ml libraries including tensorflow and pytorch paszke et al 2017 where it is mainly used to compute derivatives with respect to the dnn weights i e θ and γ in the pinn method ad allows the implementation of any pde and boundary condition constraints without numerically discretizing and solving the pdes another benefit of enforcing pde constraints via the penalty term jf θ γ is that it allows using the corresponding weight ωf to account for the fidelity of the pde model for example we can assign a smaller weight to a low fidelity pde model in general the number of unknown parameters in θ and γ is much larger than the number of measurements and training the dnns requires regularization one can consider the losses jb θ γ and jf θ γ in the minimization problem 2 as physics informed regularization terms tartakovsky et al 2020 nabian and meidani 2020 2 2 application of mpinn for subsurface transport problems for sparsely sampled systems data assimilation can significantly improve the accuracy of parameter and state estimation here we assume that the sparse steady state measurements of a synthetic tracer test in a heterogeneous porous domain ω 0 l 1 0 l 2 are available where the solute is continually injected at the x 1 0 boundary this data includes the measurements of conductivity k i k x i k hydraulic head h i h x i h and concentration c i c x i c at the locations x i k i 1 n k x i h i 1 n h and x i c i 1 n c respectively where nk nh and nc are the number of measurements of each variable our objective is to learn the conductivity head and concentration fields based on these measurements we further assume that the concentration hydraulic head and conductivity data can be accurately modeled by the steady state darcy flow equations 7 v x k x ϕ h x v x 0 x ω h x h 2 x 1 l 1 k x h x x 1 q x 1 0 k x h x x 2 0 x 2 0 or x 2 l 2 and advection dispersion equation 8 v x c x d c x x ω c x c 0 x 2 x 1 0 c x x 1 0 x 1 l 1 c x x 2 0 x 2 0 or x 2 l 2 where ϕ is the effective porosity of the medium v is the average pore velocity and d is the dispersion coefficient 9 d d w τ i α v 2 here i is the identity tensor dw is the diffusion coefficient τ is the tortuosity of the medium and α is the dispersivity tensor with the diagonal components αl and αt the conductivity k x is assumed to be unknown except at the measurement locations x i k i 1 n k in the following simulations we set the parameters as l 1 1 m l 2 0 5 m h 2 0 m q 1 m hr c 0 x 2 c exp x 2 l 2 2 2 ϵ 2 c 1 kg m 3 ϵ 0 25 m ϕ 0 317 d w 0 09 m 2 hr τ ϕ 1 3 0 681 α l 0 01 m and α t 0 001 m we start by defining the dnn representations of k x h x and c x as 10 k x n k x θ k h x n h x θ h c x n c x θ c where θk θh and θc are the vectors of parameters associated with each neural network for the considered two dimensional problem the dimension of the input layers in these dnns is two the k h and c fields are scalar therefore the dimensionality of the output layers in these dnns is one the specific form of the general loss function 3 for training these dnns is given by eqs b 4 b 6 in appendix b in eq b 6 pdes 7 and 8 are enforced at the residual points given by the sets t f h and t f c respectively where t f h n f h and t f c n f c a schematic diagram of the mpinn method for data assimilation in the transport problem described by eqs 7 and 8 is shown in fig 1 in this work we compare three approaches for training k the mpinn approach where we jointly train the dnns k h and c by minimizing the loss function b 4 the pinn darcy approach where we jointly train k and h by only enforcing the darcy equation and boundary conditions 7 and the data driven dnn approach where we separately train k h and c using only data the performance of these three approaches is investigated and compared in sections 3 and 4 given that the loss function is highly nonlinear and non convex with respect to the network parameters θk θh and θc we use the gradient descent minimization algorithms including the adam kingma and ba 2014 and l bfgs b byrd et al 1995 methods in the l bfgs b optimizer the iterative minimization process is terminated once the relative change in the loss function becomes smaller than a prescribed value in the adam method the dnns training stops once the total loss function becomes smaller than a prescribed small value or the predefined number of iterations epochs is completed as suggested in raissi et al 2019 tartakovsky et al 2020 berg and nyström 2018 and le et al 2011 l bfgs b a quasi newtown method shows superior performance with a better rate of convergence lower gradient vanishing and a lower computational cost for problems with a relatively small amount of training data and or residual points in this study we employ the l bfgs b method for the data driven dnn and pinn darcy methods with the default settings from scipy jones et al 2001 however our numerical experiments show that the l bfgs b algorithm has a slow convergence for the mpinn method where a relatively large number of residual points is used we propose a two step training algorithm where the loss function is first minimized by the adam algorithm with a prescribed stop criterion followed by the l bfgs b optimizer in this work we use the two step algorithm in all mpinn simulations unless it is stated otherwise at the beginning of the training process the parameters of the neural networks are randomly initialized using the xavier scheme glorot and bengio 2010 3 data requirements and convergence properties of dnn methods in this section we study properties of the dnn methods including data driven dnn pinn darcy and mpinn for data assimilation in subsurface transport problems described by eqs 7 and 8 we use a synthetic data set where the conductivity field is computed as k x 0 5 sin 4 π x 1 sin 4 π x 2 1 on the 256 128 uniform rectangular mesh the synthetic h x and c x fields are generated on the same mesh as numerical solutions of eqs 7 and 8 these equations are solved using the finite volume subsurface transport over multiple phase stomp code white et al 1995 the k x h x and c x fields are shown in fig 2 and in the following sections we refer to these fields as reference fields and use them to test the accuracy of the considered dnn methods we select nk nh and nc values of the k h and c fields at random locations on the mesh as the measurements training sets of the respective fields the rest of the fields values are used as the testing set to evaluate the accuracy of the dnn approximations in this case all reference fields are nonlinear with the h x and c x fields having the smallest and largest gradients respectively we quantify the accuracy of the dnn methods in terms of point errors and the relative l 2 errors that are defined as 11 ϵ γ 1 ω γ x 2 d x ω γ x γ x θ γ 2 d x for γ k h c where γ x and γ x θ γ denote the reference fields and the dnn approximations respectively we first investigate the effect of the dnn size nh mh on the approximation errors where nh is the number of hidden layers and mh is the number of neurons in each hidden layer note that all dnns have a two dimensional input layer corresponding to x 1 and x 2 and a one dimensional output layer corresponding to scalar quantities k h or c 3 1 data driven dnns for parameter estimation we test the accuracy of the data driven dnn approach i e regression for estimating k x to establish a baseline for comparison with the mpinn and pinn darcy methods the k dnn sizes and the corresponding mean and variance of the l 2 errors are summarized in table 1 the statistics of the l 2 errors are computed from five simulations in which the dnns are randomly initialized using the xavier algorithm the size of the networks is varied by changing the number of hidden layers nh while the number of neurons per layer is set to m h 32 the regression errors decrease from more than 100 for n k 16 to less than 4 for n k 96 we do not see a clear dependence of the errors on nh we attribute large errors for small nk to overfitting of the dnns various regularization methods were introduced to reduce dnn overfitting including dropout srivastava et al 2014 and l 1 and l 2 regularizers hastie et al 2009 goodfellow et al 2016 in the l 1 and l 2 regularization methods the l 1 and l 2 norms of the dnns parameters are added with the weight β in the dnn loss function nabian and meidani 2020 we investigate the effect of the l 1 and l 2 regularizers on the regression errors for the considered examples we test these regularization methods with β 10 5 10 6 and 10 7 and the best results are presented in table 1 the l 1 and l 2 regularizers reduce errors to less than 35 for n k 16 and less than 2 1 for n k 96 we also find that the ϵ k error depends on the choice of a regularization approach and the tuning coefficient β we demonstrate below that the pinn darcy and mpinn methods provide alternative physics based approaches to regularizing dnn training the advantage of using physics constraints is that the resulting solutions satisfy the governing equations while solutions obtained with the l 1 or l 2 regularizations in general do not in addition the pinn darcy and mpinn methods allow using indirect observations in addition or instead of direct observations in the k dnn training 3 2 the pinn darcy method here we examine the accuracy of the pinn darcy approach where the measurements of conductivity and hydraulic head as well as the darcy eq 7 are used to jointly train the k x θ k and h x θ h dnns the mean and standard deviations of ϵ k and ϵ h versus n n k n h are plotted in fig 3 a and c respectively for n f h 0 50 and 400 note that the pinn darcy method reduces to the data driven dnn method for n f h 0 for each case the mean and standard deviation of errors are computed from the errors of five dnns which are randomly initialized with the xavier algorithm in this test the measurements and residual points locations are randomly selected over the domain for comparison we also estimate k and h using the data driven dnn and pinn darcy methods with l 2 regularization the corresponding ϵ k and ϵ h errors are shown in fig 3 b and d respectively as expected the accuracy of the pinn darcy approach improves with increasing n for all considered n f h for a relatively small number of measurements n 80 the accuracy of the k approximation increases with increasing n f h i e both the mean ϵ k and its standard deviation decrease with an increasing number of residual points the effect of enforcing the darcy equation i e having n f h 0 is especially profound for sparse data for example for n 16 ϵ k in the pinn darcy method n f h 400 is 0 2 versus ϵ k 1 2 in the data driven dnn method note that for the same number of measurements the error in the estimated h is more than one order of magnitude smaller than that in k for both the data driven dnn and pinn darcy methods the estimated h field has smaller errors because of near linear behavior still pinn darcy yields a significantly smaller ϵ h than the data driven dnn method notably for a relatively large number of measurements in this case n 80 we observe that the ϵ k errors in pinn darcy are slightly larger than in the data driven dnn approach there are several reasons for this including in this example n 80 measurements are sufficient to accurately train k without any physics constraints as made evident by the small ϵ k the physics constraints in pinn darcy make the loss function more complicated and harder to minimize and the physics model might not be exact the synthetic h and c data are sampled from a weak form solution of the pdes while the strong form of pde constraints are enforced in the loss function which results in model errors we note that in real applications measurements are sparse and for sparse data the model errors are smaller than the regression errors this is made evident by our results for n 80 the l 2 regularization significantly reduces the mean and standard deviation of ϵ k and ϵ h however for n 50 the pinn darcy method with n f h 400 provides more accurate results for both the k and h fields adding l 2 regularization to the pinn method further reduces ϵ k and ϵ h especially for a relatively small number of residual points n f h because the computational cost of pinn darcy and mpinn increases with increasing n f h a combination of l 2 regularization and physics constraints can potentially reduce the computational cost of the pinn darcy and mpinn methods finally we analyze the loss functions decay during the k dnn training in the data driven dnn data driven dnn with l 2 regularization and pinn darcy methods with n k 36 n f h 200 and the l bfgs b optimizer these loss functions are shown in fig 4 the data driven dnn method exhibits overfitting as evident from the small training error and large test error see fig 3 c whereas both pinn darcy and l 2 regularizations prevent overfitting we also see that the l bfgs b optimizer is robust for these three approaches 3 3 the mpinn method here we investigate the mpinn method for jointly training the k x θ k h x θ h and c x θ c dnns fig 5 shows the mean errors of the mpinn estimated fields as functions of nk nh nc and n f c the number of points where the residuals of the darcy equation are minimized is set to n f h 200 in all cases for comparison we also show the pinn darcy mean ϵ k and ϵ h errors for a small number of k and h measurements n 50 the mpinn method reduces ϵ k by approximately 25 and ϵ h by 80 relative to the pinn darcy method the mpinn method leads to an even bigger improvement in the c field estimation relative to the data driven dnn method for example for n c 64 ϵ c is 0 02 in mpinn with n f c 1000 while ϵ c 0 22 in the data driven dnn method in addition the c field estimation improves as nk and nh increase this underscores the advantage of using mpinn instead of data driven dnn for data assimilation because it allows using indirect measurements to estimate quantities of interest e g using k and h measurements for estimating the c field finally we note that the two step adam l bfgs b minimization algorithm must be used in mpinn versus the one step l bfgs b algorithm in the data driven dnn and pinn darcy methods because adding multiphysics constraints makes it more difficult to find a good minimum of the mpinn loss function to illustrate the need for the two step approach in fig 6 we plot the total mpinn loss function and the loss related to the pde residual eq b 1b versus the number of epochs in this case we stop the adam optimizer when the total loss reaches a prescribed value of j 5 10 4 and apply the l bfgs b optimizer to achieve the final convergence of the loss function the stochastic gradient descent method in the adam algorithm causes oscillations in losses that allows a better dnn generalization the quasi newton l bfgs b method enables a higher rate of convergence to the minimum identified by the adam algorithm the small final value of j f c indicates that the c k and h dnns approximately satisfy the advection dispersion eq 8 the distributions of absolute point errors in the k x h x and c x fields learned with the data driven dnn data driven dnn with l 2 regularization pinn darcy and mpinn methods are given in figs 7 9 in this comparison study we use n k n h 36 n c 64 n f h 200 and n f c 1000 as expected from a regression method the data driven dnn method errors increase as distance from the measurement locations increases l 2 regularization helps reduce these errors the pinn darcy and mpinn methods further reduce point errors especially in parts of the domain with no measurements for example the data driven dnn method yields a poor approximation of c near the injection point with absolute point errors on the order of 0 1 in the mpinn method with the same number of c measurements the point errors in the same region are on the order of 0 01 4 dnn methods for estimating conductivity with complex correlation structure here we investigate the performance of the dnn methods for estimating the spatially correlated conductivity field k x exp y x with the exponential covariance function c y x x σ 2 exp x x 2 λ 2 where σ 2 and λ are the variance and correlation length of y x respectively specifically we study the performance of the dnn methods as a function of λ 4 1 optimal dnn size as a function of the correlation length λ in section 3 we showed that the network size affects the accuracy of the dnn predictions especially when the data is sparse in this section we study the dependence of the optimal dnn size on the correlation length of the approximated field we consider three k x fields generated as realizations of lognormal processes with λ 0 2 0 5 and 1 0 see fig 10 here we vary the dnn size by changing the number of neurons in each hidden layer mh the number of tunable parameters as a function of mh for the chosen dnn architecture is given in table 2 the conductivity fields in fig 10 are generated on the domain ω 0 1 0 0 5 on a 256 128 grid with 32 768 grid points here we use the values of k at 20 000 grid points to train k x θ k without any physics constraints and use the remaining k values to evaluate the accuracy of k x θ k for this large number of measurements we find that the l bfgs b algorithm is not efficient for minimizing the loss function especially for the field with λ 0 2 therefore we adopt the adam method with an experimentally determined initial learning rate of 0 0002 and a batch size of 1000 we find that 4 105 iterations are needed to train k x θ k for λ 0 2 3 105 iterations for λ 0 5 and 2 105 iterations for λ 1 0 to achieve a sufficiently low training error our results show that less iterations are needed to train dnns for smoother conductivity fields with larger correlation lengths fig 11 shows the mean and standard deviation of ϵ k as functions of mh for the three correlation lengths the statistical moments of ϵ k are computed from simulations with 10 different dnn initializations initially the approximation error decreases as the dnn size increases because of the improved dnn representation ability we can see that a smaller dnn is sufficient to represent a smoother field with larger correlation length we also see that for fields with the correlation lengths 0 5 and 1 the approximation error increases because of overfitting once the dnn size exceeds the optimal size for example for the k field with λ 0 5 see fig 11 b the smallest relative error of 0 52 is reached at m h 60 dnns with mh 60 are not representative enough and dnns with mh 60 cause overfitting therefore we postulate that for a dnn with three hidden layers m h 60 is optimal for this k field for the k fields with λ 0 2 and λ 1 0 the optimal dnn size is reached at m h 90 and m h 40 respectively for the k field with λ 1 0 the minimum of the mean error function 0 3 is very shallow as shown in fig 11 c therefore we select m h 40 as the optimal dnn width because it results in the ϵ k with the smallest standard deviation fig 12 shows the optimal dnn size as a function of λ for the considered range of λ the dnn size decreases as a power of λ it is important to note that in addition to the correlation length of the modeled field the optimal dnn size depends on many other factors including the type of activation function and the number of hidden layers in this study we fix the number of hidden layers and the activation function therefore the results in fig 12 might not apply to other dnn architectures 4 2 data assimilation next we compare the data driven dnn pinn darcy and mpinn methods for data assimilation as well as parameter and state estimation using the k h and c measurements the k fields shown in fig 10 are used as the ground truth the reference h and c fields are generated as the solutions of the darcy and advection dispersion equations using the stomp code based on the analysis in section 4 1 we use the 3 60 dnn architecture for all three k fields because this network size produces a reasonable fit for these fields we adopt the two step training procedure where the adam algorithm with a learning rate of 0 0002 is followed by the l bfgs b method with the threshold of 0 0005 fig 13 compares the approximation errors in the data driven dnn pinn darcy and mpinn methods as functions of nk for the three conductivity fields in these simulations we use n h 40 n c 100 n f h 1000 and n f c 1000 for all three correlation lengths we see that adding physics constraints improves the accuracy of the dnn approximation of the k field the biggest reduction in the estimation error is achieved by adding h measurements and the darcy equation constraint as shown by the comparison of the data driven dnn and pinn darcy estimation errors adding c measurements and advection dispersion equation constraints further reduces the approximation error the advantage of mpinn is especially pronounced for sparse data small nk and small correlation lengths for example for λ 0 2 and n k 20 the ϵ k errors are 1 8 0 66 and 0 57 in the data driven dnn pinn darcy and mpinn methods respectively table 3 lists ϵ h and ϵ c as functions of nk for the data driven dnn pinn darcy and mpinn methods and the k fields with λ 0 2 0 5 and 1 we can see here that the pinn darcy and mpinn methods provide significantly improved hydraulic head and concentration estimations compared to the data driven dnn method we note that nh and nc are fixed in this comparison study and the data driven dnn hydraulic head and concentration estimates do not depend on nk moreover the pinn darcy and mpinn estimations of h and c improve with increasing nk this demonstrates the capability of the physics informed dnns to learn from indirect measurements the improvements are particularly pronounced for estimating highly nonlinear c x e g for λ 1 and n c 100 ϵ c decreases from 16 72 in the data driven dnn to 1 35 in mpinn figs 14 16 show the k x h x and c x dnns estimated with the data driven dnn pinn darcy and mpinn methods where λ 0 5 n k 40 n h 40 n c 100 n f h 1000 and n f c 1000 in fig 14 the comparison of the estimated and reference k fields shows that pinn darcy significantly improves the data driven dnn prediction mpinn further improves the k estimation as indicated by the smaller ϵ k the data driven dnn approximation near the upper left corner significantly differs from the ground truth k field due to the lack of measurements in this region however the approximation error around this area is greatly reduced in the pinn darcy and mpinn methods which leverages indirect observations i e head and concentration observations located in this area as shown in fig 14 c and d although a relatively good approximation of h can be obtained with all three methods see fig 15 we still observe some improvements using the pinn darcy and mpinn approaches for the highly nonlinear c field the data driven dnn estimate is significantly less accurate than that found using mpinn in terms of both the point and l 2 errors as shown in fig 16 notably mpinn is able to accurately describe the eye of the concentration plume with very few direct measurements near this region once again this demonstrates that mpinn can use sparse direct and indirect measurements in combination with pdes to capture local features that otherwise cannot be described with only direct measurements finally we investigate whether using the optimal size k dnn as determined in section 4 1 would reduce the error in the estimated k h and c fields as an example we choose the case with λ 0 2 according to fig 11 a the optimal k size for a field with λ 0 2 is m h 90 table 4 presents the estimation errors for the k dnns with m h 60 90 and 120 in this comparison study we fix the h and c dnns size at m h 60 and use n k 80 n h 40 n c 100 measurements and n f h 1000 and n f c 1000 residual points we can see that the optimal size k produces the smallest estimation errors not only for the k field but also for the h field in the data driven dnn pinn darcy and mpinn methods for the c field the smallest error is achieved with m h 60 in the k dnn this indicates that a smaller estimation error in k and h does not always translate to a smaller error in c 5 conclusion in this study we presented the mpinn approach for data assimilation with a focus on parameter and state estimation in subsurface transport problems in this approach all unknown space dependent parameters and states are modeled with dnns that are jointly trained by minimizing the loss function containing the multiphysics data e g conductivity hydraulic head and concentration measurements and the associated physics constraints including the darcy and advection dispersion equations as a result the dnns can be trained using indirect measurements and underlying physics in an unsupervised learning fashion which is important when the data is sparse we compared three dnn methods 1 the pure data driven dnn approach which only uses data to train dnns 2 the pinn approach called pinn darcy which utilizes the conductivity and hydraulic head measurements and the darcy equation and 3 the mpinn approach which combines the conductivity head and concentration measurements with the darcy and advection dispersion equations our numerical results show that both physics informed methods pinn darcy and mpinn are significantly more accurate for parameter estimation than the data driven dnn method the physics informed methods provide regularization and reduce the uncertainty in dnn predictions especially when the direct measurements are limited furthermore mpinn yields better parameter and state estimation than pinn darcy we investigated the effect of the neural network size on the accuracy of parameter and state estimation as a function of the correlation length of the modeled k field we demonstrated that in pure data driven regression small and large networks might result in poor representability or overfitting and that an optimal dnn size increases with decreasing correlation length the physics constraints and added measurements reduce dependence of the dnn prediction on the dnn size given that the dnn is large representative enough however for a small number of measurements we demonstrated that an optimal size dnn outperforms both the larger and smaller dnns in subsurface applications data is usually sparse and is often indirect therefore the mpinn approach offers a flexible and unified framework to deal with sparse and multiphysics data because the proposed method involves training dnns by minimizing the loss function the performance of training algorithms is crucial in our study we found that introducing nonlinear pde constraints into the loss function increases the computational cost of training application of the physics informed dnns to large scale problems will require access to multi gpu computers and scalable training algorithms the selection of training algorithms and hyperparameters learning rate architecture of dnns etc should also be studied in more details credit authorship contribution statement qizhi he methodology software formal analysis validation investigation writing original draft david barajas solano formal analysis guzel tartakovsky formal analysis alexandre m tartakovsky conceptualization methodology writing original draft project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement this research was partially supported by the u s department of energy doe advanced scientific computing ascr program pnnl is operated by battelle for the doe under contract de ac05 76rl01830 appendix a dnn approximation in mpinn we use a fully connected feed forward network architecture known as multilayer perceptrons where the basic computing units neurons are stacked in layers as shown in fig a 17 the dnn approximation u x θ of a function u x is given as a 1 u x u x θ y n l 1 y n l y 2 x where denotes the dnn approximation and a 2 y 2 x σ w 1 x b 1 y 3 y 2 σ w 2 y 2 b 2 y n l y n l 1 σ w n l 1 y n l 1 b n l 1 y n l 1 y n l w n l y n l b n l the first layer is called the input layer and the last layer is the output layer while all the intermediate layers are known as hidden layers here nl denotes the number of hidden layers σ is the predefined activation function x r d denotes the input d is the number of spatial dimensions y n l 1 is the output vector and θ denotes all weight and bias parameters in the dnn approximation of u a 3 θ w 1 w 2 w n l b 1 b 2 b n l in the data driven approach θ is directly estimated from the measurements of u by minimizing the loss function l θ x t u u x θ u x 2 a 4 θ arg min θ x t u u x θ u x 2 where t u x 1 x 2 x t u ω denotes a set of measurement locations ω r d is the domain of the function u and u x x t u are the measured values of u at these locations some of the commonly used activation functions include logistic sigmoid hyperbolic tangent relu and leaky relu because the objective of this study is to approximate differentiable functions space dependent parameters and state variables in partial differential equations we adopt the hyperbolic tangent activation function σ x tanh x which is infinitely differentiable appendix b multiphysics informed neural networks for coupled darcy flow and advection dispersion equations next the residuals of eqs 7 and 8 are expressed in terms of θk θh and θc as b 1a f h x θ k θ h k x θ k h x θ h b 1b f c x θ k θ h θ c 1 ϕ k x θ k h x θ h c x θ c d c x θ c to enforce the neumann boundary conditions for eqs 7 and 8 we define dnns that approximate fluxes at the boundaries b 2 f n 1 h x θ k θ h k x h x x 1 q f n 2 h x θ k θ h k x h x x 2 and b 3 f n 1 c x θ c c x x 1 f n 2 c x θ c c x x 2 the loss function is then defined as b 4 j θ k θ h θ c j d θ k θ h θ c j f h θ k θ h j f c θ k θ h θ c j n 1 h θ k θ h j n 2 h θ k θ h j n 1 c θ c j n 2 c θ c j b h θ h j b c θ c where the loss due to mismatch with data is b 5 j d θ k θ h θ c 1 n k i n k k x i k θ k k i 2 1 n h i n h h x i h θ h h i 2 1 n c i n c c x i c θ c c i 2 and the losses due to partial differential equatian pde constraints and boundary conditions are b 6 j f h θ k θ h 1 t f h x t f h f h x θ k θ h 2 j f c θ k θ h θ c 1 t f c x t f c f c x θ k θ h θ c 2 j n 1 h θ k θ h 1 t n 1 h x t n 1 h f n 1 h x θ k θ h 2 j n 2 h θ k θ h 1 t n 2 h x t n 2 h f n 2 h x θ k θ h 2 j n 1 c θ c 1 t n 1 c x t n 1 c f n 1 c x θ c 2 j n 2 c θ c 1 t n 2 c x t n 2 c f n 2 c x θ c 2 j b h θ h 1 t b h x t b h h x θ h h x 2 j b c θ c 1 t b c x t b c c x θ c c x 2 in eq b 6 pdes 7 and 8 are enforced at the residual points given by the sets t f h and t f c respectively where t f h n f h and t f c n f c the terms with the subscripts n 1 or n 2 enforce the neumann boundary conditions and those with the subscript b enforce the dirichlet boundary conditions supplementary material supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103610 appendix c supplementary materials supplementary data s1 supplementary raw research data this is open data under the cc by license http creativecommons org licenses by 4 0 supplementary data s1 
482,the equivalent permeability of layered fractured rocks plays an important role in hydrocarbon recovery underground energy storage waste disposal management groundwater hydrology and subsurface contaminant transport borehole data contain some uncertainties sampling bias during collection and interpretation this sampling effect may lead to an inaccurate characterization of the fractured media studies show that long fractures with high permeability which are rarely seen in borehole images dominate the flow pattern and affect the overall permeability of the fractured system this means that samples taken at any scale smaller than the scale of interest result in imprecise permeability upscaling to understand this sampling problem we have established an efficient sampling method to study the existence of the representative elementary volume rev in naturally fractured rocks we selected a collection of outcrop data represented by discrete fracture and matrix dfm models in which fracture apertures are mechanically constrained a finite element finite volume approach is utilized to characterize the flow behavior of dfm models multiscale random sampling is combined with flow based upscaling to determine the equivalent permeability tensor and its anisotropy by considering the variable orientation of the stress state and fracture roughness our findings indicate a convergence towards a scale invariant equivalent permeability and fracture density with increasing sample size and the equivalent permeability itself has a multimodal distribution the spatial variation of the permeability tensor and the change in the degree of anisotropy with sample size reflect the inhomogeneity of the fracture patterns list of symbols k eq equivalent permeability tensor k permeability tensor u velocity vector k i j e q components of the equivalent permeability tensor i x y z and j x y z ui components of the velocity vector i x y z km matrix permeability kf fracture permeability k max e q maximum principal component of the equivalent permeability tensor p fluid pressure μ fluid viscosity l model length l sample length nf number of fractures in the model a fracture aperture a 0 closure aperture under stress free conditions initial closure aperture σ1 maximum compressive principal stress σ3 minimum compressive principal stress σn normal stress acting on the fracture plane σs shear stress acting on the fracture plane θ angle between σ1 and σ n β counter clockwise angle between σ1 and horizontal x axis ϕ r residual friction angle jrc 0 joint roughness coefficient observed in the laboratory jcs 0 joint wall compressive strength observed in the laboratory 1 introduction fractures are discontinuities in subsurface formations that have very different characteristics than the intact host rock the impact of fractures on the fluid flow and mass transport in fractured media is important from different aspects 1 a significant amount of the world s hydrocarbon reserves are stored in naturally fractured reservoirs saidi 1987 nelson 2001 2 fractured rocks are good candidates for carbon sequestration and storage ringrose et al 2013 march et al 2018 and geothermal energy utilization gringarten et al 1975 bauer et al 2017 and 3 the exploitation of unconventional resources e g coalbed methane and shale reservoirs would not be feasible without fractures turcotte et al 2014 fractures provide the preferential pathways for fluid flow in fractured rocks which implies that fracture permeability is a key parameter for fluid flow analyses in such systems fracture permeability can be simply computed using a cubic law snow 1969 witherspoon et al 1980 zimmerman and bodvarsson 1996 if the local fracture aperture is well characterized the fracture aperture itself is one of the most challenging parameters to be determined as small changes in the aperture could result in large uncertainties in flow behavior in fractured rocks de dreuzy et al 2001 de dreuzy et al 2002 min et al 2004 baghbanan and jing 2008 experimental and field data show that in situ stress conditions magnitude and orientation can modify the fracture aperture and consequently the hydraulic properties of the rock zhang and sanderson 1996 yeo et al 1998 olsson and barton 2001 baghbanan and jing 2008 rutqvist 2014 lei et al 2016 kang et al 2019 this change will in turn affect the transport properties of the fractured rock nick et al 2011 fracture characteristics are difficult to determine because the fracture spatial distribution e g length cannot be captured by borehole data i e from the centimeter scale core data to the kilometer scale seismic data wu and pollard 2002 laubach 2003 therefore outcrop studies are essential for finding such spatial information pollard and aydin 1988 bonnet et al 2001 guerriero et al 2010 hooker et al 2013 nevertheless they have not considered the orientation and spatial distribution of fractures with respect to the in situ stress field hydromechanical coupling between stress and flow transport is going to be the main focus of all subsurface flow studies stephansson et al 1996 zhang and sanderson 2002 experimental and field observations show that fracture apertures are not uniform along individual fracture faces thus considering aperture heterogeneity in flow simulation is a reasonable way to capture the flow behavior in fractured rocks couples 2013 which is ignored in conventional approaches renshaw and park 1997 demonstrated that fracture aperture has a complex dependence on the fracture length orientation stress state fluid pressure and mechanical properties of the rock the majority of the published literature assumes a constant aperture hardebol et al 2015 and if it changes with the fracture length preimposes a scale variance there are several studies that have addressed the impact of geomechanical parameters on aperture e g paluszny and matthai 2010 lang et al 2014 bisdom et al 2016c lei et al 2016 azizmohammadi and matthäi 2017 agheshlui et al 2019 and kang et al 2019 there are three main approaches for evaluating the fracture aperture 1 statistically distributed models e g lognormal distribution snow 1970 bonnet et al 2001 de dreuzy et al 2001 de dreuzy et al 2002 min et al 2004 baghbanan and jing 2008 de dreuzy et al 2012 2 linear elastic fracture mechanics lefm lawn 1993 olson 2003 and 3 empirical constitutive models barton and choubey 1977 barton and bandis 1982 bandis et al 1983 barton et al 1985 lei et al 2016 introduced the so called jcm femdem method which is a combination of the joint constitutive model jcm associated with the roughness characteristics observed in laboratory experiments with the solid mechanical model of the finite discrete element method femdem they aimed to model a realistic fracture behavior with respect to shear strength normal closure and shear dilatancy considering the impact of fracture length as seen in experiments the equivalent permeability of the fractured model can be computed using the flow based upscaling method introduced by durlofsky 1991 in which the upscaled model has the same macroscale flow behavior as the fine scale model including permeability anisotropy saevik and nixon 2017 bogdanov et al 2007 and chen et al 2015 studied the upscaling of fracture matrix systems however they did not investigate the effects of aperture on the permeability anisotropy and its variation with the scale and stress state also paluszny and matthai 2010 bisdom et al 2016a b and bisdom et al 2016c investigated the equivalent permeability of fractured rocks however they did not account for a full permeability tensor which is crucial to demonstrate flow heterogeneity in fractured rocks later bisdom et al 2017 introduced a workflow to include geomechanics and full permeability tensor calculations into outcrop models these studies are controversial because they may not have sufficiently investigated large models representing the fracture statistics observed at the field scale scale dependency of the equivalent permeability has been investigated in the literature the rev is defined as a sample size above which the measured values of the property neither vary significantly from sample to sample nor change if the sample size is further increased bear 1972 finding such an rev for the permeability in fractured sedimentary rocks is not trivial as permeability values across and along wells often vary by many orders of magnitude aguilera 1995 nelson 2001 long et al 1982 min et al 2004 and bogdanov et al 2007 observed revs for geostatistics based stochastically generated discrete fracture network dfn models with variable fracture apertures extensive analysis by azizmohammadi and matthäi 2017 on a wide range of fractured outcrop models using the dfm approach showed that the variations in equivalent permeability and its anisotropy decrease with increasing sample size which indicates the existence of an rev in this study we apply the dfm approach matthäi and belayneh 2004 to capture how the stress orientation and fracture roughness will impact the potential scale dependence of the equivalent permeability of layered fractured rocks a wide spectrum of fracture statistics from natural outcrop samples have been selected for the analyses the barton bandis constitutive model is applied to compute the in situ fracture aperture distributions barton and choubey 1977 barton and bandis 1982 bandis et al 1983 barton et al 1985 then the equivalent permeability tensors are computed using the upscaling approach introduced by azizmohammadi and matthäi 2017 this is followed by the multiscale random sampling of the fractured domain for rev analysis the procedure is repeated for several fracture roughnesses and a set of stress orientations to cover the entire parameter space for such models the novelty of this study can be summarized as the impacts of the stress orientation and fracture roughness on 1 rev analysis of the equivalent permeability 2 multiscale visualization of the permeability tensors and 3 illustration of the anisotropy of naturally fractured rocks the paper proceeds as follows first fracture aperture and permeability modeling are discussed second the procedures to compute the equivalent permeability including the governing equations and boundary conditions used in the finite element analysis are explained which is followed by an illustration of the random sampling procedure third a description of the outcrop models is presented and their geometrical characteristics are demonstrated then the results are reviewed and discussed finally the conclusions are drawn 2 methodology in this study we focus on layered naturally fractured sedimentary rocks mapped in two dimensional outcrops which are horizontal pavements with their dip perpendicular to the bedding largely penetrating the sedimentary layers this means that the fractures are largely bed confined and intersecting only in the single layer moreover fracturing is restricted to the brittle layers between the shale rich layers above and below therefore fluid flow is mostly restricted to the fractured beds thus we can ignore stereological effects darcel et al 2003 flow models were built from fracture traces which were then converted into nurbs non uniform rational b spline curves for meshing the complex systems modeling platform csmp matthäi et al 2007 was used to calculate pressure and velocity fields on the mesh using the bubnov galerkin finite element method matthäi and belayneh 2004 2 1 fracture aperture and permeability to discern the heterogeneity of the fracture system we considered a constant and isotropic permeability of the rock matrix km the permeability of each fracture segment every single element in the finite element mesh that represents a fracture was obtained by the cubic law witherspoon et al 1980 1 k f a 2 12 where a is the aperture of the fracture segment eq 1 assumes that the flow is laminar and inertial effects can be neglected zimmerman and bodvarsson 1996 the local fracture aperture was computed from the far field stress and fluid pressure acting on each fracture segment fig 1 using the analysis illustrated by azizmohammadi and matthäi 2017 in comprehensive detail as they explained the method goes far beyond other modeling approaches in which they either assume that all fractures have uniform apertures e g taylor et al 1999 and min et al 2004 or they apply the power law distributions e g long et al 1982 in this study we used the azizmohammadi and matthäi 2017 approach to calculate the fracture aperture which is affected by the stress orientation and fracture roughness later we obtained the corresponding permeability map of the outcrop models using eq 1 2 2 equivalent permeability tensor the determination of the equivalent permeability tensor starts from the steady state pressure equation which is derived by substituting darcy s law into the continuity equation u 0 2 k μ p 0 where μ is the viscosity and k is the permeability tensor which in a two dimensional cartesian coordinate system is defined as 3 k k x x k x y k y x k y y to obtain the full equivalent permeability tensor we followed the nonlocal permeability upscaling approach of durlofsky 1991 in which two flow problems must be considered in the first flow problem constant pressure dirichlet boundary conditions on the opposite left pl and right p r edges of the entire model were applied while we set no flow natural boundary conditions on the others for the second flow problem constant pressures on the opposite bottom pb and top pt boundaries and no flow natural boundary conditions to the others were applied see fig 2 for each problem the pressure field p x y was solved with finite element analysis and then from the gradient of the pressure field the piecewise constant element velocities were calculated using darcy s law the equivalent permeability tensor k eq relates the average flow velocity u to the average pressure gradient p and is computed by volume averaging of fluid velocities pressure gradients and viscosities in the form of darcy s law durlofsky 1991 4 u k e q μ p where is the volume averaging operator in this study we considered symmetric conditions for the equivalent permeability tensors therefore k x y e q k y x e q including this constraint eq 4 can be extended in a matrix form 5 p x 1 p y 1 0 0 0 0 p x 1 p y 1 p x 2 p y 2 0 0 0 0 p x 2 p y 2 0 1 1 0 k xx eq k xy eq k yx eq k yy eq μ u x 1 u y 1 u x 2 u y 2 0 superscripts 1 and 2 denote the two flow problems described above the samg algebraic multigrid solver was used to solve the system of equations to determine the components of the equivalent permeability tensor 6 k eq k xx eq k xy eq k yx eq k yy eq 2 3 sampling method for rev analysis the computed pressure and velocity fields over the entire model were sampled randomly in square shaped subregions with a side length l as a fraction of the model length l fig 3 shows some typical random square shaped samples inside a test model samples that were taken this way might partially overlap with each other the dimensionless sample size ld is defined azizmohammadi and matthäi 2017 7 l d l l 1 1 r r r where r is a set of real positive numbers and 1 1 r reflects the size fraction of a sample with respect to the entire model for the meaningful statistical analysis the smallest r is chosen so that each sample contains at least 50 elements a sufficient model size ascertains that enough samples can be taken on the selected model for each sample size length scale 10 random samples were taken in this way therefore we were able to determine k eq and fracture density as a function of sample size while the sampling was carried out over three orders of magnitude of the length scale from ld 0 01 to 1 3 fracture outcrop models in this study we use fracture traces mapped in natural outcrops because the fracture attributes are hidden in the subsurface and the limited well data cannot be used to construct the fracture geometry geiger and matthäi 2012 additionally the geostatistics based fracture models dershowitz and einstein 1988 cannot explain the spatial distribution of naturally developed fractures pollard and aydin 1988 wu and pollard 1995 renshaw and park 1997 therefore the outcrop model is a reasonable choice for such studies the outcrops here were selected from different places to include a wide spectrum of fracture patterns and length scales from a few meters to a kilometer scale as seen in fig 4 the kilve model was selected from an outcrop located on the southern margin of the bristol channel basin u k south of the village of kilve the arches model was extracted from satellite imagery from google maps of the traced fracture patterns in the entrada sandstone between fiery furnace and freshwater springs arches national park utah matthai et al 2012 hornelen7 and hornelen1 models were mapped on outcrops located in the hornelen basin which is approximately 200 km north of bergen norway odling 1997 for detailed information about these outcrops see azizmohammadi and matthäi 2017 3 1 model configuration for fracture aperture calculations with the barton bandis model the rock mechanical parameters are needed since no published data are available for the regions of this study constant far field stress magnitude was applied to the fracture patterns to compute aperture distributions the common scenario of a shallow burial depth in a normal faulting regime with maximum compressive principal stress σ1 of 15 mpa minimum compressive principal stress σ3 of 10 mpa and a fluid pressure of 9 mpa are assumed for all outcrop models to study the effect of stress orientation β and fracture roughness jrc 0 on the permeability variation of the fractured rock six angles 0 30 60 90 120 and 150 degrees were considered for β and four joint roughness coefficients 5 10 15 and 20 were selected for jrc 0 to define the parameter space for our analysis moreover a residual friction angle φ r 25 was taken from the literature as plausible constant values for the models a fracture closure aperture of 20 μm was assumed to ensure that all fractures contributed to the flow cracks with an opening below this value are assumed to be sealed with a reactive pore fluid roedder 1984 a constant and isotropic matrix permeability km of 10 13 m2 100 md was assumed for all outcrop models table 1 enlists the mechanical parameters used in this study to compute the fracture aperture 4 geometric attributes here we use the same outcrop models introduced in azizmohammadi and matthäi 2017 therefore the same geometric attributes are considered here the characteristics of the outcrop models analyzed are presented in table 2 4 1 fracture length fracture length data are often influenced by two effects 1 truncation effect in which the spatial resolution restricts capturing short traces and 2 censoring effect where the long traces cannot be captured due to sampling limitations odling 1997 bonnet et al 2001 for most early sets and 2 d satellite images the fracture trace length distributions tend to be power law de dreuzy et al 2001 bour 2002 in this study the truncation and censoring effects for the abovementioned outcrop models were analyzed and a power law fit was obtained using the maximum likelihood estimation mle method more details can be found in azizmohammadi and matthäi 2017 4 2 fracture aperture and fracture permeability for each set of parameters the fracture aperture was computed using the barton bandis model the process was repeated for all the parameter space defined in table 1 to obtain the aperture distribution under certain conditions fig 5 shows aperture distribution and fig 6 displays the corresponding permeability map of all the models for β 150 and jrc 0 10 as an example for the applied differential stress only those fractures with an orientation that leads to a reduced fracture normal stress are dilated most of the fractures in the models are curved this implies that they are not dilated over their entire length and that only favorably oriented segments are dilated because their length is much less than the overall fracture length 5 simulation results the following sections present the results of the simulations performed on the outcrop models with the previously introduced setup to obtain the variations in the equivalent permeability tensor permeability anisotropy and fracture density with the sample size 5 1 equivalent permeability tensor equivalent permeability tensors were computed for square sample subregions covering a wide range of sample sizes from 0 44 to 794 m in different models figs 7 10 show the variation in the magnitude of k d k max e q k m maximum principal component k max e q normalized by rock matrix permeability km with changing stress orientation and fracture roughness in the kilve model fig 7 for all the joint roughness coefficients kd increases as the stress orientation β changes from 0 to 30 this occurs as most fractures are either aligned with the south s north n or east e west w direction thus β 30 gives the highest permeability by keeping both long e w and small s n fractures highly conductive similar situations occur at β 150 fig 7 this can be seen in the inset histograms showing the aperture distribution of the kilve model the lowest kd values are achieved for the cases in which β 90 as it minimizes the aperture of the long e w fractures connecting the boundaries at the left and right such a low kd shows that kilve tends to have an isotropic permeability at β 90 for stress orientation angles 0 60 and 120 the influence of jrc 0 on permeability is similar here the maximum values of kd decrease when jrc 0 increases from 5 to 10 however this value continues to increase as jrc 0 increases from 10 to 20 for stress orientation angles of 30 and 150 the maximum kd decreases increases and decreases when jrc 0 changes from 5 to 10 from 10 to 15 and from 15 to 20 respectively this shows that the influence of jrc 0 on the permeability of kilve is highly controlled by the stress orientation for the arches model fig 8 the influence of the stress orientation β on kd is similar for jrc 0 5 10 15 similar to the kilve model change in kd is significant with changes in β however when jrc 0 20 the change in kd with β becomes very small and the highest permeability is obtained at stress orientation angles of 0 and 90 degrees different from the other jrc 0 values the results show that an increase in jrc 0 leads to a huge decrease in kd for all stress orientation angles which can also be inferred from the aperture distribution displayed in the histograms this indicates that the joint roughness coefficient jrc 0 becomes a more influential factor when determining the permeability of large models in the hoerneln7 model fig 9 for jrc 0 5 10 15 the highest permeability values are obtained at β 0 60 120 however similar to the arches model this pattern changes when jrc 0 20 similar to the arches model permeability in general tends to be more isotropic for high joint roughness coefficients and there is a significant decrease in kd when jrc 0 changes from 15 to 20 here the joint roughness coefficient becomes a more influential factor when determining the permeability of this model this can be observed in the inset histograms showing the fracture aperture distribution of the hornelen7 model in the hornelen1 model fig 10 for all jrc 0 values kd goes through increase decrease cycles at every 30 degree increase in stress orientation angle β here similar to the kilve model an increase in jrc 0 does not necessarily make the permeability more isotropic in general these results indicate that a sharp decrease in fluctuations of kd occurs around ld 0 2 the variation in permeability with sample size fades even further within 0 2 ld 0 4 for ld 0 4 the variation in permeability with sample size is relatively small 5 2 permeability anisotropy permeability anisotropy at different length scales can be investigated by visualization of the permeability tensors which were computed on square samples with different sizes and stress orientations figs 11 14 demonstrate the permeability tensors as colored ellipses for all the outcrop models for jrc 0 10 the color varies from blue low contrast to red high contrast between the major and minor axes of the ellipse the axes of the ellipses were scaled with the principal components of the permeability tensor eigenvalues of k eq these figures show how the change in scale will influence the permeability tensors at different stress orientation angles as already determined in the previous section in the kilve model the lowest permeability values and the most isotropic permeability tensors are achieved at β 90 fig 11 for β 30 and 150 the permeability tensor is highly anisotropic and reaches its maximum value in the kilve model the local and global flow directions almost match in different scales however they vary substantially in the other models in the arches model fig 12 the flow could significantly change its direction and strength between two adjacent 100 m sample grids however in larger scales the flow direction is w e except for the case β 90 figs 13 and 14 show the permeability tensor of the hornelen models on grid sizes from 3 m hornelen1 to 720 m hornelen7 here we can see how the increase in the stress orientation angle could change the direction of the ensemble flow for example in the hornelen1 model fig 14 the ensemble flow direction could vary from sw ne to se nw by changing the stress orientation only from 60 to 90 degrees of course the change is less noticeable in the hornelen7 model fig 13 as the maximum sample size 18 m in the hornelen1 model is smaller than the smallest sample 90 m of the big hornelen7 model 5 3 fracture density fracture density was calculated for each sample subregion using the method introduced by wu and pollard 2002 fig 15 displays the change in fracture density with sample size these results also indicate a decreasing trend for the variation in fracture density with scale for all outcrop models nevertheless they do not behave like permeability indicating a difference between the scale dependencies of permeability and fracture density with sample size this occurs because fracture density does not account for fracture connectivity and direction and it weighs the fractures regardless of their permeability 6 discussion the impact of regional stress orientation and fracture roughness on equivalent permeability tensors magnitude and anisotropy and fluid flow pathways in dfm models mapped from 2 d outcrop fractured rocks were investigated we studied the effects of both stress state and fracture roughness on the overall hydromechanical behaviors of the fractured outcrop samples by coupling geometric characteristics and mechanical behaviors the results show that while this coupling has significant impacts on the equivalent permeability magnitude and its anisotropy it has no impact on the scale dependency of the equivalent permeability these findings are in line with previous studies long et al 1982 min et al 2004 bogdanov et al 2007 as they found revs for geostatistics based stochastically generated fractured models with variable fracture apertures our hypothesis here is to consider that far field stress orientations are representative for computing local fracture apertures because local stress perturbation and shadowing effects may influence fracture network properties remote stress alone cannot be simply applied to estimate the fracture aperture at the local scale zhang and sanderson 1996 however the aperture model that we used is based on asperity sliding where we ignore stress perturbation and shadowing effects moreover our approach goes one step beyond the most common approaches that have dominated the literature and that offer zero dimensional correlations statistical distributions and or constant apertures see e g long et al 1982 taylor et al 1999 and min et al 2004 the maximum principal component of the k eq is decreased with increasing sample size which indicates the existence of a practical rev this rev is supposed to be approximately ld 0 2 which will be 167 m for the arches model 144 m for the large scale hornelen7 model and 3 6 m for the small scale hornelen1 model this is a very important result for the upscaling purposes and simulation of fluid flow on the continuum scale for fractured rocks where the potential rev must be identified first the concept of rev is controversial however this work clearly showed that the flow based rev is not necessarily equal to the geometric based rev fig 15 additionally it is shown that rev could significantly vary between the rock properties sedaghat and azizmohammadi 2019 the results implied that the influence of the joint rightness coefficient on the permeability of the models intensifies as the model size increases figs 7 10 this is due to the stronger impact of jrc 0 on long fractures which are more frequent in large models fig 16 19 show the variation in fracture permeability with fracture length for different stress orientations β and fracture roughnesses jrc 0 for the kilve and hornelen1 models fracture permeability has an increasing trend with fracture length however in the arches and hornelen7 models where fractures are generally longer than in the kilve and hornelen1 models for all the stress orientation angles the permeability length trend changes with a change in jrc 0 this could be the reason why kd decreases with increasing jrc 0 for the arches and hornelen7 models figs 8 and 9 regardless of the stress orientation angle figs 17 and 18 change in fluid pressure as a result of production can lead to significant pressure fluctuations in fractures than in the matrix due to the large permeability contrast between them such operational conditions will influence the local stress state of the fractured system and consequently change the fracture permeability zhang and sanderson 1996 this must be considered during the production phase in this study we do not consider local stress perturbation and shadowing effects due to variation of pore pressure during production therefore far field stress is assumed equal to local stress on the fracture plane this simplification will influence the local fracture aperture and may overestimate the aperture size up to 5 bisdom et al 2016b 3 d fractured models seem to be more realistic for naturally fractured rock studies connectivity of 3 d fractured system is misinterpreted by 2 d models if the fractures have partial penetration of the sedimentary layers de dreuzy et al 2012 therefore analysis of layer restricted patterns is very important however they are sufficiently complex to merit a separate publication furthermore there are some major limitations regarding 3 d models 1 observability of 3 d data in natural outcrops recent developments in imaging techniques e g lidar scanning will open up a huge research potential in this area 2 availability of 3 d models as they are not commonly used in fractured rock studies 3 characterization of 3 d models even if the 3 d model exists it cannot be easily characterized the conventional approach to model 3 d fractured domains is to assume statistical distributions of apertures the big challenge here is to get the right spatial correlation else the results will not be representative of the actual aperture pattern in the natural systems pollard and aydin 1988 on the other hand correlating 2 d to 3 d systems seems unlikely to be straightforward the rev analysis approach developed here does not have any limitation with regard to applications to 3 d models it should be mentioned that in practice fractures can behave as sealing barriers to flow in such cases upscaling of the system containing a wide range of permeabilities from non conductive impermeable to extremely conductive fractures might get in trouble as finding the equivalent permeability is not trivial multiscale methods have been developed to address such problems by transferring the solution e g pressure to coarser scale this makes them attractive compared to traditional upscaling approaches when highly heterogeneous systems are considered tene et al 2017 7 conclusions we analyzed the scale dependence and anisotropy of the equivalent permeability in layered fractured rocks using fracture patterns mapped in natural outcrops by including the impact of regional stress orientation and fracture roughness the barton bandis constitutive model was applied to fractures segment by segment to compute the realistic local aperture distributions based on the far field stress the resulting fracture apertures are almost log normally distributed then the equivalent permeability tensor k eq was computed using a flow based upscaling approach for varying sample size stress orientations and fracture roughness we found a strong anisotropy imposed by the fractures that show significant variations of the equivalent permeability tensor k eq magnitude and direction although selected outcrops show a rather homogeneous pattern we found that the axes of the k eq are neither aligned with the conductive fractures nor with the principal directions of the far field stress thus a full tensor of equivalent permeability is absolutely required for modeling flow through fractured rocks at the continuum scale we found that rev could exist for the models studied here as the maximum principal component of the k eq decreased with increasing sample size this flow based rev does not coincide with the geometric based rev we also found that the roughness becomes a more influential factor when determining the permeability of a large model by decreasing the permeability of long fractures increase in roughness also decreases the frequency of wide fractures credit authorship contribution statement siroos azizmohammadi conceptualization methodology software visualization writing original draft mohammad sedaghat conceptualization formal analysis validation writing review editing declaration of competing interest all authors have participated in a conception and design or analysis and interpretation of the data b drafting the article or revising it critically for important intellectual content and c approval of the final version this manuscript has not been submitted to nor is under review at another journal or other publishing venue the authors have no affiliation with any organization with a direct or indirect financial interest in the subject matter discussed in the manuscript acknowledgements we thank mandefro belayneh saudi aramco and noelle odling university of leeds uk who gave us permission to use their original fracture trace maps without their datasets this work would not have been possible we greatly appreciate their support the fracture datasets used in this study may be obtained by contacting the first author via email siroos azizmohammadi unileoben ac at supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103579 appendix supplementary materials image application 1 
482,the equivalent permeability of layered fractured rocks plays an important role in hydrocarbon recovery underground energy storage waste disposal management groundwater hydrology and subsurface contaminant transport borehole data contain some uncertainties sampling bias during collection and interpretation this sampling effect may lead to an inaccurate characterization of the fractured media studies show that long fractures with high permeability which are rarely seen in borehole images dominate the flow pattern and affect the overall permeability of the fractured system this means that samples taken at any scale smaller than the scale of interest result in imprecise permeability upscaling to understand this sampling problem we have established an efficient sampling method to study the existence of the representative elementary volume rev in naturally fractured rocks we selected a collection of outcrop data represented by discrete fracture and matrix dfm models in which fracture apertures are mechanically constrained a finite element finite volume approach is utilized to characterize the flow behavior of dfm models multiscale random sampling is combined with flow based upscaling to determine the equivalent permeability tensor and its anisotropy by considering the variable orientation of the stress state and fracture roughness our findings indicate a convergence towards a scale invariant equivalent permeability and fracture density with increasing sample size and the equivalent permeability itself has a multimodal distribution the spatial variation of the permeability tensor and the change in the degree of anisotropy with sample size reflect the inhomogeneity of the fracture patterns list of symbols k eq equivalent permeability tensor k permeability tensor u velocity vector k i j e q components of the equivalent permeability tensor i x y z and j x y z ui components of the velocity vector i x y z km matrix permeability kf fracture permeability k max e q maximum principal component of the equivalent permeability tensor p fluid pressure μ fluid viscosity l model length l sample length nf number of fractures in the model a fracture aperture a 0 closure aperture under stress free conditions initial closure aperture σ1 maximum compressive principal stress σ3 minimum compressive principal stress σn normal stress acting on the fracture plane σs shear stress acting on the fracture plane θ angle between σ1 and σ n β counter clockwise angle between σ1 and horizontal x axis ϕ r residual friction angle jrc 0 joint roughness coefficient observed in the laboratory jcs 0 joint wall compressive strength observed in the laboratory 1 introduction fractures are discontinuities in subsurface formations that have very different characteristics than the intact host rock the impact of fractures on the fluid flow and mass transport in fractured media is important from different aspects 1 a significant amount of the world s hydrocarbon reserves are stored in naturally fractured reservoirs saidi 1987 nelson 2001 2 fractured rocks are good candidates for carbon sequestration and storage ringrose et al 2013 march et al 2018 and geothermal energy utilization gringarten et al 1975 bauer et al 2017 and 3 the exploitation of unconventional resources e g coalbed methane and shale reservoirs would not be feasible without fractures turcotte et al 2014 fractures provide the preferential pathways for fluid flow in fractured rocks which implies that fracture permeability is a key parameter for fluid flow analyses in such systems fracture permeability can be simply computed using a cubic law snow 1969 witherspoon et al 1980 zimmerman and bodvarsson 1996 if the local fracture aperture is well characterized the fracture aperture itself is one of the most challenging parameters to be determined as small changes in the aperture could result in large uncertainties in flow behavior in fractured rocks de dreuzy et al 2001 de dreuzy et al 2002 min et al 2004 baghbanan and jing 2008 experimental and field data show that in situ stress conditions magnitude and orientation can modify the fracture aperture and consequently the hydraulic properties of the rock zhang and sanderson 1996 yeo et al 1998 olsson and barton 2001 baghbanan and jing 2008 rutqvist 2014 lei et al 2016 kang et al 2019 this change will in turn affect the transport properties of the fractured rock nick et al 2011 fracture characteristics are difficult to determine because the fracture spatial distribution e g length cannot be captured by borehole data i e from the centimeter scale core data to the kilometer scale seismic data wu and pollard 2002 laubach 2003 therefore outcrop studies are essential for finding such spatial information pollard and aydin 1988 bonnet et al 2001 guerriero et al 2010 hooker et al 2013 nevertheless they have not considered the orientation and spatial distribution of fractures with respect to the in situ stress field hydromechanical coupling between stress and flow transport is going to be the main focus of all subsurface flow studies stephansson et al 1996 zhang and sanderson 2002 experimental and field observations show that fracture apertures are not uniform along individual fracture faces thus considering aperture heterogeneity in flow simulation is a reasonable way to capture the flow behavior in fractured rocks couples 2013 which is ignored in conventional approaches renshaw and park 1997 demonstrated that fracture aperture has a complex dependence on the fracture length orientation stress state fluid pressure and mechanical properties of the rock the majority of the published literature assumes a constant aperture hardebol et al 2015 and if it changes with the fracture length preimposes a scale variance there are several studies that have addressed the impact of geomechanical parameters on aperture e g paluszny and matthai 2010 lang et al 2014 bisdom et al 2016c lei et al 2016 azizmohammadi and matthäi 2017 agheshlui et al 2019 and kang et al 2019 there are three main approaches for evaluating the fracture aperture 1 statistically distributed models e g lognormal distribution snow 1970 bonnet et al 2001 de dreuzy et al 2001 de dreuzy et al 2002 min et al 2004 baghbanan and jing 2008 de dreuzy et al 2012 2 linear elastic fracture mechanics lefm lawn 1993 olson 2003 and 3 empirical constitutive models barton and choubey 1977 barton and bandis 1982 bandis et al 1983 barton et al 1985 lei et al 2016 introduced the so called jcm femdem method which is a combination of the joint constitutive model jcm associated with the roughness characteristics observed in laboratory experiments with the solid mechanical model of the finite discrete element method femdem they aimed to model a realistic fracture behavior with respect to shear strength normal closure and shear dilatancy considering the impact of fracture length as seen in experiments the equivalent permeability of the fractured model can be computed using the flow based upscaling method introduced by durlofsky 1991 in which the upscaled model has the same macroscale flow behavior as the fine scale model including permeability anisotropy saevik and nixon 2017 bogdanov et al 2007 and chen et al 2015 studied the upscaling of fracture matrix systems however they did not investigate the effects of aperture on the permeability anisotropy and its variation with the scale and stress state also paluszny and matthai 2010 bisdom et al 2016a b and bisdom et al 2016c investigated the equivalent permeability of fractured rocks however they did not account for a full permeability tensor which is crucial to demonstrate flow heterogeneity in fractured rocks later bisdom et al 2017 introduced a workflow to include geomechanics and full permeability tensor calculations into outcrop models these studies are controversial because they may not have sufficiently investigated large models representing the fracture statistics observed at the field scale scale dependency of the equivalent permeability has been investigated in the literature the rev is defined as a sample size above which the measured values of the property neither vary significantly from sample to sample nor change if the sample size is further increased bear 1972 finding such an rev for the permeability in fractured sedimentary rocks is not trivial as permeability values across and along wells often vary by many orders of magnitude aguilera 1995 nelson 2001 long et al 1982 min et al 2004 and bogdanov et al 2007 observed revs for geostatistics based stochastically generated discrete fracture network dfn models with variable fracture apertures extensive analysis by azizmohammadi and matthäi 2017 on a wide range of fractured outcrop models using the dfm approach showed that the variations in equivalent permeability and its anisotropy decrease with increasing sample size which indicates the existence of an rev in this study we apply the dfm approach matthäi and belayneh 2004 to capture how the stress orientation and fracture roughness will impact the potential scale dependence of the equivalent permeability of layered fractured rocks a wide spectrum of fracture statistics from natural outcrop samples have been selected for the analyses the barton bandis constitutive model is applied to compute the in situ fracture aperture distributions barton and choubey 1977 barton and bandis 1982 bandis et al 1983 barton et al 1985 then the equivalent permeability tensors are computed using the upscaling approach introduced by azizmohammadi and matthäi 2017 this is followed by the multiscale random sampling of the fractured domain for rev analysis the procedure is repeated for several fracture roughnesses and a set of stress orientations to cover the entire parameter space for such models the novelty of this study can be summarized as the impacts of the stress orientation and fracture roughness on 1 rev analysis of the equivalent permeability 2 multiscale visualization of the permeability tensors and 3 illustration of the anisotropy of naturally fractured rocks the paper proceeds as follows first fracture aperture and permeability modeling are discussed second the procedures to compute the equivalent permeability including the governing equations and boundary conditions used in the finite element analysis are explained which is followed by an illustration of the random sampling procedure third a description of the outcrop models is presented and their geometrical characteristics are demonstrated then the results are reviewed and discussed finally the conclusions are drawn 2 methodology in this study we focus on layered naturally fractured sedimentary rocks mapped in two dimensional outcrops which are horizontal pavements with their dip perpendicular to the bedding largely penetrating the sedimentary layers this means that the fractures are largely bed confined and intersecting only in the single layer moreover fracturing is restricted to the brittle layers between the shale rich layers above and below therefore fluid flow is mostly restricted to the fractured beds thus we can ignore stereological effects darcel et al 2003 flow models were built from fracture traces which were then converted into nurbs non uniform rational b spline curves for meshing the complex systems modeling platform csmp matthäi et al 2007 was used to calculate pressure and velocity fields on the mesh using the bubnov galerkin finite element method matthäi and belayneh 2004 2 1 fracture aperture and permeability to discern the heterogeneity of the fracture system we considered a constant and isotropic permeability of the rock matrix km the permeability of each fracture segment every single element in the finite element mesh that represents a fracture was obtained by the cubic law witherspoon et al 1980 1 k f a 2 12 where a is the aperture of the fracture segment eq 1 assumes that the flow is laminar and inertial effects can be neglected zimmerman and bodvarsson 1996 the local fracture aperture was computed from the far field stress and fluid pressure acting on each fracture segment fig 1 using the analysis illustrated by azizmohammadi and matthäi 2017 in comprehensive detail as they explained the method goes far beyond other modeling approaches in which they either assume that all fractures have uniform apertures e g taylor et al 1999 and min et al 2004 or they apply the power law distributions e g long et al 1982 in this study we used the azizmohammadi and matthäi 2017 approach to calculate the fracture aperture which is affected by the stress orientation and fracture roughness later we obtained the corresponding permeability map of the outcrop models using eq 1 2 2 equivalent permeability tensor the determination of the equivalent permeability tensor starts from the steady state pressure equation which is derived by substituting darcy s law into the continuity equation u 0 2 k μ p 0 where μ is the viscosity and k is the permeability tensor which in a two dimensional cartesian coordinate system is defined as 3 k k x x k x y k y x k y y to obtain the full equivalent permeability tensor we followed the nonlocal permeability upscaling approach of durlofsky 1991 in which two flow problems must be considered in the first flow problem constant pressure dirichlet boundary conditions on the opposite left pl and right p r edges of the entire model were applied while we set no flow natural boundary conditions on the others for the second flow problem constant pressures on the opposite bottom pb and top pt boundaries and no flow natural boundary conditions to the others were applied see fig 2 for each problem the pressure field p x y was solved with finite element analysis and then from the gradient of the pressure field the piecewise constant element velocities were calculated using darcy s law the equivalent permeability tensor k eq relates the average flow velocity u to the average pressure gradient p and is computed by volume averaging of fluid velocities pressure gradients and viscosities in the form of darcy s law durlofsky 1991 4 u k e q μ p where is the volume averaging operator in this study we considered symmetric conditions for the equivalent permeability tensors therefore k x y e q k y x e q including this constraint eq 4 can be extended in a matrix form 5 p x 1 p y 1 0 0 0 0 p x 1 p y 1 p x 2 p y 2 0 0 0 0 p x 2 p y 2 0 1 1 0 k xx eq k xy eq k yx eq k yy eq μ u x 1 u y 1 u x 2 u y 2 0 superscripts 1 and 2 denote the two flow problems described above the samg algebraic multigrid solver was used to solve the system of equations to determine the components of the equivalent permeability tensor 6 k eq k xx eq k xy eq k yx eq k yy eq 2 3 sampling method for rev analysis the computed pressure and velocity fields over the entire model were sampled randomly in square shaped subregions with a side length l as a fraction of the model length l fig 3 shows some typical random square shaped samples inside a test model samples that were taken this way might partially overlap with each other the dimensionless sample size ld is defined azizmohammadi and matthäi 2017 7 l d l l 1 1 r r r where r is a set of real positive numbers and 1 1 r reflects the size fraction of a sample with respect to the entire model for the meaningful statistical analysis the smallest r is chosen so that each sample contains at least 50 elements a sufficient model size ascertains that enough samples can be taken on the selected model for each sample size length scale 10 random samples were taken in this way therefore we were able to determine k eq and fracture density as a function of sample size while the sampling was carried out over three orders of magnitude of the length scale from ld 0 01 to 1 3 fracture outcrop models in this study we use fracture traces mapped in natural outcrops because the fracture attributes are hidden in the subsurface and the limited well data cannot be used to construct the fracture geometry geiger and matthäi 2012 additionally the geostatistics based fracture models dershowitz and einstein 1988 cannot explain the spatial distribution of naturally developed fractures pollard and aydin 1988 wu and pollard 1995 renshaw and park 1997 therefore the outcrop model is a reasonable choice for such studies the outcrops here were selected from different places to include a wide spectrum of fracture patterns and length scales from a few meters to a kilometer scale as seen in fig 4 the kilve model was selected from an outcrop located on the southern margin of the bristol channel basin u k south of the village of kilve the arches model was extracted from satellite imagery from google maps of the traced fracture patterns in the entrada sandstone between fiery furnace and freshwater springs arches national park utah matthai et al 2012 hornelen7 and hornelen1 models were mapped on outcrops located in the hornelen basin which is approximately 200 km north of bergen norway odling 1997 for detailed information about these outcrops see azizmohammadi and matthäi 2017 3 1 model configuration for fracture aperture calculations with the barton bandis model the rock mechanical parameters are needed since no published data are available for the regions of this study constant far field stress magnitude was applied to the fracture patterns to compute aperture distributions the common scenario of a shallow burial depth in a normal faulting regime with maximum compressive principal stress σ1 of 15 mpa minimum compressive principal stress σ3 of 10 mpa and a fluid pressure of 9 mpa are assumed for all outcrop models to study the effect of stress orientation β and fracture roughness jrc 0 on the permeability variation of the fractured rock six angles 0 30 60 90 120 and 150 degrees were considered for β and four joint roughness coefficients 5 10 15 and 20 were selected for jrc 0 to define the parameter space for our analysis moreover a residual friction angle φ r 25 was taken from the literature as plausible constant values for the models a fracture closure aperture of 20 μm was assumed to ensure that all fractures contributed to the flow cracks with an opening below this value are assumed to be sealed with a reactive pore fluid roedder 1984 a constant and isotropic matrix permeability km of 10 13 m2 100 md was assumed for all outcrop models table 1 enlists the mechanical parameters used in this study to compute the fracture aperture 4 geometric attributes here we use the same outcrop models introduced in azizmohammadi and matthäi 2017 therefore the same geometric attributes are considered here the characteristics of the outcrop models analyzed are presented in table 2 4 1 fracture length fracture length data are often influenced by two effects 1 truncation effect in which the spatial resolution restricts capturing short traces and 2 censoring effect where the long traces cannot be captured due to sampling limitations odling 1997 bonnet et al 2001 for most early sets and 2 d satellite images the fracture trace length distributions tend to be power law de dreuzy et al 2001 bour 2002 in this study the truncation and censoring effects for the abovementioned outcrop models were analyzed and a power law fit was obtained using the maximum likelihood estimation mle method more details can be found in azizmohammadi and matthäi 2017 4 2 fracture aperture and fracture permeability for each set of parameters the fracture aperture was computed using the barton bandis model the process was repeated for all the parameter space defined in table 1 to obtain the aperture distribution under certain conditions fig 5 shows aperture distribution and fig 6 displays the corresponding permeability map of all the models for β 150 and jrc 0 10 as an example for the applied differential stress only those fractures with an orientation that leads to a reduced fracture normal stress are dilated most of the fractures in the models are curved this implies that they are not dilated over their entire length and that only favorably oriented segments are dilated because their length is much less than the overall fracture length 5 simulation results the following sections present the results of the simulations performed on the outcrop models with the previously introduced setup to obtain the variations in the equivalent permeability tensor permeability anisotropy and fracture density with the sample size 5 1 equivalent permeability tensor equivalent permeability tensors were computed for square sample subregions covering a wide range of sample sizes from 0 44 to 794 m in different models figs 7 10 show the variation in the magnitude of k d k max e q k m maximum principal component k max e q normalized by rock matrix permeability km with changing stress orientation and fracture roughness in the kilve model fig 7 for all the joint roughness coefficients kd increases as the stress orientation β changes from 0 to 30 this occurs as most fractures are either aligned with the south s north n or east e west w direction thus β 30 gives the highest permeability by keeping both long e w and small s n fractures highly conductive similar situations occur at β 150 fig 7 this can be seen in the inset histograms showing the aperture distribution of the kilve model the lowest kd values are achieved for the cases in which β 90 as it minimizes the aperture of the long e w fractures connecting the boundaries at the left and right such a low kd shows that kilve tends to have an isotropic permeability at β 90 for stress orientation angles 0 60 and 120 the influence of jrc 0 on permeability is similar here the maximum values of kd decrease when jrc 0 increases from 5 to 10 however this value continues to increase as jrc 0 increases from 10 to 20 for stress orientation angles of 30 and 150 the maximum kd decreases increases and decreases when jrc 0 changes from 5 to 10 from 10 to 15 and from 15 to 20 respectively this shows that the influence of jrc 0 on the permeability of kilve is highly controlled by the stress orientation for the arches model fig 8 the influence of the stress orientation β on kd is similar for jrc 0 5 10 15 similar to the kilve model change in kd is significant with changes in β however when jrc 0 20 the change in kd with β becomes very small and the highest permeability is obtained at stress orientation angles of 0 and 90 degrees different from the other jrc 0 values the results show that an increase in jrc 0 leads to a huge decrease in kd for all stress orientation angles which can also be inferred from the aperture distribution displayed in the histograms this indicates that the joint roughness coefficient jrc 0 becomes a more influential factor when determining the permeability of large models in the hoerneln7 model fig 9 for jrc 0 5 10 15 the highest permeability values are obtained at β 0 60 120 however similar to the arches model this pattern changes when jrc 0 20 similar to the arches model permeability in general tends to be more isotropic for high joint roughness coefficients and there is a significant decrease in kd when jrc 0 changes from 15 to 20 here the joint roughness coefficient becomes a more influential factor when determining the permeability of this model this can be observed in the inset histograms showing the fracture aperture distribution of the hornelen7 model in the hornelen1 model fig 10 for all jrc 0 values kd goes through increase decrease cycles at every 30 degree increase in stress orientation angle β here similar to the kilve model an increase in jrc 0 does not necessarily make the permeability more isotropic in general these results indicate that a sharp decrease in fluctuations of kd occurs around ld 0 2 the variation in permeability with sample size fades even further within 0 2 ld 0 4 for ld 0 4 the variation in permeability with sample size is relatively small 5 2 permeability anisotropy permeability anisotropy at different length scales can be investigated by visualization of the permeability tensors which were computed on square samples with different sizes and stress orientations figs 11 14 demonstrate the permeability tensors as colored ellipses for all the outcrop models for jrc 0 10 the color varies from blue low contrast to red high contrast between the major and minor axes of the ellipse the axes of the ellipses were scaled with the principal components of the permeability tensor eigenvalues of k eq these figures show how the change in scale will influence the permeability tensors at different stress orientation angles as already determined in the previous section in the kilve model the lowest permeability values and the most isotropic permeability tensors are achieved at β 90 fig 11 for β 30 and 150 the permeability tensor is highly anisotropic and reaches its maximum value in the kilve model the local and global flow directions almost match in different scales however they vary substantially in the other models in the arches model fig 12 the flow could significantly change its direction and strength between two adjacent 100 m sample grids however in larger scales the flow direction is w e except for the case β 90 figs 13 and 14 show the permeability tensor of the hornelen models on grid sizes from 3 m hornelen1 to 720 m hornelen7 here we can see how the increase in the stress orientation angle could change the direction of the ensemble flow for example in the hornelen1 model fig 14 the ensemble flow direction could vary from sw ne to se nw by changing the stress orientation only from 60 to 90 degrees of course the change is less noticeable in the hornelen7 model fig 13 as the maximum sample size 18 m in the hornelen1 model is smaller than the smallest sample 90 m of the big hornelen7 model 5 3 fracture density fracture density was calculated for each sample subregion using the method introduced by wu and pollard 2002 fig 15 displays the change in fracture density with sample size these results also indicate a decreasing trend for the variation in fracture density with scale for all outcrop models nevertheless they do not behave like permeability indicating a difference between the scale dependencies of permeability and fracture density with sample size this occurs because fracture density does not account for fracture connectivity and direction and it weighs the fractures regardless of their permeability 6 discussion the impact of regional stress orientation and fracture roughness on equivalent permeability tensors magnitude and anisotropy and fluid flow pathways in dfm models mapped from 2 d outcrop fractured rocks were investigated we studied the effects of both stress state and fracture roughness on the overall hydromechanical behaviors of the fractured outcrop samples by coupling geometric characteristics and mechanical behaviors the results show that while this coupling has significant impacts on the equivalent permeability magnitude and its anisotropy it has no impact on the scale dependency of the equivalent permeability these findings are in line with previous studies long et al 1982 min et al 2004 bogdanov et al 2007 as they found revs for geostatistics based stochastically generated fractured models with variable fracture apertures our hypothesis here is to consider that far field stress orientations are representative for computing local fracture apertures because local stress perturbation and shadowing effects may influence fracture network properties remote stress alone cannot be simply applied to estimate the fracture aperture at the local scale zhang and sanderson 1996 however the aperture model that we used is based on asperity sliding where we ignore stress perturbation and shadowing effects moreover our approach goes one step beyond the most common approaches that have dominated the literature and that offer zero dimensional correlations statistical distributions and or constant apertures see e g long et al 1982 taylor et al 1999 and min et al 2004 the maximum principal component of the k eq is decreased with increasing sample size which indicates the existence of a practical rev this rev is supposed to be approximately ld 0 2 which will be 167 m for the arches model 144 m for the large scale hornelen7 model and 3 6 m for the small scale hornelen1 model this is a very important result for the upscaling purposes and simulation of fluid flow on the continuum scale for fractured rocks where the potential rev must be identified first the concept of rev is controversial however this work clearly showed that the flow based rev is not necessarily equal to the geometric based rev fig 15 additionally it is shown that rev could significantly vary between the rock properties sedaghat and azizmohammadi 2019 the results implied that the influence of the joint rightness coefficient on the permeability of the models intensifies as the model size increases figs 7 10 this is due to the stronger impact of jrc 0 on long fractures which are more frequent in large models fig 16 19 show the variation in fracture permeability with fracture length for different stress orientations β and fracture roughnesses jrc 0 for the kilve and hornelen1 models fracture permeability has an increasing trend with fracture length however in the arches and hornelen7 models where fractures are generally longer than in the kilve and hornelen1 models for all the stress orientation angles the permeability length trend changes with a change in jrc 0 this could be the reason why kd decreases with increasing jrc 0 for the arches and hornelen7 models figs 8 and 9 regardless of the stress orientation angle figs 17 and 18 change in fluid pressure as a result of production can lead to significant pressure fluctuations in fractures than in the matrix due to the large permeability contrast between them such operational conditions will influence the local stress state of the fractured system and consequently change the fracture permeability zhang and sanderson 1996 this must be considered during the production phase in this study we do not consider local stress perturbation and shadowing effects due to variation of pore pressure during production therefore far field stress is assumed equal to local stress on the fracture plane this simplification will influence the local fracture aperture and may overestimate the aperture size up to 5 bisdom et al 2016b 3 d fractured models seem to be more realistic for naturally fractured rock studies connectivity of 3 d fractured system is misinterpreted by 2 d models if the fractures have partial penetration of the sedimentary layers de dreuzy et al 2012 therefore analysis of layer restricted patterns is very important however they are sufficiently complex to merit a separate publication furthermore there are some major limitations regarding 3 d models 1 observability of 3 d data in natural outcrops recent developments in imaging techniques e g lidar scanning will open up a huge research potential in this area 2 availability of 3 d models as they are not commonly used in fractured rock studies 3 characterization of 3 d models even if the 3 d model exists it cannot be easily characterized the conventional approach to model 3 d fractured domains is to assume statistical distributions of apertures the big challenge here is to get the right spatial correlation else the results will not be representative of the actual aperture pattern in the natural systems pollard and aydin 1988 on the other hand correlating 2 d to 3 d systems seems unlikely to be straightforward the rev analysis approach developed here does not have any limitation with regard to applications to 3 d models it should be mentioned that in practice fractures can behave as sealing barriers to flow in such cases upscaling of the system containing a wide range of permeabilities from non conductive impermeable to extremely conductive fractures might get in trouble as finding the equivalent permeability is not trivial multiscale methods have been developed to address such problems by transferring the solution e g pressure to coarser scale this makes them attractive compared to traditional upscaling approaches when highly heterogeneous systems are considered tene et al 2017 7 conclusions we analyzed the scale dependence and anisotropy of the equivalent permeability in layered fractured rocks using fracture patterns mapped in natural outcrops by including the impact of regional stress orientation and fracture roughness the barton bandis constitutive model was applied to fractures segment by segment to compute the realistic local aperture distributions based on the far field stress the resulting fracture apertures are almost log normally distributed then the equivalent permeability tensor k eq was computed using a flow based upscaling approach for varying sample size stress orientations and fracture roughness we found a strong anisotropy imposed by the fractures that show significant variations of the equivalent permeability tensor k eq magnitude and direction although selected outcrops show a rather homogeneous pattern we found that the axes of the k eq are neither aligned with the conductive fractures nor with the principal directions of the far field stress thus a full tensor of equivalent permeability is absolutely required for modeling flow through fractured rocks at the continuum scale we found that rev could exist for the models studied here as the maximum principal component of the k eq decreased with increasing sample size this flow based rev does not coincide with the geometric based rev we also found that the roughness becomes a more influential factor when determining the permeability of a large model by decreasing the permeability of long fractures increase in roughness also decreases the frequency of wide fractures credit authorship contribution statement siroos azizmohammadi conceptualization methodology software visualization writing original draft mohammad sedaghat conceptualization formal analysis validation writing review editing declaration of competing interest all authors have participated in a conception and design or analysis and interpretation of the data b drafting the article or revising it critically for important intellectual content and c approval of the final version this manuscript has not been submitted to nor is under review at another journal or other publishing venue the authors have no affiliation with any organization with a direct or indirect financial interest in the subject matter discussed in the manuscript acknowledgements we thank mandefro belayneh saudi aramco and noelle odling university of leeds uk who gave us permission to use their original fracture trace maps without their datasets this work would not have been possible we greatly appreciate their support the fracture datasets used in this study may be obtained by contacting the first author via email siroos azizmohammadi unileoben ac at supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103579 appendix supplementary materials image application 1 
483,sensitivity to the boundary conditions bc s when determining macroscopic transport coefficients by numerical upscaling in finite domains is a well known methodological issue explored here with the purpose of quantifying the influence of the bc s in relation with the parameters of the system porosity characteristic length scale conductivity contrast assessing the level of confidence associated with the predictions devising criteria to anticipate the risk of serious artifacts and proposing ways to limit them the terminology of thermal transfer is used but the developments apply to any transport mechanism governed by a diffusion equation including conduction mass diffusion or darcy flow quantitative indicators are defined for a rigorous individual or comparative assessment of conductivity tensors and used in the analysis of extensive numerical data obtained in tomographic images and model materials with a broad range of properties practical criteria are proposed for the a priori and a posteriori detection of at risk situations and a self diagnosing protocol is proposed to screen out the bc s influence whenever possible keywords numerical upscaling conductivity permeability boundary condition tomography undersampling 1 introduction sensitivity to boundary conditions bc s is a well known issue when determining macroscopic transport coefficients by numerical upscaling i e by solving governing equations in a finite domain where the required fields of the local properties are provided either for instance by x ray tomographic imaging for core scale samples shi et al 2020 or from geophysical characterization techniques on the field scale hubbard and rubin 2000 in the first case with a full knowledge of the microscopic geometry the upscaling of stokes flow equations for the determination of a permeability tensor can be addressed stokes darcy as well as any conduction or diffusion transport processus in the latter case the data are provided on a coarser scale where the flow properties are already described by a mesoscale permeability coefficient and the secondary upscaling aims to determine a permeability tensor of the same nature but on a larger scale we focus in this work on steady state conduction like processes governed by fourier ohm fick or darcy laws which are mathematically equivalent a heat transfer terminology is used but the word conductivity can be understood throughout this paper as thermal electric hydraulic or mass diffusivity with temperature t replaced by potential pressure or concentration see section 2 3 the same question was addressed in the recent contribution shi et al 2020 where four tomographic images of materials of various natures were used for a thorough assessment of the bc s influence the present paper proceeds along the same lines and also considers synthetic media which makes a systematic investigation of geometrical parameters possible and allows to formulate the phenomenological observations of shi et al 2020 in a more general and quantitative way in order to be reasonably self contained many definitions of mathematical and conceptual tools are repeated here but some elements are skipped for concision complementary bibliographical elements phenomenological discussion and additional technical details can be found in shi et al 2020 various procedures based on different kinds of boundary conditions have been used since the earliest days of numerical upscaling of heterogeneous system properties on the field scale long et al 1982 or on the core scale based on tomographic digital images spanne et al 1994 and the differences in the results of different approaches was often pointed out the brief following review focuses on contributions which present systematic comparisons and or address theoretical aspects of the issue the general review renard and de marsily 1997 of theoretical aspects of the upscaling techniques for darcy flow in heterogeneneous media surveys various protocols and stresses the sensitivity of the resulting block permeability to the bc s darcy flow upscaling procedures are also extensively reviewed in durlofsky 2005 including the aspects associated with bc s and post treatments periodicity permeameter and immersion conditions see section 2 5 as well as others involving the introduction of border regions see below and section 2 8 are surveyed and their relative merits and shortcomings are discussed more recently various bc s have been tested in andrä et al 2013 for the evaluation of the electrical conductivity of rock samples from tomographic images it was stressed again that the choice of bc s is important but no conclusion or advice was put forward the undersampling and oversampling approaches proceed from the same idea in the search of an intrinsic value of an effective conductivity in the former the sampling domain is reduced by excluding from the measurements a peripheral layer so that boundary effects are minimized the procedure described in section 2 8 proceeds along these lines it was applied in lang et al 2014 but without quantification of the difference it makes or investigation of the requirements for the removed layer thickness the oversampling approach follows the opposite way by using an enlarged sampling block so that the conductivity measured in the domain of interest is not polluted by the boundary effects confined in the peripheral region the r p boundary conditions described in section 2 5 is an application of this approach the term oversampling is due to wu et al 2002 but the method was introduced earlier gomez hermindez and journel 1990 and used under different names by others such as wen et al 2003 it requires a knowledge of what surrounds the investigated domain which can be available in the situations addressed in wu et al 2002 gomez hermindez and journel 1990 wen et al 2003 where the aim is the coarsening of a detailed large scale permeability field but not when operating with a tomographic image let us mention for completeness important contributions about the upscaling of the microscale stokes equations for flows in porous media which is a mathematically different problem but just as sensitive to the prescibed boundary conditions the classical bc s are of the same type as those for conduction problems combining periodicity dirichlet and neumann conditions several of them resulting in significantly different predictions are implemented in piller et al 2009 where the undersampling procedure is also used for the identification of a region nearly unaffected by the bc s systematic investigations where many kinds of bc s have been applied and compared have also been conducted in guibert et al 2016 gerke et al 2019 including an effective medium approach similar to e p in the following see section 2 5 thus a corpus of knowledge exists in the literature but unfortunately it consists in many disparate comparisons of approaches in particular cases and whereas the influence of the choice of a procedure and bc s is always pointed out the differences between predictions are often presented in an illustrative and or qualitative way even the most systematic studies provide general observations and mention some pitfalls but rarely come up with practical recommendations thus someone in search for practical advices for an application is at a loss to find explicit guidance of course at least in the case of tomographic sample images there is no right answer since what lies beyond the sample boundaries is unknown if two methods yield different results it generally cannot be claimed that one of them is right although it can sometimes be detected that one or both of them is wrong with a quantitative estimate of just how wrong it has to be therefore our work was conducted with several objectives in mind contribute to the knowledge base by a systematic examination of a variety of materials with quantification of the influence of the boundary conditions in relation with the parameters of the system volume fractions characteristic length scale of the microstructure contrast of the local conductivities provide quantitative tools for the assessment of the expected level of confidence associated with predictions and if possible propose self diagnosing procedures identify criteria possibly just rules of thumb a priori or a posteriori for the detection of the risk situations where serious artifacts can be expected and particular caution is required fullfilling this involves extensive numerical calculations but also the definition of quantitative indicators for a rigorous analysis of the results the work was initiated in shi et al 2020 by treating tomographic images of several kinds of real materials phenomenological knowledge was gained from this collection of particular cases quantitative assessments have been conducted for each of them and general trends identified in the present study synthetic numerically generated media are used to explore systematically a wider range of morphological parameters and more general quantitative criteria are obtained the paper is organised as follows section 2 starts with a description of the context and of the investigated samples which include tomographic images of real materials and synthetic numerically generated model media the mathematical problem to be solved is then stated and a brief description of the numerical solver is provided the set of bc s considered in the study is introduced and some of their expected artefacts are commented the procedure to obtain the full effective conductivity tensor is described from the whole sample or from measurements in inner sub domains undersampling finally some rigorous quantification tools for the comparative analysis of the results are introduced the results are presented in sections 3 5 starting with global indicators such as the mean conductivities and especially the distances between tensors resulting from different bc s then qualitative comparisons of the local fields are presented in section 4 which provide a phenomenological picture of the effects of the boundary conditions and a quantitative analysis of their differences is conducted finally the undersampling approach is illustrated in section 5 by applications to several examples a discussion in section 6 concludes the paper 2 context and methods 2 1 context the initial motivation for this study stemmed from a practical thermal problem which explains that when we decided to investigate with some rigour the issue of the bc s influence in finite domains for the possible benefit of a wide community of colleagues facing the same difficulties we kept the thermal terminology and refer to solid and gas phases with conductivities λs and λg however this bears no particular meaning since the following developments apply for any mixture of two components with different conductivities in particular when considering darcy flow in heterogenous media what is called here gas and solid can actually correspond to regions with different permeabilities furthermore the ratio λs λg can range from very large in thermal applications to very small if λ stands for mass diffusivity or electrical conductivity in a brine saturated porous medium where the solid phase is nearly if microporous or totally impervious for this reason a broad range of conductivity contrasts with 10 4 λ s λ g 104 was explored in the materials presented below see table 2 only binary media are considered containing two phases with constant isotropic conductivities media with continuous variations of the local conductivity could be treated in the same way some of the effects would probably be milder but the general trends are not expected to differ and the methods and quantification tools presented in the following would retain their interest 2 2 investigated materials tomographic images of real materials and synthetic model media have been investigated in all cases the geometry is described by a phase function z defined in a lx ly lz array of cubic p x 3 voxels equal to 1 in the pores and to 0 in the solid two of its statistical moments are of a foremost interest the first one is the porosity ϵ which is the volume average z the second one is the spatial correlation function rz u covar z x z x u var z the integral correlation length l c 0 r z u d u per direction if rz is anisotropic provides a length scale associated with the microstructure when rz u happens to decay exponentially this lc is also equal to the decay length note that the samples considered here are all cubic i e l x l y l z l the tomographic images are rock samples already examined in earlier works namely a fontainebleau sandstone fs with porosity 0 0692 fully characterized in thovert et al 2001 fig 1 a and a bentheim sandstone bs with porosity 0 232 studied in thovert and adler 2011 fig 1b in both cases the correlation function is isotropic and exponentially decaying their characteristics are given in table 1 these two samples were already considered in shi et al 2020 and they are kept here for comparison purposes with the synthetic media the other two samples of shi et al 2020 were of a different nature namely thermally degraded polymer based composites they were interesting because they are multiscale and anisotropic but they are not considered here for the sake of concision and because of their smaller sizes two kinds of model media have been systematically investigated in the penetrable sphere model psm thovert et al 2001 thovert and adler 2011 solid spheres with radius r are inserted with a density ρ at random positions in the 128 r 3 unit cell of a periodic medium fig 1c the pore space which remains uncovered has a volume fraction ϵ z e 4 3 π r 3 ρ the percolation threshold ϵ c of such media is about 0 034 a set of porosities above ϵ c has been investigated with 10 values of ϵ ranging from 0 04 to 0 30 see table 2 the spatial correlation is given by eq 16 in thovert et al 2001 and the correlation length lc is about r 2 from lc 0 4 r when ϵ 0 04 to lc 0 6 r when ϵ 0 30 thus the sample size 128 r 3 roughly corresponds to 256 lc 3 in the thresholded gaussian field tgf model adler et al 1990 adler 1992 a discrete field z with prescribed mean z ϵ and spatial correlation function rz is obtained by the following steps first generate a random uncorrelated gaussian field x convolve it in fourier space with a kernel derived from the target correlation function rz to obtain a correlated gaussian field y finally set the phase function z equal to 1 where y exceeds a threshold that depends on the target porosity here the correlation was taken isotropic and exponentially decaying according to r z u e u l c and samples of size 128 lc 3 were generated fig 1d the percolation threshold ϵ c of such media is in the interval 0 08 0 09 porosities from this range up to 0 25 have been investigated see table 2 the reconstructed samples are periodic for both psm and tgf the spatial resolution voxel size was set to p x l c 4 tgf or r 4 psm so that z is stored in a 512 3 array in order to obtain aperiodic samples comparable to tomographic images of real media a peripheral layer of thickness 2lc or 2r is removed from the generated samples which results in 124 lc 3 for tgf or 124 r 3 for psm computation domains these reduced domains are called ω whereas the larger initially generated domains are called ω 2 3 local and upscaled formulations stationary thermal conduction in a heterogeneous medium with position dependent thermal conductivity λ is governed on the local scale by fourier s law and a conservation equation 1 q λ t q 0 where q is the heat flux and t is the temperature if the medium statististical properties are spatially uniform it can be regarded on a larger scale as an equivalent homogeneous material with effective properties and in particular with an effective conductivity λ which relates the locally averaged flux and gradient 2 q λ t q 0 even though the local conductivity is assumed to be isotropic the medium structure can be anisotropic and therefore the effective coefficient λ is in general tensorial if the medium is not strictly homogeneous 2 still applies with a position dependent λ if its characteristics are slowly varying i e on a regional scale much larger than the microscale of the λ fluctuations then an intermediate scale the so called representative elementary volume rev smaller than the former and larger than the latter can exist upon which volume averages of the flux and gradient can be taken note that the rev is often defined only as the minimal averaging volume required to damp porosity fluctuations whereas we are talking here of the averaging volume necessary for a robust estimation of a transport coefficient very often this is a more stringent criterion for instance close to a percolation threshold when the conductivity contrast is strong but as illustrated in section 5 it can also be a milder criterion in the case of a moderate conductivity contrast the upscaling from 1 to 2 reduces of course tremendeously the computational effort required for simulations on the field scale since much coarser volume elements with effective properties can be used the theoretical background for the homogenization process is classical and not detailed here see e g adler 1992 quintard and whitaker 1993 bourgeat et al 1988 let us just mention that λ is a symmetric positive tensor this applies to any diffusion like process governed by mathematically equivalent equations such as mass diffusion of electrical conduction furthermore whereas creeping fluid flow through a porous medium is governed locally by stokes equations a first upscaling step can reduce the flow problem into a homogenized form similar to 1 involving darcy s law 3 v 1 μ k p v 0 where v is the seepage velocity p is the pressure μ is the fluid viscosity and k is a permeability coefficient this formulation applies on a scale much larger than the medium microstructure but the medium can be heretogeneous on a still larger scale which makes k position dependent in this case a second upscaling can be performed to obtain a counterpart of 2 involving an effective permeability tensor k 2 4 solution of the local problem the problem governed by 1 is solved in the domain ω or ω subject to various conditions on its boundary ω or ω which are detailed in the next section 2 5 the solver is a distant descendant of that presented in henriette et al 1989 where the formulation is described in full details equations 1 are discretized in a finite volume formulation according to the so called box integration method t is determined at the vertices of cubic volume elements the resulting set of linear equations a t b is solved by a conjugate gradient method iterations are stopped when the global relative residue a t b becomes smaller than 10 6 b this criterion for the global residue translates into a o 10 4 relative accuracy for the components of the predicted mean flux and to at most 10 3 for pointwise temperature relative to the overall temperature drop note that this is much more demanding than the stopping criterion for routine applications where 10 4 is regarded as sufficient this much finer and numerically much costlier accuracy is required for a reliable comparison of the solutions for different bc s the computation time depends of course on the sample size but also strongly on the conductivity contrast for the record the determination of a conductivity tensor 3 solutions for different mean gradient directions in fs takes 10 20h when λ s λ g 10 1 and 100h when λ s λ g 10 4 single core 3 4ghz xeon cpu time of course the computations were run in parallel over multiple cores since e p is an iterative procedure in an enlarged domain some calculations took up to 800h in routine applications the stated cpu times should be divided by about 10 resp o 102 if an accuracy of 0 1 resp 1 for the global conductivity tensor is regarded as sufficient the volume averages q and t of the flux and gradient in ω are actually evaluated by the surface integrals 4 q 1 ω ω q x n x d s t 1 ω ω t n d s where n is the unit outwards vector normal to ω 2 5 investigated boundary conditions a natural way to set the overall bc s for the solution of problem 1 in a finite sample ω without knowledge of what lies beyond its boundaries ω is to mimic real or virtual experimental settings as illustrated in fig 2 permeameter conditions named after a common apparatus for permeability measurements correspond to the situation where the sample is placed between two isopotential chambers dirichlet conditions and enclosed transversally in an impervious jacket obviously the no flux condition through the transverse boundaries constrains the flux directionally and makes this approach inappropriate for the determination of the full tensors λ or k in anisotropic media therefore in spite of their frequent use permeameter conditions have not been included in the set of investigated bc s listed below d p the disturbing impervious walls of the permeameter can be removed in a virtual experiment where the single jacketed sample is replaced by a layer of juxtaposed replicas exposed to the same upstream and downstream dirichlet conditions we call the corresponding bc s d p standing for dirichlet and periodic in the axial and transverse directions respectively for instance for a calculation along the x direction 5a t x 0 g l x t x l x 0 5b q 2 q 1 t 2 t 1 at homologous points x 1 x 2 on opposite transverse faces of ω p p in another virtual experiment the entire space can be covered by such identical replicas periodicity of fluxes and temperature gradient can be applied along all directions regardless of a geometrical mismatch at opposite faces of the sample if g is a prescribed macroscopic temperature gradient 6 q 2 q 1 t 2 t 1 g x 2 x 1 at homologous points x 1 x 2 on any opposite faces of ω e p one may consider that the sample ω perceives its surroundings as a homogeneous material with the same effective conductivity to be determined submitted to far field conditions in the form of a prescribed macroscopic gradient a sheath of homogeneous material tentatively screens out most of the influence of the outer bc s and the enlarged domain ω can be treated as periodic since there is no geometrical mismatches at its boundaries thus problem 1 is solved in ω with the periodicity conditions 6 applied on ω we call this e p for encased and periodic integrations 4 to obtain the mean flux and gradient are restricted to ω the embedding medium is given a conductivity λ e possibly anisotropic equal to that obtained in ω since the latter is not known beforehand this is an iterative process a reasonable guess for λ e is used first which is updated after successive resolutions until convergence the layer added on the six faces of the samples was 16 voxels thick for the tomographic images 2lc for tgf and 2r for psm it has been checked that this is sufficient to make the results nearly independent of the layer thickness both for the global parameters and for the local deviations in ω by comparison with systematic data for the tomographies with a thickness of 8 voxels and selected cases for the synthetic media e g with 4lc and 8lc for tgf it is worth noting that although the idea of a self consistent effective medium scheme is very common in theoretical models for the conductivity of composites such as those of bruggeman 1935 or landauer 1978 it seems that its numerical counterpart has not been implemented in earlier works for the upscaling of conduction properties but it is in guibert et al 2016 gerke et al 2019 for the upscaling of the stokes flow equations and in knackstedt et al 2006 to compute the elastic properties of low density materials d d in a somewhat far fetched approximation one may assume that the far field conditions of e p apply down to ω in these so called immersion conditions denoted d d dirichlet conditions are imposed on the entire boundary ω of the domain corresponding to a prescribed mean gradient with 7 t x g x on ω within an arbitrary additive constant in practice with g along one of the axes of coordinates this results in dirichlet conditions 5a on inlet outlet faces and linear profiles along the transverse faces note that a counterpart of d d was considered in pouya and fouché 2009 where the normal flux instead of t is prescribed on the boundaries with q x n b n on ω where b is a prescribed vector which correspond to q as shown by 4 r p the last kind of bc s considered here is a special case applicable only to synthetic media and introduced only for comparison purposes recall that periodic psm and tgf samples ω with sizes 128 lc 3 or 128 r 3 are generated first which are subsequently reduced by removal of a peripheral layer to obtain aperiodic domains ω similar to tomographic images see section 2 2 however problem 1 can also be solved in ω with periodicity conditions as done in e p again integrations 4 to obtain the mean flux and gradient are restricted to ω this is akin to the oversampling method wu et al 2002 gomez hermindez and journel 1990 wen et al 2003 where the properties of a sample are determined by solving the flow problem in an wider domain when the required data are available e g when determining the properties of a block extracted from whole field data it is also possible for our numerically generated samples and provides a reference solution hence the name r p note however that ω is supposedly the only data available the larger ω is a periodic continuation of ω but not the unique possible one and therefore reference does not mean right or unique extensive references are provided in shi et al 2020 for many applications in the literature of the various bc s mentioned in the above and of some others in particular the computation domain is sometimes made periodic by juxtaposing mirrored images of ω this approach was not considered here because as the permeameter conditions it introduces directional constraints and the eigen directions of λ or k can only be found aligned with the artificial planes of symmetry as demonstrated for instance in guibert et al 2016 gerke et al 2019 2 6 artefacts associated with the boundary conditions with the exception of p p applied to periodic media which generally means model media all the conditions listed in section 2 5 present some undesirable features consider for illustration purposes the most severe situations where only the pore phase is conducting λs 0 milder but similar effects are expected for moderate contrasts periodicity p p imposes that the fluxes on opposite faces are equal but since the phase arrangements in these faces do not match in aperiodic media the flux has to cross a plane with a much reduced open fraction equal to ϵ2 in the average fig 3 a this introduces a skin resistance and the overall conductivity is underestimated with dirichlet conditions d p flux can enter any pore showing on the inlet face of ω although some of them are actually dead ends and would receive no flux from the actual upstream material fig 3b the overall conductivity is overestimated with the pressure condition 7 of d d flux can leave or enter any pore showing on a lateral face of ω as if some continuous conducting material lay beyond ω this creates long range connections all along the lateral faces fig 3c which can behave as an apparent lateral conducting skin the overall conductivity is overestimated these effects of d d are also illustrated in guibert et al 2016 gerke et al 2019 in the context of fluid flow governed by stokes equations note that the artefacts associated with p p and d p are local features they affect the transfers through a surface which the flux has to cross if t or might cross if t conversely the artefact introduced by d d has long range effects generally with stronger impact on the predicted conductivity as indeed observed in the following in a caricatured situation it would yield non zero flux and effective conductivity if ω were entirely filled with insulating material except for small unconnected conducting parts located at its corners 2 7 determination of a full tensor λ equations 1 are solved subject to one of the bc s listed in section 2 7 say bc with the vector g set successively along the x y and z directions in each case the mean flux q ξ and gradient t ξ ξ x y or z are evaluated by means of 4 note that t in ω is equal to g in the cases of d p p p and d d however when g is applied on the boundaries of the enlarged domain ω for conditions e p and r p the mean gradient in ω can be different and has to be calculated from the temperature field by application of 4 then the following set of 9 linear equations is solved to determine the 9 components of λ bc 8 q ξ λ b c t ξ ξ x y and z with conditions p p d d e p and r p the solutions obtained with different vectors g can be superposed in view of the linearity of the governing equations therefore the solution for any g can be obtained by a linear combination of the solutions with g set along the three axes and λ bc determined by 8 can be used to predict the mean flux resulting from any mean gradient conversely the solutions obtained with d p applied along x y and z cannot be superposed thus the derivation of λ d p is only formal and 8 applies only for g set along x y or z anyway it is difficult to conceive a numerical experiment where conditions of the type d p would be imposed along a direction oblique relative to a parallelepipedic sample note that the same observations apply as well to the permeameter conditions where transverse periodicity is replaced by a no flux condition however this does not preclude λ d p from bearing information about the sample conductive properties the effective tensor λ should be symmetric and λ p p obtained by 8 with periodicity conditions p p is indeed symmetric the demonstration relies on a reciprocal theorem see e g adler 1992 the same line of reasoning shows that λ d d is also symmetric pouya and fouché 2009 however λ d p λ e p and λ r p are not necessarily symmetric even though periodicity conditions are applied on ω in the cases of e p and r p symmetry would be ensured with e p and r p only if the averages used in 8 were evaluated over ω instead of ω asymmetric tensors are defective and two techniques are widely used to put up with situations where the upscaling procedure yields an asymmetric result the simplest is to make the tensor symmetric by averaging it with its transpose 9 λ s y m λ b c λ b c t 2 another approach is to supplement 8 with additional equations stating the symmetry of λ bc the system becomes overdetermined and it has to be solved in some least square sense generally some residual asymmetry remains which can be eliminated with 9 durlofsky 2005 such expedients are necessary for the practical use of λ in simulation models but no such step was taken in the present investigation the purpose is not to cure the asymmetry of λ bc but to quantify it and explore the circumstances of its occurence 2 8 undersampling the fundamental idea underlying the application of upscaled models is the belief that an effective coefficient λ exists which relates the locally averaged flux and gradient regardless of the circumstances i e far field conditions which induce t at the position where 2 is applied this has been theoretically established in auriault 2011 by considering an rev deep within a macroscopic domain v under the assumption that the macroscale and the rev scale are widely separated however whether this requirement is fulfilled in practice in a given sample has to be checked directly as well as the screening distance and whether an rev remains when the corresponding layer is discarded on this premise it can be attempted to determine this value of λ by focusing on some inner subdomain ω c in ω if the tensor λ c obtained by 8 with the mean fluxes and gradients given by the integrals 4 applied to ω c is found independent of the conditions applied at ω this λ fulfills the aforementioned requirement for its use in upscaled models this methodology has been applied in lang et al 2014 for conduction processes and in piller et al 2009 for fluid flow we have applied this approach with subdomains ω c m obtained by removing from ω a peripheral layer with thickness m the conductivity tensor of ω c obtained from the solution of 1 with conditions bc at ω is denoted λ bc c m obviously a thick enough margin m not too small is required to screen out the influence of the outer conditions on the other hand the subvolume ω c has to be sufficient m not too large to remain representative i e to prevent the occurence of large statistical fluctuations if the whole sample ω is large enough an intermediate range for m can exist where both of these criteria are fulfilled this means that over this interval λ bc c m should be independent of bc first criterion and m second criterion i e the effective tensor λ for the investigated material of course the term independent has to be understood within some practical tolerance and a quantitative indicator is required to measure the difference between two tensors such an indicator is defined in section 2 9 2 9 notations and quantification tools a few notations and definitions are introduced here which are used in the subsequent discussions first the mean λ of the diagonal terms of a tensor λ the anisotropy index n the arithmetic and harmonic volume averages of the local conductivities λ and λ h and the index τ are defined by 10 λ 1 3 i λ i i n λ m a x λ m i n λ 1 ω ω λ d v λ h 1 1 ω ω λ 1 d v τ λ λ m i n 1 where λmax and λmin are the largest and smallest eigenvalues of λ λ and λ h are the fully general upper and lower wiener s bounds in addition hashin shtrikman s upper and lower bounds hashin and shtrikman 1963 are denoted by λ h s u and λ h s l both sets of bounds only depend on the phase conductivities and volume fractions but the tighter hashin shtrikman s bounds apply only to isotropic media the index τ discriminates situations where the volume containing the most conducting phase is well connected λ o λ τ 1 or tortuous and or poorly connected λ λ τ 1 for the nearly isotropic media considered here λmin in the definition of τ is close to λ but it is very different for some anisotropic materials considered in shi et al 2020 a distance is introduced to quantify the difference between two tensors say λ 1 and λ 2 resulting for instance from different upscaling protocols in response to a same unit gradient g these tensors predict fluxes q i λ i g the squared norm of their deviation q 2 q 1 2 is equal to g t λ 2 λ 1 t λ 2 λ 1 g it is maximum when g is aligned with the eigendirection of λ 2 λ 1 t λ 2 λ 1 associated with its largest eigenvalue therefore we measure the difference of λ 1 and λ 2 by the distance d and the normalized dimensionless quantity d defined by 11 d 2 λ 1 λ 2 largest eigenvalue of λ 2 λ 1 t λ 2 λ 1 d d λ 1 λ 2 1 2 d λ 1 λ 2 is the maximal relative deviation combining magnitude and direction differences of the fluxes predicted by λ 1 and λ 2 when applied to the same gradient note that the λ i s do not need to be symmetric in the definition 11 and that d is a distance in the mathematical sense i e a symmetric positive definite function satisfying the triangle inequality although d is used in other contexts to measure the difference between matrices to monitor the convergence of iterative numerical schemes ralston and rabinowitz 2001 we are not aware of its use for the comparison of tensorial transport coefficients prior to shi et al 2020 another quantity of interest is the asymmetry index a and its normalized dimensionless counterpart a 12 a 2 λ 1 i j 3 λ i j λ j i 2 2 a λ a λ λ this indicator has an interesting relation with d namely that if λ 2 λ 1 is antisymmetric then d λ 1 λ 2 a λ 2 λ 1 this implies that if a tensor λ bc resulting from an upscaling procedure is not symmetric it differs from λ sym obtained by the symmetrization 9 by d λ b c λ s y m a λ b c and by at least that much from any possible acceptable and therefore symmetric conductivity tensor furthermore this is only a lower bound for the error for instance say λ bc differs from an exact value λ i by a gaussian noise with standard deviation σλ for all its components then a λ b c 0 33σ and d λ b c λ i 4 9 a averages over 108 monte carlo realizations hence even a moderate asymmetry by a few percent should be considered with attention instead of carelessly eliminating it with 9 since it can point at a quite significant uncertainty in the tensor determination 2 10 notes about the influence of the spatial resolution the discrete representation of a medium and the predicted fluxes and therefore conductivity tensor obtained when solving 1 obviously depend on the spatial resolution and possibly on preliminary treatments of the primary tomographic or geophysical data in particular singular contacts can be overlooked or near contacts can be interpreted as actual contacts with significant impact when the property contrast is large whatever the bc s these effects have been examined in details in guibert et al 2015 guan et al 2019 however while singular contacts or lack of make a difference for the fields in a region around them they do not affect the thickness of the peripheral layer where the kind of bc s is felt unless the property contrast is extreme and a very coarse resolution prevents the conducting phase from percolating but then sensitivity to the bc s becomes a secondary issue sensitivity to spatial resolution and to the boundary conditions both contribute to the uncertainty of the conductivity prediction but they are different and mostly independent matters we focus in the present work on the latter which remains even if the resolution is excellent and on the way to get the best out of an available digital image if need be the proposed procedures can be applied to variants of the image resulting from different pre treatments furthermore the trends and general observations mentioned in the following regarding the differences between predictions from different bc s are not expected to depend on resolution this is supported by the similarity of the observations for the present samples whose resolution quantified by the ratio lc px ranges from 1 6 to 6 5 see table 1 and by a direct comparison for model media not reported here for instance identical 64 r 3 psm samples have been discretized with r 4 6 and 8px the responses to different bc s differ in the same way in all cases over the whole range of porosity and conductivity contrast 2 11 summary of the investigated cases the combinations of porosities conductivity contrast and boundary conditions considered for the various kinds of samples are summarized in table 2 twenty four values of λs λg ranging from 10 4 to 104 have been used in fs and bs for all bc s described in section 2 5 except r p by lack of data in the surroundings of the samples note however that the undersampling technique is a way to reach the same objective several values of the porosities have been considered in the model media up to 0 25 tgf and 0 30 psm since the results for fs and bs show that nothing dramatic occurs when the most conducting phase is also the most present the range of contrast was reduced in the model media with 10 4 λ s λ g 10 1 i e the cases when the least present phase pores is the most conducting all bc s but d d have been applied in tgf and all but e p in psm except for the cases indicated in table 2 where the 5 kinds bc s were imposed four stochastic realizations have been treated in each case for the model media unless otherwise stated the results presented in the following are averages over the four samples these averages are arithmetic for quantities such as λ and quadratic rms when deviations such as d or δ t in section 4 are considered 3 results for global indicators we consider here global indicators i e quantities which can be deduced from the tensors λ obtained by solving problem 1 subject to with the various bc s without scrutinizing the local fields the simplest one is the mean conductivity λ which is plotted as a function of λs λg in fig 5 for fs bs and examples of psm and tgf with porosities 0 08 and 0 12 and for all investigated bc s the graphic conventions for this figure and subsequent ones are explicited in fig 4 λ is normalized by λ for an easier comparison of results with very different orders of magnitude when the phase conductivities vary note that the ratio λ λ can be viewed as a tortuosity factor since it approaches one when most heat flow takes place along straight streamlines in the most conducting phase the samples are actually slightly anisotropic the anisotropy index n see eq 10 can reach about 1 2 in fs and in individual realizations of psm with large contrasts and small porosities 1 16 in bs and 1 08 in psm but plots of λmin and λmax look very similar to fig 5 several general features stand out whatever the bc s a when the conductivity contrast is very large one expects that one of the phases ultimately plays a negligible role and that an infinite ratio or some very large finite value makes vanishing difference this is observed in many cases with established asymptotical values beyond 10 3 but λ λ is still decaying when λ s λ g 10 4 in some others it has been checked that the gas space is percolating in all these cases which implies that some non zero asymptotic value exists when λs λg 0 but convergence is not reached in the investigated range note that the slow convergences occur when λ λ is small i e when τ 1 b for comparison wiener s lower bound λ h and hashin shtrikman s bounds λ h s l and λ h s u are also shown in fig 5 wiener s upper bound corresponds to unity of course all these bounds provide reasonable estimates for small contrasts but they grossly deviate from the numerical data for λs λg beyond 10 1 note that the eigenvalues of λ sometimes slightly exceed the hashin shtrikman s bounds this is not aberrant since hashin shtrikman s bounds apply to isotropic media and do not constrain λ max and λ min in anisotropic ones c solid is largely predominant in fs and bs therefore when it is the most conducting phase tortuosity is minimal and λ is not much smaller than λ in the opposite case of λs λg λ λ 1 20 fs or 1 3 bs d even though ϵ 0 12 for the example of tgf is larger that the porosity in fs 0 069 or in the example of psm 0 08 its ratio λ λ is smaller when solid becomes nearly insulating this results from a poor connectivity of the pore space 0 12 is not much larger than the percolation threshold ϵ c 0 09 of tgf while 0 08 is more than twice ϵ c 0 034 for psm similar and more dramatic illustrations of the influence of the morphology can be found in shi et al 2020 in foam like media where porosity is large but the pores consist in poorly connected inclusions the volume fraction and connectivity issues mentioned in c d are expected to influence the impact of the bc s on the determination of λ when the most conducting phase is predominant and well connected artefacts such as those illustrated in fig 3 a b are expected to be minimized conversely strong effects are probable when a poorly connected phase with low volume fraction is the most conducting the comparison of the data in fig 5 confirms these expectations the relative deviations between the predictions from various bc s are small when λ λ i e τ 1 and large when λ λ i e τ 1 it is also observed that the predictions of p p r p and e p are generally in fair agreement that those of d p somewhat deviates from them and that d d can yield very different and always larger results this can be quantified and analyzed in more details by considering a secong global indicator namely the relative difference d between tensors resulting from calculations with different bc s furthermore beyond the mere difference in mean conductivity λ the measure d incorporates the differences between the eigenvalues as well as the deviations between the eigenvectors of the tensors the distance d λ 1 λ 2 between the conductivity tensors resulting from calculations with different conditions bc1 and bc2 is plotted in the top row of fig 6 as a function of λs λg for the same media as in fig 5 note that the very small values of d must not be taken literally the deviations between very similar predictions of λ for two kinds of bc s involve the influence of the bc s but also the accuracy of the numerical solution of problem 1 thus values of d 10 3 are mostly indicative with the meaning undistinguishable from a practical point of view the hierachy of the curves for the various pairs of bc s complies with what could be perceived in fig 5 it is clear in particular that the set of curves for the comparions of bc s among d p p p e p and r p cool bluish colors see fig 4f is always below the set of curves for comparisons of d d with the other bc s warm reddish colors this means that λ obtained with d d strongly departs from the λ s resulting from all other bc s which are in better mutual agreements unsurprisingly the distance d between the predictions increases with the contrast in the conductivities of the components and reaches asymptotes when the contrast is large this convergence is achieved or not in the investigated range of λs λg in the same cases as the convergence of λ in fig 5 furthermore the asymptotic values are clearly in relation with the mean conductivity when the solid is the most conducting phase in fs and bs i e when conduction takes place mostly in the predominant phase and is not strongly impaired by tortuosity as noted in feature c in the above d remains small o 10 3 in fs where λ λ 0 93 and o 10 2 in bs where λ λ 0 77 no significant influence of the bc s is to be feared more concerning values are observed in bs when gas is the conducting phase with d o 10 1 while λ λ 1 3 finally d alarmingly approaches o 1 in all cases where λ λ 1 this anticorrelation of d with λ λ or its correlation with τ as defined in 10 is checked directly by the plots of d τ in the second row of fig 6 this strickingly levels the results the variations of d which span 2 or 3 orders of magnitude when λs λg varies are reduced to a factor 2 for the corresponding curves for d τ recall that the very small values of d should only be regarded as indicative for instance the two very different asymptotes of d on either sides of the curves in fs yield very similar ratios d τ in addition it is expected that the sensitivity to the bc s depends on the sample size since its originates in disturbances near the sample boundaries which gradually decrease deeper in its volume this size has to be measured relative to the characteristic scale of the material texture which we quantify here by the correlation length lc therefore the same data for d are plotted again in the bottom row of fig 6 normalized by τ lc l the shapes of the curves are of course the same as for d τ but this additional normalization shifts them vertically and bring them at similar levels relative to fs and tgf which both have sizes l lc 128 the curves for bs l lc 77 are shifted downwards and those for psm l lc 280 are shifted upwards fig 7 where d l l c is plotted as a function of τ illustrates this in a systematic way the data from all our calculations are presented including all ratios λs λg in fs bs and all the individual realizations of the synthetic media psm and tgf for all the values of their porosities and for all pairs of bc s additionnal data obtained in shi et al 2020 for tomographic images of other anisotropic multiscale materials are also shown this amounts to about 1500 300 data points though many of them overlap and cannot be distinguished in this loglog plot an upper envelope is clearly visible which corresponds to 13a d 5 τ l c l 5 λ λ m i n 1 l c l all the data are below this limit and deviations d which approach this limit are observed for all the media conductivity contrast combinations for some pair of bc s in practice this pair always involves d d the corresponding points reddish colors are all situated in an upper strip between 13a and another line which is an upper envelope for d when comparing the predictions of λ resulting from all bc s except d d 13b d 2 τ l c l 2 λ λ min 1 l c l d d excluded 4 comparison of local fields comparing λ b c 1 and λ b c 2 resulting from different bc s means comparing the fluxes obtained for an identical t from a reversed point of view the temperature fields corresponding to different bc s but identical mean fluxes can be compared to this end the fields obtained when solving problem 1 with unit gradients t have been renormalized by the corresponding diagonal component of λ so that the mean flux component in the direction of t is the same for all bc s two such fields can be meaningfully compared and their difference δ t b c 1 b c 2 is made dimensionless by dividing it by the overall drop δt over the whole sample examples are displayed in fig 8 in a cross section of a psm sample with ϵ 0 08 when λs λg 10 3 large deviations between the fields for d p and p p reaching nearly 10 of δt are observed in a near the inlet and outlet faces as expected since this is where the bc s differ periodicity or dirichlet conversely no difference is observed along the transverse boundaries where the bc s are identical the comparison of d p with e p in b shows a similar pattern at the inlet and outlet faces and also some differences along the transverse boundaries but of a much smaller amplitude exceeding 1 of δt only a few spots in both cases the two compared fields are nearly identical in a broad central region where the darkest blue color corresponds to δ t 10 3 however the comparison of d p with d d in fig 8c as well as the confrontations of d d with p p and e p not shown is quite different instead of an agreement in a central part and deviations near the boundaries δ t follows a linear trend across the whole sample this results from the artefact associated with d d discussed in section 2 6 and illustrated in fig 3d the apparent conducting skin along the transverse boundaries provides an additional path for the heat flux therefore the immersion conditions increase the effective conductivity as noted in section 3 however the overall mean flux is not representative of the flux in the bulk of the sample and consequently after calibration of the t field the mean gradient in the bulk does not correspond to a unit mean flux as a result the good agreements of the fields in the central regions of figs 8a b is replaced by the difference of two different linear trends in order to directly exhibit the conducting skin along the transverse boundaries with d d the local flux field q was recorded in the same case as for fig 8 its component along t is denoted by q and the norm of its transverse component by q their averages q and q were measured over planes parallel at a distance d to the transverse boundaries excluding a 16r thick layer near the inlet and outlet and normalized by the overall averages of q and q these quantities are plotted in fig 9 as functions of the distance d r with bc s d p or p p both averages remain close to unity down to d 0 d p and p p yield the same result since the fields are identical see fig 8a with e p q drops slightly very close to the boundary but q remains close to one and actually nearly identical to that for p p over the whole range of d conversely with d d q sharply increases at distance d 2r and exceeds 10 at d 0 this is due to exchanges across the sample boundaries where t is prescribed and accordingly q strongly increases as well since the data are normalized by the overall volume average the excess flux in the peripheral skin is compensated by q 1 in the bulk of the sample similar evidence of this d d artefact is visible in fig 12 as discussed in section 5 a detailed and more quantitative anaylsis of the t fields differences was conducted by considering the profiles along the direction of t of the rms average δ t 2 the results are shown here only for the comparison of d p vs p p which differ only by the inlet outlet conditions therefore the profiles provide a clear view of the affected regions near the upstream and downstream domain boundaries and of the unaffected central region the latter is blurred in comparisons involving e p and r p because of the differences along the transverse boundaries see fig 8b but if a peripheral layer is filtered out the resulting profiles are similar to those obtained with d p vs p p of course a comparison in these terms of d d with other bc s is meaningless since it only shows the difference in mean gradient visible in fig 8c the profiles of δ t 2 are plotted in fig 10 for all investigated samples the raw data in the left column include all the numerical results in all cases δ t 2 decreases by a factor at least 10 from the boundaries to the central region the various curves for each kind of material are similar but spread over about two orders of magnitude according to the values of ϵ in psm and tgf and λs λg all materials unsurprisingly the lowest curves correspond to moderate conductivity contrasts green curves large contrasts yield larger δ t 2 by a significant factor when the most conducting phase is the most present red curves and by a very large factor when it is the least present blue curves this is most easily seen for fs and bs but the same trend applies in psm and tgf though it is less visible because many curves for different porosities are mixed this is the same hierarchy as for the global indicator d in fig 6 and a rationalization based on the same parameters τ and lc l can be attempted in the middle column of fig 10 δ t 2 is normalized by τ l c l the vertical spread of the profiles is very much reduced spanning a factor of about 2 only for each kind of material the maximal values at the boundaries are all between 1 and 2 except for a few cases with λs λg 1 in fs where it approaches 3 note that this unification involves τ instead of τ in the normalization factor for d in fig 6 and eq 13 another normalization is made in the right column of fig 10 where δ t 2 is simply divided in each case by its value at the boundaries this is even more successful in gathering the various curves mostly because it eliminates the spread of the end values and it demonstrates that all the profiles for each kind of media have the same shape there is a little cheat in the normalized profiles in fig 10 middle and right columns a few cases have been omitted namely λs λg 10 4 ϵ 0 15 for tgf and λs λg 10 4 ϵ 0 08 and λs λg 10 3 ϵ 0 04 for psm atypical profiles are observed in these situations of a small amount of conducting gas in a nearly insulating solid these data are included in fig 11 where the decay of the rms deviation δ t 2 is shown for all kinds of material together as a function of the distance x from the inlet outlet faces normalized by their correlation length lc however another selection has been applied with two families of situations first data for the low porosity fs ϵ 0 069 sample and those for the aforementioned low porosity synthetic media with extreme contrasts red curves second data for bs ϵ 0 232 and most data for the synthetic media excluding those with small porosity or extreme conductivity contrasts i e retaining only the cases where proximity to a percolation threshold is certainly not an issue blue curves the curves for these two families are clearly gathered in two separate groups only a few cases of synthetic media on the fringe between them yield profiles intermediate between the two groups such as psm ϵ 0 08 and tgf ϵ 0 15 with λ s λ g 10 3 green curves which are the examples used in figs 6 8 12 and 13 hence while δ t 2 at x 0 scales approximately as τ l c l its decay length within the material does not only depend on the textural scale lc furthermore from the available data a nearly bimodal behavior seems to emerge with different screening lengths for instance δ t 2 drops at x 16lc by factors about 3 and 10 for the two groups of curves in fig 11 however the parameters and mechanisms which govern the decay are not elucidated the existence of a transition would suggest that the proximity to a percolation threshold plays a role this could result from a particularly strong influence of mismatches of the inlet and outlet faces but also from a change of the relevant microscale in a near critical state it switches from the correlation length lc to the typical size of the conducting clusters also called correlation length in the framework of percolation theory but with a different meaning 5 undersampling measurements in inner subdomains the conductivity tensors associated with central sub blocks of the samples have been systematically evaluated according to the procedure described in section 2 8 a tensor λ bc c m can be deduced via 8 from the set of q c and t c vectors measured in a series of concentric subdomains ω c m obtained by removing from ω a peripheral layer with thickness m when solving problem 1 submitted to boundary conditions bc at ω results are presented in fig 12 for two examples of psm with porosity 0 08 and tgf with porosity 0 12 for λs λg 10 3 a similar figure for fs and bs can be found in shi et al 2020 the porosity ϵ is shown on the left as a function of m for the 4 stochastic realizations and their average its statistical fluctuations increase with m as the volume of the measuring domain decreases but since the samples are large these fluctuations remain quite moderate over the broad range m 160px 0 002 for psm and 0 005 for tgf thus a range with m thick enough to screen most of the influence of the bc s while ω c remains large enough to be representative can exist in these examples the plots of the mean diagonal terms λ c resulting from various overall bc s confirm this expectation middle column in fig 12 the values of λ for m 0 differ by as much as 20 in the psm sample but λ c for d d which departs the most from the other predictions drops very fast so that all predictions are within 5 as soon as m 4lc 2r this is because the measuring volume ω c excludes the conducting skin caused by d d shown in fig 9 this feature does not show in the example for tgf since d d was not implemented for this model but it is clearly visible as well in the similar plots of fig 11 of shi et al 2020 for fs and bs for larger m all predictions λ c converge progressively and reach a very good agreement when m 16lc within about 1 and all distances d 10 2 see fig 13 the differences of the local temperature fields are not entirely screened out at this distance green curves in fig 11 but their absolute values are small δ t 2 2 10 3 for psm and 8 10 3 for tgf in fig 10 all these comments apply both to the data for an individual sample and to the average over samples shown in fig 12 it is worth mentioning here the investigation in alizadeh et al 2017 of the permeability and electrical conductivity corresponding to λs λg 0 of several rock samples based on tomographic images of cylindrical samples the influence of the removal of a transverse peripheral layer was examined and the convergence of the predictions from two different kinds of boundary conditions was demonstrated as for λ c in fig 12 in these materials the influence of the transverse bc which corresponds to the deviations observed near the top and bottom boundaries in fig 8b is felt up to a distance of 3 to 4 pores away from the boundary for the permeability and less than that for the electical conductivity finally the asymmetry index a c of λ c in the right column of fig 12 is seen to increase with m it does not reach alarming levels in the present examples but larger values are observed in cases of larger constrasts and or smaller porosities e g 0 05 for fs in fig 11 of shi et al 2020 recall that λ c differs by at least a c from any acceptable conductivity tensor as discussed in section 2 9 therefore this minimal degree of uncertainty should be kept in mind even if concordant predictions of the effective conductivity are obtained from different upscaling procedures a more complete set of data covering the whole range of contrasts λs λg is presented in fig 13 where the distances d λ b c 1 c λ b c 2 c are plotted as functions of m this accounts more fully for all the differences between tensors including in their individual eigenvalues and eigendirections than the mere comparison of the mean diagonal λ c the figure includes fs and bs and the individual realizations of psm and tgf considered in fig 12 other realizations and their statistical averages give rise to similar features synthetic media with different porosities also present the same patterns although the positions of the transitions can be shifted however we do not intend here to provide a comprehensive survey of the evolution of the distances between conductivity tensors measured in sub volumes which we could not fully rationalize anyway instead our purpose is to illustrate the main phenomenological features to be expected in the practical application of the undersampling approach to a particular sample recall also that values of d 10 3 are mostly indicative as pointed out in section 3 the general features observed in fig 6 for the distances between the overall tensors λ also apply to their values λ c in inner sub domains d increases with the contrast in the component conductivities and tends toward asymptotic values when the contrast is large when the solid is the most conducting phase the pictures obtained for all λs λg 10 are very similar and only those for λs λg 100 are shown for fs and bs the hierarchy of the distances is also preserved distances d for pairs of bc s involving d d reddish curves are always larger than the others for λ and remain so even when the measurement λ c is restricted to inner sub domains there is no clear cut general behavior but the following observations can be made d decreases steeply as the thickness m of the layer discarded for the measurements increases from zero d slowly increases with m when it becomes very large the reason for this is unclear but it is of no concern since d is always small in this range 10 2 consequently there is a minimum for d at some intermediate position the transition between the decaying and growing regimes can be smooth sometimes with the appearence of a plateau or more acute the minimum takes place around m 16lc in bs psm and tgf when the contrast is strong and sooner than that if the contrast is mild it occurs later in fs in keeping with the differences in screening lengths observed in fig 11 fs belongs to the set of slowly decaying red curves while bs and the samples of synthetic media with λs λg 10 3 belong to the sets of steeper blue and green curves respectively in the examples in fig 13 the cases which call for attention because the various determinations of λ depart by distances d of order o 10 1 or more correspond to λ s λ g 10 2 for fs and bs and 10 3 for psm and tgf undersampling is a possible way to try and filter out the influence of the bc s and indeed its application with m 16 l c in all these cases yields tensors λ c which are all in agreement within a reasonable practicle tolerance of d 0 05 and often much less the only exception is fs with λ s λ g 10 4 but the remaining deviations of the order of o 10 1 involve the d d conditions and it disappears if this inadvisable bc is discarded note that fig 13 is incomplete in the sense that it only compares tensors λ bc c from various bc s in the same subdomains not their values in domains of different sizes in order to be an intrinsic effective parameter the tensor should also be invariant over a range of m this is partly checked in fig 12 with the plots of λ c which is indeed found constant within 1 5 in a range 16 m lc 64 for psm and 16 m lc 32 for tgf this is a promising but partial indication to be rigorous both checks for the independence on the bc s and on the domain size have to be made by use of the tensorial distance d for the sake of concision only the former is presented in these terms here all the quantitative statement in the above applies of course only to the particular examples considered in this section and should not be blindly transposed to other materials such as psm or tgf with different porosities or media of an entirely different kind the observed general features are expected to apply qualitatively in any case but not quantitatively when applying the undersampling in any particular sample 6 discussion and conclusions the impact of the choice of boundary conditions on the macroscopic transport coefficient predicted by a numerical upscaling has been systematically investigated for a variety of real or model heterogeneous materials with broad ranges of geometrical properties and conductivity contrasts by considering five kinds of bc s the differences of the various predictions have been quantified by the tensorial distance d note first that when the conductivity contrast is very large its precise value makes ultimately no difference and the macroscopic coefficients are in practice equivalent to those for infinite contrast for instance if the solid tends to be insulating likewise in the opposite limit the tensors λ bc and therefore their differences d converge as 14 λ b c λ g λ b c 1 0 and d λ b c 1 λ b c 2 d λ b c 1 1 0 λ b c 2 1 0 as λ s λ g 0 where λ b c 1 0 is the tensor obtained when λg 1 and λs 0 these convergences are indeed observed but their asymptotic values are not reached yet in some cases in the investigated range of contrast this occurs in situations of strong contrasts with a sparse and or poorly connected conducting phase i e λ λ or τ 1 which are also those where one should be the most concerned about the influence of the boundary conditions and where the numerical calculations are computionally most demanding however the fact that the ratio d τ is nearly independent of the contrast middle row in fig 6 is a new piece of information and advantage can be taken from it to infer the expected uncertainty for a strong contrast from its knowledge for a milder one the additional feature that the bc s effects scale as the inverse of the sample size and the corresponding normalization of d by lc l contributes to unify even more the data and leads to the representation of the whole set of numerical results in fig 7 for any particular sample the values of d for various pairs of bc s measure the difference of the corresponding predictions of λ some pairs such as p p e p are always in a better agreement than others but the largest d can be considered as an estimate of the intrinsic uncertainty of the determination of λ since at least two results differ by that much thus only the upper envelope of the data is to be considered it is fairly well described by 13 where the uncertainty is simply proportionnal to τlc l the observation 13 is probably the most important result in this paper it provides a practical a priori criterion to estimate an upper bound of the relative uncertainty of a tensor obtained by numerical upscaling when the data required for the solution of problem 1 are available lc and λ are readily available as well when a calculation with some bc yields a tensor λ τ can be estimated and 13 tells by how much tensors resulting from other bc s could differ from λ recall that d is the value that the relative error of the flux can reach when λ is used in simulations see section 2 9 there are actually two envelopes in fig 7 and two estimates of the uncertainty in 13 according to whether the immersion conditions d d should be considered or not this question is raised by the a priori suspicion that d d introduces by itself spurious effects discussed in section 2 6 and by the observation that indeed it often yields predictions notably different larger from those from other bc s the reservations about d d are supported by the analysis of local fields their comparison for different bc s in section 4 reveals various phenomenological features is is observed that the rms deviations of the local fields scale as τ and that their magnitude decays within the samples over a screening distance which is not simply proportional to the textural length lc a nearly bimodal behavior seems to emerge with different screening lengths according to whether or not the material is close to a critical state regarding conduction the latter feature is not understood and might deserve further investigation however it is made unambiguously apparent that d d causes the appearance of an excess flux in a peripheral skin along the transverse boundaries which explains the larger predicted macroscopic conductivity hence we advocate that using the d d immersion condition is inadvisable because it introduces by itself strong artefacts it induces thereby large values of the distance d from the predictions with other bc s but mostly due to its own identified sources of error recall also that the permeameter conditions or the periodization of the sample by justaposition of mirrored replicas have not been considered here because they are known to constrain the eigendirections of λ rotating them would induces large values of d if the medium is not very close to isotropic if such approaches as well as d d are set aside 13b applies in summary 13 provides a criterion for the a priori detections of situations that might be problematic in practical applications once a numerical upscaling has been performed τlc l is readily available and if it is too large it is very likely that a solution of 1 with another bc would yield a significantly different result recall that a noticeable asymmetry is also a worrying feature since the index a is a lower bound for the distance of λ from any acceptable value see section 2 9 in case of doubts appropriate measures should then be taken the first step could be to try different bc s and check whether the result is really impacted if it is the next step might be to consider ways to filter out the bc s influence by excluding the potentially disturbed region from the measurement volume to this end we recommend the undersampling procedure described in section 2 8 and illustrated in section 5 for various examples it should be emphasized that it is virtually cost free once problem 1 has been solved with any kind of bc measuring the mean flux q c and gradient t c in a series of inner sub domains does not require any significant additional computational effort the conductivity tensors λ bc c resulting from various bc s should be compared hopefully λ bc c can be found identical for all bc s and in a wide enough range of sub domains sizes within a user defined tolerance for d this tensor can be then regarded as an intrinsic effective property associated with and only with the material under consideration this requires that the sample is large enough so that a peripheral layer can be discarded from the measurement volume sufficiently thick to screen out most of the bc s influence while the remaining volume is still large enough to be representative if this is not possible it must be accepted that no reliable estimate of an effective conductivity tensor can be obtained from this sample credit authorship contribution statement jean françois thovert conceptualization methodology formal analysis writing original draft visualization supervision valeri v mourzenko software formal analysis declaration of competing interest the authors declare that they have no known competing financialinterestsor personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work pertains to the french government programme investissements d avenir labex interactifs reference anr 11 labx 0017 01 
483,sensitivity to the boundary conditions bc s when determining macroscopic transport coefficients by numerical upscaling in finite domains is a well known methodological issue explored here with the purpose of quantifying the influence of the bc s in relation with the parameters of the system porosity characteristic length scale conductivity contrast assessing the level of confidence associated with the predictions devising criteria to anticipate the risk of serious artifacts and proposing ways to limit them the terminology of thermal transfer is used but the developments apply to any transport mechanism governed by a diffusion equation including conduction mass diffusion or darcy flow quantitative indicators are defined for a rigorous individual or comparative assessment of conductivity tensors and used in the analysis of extensive numerical data obtained in tomographic images and model materials with a broad range of properties practical criteria are proposed for the a priori and a posteriori detection of at risk situations and a self diagnosing protocol is proposed to screen out the bc s influence whenever possible keywords numerical upscaling conductivity permeability boundary condition tomography undersampling 1 introduction sensitivity to boundary conditions bc s is a well known issue when determining macroscopic transport coefficients by numerical upscaling i e by solving governing equations in a finite domain where the required fields of the local properties are provided either for instance by x ray tomographic imaging for core scale samples shi et al 2020 or from geophysical characterization techniques on the field scale hubbard and rubin 2000 in the first case with a full knowledge of the microscopic geometry the upscaling of stokes flow equations for the determination of a permeability tensor can be addressed stokes darcy as well as any conduction or diffusion transport processus in the latter case the data are provided on a coarser scale where the flow properties are already described by a mesoscale permeability coefficient and the secondary upscaling aims to determine a permeability tensor of the same nature but on a larger scale we focus in this work on steady state conduction like processes governed by fourier ohm fick or darcy laws which are mathematically equivalent a heat transfer terminology is used but the word conductivity can be understood throughout this paper as thermal electric hydraulic or mass diffusivity with temperature t replaced by potential pressure or concentration see section 2 3 the same question was addressed in the recent contribution shi et al 2020 where four tomographic images of materials of various natures were used for a thorough assessment of the bc s influence the present paper proceeds along the same lines and also considers synthetic media which makes a systematic investigation of geometrical parameters possible and allows to formulate the phenomenological observations of shi et al 2020 in a more general and quantitative way in order to be reasonably self contained many definitions of mathematical and conceptual tools are repeated here but some elements are skipped for concision complementary bibliographical elements phenomenological discussion and additional technical details can be found in shi et al 2020 various procedures based on different kinds of boundary conditions have been used since the earliest days of numerical upscaling of heterogeneous system properties on the field scale long et al 1982 or on the core scale based on tomographic digital images spanne et al 1994 and the differences in the results of different approaches was often pointed out the brief following review focuses on contributions which present systematic comparisons and or address theoretical aspects of the issue the general review renard and de marsily 1997 of theoretical aspects of the upscaling techniques for darcy flow in heterogeneneous media surveys various protocols and stresses the sensitivity of the resulting block permeability to the bc s darcy flow upscaling procedures are also extensively reviewed in durlofsky 2005 including the aspects associated with bc s and post treatments periodicity permeameter and immersion conditions see section 2 5 as well as others involving the introduction of border regions see below and section 2 8 are surveyed and their relative merits and shortcomings are discussed more recently various bc s have been tested in andrä et al 2013 for the evaluation of the electrical conductivity of rock samples from tomographic images it was stressed again that the choice of bc s is important but no conclusion or advice was put forward the undersampling and oversampling approaches proceed from the same idea in the search of an intrinsic value of an effective conductivity in the former the sampling domain is reduced by excluding from the measurements a peripheral layer so that boundary effects are minimized the procedure described in section 2 8 proceeds along these lines it was applied in lang et al 2014 but without quantification of the difference it makes or investigation of the requirements for the removed layer thickness the oversampling approach follows the opposite way by using an enlarged sampling block so that the conductivity measured in the domain of interest is not polluted by the boundary effects confined in the peripheral region the r p boundary conditions described in section 2 5 is an application of this approach the term oversampling is due to wu et al 2002 but the method was introduced earlier gomez hermindez and journel 1990 and used under different names by others such as wen et al 2003 it requires a knowledge of what surrounds the investigated domain which can be available in the situations addressed in wu et al 2002 gomez hermindez and journel 1990 wen et al 2003 where the aim is the coarsening of a detailed large scale permeability field but not when operating with a tomographic image let us mention for completeness important contributions about the upscaling of the microscale stokes equations for flows in porous media which is a mathematically different problem but just as sensitive to the prescibed boundary conditions the classical bc s are of the same type as those for conduction problems combining periodicity dirichlet and neumann conditions several of them resulting in significantly different predictions are implemented in piller et al 2009 where the undersampling procedure is also used for the identification of a region nearly unaffected by the bc s systematic investigations where many kinds of bc s have been applied and compared have also been conducted in guibert et al 2016 gerke et al 2019 including an effective medium approach similar to e p in the following see section 2 5 thus a corpus of knowledge exists in the literature but unfortunately it consists in many disparate comparisons of approaches in particular cases and whereas the influence of the choice of a procedure and bc s is always pointed out the differences between predictions are often presented in an illustrative and or qualitative way even the most systematic studies provide general observations and mention some pitfalls but rarely come up with practical recommendations thus someone in search for practical advices for an application is at a loss to find explicit guidance of course at least in the case of tomographic sample images there is no right answer since what lies beyond the sample boundaries is unknown if two methods yield different results it generally cannot be claimed that one of them is right although it can sometimes be detected that one or both of them is wrong with a quantitative estimate of just how wrong it has to be therefore our work was conducted with several objectives in mind contribute to the knowledge base by a systematic examination of a variety of materials with quantification of the influence of the boundary conditions in relation with the parameters of the system volume fractions characteristic length scale of the microstructure contrast of the local conductivities provide quantitative tools for the assessment of the expected level of confidence associated with predictions and if possible propose self diagnosing procedures identify criteria possibly just rules of thumb a priori or a posteriori for the detection of the risk situations where serious artifacts can be expected and particular caution is required fullfilling this involves extensive numerical calculations but also the definition of quantitative indicators for a rigorous analysis of the results the work was initiated in shi et al 2020 by treating tomographic images of several kinds of real materials phenomenological knowledge was gained from this collection of particular cases quantitative assessments have been conducted for each of them and general trends identified in the present study synthetic numerically generated media are used to explore systematically a wider range of morphological parameters and more general quantitative criteria are obtained the paper is organised as follows section 2 starts with a description of the context and of the investigated samples which include tomographic images of real materials and synthetic numerically generated model media the mathematical problem to be solved is then stated and a brief description of the numerical solver is provided the set of bc s considered in the study is introduced and some of their expected artefacts are commented the procedure to obtain the full effective conductivity tensor is described from the whole sample or from measurements in inner sub domains undersampling finally some rigorous quantification tools for the comparative analysis of the results are introduced the results are presented in sections 3 5 starting with global indicators such as the mean conductivities and especially the distances between tensors resulting from different bc s then qualitative comparisons of the local fields are presented in section 4 which provide a phenomenological picture of the effects of the boundary conditions and a quantitative analysis of their differences is conducted finally the undersampling approach is illustrated in section 5 by applications to several examples a discussion in section 6 concludes the paper 2 context and methods 2 1 context the initial motivation for this study stemmed from a practical thermal problem which explains that when we decided to investigate with some rigour the issue of the bc s influence in finite domains for the possible benefit of a wide community of colleagues facing the same difficulties we kept the thermal terminology and refer to solid and gas phases with conductivities λs and λg however this bears no particular meaning since the following developments apply for any mixture of two components with different conductivities in particular when considering darcy flow in heterogenous media what is called here gas and solid can actually correspond to regions with different permeabilities furthermore the ratio λs λg can range from very large in thermal applications to very small if λ stands for mass diffusivity or electrical conductivity in a brine saturated porous medium where the solid phase is nearly if microporous or totally impervious for this reason a broad range of conductivity contrasts with 10 4 λ s λ g 104 was explored in the materials presented below see table 2 only binary media are considered containing two phases with constant isotropic conductivities media with continuous variations of the local conductivity could be treated in the same way some of the effects would probably be milder but the general trends are not expected to differ and the methods and quantification tools presented in the following would retain their interest 2 2 investigated materials tomographic images of real materials and synthetic model media have been investigated in all cases the geometry is described by a phase function z defined in a lx ly lz array of cubic p x 3 voxels equal to 1 in the pores and to 0 in the solid two of its statistical moments are of a foremost interest the first one is the porosity ϵ which is the volume average z the second one is the spatial correlation function rz u covar z x z x u var z the integral correlation length l c 0 r z u d u per direction if rz is anisotropic provides a length scale associated with the microstructure when rz u happens to decay exponentially this lc is also equal to the decay length note that the samples considered here are all cubic i e l x l y l z l the tomographic images are rock samples already examined in earlier works namely a fontainebleau sandstone fs with porosity 0 0692 fully characterized in thovert et al 2001 fig 1 a and a bentheim sandstone bs with porosity 0 232 studied in thovert and adler 2011 fig 1b in both cases the correlation function is isotropic and exponentially decaying their characteristics are given in table 1 these two samples were already considered in shi et al 2020 and they are kept here for comparison purposes with the synthetic media the other two samples of shi et al 2020 were of a different nature namely thermally degraded polymer based composites they were interesting because they are multiscale and anisotropic but they are not considered here for the sake of concision and because of their smaller sizes two kinds of model media have been systematically investigated in the penetrable sphere model psm thovert et al 2001 thovert and adler 2011 solid spheres with radius r are inserted with a density ρ at random positions in the 128 r 3 unit cell of a periodic medium fig 1c the pore space which remains uncovered has a volume fraction ϵ z e 4 3 π r 3 ρ the percolation threshold ϵ c of such media is about 0 034 a set of porosities above ϵ c has been investigated with 10 values of ϵ ranging from 0 04 to 0 30 see table 2 the spatial correlation is given by eq 16 in thovert et al 2001 and the correlation length lc is about r 2 from lc 0 4 r when ϵ 0 04 to lc 0 6 r when ϵ 0 30 thus the sample size 128 r 3 roughly corresponds to 256 lc 3 in the thresholded gaussian field tgf model adler et al 1990 adler 1992 a discrete field z with prescribed mean z ϵ and spatial correlation function rz is obtained by the following steps first generate a random uncorrelated gaussian field x convolve it in fourier space with a kernel derived from the target correlation function rz to obtain a correlated gaussian field y finally set the phase function z equal to 1 where y exceeds a threshold that depends on the target porosity here the correlation was taken isotropic and exponentially decaying according to r z u e u l c and samples of size 128 lc 3 were generated fig 1d the percolation threshold ϵ c of such media is in the interval 0 08 0 09 porosities from this range up to 0 25 have been investigated see table 2 the reconstructed samples are periodic for both psm and tgf the spatial resolution voxel size was set to p x l c 4 tgf or r 4 psm so that z is stored in a 512 3 array in order to obtain aperiodic samples comparable to tomographic images of real media a peripheral layer of thickness 2lc or 2r is removed from the generated samples which results in 124 lc 3 for tgf or 124 r 3 for psm computation domains these reduced domains are called ω whereas the larger initially generated domains are called ω 2 3 local and upscaled formulations stationary thermal conduction in a heterogeneous medium with position dependent thermal conductivity λ is governed on the local scale by fourier s law and a conservation equation 1 q λ t q 0 where q is the heat flux and t is the temperature if the medium statististical properties are spatially uniform it can be regarded on a larger scale as an equivalent homogeneous material with effective properties and in particular with an effective conductivity λ which relates the locally averaged flux and gradient 2 q λ t q 0 even though the local conductivity is assumed to be isotropic the medium structure can be anisotropic and therefore the effective coefficient λ is in general tensorial if the medium is not strictly homogeneous 2 still applies with a position dependent λ if its characteristics are slowly varying i e on a regional scale much larger than the microscale of the λ fluctuations then an intermediate scale the so called representative elementary volume rev smaller than the former and larger than the latter can exist upon which volume averages of the flux and gradient can be taken note that the rev is often defined only as the minimal averaging volume required to damp porosity fluctuations whereas we are talking here of the averaging volume necessary for a robust estimation of a transport coefficient very often this is a more stringent criterion for instance close to a percolation threshold when the conductivity contrast is strong but as illustrated in section 5 it can also be a milder criterion in the case of a moderate conductivity contrast the upscaling from 1 to 2 reduces of course tremendeously the computational effort required for simulations on the field scale since much coarser volume elements with effective properties can be used the theoretical background for the homogenization process is classical and not detailed here see e g adler 1992 quintard and whitaker 1993 bourgeat et al 1988 let us just mention that λ is a symmetric positive tensor this applies to any diffusion like process governed by mathematically equivalent equations such as mass diffusion of electrical conduction furthermore whereas creeping fluid flow through a porous medium is governed locally by stokes equations a first upscaling step can reduce the flow problem into a homogenized form similar to 1 involving darcy s law 3 v 1 μ k p v 0 where v is the seepage velocity p is the pressure μ is the fluid viscosity and k is a permeability coefficient this formulation applies on a scale much larger than the medium microstructure but the medium can be heretogeneous on a still larger scale which makes k position dependent in this case a second upscaling can be performed to obtain a counterpart of 2 involving an effective permeability tensor k 2 4 solution of the local problem the problem governed by 1 is solved in the domain ω or ω subject to various conditions on its boundary ω or ω which are detailed in the next section 2 5 the solver is a distant descendant of that presented in henriette et al 1989 where the formulation is described in full details equations 1 are discretized in a finite volume formulation according to the so called box integration method t is determined at the vertices of cubic volume elements the resulting set of linear equations a t b is solved by a conjugate gradient method iterations are stopped when the global relative residue a t b becomes smaller than 10 6 b this criterion for the global residue translates into a o 10 4 relative accuracy for the components of the predicted mean flux and to at most 10 3 for pointwise temperature relative to the overall temperature drop note that this is much more demanding than the stopping criterion for routine applications where 10 4 is regarded as sufficient this much finer and numerically much costlier accuracy is required for a reliable comparison of the solutions for different bc s the computation time depends of course on the sample size but also strongly on the conductivity contrast for the record the determination of a conductivity tensor 3 solutions for different mean gradient directions in fs takes 10 20h when λ s λ g 10 1 and 100h when λ s λ g 10 4 single core 3 4ghz xeon cpu time of course the computations were run in parallel over multiple cores since e p is an iterative procedure in an enlarged domain some calculations took up to 800h in routine applications the stated cpu times should be divided by about 10 resp o 102 if an accuracy of 0 1 resp 1 for the global conductivity tensor is regarded as sufficient the volume averages q and t of the flux and gradient in ω are actually evaluated by the surface integrals 4 q 1 ω ω q x n x d s t 1 ω ω t n d s where n is the unit outwards vector normal to ω 2 5 investigated boundary conditions a natural way to set the overall bc s for the solution of problem 1 in a finite sample ω without knowledge of what lies beyond its boundaries ω is to mimic real or virtual experimental settings as illustrated in fig 2 permeameter conditions named after a common apparatus for permeability measurements correspond to the situation where the sample is placed between two isopotential chambers dirichlet conditions and enclosed transversally in an impervious jacket obviously the no flux condition through the transverse boundaries constrains the flux directionally and makes this approach inappropriate for the determination of the full tensors λ or k in anisotropic media therefore in spite of their frequent use permeameter conditions have not been included in the set of investigated bc s listed below d p the disturbing impervious walls of the permeameter can be removed in a virtual experiment where the single jacketed sample is replaced by a layer of juxtaposed replicas exposed to the same upstream and downstream dirichlet conditions we call the corresponding bc s d p standing for dirichlet and periodic in the axial and transverse directions respectively for instance for a calculation along the x direction 5a t x 0 g l x t x l x 0 5b q 2 q 1 t 2 t 1 at homologous points x 1 x 2 on opposite transverse faces of ω p p in another virtual experiment the entire space can be covered by such identical replicas periodicity of fluxes and temperature gradient can be applied along all directions regardless of a geometrical mismatch at opposite faces of the sample if g is a prescribed macroscopic temperature gradient 6 q 2 q 1 t 2 t 1 g x 2 x 1 at homologous points x 1 x 2 on any opposite faces of ω e p one may consider that the sample ω perceives its surroundings as a homogeneous material with the same effective conductivity to be determined submitted to far field conditions in the form of a prescribed macroscopic gradient a sheath of homogeneous material tentatively screens out most of the influence of the outer bc s and the enlarged domain ω can be treated as periodic since there is no geometrical mismatches at its boundaries thus problem 1 is solved in ω with the periodicity conditions 6 applied on ω we call this e p for encased and periodic integrations 4 to obtain the mean flux and gradient are restricted to ω the embedding medium is given a conductivity λ e possibly anisotropic equal to that obtained in ω since the latter is not known beforehand this is an iterative process a reasonable guess for λ e is used first which is updated after successive resolutions until convergence the layer added on the six faces of the samples was 16 voxels thick for the tomographic images 2lc for tgf and 2r for psm it has been checked that this is sufficient to make the results nearly independent of the layer thickness both for the global parameters and for the local deviations in ω by comparison with systematic data for the tomographies with a thickness of 8 voxels and selected cases for the synthetic media e g with 4lc and 8lc for tgf it is worth noting that although the idea of a self consistent effective medium scheme is very common in theoretical models for the conductivity of composites such as those of bruggeman 1935 or landauer 1978 it seems that its numerical counterpart has not been implemented in earlier works for the upscaling of conduction properties but it is in guibert et al 2016 gerke et al 2019 for the upscaling of the stokes flow equations and in knackstedt et al 2006 to compute the elastic properties of low density materials d d in a somewhat far fetched approximation one may assume that the far field conditions of e p apply down to ω in these so called immersion conditions denoted d d dirichlet conditions are imposed on the entire boundary ω of the domain corresponding to a prescribed mean gradient with 7 t x g x on ω within an arbitrary additive constant in practice with g along one of the axes of coordinates this results in dirichlet conditions 5a on inlet outlet faces and linear profiles along the transverse faces note that a counterpart of d d was considered in pouya and fouché 2009 where the normal flux instead of t is prescribed on the boundaries with q x n b n on ω where b is a prescribed vector which correspond to q as shown by 4 r p the last kind of bc s considered here is a special case applicable only to synthetic media and introduced only for comparison purposes recall that periodic psm and tgf samples ω with sizes 128 lc 3 or 128 r 3 are generated first which are subsequently reduced by removal of a peripheral layer to obtain aperiodic domains ω similar to tomographic images see section 2 2 however problem 1 can also be solved in ω with periodicity conditions as done in e p again integrations 4 to obtain the mean flux and gradient are restricted to ω this is akin to the oversampling method wu et al 2002 gomez hermindez and journel 1990 wen et al 2003 where the properties of a sample are determined by solving the flow problem in an wider domain when the required data are available e g when determining the properties of a block extracted from whole field data it is also possible for our numerically generated samples and provides a reference solution hence the name r p note however that ω is supposedly the only data available the larger ω is a periodic continuation of ω but not the unique possible one and therefore reference does not mean right or unique extensive references are provided in shi et al 2020 for many applications in the literature of the various bc s mentioned in the above and of some others in particular the computation domain is sometimes made periodic by juxtaposing mirrored images of ω this approach was not considered here because as the permeameter conditions it introduces directional constraints and the eigen directions of λ or k can only be found aligned with the artificial planes of symmetry as demonstrated for instance in guibert et al 2016 gerke et al 2019 2 6 artefacts associated with the boundary conditions with the exception of p p applied to periodic media which generally means model media all the conditions listed in section 2 5 present some undesirable features consider for illustration purposes the most severe situations where only the pore phase is conducting λs 0 milder but similar effects are expected for moderate contrasts periodicity p p imposes that the fluxes on opposite faces are equal but since the phase arrangements in these faces do not match in aperiodic media the flux has to cross a plane with a much reduced open fraction equal to ϵ2 in the average fig 3 a this introduces a skin resistance and the overall conductivity is underestimated with dirichlet conditions d p flux can enter any pore showing on the inlet face of ω although some of them are actually dead ends and would receive no flux from the actual upstream material fig 3b the overall conductivity is overestimated with the pressure condition 7 of d d flux can leave or enter any pore showing on a lateral face of ω as if some continuous conducting material lay beyond ω this creates long range connections all along the lateral faces fig 3c which can behave as an apparent lateral conducting skin the overall conductivity is overestimated these effects of d d are also illustrated in guibert et al 2016 gerke et al 2019 in the context of fluid flow governed by stokes equations note that the artefacts associated with p p and d p are local features they affect the transfers through a surface which the flux has to cross if t or might cross if t conversely the artefact introduced by d d has long range effects generally with stronger impact on the predicted conductivity as indeed observed in the following in a caricatured situation it would yield non zero flux and effective conductivity if ω were entirely filled with insulating material except for small unconnected conducting parts located at its corners 2 7 determination of a full tensor λ equations 1 are solved subject to one of the bc s listed in section 2 7 say bc with the vector g set successively along the x y and z directions in each case the mean flux q ξ and gradient t ξ ξ x y or z are evaluated by means of 4 note that t in ω is equal to g in the cases of d p p p and d d however when g is applied on the boundaries of the enlarged domain ω for conditions e p and r p the mean gradient in ω can be different and has to be calculated from the temperature field by application of 4 then the following set of 9 linear equations is solved to determine the 9 components of λ bc 8 q ξ λ b c t ξ ξ x y and z with conditions p p d d e p and r p the solutions obtained with different vectors g can be superposed in view of the linearity of the governing equations therefore the solution for any g can be obtained by a linear combination of the solutions with g set along the three axes and λ bc determined by 8 can be used to predict the mean flux resulting from any mean gradient conversely the solutions obtained with d p applied along x y and z cannot be superposed thus the derivation of λ d p is only formal and 8 applies only for g set along x y or z anyway it is difficult to conceive a numerical experiment where conditions of the type d p would be imposed along a direction oblique relative to a parallelepipedic sample note that the same observations apply as well to the permeameter conditions where transverse periodicity is replaced by a no flux condition however this does not preclude λ d p from bearing information about the sample conductive properties the effective tensor λ should be symmetric and λ p p obtained by 8 with periodicity conditions p p is indeed symmetric the demonstration relies on a reciprocal theorem see e g adler 1992 the same line of reasoning shows that λ d d is also symmetric pouya and fouché 2009 however λ d p λ e p and λ r p are not necessarily symmetric even though periodicity conditions are applied on ω in the cases of e p and r p symmetry would be ensured with e p and r p only if the averages used in 8 were evaluated over ω instead of ω asymmetric tensors are defective and two techniques are widely used to put up with situations where the upscaling procedure yields an asymmetric result the simplest is to make the tensor symmetric by averaging it with its transpose 9 λ s y m λ b c λ b c t 2 another approach is to supplement 8 with additional equations stating the symmetry of λ bc the system becomes overdetermined and it has to be solved in some least square sense generally some residual asymmetry remains which can be eliminated with 9 durlofsky 2005 such expedients are necessary for the practical use of λ in simulation models but no such step was taken in the present investigation the purpose is not to cure the asymmetry of λ bc but to quantify it and explore the circumstances of its occurence 2 8 undersampling the fundamental idea underlying the application of upscaled models is the belief that an effective coefficient λ exists which relates the locally averaged flux and gradient regardless of the circumstances i e far field conditions which induce t at the position where 2 is applied this has been theoretically established in auriault 2011 by considering an rev deep within a macroscopic domain v under the assumption that the macroscale and the rev scale are widely separated however whether this requirement is fulfilled in practice in a given sample has to be checked directly as well as the screening distance and whether an rev remains when the corresponding layer is discarded on this premise it can be attempted to determine this value of λ by focusing on some inner subdomain ω c in ω if the tensor λ c obtained by 8 with the mean fluxes and gradients given by the integrals 4 applied to ω c is found independent of the conditions applied at ω this λ fulfills the aforementioned requirement for its use in upscaled models this methodology has been applied in lang et al 2014 for conduction processes and in piller et al 2009 for fluid flow we have applied this approach with subdomains ω c m obtained by removing from ω a peripheral layer with thickness m the conductivity tensor of ω c obtained from the solution of 1 with conditions bc at ω is denoted λ bc c m obviously a thick enough margin m not too small is required to screen out the influence of the outer conditions on the other hand the subvolume ω c has to be sufficient m not too large to remain representative i e to prevent the occurence of large statistical fluctuations if the whole sample ω is large enough an intermediate range for m can exist where both of these criteria are fulfilled this means that over this interval λ bc c m should be independent of bc first criterion and m second criterion i e the effective tensor λ for the investigated material of course the term independent has to be understood within some practical tolerance and a quantitative indicator is required to measure the difference between two tensors such an indicator is defined in section 2 9 2 9 notations and quantification tools a few notations and definitions are introduced here which are used in the subsequent discussions first the mean λ of the diagonal terms of a tensor λ the anisotropy index n the arithmetic and harmonic volume averages of the local conductivities λ and λ h and the index τ are defined by 10 λ 1 3 i λ i i n λ m a x λ m i n λ 1 ω ω λ d v λ h 1 1 ω ω λ 1 d v τ λ λ m i n 1 where λmax and λmin are the largest and smallest eigenvalues of λ λ and λ h are the fully general upper and lower wiener s bounds in addition hashin shtrikman s upper and lower bounds hashin and shtrikman 1963 are denoted by λ h s u and λ h s l both sets of bounds only depend on the phase conductivities and volume fractions but the tighter hashin shtrikman s bounds apply only to isotropic media the index τ discriminates situations where the volume containing the most conducting phase is well connected λ o λ τ 1 or tortuous and or poorly connected λ λ τ 1 for the nearly isotropic media considered here λmin in the definition of τ is close to λ but it is very different for some anisotropic materials considered in shi et al 2020 a distance is introduced to quantify the difference between two tensors say λ 1 and λ 2 resulting for instance from different upscaling protocols in response to a same unit gradient g these tensors predict fluxes q i λ i g the squared norm of their deviation q 2 q 1 2 is equal to g t λ 2 λ 1 t λ 2 λ 1 g it is maximum when g is aligned with the eigendirection of λ 2 λ 1 t λ 2 λ 1 associated with its largest eigenvalue therefore we measure the difference of λ 1 and λ 2 by the distance d and the normalized dimensionless quantity d defined by 11 d 2 λ 1 λ 2 largest eigenvalue of λ 2 λ 1 t λ 2 λ 1 d d λ 1 λ 2 1 2 d λ 1 λ 2 is the maximal relative deviation combining magnitude and direction differences of the fluxes predicted by λ 1 and λ 2 when applied to the same gradient note that the λ i s do not need to be symmetric in the definition 11 and that d is a distance in the mathematical sense i e a symmetric positive definite function satisfying the triangle inequality although d is used in other contexts to measure the difference between matrices to monitor the convergence of iterative numerical schemes ralston and rabinowitz 2001 we are not aware of its use for the comparison of tensorial transport coefficients prior to shi et al 2020 another quantity of interest is the asymmetry index a and its normalized dimensionless counterpart a 12 a 2 λ 1 i j 3 λ i j λ j i 2 2 a λ a λ λ this indicator has an interesting relation with d namely that if λ 2 λ 1 is antisymmetric then d λ 1 λ 2 a λ 2 λ 1 this implies that if a tensor λ bc resulting from an upscaling procedure is not symmetric it differs from λ sym obtained by the symmetrization 9 by d λ b c λ s y m a λ b c and by at least that much from any possible acceptable and therefore symmetric conductivity tensor furthermore this is only a lower bound for the error for instance say λ bc differs from an exact value λ i by a gaussian noise with standard deviation σλ for all its components then a λ b c 0 33σ and d λ b c λ i 4 9 a averages over 108 monte carlo realizations hence even a moderate asymmetry by a few percent should be considered with attention instead of carelessly eliminating it with 9 since it can point at a quite significant uncertainty in the tensor determination 2 10 notes about the influence of the spatial resolution the discrete representation of a medium and the predicted fluxes and therefore conductivity tensor obtained when solving 1 obviously depend on the spatial resolution and possibly on preliminary treatments of the primary tomographic or geophysical data in particular singular contacts can be overlooked or near contacts can be interpreted as actual contacts with significant impact when the property contrast is large whatever the bc s these effects have been examined in details in guibert et al 2015 guan et al 2019 however while singular contacts or lack of make a difference for the fields in a region around them they do not affect the thickness of the peripheral layer where the kind of bc s is felt unless the property contrast is extreme and a very coarse resolution prevents the conducting phase from percolating but then sensitivity to the bc s becomes a secondary issue sensitivity to spatial resolution and to the boundary conditions both contribute to the uncertainty of the conductivity prediction but they are different and mostly independent matters we focus in the present work on the latter which remains even if the resolution is excellent and on the way to get the best out of an available digital image if need be the proposed procedures can be applied to variants of the image resulting from different pre treatments furthermore the trends and general observations mentioned in the following regarding the differences between predictions from different bc s are not expected to depend on resolution this is supported by the similarity of the observations for the present samples whose resolution quantified by the ratio lc px ranges from 1 6 to 6 5 see table 1 and by a direct comparison for model media not reported here for instance identical 64 r 3 psm samples have been discretized with r 4 6 and 8px the responses to different bc s differ in the same way in all cases over the whole range of porosity and conductivity contrast 2 11 summary of the investigated cases the combinations of porosities conductivity contrast and boundary conditions considered for the various kinds of samples are summarized in table 2 twenty four values of λs λg ranging from 10 4 to 104 have been used in fs and bs for all bc s described in section 2 5 except r p by lack of data in the surroundings of the samples note however that the undersampling technique is a way to reach the same objective several values of the porosities have been considered in the model media up to 0 25 tgf and 0 30 psm since the results for fs and bs show that nothing dramatic occurs when the most conducting phase is also the most present the range of contrast was reduced in the model media with 10 4 λ s λ g 10 1 i e the cases when the least present phase pores is the most conducting all bc s but d d have been applied in tgf and all but e p in psm except for the cases indicated in table 2 where the 5 kinds bc s were imposed four stochastic realizations have been treated in each case for the model media unless otherwise stated the results presented in the following are averages over the four samples these averages are arithmetic for quantities such as λ and quadratic rms when deviations such as d or δ t in section 4 are considered 3 results for global indicators we consider here global indicators i e quantities which can be deduced from the tensors λ obtained by solving problem 1 subject to with the various bc s without scrutinizing the local fields the simplest one is the mean conductivity λ which is plotted as a function of λs λg in fig 5 for fs bs and examples of psm and tgf with porosities 0 08 and 0 12 and for all investigated bc s the graphic conventions for this figure and subsequent ones are explicited in fig 4 λ is normalized by λ for an easier comparison of results with very different orders of magnitude when the phase conductivities vary note that the ratio λ λ can be viewed as a tortuosity factor since it approaches one when most heat flow takes place along straight streamlines in the most conducting phase the samples are actually slightly anisotropic the anisotropy index n see eq 10 can reach about 1 2 in fs and in individual realizations of psm with large contrasts and small porosities 1 16 in bs and 1 08 in psm but plots of λmin and λmax look very similar to fig 5 several general features stand out whatever the bc s a when the conductivity contrast is very large one expects that one of the phases ultimately plays a negligible role and that an infinite ratio or some very large finite value makes vanishing difference this is observed in many cases with established asymptotical values beyond 10 3 but λ λ is still decaying when λ s λ g 10 4 in some others it has been checked that the gas space is percolating in all these cases which implies that some non zero asymptotic value exists when λs λg 0 but convergence is not reached in the investigated range note that the slow convergences occur when λ λ is small i e when τ 1 b for comparison wiener s lower bound λ h and hashin shtrikman s bounds λ h s l and λ h s u are also shown in fig 5 wiener s upper bound corresponds to unity of course all these bounds provide reasonable estimates for small contrasts but they grossly deviate from the numerical data for λs λg beyond 10 1 note that the eigenvalues of λ sometimes slightly exceed the hashin shtrikman s bounds this is not aberrant since hashin shtrikman s bounds apply to isotropic media and do not constrain λ max and λ min in anisotropic ones c solid is largely predominant in fs and bs therefore when it is the most conducting phase tortuosity is minimal and λ is not much smaller than λ in the opposite case of λs λg λ λ 1 20 fs or 1 3 bs d even though ϵ 0 12 for the example of tgf is larger that the porosity in fs 0 069 or in the example of psm 0 08 its ratio λ λ is smaller when solid becomes nearly insulating this results from a poor connectivity of the pore space 0 12 is not much larger than the percolation threshold ϵ c 0 09 of tgf while 0 08 is more than twice ϵ c 0 034 for psm similar and more dramatic illustrations of the influence of the morphology can be found in shi et al 2020 in foam like media where porosity is large but the pores consist in poorly connected inclusions the volume fraction and connectivity issues mentioned in c d are expected to influence the impact of the bc s on the determination of λ when the most conducting phase is predominant and well connected artefacts such as those illustrated in fig 3 a b are expected to be minimized conversely strong effects are probable when a poorly connected phase with low volume fraction is the most conducting the comparison of the data in fig 5 confirms these expectations the relative deviations between the predictions from various bc s are small when λ λ i e τ 1 and large when λ λ i e τ 1 it is also observed that the predictions of p p r p and e p are generally in fair agreement that those of d p somewhat deviates from them and that d d can yield very different and always larger results this can be quantified and analyzed in more details by considering a secong global indicator namely the relative difference d between tensors resulting from calculations with different bc s furthermore beyond the mere difference in mean conductivity λ the measure d incorporates the differences between the eigenvalues as well as the deviations between the eigenvectors of the tensors the distance d λ 1 λ 2 between the conductivity tensors resulting from calculations with different conditions bc1 and bc2 is plotted in the top row of fig 6 as a function of λs λg for the same media as in fig 5 note that the very small values of d must not be taken literally the deviations between very similar predictions of λ for two kinds of bc s involve the influence of the bc s but also the accuracy of the numerical solution of problem 1 thus values of d 10 3 are mostly indicative with the meaning undistinguishable from a practical point of view the hierachy of the curves for the various pairs of bc s complies with what could be perceived in fig 5 it is clear in particular that the set of curves for the comparions of bc s among d p p p e p and r p cool bluish colors see fig 4f is always below the set of curves for comparisons of d d with the other bc s warm reddish colors this means that λ obtained with d d strongly departs from the λ s resulting from all other bc s which are in better mutual agreements unsurprisingly the distance d between the predictions increases with the contrast in the conductivities of the components and reaches asymptotes when the contrast is large this convergence is achieved or not in the investigated range of λs λg in the same cases as the convergence of λ in fig 5 furthermore the asymptotic values are clearly in relation with the mean conductivity when the solid is the most conducting phase in fs and bs i e when conduction takes place mostly in the predominant phase and is not strongly impaired by tortuosity as noted in feature c in the above d remains small o 10 3 in fs where λ λ 0 93 and o 10 2 in bs where λ λ 0 77 no significant influence of the bc s is to be feared more concerning values are observed in bs when gas is the conducting phase with d o 10 1 while λ λ 1 3 finally d alarmingly approaches o 1 in all cases where λ λ 1 this anticorrelation of d with λ λ or its correlation with τ as defined in 10 is checked directly by the plots of d τ in the second row of fig 6 this strickingly levels the results the variations of d which span 2 or 3 orders of magnitude when λs λg varies are reduced to a factor 2 for the corresponding curves for d τ recall that the very small values of d should only be regarded as indicative for instance the two very different asymptotes of d on either sides of the curves in fs yield very similar ratios d τ in addition it is expected that the sensitivity to the bc s depends on the sample size since its originates in disturbances near the sample boundaries which gradually decrease deeper in its volume this size has to be measured relative to the characteristic scale of the material texture which we quantify here by the correlation length lc therefore the same data for d are plotted again in the bottom row of fig 6 normalized by τ lc l the shapes of the curves are of course the same as for d τ but this additional normalization shifts them vertically and bring them at similar levels relative to fs and tgf which both have sizes l lc 128 the curves for bs l lc 77 are shifted downwards and those for psm l lc 280 are shifted upwards fig 7 where d l l c is plotted as a function of τ illustrates this in a systematic way the data from all our calculations are presented including all ratios λs λg in fs bs and all the individual realizations of the synthetic media psm and tgf for all the values of their porosities and for all pairs of bc s additionnal data obtained in shi et al 2020 for tomographic images of other anisotropic multiscale materials are also shown this amounts to about 1500 300 data points though many of them overlap and cannot be distinguished in this loglog plot an upper envelope is clearly visible which corresponds to 13a d 5 τ l c l 5 λ λ m i n 1 l c l all the data are below this limit and deviations d which approach this limit are observed for all the media conductivity contrast combinations for some pair of bc s in practice this pair always involves d d the corresponding points reddish colors are all situated in an upper strip between 13a and another line which is an upper envelope for d when comparing the predictions of λ resulting from all bc s except d d 13b d 2 τ l c l 2 λ λ min 1 l c l d d excluded 4 comparison of local fields comparing λ b c 1 and λ b c 2 resulting from different bc s means comparing the fluxes obtained for an identical t from a reversed point of view the temperature fields corresponding to different bc s but identical mean fluxes can be compared to this end the fields obtained when solving problem 1 with unit gradients t have been renormalized by the corresponding diagonal component of λ so that the mean flux component in the direction of t is the same for all bc s two such fields can be meaningfully compared and their difference δ t b c 1 b c 2 is made dimensionless by dividing it by the overall drop δt over the whole sample examples are displayed in fig 8 in a cross section of a psm sample with ϵ 0 08 when λs λg 10 3 large deviations between the fields for d p and p p reaching nearly 10 of δt are observed in a near the inlet and outlet faces as expected since this is where the bc s differ periodicity or dirichlet conversely no difference is observed along the transverse boundaries where the bc s are identical the comparison of d p with e p in b shows a similar pattern at the inlet and outlet faces and also some differences along the transverse boundaries but of a much smaller amplitude exceeding 1 of δt only a few spots in both cases the two compared fields are nearly identical in a broad central region where the darkest blue color corresponds to δ t 10 3 however the comparison of d p with d d in fig 8c as well as the confrontations of d d with p p and e p not shown is quite different instead of an agreement in a central part and deviations near the boundaries δ t follows a linear trend across the whole sample this results from the artefact associated with d d discussed in section 2 6 and illustrated in fig 3d the apparent conducting skin along the transverse boundaries provides an additional path for the heat flux therefore the immersion conditions increase the effective conductivity as noted in section 3 however the overall mean flux is not representative of the flux in the bulk of the sample and consequently after calibration of the t field the mean gradient in the bulk does not correspond to a unit mean flux as a result the good agreements of the fields in the central regions of figs 8a b is replaced by the difference of two different linear trends in order to directly exhibit the conducting skin along the transverse boundaries with d d the local flux field q was recorded in the same case as for fig 8 its component along t is denoted by q and the norm of its transverse component by q their averages q and q were measured over planes parallel at a distance d to the transverse boundaries excluding a 16r thick layer near the inlet and outlet and normalized by the overall averages of q and q these quantities are plotted in fig 9 as functions of the distance d r with bc s d p or p p both averages remain close to unity down to d 0 d p and p p yield the same result since the fields are identical see fig 8a with e p q drops slightly very close to the boundary but q remains close to one and actually nearly identical to that for p p over the whole range of d conversely with d d q sharply increases at distance d 2r and exceeds 10 at d 0 this is due to exchanges across the sample boundaries where t is prescribed and accordingly q strongly increases as well since the data are normalized by the overall volume average the excess flux in the peripheral skin is compensated by q 1 in the bulk of the sample similar evidence of this d d artefact is visible in fig 12 as discussed in section 5 a detailed and more quantitative anaylsis of the t fields differences was conducted by considering the profiles along the direction of t of the rms average δ t 2 the results are shown here only for the comparison of d p vs p p which differ only by the inlet outlet conditions therefore the profiles provide a clear view of the affected regions near the upstream and downstream domain boundaries and of the unaffected central region the latter is blurred in comparisons involving e p and r p because of the differences along the transverse boundaries see fig 8b but if a peripheral layer is filtered out the resulting profiles are similar to those obtained with d p vs p p of course a comparison in these terms of d d with other bc s is meaningless since it only shows the difference in mean gradient visible in fig 8c the profiles of δ t 2 are plotted in fig 10 for all investigated samples the raw data in the left column include all the numerical results in all cases δ t 2 decreases by a factor at least 10 from the boundaries to the central region the various curves for each kind of material are similar but spread over about two orders of magnitude according to the values of ϵ in psm and tgf and λs λg all materials unsurprisingly the lowest curves correspond to moderate conductivity contrasts green curves large contrasts yield larger δ t 2 by a significant factor when the most conducting phase is the most present red curves and by a very large factor when it is the least present blue curves this is most easily seen for fs and bs but the same trend applies in psm and tgf though it is less visible because many curves for different porosities are mixed this is the same hierarchy as for the global indicator d in fig 6 and a rationalization based on the same parameters τ and lc l can be attempted in the middle column of fig 10 δ t 2 is normalized by τ l c l the vertical spread of the profiles is very much reduced spanning a factor of about 2 only for each kind of material the maximal values at the boundaries are all between 1 and 2 except for a few cases with λs λg 1 in fs where it approaches 3 note that this unification involves τ instead of τ in the normalization factor for d in fig 6 and eq 13 another normalization is made in the right column of fig 10 where δ t 2 is simply divided in each case by its value at the boundaries this is even more successful in gathering the various curves mostly because it eliminates the spread of the end values and it demonstrates that all the profiles for each kind of media have the same shape there is a little cheat in the normalized profiles in fig 10 middle and right columns a few cases have been omitted namely λs λg 10 4 ϵ 0 15 for tgf and λs λg 10 4 ϵ 0 08 and λs λg 10 3 ϵ 0 04 for psm atypical profiles are observed in these situations of a small amount of conducting gas in a nearly insulating solid these data are included in fig 11 where the decay of the rms deviation δ t 2 is shown for all kinds of material together as a function of the distance x from the inlet outlet faces normalized by their correlation length lc however another selection has been applied with two families of situations first data for the low porosity fs ϵ 0 069 sample and those for the aforementioned low porosity synthetic media with extreme contrasts red curves second data for bs ϵ 0 232 and most data for the synthetic media excluding those with small porosity or extreme conductivity contrasts i e retaining only the cases where proximity to a percolation threshold is certainly not an issue blue curves the curves for these two families are clearly gathered in two separate groups only a few cases of synthetic media on the fringe between them yield profiles intermediate between the two groups such as psm ϵ 0 08 and tgf ϵ 0 15 with λ s λ g 10 3 green curves which are the examples used in figs 6 8 12 and 13 hence while δ t 2 at x 0 scales approximately as τ l c l its decay length within the material does not only depend on the textural scale lc furthermore from the available data a nearly bimodal behavior seems to emerge with different screening lengths for instance δ t 2 drops at x 16lc by factors about 3 and 10 for the two groups of curves in fig 11 however the parameters and mechanisms which govern the decay are not elucidated the existence of a transition would suggest that the proximity to a percolation threshold plays a role this could result from a particularly strong influence of mismatches of the inlet and outlet faces but also from a change of the relevant microscale in a near critical state it switches from the correlation length lc to the typical size of the conducting clusters also called correlation length in the framework of percolation theory but with a different meaning 5 undersampling measurements in inner subdomains the conductivity tensors associated with central sub blocks of the samples have been systematically evaluated according to the procedure described in section 2 8 a tensor λ bc c m can be deduced via 8 from the set of q c and t c vectors measured in a series of concentric subdomains ω c m obtained by removing from ω a peripheral layer with thickness m when solving problem 1 submitted to boundary conditions bc at ω results are presented in fig 12 for two examples of psm with porosity 0 08 and tgf with porosity 0 12 for λs λg 10 3 a similar figure for fs and bs can be found in shi et al 2020 the porosity ϵ is shown on the left as a function of m for the 4 stochastic realizations and their average its statistical fluctuations increase with m as the volume of the measuring domain decreases but since the samples are large these fluctuations remain quite moderate over the broad range m 160px 0 002 for psm and 0 005 for tgf thus a range with m thick enough to screen most of the influence of the bc s while ω c remains large enough to be representative can exist in these examples the plots of the mean diagonal terms λ c resulting from various overall bc s confirm this expectation middle column in fig 12 the values of λ for m 0 differ by as much as 20 in the psm sample but λ c for d d which departs the most from the other predictions drops very fast so that all predictions are within 5 as soon as m 4lc 2r this is because the measuring volume ω c excludes the conducting skin caused by d d shown in fig 9 this feature does not show in the example for tgf since d d was not implemented for this model but it is clearly visible as well in the similar plots of fig 11 of shi et al 2020 for fs and bs for larger m all predictions λ c converge progressively and reach a very good agreement when m 16lc within about 1 and all distances d 10 2 see fig 13 the differences of the local temperature fields are not entirely screened out at this distance green curves in fig 11 but their absolute values are small δ t 2 2 10 3 for psm and 8 10 3 for tgf in fig 10 all these comments apply both to the data for an individual sample and to the average over samples shown in fig 12 it is worth mentioning here the investigation in alizadeh et al 2017 of the permeability and electrical conductivity corresponding to λs λg 0 of several rock samples based on tomographic images of cylindrical samples the influence of the removal of a transverse peripheral layer was examined and the convergence of the predictions from two different kinds of boundary conditions was demonstrated as for λ c in fig 12 in these materials the influence of the transverse bc which corresponds to the deviations observed near the top and bottom boundaries in fig 8b is felt up to a distance of 3 to 4 pores away from the boundary for the permeability and less than that for the electical conductivity finally the asymmetry index a c of λ c in the right column of fig 12 is seen to increase with m it does not reach alarming levels in the present examples but larger values are observed in cases of larger constrasts and or smaller porosities e g 0 05 for fs in fig 11 of shi et al 2020 recall that λ c differs by at least a c from any acceptable conductivity tensor as discussed in section 2 9 therefore this minimal degree of uncertainty should be kept in mind even if concordant predictions of the effective conductivity are obtained from different upscaling procedures a more complete set of data covering the whole range of contrasts λs λg is presented in fig 13 where the distances d λ b c 1 c λ b c 2 c are plotted as functions of m this accounts more fully for all the differences between tensors including in their individual eigenvalues and eigendirections than the mere comparison of the mean diagonal λ c the figure includes fs and bs and the individual realizations of psm and tgf considered in fig 12 other realizations and their statistical averages give rise to similar features synthetic media with different porosities also present the same patterns although the positions of the transitions can be shifted however we do not intend here to provide a comprehensive survey of the evolution of the distances between conductivity tensors measured in sub volumes which we could not fully rationalize anyway instead our purpose is to illustrate the main phenomenological features to be expected in the practical application of the undersampling approach to a particular sample recall also that values of d 10 3 are mostly indicative as pointed out in section 3 the general features observed in fig 6 for the distances between the overall tensors λ also apply to their values λ c in inner sub domains d increases with the contrast in the component conductivities and tends toward asymptotic values when the contrast is large when the solid is the most conducting phase the pictures obtained for all λs λg 10 are very similar and only those for λs λg 100 are shown for fs and bs the hierarchy of the distances is also preserved distances d for pairs of bc s involving d d reddish curves are always larger than the others for λ and remain so even when the measurement λ c is restricted to inner sub domains there is no clear cut general behavior but the following observations can be made d decreases steeply as the thickness m of the layer discarded for the measurements increases from zero d slowly increases with m when it becomes very large the reason for this is unclear but it is of no concern since d is always small in this range 10 2 consequently there is a minimum for d at some intermediate position the transition between the decaying and growing regimes can be smooth sometimes with the appearence of a plateau or more acute the minimum takes place around m 16lc in bs psm and tgf when the contrast is strong and sooner than that if the contrast is mild it occurs later in fs in keeping with the differences in screening lengths observed in fig 11 fs belongs to the set of slowly decaying red curves while bs and the samples of synthetic media with λs λg 10 3 belong to the sets of steeper blue and green curves respectively in the examples in fig 13 the cases which call for attention because the various determinations of λ depart by distances d of order o 10 1 or more correspond to λ s λ g 10 2 for fs and bs and 10 3 for psm and tgf undersampling is a possible way to try and filter out the influence of the bc s and indeed its application with m 16 l c in all these cases yields tensors λ c which are all in agreement within a reasonable practicle tolerance of d 0 05 and often much less the only exception is fs with λ s λ g 10 4 but the remaining deviations of the order of o 10 1 involve the d d conditions and it disappears if this inadvisable bc is discarded note that fig 13 is incomplete in the sense that it only compares tensors λ bc c from various bc s in the same subdomains not their values in domains of different sizes in order to be an intrinsic effective parameter the tensor should also be invariant over a range of m this is partly checked in fig 12 with the plots of λ c which is indeed found constant within 1 5 in a range 16 m lc 64 for psm and 16 m lc 32 for tgf this is a promising but partial indication to be rigorous both checks for the independence on the bc s and on the domain size have to be made by use of the tensorial distance d for the sake of concision only the former is presented in these terms here all the quantitative statement in the above applies of course only to the particular examples considered in this section and should not be blindly transposed to other materials such as psm or tgf with different porosities or media of an entirely different kind the observed general features are expected to apply qualitatively in any case but not quantitatively when applying the undersampling in any particular sample 6 discussion and conclusions the impact of the choice of boundary conditions on the macroscopic transport coefficient predicted by a numerical upscaling has been systematically investigated for a variety of real or model heterogeneous materials with broad ranges of geometrical properties and conductivity contrasts by considering five kinds of bc s the differences of the various predictions have been quantified by the tensorial distance d note first that when the conductivity contrast is very large its precise value makes ultimately no difference and the macroscopic coefficients are in practice equivalent to those for infinite contrast for instance if the solid tends to be insulating likewise in the opposite limit the tensors λ bc and therefore their differences d converge as 14 λ b c λ g λ b c 1 0 and d λ b c 1 λ b c 2 d λ b c 1 1 0 λ b c 2 1 0 as λ s λ g 0 where λ b c 1 0 is the tensor obtained when λg 1 and λs 0 these convergences are indeed observed but their asymptotic values are not reached yet in some cases in the investigated range of contrast this occurs in situations of strong contrasts with a sparse and or poorly connected conducting phase i e λ λ or τ 1 which are also those where one should be the most concerned about the influence of the boundary conditions and where the numerical calculations are computionally most demanding however the fact that the ratio d τ is nearly independent of the contrast middle row in fig 6 is a new piece of information and advantage can be taken from it to infer the expected uncertainty for a strong contrast from its knowledge for a milder one the additional feature that the bc s effects scale as the inverse of the sample size and the corresponding normalization of d by lc l contributes to unify even more the data and leads to the representation of the whole set of numerical results in fig 7 for any particular sample the values of d for various pairs of bc s measure the difference of the corresponding predictions of λ some pairs such as p p e p are always in a better agreement than others but the largest d can be considered as an estimate of the intrinsic uncertainty of the determination of λ since at least two results differ by that much thus only the upper envelope of the data is to be considered it is fairly well described by 13 where the uncertainty is simply proportionnal to τlc l the observation 13 is probably the most important result in this paper it provides a practical a priori criterion to estimate an upper bound of the relative uncertainty of a tensor obtained by numerical upscaling when the data required for the solution of problem 1 are available lc and λ are readily available as well when a calculation with some bc yields a tensor λ τ can be estimated and 13 tells by how much tensors resulting from other bc s could differ from λ recall that d is the value that the relative error of the flux can reach when λ is used in simulations see section 2 9 there are actually two envelopes in fig 7 and two estimates of the uncertainty in 13 according to whether the immersion conditions d d should be considered or not this question is raised by the a priori suspicion that d d introduces by itself spurious effects discussed in section 2 6 and by the observation that indeed it often yields predictions notably different larger from those from other bc s the reservations about d d are supported by the analysis of local fields their comparison for different bc s in section 4 reveals various phenomenological features is is observed that the rms deviations of the local fields scale as τ and that their magnitude decays within the samples over a screening distance which is not simply proportional to the textural length lc a nearly bimodal behavior seems to emerge with different screening lengths according to whether or not the material is close to a critical state regarding conduction the latter feature is not understood and might deserve further investigation however it is made unambiguously apparent that d d causes the appearance of an excess flux in a peripheral skin along the transverse boundaries which explains the larger predicted macroscopic conductivity hence we advocate that using the d d immersion condition is inadvisable because it introduces by itself strong artefacts it induces thereby large values of the distance d from the predictions with other bc s but mostly due to its own identified sources of error recall also that the permeameter conditions or the periodization of the sample by justaposition of mirrored replicas have not been considered here because they are known to constrain the eigendirections of λ rotating them would induces large values of d if the medium is not very close to isotropic if such approaches as well as d d are set aside 13b applies in summary 13 provides a criterion for the a priori detections of situations that might be problematic in practical applications once a numerical upscaling has been performed τlc l is readily available and if it is too large it is very likely that a solution of 1 with another bc would yield a significantly different result recall that a noticeable asymmetry is also a worrying feature since the index a is a lower bound for the distance of λ from any acceptable value see section 2 9 in case of doubts appropriate measures should then be taken the first step could be to try different bc s and check whether the result is really impacted if it is the next step might be to consider ways to filter out the bc s influence by excluding the potentially disturbed region from the measurement volume to this end we recommend the undersampling procedure described in section 2 8 and illustrated in section 5 for various examples it should be emphasized that it is virtually cost free once problem 1 has been solved with any kind of bc measuring the mean flux q c and gradient t c in a series of inner sub domains does not require any significant additional computational effort the conductivity tensors λ bc c resulting from various bc s should be compared hopefully λ bc c can be found identical for all bc s and in a wide enough range of sub domains sizes within a user defined tolerance for d this tensor can be then regarded as an intrinsic effective property associated with and only with the material under consideration this requires that the sample is large enough so that a peripheral layer can be discarded from the measurement volume sufficiently thick to screen out most of the bc s influence while the remaining volume is still large enough to be representative if this is not possible it must be accepted that no reliable estimate of an effective conductivity tensor can be obtained from this sample credit authorship contribution statement jean françois thovert conceptualization methodology formal analysis writing original draft visualization supervision valeri v mourzenko software formal analysis declaration of competing interest the authors declare that they have no known competing financialinterestsor personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work pertains to the french government programme investissements d avenir labex interactifs reference anr 11 labx 0017 01 
484,channel meanders in rivers induce complex three dimensional 3d flow characteristics such as secondary flows and flow recirculation helical secondary flows promote transverse dispersion and flow recirculation zones trap tracers as a result these meander driven flows may cause anomalous transport manifested by unusually elevated levels of tracer concentration at early and late times of breakthrough curves btcs in this study we perform 3d numerical simulations in meandering channels across a wide range of channel sinuosity to investigate the impact of meander geometry on flow and transport we solve 3d reynolds averaged navier stoke equations blended with a sst k ω turbulence model to obtain velocity and turbulence fields we then incorporate the obtained flow fields into a lagrangian particle tracking model to simulate solute transport sinuosity higher than 1 5 leads to the onset of horizontal recirculating flows along the apex outer banks and these recirculation zones expand as sinuosity increases the analysis of the transport simulations elucidates that the interplay between the secondary flows and recirculation zones induces anomalous transport the helical secondary flows bring particles into the recirculation zones by promoting transverse dispersion and the recirculating flows delay particle transport by the trapping effect we show that the tail power law slope and truncated time of btcs as well as lagrangian tortuosity distributions change dramatically with the emergence of recirculation zones these analyses demonstrate that the recirculation zones are acting as the primary driver of anomalous transport finally we successfully predict the observed anomalous transport with a spatial markov model smm which is an upscaled transport model that incorporates lagrangian velocity distribution and spatial velocity correlation the successful predictions show that the lagrangian velocity statistics effectively capture the underlying mechanisms of anomalous transport in meandering open channel flows keywords anomalous transport open channel flow channel meander recirculation zone secondary flow spatial markov model 1 introduction a meander is one of the distinctive features of rivers and streams and this channel bend controls flow and transport mechanisms notably the winding patterns of channels are known to generate complex flow patterns such as secondary flows and recirculating flows bathurst et al 1977 nelson and smith 1989 liverpool and edwards 1995 shiono and muto 1998 the secondary flows can be classified as prandtl s first kind and prandtl s second kind bradshaw 1987 nezu and nakagawa 1993 the first type is the meander driven secondary flow formed by the local imbalance in centrifugal and pressure forces between the upper layer and the lower layer of the water column and it forms the helical motion by which the water in the upper part and the lower part flows outward and inward around the channel bend respectively blanckaert and graf 2004 corney et al 2006 the second type is the non helical secondary flow generated by the anisotropy of turbulent stresses bradshaw 1987 vinuesa et al 2014 in meandering rivers the secondary flow of prandtl s first kind is known to be predominant nezu and nakagawa 1993 blanckaert and de vriend 2004 moinuddin et al 2004 dey and ali 2017 the helical secondary flow impacts the primary flow patterns and substantially increases transverse dispersion via momentum and mass redistributions thus its effects on transverse dispersion in rivers have extensively been studied both theoretically and experimentally boxall and guymer 2003 marion and zaramella 2006 baek and seo 2011 seo et al 2016a in addition to the secondary flow some experimental works achieved direct observation of recirculating flows in laboratory flumes and natural rivers using an acoustic doppler velocimetry and profiler ferguson et al 2003 blanckaert 2010 2011 blanckaert et al 2013 their research reported that a sharp meander induces the onset of the horizontal recirculation zone near the bend inner bank due to the lateral momentum exchange across the interface between the main flow high velocity zone and recirculation low velocity zones the horizontal recirculation zone is usually deemed as an in stream storage zone where tracers are repeatedly trapped and released slowly back to the main flow region hence it is discussed as a potential source of anomalous non fickian transport which cannot be captured with a conventional advection dispersion equation seo and maxwell 1992 choi et al 2000 uijttewaal et al 2001 jackson et al 2013 drost et al 2014 the key signatures of anomalous transport are unusually elevated levels of tracer concentration at early and late times of breakthrough curves btcs measured at downstream positions despite the importance of the anomalous transport phenomena in surface water systems we still do not have a mechanistic understanding of how secondary flows and recirculating flows contribute to anomalous transport in meandering open channels the late time tails in btcs in open channel flows have frequently been observed in field tracer tests and the trapping effects of the horizontal recirculation zones have been discussed as the source of the late time tailing gooseff et al 2005 o connor et al 2009 jackson et al 2012 bradley and tucker 2012 and bradley 2017 presented the field evidence of recirculating flow induced anomalous sediment transport sediments exhibited an abnormally large accumulation around a sharp meander with strong flow recirculation leading to heavy tailed storage time distributions in terms of solute transport seo et al 2016b and baek and seo 2010 showed the large longitudinal elongation of a solute plume after the tracers past a sharp river bend where vigorous recirculating flows take place despite the significant effects of the meander driven recirculating flows on transport in meandering rivers the detailed flow properties the occurrence conditions and the effects of the recirculation zones on anomalous transport remain largely unknown blanckaert 2010 with the recent advancement of computational fluid dynamics cfd tools numerous studies analyzed the meander induced flow patterns with numerical experiments flow characteristics of meandering open channels are indeed shown to be highly three dimensional 3d phenomena with helical secondary flows morvan et al 2002 frothingham and rhoads 2003 rodriguez et al 2004 a number of numerical studies also reported that pronounced recirculation zones emerge near the apex inner bank of the channels owing to the sharp curvature and the shallow flow depth van balen et al 2009 2010 kang et al 2011b kang and sotiropoulos 2012 several studies also simulated transport in meandering open channels shams et al 2002 simulated sediment transport in a meandering open channel and showed that secondary flows near the channel bend control particle deposition patterns anderson and phanikumar 2011 simulated solute transport in a large river with irregular in channel topography including islands and delta bifurcations they successfully predicted the multimodal btcs with an upscale model that captures the surface storage dynamics of solutes park and seo 2018 and wu and liang 2019 developed random walk methods that use a depth averaged two dimensional 2d velocity field and adequately reproduced non fickian dispersion of solute plumes observed in rivers while numerous field and numerical studies explored the influence of channel meander on flow and transport most of the past studies investigated a specific channel geometry rivers and streams can have various meander geometries characterized by channel sinuosity as illustrated in fig 1 which should exert dominant control over the occurrence and characteristics of recirculation zones the sinuosity is a geometric index that measures the ratio of channel length to valley length that quantifies the magnitude of channel meander schumm 1963 to establish a mechanistic understanding of the meander induced anomalous transport in riverine environments it is crucial to systematically vary channel geometric parameters such as sinuosity and study their effects on not only 3d flow patterns vidal et al 2018 but also resulting transport phenomena noorani et al 2016 currently we do not have a mechanistic understanding of how the meander induced 3d flow patterns control anomalous transport the direct simulation of 3d flow and transport is advantageous to explicitly consider the effects of in channel topography and velocity fields on transport nevertheless its substantial computational cost decreases the relevance of such a model in river management anderson and phanikumar 2011 a parsimonious upscaled transport model with physical parameters are highly sought after for effective prediction of tracer transport among many upscaled transport models the spatial markov model smm suggested by le borgne et al 2008a has been successful in predicting anomalous transport behaviors across the broad spectrum of flow regimes in groundwater systems kang et al 2011a de anna et al 2013 bolster et al 2014 kang et al 2014 sund et al 2017 sherman et al 2019a this effective stochastic transport model is parsimoniously parameterized with lagrangian velocity distribution and one step spatial velocity correlation kim and kang 2020 successfully applied the smm to unconfined systems for the first time and predicted anomalous transport in turbulent open channel flows with a porous media bed also engdahl and bolster 2020 successfully extended the smm to capture transport in a variably saturated watershed yet the smm has never been applied to 3d open channel systems where the 3d flow characteristics such as secondary flows and recirculating flows govern solute transport in this study we first investigate the effects of channel sinuosity on flow characteristics especially the secondary flows of prandtl s first kind and the horizontal recirculating flows and elucidate how such complex flow patterns control solute transport mechanisms in meandering open channels we generate meandering channels across a broad range of sinuosity and perform flow simulations using a 3d numerical model this flow model is first verified with velocity data measured at a laboratory meandering channel chang 1971 and then applied to resolve the 3d flow fields in meandering channels with the obtained mean velocity and turbulence fields we simulate solute transport using a 3d lagrangian particle tracking lpt method which explicitly takes into account advection and turbulent diffusion to the best of our knowledge this is the first study that investigates how the complex interplay between the recirculation zone secondary flow and turbulent diffusion initiates anomalous transport in meandering channels we conduct a comprehensive parametric study to unravel how the secondary flow and horizontal recirculation zone develop with an increase in channel sinuosity and to elucidate how they induce anomalous transport in meandering open channels furthermore we upscale and predict this anomalous transport behavior using the smm which is effectively parameterized with lagrangian velocity statistics 2 methods 2 1 flow model large eddy simulation les has increasingly been applied to analyze 3d coherent structures of turbulent flows in curved open channels which captures transient turbulent flows with high spatio temporal resolution by explicitly resolving large scale turbulent eddies van balen et al 2009 stoesser et al 2010 2010 kang et al 2011b kang and sotiropoulos 2012 while les is robust in resolving 3d turbulent flows this modeling approach is computationally expensive and therefore not practical for a comprehensive parametric study which is required to study the influence of meander geometry on flow and transport kashyap et al 2012 in this study we use a reynolds averaged navier stokes rans model incorporating turbulence closure models which is a computationally efficient and practical approach to environmental hydraulics problems and has widely been used for modeling complex 3d flow behaviors in meandering open channels demuren and rodi 1986 ye and mccorquodale 1998 ferguson et al 2003 wilson et al 2003 duan 2004 rodriguez et al 2004 duan and julien 2005 liu and garcia 2008 kashyap et al 2012 most of the previous rans based studies employed k ε type turbulence models which have a limited ability to predict the onset and size of recirculation zones wilcox 1988 menter 1993 kok 2000 in contrast a shear stress transport sst k ω turbulence model menter 1993 has often shown a better performance over the k ε type models well capturing the separated flows in near wall regions of complex geometric configurations menter et al 2003 stamou and katsiris 2006 rumsey 2009 el behery and hamed 2011 coughtrie et al 2013 kim et al 2016 the sst k ω model blends the robust formulations of the standard k ω model for the boundary layer flows and the standard k ε model for the shear flows menter 1993 kang et al 2011b showed that the sst k ω model is more accurate over a standard k ω model in simulating mean velocity and turbulence distributions they also demonstrated that the simulation results of the sst k ω model are qualitatively similar to those of les and are in good agreement with field observation data we thus conduct fully 3d numerical simulations using an unsteady rans solver integrated with the sst k ω turbulence model available in openfoam library greenshields 2015 an open source cfd code that solves navier stokes equations via a finite volume method the computations are performed until velocity and turbulence fields reach the steady state the governing equations are unsteady 3d continuity and momentum equations in tensor notation described as 1a u i x i 0 1b u i t u j u i x j 1 ρ p x i x j ν u i x j u j x i x j u i u j where ui and uj are the time averaged velocity components in the xi and xj directions of cartesian coordinates respectively also p is the fluid pressure ρ is the density of the fluid ν is the kinematic viscosity of the fluid ui and uj are the fluctuating velocity vectors in the xi and xj directions respectively and u i u j indicates the reynolds stress a product of the reynolds decomposition to be modeled with turbulence closure models in this study we employ the sst k ω turbulence model to close eq 1b the sst k ω model has two additional transport equations for k and ω which can be expressed in tensor notation as follows 2a k t u j k x j p k β k ω x j ν σ k ν t k x j 2b ω t u j ω x j α s 2 β ω 2 x j ν σ ω ν t ω x j 2 1 f 1 σ ω 2 1 ω k x i ω x i where k is the turbulent kinetic energy ω is the specific dissipation rate pk and f 1 are the auxiliary relations and α β β σ k σω and σω2 are the closure coefficients all the parameters and relations used in the sst k ω model is summarized in table 1 and these are suggested by menter 1993 2 2 transport model we simulate transport of solute particles using a 3d lpt model herein the solute particles are considered as passive massless tracers and we do not consider sediment transport in the case of two way coupling tracer concentration can affect flow fields for example the tracer concentration can change the fluid density locally and affect the secondary and recirculating flow characteristics which may subsequently impact solute transport behaviors in this study however we assume both particle particle interactions and particle fluid interactions are negligible the tracer motion is conventionally determined by the combined effects of advection molecular diffusion and turbulent diffusion in rivers and streams we can neglect the molecular diffusion process which is insignificant compared to the turbulent diffusion process rutherford 1994 in consequence particle trajectories are determined by 3d stochastic langevin equations in tensor notation as follows 3 x i p t δ t x i p t u i x i p t u i x i p t δ t where x i p t is the particle position at t and ui x i p t and ui x i p t are the mean velocity and the fluctuating velocity which represent advection and turbulent diffusion of particles respectively as functions of time and space in this study we employ a discrete random walk drw model proposed by gosman and loannides 1983 to model the effects of random turbulent diffusion on particle trajectories the drw model defines the turbulent diffusion of particles as successive interactions between the particles and discrete turbulent eddies that have finite length and lifetime dehbi 2008 and it has successfully been applied to rans based particle transport and validated with experimental data in various environmental flows bocksell and loth 2001 shams et al 2002 buwa et al 2006 gao et al 2012 javaherchi and aliseda 2017 sajjadi et al 2017 kim and kang 2020 in the drw framework ui can be estimated from k available with the rans simulation using a relationship described as 4 u i x i p t ξ i 2 k 3 where ξ i is the unit gaussian distributed random number representing the arbitrary motion of turbulent eddies herein ξ i is updated after each lifetime of the turbulent eddy τ e calculated as 5 τ e c μ 3 4 k ε ln ζ where ε is the dissipation rate of the turbulent eddy equal to kω and ζ is the random number ranging 0 1 with eqs 4 and 5 we can describe turbulent diffusion in eddies that have constant values of ξ i during τ e when the time from the origin time of the turbulent eddy exceeds τ e the drw model renews the particle turbulent eddy interaction by regenerating ξ i and τ e with the rans simulated k and ω repeating this process we can consider the spatio temporal variability of the turbulent eddies on particle dispersion 2 3 upscaled transport model spatial markov model we predict particle residence times by upscaling transport behaviors in meandering channels using the smm this upscaled transport model incorporates lagrangian velocity statistics as model parameters and honors the interplay between velocity distribution and spatial velocity correlation le borgne et al 2008a in the smm the lagrangian velocity series are described with a velocity markov model dentz et al 2016 kang et al 2017 the one dimensional 1d langevin equations governing particle positions and residence times are expressed as 6a x n 1 x n δ x 6b t n 1 t n τ n where τ n is the transition time of particles to jump a fixed spatial step δx by sampling τ at every δx from particle trajectories we can obtain a probability density function pdf of τ p τ which has one to one relation with lagrangian velocity distribution the transition time and the corresponding lagrangian velocity are linked with the following relation τ n δx vn where vn is the corresponding largrangian velocity we only consider x directional movement of particles in this study the unique feature of the smm is that τ τ n is correlated to a particle transition time at a previous step τ τ n 1 owing to the spatial markov property of lagrangian velocity transitions le borgne et al 2008a therefore we can model τ by constructing a transition probability matrix that considers the one step spatial velocity correlation to retrieve the transition probabilities from the 3d lpt simulation results p τ is discretized into n classes ci 1 i n where i increases with an increase in τ we then obtain the conditional probability density r τ τ consequently the transition probability matrix is given as 7 t i j τ i τ i 1 τ j τ j 1 r τ τ p τ d τ d τ τ j τ j 1 p τ d τ where tij indicates the transition probability from the current transition time class j to the next transition time class i 2 4 setup of numerical experiments 2 4 1 model validation case to validate the flow model we first perform hydrodynamic simulations of a meandering channel geometry that has laboratory experimental data chang 1971 conducted hydraulic experiments in a meandering flume with a flat bed and measured 3d velocity components the experimental flume with hydraulically smooth walls and rectangular cross sections includes uniform 90 bends in alternating directions interconnected by straight reaches as shown in fig 2 the mean velocity at the inlet u 0 is 0 366 m s and water depth h and channel width w are 0 115 m and 2 34 m respectively this set up leads to 1 81 105 and 0 345 of fluid reynolds number re u 0 dh ν and froude number fr u 0 g h respectively where dh is the hydraulic diameter in chang s experiment the 3d velocity components were measured along the second bend of the channel chang s channel has been often used for the validation of numerical models demuren and rodi 1986 ye and mccorquidale 1998 demuren and rodi 1986 performed numerical simulations using a computational mesh with 14 nodes and 24 nodes in the vertical and transverse directions respectively and 122 nodes in the longitudinal direction they reported that the discretization of 122 by 24 by 14 had been found to be optimal achieving reasonable accuracy without high computational cost to guarantee the grid independency we conduct simulations with a coarse grid distribution 122 24 14 cells identical to that of demuren and rodi s study and a finer grid distribution 320 52 20 cells both composed of structured cells these grid distributions guarantee the use of wall functions satisfying the dimensionless wall height z zbu ν criterion of 30 z 300 where zb is the distance from solid boundaries side walls or stream bed to the center of the grids nearest to these wall boundaries the difference in mesh resolution resulted in no significant difference in simulated mean velocity and turbulence fields this result is consistent with findings of demuren and rodi 1986 andye and mccorquidale 1998 in which they reported that computations with the grid resolution of 122 24 14 cells and 132 26 12 cells and with the grid resolution twice finer than the repective ones yield the relative difference less than 1 thus we adopt the coarse grid distribution for flow simulations of study cases 2 4 2 study cases based on geometric data obtained from field observation in rivers hey 1976 proposed empirical relationships between the wavelength λ m radius of curvature rc and channel width w for various arc angles θ as follows 8a r c 360 θ w 8b λ m 4 sin θ 2 r c 8c λ m 1 440 θ sin θ 2 w using these relationships we generate six meandering channels with different levels of channel sinuosity for study cases and each channel is composed of 12 meanders as shown in fig 1 the aspect ratio w h of the generated channels and u 0 are identical to those of chang s meandering channel thereby retaining re and fr equal to 1 81 105 and 0 345 respectively both inlet and outlet are characterized as a straight reach which length is twice the channel width in this study we control meander geometry by varying θ from 45 to 240 and this geometric configuration produces the channel sinuosity defined as lm l 0 which ranges 1 03 2 42 the geometric parameters used in generating the meandering channels are described in fig 1 and their values for the study cases are summarized in table 2 note that the channel length l is constant over all the study cases for computational meshes of the study cases we use the grid resolution of 629 24 14 which is identical to the grid resolution of the model validation case 2 4 3 boundary and simulation conditions we apply the dirichlet boundary condition to the inlet boundary for velocity and turbulence variables the velocity is uniformly prescribed depending on a discharge velocity that corresponds to u 0 the turbulence variables which are involved with the sst k ω turbulence model are set to the inlet boundary given by 9a k 3 2 u 0 i 2 9b ω c μ 1 4 k l where i is the turbulent intensity and l is the turbulent length scale we assume i and l as 5 of the mean velocity magnitude and 7 of the flow depth respectively verstegg and malalasekera 2007 the no slip condition is set for the velocity at the walls and channel bed the turbulence variables such as k ω and ν t are set to the wall functions at the walls the zero gradient condition is imposed on k at the wall contiguous cells the wall function for ω can be defined as 10 ω p ω v i s 2 ω l o g 2 where ω p is the centroid value in cells adjacent to solid walls ω vis and ω log are the values for viscous and log layer respectively described as 11a ω vis 6 ν β 1 d 2 11b ω log u c μ 1 4 κ d where u is the shear velocity κ is the von karman constant set to 0 41 and d is the distance from the solid walls ν t at the walls can be replaced as follows 12 ν t w a l l ν w a l l z κ ln e z 1 where e is the empirical constant set to 8 43 haase et al 2006 in this study we treat the free surface boundary as a rigid lid so that the water surface is replaced by a frictionless plane surface parallel to the channel bed this boundary is thus assumed to behave like a plane of symmetry with the velocity component normal to it and the normal gradients of all other quantities are equal to zero the use of such a rigid lid is justified if the gradient of the water surface is small enough with fr less than unity which is the case in this study this approach is often used for curved open channel flows demuren and rodi 1986 stoesser et al 2010 van balen et al 2010 for boundary conditions at the outlet all variables of velocity and turbulence components are set to the zero gradient boundary condition for pressure the zero gradient condition is applied to all boundaries except the outlet and pressure implicit with splitting of operators piso algorithm is used for coupling between pressure and velocity in solute transport simulations the total particle number of 106 is injected from the inlet boundary at the center of the channel cross section as a point source which allows us to explore the 3d spatio temporal evolution of particle spreading we simulate advection and turbulent diffusion of solute particles using the steady state velocity and turbulence fields the time step is set to a value which satisfies courant number cr ui δt δx less than unity 3 results and discussion 3 1 model validation results we first validate our flow model by comparing model results with the experimental data chang 1971 streamwise velocity and transverse velocity profiles from the experiment and numerical model on the selected cross sections of sec 7 sec 9 and sec 11 fig 2 are shown in figs 3 and 4 previous studies observed pronounced helical motions of the secondary flow on the selected cross sections chang 1971 demuren and rodi 1986 ye and mccorquidale 1998 the number of observation column is 6 in the transverse direction with 9 points in the vertical direction numerical simulations adequately reproduce the general flow patterns observed in the experiments in chang s meandering channel for the streamwise velocities the discrepancy of the velocity magnitude at the water surface is relatively large near the side walls while the accuracy of that is enhanced towards the central regions of the channel fig 3 for the spanwise velocities even if the velocity magnitude is underestimated near the water surface the numerical model successfully captures that the helical cross sectionally rotating motion of secondary flows identified as the vertical gradients in the spanwise velocity are developed near the meander apex fig 4 these tendencies are very similar to earlier studies that performed rans simulations in chang s meandering channel demuren and rodi 1986 ye and mccorquidale 1998 they reported that the rans based turbulence models underestimate the secondary flow effects and consequently yields the relatively large errors in the streamwise velocity close to the side walls this is because the isotropic turbulence models used in the rans simulations underpredict the outer bank secondary flow cell booij 2003 marin et al 2016 which represents the non helical flow of prandtl s second kind driven by turbulence anisotropy stoesser et al 2010 in this study as a result the inherent limitation of the rans based turbulence modeling may result in the near wall discrepancy in the streamwise velocity between the observation and simulation in the present work nevetheless the primary flow patterns at the central region of the channels should be less affected by the near bank secondary flows because the channel have the large aspect ratio of w h 20 vinuesa et al 2018 fig 2 shows the spatial map of the simulated mean velocity magnitude at the free surface according to this figure the maximum streamwise velocity occurs near the inner banks of a bend this behavior was frequently observed in previous experiments and numerical simulations chang 1971 demuren and rodi 1986 ye and mccorquidale 1998 abad and garcia 2009a stoesser et al 2010 in natural streams however the maximum velocity is generally found towards the outer bank of meanders this discrepancy is because of the flat and smooth bed conditions in the experiments that do not consider channel bed deformation by sediment transport as demonstrated in previous experimental studies duan and julien 2005 abad and garcia 2009b blanckaert 2010 2011 the erosional and depositional processes form thalweg towards the outer bank of a bend where maximum velocity is often observed whiting and dietrich 1993 termini 2015 3 2 results of flow simulation for study cases 3 2 1 streamwise velocity distribution fig 5 a illustrates cross sectional maps of streamwise velocity at the meander apexes located in a11 and a12 in fig 1 from this figure one can notice that the streamwise velocity increases dramatically towards the inner bank as sinuosity increases this behavior causes high sinuosity cases to yield large velocity deviations from the mean value u 0 0 366 m s in the spanwise direction fig 1 also we calculate depth averaged streamwise velocity distributions by integrating streamwise velocity components over the flow depth and plot them in the spanwise direction fig 5b this figure shows that the maximum streamwise velocity normalized by u 0 of sn242 sinuosity 2 42 is about 1 5 times larger than the value of sn103 sinuosity 1 03 note that u 0 is constant over all study cases this result confirms that the increase in sinuosity increases the maximum streamwise velocity and thus forms a strong preferential flow path as shown in fig 1 for the low sinuosity while the difference between the maximum velocity and the mean velocity is relatively small corresponding to the enhanced streamwise velocity near the inner bank the streamwise velocity decreases towards the outer bank as a consequence this large velocity gradient in the spanwise direction which is originated from the high sinuosity promotes the longitudinal spreading of a solute plume in rivers and streams deng et al 2001 seo and baek 2004 furthermore fig 5b shows negative streamwise velocities close to the outer bank for the study cases with sinuosity 1 9 and 2 42 this backflow indicates that vigorous recirculation zones in the horizontal plane emerge in the vicinity of the outer bank the detailed flow characteristics of these horizontal recirculation zones will be further discussed in section 3 2 3 3 2 2 secondary flow fig 6 a presents cross sectional maps of spanwise velocity at the bend apex a11 and a12 in fig 1 where the strong helical secondary flows emerge as sinuosity increases we also calculate width averaged spanwise velocity profiles by integrating components of spanwise velocity over the channel width fig 6b as sinuosity increases the magnitude of the width averaged spanwise velocity increases with the large vertical gradient of the spanwise velocity for the high sinuosity cases of sn157 sn190 and sn242 note that the secondary circulation cells are significantly reduced near the outer bank owing to the presence of the horizontal recirculation zones with low velocity magnitudes we quantify the secondary current intensity sci at the apex using the equation as follows 13 s c i 1 m k 1 m u n u 0 100 where m is the total number of observation points and un is the deviation of the spanwise velocity un from the averaged spanwise velocity u n of the cross section at the apex this indicator measures the magnitude of the secondary flow relative to the mean velocity magnitude fig 7 a shows sci as a function of rc w which is the curvature ratio to channel width rc w is also a measure for the channel sinuosity and rc w increases as sinuosity decreases fig 7a shows that sn242 rc w 1 5 exhibits sci more than 6 times the value of sn103 which contributes up to about 8 of the bulk flow through the channel the relationship between rc w sinuosity and sci follows a power law function with a scaling exponent of about 1 here and hereafter we estimated power law scaling exponents using a method of least squares 3 2 3 horizontal recirculation zone we quantify the occurrence condition of horizontal recirculating flows and the effects of sinuosity on the recirculating flow properties such as the reattachment length width and velocity of recirculation zones the study cases of sn157 sn190 and sn242 have horizontal recirculation zones developed along the apex outer banks as shown in fig 7b the high velocity zones and the low velocity zones are separated more distinctively with increasing sinuosity which induces the large difference in maximum and minimum values of mean velocity in the spanwise direction fig 7a as a result of this flow separation the lateral momentum exchange between the high velocity region and the low velocity region produces the outer bank horizontal recirculation zone under the high sinuosity conditions of sn157 sn190 and sn242 in earlier studies some researchers found that the onset of the horizontal recirculation zone in meanders can be related to rc w hickin 1978 experimentally showed that the flow recirculations develop with decreasing rc w and suggested the threshold of rc w 2 for the onset of the recirculation zone as shown in table 2 sn157 sn190 and sn242 have rc w equal to or smaller than the occurrence threshold therefore simulation results show good agreement with the experimental finding of hickin 1978 we further analyze the size and flow properties of the recirculation zones as shown in figs 7b and 7c the reattachment length lr and maximum width wr max of the recirculation zones both enlarge with increasing sinuosity decreasing rc w especially for sn242 lr and wr max are more than twice the values of sn157 we also calculate the maximum depth averaged value of velocity magnitude inside the recirculation zone u r max to evaluate the recirculating flow intensity for sn157 which has rc w equal to the critical condition of 2 u r max is very small whereas the higher sinuosity cases of sn190 and sn242 exhibit larger values of u r max which increase up to 5 times the value of sn157 these parameters characterizing the recirculation zone can be adequately related to sinuosity rc w using power law functions fig 7c from these findings we can infer that channel sinuosity controls not only the occurrence of the recirculation zone but also its size and flow characteristics 3 3 results of transport simulation for study cases 3 3 1 tracer breakthrough curves to observe the impact of the sinuosity driven flow characteristics on longitudinal and transverse dispersion of tracers we first plot horizontal 2d btcs from the 3d lpt simulations as shown in fig 8 the 2d btcs are generated by measuring arrival times of tracers at the outlet and plotting the tracer concentrations as a function of the arrival time and transversal distance from the left bank note that the meandering channels of study cases have a large value of w h so that the tracers are well mixed in the vertical direction at an early stage fig 8 shows that the longitudinal spreading of a tracer cloud increases significantly as sinuosity increases this enhanced dispersion yields not only early and late arrivals of the particles but also a decrease in the peak concentration these behaviors are more evident in 1d longitudinal btcs fig 9 first the preferential flow path emerging with the increase in sinuosity fig 1 shortens the arrival time of the peak concentration also the strong velocity gradients in the spanwise direction fig 5 combined with the horizontal recirculation zones enhance longitudinal dispersion from the 1d btcs we characterize relationships between sinuosity and btc parameters of the peak concentration cp and the peak arrival time tp and show that they closely follow power law functions with scaling exponents of 1 77 and 0 32 respectively figs 10 a and b additionally figs 8 and 9 show that the high sinuosity cases of sn157 sn190 and sn242 exhibit the abrupt elongation of late time tails in the btcs which may be induced by the recirculation zones to quantitatively evaluate the effects of channel sinuosity on anomalous transport we analyze btc parameters of the tail power law slope α and the truncated time tt we approximate the truncated time by extrapolating the btcs to the target minimum tracer concentration of 10 6 measured at the outlet using the estimated tail power law slope drummond et al 2012 suggested that the dynamic range ratio of peak concentration to minimum concentration distinguished from background noise should be large enough to appropriately characterize in stream btcs with power law tailing resulting from storage zone effects and suggested its value of 2 9e4 the dynamic range used in this study varies about 1 5e4 6 3e4 which is close to or larger than the suggested value this implies that we can capture late time tailing of btcs based on power law functions effectively both the power law slope and truncated times are sensitive to channel sinuosity as shown in figs 10c and d note that two different regimes are found both in the tail power law slope and truncated time as a function of sinuosity we further discuss the role of recirculation zones on anomalous transport with these btc parameters in section 3 3 2 from the 2d btcs we also notice the large transverse spreading of the particle plume as sinuosity increases fig 8 this confirms that the enhanced secondary flow associated with the high sinuosity facilitates the strong transverse spreading of the solute particles even though the secondary flow velocity is smaller than the primary flow velocity figs 5 and 6 this helical flow motion promotes transverse dispersion of the solute particles by actively spreading them three dimensionally and reducing the concentration gradient especially in the transverse direction owing to the large value of w h boxall and guymer 2003 albers and steffler 2007 baek and seo 2011 fig 11 shows the time averaged particle number in the transverse direction at the outlet and the corresponding spatial variance fig 11 inset as a function of sinuosity because of the limited secondary flow the small sinuosity case sn103 does not exhibit active movement of the particles towards the channel banks thereby leading to the large transverse variance which is about one order of magnitude larger than the value of the high sinuosity cases as shown in fig 11 inset beyond sinuosity 1 5 no significant difference in the transverse variance is observed because the particles are almost fully mixed in the transverse direction at the outlet due to the enhanced secondary flow for sn242 the significant skewness of the solute plume towards the left bank is found fig 8 which results in a substantial increase in the transverse spatial variance of the time averaged particle number tracer concentration at the outlet fig 11 this can be explained by the main passage preferential flow path of the tracers through the outlet biased towards the left bank due to the transversely skewed velocity distribution which is caused by the high sinuosity as depicted in fig 1 this strongly skewed preferential flow path leads fewer particles to breakthrough near the right bank of the outlet that has low velocities the strong skewness of the particle pathline in sn242 is also related to the enlarged recirculation zones that exert the storage effects on transport and cause the second peak in the btcs as shown in figs 8 and 9 3 3 2 role of recirculation zones on anomalous transport we observe strong late time tailing a key signature of anomalous transport from the btcs of sn157 sn190 and sn242 figs 8 and 9 the emergence of the late time tailing coincides with the onset of the horizontal recirculation zones induced by high sinuosity larger than 1 5 fig 7b this implies that the recirculating flow may be the dominant driver of anomalous transport by exerting the trapping effects on particle motions and delaying particle transport the increase in sinuosity exacerbates the heavy tailed btcs by enlarging recirculating flows with trapping effects as illustrated in fig 12 the enlarged recirculation zones with the strong secondary flow cause particles to be more easily trapped and stay longer in the recirculation zones resulting in an increased accumulation of the particles inside the recirculation zones the combined effects of the secondary flow and the recirculation zone lead to the significant late time tailing of the btcs first the helical secondary flow brings more particles towards the recirculation zones via transverse dispersion facilitating more particles to be trapped in the recirculation zones once the particles are trapped in the recirculation zones they cannot easily escape from the recirculation zones this is mainly because the secondary flow intensity is reduced drastically inside the recirculation zones as demonstrated in fig 6a hence we can infer that the secondary flow also contributes to anomalous transport by promoting the particle trapping effects of the recirculation zones this trend is more pronounced as sinuosity increases for sn242 the combined effects of the enhanced recirculating and secondary flows exert the significant storage effects on particle transport and accordingly result in the aforementioned secondary peak in the btc figs 8 and 9 fig 10c presents the tail power law slopes as a function of sinuosity and clearly shows that scaling exponents change drammatically corresponding to the emergence of the horizontal recirculation zones the power law slope shows two regimes according to the existence of the recirculation zones and increases significantly when recirculation zones emerge the truncated times as a function of sinuosity also exhibit two regimes as shown in fig 10d this figure shows that the truncated times of sn157 sn190 and sn242 are about 2 3 times the values of sn103 sn111 and sn136 the common tendencies found in the estimated btc parameters are that both the power law slope and truncated time do not differ noticeably with increasing sinuosity in the absence of the recirculation zones whereas these parameters both change radically with the onset of the recirculation zones consequently this result shows that the sinuosity driven recirculation zone appears to be a major source of anomalous transport in the meandering open channel flows to further demonstrate the effects of the recirculating flows on tracer transport we calculate the tortuosity of particle trajectories the tortuosity is estimated by calculating the ratio of the 2d particle trajectory curvilinear length to the linear distance over a single meander wavelength λ m between the 10th and 12th meander apex of the channels normalized by sinuosity as shown in fig 13 a note that the particle movements in the vertical direction is not considered in the tortuosity estimation because they are negligibly small due to the large aspect ratio w h 20 of the channels fig 13a depicts the estimated tortuosity distributions for 0 5 of the total particles which have the tortuosity higher than that of the remaining 99 5 particles and these particles characterize the late arrival of the tracers as the recirculation zones emerge sn157 sn190 and sn242 we observe that the tortuosity values increase and deviate significantly from the reference base tortuosity plateaus in fig 13a this observation highlights the trapping effects of the recirculation zones because the large tortuosity characterizes the late arrival of particles the tortuosity deviation becomes more significant as the recirculation zones enlarge with increasing sinuosity this tendency is also demonstrated in fig 13b which shows particle positions of two sampled particles at a discrete time step of 5 s fig 13b visualizes how the large recirculation zones increase not only the length of the particle trajectories tortuosity but also the residenc times of the particles via the trapping effects note that in fig 13b the number of the dots in the channels is proportional to the particle residence time thus the regions where the dots are highly concentrated can be identified as significant trapping zones for the sample particles fig 13a inset shows the tortuosity over the whole study reach for 5 of the total particles which have the tortuosity higher than that of the remaining 95 particles according to this figure the maximum tortuosity and its ratio to the base value maximum tortuosity minimum tortuosity increase up to about 1 6 and 1 8 respectively the maximum tortuosity ratio to the base tortuosity measures the difference between the latest arrival time and the earliest arrival time of the particles extent of longitudinal spreading from these two indicators hence we can quantify the anomality of solute transport note that the minimum base tortuosity decreases with increasing sinuosity this is because the strong velocity gradient in the spanwise direction arising from the high sinuosity fig 5 shortens the length of the shortest particle pathline as shown in fig 13c the shortest particle pathline corresponds to the minimum base tortuosity and we confirmed that the shortest particle trajectory coincides with the fastest particle trajectory the relationship between the length of the shortest particle pathline and sinuosity nicely follows a power law function with a scaling exponent of 0 123 and this has direct implications on the early arrival of the tracers 3 3 3 results of upscaled transport modeling to upscale solute transport with the smm we parametrize this upscaled transport model using the lagrangian velocity statistics characterized with velocity transition time distribution and spatial velocity correlation the motion of solute particles is discretized equidistantly with the fixed spatial jump of δx the particle transition times τ in eq 6b are sampled at every apex of the meanders which corresponds to total 13 jumps over the channel fig 14 a presents pdfs of τ transition time distributions for representative study cases of sn103 sn136 sn157 and sn242 from fig 14a it is notable that the transition time pdfs have power law slopes closely resembling those of the corresponding btcs and also capture the secondary peak phenomenon observed in sn242 induced by the strong storage trapping effects of the large recirculation zones the probability of having large transition times increases significantly as sinuosity increases producing the heavy tailed pdfs of τ this is because the prevalent backflows and slow velocity inside the expanded recirculation zones delay particle transport from these observations it seems that the lagrangian velocity distributions adequately capture the influence of the sinuosity induced flow characteristics on anomalous transport additionally we characterize the spatial velocity correlation structures by constructing the transition matrix defined in eq 7 from the series of τ sampled at each δx we build 20 20 transition matrices as shown in fig 15 for which each transition time class is spaced equidistantly in the logarithmic scale to provide a better resolution for large transition times that governs late time tailing le borgne et al 2008b kang et al 2015 the channel sinuosity has major impacts on the velocity correlation structure as sinuosity increases from 1 03 to 1 57 the transition probabilities from the current transition time classes cj to the next transition time classes ci increase and become concentrated in the specific range of i 4 10 small values of τ as shown in fig 15a c this is because the strong velocity gradient in the spanwise direction due to the increase in sinuosity focuses the particle paths to the fast flow regions particles in the fast flow regions cannot easily diffuse into the slow flow regions via turbulent diffusion because of the strong inertia effect on the other hand the slow flow regions have the relatively weak inertia effect allowing particles to jump actively into the fast flow regions via turbulent diffusion interestingly sn242 shows the strong spatial correlation for both small transition times preferential flow path and large transition times recirculation zones as show in fig 15d it is notable that the strong correlation is found in the large transition times unlike other study cases this is because sn242 has the pronounced recirculation zones resulting from high sinuosity and particles retain the memory of the small transition times by the strong trapping effects compared to other study cases sn242 exhibits larger and faster recirculating flows as demonstrated in figs 7b and c in which the trapped particles cannot easily escape from the recirculation zones to the main flow zone by turbulent diffusion leading to the strong correlation for the small transition times the intrinsic flow characteristics of the high sinuosity channel make the particles to retain the memory of both small lagrangian velocities attributed to the horizontal recirculating flows and large lagrangian velocities attributed to the preferential flow paths thereby causing both early arrival and late arrival of the first passage times with the constructed transition matrices of τ we conduct predictive modeling of tracer btcs fig 14b shows btcs predicted with the smm for the representative study cases of sn103 sn136 sn157 and sn242 to assess the competency of this effective upscaled transport model in predicting anomalous transport observed in the numerical simulations the comparison between the smm predictions and the 3d lpt simulation results shows that the smm successfully reproduces the first passage time distributions btcs accurately capturing the recirculation zone induced anomalous tailing behaviors note that we also confirmed the capability of the smm in predicting the remaining study cases from these upscaled predictions we can conclude that the lagrangian velocity statistics composed of velocity distribution and velocity correlation effectively encode anomalous transport dynamics in the meandering open channels where the complex interplay between the shear flow velocity gradient secondary flow horizontal recirculation zone and turbulent diffusion govern solute transport 4 conclusions this study elucidates the effects of the meander induced 3d flow characteristics especially horizontal recirculating flows and secondary flows on anomalous transport in meandering open channels we first validated the 3d rans model integrated with the sst k ω turbulence closure approach by comparing the model results with the experimental study chang 1971 and the flow model adequately reproduced the helical motion of secondary flows near the bend apex we used this validated flow model to explore the control of meander geometry sinuosity on open channel flow patterns across a wide range of sinuosity varying 1 03 2 42 as sinuosity increases the flow simulations revealed the following flow characteristics i the large discrepancy between the maximum and minimum streamwise velocities in the spanwise direction both largely deviated from the mean velocity ii the enhancement of the secondary flow whose intensity increases up to about 8 of the main stream velocity and shown to follow the power law relationship with rc w and iii the emergence of the horizontal recirculating flows in the vicinity of the apex outer banks when rc w 2 which corresponds to sinuosity larger than 1 5 these recirculation zones expand as sinuosity increases showing the power law relationships between hydrogeometric parameters reattachment length maximum width and maximum velocity and rc w the transport simulations using the 3d lpt model demonstrated that the combined effects of the horizontal recirculation zones and the secondary flows substantially govern anomalous transport in meandering open channels the secondary flows originated from the increase in channel sinuosity enhance transverse dispersion and bring particles towards the recirculation zones where the particle trapping effects considerably delay particle transport thereby resulting in the late breakthrough of the particles even if the secondary flows enhance the trapping effects of the flow recirculation this study shows that the recirculation zone plays a critical role in determining anomalous transport in meandering open channels this is demonstrated by various transport measures btc parameters of power law slope and truncated time changed dramatically with the emergence of the horizontal flow recirculation both the power law slope and truncated time showed two distinctive regimes depending on the existence of the recirculating flows also we found the evidence of the recirculation zone induced anomalous transport from the tortuosity of particle trajectories as sinuosity increases beyond the occurrence condition sinuosity 1 5 of the recirculation zones the number of the particles having large tortuosity increased significantly because of the circulating streamlines inside the recirculation zones a recent study showed that the interplay between helical secondary flows and recirculating flows can also induce reaction hot spots in confined channel flows lee and kang 2020 and this study can be extended to elucidate the effects of 3d flow characteristics on reactive transport in open channel systems we applied the smm to upscale particle transport and accurately predicted anomalous transport behaviors observed in the 3d lpt simulations this upscaled stochastic transport model was parameterized using a transition matrix which encodes the lagrangian velocity distribution and spatial velocity correlation properties derived from the simulated particle trajectories this markovian transition matrix effectively captured the strong trapping effects by the recirculation zones and the effects of preferential flows the transition matrix of sn242 showed the strong correlation for both small and large transition times which arise from the preferential flows and the recirculating flows respectively the smm successfully reproduced the btcs obtained from the numerical simulations by capturing the mechanisms of recirculation zone induced anomalous transport via the lagrangian velocity statistics in this study we paramterized the smm using the particle tracking simulation data even though the focus of the present work is not to efficiently parameterize the smm but to evaluate the applicability of the smm in meandering rivers the efficient parameteration of the smm is practically important sherman et al 2017 hence the parameter estimation of the smm from river hydraulic or topographic data should be an important next step in summary this study reveals that the sinuosity driven recirculating flows exert dominant control over anomalous transport in meandering open channel flows and shows that the smm can effectively upscale the underlying transport mechanisms we highlight that the present work is the first successful application of the smm to the reach scale meandering open channels as aforementioned however we considerd the flat and smooth bed conditions and streambed topology controlled by sediment transport can play a vital role in determining the thalweg patterns and resulting flow properties such as secondary flows and recirculating flows in meandering rivers abad and garcia 2009b blanckaert 2010 termini and piraino 2011 therefore various channel bed morphologies that honor erosional and depositional processes of sediment beds should be considered in a future study the combined effects of sinuosity and channel morphodynamics on anomalous transport is an important next step furthermore in stream vegetation and hyporheic zone widely recognized as sources of anomalous transport in surface waters are other essential factors to be considered stonedahl et al 2012 aubeneau et al 2014 rubol et al 2016 yang et al 2016 sherman et al 2019b nevertheless the main findings of this study provide key insights regarding the mechanisms of anomalous transport in rivers and streams because the meandering channel geometry sinuosity is ubiquitous in riverine environments and should exert first order control on flow and transport credit authorship contribution statement jun song kim conceptualization methodology software investigation formal analysis writing original draft visualization il won seo writing review editing donghae baek methodology software visualization validation writing review editing project administration peter k kang conceptualization methodology writing review editing supervision project administration funding acquisition declaration of competing interest none acknowledgments jsk and pkk acknowledge the college of science engineering at the university of minnesota and the george and orpha gibson endowment and a grant from korea environment industry and technology institute keiti through subsurface environmental management sem project funded by the korea ministry of environment moe 2018002440003 iws and db also acknowledge support from the institute of engineering research and institute of construction and environmental engineering in seoul national university seoul south korea we thank the minnesota supercomputing institute msi at the university of minnesota for computational resources and support supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103603 appendix supplementary materials image application 1 
484,channel meanders in rivers induce complex three dimensional 3d flow characteristics such as secondary flows and flow recirculation helical secondary flows promote transverse dispersion and flow recirculation zones trap tracers as a result these meander driven flows may cause anomalous transport manifested by unusually elevated levels of tracer concentration at early and late times of breakthrough curves btcs in this study we perform 3d numerical simulations in meandering channels across a wide range of channel sinuosity to investigate the impact of meander geometry on flow and transport we solve 3d reynolds averaged navier stoke equations blended with a sst k ω turbulence model to obtain velocity and turbulence fields we then incorporate the obtained flow fields into a lagrangian particle tracking model to simulate solute transport sinuosity higher than 1 5 leads to the onset of horizontal recirculating flows along the apex outer banks and these recirculation zones expand as sinuosity increases the analysis of the transport simulations elucidates that the interplay between the secondary flows and recirculation zones induces anomalous transport the helical secondary flows bring particles into the recirculation zones by promoting transverse dispersion and the recirculating flows delay particle transport by the trapping effect we show that the tail power law slope and truncated time of btcs as well as lagrangian tortuosity distributions change dramatically with the emergence of recirculation zones these analyses demonstrate that the recirculation zones are acting as the primary driver of anomalous transport finally we successfully predict the observed anomalous transport with a spatial markov model smm which is an upscaled transport model that incorporates lagrangian velocity distribution and spatial velocity correlation the successful predictions show that the lagrangian velocity statistics effectively capture the underlying mechanisms of anomalous transport in meandering open channel flows keywords anomalous transport open channel flow channel meander recirculation zone secondary flow spatial markov model 1 introduction a meander is one of the distinctive features of rivers and streams and this channel bend controls flow and transport mechanisms notably the winding patterns of channels are known to generate complex flow patterns such as secondary flows and recirculating flows bathurst et al 1977 nelson and smith 1989 liverpool and edwards 1995 shiono and muto 1998 the secondary flows can be classified as prandtl s first kind and prandtl s second kind bradshaw 1987 nezu and nakagawa 1993 the first type is the meander driven secondary flow formed by the local imbalance in centrifugal and pressure forces between the upper layer and the lower layer of the water column and it forms the helical motion by which the water in the upper part and the lower part flows outward and inward around the channel bend respectively blanckaert and graf 2004 corney et al 2006 the second type is the non helical secondary flow generated by the anisotropy of turbulent stresses bradshaw 1987 vinuesa et al 2014 in meandering rivers the secondary flow of prandtl s first kind is known to be predominant nezu and nakagawa 1993 blanckaert and de vriend 2004 moinuddin et al 2004 dey and ali 2017 the helical secondary flow impacts the primary flow patterns and substantially increases transverse dispersion via momentum and mass redistributions thus its effects on transverse dispersion in rivers have extensively been studied both theoretically and experimentally boxall and guymer 2003 marion and zaramella 2006 baek and seo 2011 seo et al 2016a in addition to the secondary flow some experimental works achieved direct observation of recirculating flows in laboratory flumes and natural rivers using an acoustic doppler velocimetry and profiler ferguson et al 2003 blanckaert 2010 2011 blanckaert et al 2013 their research reported that a sharp meander induces the onset of the horizontal recirculation zone near the bend inner bank due to the lateral momentum exchange across the interface between the main flow high velocity zone and recirculation low velocity zones the horizontal recirculation zone is usually deemed as an in stream storage zone where tracers are repeatedly trapped and released slowly back to the main flow region hence it is discussed as a potential source of anomalous non fickian transport which cannot be captured with a conventional advection dispersion equation seo and maxwell 1992 choi et al 2000 uijttewaal et al 2001 jackson et al 2013 drost et al 2014 the key signatures of anomalous transport are unusually elevated levels of tracer concentration at early and late times of breakthrough curves btcs measured at downstream positions despite the importance of the anomalous transport phenomena in surface water systems we still do not have a mechanistic understanding of how secondary flows and recirculating flows contribute to anomalous transport in meandering open channels the late time tails in btcs in open channel flows have frequently been observed in field tracer tests and the trapping effects of the horizontal recirculation zones have been discussed as the source of the late time tailing gooseff et al 2005 o connor et al 2009 jackson et al 2012 bradley and tucker 2012 and bradley 2017 presented the field evidence of recirculating flow induced anomalous sediment transport sediments exhibited an abnormally large accumulation around a sharp meander with strong flow recirculation leading to heavy tailed storage time distributions in terms of solute transport seo et al 2016b and baek and seo 2010 showed the large longitudinal elongation of a solute plume after the tracers past a sharp river bend where vigorous recirculating flows take place despite the significant effects of the meander driven recirculating flows on transport in meandering rivers the detailed flow properties the occurrence conditions and the effects of the recirculation zones on anomalous transport remain largely unknown blanckaert 2010 with the recent advancement of computational fluid dynamics cfd tools numerous studies analyzed the meander induced flow patterns with numerical experiments flow characteristics of meandering open channels are indeed shown to be highly three dimensional 3d phenomena with helical secondary flows morvan et al 2002 frothingham and rhoads 2003 rodriguez et al 2004 a number of numerical studies also reported that pronounced recirculation zones emerge near the apex inner bank of the channels owing to the sharp curvature and the shallow flow depth van balen et al 2009 2010 kang et al 2011b kang and sotiropoulos 2012 several studies also simulated transport in meandering open channels shams et al 2002 simulated sediment transport in a meandering open channel and showed that secondary flows near the channel bend control particle deposition patterns anderson and phanikumar 2011 simulated solute transport in a large river with irregular in channel topography including islands and delta bifurcations they successfully predicted the multimodal btcs with an upscale model that captures the surface storage dynamics of solutes park and seo 2018 and wu and liang 2019 developed random walk methods that use a depth averaged two dimensional 2d velocity field and adequately reproduced non fickian dispersion of solute plumes observed in rivers while numerous field and numerical studies explored the influence of channel meander on flow and transport most of the past studies investigated a specific channel geometry rivers and streams can have various meander geometries characterized by channel sinuosity as illustrated in fig 1 which should exert dominant control over the occurrence and characteristics of recirculation zones the sinuosity is a geometric index that measures the ratio of channel length to valley length that quantifies the magnitude of channel meander schumm 1963 to establish a mechanistic understanding of the meander induced anomalous transport in riverine environments it is crucial to systematically vary channel geometric parameters such as sinuosity and study their effects on not only 3d flow patterns vidal et al 2018 but also resulting transport phenomena noorani et al 2016 currently we do not have a mechanistic understanding of how the meander induced 3d flow patterns control anomalous transport the direct simulation of 3d flow and transport is advantageous to explicitly consider the effects of in channel topography and velocity fields on transport nevertheless its substantial computational cost decreases the relevance of such a model in river management anderson and phanikumar 2011 a parsimonious upscaled transport model with physical parameters are highly sought after for effective prediction of tracer transport among many upscaled transport models the spatial markov model smm suggested by le borgne et al 2008a has been successful in predicting anomalous transport behaviors across the broad spectrum of flow regimes in groundwater systems kang et al 2011a de anna et al 2013 bolster et al 2014 kang et al 2014 sund et al 2017 sherman et al 2019a this effective stochastic transport model is parsimoniously parameterized with lagrangian velocity distribution and one step spatial velocity correlation kim and kang 2020 successfully applied the smm to unconfined systems for the first time and predicted anomalous transport in turbulent open channel flows with a porous media bed also engdahl and bolster 2020 successfully extended the smm to capture transport in a variably saturated watershed yet the smm has never been applied to 3d open channel systems where the 3d flow characteristics such as secondary flows and recirculating flows govern solute transport in this study we first investigate the effects of channel sinuosity on flow characteristics especially the secondary flows of prandtl s first kind and the horizontal recirculating flows and elucidate how such complex flow patterns control solute transport mechanisms in meandering open channels we generate meandering channels across a broad range of sinuosity and perform flow simulations using a 3d numerical model this flow model is first verified with velocity data measured at a laboratory meandering channel chang 1971 and then applied to resolve the 3d flow fields in meandering channels with the obtained mean velocity and turbulence fields we simulate solute transport using a 3d lagrangian particle tracking lpt method which explicitly takes into account advection and turbulent diffusion to the best of our knowledge this is the first study that investigates how the complex interplay between the recirculation zone secondary flow and turbulent diffusion initiates anomalous transport in meandering channels we conduct a comprehensive parametric study to unravel how the secondary flow and horizontal recirculation zone develop with an increase in channel sinuosity and to elucidate how they induce anomalous transport in meandering open channels furthermore we upscale and predict this anomalous transport behavior using the smm which is effectively parameterized with lagrangian velocity statistics 2 methods 2 1 flow model large eddy simulation les has increasingly been applied to analyze 3d coherent structures of turbulent flows in curved open channels which captures transient turbulent flows with high spatio temporal resolution by explicitly resolving large scale turbulent eddies van balen et al 2009 stoesser et al 2010 2010 kang et al 2011b kang and sotiropoulos 2012 while les is robust in resolving 3d turbulent flows this modeling approach is computationally expensive and therefore not practical for a comprehensive parametric study which is required to study the influence of meander geometry on flow and transport kashyap et al 2012 in this study we use a reynolds averaged navier stokes rans model incorporating turbulence closure models which is a computationally efficient and practical approach to environmental hydraulics problems and has widely been used for modeling complex 3d flow behaviors in meandering open channels demuren and rodi 1986 ye and mccorquodale 1998 ferguson et al 2003 wilson et al 2003 duan 2004 rodriguez et al 2004 duan and julien 2005 liu and garcia 2008 kashyap et al 2012 most of the previous rans based studies employed k ε type turbulence models which have a limited ability to predict the onset and size of recirculation zones wilcox 1988 menter 1993 kok 2000 in contrast a shear stress transport sst k ω turbulence model menter 1993 has often shown a better performance over the k ε type models well capturing the separated flows in near wall regions of complex geometric configurations menter et al 2003 stamou and katsiris 2006 rumsey 2009 el behery and hamed 2011 coughtrie et al 2013 kim et al 2016 the sst k ω model blends the robust formulations of the standard k ω model for the boundary layer flows and the standard k ε model for the shear flows menter 1993 kang et al 2011b showed that the sst k ω model is more accurate over a standard k ω model in simulating mean velocity and turbulence distributions they also demonstrated that the simulation results of the sst k ω model are qualitatively similar to those of les and are in good agreement with field observation data we thus conduct fully 3d numerical simulations using an unsteady rans solver integrated with the sst k ω turbulence model available in openfoam library greenshields 2015 an open source cfd code that solves navier stokes equations via a finite volume method the computations are performed until velocity and turbulence fields reach the steady state the governing equations are unsteady 3d continuity and momentum equations in tensor notation described as 1a u i x i 0 1b u i t u j u i x j 1 ρ p x i x j ν u i x j u j x i x j u i u j where ui and uj are the time averaged velocity components in the xi and xj directions of cartesian coordinates respectively also p is the fluid pressure ρ is the density of the fluid ν is the kinematic viscosity of the fluid ui and uj are the fluctuating velocity vectors in the xi and xj directions respectively and u i u j indicates the reynolds stress a product of the reynolds decomposition to be modeled with turbulence closure models in this study we employ the sst k ω turbulence model to close eq 1b the sst k ω model has two additional transport equations for k and ω which can be expressed in tensor notation as follows 2a k t u j k x j p k β k ω x j ν σ k ν t k x j 2b ω t u j ω x j α s 2 β ω 2 x j ν σ ω ν t ω x j 2 1 f 1 σ ω 2 1 ω k x i ω x i where k is the turbulent kinetic energy ω is the specific dissipation rate pk and f 1 are the auxiliary relations and α β β σ k σω and σω2 are the closure coefficients all the parameters and relations used in the sst k ω model is summarized in table 1 and these are suggested by menter 1993 2 2 transport model we simulate transport of solute particles using a 3d lpt model herein the solute particles are considered as passive massless tracers and we do not consider sediment transport in the case of two way coupling tracer concentration can affect flow fields for example the tracer concentration can change the fluid density locally and affect the secondary and recirculating flow characteristics which may subsequently impact solute transport behaviors in this study however we assume both particle particle interactions and particle fluid interactions are negligible the tracer motion is conventionally determined by the combined effects of advection molecular diffusion and turbulent diffusion in rivers and streams we can neglect the molecular diffusion process which is insignificant compared to the turbulent diffusion process rutherford 1994 in consequence particle trajectories are determined by 3d stochastic langevin equations in tensor notation as follows 3 x i p t δ t x i p t u i x i p t u i x i p t δ t where x i p t is the particle position at t and ui x i p t and ui x i p t are the mean velocity and the fluctuating velocity which represent advection and turbulent diffusion of particles respectively as functions of time and space in this study we employ a discrete random walk drw model proposed by gosman and loannides 1983 to model the effects of random turbulent diffusion on particle trajectories the drw model defines the turbulent diffusion of particles as successive interactions between the particles and discrete turbulent eddies that have finite length and lifetime dehbi 2008 and it has successfully been applied to rans based particle transport and validated with experimental data in various environmental flows bocksell and loth 2001 shams et al 2002 buwa et al 2006 gao et al 2012 javaherchi and aliseda 2017 sajjadi et al 2017 kim and kang 2020 in the drw framework ui can be estimated from k available with the rans simulation using a relationship described as 4 u i x i p t ξ i 2 k 3 where ξ i is the unit gaussian distributed random number representing the arbitrary motion of turbulent eddies herein ξ i is updated after each lifetime of the turbulent eddy τ e calculated as 5 τ e c μ 3 4 k ε ln ζ where ε is the dissipation rate of the turbulent eddy equal to kω and ζ is the random number ranging 0 1 with eqs 4 and 5 we can describe turbulent diffusion in eddies that have constant values of ξ i during τ e when the time from the origin time of the turbulent eddy exceeds τ e the drw model renews the particle turbulent eddy interaction by regenerating ξ i and τ e with the rans simulated k and ω repeating this process we can consider the spatio temporal variability of the turbulent eddies on particle dispersion 2 3 upscaled transport model spatial markov model we predict particle residence times by upscaling transport behaviors in meandering channels using the smm this upscaled transport model incorporates lagrangian velocity statistics as model parameters and honors the interplay between velocity distribution and spatial velocity correlation le borgne et al 2008a in the smm the lagrangian velocity series are described with a velocity markov model dentz et al 2016 kang et al 2017 the one dimensional 1d langevin equations governing particle positions and residence times are expressed as 6a x n 1 x n δ x 6b t n 1 t n τ n where τ n is the transition time of particles to jump a fixed spatial step δx by sampling τ at every δx from particle trajectories we can obtain a probability density function pdf of τ p τ which has one to one relation with lagrangian velocity distribution the transition time and the corresponding lagrangian velocity are linked with the following relation τ n δx vn where vn is the corresponding largrangian velocity we only consider x directional movement of particles in this study the unique feature of the smm is that τ τ n is correlated to a particle transition time at a previous step τ τ n 1 owing to the spatial markov property of lagrangian velocity transitions le borgne et al 2008a therefore we can model τ by constructing a transition probability matrix that considers the one step spatial velocity correlation to retrieve the transition probabilities from the 3d lpt simulation results p τ is discretized into n classes ci 1 i n where i increases with an increase in τ we then obtain the conditional probability density r τ τ consequently the transition probability matrix is given as 7 t i j τ i τ i 1 τ j τ j 1 r τ τ p τ d τ d τ τ j τ j 1 p τ d τ where tij indicates the transition probability from the current transition time class j to the next transition time class i 2 4 setup of numerical experiments 2 4 1 model validation case to validate the flow model we first perform hydrodynamic simulations of a meandering channel geometry that has laboratory experimental data chang 1971 conducted hydraulic experiments in a meandering flume with a flat bed and measured 3d velocity components the experimental flume with hydraulically smooth walls and rectangular cross sections includes uniform 90 bends in alternating directions interconnected by straight reaches as shown in fig 2 the mean velocity at the inlet u 0 is 0 366 m s and water depth h and channel width w are 0 115 m and 2 34 m respectively this set up leads to 1 81 105 and 0 345 of fluid reynolds number re u 0 dh ν and froude number fr u 0 g h respectively where dh is the hydraulic diameter in chang s experiment the 3d velocity components were measured along the second bend of the channel chang s channel has been often used for the validation of numerical models demuren and rodi 1986 ye and mccorquidale 1998 demuren and rodi 1986 performed numerical simulations using a computational mesh with 14 nodes and 24 nodes in the vertical and transverse directions respectively and 122 nodes in the longitudinal direction they reported that the discretization of 122 by 24 by 14 had been found to be optimal achieving reasonable accuracy without high computational cost to guarantee the grid independency we conduct simulations with a coarse grid distribution 122 24 14 cells identical to that of demuren and rodi s study and a finer grid distribution 320 52 20 cells both composed of structured cells these grid distributions guarantee the use of wall functions satisfying the dimensionless wall height z zbu ν criterion of 30 z 300 where zb is the distance from solid boundaries side walls or stream bed to the center of the grids nearest to these wall boundaries the difference in mesh resolution resulted in no significant difference in simulated mean velocity and turbulence fields this result is consistent with findings of demuren and rodi 1986 andye and mccorquidale 1998 in which they reported that computations with the grid resolution of 122 24 14 cells and 132 26 12 cells and with the grid resolution twice finer than the repective ones yield the relative difference less than 1 thus we adopt the coarse grid distribution for flow simulations of study cases 2 4 2 study cases based on geometric data obtained from field observation in rivers hey 1976 proposed empirical relationships between the wavelength λ m radius of curvature rc and channel width w for various arc angles θ as follows 8a r c 360 θ w 8b λ m 4 sin θ 2 r c 8c λ m 1 440 θ sin θ 2 w using these relationships we generate six meandering channels with different levels of channel sinuosity for study cases and each channel is composed of 12 meanders as shown in fig 1 the aspect ratio w h of the generated channels and u 0 are identical to those of chang s meandering channel thereby retaining re and fr equal to 1 81 105 and 0 345 respectively both inlet and outlet are characterized as a straight reach which length is twice the channel width in this study we control meander geometry by varying θ from 45 to 240 and this geometric configuration produces the channel sinuosity defined as lm l 0 which ranges 1 03 2 42 the geometric parameters used in generating the meandering channels are described in fig 1 and their values for the study cases are summarized in table 2 note that the channel length l is constant over all the study cases for computational meshes of the study cases we use the grid resolution of 629 24 14 which is identical to the grid resolution of the model validation case 2 4 3 boundary and simulation conditions we apply the dirichlet boundary condition to the inlet boundary for velocity and turbulence variables the velocity is uniformly prescribed depending on a discharge velocity that corresponds to u 0 the turbulence variables which are involved with the sst k ω turbulence model are set to the inlet boundary given by 9a k 3 2 u 0 i 2 9b ω c μ 1 4 k l where i is the turbulent intensity and l is the turbulent length scale we assume i and l as 5 of the mean velocity magnitude and 7 of the flow depth respectively verstegg and malalasekera 2007 the no slip condition is set for the velocity at the walls and channel bed the turbulence variables such as k ω and ν t are set to the wall functions at the walls the zero gradient condition is imposed on k at the wall contiguous cells the wall function for ω can be defined as 10 ω p ω v i s 2 ω l o g 2 where ω p is the centroid value in cells adjacent to solid walls ω vis and ω log are the values for viscous and log layer respectively described as 11a ω vis 6 ν β 1 d 2 11b ω log u c μ 1 4 κ d where u is the shear velocity κ is the von karman constant set to 0 41 and d is the distance from the solid walls ν t at the walls can be replaced as follows 12 ν t w a l l ν w a l l z κ ln e z 1 where e is the empirical constant set to 8 43 haase et al 2006 in this study we treat the free surface boundary as a rigid lid so that the water surface is replaced by a frictionless plane surface parallel to the channel bed this boundary is thus assumed to behave like a plane of symmetry with the velocity component normal to it and the normal gradients of all other quantities are equal to zero the use of such a rigid lid is justified if the gradient of the water surface is small enough with fr less than unity which is the case in this study this approach is often used for curved open channel flows demuren and rodi 1986 stoesser et al 2010 van balen et al 2010 for boundary conditions at the outlet all variables of velocity and turbulence components are set to the zero gradient boundary condition for pressure the zero gradient condition is applied to all boundaries except the outlet and pressure implicit with splitting of operators piso algorithm is used for coupling between pressure and velocity in solute transport simulations the total particle number of 106 is injected from the inlet boundary at the center of the channel cross section as a point source which allows us to explore the 3d spatio temporal evolution of particle spreading we simulate advection and turbulent diffusion of solute particles using the steady state velocity and turbulence fields the time step is set to a value which satisfies courant number cr ui δt δx less than unity 3 results and discussion 3 1 model validation results we first validate our flow model by comparing model results with the experimental data chang 1971 streamwise velocity and transverse velocity profiles from the experiment and numerical model on the selected cross sections of sec 7 sec 9 and sec 11 fig 2 are shown in figs 3 and 4 previous studies observed pronounced helical motions of the secondary flow on the selected cross sections chang 1971 demuren and rodi 1986 ye and mccorquidale 1998 the number of observation column is 6 in the transverse direction with 9 points in the vertical direction numerical simulations adequately reproduce the general flow patterns observed in the experiments in chang s meandering channel for the streamwise velocities the discrepancy of the velocity magnitude at the water surface is relatively large near the side walls while the accuracy of that is enhanced towards the central regions of the channel fig 3 for the spanwise velocities even if the velocity magnitude is underestimated near the water surface the numerical model successfully captures that the helical cross sectionally rotating motion of secondary flows identified as the vertical gradients in the spanwise velocity are developed near the meander apex fig 4 these tendencies are very similar to earlier studies that performed rans simulations in chang s meandering channel demuren and rodi 1986 ye and mccorquidale 1998 they reported that the rans based turbulence models underestimate the secondary flow effects and consequently yields the relatively large errors in the streamwise velocity close to the side walls this is because the isotropic turbulence models used in the rans simulations underpredict the outer bank secondary flow cell booij 2003 marin et al 2016 which represents the non helical flow of prandtl s second kind driven by turbulence anisotropy stoesser et al 2010 in this study as a result the inherent limitation of the rans based turbulence modeling may result in the near wall discrepancy in the streamwise velocity between the observation and simulation in the present work nevetheless the primary flow patterns at the central region of the channels should be less affected by the near bank secondary flows because the channel have the large aspect ratio of w h 20 vinuesa et al 2018 fig 2 shows the spatial map of the simulated mean velocity magnitude at the free surface according to this figure the maximum streamwise velocity occurs near the inner banks of a bend this behavior was frequently observed in previous experiments and numerical simulations chang 1971 demuren and rodi 1986 ye and mccorquidale 1998 abad and garcia 2009a stoesser et al 2010 in natural streams however the maximum velocity is generally found towards the outer bank of meanders this discrepancy is because of the flat and smooth bed conditions in the experiments that do not consider channel bed deformation by sediment transport as demonstrated in previous experimental studies duan and julien 2005 abad and garcia 2009b blanckaert 2010 2011 the erosional and depositional processes form thalweg towards the outer bank of a bend where maximum velocity is often observed whiting and dietrich 1993 termini 2015 3 2 results of flow simulation for study cases 3 2 1 streamwise velocity distribution fig 5 a illustrates cross sectional maps of streamwise velocity at the meander apexes located in a11 and a12 in fig 1 from this figure one can notice that the streamwise velocity increases dramatically towards the inner bank as sinuosity increases this behavior causes high sinuosity cases to yield large velocity deviations from the mean value u 0 0 366 m s in the spanwise direction fig 1 also we calculate depth averaged streamwise velocity distributions by integrating streamwise velocity components over the flow depth and plot them in the spanwise direction fig 5b this figure shows that the maximum streamwise velocity normalized by u 0 of sn242 sinuosity 2 42 is about 1 5 times larger than the value of sn103 sinuosity 1 03 note that u 0 is constant over all study cases this result confirms that the increase in sinuosity increases the maximum streamwise velocity and thus forms a strong preferential flow path as shown in fig 1 for the low sinuosity while the difference between the maximum velocity and the mean velocity is relatively small corresponding to the enhanced streamwise velocity near the inner bank the streamwise velocity decreases towards the outer bank as a consequence this large velocity gradient in the spanwise direction which is originated from the high sinuosity promotes the longitudinal spreading of a solute plume in rivers and streams deng et al 2001 seo and baek 2004 furthermore fig 5b shows negative streamwise velocities close to the outer bank for the study cases with sinuosity 1 9 and 2 42 this backflow indicates that vigorous recirculation zones in the horizontal plane emerge in the vicinity of the outer bank the detailed flow characteristics of these horizontal recirculation zones will be further discussed in section 3 2 3 3 2 2 secondary flow fig 6 a presents cross sectional maps of spanwise velocity at the bend apex a11 and a12 in fig 1 where the strong helical secondary flows emerge as sinuosity increases we also calculate width averaged spanwise velocity profiles by integrating components of spanwise velocity over the channel width fig 6b as sinuosity increases the magnitude of the width averaged spanwise velocity increases with the large vertical gradient of the spanwise velocity for the high sinuosity cases of sn157 sn190 and sn242 note that the secondary circulation cells are significantly reduced near the outer bank owing to the presence of the horizontal recirculation zones with low velocity magnitudes we quantify the secondary current intensity sci at the apex using the equation as follows 13 s c i 1 m k 1 m u n u 0 100 where m is the total number of observation points and un is the deviation of the spanwise velocity un from the averaged spanwise velocity u n of the cross section at the apex this indicator measures the magnitude of the secondary flow relative to the mean velocity magnitude fig 7 a shows sci as a function of rc w which is the curvature ratio to channel width rc w is also a measure for the channel sinuosity and rc w increases as sinuosity decreases fig 7a shows that sn242 rc w 1 5 exhibits sci more than 6 times the value of sn103 which contributes up to about 8 of the bulk flow through the channel the relationship between rc w sinuosity and sci follows a power law function with a scaling exponent of about 1 here and hereafter we estimated power law scaling exponents using a method of least squares 3 2 3 horizontal recirculation zone we quantify the occurrence condition of horizontal recirculating flows and the effects of sinuosity on the recirculating flow properties such as the reattachment length width and velocity of recirculation zones the study cases of sn157 sn190 and sn242 have horizontal recirculation zones developed along the apex outer banks as shown in fig 7b the high velocity zones and the low velocity zones are separated more distinctively with increasing sinuosity which induces the large difference in maximum and minimum values of mean velocity in the spanwise direction fig 7a as a result of this flow separation the lateral momentum exchange between the high velocity region and the low velocity region produces the outer bank horizontal recirculation zone under the high sinuosity conditions of sn157 sn190 and sn242 in earlier studies some researchers found that the onset of the horizontal recirculation zone in meanders can be related to rc w hickin 1978 experimentally showed that the flow recirculations develop with decreasing rc w and suggested the threshold of rc w 2 for the onset of the recirculation zone as shown in table 2 sn157 sn190 and sn242 have rc w equal to or smaller than the occurrence threshold therefore simulation results show good agreement with the experimental finding of hickin 1978 we further analyze the size and flow properties of the recirculation zones as shown in figs 7b and 7c the reattachment length lr and maximum width wr max of the recirculation zones both enlarge with increasing sinuosity decreasing rc w especially for sn242 lr and wr max are more than twice the values of sn157 we also calculate the maximum depth averaged value of velocity magnitude inside the recirculation zone u r max to evaluate the recirculating flow intensity for sn157 which has rc w equal to the critical condition of 2 u r max is very small whereas the higher sinuosity cases of sn190 and sn242 exhibit larger values of u r max which increase up to 5 times the value of sn157 these parameters characterizing the recirculation zone can be adequately related to sinuosity rc w using power law functions fig 7c from these findings we can infer that channel sinuosity controls not only the occurrence of the recirculation zone but also its size and flow characteristics 3 3 results of transport simulation for study cases 3 3 1 tracer breakthrough curves to observe the impact of the sinuosity driven flow characteristics on longitudinal and transverse dispersion of tracers we first plot horizontal 2d btcs from the 3d lpt simulations as shown in fig 8 the 2d btcs are generated by measuring arrival times of tracers at the outlet and plotting the tracer concentrations as a function of the arrival time and transversal distance from the left bank note that the meandering channels of study cases have a large value of w h so that the tracers are well mixed in the vertical direction at an early stage fig 8 shows that the longitudinal spreading of a tracer cloud increases significantly as sinuosity increases this enhanced dispersion yields not only early and late arrivals of the particles but also a decrease in the peak concentration these behaviors are more evident in 1d longitudinal btcs fig 9 first the preferential flow path emerging with the increase in sinuosity fig 1 shortens the arrival time of the peak concentration also the strong velocity gradients in the spanwise direction fig 5 combined with the horizontal recirculation zones enhance longitudinal dispersion from the 1d btcs we characterize relationships between sinuosity and btc parameters of the peak concentration cp and the peak arrival time tp and show that they closely follow power law functions with scaling exponents of 1 77 and 0 32 respectively figs 10 a and b additionally figs 8 and 9 show that the high sinuosity cases of sn157 sn190 and sn242 exhibit the abrupt elongation of late time tails in the btcs which may be induced by the recirculation zones to quantitatively evaluate the effects of channel sinuosity on anomalous transport we analyze btc parameters of the tail power law slope α and the truncated time tt we approximate the truncated time by extrapolating the btcs to the target minimum tracer concentration of 10 6 measured at the outlet using the estimated tail power law slope drummond et al 2012 suggested that the dynamic range ratio of peak concentration to minimum concentration distinguished from background noise should be large enough to appropriately characterize in stream btcs with power law tailing resulting from storage zone effects and suggested its value of 2 9e4 the dynamic range used in this study varies about 1 5e4 6 3e4 which is close to or larger than the suggested value this implies that we can capture late time tailing of btcs based on power law functions effectively both the power law slope and truncated times are sensitive to channel sinuosity as shown in figs 10c and d note that two different regimes are found both in the tail power law slope and truncated time as a function of sinuosity we further discuss the role of recirculation zones on anomalous transport with these btc parameters in section 3 3 2 from the 2d btcs we also notice the large transverse spreading of the particle plume as sinuosity increases fig 8 this confirms that the enhanced secondary flow associated with the high sinuosity facilitates the strong transverse spreading of the solute particles even though the secondary flow velocity is smaller than the primary flow velocity figs 5 and 6 this helical flow motion promotes transverse dispersion of the solute particles by actively spreading them three dimensionally and reducing the concentration gradient especially in the transverse direction owing to the large value of w h boxall and guymer 2003 albers and steffler 2007 baek and seo 2011 fig 11 shows the time averaged particle number in the transverse direction at the outlet and the corresponding spatial variance fig 11 inset as a function of sinuosity because of the limited secondary flow the small sinuosity case sn103 does not exhibit active movement of the particles towards the channel banks thereby leading to the large transverse variance which is about one order of magnitude larger than the value of the high sinuosity cases as shown in fig 11 inset beyond sinuosity 1 5 no significant difference in the transverse variance is observed because the particles are almost fully mixed in the transverse direction at the outlet due to the enhanced secondary flow for sn242 the significant skewness of the solute plume towards the left bank is found fig 8 which results in a substantial increase in the transverse spatial variance of the time averaged particle number tracer concentration at the outlet fig 11 this can be explained by the main passage preferential flow path of the tracers through the outlet biased towards the left bank due to the transversely skewed velocity distribution which is caused by the high sinuosity as depicted in fig 1 this strongly skewed preferential flow path leads fewer particles to breakthrough near the right bank of the outlet that has low velocities the strong skewness of the particle pathline in sn242 is also related to the enlarged recirculation zones that exert the storage effects on transport and cause the second peak in the btcs as shown in figs 8 and 9 3 3 2 role of recirculation zones on anomalous transport we observe strong late time tailing a key signature of anomalous transport from the btcs of sn157 sn190 and sn242 figs 8 and 9 the emergence of the late time tailing coincides with the onset of the horizontal recirculation zones induced by high sinuosity larger than 1 5 fig 7b this implies that the recirculating flow may be the dominant driver of anomalous transport by exerting the trapping effects on particle motions and delaying particle transport the increase in sinuosity exacerbates the heavy tailed btcs by enlarging recirculating flows with trapping effects as illustrated in fig 12 the enlarged recirculation zones with the strong secondary flow cause particles to be more easily trapped and stay longer in the recirculation zones resulting in an increased accumulation of the particles inside the recirculation zones the combined effects of the secondary flow and the recirculation zone lead to the significant late time tailing of the btcs first the helical secondary flow brings more particles towards the recirculation zones via transverse dispersion facilitating more particles to be trapped in the recirculation zones once the particles are trapped in the recirculation zones they cannot easily escape from the recirculation zones this is mainly because the secondary flow intensity is reduced drastically inside the recirculation zones as demonstrated in fig 6a hence we can infer that the secondary flow also contributes to anomalous transport by promoting the particle trapping effects of the recirculation zones this trend is more pronounced as sinuosity increases for sn242 the combined effects of the enhanced recirculating and secondary flows exert the significant storage effects on particle transport and accordingly result in the aforementioned secondary peak in the btc figs 8 and 9 fig 10c presents the tail power law slopes as a function of sinuosity and clearly shows that scaling exponents change drammatically corresponding to the emergence of the horizontal recirculation zones the power law slope shows two regimes according to the existence of the recirculation zones and increases significantly when recirculation zones emerge the truncated times as a function of sinuosity also exhibit two regimes as shown in fig 10d this figure shows that the truncated times of sn157 sn190 and sn242 are about 2 3 times the values of sn103 sn111 and sn136 the common tendencies found in the estimated btc parameters are that both the power law slope and truncated time do not differ noticeably with increasing sinuosity in the absence of the recirculation zones whereas these parameters both change radically with the onset of the recirculation zones consequently this result shows that the sinuosity driven recirculation zone appears to be a major source of anomalous transport in the meandering open channel flows to further demonstrate the effects of the recirculating flows on tracer transport we calculate the tortuosity of particle trajectories the tortuosity is estimated by calculating the ratio of the 2d particle trajectory curvilinear length to the linear distance over a single meander wavelength λ m between the 10th and 12th meander apex of the channels normalized by sinuosity as shown in fig 13 a note that the particle movements in the vertical direction is not considered in the tortuosity estimation because they are negligibly small due to the large aspect ratio w h 20 of the channels fig 13a depicts the estimated tortuosity distributions for 0 5 of the total particles which have the tortuosity higher than that of the remaining 99 5 particles and these particles characterize the late arrival of the tracers as the recirculation zones emerge sn157 sn190 and sn242 we observe that the tortuosity values increase and deviate significantly from the reference base tortuosity plateaus in fig 13a this observation highlights the trapping effects of the recirculation zones because the large tortuosity characterizes the late arrival of particles the tortuosity deviation becomes more significant as the recirculation zones enlarge with increasing sinuosity this tendency is also demonstrated in fig 13b which shows particle positions of two sampled particles at a discrete time step of 5 s fig 13b visualizes how the large recirculation zones increase not only the length of the particle trajectories tortuosity but also the residenc times of the particles via the trapping effects note that in fig 13b the number of the dots in the channels is proportional to the particle residence time thus the regions where the dots are highly concentrated can be identified as significant trapping zones for the sample particles fig 13a inset shows the tortuosity over the whole study reach for 5 of the total particles which have the tortuosity higher than that of the remaining 95 particles according to this figure the maximum tortuosity and its ratio to the base value maximum tortuosity minimum tortuosity increase up to about 1 6 and 1 8 respectively the maximum tortuosity ratio to the base tortuosity measures the difference between the latest arrival time and the earliest arrival time of the particles extent of longitudinal spreading from these two indicators hence we can quantify the anomality of solute transport note that the minimum base tortuosity decreases with increasing sinuosity this is because the strong velocity gradient in the spanwise direction arising from the high sinuosity fig 5 shortens the length of the shortest particle pathline as shown in fig 13c the shortest particle pathline corresponds to the minimum base tortuosity and we confirmed that the shortest particle trajectory coincides with the fastest particle trajectory the relationship between the length of the shortest particle pathline and sinuosity nicely follows a power law function with a scaling exponent of 0 123 and this has direct implications on the early arrival of the tracers 3 3 3 results of upscaled transport modeling to upscale solute transport with the smm we parametrize this upscaled transport model using the lagrangian velocity statistics characterized with velocity transition time distribution and spatial velocity correlation the motion of solute particles is discretized equidistantly with the fixed spatial jump of δx the particle transition times τ in eq 6b are sampled at every apex of the meanders which corresponds to total 13 jumps over the channel fig 14 a presents pdfs of τ transition time distributions for representative study cases of sn103 sn136 sn157 and sn242 from fig 14a it is notable that the transition time pdfs have power law slopes closely resembling those of the corresponding btcs and also capture the secondary peak phenomenon observed in sn242 induced by the strong storage trapping effects of the large recirculation zones the probability of having large transition times increases significantly as sinuosity increases producing the heavy tailed pdfs of τ this is because the prevalent backflows and slow velocity inside the expanded recirculation zones delay particle transport from these observations it seems that the lagrangian velocity distributions adequately capture the influence of the sinuosity induced flow characteristics on anomalous transport additionally we characterize the spatial velocity correlation structures by constructing the transition matrix defined in eq 7 from the series of τ sampled at each δx we build 20 20 transition matrices as shown in fig 15 for which each transition time class is spaced equidistantly in the logarithmic scale to provide a better resolution for large transition times that governs late time tailing le borgne et al 2008b kang et al 2015 the channel sinuosity has major impacts on the velocity correlation structure as sinuosity increases from 1 03 to 1 57 the transition probabilities from the current transition time classes cj to the next transition time classes ci increase and become concentrated in the specific range of i 4 10 small values of τ as shown in fig 15a c this is because the strong velocity gradient in the spanwise direction due to the increase in sinuosity focuses the particle paths to the fast flow regions particles in the fast flow regions cannot easily diffuse into the slow flow regions via turbulent diffusion because of the strong inertia effect on the other hand the slow flow regions have the relatively weak inertia effect allowing particles to jump actively into the fast flow regions via turbulent diffusion interestingly sn242 shows the strong spatial correlation for both small transition times preferential flow path and large transition times recirculation zones as show in fig 15d it is notable that the strong correlation is found in the large transition times unlike other study cases this is because sn242 has the pronounced recirculation zones resulting from high sinuosity and particles retain the memory of the small transition times by the strong trapping effects compared to other study cases sn242 exhibits larger and faster recirculating flows as demonstrated in figs 7b and c in which the trapped particles cannot easily escape from the recirculation zones to the main flow zone by turbulent diffusion leading to the strong correlation for the small transition times the intrinsic flow characteristics of the high sinuosity channel make the particles to retain the memory of both small lagrangian velocities attributed to the horizontal recirculating flows and large lagrangian velocities attributed to the preferential flow paths thereby causing both early arrival and late arrival of the first passage times with the constructed transition matrices of τ we conduct predictive modeling of tracer btcs fig 14b shows btcs predicted with the smm for the representative study cases of sn103 sn136 sn157 and sn242 to assess the competency of this effective upscaled transport model in predicting anomalous transport observed in the numerical simulations the comparison between the smm predictions and the 3d lpt simulation results shows that the smm successfully reproduces the first passage time distributions btcs accurately capturing the recirculation zone induced anomalous tailing behaviors note that we also confirmed the capability of the smm in predicting the remaining study cases from these upscaled predictions we can conclude that the lagrangian velocity statistics composed of velocity distribution and velocity correlation effectively encode anomalous transport dynamics in the meandering open channels where the complex interplay between the shear flow velocity gradient secondary flow horizontal recirculation zone and turbulent diffusion govern solute transport 4 conclusions this study elucidates the effects of the meander induced 3d flow characteristics especially horizontal recirculating flows and secondary flows on anomalous transport in meandering open channels we first validated the 3d rans model integrated with the sst k ω turbulence closure approach by comparing the model results with the experimental study chang 1971 and the flow model adequately reproduced the helical motion of secondary flows near the bend apex we used this validated flow model to explore the control of meander geometry sinuosity on open channel flow patterns across a wide range of sinuosity varying 1 03 2 42 as sinuosity increases the flow simulations revealed the following flow characteristics i the large discrepancy between the maximum and minimum streamwise velocities in the spanwise direction both largely deviated from the mean velocity ii the enhancement of the secondary flow whose intensity increases up to about 8 of the main stream velocity and shown to follow the power law relationship with rc w and iii the emergence of the horizontal recirculating flows in the vicinity of the apex outer banks when rc w 2 which corresponds to sinuosity larger than 1 5 these recirculation zones expand as sinuosity increases showing the power law relationships between hydrogeometric parameters reattachment length maximum width and maximum velocity and rc w the transport simulations using the 3d lpt model demonstrated that the combined effects of the horizontal recirculation zones and the secondary flows substantially govern anomalous transport in meandering open channels the secondary flows originated from the increase in channel sinuosity enhance transverse dispersion and bring particles towards the recirculation zones where the particle trapping effects considerably delay particle transport thereby resulting in the late breakthrough of the particles even if the secondary flows enhance the trapping effects of the flow recirculation this study shows that the recirculation zone plays a critical role in determining anomalous transport in meandering open channels this is demonstrated by various transport measures btc parameters of power law slope and truncated time changed dramatically with the emergence of the horizontal flow recirculation both the power law slope and truncated time showed two distinctive regimes depending on the existence of the recirculating flows also we found the evidence of the recirculation zone induced anomalous transport from the tortuosity of particle trajectories as sinuosity increases beyond the occurrence condition sinuosity 1 5 of the recirculation zones the number of the particles having large tortuosity increased significantly because of the circulating streamlines inside the recirculation zones a recent study showed that the interplay between helical secondary flows and recirculating flows can also induce reaction hot spots in confined channel flows lee and kang 2020 and this study can be extended to elucidate the effects of 3d flow characteristics on reactive transport in open channel systems we applied the smm to upscale particle transport and accurately predicted anomalous transport behaviors observed in the 3d lpt simulations this upscaled stochastic transport model was parameterized using a transition matrix which encodes the lagrangian velocity distribution and spatial velocity correlation properties derived from the simulated particle trajectories this markovian transition matrix effectively captured the strong trapping effects by the recirculation zones and the effects of preferential flows the transition matrix of sn242 showed the strong correlation for both small and large transition times which arise from the preferential flows and the recirculating flows respectively the smm successfully reproduced the btcs obtained from the numerical simulations by capturing the mechanisms of recirculation zone induced anomalous transport via the lagrangian velocity statistics in this study we paramterized the smm using the particle tracking simulation data even though the focus of the present work is not to efficiently parameterize the smm but to evaluate the applicability of the smm in meandering rivers the efficient parameteration of the smm is practically important sherman et al 2017 hence the parameter estimation of the smm from river hydraulic or topographic data should be an important next step in summary this study reveals that the sinuosity driven recirculating flows exert dominant control over anomalous transport in meandering open channel flows and shows that the smm can effectively upscale the underlying transport mechanisms we highlight that the present work is the first successful application of the smm to the reach scale meandering open channels as aforementioned however we considerd the flat and smooth bed conditions and streambed topology controlled by sediment transport can play a vital role in determining the thalweg patterns and resulting flow properties such as secondary flows and recirculating flows in meandering rivers abad and garcia 2009b blanckaert 2010 termini and piraino 2011 therefore various channel bed morphologies that honor erosional and depositional processes of sediment beds should be considered in a future study the combined effects of sinuosity and channel morphodynamics on anomalous transport is an important next step furthermore in stream vegetation and hyporheic zone widely recognized as sources of anomalous transport in surface waters are other essential factors to be considered stonedahl et al 2012 aubeneau et al 2014 rubol et al 2016 yang et al 2016 sherman et al 2019b nevertheless the main findings of this study provide key insights regarding the mechanisms of anomalous transport in rivers and streams because the meandering channel geometry sinuosity is ubiquitous in riverine environments and should exert first order control on flow and transport credit authorship contribution statement jun song kim conceptualization methodology software investigation formal analysis writing original draft visualization il won seo writing review editing donghae baek methodology software visualization validation writing review editing project administration peter k kang conceptualization methodology writing review editing supervision project administration funding acquisition declaration of competing interest none acknowledgments jsk and pkk acknowledge the college of science engineering at the university of minnesota and the george and orpha gibson endowment and a grant from korea environment industry and technology institute keiti through subsurface environmental management sem project funded by the korea ministry of environment moe 2018002440003 iws and db also acknowledge support from the institute of engineering research and institute of construction and environmental engineering in seoul national university seoul south korea we thank the minnesota supercomputing institute msi at the university of minnesota for computational resources and support supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2020 103603 appendix supplementary materials image application 1 
