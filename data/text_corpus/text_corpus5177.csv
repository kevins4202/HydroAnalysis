index,text
25885,it is common for model based simulations to be reported using prediction interval estimates that characterize the lack of precision associated with the simulated values when based on monte carlo sampling to approximate the relevant probability density function s such estimates can significantly underestimate the width of the prediction intervals unless the sample size is sufficiently large using theoretical arguments supported by numerical experiments we discuss the nature and severity of this problem and demonstrate how better estimates of prediction intervals can be achieved by adjusting the interval width to account for the size of the sample used in its construction our method is generally applicable regardless of the form of the underlying probability density function and can be particularly useful when the model is expensive to run and large samples are not available we illustrate its use via a simple example involving conceptual modeling of the rainfall runoff response of a catchment keywords prediction intervals sampling variability uncertainty precision monte carlo simulation estimation 1 introduction it is common for simulations or predictions made using dynamical environmental system models desms to be presented in the form of best estimates accompanied by 95 or 90 or 99 etc prediction intervals pis see fig 1 a the pis are typically indicated by reporting the positions of the 2 5 and 97 5 quantiles of the probability density function pdf characterizing the lack of precision uncertainty associated with the model simulated value cho et al 2016 hassan et al 2009 hirsch et al 2015 inam et al 2017 roy et al 2017 2018 yang 2011 throughout this paper we use the term prediction interval to refer to prediction uncertainty and the term confidence interval to represent uncertainty in some estimated quantity in many cases the reported pis are estimated via the use of monte carlo sampling to approximate the form of the relevant pdf random samples are typically drawn from either the input space nikishova et al 2017 or parameter space wagener and kollat 2007 or both and used to generate an ensemble of model simulations from which the pis are then calculated the advantage of monte carlo based methods is that they help us to better understand model behaviors sensitivities and uncertainties wagener and kollat 2007 more detailed methods also premised on monte carlo sampling have been proposed ajami et al 2007 stedinger et al 2008 yang et al 2018 monte carlo based methods for estimating quantiles have been examined by the non hydrology literature e g linnet 2000 sun and lahiri 2006 bulter et al 2017 and references therein where it has been shown that if the cumulative distribution function cdf is differentiable and has a positive derivative at a population quantile the sample quantile will be asymptotically normal further for this case the centered and scaled sample quantile z n n f n 1 p f 1 p will converge to a standard normal distribution with zero mean and a variance of p 1 p f 2 f 1 p in the limiting case n where f is the pdf sun and lahiri 2006 here f n 1 is the sample quantile estimator f 1 is the theoretical quantile p is the non exceedance probability and n is the sample size one of the crucial considerations in monte carlo sampling is the size of the sample in section 3 we show that for smaller sample sizes these methods will typically underestimate the width of the pi due to unavoidable considerations of sampling variability through theoretical arguments supported by numerical experiments we investigate and demonstrate the nature and severity of this problem and its relationship to sample size we also demonstrate how a better more representative estimate of the pi can be achieved by adjusting its width to account for the size of the sample used section 4 in section 5 we briefly illustrate the application of this approach to streamflow uncertainty estimation via hydrological modeling of a catchment 2 computing the quantiles of a probability distribution function quantiles of a density function f x x are points along the variable axis that divide the range of the pdf into contiguous intervals having equal probability mass fig 1b a quantile is defined as the value x z such that the cumulative density function cdf f x x z x z f x x dx z 100 meaning that z of the total probability mass of f x x lies to the left of x z on the variable axis i e in the region x x z for an unbounded distribution where z is the non exceedance probability nep so for a uniform distribution f x x u a b having constant probability 1 b a on a x b and zero probability everywhere else the set of quantiles x 1 x 2 x 99 partitions the range a b into 100 intervals of equal width δx b a 100 more generally for non uniform distributions such as the gaussian f x x n μ σ that has non zero probability everywhere on the quantiles x 1 x 2 x 99 will not be equally spaced since larger spacings are associated with regions of lower probability density and vice versa in general when reporting pis of a pdf it is common to be interested in quantiles such as x 2 5 x 97 5 that correspond to the 95 probability density region i e 97 5 2 5 95 similarly one could instead be interested in 90 x 5 x 95 or 99 x 0 5 x 99 5 probability density regions etc without loss of generality except for very highly skewed distributions the discussion presented here will focus on the 95 high probability density region characterized by x 2 5 x 97 5 when the actual mathematical form of the underlying f x x is known a quantile x z is readily computed by finding the value for which the cumulative density f x x z z 100 however when working with desms the mathematical form f x x associated with x e g simulated streamflow is typically not known instead it is common to generate a set x x 1 x 2 x n of n equally likely random samples x j j 1 n that taken together are representative of informative about the unknown underlying pdf an empirical estimate f ˆ x x the hat is used to denote an estimate of the cumulative density f x x is then constructed from which estimates of the desired quantiles x 2 5 x 97 5 can be determined fig 1b shows an example of how the quantiles are calculated from a cdf 3 uncertainty associated with sample based estimates of the quantiles it is important to note that since many possible equally likely sets x i x 1 i x 2 i x n i can be randomly generated i represents realizations via monte carlo sampling there can be many possible estimates f ˆ x x i of the cdf and hence many possible corresponding estimates of the quantiles x ˆ 2 5 i x ˆ 97 5 i in other words any estimate of quantile x z i is a statistic having its own sampling distribution f x z x ˆ z where the statistical properties of the distribution depend on both the form of the unknown parent distribution and the sample size used to construct it fig 2 illustrates these facts for three different theoretical probability density functions the standard normal n 0 1 gamma g 2 2 and uniform u 0 10 the top and bottom rows correspond to sample sizes n 100 and n 1 000 respectively in each subplot the black line indicates the theoretical form of the associated cdf while the grey lines indicate r 10 000 different randomly generated estimates of the cdf hereafter called realizations on each plot we indicate the theoretical positions of x 2 5 x 50 x 97 5 and present frequency histograms of the 10 000 realizations obtained for each of these quantiles fig 2 illustrates several points 1 due to sampling variability the different realizations of the estimated cdfs are distributed randomly about the actual cdf 2 the precision of the distribution of estimated cdfs improves variance decreases with increasing sample size n compare top and bottom rows 3 the precision of the distribution of estimated cdfs is better smaller variance in regions where the cdf has steeper slope larger probability density and near bounding values e g the gamma density is bounded below by 0 and the uniform density is bounded both above and below at 0 10 4 conversely the precision of the distribution of estimated cdfs is worse larger variance in regions where the theoretical cdf has shallower slope smaller probability density these correspond to regions that are several standard deviations away from the mean of the normal density and to regions towards the unbounded right side of the gamma density 5 the distributions of the estimated quantiles are skewed towards regions of higher density for example for the gamma density top row 2nd column the mirror image of the distribution of estimates of x 97 5 is skewed towards the right the implication of these results is that the estimates x ˆ 2 5 x ˆ 97 5 generated via a single monte carlo realization can be highly imprecise particularly when n is small this is because the theoretical and hence actual probability of generating sample values near the unbounded extremes of a pdf becomes progressively smaller as we move towards lower probability regions fig 3 a shows for a standard normal density how the 95 confidence intervals of the quantiles from sample mean subtracted realizations vary with the sample size for neps between 0 15 and 0 85 corresponding to relatively high probability density regions the interval is fairly constant however the width increases rapidly outside of this area i e in low probability density regions near the extremes of the pdf so the precision of estimates x ˆ 2 5 x ˆ 97 5 generated using single realizations of samples generated from the underlying pdf can be extremely poor particularly for smaller sample sizes fig 3b shows for the standard normal density how the confidence intervals of three quantile estimates vary with the logarithm of sample size with precision increasing rapidly up to a sample size of 10 3 or 10 4 beyond which there is still improvement but not as significant as before note that although the plots show results for n 25 we need a minimum of n 100 2 5 1 39 sample points to actually estimate x ˆ 2 5 and x ˆ 97 5 or else we must extrapolate or arbitrarily specify two additional values to represent extreme points of the range of x similarly 90 cis require a minimum of n 100 5 1 19 sample points to estimate x ˆ 5 and x ˆ 95 and 99 cis require a minimum of n 100 0 5 1 199 sample points to estimate x ˆ 0 5 and x ˆ 99 5 these results imply that the monte carlo based estimates of pis will tend to be unreliable unless we are careful to use sufficiently large sample sizes fig 3c shows for the standard normal density how the confidence interval of the 95 prediction interval width wx ˆ 95 x ˆ 97 5 x ˆ 2 5 improves with the logarithm of sample size converging towards the theoretical value wx 95 2 1 96 3 92 for small samples sizes such as n 100 the uncertainty in pi width can be as large as 38 and for n 1 000 the uncertainty is still about 13 the smaller sample sizes are also associated with slight negative bias 4 accounting for uncertainty in the estimated quantiles given that the pis estimated using a single monte carlo realization are subject to sampling variability it would make sense to take this factor into account when reporting the precision associated with a model simulated variable x e g simulated streamflow one way to acknowledge the imprecision in the estimate a hat is used to denote an estimate of quantile x z is to compute the quantile y z x ˆ z associated with the quantile of interest i e to take into consideration the sampling uncertainty associated with the estimate of the quantile what might be thought of as second order uncertainty in other words we inflate the width of pi from wx 95 x 97 5 x 2 5 to the adjusted value wy 95 adj y 97 5 x 97 5 y 2 5 x 2 5 hereafter we will refer to these as adjusted pis fig 3d e shows how these adjusted pis compare with their theoretical counterparts for the un skewed normal n 4 2 and skewed gamma g 2 2 density functions note that even though wx 95 and wy 95 adj both represent prediction intervals the latter is derived from the confidence intervals cis of the prediction bounds since these bounds are themselves estimated entities also the z value selected for y need not necessarily be the same as the z value mean subtracted value normalized by the standard deviation selected for x in fact the z value applied to the upper bound could be any nep above 50 and for the lower bound it could be any value below 50 since that would result in a degree of inflation in this study we have used 97 5 and 2 5 z values for both x and y because of their widespread use one interesting aspect of this inflation approach is that the appropriate adjustments only need to be computed once for each sample size and can be done in a way that is independent of the actual form of the underlying pdf this is because the adjustments are performed in the nep space as opposed to the variable space and the neps are by definition unit interval uniform regardless of the form of the underlying distribution once the required adjustments are made the inflated pis can be calculated empirically from the data here we derive the adjustments assuming a gaussian density function n μ σ for the form of the distribution of the quantiles subject to sampling variability where the statistical precision of the estimate of the mean μ varies in a manner proportional to σ n fig 4 shows as dashed lines the theoretical widths of the 90 95 and 99 pis wx 90 3 29 wx 95 3 92 wx 99 5 15 the dots indicate the empirically computed adjusted widths associated with different sample sizes based on 10 000 realizations of each and the solid lines show the fitted theoretical curve μ k z σ n here μ represents the theoretical widths σ 1 case of standard normal and k z is the fitting coefficient the values of which were computed to be k 90 9 213 z 90 k 95 5 031 z 95 and k 99 4 077 z 99 by least squared fitting of the theoretical curve to the empirically computed data so for the lower 2 5 and upper 97 5 non exceedance probabilities we have the adjusted quantiles x 2 5 adj x 2 5 k 95 n and x 97 5 adj x 97 5 k 95 n on the x axis of the distribution function in general this can be expressed as 1 x z adj x z sign x z μ k z n where sign x z μ is 1 0 for x z μ and 1 0 for x z μ writing the equation in standardized form we get 2 x z adj μ σ x z μ σ sign x z μ k z n now what remains is to translate from the adjusted quantiles x z adj to the corresponding adjusted non exceedance probabilities z adj as follows for any gaussian density the theoretical relationship between the quantile x z on the variable axis and its corresponding non exceedance probability z is given by 3 z 1 2 1 erf 1 2 x z μ σ 100 where erf refers to the error function substituting for x z adj from equation 3 we have 4 z adj 1 2 1 erf 1 2 x z μ σ sign x z μ k z n 100 having computed z adj the corresponding adjusted quantile x z adj is obtained by finding the value of x that corresponds to the non exceedance probability z adj on the empirical cdf of the variable x for convenience table 1 lists the adjusted inflated non exceedance probabilities to be used for various sample sizes when accounting for the lack of precision in the estimated 95 pis to reiterate these adjusted non exceedance probabilities can be used for any form of probability density function theoretical or empirical to evaluate this claim we ran a test comparing results for the normal n 4 2 gamma g 2 2 density functions which both have the same mean μ 4 and obtained results that are consistent to within numerical precision to summarize our method is conceptually very simple once a set of n independent equally likely samples is available the steps are a using the samples construct the empirical cdf b select the non exceedance probabilities z lower and z upper relevant to the desired prediction interval c compute the adjusted non exceedance probabilities z lower adj and z upper adj to account for the sample size n using equation 3 d compute the corresponding adjusted quantiles x lower adj and x upper adj by projecting z lower adj and z upper adj through the empirical cdf e report the adjusted prediction interval as the range x lower adj x upper adj 5 illustration of application to streamflow estimation via hydrological modeling we illustrate the use of adjusted prediction intervals for the case of streamflow estimation using the conceptual catchment model hymod boyle et al 2000 and the leaf river mississippi data which has been extensively used in several previous studies e g brazil and hudlow 1981 gong et al 2013 moradkhani et al 2005 sorooshian et al 1983 the model has five adjustable parameters which can vary within ranges specified by the user given the hydrologic model m x θ generating the output x and the marginal distributions of the parameter vector θ assuming inter parameter independence our purpose is to estimate the distribution and more specifically the 95 prediction interval of the model simulations using the monte carlo approach we independently and uniformly sampled n 106 parameter locations in the five parameter space and created 106 unique parameter sets to run the model 106 times we treat these results as our theoretical sample the model was run for two consecutive years and the first year of simulated streamflow values were discarded to remove the spin up effect from this sample set we computed the 2 5 and 97 5 quantiles of streamflow at each time step and assumed these to represent the theoretical quantiles of the associated time varying probability density functions i e the time varying 95 pis on streamflow of course with larger sample sizes the accuracy of these will improve but the selected number seems adequate for the purpose of this illustrative example next we resampled the theoretical sample to design various representative cases we considered different sample sizes from small to large 25 50 100 500 1 000 5 000 and 10 000 and generated 1000 realizations for each case for example for the 100 sample case we resampled the first 100 1000 100 000 simulation points from the theoretical sample and so on for each realization we computed the 2 5 and 97 5 quantiles the estimated 95 pi and then used equation 4 to compute the corresponding adjusted quantiles the adjusted 95 pi then we counted how often the estimated and adjusted prediction intervals contained the theoretically true intervals obtained via higher density sampling with n 106 specifically we counted how often 1 the upper bound is contained but lower bound is not contained 2 the lower bound is contained but upper bound is not contained 3 neither of the bounds is contained and 4 both of the bounds are contained in the first and second cases the pi is biased towards higher and lower values respectively in the third case the width of the pi is underestimated in the fourth case we have a conservative estimate of the pi the results are as follows before adjustment the estimated pis based on n 100 samples contained the theoretical pi in only 21 of the cases whereas after adjustment the probability of inclusion increases to 82 meanwhile the percentage when neither of the bounds is contained decreased from 30 to only 1 when we used n 1000 samples the probability of inclusion increased from 23 before to 91 after adjustment while the probability that neither of the bounds is contained decreased from 26 to only 0 2 fig 5 demonstrates how the distribution of the adjustments changes with sample size as we have shown the quantile estimates for small sample sizes can be highly uncertain in which case we would want a large degree of inflation of the bound as shown by the figure the variance of the ratio is quite high for smaller sample sizes and the mean of the ratio deviates significantly from 1 as the sample size increases the mean of the ratio approaches 1 and the variance decreases 6 discussion we have examined the effects of sampling variability on the estimates of prediction intervals computed for an uncertain quantity e g streamflow when the underlying theoretical pdf is not known and is instead approximated via monte carlo sampling in particular we have investigated the implications of sample sizes such as those commonly used by modelers that are not large enough to adequately represent be properly informative about the underlying form of the parent pdf our analysis shows that prediction intervals e g 95 estimated using a single sample drawn from the parent population can be quite imprecise for sample sizes smaller than n 1 000 our results indicate that precise estimates of the 95 prediction intervals require sample sizes of 10 000 or larger but sizes above 1000 may be considered acceptable for one dimensional pdfs more importantly it is possible to compensate for this lack of precision by adjusting the width of the prediction interval to account for the sample size and associated sampling variability for example as indicated in table 1 when n 100 one should use z 98 6 instead of 95 for a 95 ci and when n 1 000 one should use 96 6 more generally equation 4 can be used to compute adjusted quantiles for any desired prediction interval and sample size this approach is generally applicable regardless of the known or unknown form of the underlying generating pdf a simple but practical case of streamflow estimation by conceptual catchment modeling has been used to illustrate the approach as a strong caveat our approach assumes that all of the samples are independent draws coming from the same underlying stationary parent probability density when such is not the case then there can be other serious problems associated with pi estimation that are not necessarily related to the sample size such problems are common to many methods for pi estimation reported in the literature and require different solutions not discussed here conversely when the probability densities associated with model simulated variables are represented by multiple independent traces trajectories through time our approach may be considered particularly suitable although the shape and extent of the underlying probability density of the model generated simulated variables will generally vary with time the samples of underlying causal factors e g model parameters sampled from a joint distribution are often independent equally likely samples drawn from a fixed parent density further when the cost of running the dynamic simulation model for a single point in the parameter space is expensive e g for spatially distributed land surface models methods such as ours that facilitate the use of smaller sample sizes can be particularly useful in such cases the main issue is to take care that the high dimensional joint density of underlying causal factors e g joint parameter distribution is sufficiently well sampled that the lower dimensional conditional density of the simulated variable s e g estimated streamflow is adequately described by the samples of simulated variable traces generated therefrom an example application where the proposed method would be useful is ensemble streamflow forecasting in this case the monte carlo sample size is limited by the size of the available inputs which are treated as random variables the sample size in this case rarely exceeds 100 and therefore the estimated prediction intervals could be highly biased unless the proposed corrections are incorporated of course it is possible that the proposed correction procedure could sometimes lead to conservative estimates of the interval however the goal of this paper is to demonstrate how the prediction bounds should be adjusted to account for sampling variability such that we can avoid a false sense of confidence 7 conclusions the effects of sampling variability can significantly affect the estimation of prediction intervals with significant implications to hydrologic applications especially when using small monte carlo sample sizes in this study we propose and demonstrate a method for adjusting the width of the prediction intervals to compensate for small sample sizes the method is easy to implement and effectively accounts for the unavoidable effects of sampling variability by proper adjustment of the prediction interval we obtain a more realistic estimate of overall uncertainty in the model output space thereby enabling a better assessment of the underlying risk future research will focus on optimizing the proposed degree of inflation to make sure that the interval is not too conservative as always we invite discussion and collaboration on this and other issues related to desm identification and use declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the second author acknowledges partial support by the australian centre of excellence for climate system science ce110001028 data and codes used in this study are available upon request from the authors 
25885,it is common for model based simulations to be reported using prediction interval estimates that characterize the lack of precision associated with the simulated values when based on monte carlo sampling to approximate the relevant probability density function s such estimates can significantly underestimate the width of the prediction intervals unless the sample size is sufficiently large using theoretical arguments supported by numerical experiments we discuss the nature and severity of this problem and demonstrate how better estimates of prediction intervals can be achieved by adjusting the interval width to account for the size of the sample used in its construction our method is generally applicable regardless of the form of the underlying probability density function and can be particularly useful when the model is expensive to run and large samples are not available we illustrate its use via a simple example involving conceptual modeling of the rainfall runoff response of a catchment keywords prediction intervals sampling variability uncertainty precision monte carlo simulation estimation 1 introduction it is common for simulations or predictions made using dynamical environmental system models desms to be presented in the form of best estimates accompanied by 95 or 90 or 99 etc prediction intervals pis see fig 1 a the pis are typically indicated by reporting the positions of the 2 5 and 97 5 quantiles of the probability density function pdf characterizing the lack of precision uncertainty associated with the model simulated value cho et al 2016 hassan et al 2009 hirsch et al 2015 inam et al 2017 roy et al 2017 2018 yang 2011 throughout this paper we use the term prediction interval to refer to prediction uncertainty and the term confidence interval to represent uncertainty in some estimated quantity in many cases the reported pis are estimated via the use of monte carlo sampling to approximate the form of the relevant pdf random samples are typically drawn from either the input space nikishova et al 2017 or parameter space wagener and kollat 2007 or both and used to generate an ensemble of model simulations from which the pis are then calculated the advantage of monte carlo based methods is that they help us to better understand model behaviors sensitivities and uncertainties wagener and kollat 2007 more detailed methods also premised on monte carlo sampling have been proposed ajami et al 2007 stedinger et al 2008 yang et al 2018 monte carlo based methods for estimating quantiles have been examined by the non hydrology literature e g linnet 2000 sun and lahiri 2006 bulter et al 2017 and references therein where it has been shown that if the cumulative distribution function cdf is differentiable and has a positive derivative at a population quantile the sample quantile will be asymptotically normal further for this case the centered and scaled sample quantile z n n f n 1 p f 1 p will converge to a standard normal distribution with zero mean and a variance of p 1 p f 2 f 1 p in the limiting case n where f is the pdf sun and lahiri 2006 here f n 1 is the sample quantile estimator f 1 is the theoretical quantile p is the non exceedance probability and n is the sample size one of the crucial considerations in monte carlo sampling is the size of the sample in section 3 we show that for smaller sample sizes these methods will typically underestimate the width of the pi due to unavoidable considerations of sampling variability through theoretical arguments supported by numerical experiments we investigate and demonstrate the nature and severity of this problem and its relationship to sample size we also demonstrate how a better more representative estimate of the pi can be achieved by adjusting its width to account for the size of the sample used section 4 in section 5 we briefly illustrate the application of this approach to streamflow uncertainty estimation via hydrological modeling of a catchment 2 computing the quantiles of a probability distribution function quantiles of a density function f x x are points along the variable axis that divide the range of the pdf into contiguous intervals having equal probability mass fig 1b a quantile is defined as the value x z such that the cumulative density function cdf f x x z x z f x x dx z 100 meaning that z of the total probability mass of f x x lies to the left of x z on the variable axis i e in the region x x z for an unbounded distribution where z is the non exceedance probability nep so for a uniform distribution f x x u a b having constant probability 1 b a on a x b and zero probability everywhere else the set of quantiles x 1 x 2 x 99 partitions the range a b into 100 intervals of equal width δx b a 100 more generally for non uniform distributions such as the gaussian f x x n μ σ that has non zero probability everywhere on the quantiles x 1 x 2 x 99 will not be equally spaced since larger spacings are associated with regions of lower probability density and vice versa in general when reporting pis of a pdf it is common to be interested in quantiles such as x 2 5 x 97 5 that correspond to the 95 probability density region i e 97 5 2 5 95 similarly one could instead be interested in 90 x 5 x 95 or 99 x 0 5 x 99 5 probability density regions etc without loss of generality except for very highly skewed distributions the discussion presented here will focus on the 95 high probability density region characterized by x 2 5 x 97 5 when the actual mathematical form of the underlying f x x is known a quantile x z is readily computed by finding the value for which the cumulative density f x x z z 100 however when working with desms the mathematical form f x x associated with x e g simulated streamflow is typically not known instead it is common to generate a set x x 1 x 2 x n of n equally likely random samples x j j 1 n that taken together are representative of informative about the unknown underlying pdf an empirical estimate f ˆ x x the hat is used to denote an estimate of the cumulative density f x x is then constructed from which estimates of the desired quantiles x 2 5 x 97 5 can be determined fig 1b shows an example of how the quantiles are calculated from a cdf 3 uncertainty associated with sample based estimates of the quantiles it is important to note that since many possible equally likely sets x i x 1 i x 2 i x n i can be randomly generated i represents realizations via monte carlo sampling there can be many possible estimates f ˆ x x i of the cdf and hence many possible corresponding estimates of the quantiles x ˆ 2 5 i x ˆ 97 5 i in other words any estimate of quantile x z i is a statistic having its own sampling distribution f x z x ˆ z where the statistical properties of the distribution depend on both the form of the unknown parent distribution and the sample size used to construct it fig 2 illustrates these facts for three different theoretical probability density functions the standard normal n 0 1 gamma g 2 2 and uniform u 0 10 the top and bottom rows correspond to sample sizes n 100 and n 1 000 respectively in each subplot the black line indicates the theoretical form of the associated cdf while the grey lines indicate r 10 000 different randomly generated estimates of the cdf hereafter called realizations on each plot we indicate the theoretical positions of x 2 5 x 50 x 97 5 and present frequency histograms of the 10 000 realizations obtained for each of these quantiles fig 2 illustrates several points 1 due to sampling variability the different realizations of the estimated cdfs are distributed randomly about the actual cdf 2 the precision of the distribution of estimated cdfs improves variance decreases with increasing sample size n compare top and bottom rows 3 the precision of the distribution of estimated cdfs is better smaller variance in regions where the cdf has steeper slope larger probability density and near bounding values e g the gamma density is bounded below by 0 and the uniform density is bounded both above and below at 0 10 4 conversely the precision of the distribution of estimated cdfs is worse larger variance in regions where the theoretical cdf has shallower slope smaller probability density these correspond to regions that are several standard deviations away from the mean of the normal density and to regions towards the unbounded right side of the gamma density 5 the distributions of the estimated quantiles are skewed towards regions of higher density for example for the gamma density top row 2nd column the mirror image of the distribution of estimates of x 97 5 is skewed towards the right the implication of these results is that the estimates x ˆ 2 5 x ˆ 97 5 generated via a single monte carlo realization can be highly imprecise particularly when n is small this is because the theoretical and hence actual probability of generating sample values near the unbounded extremes of a pdf becomes progressively smaller as we move towards lower probability regions fig 3 a shows for a standard normal density how the 95 confidence intervals of the quantiles from sample mean subtracted realizations vary with the sample size for neps between 0 15 and 0 85 corresponding to relatively high probability density regions the interval is fairly constant however the width increases rapidly outside of this area i e in low probability density regions near the extremes of the pdf so the precision of estimates x ˆ 2 5 x ˆ 97 5 generated using single realizations of samples generated from the underlying pdf can be extremely poor particularly for smaller sample sizes fig 3b shows for the standard normal density how the confidence intervals of three quantile estimates vary with the logarithm of sample size with precision increasing rapidly up to a sample size of 10 3 or 10 4 beyond which there is still improvement but not as significant as before note that although the plots show results for n 25 we need a minimum of n 100 2 5 1 39 sample points to actually estimate x ˆ 2 5 and x ˆ 97 5 or else we must extrapolate or arbitrarily specify two additional values to represent extreme points of the range of x similarly 90 cis require a minimum of n 100 5 1 19 sample points to estimate x ˆ 5 and x ˆ 95 and 99 cis require a minimum of n 100 0 5 1 199 sample points to estimate x ˆ 0 5 and x ˆ 99 5 these results imply that the monte carlo based estimates of pis will tend to be unreliable unless we are careful to use sufficiently large sample sizes fig 3c shows for the standard normal density how the confidence interval of the 95 prediction interval width wx ˆ 95 x ˆ 97 5 x ˆ 2 5 improves with the logarithm of sample size converging towards the theoretical value wx 95 2 1 96 3 92 for small samples sizes such as n 100 the uncertainty in pi width can be as large as 38 and for n 1 000 the uncertainty is still about 13 the smaller sample sizes are also associated with slight negative bias 4 accounting for uncertainty in the estimated quantiles given that the pis estimated using a single monte carlo realization are subject to sampling variability it would make sense to take this factor into account when reporting the precision associated with a model simulated variable x e g simulated streamflow one way to acknowledge the imprecision in the estimate a hat is used to denote an estimate of quantile x z is to compute the quantile y z x ˆ z associated with the quantile of interest i e to take into consideration the sampling uncertainty associated with the estimate of the quantile what might be thought of as second order uncertainty in other words we inflate the width of pi from wx 95 x 97 5 x 2 5 to the adjusted value wy 95 adj y 97 5 x 97 5 y 2 5 x 2 5 hereafter we will refer to these as adjusted pis fig 3d e shows how these adjusted pis compare with their theoretical counterparts for the un skewed normal n 4 2 and skewed gamma g 2 2 density functions note that even though wx 95 and wy 95 adj both represent prediction intervals the latter is derived from the confidence intervals cis of the prediction bounds since these bounds are themselves estimated entities also the z value selected for y need not necessarily be the same as the z value mean subtracted value normalized by the standard deviation selected for x in fact the z value applied to the upper bound could be any nep above 50 and for the lower bound it could be any value below 50 since that would result in a degree of inflation in this study we have used 97 5 and 2 5 z values for both x and y because of their widespread use one interesting aspect of this inflation approach is that the appropriate adjustments only need to be computed once for each sample size and can be done in a way that is independent of the actual form of the underlying pdf this is because the adjustments are performed in the nep space as opposed to the variable space and the neps are by definition unit interval uniform regardless of the form of the underlying distribution once the required adjustments are made the inflated pis can be calculated empirically from the data here we derive the adjustments assuming a gaussian density function n μ σ for the form of the distribution of the quantiles subject to sampling variability where the statistical precision of the estimate of the mean μ varies in a manner proportional to σ n fig 4 shows as dashed lines the theoretical widths of the 90 95 and 99 pis wx 90 3 29 wx 95 3 92 wx 99 5 15 the dots indicate the empirically computed adjusted widths associated with different sample sizes based on 10 000 realizations of each and the solid lines show the fitted theoretical curve μ k z σ n here μ represents the theoretical widths σ 1 case of standard normal and k z is the fitting coefficient the values of which were computed to be k 90 9 213 z 90 k 95 5 031 z 95 and k 99 4 077 z 99 by least squared fitting of the theoretical curve to the empirically computed data so for the lower 2 5 and upper 97 5 non exceedance probabilities we have the adjusted quantiles x 2 5 adj x 2 5 k 95 n and x 97 5 adj x 97 5 k 95 n on the x axis of the distribution function in general this can be expressed as 1 x z adj x z sign x z μ k z n where sign x z μ is 1 0 for x z μ and 1 0 for x z μ writing the equation in standardized form we get 2 x z adj μ σ x z μ σ sign x z μ k z n now what remains is to translate from the adjusted quantiles x z adj to the corresponding adjusted non exceedance probabilities z adj as follows for any gaussian density the theoretical relationship between the quantile x z on the variable axis and its corresponding non exceedance probability z is given by 3 z 1 2 1 erf 1 2 x z μ σ 100 where erf refers to the error function substituting for x z adj from equation 3 we have 4 z adj 1 2 1 erf 1 2 x z μ σ sign x z μ k z n 100 having computed z adj the corresponding adjusted quantile x z adj is obtained by finding the value of x that corresponds to the non exceedance probability z adj on the empirical cdf of the variable x for convenience table 1 lists the adjusted inflated non exceedance probabilities to be used for various sample sizes when accounting for the lack of precision in the estimated 95 pis to reiterate these adjusted non exceedance probabilities can be used for any form of probability density function theoretical or empirical to evaluate this claim we ran a test comparing results for the normal n 4 2 gamma g 2 2 density functions which both have the same mean μ 4 and obtained results that are consistent to within numerical precision to summarize our method is conceptually very simple once a set of n independent equally likely samples is available the steps are a using the samples construct the empirical cdf b select the non exceedance probabilities z lower and z upper relevant to the desired prediction interval c compute the adjusted non exceedance probabilities z lower adj and z upper adj to account for the sample size n using equation 3 d compute the corresponding adjusted quantiles x lower adj and x upper adj by projecting z lower adj and z upper adj through the empirical cdf e report the adjusted prediction interval as the range x lower adj x upper adj 5 illustration of application to streamflow estimation via hydrological modeling we illustrate the use of adjusted prediction intervals for the case of streamflow estimation using the conceptual catchment model hymod boyle et al 2000 and the leaf river mississippi data which has been extensively used in several previous studies e g brazil and hudlow 1981 gong et al 2013 moradkhani et al 2005 sorooshian et al 1983 the model has five adjustable parameters which can vary within ranges specified by the user given the hydrologic model m x θ generating the output x and the marginal distributions of the parameter vector θ assuming inter parameter independence our purpose is to estimate the distribution and more specifically the 95 prediction interval of the model simulations using the monte carlo approach we independently and uniformly sampled n 106 parameter locations in the five parameter space and created 106 unique parameter sets to run the model 106 times we treat these results as our theoretical sample the model was run for two consecutive years and the first year of simulated streamflow values were discarded to remove the spin up effect from this sample set we computed the 2 5 and 97 5 quantiles of streamflow at each time step and assumed these to represent the theoretical quantiles of the associated time varying probability density functions i e the time varying 95 pis on streamflow of course with larger sample sizes the accuracy of these will improve but the selected number seems adequate for the purpose of this illustrative example next we resampled the theoretical sample to design various representative cases we considered different sample sizes from small to large 25 50 100 500 1 000 5 000 and 10 000 and generated 1000 realizations for each case for example for the 100 sample case we resampled the first 100 1000 100 000 simulation points from the theoretical sample and so on for each realization we computed the 2 5 and 97 5 quantiles the estimated 95 pi and then used equation 4 to compute the corresponding adjusted quantiles the adjusted 95 pi then we counted how often the estimated and adjusted prediction intervals contained the theoretically true intervals obtained via higher density sampling with n 106 specifically we counted how often 1 the upper bound is contained but lower bound is not contained 2 the lower bound is contained but upper bound is not contained 3 neither of the bounds is contained and 4 both of the bounds are contained in the first and second cases the pi is biased towards higher and lower values respectively in the third case the width of the pi is underestimated in the fourth case we have a conservative estimate of the pi the results are as follows before adjustment the estimated pis based on n 100 samples contained the theoretical pi in only 21 of the cases whereas after adjustment the probability of inclusion increases to 82 meanwhile the percentage when neither of the bounds is contained decreased from 30 to only 1 when we used n 1000 samples the probability of inclusion increased from 23 before to 91 after adjustment while the probability that neither of the bounds is contained decreased from 26 to only 0 2 fig 5 demonstrates how the distribution of the adjustments changes with sample size as we have shown the quantile estimates for small sample sizes can be highly uncertain in which case we would want a large degree of inflation of the bound as shown by the figure the variance of the ratio is quite high for smaller sample sizes and the mean of the ratio deviates significantly from 1 as the sample size increases the mean of the ratio approaches 1 and the variance decreases 6 discussion we have examined the effects of sampling variability on the estimates of prediction intervals computed for an uncertain quantity e g streamflow when the underlying theoretical pdf is not known and is instead approximated via monte carlo sampling in particular we have investigated the implications of sample sizes such as those commonly used by modelers that are not large enough to adequately represent be properly informative about the underlying form of the parent pdf our analysis shows that prediction intervals e g 95 estimated using a single sample drawn from the parent population can be quite imprecise for sample sizes smaller than n 1 000 our results indicate that precise estimates of the 95 prediction intervals require sample sizes of 10 000 or larger but sizes above 1000 may be considered acceptable for one dimensional pdfs more importantly it is possible to compensate for this lack of precision by adjusting the width of the prediction interval to account for the sample size and associated sampling variability for example as indicated in table 1 when n 100 one should use z 98 6 instead of 95 for a 95 ci and when n 1 000 one should use 96 6 more generally equation 4 can be used to compute adjusted quantiles for any desired prediction interval and sample size this approach is generally applicable regardless of the known or unknown form of the underlying generating pdf a simple but practical case of streamflow estimation by conceptual catchment modeling has been used to illustrate the approach as a strong caveat our approach assumes that all of the samples are independent draws coming from the same underlying stationary parent probability density when such is not the case then there can be other serious problems associated with pi estimation that are not necessarily related to the sample size such problems are common to many methods for pi estimation reported in the literature and require different solutions not discussed here conversely when the probability densities associated with model simulated variables are represented by multiple independent traces trajectories through time our approach may be considered particularly suitable although the shape and extent of the underlying probability density of the model generated simulated variables will generally vary with time the samples of underlying causal factors e g model parameters sampled from a joint distribution are often independent equally likely samples drawn from a fixed parent density further when the cost of running the dynamic simulation model for a single point in the parameter space is expensive e g for spatially distributed land surface models methods such as ours that facilitate the use of smaller sample sizes can be particularly useful in such cases the main issue is to take care that the high dimensional joint density of underlying causal factors e g joint parameter distribution is sufficiently well sampled that the lower dimensional conditional density of the simulated variable s e g estimated streamflow is adequately described by the samples of simulated variable traces generated therefrom an example application where the proposed method would be useful is ensemble streamflow forecasting in this case the monte carlo sample size is limited by the size of the available inputs which are treated as random variables the sample size in this case rarely exceeds 100 and therefore the estimated prediction intervals could be highly biased unless the proposed corrections are incorporated of course it is possible that the proposed correction procedure could sometimes lead to conservative estimates of the interval however the goal of this paper is to demonstrate how the prediction bounds should be adjusted to account for sampling variability such that we can avoid a false sense of confidence 7 conclusions the effects of sampling variability can significantly affect the estimation of prediction intervals with significant implications to hydrologic applications especially when using small monte carlo sample sizes in this study we propose and demonstrate a method for adjusting the width of the prediction intervals to compensate for small sample sizes the method is easy to implement and effectively accounts for the unavoidable effects of sampling variability by proper adjustment of the prediction interval we obtain a more realistic estimate of overall uncertainty in the model output space thereby enabling a better assessment of the underlying risk future research will focus on optimizing the proposed degree of inflation to make sure that the interval is not too conservative as always we invite discussion and collaboration on this and other issues related to desm identification and use declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements the second author acknowledges partial support by the australian centre of excellence for climate system science ce110001028 data and codes used in this study are available upon request from the authors 
25886,this paper describes a post processing tool included in the globally used swat model for desktop assessment of environmental flows the tool uses daily flow data from swat outputs and can apply different methodologies based on percentiles or moving averages to assess environmental flows this tool included in the visualization section of the swat model is open source and can therefore be readily expanded to include additional methodologies the features and capabilities of this tool are demonstrated through an application to the eo river basin in the northwest of spain the impact of climate change on environmental flows was analyzed obtaining reductions in environmental flows significantly greater than those of average flows mainly as a result of the increase in the variability of the daily flow series this tool can help policymakers and scientists with rapid preliminary assessment of environmental flows keywords swat model environmental flows moving averages percentiles eo river climate change software availability the qswat code is the qgis 3 plugin for generating inputs for swat code on the swat model website https swat tamu edu software plus it is open source and available for download and code modification language python software name post processing tool of qswat developers javier senent aparicio chris george and raghavan srinivasan system requirements windows programming language python software required qgis source code available bitbucket https bitbucket org chriswgeorge qswatplus3 src master 1 introduction the soil and water assessment tool swat model is a watershed scale and physically based model operating on a daily time step arnold et al 1998 it was developed to predict the impact of land management practices on water sediment and agricultural yields in large complex watersheds over long periods of time dile et al 2016 it has become one of the most widely used hydrologic models in the world and has been applied in many watersheds across the globe gassman et al 2007 as can be seen in the swat literature database swatpubdatabase 2020 as of july 2020 a total of 4000 peer reviewed swat model applications have been published in scientific journals due to the open source nature of swat improvements to the swat algorithm and its modules is an ongoing process guided by the needs of the growing worldwide user community merwade et al 2017 in the past few years and to face present and future challenges in water resources modelling and management the swat code has undergone major modifications resulting in swat swat is a completely revised version of the model characterized by being more flexible than swat in terms of the spatial representation of interactions and processes within a watershed bieger et al 2017 one of the challenges faced by water planners and managers is the establishment of an environmental flow regime to make this task easier for swat users this tool was developed to calculate environmental flows efs using different hydrological methodologies the establishment of the ef regime in a river is a complex problem with important legal and socioeconomic implications and for which there are no common scientific technical criteria or a universally accepted operational methodological proposal however a fundamental assumption of ef research is the natural flow paradigm which states that the natural flow regime including natural fluctuations provides the optimum conditions for a river ecosystem poff et al 1997 the estimation of naturalized streamflows that represent the historical natural hydrology unaffected by human activities is fundamental to address different aspects of river basin management wurbs 2006 in basins subject to a high degree of anthropization hydrological models such as swat are a good option for determining the natural flow regime among the different types of existing methods for making ef recommendations a widespread approach is to base the environmental flow regime exclusively on the analysis of the record of flows observed in the area of interest without introducing other geomorphological or hydrobiological considerations this is based on the assumption that the flow record is a footprint that incorporates relevant environmental information of the affected ecosystem this type of method is called hydrological and is based on the series of flows in a natural regime according to tharme 2003 there are four basic types of ef methods hydrological hydraulic habitat simulation and holistic considered to be the hydrological methods most appropriate for water resources planning and management due to the fact that they are regarded as the simplest and most easily used to calculate ef these hydrological methods need as input data daily average flows under natural flow regimes which reduces data availability alcázar et al 2008 this data limitation is especially important in spain because gauging stations are scarce and usually located in the mainstream so they are usually impacted by water withdrawals diversions and reservoir operations belmar et al 2011 hence the need for the use of swat model to generate a database of long term daily flow records at many locations in large basins based on this dataset it would be very helpful to water resources managers to calculate environmental flows at several locations in a flexible and easy to use interface therefore the objective of this work is to present a new user friendly post processing tool included in the qgis interface of swat which can obtain different hydrological indexes related to efs and help users to evaluate the ef requirements based on swat outputs we first present how this tool was developed and what type of indexes have been included section 2 we then illustrate the features and capabilities of this tool through an application to the eo river basin in the northwest of spain to assess the impact of climate change on ef section 3 natural flow regimes are already shifting due to climate change and water management authorities will need to evaluate these changes poff 2018 2 post processing tool development 2 1 environmental flow methodologies that can be applied using the post processing tool according to poff et al 1997 the regulation of environmental processes in river ecosystems is based on five components magnitude frequency duration timing and rate of change of hydrologic conditions the tool presented in this study is based on the calculation of the minimum efs this is due to the fact that in semi arid and mediterranean areas this is the most critical component of efs because of the seasonal nature of dry and hot summers which leads to water shortages when the water demand is high aguilar and polo 2016 2 1 1 dqp methods or methods based on moving averages dqp methods start from the daily series of flows at the point of interest and depends on the number of days used to calculate moving averages d and the probability of no exceedance p these methods are based on the determination of the average flows of length d days that is not exceeded in p of the years to do this starting from the daily series of flows with n years of data series s 1 the series s1 of moving averages of order d applied to the daily flow q are obtained 2 the annual minimums are extracted from the series s1 obtaining a series s2 of length n years 3 the value corresponding to the percentile of p is obtained from s2 this value is the desired dqp value the percentile can be obtained non parametrically or parametrically adjusting a distribution to the data and obtaining the corresponding quantile in the post processing tool presented here percentiles are obtained non parametrically the tool allows the user to freely choose the values of the variables d and p which allows the calculation of several indices the most common of this set of methods is undoubtedly the 7q10 widely used since the early 1970s by u s agencies dealing with river pollution ames 2006 water quality was considered acceptable if the flow was equal to or greater than 7q10 given that in this initial use 7q10 was only related to the regulation and dilution of pollution in rivers its suitability for other objectives related to the protection of habitats or aquatic species is not proven although in any case it constitutes a fundamental reference in studies on minimum flows in addition to the 7q10 standard other dqp indices have been used for example in eastern european countries along with the 7q10 there are a variety of other 7q flows that can be calculated by the tool pyrce 2004 for example the ontario ministry of natural resources make use of 7q20 and 7q2 flows 7q20 is used as a conservative approach to ensure that sufficient streamflow is available to dilute point source discharges and 7q2 is used as the habitat maintenance flow moving averages of 1 day or 30 days are also used instead of 7 days karakoyoun 2018 recent work in spain and specifically in the tagus basin baeza et al 2005 has suggested the use of the lowest moving average of 25 days 25q as representative of the ef in a year the observation of a change of slope around step 25 in the low water graphs suggests the use of this order for the moving average and is what probably led to its suggested use in the spanish water planning instruction swpi as will be seen in the case study as well as suggesting the use of a minimum flow of 25q10 or 10 percentile applied to the annual series of these 25 day minimums unless the channel naturally dries up without resorting to percentiles but considering average values the 25qm method consists of obtaining the 25 day moving averages for each year and choosing their lowest value this gives the minimum series s2 of a size equal to the number of years whose arithmetic mean is the environmental flow note that instead of a percentile the average is used whose equivalent percentile is not fixed but depends on the distribution of the data this methodology was proposed by baeza sanz and garcía del jalón 2005 and can also be calculated using the post processing tool 2 1 2 qq methods or methods based on percentiles qq methods are based on the frequency analysis of the series approached by studying the percentiles of its daily flow duration curve they provide values similar to the dqp methods in which the period of the moving average becomes d 1 and the probability of exceedance q is complementary to that of no exceedance p the difference is that dqp obtains the quantiles from the annual minimum series and qq obtains them from the complete daily series the tool presented in this work allows the user to choose any percentile value although the most common minimum flows are q95 and q90 for example the uk australia taiwan and bulgaria apply q95 as a minimum standard whereas brazil and canada use q90 efstratiadis et al 2014 likewise different indicators related to the average monthly flows during the summer months have been used with daily data sorted by year the q347 and q355 methods are widely used the first is the basis of the swiss or matthey method in which a procedure is proposed based on the flow equaled or exceeded during 347 days a year if the complete series is used this value is equal to q95 and with annual minimums it is equal to 1q5 2 1 3 basic flow method qb the basic flow method was conceived and developed in spain palau and alcázar 2012 and has been applied in numerous rivers efstratiadis et al 2014 peñas et al 2014 herrera and burneo 2017 it is based on the study of moving averages of the daily flow time series seeking to recognize certain irregularities or discontinuities throughout the series which are associated with thresholds of environmental alteration of the fluvial system this methodology includes a set of indicators of which only the one called basic flow qb has been incorporated into this version of the post processing tool this flow is defined as the absolute minimum that must always be maintained in the channel the qb is calculated independently for each year using moving averages applied at increasing intervals of consecutive data daily average flows of order between 1 and 100 this limit is established on the basis that an average of 100 daily average flows already includes the low water period about 3 months over which the qb will most likely be defined the minimum of the moving average model applied to each increasing interval is identified then the qb value for each year is defined from the streamflow ending the longest flow period which is identified by the highest relative increment between two consecutive increasing intervals of minimum average flows alcázar and palau 2010 the final qb value is calculated as the mean of the individual qb values for every year taking into account that the period of analysis must be at least 10 years a more detailed description can be found in the work of palau and alcazar 2012 2 2 tool implementation the calculations of the efs qq dqp and qb are integrated into the post processing section of the visualization component of qswat they all depend on the daily channel output table which provides data including outflow in m3 s for every channel for every day in the simulation each ef method has a separate form offering a choice of subbasin internally converted into a choice of that subbasin s outflowing channel plus the other required parameters percentile start month and number of days for moving average as appropriate results are displayed in the form and can also be saved to an output file the coding is in python like the rest of qswat these calculations proved to run quickly so no special coding or use of packages such as numpy was necessary the algorithms are similar the data for the selected channel is read from the daily channel output table with a simple sql select statement into a suitable data structure for qq and qb this structure is a mapping from month to list of values for dqp it is a list of values for each year long period starting from the start month then qq for example is completed by sorting each month s list of values when a percentile translates immediately into a position on the list 3 application to the eo river basin for the purpose of demonstration in this paper the swat post processing tool was applied to the eo river basin nw spain to evaluate the impact of climate change on efs based on the swpi the characterization of the natural regime of a river needs representative hydrological series of at least 20 years with a balanced alternation between dry and wet years and the definition of moving averages methods and percentiles between the 5th and 15th percentile from the flow duration curve in this study and to cover the two criteria established by the swpi 25qm q85 and qb were evaluated in addition to the above environmental flow values two basic variables were studied that characterize the hydrological behavior of the hydrological series the average flow and the coefficient of variation cv which is the ratio of the standard deviation to average and is a measure of relative variability 3 1 study site the eo river basin located in the north of spain fig 1 as a physical frontier between the regions of asturias and galicia covers an area of 819 km2 and the total length of the main stream is 92 km being part of the western cantabric basin the basin elevation ranges between sea level and 1108 m a s l and has a relatively steep topography ninety five percent of the basin area presents slopes higher than 8 therefore plains are scarce and are mainly situated in the downstream areas pérez sánchez et al 2020 the annual mean rainfall in the eo river basin for the 1976 2005 period was 1295 mm and the average annual flow at san tirso de abres gauge station was 17 8 m3 s the historical average annual maximum and minimum temperature were 16 0 and 5 6 c respectively the eo river basin is characterized by its low population density and low level of urbanization and it does not support any significant industrial or intensive agriculture activities de paz et al 2008 due to its high environmental value more than 90 of the eo river basin area was declared a biosphere reserve by the united nations educational scientific and cultural organization unesco in 2007 3 2 swat model for the eo river basin 3 2 1 data and model setup the model input data included the digital elevation model dem of 25 m resolution from the national geographic institute of spain the land use map was derived from the reclassified corine land cover 1 50 000 and the 90 m resolution soil map extracted from the harmonized world soil database hwsd version 1 2 daily weather data including precipitation and maximum and minimum temperature were obtained from aemet and spain02 respectively these data were previously used satisfactorily for hydrological modelling in peninsular spain senent aparicio et al 2018a 2018b pérez sánchez et al 2019 in this study potential evapotranspiration was simulated using the hargreaves method hargreaves 1994 because it only requires maximum and minimum daily temperatures the basin was divided into 11 subbasins and discretized into 121 hydrological response units hrus landscape units lsus and channels landscape features were not considered to define the hrus and lsus 3 2 2 model calibration validation and performance evaluation manual calibration was performed from 1976 to 1990 by comparing observed and simulated daily discharges and the years 1991 2005 were used for the model validation in addition a five year 1971 1975 warm up period was used to minimize the impact of initial conditions on model simulations the nash sutcliffe efficiency nse kling gupta efficiency kge determination coefficient r2 and percent bias pbias were used as goodness of fit indicators for daily model simulations according to krause et al 2005 the nse is not suitable for low flow conditions because it overestimates larger values neglecting lower values due to the use of square of difference between simulated and observed streamflows to specifically evaluate the performance in the low flow simulation and to overcome the nse s oversensitivity to extreme values we used the logarithmic nash sutcliffe lnnse this transformation has been used in several previous studies chen et al 2018 osuch et al 2018 parra et al 2019 3 3 climate change scenarios after the swat model was calibrated and validated under current conditions the potential impact of climate change on environmental flows was analyzed in two different future periods the near future 2021 2050 and far future 2051 2080 for both rcp 4 5 and rcp 8 5 climate scenarios data for the climate change scenarios were extracted and prepared using the climate change toolkit cct as can be seen in table 1 this tool provides historical and future data from five different models gfdl esm2m hadgem2 es ipsl cm5a lr miroc and noeresm1 m as can be seen in fig 2 bias correction and spatial downscaling were carried out using a monthly additive correction factor temperature and a monthly multiplicative correction factor precipitation a more detailed cct process description is given by vaghefi et al 2017 3 4 results and discussion 3 4 1 swat model performance as can be seen in table 2 daily model performance using default values is fairly acceptable however lnnse results reflected poor performance of the low flows according to these results manual calibration was conducted using only three parameters the base flow alpha factor alpha bf was calculated using an automated digital filter program arnold and allen 1999 obtaining a value of 0 024 this program was previously used in many studies related to the swat model meaurio et al 2015 alpha bf gives the base flow recession constant factor and is an important parameter in the base flow estimation the soil evaporation compensation factor esco and lateral flow travel time lat ttime were manually calibrated in a trial and error process obtaining final values of 0 85 and 39 respectively the average nse values on a daily basis were 0 53 and 0 51 respectively during calibration and validation furthermore an r2 greater than 0 5 a pbias less than 25 and an rsr less than 0 7 indicated a suitable modelling performance according to the criteria established by moriasi et al 2007 related to the lnnse manual calibration was able to improve low flow simulations obtaining a model that can simulate daily streamflows with reasonable accuracy finally we performed a visual inspection of observed against simulated streamflows because using only performance metrics can be misleading and produce statistically good but unrealistic simulations daggupati et al 2015 as can be seen in fig 3 the accuracy of daily streamflow results suggests that the calibrated model can simulate the streamflow 3 4 2 using the swat post processing tool to calculate ef in the eo river basin once calibrated climate change scenarios were simulated using projections based on the gcms included in the cct for both scenarios rcp 4 5 and rcp 8 5 and for the near 2021 2050 and far future 2051 2080 these scenarios were compared to the historical period 1976 2005 from the swat outputs efs were evaluated using the post processing tool this tool is available via the visualize form under the post processing tab dile et al 2019 as an example of the tool application fig 3 illustrates how to calculate dqp qq and qb regardless of the statistic selected the first step is to select the scenario from which to calculate the statistics and the swat outputs from which to extract the data in this example for daily flows the channel sd day table was selected and efs were calculated for the historical period of the gcm3 the qq statistic provides a measure of the flows for that month that satisfies the condition that q of the flows exceed the measure the q value and the number of subbasins must be chosen by the user who can change the percentage and subbasin as well as the calculation period if desired before clicking calculate fig 4 a the result for each month is then written to the table the qb statistic provides for a given subbasin annual and monthly statistics fig 4b users must choose a start month and based on that selection the period is divided into successive year long periods starting with the first day of the start month and finishing with the last day of the preceding month one year later days before the first start month are ignored as are days at the end that do not make a complete year the reason for including the starting month option is because qb is calculated on an annual basis and the starting month may affect the calculated qb values according to palau and alcázar 2012 the starting month should not be in a low flow period e g winter flow in snow affected watersheds or summer flows in mediterranean climates and should never be the month with the lowest average flow following their suggestions in this study april was selected as the starting month annual to monthly qb disaggregation is calculated using a variation factor that consists of the square root of the ratio of mean for each month to the minimum monthly flow in this way the minimum monthly qb would correspond to the annual qb the dqp statistic provides a single flow statistic for a given subbasin where d is the number of days for moving average and p is the complementary probability of q percentage of the flows that do not exceed the measure as stated in the qb calculation users also need to choose a start month and based on the chosen period data are divided into year long periods in the same way as for qb moving averages of length d days are calculated for the daily flows for each year period and for each year period the minimum moving average is selected as the flow for that year then users can select between percentile and mean as the final statistic in this study fig 4c and to obtain 25qm mean was selected and the result was calculated by the mean of the flows for the year periods in any of the statistics included in the post processing tool after setting the parameters the result is calculated and displayed in the form by clicking calculate the save button must be used to save the results to a text file by checking the append box the result will be appended to the selected file allowing results for different parameter settings to be saved together all statistics calculated using this tool are in m³ s 3 4 3 climate change impact on the environmental flow regime table 3 shows that significant percentage changes in monthly mean precipitation would occur in late summer and autumn where precipitation would reduce by more than 30 both rcps agreed on projecting a decrease in the precipitation for spring summer and autumn while the precipitation would not suffer significant variations in winter the results also show that the increase in temperature during the summer and autumn months could occur with greater intensity in the months of july august and september with average increases of 1 8 c rcp 4 5 and 2 2 c rcp 8 5 for the short term period 2021 2050 and 2 8 c rcp 4 5 and 4 1 c rcp 8 5 for 2051 2080 the combined effect of changing temperatures and precipitation in late summer and autumn is expected to be the main driver behind the overall decrease of environmental flows in the eo river basin table 4 summarizes the average annual ef for the historical period as well as under both emissions scenarios and both future periods of the 5 gcms considered on an annual scale the results show that ef and mean daily flow will follow a decreasing trend under future conditions while standard deviation and the coefficient of variation will follow an increasing trend overall a significant decrease in average daily flow of up to 11 can be observed in the rcp 8 5 scenario and for the far future period the results obtained are consistent with the study of cedex 2017 which predicted an average decrease of 12 in the western cantabric basin for the 2040 2070 period in addition a remarkable increase in the variability of the series was detected with an increase of more than 22 for the far future the combined effect of the reduction in the average flows together with the increase in the variability of the series results in a reduction in the environmental flows of more than 30 fig 5 shows the ensemble changes in predicted monthly q85 in the future time periods under both rcps compared to the baseline period the ensemble was calculated using the simple arithmetic mean method which is widely used in climate change studies bhatta et al 2019 regardless of climate change scenario there is no clear trend during winter and spring while in summer and autumn time periods that include the months when the eo river has a lower flow september october there is a significant decrease in the q85 for example in the most severe scenario rcp 8 5 and for the far future the monthly q85 exhibits a decrease of 39 4 conclusions and future work this paper presents an updated version of the qgis interface for swat that includes the possibility of calculating ef based on model outputs the use of this post processing tool include in the swat visualization form is demonstrated through an application to the eo river basin in north spain the impact of climate change on the efs was determined based on the analysis of the variations in the efs in the near future 2021 2050 and the far future 2051 2080 compared to the baseline period 1976 2005 the hydrological characteristics of the initial series average flow and coefficient of variation and the environmental flows were calculated using the hydrological methods recommended in the sphi 25qm qb and q85 reductions in the average flows of the series between 5 and 7 and increases in the coefficient of variation of the series by over 13 were obtained for the near future 2021 2050 for the far future 2051 2080 average flows will be reduced between 4 and 11 while the coefficient of variation will increase between 21 and 23 in the overall environmental flows analyzed average reductions between 12 and 37 were obtained for the near and far future respectively these reductions are significantly greater than reductions in average flows due to the increase in the variability of the series which affects the determination of the environmental flows by hydrological methods the results obtained from this modelling study should be incorporated into an eo river basin management plan the establishment of ef is an essential element in meeting the objectives set in the european water framework directive such as the protection and conservation of water dependent ecosystems the newly developed post processing tool can conveniently provide an easy to use interface to analyze ef from swat results for many of the existing swat applications around the world there is now a potential for new analysis from swat outputs moreover the inventory of indexes can be expanded to include for example not only the calculation of minimum ef but also the calculation of maximum ef or rates of change as the number of swat users grows worldwide this post processing tool could be a useful tool for various potential model users in the evaluation of ef declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements dr senent aparicio was supported by a fulbright visiting scholar fellowship grant number cas18 00352 at the texas a m university college station usa authors also acknowledge papercheck proofreading and editing services 
25886,this paper describes a post processing tool included in the globally used swat model for desktop assessment of environmental flows the tool uses daily flow data from swat outputs and can apply different methodologies based on percentiles or moving averages to assess environmental flows this tool included in the visualization section of the swat model is open source and can therefore be readily expanded to include additional methodologies the features and capabilities of this tool are demonstrated through an application to the eo river basin in the northwest of spain the impact of climate change on environmental flows was analyzed obtaining reductions in environmental flows significantly greater than those of average flows mainly as a result of the increase in the variability of the daily flow series this tool can help policymakers and scientists with rapid preliminary assessment of environmental flows keywords swat model environmental flows moving averages percentiles eo river climate change software availability the qswat code is the qgis 3 plugin for generating inputs for swat code on the swat model website https swat tamu edu software plus it is open source and available for download and code modification language python software name post processing tool of qswat developers javier senent aparicio chris george and raghavan srinivasan system requirements windows programming language python software required qgis source code available bitbucket https bitbucket org chriswgeorge qswatplus3 src master 1 introduction the soil and water assessment tool swat model is a watershed scale and physically based model operating on a daily time step arnold et al 1998 it was developed to predict the impact of land management practices on water sediment and agricultural yields in large complex watersheds over long periods of time dile et al 2016 it has become one of the most widely used hydrologic models in the world and has been applied in many watersheds across the globe gassman et al 2007 as can be seen in the swat literature database swatpubdatabase 2020 as of july 2020 a total of 4000 peer reviewed swat model applications have been published in scientific journals due to the open source nature of swat improvements to the swat algorithm and its modules is an ongoing process guided by the needs of the growing worldwide user community merwade et al 2017 in the past few years and to face present and future challenges in water resources modelling and management the swat code has undergone major modifications resulting in swat swat is a completely revised version of the model characterized by being more flexible than swat in terms of the spatial representation of interactions and processes within a watershed bieger et al 2017 one of the challenges faced by water planners and managers is the establishment of an environmental flow regime to make this task easier for swat users this tool was developed to calculate environmental flows efs using different hydrological methodologies the establishment of the ef regime in a river is a complex problem with important legal and socioeconomic implications and for which there are no common scientific technical criteria or a universally accepted operational methodological proposal however a fundamental assumption of ef research is the natural flow paradigm which states that the natural flow regime including natural fluctuations provides the optimum conditions for a river ecosystem poff et al 1997 the estimation of naturalized streamflows that represent the historical natural hydrology unaffected by human activities is fundamental to address different aspects of river basin management wurbs 2006 in basins subject to a high degree of anthropization hydrological models such as swat are a good option for determining the natural flow regime among the different types of existing methods for making ef recommendations a widespread approach is to base the environmental flow regime exclusively on the analysis of the record of flows observed in the area of interest without introducing other geomorphological or hydrobiological considerations this is based on the assumption that the flow record is a footprint that incorporates relevant environmental information of the affected ecosystem this type of method is called hydrological and is based on the series of flows in a natural regime according to tharme 2003 there are four basic types of ef methods hydrological hydraulic habitat simulation and holistic considered to be the hydrological methods most appropriate for water resources planning and management due to the fact that they are regarded as the simplest and most easily used to calculate ef these hydrological methods need as input data daily average flows under natural flow regimes which reduces data availability alcázar et al 2008 this data limitation is especially important in spain because gauging stations are scarce and usually located in the mainstream so they are usually impacted by water withdrawals diversions and reservoir operations belmar et al 2011 hence the need for the use of swat model to generate a database of long term daily flow records at many locations in large basins based on this dataset it would be very helpful to water resources managers to calculate environmental flows at several locations in a flexible and easy to use interface therefore the objective of this work is to present a new user friendly post processing tool included in the qgis interface of swat which can obtain different hydrological indexes related to efs and help users to evaluate the ef requirements based on swat outputs we first present how this tool was developed and what type of indexes have been included section 2 we then illustrate the features and capabilities of this tool through an application to the eo river basin in the northwest of spain to assess the impact of climate change on ef section 3 natural flow regimes are already shifting due to climate change and water management authorities will need to evaluate these changes poff 2018 2 post processing tool development 2 1 environmental flow methodologies that can be applied using the post processing tool according to poff et al 1997 the regulation of environmental processes in river ecosystems is based on five components magnitude frequency duration timing and rate of change of hydrologic conditions the tool presented in this study is based on the calculation of the minimum efs this is due to the fact that in semi arid and mediterranean areas this is the most critical component of efs because of the seasonal nature of dry and hot summers which leads to water shortages when the water demand is high aguilar and polo 2016 2 1 1 dqp methods or methods based on moving averages dqp methods start from the daily series of flows at the point of interest and depends on the number of days used to calculate moving averages d and the probability of no exceedance p these methods are based on the determination of the average flows of length d days that is not exceeded in p of the years to do this starting from the daily series of flows with n years of data series s 1 the series s1 of moving averages of order d applied to the daily flow q are obtained 2 the annual minimums are extracted from the series s1 obtaining a series s2 of length n years 3 the value corresponding to the percentile of p is obtained from s2 this value is the desired dqp value the percentile can be obtained non parametrically or parametrically adjusting a distribution to the data and obtaining the corresponding quantile in the post processing tool presented here percentiles are obtained non parametrically the tool allows the user to freely choose the values of the variables d and p which allows the calculation of several indices the most common of this set of methods is undoubtedly the 7q10 widely used since the early 1970s by u s agencies dealing with river pollution ames 2006 water quality was considered acceptable if the flow was equal to or greater than 7q10 given that in this initial use 7q10 was only related to the regulation and dilution of pollution in rivers its suitability for other objectives related to the protection of habitats or aquatic species is not proven although in any case it constitutes a fundamental reference in studies on minimum flows in addition to the 7q10 standard other dqp indices have been used for example in eastern european countries along with the 7q10 there are a variety of other 7q flows that can be calculated by the tool pyrce 2004 for example the ontario ministry of natural resources make use of 7q20 and 7q2 flows 7q20 is used as a conservative approach to ensure that sufficient streamflow is available to dilute point source discharges and 7q2 is used as the habitat maintenance flow moving averages of 1 day or 30 days are also used instead of 7 days karakoyoun 2018 recent work in spain and specifically in the tagus basin baeza et al 2005 has suggested the use of the lowest moving average of 25 days 25q as representative of the ef in a year the observation of a change of slope around step 25 in the low water graphs suggests the use of this order for the moving average and is what probably led to its suggested use in the spanish water planning instruction swpi as will be seen in the case study as well as suggesting the use of a minimum flow of 25q10 or 10 percentile applied to the annual series of these 25 day minimums unless the channel naturally dries up without resorting to percentiles but considering average values the 25qm method consists of obtaining the 25 day moving averages for each year and choosing their lowest value this gives the minimum series s2 of a size equal to the number of years whose arithmetic mean is the environmental flow note that instead of a percentile the average is used whose equivalent percentile is not fixed but depends on the distribution of the data this methodology was proposed by baeza sanz and garcía del jalón 2005 and can also be calculated using the post processing tool 2 1 2 qq methods or methods based on percentiles qq methods are based on the frequency analysis of the series approached by studying the percentiles of its daily flow duration curve they provide values similar to the dqp methods in which the period of the moving average becomes d 1 and the probability of exceedance q is complementary to that of no exceedance p the difference is that dqp obtains the quantiles from the annual minimum series and qq obtains them from the complete daily series the tool presented in this work allows the user to choose any percentile value although the most common minimum flows are q95 and q90 for example the uk australia taiwan and bulgaria apply q95 as a minimum standard whereas brazil and canada use q90 efstratiadis et al 2014 likewise different indicators related to the average monthly flows during the summer months have been used with daily data sorted by year the q347 and q355 methods are widely used the first is the basis of the swiss or matthey method in which a procedure is proposed based on the flow equaled or exceeded during 347 days a year if the complete series is used this value is equal to q95 and with annual minimums it is equal to 1q5 2 1 3 basic flow method qb the basic flow method was conceived and developed in spain palau and alcázar 2012 and has been applied in numerous rivers efstratiadis et al 2014 peñas et al 2014 herrera and burneo 2017 it is based on the study of moving averages of the daily flow time series seeking to recognize certain irregularities or discontinuities throughout the series which are associated with thresholds of environmental alteration of the fluvial system this methodology includes a set of indicators of which only the one called basic flow qb has been incorporated into this version of the post processing tool this flow is defined as the absolute minimum that must always be maintained in the channel the qb is calculated independently for each year using moving averages applied at increasing intervals of consecutive data daily average flows of order between 1 and 100 this limit is established on the basis that an average of 100 daily average flows already includes the low water period about 3 months over which the qb will most likely be defined the minimum of the moving average model applied to each increasing interval is identified then the qb value for each year is defined from the streamflow ending the longest flow period which is identified by the highest relative increment between two consecutive increasing intervals of minimum average flows alcázar and palau 2010 the final qb value is calculated as the mean of the individual qb values for every year taking into account that the period of analysis must be at least 10 years a more detailed description can be found in the work of palau and alcazar 2012 2 2 tool implementation the calculations of the efs qq dqp and qb are integrated into the post processing section of the visualization component of qswat they all depend on the daily channel output table which provides data including outflow in m3 s for every channel for every day in the simulation each ef method has a separate form offering a choice of subbasin internally converted into a choice of that subbasin s outflowing channel plus the other required parameters percentile start month and number of days for moving average as appropriate results are displayed in the form and can also be saved to an output file the coding is in python like the rest of qswat these calculations proved to run quickly so no special coding or use of packages such as numpy was necessary the algorithms are similar the data for the selected channel is read from the daily channel output table with a simple sql select statement into a suitable data structure for qq and qb this structure is a mapping from month to list of values for dqp it is a list of values for each year long period starting from the start month then qq for example is completed by sorting each month s list of values when a percentile translates immediately into a position on the list 3 application to the eo river basin for the purpose of demonstration in this paper the swat post processing tool was applied to the eo river basin nw spain to evaluate the impact of climate change on efs based on the swpi the characterization of the natural regime of a river needs representative hydrological series of at least 20 years with a balanced alternation between dry and wet years and the definition of moving averages methods and percentiles between the 5th and 15th percentile from the flow duration curve in this study and to cover the two criteria established by the swpi 25qm q85 and qb were evaluated in addition to the above environmental flow values two basic variables were studied that characterize the hydrological behavior of the hydrological series the average flow and the coefficient of variation cv which is the ratio of the standard deviation to average and is a measure of relative variability 3 1 study site the eo river basin located in the north of spain fig 1 as a physical frontier between the regions of asturias and galicia covers an area of 819 km2 and the total length of the main stream is 92 km being part of the western cantabric basin the basin elevation ranges between sea level and 1108 m a s l and has a relatively steep topography ninety five percent of the basin area presents slopes higher than 8 therefore plains are scarce and are mainly situated in the downstream areas pérez sánchez et al 2020 the annual mean rainfall in the eo river basin for the 1976 2005 period was 1295 mm and the average annual flow at san tirso de abres gauge station was 17 8 m3 s the historical average annual maximum and minimum temperature were 16 0 and 5 6 c respectively the eo river basin is characterized by its low population density and low level of urbanization and it does not support any significant industrial or intensive agriculture activities de paz et al 2008 due to its high environmental value more than 90 of the eo river basin area was declared a biosphere reserve by the united nations educational scientific and cultural organization unesco in 2007 3 2 swat model for the eo river basin 3 2 1 data and model setup the model input data included the digital elevation model dem of 25 m resolution from the national geographic institute of spain the land use map was derived from the reclassified corine land cover 1 50 000 and the 90 m resolution soil map extracted from the harmonized world soil database hwsd version 1 2 daily weather data including precipitation and maximum and minimum temperature were obtained from aemet and spain02 respectively these data were previously used satisfactorily for hydrological modelling in peninsular spain senent aparicio et al 2018a 2018b pérez sánchez et al 2019 in this study potential evapotranspiration was simulated using the hargreaves method hargreaves 1994 because it only requires maximum and minimum daily temperatures the basin was divided into 11 subbasins and discretized into 121 hydrological response units hrus landscape units lsus and channels landscape features were not considered to define the hrus and lsus 3 2 2 model calibration validation and performance evaluation manual calibration was performed from 1976 to 1990 by comparing observed and simulated daily discharges and the years 1991 2005 were used for the model validation in addition a five year 1971 1975 warm up period was used to minimize the impact of initial conditions on model simulations the nash sutcliffe efficiency nse kling gupta efficiency kge determination coefficient r2 and percent bias pbias were used as goodness of fit indicators for daily model simulations according to krause et al 2005 the nse is not suitable for low flow conditions because it overestimates larger values neglecting lower values due to the use of square of difference between simulated and observed streamflows to specifically evaluate the performance in the low flow simulation and to overcome the nse s oversensitivity to extreme values we used the logarithmic nash sutcliffe lnnse this transformation has been used in several previous studies chen et al 2018 osuch et al 2018 parra et al 2019 3 3 climate change scenarios after the swat model was calibrated and validated under current conditions the potential impact of climate change on environmental flows was analyzed in two different future periods the near future 2021 2050 and far future 2051 2080 for both rcp 4 5 and rcp 8 5 climate scenarios data for the climate change scenarios were extracted and prepared using the climate change toolkit cct as can be seen in table 1 this tool provides historical and future data from five different models gfdl esm2m hadgem2 es ipsl cm5a lr miroc and noeresm1 m as can be seen in fig 2 bias correction and spatial downscaling were carried out using a monthly additive correction factor temperature and a monthly multiplicative correction factor precipitation a more detailed cct process description is given by vaghefi et al 2017 3 4 results and discussion 3 4 1 swat model performance as can be seen in table 2 daily model performance using default values is fairly acceptable however lnnse results reflected poor performance of the low flows according to these results manual calibration was conducted using only three parameters the base flow alpha factor alpha bf was calculated using an automated digital filter program arnold and allen 1999 obtaining a value of 0 024 this program was previously used in many studies related to the swat model meaurio et al 2015 alpha bf gives the base flow recession constant factor and is an important parameter in the base flow estimation the soil evaporation compensation factor esco and lateral flow travel time lat ttime were manually calibrated in a trial and error process obtaining final values of 0 85 and 39 respectively the average nse values on a daily basis were 0 53 and 0 51 respectively during calibration and validation furthermore an r2 greater than 0 5 a pbias less than 25 and an rsr less than 0 7 indicated a suitable modelling performance according to the criteria established by moriasi et al 2007 related to the lnnse manual calibration was able to improve low flow simulations obtaining a model that can simulate daily streamflows with reasonable accuracy finally we performed a visual inspection of observed against simulated streamflows because using only performance metrics can be misleading and produce statistically good but unrealistic simulations daggupati et al 2015 as can be seen in fig 3 the accuracy of daily streamflow results suggests that the calibrated model can simulate the streamflow 3 4 2 using the swat post processing tool to calculate ef in the eo river basin once calibrated climate change scenarios were simulated using projections based on the gcms included in the cct for both scenarios rcp 4 5 and rcp 8 5 and for the near 2021 2050 and far future 2051 2080 these scenarios were compared to the historical period 1976 2005 from the swat outputs efs were evaluated using the post processing tool this tool is available via the visualize form under the post processing tab dile et al 2019 as an example of the tool application fig 3 illustrates how to calculate dqp qq and qb regardless of the statistic selected the first step is to select the scenario from which to calculate the statistics and the swat outputs from which to extract the data in this example for daily flows the channel sd day table was selected and efs were calculated for the historical period of the gcm3 the qq statistic provides a measure of the flows for that month that satisfies the condition that q of the flows exceed the measure the q value and the number of subbasins must be chosen by the user who can change the percentage and subbasin as well as the calculation period if desired before clicking calculate fig 4 a the result for each month is then written to the table the qb statistic provides for a given subbasin annual and monthly statistics fig 4b users must choose a start month and based on that selection the period is divided into successive year long periods starting with the first day of the start month and finishing with the last day of the preceding month one year later days before the first start month are ignored as are days at the end that do not make a complete year the reason for including the starting month option is because qb is calculated on an annual basis and the starting month may affect the calculated qb values according to palau and alcázar 2012 the starting month should not be in a low flow period e g winter flow in snow affected watersheds or summer flows in mediterranean climates and should never be the month with the lowest average flow following their suggestions in this study april was selected as the starting month annual to monthly qb disaggregation is calculated using a variation factor that consists of the square root of the ratio of mean for each month to the minimum monthly flow in this way the minimum monthly qb would correspond to the annual qb the dqp statistic provides a single flow statistic for a given subbasin where d is the number of days for moving average and p is the complementary probability of q percentage of the flows that do not exceed the measure as stated in the qb calculation users also need to choose a start month and based on the chosen period data are divided into year long periods in the same way as for qb moving averages of length d days are calculated for the daily flows for each year period and for each year period the minimum moving average is selected as the flow for that year then users can select between percentile and mean as the final statistic in this study fig 4c and to obtain 25qm mean was selected and the result was calculated by the mean of the flows for the year periods in any of the statistics included in the post processing tool after setting the parameters the result is calculated and displayed in the form by clicking calculate the save button must be used to save the results to a text file by checking the append box the result will be appended to the selected file allowing results for different parameter settings to be saved together all statistics calculated using this tool are in m³ s 3 4 3 climate change impact on the environmental flow regime table 3 shows that significant percentage changes in monthly mean precipitation would occur in late summer and autumn where precipitation would reduce by more than 30 both rcps agreed on projecting a decrease in the precipitation for spring summer and autumn while the precipitation would not suffer significant variations in winter the results also show that the increase in temperature during the summer and autumn months could occur with greater intensity in the months of july august and september with average increases of 1 8 c rcp 4 5 and 2 2 c rcp 8 5 for the short term period 2021 2050 and 2 8 c rcp 4 5 and 4 1 c rcp 8 5 for 2051 2080 the combined effect of changing temperatures and precipitation in late summer and autumn is expected to be the main driver behind the overall decrease of environmental flows in the eo river basin table 4 summarizes the average annual ef for the historical period as well as under both emissions scenarios and both future periods of the 5 gcms considered on an annual scale the results show that ef and mean daily flow will follow a decreasing trend under future conditions while standard deviation and the coefficient of variation will follow an increasing trend overall a significant decrease in average daily flow of up to 11 can be observed in the rcp 8 5 scenario and for the far future period the results obtained are consistent with the study of cedex 2017 which predicted an average decrease of 12 in the western cantabric basin for the 2040 2070 period in addition a remarkable increase in the variability of the series was detected with an increase of more than 22 for the far future the combined effect of the reduction in the average flows together with the increase in the variability of the series results in a reduction in the environmental flows of more than 30 fig 5 shows the ensemble changes in predicted monthly q85 in the future time periods under both rcps compared to the baseline period the ensemble was calculated using the simple arithmetic mean method which is widely used in climate change studies bhatta et al 2019 regardless of climate change scenario there is no clear trend during winter and spring while in summer and autumn time periods that include the months when the eo river has a lower flow september october there is a significant decrease in the q85 for example in the most severe scenario rcp 8 5 and for the far future the monthly q85 exhibits a decrease of 39 4 conclusions and future work this paper presents an updated version of the qgis interface for swat that includes the possibility of calculating ef based on model outputs the use of this post processing tool include in the swat visualization form is demonstrated through an application to the eo river basin in north spain the impact of climate change on the efs was determined based on the analysis of the variations in the efs in the near future 2021 2050 and the far future 2051 2080 compared to the baseline period 1976 2005 the hydrological characteristics of the initial series average flow and coefficient of variation and the environmental flows were calculated using the hydrological methods recommended in the sphi 25qm qb and q85 reductions in the average flows of the series between 5 and 7 and increases in the coefficient of variation of the series by over 13 were obtained for the near future 2021 2050 for the far future 2051 2080 average flows will be reduced between 4 and 11 while the coefficient of variation will increase between 21 and 23 in the overall environmental flows analyzed average reductions between 12 and 37 were obtained for the near and far future respectively these reductions are significantly greater than reductions in average flows due to the increase in the variability of the series which affects the determination of the environmental flows by hydrological methods the results obtained from this modelling study should be incorporated into an eo river basin management plan the establishment of ef is an essential element in meeting the objectives set in the european water framework directive such as the protection and conservation of water dependent ecosystems the newly developed post processing tool can conveniently provide an easy to use interface to analyze ef from swat results for many of the existing swat applications around the world there is now a potential for new analysis from swat outputs moreover the inventory of indexes can be expanded to include for example not only the calculation of minimum ef but also the calculation of maximum ef or rates of change as the number of swat users grows worldwide this post processing tool could be a useful tool for various potential model users in the evaluation of ef declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements dr senent aparicio was supported by a fulbright visiting scholar fellowship grant number cas18 00352 at the texas a m university college station usa authors also acknowledge papercheck proofreading and editing services 
25887,a global sensitivity analysis of a lake ecosystem model gotm fabm pclake was undertaken to test the impacts of lake morphology on parameter sensitivity in three different lakes the analysis was facilitated by the parallel sensitivity and auto calibration tool parsac and included a screening step with the density based borgonovo s method followed by in depth analysis with both borgonovo s and the variance based sobol methods the borgonovo s method proved efficient in ranking the most influential parameters and its results were corroborated by the sobol method for total phosphorus and total nitrogen parameters related to the benthic pelagic coupling and phytoplankton were particularly important for the shallower lakes whereas the most important parameters for total nitrogen were related mainly to the benthic pelagic coupling in the deepest lake for chlorophyll a phytoplankton and zooplankton parameters were most influential we conclude that lake morphology shapes the parameter sensitivity of lake ecosystem models keywords global sensitivity analysis lake ecosystem modelling process based modelling moment independent sensitivity method variance based sensitivity method fabm pclake software availability the parallel sensitivity and auto calibration parsac tool was developed by bolding bruggeman as a designated python package parsac version 0 5 7 bolding and bruggeman 2020 was applied in this study and is freely available via the python package manager pip install parsac user from pypi org the sensitivity analysis library in python salib herman and usher 2017 is a python implementation of commonly used sensitivity analysis methods including borgonovo s and sobol methods salib version 1 3 8 was used in this study and this and the newest version is freely available at www github com salib salib last accessed november 1 2020 and from pypi org the 1d hydrodynamic model general ocean turbulence model gotm burchard et al 1999 and the lake ecosystem model fabm pclake hu et al 2016 are public domain models that are freely available at www github com gotm model and www gitlab com fabm pclake pclake last accessed november 1 2020 respectively in this study the gotm fabm pclake model complex as configured and validated for the lake ravn trolle et al 2008b lake bryrup chen et al 2019 and lake hinge andersen et al 2020 was employed 1 introduction lake ecosystems and their biodiversity are currently under serious threat from eutrophication and global climate changes albert et al 2020 jeppesen et al 2014 wwf 2018 therefore lake ecosystem models are increasingly applied to simulate water quality and to gain a deeper understanding of lake ecosystem functioning trolle et al 2012 lake ecosystem models may also act as tools supporting management decisions and policy making for instance by quantifying the effectiveness of management measures hilt et al 2017 thereby providing information on how to best mitigate future impacts e g rolighed et al 2016 several complex aquatic ecosystem models are available mooij et al 2010 and have been used to assess the effect of different management measures and the impacts of future global climate changes for example i three different process based lake ecosystem models were used to project the response of phytoplankton to climate change in a small shallow danish lake trolle et al 2014 ii ensemble modelling with a hydrodynamic lake model explored the impacts of climate warming and increased frequency of heat waves on the thermal characteristics of a large sub tropical lake gal et al 2020 and iii the lake ecosystem model complex gotm fabm pclake was used to assess the level of external nutrient load reductions needed for a shallow lake to reach clear water conditions with a high coverage of submerged vegetation andersen et al 2020 the algorithms of complex environmental models often include hundreds of parameters many of which require tailored configuration and adjustment in each application case and model complexity will likely increase further in the future wagener and pianosi 2019 this is also true for lake ecosystem models robson 2014 and the majority of model parameters cannot be accurately measured or are unknown due to for instance lack of observations this means that modellers have to rely on literature values and calibration to identify the optimal parameter values to give a satisfactory description of the system being modelled to ensure robust and high quality model output it is vitally important to focus on accurately determining the parameters that are most influential for the model outputs arhonditsis and brett 2004 comprehensive sensitivity analysis sa can serve this purpose and is considered an important part of any due diligent modelling process jørgensen 1995 ravalico et al 2005 especially in a policy context saltelli and funtowicz 2014 this is also stressed by several agencies that recommend the use of sa as best practice in the development and application of models european commission 2005 u s epa 2009 sa methods have commonly been divided into two broad categories local sa methods where input parameters has been varied one at a time around a nominal value and global sa methods which attempts to explore the entire space of input parameters global sa is to be preferred in most cases as i it does not assume that the model is linear or additive which is rarely the case for any complex ecological model and because ii it accounts for the effects of interactions between model parameters saltelli et al 2008 saltelli and annoni 2010 local sa is still the most commonly used approach but global approaches have recently achieved increasing attention ferretti et al 2016 in the development and application of the most widely used lake models sa has usually been performed and reported but sa is typically not an integral and ongoing process in further model developments mooij et al 2010 application of lake models to specific case studies tends to rely on sa results to decide which parameters and their ranges to include in the calibration process e g di maggio et al 2016 rolighed et al 2016 sa of lake models has either been undertaken using local e g schladow and hamilton 1997 elliott et al 1999 nielsen et al 2014 or global e g bruce et al 2006 janse et al 2010 page et al 2017 sa methods due to the complexity of ecological models sa computation can be time consuming and computational costly and time and resources are only rarely available for conducting rigorous global sa of such models jakeman et al 2006 robson et al 2008 the sensitivity and calibration utility parsac parallel sensitivity analysis and calibration has the potential to greatly reduce the time required for conducting global sa by automating key steps in the procedure parsac is written in python for models with output in netcdf and model configuration files in namelist or yaml format to further reduce the computational burden the global sa may be divided into a screening step and a more detailed analysis step as recommended by saltelli et al 2008 the screening step aims to identify all non influential parameters conditional on the chosen target variable and concentrate the detailed global sa analysis on influential parameters this approach has also been applied to lake models with various sa methods e g janse et al 2010 makler pick et al 2011 parameterisation of environmental models can differ between sites and contexts and parameter sensitivity has also been shown to be potentially context specific wagener and pianosi 2019 for example parameter sensitivity of the soil and water assessment tool swat varied in two different watersheds and with different climatic conditions cibin et al 2010 this is likely also true for lake ecosystem models even though most lake models have been developed to cover the general behaviour and mechanisms of lake ecosystems they often need to be calibrated for a specific lake consequently the analysis may only provide information on influential parameters and model behaviour for that specific lake or lake type in this study we aim to evaluate the influence of lake morphology on the sensitivity of model parameters we provide the first comprehensive global sensitivity study of the 1 dimensional hydrodynamic lake ecosystem model complex gotm fabm pclake for three danish lakes with varying bathymetry max depth ranging from 2 to 33 m and trophic state ranging from meso to eutrophic model applications for these three lakes have previously undergone rigorous calibration and validation andersen et al 2020 chen et al 2019 trolle et al 2008b as shallow lakes likely have a tighter coupling between the pelagic benthic domains compared with deep lakes schindler and scheuerell 2002 we expect to identify more influential model parameters relating to this particular coupling in the shallow lakes sa has proven to be sensitive to the choice of methods wagener and pianosi 2019 we therefore applied two global sa methods the density based borgonovo s δ sensitivity measure and the widely used variance based first and total order sobol indices in a two step approach with a screening followed by an in depth analysis the global sa was performed with the sensitivity and calibration utility parsac version 0 5 7 which was chosen for its ability to minimise the computational burden and included both borgonovo s and the sobol methods the aim of the sensitivity analysis was to obtain insight into which model parameters are most influential in shaping model behaviour across different lake depths we provide a ranking of the most influential parameters for each lake on important model outputs which are typically targeted for calibration purposes we also exemplify usage of the sensitivity and calibration utility tool parsac the insight from sensitivity analysis in this work will be broadly applicable in future lake model case studies within the temperate zone and for the development of the next generation of lake ecosystem models 2 methods 2 1 the study design the focus of this sensitivity analysis is on the output variables that are most commonly examined in calibration and validation processes during a lake modelling case study table 1 the analysis includes three lakes with varying bathymetry and trophic state all located in denmark lake ravn lake bryrup and lake hinge for each lake the gotm fabm pclake model complex have been set up calibrated and validated in separate studies for details see andersen et al 2020 chen et al 2019 trolle et al 2008a to minimise effects of model initialisation model simulations included a warm up period of 5 years 1996 2000 before the analysis period of 5 years 2001 2005 and were configured with a 1 hourly time step and daily output values for layers in the surface ranging between 0 and 3 m all forcing and boundary conditions were lake specific output variables were processed across the analysis period into summer april to september mean values all 356 fabm pclake parameters and five common calibrated gotm parameters were included in the sa appendix a the parameter space was defined as 25 of the lake specific calibrated parameter values although the parameter space was bound by model constraints and not allowed to cross model limits e g a parameter describing a fraction ranging from 0 to 1 was bound within this range appendix a all parameter values were assumed to be uniformly distributed within the parameter space parsac bolding and bruggeman 2020 is a python package for sensitivity analysis and calibration designed specifically for models that take a long time to run it allows the work for a sensitivity analysis or calibration procedure to be distributed over multiple compute cores of a single workstation or high performance computing cluster which may potentially considerably reduce the time taken to complete the analysis parsac further emphasises traceability and reuse of model analyses which is made possible by logging parameter values and summary statistics for each model simulation to a mysql database https www mysql com last accessed november 1 2020 the package is model independent as it supports different mechanisms to configure parameters yaml files fortran namelists attributes of python objects and its access to model outputs e g reading spatiotemporally varying fields from netcdf files or calling python functions these features make it particularly suitable for analysis of gotm fabm which is configured through yaml files and writes outputs in netcdf format sensitivity analysis in parsac is built on top of salib sensitivity analysis library in python which supports a range of commonly used sensitivity analysis methods this study applied two global sensitivity methods the density based borgonovo s δ method and the widely used variance based sobol method to calculate first and total order indices fig 1 initially a sa with borgonovo s δ was applied to identify and separate influential from non influential parameters often referred to as the parameter fixing setting or parameter screening for this purpose a dummy parameter having no influence on the model output was included in the sampled parameter set in theory non influential parameters in the borgonovo s δ and sobol total order indices have a value of zero but due to numerical approximations in the sa algorithms the non influential parameters may obtain small non zero sensitivity indices the sensitivity index of the dummy parameter thus provided an indication of the approximation error of estimating sensitivity indices all parameters with a sensitivity index above the dummy parameter s confidence interval were classified as influential similar to this dummy approach has been applied in other sensitivity studies with complex environmental models e g zadeh et al 2017 the parameter space was sampled with latin hypercube sampling lhs with a sample size of 100 generating in total 36 200 model simulations for each lake model and confidence intervals were determined by bootstrap resampling of 100 samples and a confidence interval level of 0 95 herman and usher 2017 for further in depth analysis of the shallowest and the deepest lake the most influential parameters from lake hinge and lake ravn were selected based on the identified influential parameters from the screening analysis for the output variables total chlorophyll a chl a total phosphorus tp and total nitrogen tn to increase the strength of the analysis a sample size of 250 was applied for both the borgonovo s and sobol methods generated with lhs and saltelli s sampling scheme saltelli 2002 respectively to avoid numerical instabilities and consequently model crashes when running simulations with the generated parameter sets the parameter sampling range for the in depth analysis had to be constrained for lake ravn to 15 of lake specific calibrated parameter values in the lake hinge in depth sa both 25 and 15 of lake specific calibrated parameter values were applied to also compare in depth and screening results all results were analysed with confidence intervals determined by bootstrap resampling of 100 samples and a confidence interval level of 0 95 herman and usher 2017 2 2 global sensitivity analysis methods 2 2 1 the density based borgonovo s δ sensitivity measure the density based borgonovo s method borgonovo 2007 plischke et al 2013 is a global model and moment independent sensitivity measure that considers the entire model output distribution in order to quantify the relative influence of parameters on the model output the δ sensitivity measure is based on estimating the change between the probability distribution function pdf of the model output and the pdf of the model output conditional upon fixing a given input parameter let the model be represented by a function 1 y f x f x 1 x n where y is scalar model output and x x 1 x n is a set of n independent model parameters in this study the model parameters the separation between the unconditional probability distribution function of the model output f y y and the probability density conditional upon fixing input parameter x i f y x i y can be obtained by calculating 2 s x i f y y f y x i y d y the expected separation is then 3 e x i s x i f x i x i f y y f y x i y d y d x i and the sensitivity measure δ i for parameter x i can be defined as 4 δ i 1 2 e x i s x i i 1 n the δ represents the normalised expected shift in the distribution of y provoked by x i the δ sensitivity measure describes direct and indirect effects of the parameter and possesses several important properties 1 δ lies between 0 and 1 2 δ is zero when y is independent of x i and 3 δ equals unity when uncertainty in all model inputs is resolved δ 1 2 n 1 borgonovo 2017 to estimate δ for model parameters we applied the method laid out in plischke et al 2013 as included in the global sensitivity analysis software salib herman and usher 2017 this method also includes calculating sobol first order indices from lhs so sobol first order index is also applied to assess the screening results e g fig 4 model parameters were sampled with lhs assuming a uniform parameter distribution with a sampling size of n 100 and n 250 for the screening analysis and in depth analysis respectively one model output green algae dw in the lake ravn model was log transformed before borgonovo s δ was estimated to handle unreasonably high δ sensitivity measures 2 2 2 the variance based sobol s indices sobol s sensitivity analysis method sobol 2001 saltelli 2002 saltelli et al 2010 is a global and model independent sensitivity analysis that is based on variance decomposition it can handle non linear and non monotonic functions and models the variance based sobol s indices represent the fraction of the variance in the output that can be attributed to a given input alone first order s i or with consideration of the input interaction with all other model parameters included in the analysis total order s t i let the model be represented by a function 5 y f x f x 1 x n where y is scalar model output and x x 1 x n is a set of n independent model parameters the total unconditional variance of the model output v y can be decomposed as 6 v y i v i i j v i j v 1 2 n where v i is the partial variance of x i on y and is given by v i v e y x i while v i j is the impact of x i and x j on the total variance minus their first order effects using these partial variances the first and total order sobol sensitivity indices s i and s t i can be defined in relation to the total variance borgonovo 2017 saltelli et al 2008 where i 1 n 7 s i v i v y v e y x i v y 8 s t i 1 v i v y v e y x i v y to sample the parameter ranges and generate model inputs this study applied the saltelli extension of the sobol sequence to estimate the first and total order indices at a cost of n n 2 p 2 evaluations where n is the number of model simulations n is the number of samples to generate and p is the number of model parameters saltelli 2002 sobol first order sensitivity index is widely used and is a robust measure of functional dependence plischke et al 2013 saltelli et al 2008 a null value of the first order sensitivity measure does not imply that the model output is independent of the input parameter x i as interactions are not captured plischke et al 2013 saltelli et al 2008 2 3 the lake ecosystem model gotm fabm pclake we applied a lake adapted version of the one dimensional water column model gotm coupled with the lake ecosystem model fabm pclake the hydrodynamic and ecological lake model gotm fabm pclake describes conceptually the most important hydrodynamic and ecological processes in temperate lake ecosystems based on lake specific meteorological forcing in and outflows and a hypsograph i e the relation between depth and the corresponding horizontal area gotm simulates the vertical transport of momentum salt and heat through the water column this study utilised the k epsilon model for calculating the turbulence closure and the first order positive preserving and conservative extended modified patankar ordinary differential equation scheme for source and sink dynamics bruggeman et al 2007 fabm pclake is a dynamic complex lake ecosystem model which simulates nutrient and food web dynamics within the water column and the top sediment in each water layer hu et al 2016 the model is a redesign of the widely applied aquatic ecosystem model pclake janse 2005 the modelled lake ecosystem consists of variables describing oxygen dynamics organic and inorganic fractions of nitrogen phosphorus and silica three different groups of phytoplankton zooplankton zoobenthos plankti and benthivorous fish juveniles and adults piscivorous fish as well submerged vegetation fig 2 a full list of model parameters and state variables is available in hu et al 2016 2 4 the lake model cases a gotm fabm pclake model complex was set up calibrated and validated for three danish lakes lake hinge lake bryrup and lake ravn during a lake model pilot project for the danish environmental protection agency for calibrated parameter values see appendix a these lakes range from shallow to deep in a danish context lake hinge has a mean and maximum depth of 1 2 m and 2 6 m respectively a surface area of 0 91 km2 and a short hydraulic residence time of 16 32 days the water column in lake hinge rarely stratifies for periods longer than a week during summer the catchment area approximately 55 km2 comprises mainly agriculture 93 nielsen et al 2000 as reflected by the high external tp and tn loading of 2 1 3 7 mg yr and 62 121 mg yr respectively in 2001 2005 the lake is eutrophic with mean summer tp and chl a concentrations of approx 0 1 0 2 mg l and 60 150 μg l respectively a gotm fabm pclake model complex was set up calibrated and validated on lake hinge for the period 1993 2007 by andersen et al 2020 lake bryrup has a mean and maximum depth of 4 6 m and 9 m a surface area of 0 37 km2 and its hydraulic residence time varies between 2 and 3 months the lake is polymictic and stratifies temporarily during summer the catchment area is approximately 50 km2 with 60 of the area being used for agriculture nielsen et al 2000 the external loading of tp and tn to the lake was 0 7 1 2 mg yr and 51 80 mg yr respectively in 2001 2005 the lake frequently experienced cyanobacteria summer blooms and had a mean summer tp and chl a concentrations of approx 0 05 0 1 mg l and 25 50 μg l respectively a gotm fabm pclake model complex was set up calibrated and validated on lake bryrup for the period 1996 2005 by chen et al 2019 lake ravn has a mean and maximum depth of 15 m and 33 m respectively a surface area of 1 8 km2 and a hydraulic residence time of approx 1 8 years lake ravn is dimictic and the water column stratifies throughout summer until autumn may to october november the lake catchment 57 2 km2 is dominated by agriculture 70 nielsen et al 2000 in 2001 2005 the external nutrient loading of tp and tn to the lake was 0 8 mg tp yr and 47 108 mg tn yr the lake is classified as mesotrophic with mean summer tp and chl a concentrations of approx 15 23 μg l and 9 12 μg l respectively based on a previous lake model by trolle et al 2008a a gotm fabm pclake model complex was set up calibrated and validated on lake ravn for the period 1996 2005 with improvements in model performance for calibrated parameter values see appendix a meteorological data for atmospheric forcing of all three lake models were derived from the european ecmwf interim dataset dee et al 2011 monthly averages of water inflow m3 s and nutrient concentrations mg l were used as boundary conditions based on bimonthly measurements of inflow inorganic and total nitrogen and phosphorous concentrations from the danish monitoring program novana for lakes johansson et al 2015 combined with estimates from the dk qnp model for the ungauged catchment area thodsen et al 2016 the particulate organic fraction of the total phosphorus and nitrogen load was estimated for each individual lake as were the initialisation values for the sediment nutrient pool 3 results 3 1 screening by borgonovo s δ sensitivity measure a total of 108 300 model simulations were executed during the screening step and analysed with the density based borgonovo s method for the three lake model studies the screening step categorised 46 23 and 21 parameters to be influential on two of the three output variables total chlorophyll a tn and tp for each lake model for lake hinge lake bryrup and lake ravn respectively table 2 for full table see appendix b in total 60 unique parameters were identified for further in depth analysis 3 2 parameter sensitivity across lake types in the screening step aggregated sensitivities of model parameters to model module level were overall similar for lake model outputs across the three different lake model studies with both the density based δ sensitivity measures fig 3 and the variance based sobol first order indices fig 4 however the models simulating the two deeper lakes lake bryrup and lake ravn were generally more sensitive to parameters related to mixing of the water column e g wind factor for summer mean water temperature nitrogen concentrations and phyto and zooplankton biomasses in contrast parameters related to the macrophytes module and particle dynamics e g resuspension kresusphytmax or kturbfish and phytoplankton growth cmumaxgren were more influential on determining model outputs in lake hinge compared with the two deeper lakes however as for tp both lake hinge and lake bryrup were more sensitive to parameters relating the benthic pelagic coupling e g resuspension than the deepest lake lake ravn thus lake bryrup shows an intermediate response between the shallowest and deepest lake depending on the model output the density based sensitivity screening showed overall similar sensitivity patterns though there were also clear differences in parameter sensitivity for some model outputs between the lakes for all three lake models a scale factor to the forcing wind speed wind factor in the hydrodynamic model was the most influential parameter in determining the summer mean surface water temperature figs 3 and 4 for the two deeper lakes lake bryrup and lake ravn where stratification occurs every summer almost all of the variance of the water temperature could be ascribed to this particular scale factor s1 0 95 0 001 and 0 96 0 0009 respectively in the lake model for shallow lake hinge the scale factor was also the most influential parameter hinge model δ 0 224 0003 and s1 0 125 0 007 however many parameters related to plankton and particle dynamics such as growth rates of all three phytoplankton groups zooplankton grazing and parameters related to particle resuspension by fish together contributed with more variability to water temperature fig 5 for inorganic and total nitrogen concentrations the lake bryrup and lake ravn models varied in influential parameters and modules compared with lake hinge phytoplankton growth and n uptake parameters contributed most to the aggregated variability per module for outputs of summer mean nitrate lake hinge and lake bryrup and ammonium concentrations all three lakes for the stratified lakes lake bryrup and lake ravn the nitrification rate constant cnitrw was the single most influential parameter explaining approx 30 of the variance in summer mean ammonium concentrations when disregarding parameter interactions appendix b several zooplankton parameters especially cfiltmax influenced the summer mean nitrate concentrations in the lake hinge and lake ravn models fig 3 summer mean tn concentrations were mostly driven by parameters controlling particle concentrations e g phytoplankton growth rates and zooplankton grazing in lake hinge parameters controlling phytoplankton growth and n mineralisation related parameters as well as wind factor in lake bryrup and parameters related zooplankton grazing and to nitrogen release from the bottom sediments in lake ravn fig 3 interestingly both the impacts of wind factor and sediment parameters increased with the depth of the lake model in the model for the deepest stratified lake wind factor contributed with approx 28 of variance in the tn summer mean without interaction effects for summer mean phosphate and total phosphorous concentrations the parameter sensitivity response was overall similar for the three lake models in all models parameters in the zooplankton module were of primary importance and those in the phytoplankton module of secondary importance except the lake bryrup tp output in determining p concentrations however notable differences occurred for lake hinge and lake ravn parameters determining zooplankton grazing ranked highest in sensitivity of tp concentrations and parameters describing p sediment mineralisation processes e g kpminpoms and cthetaminpoms were also classified as influential in the lake bryrup model and also secondary for lake hinge sedimentation and resuspension parameters were the most important in determining summer mean tp concentrations phyto and zooplankton outputs in general showed the same sensitivity response across all three lake models however some differences related to lake depth and trophic state occurred zooplankton grazing parameters cfiltmax and hfilt were the most dominant in determining summer mean phyto and zooplankton biomasses for all lakes for phytoplankton biomasses maximum growth rates for each specific phytoplankton cmumaxphyt and other phytoplankton related parameters e g temperature modifiers were also clearly influential fig 5 for most phytoplankton groups the maximum growth rate of other phytoplankton groups was also influential for instance in the lake ravn model the most influential parameter on diatom dw was maximum growth rate of cyanobacteria cmumaxblue silicate to dw ratios csiddiat in both water and sediment phytoplankton modules were the most influential parameters for both summer mean diatom and green algae biomasses in the lake bryrup model in contrast to the deeper lakes lake hinge had several influential parameters on phyto and zooplankton dynamics related to particle dynamics phytoplankton growth rate sedimentation and resuspension highlighting the interaction between the sediment and the pelagic domains in driving plankton dynamics in this the most shallow lake macrophyte growth rate cmumaxveg was the most influential parameter in determining the macrophyte biomass in the lake ravn and lake hinge models but was less important in the lake bryrup model here the migration rate cdvegin was the most influential parameter as a low calibrated value of the macrophyte growth rate prevented establishment of macrophytes the ability of the models to simulate the light environment was also influential on macrophyte biomass as particle dynamic parameters e g zooplankton grazing and the non visible fraction of shortwave radiation a gotm parameter were influential in turbid lake hinge and clear water lake ravn respectively in lake hinge the maximum growth rate of macrophytes was ranked in top 10 most influential parameters on summer mean ammonium nitrate tn phosphorus do and macrophytes biomass whereas maximum growth rate was influential in the lake bryrup and lake ravn models only for macrophytes and piscivorous biomass fig 5 the three fish groups were overall determined by parameters related to their food availability and predation from piscivorous fish on zooplankti benthivorous fish for zooplanktivorous fish juvenile fish the most influential parameters were related to phyto and zooplankton whereas for zoobenthivorous fish adult fish the single most influential parameter was zoobenthos assimilation efficiency kdassbent the inclusion of a positive effect on piscivorous assimilation with increased macrophytes biomass in the fabm pclake model was illustrated in the lake ravn model where macrophyte growth rate cmumaxveg δ 0 17 0 005 was the most influential parameter on the piscivorous fish biomass a similar response was not observed for the lake hinge surprisingly the most influential parameter in determining summer mean piscivorous fish biomass was the migration factor cdpiscin and no predation parameters were found to be influential for lake bryrup 3 3 in depth analysis with borgonovo s δ and sobol total order indices the in depth analysis corroborated the initial findings of the screening density based analysis for the two analysed models of shallow lake hinge and deep lake ravn the relative ranking of the most influential parameters was consistent across the δ and sobol total order indices though the variance based method gave consistently larger values when subtracting the δ measure of the dummy parameter from the estimated δ measures for summer mean chlorophyll a concentrations see fig 6 and appendix b zooplankton maximum filtration rate cfiltmax was the most influential parameter in determining summer mean tp and chlorophyll a concentrations for both lake hinge and lake ravn surprisingly maximum growth rate of green algae was the most influential parameter for summer mean tn concentrations in lake hinge the green algae group contributed with a minor fraction of the summer total phytoplankton biomass in lake hinge and therefore calibration and validation of green algae related model parameters were of less focus e g n dw ratios andersen et al 2020 the scale factor for wind speed wind factor was the most influential parameter in determining summer mean tn concentrations other top ranked influential parameters on tp tn and chlorophyll a concentrations were zooplankton preference factor for particulate organic matter cprefpom zooplankton half saturation constant hfilt maximum growth rate of diatoms cmumaxdiat and temperature optimum for zooplankton ctmoptzoo 4 discussion 4 1 parameter influence can differ between lakes we undertook a global sa with both density and variance based sensitivity methods to analyse the sensitivity of model outputs in the 1d hydrodynamic lake ecosystem model gotm fabm pclake for three different lakes overall the sensitivity responses of most summer mean model outputs were similar across the three lakes however some differences emerged which can be attributed to the type of the lakes and specifically their differing morphology ranging from shallow to deep the sa revealed increased influence of parameters describing the benthic pelagic coupling for the shallowest modelled lake lake hinge fig 5 resuspension and sedimentation parameters wind factor and all auxiliary parameters in fig 5 contributed with more variability to the summer mean temperature and nitrogen concentrations in lake hinge compared with the two deeper lakes this corroborates the mechanistic description of physical processes in gotm as less wind energy is required to break the water column stability and as wind events more easily resuspend particulates from the sediment in shallower than in deeper lakes kalff 2002 the influence of resuspension as a main process in regulating particle dynamics with consequences for water turbidity nutrient dynamics and biotic communities was also shown to be of key importance in another sensitivity study of a shallow lake model janse et al 2010 lake hinge is eutrophic so the amount of suspended particulates i e high concentration of phytoplankton also impacted light penetration and hence the heat captured in the water column which likely also increased the influence of resuspension on the modelled temperature output the sa of the models of the deep lake ravn and to a lesser degree also of the less deep lake bryrup emphasised the importance of the wind factor for temperature and its influence on the variability in nitrate and total nitrogen concentrations the scale factor for wind modifies the air water interactions that impact the mixing and water temperature in the epilimnion as well as the depth of the simulated thermocline the parameter was calibrated for all three lakes to account for local variations that is not taken into account in the wind forcings for instance a forest surrounding lake ravn trolle et al 2008a both lake models correctly simulated summer build up of phosphorus and ammonium concentrations in the hypolimnion chen et al 2019 trolle et al 2008b variability in summer nitrate concentrations in surface waters could partly be explained by changes in thermocline depth influencing hypolimnion ammonium concentrations and the transport of ammonium to the epilimnion where it is further oxidised to nitrate the importance of the wind scale factor and the influence of the light parameters from the hydrodynamic gotm model on many of the outputs of the fabm pclake model clearly illustrate the necessity of including the entire model complex and all parameters when performing a global sa to properly capture model sensitivity in general the most influential parameters were closely related but not limited to their derivative output variable and many parameters contributed with variability in the modelled output in all three lake models for example summer mean phytoplankton macrophyte and zooplankton biomasses were most sensitive to the maximum phytoplankton growth rate the maximum macrophyte growth rate and the maximum zooplankton filtration rate respectively the same general conclusions have been drawn in other lake ecosystem model sensitivity studies janse et al 2010 makler pick et al 2011 which stresses the importance of including all not just a subset of parameters in a sa in the in depth analysis zooplankton parameters such as maximum grazing rate cfiltmax and half saturation of food hfilt were found to be most influential on chlorophyll a tn and tp concentrations previous sensitivity studies of shallow lakes with the 0 dimensional 0d pclake model also ranked zooplankton grazing parameters as being very influential on simulated water quality variables janse et al 2010 nielsen et al 2014 both 1d fabm pclake and 0d pclake include only one zooplankton group in the food web in comparison a hydrodynamic ecological lake model dyresm caedym applied to lake kinneret israel included three groups of zooplankton and a global sensitivity study of this model did not rank zooplankton grazing parameters as most influential although the messy feeding and grazing rate of zooplankton was overall influential makler pick et al 2011 the secondary importance of zooplankton parameters compared with nutrient related processes may be explained by the fact that lake kinneret is bottom up controlled makler pick et al 2011 as is typical for warm lakes due to the overall higher fish predation on zooplankton suppressing the abundance and size jeppesen et al 2020 parameterisation of only one zooplankton group to describe an entire zooplankton community and its impact on the lake ecosystem is probably a too crude and insufficient assumption as most zooplankton communities vary with the season in both shallow and deep lakes across a trophic gradient jeppesen et al 2011 increasing the number of zooplankton groups would likely partition some of the sensitivity and increase the accuracy of the parameterisation the sa highlights the sensitivity of possible shifts in the simulated dominance of primary production between phytoplankton and macrophytes in shallow lakes by fabm pclake hence the trophic state of lakes which also differed between the three lakes in our study will likely also shape the sensitivity of the models similar results were found in a local sa applying 0d pclake to lake arreskov denmark nielsen et al 2014 the maximum growth rate of the macrophytes cmumaxveg was in the top 10 of the most influential parameters on summer mean chlorophyll a tn tp concentrations and macrophyte biomass nielsen et al 2014 however a sa conducted with the method of morris janse et al 2010 did not find cmumaxveg to be influential not even on macrophyte biomass although other macrophyte parameters such as the overwintering fraction of submerged vegetation fwinveg and macrophyte respiration rate kdrespveg were shown to impact the variability of simulated tn and tp outputs janse et al 2010 this sa was confined to analyse parameter sensitivity within the conceptual structure of gotm fabm pclake and did not evaluate impacts of different model structures for example ice coverage was not included in the gotm fabm pclake version applied in this study however it is now possible to simulate ice coverage in gotm http www github com gotm model last accessed november 1 2020 and it cannot be ruled out that this might have impacted both the simulated water quality and ecological state variables balayla et al 2010 and thereby parameter sensitivity with continued model development this highlights the need for more frequent application of sa in the modelling process 4 2 parameter sensitivity as a model evaluation tool a common modelling procedure is to rely on previous sensitivity studies when deciding which parameters to target during calibration and only rarely is a new sa conducted for a new model application to an individual lake however facilitated by parsac the sa methods presented in this study can now without much effort be applied before any new lake model application undergoes calibration parameter ranges in an initial sa should be based on literature values expert knowledge or similar model set ups as there are no calibration results to depend on during model calibration a sa could serve as an additional model evaluation tool and provide a system level assessment as presented in hipsey et al 2020 under the assumption that the influential parameters or modules when importance measures have been aggregated to module level identified by the sa of the models reflect the most important processes in each of the lakes then if a discrepancy was identified between empirical data and the outcomes of a sa in terms of the most influential parameters and processes this would warrant an investigation into the specific process and or entire model parameterisation and the cause of the discrepancy and thereby help improve the understanding of the interactions in lake ecosystem potential discrepancies could among other reasons be ascribed to wrongful parameter calibration the chance of the calibration process converging on one among several plausible combinations of model parameter values i e equifinality parameter ranges applied in the sa missing knowledge of processes in the ecosystem and or conceptual errors in the lake models if wrongful parameter values or equifinalty is the cause of the discrepancy this could warrant a new round of calibration or changes to the model structure to better reflect the knowledge of influential processes in the lake ecosystem for example a decoupling of the simulated piscivorous fish from the rest of the food web was identified in lake bryrup and a surprising impact of simulated green algae on tn concentrations was identified in lake hinge the two examples are not in correspondence with current knowledge of the systems modelled and therefore warrant investigations into these parameterisations and maybe further calibrations and or changes in the model structure 4 3 technical assessment of analysis approaches with the newly developed software application parsac we ran a global sa with both density and variance based sensitivity methods in a two step approach screening and in depth to fully analyse the hydrodynamic lake ecosystem model gotm fabm pclake by utilising parallel processing in the execution of model simulations parsac markedly decreased computing time thereby removing one of the obstacles to applying continuous sensitivity studies in the model development and application process jakeman et al 2006 robson et al 2008 for example on a microsoft windows server 2016 with four processors with 64 cores executing in total 36 100 model simulations for lake bryrup took less than 5 h parsac also benefits from the open source community as it is written in python and utilises salib sensitivity analysis library in python herman and usher 2017 4 4 variance based sensitivity corroborates density based parameter ranking the two step approach with a screening analysis followed by an in depth analysis applied in this study resembles other global sa approaches combining a screening and a global sa method as recommended by for instance saltelli et al 2008 by way of example a sensitivity study of the biogeochemical lake model pclake janse et al 2010 utilised the morris method morris 1991 saltelli et al 2008 and then the variance based fourier amplitude sensitivity test method saltelli et al 2008 whereas the sensitivity study of the lake ecosystem model caedym applied first recursive partitioning and regression trees breiman et al 1984 and general linear model laird and ware 1982 analysis methods and subsequently a generalized boosted modelling analysis friedman 1999 here we conducted an initial screening applying the density based method borgonovo s δ sensitivity measure with a lower sampling size in combination with an in depth analysis as this method met several criteria established for integrated models to be used in environmental management and decision making ravalico et al 2005 the method was capable of handling 300 parameters taking into account higher order parameter interactions and model non linearity not requiring knowledge of parameter probability distributions and output interpretable results another important criterion was that the method should be able to handle eventual removal of parameter sets i e for simulations that resulted in a model failure as running a global sa without detecting model errors would be unusual saltelli et al 2019 borgonovo s δ sensitivity measure relies on lhs which allows for removal of parameter sets without breaking the sampling strategy the removal of parameter sets was also tested see appendix b therefore what is traditionally viewed as a screening step was in this study in reality a full global sa and the following sa step was a test of the screening results with both a density and variance based method the density and variance based methods agreed in the ranking of the most influential parameters on simulated summer mean tn tp and chlorophyll a concentrations for the shallow lake hinge and deep lake ravn lakes subjected to in depth analysis figure s6 figure s7 and figure s8 the agreement between the parameter ranking of the density and variance based methods increased the confidence in which parameters are important borgonovo et al 2017 thus applying several sa methods following the initial density based analysis will function as a test and possible corroboration of the density based analysis instead of applying other sampling strategies and corresponding sensitivity methods several sensitivity methods can be based on lhs as exemplified in the given data approach by borgonovo et al 2017 for example first order sobol borgonovo s δ kuiper metric and the delsa methods were used to interrogate a hydrological model borgonovo et al 2017 overall the screening and in depth analysis replicated the ranking of the most influential parameters between the two lakes as the screening step in this study was a full global sa though with a lower sampling size and not a sensitivity screening method the discrepancy between the screening step and the in depth analysis step should be relatively low an advantage of the screening analysis was the inclusion of all model parameters which impacted the identification of most sensitive parameters in this study 4 5 impacts of parameter ranges on sensitivity the definition of parameter ranges included in the sa potentially has a significant impact on the results and should therefore be considered carefully in all sensitivity studies wagener and pianosi 2019 setting plausible ranges of allowed parameter values when sampling for the analysis may be a challenging task however sensitivity studies of aquatic ecosystem models have based parameter ranges on both literature and expert judgment e g makler pick et al 2011 missaghi et al 2013 percentage ranges from calibrated and or default model values e g bruce et al 2006 elliott et al 1999 or a combination of these e g omlin et al 2001 to properly capture the targeted lake s specific ecosystem dynamics and simulate different lake types this study applied 25 and 15 ranges on calibrated and validated parameter values for the lake hinge model total order sobol and borgonovo s δ in depth analysis agreed in the ranking of the most influential parameters on summer tn tp and chlorophyll a concentrations with 25 and 15 ranges on calibrated parameter values in contrast the lake ravn model was impacted by parameter range size as only 15 ranges and not 25 ranges sampled with saltelli sampling allowed error free model simulations but this does not necessarily mean that the parameter sensitivity would be different if model execution with 25 ranges were possible we also searched for patterns in the parameter sets of model crashes with a decision tree analysis decisiontreeclassifier in scikit learn version 0 23 1 pedregosa et al 2011 results not shown however no clear patterns emerged so removal of model crashes and their parameter sets likely did not impact the results as gotm fabm pclake is a complex model characterized with the equifinality issue beven 2006 the sa results could potentially also be impacted by this issue as the calibrated parameter values served as basis for parameter ranges in the sa even though the parameter range size of 25 and 15 was applied the equifinality issue re emphasises the need to not rely on a single or few sa studies but to apply sa actively in the modelling process 5 conclusions parallel sensitivity and auto calibration parsac with density and variance based sensitivity methods offers a powerful tool to aquatic ecosystem modellers investigating numerical models by applying global sa applying the density based global sa borgonovo s method as a screening step proved efficient in ranking the most influential parameters and the ranking was corroborated by the variance based sa sobol method when performing a global sa with lake ecosystem models all model parameters and the entire model complex should initially be included in the analysis and sa should preferably be performed for each individual study case as lake morphology and lake type can shape the parameter sensitivity of lake ecosystem models for total phosphorus we found that parameters related to the benthic pelagic coupling were particularly important for the shallower lakes and less so for the deepest lake for total nitrogen and to a lesser degree for nitrate we found that phytoplankton related parameters were the most sensitive for the shallower lakes whereas parameters related to the benthic pelagic coupling were more important for the deepest lake for chlorophyll a and the biomass of all phytoplankton groups we generally found that phytoplankton and zooplankton parameters were most important the latter to a lesser extent in the shallowest lake where resuspension also impacted output variability we infer that lake morphology shapes the parameter sensitivity of lake ecosystem models and should be factored in when experimenting with these models declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported partly by a research project on process based lake ecosystem models supported by the danish environmental protection agency by the danish council for independent research through the cashfish project and ph d funding by the sino danish center for education and research ej was also supported by the tübitak bideb 2232 program 118c250 we thank anne mette poulsen for valuable editorial assistance and the anonymous reviewer for their valuable comments which greatly improved the manuscript author contributions t k a and d t designed the research j b k b and t k a programmed the sensitivity software t k a performed the research t k a and d t analysed the data and t k a e j a n j b k b and d t wrote the paper appendix a supplementary data the following are the supplementary data to this article multimedia component 1 multimedia component 1 multimedia component 2 multimedia component 2 multimedia component 3 multimedia component 3 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104945 
25887,a global sensitivity analysis of a lake ecosystem model gotm fabm pclake was undertaken to test the impacts of lake morphology on parameter sensitivity in three different lakes the analysis was facilitated by the parallel sensitivity and auto calibration tool parsac and included a screening step with the density based borgonovo s method followed by in depth analysis with both borgonovo s and the variance based sobol methods the borgonovo s method proved efficient in ranking the most influential parameters and its results were corroborated by the sobol method for total phosphorus and total nitrogen parameters related to the benthic pelagic coupling and phytoplankton were particularly important for the shallower lakes whereas the most important parameters for total nitrogen were related mainly to the benthic pelagic coupling in the deepest lake for chlorophyll a phytoplankton and zooplankton parameters were most influential we conclude that lake morphology shapes the parameter sensitivity of lake ecosystem models keywords global sensitivity analysis lake ecosystem modelling process based modelling moment independent sensitivity method variance based sensitivity method fabm pclake software availability the parallel sensitivity and auto calibration parsac tool was developed by bolding bruggeman as a designated python package parsac version 0 5 7 bolding and bruggeman 2020 was applied in this study and is freely available via the python package manager pip install parsac user from pypi org the sensitivity analysis library in python salib herman and usher 2017 is a python implementation of commonly used sensitivity analysis methods including borgonovo s and sobol methods salib version 1 3 8 was used in this study and this and the newest version is freely available at www github com salib salib last accessed november 1 2020 and from pypi org the 1d hydrodynamic model general ocean turbulence model gotm burchard et al 1999 and the lake ecosystem model fabm pclake hu et al 2016 are public domain models that are freely available at www github com gotm model and www gitlab com fabm pclake pclake last accessed november 1 2020 respectively in this study the gotm fabm pclake model complex as configured and validated for the lake ravn trolle et al 2008b lake bryrup chen et al 2019 and lake hinge andersen et al 2020 was employed 1 introduction lake ecosystems and their biodiversity are currently under serious threat from eutrophication and global climate changes albert et al 2020 jeppesen et al 2014 wwf 2018 therefore lake ecosystem models are increasingly applied to simulate water quality and to gain a deeper understanding of lake ecosystem functioning trolle et al 2012 lake ecosystem models may also act as tools supporting management decisions and policy making for instance by quantifying the effectiveness of management measures hilt et al 2017 thereby providing information on how to best mitigate future impacts e g rolighed et al 2016 several complex aquatic ecosystem models are available mooij et al 2010 and have been used to assess the effect of different management measures and the impacts of future global climate changes for example i three different process based lake ecosystem models were used to project the response of phytoplankton to climate change in a small shallow danish lake trolle et al 2014 ii ensemble modelling with a hydrodynamic lake model explored the impacts of climate warming and increased frequency of heat waves on the thermal characteristics of a large sub tropical lake gal et al 2020 and iii the lake ecosystem model complex gotm fabm pclake was used to assess the level of external nutrient load reductions needed for a shallow lake to reach clear water conditions with a high coverage of submerged vegetation andersen et al 2020 the algorithms of complex environmental models often include hundreds of parameters many of which require tailored configuration and adjustment in each application case and model complexity will likely increase further in the future wagener and pianosi 2019 this is also true for lake ecosystem models robson 2014 and the majority of model parameters cannot be accurately measured or are unknown due to for instance lack of observations this means that modellers have to rely on literature values and calibration to identify the optimal parameter values to give a satisfactory description of the system being modelled to ensure robust and high quality model output it is vitally important to focus on accurately determining the parameters that are most influential for the model outputs arhonditsis and brett 2004 comprehensive sensitivity analysis sa can serve this purpose and is considered an important part of any due diligent modelling process jørgensen 1995 ravalico et al 2005 especially in a policy context saltelli and funtowicz 2014 this is also stressed by several agencies that recommend the use of sa as best practice in the development and application of models european commission 2005 u s epa 2009 sa methods have commonly been divided into two broad categories local sa methods where input parameters has been varied one at a time around a nominal value and global sa methods which attempts to explore the entire space of input parameters global sa is to be preferred in most cases as i it does not assume that the model is linear or additive which is rarely the case for any complex ecological model and because ii it accounts for the effects of interactions between model parameters saltelli et al 2008 saltelli and annoni 2010 local sa is still the most commonly used approach but global approaches have recently achieved increasing attention ferretti et al 2016 in the development and application of the most widely used lake models sa has usually been performed and reported but sa is typically not an integral and ongoing process in further model developments mooij et al 2010 application of lake models to specific case studies tends to rely on sa results to decide which parameters and their ranges to include in the calibration process e g di maggio et al 2016 rolighed et al 2016 sa of lake models has either been undertaken using local e g schladow and hamilton 1997 elliott et al 1999 nielsen et al 2014 or global e g bruce et al 2006 janse et al 2010 page et al 2017 sa methods due to the complexity of ecological models sa computation can be time consuming and computational costly and time and resources are only rarely available for conducting rigorous global sa of such models jakeman et al 2006 robson et al 2008 the sensitivity and calibration utility parsac parallel sensitivity analysis and calibration has the potential to greatly reduce the time required for conducting global sa by automating key steps in the procedure parsac is written in python for models with output in netcdf and model configuration files in namelist or yaml format to further reduce the computational burden the global sa may be divided into a screening step and a more detailed analysis step as recommended by saltelli et al 2008 the screening step aims to identify all non influential parameters conditional on the chosen target variable and concentrate the detailed global sa analysis on influential parameters this approach has also been applied to lake models with various sa methods e g janse et al 2010 makler pick et al 2011 parameterisation of environmental models can differ between sites and contexts and parameter sensitivity has also been shown to be potentially context specific wagener and pianosi 2019 for example parameter sensitivity of the soil and water assessment tool swat varied in two different watersheds and with different climatic conditions cibin et al 2010 this is likely also true for lake ecosystem models even though most lake models have been developed to cover the general behaviour and mechanisms of lake ecosystems they often need to be calibrated for a specific lake consequently the analysis may only provide information on influential parameters and model behaviour for that specific lake or lake type in this study we aim to evaluate the influence of lake morphology on the sensitivity of model parameters we provide the first comprehensive global sensitivity study of the 1 dimensional hydrodynamic lake ecosystem model complex gotm fabm pclake for three danish lakes with varying bathymetry max depth ranging from 2 to 33 m and trophic state ranging from meso to eutrophic model applications for these three lakes have previously undergone rigorous calibration and validation andersen et al 2020 chen et al 2019 trolle et al 2008b as shallow lakes likely have a tighter coupling between the pelagic benthic domains compared with deep lakes schindler and scheuerell 2002 we expect to identify more influential model parameters relating to this particular coupling in the shallow lakes sa has proven to be sensitive to the choice of methods wagener and pianosi 2019 we therefore applied two global sa methods the density based borgonovo s δ sensitivity measure and the widely used variance based first and total order sobol indices in a two step approach with a screening followed by an in depth analysis the global sa was performed with the sensitivity and calibration utility parsac version 0 5 7 which was chosen for its ability to minimise the computational burden and included both borgonovo s and the sobol methods the aim of the sensitivity analysis was to obtain insight into which model parameters are most influential in shaping model behaviour across different lake depths we provide a ranking of the most influential parameters for each lake on important model outputs which are typically targeted for calibration purposes we also exemplify usage of the sensitivity and calibration utility tool parsac the insight from sensitivity analysis in this work will be broadly applicable in future lake model case studies within the temperate zone and for the development of the next generation of lake ecosystem models 2 methods 2 1 the study design the focus of this sensitivity analysis is on the output variables that are most commonly examined in calibration and validation processes during a lake modelling case study table 1 the analysis includes three lakes with varying bathymetry and trophic state all located in denmark lake ravn lake bryrup and lake hinge for each lake the gotm fabm pclake model complex have been set up calibrated and validated in separate studies for details see andersen et al 2020 chen et al 2019 trolle et al 2008a to minimise effects of model initialisation model simulations included a warm up period of 5 years 1996 2000 before the analysis period of 5 years 2001 2005 and were configured with a 1 hourly time step and daily output values for layers in the surface ranging between 0 and 3 m all forcing and boundary conditions were lake specific output variables were processed across the analysis period into summer april to september mean values all 356 fabm pclake parameters and five common calibrated gotm parameters were included in the sa appendix a the parameter space was defined as 25 of the lake specific calibrated parameter values although the parameter space was bound by model constraints and not allowed to cross model limits e g a parameter describing a fraction ranging from 0 to 1 was bound within this range appendix a all parameter values were assumed to be uniformly distributed within the parameter space parsac bolding and bruggeman 2020 is a python package for sensitivity analysis and calibration designed specifically for models that take a long time to run it allows the work for a sensitivity analysis or calibration procedure to be distributed over multiple compute cores of a single workstation or high performance computing cluster which may potentially considerably reduce the time taken to complete the analysis parsac further emphasises traceability and reuse of model analyses which is made possible by logging parameter values and summary statistics for each model simulation to a mysql database https www mysql com last accessed november 1 2020 the package is model independent as it supports different mechanisms to configure parameters yaml files fortran namelists attributes of python objects and its access to model outputs e g reading spatiotemporally varying fields from netcdf files or calling python functions these features make it particularly suitable for analysis of gotm fabm which is configured through yaml files and writes outputs in netcdf format sensitivity analysis in parsac is built on top of salib sensitivity analysis library in python which supports a range of commonly used sensitivity analysis methods this study applied two global sensitivity methods the density based borgonovo s δ method and the widely used variance based sobol method to calculate first and total order indices fig 1 initially a sa with borgonovo s δ was applied to identify and separate influential from non influential parameters often referred to as the parameter fixing setting or parameter screening for this purpose a dummy parameter having no influence on the model output was included in the sampled parameter set in theory non influential parameters in the borgonovo s δ and sobol total order indices have a value of zero but due to numerical approximations in the sa algorithms the non influential parameters may obtain small non zero sensitivity indices the sensitivity index of the dummy parameter thus provided an indication of the approximation error of estimating sensitivity indices all parameters with a sensitivity index above the dummy parameter s confidence interval were classified as influential similar to this dummy approach has been applied in other sensitivity studies with complex environmental models e g zadeh et al 2017 the parameter space was sampled with latin hypercube sampling lhs with a sample size of 100 generating in total 36 200 model simulations for each lake model and confidence intervals were determined by bootstrap resampling of 100 samples and a confidence interval level of 0 95 herman and usher 2017 for further in depth analysis of the shallowest and the deepest lake the most influential parameters from lake hinge and lake ravn were selected based on the identified influential parameters from the screening analysis for the output variables total chlorophyll a chl a total phosphorus tp and total nitrogen tn to increase the strength of the analysis a sample size of 250 was applied for both the borgonovo s and sobol methods generated with lhs and saltelli s sampling scheme saltelli 2002 respectively to avoid numerical instabilities and consequently model crashes when running simulations with the generated parameter sets the parameter sampling range for the in depth analysis had to be constrained for lake ravn to 15 of lake specific calibrated parameter values in the lake hinge in depth sa both 25 and 15 of lake specific calibrated parameter values were applied to also compare in depth and screening results all results were analysed with confidence intervals determined by bootstrap resampling of 100 samples and a confidence interval level of 0 95 herman and usher 2017 2 2 global sensitivity analysis methods 2 2 1 the density based borgonovo s δ sensitivity measure the density based borgonovo s method borgonovo 2007 plischke et al 2013 is a global model and moment independent sensitivity measure that considers the entire model output distribution in order to quantify the relative influence of parameters on the model output the δ sensitivity measure is based on estimating the change between the probability distribution function pdf of the model output and the pdf of the model output conditional upon fixing a given input parameter let the model be represented by a function 1 y f x f x 1 x n where y is scalar model output and x x 1 x n is a set of n independent model parameters in this study the model parameters the separation between the unconditional probability distribution function of the model output f y y and the probability density conditional upon fixing input parameter x i f y x i y can be obtained by calculating 2 s x i f y y f y x i y d y the expected separation is then 3 e x i s x i f x i x i f y y f y x i y d y d x i and the sensitivity measure δ i for parameter x i can be defined as 4 δ i 1 2 e x i s x i i 1 n the δ represents the normalised expected shift in the distribution of y provoked by x i the δ sensitivity measure describes direct and indirect effects of the parameter and possesses several important properties 1 δ lies between 0 and 1 2 δ is zero when y is independent of x i and 3 δ equals unity when uncertainty in all model inputs is resolved δ 1 2 n 1 borgonovo 2017 to estimate δ for model parameters we applied the method laid out in plischke et al 2013 as included in the global sensitivity analysis software salib herman and usher 2017 this method also includes calculating sobol first order indices from lhs so sobol first order index is also applied to assess the screening results e g fig 4 model parameters were sampled with lhs assuming a uniform parameter distribution with a sampling size of n 100 and n 250 for the screening analysis and in depth analysis respectively one model output green algae dw in the lake ravn model was log transformed before borgonovo s δ was estimated to handle unreasonably high δ sensitivity measures 2 2 2 the variance based sobol s indices sobol s sensitivity analysis method sobol 2001 saltelli 2002 saltelli et al 2010 is a global and model independent sensitivity analysis that is based on variance decomposition it can handle non linear and non monotonic functions and models the variance based sobol s indices represent the fraction of the variance in the output that can be attributed to a given input alone first order s i or with consideration of the input interaction with all other model parameters included in the analysis total order s t i let the model be represented by a function 5 y f x f x 1 x n where y is scalar model output and x x 1 x n is a set of n independent model parameters the total unconditional variance of the model output v y can be decomposed as 6 v y i v i i j v i j v 1 2 n where v i is the partial variance of x i on y and is given by v i v e y x i while v i j is the impact of x i and x j on the total variance minus their first order effects using these partial variances the first and total order sobol sensitivity indices s i and s t i can be defined in relation to the total variance borgonovo 2017 saltelli et al 2008 where i 1 n 7 s i v i v y v e y x i v y 8 s t i 1 v i v y v e y x i v y to sample the parameter ranges and generate model inputs this study applied the saltelli extension of the sobol sequence to estimate the first and total order indices at a cost of n n 2 p 2 evaluations where n is the number of model simulations n is the number of samples to generate and p is the number of model parameters saltelli 2002 sobol first order sensitivity index is widely used and is a robust measure of functional dependence plischke et al 2013 saltelli et al 2008 a null value of the first order sensitivity measure does not imply that the model output is independent of the input parameter x i as interactions are not captured plischke et al 2013 saltelli et al 2008 2 3 the lake ecosystem model gotm fabm pclake we applied a lake adapted version of the one dimensional water column model gotm coupled with the lake ecosystem model fabm pclake the hydrodynamic and ecological lake model gotm fabm pclake describes conceptually the most important hydrodynamic and ecological processes in temperate lake ecosystems based on lake specific meteorological forcing in and outflows and a hypsograph i e the relation between depth and the corresponding horizontal area gotm simulates the vertical transport of momentum salt and heat through the water column this study utilised the k epsilon model for calculating the turbulence closure and the first order positive preserving and conservative extended modified patankar ordinary differential equation scheme for source and sink dynamics bruggeman et al 2007 fabm pclake is a dynamic complex lake ecosystem model which simulates nutrient and food web dynamics within the water column and the top sediment in each water layer hu et al 2016 the model is a redesign of the widely applied aquatic ecosystem model pclake janse 2005 the modelled lake ecosystem consists of variables describing oxygen dynamics organic and inorganic fractions of nitrogen phosphorus and silica three different groups of phytoplankton zooplankton zoobenthos plankti and benthivorous fish juveniles and adults piscivorous fish as well submerged vegetation fig 2 a full list of model parameters and state variables is available in hu et al 2016 2 4 the lake model cases a gotm fabm pclake model complex was set up calibrated and validated for three danish lakes lake hinge lake bryrup and lake ravn during a lake model pilot project for the danish environmental protection agency for calibrated parameter values see appendix a these lakes range from shallow to deep in a danish context lake hinge has a mean and maximum depth of 1 2 m and 2 6 m respectively a surface area of 0 91 km2 and a short hydraulic residence time of 16 32 days the water column in lake hinge rarely stratifies for periods longer than a week during summer the catchment area approximately 55 km2 comprises mainly agriculture 93 nielsen et al 2000 as reflected by the high external tp and tn loading of 2 1 3 7 mg yr and 62 121 mg yr respectively in 2001 2005 the lake is eutrophic with mean summer tp and chl a concentrations of approx 0 1 0 2 mg l and 60 150 μg l respectively a gotm fabm pclake model complex was set up calibrated and validated on lake hinge for the period 1993 2007 by andersen et al 2020 lake bryrup has a mean and maximum depth of 4 6 m and 9 m a surface area of 0 37 km2 and its hydraulic residence time varies between 2 and 3 months the lake is polymictic and stratifies temporarily during summer the catchment area is approximately 50 km2 with 60 of the area being used for agriculture nielsen et al 2000 the external loading of tp and tn to the lake was 0 7 1 2 mg yr and 51 80 mg yr respectively in 2001 2005 the lake frequently experienced cyanobacteria summer blooms and had a mean summer tp and chl a concentrations of approx 0 05 0 1 mg l and 25 50 μg l respectively a gotm fabm pclake model complex was set up calibrated and validated on lake bryrup for the period 1996 2005 by chen et al 2019 lake ravn has a mean and maximum depth of 15 m and 33 m respectively a surface area of 1 8 km2 and a hydraulic residence time of approx 1 8 years lake ravn is dimictic and the water column stratifies throughout summer until autumn may to october november the lake catchment 57 2 km2 is dominated by agriculture 70 nielsen et al 2000 in 2001 2005 the external nutrient loading of tp and tn to the lake was 0 8 mg tp yr and 47 108 mg tn yr the lake is classified as mesotrophic with mean summer tp and chl a concentrations of approx 15 23 μg l and 9 12 μg l respectively based on a previous lake model by trolle et al 2008a a gotm fabm pclake model complex was set up calibrated and validated on lake ravn for the period 1996 2005 with improvements in model performance for calibrated parameter values see appendix a meteorological data for atmospheric forcing of all three lake models were derived from the european ecmwf interim dataset dee et al 2011 monthly averages of water inflow m3 s and nutrient concentrations mg l were used as boundary conditions based on bimonthly measurements of inflow inorganic and total nitrogen and phosphorous concentrations from the danish monitoring program novana for lakes johansson et al 2015 combined with estimates from the dk qnp model for the ungauged catchment area thodsen et al 2016 the particulate organic fraction of the total phosphorus and nitrogen load was estimated for each individual lake as were the initialisation values for the sediment nutrient pool 3 results 3 1 screening by borgonovo s δ sensitivity measure a total of 108 300 model simulations were executed during the screening step and analysed with the density based borgonovo s method for the three lake model studies the screening step categorised 46 23 and 21 parameters to be influential on two of the three output variables total chlorophyll a tn and tp for each lake model for lake hinge lake bryrup and lake ravn respectively table 2 for full table see appendix b in total 60 unique parameters were identified for further in depth analysis 3 2 parameter sensitivity across lake types in the screening step aggregated sensitivities of model parameters to model module level were overall similar for lake model outputs across the three different lake model studies with both the density based δ sensitivity measures fig 3 and the variance based sobol first order indices fig 4 however the models simulating the two deeper lakes lake bryrup and lake ravn were generally more sensitive to parameters related to mixing of the water column e g wind factor for summer mean water temperature nitrogen concentrations and phyto and zooplankton biomasses in contrast parameters related to the macrophytes module and particle dynamics e g resuspension kresusphytmax or kturbfish and phytoplankton growth cmumaxgren were more influential on determining model outputs in lake hinge compared with the two deeper lakes however as for tp both lake hinge and lake bryrup were more sensitive to parameters relating the benthic pelagic coupling e g resuspension than the deepest lake lake ravn thus lake bryrup shows an intermediate response between the shallowest and deepest lake depending on the model output the density based sensitivity screening showed overall similar sensitivity patterns though there were also clear differences in parameter sensitivity for some model outputs between the lakes for all three lake models a scale factor to the forcing wind speed wind factor in the hydrodynamic model was the most influential parameter in determining the summer mean surface water temperature figs 3 and 4 for the two deeper lakes lake bryrup and lake ravn where stratification occurs every summer almost all of the variance of the water temperature could be ascribed to this particular scale factor s1 0 95 0 001 and 0 96 0 0009 respectively in the lake model for shallow lake hinge the scale factor was also the most influential parameter hinge model δ 0 224 0003 and s1 0 125 0 007 however many parameters related to plankton and particle dynamics such as growth rates of all three phytoplankton groups zooplankton grazing and parameters related to particle resuspension by fish together contributed with more variability to water temperature fig 5 for inorganic and total nitrogen concentrations the lake bryrup and lake ravn models varied in influential parameters and modules compared with lake hinge phytoplankton growth and n uptake parameters contributed most to the aggregated variability per module for outputs of summer mean nitrate lake hinge and lake bryrup and ammonium concentrations all three lakes for the stratified lakes lake bryrup and lake ravn the nitrification rate constant cnitrw was the single most influential parameter explaining approx 30 of the variance in summer mean ammonium concentrations when disregarding parameter interactions appendix b several zooplankton parameters especially cfiltmax influenced the summer mean nitrate concentrations in the lake hinge and lake ravn models fig 3 summer mean tn concentrations were mostly driven by parameters controlling particle concentrations e g phytoplankton growth rates and zooplankton grazing in lake hinge parameters controlling phytoplankton growth and n mineralisation related parameters as well as wind factor in lake bryrup and parameters related zooplankton grazing and to nitrogen release from the bottom sediments in lake ravn fig 3 interestingly both the impacts of wind factor and sediment parameters increased with the depth of the lake model in the model for the deepest stratified lake wind factor contributed with approx 28 of variance in the tn summer mean without interaction effects for summer mean phosphate and total phosphorous concentrations the parameter sensitivity response was overall similar for the three lake models in all models parameters in the zooplankton module were of primary importance and those in the phytoplankton module of secondary importance except the lake bryrup tp output in determining p concentrations however notable differences occurred for lake hinge and lake ravn parameters determining zooplankton grazing ranked highest in sensitivity of tp concentrations and parameters describing p sediment mineralisation processes e g kpminpoms and cthetaminpoms were also classified as influential in the lake bryrup model and also secondary for lake hinge sedimentation and resuspension parameters were the most important in determining summer mean tp concentrations phyto and zooplankton outputs in general showed the same sensitivity response across all three lake models however some differences related to lake depth and trophic state occurred zooplankton grazing parameters cfiltmax and hfilt were the most dominant in determining summer mean phyto and zooplankton biomasses for all lakes for phytoplankton biomasses maximum growth rates for each specific phytoplankton cmumaxphyt and other phytoplankton related parameters e g temperature modifiers were also clearly influential fig 5 for most phytoplankton groups the maximum growth rate of other phytoplankton groups was also influential for instance in the lake ravn model the most influential parameter on diatom dw was maximum growth rate of cyanobacteria cmumaxblue silicate to dw ratios csiddiat in both water and sediment phytoplankton modules were the most influential parameters for both summer mean diatom and green algae biomasses in the lake bryrup model in contrast to the deeper lakes lake hinge had several influential parameters on phyto and zooplankton dynamics related to particle dynamics phytoplankton growth rate sedimentation and resuspension highlighting the interaction between the sediment and the pelagic domains in driving plankton dynamics in this the most shallow lake macrophyte growth rate cmumaxveg was the most influential parameter in determining the macrophyte biomass in the lake ravn and lake hinge models but was less important in the lake bryrup model here the migration rate cdvegin was the most influential parameter as a low calibrated value of the macrophyte growth rate prevented establishment of macrophytes the ability of the models to simulate the light environment was also influential on macrophyte biomass as particle dynamic parameters e g zooplankton grazing and the non visible fraction of shortwave radiation a gotm parameter were influential in turbid lake hinge and clear water lake ravn respectively in lake hinge the maximum growth rate of macrophytes was ranked in top 10 most influential parameters on summer mean ammonium nitrate tn phosphorus do and macrophytes biomass whereas maximum growth rate was influential in the lake bryrup and lake ravn models only for macrophytes and piscivorous biomass fig 5 the three fish groups were overall determined by parameters related to their food availability and predation from piscivorous fish on zooplankti benthivorous fish for zooplanktivorous fish juvenile fish the most influential parameters were related to phyto and zooplankton whereas for zoobenthivorous fish adult fish the single most influential parameter was zoobenthos assimilation efficiency kdassbent the inclusion of a positive effect on piscivorous assimilation with increased macrophytes biomass in the fabm pclake model was illustrated in the lake ravn model where macrophyte growth rate cmumaxveg δ 0 17 0 005 was the most influential parameter on the piscivorous fish biomass a similar response was not observed for the lake hinge surprisingly the most influential parameter in determining summer mean piscivorous fish biomass was the migration factor cdpiscin and no predation parameters were found to be influential for lake bryrup 3 3 in depth analysis with borgonovo s δ and sobol total order indices the in depth analysis corroborated the initial findings of the screening density based analysis for the two analysed models of shallow lake hinge and deep lake ravn the relative ranking of the most influential parameters was consistent across the δ and sobol total order indices though the variance based method gave consistently larger values when subtracting the δ measure of the dummy parameter from the estimated δ measures for summer mean chlorophyll a concentrations see fig 6 and appendix b zooplankton maximum filtration rate cfiltmax was the most influential parameter in determining summer mean tp and chlorophyll a concentrations for both lake hinge and lake ravn surprisingly maximum growth rate of green algae was the most influential parameter for summer mean tn concentrations in lake hinge the green algae group contributed with a minor fraction of the summer total phytoplankton biomass in lake hinge and therefore calibration and validation of green algae related model parameters were of less focus e g n dw ratios andersen et al 2020 the scale factor for wind speed wind factor was the most influential parameter in determining summer mean tn concentrations other top ranked influential parameters on tp tn and chlorophyll a concentrations were zooplankton preference factor for particulate organic matter cprefpom zooplankton half saturation constant hfilt maximum growth rate of diatoms cmumaxdiat and temperature optimum for zooplankton ctmoptzoo 4 discussion 4 1 parameter influence can differ between lakes we undertook a global sa with both density and variance based sensitivity methods to analyse the sensitivity of model outputs in the 1d hydrodynamic lake ecosystem model gotm fabm pclake for three different lakes overall the sensitivity responses of most summer mean model outputs were similar across the three lakes however some differences emerged which can be attributed to the type of the lakes and specifically their differing morphology ranging from shallow to deep the sa revealed increased influence of parameters describing the benthic pelagic coupling for the shallowest modelled lake lake hinge fig 5 resuspension and sedimentation parameters wind factor and all auxiliary parameters in fig 5 contributed with more variability to the summer mean temperature and nitrogen concentrations in lake hinge compared with the two deeper lakes this corroborates the mechanistic description of physical processes in gotm as less wind energy is required to break the water column stability and as wind events more easily resuspend particulates from the sediment in shallower than in deeper lakes kalff 2002 the influence of resuspension as a main process in regulating particle dynamics with consequences for water turbidity nutrient dynamics and biotic communities was also shown to be of key importance in another sensitivity study of a shallow lake model janse et al 2010 lake hinge is eutrophic so the amount of suspended particulates i e high concentration of phytoplankton also impacted light penetration and hence the heat captured in the water column which likely also increased the influence of resuspension on the modelled temperature output the sa of the models of the deep lake ravn and to a lesser degree also of the less deep lake bryrup emphasised the importance of the wind factor for temperature and its influence on the variability in nitrate and total nitrogen concentrations the scale factor for wind modifies the air water interactions that impact the mixing and water temperature in the epilimnion as well as the depth of the simulated thermocline the parameter was calibrated for all three lakes to account for local variations that is not taken into account in the wind forcings for instance a forest surrounding lake ravn trolle et al 2008a both lake models correctly simulated summer build up of phosphorus and ammonium concentrations in the hypolimnion chen et al 2019 trolle et al 2008b variability in summer nitrate concentrations in surface waters could partly be explained by changes in thermocline depth influencing hypolimnion ammonium concentrations and the transport of ammonium to the epilimnion where it is further oxidised to nitrate the importance of the wind scale factor and the influence of the light parameters from the hydrodynamic gotm model on many of the outputs of the fabm pclake model clearly illustrate the necessity of including the entire model complex and all parameters when performing a global sa to properly capture model sensitivity in general the most influential parameters were closely related but not limited to their derivative output variable and many parameters contributed with variability in the modelled output in all three lake models for example summer mean phytoplankton macrophyte and zooplankton biomasses were most sensitive to the maximum phytoplankton growth rate the maximum macrophyte growth rate and the maximum zooplankton filtration rate respectively the same general conclusions have been drawn in other lake ecosystem model sensitivity studies janse et al 2010 makler pick et al 2011 which stresses the importance of including all not just a subset of parameters in a sa in the in depth analysis zooplankton parameters such as maximum grazing rate cfiltmax and half saturation of food hfilt were found to be most influential on chlorophyll a tn and tp concentrations previous sensitivity studies of shallow lakes with the 0 dimensional 0d pclake model also ranked zooplankton grazing parameters as being very influential on simulated water quality variables janse et al 2010 nielsen et al 2014 both 1d fabm pclake and 0d pclake include only one zooplankton group in the food web in comparison a hydrodynamic ecological lake model dyresm caedym applied to lake kinneret israel included three groups of zooplankton and a global sensitivity study of this model did not rank zooplankton grazing parameters as most influential although the messy feeding and grazing rate of zooplankton was overall influential makler pick et al 2011 the secondary importance of zooplankton parameters compared with nutrient related processes may be explained by the fact that lake kinneret is bottom up controlled makler pick et al 2011 as is typical for warm lakes due to the overall higher fish predation on zooplankton suppressing the abundance and size jeppesen et al 2020 parameterisation of only one zooplankton group to describe an entire zooplankton community and its impact on the lake ecosystem is probably a too crude and insufficient assumption as most zooplankton communities vary with the season in both shallow and deep lakes across a trophic gradient jeppesen et al 2011 increasing the number of zooplankton groups would likely partition some of the sensitivity and increase the accuracy of the parameterisation the sa highlights the sensitivity of possible shifts in the simulated dominance of primary production between phytoplankton and macrophytes in shallow lakes by fabm pclake hence the trophic state of lakes which also differed between the three lakes in our study will likely also shape the sensitivity of the models similar results were found in a local sa applying 0d pclake to lake arreskov denmark nielsen et al 2014 the maximum growth rate of the macrophytes cmumaxveg was in the top 10 of the most influential parameters on summer mean chlorophyll a tn tp concentrations and macrophyte biomass nielsen et al 2014 however a sa conducted with the method of morris janse et al 2010 did not find cmumaxveg to be influential not even on macrophyte biomass although other macrophyte parameters such as the overwintering fraction of submerged vegetation fwinveg and macrophyte respiration rate kdrespveg were shown to impact the variability of simulated tn and tp outputs janse et al 2010 this sa was confined to analyse parameter sensitivity within the conceptual structure of gotm fabm pclake and did not evaluate impacts of different model structures for example ice coverage was not included in the gotm fabm pclake version applied in this study however it is now possible to simulate ice coverage in gotm http www github com gotm model last accessed november 1 2020 and it cannot be ruled out that this might have impacted both the simulated water quality and ecological state variables balayla et al 2010 and thereby parameter sensitivity with continued model development this highlights the need for more frequent application of sa in the modelling process 4 2 parameter sensitivity as a model evaluation tool a common modelling procedure is to rely on previous sensitivity studies when deciding which parameters to target during calibration and only rarely is a new sa conducted for a new model application to an individual lake however facilitated by parsac the sa methods presented in this study can now without much effort be applied before any new lake model application undergoes calibration parameter ranges in an initial sa should be based on literature values expert knowledge or similar model set ups as there are no calibration results to depend on during model calibration a sa could serve as an additional model evaluation tool and provide a system level assessment as presented in hipsey et al 2020 under the assumption that the influential parameters or modules when importance measures have been aggregated to module level identified by the sa of the models reflect the most important processes in each of the lakes then if a discrepancy was identified between empirical data and the outcomes of a sa in terms of the most influential parameters and processes this would warrant an investigation into the specific process and or entire model parameterisation and the cause of the discrepancy and thereby help improve the understanding of the interactions in lake ecosystem potential discrepancies could among other reasons be ascribed to wrongful parameter calibration the chance of the calibration process converging on one among several plausible combinations of model parameter values i e equifinality parameter ranges applied in the sa missing knowledge of processes in the ecosystem and or conceptual errors in the lake models if wrongful parameter values or equifinalty is the cause of the discrepancy this could warrant a new round of calibration or changes to the model structure to better reflect the knowledge of influential processes in the lake ecosystem for example a decoupling of the simulated piscivorous fish from the rest of the food web was identified in lake bryrup and a surprising impact of simulated green algae on tn concentrations was identified in lake hinge the two examples are not in correspondence with current knowledge of the systems modelled and therefore warrant investigations into these parameterisations and maybe further calibrations and or changes in the model structure 4 3 technical assessment of analysis approaches with the newly developed software application parsac we ran a global sa with both density and variance based sensitivity methods in a two step approach screening and in depth to fully analyse the hydrodynamic lake ecosystem model gotm fabm pclake by utilising parallel processing in the execution of model simulations parsac markedly decreased computing time thereby removing one of the obstacles to applying continuous sensitivity studies in the model development and application process jakeman et al 2006 robson et al 2008 for example on a microsoft windows server 2016 with four processors with 64 cores executing in total 36 100 model simulations for lake bryrup took less than 5 h parsac also benefits from the open source community as it is written in python and utilises salib sensitivity analysis library in python herman and usher 2017 4 4 variance based sensitivity corroborates density based parameter ranking the two step approach with a screening analysis followed by an in depth analysis applied in this study resembles other global sa approaches combining a screening and a global sa method as recommended by for instance saltelli et al 2008 by way of example a sensitivity study of the biogeochemical lake model pclake janse et al 2010 utilised the morris method morris 1991 saltelli et al 2008 and then the variance based fourier amplitude sensitivity test method saltelli et al 2008 whereas the sensitivity study of the lake ecosystem model caedym applied first recursive partitioning and regression trees breiman et al 1984 and general linear model laird and ware 1982 analysis methods and subsequently a generalized boosted modelling analysis friedman 1999 here we conducted an initial screening applying the density based method borgonovo s δ sensitivity measure with a lower sampling size in combination with an in depth analysis as this method met several criteria established for integrated models to be used in environmental management and decision making ravalico et al 2005 the method was capable of handling 300 parameters taking into account higher order parameter interactions and model non linearity not requiring knowledge of parameter probability distributions and output interpretable results another important criterion was that the method should be able to handle eventual removal of parameter sets i e for simulations that resulted in a model failure as running a global sa without detecting model errors would be unusual saltelli et al 2019 borgonovo s δ sensitivity measure relies on lhs which allows for removal of parameter sets without breaking the sampling strategy the removal of parameter sets was also tested see appendix b therefore what is traditionally viewed as a screening step was in this study in reality a full global sa and the following sa step was a test of the screening results with both a density and variance based method the density and variance based methods agreed in the ranking of the most influential parameters on simulated summer mean tn tp and chlorophyll a concentrations for the shallow lake hinge and deep lake ravn lakes subjected to in depth analysis figure s6 figure s7 and figure s8 the agreement between the parameter ranking of the density and variance based methods increased the confidence in which parameters are important borgonovo et al 2017 thus applying several sa methods following the initial density based analysis will function as a test and possible corroboration of the density based analysis instead of applying other sampling strategies and corresponding sensitivity methods several sensitivity methods can be based on lhs as exemplified in the given data approach by borgonovo et al 2017 for example first order sobol borgonovo s δ kuiper metric and the delsa methods were used to interrogate a hydrological model borgonovo et al 2017 overall the screening and in depth analysis replicated the ranking of the most influential parameters between the two lakes as the screening step in this study was a full global sa though with a lower sampling size and not a sensitivity screening method the discrepancy between the screening step and the in depth analysis step should be relatively low an advantage of the screening analysis was the inclusion of all model parameters which impacted the identification of most sensitive parameters in this study 4 5 impacts of parameter ranges on sensitivity the definition of parameter ranges included in the sa potentially has a significant impact on the results and should therefore be considered carefully in all sensitivity studies wagener and pianosi 2019 setting plausible ranges of allowed parameter values when sampling for the analysis may be a challenging task however sensitivity studies of aquatic ecosystem models have based parameter ranges on both literature and expert judgment e g makler pick et al 2011 missaghi et al 2013 percentage ranges from calibrated and or default model values e g bruce et al 2006 elliott et al 1999 or a combination of these e g omlin et al 2001 to properly capture the targeted lake s specific ecosystem dynamics and simulate different lake types this study applied 25 and 15 ranges on calibrated and validated parameter values for the lake hinge model total order sobol and borgonovo s δ in depth analysis agreed in the ranking of the most influential parameters on summer tn tp and chlorophyll a concentrations with 25 and 15 ranges on calibrated parameter values in contrast the lake ravn model was impacted by parameter range size as only 15 ranges and not 25 ranges sampled with saltelli sampling allowed error free model simulations but this does not necessarily mean that the parameter sensitivity would be different if model execution with 25 ranges were possible we also searched for patterns in the parameter sets of model crashes with a decision tree analysis decisiontreeclassifier in scikit learn version 0 23 1 pedregosa et al 2011 results not shown however no clear patterns emerged so removal of model crashes and their parameter sets likely did not impact the results as gotm fabm pclake is a complex model characterized with the equifinality issue beven 2006 the sa results could potentially also be impacted by this issue as the calibrated parameter values served as basis for parameter ranges in the sa even though the parameter range size of 25 and 15 was applied the equifinality issue re emphasises the need to not rely on a single or few sa studies but to apply sa actively in the modelling process 5 conclusions parallel sensitivity and auto calibration parsac with density and variance based sensitivity methods offers a powerful tool to aquatic ecosystem modellers investigating numerical models by applying global sa applying the density based global sa borgonovo s method as a screening step proved efficient in ranking the most influential parameters and the ranking was corroborated by the variance based sa sobol method when performing a global sa with lake ecosystem models all model parameters and the entire model complex should initially be included in the analysis and sa should preferably be performed for each individual study case as lake morphology and lake type can shape the parameter sensitivity of lake ecosystem models for total phosphorus we found that parameters related to the benthic pelagic coupling were particularly important for the shallower lakes and less so for the deepest lake for total nitrogen and to a lesser degree for nitrate we found that phytoplankton related parameters were the most sensitive for the shallower lakes whereas parameters related to the benthic pelagic coupling were more important for the deepest lake for chlorophyll a and the biomass of all phytoplankton groups we generally found that phytoplankton and zooplankton parameters were most important the latter to a lesser extent in the shallowest lake where resuspension also impacted output variability we infer that lake morphology shapes the parameter sensitivity of lake ecosystem models and should be factored in when experimenting with these models declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported partly by a research project on process based lake ecosystem models supported by the danish environmental protection agency by the danish council for independent research through the cashfish project and ph d funding by the sino danish center for education and research ej was also supported by the tübitak bideb 2232 program 118c250 we thank anne mette poulsen for valuable editorial assistance and the anonymous reviewer for their valuable comments which greatly improved the manuscript author contributions t k a and d t designed the research j b k b and t k a programmed the sensitivity software t k a performed the research t k a and d t analysed the data and t k a e j a n j b k b and d t wrote the paper appendix a supplementary data the following are the supplementary data to this article multimedia component 1 multimedia component 1 multimedia component 2 multimedia component 2 multimedia component 3 multimedia component 3 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104945 
25888,the accurate understanding of the human modified water cycle calls for a detailed representation of human and water systems including relevant non linearities and of the feedback responses between them this paper couples a microeconomic positive multi attribute utility programming model with a hydrologic modeling system hec hms with the objective of incorporating the behavior and adaptive responses of human agents into the representation of the human modified water cycle the coupling occurs in a sequential fashion using bidirectional protocols that represent the feedback responses between the microeconomic and hydrologic modules through common spatial elements and variables the proposed model is illustrated with an application to agricultural water management in the upper tagus river basin in spain the non linear responses observed in the modeled human water system suggest that strengthening the agricultural water allocation constraint can avert or delay drought negative environmental impacts with a less than proportional yet incremental impact on gross value added and employment keywords water resources management hydroeconomic modeling hec hms mathematical programming 1 introduction water withdrawals are increasing worldwide mainly due to population growth and economic development un 2018 at the same time climate change is expected to reduce water availability in many arid and semi arid basins notably those of the mediterranean region and middle east high confidence ipcc 2018 the combined effects of increasing demand and decreasing supply can potentially aggravate the economic and environmental impacts of water scarcity and droughts world bank 2016 in this context there is a growing pressure to formulate policies that reallocate available water resources among competing uses so to mitigate economic losses and ensure enough resources are reserved for the public good grafton et al 2018 such demand side approach can induce non linear and non trivial behavioral changes in economic agents that may affect water and land management change the trajectory of hydrologic systems create feedback responses from human systems and further impact water and land management practices alam 2015 hence addressing water scarcity challenges demands innovative integrated approaches to water resources research and hydroeconomic modeling in particular loon et al 2016 pande and sivapalan 2017 sivapalan et al 2014 hydrologic and economic modeling play a critical role in defining adaptation strategies to water scarcity and droughts they inform policy makers on the economic and environmental outcomes of projected policies and the relevant tradeoffs between them and help prevent maladaptation economics and civil engineering are historically kindred disciplines dupuit 1844 that in the case of water resources management converge into the area of hydroeconomics optimization typically provides the mathematical link between the two disciplines civil engineering hydrology evaluates the costs of building operating and maintaining water works and estimates water requirements economics evaluates the utility relevant attributes driving human responses to key stimuli so to predict future adaptive behavior and mathematically stated objective functions subject to physical and socioeconomic constraints resolve the water allocation problem harou et al 2009 based on how the hydrologic and economic sub models interact to represent processes and decisions hydroeconomic models can be broadly segregated into modular and holistic brouwer and hofkes 2008 conventional holistic models typically estimate economic agents responses to policy shocks or other stimuli using an external economic sub model which is subsequently integrated in the architecture of the hydrologic model through piecewise equations this offers the advantage of a more straightforward and effective representation of causal relationships and interdependencies while reducing computational costs on the other hand the modular approach resolves the economic and hydrologic sub models separately connecting them in sequence this offers increased probability of convergence to an optimal solution and potentially higher detail in the representation of each sub field which can be independently developed and adjusted both holistic and modular approaches have been applied to water resources planning and management in the past albeit the former is prevalent given the supply side emphasis of conventional water policy where focus is placed on building operating and maintaining water works to meet demands blair and buytaert 2016 harou et al 2009 however where policies may induce behavioral responses that significantly impact the water system as happens with demand side approaches such as water pricing markets or caps understanding and interpreting the human modified water cycle requires the explicit inclusion of feedbacks between human and water systems so to allow for a richer understanding of coupled human water system dynamics that better represents water and land management operations sivapalan et al 2014 relevant contributions towards a more detailed representation of agents autonomous adaptation behavior in complex human water systems have been recently made in the area of socio hydrology sivapalan and blöschl 2015 socio hydrology conceives complex human water systems as an ensemble of many elements where the different elements of the system are conceptualized through nested hierarchies of models that are able to exchange and communicate information blair and buytaert 2016 such modular framework has the additional advantage of making possible the addition of nonlinearity to each element of the system so that surprises are not so surprising and can be adequately understood levin et al 2013 and explored using uncertainty analysis tools such as scenario discovery baldassarre et al 2016 this does not mean that all the processes occurring in the human water system need be full fledged models depending on the problem at hand subsystems can be grouped e g hydrological and microeconomic systems or divided also while relevant subsystems can be represented through individual modeling components use of single differential equations that relate the function with its derivatives is acceptable e g to represent less important elements sivapalan and blöschl 2015 this paper builds socio hydrology inspired science by developing a methodological framework to couple a microeconomic positive multi attribute utility programming pmaup model that represents the behavior of irrigators and simulates their adaptive responses gómez limón et al 2016 gutiérrez martín and gómez 2011 with a hydrologic modeling system hec hms designed to simulate the rainfall runoff processes of dendritic basins ceiwr hec 2018 while hec hms is a popular tool for the development of hydrologic applications this is to the best of our knowledge the first study that uses hec hms in concert with an agricultural economics module the coupling between the pmaup model and hec hms occurs in a sequential fashion using protocols i e rules designed to manage relationships and processes between modules csete and doyle 2002 protocols enable the simulation of the interconnected dynamics and feedback responses between the microeconomic and hydrologic module through common spatial crop portfolio and related land use changes and water availability variables to this end we integrate farmers responses as predicted by the microeconomic module into the hydrological module through the explicit representation of crop portfolio land use decisions and related irrigation water use and consumption in hec hms and use this information as an additional input to hydrologic simulations thus allowing the assessment of the impacts of human agency on the water cycle and potential feedbacks the methods presented in this paper contribute to the literature on socio hydrology and hydroeconomic research in three ways 1 the modular integrated framework proposed in this paper rationalizes human water system analysis and aspires to provide a more profound understanding and a more accurate representation of human agency and the feedbacks between human and water systems in dendritic basins 2 we present a new set of bidirectional protocols based on land use and water availability variables to couple human and water systems and conceptualize the relevant two way feedbacks happening between them 3 the coupling is designed to be flexible i e allowing for alternative microeconomic models to be used and replicable i e to involve alternative hydrologic models by adapting the coupling variables the flexibility and replicability of the proposed approach combined with recent advances in socio hydrology through protocols and modularity see e g essenfelder et al 2018 esteve et al 2015 are instrumental towards the development of uncertainty assessments that go beyond conventional scenario discovery to include multi system ensemble experiments that sample parameter and structural uncertainties in socio hydrology modeling 2 methods 2 1 the microeconomic module positive multi attribute utility programming pmaup human agency in agricultural water management and water resources allocation is typically represented through microeconomic modeling approaches graveline 2016 microeconomic models are a mathematically stated representation of the behavior of socioeconomic agents that can be used to understand and predict their responses to key stimuli given a number of physical and or socioeconomic restrictions i e domain rational agents in microeconomic models are capable of resolving complex input allocation problems so to maximize the utility derived from one single attribute or many multi attribute utility relevant attributes within the domain this complex decision making process can be modeled following a normative or calibrated i e positive objective function normative models are based on value judgments and expert opinions that prescribe an objective function which can range from simple linear profit maximization to more sophisticated representations of human agency through e g state contingent approach chambers and quiggin 2000 positive models in contrast use calibration methods to elicit the parameters of an objective function that represents observed choices i e realized crop portfolio choices positive models can be broadly classified in linear programming paris 2015 positive mathematical programming howitt 1995 and pmaup gómez limón et al 2016 pérez blanco and gutiérrez martín 2017 microeconomic models start from a generic utility maximization problem that complies with a domain fx with an objective function u x that considers one or multiple objectives through a vector of attributes z x 1 m a x u x x u z 1 x z 2 x z 3 x z m x 2 s t 0 x c 1 3 c 1 n x c 1 4 x f x 5 z x r m the decision variable or crop portfolio vector x comprises the fraction of land allocated to each individual crop xc typically each individual crop xc represents a unique combination of cultivars management techniques and capital investment which results in a unique combination of attributes z xc z xi rational agents will decide on the crop portfolio x so to maximize the utility derived from attributes z x within a domain fx conformed by measurable and quantifiable water land climatic agronomic and policy constraints see annex i in the online supplementary material for a detailed description of model constraints pérez blanco and gutiérrez martín 2017 of particular interest to this research is the water availability constraint 6 c 1 n w c x c w where w i wirepresents water requirements per crop per hectare and w represents the total water allotment in our application of the proposed coupling framework we rely on a pmaup model to simulate the behavior and responses of the agents in this case the agricultural water demand units awdus which are a frequently used irrigation unit in spain defined as groups of irrigators sharing a common source of water territorial administrative and hydrological characteristics trba 2016 note again that the model is flexible and use of alternative microeconomic models as well as agent types e g farmers agricultural districts could be explored the calibration of the pmaup model follows a positive approach the observed decision by the rational agent i e realized crop portfolio x 0 is assumed to be the one that maximizes utility for a given set of restrictions or domain thus any deviation of the calibrated crop portfolio x i e the solution to the utility maximization problem in eq 1 5 from the observed crop portfolio x 0 is interpreted as a calibration residual the pmaup model sets to elicit the parameters of the objective function that minimize the distance between observed and calibrated decisions this is done in four steps 1 the marginal rate of transformation m r t i j along the efficiency frontier i e the rate at which the provision of one attribute i can be redirected into the provision of another attribute j through a reallocation of inputs is obtained 2 the marginal rate of substitution m r s i j of the utility function i e the rate at which the agent can give up one unit of attribute i in exchange of one unit of attribute j is obtained 3 we equalize the m r t i j to the m r s i j and resolve the resulting system of equations to elicit the parameters of the utility function for each possible combination of attributes considered 4 we obtain the calibrated crop portfolio x for each possible combination of attributes utility function and measure the distance to the observed crop portfolio x 0 the utility function that minimizes the calibration residual is revealed preferred and used in the simulations a mathematical formulation of the pmaup calibration procedure is available in annex ii in the online supplementary material 2 2 the hydrologic module hydrologic engineering center s hydrologic modeling system hec hms the water system is modeled using the hydrologic engineering center s hydrologic modeling system hec hms v 4 3 hec hms is an open access semi distributed hydrologic model for simulating the rainfall runoff process of dendritic basins the model is typically used to simulate flood and drought events although continuous hydrologic simulations can also be used to simulate the water cycle in the longer term hec hms divides the water system of a basin into manageable sub basins and water cycle processes and uses mathematical modules to represent any flux within a given sub basin and process e g streamflow there are four critical model components to any hec hms simulation i basin model components ii meteorological model components iii control specification components and iv input data components basin model components conform the physical representation of the basin in hec hms the basin is typically divided into interconnected sub basins within a river network sub basin units are obtained from the digital elevation model dem layer combining the flow accumulation adjoint catchment and drainage line layers using the area threshold or slope area method with the area threshold method being used in this study due to the gridded nature of the input datasets employed in the coupling framework other hydrologic elements used in the basin model include reach junction reservoir sink and diversion which are placed in a spatial context through background maps precipitation losses streamflow infiltration and baseflow i e minimum water depth on top of which additional runoff accumulates simulations are obtained using a combination of the following hec hms standard methods simple canopy canopy layer simple surface surface layer between canopy and soil layer soil moisture accounting loss method scs unit hydrograph transformation method which converts precipitation into runoff and linear reservoir baseflow meteorological model components include precipitation shortwave radiation longwave radiation evapotranspiration and snowmelt our application to agricultural water management uses observed exogenous data on irrigation water withdrawals application and consumption to run hydrologic and microeconomic simulations so to ensure consistency between the two modules which makes the use of shortwave radiation longwave radiation and evapotranspiration variables to assess irrigation demand redundant control specifications define the start date end date and time interval october september and daily respectively in our application model setting is completed combining the basin model meteorological model and control specifications with input data components that assign precipitation and discharge time series data to the relevant sub basin the hydrologic model used in this study hec hms simulates the movement and storage of water in vegetation soil surface and soil layer and groundwater layers two layers plus a deep aquifer to this end hec hms uses the canopy layer surface layer and soil water accounting loss method to separate precipitation data into losses through canopy interception surface storage and infiltration into aquifers and net precipitation i e the difference between total rainfall and losses the latter is used as an input to the transformation method to calculate runoff which is added in turn to baseflow alternative land uses through e g crop choices affect the movement of water in a watershed in different ways for instance precipitation or water from irrigation systems might be intercepted by the canopy of the vegetation covering certain area of land and different crops have different canopy interception storages water that is intercepted by canopy does not reach the soil surface in hec hms precipitation becomes available for filling other volumes only after canopy interception storage is filled while water in canopy interception storage is removed only by evaporation the water that reaches the soil surface may runoff on the surface which is also a function of the land cover or infiltrate to the soil profile storage which is divided in upper zone where percolation occurs and tension zone when water percolates from the soil profile storage it reaches the groundwater storage water stored in the groundwater systems may either return to the watershed by means of baseflow or percolate from the first groundwater layer to the second or from the second groundwater layer to deep percolation which in this case represents a loss from the system note that there are alternative hydrogeological models that offer a more precise representation of groundwater dynamics e g modflow hughes et al 2017 better suited to model impacts on the human modified water system where aquifers are the main water source for irrigation this is not the case in our case study area where 99 of irrigation withdrawals come from surface water bodies the calculations above are performed for each sub basin within the network next reservoirs are incorporated into the model and its historical management rules calibrated using discharge data downstream the reservoirs as a reference finally the routing process is used to simulate stage and discharge and assess the hydrograph along stream channels so to reproduce the observed conditions of the basin with the minimum possible error 2 3 protocols and coupling the proposed integrated hydroeconomic modeling framework operates through an iterative modular approach that runs the microeconomic and hydrologic modules independently modules in turn are connected and exchange information through protocols i e rules designed to manage relationships and processes between modules the use of protocols enables the simulation of interconnected dynamics and feedback responses between human water systems two protocols working in opposite ways so to reproduce feedback responses are developed the first protocol connects the hydrologic to the microeconomic model while the second protocol connects the microeconomic to the hydrologic model where changes in the water cycle following hydrologic simulations e g reduced discharge during a drought strengthen the water availability constraint for irrigation the first protocol is activated and simulations are run in the microeconomic model to assess crop portfolio choices under the new water constraint in the second protocol shifting crop portfolio choices and related water application in the microeconomic module are reproduced in the semi distributed hec hms as land use and water requirement changes and hydrologic simulations are run to assess the impact of these changes on the water cycle what protocol is activated first is conditional on the shock that affects the system where water availability is constrained due to a supply shock such as a drought that triggers water restrictions which can be articulated through demand side responses such as caps or charges the first protocol is activated followed by the second protocol i e starting from the hydrologic module to the microeconomic module the opposite happens where proactive demand side policies that do not respond to a supply shock are implemented e g water charges during normal hydrologic years i e starting from the microeconomic module to the hydrologic module the coupling framework is described in fig 1 and in the paragraphs below albeit the coupling framework is flexible and replicable and could be used with other microeconomic and hydrologic models the description that follows is applicable to the pmaup hec hms integrated hydroeconomic modeling framework the first protocol connects the hydrologic to the microeconomic model through changes in water availability the protocol is activated when i droughts scarcity and or ii policy induced changes strengthen the water availability constraint in equation 6 for example i droughts can reduce discharge and water availability for irrigators or ii water trading upstream may reduce water availability to downstream users not directly involved in the trading through increased consumptive use i e externality grafton et al 2018 note that droughts scarcity typically trigger ad hoc policies e g caps meaning that the impact of hydrologic shocks on the human system will be the result of both drought scarcity and related policy responses this is the case of our application of the proposed coupling framework see section 3 2 the second protocol connects the microeconomic to the hydrologic model through changes in the crop portfolio and water application as the hec hms is a hydrological model without an explicit ecological module a series of additional developments are needed to reproduce agricultural land use changes in hec hms and their impacts on the water cycle the first step involves the division of the sub basin units into smaller units that share a common land use category e g permanently irrigated land fruit trees to this end we integrate spatial land use data from corine land cover ign 2017 with the hec hms using the geospatial hydrologic modeling extension hec geohms ceiwr hec 2018 next the combined sub basins land use layer is crossed with the awdu layer i e agents in the microeconomic model resulting in a geodatabase containing information on land use and land management per crop and awdu this allows to reproduce different crop portfolios from the microeconomic module in a hec hms environment fig 2 accordingly any adaptation strategy that changes crop portfolio decisions in the microeconomic model will now have an impact on land use and hydrologic processes in hec hms detailed agricultural land use information from the microeconomic model are used as an input to assess the irrigation process and its impacts on the water cycle agricultural water requirements are fed into the hec hms as water needs per crop on a per hectare basis and match those of the pmaup model see eq 6 for consistency total water withdrawals thus depend on crop portfolio choices which in turn are a function of the behavior and adaptive responses of socioeconomic agents see eq 1 5 water released from reservoirs responds to water demand for economic uses including agricultural water demand through water withdrawals for irrigation as well as reservoir management rules e g minimum environmental flows water transfers elsewhere water withdrawals from the watercourses are modeled in hec hms through downstream diversions withdrawals finally reaching the field are applied to crops the amount of water effectively consumed in the process is calculated for every crop and awdu based on local conveyance distribution and application coefficients trba 2016 the amount of water that is not consumed contributes to increase the percentage of soil moisture monthly basis and eventually returns to water bodies the second protocol thus allows the hec hms model to reproduce land use changes emerging from irrigators responses to adaptation policies as simulated by the microeconomic module and to assess their impacts on the water cycle note that although calibration and simulations in the hydrologic module are implemented at a daily level the second protocol transfers data from the microeconomic to the hydrologic module at the monthly level because the microeconomic module has a coarser time scale than the day as a result the impact of irrigators choices on the value of hydrologic parameters such as the initial soil moisture through the second protocol change only on a monthly basis a major issue in systems coupling through modularity and protocols is that of convergence hasegawa et al 2016 convergence is typically assumed to be achieved where the changes observed in the coupling variables in two consecutive iterations i e changes in water availability in the first protocol and crop portfolio changes and water application changes in the second protocol are below a predetermined threshold ideally the threshold could be set to 0 which means the solutions in the last two iterations are identical albeit the tolerance level is typically higher parrado et al 2019 depending on factors including the type of shock modules complexity the protocols defined and the convergence threshold convergence may take several iterations to be achieved convergence is typically assessed through a convergence test where a series of shocks are implemented to audit the convergence behavior of the coupled system under alternative scenarios ronneberger et al 2009 this is performed in section 4 in this paper 3 case study area the upper tagus river basin in spain the capabilities of the integrated pmaup and hec hms model are illustrated by simulating the impacts of selected drought episodes and their corresponding irrigation restrictions as foreseen under the new drought management plan dmp of the upper tagus river basin utrb in the center of the iberian peninsula trba 2018 dmps are a regulatory drought adaptation strategy that define drought indices and thresholds establish priorities among uses and strengthen water allocation constraints during drought spells typically starting from low priority agricultural water uses 3 1 background to the case study the utrb covers an area of 9427 5 km2 and comprises 17 awdus see fig 3 trba 2014 irrigation is the largest water use in the utrb and demands on average 172 6 million m3 year 99 of which from surface water 77 3 of the total water demand of 223 1 million m3 year on the other hand average water supply in the utrb ranges between 1026 1 1980 2011 time series and 1311 5 million m3 year 1940 2011 this is from 4 6 to 5 9 times larger than demand in the area and represents between 12 5 and 13 4 of total water supply in the entire tagus river basin trb this water surplus has historically supplied users in the middle trb including the environment and since the 70s also the profitable and water intensive agriculture of the segura river basin srb through the tagus segura water transfer tswt the largest water infrastructure in spain with the capacity to convey up to 650 million m3 year from the utrb to the srb water resources generated within the utrb are managed through the entrepeñas buendía and bolarque reservoirs entrepeñas is located in the tagus river and has a storage capacity of 802 6 million m³ while buendía is located in the guadiela river and its storage capacity is 1691 million m³ finally bolarque has a lower storage capacity of 30 7 million m³ and was designed to regulate transfers to the srb through the tswt environmental organizations farmers and other stakeholders in the trb contest inter basin water transfers to the srb arguing that upstream surpluses should be reserved for downstream users in the trb hernández mora and del moral 2015 this argument is challenged by srb irrigators pwc 2013 in recent years conflict has been aggravated by increasingly intense and frequent droughts with available supply in the utrb falling below 500 million m3 year trba 2018 the worst recorded drought in the utrb happened in the years 1991 995 and 2004 2006 when annual water availability fell to 424 1 million m3 which is barely sufficient to supply water to awdus and other economic and environmental uses in the utrb the trb srb water war delacámara and gómez 2015 has led to institutional deadlock and incremental environmental impacts rather than clearly setting drought thresholds and restrictions the tswt management rules and water allocation rules in the utrb dmp remain largely discretionary which has ultimately affected environmental uses in the middle and lower stretches of the trb boe 2015 minimum environmental flows in the middle stretches of the trb initially set at 10 86 m3 s in aranjuez 14 10 m3 s in toledo and 15 92 m3 s in talavera de la reina trba 2008 have been repeatedly breached and eventually were replaced by a less ambitious minimum threshold of 6 m3 s in aranjuez 81 and 10 m3 s in toledo 41 and talavera de la reina 59 2 in the 2016 tagus river basin management plan trba 2016 in an unprecedented move the spanish supreme court of justice the highest judiciary body in spain recently revoked the 2016 river basin management plan due to its infringement of the minimum environmental flows set back in 2008 while establishing that the entrepeñas buendía and bolarque reservoirs regulating the tswt should have as a priority guaranteeing 2008 minimum environmental flows along the trb boe 2019 the ruling from the supreme court of justice will constrain water authorities to revise water allocation mechanisms in the trb and possibly the tswt particularly during droughts so to redefine and enforce minimum environmental flows most recently proposals have been advanced to increase the minimum threshold below which the tswt is closed see next subsection all this will require a profound revision of the trb dmp particularly in the strategic utrb area 3 2 drought management in the utrb spanish river basins pioneered the adoption of dmps in europe through the entry into force of the 2001 national hydrologic plan boe 2001 since then and despite not being formally prescribed in the eu legal acquis unlike river basin management plans a growing number of basins in spain italy portugal france the uk the netherlands and finland have developed dmps pérez blanco and gómez 2014 beyond europe several river basin authorities in the middle east and north africa e g syria morocco latin america e g mexico brazil china india the us and elsewhere including relatively water abundant basins e g in canada have also adopted dmps which highlights the relevance of the instrument bcn 2018 spanish dmps aim to achieve three specific objectives in the following order 1 ensuring water availability for households 2 minimizing negative environmental impacts on water bodies and 3 minimizing the negative effects of droughts on economic activities to this end dmps define for each hydrological unit sub basin within the basin a drought index and four thresholds that set incremental restrictions on water allocations in accordance to the severity of the drought normality pre alert alert and emergency boe 2001 in the case of the trb dmp two different systems coexist within the utrb hydrological unit the utrb system itself uts 01 cabecera and the tswt system ute 01 ats which have different largely discretionary and potentially conflicting rules trba 2018 in the tswt system the drought index is based on i the volume of water stored in the entrepeñas and buendía reservoirs ve and on ii cumulative water inflows to the entrepeñas and buendía reservoirs during the previous 12 months ap the four drought thresholds and apposite restrictions are defined as follows table 1 for the utrb system the trb dmp defines the drought severity index as a weighted average between two independent indices based on the 3 month cumulative water inflows to the entrepeñas reservoir drought index 1 or di1 weight 55 and buendía reservoir di2 45 respectively see table 2 if the weighted drought severity index for the utrb is equal to or greater than 1 0 normality no restriction is imposed if the drought index for the utrb belongs to the interval 0 5 1 0 a pre alert drought is declared and irrigation water allotments will be temporarily reduced between 0 and 20 if the drought index for the utrb belongs to the interval 0 3 0 5 an alert drought is declared and irrigation water allotments will be temporarily reduced between 0 and 40 finally if the drought index for the utrb belongs to the interval 0 0 0 3 an emergency drought is declared and irrigation water allotments will be temporarily reduced between 20 and 50 for example if cumulative water inflows to entrepeñas are between 42 5 12 9 13 5 16 1 and 86 5 24 1 27 4 35 million m3 in the february april period di1 0 3 and cumulative water inflows to buendía are between 32 89 10 09 9 8 13 and 73 28 21 44 23 42 28 42 million m3 in the february april period di2 0 3 an alert drought would be declared at the beginning of the irrigation campaign in april may weighted drought index utrb 0 3 0 55 0 3 0 45 0 3 and the water allotment for irrigation will be reduced between 0 and 40 where the specific number within this range will be based on a discretionary decision by the drought steering committee noteworthy similar to other spanish river basins discretionary irrigation restrictions in the past have typically gravitated towards the lower threshold 4 results 4 1 calibration 4 1 1 microeconomic pmaup module following gómez limón et al 2016 gutiérrez martín and gómez 2011 and pérez blanco and gutiérrez martín 2017 we explore the relevance of five attributes in the pmaup model z x z 1 x z 2 x z 3 x z 4 x z 5 x namely expected profit z1 risk avoidance z2 and management complexity avoidance the latter being measured through three proxy variables z3 z4 and z5 these attributes are defined in annex iii in the online supplementary material table 3 presents data inputs to the microeconomic module the calibration year is 2013 calibration results of the pmaup model including parameter values α and error metrics e are presented in table 4 below for every awdu in the utrb α1 α5 are the parameter values of the utility function which in our application to the utrb adopts a cobb douglas functional form see annex ii each α1 α5 measures the relative relevance of their corresponding attributes z1 z5 described in annex iii ea ed and em are the crop portfolio residual the attribute residual and the average calibration residual respectively see annex ii for a detailed description of the calibration residuals expected profit α1 and risk avoidance α2 are relevant attributes in explaining the behavior of all economic agents while management complexities α3 α5 are relevant to six agents the average calibration residual ranges from low 10 in 14 awdus to moderate 10 15 in 2 awdus parrado et al 2019 4 1 2 hydrologic hec hms module table 5 presents data inputs to the hec hms model the reference period used for the calibration and validation is 1996 2013 basin model components were obtained using hec hms functions described in section 2 2 channel geometry was derived using dem data hec geohms was chosen to execute this function through a series of steps known as terrain preprocessing which utilizes surface topography to reveal the flow accumulation and stream network we use the period 1996 2013 as a reference for the calibration and validation of hec hms daily rainfall and baseflow data were combined with basin model components so to calculate the rainfall runoff process under natural regime i e no regulation and represent the non altered natural hydrologic conditions of the utrb table 6 shows the initial and calibrated parameters for the calibration period 1996 2010 obtained for the sub basin w810 northeast to the buendía reservoir see fig 3 which is representative of the non altered natural hydrologic conditions of the utrb the validation period is 2010 2013 reservoirs and diversions were subsequently added to hec hms to simulate reservoir and tswt management and agricultural water use water releases from reservoirs are simulated using data from recorded discharges in downstream streamflow stations coupled with information on crop water requirements and tswt management rules see section 3 2 note that the latter two variables are conditional on the drought situation normality pre alert alert and emergency under drought conditions discharge from reservoirs is estimated as the summation of minimum environmental flow regulations and water allocation to economic uses where priority of use is given to the former fig 4 presents observed and simulated flow values for the period 1996 2010 at the outlet of the w810 sub basin in the format of scatterplot to account for dispersion fig 4 reveals differences between observed and simulated flows particularly during peak flows which are attributed to i the limited number of discharge monitoring points in the basin and ii limitations in the model calibration which relies on an initial estimation of soil moisture data instead of using longitudinal data as it does e g with rainfall in order to address limitation i data at a finer spatial resolution is necessary through additional monitoring points while the limitation number ii would require an update in the hec hms source code so to incorporate longitudinal soil moisture data in the calibration stage importantly the simulated flow using our calibrated model is capable of accurately reproducing observed historical flows where discharge is medium or low as the focus of our analysis is on water scarcity rather than water excess e g floods we evaluate the performance of the model by means of the modified nash sutcliffe efficiency coefficient nse which is typically used for datasets with large outliers in it legates and mccabe 1999 ritter and muñoz carpena 2013 we obtain values of 0 78 for the calibration period and 0 8 for the validation period in the range of acceptable nse between 0 65 and 0 8 to good 0 8 0 9 model efficiency and above the threshold value of 0 65 typically used to objectively accept the model 4 2 simulation scenarios we articulate simulation scenarios along four stages 1 water inputs to the water system precipitation and baseflow 2 water inputs to the human system irrigation allotments 3 reservoir management rules minimum environmental flows and 4 reservoir management rules tswt in the first stage we assign precipitation and baseflow input values to each relevant sub basin within the utrb system using i observed data from historical hydrological years in the period 1968 2014 including 4 scenarios 2 conducive towards pre alert representative of the upper pamax corresponding to the 1986 1987 hydrologic year and lower pre alert threshold pamin 1991 1992 in the utrb system and 2 conducive towards alert representative of the upper amax 2001 2002 and lower alert threshold amin 2004 2005 in the utrb system and ii hypothetical data from a combination of historical hydrological years and magrama 2017 analysis of water resources availability under rcp4 5 and rcp8 5 climate change scenarios2 to generate 2 additional scenarios ercp4 5 and ercp8 5 conducive towards emergency drought no emergency drought is observed in the 1979 2013 series magrama 2017 water availability scenarios leverage on the climate change scenarios rcp4 5 rcp6 0 and rcp8 5 ipcc 2014 and on the spanish meteorological agency downscaling of such scenarios aemet 2016 which uses local data from meteorological stations and two alternative methods analog method and statistical downscaling method to build an ensemble of 12 precipitation forecasts for each rcp scenario and disaggregation unit aemet 2016 forecasts are subsequently used to force the conceptual quasi distributed and continuous simulation simpa hydrologic model and thus obtain the impacts on runoff following magrama 2017 water availability scenarios runoff can be reduced by 29 for the rcp4 5 scenario and by as much as 51 in the rcp8 5 scenario precipitation and runoff forecasts are used to reduce input data series in our hec hms model and reproduce a hypothetical emergency drought year selected precipitation and baseflow inputs lead to droughts of varying intensity 2 pre alert 2 alert and 2 emergency that trigger dmp irrigation restrictions initial water stock in reservoirs is set based on historical values for the same year as precipitation and baseflow inputs in the second stage drought severity is assessed in april may i e at the beginning of the irrigation campaign based on the drought index for the utrb which in turn is based on inflows to reservoirs see table 2 and agricultural water restrictions are enforced for each awdu along the entire irrigation campaign since water restrictions in the dmp are largely discretionary see section 3 2 we run simulations considering both the maximum 20 under pre alert 40 under alert and 50 under emergency and minimum irrigation restriction thresholds 0 under pre alert and alert 20 under emergency foreseen for the utrb in the trb dmp to assess responses in the human system in the third stage we set the minimum environmental flows at the outlet of the utrb which in turn condition reservoir management rules in the sub basin we consider two alternatives i 2016 minimum environmental flows of 6 m3 s in aranjuez and 2008 minimum environmental flows of 10 86 m3 s in aranjuez note that environmental flows in the tagus river downstream aranjuez e g in toledo and talavera de la reina are dependent on water inputs from the utrb as well as other hydrological units sub basins not included in our study and are therefore excluded from our analysis finally in the fourth stage we assess the outcomes of alternative tswt management rules since dmp water restrictions for the tswt are again largely discretionary we run simulations considering two alternative emergency thresholds the current 400 million m3 threshold and a more ambitious one of 500 million m3 that is currently being discussed high representative of the tagus river basin authority and personal communication 2019 note that under emergency the tswt is closed thus changing the hydrologic dynamics of the srb increasing irrigation restrictions and inducing non trivial behavioral responses to reduced water availability in the srb these impacts are nonetheless excluded from our analysis of coupled human water systems which focuses on the utrb system the combination of the four stages leads to 6 2 x 2 2 48 scenarios and related simulation runs table 7 4 3 simulation results and discussion 4 3 1 microeconomic pmaup module baseflow and input values to hec hms determine the utrb drought index and corresponding drought threshold normality pre alert alert or emergency when the utrb is under pre alert alert or emergency the water availability constraint for irrigation in equation 6 is strengthened activating the first protocol at this point the microeconomic module is used to assess irrigators responses to incremental restrictions in water availability note that the dmp foresees water restrictions to irrigators in the utrb through reduced water allotments in the area and the srb through tswt management rules and thresholds in this application we are interested in modeling the human modified water cycle in the utrb and therefore focus on the former fig 5 summarizes the crop portfolio responses x the decision variable in the microeconomic model of the awdus of the utrb to incremental restrictions in the water allocation constraint of 20 r20 40 r40 and 50 r50 these thresholds correspond to the dmp irrigation restriction scenarios for the utrb described in section 3 2 which range from 0 to 20 for pre alert drought 0 40 for alert drought and 20 50 for emergency drought crop portfolio responses to incremental irrigation restrictions are driven by differentials in the marginal foregone utility due to water allocation restrictions for each crop or shadow price of water agents have distinct initial crop portfolios utility functions and domains that lead to asymmetric shadow price impacts among awdus following irrigation restrictions most agents adapt to incremental irrigation restrictions through land reallocations from irrigated to rainfed agriculture known as super extensive margin adjustments notably through the substitution of irrigated cereals e g corn irrigated wheat irrigated barley by rainfed crops e g rainfed cereals but also rainfed sunflower super extensive margin adjustments can be also implemented through the substitution of irrigated sunflower by rainfed sunflower awdu r08 throughout the utrb the surface of vineyard and olive groves is kept constant with marginal reductions of olive groves in r13 and r15 and an abrupt reduction of vineyard in r09 under scenario r50 due to the inability to meet minimum water requirements with super extensive margin adjustments observed for olive groves in r13 and r15 note that among economic uses spanish dmps give priority to the survival of ligneous crops meaning that an irrigation restriction of 50 in r09 conducive towards the removal of vineyard is unlikely to be implemented another type of adaptive response occurs through land reallocations towards less water intensive crops known as extensive margin adjustments although this is less common in the utrb where most irrigated crops can also produce significant yields under rainfed agriculture one example of extensive margin adjustment is observed in r01 where corn is substituted by less water intensive lentils as the water allocation constraint is strengthened throughout all simulations the surface of highly valuable crops such as onion and melon is kept constant and in the most restrictive scenarios may slightly increase to compensate abrupt income losses e g awdu r09 as noted above the intensity and direction of extensive and super extensive margin adjustments are heterogeneous and depend on agent s unique features domain utility function initial crop portfolio for example awdu r01 is mostly concerned about expected profit see table 4 and conserves a significant surface of irrigated cereals in all simulations which is progressively substituted by less water intensive lentils a relatively more profitable crop than rainfed cereals in that awdu on the other hand awdu r10 is relatively more risk and management complexity averse and adapts through super extensive margin adjustments that favor rainfed sunflower which features a relatively lower variance and management complexity than alternative feasible crop choices in that awdu adaptation to incremental irrigation restrictions leads to reduced water withdrawals and enhanced water conservation in the utrb at the expense of decreased gross value added gva and employment fig 6 rational agents respond to the new irrigation constraint allocating available resources to those crops that yield a higher utility which typically are those that yield also a higher gross margin one of the two components of gva the other being labor income and substituting irrigated crops at the margin i e those yielding lower utility and gross margin by rainfed crops this adaptive behavior leads to gva losses that are less than proportional than irrigation restrictions particularly where irrigation restrictions are still low moderate as the water allocation constraint increases valuable crops are replaced by rainfed crops as well leading to rising incremental gva losses accordingly a 40 reduction of water allotments yields a reduction in gva of about 16 while a 50 reduction of water allotments 1 25 larger yields a reduction in gva of about 21 1 31 larger gva losses show an important degree of heterogeneity among awdus with higher gva losses concentrated in the awdus along the banks of the tagus river where there is a relatively larger land use share devoted to valuable crops notably corn employment is reduced consistently along incremental water constraints although the adaptive behavior of irrigators helps to mitigate employment losses a 40 reduction of water allotments yields an employment loss of 27 while a 50 reduction of water allotments yields an employment loss of 34 employment is reduced at a faster pace than gva suggesting a progressive shift towards less labor intensive crops and a reallocation of income from labor labor income to land tenants gross margin most employment losses happen at the lower areas of the utrb where more labor intensive crops which also happen to be the more water intensive e g corn are located these results suggest that adaptive responses from economic agents in the utrb will mitigate impacts on the human system without affecting irrigation restrictions compliance with a percentage of irrigation restrictions to percentage of gva reductions ratio ranging from 1 0 35 r20 to 1 0 42 r50 and a percentage of irrigation restrictions to percentage of employment reductions ratio ranging from 1 0 65 r20 to 1 0 68 r50 such complex non linear human responses appear fundamental towards proper understanding and accurate representation of water and land management operations in complex socio ecological systems such as the human modified water cycle 4 3 2 hydrologic hec hms module crop portfolio choices in the pmaup model are next used as inputs to the hec hms the second protocol is used to transfer crop portfolio and related water use responses from the human to the water system since dmps univocally reduce water withdrawals and increase water conservation no further irrigation restrictions are applied meaning there is no further feedback response from the water to the human system and convergence is achieved in the first iteration note that achieving convergence may take more iterations with alternative policies e g water markets crop portfolio land use changes under the three scenarios considered r20 r40 r50 see stage 2 are subsequently combined with precipitation and discharge inputs and corresponding initial water stock in reservoirs see stage 1 reservoir management rules inputs stage 3 and tswt management rules inputs stage 4 which altogether conform the 48 scenarios described in section 4 2 to assess the impacts of dmps on the utrb human modified water cycle under alternative conditions impacts on the water system are measured through water stored in the entrepeñas buendía bolarque reservoir system an indicator of system s resilience and represented in figs 7 9 note again that streamflow at the utrb outlet is constant during droughts and equal to the legally binding minimum environmental flow the impact of human agency on the water system is significant in all simulations considered particularly during alert and emergency conditions strengthening or weakening the water allocation constraint e g from r20 to r50 under emergency leads to non linear responses on the human water system that are observable through an increase or reduction of the water stored in the entrepeñas buendía bolarque reservoir system note again that since discretionary irrigation restrictions in dmps in the past have typically gravitated towards the lower less restrictive threshold garrido and gómez ramos 2009 gómez and pérez blanco 2012 there is potential for additional water conservation through more restrictive irrigation constraints during the alert and pre alert year simulations no system failure i e inability to meet minimum environmental flows is observed under current minimum environmental flows 6 m³ s tswt threshold 400 million m³ or projected management rules minimum environmental flows 10 86 m³ s tswt threshold 500 million m³ irrespective of the irrigation constraints imposed to irrigators of the utrb this result is somewhat expected given the upstream location of the utrb and its relative water abundance however while the entrepeñas buendía bolarque reservoir system as a whole can supply sufficient water to existent uses in all pre alert and alert simulations the entrepeñas reservoir is depleted in the r0 tswt 400 million m³ and 10 86 m³ s scenario in the two alert drought simulations a min a max which results in higher vulnerability due to temporary water supply reliance on the buendía reservoir and the guadiela river exclusively our simulations suggest that this temporary vulnerability can be averted by applying a more restrictive agricultural water constraint of 40 in the utrb r40 scenario which reduces gva and employment in the utrb by 16 and 27 respectively or alternatively increasing the tswt emergency threshold to 500 million m³ or a combination of both under climate change the utrb narrowly avoids system failure in the emergency drought simulations considered ercp4 5 ercp8 5 although water stock falls below 100 and 50 million m3 in ercp4 5 and ercp8 5 simulations respectively this erodes resilience and increases the risk of system failure if an emergency drought under rcp4 5 or rcp8 5 climate change scenario lasts for 2 years our simulations indicate that system failure may happen under r20 and 10 86 m³ s minimum environmental flow scenario increasing irrigation restrictions in the utrb to the upper threshold r50 can delay system failure although reservoirs would continue depleting throughout the 2 year period and eventually lead to system failure during the second year of emergency drought in the middle and final stages of the irrigation campaign for rcp4 5 and rcp8 5 scenarios respectively admittedly considering that only one emergency drought has been recorded throughout the period 1979 2013 the possibility of a 2 year emergency drought that results in system failure may seem far fetched yet this is not anymore the case under climate change magrama 2017 analysis of water resources availability under climate change suggests that in some spanish basins including the trb droughts are becoming the new normal indeed the combination of magrama s 2017 climate change scenarios and 1979 2013 historical hydrologic data for the utrb suggests that drought frequency as measured in the dmp will increase consistently in the basin with alert drought years becoming more frequent than normality years from 2040 onwards rcp4 5 scenario and emergency drought years becoming more frequent than normality years from 2070 onwards rcp8 5 scenario fig 10 note that during emergency drought the volume of water stored in our simulations is consistently below 400 million m³ and the tswt is therefore closed meaning that revising the tswt management rules is ineffective towards mitigating drought impacts however this measure is effective to mitigate reservoir depletion during pre alert or alert drought in other words revising the tswt management rules during emergency is ineffective towards preventing system failure but sensible tswt management rules are necessary to avoid that pre alert or alert drought evolves into emergency drought 5 conclusions in the anthropocene the epoch where humans are causing significant impact on the geology and ecosystems of the planet earth natural systems cannot be properly studied and understood in isolation from human systems and vice versa in a context of growing water scarcity water resources reallocation policies may induce behavioral responses on the human system with non trivial feedbacks on the water system and related natural systems this paper develops a modular integrated hydroeconomic pmaup hec hms model to assess the intertwined dynamics of the human modified water cycle using protocols that connect in sequence the human and water systems through common spatial crop portfolio and related land use changes and water availability variables to this end the conventional hec hms sub basin compartmentalization is further sub divided into smaller units that share a common land use which allows the hydrologic module to mimic crop portfolio and land use changes emerging from simulations in the pmaup model the coupling framework is flexible offering the possibility of accommodating alternative microeconomic models in the framework and replicable meaning the protocols can be adapted to accommodate alternative hydrologic models in the framework the proposed framework can be used to mainstream adaptive responses in the human system into the water system through the use of hydroeconomic models that rely on modularity to go beyond conventional stand alone hydrologic or piecewise approximations to human agency the capabilities of the coupled model are illustrated by simulating the impacts of selected drought episodes and their corresponding irrigation restrictions as foreseen under the new dmp of the upper tagus river basin in the center of the iberian peninsula a critical result of the study is that the impact of human agency on the water system is significant in all simulations considered and should not be neglected the non linear responses observed in the human and coupled human water systems which contrast with exogenous piecewise representations of human agency in conventional hydroeconomic models appear fundamental towards a proper understanding and accurate representation of water and land management operations in complex socio ecological systems such as the human modified water cycle in all simulation runs economic agents behavioral responses to reduced water availability induced non linear large scale land use and water management changes with significant impact on major hydrologic processes and water cycle dynamics our results suggest that a comprehensive understanding and accurate representation of the human modified water cycle necessitates a detailed representation of the complex human system dynamics including non linearities and its interaction with the water system which is not achievable through conventional stand alone hydrologic models or piecewise representations of human agency a key finding of our research is that enhancing water stocks and drought resilience in the utrb through changes in the dmp can be achieved by implementing one or both of the following actions in the human system i increasing the tswt emergency threshold which contributes to prevent pre alert and alert droughts from evolving into more severe emergency drought and ii strengthening irrigators water allocation constraint which is also the only effective drought management action during emergency moreover minimum environmental flow requirements are determinant for drought impact assessments simulations are also sensitive to climate change impacts on precipitation and baseflow which are expected to make drought events more intense and lead to emergency droughts that erode system resilience through reservoir depletion and potentially resulting in system failure note that the environmental flows and climate scenarios above are legally binding minimum environmental flows or set by future states of nature climate change and are therefore exogenous to decision making future research should address the limitations of the proposed pmaup hec hms hydroeconomic framework and its modules regarding the limitations of the hydrologic module hec hms is not the most adequate model to reproduce the dynamics of groundwater where groundwater use is relevant the modular framework developed in the paper could be modified to address this shortcoming e g using a hydrogeological model such as modflow as the water system module in addition the model calibration relies on an initial estimation of soil moisture data instead of using longitudinal series which affects model accuracy including during peak flows note that to address this limitation hec hms coding should be updated to incorporate observed soil moisture data in the calibration stage regarding the limitations of the microeconomic module additional attributes and alternative agricultural practices could be explored and eventually incorporated to the pmaup model to improve accuracy for example crop water production functions could be also included in the pmaup model to assess adjustments at the intensive margin i e deficit irrigation although this improvement is conditional to data availability and could be computationally expensive we expect that expanding microeconomic datasets and computational power make the incorporation of additional attributes and crop portfolio choices to the pmaup model and within the coupled hydroeconomic framework increasingly feasible in the future another significant improvement on the economic modeling pertains to the fact that prices are exogenous in microeconomic agricultural models which yields a partial representation of the human system that excludes the macroeconomic system recent studies relying on modularity and recursivity principles have explored alternative approaches to address this gap and could be used to complement our integrated microeconomic programming and hec hms hydroeconomic model with a representation of the macroeconomic system hasegawa et al 2016 parrado et al 2019 ronneberger et al 2009 regarding the coupling procedure the second protocol land use needs further automatization for a better exchange of information between modules and for enabling faster analysis of alternative scenarios in addition the land use coupling protocol relies on monthly inputs from the microeconomic module to increase soil moisture following irrigation withdrawals through diversions in hec hms and water application which may affect accuracy a microeconomic model with a finer temporal scale ideally the day could help address this limitation nonetheless crop portfolio choices are taken by agents at the beginning of the irrigation campaign when water allotments are awarded and typically remain constant throughout meaning conventional microeconomic models work at a coarser time scale than the day usually month or irrigation campaign again rework of the hec hms coding would be necessary to allow for the introduction of daily soil moisture data finally applications in alternative case study areas and using alternative shocks e g water charges water markets are necessary to validate the coupling procedure notably its convergence behavior the limitations of the proposed pmaup hec hms hydroeconomic framework identified above will result in modeling uncertainty parameter and structural and deviations of estimated from observed output variables a seemingly straightforward solution to improve modeling uncertainty in our coupled hydroeconomic approach consists in using for each module those models that minimize such deviations yet since errors in alternative models are typically independent and not directly comparable ipcc 2014 assigning a reasonable metric of uncertainty to each model is challenging due to the discretion involved an alternative to this approach is the use of multiple models in each module so to sample uncertainty through the model spread this precludes conventional consolidative modeling i e finding the optimal policy through a single model on the other hand by means of combining simulation outputs with automatized or heuristic robust decision making methods ensemble experiments avoid providing more information than is warranted by available data and prevent maladaptation as mentioned in the introduction to this article this paper contributes to a growing socio hydrology literature that represents complex human water systems through flexible modular hydroeconomic modeling see e g essenfelder et al 2018 esteve et al 2015 along with these papers our research can contribute towards the development of socio hydrology inspired science that combines increasingly accurate models that reduce prediction errors with ensemble experiments that acknowledge and sample uncertainty for more informed robust decisions significant sources of scenario uncertainty can be also identified in the coupled pmaup hec hms model through both physical e g climate change and socioeconomic variables e g dmp thresholds and related restrictions could be revised and changed scenario uncertainty is typically addressed through scenario discovery techniques i e modeling multiple plausible futures to relate alternative simulation scenarios to their implied consequences which offers a valuable tool to inform decision making in our application to the utrb scenario uncertainty is assessed exploring the outcomes of 48 scenarios through an equal number of simulations however a more profound analysis may be required if a particular policy is to be assessed e g a proposal to revise agricultural water restrictions to utrb irrigators during droughts calls for a larger number of irrigation restriction scenarios in section 4 2 stage 2 note that such application is likely to be significantly more computationally demanding calling in turn for some of the model improvements listed above declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the research leading to these results has been developed with the support of the program for the attraction of scientific talent s swan sustainable watersheds emerging economic instruments for water and food security project and of the ministerio para la transición ecológica y el reto demográfico through fundación biodiversidad atacc project adaptación transformativa al cambio climático en el regadío appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104943 
25888,the accurate understanding of the human modified water cycle calls for a detailed representation of human and water systems including relevant non linearities and of the feedback responses between them this paper couples a microeconomic positive multi attribute utility programming model with a hydrologic modeling system hec hms with the objective of incorporating the behavior and adaptive responses of human agents into the representation of the human modified water cycle the coupling occurs in a sequential fashion using bidirectional protocols that represent the feedback responses between the microeconomic and hydrologic modules through common spatial elements and variables the proposed model is illustrated with an application to agricultural water management in the upper tagus river basin in spain the non linear responses observed in the modeled human water system suggest that strengthening the agricultural water allocation constraint can avert or delay drought negative environmental impacts with a less than proportional yet incremental impact on gross value added and employment keywords water resources management hydroeconomic modeling hec hms mathematical programming 1 introduction water withdrawals are increasing worldwide mainly due to population growth and economic development un 2018 at the same time climate change is expected to reduce water availability in many arid and semi arid basins notably those of the mediterranean region and middle east high confidence ipcc 2018 the combined effects of increasing demand and decreasing supply can potentially aggravate the economic and environmental impacts of water scarcity and droughts world bank 2016 in this context there is a growing pressure to formulate policies that reallocate available water resources among competing uses so to mitigate economic losses and ensure enough resources are reserved for the public good grafton et al 2018 such demand side approach can induce non linear and non trivial behavioral changes in economic agents that may affect water and land management change the trajectory of hydrologic systems create feedback responses from human systems and further impact water and land management practices alam 2015 hence addressing water scarcity challenges demands innovative integrated approaches to water resources research and hydroeconomic modeling in particular loon et al 2016 pande and sivapalan 2017 sivapalan et al 2014 hydrologic and economic modeling play a critical role in defining adaptation strategies to water scarcity and droughts they inform policy makers on the economic and environmental outcomes of projected policies and the relevant tradeoffs between them and help prevent maladaptation economics and civil engineering are historically kindred disciplines dupuit 1844 that in the case of water resources management converge into the area of hydroeconomics optimization typically provides the mathematical link between the two disciplines civil engineering hydrology evaluates the costs of building operating and maintaining water works and estimates water requirements economics evaluates the utility relevant attributes driving human responses to key stimuli so to predict future adaptive behavior and mathematically stated objective functions subject to physical and socioeconomic constraints resolve the water allocation problem harou et al 2009 based on how the hydrologic and economic sub models interact to represent processes and decisions hydroeconomic models can be broadly segregated into modular and holistic brouwer and hofkes 2008 conventional holistic models typically estimate economic agents responses to policy shocks or other stimuli using an external economic sub model which is subsequently integrated in the architecture of the hydrologic model through piecewise equations this offers the advantage of a more straightforward and effective representation of causal relationships and interdependencies while reducing computational costs on the other hand the modular approach resolves the economic and hydrologic sub models separately connecting them in sequence this offers increased probability of convergence to an optimal solution and potentially higher detail in the representation of each sub field which can be independently developed and adjusted both holistic and modular approaches have been applied to water resources planning and management in the past albeit the former is prevalent given the supply side emphasis of conventional water policy where focus is placed on building operating and maintaining water works to meet demands blair and buytaert 2016 harou et al 2009 however where policies may induce behavioral responses that significantly impact the water system as happens with demand side approaches such as water pricing markets or caps understanding and interpreting the human modified water cycle requires the explicit inclusion of feedbacks between human and water systems so to allow for a richer understanding of coupled human water system dynamics that better represents water and land management operations sivapalan et al 2014 relevant contributions towards a more detailed representation of agents autonomous adaptation behavior in complex human water systems have been recently made in the area of socio hydrology sivapalan and blöschl 2015 socio hydrology conceives complex human water systems as an ensemble of many elements where the different elements of the system are conceptualized through nested hierarchies of models that are able to exchange and communicate information blair and buytaert 2016 such modular framework has the additional advantage of making possible the addition of nonlinearity to each element of the system so that surprises are not so surprising and can be adequately understood levin et al 2013 and explored using uncertainty analysis tools such as scenario discovery baldassarre et al 2016 this does not mean that all the processes occurring in the human water system need be full fledged models depending on the problem at hand subsystems can be grouped e g hydrological and microeconomic systems or divided also while relevant subsystems can be represented through individual modeling components use of single differential equations that relate the function with its derivatives is acceptable e g to represent less important elements sivapalan and blöschl 2015 this paper builds socio hydrology inspired science by developing a methodological framework to couple a microeconomic positive multi attribute utility programming pmaup model that represents the behavior of irrigators and simulates their adaptive responses gómez limón et al 2016 gutiérrez martín and gómez 2011 with a hydrologic modeling system hec hms designed to simulate the rainfall runoff processes of dendritic basins ceiwr hec 2018 while hec hms is a popular tool for the development of hydrologic applications this is to the best of our knowledge the first study that uses hec hms in concert with an agricultural economics module the coupling between the pmaup model and hec hms occurs in a sequential fashion using protocols i e rules designed to manage relationships and processes between modules csete and doyle 2002 protocols enable the simulation of the interconnected dynamics and feedback responses between the microeconomic and hydrologic module through common spatial crop portfolio and related land use changes and water availability variables to this end we integrate farmers responses as predicted by the microeconomic module into the hydrological module through the explicit representation of crop portfolio land use decisions and related irrigation water use and consumption in hec hms and use this information as an additional input to hydrologic simulations thus allowing the assessment of the impacts of human agency on the water cycle and potential feedbacks the methods presented in this paper contribute to the literature on socio hydrology and hydroeconomic research in three ways 1 the modular integrated framework proposed in this paper rationalizes human water system analysis and aspires to provide a more profound understanding and a more accurate representation of human agency and the feedbacks between human and water systems in dendritic basins 2 we present a new set of bidirectional protocols based on land use and water availability variables to couple human and water systems and conceptualize the relevant two way feedbacks happening between them 3 the coupling is designed to be flexible i e allowing for alternative microeconomic models to be used and replicable i e to involve alternative hydrologic models by adapting the coupling variables the flexibility and replicability of the proposed approach combined with recent advances in socio hydrology through protocols and modularity see e g essenfelder et al 2018 esteve et al 2015 are instrumental towards the development of uncertainty assessments that go beyond conventional scenario discovery to include multi system ensemble experiments that sample parameter and structural uncertainties in socio hydrology modeling 2 methods 2 1 the microeconomic module positive multi attribute utility programming pmaup human agency in agricultural water management and water resources allocation is typically represented through microeconomic modeling approaches graveline 2016 microeconomic models are a mathematically stated representation of the behavior of socioeconomic agents that can be used to understand and predict their responses to key stimuli given a number of physical and or socioeconomic restrictions i e domain rational agents in microeconomic models are capable of resolving complex input allocation problems so to maximize the utility derived from one single attribute or many multi attribute utility relevant attributes within the domain this complex decision making process can be modeled following a normative or calibrated i e positive objective function normative models are based on value judgments and expert opinions that prescribe an objective function which can range from simple linear profit maximization to more sophisticated representations of human agency through e g state contingent approach chambers and quiggin 2000 positive models in contrast use calibration methods to elicit the parameters of an objective function that represents observed choices i e realized crop portfolio choices positive models can be broadly classified in linear programming paris 2015 positive mathematical programming howitt 1995 and pmaup gómez limón et al 2016 pérez blanco and gutiérrez martín 2017 microeconomic models start from a generic utility maximization problem that complies with a domain fx with an objective function u x that considers one or multiple objectives through a vector of attributes z x 1 m a x u x x u z 1 x z 2 x z 3 x z m x 2 s t 0 x c 1 3 c 1 n x c 1 4 x f x 5 z x r m the decision variable or crop portfolio vector x comprises the fraction of land allocated to each individual crop xc typically each individual crop xc represents a unique combination of cultivars management techniques and capital investment which results in a unique combination of attributes z xc z xi rational agents will decide on the crop portfolio x so to maximize the utility derived from attributes z x within a domain fx conformed by measurable and quantifiable water land climatic agronomic and policy constraints see annex i in the online supplementary material for a detailed description of model constraints pérez blanco and gutiérrez martín 2017 of particular interest to this research is the water availability constraint 6 c 1 n w c x c w where w i wirepresents water requirements per crop per hectare and w represents the total water allotment in our application of the proposed coupling framework we rely on a pmaup model to simulate the behavior and responses of the agents in this case the agricultural water demand units awdus which are a frequently used irrigation unit in spain defined as groups of irrigators sharing a common source of water territorial administrative and hydrological characteristics trba 2016 note again that the model is flexible and use of alternative microeconomic models as well as agent types e g farmers agricultural districts could be explored the calibration of the pmaup model follows a positive approach the observed decision by the rational agent i e realized crop portfolio x 0 is assumed to be the one that maximizes utility for a given set of restrictions or domain thus any deviation of the calibrated crop portfolio x i e the solution to the utility maximization problem in eq 1 5 from the observed crop portfolio x 0 is interpreted as a calibration residual the pmaup model sets to elicit the parameters of the objective function that minimize the distance between observed and calibrated decisions this is done in four steps 1 the marginal rate of transformation m r t i j along the efficiency frontier i e the rate at which the provision of one attribute i can be redirected into the provision of another attribute j through a reallocation of inputs is obtained 2 the marginal rate of substitution m r s i j of the utility function i e the rate at which the agent can give up one unit of attribute i in exchange of one unit of attribute j is obtained 3 we equalize the m r t i j to the m r s i j and resolve the resulting system of equations to elicit the parameters of the utility function for each possible combination of attributes considered 4 we obtain the calibrated crop portfolio x for each possible combination of attributes utility function and measure the distance to the observed crop portfolio x 0 the utility function that minimizes the calibration residual is revealed preferred and used in the simulations a mathematical formulation of the pmaup calibration procedure is available in annex ii in the online supplementary material 2 2 the hydrologic module hydrologic engineering center s hydrologic modeling system hec hms the water system is modeled using the hydrologic engineering center s hydrologic modeling system hec hms v 4 3 hec hms is an open access semi distributed hydrologic model for simulating the rainfall runoff process of dendritic basins the model is typically used to simulate flood and drought events although continuous hydrologic simulations can also be used to simulate the water cycle in the longer term hec hms divides the water system of a basin into manageable sub basins and water cycle processes and uses mathematical modules to represent any flux within a given sub basin and process e g streamflow there are four critical model components to any hec hms simulation i basin model components ii meteorological model components iii control specification components and iv input data components basin model components conform the physical representation of the basin in hec hms the basin is typically divided into interconnected sub basins within a river network sub basin units are obtained from the digital elevation model dem layer combining the flow accumulation adjoint catchment and drainage line layers using the area threshold or slope area method with the area threshold method being used in this study due to the gridded nature of the input datasets employed in the coupling framework other hydrologic elements used in the basin model include reach junction reservoir sink and diversion which are placed in a spatial context through background maps precipitation losses streamflow infiltration and baseflow i e minimum water depth on top of which additional runoff accumulates simulations are obtained using a combination of the following hec hms standard methods simple canopy canopy layer simple surface surface layer between canopy and soil layer soil moisture accounting loss method scs unit hydrograph transformation method which converts precipitation into runoff and linear reservoir baseflow meteorological model components include precipitation shortwave radiation longwave radiation evapotranspiration and snowmelt our application to agricultural water management uses observed exogenous data on irrigation water withdrawals application and consumption to run hydrologic and microeconomic simulations so to ensure consistency between the two modules which makes the use of shortwave radiation longwave radiation and evapotranspiration variables to assess irrigation demand redundant control specifications define the start date end date and time interval october september and daily respectively in our application model setting is completed combining the basin model meteorological model and control specifications with input data components that assign precipitation and discharge time series data to the relevant sub basin the hydrologic model used in this study hec hms simulates the movement and storage of water in vegetation soil surface and soil layer and groundwater layers two layers plus a deep aquifer to this end hec hms uses the canopy layer surface layer and soil water accounting loss method to separate precipitation data into losses through canopy interception surface storage and infiltration into aquifers and net precipitation i e the difference between total rainfall and losses the latter is used as an input to the transformation method to calculate runoff which is added in turn to baseflow alternative land uses through e g crop choices affect the movement of water in a watershed in different ways for instance precipitation or water from irrigation systems might be intercepted by the canopy of the vegetation covering certain area of land and different crops have different canopy interception storages water that is intercepted by canopy does not reach the soil surface in hec hms precipitation becomes available for filling other volumes only after canopy interception storage is filled while water in canopy interception storage is removed only by evaporation the water that reaches the soil surface may runoff on the surface which is also a function of the land cover or infiltrate to the soil profile storage which is divided in upper zone where percolation occurs and tension zone when water percolates from the soil profile storage it reaches the groundwater storage water stored in the groundwater systems may either return to the watershed by means of baseflow or percolate from the first groundwater layer to the second or from the second groundwater layer to deep percolation which in this case represents a loss from the system note that there are alternative hydrogeological models that offer a more precise representation of groundwater dynamics e g modflow hughes et al 2017 better suited to model impacts on the human modified water system where aquifers are the main water source for irrigation this is not the case in our case study area where 99 of irrigation withdrawals come from surface water bodies the calculations above are performed for each sub basin within the network next reservoirs are incorporated into the model and its historical management rules calibrated using discharge data downstream the reservoirs as a reference finally the routing process is used to simulate stage and discharge and assess the hydrograph along stream channels so to reproduce the observed conditions of the basin with the minimum possible error 2 3 protocols and coupling the proposed integrated hydroeconomic modeling framework operates through an iterative modular approach that runs the microeconomic and hydrologic modules independently modules in turn are connected and exchange information through protocols i e rules designed to manage relationships and processes between modules the use of protocols enables the simulation of interconnected dynamics and feedback responses between human water systems two protocols working in opposite ways so to reproduce feedback responses are developed the first protocol connects the hydrologic to the microeconomic model while the second protocol connects the microeconomic to the hydrologic model where changes in the water cycle following hydrologic simulations e g reduced discharge during a drought strengthen the water availability constraint for irrigation the first protocol is activated and simulations are run in the microeconomic model to assess crop portfolio choices under the new water constraint in the second protocol shifting crop portfolio choices and related water application in the microeconomic module are reproduced in the semi distributed hec hms as land use and water requirement changes and hydrologic simulations are run to assess the impact of these changes on the water cycle what protocol is activated first is conditional on the shock that affects the system where water availability is constrained due to a supply shock such as a drought that triggers water restrictions which can be articulated through demand side responses such as caps or charges the first protocol is activated followed by the second protocol i e starting from the hydrologic module to the microeconomic module the opposite happens where proactive demand side policies that do not respond to a supply shock are implemented e g water charges during normal hydrologic years i e starting from the microeconomic module to the hydrologic module the coupling framework is described in fig 1 and in the paragraphs below albeit the coupling framework is flexible and replicable and could be used with other microeconomic and hydrologic models the description that follows is applicable to the pmaup hec hms integrated hydroeconomic modeling framework the first protocol connects the hydrologic to the microeconomic model through changes in water availability the protocol is activated when i droughts scarcity and or ii policy induced changes strengthen the water availability constraint in equation 6 for example i droughts can reduce discharge and water availability for irrigators or ii water trading upstream may reduce water availability to downstream users not directly involved in the trading through increased consumptive use i e externality grafton et al 2018 note that droughts scarcity typically trigger ad hoc policies e g caps meaning that the impact of hydrologic shocks on the human system will be the result of both drought scarcity and related policy responses this is the case of our application of the proposed coupling framework see section 3 2 the second protocol connects the microeconomic to the hydrologic model through changes in the crop portfolio and water application as the hec hms is a hydrological model without an explicit ecological module a series of additional developments are needed to reproduce agricultural land use changes in hec hms and their impacts on the water cycle the first step involves the division of the sub basin units into smaller units that share a common land use category e g permanently irrigated land fruit trees to this end we integrate spatial land use data from corine land cover ign 2017 with the hec hms using the geospatial hydrologic modeling extension hec geohms ceiwr hec 2018 next the combined sub basins land use layer is crossed with the awdu layer i e agents in the microeconomic model resulting in a geodatabase containing information on land use and land management per crop and awdu this allows to reproduce different crop portfolios from the microeconomic module in a hec hms environment fig 2 accordingly any adaptation strategy that changes crop portfolio decisions in the microeconomic model will now have an impact on land use and hydrologic processes in hec hms detailed agricultural land use information from the microeconomic model are used as an input to assess the irrigation process and its impacts on the water cycle agricultural water requirements are fed into the hec hms as water needs per crop on a per hectare basis and match those of the pmaup model see eq 6 for consistency total water withdrawals thus depend on crop portfolio choices which in turn are a function of the behavior and adaptive responses of socioeconomic agents see eq 1 5 water released from reservoirs responds to water demand for economic uses including agricultural water demand through water withdrawals for irrigation as well as reservoir management rules e g minimum environmental flows water transfers elsewhere water withdrawals from the watercourses are modeled in hec hms through downstream diversions withdrawals finally reaching the field are applied to crops the amount of water effectively consumed in the process is calculated for every crop and awdu based on local conveyance distribution and application coefficients trba 2016 the amount of water that is not consumed contributes to increase the percentage of soil moisture monthly basis and eventually returns to water bodies the second protocol thus allows the hec hms model to reproduce land use changes emerging from irrigators responses to adaptation policies as simulated by the microeconomic module and to assess their impacts on the water cycle note that although calibration and simulations in the hydrologic module are implemented at a daily level the second protocol transfers data from the microeconomic to the hydrologic module at the monthly level because the microeconomic module has a coarser time scale than the day as a result the impact of irrigators choices on the value of hydrologic parameters such as the initial soil moisture through the second protocol change only on a monthly basis a major issue in systems coupling through modularity and protocols is that of convergence hasegawa et al 2016 convergence is typically assumed to be achieved where the changes observed in the coupling variables in two consecutive iterations i e changes in water availability in the first protocol and crop portfolio changes and water application changes in the second protocol are below a predetermined threshold ideally the threshold could be set to 0 which means the solutions in the last two iterations are identical albeit the tolerance level is typically higher parrado et al 2019 depending on factors including the type of shock modules complexity the protocols defined and the convergence threshold convergence may take several iterations to be achieved convergence is typically assessed through a convergence test where a series of shocks are implemented to audit the convergence behavior of the coupled system under alternative scenarios ronneberger et al 2009 this is performed in section 4 in this paper 3 case study area the upper tagus river basin in spain the capabilities of the integrated pmaup and hec hms model are illustrated by simulating the impacts of selected drought episodes and their corresponding irrigation restrictions as foreseen under the new drought management plan dmp of the upper tagus river basin utrb in the center of the iberian peninsula trba 2018 dmps are a regulatory drought adaptation strategy that define drought indices and thresholds establish priorities among uses and strengthen water allocation constraints during drought spells typically starting from low priority agricultural water uses 3 1 background to the case study the utrb covers an area of 9427 5 km2 and comprises 17 awdus see fig 3 trba 2014 irrigation is the largest water use in the utrb and demands on average 172 6 million m3 year 99 of which from surface water 77 3 of the total water demand of 223 1 million m3 year on the other hand average water supply in the utrb ranges between 1026 1 1980 2011 time series and 1311 5 million m3 year 1940 2011 this is from 4 6 to 5 9 times larger than demand in the area and represents between 12 5 and 13 4 of total water supply in the entire tagus river basin trb this water surplus has historically supplied users in the middle trb including the environment and since the 70s also the profitable and water intensive agriculture of the segura river basin srb through the tagus segura water transfer tswt the largest water infrastructure in spain with the capacity to convey up to 650 million m3 year from the utrb to the srb water resources generated within the utrb are managed through the entrepeñas buendía and bolarque reservoirs entrepeñas is located in the tagus river and has a storage capacity of 802 6 million m³ while buendía is located in the guadiela river and its storage capacity is 1691 million m³ finally bolarque has a lower storage capacity of 30 7 million m³ and was designed to regulate transfers to the srb through the tswt environmental organizations farmers and other stakeholders in the trb contest inter basin water transfers to the srb arguing that upstream surpluses should be reserved for downstream users in the trb hernández mora and del moral 2015 this argument is challenged by srb irrigators pwc 2013 in recent years conflict has been aggravated by increasingly intense and frequent droughts with available supply in the utrb falling below 500 million m3 year trba 2018 the worst recorded drought in the utrb happened in the years 1991 995 and 2004 2006 when annual water availability fell to 424 1 million m3 which is barely sufficient to supply water to awdus and other economic and environmental uses in the utrb the trb srb water war delacámara and gómez 2015 has led to institutional deadlock and incremental environmental impacts rather than clearly setting drought thresholds and restrictions the tswt management rules and water allocation rules in the utrb dmp remain largely discretionary which has ultimately affected environmental uses in the middle and lower stretches of the trb boe 2015 minimum environmental flows in the middle stretches of the trb initially set at 10 86 m3 s in aranjuez 14 10 m3 s in toledo and 15 92 m3 s in talavera de la reina trba 2008 have been repeatedly breached and eventually were replaced by a less ambitious minimum threshold of 6 m3 s in aranjuez 81 and 10 m3 s in toledo 41 and talavera de la reina 59 2 in the 2016 tagus river basin management plan trba 2016 in an unprecedented move the spanish supreme court of justice the highest judiciary body in spain recently revoked the 2016 river basin management plan due to its infringement of the minimum environmental flows set back in 2008 while establishing that the entrepeñas buendía and bolarque reservoirs regulating the tswt should have as a priority guaranteeing 2008 minimum environmental flows along the trb boe 2019 the ruling from the supreme court of justice will constrain water authorities to revise water allocation mechanisms in the trb and possibly the tswt particularly during droughts so to redefine and enforce minimum environmental flows most recently proposals have been advanced to increase the minimum threshold below which the tswt is closed see next subsection all this will require a profound revision of the trb dmp particularly in the strategic utrb area 3 2 drought management in the utrb spanish river basins pioneered the adoption of dmps in europe through the entry into force of the 2001 national hydrologic plan boe 2001 since then and despite not being formally prescribed in the eu legal acquis unlike river basin management plans a growing number of basins in spain italy portugal france the uk the netherlands and finland have developed dmps pérez blanco and gómez 2014 beyond europe several river basin authorities in the middle east and north africa e g syria morocco latin america e g mexico brazil china india the us and elsewhere including relatively water abundant basins e g in canada have also adopted dmps which highlights the relevance of the instrument bcn 2018 spanish dmps aim to achieve three specific objectives in the following order 1 ensuring water availability for households 2 minimizing negative environmental impacts on water bodies and 3 minimizing the negative effects of droughts on economic activities to this end dmps define for each hydrological unit sub basin within the basin a drought index and four thresholds that set incremental restrictions on water allocations in accordance to the severity of the drought normality pre alert alert and emergency boe 2001 in the case of the trb dmp two different systems coexist within the utrb hydrological unit the utrb system itself uts 01 cabecera and the tswt system ute 01 ats which have different largely discretionary and potentially conflicting rules trba 2018 in the tswt system the drought index is based on i the volume of water stored in the entrepeñas and buendía reservoirs ve and on ii cumulative water inflows to the entrepeñas and buendía reservoirs during the previous 12 months ap the four drought thresholds and apposite restrictions are defined as follows table 1 for the utrb system the trb dmp defines the drought severity index as a weighted average between two independent indices based on the 3 month cumulative water inflows to the entrepeñas reservoir drought index 1 or di1 weight 55 and buendía reservoir di2 45 respectively see table 2 if the weighted drought severity index for the utrb is equal to or greater than 1 0 normality no restriction is imposed if the drought index for the utrb belongs to the interval 0 5 1 0 a pre alert drought is declared and irrigation water allotments will be temporarily reduced between 0 and 20 if the drought index for the utrb belongs to the interval 0 3 0 5 an alert drought is declared and irrigation water allotments will be temporarily reduced between 0 and 40 finally if the drought index for the utrb belongs to the interval 0 0 0 3 an emergency drought is declared and irrigation water allotments will be temporarily reduced between 20 and 50 for example if cumulative water inflows to entrepeñas are between 42 5 12 9 13 5 16 1 and 86 5 24 1 27 4 35 million m3 in the february april period di1 0 3 and cumulative water inflows to buendía are between 32 89 10 09 9 8 13 and 73 28 21 44 23 42 28 42 million m3 in the february april period di2 0 3 an alert drought would be declared at the beginning of the irrigation campaign in april may weighted drought index utrb 0 3 0 55 0 3 0 45 0 3 and the water allotment for irrigation will be reduced between 0 and 40 where the specific number within this range will be based on a discretionary decision by the drought steering committee noteworthy similar to other spanish river basins discretionary irrigation restrictions in the past have typically gravitated towards the lower threshold 4 results 4 1 calibration 4 1 1 microeconomic pmaup module following gómez limón et al 2016 gutiérrez martín and gómez 2011 and pérez blanco and gutiérrez martín 2017 we explore the relevance of five attributes in the pmaup model z x z 1 x z 2 x z 3 x z 4 x z 5 x namely expected profit z1 risk avoidance z2 and management complexity avoidance the latter being measured through three proxy variables z3 z4 and z5 these attributes are defined in annex iii in the online supplementary material table 3 presents data inputs to the microeconomic module the calibration year is 2013 calibration results of the pmaup model including parameter values α and error metrics e are presented in table 4 below for every awdu in the utrb α1 α5 are the parameter values of the utility function which in our application to the utrb adopts a cobb douglas functional form see annex ii each α1 α5 measures the relative relevance of their corresponding attributes z1 z5 described in annex iii ea ed and em are the crop portfolio residual the attribute residual and the average calibration residual respectively see annex ii for a detailed description of the calibration residuals expected profit α1 and risk avoidance α2 are relevant attributes in explaining the behavior of all economic agents while management complexities α3 α5 are relevant to six agents the average calibration residual ranges from low 10 in 14 awdus to moderate 10 15 in 2 awdus parrado et al 2019 4 1 2 hydrologic hec hms module table 5 presents data inputs to the hec hms model the reference period used for the calibration and validation is 1996 2013 basin model components were obtained using hec hms functions described in section 2 2 channel geometry was derived using dem data hec geohms was chosen to execute this function through a series of steps known as terrain preprocessing which utilizes surface topography to reveal the flow accumulation and stream network we use the period 1996 2013 as a reference for the calibration and validation of hec hms daily rainfall and baseflow data were combined with basin model components so to calculate the rainfall runoff process under natural regime i e no regulation and represent the non altered natural hydrologic conditions of the utrb table 6 shows the initial and calibrated parameters for the calibration period 1996 2010 obtained for the sub basin w810 northeast to the buendía reservoir see fig 3 which is representative of the non altered natural hydrologic conditions of the utrb the validation period is 2010 2013 reservoirs and diversions were subsequently added to hec hms to simulate reservoir and tswt management and agricultural water use water releases from reservoirs are simulated using data from recorded discharges in downstream streamflow stations coupled with information on crop water requirements and tswt management rules see section 3 2 note that the latter two variables are conditional on the drought situation normality pre alert alert and emergency under drought conditions discharge from reservoirs is estimated as the summation of minimum environmental flow regulations and water allocation to economic uses where priority of use is given to the former fig 4 presents observed and simulated flow values for the period 1996 2010 at the outlet of the w810 sub basin in the format of scatterplot to account for dispersion fig 4 reveals differences between observed and simulated flows particularly during peak flows which are attributed to i the limited number of discharge monitoring points in the basin and ii limitations in the model calibration which relies on an initial estimation of soil moisture data instead of using longitudinal data as it does e g with rainfall in order to address limitation i data at a finer spatial resolution is necessary through additional monitoring points while the limitation number ii would require an update in the hec hms source code so to incorporate longitudinal soil moisture data in the calibration stage importantly the simulated flow using our calibrated model is capable of accurately reproducing observed historical flows where discharge is medium or low as the focus of our analysis is on water scarcity rather than water excess e g floods we evaluate the performance of the model by means of the modified nash sutcliffe efficiency coefficient nse which is typically used for datasets with large outliers in it legates and mccabe 1999 ritter and muñoz carpena 2013 we obtain values of 0 78 for the calibration period and 0 8 for the validation period in the range of acceptable nse between 0 65 and 0 8 to good 0 8 0 9 model efficiency and above the threshold value of 0 65 typically used to objectively accept the model 4 2 simulation scenarios we articulate simulation scenarios along four stages 1 water inputs to the water system precipitation and baseflow 2 water inputs to the human system irrigation allotments 3 reservoir management rules minimum environmental flows and 4 reservoir management rules tswt in the first stage we assign precipitation and baseflow input values to each relevant sub basin within the utrb system using i observed data from historical hydrological years in the period 1968 2014 including 4 scenarios 2 conducive towards pre alert representative of the upper pamax corresponding to the 1986 1987 hydrologic year and lower pre alert threshold pamin 1991 1992 in the utrb system and 2 conducive towards alert representative of the upper amax 2001 2002 and lower alert threshold amin 2004 2005 in the utrb system and ii hypothetical data from a combination of historical hydrological years and magrama 2017 analysis of water resources availability under rcp4 5 and rcp8 5 climate change scenarios2 to generate 2 additional scenarios ercp4 5 and ercp8 5 conducive towards emergency drought no emergency drought is observed in the 1979 2013 series magrama 2017 water availability scenarios leverage on the climate change scenarios rcp4 5 rcp6 0 and rcp8 5 ipcc 2014 and on the spanish meteorological agency downscaling of such scenarios aemet 2016 which uses local data from meteorological stations and two alternative methods analog method and statistical downscaling method to build an ensemble of 12 precipitation forecasts for each rcp scenario and disaggregation unit aemet 2016 forecasts are subsequently used to force the conceptual quasi distributed and continuous simulation simpa hydrologic model and thus obtain the impacts on runoff following magrama 2017 water availability scenarios runoff can be reduced by 29 for the rcp4 5 scenario and by as much as 51 in the rcp8 5 scenario precipitation and runoff forecasts are used to reduce input data series in our hec hms model and reproduce a hypothetical emergency drought year selected precipitation and baseflow inputs lead to droughts of varying intensity 2 pre alert 2 alert and 2 emergency that trigger dmp irrigation restrictions initial water stock in reservoirs is set based on historical values for the same year as precipitation and baseflow inputs in the second stage drought severity is assessed in april may i e at the beginning of the irrigation campaign based on the drought index for the utrb which in turn is based on inflows to reservoirs see table 2 and agricultural water restrictions are enforced for each awdu along the entire irrigation campaign since water restrictions in the dmp are largely discretionary see section 3 2 we run simulations considering both the maximum 20 under pre alert 40 under alert and 50 under emergency and minimum irrigation restriction thresholds 0 under pre alert and alert 20 under emergency foreseen for the utrb in the trb dmp to assess responses in the human system in the third stage we set the minimum environmental flows at the outlet of the utrb which in turn condition reservoir management rules in the sub basin we consider two alternatives i 2016 minimum environmental flows of 6 m3 s in aranjuez and 2008 minimum environmental flows of 10 86 m3 s in aranjuez note that environmental flows in the tagus river downstream aranjuez e g in toledo and talavera de la reina are dependent on water inputs from the utrb as well as other hydrological units sub basins not included in our study and are therefore excluded from our analysis finally in the fourth stage we assess the outcomes of alternative tswt management rules since dmp water restrictions for the tswt are again largely discretionary we run simulations considering two alternative emergency thresholds the current 400 million m3 threshold and a more ambitious one of 500 million m3 that is currently being discussed high representative of the tagus river basin authority and personal communication 2019 note that under emergency the tswt is closed thus changing the hydrologic dynamics of the srb increasing irrigation restrictions and inducing non trivial behavioral responses to reduced water availability in the srb these impacts are nonetheless excluded from our analysis of coupled human water systems which focuses on the utrb system the combination of the four stages leads to 6 2 x 2 2 48 scenarios and related simulation runs table 7 4 3 simulation results and discussion 4 3 1 microeconomic pmaup module baseflow and input values to hec hms determine the utrb drought index and corresponding drought threshold normality pre alert alert or emergency when the utrb is under pre alert alert or emergency the water availability constraint for irrigation in equation 6 is strengthened activating the first protocol at this point the microeconomic module is used to assess irrigators responses to incremental restrictions in water availability note that the dmp foresees water restrictions to irrigators in the utrb through reduced water allotments in the area and the srb through tswt management rules and thresholds in this application we are interested in modeling the human modified water cycle in the utrb and therefore focus on the former fig 5 summarizes the crop portfolio responses x the decision variable in the microeconomic model of the awdus of the utrb to incremental restrictions in the water allocation constraint of 20 r20 40 r40 and 50 r50 these thresholds correspond to the dmp irrigation restriction scenarios for the utrb described in section 3 2 which range from 0 to 20 for pre alert drought 0 40 for alert drought and 20 50 for emergency drought crop portfolio responses to incremental irrigation restrictions are driven by differentials in the marginal foregone utility due to water allocation restrictions for each crop or shadow price of water agents have distinct initial crop portfolios utility functions and domains that lead to asymmetric shadow price impacts among awdus following irrigation restrictions most agents adapt to incremental irrigation restrictions through land reallocations from irrigated to rainfed agriculture known as super extensive margin adjustments notably through the substitution of irrigated cereals e g corn irrigated wheat irrigated barley by rainfed crops e g rainfed cereals but also rainfed sunflower super extensive margin adjustments can be also implemented through the substitution of irrigated sunflower by rainfed sunflower awdu r08 throughout the utrb the surface of vineyard and olive groves is kept constant with marginal reductions of olive groves in r13 and r15 and an abrupt reduction of vineyard in r09 under scenario r50 due to the inability to meet minimum water requirements with super extensive margin adjustments observed for olive groves in r13 and r15 note that among economic uses spanish dmps give priority to the survival of ligneous crops meaning that an irrigation restriction of 50 in r09 conducive towards the removal of vineyard is unlikely to be implemented another type of adaptive response occurs through land reallocations towards less water intensive crops known as extensive margin adjustments although this is less common in the utrb where most irrigated crops can also produce significant yields under rainfed agriculture one example of extensive margin adjustment is observed in r01 where corn is substituted by less water intensive lentils as the water allocation constraint is strengthened throughout all simulations the surface of highly valuable crops such as onion and melon is kept constant and in the most restrictive scenarios may slightly increase to compensate abrupt income losses e g awdu r09 as noted above the intensity and direction of extensive and super extensive margin adjustments are heterogeneous and depend on agent s unique features domain utility function initial crop portfolio for example awdu r01 is mostly concerned about expected profit see table 4 and conserves a significant surface of irrigated cereals in all simulations which is progressively substituted by less water intensive lentils a relatively more profitable crop than rainfed cereals in that awdu on the other hand awdu r10 is relatively more risk and management complexity averse and adapts through super extensive margin adjustments that favor rainfed sunflower which features a relatively lower variance and management complexity than alternative feasible crop choices in that awdu adaptation to incremental irrigation restrictions leads to reduced water withdrawals and enhanced water conservation in the utrb at the expense of decreased gross value added gva and employment fig 6 rational agents respond to the new irrigation constraint allocating available resources to those crops that yield a higher utility which typically are those that yield also a higher gross margin one of the two components of gva the other being labor income and substituting irrigated crops at the margin i e those yielding lower utility and gross margin by rainfed crops this adaptive behavior leads to gva losses that are less than proportional than irrigation restrictions particularly where irrigation restrictions are still low moderate as the water allocation constraint increases valuable crops are replaced by rainfed crops as well leading to rising incremental gva losses accordingly a 40 reduction of water allotments yields a reduction in gva of about 16 while a 50 reduction of water allotments 1 25 larger yields a reduction in gva of about 21 1 31 larger gva losses show an important degree of heterogeneity among awdus with higher gva losses concentrated in the awdus along the banks of the tagus river where there is a relatively larger land use share devoted to valuable crops notably corn employment is reduced consistently along incremental water constraints although the adaptive behavior of irrigators helps to mitigate employment losses a 40 reduction of water allotments yields an employment loss of 27 while a 50 reduction of water allotments yields an employment loss of 34 employment is reduced at a faster pace than gva suggesting a progressive shift towards less labor intensive crops and a reallocation of income from labor labor income to land tenants gross margin most employment losses happen at the lower areas of the utrb where more labor intensive crops which also happen to be the more water intensive e g corn are located these results suggest that adaptive responses from economic agents in the utrb will mitigate impacts on the human system without affecting irrigation restrictions compliance with a percentage of irrigation restrictions to percentage of gva reductions ratio ranging from 1 0 35 r20 to 1 0 42 r50 and a percentage of irrigation restrictions to percentage of employment reductions ratio ranging from 1 0 65 r20 to 1 0 68 r50 such complex non linear human responses appear fundamental towards proper understanding and accurate representation of water and land management operations in complex socio ecological systems such as the human modified water cycle 4 3 2 hydrologic hec hms module crop portfolio choices in the pmaup model are next used as inputs to the hec hms the second protocol is used to transfer crop portfolio and related water use responses from the human to the water system since dmps univocally reduce water withdrawals and increase water conservation no further irrigation restrictions are applied meaning there is no further feedback response from the water to the human system and convergence is achieved in the first iteration note that achieving convergence may take more iterations with alternative policies e g water markets crop portfolio land use changes under the three scenarios considered r20 r40 r50 see stage 2 are subsequently combined with precipitation and discharge inputs and corresponding initial water stock in reservoirs see stage 1 reservoir management rules inputs stage 3 and tswt management rules inputs stage 4 which altogether conform the 48 scenarios described in section 4 2 to assess the impacts of dmps on the utrb human modified water cycle under alternative conditions impacts on the water system are measured through water stored in the entrepeñas buendía bolarque reservoir system an indicator of system s resilience and represented in figs 7 9 note again that streamflow at the utrb outlet is constant during droughts and equal to the legally binding minimum environmental flow the impact of human agency on the water system is significant in all simulations considered particularly during alert and emergency conditions strengthening or weakening the water allocation constraint e g from r20 to r50 under emergency leads to non linear responses on the human water system that are observable through an increase or reduction of the water stored in the entrepeñas buendía bolarque reservoir system note again that since discretionary irrigation restrictions in dmps in the past have typically gravitated towards the lower less restrictive threshold garrido and gómez ramos 2009 gómez and pérez blanco 2012 there is potential for additional water conservation through more restrictive irrigation constraints during the alert and pre alert year simulations no system failure i e inability to meet minimum environmental flows is observed under current minimum environmental flows 6 m³ s tswt threshold 400 million m³ or projected management rules minimum environmental flows 10 86 m³ s tswt threshold 500 million m³ irrespective of the irrigation constraints imposed to irrigators of the utrb this result is somewhat expected given the upstream location of the utrb and its relative water abundance however while the entrepeñas buendía bolarque reservoir system as a whole can supply sufficient water to existent uses in all pre alert and alert simulations the entrepeñas reservoir is depleted in the r0 tswt 400 million m³ and 10 86 m³ s scenario in the two alert drought simulations a min a max which results in higher vulnerability due to temporary water supply reliance on the buendía reservoir and the guadiela river exclusively our simulations suggest that this temporary vulnerability can be averted by applying a more restrictive agricultural water constraint of 40 in the utrb r40 scenario which reduces gva and employment in the utrb by 16 and 27 respectively or alternatively increasing the tswt emergency threshold to 500 million m³ or a combination of both under climate change the utrb narrowly avoids system failure in the emergency drought simulations considered ercp4 5 ercp8 5 although water stock falls below 100 and 50 million m3 in ercp4 5 and ercp8 5 simulations respectively this erodes resilience and increases the risk of system failure if an emergency drought under rcp4 5 or rcp8 5 climate change scenario lasts for 2 years our simulations indicate that system failure may happen under r20 and 10 86 m³ s minimum environmental flow scenario increasing irrigation restrictions in the utrb to the upper threshold r50 can delay system failure although reservoirs would continue depleting throughout the 2 year period and eventually lead to system failure during the second year of emergency drought in the middle and final stages of the irrigation campaign for rcp4 5 and rcp8 5 scenarios respectively admittedly considering that only one emergency drought has been recorded throughout the period 1979 2013 the possibility of a 2 year emergency drought that results in system failure may seem far fetched yet this is not anymore the case under climate change magrama 2017 analysis of water resources availability under climate change suggests that in some spanish basins including the trb droughts are becoming the new normal indeed the combination of magrama s 2017 climate change scenarios and 1979 2013 historical hydrologic data for the utrb suggests that drought frequency as measured in the dmp will increase consistently in the basin with alert drought years becoming more frequent than normality years from 2040 onwards rcp4 5 scenario and emergency drought years becoming more frequent than normality years from 2070 onwards rcp8 5 scenario fig 10 note that during emergency drought the volume of water stored in our simulations is consistently below 400 million m³ and the tswt is therefore closed meaning that revising the tswt management rules is ineffective towards mitigating drought impacts however this measure is effective to mitigate reservoir depletion during pre alert or alert drought in other words revising the tswt management rules during emergency is ineffective towards preventing system failure but sensible tswt management rules are necessary to avoid that pre alert or alert drought evolves into emergency drought 5 conclusions in the anthropocene the epoch where humans are causing significant impact on the geology and ecosystems of the planet earth natural systems cannot be properly studied and understood in isolation from human systems and vice versa in a context of growing water scarcity water resources reallocation policies may induce behavioral responses on the human system with non trivial feedbacks on the water system and related natural systems this paper develops a modular integrated hydroeconomic pmaup hec hms model to assess the intertwined dynamics of the human modified water cycle using protocols that connect in sequence the human and water systems through common spatial crop portfolio and related land use changes and water availability variables to this end the conventional hec hms sub basin compartmentalization is further sub divided into smaller units that share a common land use which allows the hydrologic module to mimic crop portfolio and land use changes emerging from simulations in the pmaup model the coupling framework is flexible offering the possibility of accommodating alternative microeconomic models in the framework and replicable meaning the protocols can be adapted to accommodate alternative hydrologic models in the framework the proposed framework can be used to mainstream adaptive responses in the human system into the water system through the use of hydroeconomic models that rely on modularity to go beyond conventional stand alone hydrologic or piecewise approximations to human agency the capabilities of the coupled model are illustrated by simulating the impacts of selected drought episodes and their corresponding irrigation restrictions as foreseen under the new dmp of the upper tagus river basin in the center of the iberian peninsula a critical result of the study is that the impact of human agency on the water system is significant in all simulations considered and should not be neglected the non linear responses observed in the human and coupled human water systems which contrast with exogenous piecewise representations of human agency in conventional hydroeconomic models appear fundamental towards a proper understanding and accurate representation of water and land management operations in complex socio ecological systems such as the human modified water cycle in all simulation runs economic agents behavioral responses to reduced water availability induced non linear large scale land use and water management changes with significant impact on major hydrologic processes and water cycle dynamics our results suggest that a comprehensive understanding and accurate representation of the human modified water cycle necessitates a detailed representation of the complex human system dynamics including non linearities and its interaction with the water system which is not achievable through conventional stand alone hydrologic models or piecewise representations of human agency a key finding of our research is that enhancing water stocks and drought resilience in the utrb through changes in the dmp can be achieved by implementing one or both of the following actions in the human system i increasing the tswt emergency threshold which contributes to prevent pre alert and alert droughts from evolving into more severe emergency drought and ii strengthening irrigators water allocation constraint which is also the only effective drought management action during emergency moreover minimum environmental flow requirements are determinant for drought impact assessments simulations are also sensitive to climate change impacts on precipitation and baseflow which are expected to make drought events more intense and lead to emergency droughts that erode system resilience through reservoir depletion and potentially resulting in system failure note that the environmental flows and climate scenarios above are legally binding minimum environmental flows or set by future states of nature climate change and are therefore exogenous to decision making future research should address the limitations of the proposed pmaup hec hms hydroeconomic framework and its modules regarding the limitations of the hydrologic module hec hms is not the most adequate model to reproduce the dynamics of groundwater where groundwater use is relevant the modular framework developed in the paper could be modified to address this shortcoming e g using a hydrogeological model such as modflow as the water system module in addition the model calibration relies on an initial estimation of soil moisture data instead of using longitudinal series which affects model accuracy including during peak flows note that to address this limitation hec hms coding should be updated to incorporate observed soil moisture data in the calibration stage regarding the limitations of the microeconomic module additional attributes and alternative agricultural practices could be explored and eventually incorporated to the pmaup model to improve accuracy for example crop water production functions could be also included in the pmaup model to assess adjustments at the intensive margin i e deficit irrigation although this improvement is conditional to data availability and could be computationally expensive we expect that expanding microeconomic datasets and computational power make the incorporation of additional attributes and crop portfolio choices to the pmaup model and within the coupled hydroeconomic framework increasingly feasible in the future another significant improvement on the economic modeling pertains to the fact that prices are exogenous in microeconomic agricultural models which yields a partial representation of the human system that excludes the macroeconomic system recent studies relying on modularity and recursivity principles have explored alternative approaches to address this gap and could be used to complement our integrated microeconomic programming and hec hms hydroeconomic model with a representation of the macroeconomic system hasegawa et al 2016 parrado et al 2019 ronneberger et al 2009 regarding the coupling procedure the second protocol land use needs further automatization for a better exchange of information between modules and for enabling faster analysis of alternative scenarios in addition the land use coupling protocol relies on monthly inputs from the microeconomic module to increase soil moisture following irrigation withdrawals through diversions in hec hms and water application which may affect accuracy a microeconomic model with a finer temporal scale ideally the day could help address this limitation nonetheless crop portfolio choices are taken by agents at the beginning of the irrigation campaign when water allotments are awarded and typically remain constant throughout meaning conventional microeconomic models work at a coarser time scale than the day usually month or irrigation campaign again rework of the hec hms coding would be necessary to allow for the introduction of daily soil moisture data finally applications in alternative case study areas and using alternative shocks e g water charges water markets are necessary to validate the coupling procedure notably its convergence behavior the limitations of the proposed pmaup hec hms hydroeconomic framework identified above will result in modeling uncertainty parameter and structural and deviations of estimated from observed output variables a seemingly straightforward solution to improve modeling uncertainty in our coupled hydroeconomic approach consists in using for each module those models that minimize such deviations yet since errors in alternative models are typically independent and not directly comparable ipcc 2014 assigning a reasonable metric of uncertainty to each model is challenging due to the discretion involved an alternative to this approach is the use of multiple models in each module so to sample uncertainty through the model spread this precludes conventional consolidative modeling i e finding the optimal policy through a single model on the other hand by means of combining simulation outputs with automatized or heuristic robust decision making methods ensemble experiments avoid providing more information than is warranted by available data and prevent maladaptation as mentioned in the introduction to this article this paper contributes to a growing socio hydrology literature that represents complex human water systems through flexible modular hydroeconomic modeling see e g essenfelder et al 2018 esteve et al 2015 along with these papers our research can contribute towards the development of socio hydrology inspired science that combines increasingly accurate models that reduce prediction errors with ensemble experiments that acknowledge and sample uncertainty for more informed robust decisions significant sources of scenario uncertainty can be also identified in the coupled pmaup hec hms model through both physical e g climate change and socioeconomic variables e g dmp thresholds and related restrictions could be revised and changed scenario uncertainty is typically addressed through scenario discovery techniques i e modeling multiple plausible futures to relate alternative simulation scenarios to their implied consequences which offers a valuable tool to inform decision making in our application to the utrb scenario uncertainty is assessed exploring the outcomes of 48 scenarios through an equal number of simulations however a more profound analysis may be required if a particular policy is to be assessed e g a proposal to revise agricultural water restrictions to utrb irrigators during droughts calls for a larger number of irrigation restriction scenarios in section 4 2 stage 2 note that such application is likely to be significantly more computationally demanding calling in turn for some of the model improvements listed above declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the research leading to these results has been developed with the support of the program for the attraction of scientific talent s swan sustainable watersheds emerging economic instruments for water and food security project and of the ministerio para la transición ecológica y el reto demográfico through fundación biodiversidad atacc project adaptación transformativa al cambio climático en el regadío appendix a supplementary data the following is the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104943 
25889,this paper introduces pysedsim an open source object oriented python based daily time step river basin simulation screening model for flow sediment and hydropower in networks of reservoirs and river channels the model enables users to explore representations of four key concerns relevant to the selection and evaluation of alternative reservoir configurations 1 management approaches to improve the passage of sediment through and around reservoirs to avoid storage capacity loss and downstream ecological impacts 2 search for flexible and adaptive reservoir operating policies designed to achieve multiple objectives 3 alternative design features such as dam gates which are necessary to enable ecologically focused reservoir features and 4 uncertainties associated with hydroclimatic drivers and sediment processes pysedsim is intended to support deliberative decision making and design processes we highlight pysedsim s functionality by demonstrating its use in a real decision context focused on identifying siting design and operation alternatives for the proposed sambor mega dam in cambodia graphical abstract image 1 keywords dams hydropower ecology mekong sediment management reservoir operation software availability name of software pysedsim description pysedsim is an open source object oriented python based daily time step river basin simulation model for flow sediment and hydropower production in networks of reservoirs and river channels it is intended to predict in relative terms the spatial and temporal accumulation and depletion of sediment in river reaches and in reservoirs under different reservoir operating and sediment management policies the model can be run in both stochastic monte carlo and deterministic modes it also offers integrated support for coupling with an external evolutionary optimization algorithm to identify tradeoffs among operating policies designed to perform well across a suite of user defined objectives developer t b wild twild umd edu a birnbaum p reed d p loucks funding sources cornell university s david r atkinson center for a sustainable future acsf national science foundation grant no 1855982 source language python dependencies pandas openpyxl numpy matplotlib mpi4py borg supported systems linux windows license bsd 2 clause availability https github com feralflows pysedsim 1 introduction plans exist for building over 3700 hydropower dams globally in the next 20 years zarfl et al 2015 intensive hydropower development is currently being planned in river basins that host over one third of the world s riverine biodiversity including the mekong amazon and congo among others winemiller et al 2016 vörösmarty et al 2010 zarfl et al 2019 most of these rivers flowed freely several decades ago but have recently experienced increased pressure from hydropower development currently less than 25 of large rivers flow uninterrupted for their entire length grill et al 2019 given that hydropower dams are typically sited designed and operated to maximize power production rather than to preserve ecosystem health and productivity ifc 2015 they pose a direct and significant risk to several hundred million impoverished people who depend upon riverine ecosystem services to support their food security and economic welfare mcintyre et al 2016 the world s most productive riverine ecosystems typically rely on highly dynamic and complex biophysical processes to drive productivity for example in the mekong and amazon river basins a dynamic annual flood pulse drives productivity by annually transporting sediment nutrients and many fish species into floodplains the floodplains then rapidly expand in areal extent encouraging the exchange of energy between terrestrial and aquatic environments junk et al 1989 dams in such river basins and elsewhere have historically disrupted these natural processes including altering natural flow regimes poff et al 1997 trapping sediment vörösmarty et al 2003 and nutrients maavara et al 2015 preventing fish migration noonan et al 2012 bunt et al 2012 and reducing ecosystem connectivity by fragmenting habitats especially for migratory fish species andrén 1994 larinier 2001 fahrig 2003 noonan et al 2012 bunt et al 2012 the externalities associated with dams have led some to argue that healthy freshwater fisheries and dams cannot coexist especially in tropical river basins winemiller et al 2016 fearnside 2016 regardless of these potential negative consequences hydropower development is likely to proceed in many river basins globally moran et al 2018 given this reality society could benefit from planning approaches that seek to support the discovery of more balanced outcomes with respect to ecological energy food and other potential demands to achieve this balance may require significant integrated and ecologically focused modifications to the siting design and operation sdo features of planned dams wild et al 2019a even in river basins where dams are no longer being planned but are instead being removed e g in the united states or retrofitted with ecologically focused design features it seems reasonable to explore significant reoperation of the modified network of dams to restore ecological integrity opperman et al 2011 this will require a departure from the traditional hydropower development paradigm which considers ecological concerns only after hydropower potential is optimized this study contributes pysedsim an open source object oriented python based daily time step river basin simulation model for flow sediment and hydropower in networks of reservoirs and river channels to facilitate exploring ecologically oriented sdo alternatives the model is designed for use in feasibility and pre feasibility ifc 2015 screening assessments of alternative river basin infrastructure plans involving reservoirs the model is flexible both in its software design e g object oriented structure and its core functionality and features e g exploring tradeoffs across multiple conflicting objectives pysedsim users can explore representations of four key concerns relevant to the selection and evaluation of alternative reservoir configurations 1 management approaches to improve the passage of sediment through and around reservoirs to avoid storage capacity loss and downstream ecological impacts 2 search for flexible and adaptive alternative reservoir operating policies designed to achieve multiple objectives 3 alternative design features such as dam gates reservoir bypasses and other hydraulic infrastructure which are necessary to enable ecologically focused reservoir operational practices e g fish and sediment passage and 4 uncertainties in hydroclimatic drivers and in the physical processes of sediment production transport reservoir trapping and reservoir management while some existing river basin modeling tools can address one or several of these concerns we know of none that address them all in a single tool modeling tools designed to support river basin infrastructure planning and management have tended to focus on water examples include iras matrosov et al 2011 loucks et al 1995 weap yates 2005 oasis sheer 2000 riverware zagona et al 2001 and modsim labadie et al 2000 such water management oriented models have not typically accounted for natural and managed sediment processes such as alternative strategies for better managing sediment flows through and around reservoirs thus they have not been effective for exploring options for managing basin scale sediment balances via alternative dam network configurations and reservoir operation strategies this lack of focus on sediment related functionality in river basin planning models historically has occurred for at least two reasons first sediment transport and accumulation in reservoirs has not traditionally been viewed as a major objective of concern in river basin planning efforts annandale 2013 despite the threat that reservoir sedimentation poses to water management and ecosystem health grant et al 2003 petts and gurnell 2005 second sediment production transport trapping and management are complex to represent particularly when it comes to the distribution and management of sediment within large networks of complex reservoir bodies the complexity posed by the movement of sediment through natural and man made water bodies has led to the development of several models that consider sediment management at very fine spatiotemporal process resolution and often for a small number of sediment management approaches such as reservoir flushing chang et al 2003 gallerano and cannata 2011 khan and tingsanchali 2009 shokri et al 2013 u s army corps of engineers 2016 danish hydraulic institute 2017 shin et al 2019 increased process resolution creates extra computational burden and carries additional data collection requirements such as river and reservoir bathymetry and sediment grain size distribution this computational and data collection burden can make these higher resolution tools difficult to deploy in the multi objective multi reservoir stochastic river basin planning contexts for which pysedsim was designed there are some tools that take a coarser resolution approach to sediment simulation to enable basin scale analyses for example pal and galelli 2019 and tangi et al 2019 have developed models capable of exploring options for controlling sediment flows and managing basin scale sediment balances via alternative configurations of dam networks these tools are very effective in basin scale sediment focused infrastructure planning contexts but they lack the detailed representations of reservoir and dam infrastructure required to explore the implications of alternative multi objective reservoir operation strategies including those seeking to improve water management or increase the passage of sediment through or around reservoirs conversely pysedsim simulates alternative reservoir sediment management strategies in reservoir networks with enough detail to capture the implications for sediment balances hydropower hydrology ecology and other considerations but without so much detail that basin scale monte carlo analyses are not possible in particular its representation of dam features e g gates and reservoir operations and the ability to search for alternative operating policies designed to achieve multiple objectives also make pysedsim suitable for use in a traditional stakeholder driven river basin planning context even when sediment is not a focus pysedsim has a software architecture that allows users to rapidly explore alternative sdo problem formulation hypotheses this is integral to facilitating exploration and evaluation of candidate hydropower sdo modifications that may be necessary to reduce reservoirs impacts on the ecological integrity of river basins indeed the most effective modeling tools and scientific studies in influencing policy agendas have often been those that change the way key issues are defined and framed and on the array of options for dealing with issues that are considered rather than only the actions that are ultimately taken cash et al 2003 pysedsim is intended to serve as a flexible iterative problem exploration framework fig 1 that can be deployed to support deliberative decision making processes fig 1 illustrates the deliberative decision support framework that pysedsim has been designed to support it begins with initial problem formulation step 1 which includes defining objectives deterministic or probabilistic constraints and uncertainties the extent to which reservoir operating policies will be pre specified or searched for the network of reservoirs and river channel locations to be considered reservoir design features such as dam gates and reservoir sediment management strategies to be applied in step 2 pysedsim leverages advances in multi objective evolutionary optimization coello et al 2007 reed et al 2013 maier et al 2014 to identify tradeoffs among objectives comprised of a suite of alternative reservoir sdo options some users may wish to initially skip this step beginning instead with simulating pre specified sdo options e g reservoir rule curves in an existing reservoir design returning later to optimization if warranted in step 3 the performance of all or a subset of the identified or pre specified alternatives can be simulated under a range of uncertainties in hydrologic and sediment processes defined in step 1 in step 4 users can connect to external visual analytic tools to navigate alternative solutions this includes visually searching for policies that balance concerns across conflicting objectives and comparing the results across alternative formulations any given problem formulation may only involve a subset of these steps and indeed any step along the way may offer some insight e g into new objectives that warrants returning to the problem formulation step to reframe the problem the remainder of this paper is organized as follows the methodology section describes key pysedsim model features functionality and software design principles and compares pysedsim to existing river basin models the case study section introduces the design and operational context for the proposed sambor dam in cambodia for which we will demonstrate pysedsim s capabilities to analyze hydropower production sediment management and fish passage concerns this section also introduces three alternative problem framings that are representative of the real decision context where pysedsim was used to iteratively fig 1 identify and evaluate alternative sdo options for the sambor dam our results compare the insights gained from these alternative formulations demonstrating how pysedsim facilitates iterative problem formulation and refinement to aid the discovery of decision relevant insights in complex sdo contexts readers interested in detailed guidance on pysedsim features and use should also reference the model s user manual which is available at the model s github repository 2 methods 2 1 classification of modeling functionality fig 2 provides a graphical taxonomy for classifying pysedsim s functionality relative to existing tools that might be considered for use in a river basin reservoir planning context the figure highlights common differences among existing models with respect to three categories each shown in a different colored box the processes they include both physical processes and management processes the mathematical representations of those processes and the nature of the questions the model is designed to explore e g simulation versus optimization within each of the three colored boxes there exist categories of choices each of which is represented by a tree in general these trees are intended to describe some of the key features that models used in a river basin planning context may have options within a given tree are not necessarily mutually exclusive modeling choices for example models such as pysedsim can have both deterministic and stochastic simulation options and may even represent different processes with different levels of detail boxes outlined in red are used to highlight where pysedsim s features reside within this hierarchy of potential modeling choices beginning with box i processes included river basin models often include representations of natural physical processes which describe how water and sediment move through the natural landscape e g rainfall and runoff as well as management processes which describe the various ways in which these natural processes may be modified by infrastructure e g management of water and trapping of sediment in reservoirs striking a balance between computational demands and end use purpose pysedsim is limited in its abstraction of detailed natural physical processes in the water resources domain natural physical processes frequently accounted for in models include rainfall runoff groundwater infiltration and channel flow among these processes pysedsim accounts only for routing of flows through networks of river channels relying on user selected external models e g swat for the other processes with respect to sediment models are often classified as either loading models which account for production of sediment suspended in watershed runoff or as receiving models which route sediment through channels and reservoirs kalin and hantush 2003 pysedsim is a receiving model designed to receive input from a loading model e g swat an important difference among receiving models is with respect to the degree to which sediment management processes are included pysedsim includes numerous sediment management processes such as the trapping of sediment in reservoirs the distribution of that sediment within reservoirs storage geometry and the various ways in which sediment can be removed or passed through or around reservoirs in reviewing existing river basin simulation models e g matrosov et al 2011 loucks et al 1995 yates 2005 sheer 2000 zagona et al 2001 labadie et al 2000 we found a dearth of models that include treatment of both sediment and water processes especially reservoir sediment management sediment management focused models typically do not include detailed representations of water management issues likewise water management focused models typically do not explicitly account for any of the natural or managed sediment processes from box i pysedsim includes water management features such as reservoir operations and river routing capabilities though it does not include water demand and supply modeling or groundwater which water management focused models typically do box ii process representations in fig 2 shows that all of the natural and managed water and sediment processes from box i can be represented with varying degrees of complexity including the mathematical representations of relationships the extent to which uncertainty is represented and the resolution of the model in both space and time pysedsim employs empirical process relationships with a specific intent to enable sdo analyses given the data limited nature of most problem settings it also offers the flexibility to explore through monte carlo simulation the uncertainty in the numerous parameters that define these empirical relationships including parameters for sediment production sediment transport reservoir sediment trapping and reservoir sediment management with respect to spatiotemporal resolution pysedsim is a lumped model in that users are permitted to define parameters for discrete model elements e g river channel segments the model is a one dimensional fixed bed model in that it does not explicitly represent channel or reservoir cross sections and their feedbacks with flow processes as can be accounted for in more detailed models such as hec ras u s army corps of engineers 2016 a daily time step was selected to facilitate coupling with existing daily time step loading models such as swat with respect to process representation in reservoir sediment management models focused on sediment management often represent only a limited number of alternative sediment management strategies such as flushing e g chang et al 2003 gallerano and cannata 2011 khan and tingsanchali 2009 shokri et al 2013 and do so at fine resolution such detailed process representations require more data such as sediment grain size distribution and reservoir bathymetry detailed simulations also tend to be more computationally intensive and are difficult to embed within a broader multi reservoir network simulation for example hec ras u s army corps of engineers and mike21c danish hydraulic institute 2017 offer physically based simulations of management processes such as sluicing and flushing conversely pysedsim enables less detailed assessments of multiple alternative sediment management strategies for large scale multi reservoir systems box iii identification and evaluation of management actions within fig 2 highlights how existing models differ in the questions they are designed to answer pysedsim is a simulation model in that it addresses what if scenarios what may happen if a particular scenario e g hydroclimatic inputs or reservoir network configuration is assumed or if a particular decision e g reservoir operating policy is made conversely optimization models seek to identify the best decision or tradeoffs among alternative equally optimal decisions while pysedsim is a simulation model at its core it facilitates direct coupling with external optimization models finally as with process representations management actions can be identified and evaluated in both deterministic and stochastic monte carlo contexts in pysedsim for example the model s stochastic simulation optimization functionality will search for robust operating policies that perform well under a range of future uncertainties pysedsim is a preliminary screening model loucks and van beek 2017 loucks 2020 in that its best use is to explore a wide range of alternatives and the tradeoffs in performance across them the coupled simulation optimization functionality enables users to screen out a large number of less desirable alternatives leaving a relatively smaller number of potentially desirable alternatives to be evaluated later with other more detailed e g finer spatiotemporal resolution simulation models for example during the hydropower project development process ifc 2015 this more detailed modeling is typically done during the detailed design phase rather than during preliminary screening of alternatives this detailed phase of analysis could also include higher resolution assessment of specific sediment management alternatives e g sluicing flushing dredging etc at specific reservoir sites e g using process based models like hec ras 2 2 detailed model functionality and assumptions 2 2 1 overview pysedsim includes a unique combination of four core model features 1 representing alternative reservoir sediment management approaches 2 representing detailed dam design features e g gates 3 supporting multi objective optimization frameworks for discovering reservoir operating policies and their resulting tradeoffs and 4 facilitating stochastic monte carlo simulation for characterizing uncertainty in hydrologic and sediment processes fig 3 illustrates some of these model features in the context of an example pysedsim simulation network of river channel segments reservoirs and connecting junctions through which water and sediment are routed and stored on a daily basis in a simulation any pysedsim simulation network is comprised of some combination of these three building blocks the features illustrated in fig 3a are organized into two categories sediment left and water right 2 2 2 natural water and sediment processes in keeping with its intended use as a screening model pysedsim employs relatively simplistic i e empirical approaches to representing complex sediment processes including sediment production transport reservoir trapping and distribution and reservoir management left hand side of fig 2 at its core pysedsim includes most of the sediment simulation functionality present in the sedsim simulation model wild et al 2019b wild and loucks 2015a https github com feralflows sedsim but with new features that support stochastic simulation and multi objective optimization sedsim has been applied in other studies to evaluate the hydrologic sediment and hydropower implications of reservoirs wild and loucks 2014 2015b 2016 souter et al 2020 while pysedsim s python based object oriented software design section 2 4 is much different from sedsim s visual basic for applications vba based software design both models allow users to exploit the same excel based interface if desired this simple interface ensures backward compatibility with previous sedsim applications and facilitates training of less advanced users e g river basin stakeholders as shown in fig 3b water and sediment can only enter the modeled system at junctions flows specified at junctions represent incremental daily water and sediment runoff from the local watershed i e between successive incremental flow junctions the model simulates a single median sediment grain size rather than a grain size distribution junction inputs must be externally gathered e g from gage station data or generated e g simulated with a separate model such as swat neitsch et al 2009 users can also specify parameters for a rating curve function that describe daily sediment load production as a function of daily hydrologic flow water and sediment entering a junction in a given day immediately enter the next downstream channel segment or reservoir and are thereafter routed through that downstream element along with any sediment and water entering from upstream fig 3c depicts this routing process for an example river channel segment i the model maintains flow routing options consistent with some of those available in the swat model neitsch et al 2009 including manning s equation routing as shown in fig 3c each channel segment is assumed to have a carrying capacity bagnold 1977 to produce suspended sediment in its outflow as a power function of water outflow rate if the concentration of sediment suspended in the water column exceeds the channel s carrying capacity some sediment settles to the channel bed i e deposition dominates otherwise sediment is scoured from the channel bed i e resuspension dominates 2 2 3 managed water and sediment processes 2 2 3 1 reservoir sediment trapping distribution and management the model includes representations of reservoir sediment trapping distribution and management processes as shown in fig 3d the fraction of inflowing sediment mass trapped in a reservoir during each time period or trapping efficiency is determined as a function of sediment particle size and residence time of water in the reservoir brune 1953 this results in declining trapping efficiency with declining storage capacity minear and kondolf 2009 morris and fan 1998 within the reservoir s storage capacity the volume occupied by settled sediment mass depends on its user specified bulk density fig 3d shows that the model differentially distributes deposited sediment within the reservoir s active and dead storage zones lara and pemberton 1963 which captures the impact of sedimentation on reservoir operations despite the availability of techniques to improve sediment passage through and around reservoirs kondolf et al 2014b annandale 2013 planning studies of large reservoir networks typically focus on predicting sediment trapping e g kummu et al 2014 kondolf et al 2014 rather than on assessing the potential to reduce it wild et al 2016 2019a wild and loucks 2014 schmitt et al 2018 this capability is needed when simulating alternative dam development configurations in basins such as the amazon congo and mekong as these river basins transport among the world s highest annual sediment loads milliman and meade 1983 fig 3 does not depict pysedsim s representations of sediment management processes which are relatively more complex and therefore appear in the model s user manual in general pysedsim employs empirical approaches to simulating the effectiveness of flushing atkinson 1996 sluicing churchill 1948 and density current venting morris and fan 1998 at removing or passing sediment through a reservoir before considering simulating particular reservoir sediment management techniques with pysedsim an external model such as rescon should first be used to assess the economic and technical feasibility of those techniques given the reservoir s site specific characteristics palmieri et al 2003 efthymiou et al 2017 2 2 3 2 reservoir operations and dam design features reservoirs are assumed to be regulated by a dam the daily outflows from which are determined by an operating policy subject to constraints related to the dam s outlet works and primary operational objectives as listed on the right hand side of fig 3 pysedsim offers flexibility in exploring reservoir operations numerous studies have noted the potential value of optimization in contributing to the ongoing multi objective river basin development dialogue globally sabo et al 2017 tnc 2016 ziv et al 2012 opperman et al 2015 grill et al 2014 2015 roy et al 2020 cronin et al 2016 kondolf et al 2018 schmitt et al 2018 wild et al 2019a schmitt et al 2019 intralawan et al 2018 song et al 2020 pysedsim has been developed to support the flexible representation of candidate reservoir operations and simulation of their performance the software offers specific support for the evolutionary multi objective direct policy search emodps analytic framework giuliani et al 2016 guariso et al 1986 oliveira and loucks 1997 koutsoyiannis and economou 2003 for quantifying operational tradeoffs the emodps simulation optimization framework is implemented by facilitating a full coupling of pysedsim with external multi objective evolutionary optimization algorithm moea solvers coello et al 2007 reed et al 2013 zatarain salazar et al 2016 the closed loop feedback structure of the identified operating policies can flexibly adapt to changing site conditions where site conditions can be abstracted using any relevant reservoir state variables as inputs e g water surface elevation inflow and time of year objectives are defined by the user as a function of any pysedsim model state variables e g daily suspended sediment passage flow rates etc for any system element i e junction reservoir or channel the ability to identify adaptive operating policies is a distinct advantage in assessing the potential for sdo alternatives to mitigate ecological impacts wild et al 2019a the theoretical details of pysedsim s emodps approach to identifying tradeoffs composed of alternative reservoir operating policies appears in wild et al 2019a as well as in the model s user manual while pysedsim directly supports a search for alternative reservoir operating policies the software s architecture also theoretically enables searching alternative relevant decision spaces such as the locations of reservoirs in networks by including these decision variables among those that define reservoir operating policies the code modifications required to do this are discussed in the user manual at the paper s online repository conducting such joint planning management simulation optimization particularly for large scale systems e g with numerous dams creates the potential for steep computational expense this is one of the reasons that such joint planning management analysis has long posed a challenge in the water resources and environmental systems literature zeff et al 2016 loucks and van beek 2017 wild et al 2019 bertoni et al 2019 herman et al 2020 trindade et al 2020 the emodps approach pysedsim uses to explore tradeoffs across alternative portfolios of decision variables avoids the curse of dimensionality bellman 1957 that limits the power of dynamic programming based approaches in joint planning management contexts giuliani et al 2016 in order to accurately evaluate sediment removal sediment passage and fish passage pysedsim enables users to explore the performance of dams with alternative detailed design features this includes not only reservoir storage capacity and geometry i e elevation volume area curve but the presence of low level outlets mid level outlets i e sluice gates spillways and hydraulic bypass channels and their specifications e g elevation discharge capacity curves 2 2 4 uncertainty analysis the effectiveness of the previously discussed design and operational features can be evaluated in either stochastic monte carlo or deterministic mode this enables users to explore performance of alternative operating policy and design configurations under different hydrologic and sediment uncertainties as well as to identify sdo features that perform robustly under these uncertainties pysedsim s monte carlo functionality enables users to sample the multiple empirical model parameters employed in representing sediment processes including sediment production from the watershed transport in river channels trapping in reservoirs and various representations of reservoir sediment management processes parameter sampling is possible across a diverse array of probability distributions e g normal uniform triangular etc to explore uncertainty in hydroclimatic conditions users may generate stochastic sequences of daily hydrologic and sediment inflows using external models or techniques e g stedinger and taylor 1982 pysedsim provides support for monte carlo simulation by sampling these externally generated time series and organizing the stochastic simulation results in comparing pysedsim to other river basin simulation models we found widespread exclusion of uncertainty analysis capabilities regardless of a model s core process focus i e water or sediment in the water management domain existing models are often limited in their ability to handle even well characterized e g hydroclimatic uncertainty uncertainty analysis is theoretically possible in any simulation model for which execution can be automated but many models do not directly support monte carlo simulation with simple user specifications with respect to sediment management few models include stochastic representations of the sediment management processes e g shokri et al 2013 regardless accounting for uncertainty in models with very detailed representations of sediment management would render these models even more unlikely to be applicable in a river basin planning setting the capability to evaluate the impacts of key uncertainties is foundational to evaluating the risk driven objectives of decision relevance in many river basins quinn et al 2017 2 3 software design as illustrated in fig 4 pysedsim s software architecture is designed to support flexibility extensibility transparency provenance and scalability flexibility is addressed by providing a breadth of river basin and infrastructure features that can be readily represented in sdo applications transparency refers to the extent to which model users and prospective developers can view and understand the software s design and structure provenance refers to the chronology of ownership and development of a model scalability refers to pysedsim s ability to be implemented across a range of computing resources from laptops to high performance parallel supercomputers this helps users to effectively manage the computational demands in their analyses e g simulations of larger systems uncertainty assessments simulation optimization finally extensibility refers to facilitating a broad range of analytical workflows that exploit current and emerging software tools each of these five software architecture design features is addressed separately below flexibility is achieved in pysedsim through object oriented and modular software design the enlarged box on the upper right hand side of fig 4 demonstrates a simplified unified modeling language uml diagram of a representative sample of core pysedsim classes and their hierarchical relationships this serves as just one example of the numerous classes used to organize the model s key processes and features core sub classes are shown at the bottom of the uml diagram any given model application requires creating multiple of these core sub classes and piecing them together into a unique network of reservoirs channels and junctions pysedsim s object oriented design facilitates integration of multiple energy and ecological concerns into a single model because prospective co developers can easily extend the model s functionality to include new or different ecological or other concerns pysedsim facilitates extensibility through outward connectivity to external python based packages and tools the enlarged box on the lower right hand side of fig 4 provides a sample of existing connections between pysedsim and external python packages as well as examples of potential future external connections some packages are required for pysedsim to run basic simulations whereas others are used to extend pysedsim s functionality only in select circumstances e g optimization for example fig 4 shows that to facilitate identification of tradeoffs and optimization of operating policies pysedsim connects to the borg multi objective evolutionary optimization algorithm hadka and reed 2013 while pysedsim directly supports the borg moea pysedsim can be coupled with any open source moea that is python based or has a python wrapper such as the project platypus library https github com project platypus platypus to facilitate scalability especially in monte carlo simulation or simulation optimization experiments pysedsim uses the python based message passing interface for python i e mpi4py package dalcin et al 2005 2008 2011 to facilitate user interaction with the model software and efficient data import pysedsim uses the python based openpyxl library to import excel based data gazoni and clark 2017 to facilitate data processing and export pysedsim uses the python based pandas software for panel data manipulation and analysis mckinney 2012 to organize process and export simulation data by enabling the use of an excel based user interface and efficient production of data outputs these connections facilitate pysedsim s goal to serve as a decision support system loucks 1995 to facilitate data visualization pysedsim uses the matplotlib package hunter 2007 to facilitate use of external hydrologic and sediment modeling tools pysedsim is built to accept inflows and sediment loads in the same style as those produced by the swat model neitsch et al 2009 such external modeling exercises e g swat that enhance pysedsim analyses often require extensive expertise and data sets thus pysedsim applications can benefit from leveraging the modeling outputs produced by other more detailed studies while the model does not currently connect directly to an external python based stochastic hydrology package for hydroclimatic uncertainty analysis the model is structured to facilitate establishment of such a future connection as well as to sensitivity analysis libraries e g the sensitivity analysis library salib developed by herman and usher 2017 in a river basin modeling context transparency is likely the single most important factor in facilitating replicability and reproducibility ceola et al 2012 which are often overlooked but fundamentally important requirements for designing and executing sound scientific experiments peng 2011 transparency also encourages extensibility by enabling users to more effectively understand and extend the model pysedsim is transparent via its object oriented and modular code design and extensive in code documentation which clarify model structure by providing fully replicable example model applications which are explored in this paper and in that the code is open source the model s open source repository facilitates provenance by enabling co developers to contribute code on the model s public repository finally scalability is important in the context of evolutionary optimization methods which can require many simulations to converge on reliable solutions pysedsim is scalable in that it supports cluster based parallelization of simulation optimization and monte carlo simulation experiments this functionality is available to users through several pysedsim functions that optionally call the mpi4py package details are provided in the model user documentation and in function docstrings 3 model application case study sambor dam mekong river basin cambodia 3 1 background the mekong river in southeast asia is one of the world s most productive and dynamic rivers hosting an open access wild capture fishery of over 1200 fish species poulsen et al 2004 the basin s 60 million inhabitants rely on the river for food and income security harvesting 2 1 million metric tons of fish per year at a retail value of up to 7 8 billion us per year hortle 2009 less than 30 years ago the river fig 5 a flowed freely for 4350 km mrc 2016 today over 40 large hydropower dams exist with over 100 more dams proposed or under construction mrc 2016 the proposed sambor mega dam has been a major focus for the government of cambodia goc in its efforts to generate hydropower revenue and secure a reliable domestic energy supply sambor s original design china southern power grid company 2008 was proposed to extend 18 km across the mekong river which would make it one of the world s longest dams lehner et al 2011 as the basin s downstream most proposed dam it would be sited in proximity to tonle sap lake one of the world s most productive freshwater lakes lamberts 2006 that provides up to 80 of cambodia s protein in some areas hortle 2007 over 50 species of fish annually migrate upstream past the planned dam site to main stem and tributary spawning grounds barlow et al 2008 halls and kshatriya 2009 after spawning the fish swim downstream past the planned dam site returning to the floodplains to feed eggs laid in tributaries become larvae that naturally passively drift back downstream to the floodplains while suspended in the river s flow nearly all of the mekong s natural 160 mt y sediment load is transported annually past the dam site as well designed to maximize energy production the sambor design poses fundamental ecological concerns because it would provide inadequate means of passing the river s significant migratory fish biomass and would be too large and wide to effectively pass sediment nutrients and fish larvae downstream wild and loucks 2015b in a multi year partnership with the goc nhi 2017 wild et al 2019a used pysedsim to study the potential for alternative sambor dam sdo options to produce more balanced outcomes with respect to ecological and energy production goals as shown in fig 5 an alternative dam concept sambor ecological alternative i e sambor ea was identified that includes numerous siting and design features to encourage sediment and fish passage the dam s salient design feature is a completely unregulated natural bypass channel to the east of the reservoir that exists to facilitate sediment passage and fish migration sambor ea s geographic location is shown in fig 4a fig 4b shows a plan view of the dam and reservoir overlaid by a pysedsim model schematic of the river channel segments junctions and reservoir that make up the pysedsim implementation of sambor ea used for demonstrative purposes in this paper ultimately the iterative process of exploring sambor alternatives described in section 3 2 contributed to the success of nhi 2017 in directly influencing the goc to postpone all mainstem mekong dam construction ratcliffe 2020 3 2 iterative problem formulation overview pysedsim supported the stakeholder engagement and pre feasibility planning process surrounding sambor and sambor ea nhi 2017 through an extended iterative problem formulation and exploration process with basin stakeholders fig 1 in this paper we demonstrate pysedsim s use across three formulations that compare searching for rather than pre specifying operating policies conducting stochastic versus deterministic analysis and exploring combinations of multiple performance metrics that reflect diverse stakeholder preferences each candidate formulation builds upon prior formulations to arrive at final recommendations to decision makers nhi 2017 to evaluate performance across formulations we evaluated sambor ea reservoir operation alternatives using daily simulation output from the six pysedsim state variables below which we selected to reflect diverse stakeholder preferences 1 daily energy production gw h e hydropower production at the sambor ea powerhouse 2 daily bypass attraction flow rate m 3 s f the bypass channel in fig 5b will be the primary route for fish to circumnavigate the dam this variable represents the attraction of fish into the bypass channel during upstream migration bunt et al 2012 noonan et al 2012 3 daily larvae flow fraction unitless 0 1 l larvae can die due to predation and starvation if they are trapped in a reservoir while drifting downstream agostinho et al 2007 pelicice and agostinho 2008 pompeu et al 2011 suzuki et al 2011 pelicice et al 2015 this variable uses the fraction of main stem flow each day that either enters the bypass i e safe passage or enters the reservoir when velocities are suitable for passage fig s1 to estimate the daily fraction of larvae safely passing the site wild et al 2019a describe the modeling approach to evaluate suitability of reservoir hydraulic conditions for larvae passage 4 daily trapped sediment load kg s t this variable represents the suspended sediment load trapped in the reservoir s storage capacity the river s suspended sediment load sustains the river s geomorphic structure rubin et al 2015 and habitats halls et al 2013 transports nutrients liljeström et al 2012 arias et al 2014 and slows the subsidence of the mekong delta landform which poses an existential threat to its nearly 20 million inhabitants kondolf et al 2018 schmitt et al 2017 5 daily reservoir total storage capacity loss s c this variable represents the loss in total reservoir storage capacity m3 total storage capacity is the sum of active storage capacity which is accessed during normal operations and dead storage capacity sedimentation reduces reservoir storage capacity and hence energy production and reliability as well as other benefits dams provide mahmood 1987 white 2001 globally storage capacity is being lost in reservoirs at a rate of 0 5 1 per year mahmood 1987 white 2001 6 daily sediment load released from the dam during flushing events kg s f to enable passage of sediment through the site our simulations implemented annual sediment sluicing i e pass through and flushing i e removal the less frequently flushing takes place the larger the short term sediment pulses released downstream become relative to natural conditions thereby posing risks to ecosystems downstream wild et al 2016 we summarized each daily time series variable temporally e g annually monthly or daily and statistically e g mean and quantile to create decision relevant performance metrics such as mean annual energy production detailed mathematical definitions of these performance metrics are provided in section ii of the paper s supplement in particular table s3 shows each formulation s performance metrics and corresponding equations fig 6 summarizes the key differences across the three formulations with respect to performance metrics each formulation has a potential space of 2 columns and 4 rows in which performance metrics can reside columns represent the nature of statistical metrics of performance focused on either risk neutral mean performance or a more risk averse worst first percentile of the empirical cumulative distribution function depending on the formulation rows represent the time scales of interest for each of the performance metrics ranging from daily to annual within each formulation each individual shape i e square or circle in the figure corresponds to a different metric squares reflect pre specification of reservoir operating policies whereas circles reflect a search for operating policies via optimization the color of a shape represents the category of its corresponding performance metric including sediment fish larvae and energy the sediment i e brown colored category includes all three of the sediment related time series variables discussed previously filled and hollow shapes correspond to deterministic and stochastic simulation of metrics respectively deterministic evaluations consisted of a historical simulation using the full 100 year long flow record available at the stung treng gage station near the sambor ea dam site alternatively the monte carlo simulations consisted of a stochastic ensemble of five 100 year simulations each driven by a randomly drawn sequence of synthetically generated nowak et al 2010 kirsch et al 2013 inflow hydrology and corresponding daily sediment loads see section iii e g fig s2 of the paper s supplement for further details on our approach to synthetic flow generation as shown in fig 6 formulations implementing optimization formulations ii and iii seek to maximize or minimize performance with respect to the mean or 1st percentile of the empirical cumulative distribution function cdf for the 500 values i e 5 realizations of 100 years performance was maximized in all objectives except for the sediment related objectives which were minimized in the following subsections we briefly introduce a short synopsis of each of the three formulations and discuss their results detailed mathematical definitions for each of the formulations and performance metrics appears in section iv of the supplement section v of the supplement details the paper s computational experiments including model configurations and computing requirements to run each formulation follow the model installation instructions on the model s github repository then run the desired formulation s python script e g formulation i serial py for the serialized version of the screening formulation 3 3 formulation i problem screening 3 3 1 formulation i overview the problem screening formulation screening represents a typical starting point in a dam pre feasibility study ifc 2015 wherein a particular dam concept i e location and basic design specifications has been identified but in order to evaluate its suitability for investment the dam s performance potential must be evaluated e g with respect to energy production and adverse ecological impacts sambor ea has the capacity to store less than 0 5 of mean annual inflow the tendency in pre feasibility studies of similarly hydrologically small i e low capacity inflow ratio reservoirs is to specify energy maximizing run of river operations much like specifying a static design feature to reflect this standard planning approach the screening formulation includes an energy maximizing rule curve i e energy rule curve as shown in fig 7 rule curves for sambor ea were strongly shaped by the reservoir s complex hydraulic configuration which is detailed in the appendix fig s1 in brief the reservoir s unregulated upstream end means that lower water levels increase reservoir inflows and reduce spillage into the unregulated bypass channel thus energy production is not maximized by maximizing water level because high water levels imply significant spillage to reflect diverse stakeholder preferences and to attempt to capture the potential for tradeoffs across objectives we also include two ecologically focused rule curves one focused on larvae passage i e the larvae rule curve and one focused on adult fish passage i e adult fish rule curve the larvae rule curve was designed to enable year round downstream passage of fish larvae the adult fish rule curve was designed to benefit adult fish passage around the dam by maximizing the rate of flow spilled into the bypass channel disciplinary experts identified these rule curves during the pre feasibility study of sambor dam nhi 2017 across all formulations operating policies implement identical approaches to improving sediment passage through and around the sambor ea reservoir including annually passing inflowing sediment through the reservoir i e sluicing through mid level outlets and infrequently removing deposited sediment from the reservoir i e flushing through low level outlets to highlight the difficulty in pre specifying rule curves that perform well under uncertainty across multiple metrics the three rule curves were simulated both deterministically using the 107 year historical hydrologic record and stochastically using synthetically generated hydrologic sequences to modestly sample well characterized hydrologic uncertainty performance was then evaluated both deterministically and stochastically with a wide range of metrics reflecting different temporal and statistical filtering of the six time series variables introduced in section 3 2 1 formulation i is referred to as the problem screening formulation because we initially explore a large set of metrics then sift through those metrics to inform a more targeted subset of metrics for future problem formulations fig 6 shows that all metrics in the screening formulation were evaluated annually except for sediment flushing which was evaluated on a monthly basis to capture the potential for ecologically harmful short term spikes in sediment load in total the screening formulation consists of 12 simulations one deterministic and one stochastic simulation for each of the three rule curves with and without reservoir sediment management taking place in this sense the screening formulation is a departure from the traditional dam pre feasibility analysis because it emphasizes evaluating policy performance under a wide range of performance metrics and uncertainties to better understand performance potential and tradeoffs 3 3 2 formulation i results the nine plots in fig 8 report the performance of the three expert elicited operational rule curves the top row of plots fig 8a c report the rules attained performance for energy production larvae passage and fish passage fig 8d i summarize the rule curves performance for sediment including the quantity trapped the effect of the trapped load on storage capacity and the magnitude of sediment released downstream of the dam during the month of june when the majority of flushing events take place for these metrics fig 8d f reflect simulations in which no sediment management takes place whereas fig 8g i account for sediment management effects within each figure the three rule curves are designated by different colors across the metrics of performance the deterministic performance results are plotted as single mean values i e vertical lines representing the three candidate rule curves mean annual performance for a single historical time series of hydrologic and sediment inflows in contrast stochastic performance dashed lines for a given rule curve is plotted as an empirical cumulative distribution function cdf each cdf represents the distribution of performance across all years in the monte carlo simulation as the slope of the cdfs become flatter the variance in attained performance metrics is increasing each stochastic cdf represents a simulation with five inflow sequences of 100 years or 500 annual values this sampling level was confirmed to provide stable convergence for the more extreme quantiles in the empiric cdfs fig 8 reveals three key points for guiding the evolution of future sambor ea problem formulations first there is significant variance in performance across numerous performance metrics under a modest sampling of well characterized uncertainty as an example of important variance at sambor ea fig 8a shows that annual energy production varies from the mean by as much as 50 in best and worst case years for each of the three policies this has important financial implications as the dam s financier must maintain adequate cash flows to service the debt incurred in constructing the dam not just on average but also during periods of lower hydrologic inflows this strongly suggests future problem formulations should account for uncertainty in identifying and evaluating candidate operating policies it has long been known that optimizing policies to achieve mean focused performance metrics often tacitly exposes policies to broader variability in performance beyer and sendhoff 2007 the variability in performance across the probability distribution for each metric underscores the importance of sampling multiple stochastic hydrologic futures to more reliably approximate the distribution tails i e extreme events second the results from the screening formulation show that evaluating a small handful of pre specified policies designed to achieve performance in a single objective has two important consequences to begin this approach suffers from the potential for strong decision maker regrets as performance could likely be substantially improved in all metrics i e a dominated set of candidate actions despite the best efforts of disciplinary experts additionally even if the policies are theoretically optimal in each single metric evaluating a small handful of policies can only reveal that performance conflicts exist rather than explicitly quantifying their complex tradeoffs for example the larvae rule curve was unsurprisingly the best performing with respect to the larvae passage objective fig 8b yet it performed the worst of the three policies with respect to energy production fig 8a and bypass flow for adult fish passage fig 8c together these results suggest future problem formulations should include an optimal search for reservoir operating policies and the tradeoffs they create rather than pre specifying rule curves which is at present standard practice in most simulation frameworks loucks et al 1995 sheer 2000 labadie et al 2000 zagona et al 2001 matrosov et al 2011 yates 2005 third the middle and bottom panels of fig 8 demonstrate the value of pysedsim s ability to evaluate reservoir sediment management metrics fig 8d shows that despite its ecologically focused redesign sambor ea could trap 5 8 million metric tons of ecologically important suspended sediment on average annually fig 8d shows that this could result in an annual loss of 0 25 0 6 of total reservoir storage capacity per year this implies the reservoir could lose up to nearly 25 of its storage capacity by the time of transfer of ownership of the dam this result has important implications for the goc who would only assume ownership of the devalued reservoir after a concession period of up to 40 years nhi 2017 options are available to mitigate storage capacity loss fig 8g and h show that implementation of annual sediment pass through i e sluicing and irregular removal i e flushing every 15 years for drawdown periods of about one week significantly limit deposition and storage capacity reduction by regularly preventing and removing deposited sediment these increased sediment flows show that significant basin wide sediment trapping e g as predicted by kondolf et al 2014 both in the mekong and elsewhere is not a foregone conclusion much of the scientific literature focused on reservoir sedimentation particularly in the mekong e g kondolf et al 2014 kummu et al 2010 is geared toward impact prediction and vulnerability assessment rather than practical management approaches to mitigating impacts wild and loucks 2014 2015b 2016 wild et al 2019a however implementing these approaches requires dams be sited and designed e g with low level outlets to enable these approaches to be applied kondolf et al 2015 annandale 2013 kondolf et al 2014 mrc 2009 pysedsim captures design details such as low and mid level gates that facilitate this evaluation while the potential for sediment management options exist a comparison of fig 8f i shows that techniques such as flushing can have negative impacts if not managed carefully specifically irregularly flushing sediment from the reservoir can significantly distort the river s natural probabilistic sedigraph i e sediment duration curve downstream of the dam site during the month of june when flushing occurs most frequently sediment discharge increases not only on average but also in the more extreme quantiles of the probability distribution creating the potential for significant ecological impacts downstream wild and loucks 2016 one potential solution is to increase the frequency of flushing though this creates a tradeoff with the objective to maximize annual energy production 3 4 formulation ii discovering tradeoffs 3 4 1 formulation ii overview while the three screening formulation rule curves potentially represent reasonable efforts at maximizing performance among three objectives there is no guarantee these policies perform well compared to other possible operational rules or that they perform well under uncertainty moreover it is difficult to assess how the expert defined operational rules are striking compromises across the complex tradeoffs that likely exist across ecological concerns and power production ending the analysis at the screening formulation could misrepresent sambor ea s potential to achieve balanced ecology energy outcomes this motivated the need for the discovering tradeoffs i e tradeoffs formulation in which we conduct an optimal search for policies designed to perform well across multiple objectives under uncertainty the tradeoffs formulation seeks to identify rather than pre specify alternative reservoir operating policy alternatives that perform well on average under hydrologic uncertainty as shown in fig 6 this formulation seeks to identify policies that perform well with respect to a subset of four of the performance metrics that demonstrated strong tradeoffs and decision relevance in the screening formulation namely reservoir sediment trapping and storage capacity loss metrics are dropped compared to the screening formulation and finer temporal scale is adopted for the adult fish passage and sediment flushing metrics rather than seeking to identify a single optimal operating policy pysedsim s multi objective simulation optimization approach identifies the suite of candidate operating policies whose performance in at least one objective cannot be improved without degrading performance in one or more of the remaining objectives i e pareto approximate solutions a fully coupled multi objective evolutionary algorithm moea the borg moea hadka and reed 2013 parameterizes and iteratively refines operating policies optimizing them in response to their simulated performance with respect to four metrics reservoir operating policies take the form of parameterized non linear gaussian radial basis functions rbfs these rbf parameters serve as the decision variables the moea uses to control policy performance additionally the tradeoffs formulation includes three sediment management variables in its optimal search related to sediment flushing 1 the frequency of sediment flushing operations constrained from 1 to 15 years 2 the day of the year on which to begin considering flushing the reservoir constrained from days 120 225 to avoid dry season and monsoon conditions wild et al 2016 and 3 the reservoir inflow rate m3 s triggering flushing drawdown to occur constrained from 6000 10 000 m3 s section v of the supplement contains a summary of key moea related assumptions across formulations and the performance of the moea in relevant formulations 3 4 2 formulation ii results the four objective ecology energy tradeoffs in fig 9 resulting from the tradeoffs formulation provide a broader context for understanding key performance conflicts and for exploring diverse stakeholder preferences fig 9 represents the best approximation for sambor ea s control policy tradeoffs accumulated across 25 trials of moea based search for visual clarity fig 9 only displays a representative subset of 100 policies from the approximately 500 in the original set pysedsim processing reference set module optionally automates this thinning using the concept of ϵ dominance laumanns et al 2002 in fig 9 each of three axes corresponds to a different objective while color represents a fourth objective to maximize dry season flow rate spilled into the bypass channel to attract migrating fish the direction of better performance in fig 9 is toward the upper right of the figure as marked by black arrows the theoretical ideal policy in fig 9 is represented by a blue star at the upper right of the plot the screening formulation policies are included among the reference set of the tradeoffs formulation policies in fig 9 to facilitate comparison each of the three pre specified rule curves was dominated i e outperformed in all four objectives by at least one member of the tradeoffs formulation reference set of control policies identified through optimization when re evaluated with random sequences of inflow hydrology and sediment loads via the processing reference set module while the screening formulation policies were outperformed they were still close to optimality however the screening formulation policies all reside in one extreme region of the broader tradeoff frontier discovered in the tradeoffs formulation thus while pre specified rule curves may perform reasonably well without any optimization it is nevertheless very difficult to capture the complex nonlinear nature of the tradeoff frontier by designing a small set of pre specified policies this result clearly demonstrates the value of identifying rather than specifying operating policies in a river basin infrastructure planning context the tradeoffs formulation results show that reducing the magnitude of sediment load released during flushing requires a tradeoff with energy production importantly the tradeoffs formulation was designed with no long term sediment passage objective because the screening formulation results fig 9 showed that the combination of sluicing and flushing and small storage capacity relative to annual inflow would likely enable highly effective sediment passage at sambor ea however the quantity of sediment load released during flushing events is of ecological importance fig 9 reveals that some policies produced an average sediment load release during flushing events of up to 18 mt d in contrast the natural daily sediment load during the monsoon season is 1 mt d koehnken 2014 policies with ecologically problematic sediment releases toward the front and bottom of fig 9a also produced the most hydropower and vice versa the presence of this important tradeoff underscores the value of pysedim s flexibility to include flushing related parameters in the optimal search process this tradeoff occurs because emptying a reservoir to conduct flushing reduces energy production so policies prioritizing energy production flushed as infrequently as possible thus releasing much larger sediment loads during flushing events finally the presence of blue and green colored policies i e with the highest bypass spillage rates throughout much of the tradeoff space in fig 9 demonstrates that this objective is not in strong conflict with other objectives as anticipated the lower limit of the color bar 5200 m3 s shows that even the poorest performing policies with respect to fish bypass flow were still on average spilling in excess of 50 of the main stem s 13 200 m3 s mean annual flow rate into the bypass channels given that all policies in the tradeoffs formulation performed well with respect to mean annual bypass flow rate the alternatives formulation was designed to include a dry season bypass flow objective to evaluate fish passage potential in both seasons a dry season energy production metric was also created in the alternatives formulation to enable better understanding of the energy sacrifice required to pass dry season larvae and adult fish while fig 9 is a crude representation of tradeoffs across complex ecological objectives it nevertheless facilitates a detailed discussion among decision makers and technical experts regarding how to define acceptable ecological performance targets in order to navigate tradeoffs in search of a subset of candidate alternatives literature regarding ecological performance metrics and thresholds is sparse in the mekong in large part due to the paucity of data describing the life cycle processes of over 1200 species of fish the mekong river commission mrc defines effective fish passage as providing safe passage for 95 of the target species under all flow conditions mekong river commission 2009 while it is not straightforward to directly apply this criterion to fish pass flow rates it can readily be applied to larvae passage flow rates referring to fig 9 policies that only meet or exceed this 95 criterion would require substantial and likely economically nonviable energy production losses this result initiated some key questions and extensive debate regarding the temporal and statistical definition of the 95 criterion for example given fish life cycle processes in the wet season contribute relatively more to the fishery s productivity could sustainable fishery outcomes still result from a compromise in which the criterion is met more frequently in the wet season as opposed to the dry season also is the criterion defined only for average conditions or does it need to be met even in worst case conditions given the potential impact of sambor ea on the appreciable socioeconomic value of the mekong fishery we pursued the alternatives formulation in which ecological objectives are optimized with respect to an approximation of worst case conditions i e 1st percentile of performance metric cdfs quinn et al 2017 maximizing performance in worst case conditions is likely to produce policies robust to future hydrologic uncertainty that perform well even in the worst e g drought years recent geopolitical tension resulting from drought conditions stone 2010 underscores the value of such policies 3 5 formulation iii refining alternatives 3 5 1 formulation iii overview the screening formulation sought to identify a subset of decision relevant metrics from among a large set while the tradeoffs formulation took that subset of metrics and sought to identify a wide array of alternative operating policies that perform well across that subset of measures however the presence of sharp tradeoffs among energy and ecological objectives in a critical and sensitive ecosystem such as the mekong naturally raises questions about how best to carefully define ecological performance metrics and thresholds in response the refining alternatives formulation alternatives reflects a shift in focus to more carefully defining ecological performance metrics and navigating the resulting refined tradeoffs in search of candidate alternatives specifically fig 6 shows that larvae passage is converted into a seasonal variable to discover strategies more capable of facilitating ecologically critical wet season larvae passage dry season larvae passage is also evaluated which is why two larvae metrics appear under formulation iii in fig 6 additionally the sediment flushing metric is converted into a daily metric to reflect the ecological impacts of large sediment releases over very short periods of time given the potential for problematic ecological performance in this critical ecosystem the alternatives formulation also shifts all performance metrics to definition in the worst first percentile rather than the mean this ensures that policies will be robust in that they will be designed to perform well in an approximation of worst case conditions quinn et al 2017 a worst first percentile i e the 1st or 99th was used as an estimator to approximate worst case behavior because quantiles are more stable and convergent than the maximum or minimum values resulting from a given stochastic simulation as is commonly done in robust optimization taguchi 1986 quinn et al 2017 stedinger et al 1993 castelletti et al 2012 beyer and sendhoff 2007 3 5 2 formulation iii results the alternatives formulation differs from previous formulations primarily in its conservative approach to defining worst case i e 1st percentile metrics the parallel axis plot in fig 10 which is reproduced from wild et al 2019a for purposes of comparing formulations summarizes the tradeoffs across the six objectives that define the alternatives formulation each vertical axis represents performance for one of the six objectives the axes are oriented such that performance improves moving vertically upward on each axis each line represents a different operating policy each policy s performance is designated by where it intersects each vertical axis the steepness of the diagonal lines between two adjacent axes displays the degree of tradeoff for solutions between the two objectives the theoretical ideal policy would be a single blue horizontal line crossing at the top of all the axes rather than representing objectives defined in the mean the performance of policies in fig 10 represents an approximation of worst case conditions by evaluating performance in the 1st percentile of the cdf of corresponding performance metrics fig 10 reveals the potential for 1st percentile performance to be significantly worse than mean performance for example dry and wet season larvae passage performance can be as poor as 18 and 40 respectively compared to 56 in mean annual conditions also sediment loads can be over twice as large in worst case conditions additionally the tradeoffs formulation fig 9 did not reveal a particularly strong tradeoff between mean annual fish bypass attraction flows and other objectives conversely fig 10 shows worst case dry season flows can be below 500 m3 s depending on the timing of these discharge values this could potentially represent less than 10 of dry season main stem discharge which would supply less than the generic 10 fish pass criterion employed in many studies thorncraft and harris 2000 numerous policies in fig 10 reflect this problematic dry season flow condition referring to fig 10 third axis a cluster of red colored policies creates very low worst case bypass attraction flows for fish migration during the dry season however many of these same policies create hydraulic conditions in the reservoir capable of achieving high levels of dry season larvae passage fourth axis these policies also significantly reduce high value dry season energy fifth axis because the site s hydraulics fig s1 in the supplement require extensive drawdown to increase inflow and thus velocities this requires directing more water down the main stem instead of spilling it into the bypass this existence of a potential tradeoff among ecological objectives themselves i e larvae and adult fish passage as opposed to between energy and ecological objectives was entirely unforeseen and was not clearly identified in formulations i and ii the appearance of problematic performance and unforeseen tradeoffs underscores the benefit of an iterative formulation approach fig 1 in a complex multi stakeholder river basin decision context having identified rich tradeoffs across multiple probabilistic seasonal fish life cycle and energy production metrics it is next possible to navigate fig 10 in search of potential solutions worth exploring in more detail three policies highlighted in fig 10 energy compromise and larvae illustrate examples of different candidate decision preferences the larvae policy achieves acceptable fish related performance in 95 of days in both seasons with hydraulic conditions conducive to larvae passage the larvae policy performs poorly in the dry season larvae passage objective making this policy less attractive across stakeholder interests just as with the larvae policy the energy policy in fig 10 performs poorly with respect to the larvae flow fraction objective in response to the potentially problematic multi objective performance of the larvae and energy policies we highlight a potential compromise policy the compromise policy shows that compromising on larvae passage in both seasons could significantly improve energy production compared to the larvae policy while also significantly improving rates of dry season bypass spillage for fish migration and reducing the magnitude of flushed sediment loads this policy prioritizes wet season larvae passage because of its relative importance to the fishery achieving 90 larvae performance in the wet season but only 60 in the dry season rarely will a single formulation of a particular problem result in the refined insight and compromise solutions that result from fig 10 the iterative approach to problem formulation and refinement of complexity in representing uncertainties objectives and reservoir operations described in fig 1 ultimately enabled more distinct tradeoffs to take shape and potential compromises to be identified 3 6 reservoir operations to better understand the new knowledge that is gained in each successive problem formulation it is helpful to view the operating policies of which the tradeoffs are comprised fig 11 plots a representative subset of reservoir operating policies from each formulation each column of figures represents a different formulation the top figure in each column represents simulated mean monthly sambor ea water surface elevation while the lower figure represents the reservoir release rate resulting from the operating policy each colored line represents a different operating policy the dashed gray line in the lower row of figures represents the mean monthly main stem flow rate at the reservoir site main stem flow rate is included as opposed to reservoir inflow because it remains the same across the formulations and policies reservoir inflows differ across policies as a result of the site s hydraulic configuration which induces different inflow rates depending on the reservoir s water levels as shown in fig s1 the screening formulation policies represent the three expert specified rule curves introduced in fig 7 the tradeoffs formulation and alternatives formulation policies selected from the reference sets of their respective formulations represent the very best performing policies for each objective hence the number of policies grows as the formulations evolve to reflect the increasing number of objectives in those formulations colors are used to reflect four objective themes energy larvae adult fish and sediment solid lines are used to distinguish policies corresponding to objectives defined in the mean whereas dotted lines correspond to objectives defined in the 1st percentile each policy was reevaluated using randomly generated sequences of inflow hydrology and sediment loads that were not used during the identification i e pre specification or optimization of the policies beginning with the screening formulation fig 11a and b show that the energy policy and fish policy maintain similar water levels and similar reservoir releases this important finding which suggests at this dam site that energy focused operations naturally produce conditions favorable for adult fish passage is a direct result of the reservoir s unique ecologically oriented hydraulic design which naturally induces significant spillage into the reservoir s anabranch channel at the reservoir water levels required for significant energy production second the operational strategy required for managing larvae i e larvae rule curve requires maintaining low reservoir water levels fig 11a while main stem flow rates fig 11b are low water levels are increased only when flow rate and corresponding velocity increases to create conditions with sufficient sustained velocity to pass larvae through the reservoir these strong seasonal differences in policies underscore the importance of pysedsim s flexibility to define objectives seasonally in comparison to the screening formulation the tradeoffs formulation policies fig 11c and d reflect the methodological differences in the approaches used to define the policies i e optimization versus pre specification for example the optimization based tradeoffs formulation produces a more refined larvae focused policy that maintains lower water levels for longer into the dry season than the corresponding policy from the screening formulation key differences in policies from the alternatives formulation in comparison to policies from the tradeoffs formulation are a direct result of the use of objectives defined 1 seasonally rather than only annually and 2 in the 1st percentile versus the mean for example the policies performing the best with respect to wet and dry season larvae passage carefully time their reservoir emptying and refill processes very differently keeping water levels lower during their respective seasons of focus these policies are especially conservative seeking to avoid poor performance even in the worst years for this reason water levels are kept lower and for longer durations than would otherwise be necessary the most important general result from fig 11 which is most evident in fig 11e and f is the vast space of reservoir operation possibilities and resulting differing multi objective performance that exist at such a hydrologically small reservoir hydrologically small reservoirs are widely regarded as relatively benign alternatives not requiring careful intra annual operation fig 7 demonstrates that this generalization is unlikely to apply to dams such as sambor ea that have a diverse array of design features oriented toward improving sediment and fish passage this demonstrates the importance of tools with pysedsim s flexibility in river basin infrastructure planning applications wherein ecologically focused changes to the sdo features of planned dams are of interest the importance of reservoir operations in this case study highlights the potential drawbacks of focusing solely on spatial optimization of dam locations in identifying alternative hydropower portfolios ziv et al 2012 schmitt et al 2018 opperman et al 2015 jager et al 2015 failing to search for reservoir operation options could constrain the potential to identify more balanced alternatives to proposed dams 4 conclusions intensive and pervasive hydropower dam development is expected over the next several decades including in some of the world s most ecologically diverse river basins e g the mekong congo and amazon winemiller et al 2016 vörösmarty et al 2010 zarfl et al 2015 moran et al 2018 this infrastructure development as planned is expected to result in severe consequences for ecosystems as well as for the hundreds of millions of impoverished people who depend on riverine ecosystems to support their food security and economic welfare mcintyre et al 2016 these ecological impacts are anticipated because hydropower dams are typically sited designed and operated to maximize power production rather than to preserve ecosystem health and productivity ifc 2015 to strike more balanced performance across ecological energy food and other potential objectives in these contexts will require re thinking the traditional approach to hydropower planning in at least two respects first rather than focusing on planning one dam at a time long term hydropower planning should more strategically consider the cumulative interactions and impacts of all existing and planned dams sabo et al 2017 tnc 2016 ziv et al 2012 opperman et al 2015 grill et al 2014 cronin et al 2016 kondolf et al 2018 schmitt et al 2018 wild et al 2019a schmitt et al 2019 intralawan et al 2018 song et al 2020 grill et al 2015 roy et al 2020 this could produce positive outcomes such as building first those dams that marginally produce the most power relative to their negative e g ecological impacts second significant modifications will be required to the siting design and operation sdo features of planned dams wild et al 2019a particularly those expected to be most impactful in the context of sensitive ecosystems to facilitate this transition toward identifying hydropower alternatives with more balanced performance this paper and its supplement introduce and describe the features of the pysedsim modeling framework and its successful application in a real hydropower planning context pysedsim is an open source object oriented python based daily time step river basin simulation model for flow sediment and hydropower in networks of reservoirs and river channels capable of exploring ecologically oriented sdo alternatives pysedsim is designed for use in feasibility and pre feasibility ifc 2015 screening assessments of alternative river basin infrastructure plans involving reservoirs the model is flexible both in its software design and its core functionality and features pysedsim users can explore representations of four key concerns relevant to the selection and evaluation of alternative reservoir configurations particularly in the ecologically sensitive contexts described earlier 1 management approaches to improve the passage of sediment through and around reservoirs to avoid storage capacity loss and downstream ecological impacts 2 search for flexible and adaptive alternative reservoir operating policies designed to achieve multiple objectives 3 alternative design features such as dam gates reservoir bypasses and other hydraulic infrastructure which are necessary to enable ecologically focused reservoir operational practices e g fish and sediment passage and 4 uncertainties in hydroclimatic drivers and in the physical processes of sediment production transport reservoir trapping and reservoir management while some existing river basin modeling tools can address one or several of these concerns we know of none that address them all in a single tool pysedsim has a software architecture that allows users to exploit these four core features in a manner that facilitates rapid testing of alternative sdo problem formulation hypotheses this is integral to facilitating exploration and evaluation of candidate hydropower sdo modifications that may be necessary to reduce reservoirs impacts on the ecological integrity of river basins indeed the most effective modeling tools and scientific studies in influencing policy agendas have often been those that change the way key issues are defined and framed and on the array of options for dealing with issues that are considered rather than only the actions that are ultimately taken cash et al 2003 pysedsim was used in a multi year multidisciplinary study conducted in partnership with the government of cambodia goc seeking to identify and evaluate alternative dam sites designs and operation sdo options as candidates to replace the proposed sambor mega dam on the mekong river wild et al 2019a nhi 2017 as proposed sambor dam would be one of the world s longest and most environmentally impactful hydropower dams spanning 18 km across the lower mekong river s floodplains with the potential to trap significant quantities of sediment critical for downstream ecosystems e g the vietnam delta and block the migration routes for over 50 species of fish using pysedsim we focused on one particular alternative dam location and design sambor ecological alternative or sambor ea and iteratively explored tradeoffs across multiple conflicting ecological and hydropower objectives of decision relevance seeking to produce the information needed to allow the goc to identify what they considered the most balanced plan this iterative problem formulation process exposed us to the complexity of this system we were analyzing and the need to address a succession of new questions and issues as we proceeded in this paper we describe three alternative problem formulations that capture the evolution of this iterative decision support process each formulation builds upon prior formulations to arrive at the final recommendations to decision makers nhi 2017 through these system representations which naturally grow in complexity we show that as operating policies were searched for rather than pre specified as more conflicting objectives were identified and included and as more uncertainty was acknowledged new objectives of interest and tradeoffs among them emerged this increasing insight changed the way the problem was framed and also revealed new options for satisfying multiple objectives that were not previously considered the flexibility of the modeling tools both in software design and functionality to iteratively explore and discover increasingly realistic formulations that reflect diverse stakeholder preferences greatly enhanced the discussions with the goc surrounding river basin development that have been taking place pysedsim could similarly be used to enhance the discussion surrounding river basin development that is currently taking place in other river basins globally pysedsim s capacity to contribute solutions to challenging problems in these contexts can be enhanced by exploring new linkages with frameworks in the following areas many objective robust decision making hadjimichael et al 2020 hadka et al 2015 kasprzyk et al 2013 power systems chowdhury et al 2020a b energy water land nexus planning and management khan et al 2020 and sensitivity analysis herman and usher 2017 declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was supported by cornell university s david r atkinson center for a sustainable future postdoctoral fellowship in sustainability grant no 2015 additionally this material is based upon work supported by the u s national science foundation under grant no 1855982 appendix a supplementary data the following are the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104947 
25889,this paper introduces pysedsim an open source object oriented python based daily time step river basin simulation screening model for flow sediment and hydropower in networks of reservoirs and river channels the model enables users to explore representations of four key concerns relevant to the selection and evaluation of alternative reservoir configurations 1 management approaches to improve the passage of sediment through and around reservoirs to avoid storage capacity loss and downstream ecological impacts 2 search for flexible and adaptive reservoir operating policies designed to achieve multiple objectives 3 alternative design features such as dam gates which are necessary to enable ecologically focused reservoir features and 4 uncertainties associated with hydroclimatic drivers and sediment processes pysedsim is intended to support deliberative decision making and design processes we highlight pysedsim s functionality by demonstrating its use in a real decision context focused on identifying siting design and operation alternatives for the proposed sambor mega dam in cambodia graphical abstract image 1 keywords dams hydropower ecology mekong sediment management reservoir operation software availability name of software pysedsim description pysedsim is an open source object oriented python based daily time step river basin simulation model for flow sediment and hydropower production in networks of reservoirs and river channels it is intended to predict in relative terms the spatial and temporal accumulation and depletion of sediment in river reaches and in reservoirs under different reservoir operating and sediment management policies the model can be run in both stochastic monte carlo and deterministic modes it also offers integrated support for coupling with an external evolutionary optimization algorithm to identify tradeoffs among operating policies designed to perform well across a suite of user defined objectives developer t b wild twild umd edu a birnbaum p reed d p loucks funding sources cornell university s david r atkinson center for a sustainable future acsf national science foundation grant no 1855982 source language python dependencies pandas openpyxl numpy matplotlib mpi4py borg supported systems linux windows license bsd 2 clause availability https github com feralflows pysedsim 1 introduction plans exist for building over 3700 hydropower dams globally in the next 20 years zarfl et al 2015 intensive hydropower development is currently being planned in river basins that host over one third of the world s riverine biodiversity including the mekong amazon and congo among others winemiller et al 2016 vörösmarty et al 2010 zarfl et al 2019 most of these rivers flowed freely several decades ago but have recently experienced increased pressure from hydropower development currently less than 25 of large rivers flow uninterrupted for their entire length grill et al 2019 given that hydropower dams are typically sited designed and operated to maximize power production rather than to preserve ecosystem health and productivity ifc 2015 they pose a direct and significant risk to several hundred million impoverished people who depend upon riverine ecosystem services to support their food security and economic welfare mcintyre et al 2016 the world s most productive riverine ecosystems typically rely on highly dynamic and complex biophysical processes to drive productivity for example in the mekong and amazon river basins a dynamic annual flood pulse drives productivity by annually transporting sediment nutrients and many fish species into floodplains the floodplains then rapidly expand in areal extent encouraging the exchange of energy between terrestrial and aquatic environments junk et al 1989 dams in such river basins and elsewhere have historically disrupted these natural processes including altering natural flow regimes poff et al 1997 trapping sediment vörösmarty et al 2003 and nutrients maavara et al 2015 preventing fish migration noonan et al 2012 bunt et al 2012 and reducing ecosystem connectivity by fragmenting habitats especially for migratory fish species andrén 1994 larinier 2001 fahrig 2003 noonan et al 2012 bunt et al 2012 the externalities associated with dams have led some to argue that healthy freshwater fisheries and dams cannot coexist especially in tropical river basins winemiller et al 2016 fearnside 2016 regardless of these potential negative consequences hydropower development is likely to proceed in many river basins globally moran et al 2018 given this reality society could benefit from planning approaches that seek to support the discovery of more balanced outcomes with respect to ecological energy food and other potential demands to achieve this balance may require significant integrated and ecologically focused modifications to the siting design and operation sdo features of planned dams wild et al 2019a even in river basins where dams are no longer being planned but are instead being removed e g in the united states or retrofitted with ecologically focused design features it seems reasonable to explore significant reoperation of the modified network of dams to restore ecological integrity opperman et al 2011 this will require a departure from the traditional hydropower development paradigm which considers ecological concerns only after hydropower potential is optimized this study contributes pysedsim an open source object oriented python based daily time step river basin simulation model for flow sediment and hydropower in networks of reservoirs and river channels to facilitate exploring ecologically oriented sdo alternatives the model is designed for use in feasibility and pre feasibility ifc 2015 screening assessments of alternative river basin infrastructure plans involving reservoirs the model is flexible both in its software design e g object oriented structure and its core functionality and features e g exploring tradeoffs across multiple conflicting objectives pysedsim users can explore representations of four key concerns relevant to the selection and evaluation of alternative reservoir configurations 1 management approaches to improve the passage of sediment through and around reservoirs to avoid storage capacity loss and downstream ecological impacts 2 search for flexible and adaptive alternative reservoir operating policies designed to achieve multiple objectives 3 alternative design features such as dam gates reservoir bypasses and other hydraulic infrastructure which are necessary to enable ecologically focused reservoir operational practices e g fish and sediment passage and 4 uncertainties in hydroclimatic drivers and in the physical processes of sediment production transport reservoir trapping and reservoir management while some existing river basin modeling tools can address one or several of these concerns we know of none that address them all in a single tool modeling tools designed to support river basin infrastructure planning and management have tended to focus on water examples include iras matrosov et al 2011 loucks et al 1995 weap yates 2005 oasis sheer 2000 riverware zagona et al 2001 and modsim labadie et al 2000 such water management oriented models have not typically accounted for natural and managed sediment processes such as alternative strategies for better managing sediment flows through and around reservoirs thus they have not been effective for exploring options for managing basin scale sediment balances via alternative dam network configurations and reservoir operation strategies this lack of focus on sediment related functionality in river basin planning models historically has occurred for at least two reasons first sediment transport and accumulation in reservoirs has not traditionally been viewed as a major objective of concern in river basin planning efforts annandale 2013 despite the threat that reservoir sedimentation poses to water management and ecosystem health grant et al 2003 petts and gurnell 2005 second sediment production transport trapping and management are complex to represent particularly when it comes to the distribution and management of sediment within large networks of complex reservoir bodies the complexity posed by the movement of sediment through natural and man made water bodies has led to the development of several models that consider sediment management at very fine spatiotemporal process resolution and often for a small number of sediment management approaches such as reservoir flushing chang et al 2003 gallerano and cannata 2011 khan and tingsanchali 2009 shokri et al 2013 u s army corps of engineers 2016 danish hydraulic institute 2017 shin et al 2019 increased process resolution creates extra computational burden and carries additional data collection requirements such as river and reservoir bathymetry and sediment grain size distribution this computational and data collection burden can make these higher resolution tools difficult to deploy in the multi objective multi reservoir stochastic river basin planning contexts for which pysedsim was designed there are some tools that take a coarser resolution approach to sediment simulation to enable basin scale analyses for example pal and galelli 2019 and tangi et al 2019 have developed models capable of exploring options for controlling sediment flows and managing basin scale sediment balances via alternative configurations of dam networks these tools are very effective in basin scale sediment focused infrastructure planning contexts but they lack the detailed representations of reservoir and dam infrastructure required to explore the implications of alternative multi objective reservoir operation strategies including those seeking to improve water management or increase the passage of sediment through or around reservoirs conversely pysedsim simulates alternative reservoir sediment management strategies in reservoir networks with enough detail to capture the implications for sediment balances hydropower hydrology ecology and other considerations but without so much detail that basin scale monte carlo analyses are not possible in particular its representation of dam features e g gates and reservoir operations and the ability to search for alternative operating policies designed to achieve multiple objectives also make pysedsim suitable for use in a traditional stakeholder driven river basin planning context even when sediment is not a focus pysedsim has a software architecture that allows users to rapidly explore alternative sdo problem formulation hypotheses this is integral to facilitating exploration and evaluation of candidate hydropower sdo modifications that may be necessary to reduce reservoirs impacts on the ecological integrity of river basins indeed the most effective modeling tools and scientific studies in influencing policy agendas have often been those that change the way key issues are defined and framed and on the array of options for dealing with issues that are considered rather than only the actions that are ultimately taken cash et al 2003 pysedsim is intended to serve as a flexible iterative problem exploration framework fig 1 that can be deployed to support deliberative decision making processes fig 1 illustrates the deliberative decision support framework that pysedsim has been designed to support it begins with initial problem formulation step 1 which includes defining objectives deterministic or probabilistic constraints and uncertainties the extent to which reservoir operating policies will be pre specified or searched for the network of reservoirs and river channel locations to be considered reservoir design features such as dam gates and reservoir sediment management strategies to be applied in step 2 pysedsim leverages advances in multi objective evolutionary optimization coello et al 2007 reed et al 2013 maier et al 2014 to identify tradeoffs among objectives comprised of a suite of alternative reservoir sdo options some users may wish to initially skip this step beginning instead with simulating pre specified sdo options e g reservoir rule curves in an existing reservoir design returning later to optimization if warranted in step 3 the performance of all or a subset of the identified or pre specified alternatives can be simulated under a range of uncertainties in hydrologic and sediment processes defined in step 1 in step 4 users can connect to external visual analytic tools to navigate alternative solutions this includes visually searching for policies that balance concerns across conflicting objectives and comparing the results across alternative formulations any given problem formulation may only involve a subset of these steps and indeed any step along the way may offer some insight e g into new objectives that warrants returning to the problem formulation step to reframe the problem the remainder of this paper is organized as follows the methodology section describes key pysedsim model features functionality and software design principles and compares pysedsim to existing river basin models the case study section introduces the design and operational context for the proposed sambor dam in cambodia for which we will demonstrate pysedsim s capabilities to analyze hydropower production sediment management and fish passage concerns this section also introduces three alternative problem framings that are representative of the real decision context where pysedsim was used to iteratively fig 1 identify and evaluate alternative sdo options for the sambor dam our results compare the insights gained from these alternative formulations demonstrating how pysedsim facilitates iterative problem formulation and refinement to aid the discovery of decision relevant insights in complex sdo contexts readers interested in detailed guidance on pysedsim features and use should also reference the model s user manual which is available at the model s github repository 2 methods 2 1 classification of modeling functionality fig 2 provides a graphical taxonomy for classifying pysedsim s functionality relative to existing tools that might be considered for use in a river basin reservoir planning context the figure highlights common differences among existing models with respect to three categories each shown in a different colored box the processes they include both physical processes and management processes the mathematical representations of those processes and the nature of the questions the model is designed to explore e g simulation versus optimization within each of the three colored boxes there exist categories of choices each of which is represented by a tree in general these trees are intended to describe some of the key features that models used in a river basin planning context may have options within a given tree are not necessarily mutually exclusive modeling choices for example models such as pysedsim can have both deterministic and stochastic simulation options and may even represent different processes with different levels of detail boxes outlined in red are used to highlight where pysedsim s features reside within this hierarchy of potential modeling choices beginning with box i processes included river basin models often include representations of natural physical processes which describe how water and sediment move through the natural landscape e g rainfall and runoff as well as management processes which describe the various ways in which these natural processes may be modified by infrastructure e g management of water and trapping of sediment in reservoirs striking a balance between computational demands and end use purpose pysedsim is limited in its abstraction of detailed natural physical processes in the water resources domain natural physical processes frequently accounted for in models include rainfall runoff groundwater infiltration and channel flow among these processes pysedsim accounts only for routing of flows through networks of river channels relying on user selected external models e g swat for the other processes with respect to sediment models are often classified as either loading models which account for production of sediment suspended in watershed runoff or as receiving models which route sediment through channels and reservoirs kalin and hantush 2003 pysedsim is a receiving model designed to receive input from a loading model e g swat an important difference among receiving models is with respect to the degree to which sediment management processes are included pysedsim includes numerous sediment management processes such as the trapping of sediment in reservoirs the distribution of that sediment within reservoirs storage geometry and the various ways in which sediment can be removed or passed through or around reservoirs in reviewing existing river basin simulation models e g matrosov et al 2011 loucks et al 1995 yates 2005 sheer 2000 zagona et al 2001 labadie et al 2000 we found a dearth of models that include treatment of both sediment and water processes especially reservoir sediment management sediment management focused models typically do not include detailed representations of water management issues likewise water management focused models typically do not explicitly account for any of the natural or managed sediment processes from box i pysedsim includes water management features such as reservoir operations and river routing capabilities though it does not include water demand and supply modeling or groundwater which water management focused models typically do box ii process representations in fig 2 shows that all of the natural and managed water and sediment processes from box i can be represented with varying degrees of complexity including the mathematical representations of relationships the extent to which uncertainty is represented and the resolution of the model in both space and time pysedsim employs empirical process relationships with a specific intent to enable sdo analyses given the data limited nature of most problem settings it also offers the flexibility to explore through monte carlo simulation the uncertainty in the numerous parameters that define these empirical relationships including parameters for sediment production sediment transport reservoir sediment trapping and reservoir sediment management with respect to spatiotemporal resolution pysedsim is a lumped model in that users are permitted to define parameters for discrete model elements e g river channel segments the model is a one dimensional fixed bed model in that it does not explicitly represent channel or reservoir cross sections and their feedbacks with flow processes as can be accounted for in more detailed models such as hec ras u s army corps of engineers 2016 a daily time step was selected to facilitate coupling with existing daily time step loading models such as swat with respect to process representation in reservoir sediment management models focused on sediment management often represent only a limited number of alternative sediment management strategies such as flushing e g chang et al 2003 gallerano and cannata 2011 khan and tingsanchali 2009 shokri et al 2013 and do so at fine resolution such detailed process representations require more data such as sediment grain size distribution and reservoir bathymetry detailed simulations also tend to be more computationally intensive and are difficult to embed within a broader multi reservoir network simulation for example hec ras u s army corps of engineers and mike21c danish hydraulic institute 2017 offer physically based simulations of management processes such as sluicing and flushing conversely pysedsim enables less detailed assessments of multiple alternative sediment management strategies for large scale multi reservoir systems box iii identification and evaluation of management actions within fig 2 highlights how existing models differ in the questions they are designed to answer pysedsim is a simulation model in that it addresses what if scenarios what may happen if a particular scenario e g hydroclimatic inputs or reservoir network configuration is assumed or if a particular decision e g reservoir operating policy is made conversely optimization models seek to identify the best decision or tradeoffs among alternative equally optimal decisions while pysedsim is a simulation model at its core it facilitates direct coupling with external optimization models finally as with process representations management actions can be identified and evaluated in both deterministic and stochastic monte carlo contexts in pysedsim for example the model s stochastic simulation optimization functionality will search for robust operating policies that perform well under a range of future uncertainties pysedsim is a preliminary screening model loucks and van beek 2017 loucks 2020 in that its best use is to explore a wide range of alternatives and the tradeoffs in performance across them the coupled simulation optimization functionality enables users to screen out a large number of less desirable alternatives leaving a relatively smaller number of potentially desirable alternatives to be evaluated later with other more detailed e g finer spatiotemporal resolution simulation models for example during the hydropower project development process ifc 2015 this more detailed modeling is typically done during the detailed design phase rather than during preliminary screening of alternatives this detailed phase of analysis could also include higher resolution assessment of specific sediment management alternatives e g sluicing flushing dredging etc at specific reservoir sites e g using process based models like hec ras 2 2 detailed model functionality and assumptions 2 2 1 overview pysedsim includes a unique combination of four core model features 1 representing alternative reservoir sediment management approaches 2 representing detailed dam design features e g gates 3 supporting multi objective optimization frameworks for discovering reservoir operating policies and their resulting tradeoffs and 4 facilitating stochastic monte carlo simulation for characterizing uncertainty in hydrologic and sediment processes fig 3 illustrates some of these model features in the context of an example pysedsim simulation network of river channel segments reservoirs and connecting junctions through which water and sediment are routed and stored on a daily basis in a simulation any pysedsim simulation network is comprised of some combination of these three building blocks the features illustrated in fig 3a are organized into two categories sediment left and water right 2 2 2 natural water and sediment processes in keeping with its intended use as a screening model pysedsim employs relatively simplistic i e empirical approaches to representing complex sediment processes including sediment production transport reservoir trapping and distribution and reservoir management left hand side of fig 2 at its core pysedsim includes most of the sediment simulation functionality present in the sedsim simulation model wild et al 2019b wild and loucks 2015a https github com feralflows sedsim but with new features that support stochastic simulation and multi objective optimization sedsim has been applied in other studies to evaluate the hydrologic sediment and hydropower implications of reservoirs wild and loucks 2014 2015b 2016 souter et al 2020 while pysedsim s python based object oriented software design section 2 4 is much different from sedsim s visual basic for applications vba based software design both models allow users to exploit the same excel based interface if desired this simple interface ensures backward compatibility with previous sedsim applications and facilitates training of less advanced users e g river basin stakeholders as shown in fig 3b water and sediment can only enter the modeled system at junctions flows specified at junctions represent incremental daily water and sediment runoff from the local watershed i e between successive incremental flow junctions the model simulates a single median sediment grain size rather than a grain size distribution junction inputs must be externally gathered e g from gage station data or generated e g simulated with a separate model such as swat neitsch et al 2009 users can also specify parameters for a rating curve function that describe daily sediment load production as a function of daily hydrologic flow water and sediment entering a junction in a given day immediately enter the next downstream channel segment or reservoir and are thereafter routed through that downstream element along with any sediment and water entering from upstream fig 3c depicts this routing process for an example river channel segment i the model maintains flow routing options consistent with some of those available in the swat model neitsch et al 2009 including manning s equation routing as shown in fig 3c each channel segment is assumed to have a carrying capacity bagnold 1977 to produce suspended sediment in its outflow as a power function of water outflow rate if the concentration of sediment suspended in the water column exceeds the channel s carrying capacity some sediment settles to the channel bed i e deposition dominates otherwise sediment is scoured from the channel bed i e resuspension dominates 2 2 3 managed water and sediment processes 2 2 3 1 reservoir sediment trapping distribution and management the model includes representations of reservoir sediment trapping distribution and management processes as shown in fig 3d the fraction of inflowing sediment mass trapped in a reservoir during each time period or trapping efficiency is determined as a function of sediment particle size and residence time of water in the reservoir brune 1953 this results in declining trapping efficiency with declining storage capacity minear and kondolf 2009 morris and fan 1998 within the reservoir s storage capacity the volume occupied by settled sediment mass depends on its user specified bulk density fig 3d shows that the model differentially distributes deposited sediment within the reservoir s active and dead storage zones lara and pemberton 1963 which captures the impact of sedimentation on reservoir operations despite the availability of techniques to improve sediment passage through and around reservoirs kondolf et al 2014b annandale 2013 planning studies of large reservoir networks typically focus on predicting sediment trapping e g kummu et al 2014 kondolf et al 2014 rather than on assessing the potential to reduce it wild et al 2016 2019a wild and loucks 2014 schmitt et al 2018 this capability is needed when simulating alternative dam development configurations in basins such as the amazon congo and mekong as these river basins transport among the world s highest annual sediment loads milliman and meade 1983 fig 3 does not depict pysedsim s representations of sediment management processes which are relatively more complex and therefore appear in the model s user manual in general pysedsim employs empirical approaches to simulating the effectiveness of flushing atkinson 1996 sluicing churchill 1948 and density current venting morris and fan 1998 at removing or passing sediment through a reservoir before considering simulating particular reservoir sediment management techniques with pysedsim an external model such as rescon should first be used to assess the economic and technical feasibility of those techniques given the reservoir s site specific characteristics palmieri et al 2003 efthymiou et al 2017 2 2 3 2 reservoir operations and dam design features reservoirs are assumed to be regulated by a dam the daily outflows from which are determined by an operating policy subject to constraints related to the dam s outlet works and primary operational objectives as listed on the right hand side of fig 3 pysedsim offers flexibility in exploring reservoir operations numerous studies have noted the potential value of optimization in contributing to the ongoing multi objective river basin development dialogue globally sabo et al 2017 tnc 2016 ziv et al 2012 opperman et al 2015 grill et al 2014 2015 roy et al 2020 cronin et al 2016 kondolf et al 2018 schmitt et al 2018 wild et al 2019a schmitt et al 2019 intralawan et al 2018 song et al 2020 pysedsim has been developed to support the flexible representation of candidate reservoir operations and simulation of their performance the software offers specific support for the evolutionary multi objective direct policy search emodps analytic framework giuliani et al 2016 guariso et al 1986 oliveira and loucks 1997 koutsoyiannis and economou 2003 for quantifying operational tradeoffs the emodps simulation optimization framework is implemented by facilitating a full coupling of pysedsim with external multi objective evolutionary optimization algorithm moea solvers coello et al 2007 reed et al 2013 zatarain salazar et al 2016 the closed loop feedback structure of the identified operating policies can flexibly adapt to changing site conditions where site conditions can be abstracted using any relevant reservoir state variables as inputs e g water surface elevation inflow and time of year objectives are defined by the user as a function of any pysedsim model state variables e g daily suspended sediment passage flow rates etc for any system element i e junction reservoir or channel the ability to identify adaptive operating policies is a distinct advantage in assessing the potential for sdo alternatives to mitigate ecological impacts wild et al 2019a the theoretical details of pysedsim s emodps approach to identifying tradeoffs composed of alternative reservoir operating policies appears in wild et al 2019a as well as in the model s user manual while pysedsim directly supports a search for alternative reservoir operating policies the software s architecture also theoretically enables searching alternative relevant decision spaces such as the locations of reservoirs in networks by including these decision variables among those that define reservoir operating policies the code modifications required to do this are discussed in the user manual at the paper s online repository conducting such joint planning management simulation optimization particularly for large scale systems e g with numerous dams creates the potential for steep computational expense this is one of the reasons that such joint planning management analysis has long posed a challenge in the water resources and environmental systems literature zeff et al 2016 loucks and van beek 2017 wild et al 2019 bertoni et al 2019 herman et al 2020 trindade et al 2020 the emodps approach pysedsim uses to explore tradeoffs across alternative portfolios of decision variables avoids the curse of dimensionality bellman 1957 that limits the power of dynamic programming based approaches in joint planning management contexts giuliani et al 2016 in order to accurately evaluate sediment removal sediment passage and fish passage pysedsim enables users to explore the performance of dams with alternative detailed design features this includes not only reservoir storage capacity and geometry i e elevation volume area curve but the presence of low level outlets mid level outlets i e sluice gates spillways and hydraulic bypass channels and their specifications e g elevation discharge capacity curves 2 2 4 uncertainty analysis the effectiveness of the previously discussed design and operational features can be evaluated in either stochastic monte carlo or deterministic mode this enables users to explore performance of alternative operating policy and design configurations under different hydrologic and sediment uncertainties as well as to identify sdo features that perform robustly under these uncertainties pysedsim s monte carlo functionality enables users to sample the multiple empirical model parameters employed in representing sediment processes including sediment production from the watershed transport in river channels trapping in reservoirs and various representations of reservoir sediment management processes parameter sampling is possible across a diverse array of probability distributions e g normal uniform triangular etc to explore uncertainty in hydroclimatic conditions users may generate stochastic sequences of daily hydrologic and sediment inflows using external models or techniques e g stedinger and taylor 1982 pysedsim provides support for monte carlo simulation by sampling these externally generated time series and organizing the stochastic simulation results in comparing pysedsim to other river basin simulation models we found widespread exclusion of uncertainty analysis capabilities regardless of a model s core process focus i e water or sediment in the water management domain existing models are often limited in their ability to handle even well characterized e g hydroclimatic uncertainty uncertainty analysis is theoretically possible in any simulation model for which execution can be automated but many models do not directly support monte carlo simulation with simple user specifications with respect to sediment management few models include stochastic representations of the sediment management processes e g shokri et al 2013 regardless accounting for uncertainty in models with very detailed representations of sediment management would render these models even more unlikely to be applicable in a river basin planning setting the capability to evaluate the impacts of key uncertainties is foundational to evaluating the risk driven objectives of decision relevance in many river basins quinn et al 2017 2 3 software design as illustrated in fig 4 pysedsim s software architecture is designed to support flexibility extensibility transparency provenance and scalability flexibility is addressed by providing a breadth of river basin and infrastructure features that can be readily represented in sdo applications transparency refers to the extent to which model users and prospective developers can view and understand the software s design and structure provenance refers to the chronology of ownership and development of a model scalability refers to pysedsim s ability to be implemented across a range of computing resources from laptops to high performance parallel supercomputers this helps users to effectively manage the computational demands in their analyses e g simulations of larger systems uncertainty assessments simulation optimization finally extensibility refers to facilitating a broad range of analytical workflows that exploit current and emerging software tools each of these five software architecture design features is addressed separately below flexibility is achieved in pysedsim through object oriented and modular software design the enlarged box on the upper right hand side of fig 4 demonstrates a simplified unified modeling language uml diagram of a representative sample of core pysedsim classes and their hierarchical relationships this serves as just one example of the numerous classes used to organize the model s key processes and features core sub classes are shown at the bottom of the uml diagram any given model application requires creating multiple of these core sub classes and piecing them together into a unique network of reservoirs channels and junctions pysedsim s object oriented design facilitates integration of multiple energy and ecological concerns into a single model because prospective co developers can easily extend the model s functionality to include new or different ecological or other concerns pysedsim facilitates extensibility through outward connectivity to external python based packages and tools the enlarged box on the lower right hand side of fig 4 provides a sample of existing connections between pysedsim and external python packages as well as examples of potential future external connections some packages are required for pysedsim to run basic simulations whereas others are used to extend pysedsim s functionality only in select circumstances e g optimization for example fig 4 shows that to facilitate identification of tradeoffs and optimization of operating policies pysedsim connects to the borg multi objective evolutionary optimization algorithm hadka and reed 2013 while pysedsim directly supports the borg moea pysedsim can be coupled with any open source moea that is python based or has a python wrapper such as the project platypus library https github com project platypus platypus to facilitate scalability especially in monte carlo simulation or simulation optimization experiments pysedsim uses the python based message passing interface for python i e mpi4py package dalcin et al 2005 2008 2011 to facilitate user interaction with the model software and efficient data import pysedsim uses the python based openpyxl library to import excel based data gazoni and clark 2017 to facilitate data processing and export pysedsim uses the python based pandas software for panel data manipulation and analysis mckinney 2012 to organize process and export simulation data by enabling the use of an excel based user interface and efficient production of data outputs these connections facilitate pysedsim s goal to serve as a decision support system loucks 1995 to facilitate data visualization pysedsim uses the matplotlib package hunter 2007 to facilitate use of external hydrologic and sediment modeling tools pysedsim is built to accept inflows and sediment loads in the same style as those produced by the swat model neitsch et al 2009 such external modeling exercises e g swat that enhance pysedsim analyses often require extensive expertise and data sets thus pysedsim applications can benefit from leveraging the modeling outputs produced by other more detailed studies while the model does not currently connect directly to an external python based stochastic hydrology package for hydroclimatic uncertainty analysis the model is structured to facilitate establishment of such a future connection as well as to sensitivity analysis libraries e g the sensitivity analysis library salib developed by herman and usher 2017 in a river basin modeling context transparency is likely the single most important factor in facilitating replicability and reproducibility ceola et al 2012 which are often overlooked but fundamentally important requirements for designing and executing sound scientific experiments peng 2011 transparency also encourages extensibility by enabling users to more effectively understand and extend the model pysedsim is transparent via its object oriented and modular code design and extensive in code documentation which clarify model structure by providing fully replicable example model applications which are explored in this paper and in that the code is open source the model s open source repository facilitates provenance by enabling co developers to contribute code on the model s public repository finally scalability is important in the context of evolutionary optimization methods which can require many simulations to converge on reliable solutions pysedsim is scalable in that it supports cluster based parallelization of simulation optimization and monte carlo simulation experiments this functionality is available to users through several pysedsim functions that optionally call the mpi4py package details are provided in the model user documentation and in function docstrings 3 model application case study sambor dam mekong river basin cambodia 3 1 background the mekong river in southeast asia is one of the world s most productive and dynamic rivers hosting an open access wild capture fishery of over 1200 fish species poulsen et al 2004 the basin s 60 million inhabitants rely on the river for food and income security harvesting 2 1 million metric tons of fish per year at a retail value of up to 7 8 billion us per year hortle 2009 less than 30 years ago the river fig 5 a flowed freely for 4350 km mrc 2016 today over 40 large hydropower dams exist with over 100 more dams proposed or under construction mrc 2016 the proposed sambor mega dam has been a major focus for the government of cambodia goc in its efforts to generate hydropower revenue and secure a reliable domestic energy supply sambor s original design china southern power grid company 2008 was proposed to extend 18 km across the mekong river which would make it one of the world s longest dams lehner et al 2011 as the basin s downstream most proposed dam it would be sited in proximity to tonle sap lake one of the world s most productive freshwater lakes lamberts 2006 that provides up to 80 of cambodia s protein in some areas hortle 2007 over 50 species of fish annually migrate upstream past the planned dam site to main stem and tributary spawning grounds barlow et al 2008 halls and kshatriya 2009 after spawning the fish swim downstream past the planned dam site returning to the floodplains to feed eggs laid in tributaries become larvae that naturally passively drift back downstream to the floodplains while suspended in the river s flow nearly all of the mekong s natural 160 mt y sediment load is transported annually past the dam site as well designed to maximize energy production the sambor design poses fundamental ecological concerns because it would provide inadequate means of passing the river s significant migratory fish biomass and would be too large and wide to effectively pass sediment nutrients and fish larvae downstream wild and loucks 2015b in a multi year partnership with the goc nhi 2017 wild et al 2019a used pysedsim to study the potential for alternative sambor dam sdo options to produce more balanced outcomes with respect to ecological and energy production goals as shown in fig 5 an alternative dam concept sambor ecological alternative i e sambor ea was identified that includes numerous siting and design features to encourage sediment and fish passage the dam s salient design feature is a completely unregulated natural bypass channel to the east of the reservoir that exists to facilitate sediment passage and fish migration sambor ea s geographic location is shown in fig 4a fig 4b shows a plan view of the dam and reservoir overlaid by a pysedsim model schematic of the river channel segments junctions and reservoir that make up the pysedsim implementation of sambor ea used for demonstrative purposes in this paper ultimately the iterative process of exploring sambor alternatives described in section 3 2 contributed to the success of nhi 2017 in directly influencing the goc to postpone all mainstem mekong dam construction ratcliffe 2020 3 2 iterative problem formulation overview pysedsim supported the stakeholder engagement and pre feasibility planning process surrounding sambor and sambor ea nhi 2017 through an extended iterative problem formulation and exploration process with basin stakeholders fig 1 in this paper we demonstrate pysedsim s use across three formulations that compare searching for rather than pre specifying operating policies conducting stochastic versus deterministic analysis and exploring combinations of multiple performance metrics that reflect diverse stakeholder preferences each candidate formulation builds upon prior formulations to arrive at final recommendations to decision makers nhi 2017 to evaluate performance across formulations we evaluated sambor ea reservoir operation alternatives using daily simulation output from the six pysedsim state variables below which we selected to reflect diverse stakeholder preferences 1 daily energy production gw h e hydropower production at the sambor ea powerhouse 2 daily bypass attraction flow rate m 3 s f the bypass channel in fig 5b will be the primary route for fish to circumnavigate the dam this variable represents the attraction of fish into the bypass channel during upstream migration bunt et al 2012 noonan et al 2012 3 daily larvae flow fraction unitless 0 1 l larvae can die due to predation and starvation if they are trapped in a reservoir while drifting downstream agostinho et al 2007 pelicice and agostinho 2008 pompeu et al 2011 suzuki et al 2011 pelicice et al 2015 this variable uses the fraction of main stem flow each day that either enters the bypass i e safe passage or enters the reservoir when velocities are suitable for passage fig s1 to estimate the daily fraction of larvae safely passing the site wild et al 2019a describe the modeling approach to evaluate suitability of reservoir hydraulic conditions for larvae passage 4 daily trapped sediment load kg s t this variable represents the suspended sediment load trapped in the reservoir s storage capacity the river s suspended sediment load sustains the river s geomorphic structure rubin et al 2015 and habitats halls et al 2013 transports nutrients liljeström et al 2012 arias et al 2014 and slows the subsidence of the mekong delta landform which poses an existential threat to its nearly 20 million inhabitants kondolf et al 2018 schmitt et al 2017 5 daily reservoir total storage capacity loss s c this variable represents the loss in total reservoir storage capacity m3 total storage capacity is the sum of active storage capacity which is accessed during normal operations and dead storage capacity sedimentation reduces reservoir storage capacity and hence energy production and reliability as well as other benefits dams provide mahmood 1987 white 2001 globally storage capacity is being lost in reservoirs at a rate of 0 5 1 per year mahmood 1987 white 2001 6 daily sediment load released from the dam during flushing events kg s f to enable passage of sediment through the site our simulations implemented annual sediment sluicing i e pass through and flushing i e removal the less frequently flushing takes place the larger the short term sediment pulses released downstream become relative to natural conditions thereby posing risks to ecosystems downstream wild et al 2016 we summarized each daily time series variable temporally e g annually monthly or daily and statistically e g mean and quantile to create decision relevant performance metrics such as mean annual energy production detailed mathematical definitions of these performance metrics are provided in section ii of the paper s supplement in particular table s3 shows each formulation s performance metrics and corresponding equations fig 6 summarizes the key differences across the three formulations with respect to performance metrics each formulation has a potential space of 2 columns and 4 rows in which performance metrics can reside columns represent the nature of statistical metrics of performance focused on either risk neutral mean performance or a more risk averse worst first percentile of the empirical cumulative distribution function depending on the formulation rows represent the time scales of interest for each of the performance metrics ranging from daily to annual within each formulation each individual shape i e square or circle in the figure corresponds to a different metric squares reflect pre specification of reservoir operating policies whereas circles reflect a search for operating policies via optimization the color of a shape represents the category of its corresponding performance metric including sediment fish larvae and energy the sediment i e brown colored category includes all three of the sediment related time series variables discussed previously filled and hollow shapes correspond to deterministic and stochastic simulation of metrics respectively deterministic evaluations consisted of a historical simulation using the full 100 year long flow record available at the stung treng gage station near the sambor ea dam site alternatively the monte carlo simulations consisted of a stochastic ensemble of five 100 year simulations each driven by a randomly drawn sequence of synthetically generated nowak et al 2010 kirsch et al 2013 inflow hydrology and corresponding daily sediment loads see section iii e g fig s2 of the paper s supplement for further details on our approach to synthetic flow generation as shown in fig 6 formulations implementing optimization formulations ii and iii seek to maximize or minimize performance with respect to the mean or 1st percentile of the empirical cumulative distribution function cdf for the 500 values i e 5 realizations of 100 years performance was maximized in all objectives except for the sediment related objectives which were minimized in the following subsections we briefly introduce a short synopsis of each of the three formulations and discuss their results detailed mathematical definitions for each of the formulations and performance metrics appears in section iv of the supplement section v of the supplement details the paper s computational experiments including model configurations and computing requirements to run each formulation follow the model installation instructions on the model s github repository then run the desired formulation s python script e g formulation i serial py for the serialized version of the screening formulation 3 3 formulation i problem screening 3 3 1 formulation i overview the problem screening formulation screening represents a typical starting point in a dam pre feasibility study ifc 2015 wherein a particular dam concept i e location and basic design specifications has been identified but in order to evaluate its suitability for investment the dam s performance potential must be evaluated e g with respect to energy production and adverse ecological impacts sambor ea has the capacity to store less than 0 5 of mean annual inflow the tendency in pre feasibility studies of similarly hydrologically small i e low capacity inflow ratio reservoirs is to specify energy maximizing run of river operations much like specifying a static design feature to reflect this standard planning approach the screening formulation includes an energy maximizing rule curve i e energy rule curve as shown in fig 7 rule curves for sambor ea were strongly shaped by the reservoir s complex hydraulic configuration which is detailed in the appendix fig s1 in brief the reservoir s unregulated upstream end means that lower water levels increase reservoir inflows and reduce spillage into the unregulated bypass channel thus energy production is not maximized by maximizing water level because high water levels imply significant spillage to reflect diverse stakeholder preferences and to attempt to capture the potential for tradeoffs across objectives we also include two ecologically focused rule curves one focused on larvae passage i e the larvae rule curve and one focused on adult fish passage i e adult fish rule curve the larvae rule curve was designed to enable year round downstream passage of fish larvae the adult fish rule curve was designed to benefit adult fish passage around the dam by maximizing the rate of flow spilled into the bypass channel disciplinary experts identified these rule curves during the pre feasibility study of sambor dam nhi 2017 across all formulations operating policies implement identical approaches to improving sediment passage through and around the sambor ea reservoir including annually passing inflowing sediment through the reservoir i e sluicing through mid level outlets and infrequently removing deposited sediment from the reservoir i e flushing through low level outlets to highlight the difficulty in pre specifying rule curves that perform well under uncertainty across multiple metrics the three rule curves were simulated both deterministically using the 107 year historical hydrologic record and stochastically using synthetically generated hydrologic sequences to modestly sample well characterized hydrologic uncertainty performance was then evaluated both deterministically and stochastically with a wide range of metrics reflecting different temporal and statistical filtering of the six time series variables introduced in section 3 2 1 formulation i is referred to as the problem screening formulation because we initially explore a large set of metrics then sift through those metrics to inform a more targeted subset of metrics for future problem formulations fig 6 shows that all metrics in the screening formulation were evaluated annually except for sediment flushing which was evaluated on a monthly basis to capture the potential for ecologically harmful short term spikes in sediment load in total the screening formulation consists of 12 simulations one deterministic and one stochastic simulation for each of the three rule curves with and without reservoir sediment management taking place in this sense the screening formulation is a departure from the traditional dam pre feasibility analysis because it emphasizes evaluating policy performance under a wide range of performance metrics and uncertainties to better understand performance potential and tradeoffs 3 3 2 formulation i results the nine plots in fig 8 report the performance of the three expert elicited operational rule curves the top row of plots fig 8a c report the rules attained performance for energy production larvae passage and fish passage fig 8d i summarize the rule curves performance for sediment including the quantity trapped the effect of the trapped load on storage capacity and the magnitude of sediment released downstream of the dam during the month of june when the majority of flushing events take place for these metrics fig 8d f reflect simulations in which no sediment management takes place whereas fig 8g i account for sediment management effects within each figure the three rule curves are designated by different colors across the metrics of performance the deterministic performance results are plotted as single mean values i e vertical lines representing the three candidate rule curves mean annual performance for a single historical time series of hydrologic and sediment inflows in contrast stochastic performance dashed lines for a given rule curve is plotted as an empirical cumulative distribution function cdf each cdf represents the distribution of performance across all years in the monte carlo simulation as the slope of the cdfs become flatter the variance in attained performance metrics is increasing each stochastic cdf represents a simulation with five inflow sequences of 100 years or 500 annual values this sampling level was confirmed to provide stable convergence for the more extreme quantiles in the empiric cdfs fig 8 reveals three key points for guiding the evolution of future sambor ea problem formulations first there is significant variance in performance across numerous performance metrics under a modest sampling of well characterized uncertainty as an example of important variance at sambor ea fig 8a shows that annual energy production varies from the mean by as much as 50 in best and worst case years for each of the three policies this has important financial implications as the dam s financier must maintain adequate cash flows to service the debt incurred in constructing the dam not just on average but also during periods of lower hydrologic inflows this strongly suggests future problem formulations should account for uncertainty in identifying and evaluating candidate operating policies it has long been known that optimizing policies to achieve mean focused performance metrics often tacitly exposes policies to broader variability in performance beyer and sendhoff 2007 the variability in performance across the probability distribution for each metric underscores the importance of sampling multiple stochastic hydrologic futures to more reliably approximate the distribution tails i e extreme events second the results from the screening formulation show that evaluating a small handful of pre specified policies designed to achieve performance in a single objective has two important consequences to begin this approach suffers from the potential for strong decision maker regrets as performance could likely be substantially improved in all metrics i e a dominated set of candidate actions despite the best efforts of disciplinary experts additionally even if the policies are theoretically optimal in each single metric evaluating a small handful of policies can only reveal that performance conflicts exist rather than explicitly quantifying their complex tradeoffs for example the larvae rule curve was unsurprisingly the best performing with respect to the larvae passage objective fig 8b yet it performed the worst of the three policies with respect to energy production fig 8a and bypass flow for adult fish passage fig 8c together these results suggest future problem formulations should include an optimal search for reservoir operating policies and the tradeoffs they create rather than pre specifying rule curves which is at present standard practice in most simulation frameworks loucks et al 1995 sheer 2000 labadie et al 2000 zagona et al 2001 matrosov et al 2011 yates 2005 third the middle and bottom panels of fig 8 demonstrate the value of pysedsim s ability to evaluate reservoir sediment management metrics fig 8d shows that despite its ecologically focused redesign sambor ea could trap 5 8 million metric tons of ecologically important suspended sediment on average annually fig 8d shows that this could result in an annual loss of 0 25 0 6 of total reservoir storage capacity per year this implies the reservoir could lose up to nearly 25 of its storage capacity by the time of transfer of ownership of the dam this result has important implications for the goc who would only assume ownership of the devalued reservoir after a concession period of up to 40 years nhi 2017 options are available to mitigate storage capacity loss fig 8g and h show that implementation of annual sediment pass through i e sluicing and irregular removal i e flushing every 15 years for drawdown periods of about one week significantly limit deposition and storage capacity reduction by regularly preventing and removing deposited sediment these increased sediment flows show that significant basin wide sediment trapping e g as predicted by kondolf et al 2014 both in the mekong and elsewhere is not a foregone conclusion much of the scientific literature focused on reservoir sedimentation particularly in the mekong e g kondolf et al 2014 kummu et al 2010 is geared toward impact prediction and vulnerability assessment rather than practical management approaches to mitigating impacts wild and loucks 2014 2015b 2016 wild et al 2019a however implementing these approaches requires dams be sited and designed e g with low level outlets to enable these approaches to be applied kondolf et al 2015 annandale 2013 kondolf et al 2014 mrc 2009 pysedsim captures design details such as low and mid level gates that facilitate this evaluation while the potential for sediment management options exist a comparison of fig 8f i shows that techniques such as flushing can have negative impacts if not managed carefully specifically irregularly flushing sediment from the reservoir can significantly distort the river s natural probabilistic sedigraph i e sediment duration curve downstream of the dam site during the month of june when flushing occurs most frequently sediment discharge increases not only on average but also in the more extreme quantiles of the probability distribution creating the potential for significant ecological impacts downstream wild and loucks 2016 one potential solution is to increase the frequency of flushing though this creates a tradeoff with the objective to maximize annual energy production 3 4 formulation ii discovering tradeoffs 3 4 1 formulation ii overview while the three screening formulation rule curves potentially represent reasonable efforts at maximizing performance among three objectives there is no guarantee these policies perform well compared to other possible operational rules or that they perform well under uncertainty moreover it is difficult to assess how the expert defined operational rules are striking compromises across the complex tradeoffs that likely exist across ecological concerns and power production ending the analysis at the screening formulation could misrepresent sambor ea s potential to achieve balanced ecology energy outcomes this motivated the need for the discovering tradeoffs i e tradeoffs formulation in which we conduct an optimal search for policies designed to perform well across multiple objectives under uncertainty the tradeoffs formulation seeks to identify rather than pre specify alternative reservoir operating policy alternatives that perform well on average under hydrologic uncertainty as shown in fig 6 this formulation seeks to identify policies that perform well with respect to a subset of four of the performance metrics that demonstrated strong tradeoffs and decision relevance in the screening formulation namely reservoir sediment trapping and storage capacity loss metrics are dropped compared to the screening formulation and finer temporal scale is adopted for the adult fish passage and sediment flushing metrics rather than seeking to identify a single optimal operating policy pysedsim s multi objective simulation optimization approach identifies the suite of candidate operating policies whose performance in at least one objective cannot be improved without degrading performance in one or more of the remaining objectives i e pareto approximate solutions a fully coupled multi objective evolutionary algorithm moea the borg moea hadka and reed 2013 parameterizes and iteratively refines operating policies optimizing them in response to their simulated performance with respect to four metrics reservoir operating policies take the form of parameterized non linear gaussian radial basis functions rbfs these rbf parameters serve as the decision variables the moea uses to control policy performance additionally the tradeoffs formulation includes three sediment management variables in its optimal search related to sediment flushing 1 the frequency of sediment flushing operations constrained from 1 to 15 years 2 the day of the year on which to begin considering flushing the reservoir constrained from days 120 225 to avoid dry season and monsoon conditions wild et al 2016 and 3 the reservoir inflow rate m3 s triggering flushing drawdown to occur constrained from 6000 10 000 m3 s section v of the supplement contains a summary of key moea related assumptions across formulations and the performance of the moea in relevant formulations 3 4 2 formulation ii results the four objective ecology energy tradeoffs in fig 9 resulting from the tradeoffs formulation provide a broader context for understanding key performance conflicts and for exploring diverse stakeholder preferences fig 9 represents the best approximation for sambor ea s control policy tradeoffs accumulated across 25 trials of moea based search for visual clarity fig 9 only displays a representative subset of 100 policies from the approximately 500 in the original set pysedsim processing reference set module optionally automates this thinning using the concept of ϵ dominance laumanns et al 2002 in fig 9 each of three axes corresponds to a different objective while color represents a fourth objective to maximize dry season flow rate spilled into the bypass channel to attract migrating fish the direction of better performance in fig 9 is toward the upper right of the figure as marked by black arrows the theoretical ideal policy in fig 9 is represented by a blue star at the upper right of the plot the screening formulation policies are included among the reference set of the tradeoffs formulation policies in fig 9 to facilitate comparison each of the three pre specified rule curves was dominated i e outperformed in all four objectives by at least one member of the tradeoffs formulation reference set of control policies identified through optimization when re evaluated with random sequences of inflow hydrology and sediment loads via the processing reference set module while the screening formulation policies were outperformed they were still close to optimality however the screening formulation policies all reside in one extreme region of the broader tradeoff frontier discovered in the tradeoffs formulation thus while pre specified rule curves may perform reasonably well without any optimization it is nevertheless very difficult to capture the complex nonlinear nature of the tradeoff frontier by designing a small set of pre specified policies this result clearly demonstrates the value of identifying rather than specifying operating policies in a river basin infrastructure planning context the tradeoffs formulation results show that reducing the magnitude of sediment load released during flushing requires a tradeoff with energy production importantly the tradeoffs formulation was designed with no long term sediment passage objective because the screening formulation results fig 9 showed that the combination of sluicing and flushing and small storage capacity relative to annual inflow would likely enable highly effective sediment passage at sambor ea however the quantity of sediment load released during flushing events is of ecological importance fig 9 reveals that some policies produced an average sediment load release during flushing events of up to 18 mt d in contrast the natural daily sediment load during the monsoon season is 1 mt d koehnken 2014 policies with ecologically problematic sediment releases toward the front and bottom of fig 9a also produced the most hydropower and vice versa the presence of this important tradeoff underscores the value of pysedim s flexibility to include flushing related parameters in the optimal search process this tradeoff occurs because emptying a reservoir to conduct flushing reduces energy production so policies prioritizing energy production flushed as infrequently as possible thus releasing much larger sediment loads during flushing events finally the presence of blue and green colored policies i e with the highest bypass spillage rates throughout much of the tradeoff space in fig 9 demonstrates that this objective is not in strong conflict with other objectives as anticipated the lower limit of the color bar 5200 m3 s shows that even the poorest performing policies with respect to fish bypass flow were still on average spilling in excess of 50 of the main stem s 13 200 m3 s mean annual flow rate into the bypass channels given that all policies in the tradeoffs formulation performed well with respect to mean annual bypass flow rate the alternatives formulation was designed to include a dry season bypass flow objective to evaluate fish passage potential in both seasons a dry season energy production metric was also created in the alternatives formulation to enable better understanding of the energy sacrifice required to pass dry season larvae and adult fish while fig 9 is a crude representation of tradeoffs across complex ecological objectives it nevertheless facilitates a detailed discussion among decision makers and technical experts regarding how to define acceptable ecological performance targets in order to navigate tradeoffs in search of a subset of candidate alternatives literature regarding ecological performance metrics and thresholds is sparse in the mekong in large part due to the paucity of data describing the life cycle processes of over 1200 species of fish the mekong river commission mrc defines effective fish passage as providing safe passage for 95 of the target species under all flow conditions mekong river commission 2009 while it is not straightforward to directly apply this criterion to fish pass flow rates it can readily be applied to larvae passage flow rates referring to fig 9 policies that only meet or exceed this 95 criterion would require substantial and likely economically nonviable energy production losses this result initiated some key questions and extensive debate regarding the temporal and statistical definition of the 95 criterion for example given fish life cycle processes in the wet season contribute relatively more to the fishery s productivity could sustainable fishery outcomes still result from a compromise in which the criterion is met more frequently in the wet season as opposed to the dry season also is the criterion defined only for average conditions or does it need to be met even in worst case conditions given the potential impact of sambor ea on the appreciable socioeconomic value of the mekong fishery we pursued the alternatives formulation in which ecological objectives are optimized with respect to an approximation of worst case conditions i e 1st percentile of performance metric cdfs quinn et al 2017 maximizing performance in worst case conditions is likely to produce policies robust to future hydrologic uncertainty that perform well even in the worst e g drought years recent geopolitical tension resulting from drought conditions stone 2010 underscores the value of such policies 3 5 formulation iii refining alternatives 3 5 1 formulation iii overview the screening formulation sought to identify a subset of decision relevant metrics from among a large set while the tradeoffs formulation took that subset of metrics and sought to identify a wide array of alternative operating policies that perform well across that subset of measures however the presence of sharp tradeoffs among energy and ecological objectives in a critical and sensitive ecosystem such as the mekong naturally raises questions about how best to carefully define ecological performance metrics and thresholds in response the refining alternatives formulation alternatives reflects a shift in focus to more carefully defining ecological performance metrics and navigating the resulting refined tradeoffs in search of candidate alternatives specifically fig 6 shows that larvae passage is converted into a seasonal variable to discover strategies more capable of facilitating ecologically critical wet season larvae passage dry season larvae passage is also evaluated which is why two larvae metrics appear under formulation iii in fig 6 additionally the sediment flushing metric is converted into a daily metric to reflect the ecological impacts of large sediment releases over very short periods of time given the potential for problematic ecological performance in this critical ecosystem the alternatives formulation also shifts all performance metrics to definition in the worst first percentile rather than the mean this ensures that policies will be robust in that they will be designed to perform well in an approximation of worst case conditions quinn et al 2017 a worst first percentile i e the 1st or 99th was used as an estimator to approximate worst case behavior because quantiles are more stable and convergent than the maximum or minimum values resulting from a given stochastic simulation as is commonly done in robust optimization taguchi 1986 quinn et al 2017 stedinger et al 1993 castelletti et al 2012 beyer and sendhoff 2007 3 5 2 formulation iii results the alternatives formulation differs from previous formulations primarily in its conservative approach to defining worst case i e 1st percentile metrics the parallel axis plot in fig 10 which is reproduced from wild et al 2019a for purposes of comparing formulations summarizes the tradeoffs across the six objectives that define the alternatives formulation each vertical axis represents performance for one of the six objectives the axes are oriented such that performance improves moving vertically upward on each axis each line represents a different operating policy each policy s performance is designated by where it intersects each vertical axis the steepness of the diagonal lines between two adjacent axes displays the degree of tradeoff for solutions between the two objectives the theoretical ideal policy would be a single blue horizontal line crossing at the top of all the axes rather than representing objectives defined in the mean the performance of policies in fig 10 represents an approximation of worst case conditions by evaluating performance in the 1st percentile of the cdf of corresponding performance metrics fig 10 reveals the potential for 1st percentile performance to be significantly worse than mean performance for example dry and wet season larvae passage performance can be as poor as 18 and 40 respectively compared to 56 in mean annual conditions also sediment loads can be over twice as large in worst case conditions additionally the tradeoffs formulation fig 9 did not reveal a particularly strong tradeoff between mean annual fish bypass attraction flows and other objectives conversely fig 10 shows worst case dry season flows can be below 500 m3 s depending on the timing of these discharge values this could potentially represent less than 10 of dry season main stem discharge which would supply less than the generic 10 fish pass criterion employed in many studies thorncraft and harris 2000 numerous policies in fig 10 reflect this problematic dry season flow condition referring to fig 10 third axis a cluster of red colored policies creates very low worst case bypass attraction flows for fish migration during the dry season however many of these same policies create hydraulic conditions in the reservoir capable of achieving high levels of dry season larvae passage fourth axis these policies also significantly reduce high value dry season energy fifth axis because the site s hydraulics fig s1 in the supplement require extensive drawdown to increase inflow and thus velocities this requires directing more water down the main stem instead of spilling it into the bypass this existence of a potential tradeoff among ecological objectives themselves i e larvae and adult fish passage as opposed to between energy and ecological objectives was entirely unforeseen and was not clearly identified in formulations i and ii the appearance of problematic performance and unforeseen tradeoffs underscores the benefit of an iterative formulation approach fig 1 in a complex multi stakeholder river basin decision context having identified rich tradeoffs across multiple probabilistic seasonal fish life cycle and energy production metrics it is next possible to navigate fig 10 in search of potential solutions worth exploring in more detail three policies highlighted in fig 10 energy compromise and larvae illustrate examples of different candidate decision preferences the larvae policy achieves acceptable fish related performance in 95 of days in both seasons with hydraulic conditions conducive to larvae passage the larvae policy performs poorly in the dry season larvae passage objective making this policy less attractive across stakeholder interests just as with the larvae policy the energy policy in fig 10 performs poorly with respect to the larvae flow fraction objective in response to the potentially problematic multi objective performance of the larvae and energy policies we highlight a potential compromise policy the compromise policy shows that compromising on larvae passage in both seasons could significantly improve energy production compared to the larvae policy while also significantly improving rates of dry season bypass spillage for fish migration and reducing the magnitude of flushed sediment loads this policy prioritizes wet season larvae passage because of its relative importance to the fishery achieving 90 larvae performance in the wet season but only 60 in the dry season rarely will a single formulation of a particular problem result in the refined insight and compromise solutions that result from fig 10 the iterative approach to problem formulation and refinement of complexity in representing uncertainties objectives and reservoir operations described in fig 1 ultimately enabled more distinct tradeoffs to take shape and potential compromises to be identified 3 6 reservoir operations to better understand the new knowledge that is gained in each successive problem formulation it is helpful to view the operating policies of which the tradeoffs are comprised fig 11 plots a representative subset of reservoir operating policies from each formulation each column of figures represents a different formulation the top figure in each column represents simulated mean monthly sambor ea water surface elevation while the lower figure represents the reservoir release rate resulting from the operating policy each colored line represents a different operating policy the dashed gray line in the lower row of figures represents the mean monthly main stem flow rate at the reservoir site main stem flow rate is included as opposed to reservoir inflow because it remains the same across the formulations and policies reservoir inflows differ across policies as a result of the site s hydraulic configuration which induces different inflow rates depending on the reservoir s water levels as shown in fig s1 the screening formulation policies represent the three expert specified rule curves introduced in fig 7 the tradeoffs formulation and alternatives formulation policies selected from the reference sets of their respective formulations represent the very best performing policies for each objective hence the number of policies grows as the formulations evolve to reflect the increasing number of objectives in those formulations colors are used to reflect four objective themes energy larvae adult fish and sediment solid lines are used to distinguish policies corresponding to objectives defined in the mean whereas dotted lines correspond to objectives defined in the 1st percentile each policy was reevaluated using randomly generated sequences of inflow hydrology and sediment loads that were not used during the identification i e pre specification or optimization of the policies beginning with the screening formulation fig 11a and b show that the energy policy and fish policy maintain similar water levels and similar reservoir releases this important finding which suggests at this dam site that energy focused operations naturally produce conditions favorable for adult fish passage is a direct result of the reservoir s unique ecologically oriented hydraulic design which naturally induces significant spillage into the reservoir s anabranch channel at the reservoir water levels required for significant energy production second the operational strategy required for managing larvae i e larvae rule curve requires maintaining low reservoir water levels fig 11a while main stem flow rates fig 11b are low water levels are increased only when flow rate and corresponding velocity increases to create conditions with sufficient sustained velocity to pass larvae through the reservoir these strong seasonal differences in policies underscore the importance of pysedsim s flexibility to define objectives seasonally in comparison to the screening formulation the tradeoffs formulation policies fig 11c and d reflect the methodological differences in the approaches used to define the policies i e optimization versus pre specification for example the optimization based tradeoffs formulation produces a more refined larvae focused policy that maintains lower water levels for longer into the dry season than the corresponding policy from the screening formulation key differences in policies from the alternatives formulation in comparison to policies from the tradeoffs formulation are a direct result of the use of objectives defined 1 seasonally rather than only annually and 2 in the 1st percentile versus the mean for example the policies performing the best with respect to wet and dry season larvae passage carefully time their reservoir emptying and refill processes very differently keeping water levels lower during their respective seasons of focus these policies are especially conservative seeking to avoid poor performance even in the worst years for this reason water levels are kept lower and for longer durations than would otherwise be necessary the most important general result from fig 11 which is most evident in fig 11e and f is the vast space of reservoir operation possibilities and resulting differing multi objective performance that exist at such a hydrologically small reservoir hydrologically small reservoirs are widely regarded as relatively benign alternatives not requiring careful intra annual operation fig 7 demonstrates that this generalization is unlikely to apply to dams such as sambor ea that have a diverse array of design features oriented toward improving sediment and fish passage this demonstrates the importance of tools with pysedsim s flexibility in river basin infrastructure planning applications wherein ecologically focused changes to the sdo features of planned dams are of interest the importance of reservoir operations in this case study highlights the potential drawbacks of focusing solely on spatial optimization of dam locations in identifying alternative hydropower portfolios ziv et al 2012 schmitt et al 2018 opperman et al 2015 jager et al 2015 failing to search for reservoir operation options could constrain the potential to identify more balanced alternatives to proposed dams 4 conclusions intensive and pervasive hydropower dam development is expected over the next several decades including in some of the world s most ecologically diverse river basins e g the mekong congo and amazon winemiller et al 2016 vörösmarty et al 2010 zarfl et al 2015 moran et al 2018 this infrastructure development as planned is expected to result in severe consequences for ecosystems as well as for the hundreds of millions of impoverished people who depend on riverine ecosystems to support their food security and economic welfare mcintyre et al 2016 these ecological impacts are anticipated because hydropower dams are typically sited designed and operated to maximize power production rather than to preserve ecosystem health and productivity ifc 2015 to strike more balanced performance across ecological energy food and other potential objectives in these contexts will require re thinking the traditional approach to hydropower planning in at least two respects first rather than focusing on planning one dam at a time long term hydropower planning should more strategically consider the cumulative interactions and impacts of all existing and planned dams sabo et al 2017 tnc 2016 ziv et al 2012 opperman et al 2015 grill et al 2014 cronin et al 2016 kondolf et al 2018 schmitt et al 2018 wild et al 2019a schmitt et al 2019 intralawan et al 2018 song et al 2020 grill et al 2015 roy et al 2020 this could produce positive outcomes such as building first those dams that marginally produce the most power relative to their negative e g ecological impacts second significant modifications will be required to the siting design and operation sdo features of planned dams wild et al 2019a particularly those expected to be most impactful in the context of sensitive ecosystems to facilitate this transition toward identifying hydropower alternatives with more balanced performance this paper and its supplement introduce and describe the features of the pysedsim modeling framework and its successful application in a real hydropower planning context pysedsim is an open source object oriented python based daily time step river basin simulation model for flow sediment and hydropower in networks of reservoirs and river channels capable of exploring ecologically oriented sdo alternatives pysedsim is designed for use in feasibility and pre feasibility ifc 2015 screening assessments of alternative river basin infrastructure plans involving reservoirs the model is flexible both in its software design and its core functionality and features pysedsim users can explore representations of four key concerns relevant to the selection and evaluation of alternative reservoir configurations particularly in the ecologically sensitive contexts described earlier 1 management approaches to improve the passage of sediment through and around reservoirs to avoid storage capacity loss and downstream ecological impacts 2 search for flexible and adaptive alternative reservoir operating policies designed to achieve multiple objectives 3 alternative design features such as dam gates reservoir bypasses and other hydraulic infrastructure which are necessary to enable ecologically focused reservoir operational practices e g fish and sediment passage and 4 uncertainties in hydroclimatic drivers and in the physical processes of sediment production transport reservoir trapping and reservoir management while some existing river basin modeling tools can address one or several of these concerns we know of none that address them all in a single tool pysedsim has a software architecture that allows users to exploit these four core features in a manner that facilitates rapid testing of alternative sdo problem formulation hypotheses this is integral to facilitating exploration and evaluation of candidate hydropower sdo modifications that may be necessary to reduce reservoirs impacts on the ecological integrity of river basins indeed the most effective modeling tools and scientific studies in influencing policy agendas have often been those that change the way key issues are defined and framed and on the array of options for dealing with issues that are considered rather than only the actions that are ultimately taken cash et al 2003 pysedsim was used in a multi year multidisciplinary study conducted in partnership with the government of cambodia goc seeking to identify and evaluate alternative dam sites designs and operation sdo options as candidates to replace the proposed sambor mega dam on the mekong river wild et al 2019a nhi 2017 as proposed sambor dam would be one of the world s longest and most environmentally impactful hydropower dams spanning 18 km across the lower mekong river s floodplains with the potential to trap significant quantities of sediment critical for downstream ecosystems e g the vietnam delta and block the migration routes for over 50 species of fish using pysedsim we focused on one particular alternative dam location and design sambor ecological alternative or sambor ea and iteratively explored tradeoffs across multiple conflicting ecological and hydropower objectives of decision relevance seeking to produce the information needed to allow the goc to identify what they considered the most balanced plan this iterative problem formulation process exposed us to the complexity of this system we were analyzing and the need to address a succession of new questions and issues as we proceeded in this paper we describe three alternative problem formulations that capture the evolution of this iterative decision support process each formulation builds upon prior formulations to arrive at the final recommendations to decision makers nhi 2017 through these system representations which naturally grow in complexity we show that as operating policies were searched for rather than pre specified as more conflicting objectives were identified and included and as more uncertainty was acknowledged new objectives of interest and tradeoffs among them emerged this increasing insight changed the way the problem was framed and also revealed new options for satisfying multiple objectives that were not previously considered the flexibility of the modeling tools both in software design and functionality to iteratively explore and discover increasingly realistic formulations that reflect diverse stakeholder preferences greatly enhanced the discussions with the goc surrounding river basin development that have been taking place pysedsim could similarly be used to enhance the discussion surrounding river basin development that is currently taking place in other river basins globally pysedsim s capacity to contribute solutions to challenging problems in these contexts can be enhanced by exploring new linkages with frameworks in the following areas many objective robust decision making hadjimichael et al 2020 hadka et al 2015 kasprzyk et al 2013 power systems chowdhury et al 2020a b energy water land nexus planning and management khan et al 2020 and sensitivity analysis herman and usher 2017 declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this work was supported by cornell university s david r atkinson center for a sustainable future postdoctoral fellowship in sustainability grant no 2015 additionally this material is based upon work supported by the u s national science foundation under grant no 1855982 appendix a supplementary data the following are the supplementary data to this article multimedia component 1 multimedia component 1 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j envsoft 2020 104947 
