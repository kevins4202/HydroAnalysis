index,text
290,subgrid modeling to account for unresolved topography within the context of shallow water equations relies on the use of coarse grids for computational efficiency however excessively coarse grids can lead to artificial cross flows between hydrologically disconnected areas separated by physical barriers smaller than the grid size an approach based on introducing cell and edge clones consisting of connected groups of pixels in each cell is able to systematically remove such artificial cross flows such an approach considers that the subgrid barriers permanently divide flow among clones and effectively restrict flow to a predetermined path in this work a simple algorithm along with the use of an overtopping formula is proposed to extend the clone approach to a scenario in which clones are allowed to be further split and merged as needed depending on the surface elevation during a given runtime the algorithm is intended for accommodating the possibility of the subgrid barriers being inundated and no longer dividing the flow during an extreme event the performance of the proposed algorithm is demonstrated through a series of idealized and more realistic test cases showing considerable improvements over existing methodologies keywords subgrid model storm surge surface connectivity numerical method mathematical modelling 1 introduction accurate and efficient storm surge prediction is indispensable to prevent destruction of life and property along coastlines storm surge modeling is typically based on numerical solution of the depth averaged shallow water equations swe broadly speaking two different strategic approaches have been adopted in modern storm surge models based on their intended purposes the first is a relatively low resolution ensemble forecast which relies on using a potentially large ensemble of model runs on relatively coarse computational grids the benefit of such an approach is that predictions of storm surge before a tropical cyclone makes landfall zachry et al 2015 can be conducted quickly accounting for uncertainty in a storm s track and intensity however the use of a coarse resolution comes at a cost stemming from model errors caused intrinsically by inadequate grid resolution such as unresolved bathymetry connectivity and unknown roughness from smaller scales the second category of modeling approaches is to use high resolution simulations which aim to explicitly resolve as many scales of interest as possible such models can be very accurate dietrich et al 2017 luettich and westerink 2004 however they come with a high computational cost and require a large number of cpu cores to complete a run in a reasonably timely manner hope et al 2013 this limits their applicability with respect to ensemble forecast applications thus choosing between these two options is a trade off between computational time and accuracy high resolution models are more accurate but come with greater computational cost while low resolution models are fast to execute but less accurate kerr et al 2013 a promising intermediate path to achieve models with both accuracy and low cost is through the use of subgrid models which have recently become an active area of research in the fields focusing on flow over tidal flats and wetlands urban flooding and storm surge applications kennedy et al 2019 wu et al 2016 sanders et al 2008 sehili et al 2014 stelling 2012 wang et al 2014 note that while there is a rich history of subgrid methods in different aspects of fluid flow and transport modeling e g turbulent flow porous media flow multi phase flow different systems are needed for application to coastal models with unresolved topography to this end if higher resolution topographic and bathymetric information is available and can be directly resolved in computations it may be more practical to account for its effect with a subgrid model over the last decade the resolution of available topographic data of many coastal areas and to lesser extent bathymetric data has increasingly become far finer than the level of resolution affordable for any large scale storm surge model danielson et al 2018 to best exploit the full potential of this data it may be useful for models to include subgrid corrections conceptually subgrid models are constructed through coarsened properties such as water levels and velocities combined with integral functions of high resolution ground elevations friction characteristics and any other information that might be available early subgrid models were proposed by roig 1989 king 2001 and defina et al 1994 defina 2000 where the idea of an artificial porosity which is a function of the free surface elevation was introduced to account for partially wet areas the porosity function is used in the former in the context of a finite element implementation and the latter in deriving a set of governing equations accounting for partially wet dry areas to deal with the lack of high resolution topographical data defina 2000 introduced an explicit empirical relationship between porosity and depth based on the assumption that bottom elevations are distributed according to a given probability density function sanders et al 2008 applied volumetric and areal porosities in an integral form of the shallow water equations and discretized them with a finite volume framework to study flooding in urban areas they considered the effect of buildings on the flow using a drag formulation and a binary density function that equals zero when corresponding to a building and one otherwise however this model did not account for building interior inundation and is highly sensitive to the mesh used guinot 2017 guinot et al 2017 improved this integral porosity model by strategically creating a mesh on the computational domain such that cell edges intersect with a water blocking structures without this the effects of blocking structures do not explicitly appear in this porosity formulation while this application appears suitable for urban areas it is restricted in more natural settings particularly in areas with strong spatial heterogeneity casulli 2009 proposed a semi implicit finite volume finite difference approach on a staggered c grid with a parameter free subgrid wetting drying algorithm that uses the porosity function to ensure the positivity of the water height and to account for partial water volume in partially wet cells the resulting discrete equations are mildly nonlinear due to the nonlinear dependency of the porosity function on the surface elevation in the partially wet cells the proposed algorithm can be used on relatively coarse grids while it incorporates high resolution bathymetric data at the subgrid level casulli and stelling 2011 and sehili et al 2014 apply this approach to study flow in venice lagoon and the elbe river respectively and report that this approach improves model performance with minimal additional computational cost platzek et al 2016 combined the semi implicit method of casulli 2009 with a hierarchical grid approach to resolve small scale topographical features with the goal of more accurately accounting for regions with significant local energy losses in which the authors posit that when such losses occur the subgrid method may not be adequate and a higher grid resolution is required to improve model performance accurately parameterizing bottom drag effects is another essential aspect in the development of subgrid models that has received attention in defina 2000 d alpaos and defina 2007 the assumption of a constant friction slope was used to derive a formula for bottom stresses accounting for subgrid bathymetry casas et al 2010 presented a method for subgrid roughness parameterization based on turbulence mixing layer theory viero and valipour 2017 introduced anisotropic bottom roughness for some special cases where models were able to preserve mesh independence for relatively simple benchmark cases made up of structures with regular shapes and patterns based on casulli s subgrid formulation volp et al 2013 developed a finite volume subgrid model on the staggered c grid that employs an analytical subgrid velocity of a simplified canonical flow a channel flow with a uniform flow and constant friction slope in subgrid corrections of bottom friction and advection terms the aforementioned corrections improved model performance when there is a large variability of water depth in a coarse grid more recently kennedy et al 2019 developed an upscaled form of the 2d shallow water equations through the use of formal averaging methods the upscaled system of equations are structurally similar to the standard shallow water equations but have additional terms related to integral properties of the fine scale topography and flow they identified different levels of closures of varying complexity a number of subgrid approaches can be recovered through certain sets of closures their model provided a platform to implement subgrid corrections of bottom stresses advection and surface gradient terms the corrections to the gradient of mean water surface elevation are indeed less obvious and are intended for situations where flow characteristics change strongly within an averaging volume while the aforementioned advances have led to great improvements accounting for subgrid connectivity continues to present a substantial challenge due to an assumption of subgrid connectedness for given coarse flow variables fig 1 shows a simple example of subgrid connectedness when the water surface elevations on either side of a barrier are independent quantities one water surface elevation is not sufficient to represent the system in the coarse grid however if the surface elevation is high enough to inundate the barrier a single variable may be enough to represent the water surface elevation wu et al 2016 who adopted a pre storage of necessary quantities to increase computational efficiency note in their numerical simulation of flow in salt marshes that the level of grid coarsening is limited by bathymetric features mainly due to the assumptions of a constant surface elevation within a coarse cell it is suggested that any coarse grid used should be able to resolve general topographical features such as major channels and blocks platzek et al 2016 suggested a hierarchical grid approach utilizing a multigrid concept to resolve small bathymetric features but this comes with increased computational costs and their approach was intended for quasi steady state problems to correct surface connectivity issues hodges 2015 developed an automatic edge blocking approach that represents features along cartesian coarse cell edges the approach has been used to study many aspects of salt marshes li and hodges 2019a 2019b however inaccurate approximations of water surface elevation remain unavoidable in coarse grid settings where edge blocking prevents flow within the coarse cell with the block which depending on the problem at hand can be detrimental to model predictions recently casulli 2019 introduced a cell clone approach to remove an artificial cross flow between disconnected areas within a cell the approach takes advantage of the nature of the staggered c grid in that the surface elevation is placed at the cell center and flow velocities that connect two adjacent cells are placed at the edge center to represent flow paths each cell and edge are then cloned as many times as necessary based on disjoint groups of connected areas at a given predetermined surface elevation the surface elevation and velocity among the cell and edge clones of the host cell and host edge are then permitted to have different values essentially allowing for the possibility of having more degrees of freedom on a single cell and edge this approach was used to study tidal flow in sacramento san joaquin delta area where even relatively coarse grids showed good agreement with high resolution simulations in this approach by construction cell clones of a host cell are permanently disconnected from each other during a simulation without modification the approach does not permit an inundation of subgrid blocking features inside the coarse grid a scenario likely encountered during extreme events such as storm surge casulli 2019 suggests that this issue can be overcome by using a properly formulated weir formula to re establish the connection between two adjacent cell clones while the weir formula permits re establishment of the connection it is potentially insufficient when a subgrid barrier is fully submerged additionally the original work of casulli does not consider a possible scenario in which flow within each clone becomes physically separated by subgrid barriers as the water level recedes i e subgrid connectivity is assumed within the clone in this study we propose an extension to casulli s approach to overcome these limitations in 2 we first summarize casulli s original clone method casulli 2019 subsequently we describe a simple approach that is based on further cloning of a cell clone into sub clones that may or may not be connected depending on the value of the current surface elevation sub clones are allowed to split and merge in order to capture the effect of small barriers that are submerged or emerged when the water surface elevation rises or recedes in 3 we describe implementation of the proposed approach in the upscaled swe model of kennedy et al 2019 the performance of the proposed algorithm to deal with flooding and draining is demonstrated in 4 using test problems of increasing complexity and a real setting conclusions from the study are drawn in 5 2 methodology as standard subgrid approaches assume connectivity throughout a cell excessive coarsening while reducing computational cost substantially can lead to flow connectivity problems where features that should not be connected in reality are still connected numerically causing inaccurate estimates of water surface elevation in section 2 1 2 2 we describe casulli s method casulli 2019 in which each coarse grid is cloned based on connected pixels to remove artificial cross flows building on this we propose a method that splits a cell clone into sub clones where barriers inside a cell clone can emerge at set water surface elevation in section 2 4 a simple method is presented to connect the sub clones of a clone 2 1 computational grid and pixels here we adopt the terminology used in casulli 2019 more specifically we consider a raster based digital elevation model dem with uniform resolution δ and parameter b defined over the entire grid this might represent the bathymetric depth from still water used to define a computational domain we denote each single point as a pixel a grid cell used as the basis for a computational model is made up of a group of such pixels for the highest possible accuracy a numerical model should account for the information provided by each pixel indeed a grid cell can be as small as an individual pixel or as large as the entire computational domain to maximize efficiency when using a subgrid model the computational grid should be allowed to be much coarser than an individual pixel but still incorporate as much information from each pixel as possible let us define the size of grid cell as p q pixels of size δ by partitioning the pixels of a computational domain into m n subarrays representing host cells of size δ x p δ and δ y q δ a coarse grid is obtained in order to define pixels on a cell edge the minimum pixel values of two adjacent cells are set as an edge pixel thus each pair of two cells has either p or q edge pixels for efficiency pixels that are not likely to be flooded i e pixels where elevation values are larger than the maximum possible surge are marked as inactive within the computational domain a cell is marked as inactive if it contains no active pixel the same is done for cell edges an active cell edge has at least one active edge pixel otherwise the cell edge is marked as inactive 2 2 cell and edge clones to begin we define a reasonable range of surface elevations η min η η max based on extreme inundation and receding water levels pixels that are not likely to be flooded are marked as inactive b η max the remaining pixels are called active pixels if there is a continuous path of active pixels between any two pixels these two pixels are called connected pixels within a grid cell there may be multiple groups of connected pixels that are separated from one other similarly edge pixels that are not likely to be flooded b edge η max are marked as inactive edge pixels each cell edge that contains one or more active pixels is an active edge otherwise it is an inactive edge at the maximum surface elevation η max the host cell is cloned a sufficient number of times based on the number of separate groups of connected pixels each clone of a host cell only contains one group of connected pixels the clones of a host cell are assumed not connected with each other under any extreme situation to fully achieve this condition η max should be sufficiently high in practice a reasonable value of η max is the maximum probable surge height for the area of interest based on the historical surge event each clone of a host cell has a constant water surface elevation but this can be different among the clones within the same host cell similarly a host edge pairing two host cells is cloned a sufficient number of times where each edge clone is a group of edge pixels shared by two clones of such neighboring cells these edge clones provide the connectivity information between each host cell and its neighbours each edge clone of a host edge is assumed to have a constant discrete velocity perpendicular to the edge either u or v but this velocity can be different among edge clones of the same host edge therefore the cell and edge clone approach provides more degrees of freedom for the host cell that leads to a more accurate representation within the coarse grid where small scale structures disconnect flow to help further illustrate our point the grid cells active pixels and cell and edge clones of a meandering river are shown in fig 2 groups of connected pixels are highlighted with different colors let us focus on the host cell i j located in the center of the domain it can be seen that there are two disjoint groups of connected pixels ω i j 1 and ω i j 2 on its western left edge γ i 1 2 j there are two groups of active edges γ i 1 2 j 1 and γ i 1 2 j 2 the former connects the clone ω i j 1 and ω i 1 j and the latter connects ω i j 2 and ω i 1 j on its northern top edge the set of active edge pixels γ i j 1 2 connects ω i j 1 and ω i j 1 on its eastern right edge γ i 1 2 j connects ω i j 2 and ω i 1 j there is an inactive edge in the south bottom edge γ i j 1 2 so this host cell has two cell clones which could have different water surface elevations the host edge to the west left of this host cell has two edge clones which could have different u velocity the host edges to east right and north top have single values of the u and v velocity respectively the host edge on the south bottom is inactive and thus is treated as a dry edge it is important to note that cell clones of a host cell share the same geometric center edge clones of a host cell have the same length and geometric position of an edge cell therefore a cell clone is a copy of the host cell including a connected path of active pixels and a clone edge is a copy of the active host edge including a connected path between two neighbouring cell clones of two adjacent cells furthermore each active pixel belongs to just one single clone of a host cell and each active pixel of an edge clone belongs to just one edge clone 2 3 sub clones if a cell is cloned sufficiently at the maximum surface elevation to remove artificial cross flows such cross flow may still exist at surface elevations less than η max i e in between η min η η max as new barriers appear at lower surface elevations and split a cell clone into two or more groups of connected pixels as illustrated in fig 3 each of these groups of connected pixels is hereafter called a sub clone a sub clone of a cell clone may or may not be connected to one sub clone or multiple sub clones of the host cell clone at a given surface elevation for simplicity and efficiency purposes the horizontal size an area of a sub clone is considered as a constant during the simulation for each sub clone a minimum water surface elevation is defined based on the minimum bathymetry of the sub clone to determine the wet dry condition of the sub clone if the water surface elevation of a sub clone goes under the minimum bathymetry of the sub clone the sub clone is removed from the computational domain due to the dry condition of the sub clone fig 3 shows an example of host cells and their wet areas at four different water levels η max η 0 η 1 η 2 η 3 η min at the maximum surface elevation η max three cell clones ω i j 1 ω i j 2 ω i j 3 can be seen these three cell clones are not connected with each other by reducing the water surface elevation to η 1 cell clone number 2 ω i j 2 is divided into two disconnected sub clones ω i j 2 1 1 and ω i j 2 1 2 these two sub clones are disconnected at the specific surface elevation η h hereafter this surface elevation is called the connectivity surface elevation a lengthy notation η h i j n m where n denotes a clone number and m a sub clone level will be used to precisely indicate the connectivity surface elevation when some ambiguity arise this water surface elevation is used to connect sub clone ω i j 2 1 1 to sub clone ω i j 2 2 2 at water surface elevation η 2 this clone is divided into three sub clones ω i j 2 1 1 ω i j 2 2 1 and ω i j 2 2 2 note that sub clone ω i j 2 1 2 is divided into two sub clones at the connectivity surface elevation η 2 η ω i j 2 η 2 the connectivity surface elevation can be found for each sub clone by sampling reduced water surface elevations at surface elevation η 3 one of the sub clones ω i j 2 1 1 disappears altogether due to the dry condition thus for surface elevations in the range of η min η 3 sub clone ω i j 2 1 1 should not be considered during computations fig 4 shows the algorithm to find cell clones and sub clones of a domain step by step a sub clone has four edges at each edge a velocity perpendicular to the edge is defined if there are no active pixels on one sub clone edge that edge is inactive and it is not connected to the adjacent host cell however it is possible that a sub clone edge could be active within some range of the water surface elevations and be inactive in the others note that sub clones of a cell clone share the same size and geometric center as the host cell therefore a sub clone is a copy of the host cell including a connected path of active pixels furthermore each active pixel of a clone belongs to just one single sub clone of a cell clone a sub clone edge has the same geometric location and length of the host cell and each active pixel of an edge cell belongs to just one sub clone of a cell clone to reduce the computational cost isolated sub clones that are much smaller than the coarse grid are removed from the computational domain if a sub clone does not connect with the cell clones or sub clones of the neighbor cells it is considered an isolated sub clone 2 4 merging and splitting sub clones in this section we propose a method to connect sub clones of a cell clone when blocking structures inside the cell clone are submerged fig 5 a shows the host cell ω i j at the maximum surface elevation η max this cell has three cell clones of ω i j 1 ω i j 2 and ω i j 3 fig 5b shows the sub clones and clones of this host cell at connectivity surface elevation η h i j 2 1 it can be seen that cell clone ω i j 2 splits into two sub cell clones ω i j 2 1 1 and ω i j 2 1 2 as surface elevation increases above the connectivity surface elevation sub clones are merged therefore sub clones ω i j 2 1 1 and ω i j 2 1 2 at surface elevations η h i j 2 1 η are submerged and one sub clone is considered instead during the simulation when the water surface elevation reaches the connectivity surface elevation η h i j 2 1 for two connected or more connected sub clones they are merged and one cell clone is considered ω i j 2 this cell clone has one surface elevation which is the average surface elevation of the connected sub clones when the surface elevation of each sub clone passes the connectivity surface elevation however it is possible that the surface elevation of one of the sub clones reaches the connectivity surface elevation ahead of the other ones here a sub clone cell which is connected to the inlet has the higher water surface elevation is called a source sub clone and the other sub clones are called receiver sub clones to deal with this an overflow formula is used to connect the source sub clone to the receiver sub clones until the water surface elevation of the receiver clone reaches the connectivity water surface elevation thereafter one cell clone or sub clone with one constant surface elevation can be considered for simplicity the overflow is modeled as a sharp crested weir although we note that this could readily be changed as needed should a better option be available a sharp crested weir is an overflow structure consisting of a vertical plate with a sharp edged crest mounted perpendicular to the flow direction as shown in fig 6 a simple empirical formula is used to assign an overflow between disconnected sub clones of a cell clone downstream of a sharp crested weir free flow occurs when the weir allows free access of air under the nappe the weir will be submerged if downstream water rises near or above the crest elevation based on the experimental work of kindsvate kindsvater and carter 1959 the following formula is used to approximate discharge 1 q k w 2 g l e w h e 0 3 2 where k w 2 3 is a constant l e w is effective width and h e 0 is effective depth in regard to the shape of weir in the context of a cell clone we can calculate discharge from the source cell to the receiver cell based on 1 for each time step until the water surface elevation of receiver cell reaches the connectivity water surface elevation η h once such a state is reached the average water surface elevation of the source and receiver clone is computed for a single constant water surface elevation of the merged cell clone by means of 2 η m c v m c a m c b m c v m c v s c v r c where a and v denote the area and volume of a cell b is the averaged bathymetric depth where the average is the combination of wet areas of connected cells and subscripts m c s c and r c denote merged sub clone source sub clone and receiver sub clone respectively to conserve mass in any situations a better approach can be employed where the volume of a merged sub clone is computed from the high resolution bathymetric data as a function of the surface elevation i e given the volume of the merged sub clone from eq 2 the water surface elevation is determined from the inverse relationship of the volume and the water surface elevation curve of the merged cell for the parameters in 1 we use h e 0 η s o u r c e η h and for simplicity l e w δ x or δ y at each time step discharge is calculated for the receiver clone 3 governing equations 3 1 subgrid model discretization the two dimensional depth averaged shallow water equations are considered conservation of mass is given by 3 h t h u x h v y 0 where t denotes time and u x y t and v x y t are the vertically averaged water velocity components in the x direction and y direction respectively here h η b x y is the local total water depth where η denotes the surface elevation and b x y bathymetric depth the momentum equations in the conservative form are 4 h u t x h u u y h u v g h η x τ b x τ s x ρ 1 ρ p a x f c h v 1 ρ h τ x x x h τ x y y and 5 h v t x h v u y h v v g h η y τ b y τ s y ρ 1 ρ p a y f c h u 1 ρ h τ y x x h τ y y y where τ b and τ s are bottom stresses and surface stresses respectively p a is local atmospheric pressure f c is the coriolis parameter and τ x x τ x y τ y x and τ y y denotes the lateral stresses due to turbulence mixing for the bottom stresses we consider quadratic formula 6 τ b ρ γ u γ c f u where c f is a bottom drag coefficient for simplicity in this study the coriolis force wind stress atmospheric pressure lateral stresses are neglected although they can be readily included should they be required 3 2 upscaled equations we consider the upscaled swes proposed by kennedy et al 2019 these equations are derived from formally applying averaging techniques whitaker 2013 to the swes presented in the previous section the upscaled mass equation is 7 v w η t h u x h v y 0 where v w η denotes the wet volume per unit area for a given wet averaged surface elevation η u h u d v h d v is the velocity vector averaged to the grid level and h denotes grid averaged water depth the upscaled momentum equations are 8 h u t u u h x c u u u v h y c u v u u h g h c η x x η x c η x y η y ϕ u c m f x x u c m f x y v 9 h v t v u h x c v u v u h y c v v v v h g h c η y x η x c η y y η y ϕ u c m f y x u c m f y y v where brackets denote grid averaged quantities except for velocity and water surface elevation where they are understood as a volume average and wet intrinsic average respectively in 8 9 ϕ a w a g denotes the wet area fraction c u u c u v c v u c v v are coefficients accounting for subgrid corrections associated with the nonlinear convection terms c η is the subgrid correction of the surface gradient coefficient and c m is effective bottom stress coefficient several closures for determining the subgrid correction parameters are proposed in kennedy et al 2019 here we consider the so called level 0 closure this closure uses fractional wetting and drying over the grid cell for mass correction but makes no sophisticated attempt at subgrid corrections for the momentum convection and surface gradient terms more precisely subgrid parameter are set to 10 c η x x c η y y 1 c η x y c η y x 0 11 c m f x x c m f y y c f g c m f x y c m f y x 0 12 c u u c v v c u v c v u 1 3 3 discretization the upscaled three eqs 7 9 have three unknown solution functions η u and v the averaged water depth h v w is taken to be a known variable and determined from η and a given dem b x y they are discretized on a staggered c grid with a semi implicit finite difference method see fig 7 the unknown variable η is placed at the cell center and u v are located at the midpoint of the vertical and horizontal cell edges respectively the advection term in 8 and 9 is discretized explicitly via an upwind scheme the surface gradient and bottom stress terms in the momentum equations and velocities in the continuity eq 7 are discretized implicitly to avoid restrictions on δ t from the g h wave and stiff bottom friction source term when the value c m is large we refer to kennedy et al 2019 for more detailed account of the numerical method below we describe the modification of the method to include the methodology described in section 2 to keep the notation simple η h u and v will be used to refer to the averaged variables η h u and v respectively suppose that at the time level t δ t we have a set of wet clone edges and cell clones with at least one wet edge note that cell clones correspond to sub clones when the water surface elevation in a clone drops below the connectivity water surface elevation level see section 2 4 which determines particular sub clones to be considered with such the sets at hand the discretization of the governing equations is as follows a semi implicit discretization of the momentum equations is written for each clone edge which could be a sub clone of a host edge the discretization of the x and y momentum equations carried out at the vertical and horizontal edges are respectively 13 u i 1 2 j n 1 1 h i 1 2 j h i 1 2 j n u i 1 2 j n δ t f i 1 2 j n g δ t δ x h i 1 2 j n η i 1 j n 1 η i j n 1 and 14 v i j 1 2 n 1 1 h i j 1 2 h i j 1 2 n v i j 1 2 n δ t g i j 1 2 n g δ t δ y h i j 1 2 n η i j 1 n 1 η i j n 1 where h i 1 2 j 1 h i 1 2 j n γ i 1 2 j δ t h i j 1 2 1 h i j 1 2 n γ i j 1 2 δ t and f i 1 2 j and g i j 1 2 represent the discretization of the advection terms see kennedy et al 2019 for more detail of these terms it is emphasized that in 13 14 the notations are overloaded for notational simplicity more specifically in 13 u i 1 2 j h i 1 2 j must be interpreted as the u velocity and water depth associated with a sub clone edge of the i j 1 2 host edge η i 1 j and η i j are the surface elevations of two sub clones from neighboring host cells to which the connected path is through the clone edge considered the approximate solution variables in 14 are interpreted in an analogous manner for each clone cell which could be a sub clone of a host cell the discretization of continuity eq 7 with the euler backward time discretization is considered 15 v η i j n 1 v η i j n δ t 1 δ x s e i 1 2 j u i 1 2 j s n 1 h i 1 2 j s n s e i 1 2 j u i 1 2 j s n 1 h i 1 2 j s n 1 δ y s e i j 1 2 v i j 1 2 s n 1 h i j 1 2 s n s e i j 1 2 v i j 1 2 s n 1 h i j 1 2 s n 0 where v η i j denotes the volume per unit cell area of the clone considered η i j is overloaded for notational simplicity e i 1 2 j e i 1 2 j e i j 1 2 and e i j 1 2 represent a set of sub clone edges connecting the clone considered to sub clones of neighboring host cells along the east west north and south edge of the clone respectively the superscript s in u and h is used simply to denote that they are a quality associated with the clone edges the approximate solution η n 1 u n 1 v n 1 can be obtained either by i solving the system of nonlinear eqs 15 13 and 14 simultaneously or by ii solving a reduced system of equations arising from the substitution of 13 and 14 into 15 casulli 2009 such a reduced system of nonlinear algebraic equations in a more compact form is given by 16 v η n 1 t η n 1 b where η n 1 is a vector of the solution at the next time level t is the matrix resulting from the substitution v is the vector of the water volume and b is the known right hand side vector note that t is symmetric with positive diagonal entries and negative off diagonal entries the system of eq 16 is mildly nonlinear and is solved with the newton raphson method to obtain η n 1 subsequently the velocities at the time level n 1 are computed in a back substitution step from 13 and 14 with the now known η n 1 subsequently the approach described in section 2 4 is carried out more precisely in a scenario of overtopping the weir formula 1 is used to approximate discharges between sub clones to update the surface elevations of sub clones which in turn are employed in informing whether sub clone merging is to be conducted the resulting surface elevation is subsequently used in updating the set of active cell clones and edge clones prior to the next integration step the set includes any clone having at least one wet edge and wet clone edge the wet dry state of an edge cell is determined based on an edge surface elevation the edge surface elevation is obtained by taking the mean of the surface elevation of the pair of cells to which it connects other approaches such as upwinding can also be employed if the computed surface elevation is greater than maximum pixel depth over the clone edge this edge is wet otherwise it is regarded as dry it is important to note that the number of cell clones and edge clones can differ from time step to time step due to the possibility of merging and splitting of clones sub clones further explanation of the numerical implementation is provided in appendix a 4 tests and validation in this section the ability of the present algorithm is demonstrated through a set of test cases ranging from idealized test cases to more complex and realistic settings boundary conditions are used to drive a flooding cycle in all of the test cases atmospheric pressure and wind stress are not considered in the following simulations because those are not expected to play a significant role in any conclusions made viscosity μ t is neglected due to relatively coarse gridding the manning formula is used to determine a bottom drag coefficient 17 c f g n 2 h 1 3 where n denotes the manning roughness coefficient the manning roughness coefficient and magnitude of gravitational acceleration are set to n 0 02 s m 1 3 and g 9 81 m s 2 for all simulations tests here are divided into three main groups 1 channel and block systems 2 meandering river and bays 3 flow in buttermilk bay a complex bay channel system with measured lidar bathymetry in all numerical tests the following water surface elevation boundary condition is imposed on the inlet of the computational domain 18 η x 0 t a 0 tanh 2 t t r cos ω t where a 0 denotes the forcing amplitude and t r is the ramping time for the following simulations the value of tidal frequency is set to ω 1 4544 10 4 s 1 and the amplitude of the tide to a 0 2 m for the buttermilk bay test case this amplitude is unrealistically large and is used to demonstrate the robustness of the subgrid model the tidal like boundary condition is imposed gradually with a ramp up time of t r 0 25 day unless otherwise indicated the maximum and minimum surface elevations used in cloning are set to η max a o ϵ and η min a o ϵ with ϵ 0 2 m 4 1 channel and block systems 4 2 permanently disconnected configurations a first test of the cell and edge clone methodology is performed in an idealized channel with an interior blockage two such geometric configurations are depicted in fig 8 these systems consist of a channel and a block that splits the channel into two disconnected parts the surface elevation boundary condition 18 is imposed on the southern part of the computational domain as a result the water surface elevation should remain constant for the entire simulation in the secondary channel three simulations with varying grid sizes are performed the first is a high resolution simulation with δ x δ y 2 m where this high resolution case is taken as the ground truth reference solution the coarse grid simulations use δ x δ y 256 m and are run with and without cell and edge clones implementation fig 8 includes grid lines of the coarse grid simulation it can be observed that in both configurations the coarse cell with the block has two wet edges as the upscaled swe equations consider subgrid connectivity an artificial cross flow will be seen in the secondary channel to remove this artificial cross flow the cell with the barrier is cloned twice as there are two groups of connected pixels this host cell can have two different surface elevations cells with blocks and their corresponding cell clones are depicted in fig 9 the time series of water surface elevation in the channel connected to the inlet at station 1 x 128 m and y 200 m and in the secondary channel station 2 x 128 m and y 1000 m of channel configuration a and in the channel connected to the inlet at station 1 x 128 m and y 200 m and in the secondary channel 2 x 600 m and y 650 m of channel configuration b are plotted in fig 10 for the three simulations b and d of this figure plot the surface elevation at the location in front of the barrier as expected the high resolution produces a constant water surface elevation in the portion of channel behind the block however the time series of water surface elevation of the coarse grid calculation the green line is different from the reference solution where the surface elevation in the range of 2 m to 2 m occurs due to an artificial cross flow inside the cell with the barrier after performing the cell clone procedure for this block cell the artificial cross flow in the coarse grid is removed and the time series of surface elevation the black dashed line is constant 4 2 1 inundated configurations this next test case is similar to the configuration a of channel block system in the previous example except for the height of the block in this test the height of the block enables surface elevation connectivity between two channels as the flow rises above a certain surface elevation fig 11 we use this test case to demonstrate the ability of this algorithm to handle merging and separation of sub clones for the first test case the height of the block is b 0 m which is equal to the initial surface elevation of the secondary channel according to the reference solution when the water surface elevation is less than 0 m the channel splits into two disconnected parts thus the block cell contains two sub clones at the surface elevation of η m i n η 0 and no sub clones at the surface elevation of 0 η η m a x the block cell is cloned two times based on the connected pixels at the connectivity surface elevation η 0 shown in fig 12 therefore two parts of the channel are disconnected and there should be no cross flow from the inlet to the second part of the channel when the water surface elevation reaches η 0 the first time step then the original cell with one surface elevation is considered instead of two cell clones during draining when water surface elevation reaches zero the block cell splits into two cell clones with the surface elevation of each clone being that of the block cell the time series of water surface elevation at the end of the secondary channel x 128 m y 1050 m is shown in fig 13 a for two different grid sizes δ x δ y 2 m and 256 m without clone implementation the two parts of the channel are connected in the coarse grid calculation resulting in artificial cross flows with cell clone implementation the wetting drying state of the coarse grid solution is similar to the high resolution data in a second example the height of the block is set to 1 m the initial surface elevation of the secondary channel is set to 0 m thus initially the primary and secondary channels are disconnected and and become connected disconnected as the surface elevation of primary channel raises above recedes below the blockage height in the coarse grid calculation with clones the connectivity surface elevation in the 1 3 th host cell is equal to the blockage height the splitting and merging of sub clones occurs at this height note that when the water surface elevation of the source sub clone the clone in front of the blockage reaches 1 m for the first time the water surface elevation of the receiving cell is 0 m this large difference of water surface elevation prevents merging sub clones because the average water surface elevation of the source and receiver sub clones will be less than the height of blockage for the first cycle the present approach applies the overflow formula to connect the receiver sub clone to the source sub clone until the water surface elevation of the receiving clone reaches the height of blockage the time series of the surface elevation recorded at the end of channel x 128 m y 1050 m are shown in fig 13b for the reference solution and the subgrid model without cloning and with the proposed cloning approach for the high resolution case it can be seen that the water reaches the secondary channel at an elevation of 1 95 m during the first tidal cycle then wetting drying occurs at the elevation of 1 m as expected with our proposed technique the result from the subgrid model with cloning and sub cloning is in good agreement with the high resolution simulation while it is not for the subgrid model without clones it is noted that in the first cycle there is a small difference between the high resolution time series of surface elevation and sub cloning technique this mismatch in the surface elevation occurs because of the overflow formula 4 3 meandering river and bays an idealized setup reflecting a meandering river with two blocks in the middle as well as three artificial lakes is shown in fig 14 the largest lake is connected to the meandering channel two narrow barriers can be seen in the middle of the river the western barrier has an elevation of 0 5 m with eastern barrier elevation 0 5 m a tidal like boundary condition see 18 is imposed on the southern part of the computational domain the amplitude of the tide is a 0 2 m and the tidal period is 12 hours four different simulations are conducted a high resolution simulation with grid size δ x δ y 8 m is used as the reference solution three subgrid simulations on the coarse grid of δ x δ y 1000 m are considered they consist of i subgrid level 0 ii subgrid level 0 with casulli s cell and edge clones casulli 2019 and iii our sub clones approach as a reminder the maximum and minimum surface elevations are set to η max 2 2 m and η min 2 2 m fig 14 shows the coarse grid with three marked cells black star symbol these cells include a disjoint group of pixels at the maximum surface elevation the cell clones associated with each host cell marked are depicted in fig 15 marked cell 1 and 3 each have three cell clones and marked cell 2 has two cell clones to find the sub clone of a cell clone the number of disjoint connected pixels is checked for each cell clone at a number of surface elevation levels this process starts at the maximum surface elevation and continues until the minimum surface elevation with a decremental step of δ η 0 1 m for the cell clones of the marked host cells 1 and 3 there is only one group of connected pixels at all levels therefore there are no sub clones in these cell clones for the cell clone 1 in the marked host cell 2 the number of disjoint groups of pixels is different as the surface elevations decrease due to the presence of barriers in this cell clone see fig 15 for depiction for this simulation three ranges of water surface elevations are considered in defining clones of the marked host cell 2 when the water surface elevation is η 0 5 cell clones are used for the system in the range of 0 5 η 0 5 sub clones a and b see fig 16 are considered instead of cell clone 1 for water surface elevations of η 0 5 sub clones a c and d represent the cell clone 1 in this simulation the initial condition is set to 0 m thus for the first cycle of flooding sub clone b is connected to sub clone a through an overflow formula three stations are marked by white circles in fig 14 the time series of surface elevation at these locations from all the runs conducted are plotted in fig 17 a b and c for station 3 see fig 17 the level 0 subgrid line in green predicts wetting drying in the small lake which is not physically correct as it is not connected to the inlet the original cell clone approach and the sub clone approach proposed yield identical results both remove this artificial cross flow from the coarse grid calculations fig 17c shows the time series at station 1 located in the middle of two barriers the wetting drying occurs at elevations η 0 4 m for the reference solution it can be observed that the original cell clone approach behaves identically to the level 0 solution the reason is that barriers are determined at the maximum surface elevation in the original cell clone approach however the barriers that appear in the lower elevation are part of the continuous path of pixels in the cell clone thus these barrier s effects cannot be captured by the original cell clone approach and the artificial cross flow still exists in the cell clone s approach it is noted that due to the static nature of the original approach this approach would permanently divide the flow at the maximum surface elevation by breaking down the cell clone into sub clones and connecting and disconnecting the sub clones the artificial cross flow can be further removed thus yielding surface elevations similar to the reference solution fig 17 b shows the time series at station 2 situated in the middle of the largest lake because the elevation of the barrier is 0 5 m and the initial condition of the water surface elevation is 0 m the overflow formula is used to connect sub clone c to sub clone d see fig 16 thus wetting drying happens at the elevation of 0 5 m and sub clones are merged and split at this elevation the wetting drying state with the sub clone approach is similar to the high resolution run the coarse grid and static original cell clone runs predict wetting drying occurs at elevations less than 0 5 m which is physically incorrect due to an artificial cross flow from the results shown above it can be concluded that the cell clone technique removes the artificial cross flow in the small lakes however due to its static nature the approach cannot accurately capture the effects of two subgrid barriers inside the marked cell 2 as they are submerged at the maximum surface elevation to capture the effect of these barriers the sub clone technique is applied to the computational domain as a result marked cell 2 is divided into sub clones and these sub clones are merged and split at different surface elevations to capture wetting drying similar to the high resolution 4 4 complex test buttermilk bay in this section a more realistic computational domain is considered to simulate flooding cycles in buttermilk bay massachusetts usa 41 760n 70 620w see fig 18 the geometry of buttermilk bay includes two narrow channels and two bays which make it challenging to obtain accurate simulations using traditional techniques and a coarse grid the computational domain which has a size of 3854 m 3854 m is shown in the red box in fig 18 the driving force for this simulation is a tidal like elevation boundary see eq 18 which is imposed along the south part of the red box in fig 18 lidar data in the universal transverse mercator coordinates with 1 m resolution is used to describe the bathymetry in all subgrid calculations the fd fv subgrid solution based on casulli s method casulli 2009 with resolution δ x δ y 4 m is used as our reference solution kennedy et al kennedy et al 2019 used this test problem to evaluate the performance of the subgrid model with different closures therein they showed the accuracy of the subgrid model for different grid sizes kennedy et al 2019 and also connectivity issues when the computational grids are very coarse in this study we focus on a coarsest grid calculation of δ x δ y 256 m at this resolution the subgrid results suffer from the connectivity issues we aim to resolve note that we did not consider cell clones and isolated sub clones with an active area of less than 10 of the coarse grid the computational grid and three cells with connectivity issues marked by a blue star symbol are drawn in fig 19 a fig 20 shows the wet dry areas for the marked cell 1 at η m a x red is dry and blue is wet two disjoint groups of pixels exist in this cell the group on the east side of the cell is not connected to the group on the west side due to a barrier which is significantly smaller than the cell this cell is cloned two times based on a group of connected pixels to restrict the artificial cross flow from the west to the east part of the cell and vice versa there are no sub clones for these cell clones fig 21 shows the wet dry area at the maximum surface elevation for marked cell 3 a close inspection reveals three disjoint groups of connected pixels two of these groups intersect the west edge of the cell and one of them intersects the south edge of the cell these groups are connected in the subgrid model without cloning in the clone cell approach this cell is cloned three times each of them consisting of a connected path of pixels that restrain the artificial cross flow between these disconnected wet areas so there is no sub clone for these cell clones fig 19 shows station 3 located in queen sewell pond this area has a slightly higher elevation than the two main bays and the barrier in marked cell 3 prevents the cross flow to this area fig 19 shows station 2 located in the area between the little buttermilk bay and queen sewell pond that has a relatively higher elevation than the two main bays but lower than queen sewell pond however it may still be reached by high water elevations marked cell 2 shown in fig 19 covers the area between the little buttermilk bay and queen sewell pond fig 22 shows marked cell 2 as well as wet dry areas at various water level elevations at the surface elevation of η m a x there is one group of connected pixels at the southwest of the cell and one group of connected pixels at the northeast of the cell connected by a narrow channel at the surface elevation of η 1 m the wet proportion of the channel shrinks and two groups of connected pixels can be discerned as the surface elevation reduces further to η 0 m the group of connected pixels in the northeastern part becomes dry at fig 22d the wet dry areas are shown at η 0 98 m this is the point at which the wet areas separate into two disjoint groups when the surface elevation is η 0 98 water can connect between the southwest to the northeast and vice versa thus η 0 98 m is a connectivity surface elevation when the water surface elevation is less than η 0 98 m this cell fig 22d splits into two sub clones when the water surface elevation of this cell reaches the elevation of η 0 98 m in the first flooding cycle an overflow formula is used to connect the source sub clone and the receiver sub clone later the source sub clone and the receiver sub clone merge based on the connectivity surface elevation fig 23 shows the surface elevation of the wet area for all considered models during the rising tide period t 0 792 0 872 1 000 day fig 23a c show the results of the level 0 subgrid solution level 0 subgrid with sub clones in the computational domain the reference solution computed on 4 m 4 m grid respectively at t 1 day there are additional wet areas in queen sewell pond see red box in fig 23a at t 1 day and the west part of main bay see blue box in fig 23a at t 1 day in the level 0 subgrid solution in comparison to the reference solution these additional wet areas result from blocks in the coarse grid are treated as connected areas this artificial flow can be removed by cloning cell sufficiently to resolve the effect of barriers that are not captured by the subgrid model it can be clearly observed from fig 23b that the subgrid solution with the sub clone treatment is free of the artificial wet areas seen in fig 23a when the subgrid alone is used the sub clone subgrid solution indeed is in good agreement with the reference solution in addition a small wet area can be seen in fig 23c at the time level t 0 792 and 0 872 day see north west of red boxes at these time levels this area cannot be seen in the coarse grid simulation in fig 23 c this wet area is captured due to merging sub clones marked cell 2 at the surface elevation of 0 98 m using the overflow formula by comparing red boxes and blue boxes of fig 23b c at three time levels it can be seen that the prediction of surface elevation in the subgrid calculation the cloning technique in the computational domain of the coarse grid matches quite well with the high resolution solution in terms of capturing wetting drying areas in fig 24 a the time series of surface elevation is plotted at station 3 for the reference calculation and subgrid calculations when the cell clone approach is applied the time series of surface elevation is identical to the high resolution fig 24b shows the time series of surface elevation at station 1 note that this station is in the west part of marked cell 2 i e in front of a small barrier see fig 19 since marked cell 2 splits into two cell clones the additional water flow is not permitted to go through the barrier as a result the effect of the barrier which is smaller than the computational grid can be captured in the subgrid model the time series of surface elevation for station 2 is depicted in fig 24c note that this station is located within marked cell 2 see fig 19 as illustrated in fig 22 disconnected groups of wet areas divided by subgrid blocking structured emerge at the height of η 0 98 m see fig 22 if water elevation is less than the connectivity surface elevation this cell splits into two sub clones when the water surface elevation reaches this height only one group of connected pixels is considered see fig 22 a however there is an exception during the first tidal cycle due to a relatively significant difference of surface elevations between the source clone and the receiver clone which prevents one cell with a single value of surface elevation to reduce the large difference the overflow formula is used to connect the source clone to the receiver clone until the surface elevation of the receiving cell clone reaches the connectivity surface elevation η h 0 98 m afterward when the water surface elevation reduces to a value lower than η h 0 98 m two sub clones with two different surface elevations are defined otherwise the marked cell with one surface elevation which is equal to the average surface elevation of receiving clone and host clone is considered fig 24c shows that wetting drying similar to the reference solution can be captured with a coarse grid solution with the inclusion of cell and edge clones 5 discussion and conclusions using subgrid corrections determined by an averaging process provides increased accuracy in complex shore regions when applying on lower resolution simulations kennedy et al 2019 however using an excessively coarse grid can lead to artificial cross flows between disconnected areas due to barriers that are smaller than the grid size although the cell clone approach presented by casulli 2019 removed the artificial cross flow at the maximum surface elevation the artificial cross flows may exist at the lower surface elevations as a result of the submerged barriers in this work we extend the cell clone approach casulli 2019 by breaking the cell clone down into sub clones to remove cross flow when barriers within the coarse grids are submerged splitting and merging sub clones allows for a more flexible implementation of subgrid models to represent the effect of smaller scale barriers that are submerged and emerged at different water surface elevations furthermore it naturally extends cartesian grids to restore the high resolution bathymetric data without sampling or interpolating this algorithm in principle is applicable to any flow region with a complex geometry that may include urban areas and marshland to produce accurate simulations of inundations during flood events our proposed algorithm is implemented in an existing subgrid model kennedy et al 2019 and tested through a variety of tests ranging from simple channel block systems to a sophisticated natural system buttermilk bay the model results show that a coarse grid model when implementing our approach has the ability to capture wetting drying behaviors similar to those obtained from high resolution simulations without requiring further mesh refinement as explained in section 3 3 we solve a reduced system of nonlinear algebraic equations eq 16 for the surface elevations which is mildly nonlinear using the newton raphson method solving the system of equations eq 16 requires us to compute the volume and the wet area of coarse cells for each surface elevation here the volume and the wet area of the cells are calculated directly from the high resolution bathymetric data for the large grid sizes these calculations can be very expensive computationally due to the large amount of high resolution bathymetric data inside a coarse grid to reduce the computational cost a pre storage lookup table can be employed to store the volume and the wet area of the cells as a function of surface elevations lookup tables can be built once and for all cells as a pre processing step currently we have not implemented the lookup tables for the cell clone and sub clone approach however for the subgrid model we experienced 20 to 30 higher computing time than the standard calculations of the same grid resolutions all of the presented test cases were conducted on relatively small cartesian grids using a custom written code to consider more extreme events such as hurricane induced storm surge much larger grids and parallelization of the algorithm will be required in principle the method introduced here can be applied to curvilinear polar elliptical and hyperbolic telescoping mesh grids as well as any irregular mesh grids future work will focus on incorporating this method into widely used and available models that have a more significant impact on the field author agreement statement i the undersigned declare that this manuscript is original has not been published before and is not currently being considered for publication elsewhere i confirm that the manuscript has been read and approved by all named authors and that there are no other persons who satisfied the criteria for authorship but are not listed i further confirm that the order of authors listed in the manuscript has been approved by all of us declaration of competing interest conflict of interest and authorship conformation form please check the following as appropriate all authors have participated in a conception and design or analysis and interpretation of the data b drafting the article or revising it critically for important intellectual content and c approval of the final version this manuscript has not been submitted to nor is under review at another journal or other publishing venue the authors have no affiliation with any organization with a direct or indirect financial interest in the subject matter discussed in the manuscript acknowlgedgments work here was funded under national science foundation usa grants icer 1664040 and 1664037 and through a grant from the joint airborne lidar bathymetry technical center of expertise jalbtcx usa their support is gratefully acknowledged appendix a numerical implementation a fortran based computer code originally written for an implementation of various forms of subgrid models and variants of discretization schemes presented in kennedy et al 2019 is modified to handle the clone sub clone approach in terms of its solution algorithm the two main tasks of the code involve i computing subgrid related and other necessary quantities e g volume wet area fraction wet cross section grid averaged total water depth wet dry status of edges and cells from a given surface elevation solution and ii solving the discretized form of the momentum eqs 13 14 for the edge centered u and v velocity components and solving the discretized form of the mass eq 16 for a solution vector of cell centered surface elevation η n 1 the former task is accomplished through the use of fortran objects of derived data type encapsulating data associated with subgrid bathymetry to be described in brief below and subroutines functions computing subgrid related quantities requested from these objects and a given surface solution vector for the latter task we briefly recall below solution procedures in the original code as the clone extends such procedures in the original code for a grid of n x n y cells the latter task uses one dimensional arrays denoted as a 1 u n u i j n i 1 n x 1 j 1 n y t v n v i j n i 1 n x j 1 n y 1 t η n η i j n i 1 n x j 1 n y t to store the edge perpendicular u v velocities at the edge centered vertical and horizontal edges and surface elevation η at the cell center respectively stemming from the use of fortran ordering of entries in these 1d arrays is done by mapping an index pair i j to a single index in a column major manner once the surface elevation η n 1 is known solving the discretized form of the momentum equations is done in a node by node fashion this step is computationally efficient as 13 14 are computed only at velocity nodes associated with wet edges while the value at nodes associated with dry edges is set to zero i e no normal flow is allowed for the mass equation the reduced system of nonlinear algebraic eq 16 is solved by the newton raphson method which requires solution of a linear system of equations associated with the jacobian of the system j p t where p v η η is a diagonal matrix whose entries are the values of wet area of cells such a linear system is solved by the bi conjugate gradient stabilized solver saad 1994 where the matrix t is stored in an ellpack like format mainly for an ease of updating its non zeros entries especially when the wet dry pattern changes non zero entries in the row associated with the index pair i j of the matrix t are those associated with the surface elevation of the cell i j and its wet neighbor cells for the full gird no cell clone t has at most five nonzero entries in each row the dimension of the reduced system of equations is n w n w where n w is the number of cells having at least one wet edge for a problem with wetting drying n w is time dependent to keep the code simple instead of strictly dealing with the n w n w system whose dimension may change with time we consider an equivalent n x 1 n y 1 system of equations in which the unknown solution vector includes all the cell centered surface elevation in this system an equation associated with a cell having no wet edge inactive cell is replaced by c η i j n 1 c η i j n i e no change in the value of surface elevation from the previous time step where c is a constant used merely to obtain the jacobin matrix with a properly scaled condition number although there is computational expense associated with the inactive cells in this simple approach such expense is not substantial especially when a coarse grid is considered in a calculation to accommodate the cell clone and sub clone approach which introduce additional dofs in each host cell and host edge we use objects that pre store information of clones and all their sub clones within the range of η min to η max see section 2 3 for the procedure to identify sub clones all clones and sub clones data in the description below clones refer to both clones and sub clone of a host cell are stored in a derived data type with among several others the following data fields table type table type raster lookup table nclone total number of clones clones sub clones tabdat 1 nclone b table of bathymetric data or lookup table tabdat 1 nclone b dim 1 2 dimension of table tabdat i b tabdat 1 nlcone bmin max 1 3 min max avg of bathymetric depth of clones clone label 1 nclone 1 3 clone labels see section 2 3 eta map 1 nclone element indices of clones in a surface elevation solution 1d array η note that in the above description a b indicates that b is a member of a derived data a these data are designed to accommodate two approaches of computing subgrid related quantities a direct approach through raster data of a cell tabdat i b stores portion of dem pixel in the clone i and an approach using lookup tables which store the subgrid related quantities at different finite levels of surface elevation in a table before hand for efficiency in the look up table approach the members of tabdat i store the content of lookup tables specially b dim 1 is the number of surface elevation levels b dim 2 is the number of pre stored subgrid qualities b 1 b dim 1 j stores the j th subgrid related quantity at different levels of surface elevation from bmin max 1 to bmin max 2 with a uniform incremental step of bmin max 2 bmin max 1 b dim 1 note that the direct approach is simple and determines the subgrid quantities exactly for a given surface elevation value however it can be computationally expensive with a cost proportional to the number of pixels the lookup table is very efficient as it requires much fewer operations i e one operation to locate the interval to which the given surface elevation belongs and a few operations for interpolation this approach requires pre computing every quantity needed and in general does not yield an exact value which has a consequence in solving 16 from our experience computing the wet surface area p v η η must be done numerically using a finite difference approximation to achieve convergence in the newton raphson method note that eta map storing element indices of clones in the solution vector of surface elevation is used for fetching relevant values to clones of the host cell from a given surface elevation vector in solving the discretized form the solution vectors for the surface elevations are enlarged so that their dimensions are equal to the number of all clones and sub clones of all n x n y host cells the indexing order in the enlarged one dimensional array is done in a cell by cell order i e surface elevation solutions of all clones associated with the i j th host cell followed by those of the i 1 j th host cell in a short notation a 2 η n η i j n i 1 n x 1 j 1 t where η i j n η n ω i j r s t t denotes a surface elevation solution vector of all clones clones and sub clones in the i j host cell r s t correspond to the clone number sub clone level and sub clone number as described in section 2 3 enlargement of the velocity solution vectors are done in a similar way note that active clones in the computational domain can change due to merging and splitting sub clones as done in the full grid case when solving 16 we solve the systems written for all surface elevation dofs and appropriately modify equations associated with the inactive clones and sub clones the algorithm of computation is summarized as follows 
290,subgrid modeling to account for unresolved topography within the context of shallow water equations relies on the use of coarse grids for computational efficiency however excessively coarse grids can lead to artificial cross flows between hydrologically disconnected areas separated by physical barriers smaller than the grid size an approach based on introducing cell and edge clones consisting of connected groups of pixels in each cell is able to systematically remove such artificial cross flows such an approach considers that the subgrid barriers permanently divide flow among clones and effectively restrict flow to a predetermined path in this work a simple algorithm along with the use of an overtopping formula is proposed to extend the clone approach to a scenario in which clones are allowed to be further split and merged as needed depending on the surface elevation during a given runtime the algorithm is intended for accommodating the possibility of the subgrid barriers being inundated and no longer dividing the flow during an extreme event the performance of the proposed algorithm is demonstrated through a series of idealized and more realistic test cases showing considerable improvements over existing methodologies keywords subgrid model storm surge surface connectivity numerical method mathematical modelling 1 introduction accurate and efficient storm surge prediction is indispensable to prevent destruction of life and property along coastlines storm surge modeling is typically based on numerical solution of the depth averaged shallow water equations swe broadly speaking two different strategic approaches have been adopted in modern storm surge models based on their intended purposes the first is a relatively low resolution ensemble forecast which relies on using a potentially large ensemble of model runs on relatively coarse computational grids the benefit of such an approach is that predictions of storm surge before a tropical cyclone makes landfall zachry et al 2015 can be conducted quickly accounting for uncertainty in a storm s track and intensity however the use of a coarse resolution comes at a cost stemming from model errors caused intrinsically by inadequate grid resolution such as unresolved bathymetry connectivity and unknown roughness from smaller scales the second category of modeling approaches is to use high resolution simulations which aim to explicitly resolve as many scales of interest as possible such models can be very accurate dietrich et al 2017 luettich and westerink 2004 however they come with a high computational cost and require a large number of cpu cores to complete a run in a reasonably timely manner hope et al 2013 this limits their applicability with respect to ensemble forecast applications thus choosing between these two options is a trade off between computational time and accuracy high resolution models are more accurate but come with greater computational cost while low resolution models are fast to execute but less accurate kerr et al 2013 a promising intermediate path to achieve models with both accuracy and low cost is through the use of subgrid models which have recently become an active area of research in the fields focusing on flow over tidal flats and wetlands urban flooding and storm surge applications kennedy et al 2019 wu et al 2016 sanders et al 2008 sehili et al 2014 stelling 2012 wang et al 2014 note that while there is a rich history of subgrid methods in different aspects of fluid flow and transport modeling e g turbulent flow porous media flow multi phase flow different systems are needed for application to coastal models with unresolved topography to this end if higher resolution topographic and bathymetric information is available and can be directly resolved in computations it may be more practical to account for its effect with a subgrid model over the last decade the resolution of available topographic data of many coastal areas and to lesser extent bathymetric data has increasingly become far finer than the level of resolution affordable for any large scale storm surge model danielson et al 2018 to best exploit the full potential of this data it may be useful for models to include subgrid corrections conceptually subgrid models are constructed through coarsened properties such as water levels and velocities combined with integral functions of high resolution ground elevations friction characteristics and any other information that might be available early subgrid models were proposed by roig 1989 king 2001 and defina et al 1994 defina 2000 where the idea of an artificial porosity which is a function of the free surface elevation was introduced to account for partially wet areas the porosity function is used in the former in the context of a finite element implementation and the latter in deriving a set of governing equations accounting for partially wet dry areas to deal with the lack of high resolution topographical data defina 2000 introduced an explicit empirical relationship between porosity and depth based on the assumption that bottom elevations are distributed according to a given probability density function sanders et al 2008 applied volumetric and areal porosities in an integral form of the shallow water equations and discretized them with a finite volume framework to study flooding in urban areas they considered the effect of buildings on the flow using a drag formulation and a binary density function that equals zero when corresponding to a building and one otherwise however this model did not account for building interior inundation and is highly sensitive to the mesh used guinot 2017 guinot et al 2017 improved this integral porosity model by strategically creating a mesh on the computational domain such that cell edges intersect with a water blocking structures without this the effects of blocking structures do not explicitly appear in this porosity formulation while this application appears suitable for urban areas it is restricted in more natural settings particularly in areas with strong spatial heterogeneity casulli 2009 proposed a semi implicit finite volume finite difference approach on a staggered c grid with a parameter free subgrid wetting drying algorithm that uses the porosity function to ensure the positivity of the water height and to account for partial water volume in partially wet cells the resulting discrete equations are mildly nonlinear due to the nonlinear dependency of the porosity function on the surface elevation in the partially wet cells the proposed algorithm can be used on relatively coarse grids while it incorporates high resolution bathymetric data at the subgrid level casulli and stelling 2011 and sehili et al 2014 apply this approach to study flow in venice lagoon and the elbe river respectively and report that this approach improves model performance with minimal additional computational cost platzek et al 2016 combined the semi implicit method of casulli 2009 with a hierarchical grid approach to resolve small scale topographical features with the goal of more accurately accounting for regions with significant local energy losses in which the authors posit that when such losses occur the subgrid method may not be adequate and a higher grid resolution is required to improve model performance accurately parameterizing bottom drag effects is another essential aspect in the development of subgrid models that has received attention in defina 2000 d alpaos and defina 2007 the assumption of a constant friction slope was used to derive a formula for bottom stresses accounting for subgrid bathymetry casas et al 2010 presented a method for subgrid roughness parameterization based on turbulence mixing layer theory viero and valipour 2017 introduced anisotropic bottom roughness for some special cases where models were able to preserve mesh independence for relatively simple benchmark cases made up of structures with regular shapes and patterns based on casulli s subgrid formulation volp et al 2013 developed a finite volume subgrid model on the staggered c grid that employs an analytical subgrid velocity of a simplified canonical flow a channel flow with a uniform flow and constant friction slope in subgrid corrections of bottom friction and advection terms the aforementioned corrections improved model performance when there is a large variability of water depth in a coarse grid more recently kennedy et al 2019 developed an upscaled form of the 2d shallow water equations through the use of formal averaging methods the upscaled system of equations are structurally similar to the standard shallow water equations but have additional terms related to integral properties of the fine scale topography and flow they identified different levels of closures of varying complexity a number of subgrid approaches can be recovered through certain sets of closures their model provided a platform to implement subgrid corrections of bottom stresses advection and surface gradient terms the corrections to the gradient of mean water surface elevation are indeed less obvious and are intended for situations where flow characteristics change strongly within an averaging volume while the aforementioned advances have led to great improvements accounting for subgrid connectivity continues to present a substantial challenge due to an assumption of subgrid connectedness for given coarse flow variables fig 1 shows a simple example of subgrid connectedness when the water surface elevations on either side of a barrier are independent quantities one water surface elevation is not sufficient to represent the system in the coarse grid however if the surface elevation is high enough to inundate the barrier a single variable may be enough to represent the water surface elevation wu et al 2016 who adopted a pre storage of necessary quantities to increase computational efficiency note in their numerical simulation of flow in salt marshes that the level of grid coarsening is limited by bathymetric features mainly due to the assumptions of a constant surface elevation within a coarse cell it is suggested that any coarse grid used should be able to resolve general topographical features such as major channels and blocks platzek et al 2016 suggested a hierarchical grid approach utilizing a multigrid concept to resolve small bathymetric features but this comes with increased computational costs and their approach was intended for quasi steady state problems to correct surface connectivity issues hodges 2015 developed an automatic edge blocking approach that represents features along cartesian coarse cell edges the approach has been used to study many aspects of salt marshes li and hodges 2019a 2019b however inaccurate approximations of water surface elevation remain unavoidable in coarse grid settings where edge blocking prevents flow within the coarse cell with the block which depending on the problem at hand can be detrimental to model predictions recently casulli 2019 introduced a cell clone approach to remove an artificial cross flow between disconnected areas within a cell the approach takes advantage of the nature of the staggered c grid in that the surface elevation is placed at the cell center and flow velocities that connect two adjacent cells are placed at the edge center to represent flow paths each cell and edge are then cloned as many times as necessary based on disjoint groups of connected areas at a given predetermined surface elevation the surface elevation and velocity among the cell and edge clones of the host cell and host edge are then permitted to have different values essentially allowing for the possibility of having more degrees of freedom on a single cell and edge this approach was used to study tidal flow in sacramento san joaquin delta area where even relatively coarse grids showed good agreement with high resolution simulations in this approach by construction cell clones of a host cell are permanently disconnected from each other during a simulation without modification the approach does not permit an inundation of subgrid blocking features inside the coarse grid a scenario likely encountered during extreme events such as storm surge casulli 2019 suggests that this issue can be overcome by using a properly formulated weir formula to re establish the connection between two adjacent cell clones while the weir formula permits re establishment of the connection it is potentially insufficient when a subgrid barrier is fully submerged additionally the original work of casulli does not consider a possible scenario in which flow within each clone becomes physically separated by subgrid barriers as the water level recedes i e subgrid connectivity is assumed within the clone in this study we propose an extension to casulli s approach to overcome these limitations in 2 we first summarize casulli s original clone method casulli 2019 subsequently we describe a simple approach that is based on further cloning of a cell clone into sub clones that may or may not be connected depending on the value of the current surface elevation sub clones are allowed to split and merge in order to capture the effect of small barriers that are submerged or emerged when the water surface elevation rises or recedes in 3 we describe implementation of the proposed approach in the upscaled swe model of kennedy et al 2019 the performance of the proposed algorithm to deal with flooding and draining is demonstrated in 4 using test problems of increasing complexity and a real setting conclusions from the study are drawn in 5 2 methodology as standard subgrid approaches assume connectivity throughout a cell excessive coarsening while reducing computational cost substantially can lead to flow connectivity problems where features that should not be connected in reality are still connected numerically causing inaccurate estimates of water surface elevation in section 2 1 2 2 we describe casulli s method casulli 2019 in which each coarse grid is cloned based on connected pixels to remove artificial cross flows building on this we propose a method that splits a cell clone into sub clones where barriers inside a cell clone can emerge at set water surface elevation in section 2 4 a simple method is presented to connect the sub clones of a clone 2 1 computational grid and pixels here we adopt the terminology used in casulli 2019 more specifically we consider a raster based digital elevation model dem with uniform resolution δ and parameter b defined over the entire grid this might represent the bathymetric depth from still water used to define a computational domain we denote each single point as a pixel a grid cell used as the basis for a computational model is made up of a group of such pixels for the highest possible accuracy a numerical model should account for the information provided by each pixel indeed a grid cell can be as small as an individual pixel or as large as the entire computational domain to maximize efficiency when using a subgrid model the computational grid should be allowed to be much coarser than an individual pixel but still incorporate as much information from each pixel as possible let us define the size of grid cell as p q pixels of size δ by partitioning the pixels of a computational domain into m n subarrays representing host cells of size δ x p δ and δ y q δ a coarse grid is obtained in order to define pixels on a cell edge the minimum pixel values of two adjacent cells are set as an edge pixel thus each pair of two cells has either p or q edge pixels for efficiency pixels that are not likely to be flooded i e pixels where elevation values are larger than the maximum possible surge are marked as inactive within the computational domain a cell is marked as inactive if it contains no active pixel the same is done for cell edges an active cell edge has at least one active edge pixel otherwise the cell edge is marked as inactive 2 2 cell and edge clones to begin we define a reasonable range of surface elevations η min η η max based on extreme inundation and receding water levels pixels that are not likely to be flooded are marked as inactive b η max the remaining pixels are called active pixels if there is a continuous path of active pixels between any two pixels these two pixels are called connected pixels within a grid cell there may be multiple groups of connected pixels that are separated from one other similarly edge pixels that are not likely to be flooded b edge η max are marked as inactive edge pixels each cell edge that contains one or more active pixels is an active edge otherwise it is an inactive edge at the maximum surface elevation η max the host cell is cloned a sufficient number of times based on the number of separate groups of connected pixels each clone of a host cell only contains one group of connected pixels the clones of a host cell are assumed not connected with each other under any extreme situation to fully achieve this condition η max should be sufficiently high in practice a reasonable value of η max is the maximum probable surge height for the area of interest based on the historical surge event each clone of a host cell has a constant water surface elevation but this can be different among the clones within the same host cell similarly a host edge pairing two host cells is cloned a sufficient number of times where each edge clone is a group of edge pixels shared by two clones of such neighboring cells these edge clones provide the connectivity information between each host cell and its neighbours each edge clone of a host edge is assumed to have a constant discrete velocity perpendicular to the edge either u or v but this velocity can be different among edge clones of the same host edge therefore the cell and edge clone approach provides more degrees of freedom for the host cell that leads to a more accurate representation within the coarse grid where small scale structures disconnect flow to help further illustrate our point the grid cells active pixels and cell and edge clones of a meandering river are shown in fig 2 groups of connected pixels are highlighted with different colors let us focus on the host cell i j located in the center of the domain it can be seen that there are two disjoint groups of connected pixels ω i j 1 and ω i j 2 on its western left edge γ i 1 2 j there are two groups of active edges γ i 1 2 j 1 and γ i 1 2 j 2 the former connects the clone ω i j 1 and ω i 1 j and the latter connects ω i j 2 and ω i 1 j on its northern top edge the set of active edge pixels γ i j 1 2 connects ω i j 1 and ω i j 1 on its eastern right edge γ i 1 2 j connects ω i j 2 and ω i 1 j there is an inactive edge in the south bottom edge γ i j 1 2 so this host cell has two cell clones which could have different water surface elevations the host edge to the west left of this host cell has two edge clones which could have different u velocity the host edges to east right and north top have single values of the u and v velocity respectively the host edge on the south bottom is inactive and thus is treated as a dry edge it is important to note that cell clones of a host cell share the same geometric center edge clones of a host cell have the same length and geometric position of an edge cell therefore a cell clone is a copy of the host cell including a connected path of active pixels and a clone edge is a copy of the active host edge including a connected path between two neighbouring cell clones of two adjacent cells furthermore each active pixel belongs to just one single clone of a host cell and each active pixel of an edge clone belongs to just one edge clone 2 3 sub clones if a cell is cloned sufficiently at the maximum surface elevation to remove artificial cross flows such cross flow may still exist at surface elevations less than η max i e in between η min η η max as new barriers appear at lower surface elevations and split a cell clone into two or more groups of connected pixels as illustrated in fig 3 each of these groups of connected pixels is hereafter called a sub clone a sub clone of a cell clone may or may not be connected to one sub clone or multiple sub clones of the host cell clone at a given surface elevation for simplicity and efficiency purposes the horizontal size an area of a sub clone is considered as a constant during the simulation for each sub clone a minimum water surface elevation is defined based on the minimum bathymetry of the sub clone to determine the wet dry condition of the sub clone if the water surface elevation of a sub clone goes under the minimum bathymetry of the sub clone the sub clone is removed from the computational domain due to the dry condition of the sub clone fig 3 shows an example of host cells and their wet areas at four different water levels η max η 0 η 1 η 2 η 3 η min at the maximum surface elevation η max three cell clones ω i j 1 ω i j 2 ω i j 3 can be seen these three cell clones are not connected with each other by reducing the water surface elevation to η 1 cell clone number 2 ω i j 2 is divided into two disconnected sub clones ω i j 2 1 1 and ω i j 2 1 2 these two sub clones are disconnected at the specific surface elevation η h hereafter this surface elevation is called the connectivity surface elevation a lengthy notation η h i j n m where n denotes a clone number and m a sub clone level will be used to precisely indicate the connectivity surface elevation when some ambiguity arise this water surface elevation is used to connect sub clone ω i j 2 1 1 to sub clone ω i j 2 2 2 at water surface elevation η 2 this clone is divided into three sub clones ω i j 2 1 1 ω i j 2 2 1 and ω i j 2 2 2 note that sub clone ω i j 2 1 2 is divided into two sub clones at the connectivity surface elevation η 2 η ω i j 2 η 2 the connectivity surface elevation can be found for each sub clone by sampling reduced water surface elevations at surface elevation η 3 one of the sub clones ω i j 2 1 1 disappears altogether due to the dry condition thus for surface elevations in the range of η min η 3 sub clone ω i j 2 1 1 should not be considered during computations fig 4 shows the algorithm to find cell clones and sub clones of a domain step by step a sub clone has four edges at each edge a velocity perpendicular to the edge is defined if there are no active pixels on one sub clone edge that edge is inactive and it is not connected to the adjacent host cell however it is possible that a sub clone edge could be active within some range of the water surface elevations and be inactive in the others note that sub clones of a cell clone share the same size and geometric center as the host cell therefore a sub clone is a copy of the host cell including a connected path of active pixels furthermore each active pixel of a clone belongs to just one single sub clone of a cell clone a sub clone edge has the same geometric location and length of the host cell and each active pixel of an edge cell belongs to just one sub clone of a cell clone to reduce the computational cost isolated sub clones that are much smaller than the coarse grid are removed from the computational domain if a sub clone does not connect with the cell clones or sub clones of the neighbor cells it is considered an isolated sub clone 2 4 merging and splitting sub clones in this section we propose a method to connect sub clones of a cell clone when blocking structures inside the cell clone are submerged fig 5 a shows the host cell ω i j at the maximum surface elevation η max this cell has three cell clones of ω i j 1 ω i j 2 and ω i j 3 fig 5b shows the sub clones and clones of this host cell at connectivity surface elevation η h i j 2 1 it can be seen that cell clone ω i j 2 splits into two sub cell clones ω i j 2 1 1 and ω i j 2 1 2 as surface elevation increases above the connectivity surface elevation sub clones are merged therefore sub clones ω i j 2 1 1 and ω i j 2 1 2 at surface elevations η h i j 2 1 η are submerged and one sub clone is considered instead during the simulation when the water surface elevation reaches the connectivity surface elevation η h i j 2 1 for two connected or more connected sub clones they are merged and one cell clone is considered ω i j 2 this cell clone has one surface elevation which is the average surface elevation of the connected sub clones when the surface elevation of each sub clone passes the connectivity surface elevation however it is possible that the surface elevation of one of the sub clones reaches the connectivity surface elevation ahead of the other ones here a sub clone cell which is connected to the inlet has the higher water surface elevation is called a source sub clone and the other sub clones are called receiver sub clones to deal with this an overflow formula is used to connect the source sub clone to the receiver sub clones until the water surface elevation of the receiver clone reaches the connectivity water surface elevation thereafter one cell clone or sub clone with one constant surface elevation can be considered for simplicity the overflow is modeled as a sharp crested weir although we note that this could readily be changed as needed should a better option be available a sharp crested weir is an overflow structure consisting of a vertical plate with a sharp edged crest mounted perpendicular to the flow direction as shown in fig 6 a simple empirical formula is used to assign an overflow between disconnected sub clones of a cell clone downstream of a sharp crested weir free flow occurs when the weir allows free access of air under the nappe the weir will be submerged if downstream water rises near or above the crest elevation based on the experimental work of kindsvate kindsvater and carter 1959 the following formula is used to approximate discharge 1 q k w 2 g l e w h e 0 3 2 where k w 2 3 is a constant l e w is effective width and h e 0 is effective depth in regard to the shape of weir in the context of a cell clone we can calculate discharge from the source cell to the receiver cell based on 1 for each time step until the water surface elevation of receiver cell reaches the connectivity water surface elevation η h once such a state is reached the average water surface elevation of the source and receiver clone is computed for a single constant water surface elevation of the merged cell clone by means of 2 η m c v m c a m c b m c v m c v s c v r c where a and v denote the area and volume of a cell b is the averaged bathymetric depth where the average is the combination of wet areas of connected cells and subscripts m c s c and r c denote merged sub clone source sub clone and receiver sub clone respectively to conserve mass in any situations a better approach can be employed where the volume of a merged sub clone is computed from the high resolution bathymetric data as a function of the surface elevation i e given the volume of the merged sub clone from eq 2 the water surface elevation is determined from the inverse relationship of the volume and the water surface elevation curve of the merged cell for the parameters in 1 we use h e 0 η s o u r c e η h and for simplicity l e w δ x or δ y at each time step discharge is calculated for the receiver clone 3 governing equations 3 1 subgrid model discretization the two dimensional depth averaged shallow water equations are considered conservation of mass is given by 3 h t h u x h v y 0 where t denotes time and u x y t and v x y t are the vertically averaged water velocity components in the x direction and y direction respectively here h η b x y is the local total water depth where η denotes the surface elevation and b x y bathymetric depth the momentum equations in the conservative form are 4 h u t x h u u y h u v g h η x τ b x τ s x ρ 1 ρ p a x f c h v 1 ρ h τ x x x h τ x y y and 5 h v t x h v u y h v v g h η y τ b y τ s y ρ 1 ρ p a y f c h u 1 ρ h τ y x x h τ y y y where τ b and τ s are bottom stresses and surface stresses respectively p a is local atmospheric pressure f c is the coriolis parameter and τ x x τ x y τ y x and τ y y denotes the lateral stresses due to turbulence mixing for the bottom stresses we consider quadratic formula 6 τ b ρ γ u γ c f u where c f is a bottom drag coefficient for simplicity in this study the coriolis force wind stress atmospheric pressure lateral stresses are neglected although they can be readily included should they be required 3 2 upscaled equations we consider the upscaled swes proposed by kennedy et al 2019 these equations are derived from formally applying averaging techniques whitaker 2013 to the swes presented in the previous section the upscaled mass equation is 7 v w η t h u x h v y 0 where v w η denotes the wet volume per unit area for a given wet averaged surface elevation η u h u d v h d v is the velocity vector averaged to the grid level and h denotes grid averaged water depth the upscaled momentum equations are 8 h u t u u h x c u u u v h y c u v u u h g h c η x x η x c η x y η y ϕ u c m f x x u c m f x y v 9 h v t v u h x c v u v u h y c v v v v h g h c η y x η x c η y y η y ϕ u c m f y x u c m f y y v where brackets denote grid averaged quantities except for velocity and water surface elevation where they are understood as a volume average and wet intrinsic average respectively in 8 9 ϕ a w a g denotes the wet area fraction c u u c u v c v u c v v are coefficients accounting for subgrid corrections associated with the nonlinear convection terms c η is the subgrid correction of the surface gradient coefficient and c m is effective bottom stress coefficient several closures for determining the subgrid correction parameters are proposed in kennedy et al 2019 here we consider the so called level 0 closure this closure uses fractional wetting and drying over the grid cell for mass correction but makes no sophisticated attempt at subgrid corrections for the momentum convection and surface gradient terms more precisely subgrid parameter are set to 10 c η x x c η y y 1 c η x y c η y x 0 11 c m f x x c m f y y c f g c m f x y c m f y x 0 12 c u u c v v c u v c v u 1 3 3 discretization the upscaled three eqs 7 9 have three unknown solution functions η u and v the averaged water depth h v w is taken to be a known variable and determined from η and a given dem b x y they are discretized on a staggered c grid with a semi implicit finite difference method see fig 7 the unknown variable η is placed at the cell center and u v are located at the midpoint of the vertical and horizontal cell edges respectively the advection term in 8 and 9 is discretized explicitly via an upwind scheme the surface gradient and bottom stress terms in the momentum equations and velocities in the continuity eq 7 are discretized implicitly to avoid restrictions on δ t from the g h wave and stiff bottom friction source term when the value c m is large we refer to kennedy et al 2019 for more detailed account of the numerical method below we describe the modification of the method to include the methodology described in section 2 to keep the notation simple η h u and v will be used to refer to the averaged variables η h u and v respectively suppose that at the time level t δ t we have a set of wet clone edges and cell clones with at least one wet edge note that cell clones correspond to sub clones when the water surface elevation in a clone drops below the connectivity water surface elevation level see section 2 4 which determines particular sub clones to be considered with such the sets at hand the discretization of the governing equations is as follows a semi implicit discretization of the momentum equations is written for each clone edge which could be a sub clone of a host edge the discretization of the x and y momentum equations carried out at the vertical and horizontal edges are respectively 13 u i 1 2 j n 1 1 h i 1 2 j h i 1 2 j n u i 1 2 j n δ t f i 1 2 j n g δ t δ x h i 1 2 j n η i 1 j n 1 η i j n 1 and 14 v i j 1 2 n 1 1 h i j 1 2 h i j 1 2 n v i j 1 2 n δ t g i j 1 2 n g δ t δ y h i j 1 2 n η i j 1 n 1 η i j n 1 where h i 1 2 j 1 h i 1 2 j n γ i 1 2 j δ t h i j 1 2 1 h i j 1 2 n γ i j 1 2 δ t and f i 1 2 j and g i j 1 2 represent the discretization of the advection terms see kennedy et al 2019 for more detail of these terms it is emphasized that in 13 14 the notations are overloaded for notational simplicity more specifically in 13 u i 1 2 j h i 1 2 j must be interpreted as the u velocity and water depth associated with a sub clone edge of the i j 1 2 host edge η i 1 j and η i j are the surface elevations of two sub clones from neighboring host cells to which the connected path is through the clone edge considered the approximate solution variables in 14 are interpreted in an analogous manner for each clone cell which could be a sub clone of a host cell the discretization of continuity eq 7 with the euler backward time discretization is considered 15 v η i j n 1 v η i j n δ t 1 δ x s e i 1 2 j u i 1 2 j s n 1 h i 1 2 j s n s e i 1 2 j u i 1 2 j s n 1 h i 1 2 j s n 1 δ y s e i j 1 2 v i j 1 2 s n 1 h i j 1 2 s n s e i j 1 2 v i j 1 2 s n 1 h i j 1 2 s n 0 where v η i j denotes the volume per unit cell area of the clone considered η i j is overloaded for notational simplicity e i 1 2 j e i 1 2 j e i j 1 2 and e i j 1 2 represent a set of sub clone edges connecting the clone considered to sub clones of neighboring host cells along the east west north and south edge of the clone respectively the superscript s in u and h is used simply to denote that they are a quality associated with the clone edges the approximate solution η n 1 u n 1 v n 1 can be obtained either by i solving the system of nonlinear eqs 15 13 and 14 simultaneously or by ii solving a reduced system of equations arising from the substitution of 13 and 14 into 15 casulli 2009 such a reduced system of nonlinear algebraic equations in a more compact form is given by 16 v η n 1 t η n 1 b where η n 1 is a vector of the solution at the next time level t is the matrix resulting from the substitution v is the vector of the water volume and b is the known right hand side vector note that t is symmetric with positive diagonal entries and negative off diagonal entries the system of eq 16 is mildly nonlinear and is solved with the newton raphson method to obtain η n 1 subsequently the velocities at the time level n 1 are computed in a back substitution step from 13 and 14 with the now known η n 1 subsequently the approach described in section 2 4 is carried out more precisely in a scenario of overtopping the weir formula 1 is used to approximate discharges between sub clones to update the surface elevations of sub clones which in turn are employed in informing whether sub clone merging is to be conducted the resulting surface elevation is subsequently used in updating the set of active cell clones and edge clones prior to the next integration step the set includes any clone having at least one wet edge and wet clone edge the wet dry state of an edge cell is determined based on an edge surface elevation the edge surface elevation is obtained by taking the mean of the surface elevation of the pair of cells to which it connects other approaches such as upwinding can also be employed if the computed surface elevation is greater than maximum pixel depth over the clone edge this edge is wet otherwise it is regarded as dry it is important to note that the number of cell clones and edge clones can differ from time step to time step due to the possibility of merging and splitting of clones sub clones further explanation of the numerical implementation is provided in appendix a 4 tests and validation in this section the ability of the present algorithm is demonstrated through a set of test cases ranging from idealized test cases to more complex and realistic settings boundary conditions are used to drive a flooding cycle in all of the test cases atmospheric pressure and wind stress are not considered in the following simulations because those are not expected to play a significant role in any conclusions made viscosity μ t is neglected due to relatively coarse gridding the manning formula is used to determine a bottom drag coefficient 17 c f g n 2 h 1 3 where n denotes the manning roughness coefficient the manning roughness coefficient and magnitude of gravitational acceleration are set to n 0 02 s m 1 3 and g 9 81 m s 2 for all simulations tests here are divided into three main groups 1 channel and block systems 2 meandering river and bays 3 flow in buttermilk bay a complex bay channel system with measured lidar bathymetry in all numerical tests the following water surface elevation boundary condition is imposed on the inlet of the computational domain 18 η x 0 t a 0 tanh 2 t t r cos ω t where a 0 denotes the forcing amplitude and t r is the ramping time for the following simulations the value of tidal frequency is set to ω 1 4544 10 4 s 1 and the amplitude of the tide to a 0 2 m for the buttermilk bay test case this amplitude is unrealistically large and is used to demonstrate the robustness of the subgrid model the tidal like boundary condition is imposed gradually with a ramp up time of t r 0 25 day unless otherwise indicated the maximum and minimum surface elevations used in cloning are set to η max a o ϵ and η min a o ϵ with ϵ 0 2 m 4 1 channel and block systems 4 2 permanently disconnected configurations a first test of the cell and edge clone methodology is performed in an idealized channel with an interior blockage two such geometric configurations are depicted in fig 8 these systems consist of a channel and a block that splits the channel into two disconnected parts the surface elevation boundary condition 18 is imposed on the southern part of the computational domain as a result the water surface elevation should remain constant for the entire simulation in the secondary channel three simulations with varying grid sizes are performed the first is a high resolution simulation with δ x δ y 2 m where this high resolution case is taken as the ground truth reference solution the coarse grid simulations use δ x δ y 256 m and are run with and without cell and edge clones implementation fig 8 includes grid lines of the coarse grid simulation it can be observed that in both configurations the coarse cell with the block has two wet edges as the upscaled swe equations consider subgrid connectivity an artificial cross flow will be seen in the secondary channel to remove this artificial cross flow the cell with the barrier is cloned twice as there are two groups of connected pixels this host cell can have two different surface elevations cells with blocks and their corresponding cell clones are depicted in fig 9 the time series of water surface elevation in the channel connected to the inlet at station 1 x 128 m and y 200 m and in the secondary channel station 2 x 128 m and y 1000 m of channel configuration a and in the channel connected to the inlet at station 1 x 128 m and y 200 m and in the secondary channel 2 x 600 m and y 650 m of channel configuration b are plotted in fig 10 for the three simulations b and d of this figure plot the surface elevation at the location in front of the barrier as expected the high resolution produces a constant water surface elevation in the portion of channel behind the block however the time series of water surface elevation of the coarse grid calculation the green line is different from the reference solution where the surface elevation in the range of 2 m to 2 m occurs due to an artificial cross flow inside the cell with the barrier after performing the cell clone procedure for this block cell the artificial cross flow in the coarse grid is removed and the time series of surface elevation the black dashed line is constant 4 2 1 inundated configurations this next test case is similar to the configuration a of channel block system in the previous example except for the height of the block in this test the height of the block enables surface elevation connectivity between two channels as the flow rises above a certain surface elevation fig 11 we use this test case to demonstrate the ability of this algorithm to handle merging and separation of sub clones for the first test case the height of the block is b 0 m which is equal to the initial surface elevation of the secondary channel according to the reference solution when the water surface elevation is less than 0 m the channel splits into two disconnected parts thus the block cell contains two sub clones at the surface elevation of η m i n η 0 and no sub clones at the surface elevation of 0 η η m a x the block cell is cloned two times based on the connected pixels at the connectivity surface elevation η 0 shown in fig 12 therefore two parts of the channel are disconnected and there should be no cross flow from the inlet to the second part of the channel when the water surface elevation reaches η 0 the first time step then the original cell with one surface elevation is considered instead of two cell clones during draining when water surface elevation reaches zero the block cell splits into two cell clones with the surface elevation of each clone being that of the block cell the time series of water surface elevation at the end of the secondary channel x 128 m y 1050 m is shown in fig 13 a for two different grid sizes δ x δ y 2 m and 256 m without clone implementation the two parts of the channel are connected in the coarse grid calculation resulting in artificial cross flows with cell clone implementation the wetting drying state of the coarse grid solution is similar to the high resolution data in a second example the height of the block is set to 1 m the initial surface elevation of the secondary channel is set to 0 m thus initially the primary and secondary channels are disconnected and and become connected disconnected as the surface elevation of primary channel raises above recedes below the blockage height in the coarse grid calculation with clones the connectivity surface elevation in the 1 3 th host cell is equal to the blockage height the splitting and merging of sub clones occurs at this height note that when the water surface elevation of the source sub clone the clone in front of the blockage reaches 1 m for the first time the water surface elevation of the receiving cell is 0 m this large difference of water surface elevation prevents merging sub clones because the average water surface elevation of the source and receiver sub clones will be less than the height of blockage for the first cycle the present approach applies the overflow formula to connect the receiver sub clone to the source sub clone until the water surface elevation of the receiving clone reaches the height of blockage the time series of the surface elevation recorded at the end of channel x 128 m y 1050 m are shown in fig 13b for the reference solution and the subgrid model without cloning and with the proposed cloning approach for the high resolution case it can be seen that the water reaches the secondary channel at an elevation of 1 95 m during the first tidal cycle then wetting drying occurs at the elevation of 1 m as expected with our proposed technique the result from the subgrid model with cloning and sub cloning is in good agreement with the high resolution simulation while it is not for the subgrid model without clones it is noted that in the first cycle there is a small difference between the high resolution time series of surface elevation and sub cloning technique this mismatch in the surface elevation occurs because of the overflow formula 4 3 meandering river and bays an idealized setup reflecting a meandering river with two blocks in the middle as well as three artificial lakes is shown in fig 14 the largest lake is connected to the meandering channel two narrow barriers can be seen in the middle of the river the western barrier has an elevation of 0 5 m with eastern barrier elevation 0 5 m a tidal like boundary condition see 18 is imposed on the southern part of the computational domain the amplitude of the tide is a 0 2 m and the tidal period is 12 hours four different simulations are conducted a high resolution simulation with grid size δ x δ y 8 m is used as the reference solution three subgrid simulations on the coarse grid of δ x δ y 1000 m are considered they consist of i subgrid level 0 ii subgrid level 0 with casulli s cell and edge clones casulli 2019 and iii our sub clones approach as a reminder the maximum and minimum surface elevations are set to η max 2 2 m and η min 2 2 m fig 14 shows the coarse grid with three marked cells black star symbol these cells include a disjoint group of pixels at the maximum surface elevation the cell clones associated with each host cell marked are depicted in fig 15 marked cell 1 and 3 each have three cell clones and marked cell 2 has two cell clones to find the sub clone of a cell clone the number of disjoint connected pixels is checked for each cell clone at a number of surface elevation levels this process starts at the maximum surface elevation and continues until the minimum surface elevation with a decremental step of δ η 0 1 m for the cell clones of the marked host cells 1 and 3 there is only one group of connected pixels at all levels therefore there are no sub clones in these cell clones for the cell clone 1 in the marked host cell 2 the number of disjoint groups of pixels is different as the surface elevations decrease due to the presence of barriers in this cell clone see fig 15 for depiction for this simulation three ranges of water surface elevations are considered in defining clones of the marked host cell 2 when the water surface elevation is η 0 5 cell clones are used for the system in the range of 0 5 η 0 5 sub clones a and b see fig 16 are considered instead of cell clone 1 for water surface elevations of η 0 5 sub clones a c and d represent the cell clone 1 in this simulation the initial condition is set to 0 m thus for the first cycle of flooding sub clone b is connected to sub clone a through an overflow formula three stations are marked by white circles in fig 14 the time series of surface elevation at these locations from all the runs conducted are plotted in fig 17 a b and c for station 3 see fig 17 the level 0 subgrid line in green predicts wetting drying in the small lake which is not physically correct as it is not connected to the inlet the original cell clone approach and the sub clone approach proposed yield identical results both remove this artificial cross flow from the coarse grid calculations fig 17c shows the time series at station 1 located in the middle of two barriers the wetting drying occurs at elevations η 0 4 m for the reference solution it can be observed that the original cell clone approach behaves identically to the level 0 solution the reason is that barriers are determined at the maximum surface elevation in the original cell clone approach however the barriers that appear in the lower elevation are part of the continuous path of pixels in the cell clone thus these barrier s effects cannot be captured by the original cell clone approach and the artificial cross flow still exists in the cell clone s approach it is noted that due to the static nature of the original approach this approach would permanently divide the flow at the maximum surface elevation by breaking down the cell clone into sub clones and connecting and disconnecting the sub clones the artificial cross flow can be further removed thus yielding surface elevations similar to the reference solution fig 17 b shows the time series at station 2 situated in the middle of the largest lake because the elevation of the barrier is 0 5 m and the initial condition of the water surface elevation is 0 m the overflow formula is used to connect sub clone c to sub clone d see fig 16 thus wetting drying happens at the elevation of 0 5 m and sub clones are merged and split at this elevation the wetting drying state with the sub clone approach is similar to the high resolution run the coarse grid and static original cell clone runs predict wetting drying occurs at elevations less than 0 5 m which is physically incorrect due to an artificial cross flow from the results shown above it can be concluded that the cell clone technique removes the artificial cross flow in the small lakes however due to its static nature the approach cannot accurately capture the effects of two subgrid barriers inside the marked cell 2 as they are submerged at the maximum surface elevation to capture the effect of these barriers the sub clone technique is applied to the computational domain as a result marked cell 2 is divided into sub clones and these sub clones are merged and split at different surface elevations to capture wetting drying similar to the high resolution 4 4 complex test buttermilk bay in this section a more realistic computational domain is considered to simulate flooding cycles in buttermilk bay massachusetts usa 41 760n 70 620w see fig 18 the geometry of buttermilk bay includes two narrow channels and two bays which make it challenging to obtain accurate simulations using traditional techniques and a coarse grid the computational domain which has a size of 3854 m 3854 m is shown in the red box in fig 18 the driving force for this simulation is a tidal like elevation boundary see eq 18 which is imposed along the south part of the red box in fig 18 lidar data in the universal transverse mercator coordinates with 1 m resolution is used to describe the bathymetry in all subgrid calculations the fd fv subgrid solution based on casulli s method casulli 2009 with resolution δ x δ y 4 m is used as our reference solution kennedy et al kennedy et al 2019 used this test problem to evaluate the performance of the subgrid model with different closures therein they showed the accuracy of the subgrid model for different grid sizes kennedy et al 2019 and also connectivity issues when the computational grids are very coarse in this study we focus on a coarsest grid calculation of δ x δ y 256 m at this resolution the subgrid results suffer from the connectivity issues we aim to resolve note that we did not consider cell clones and isolated sub clones with an active area of less than 10 of the coarse grid the computational grid and three cells with connectivity issues marked by a blue star symbol are drawn in fig 19 a fig 20 shows the wet dry areas for the marked cell 1 at η m a x red is dry and blue is wet two disjoint groups of pixels exist in this cell the group on the east side of the cell is not connected to the group on the west side due to a barrier which is significantly smaller than the cell this cell is cloned two times based on a group of connected pixels to restrict the artificial cross flow from the west to the east part of the cell and vice versa there are no sub clones for these cell clones fig 21 shows the wet dry area at the maximum surface elevation for marked cell 3 a close inspection reveals three disjoint groups of connected pixels two of these groups intersect the west edge of the cell and one of them intersects the south edge of the cell these groups are connected in the subgrid model without cloning in the clone cell approach this cell is cloned three times each of them consisting of a connected path of pixels that restrain the artificial cross flow between these disconnected wet areas so there is no sub clone for these cell clones fig 19 shows station 3 located in queen sewell pond this area has a slightly higher elevation than the two main bays and the barrier in marked cell 3 prevents the cross flow to this area fig 19 shows station 2 located in the area between the little buttermilk bay and queen sewell pond that has a relatively higher elevation than the two main bays but lower than queen sewell pond however it may still be reached by high water elevations marked cell 2 shown in fig 19 covers the area between the little buttermilk bay and queen sewell pond fig 22 shows marked cell 2 as well as wet dry areas at various water level elevations at the surface elevation of η m a x there is one group of connected pixels at the southwest of the cell and one group of connected pixels at the northeast of the cell connected by a narrow channel at the surface elevation of η 1 m the wet proportion of the channel shrinks and two groups of connected pixels can be discerned as the surface elevation reduces further to η 0 m the group of connected pixels in the northeastern part becomes dry at fig 22d the wet dry areas are shown at η 0 98 m this is the point at which the wet areas separate into two disjoint groups when the surface elevation is η 0 98 water can connect between the southwest to the northeast and vice versa thus η 0 98 m is a connectivity surface elevation when the water surface elevation is less than η 0 98 m this cell fig 22d splits into two sub clones when the water surface elevation of this cell reaches the elevation of η 0 98 m in the first flooding cycle an overflow formula is used to connect the source sub clone and the receiver sub clone later the source sub clone and the receiver sub clone merge based on the connectivity surface elevation fig 23 shows the surface elevation of the wet area for all considered models during the rising tide period t 0 792 0 872 1 000 day fig 23a c show the results of the level 0 subgrid solution level 0 subgrid with sub clones in the computational domain the reference solution computed on 4 m 4 m grid respectively at t 1 day there are additional wet areas in queen sewell pond see red box in fig 23a at t 1 day and the west part of main bay see blue box in fig 23a at t 1 day in the level 0 subgrid solution in comparison to the reference solution these additional wet areas result from blocks in the coarse grid are treated as connected areas this artificial flow can be removed by cloning cell sufficiently to resolve the effect of barriers that are not captured by the subgrid model it can be clearly observed from fig 23b that the subgrid solution with the sub clone treatment is free of the artificial wet areas seen in fig 23a when the subgrid alone is used the sub clone subgrid solution indeed is in good agreement with the reference solution in addition a small wet area can be seen in fig 23c at the time level t 0 792 and 0 872 day see north west of red boxes at these time levels this area cannot be seen in the coarse grid simulation in fig 23 c this wet area is captured due to merging sub clones marked cell 2 at the surface elevation of 0 98 m using the overflow formula by comparing red boxes and blue boxes of fig 23b c at three time levels it can be seen that the prediction of surface elevation in the subgrid calculation the cloning technique in the computational domain of the coarse grid matches quite well with the high resolution solution in terms of capturing wetting drying areas in fig 24 a the time series of surface elevation is plotted at station 3 for the reference calculation and subgrid calculations when the cell clone approach is applied the time series of surface elevation is identical to the high resolution fig 24b shows the time series of surface elevation at station 1 note that this station is in the west part of marked cell 2 i e in front of a small barrier see fig 19 since marked cell 2 splits into two cell clones the additional water flow is not permitted to go through the barrier as a result the effect of the barrier which is smaller than the computational grid can be captured in the subgrid model the time series of surface elevation for station 2 is depicted in fig 24c note that this station is located within marked cell 2 see fig 19 as illustrated in fig 22 disconnected groups of wet areas divided by subgrid blocking structured emerge at the height of η 0 98 m see fig 22 if water elevation is less than the connectivity surface elevation this cell splits into two sub clones when the water surface elevation reaches this height only one group of connected pixels is considered see fig 22 a however there is an exception during the first tidal cycle due to a relatively significant difference of surface elevations between the source clone and the receiver clone which prevents one cell with a single value of surface elevation to reduce the large difference the overflow formula is used to connect the source clone to the receiver clone until the surface elevation of the receiving cell clone reaches the connectivity surface elevation η h 0 98 m afterward when the water surface elevation reduces to a value lower than η h 0 98 m two sub clones with two different surface elevations are defined otherwise the marked cell with one surface elevation which is equal to the average surface elevation of receiving clone and host clone is considered fig 24c shows that wetting drying similar to the reference solution can be captured with a coarse grid solution with the inclusion of cell and edge clones 5 discussion and conclusions using subgrid corrections determined by an averaging process provides increased accuracy in complex shore regions when applying on lower resolution simulations kennedy et al 2019 however using an excessively coarse grid can lead to artificial cross flows between disconnected areas due to barriers that are smaller than the grid size although the cell clone approach presented by casulli 2019 removed the artificial cross flow at the maximum surface elevation the artificial cross flows may exist at the lower surface elevations as a result of the submerged barriers in this work we extend the cell clone approach casulli 2019 by breaking the cell clone down into sub clones to remove cross flow when barriers within the coarse grids are submerged splitting and merging sub clones allows for a more flexible implementation of subgrid models to represent the effect of smaller scale barriers that are submerged and emerged at different water surface elevations furthermore it naturally extends cartesian grids to restore the high resolution bathymetric data without sampling or interpolating this algorithm in principle is applicable to any flow region with a complex geometry that may include urban areas and marshland to produce accurate simulations of inundations during flood events our proposed algorithm is implemented in an existing subgrid model kennedy et al 2019 and tested through a variety of tests ranging from simple channel block systems to a sophisticated natural system buttermilk bay the model results show that a coarse grid model when implementing our approach has the ability to capture wetting drying behaviors similar to those obtained from high resolution simulations without requiring further mesh refinement as explained in section 3 3 we solve a reduced system of nonlinear algebraic equations eq 16 for the surface elevations which is mildly nonlinear using the newton raphson method solving the system of equations eq 16 requires us to compute the volume and the wet area of coarse cells for each surface elevation here the volume and the wet area of the cells are calculated directly from the high resolution bathymetric data for the large grid sizes these calculations can be very expensive computationally due to the large amount of high resolution bathymetric data inside a coarse grid to reduce the computational cost a pre storage lookup table can be employed to store the volume and the wet area of the cells as a function of surface elevations lookup tables can be built once and for all cells as a pre processing step currently we have not implemented the lookup tables for the cell clone and sub clone approach however for the subgrid model we experienced 20 to 30 higher computing time than the standard calculations of the same grid resolutions all of the presented test cases were conducted on relatively small cartesian grids using a custom written code to consider more extreme events such as hurricane induced storm surge much larger grids and parallelization of the algorithm will be required in principle the method introduced here can be applied to curvilinear polar elliptical and hyperbolic telescoping mesh grids as well as any irregular mesh grids future work will focus on incorporating this method into widely used and available models that have a more significant impact on the field author agreement statement i the undersigned declare that this manuscript is original has not been published before and is not currently being considered for publication elsewhere i confirm that the manuscript has been read and approved by all named authors and that there are no other persons who satisfied the criteria for authorship but are not listed i further confirm that the order of authors listed in the manuscript has been approved by all of us declaration of competing interest conflict of interest and authorship conformation form please check the following as appropriate all authors have participated in a conception and design or analysis and interpretation of the data b drafting the article or revising it critically for important intellectual content and c approval of the final version this manuscript has not been submitted to nor is under review at another journal or other publishing venue the authors have no affiliation with any organization with a direct or indirect financial interest in the subject matter discussed in the manuscript acknowlgedgments work here was funded under national science foundation usa grants icer 1664040 and 1664037 and through a grant from the joint airborne lidar bathymetry technical center of expertise jalbtcx usa their support is gratefully acknowledged appendix a numerical implementation a fortran based computer code originally written for an implementation of various forms of subgrid models and variants of discretization schemes presented in kennedy et al 2019 is modified to handle the clone sub clone approach in terms of its solution algorithm the two main tasks of the code involve i computing subgrid related and other necessary quantities e g volume wet area fraction wet cross section grid averaged total water depth wet dry status of edges and cells from a given surface elevation solution and ii solving the discretized form of the momentum eqs 13 14 for the edge centered u and v velocity components and solving the discretized form of the mass eq 16 for a solution vector of cell centered surface elevation η n 1 the former task is accomplished through the use of fortran objects of derived data type encapsulating data associated with subgrid bathymetry to be described in brief below and subroutines functions computing subgrid related quantities requested from these objects and a given surface solution vector for the latter task we briefly recall below solution procedures in the original code as the clone extends such procedures in the original code for a grid of n x n y cells the latter task uses one dimensional arrays denoted as a 1 u n u i j n i 1 n x 1 j 1 n y t v n v i j n i 1 n x j 1 n y 1 t η n η i j n i 1 n x j 1 n y t to store the edge perpendicular u v velocities at the edge centered vertical and horizontal edges and surface elevation η at the cell center respectively stemming from the use of fortran ordering of entries in these 1d arrays is done by mapping an index pair i j to a single index in a column major manner once the surface elevation η n 1 is known solving the discretized form of the momentum equations is done in a node by node fashion this step is computationally efficient as 13 14 are computed only at velocity nodes associated with wet edges while the value at nodes associated with dry edges is set to zero i e no normal flow is allowed for the mass equation the reduced system of nonlinear algebraic eq 16 is solved by the newton raphson method which requires solution of a linear system of equations associated with the jacobian of the system j p t where p v η η is a diagonal matrix whose entries are the values of wet area of cells such a linear system is solved by the bi conjugate gradient stabilized solver saad 1994 where the matrix t is stored in an ellpack like format mainly for an ease of updating its non zeros entries especially when the wet dry pattern changes non zero entries in the row associated with the index pair i j of the matrix t are those associated with the surface elevation of the cell i j and its wet neighbor cells for the full gird no cell clone t has at most five nonzero entries in each row the dimension of the reduced system of equations is n w n w where n w is the number of cells having at least one wet edge for a problem with wetting drying n w is time dependent to keep the code simple instead of strictly dealing with the n w n w system whose dimension may change with time we consider an equivalent n x 1 n y 1 system of equations in which the unknown solution vector includes all the cell centered surface elevation in this system an equation associated with a cell having no wet edge inactive cell is replaced by c η i j n 1 c η i j n i e no change in the value of surface elevation from the previous time step where c is a constant used merely to obtain the jacobin matrix with a properly scaled condition number although there is computational expense associated with the inactive cells in this simple approach such expense is not substantial especially when a coarse grid is considered in a calculation to accommodate the cell clone and sub clone approach which introduce additional dofs in each host cell and host edge we use objects that pre store information of clones and all their sub clones within the range of η min to η max see section 2 3 for the procedure to identify sub clones all clones and sub clones data in the description below clones refer to both clones and sub clone of a host cell are stored in a derived data type with among several others the following data fields table type table type raster lookup table nclone total number of clones clones sub clones tabdat 1 nclone b table of bathymetric data or lookup table tabdat 1 nclone b dim 1 2 dimension of table tabdat i b tabdat 1 nlcone bmin max 1 3 min max avg of bathymetric depth of clones clone label 1 nclone 1 3 clone labels see section 2 3 eta map 1 nclone element indices of clones in a surface elevation solution 1d array η note that in the above description a b indicates that b is a member of a derived data a these data are designed to accommodate two approaches of computing subgrid related quantities a direct approach through raster data of a cell tabdat i b stores portion of dem pixel in the clone i and an approach using lookup tables which store the subgrid related quantities at different finite levels of surface elevation in a table before hand for efficiency in the look up table approach the members of tabdat i store the content of lookup tables specially b dim 1 is the number of surface elevation levels b dim 2 is the number of pre stored subgrid qualities b 1 b dim 1 j stores the j th subgrid related quantity at different levels of surface elevation from bmin max 1 to bmin max 2 with a uniform incremental step of bmin max 2 bmin max 1 b dim 1 note that the direct approach is simple and determines the subgrid quantities exactly for a given surface elevation value however it can be computationally expensive with a cost proportional to the number of pixels the lookup table is very efficient as it requires much fewer operations i e one operation to locate the interval to which the given surface elevation belongs and a few operations for interpolation this approach requires pre computing every quantity needed and in general does not yield an exact value which has a consequence in solving 16 from our experience computing the wet surface area p v η η must be done numerically using a finite difference approximation to achieve convergence in the newton raphson method note that eta map storing element indices of clones in the solution vector of surface elevation is used for fetching relevant values to clones of the host cell from a given surface elevation vector in solving the discretized form the solution vectors for the surface elevations are enlarged so that their dimensions are equal to the number of all clones and sub clones of all n x n y host cells the indexing order in the enlarged one dimensional array is done in a cell by cell order i e surface elevation solutions of all clones associated with the i j th host cell followed by those of the i 1 j th host cell in a short notation a 2 η n η i j n i 1 n x 1 j 1 t where η i j n η n ω i j r s t t denotes a surface elevation solution vector of all clones clones and sub clones in the i j host cell r s t correspond to the clone number sub clone level and sub clone number as described in section 2 3 enlargement of the velocity solution vectors are done in a similar way note that active clones in the computational domain can change due to merging and splitting sub clones as done in the full grid case when solving 16 we solve the systems written for all surface elevation dofs and appropriately modify equations associated with the inactive clones and sub clones the algorithm of computation is summarized as follows 
291,neural network based surrogate models are widely used to improve computational efficiency incorporating theoretical guidance into data driven neural networks has improved their generalizability and accuracy however neural networks with strong form partial differential equations theoretical guidance have limited performance when strong discontinuity exists in the solution spaces such as pressure discontinuity at sources sinks in subsurface flow problems in this study we take advantage of weak form formulation and domain decomposition to deal with such difficulties we propose two strategies based on our previously developed weak form theory guided neural network tgnn wf to solve diffusivity equations with point sinks of either dirichlet or neumann type surrogate models are trained for well placement optimization and uncertainty analysis good agreement with numerical results is observed at lower computational costs whereas strong form tgnn fails to provide satisfactory results indicating the superiority of weak form formulation when solving discontinuous problems keywords theory guided neural network weak form diffusivity equation surrogate modeling well placement optimization uncertainty analysis 1 introduction surrogate models are commonly used for optimization uncertainty quantification and inverse modeling problems to improve computational efficiency deep neural networks dnns have been widely utilized to build surrogate models due to their strong capability to learn complex correlations between inputs and outputs duan et al 2017 2020 goodfellow et al 2016 huang et al 2020 wei et al 2020 however purely data driven dnns operate as black boxes the training of which usually relies upon large amounts of labelled data lecun et al 2015 recently by incorporating theoretical guidance or physical laws into the training process dnns have shown improved accuracy and generalizability in the small data regime or when the quality of the available training data is poor karpatne et al 2017 raissi et al 2019 they have also achieved promising results in the area of scientific computing such as the solution of partial differential equations pdes raissi et al 2019 raissi and karniadakis 2018 inverse modeling jo et al 2019 wang et al 2020 and function discovery huang et al 2020 xu et al 2020 in subsurface hydrology problems diffusivity equations are commonly used to describe the time evolution of a state variable such as pressure concentration etc the solution of diffusivity equations has been broadly attempted using a variety of neural network architectures informed by either the strong form pde constraint or the weak form regularization and successes have been reported with or without labeled training data for diffusivity equations with local sources sinks however the problem becomes more challenging due to discontinuity at the source sink location strong form theory guided neural networks generally fail to provide satisfactory results for highly discontinuous problems as shown in our previous work xu et al 2021 and other related works fuks and tchelepi 2020 a variety of investigations have recently shown that weak form formulation is more effective in capturing the solution of pdes since it employs lower order derivatives by performing integration by parts and trains over a certain region of the space time domain instead of collocation points used in the strong form formulations bao et al 2020 e and yu 2017 kharazmi et al 2019 kharazmi et al 2020 sirignano and spiliopoulos 2018 however few studies have reported the use of weak form neural networks to solve parametric diffusivity equations with local sources sinks therefore in this study we use the tgnn wf framework developed in our previous work xu et al 2021 to solve diffusivity equations with local sources sinks and to build surrogate models for efficient well placement optimization and uncertainty analysis of well production considering a stochastic parameter field in our previous work we focused on flow problems without sources sinks and did not explore the use of tgnn wf for surrogate modeling in this study however we propose two strategies of solving flow problems with local sinks of either dirichlet or neumann type the proposed approaches are beneficial for improving the accuracy of the surrogate model at low computational cost when limited training data are available and they pave the way for a large variety of hydrological problems with local discontinuities to be handled effectively via machine learning approaches the remainder of this paper is organized as follows in section 2 we briefly discuss some related works in the literature in section 3 we introduce the architecture of tgnn wf and the way to incorporate weak form residual into the loss function in section 4 we conduct a comparative study to determine the optimal method of domain decomposition and weak form formulation for the training of tgnn wf to solve diffusivity equations with local sinks of either dirichlet or neumann type then in sections 5 and 6 we discuss the construction of surrogate models using tgnn wf which takes more parametric inputs the trained surrogates are also used to perform well placement optimization uncertainty analysis of well production in section 7 we discuss limitations of the proposed method propose directions for future work and conclude the study 2 related works the solution of diffusivity equations without sources sinks has been widely attempted using a variety of neural network architectures for example raissi et al 2019 proposed a physics informed neural network pinn framework which incorporates the pde residual into the loss function to guide the neural network training process indeed a variety of pdes were solved using pinn including diffusivity equations and both forward and inverse problems were probed similar works using strong form constraints to guide neural network training for subsurface transient flow problems have also been reported by wang et al 2020 2021 and chen et al 2020 zhu et al 2019 used a deep convolutional encoder decoder network to build surrogate models for uncertainty quantification of 2d saturated flow problems both strong and weak form constraints were incorporated to guide the training of the network and the sobel filter was introduced to approximate the spatial gradients good agreement with numerical results was demonstrated but only steady state problems were considered given the difficulty for the sobel filter to approximate time gradients for 2d problems wang et al 2020 proposed a theory guided auto encoder tgae framework for surrogate construction of subsurface flow problems based on diffusivity equations which adopted the finite difference method to discretize the equations and incorporated the discretized residuals into the loss function to achieve theory guided training the tgae surrogates were then utilized for uncertainty analysis and inverse modeling tasks recently we proposed a weak form theory guided neural network tgnn wf xu et al 2021 which took advantage of the weak form formulation of the governing pdes to circumvent high order derivatives evaluation and we used domain decomposition to reduce computational cost diffusivity equations considering time evolution were solved in the case of little or no labeled data and poor quality data for the solution of diffusivity equations with local sources sinks using neural networks the problem becomes more challenging due to discontinuity at the source sink location as a consequence few pertinent studies are available in the literature however mo et al 2019 employed a dense convolutional encoder decoder network in which high dimensional inputs outputs are treated as images to build surrogate models for contaminant source identification an autoregressive strategy was proposed to predict the output at the current timestep based on the output from previous timesteps cnns are powerful at recognizing images but unlike fully connected neural networks fcnns cnn predictions are not continuous and are limited to the image resolution and they are not accurate for derivative evaluation in the spatial or temporal domain wang et al 2020 used a theory guided neural network tgnn to solve the pressure diffusivity equation with a single point sink they employed an fcnn and incorporated the pde residual loss boundary bc and initial condition ic constraints and labelled data mismatch into the total loss function and successfully predicted the pressure distribution of a 2d heterogeneous reservoir with a single production well located at the center of the domain however large amounts of training data and collocation points are required to ensure satisfactory agreement with numerical simulation results and limited case studies were reported khodayi mehr and zavlanos 2019 proposed a variational fcnn varnet which relies on the variational form of pdes to solve the advection diffusion equation with compactly supported sources the way that they dealt with the local sources is by approximating the local discontinuity with a continuous function defined over the entire domain the results however are not satisfactory and the parameters in the continuous source function are not straightforwardly determined 3 architecture of weak form theory guided neural network in this section we first briefly introduce the architecture of the widely used fcnn based on which our model is constructed then we discuss the weak form formulation of the diffusivity equation with local sources sinks and the way to construct the loss function which makes use of data mismatch ic and bc regularization and weak form residual constraint 3 1 fully connected neural network fcnn is a powerful nonlinear function approximator which can learn the complex relationship between inputs and outputs using a relatively simple network structure in comparison to other types of deep neural networks an fcnn is composed of an input layer several hidden layers and an output layer for an fcnn with l hidden layers the feedforward formulation can be written as follows 1 t i σ i w i x i 1 b i i 1 2 l 1 where t i is the output of the ith layer w i and b i are the weights and biases matrices of the ith layer respectively x i 1 is the input for the ith layer and σ i is the activation function which introduces certain nonlinearity common choices of activation functions include hyperbolic tangent tanh sigmoid and rectified linear unit relu and its variations goodfellow et al 2016 for completely data driven training of an fcnn the following mean squared error mse loss function regarding data mismatch is minimized 2 l f c n n w b 1 n d i 1 n d t i n n x i w b t i 2 where t is the true solution tnn is the neural network approximation of the solution and nd is the total number of training data points eq 2 can be minimized to obtain the network parameters w b using widely adopted algorithms such as stochastic gradient decent sgd or adaptive moment estimation adam goodfellow et al 2016 3 2 weak form theory guided neural network tgnn wf for the solution of problems of which the governing equations are known incorporating theoretical guidance into the training of fcnns dramatically improves training accuracy and generalization ability when little data are available or the data quality is poor by informing the neural network of the weak form constraints of the problem to be solved we formulate the tgnn wf framework here we first briefly introduce the weak form formulation of the diffusivity equation with local sources sinks commonly encountered in subsurface flow problems the governing equations can be written as follows 3 1 s s h x t t k h q δ x x s x ω t 0 t 3 2 i h x 0 g x x ω 3 3 b h x t f x x ω t 0 t where h is the pressure or hydraulic head k is the hydraulic conductivity ss is the specific storage q is the flow rate of the local sources sinks with coordinate x s δ is the dirac delta function and operators i and b define the initial and boundary conditions respectively to reformulate the pde eq 3 1 into its corresponding weak form we first decompose the spatial temporal domain ω 0 t into nc integral subdomains δω i δti of which we refer to collocation regions as the counterpart of collocation points on each collocation region we multiply eq 3 1 by a locally defined test function ω and integrate over the subdomain 4 δ ω i δ t i s s h x t t k h q δ x x s ω i x t d x d t 0 different choices of test functions have been reported in the literature they can either be a single specifically designed function that is defined locally on each subdomain e and yu 2017 reinbold et al 2020 a set of orthogonal functions kharazmi et al 2019 kharazmi et al 2020 used to approximate the real solution or they can be approximated by another neural network that is trained collectively in the process bao et al 2020 here we define test functions in the first way the details of which will be shown later in section 3 the loss function defined for tgnn wf is composed of four parts including the data mismatch rdata the weak form residual loss rwf and ic bc regularization ric and rbc 5 1 r d a t a 1 n d i 1 n d h n n x i t i w b h x i t i 2 5 2 r w f 1 n c i 1 n c δ ω i δ t i s s h x t t k h q δ x x s ω i x t d x d t 2 5 3 r i c 1 n i c i 1 n i c i h n n x i 0 w b g x i 2 5 4 r b c 1 n b c i 1 n b c b h n n x i t i w b f x i 2 where nd is the total number of training data points nc is the number of collocation regions for weak form residual evaluation and nic and nbc are the numbers of collocation points to enforce ic bc respectively note that bc can be of either dirichlet or neumann type the loss function for tgnn wf is then defined as the weighted summation of the four components 6 l t g n n w f w b λ d r d a t a λ f r w f λ i c r i c λ b c r b c where λ d λ f λ ic and λ bc are the weights of each residual term given eq 6 the model training process can be formulated as the following minimization problem min w b l t g n n w f w b for the solution of eq 3 1 the inputs of the neural network are the spatial and temporal coordinates x t and the output is the corresponding hydraulic head h furthermore other parameters can be fed as inputs as well such as the hydraulic conductivity field or the location of the sources sinks so that efficient surrogate models can be constructed to perform a variety of optimization or uncertainty analysis tasks the architecture of tgnn wf for the solution of diffusivity equations and surrogate modeling is shown in fig 1 4 solution of diffusivity equations with point sinks here we train a tgnn wf model to predict the hydraulic head distribution of a 2d transient single phase flow problem with a local production well of dirichlet and neumann type respectively different methods of domain decomposition and weak form construction are compared to determine the optimal setting for neural network training and the effect of the amount of training data on the learning capacity of tgnn wf is investigated more complicated cases with three producing wells are shown in appendix a 4 1 problem setup we consider a 2d spatial domain of size 1020 l 1020 l where l is any consistent length unit a production well point sink is located at xw yw the diffusivity equation describing the single phase saturated flow within the domain can be written as 7 s s h t x k x y h x y k x y h y q δ x x w δ y y w we set ss 0 0001 l 1 an inhomogeneous hydraulic conductivity field is considered which is described using karhunen loeve expansion kle chang zhang 2015 zhang lu 2004 with the first 20 terms which reserve 80 of the energy assuming that the correlation length is 408 l and k obeys a lognormal distribution with ln k 0 σln k 1 details of the hydraulic conductivity field construction can be found in our previous work xu et al 2021 fig 2 shows a realization of k used in the simulation the producing well can be either of dirichlet constant pressure or neumann constant flow rate type depending on the engineering controls which will be discussed separately in the following sections we use modflow software harbaugh 2005 which applies the finite difference method to obtain the numerical solution of eq 7 against which neural network predictions will be compared in the numerical simulation a 51 51 grid is used to discretize the spatial domain δx δy 20 l and the hydraulic head distribution is solved for the first 50 timesteps with timestep size δt 0 2 t 4 2 a single production well of dirichlet type we consider a single production well located at the center of the spatial domain producing at a constant head of 80 l the hydraulic heads at the left and right boundaries are kept constant to be 202 and 200 l respectively the upper and lower boundaries are taken as no flow boundaries direct treatment of the point sink with weak form formulation is challenging since the well flow rate q in eq 7 is unknown and q varies with time as well to circumvent the derivation of q we enforce the wellbore pressure constraint on nwell randomly chosen collocation points as a special type of bc constraint the nwell collocation points are sampled by latin hypercube sampling lhs raissi et al 2019 of the temporal space at the well spatial coordinate the locations of collocation regions are then selected elaborately to exclude the well so that the following diffusivity equation without the local sink is satisfied 8 s s h t x k x y h x y k x y h y on each collocation region we multiply eq 8 by a locally defined test function ω and integrate it over the subdomain the residual of the weak form formulation is then used to construct the loss function of the neural network three different forms of weak form residuals can be obtained depending on the times that integration by parts is performed 9 1 r w f 0 δ ω δ t ω 0 s s h t x k h x y k h y d x d y d t 9 2 r w f 1 δ ω δ t s s h ω 1 t k h x ω 1 x k h y ω 1 y d x d y d t 9 3 r w f 2 δ ω δ t h s s ω 2 t x k ω 2 x y k ω 2 y d x d y d t where the superscripts 0 1 and 2 represent the times that integration by parts is performed it should be noted that ω is compactly supported vanishing at the boundaries over each subdomain moreover for r w f 2 the first order derivatives of ω are compactly supported as well to further reduce computational cost ω 0 can take any form and here we define ω 1 and ω 2 in the following way 10 1 ω 1 1 x 2 1 y 2 1 t 2 10 2 ω 2 1 x 2 2 1 y 2 2 1 t 2 10 3 x x x c h x y y y c h y t t t c h t where xc yc tc is the center coordinate of a certain collocation region and hx hy and ht are the region half length in x y and t directions respectively the integrals in eqs 9 1 9 3 are evaluated numerically using the five point gauss legendre quadrature rule along each dimension specifically 125 integral points are used to evaluate the integrals in each spatial temporal collocation region the spatial arrangement of the collocation regions khodayi mehr and zavlanos 2019 and the use of different forms of weak form residuals kharazmi et al 2019 have been found to affect training accuracy here we perform a comparative study to determine the optimal setting for this specific problem five cases are studied as shown in table 1 for the first three cases we use r w f 1 to calculate the weak form residual and study the effect of collocation regions choice on training performance for case 1 the center coordinates of the collocation regions are sampled by lhs of the whole spatial temporal domain allowing overlapping of the collocation regions for case 2 the spatial temporal domain is regularly decomposed into the same number of collocation regions as case 1 but there is no overlapping between the neighboring collocation regions for case 3 more collocation regions are allocated in the neighborhood of the well where the most intensive hydraulic head variation is expected to occur following the idea of domain refinement commonly used in the finite element method note that for all the cases collocation regions are of the same size and those containing the location of the well are excluded a schematic of the collocation choice strategies for cases 1 3 is shown in fig 3 for case 4 we use lhs for collocation region choice but r w f 2 for weak form residual evaluation r w f 0 is not considered in this comparison due to the high computational error and cost accumulated by the evaluation of higher order derivatives as a comparison case we use the strong form formulation to calculate the pde residual in case 5 for all cases we use an fcnn with 7 hidden layers and 50 neurons per layer the network takes the spatial temporal coordinates t x y as inputs and outputs the hydraulic head tanh is chosen as the activation function and adam optimizer with a learning rate of 0 001 is used to train the network we use nc 5 000 collocation regions of size hx hy 51 l and ht 0 5 t we set nbc nic 10 000 and nwell 5 000 no other labeled training data are used the choice of weights of each term in the loss function depends on the problem being solved which may be determined prior to the training or optimized during the training process in our previous work xu et al 2021 the original loss minimization problem was reformulated into a lagrangian duality problem so that the weights of the terms in the loss function are optimized in the training process for this study however we find that automatic weight optimization does not lead to noticeably better results than using constant weights therefore here we set λ d λ f λ ic λ bc 1 the model training is carried out on a nvidia geforce rtx 2080 ti gpu and the training process is terminated when the loss function drops below 0 005 over the last 100 iterations the accuracy of the neural network prediction compared to numerical simulations is evaluated using two metrics including the relative l 2 error and the coefficient of determination r 2 score which are defined as follows 11 l 2 h n n h 2 h 2 12 r 2 1 i 1 n r h i n n h i 2 i 1 n r h i h 2 where 2 represents the standard euclidean norm nr is the total number of evaluation points for r 2 and h is the average value of h the training results for the five cases are presented in table 1 and fig 4 shows the evolution of the loss functions for the five cases it is worth noting that the loss function for case 5 using strong form formulation does not converge although the maximum iteration 20 000 is reached leading to a negative r 2 value whereas the other four cases using weak form formulation have r 2 approaching 1 this indicates the superiority of the weak form formulation when solving problems with strong discontinuities sources sinks in this case similar findings have been reported in our previous work xu et al 2021 in which we studied single phase flow and two phase flow cases without sources sinks and more detailed comparisons between the performance of strong and weak form tgnn in terms of accuracy and efficiency are made case 2 converges in minimum iterations but it results in much lower accuracy than case 1 we attribute such a dissimilarity to the effectiveness of information propagation through different collocation regions certain degrees of overlapping of the collocation regions significantly facilitate information exchange allowing for more efficient loss propagation case 3 among all of the cases has the highest prediction accuracy which indicates that knowledge based collocation regions allocation and refinement can effectively improve the learning capability of the neural network but at the cost of long training time approximately four times longer than case 1 although case 4 trains the fastest since the derivatives of hydraulic heads do not need to be repeatedly evaluated as for the other cases the prediction accuracy is not satisfactory compared to case 1 which is most likely the result of a lack of accuracy when evaluating higher order test functions see eq 10 2 balancing both computational cost and prediction performance we choose the setting for case 1 as the optimal setting for the remaining case studies in the following sections unless otherwise specified in the former case studies no labelled training data are used in the training process except for the collocation points used for ic bc and well pressure constraint here we study the effect of training data on the prediction accuracy of tgnn wf we randomly extract 10 500 and 2 000 data points from each of the first 20 timesteps as the training dataset 4 000 collocation regions are used to enforce the weak form constraints and the other settings are the same as those used in case 1 the trained models are evaluated on the entire spatial temporal domain and the prediction accuracy compared to the numerical results is shown in table 2 obviously with the addition of more training data the prediction accuracy and generalizability of the trained model are improved the best performing model trained with 40 000 data points has the highest r 2 of 0 9960 in addition to pressure prediction knowing the well flow rate when producing at a constant bottomhole pressure is often desired to facilitate comparison with numerical simulations we calculate the well production rate based on pressure predictions by discretizing eq 7 on the same grid as used in the numerical simulation the discretized equation at the well can be written as 13 s s h i j t h i j t 1 δ t k i 1 2 j h i 1 j t h i j t k i 1 2 j h i j t h i 1 j t δ x 2 k i j 1 2 h i j 1 t h i j t k i j 1 2 h i j t h i j 1 t δ y 2 q δ x δ y where h i j t is the hydraulic head at the well location at timestep t and δx δy and δt are the grid sizes used in the numerical simulations the hydraulic conductivity in the middle of two neighboring grids is calculated as the harmonic mean of the two grids for example 14 k i 1 2 j 2 k i j k i 1 j k i j k i 1 j the well flow rate q can then be calculated via eq 13 knowing the hydraulic heads at the well and its four neighboring grids the calculated well flow rates at each timestep based on neural network prediction and numerical simulation are presented in fig 5 close accordance is observed between the two 4 3 a single production well of neumann type for a production well located at the center of the domain producing at a constant rate the problem is more challenging besides the selection of collocation regions without the well as introduced in section 3 2 collocation regions containing the well also need to be selected to enforce the proper mass balance since the well bottomhole pressure is not known it should be mentioned that when dealing with a point sink a collocation region size containing the sink has to be specified similar to the grid size used in numerical approaches the size can be small enough to ensure accuracy of the approximation to facilitate comparison with the simulation we set the size of the collocation regions containing the well as the same as that of a grid used in modflow i e δxw δyw 20 l δt 0 2 t and the well is at the center of the collocation region the center coordinates of the nwell collocation regions are obtained by lhs of the temporal space the following weak form formulation is then imposed at the well 15 r w f w e l l 1 δ ω w e l l δ t w e l l s s h ω t k h x ω x k h y ω y q δ x w δ y w ω d x d y d t the total weak form residual loss is defined as 16 r w f t o t a l 1 λ 1 r w f 1 λ w e l l r w f w e l l 1 as r w f w e l l 1 is significantly larger than r w f 1 here we set λ well 0 0001 and λ1 λ d λ ic λ bc 1 to balance the contribution of each term in the loss function the neural network structure is the same as in section 4 2 similarly we study the effect of training data on model performance we randomly extract 10 500 and 2 000 data points from each of the first 20 timesteps as the training dataset 4 000 collocation regions without the well and 500 collocation regions containing the well are used consistently the prediction accuracy of the trained model is shown in table 3 it should be mentioned that for the case without any labelled training data we have tested different numbers of collocation regions the methods of choosing them lhs regular refinement and different combinations of the weights of the loss function terms or network architectures unfortunately due to the limited locality of the collocation regions at the well it is nontrivial to capture the pressure drawdown implicitly caused by the constant rate production and to propagate it through the spatial and temporal domain to the boundaries as a result for this case tgnn wf cannot solve the diffusivity equation when constrained only by ic bc and weak form residual losses on the other hand for the production well of dirichlet type satisfactory results can be obtained even with zero training data see table 2 however by incorporating very limited training data 400 prediction performance is dramatically improved and r 2 reaches 0 9848 with the addition of more training data model performance is further improved compared to the case of the dirichlet type production well shown in section 4 2 the accuracy is markedly similar when the same amount of training data is used the best performing case trained with 40 000 data points has r 2 close to 1 for this case the evolution of well bottomhole pressure predicted by the neural network and numerical simulation is shown in fig 6 good agreement is again observed between the two for the detailed solution of diffusivity equations with three producing wells of dirichlet and neumann types using tgnn wf please refer to appendix a 5 surrogate modeling for well placement optimization in the area of subsurface flow optimization determining the optimal location for well placement when the bottomhole pressure is controlled is often desired so that the cumulative production over a certain period of time is maximized in an inhomogeneous hydraulic conductivity field traditionally optimal well placement has to be solved numerically by testing a large number of possible well locations which is both computationally intensive and time consuming here we aim to build a surrogate model for the numerical simulator using tgnn wf which takes well location xw yw and temporal spatial coordinates t x y as inputs and outputs the hydraulic head prediction which can then be used to obtain the well production rate cumulative production the construction of such a surrogate model will significantly accelerate the well placement optimization process since the evaluation of a trained neural network model is trivial compared to numerical simulations we use a similar problem setup as in section 4 1 the same hydraulic conductivity field is used and we consider a single production well producing at a constant hydraulic head of 80 l all four boundaries are taken as no flow boundaries an fcnn with 7 hidden layers and 50 neurons per layer is used hydraulic heads of the first 50 timesteps for 30 well location realizations are solved by numerical simulation and 500 data points from each well location realization are extracted as the training dataset 25 000 collocation regions sampled from 500 virtual well location realizations are used to enforce the weak form residual constraint note that the virtual realizations are sampled just to enforce the weak form constraints and are not intended for the solution of the pressure distribution 25 000 collocation points are used to enforce ic and well pressure constraints respectively numerically solved hydraulic head distributions of 100 well location realizations randomly sampled from the spatial domain are used as the testing set the training process takes approximately 40 000 iterations 3 5 h for the loss function to drop below 0 001 the prediction performance is quantified using l 2 and r 2 for both the training and testing sets as shown in table 4 overall the training accuracy is high with r 2 approaching unity the mean l 2 and r 2 for the testing set is only slightly worse than the training set indicating strong generalizability of the trained model to unseen realizations fig 7 shows the hydraulic head distribution at the last timestep predicted by the trained neural network and numerical simulations for three different testing well location realizations overall the point wise relative error is less than 4 the well flow rate can be calculated following the procedure introduced in section 4 2 and the cumulative well production can be obtained by integrating the flow rate over time following the procedure we calculate the cumulative well production of the 100 testing well location realizations using the trained surrogate model and numerical simulations respectively fig 8 shows the correlation plot between the two and close accordance is observed r 2 0 95 indicating the reliability of our trained surrogate model for efficient prediction of well production given any well location the well placement optimization problem can then be solved by performing a grid search to facilitate comparison with numerical results here the spatial domain is discretized into a 51 51 grid the same as used for numerical simulations and the cumulative production of the well is calculated by placing the well on each grid the optimal well location is determined to be the one that leads to the maximum well production using the trained surrogate model we obtain the well cumulative production map for 2601 well location realizations fig 9 using only 25 3 s whereas the same grid search procedure using modflow takes approximately 17 min to complete the cumulative production maps obtained by the surrogate model and numerical simulations are markedly similar as shown in fig 9 the optimal well location estimated by the surrogate model is within the error of a grid compared to that predicted by numerical simulations shown as stars in fig 9 and the maximum well production predicted by the surrogate model is approximately 5000 l3 which is close to that predicted by numerical simulations 4800 l3 it can also be observed that the well production map roughly aligns with the hydraulic conductivity field fig 2 except that the well location that leads to maximum production is not where hydraulic conductivity is the highest which indicates that the optimal well placement is a complex problem not only controlled by the local hydraulic conductivity but also the geometry and size of the domain it should be mentioned that the grids used in the searching process can be refined for the trained surrogate model at almost no cost to improve the accuracy of the well location choice however for numerical simulations grid regeneration and refinement are cumbersome and time consuming here we refine the square region 340 100 400 100 centered at the optimal well location using a 50 50 grid the trained surrogate model is then used to evaluate well production by placing the well on each of the refined grids the well production map of the refined region is shown in fig 9 and the optimal well location is further refined to be at 342 0 389 8 leading to a maximum cumulative production of 5181 l3 we also trained a surrogate model for well placement optimization of three wells all producing at a constant bottomhole hydraulic head of 80 l the results can be found in appendix b 6 surrogate modeling for uncertainty quantification for a practical reservoir the hydraulic conductivity field is usually not known except for certain statistical properties under such uncertainties it is often desired to know the resulting uncertainties in the prediction of the well production here we consider a single production well located at the center of the reservoir since it is unrealistic to use the entire hydraulic conductivity field as inputs into the fcnn we parameterize the field using kle assuming that the unknown hydraulic conductivity field k obeys a log normal distribution and the mean and standard deviation of the distribution are known ln k 0 σln k 1 then the stochastic hydraulic conductivity can be parameterized using kle as introduced in section 4 1 we take the first 20 terms of the parameterization which reserves 80 of the energy an instance of the stochastic field can then be obtained by drawing 20 random numbers δ1 δ2 δ20 from a standard normal distribution here we aim to build a surrogate model using tgnn wf which takes the parameterized hydraulic conductivity field δ1 δ2 δ20 and the spatial temporal coordinate t x y as inputs and outputs the corresponding hydraulic head due to the relatively large input vector size we use an fcnn with 8 hidden layers and 60 neurons per layer 300 instances of the stochastic hydraulic conductivity field are randomly generated to obtain the training dataset by numerical simulation 500 data points are selected from each of the 300 realizations which results in 1 5 105 training data in total 100 collocation regions of size δx δy 102 l and δt 0 4 t are sampled from each of the 500 virtually created hydraulic conductivity fields to enforce the weak form residual constraints in addition 25 000 collocation points are used to enforce ic and well pressure constraints respectively the training process takes approximately 25 000 iterations 2 5 h for the loss function to converge below 0 003 the performance of the trained model is evaluated on the training 300 realizations and testing sets 100 realizations as shown in table 5 the model evaluation on both the training and testing sets has low l 2 and high r 2 approaching 1 indicating strong learning and generalization abilities as an example fig 10 shows three testing hydraulic conductivity fields and the resulting hydraulic head predictions using the trained surrogate model and numerical simulation respectively as well as the corresponding point wise relative error in general the relative error is less than 4 we then use the trained surrogate model to study the uncertainty in the well production as a result of the stochastic hydraulic conductivities monte carlo sampling of 10 000 instances of the stochastic hydraulic conductivity field is obtained to calculate the uncertainties the evaluation of the trained surrogate model on all of the spatial temporal grid points 10 000 50 51 51 only takes approximately 12 6 min while numerical simulations on the same problem take approximately 2 h to finish fig 11 shows the histograms of the calculated well cumulative production over 50 timesteps based on the 10 000 instances of hydraulic conductivity fields using the trained neural network model and numerical simulations good agreement between the two is observed indicating that the trained surrogate model using tgnn wf is not only computationally more efficient in solving uncertainty quantification problems but also achieves comparable accuracy to numerical simulation results on the other hand for the trained surrogate model evaluation of the hydraulic heads at the well and its neighboring grids is sufficient to obtain the well flow rate via eq 13 instead of solving for the whole spatial temporal domain as is required in the numerical simulations this will further improve computational efficiency 7 discussion and future work the diffusivity equation used in this study was derived from mass conservation laws and certain simplifications have been made such as assuming the porosity of the reservoir the viscosity and compressibility of the fluid to be constant and darcy s law remaining valid this form of equation has also been widely utilized in the literature to study slightly compressible fluid flow problems at reservoir scales chen et al 2020 wang et al 2020 however it has been shown in the literature to constitute a heuristic model that is inadequate to capture inertial effects and the flow initial conditions at pore scales lasseux et al 2019 more accurate models will be explored in our future work based on current diffusivity equations the proposed approaches of weak form formulation and collocation regions allocation for tgnn wf to solve single phase flow problems involving sources sinks show noticeably improved accuracy compared to the strong form tgnn however certain limitations of tgnn wf exist arising from the nature of the method 1 the derivation of the weak form and the choice of test functions can be nontrivial for more complex problems 2 in this study we consistently used five point gauss legendre quadrature rules to evaluate the integrals in each collocation region increasing the amount of integral points leads to higher computational cost the accuracy and computational efficiency of the method should be balanced based on the problems to be solved 3 the fcnn architecture might be inefficient when dealing with high dimensional problems compared to advanced neural network architectures such as convolutional neural networks cnns to deal with the limitations of the current approach some future works include 1 explore optimal ways of collocation region choice and weak form formulation when multiple sources sinks of both dirichlet and neumann types exist at the same time 2 test different quadrature rules to improve computational efficiency when evaluating the integrals in each collocation region 3 investigate ways of incorporating the weak form theoretical guidance into the training process of cnns to deal with more complex high dimensional problems 8 conclusions we use the weak form theory guided neural network tgnn wf developed in our previous work to solve parametric diffusivity equations with strong discontinuities local point sinks the difficulty of the problem lies in the fact that different governing equations with or without the well flow term should be imposed according to the location of the collocation region for a production well of dirichlet type we circumvent the direct weak form treatment of collocation regions containing the well by filtering the collocation regions chosen from lhs of the whole domain on the other hand for a production well of neumann type we consider collocation regions both containing the well and without the well to impose proper mass balance by testing different methods of collocation region choice and different weak form formulations we find the optimal setting which balances both accuracy and computational cost i e using lhs to choose collocation regions and one time integration by parts treatment of the weak form formulation with the optimal setting we successfully solved the diffusivity equation with different numbers of producing wells using tgnn wf furthermore by incorporating more parameters into the inputs of the neural network we successfully trained two surrogate models for 1 well placement optimization to maximize cumulative production and 2 uncertainty analysis of well production when a stochastic hydraulic conductivity field is considered with known statistical properties with the assistance of weak form theoretical guidance the training process requires a small amount of training data and discontinuity at the sinks can be handled effectively once properly trained surrogate models using tgnn wf are much more computationally efficient than numerical simulations but not at the expense of accuracy moreover the proposed approach of discontinuity treatment using weak form formulation and domain decomposition can be applied to other challenging problems with discontinuities such as flow within channelized hydraulic conductivity fields or flow involving two immiscible phases credit authorship contribution statement rui xu conceptualization data curation writing original draft investigation formal analysis methodology nanzhe wang conceptualization data curation writing original draft methodology dongxiao zhang conceptualization data curation writing original draft investigation formal analysis declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper appendix a solution of diffusivity equations for multiple production wells we allocate three production wells located at 260 260 780 260 and 520 780 labelled as well 1 2 and 3 respectively as shown in fig a1 all of the wells are assumed to produce at a constant hydraulic head of 80 l and all four boundaries are taken as no flow boundaries we use the same fcnn architecture as in section 4 2 and we use 40 000 training data points and 20 000 collocation regions to train the neural network the trained model evaluated on the entire spatial temporal domain has l 2 of 0 0160 and r 2 of 0 9880 compared to the numerical results the predicted hydraulic head distributions at three timesteps are shown in fig a2 a which is in good agreement with the numerical results the flow rate of each of the three wells is also in close accordance with the numerical results as shown in fig a2 b we then study the case of three wells producing at a constant flow rate of 100 l3 t we use 40 000 training data points 20 000 collocation regions without the well and 1 500 collocation regions containing the well to train the neural network the trained model evaluated on the entire spatial temporal domain has l 2 of 0 0028 and r 2 of 0 994 compared to the numerical results the predicted hydraulic head distributions at three timesteps are shown in fig a3 a which are in close accordance with the numerical results the hydraulic heads of each of the three wells are also in good agreement with the numerical results as shown in fig a3 b appendix b well placement optimization for three producing wells in this case the neural network takes nine inputs including the three well coordinates and the spatial temporal coordinate we use 500 000 labelled training data and 50 000 collocation regions sampled from 1000 realizations in the training process which takes approximately 100 000 iterations approximately 10 h for the loss function to drop below 0 02 the prediction performance is quantified using l 2 and r 2 for both the training and testing sets as shown in table b1 overall the training accuracy is high with r 2 approaching unity the mean l 2 and r 2 for the testing set is only slightly worse than the training set indicating strong generalizability of the trained model to unseen realizations fig b1 shows the hydraulic head distribution at the last timestep predicted by the trained surrogate model and numerical simulations for three realizations of testing well locations overall the point wise relative error is less than 5 for further validation of the trained surrogate model we compare in fig b2 a the cumulative production of the three wells over 50 timesteps calculated based on the hydraulic head predictions from the trained surrogate model and numerical simulations good agreement is observed in the correlation plot with r 2 of 0 92 using the trained surrogate model we then perform a similar well placement optimization task to maximize the cumulative production of all three wells the stochastic search strategy is adopted to find the optimal well placement 50 000 well location realizations are sampled from the spatial domain by lhs the hydraulic heads at the wells and their four neighboring grids over 50 timesteps are evaluated using the surrogate and the cumulative production is integrated over time the optimization process takes approximately 30 min and the histogram of the cumulative production for the 50 000 well location realizations is shown in fig b2 b the average cumulative production of three wells randomly placed in the hydraulic conductivity field is approximately 6 000 l3 and the maximum cumulative production is 12 193 l3 which is obtained by placing the three wells at 292 8 803 1 783 9 819 1 and 346 5 382 3 as shown in fig b2 c the three wells approximately lie on the three local hydraulic conductivity peaks which is as expected since higher conductivity generally leads to larger flow rates it should be mentioned that the optimization strategy considered here is relatively simple and straightforward because our focus is to present the efficient surrogate other intelligent optimization algorithms such as genetic algorithm ga ding et al 2011 and particle swarm optimization pso wang et al 2018 can be combined with our surrogate to achieve more accurate optimization results 
291,neural network based surrogate models are widely used to improve computational efficiency incorporating theoretical guidance into data driven neural networks has improved their generalizability and accuracy however neural networks with strong form partial differential equations theoretical guidance have limited performance when strong discontinuity exists in the solution spaces such as pressure discontinuity at sources sinks in subsurface flow problems in this study we take advantage of weak form formulation and domain decomposition to deal with such difficulties we propose two strategies based on our previously developed weak form theory guided neural network tgnn wf to solve diffusivity equations with point sinks of either dirichlet or neumann type surrogate models are trained for well placement optimization and uncertainty analysis good agreement with numerical results is observed at lower computational costs whereas strong form tgnn fails to provide satisfactory results indicating the superiority of weak form formulation when solving discontinuous problems keywords theory guided neural network weak form diffusivity equation surrogate modeling well placement optimization uncertainty analysis 1 introduction surrogate models are commonly used for optimization uncertainty quantification and inverse modeling problems to improve computational efficiency deep neural networks dnns have been widely utilized to build surrogate models due to their strong capability to learn complex correlations between inputs and outputs duan et al 2017 2020 goodfellow et al 2016 huang et al 2020 wei et al 2020 however purely data driven dnns operate as black boxes the training of which usually relies upon large amounts of labelled data lecun et al 2015 recently by incorporating theoretical guidance or physical laws into the training process dnns have shown improved accuracy and generalizability in the small data regime or when the quality of the available training data is poor karpatne et al 2017 raissi et al 2019 they have also achieved promising results in the area of scientific computing such as the solution of partial differential equations pdes raissi et al 2019 raissi and karniadakis 2018 inverse modeling jo et al 2019 wang et al 2020 and function discovery huang et al 2020 xu et al 2020 in subsurface hydrology problems diffusivity equations are commonly used to describe the time evolution of a state variable such as pressure concentration etc the solution of diffusivity equations has been broadly attempted using a variety of neural network architectures informed by either the strong form pde constraint or the weak form regularization and successes have been reported with or without labeled training data for diffusivity equations with local sources sinks however the problem becomes more challenging due to discontinuity at the source sink location strong form theory guided neural networks generally fail to provide satisfactory results for highly discontinuous problems as shown in our previous work xu et al 2021 and other related works fuks and tchelepi 2020 a variety of investigations have recently shown that weak form formulation is more effective in capturing the solution of pdes since it employs lower order derivatives by performing integration by parts and trains over a certain region of the space time domain instead of collocation points used in the strong form formulations bao et al 2020 e and yu 2017 kharazmi et al 2019 kharazmi et al 2020 sirignano and spiliopoulos 2018 however few studies have reported the use of weak form neural networks to solve parametric diffusivity equations with local sources sinks therefore in this study we use the tgnn wf framework developed in our previous work xu et al 2021 to solve diffusivity equations with local sources sinks and to build surrogate models for efficient well placement optimization and uncertainty analysis of well production considering a stochastic parameter field in our previous work we focused on flow problems without sources sinks and did not explore the use of tgnn wf for surrogate modeling in this study however we propose two strategies of solving flow problems with local sinks of either dirichlet or neumann type the proposed approaches are beneficial for improving the accuracy of the surrogate model at low computational cost when limited training data are available and they pave the way for a large variety of hydrological problems with local discontinuities to be handled effectively via machine learning approaches the remainder of this paper is organized as follows in section 2 we briefly discuss some related works in the literature in section 3 we introduce the architecture of tgnn wf and the way to incorporate weak form residual into the loss function in section 4 we conduct a comparative study to determine the optimal method of domain decomposition and weak form formulation for the training of tgnn wf to solve diffusivity equations with local sinks of either dirichlet or neumann type then in sections 5 and 6 we discuss the construction of surrogate models using tgnn wf which takes more parametric inputs the trained surrogates are also used to perform well placement optimization uncertainty analysis of well production in section 7 we discuss limitations of the proposed method propose directions for future work and conclude the study 2 related works the solution of diffusivity equations without sources sinks has been widely attempted using a variety of neural network architectures for example raissi et al 2019 proposed a physics informed neural network pinn framework which incorporates the pde residual into the loss function to guide the neural network training process indeed a variety of pdes were solved using pinn including diffusivity equations and both forward and inverse problems were probed similar works using strong form constraints to guide neural network training for subsurface transient flow problems have also been reported by wang et al 2020 2021 and chen et al 2020 zhu et al 2019 used a deep convolutional encoder decoder network to build surrogate models for uncertainty quantification of 2d saturated flow problems both strong and weak form constraints were incorporated to guide the training of the network and the sobel filter was introduced to approximate the spatial gradients good agreement with numerical results was demonstrated but only steady state problems were considered given the difficulty for the sobel filter to approximate time gradients for 2d problems wang et al 2020 proposed a theory guided auto encoder tgae framework for surrogate construction of subsurface flow problems based on diffusivity equations which adopted the finite difference method to discretize the equations and incorporated the discretized residuals into the loss function to achieve theory guided training the tgae surrogates were then utilized for uncertainty analysis and inverse modeling tasks recently we proposed a weak form theory guided neural network tgnn wf xu et al 2021 which took advantage of the weak form formulation of the governing pdes to circumvent high order derivatives evaluation and we used domain decomposition to reduce computational cost diffusivity equations considering time evolution were solved in the case of little or no labeled data and poor quality data for the solution of diffusivity equations with local sources sinks using neural networks the problem becomes more challenging due to discontinuity at the source sink location as a consequence few pertinent studies are available in the literature however mo et al 2019 employed a dense convolutional encoder decoder network in which high dimensional inputs outputs are treated as images to build surrogate models for contaminant source identification an autoregressive strategy was proposed to predict the output at the current timestep based on the output from previous timesteps cnns are powerful at recognizing images but unlike fully connected neural networks fcnns cnn predictions are not continuous and are limited to the image resolution and they are not accurate for derivative evaluation in the spatial or temporal domain wang et al 2020 used a theory guided neural network tgnn to solve the pressure diffusivity equation with a single point sink they employed an fcnn and incorporated the pde residual loss boundary bc and initial condition ic constraints and labelled data mismatch into the total loss function and successfully predicted the pressure distribution of a 2d heterogeneous reservoir with a single production well located at the center of the domain however large amounts of training data and collocation points are required to ensure satisfactory agreement with numerical simulation results and limited case studies were reported khodayi mehr and zavlanos 2019 proposed a variational fcnn varnet which relies on the variational form of pdes to solve the advection diffusion equation with compactly supported sources the way that they dealt with the local sources is by approximating the local discontinuity with a continuous function defined over the entire domain the results however are not satisfactory and the parameters in the continuous source function are not straightforwardly determined 3 architecture of weak form theory guided neural network in this section we first briefly introduce the architecture of the widely used fcnn based on which our model is constructed then we discuss the weak form formulation of the diffusivity equation with local sources sinks and the way to construct the loss function which makes use of data mismatch ic and bc regularization and weak form residual constraint 3 1 fully connected neural network fcnn is a powerful nonlinear function approximator which can learn the complex relationship between inputs and outputs using a relatively simple network structure in comparison to other types of deep neural networks an fcnn is composed of an input layer several hidden layers and an output layer for an fcnn with l hidden layers the feedforward formulation can be written as follows 1 t i σ i w i x i 1 b i i 1 2 l 1 where t i is the output of the ith layer w i and b i are the weights and biases matrices of the ith layer respectively x i 1 is the input for the ith layer and σ i is the activation function which introduces certain nonlinearity common choices of activation functions include hyperbolic tangent tanh sigmoid and rectified linear unit relu and its variations goodfellow et al 2016 for completely data driven training of an fcnn the following mean squared error mse loss function regarding data mismatch is minimized 2 l f c n n w b 1 n d i 1 n d t i n n x i w b t i 2 where t is the true solution tnn is the neural network approximation of the solution and nd is the total number of training data points eq 2 can be minimized to obtain the network parameters w b using widely adopted algorithms such as stochastic gradient decent sgd or adaptive moment estimation adam goodfellow et al 2016 3 2 weak form theory guided neural network tgnn wf for the solution of problems of which the governing equations are known incorporating theoretical guidance into the training of fcnns dramatically improves training accuracy and generalization ability when little data are available or the data quality is poor by informing the neural network of the weak form constraints of the problem to be solved we formulate the tgnn wf framework here we first briefly introduce the weak form formulation of the diffusivity equation with local sources sinks commonly encountered in subsurface flow problems the governing equations can be written as follows 3 1 s s h x t t k h q δ x x s x ω t 0 t 3 2 i h x 0 g x x ω 3 3 b h x t f x x ω t 0 t where h is the pressure or hydraulic head k is the hydraulic conductivity ss is the specific storage q is the flow rate of the local sources sinks with coordinate x s δ is the dirac delta function and operators i and b define the initial and boundary conditions respectively to reformulate the pde eq 3 1 into its corresponding weak form we first decompose the spatial temporal domain ω 0 t into nc integral subdomains δω i δti of which we refer to collocation regions as the counterpart of collocation points on each collocation region we multiply eq 3 1 by a locally defined test function ω and integrate over the subdomain 4 δ ω i δ t i s s h x t t k h q δ x x s ω i x t d x d t 0 different choices of test functions have been reported in the literature they can either be a single specifically designed function that is defined locally on each subdomain e and yu 2017 reinbold et al 2020 a set of orthogonal functions kharazmi et al 2019 kharazmi et al 2020 used to approximate the real solution or they can be approximated by another neural network that is trained collectively in the process bao et al 2020 here we define test functions in the first way the details of which will be shown later in section 3 the loss function defined for tgnn wf is composed of four parts including the data mismatch rdata the weak form residual loss rwf and ic bc regularization ric and rbc 5 1 r d a t a 1 n d i 1 n d h n n x i t i w b h x i t i 2 5 2 r w f 1 n c i 1 n c δ ω i δ t i s s h x t t k h q δ x x s ω i x t d x d t 2 5 3 r i c 1 n i c i 1 n i c i h n n x i 0 w b g x i 2 5 4 r b c 1 n b c i 1 n b c b h n n x i t i w b f x i 2 where nd is the total number of training data points nc is the number of collocation regions for weak form residual evaluation and nic and nbc are the numbers of collocation points to enforce ic bc respectively note that bc can be of either dirichlet or neumann type the loss function for tgnn wf is then defined as the weighted summation of the four components 6 l t g n n w f w b λ d r d a t a λ f r w f λ i c r i c λ b c r b c where λ d λ f λ ic and λ bc are the weights of each residual term given eq 6 the model training process can be formulated as the following minimization problem min w b l t g n n w f w b for the solution of eq 3 1 the inputs of the neural network are the spatial and temporal coordinates x t and the output is the corresponding hydraulic head h furthermore other parameters can be fed as inputs as well such as the hydraulic conductivity field or the location of the sources sinks so that efficient surrogate models can be constructed to perform a variety of optimization or uncertainty analysis tasks the architecture of tgnn wf for the solution of diffusivity equations and surrogate modeling is shown in fig 1 4 solution of diffusivity equations with point sinks here we train a tgnn wf model to predict the hydraulic head distribution of a 2d transient single phase flow problem with a local production well of dirichlet and neumann type respectively different methods of domain decomposition and weak form construction are compared to determine the optimal setting for neural network training and the effect of the amount of training data on the learning capacity of tgnn wf is investigated more complicated cases with three producing wells are shown in appendix a 4 1 problem setup we consider a 2d spatial domain of size 1020 l 1020 l where l is any consistent length unit a production well point sink is located at xw yw the diffusivity equation describing the single phase saturated flow within the domain can be written as 7 s s h t x k x y h x y k x y h y q δ x x w δ y y w we set ss 0 0001 l 1 an inhomogeneous hydraulic conductivity field is considered which is described using karhunen loeve expansion kle chang zhang 2015 zhang lu 2004 with the first 20 terms which reserve 80 of the energy assuming that the correlation length is 408 l and k obeys a lognormal distribution with ln k 0 σln k 1 details of the hydraulic conductivity field construction can be found in our previous work xu et al 2021 fig 2 shows a realization of k used in the simulation the producing well can be either of dirichlet constant pressure or neumann constant flow rate type depending on the engineering controls which will be discussed separately in the following sections we use modflow software harbaugh 2005 which applies the finite difference method to obtain the numerical solution of eq 7 against which neural network predictions will be compared in the numerical simulation a 51 51 grid is used to discretize the spatial domain δx δy 20 l and the hydraulic head distribution is solved for the first 50 timesteps with timestep size δt 0 2 t 4 2 a single production well of dirichlet type we consider a single production well located at the center of the spatial domain producing at a constant head of 80 l the hydraulic heads at the left and right boundaries are kept constant to be 202 and 200 l respectively the upper and lower boundaries are taken as no flow boundaries direct treatment of the point sink with weak form formulation is challenging since the well flow rate q in eq 7 is unknown and q varies with time as well to circumvent the derivation of q we enforce the wellbore pressure constraint on nwell randomly chosen collocation points as a special type of bc constraint the nwell collocation points are sampled by latin hypercube sampling lhs raissi et al 2019 of the temporal space at the well spatial coordinate the locations of collocation regions are then selected elaborately to exclude the well so that the following diffusivity equation without the local sink is satisfied 8 s s h t x k x y h x y k x y h y on each collocation region we multiply eq 8 by a locally defined test function ω and integrate it over the subdomain the residual of the weak form formulation is then used to construct the loss function of the neural network three different forms of weak form residuals can be obtained depending on the times that integration by parts is performed 9 1 r w f 0 δ ω δ t ω 0 s s h t x k h x y k h y d x d y d t 9 2 r w f 1 δ ω δ t s s h ω 1 t k h x ω 1 x k h y ω 1 y d x d y d t 9 3 r w f 2 δ ω δ t h s s ω 2 t x k ω 2 x y k ω 2 y d x d y d t where the superscripts 0 1 and 2 represent the times that integration by parts is performed it should be noted that ω is compactly supported vanishing at the boundaries over each subdomain moreover for r w f 2 the first order derivatives of ω are compactly supported as well to further reduce computational cost ω 0 can take any form and here we define ω 1 and ω 2 in the following way 10 1 ω 1 1 x 2 1 y 2 1 t 2 10 2 ω 2 1 x 2 2 1 y 2 2 1 t 2 10 3 x x x c h x y y y c h y t t t c h t where xc yc tc is the center coordinate of a certain collocation region and hx hy and ht are the region half length in x y and t directions respectively the integrals in eqs 9 1 9 3 are evaluated numerically using the five point gauss legendre quadrature rule along each dimension specifically 125 integral points are used to evaluate the integrals in each spatial temporal collocation region the spatial arrangement of the collocation regions khodayi mehr and zavlanos 2019 and the use of different forms of weak form residuals kharazmi et al 2019 have been found to affect training accuracy here we perform a comparative study to determine the optimal setting for this specific problem five cases are studied as shown in table 1 for the first three cases we use r w f 1 to calculate the weak form residual and study the effect of collocation regions choice on training performance for case 1 the center coordinates of the collocation regions are sampled by lhs of the whole spatial temporal domain allowing overlapping of the collocation regions for case 2 the spatial temporal domain is regularly decomposed into the same number of collocation regions as case 1 but there is no overlapping between the neighboring collocation regions for case 3 more collocation regions are allocated in the neighborhood of the well where the most intensive hydraulic head variation is expected to occur following the idea of domain refinement commonly used in the finite element method note that for all the cases collocation regions are of the same size and those containing the location of the well are excluded a schematic of the collocation choice strategies for cases 1 3 is shown in fig 3 for case 4 we use lhs for collocation region choice but r w f 2 for weak form residual evaluation r w f 0 is not considered in this comparison due to the high computational error and cost accumulated by the evaluation of higher order derivatives as a comparison case we use the strong form formulation to calculate the pde residual in case 5 for all cases we use an fcnn with 7 hidden layers and 50 neurons per layer the network takes the spatial temporal coordinates t x y as inputs and outputs the hydraulic head tanh is chosen as the activation function and adam optimizer with a learning rate of 0 001 is used to train the network we use nc 5 000 collocation regions of size hx hy 51 l and ht 0 5 t we set nbc nic 10 000 and nwell 5 000 no other labeled training data are used the choice of weights of each term in the loss function depends on the problem being solved which may be determined prior to the training or optimized during the training process in our previous work xu et al 2021 the original loss minimization problem was reformulated into a lagrangian duality problem so that the weights of the terms in the loss function are optimized in the training process for this study however we find that automatic weight optimization does not lead to noticeably better results than using constant weights therefore here we set λ d λ f λ ic λ bc 1 the model training is carried out on a nvidia geforce rtx 2080 ti gpu and the training process is terminated when the loss function drops below 0 005 over the last 100 iterations the accuracy of the neural network prediction compared to numerical simulations is evaluated using two metrics including the relative l 2 error and the coefficient of determination r 2 score which are defined as follows 11 l 2 h n n h 2 h 2 12 r 2 1 i 1 n r h i n n h i 2 i 1 n r h i h 2 where 2 represents the standard euclidean norm nr is the total number of evaluation points for r 2 and h is the average value of h the training results for the five cases are presented in table 1 and fig 4 shows the evolution of the loss functions for the five cases it is worth noting that the loss function for case 5 using strong form formulation does not converge although the maximum iteration 20 000 is reached leading to a negative r 2 value whereas the other four cases using weak form formulation have r 2 approaching 1 this indicates the superiority of the weak form formulation when solving problems with strong discontinuities sources sinks in this case similar findings have been reported in our previous work xu et al 2021 in which we studied single phase flow and two phase flow cases without sources sinks and more detailed comparisons between the performance of strong and weak form tgnn in terms of accuracy and efficiency are made case 2 converges in minimum iterations but it results in much lower accuracy than case 1 we attribute such a dissimilarity to the effectiveness of information propagation through different collocation regions certain degrees of overlapping of the collocation regions significantly facilitate information exchange allowing for more efficient loss propagation case 3 among all of the cases has the highest prediction accuracy which indicates that knowledge based collocation regions allocation and refinement can effectively improve the learning capability of the neural network but at the cost of long training time approximately four times longer than case 1 although case 4 trains the fastest since the derivatives of hydraulic heads do not need to be repeatedly evaluated as for the other cases the prediction accuracy is not satisfactory compared to case 1 which is most likely the result of a lack of accuracy when evaluating higher order test functions see eq 10 2 balancing both computational cost and prediction performance we choose the setting for case 1 as the optimal setting for the remaining case studies in the following sections unless otherwise specified in the former case studies no labelled training data are used in the training process except for the collocation points used for ic bc and well pressure constraint here we study the effect of training data on the prediction accuracy of tgnn wf we randomly extract 10 500 and 2 000 data points from each of the first 20 timesteps as the training dataset 4 000 collocation regions are used to enforce the weak form constraints and the other settings are the same as those used in case 1 the trained models are evaluated on the entire spatial temporal domain and the prediction accuracy compared to the numerical results is shown in table 2 obviously with the addition of more training data the prediction accuracy and generalizability of the trained model are improved the best performing model trained with 40 000 data points has the highest r 2 of 0 9960 in addition to pressure prediction knowing the well flow rate when producing at a constant bottomhole pressure is often desired to facilitate comparison with numerical simulations we calculate the well production rate based on pressure predictions by discretizing eq 7 on the same grid as used in the numerical simulation the discretized equation at the well can be written as 13 s s h i j t h i j t 1 δ t k i 1 2 j h i 1 j t h i j t k i 1 2 j h i j t h i 1 j t δ x 2 k i j 1 2 h i j 1 t h i j t k i j 1 2 h i j t h i j 1 t δ y 2 q δ x δ y where h i j t is the hydraulic head at the well location at timestep t and δx δy and δt are the grid sizes used in the numerical simulations the hydraulic conductivity in the middle of two neighboring grids is calculated as the harmonic mean of the two grids for example 14 k i 1 2 j 2 k i j k i 1 j k i j k i 1 j the well flow rate q can then be calculated via eq 13 knowing the hydraulic heads at the well and its four neighboring grids the calculated well flow rates at each timestep based on neural network prediction and numerical simulation are presented in fig 5 close accordance is observed between the two 4 3 a single production well of neumann type for a production well located at the center of the domain producing at a constant rate the problem is more challenging besides the selection of collocation regions without the well as introduced in section 3 2 collocation regions containing the well also need to be selected to enforce the proper mass balance since the well bottomhole pressure is not known it should be mentioned that when dealing with a point sink a collocation region size containing the sink has to be specified similar to the grid size used in numerical approaches the size can be small enough to ensure accuracy of the approximation to facilitate comparison with the simulation we set the size of the collocation regions containing the well as the same as that of a grid used in modflow i e δxw δyw 20 l δt 0 2 t and the well is at the center of the collocation region the center coordinates of the nwell collocation regions are obtained by lhs of the temporal space the following weak form formulation is then imposed at the well 15 r w f w e l l 1 δ ω w e l l δ t w e l l s s h ω t k h x ω x k h y ω y q δ x w δ y w ω d x d y d t the total weak form residual loss is defined as 16 r w f t o t a l 1 λ 1 r w f 1 λ w e l l r w f w e l l 1 as r w f w e l l 1 is significantly larger than r w f 1 here we set λ well 0 0001 and λ1 λ d λ ic λ bc 1 to balance the contribution of each term in the loss function the neural network structure is the same as in section 4 2 similarly we study the effect of training data on model performance we randomly extract 10 500 and 2 000 data points from each of the first 20 timesteps as the training dataset 4 000 collocation regions without the well and 500 collocation regions containing the well are used consistently the prediction accuracy of the trained model is shown in table 3 it should be mentioned that for the case without any labelled training data we have tested different numbers of collocation regions the methods of choosing them lhs regular refinement and different combinations of the weights of the loss function terms or network architectures unfortunately due to the limited locality of the collocation regions at the well it is nontrivial to capture the pressure drawdown implicitly caused by the constant rate production and to propagate it through the spatial and temporal domain to the boundaries as a result for this case tgnn wf cannot solve the diffusivity equation when constrained only by ic bc and weak form residual losses on the other hand for the production well of dirichlet type satisfactory results can be obtained even with zero training data see table 2 however by incorporating very limited training data 400 prediction performance is dramatically improved and r 2 reaches 0 9848 with the addition of more training data model performance is further improved compared to the case of the dirichlet type production well shown in section 4 2 the accuracy is markedly similar when the same amount of training data is used the best performing case trained with 40 000 data points has r 2 close to 1 for this case the evolution of well bottomhole pressure predicted by the neural network and numerical simulation is shown in fig 6 good agreement is again observed between the two for the detailed solution of diffusivity equations with three producing wells of dirichlet and neumann types using tgnn wf please refer to appendix a 5 surrogate modeling for well placement optimization in the area of subsurface flow optimization determining the optimal location for well placement when the bottomhole pressure is controlled is often desired so that the cumulative production over a certain period of time is maximized in an inhomogeneous hydraulic conductivity field traditionally optimal well placement has to be solved numerically by testing a large number of possible well locations which is both computationally intensive and time consuming here we aim to build a surrogate model for the numerical simulator using tgnn wf which takes well location xw yw and temporal spatial coordinates t x y as inputs and outputs the hydraulic head prediction which can then be used to obtain the well production rate cumulative production the construction of such a surrogate model will significantly accelerate the well placement optimization process since the evaluation of a trained neural network model is trivial compared to numerical simulations we use a similar problem setup as in section 4 1 the same hydraulic conductivity field is used and we consider a single production well producing at a constant hydraulic head of 80 l all four boundaries are taken as no flow boundaries an fcnn with 7 hidden layers and 50 neurons per layer is used hydraulic heads of the first 50 timesteps for 30 well location realizations are solved by numerical simulation and 500 data points from each well location realization are extracted as the training dataset 25 000 collocation regions sampled from 500 virtual well location realizations are used to enforce the weak form residual constraint note that the virtual realizations are sampled just to enforce the weak form constraints and are not intended for the solution of the pressure distribution 25 000 collocation points are used to enforce ic and well pressure constraints respectively numerically solved hydraulic head distributions of 100 well location realizations randomly sampled from the spatial domain are used as the testing set the training process takes approximately 40 000 iterations 3 5 h for the loss function to drop below 0 001 the prediction performance is quantified using l 2 and r 2 for both the training and testing sets as shown in table 4 overall the training accuracy is high with r 2 approaching unity the mean l 2 and r 2 for the testing set is only slightly worse than the training set indicating strong generalizability of the trained model to unseen realizations fig 7 shows the hydraulic head distribution at the last timestep predicted by the trained neural network and numerical simulations for three different testing well location realizations overall the point wise relative error is less than 4 the well flow rate can be calculated following the procedure introduced in section 4 2 and the cumulative well production can be obtained by integrating the flow rate over time following the procedure we calculate the cumulative well production of the 100 testing well location realizations using the trained surrogate model and numerical simulations respectively fig 8 shows the correlation plot between the two and close accordance is observed r 2 0 95 indicating the reliability of our trained surrogate model for efficient prediction of well production given any well location the well placement optimization problem can then be solved by performing a grid search to facilitate comparison with numerical results here the spatial domain is discretized into a 51 51 grid the same as used for numerical simulations and the cumulative production of the well is calculated by placing the well on each grid the optimal well location is determined to be the one that leads to the maximum well production using the trained surrogate model we obtain the well cumulative production map for 2601 well location realizations fig 9 using only 25 3 s whereas the same grid search procedure using modflow takes approximately 17 min to complete the cumulative production maps obtained by the surrogate model and numerical simulations are markedly similar as shown in fig 9 the optimal well location estimated by the surrogate model is within the error of a grid compared to that predicted by numerical simulations shown as stars in fig 9 and the maximum well production predicted by the surrogate model is approximately 5000 l3 which is close to that predicted by numerical simulations 4800 l3 it can also be observed that the well production map roughly aligns with the hydraulic conductivity field fig 2 except that the well location that leads to maximum production is not where hydraulic conductivity is the highest which indicates that the optimal well placement is a complex problem not only controlled by the local hydraulic conductivity but also the geometry and size of the domain it should be mentioned that the grids used in the searching process can be refined for the trained surrogate model at almost no cost to improve the accuracy of the well location choice however for numerical simulations grid regeneration and refinement are cumbersome and time consuming here we refine the square region 340 100 400 100 centered at the optimal well location using a 50 50 grid the trained surrogate model is then used to evaluate well production by placing the well on each of the refined grids the well production map of the refined region is shown in fig 9 and the optimal well location is further refined to be at 342 0 389 8 leading to a maximum cumulative production of 5181 l3 we also trained a surrogate model for well placement optimization of three wells all producing at a constant bottomhole hydraulic head of 80 l the results can be found in appendix b 6 surrogate modeling for uncertainty quantification for a practical reservoir the hydraulic conductivity field is usually not known except for certain statistical properties under such uncertainties it is often desired to know the resulting uncertainties in the prediction of the well production here we consider a single production well located at the center of the reservoir since it is unrealistic to use the entire hydraulic conductivity field as inputs into the fcnn we parameterize the field using kle assuming that the unknown hydraulic conductivity field k obeys a log normal distribution and the mean and standard deviation of the distribution are known ln k 0 σln k 1 then the stochastic hydraulic conductivity can be parameterized using kle as introduced in section 4 1 we take the first 20 terms of the parameterization which reserves 80 of the energy an instance of the stochastic field can then be obtained by drawing 20 random numbers δ1 δ2 δ20 from a standard normal distribution here we aim to build a surrogate model using tgnn wf which takes the parameterized hydraulic conductivity field δ1 δ2 δ20 and the spatial temporal coordinate t x y as inputs and outputs the corresponding hydraulic head due to the relatively large input vector size we use an fcnn with 8 hidden layers and 60 neurons per layer 300 instances of the stochastic hydraulic conductivity field are randomly generated to obtain the training dataset by numerical simulation 500 data points are selected from each of the 300 realizations which results in 1 5 105 training data in total 100 collocation regions of size δx δy 102 l and δt 0 4 t are sampled from each of the 500 virtually created hydraulic conductivity fields to enforce the weak form residual constraints in addition 25 000 collocation points are used to enforce ic and well pressure constraints respectively the training process takes approximately 25 000 iterations 2 5 h for the loss function to converge below 0 003 the performance of the trained model is evaluated on the training 300 realizations and testing sets 100 realizations as shown in table 5 the model evaluation on both the training and testing sets has low l 2 and high r 2 approaching 1 indicating strong learning and generalization abilities as an example fig 10 shows three testing hydraulic conductivity fields and the resulting hydraulic head predictions using the trained surrogate model and numerical simulation respectively as well as the corresponding point wise relative error in general the relative error is less than 4 we then use the trained surrogate model to study the uncertainty in the well production as a result of the stochastic hydraulic conductivities monte carlo sampling of 10 000 instances of the stochastic hydraulic conductivity field is obtained to calculate the uncertainties the evaluation of the trained surrogate model on all of the spatial temporal grid points 10 000 50 51 51 only takes approximately 12 6 min while numerical simulations on the same problem take approximately 2 h to finish fig 11 shows the histograms of the calculated well cumulative production over 50 timesteps based on the 10 000 instances of hydraulic conductivity fields using the trained neural network model and numerical simulations good agreement between the two is observed indicating that the trained surrogate model using tgnn wf is not only computationally more efficient in solving uncertainty quantification problems but also achieves comparable accuracy to numerical simulation results on the other hand for the trained surrogate model evaluation of the hydraulic heads at the well and its neighboring grids is sufficient to obtain the well flow rate via eq 13 instead of solving for the whole spatial temporal domain as is required in the numerical simulations this will further improve computational efficiency 7 discussion and future work the diffusivity equation used in this study was derived from mass conservation laws and certain simplifications have been made such as assuming the porosity of the reservoir the viscosity and compressibility of the fluid to be constant and darcy s law remaining valid this form of equation has also been widely utilized in the literature to study slightly compressible fluid flow problems at reservoir scales chen et al 2020 wang et al 2020 however it has been shown in the literature to constitute a heuristic model that is inadequate to capture inertial effects and the flow initial conditions at pore scales lasseux et al 2019 more accurate models will be explored in our future work based on current diffusivity equations the proposed approaches of weak form formulation and collocation regions allocation for tgnn wf to solve single phase flow problems involving sources sinks show noticeably improved accuracy compared to the strong form tgnn however certain limitations of tgnn wf exist arising from the nature of the method 1 the derivation of the weak form and the choice of test functions can be nontrivial for more complex problems 2 in this study we consistently used five point gauss legendre quadrature rules to evaluate the integrals in each collocation region increasing the amount of integral points leads to higher computational cost the accuracy and computational efficiency of the method should be balanced based on the problems to be solved 3 the fcnn architecture might be inefficient when dealing with high dimensional problems compared to advanced neural network architectures such as convolutional neural networks cnns to deal with the limitations of the current approach some future works include 1 explore optimal ways of collocation region choice and weak form formulation when multiple sources sinks of both dirichlet and neumann types exist at the same time 2 test different quadrature rules to improve computational efficiency when evaluating the integrals in each collocation region 3 investigate ways of incorporating the weak form theoretical guidance into the training process of cnns to deal with more complex high dimensional problems 8 conclusions we use the weak form theory guided neural network tgnn wf developed in our previous work to solve parametric diffusivity equations with strong discontinuities local point sinks the difficulty of the problem lies in the fact that different governing equations with or without the well flow term should be imposed according to the location of the collocation region for a production well of dirichlet type we circumvent the direct weak form treatment of collocation regions containing the well by filtering the collocation regions chosen from lhs of the whole domain on the other hand for a production well of neumann type we consider collocation regions both containing the well and without the well to impose proper mass balance by testing different methods of collocation region choice and different weak form formulations we find the optimal setting which balances both accuracy and computational cost i e using lhs to choose collocation regions and one time integration by parts treatment of the weak form formulation with the optimal setting we successfully solved the diffusivity equation with different numbers of producing wells using tgnn wf furthermore by incorporating more parameters into the inputs of the neural network we successfully trained two surrogate models for 1 well placement optimization to maximize cumulative production and 2 uncertainty analysis of well production when a stochastic hydraulic conductivity field is considered with known statistical properties with the assistance of weak form theoretical guidance the training process requires a small amount of training data and discontinuity at the sinks can be handled effectively once properly trained surrogate models using tgnn wf are much more computationally efficient than numerical simulations but not at the expense of accuracy moreover the proposed approach of discontinuity treatment using weak form formulation and domain decomposition can be applied to other challenging problems with discontinuities such as flow within channelized hydraulic conductivity fields or flow involving two immiscible phases credit authorship contribution statement rui xu conceptualization data curation writing original draft investigation formal analysis methodology nanzhe wang conceptualization data curation writing original draft methodology dongxiao zhang conceptualization data curation writing original draft investigation formal analysis declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper appendix a solution of diffusivity equations for multiple production wells we allocate three production wells located at 260 260 780 260 and 520 780 labelled as well 1 2 and 3 respectively as shown in fig a1 all of the wells are assumed to produce at a constant hydraulic head of 80 l and all four boundaries are taken as no flow boundaries we use the same fcnn architecture as in section 4 2 and we use 40 000 training data points and 20 000 collocation regions to train the neural network the trained model evaluated on the entire spatial temporal domain has l 2 of 0 0160 and r 2 of 0 9880 compared to the numerical results the predicted hydraulic head distributions at three timesteps are shown in fig a2 a which is in good agreement with the numerical results the flow rate of each of the three wells is also in close accordance with the numerical results as shown in fig a2 b we then study the case of three wells producing at a constant flow rate of 100 l3 t we use 40 000 training data points 20 000 collocation regions without the well and 1 500 collocation regions containing the well to train the neural network the trained model evaluated on the entire spatial temporal domain has l 2 of 0 0028 and r 2 of 0 994 compared to the numerical results the predicted hydraulic head distributions at three timesteps are shown in fig a3 a which are in close accordance with the numerical results the hydraulic heads of each of the three wells are also in good agreement with the numerical results as shown in fig a3 b appendix b well placement optimization for three producing wells in this case the neural network takes nine inputs including the three well coordinates and the spatial temporal coordinate we use 500 000 labelled training data and 50 000 collocation regions sampled from 1000 realizations in the training process which takes approximately 100 000 iterations approximately 10 h for the loss function to drop below 0 02 the prediction performance is quantified using l 2 and r 2 for both the training and testing sets as shown in table b1 overall the training accuracy is high with r 2 approaching unity the mean l 2 and r 2 for the testing set is only slightly worse than the training set indicating strong generalizability of the trained model to unseen realizations fig b1 shows the hydraulic head distribution at the last timestep predicted by the trained surrogate model and numerical simulations for three realizations of testing well locations overall the point wise relative error is less than 5 for further validation of the trained surrogate model we compare in fig b2 a the cumulative production of the three wells over 50 timesteps calculated based on the hydraulic head predictions from the trained surrogate model and numerical simulations good agreement is observed in the correlation plot with r 2 of 0 92 using the trained surrogate model we then perform a similar well placement optimization task to maximize the cumulative production of all three wells the stochastic search strategy is adopted to find the optimal well placement 50 000 well location realizations are sampled from the spatial domain by lhs the hydraulic heads at the wells and their four neighboring grids over 50 timesteps are evaluated using the surrogate and the cumulative production is integrated over time the optimization process takes approximately 30 min and the histogram of the cumulative production for the 50 000 well location realizations is shown in fig b2 b the average cumulative production of three wells randomly placed in the hydraulic conductivity field is approximately 6 000 l3 and the maximum cumulative production is 12 193 l3 which is obtained by placing the three wells at 292 8 803 1 783 9 819 1 and 346 5 382 3 as shown in fig b2 c the three wells approximately lie on the three local hydraulic conductivity peaks which is as expected since higher conductivity generally leads to larger flow rates it should be mentioned that the optimization strategy considered here is relatively simple and straightforward because our focus is to present the efficient surrogate other intelligent optimization algorithms such as genetic algorithm ga ding et al 2011 and particle swarm optimization pso wang et al 2018 can be combined with our surrogate to achieve more accurate optimization results 
292,the geomechanical response of a porous reservoir due to injection of fluid can result from a complex interplay between the changes in porepressure and temperature near the wellbore as a result predictions are usually made using either simplified analytical models which may apply unrealistic assumptions in order to produce a tractable model or detailed numerical simulations that can be computationally expensive laforce et al 2014a 2014b developed a semi analytical model for the geomechanical response of a reservoir to nonisothermal multi phase fluid injection which has been used in studies of co 2 sequestration we demonstrate that a numerical solution using the moose software precisely matches the analytical formulae we then include various effects in the numerical model that relax the simplifying assumptions made in the analytical derivation we find the analytic and numerical solutions for the fluid and temperature fronts still agree reasonably while only qualitative agreement is observed for other quantities such as stress and displacement we conclude the laforce et al 2014a b solutions are useful for rapid investigation of projects involving injection of cold fluid into warm aquifers however the enhancements afforded by moose such as high precision fluid equations of state and the ability to more accurately capture geological complexity along with its computational scalability which greatly reduces runtimes means that moose should be preferred for more sophisticated analyses because validating complex coupled codes is challenging we propose that the model contained herein can be used as a benchmark for other coupled codes 1 introduction injection or production of fluid into or from the subsurface changes the pressure near the wellbore which can affect the stresses in the reservoir rock complicating this is the possible temperature difference between injected fluid and the ambient reservoir temperature which leads to thermally induced stress changes near the wellbore 1 1 fluid production typically does not change the reservoir temperature near the wellbore unless via the joule thomson effect or if coning is induced where warmer formation water below the injection depth is drawn up to the wellbore this change in reservoir stress can lead to a number of possible effects in the reservoir some adverse such as uplift or subsidence at the surface changes in pressure in overlaying or underlying aquifers reactivation of nearby faults or fractures and even the possibility of creating new fractures a number of studies have investigated coupled geomechanics and multiphase fluid flow scenarios using various numerical tools and coupling schemes e g rutqvist et al 2002 rutqvist and tsang 2002 minkoff et al 2003 dean et al 2006 rutqvist et al 2008 xu et al 2012 kim and moridis 2013 kim et al 2015 rutqvist 2017 one area of concern that has previously been addressed in the literature is the risk that increased reservoir pressure due to fluid injection may cause reactivation of existing faults near the wellbore particularly in the context of geological storage of co 2 e g cappa and rutqvist 2011 morris et al 2011 mazzoldi et al 2012 bao et al 2013 uplift or subsidence of the caprock reservoir interface and subsequent deformation at the ground surface have also been the subject of a number of numerical studies again commonly in regard to large scale underground storage of co 2 one notable example of this is the co 2 storage project at in salah in algeria where a measurable uplift in the surface was observed as a result of injection of co 2 into a low permeability formation mathieson et al 2011 rinaldi et al 2017 a number of studies have attempted to interpret these observations in order to increase understanding of important reservoir parameters e g rutqvist et al 2010 typically these numerical models are computationally expensive and require significant effort to properly characterise the reservoir in contrast analytical models can provide rapid and concise descriptions of how the system responds to variations of the input parameters without having to resort to time consuming and sometimes rather opaque numerical simulation for both the numerical and analytical cases conceptual models simplify the complex physical reality however it is usually necessary to further simplify the mathematics in order to construct an analytical solution and so modellers are left wondering if the physical situation really responds in the same way as the analytic solution in this study we explore injection of a cool fluid into a warmer idealized reservoir and examine the applicability of the semi analytical model of laforce et al 2014a b once the simplifying assumptions are relaxed we investigate coupled pressure and thermal effects on the stress and displacement and vice versa using fully coupled physics in the porousflow module wilkins et al 2020 of moose permann et al 2019 alger et al 2019 this is a high performance open source code that is particularly designed for fully coupled multi physics problems sample input files that replicate the results presented in this study are provided by the authors as part of the moose framework for readers to use alger et al 2019 this study is comprised of two parts in the first we verify the moose numerical model against the semi analytical solutions of laforce et al 2014a b for a simplified two phase thm problem involving injection of a cold fluid into a warmer elastic axially symmetric reservoir in the second part we relax the simplifications implemented in the code verification to explore the interplay between pressure temperature displacement and stress and evaluate the suitability of the semi analytical solutions of laforce et al 2014a b for cases where the simplifying assumptions used in their derivation no longer hold the following effects are explored 1 the dependence on volumetric strain rate is included so that fluid mass conservation and heat energy conservation is guaranteed and the physics is fully coupled 2 the porosity is allowed to evolve according to standard thermo poro elasticity theory 3 a nonzero capillary pressure is included 4 high precision equations of state for brine and co 2 are used which relaxes the assumptions of constant density constant viscosity and simplified internal energy and enthalpy 5 low permeability seals that largely trap the injected fluid but allow thermal conduction and impact the mechanical stresses and strains are included with all these extensions active we find the analytic and numerical solutions for the fluid and temperature fronts agree reasonably while only qualitative agreement is observed for other quantities capillarity perturbs the effective porepressure a weighted average of liquid and gas porepressure around the saturation front and reduces co 2 saturation the seals retard temperature evolution reduce displacement and increase stress the realistic fluid properties mean porepressure is lower at early times but higher at later times displacement and stress are governed by an interplay between the effect of the seals and fluid properties dynamically changing porosity makes little difference in this example the fluid heat evolution drives the mechanical response but not vice versa suggesting that an appropriate modelling strategy is to solve the fluid heat evolution separately and then impose the porepressure and temperature upon a mechanical model to determine displacement and stress based on the results we propose that the laforce et al 2014a b solutions are useful for rapid investigation of projects involving injection of cold fluid into warm aquifers in contrast to the analytic approach moose can easily employ high precision fluid equations of state capillarity and geological complexity all which impact porepressure gas saturation stress and strain distributions in the current model moose models can also incorporate heterogeneity anisotropy rock plasticity fractures and fracture propogation geochemistry and multicomponent flows all of which may be important in certain situations in addition moose s advanced computational scalability means that model runtimes are much lower than when using traditional codes we conclude that the enhancements afforded by moose mean it should be preferred for more sophisticated analyses when data is available to populate the complex model validating complex coupled codes is challenging because the physics contained in the codes is often subtly different than that of the analytical models such as the assumption of incompressibility in only some parts but not all parts of the laforce et al 2014a b derivation and because numerical artifacts such as time step sizes discretisation error and numerical stabilization schemes all impact the numerical solution the laforce et al 2014a b solutions are extremely useful in engineering assessments of contemporary projects such as co 2 sequestration or subsurface energy storage proposals and the model employs many different physics and couplings for these reasons this article s code validation is significant and can provide a demanding benchmark for other coupled codes 2 model description we consider an axially symmetric model of a reservoir bounded above and below by impermeable caprock see fig 1 the radial coordinate is labeled r and axial coordinate z the reservoir and seals are oriented horizontally normal to z a vertical wellbore intersects the reservoir and injects fluid in this case supercritical co 2 into it at a constant rate the co 2 is colder than the initial reservoir temperature the injected fluid moves through the reservoir heat or cold advects with the fluid slowly cooling the reservoir and conducting into the surrounding seals the porousflow module used in this study to undertake numerical simulations describes multiphase multicomponent flow of fluid and heat in porous media when used with the tensormechanics module also freely available as part of the moose framework permann et al 2019 alger et al 2019 fully coupled thermo hydro mechanical thm simulations are possible we summarise the governing equations used in appendix a 3 numerical model verification in order to verify the moose model for this coupled thm problem of injection of cold fluid into a warm elastic reservoir we replicate the simplified model used in laforce et al 2014a b we call this the benchmark model laforce et al 2014a b develop a semi analytical solution for this problem by extending and combining ideas and results derived by lauwerier 1955 rehbinder 1995 dindoruk and dindoruk 2008 however to make this problem tractable and enable a semi analytical solution laforce et al 2014a b make several important simplifications to the governing equations which we list in detail in appendix b one of the features of the porousflow module and moose in general is the ability to easily include or exclude physics as desired so that it is relatively simple to solve the simplified governing equations used by laforce et al 2014a b nearly exactly in this instance there are three minor differences between the moose model and the model used by laforce et al 2014a b a constant fluid viscosity is used in the moose model whereas a special form of a temperature dependent fluid viscosity is used by laforce et al 2014a b the biot coefficient has been chosen as α b 1 0 in the moose model whereas a value of α b 0 72 was used in laforce et al 2014a b at various stages in their analyses laforce et al 2014a b assume either a constant fluid density or a small fluid compressibility which is the same for each phase in order to simplify the analysis in order to satisfy both the constant density assumption and small but finite compressibility requirements of the semi analytical solution the moose model uses a fluid bulk modulus that is 10 7 larger than any porepressures see table 2 these first two changes were implemented in the solutions of laforce et al 2014a b to enable the comparisons presented below the assumption of constant fluid viscosity results in only very small changes to the semi analytical solutions which would be difficult to observe due to the finite resolution of the numerical model a two dimensional radially symmetric finite element mesh was constructed for the model described in section 2 with a finer mesh resolution in the vicinity of the injection well and a successively coarser mesh resolution away from the well the model geometry reservoir properties and simplified fluid properties representative of water and co 2 at the given pressure and temperature used in this comparison are summarised in tables 1 and 2 in appendix c figure 2 shows the excellent agreement between the moose results and the semi analytical solutions of laforce et al 2014a b when some typographical errors in those solutions are corrected see appendix d for details minor discrepancies near the fronts are observed due to the finite mesh resolution but these can be reduced by simply increasing the resolution of the mesh in these regions this comparison between the semi analytical solutions of laforce et al 2014a b verifies that moose s porousflow module in conjunction with the tensormechanics module is capable of accurately solving this fully coupled thm problem over a wide range of length and time scales 4 extensions to full governing physics extensions to the benchmark problem are explored in this section to assess the effect of relaxing the assumptions of laforce et al 2014a b described in appendix b a 3d model is used to explicitly represent the overlying and underlying seals the height of the reservoir is 11 m while the top and bottom seals have height 40 m roller boundary conditions are placed on the top and bottom of the model and it is assumed that these boundaries are impermeable to fluid and heat a non zero capillary pressure between the gas and liquid phases is introduced this relaxes assumption 10 of appendix b and causes the effective fluid pressure in assumption 24 to be dependent on saturation a van genuchten 1980 expression 1 s water 1 α p gas p water 1 1 m m where s water is the liquid saturation p gas and p water are the gas and liquid phase porepressures respectively is used with α 10 5 pa 1 and m 0 5 using a nonzero capillary pressure means that the stress boundary condition at the wellbore can depend on both liquid and gas pressure to most closely mimic the boundary condition used by laforce et al 2014a b where the effective stress is zero at the wellbore the boundary condition σ r r tot r bh p is replaced by 2 σ r r tot r bh p f where σ r r tot is the total radial stress r bh is the radius of the wellbore and p f is the effective fluid pressure defined as 3 p f s water p water s gas p gas where s gas is the gas saturation assumption 12 in appendix b is relaxed so that the dynamical equations depend on the volumetric strain rate this couples solid mechanics into the fluid and heat equations consistent with this relaxation the reservoir porosity is also assumed to be a function of porepressure volumetric strain and temperature which relaxes assumption 1 the porosity ϕ evolves as detournay and cheng 1993 chen and zhang 2009 4 ϕ α b ϕ 0 α b exp α b 1 k drained p f p ref ϵ i i total 3 α t t t ref where α b is the biot coefficient ϕ 0 is the porosity at zero elastic strain and at reference porepressure p ref and temperature t ref k drained is the drained bulk modulus of the porous skeleton ϵ i i total is the total strain tensor of the porous solid and t is the temperature brine fluid properties based on driesner and heinrich 2007 driesner 2007 and the iapws if97 formulation iapws 2007 are used with a small salt mass fraction of 1 co 2 fluid properties from span and wagner 1996 are used this relaxes the assumptions of constant density 4 of appendix b constant viscosity 9 simplified internal energy 17 and 18 and simplified enthalpy 20 and 21 thermal conduction through the seals is included rather than using the lauwerier heat loss model see eq 27 in appendix b and the seals can inhibit the radial expansion and contraction of the reservoir assumption 32 moreover an isotropic thermal conductivity is used which relaxes assumption 19 to allow radial thermal conduction the numerical results for this full case are presented in fig 3 along with the semi analytical solutions of laforce et al 2014a b for comparison 2 2 note that in this case we plot the effective porepressure rather than liquid pressure as in the benchmark verification results it is clear that including the additional physics neglected in the analysis of laforce et al 2014a b results in significant changes most strikingly while the temperature and saturation fronts are still adequately captured large discrepancies in porepressure predictions and the geomechanical response of the reservoir are observed see fig 3 due to the flexible nature of the porousflow module we are able to determine which facets of the full governing physics have impacted the solution the following sections demonstrate that the main impacts of capillarity are to introduce bumps on the effective porepressure curves at the saturation front and to reduce the co 2 saturation including the seals retards temperature evolution reduces radial displacement and increases stress in the reservoir this is because the seals conduct heat from the reservoir and inhibit its movement using realistic co 2 properties tends to decrease the porepressure at early times but increase it at later times in order to accommodate the linearly increasing volume of co 2 compared with the semi analytic solution at later times the displacement and stress are governed by a complicated interplay between the seals and the fluid properties in the case studied the fluids counter chiefly using their thermal contraction both the diminished displacement and increased stress due to the seals dynamically changing porosity and ensuring mass and heat conservation appears to make little difference 4 1 nonzero capillary pressure enhancing the benchmark model by including capillarity effects the gas saturation as shown in fig 4 this figure plots the effective fluid pressure p f instead of the water porepressure the water porepressure is lower than p f while the gas porepressure is higher capillarity does not substantially affect the mechanical stresses the displacement or the temperature 4 2 dependence on volumetric strain rate and dynamic porosity enhancing the benchmark model by including the dependence on the volumetric strain rate and using dynamically changing porosity has little impact as can be seen from fig 5 4 3 realistic fluid properties the results of using realistic fluid properties are shown in fig 6 the most obvious change is in the porepressure because of the porepressure and temperature dependence of the density and viscosity the porepressure increment is initially a little smaller than laforce et al 2014a b but as time progresses the porepressure must increase substantially to support the continual injection of co 2 the temperature distribution is largely unaffected the co 2 saturation distribution is also largely unaffected although there is a noticeable wiggle at the position of the temperature front this wiggle was studied in detail by laforce et al 2014a b who showed it is due to the change in fluid viscosity at the temperature front when capillarity is included the wiggle virtually disappears the displacement is initially less since the outward displacement is largely driven by porepressure changes but as time progresses and temperature effects start to dominate the displacement in this case reverts to the one found by laforce et al 2014a b in this case the stresses are largely unaffected by the use of realistic fluid properties 4 4 seals and thermal conduction the results of including seals and thermal conduction are shown in fig 7 the temperature front moves slightly slower than the lauwerier heat loss model lauwerier 1955 meaning the cool temperature diffuses away to the seals slightly faster than the lauwerier model predicts the difference is quite small however and largely supports the use of the lauwerier model in the laforce et al 2014a b setup the most noticeable effect is on the displacement and the stresses the presence of the seals inhibits the radial contraction of the reservoir and the stresses are consequently higher 4 5 seals thermal conduction and realistic fluid properties the results of including seals thermal conduction and realistic fluid properties are shown in fig 8 which may be compared with the full case shown in fig 3 at early times the porepressure temperature and co 2 saturation are governed by the realistic fluid properties while the displacement and stresses are the same as when just seals and thermal conduction are included however at later times there is a complicated interplay between the enhancements with the fluid properties countering both the diminished displacement and increased stress due to the seals 5 conclusions the semi analytical solutions of laforce et al 2014a b were derived for a mathematically simplified conceptual model the results have been accurately reproduced by a benchmark numerical model using the moose software fig 3 demonstrates the semi analytical solutions are only qualitatively correct when the the assumptions of laforce et al 2014a b are removed the fluid and temperature fronts are reasonably accurately represented while other quantities have greater error in the case studied coupling the mechanics into the fluid and heat equations by including dependence on the volumetric strain rate and using dynamically changing porosity had negligible impact the practical consequence is that an accurate modelling strategy is to solve the fluid and heat evolution in one model and then introduce porepressure and temperature into a separate mechanical model to derive the displacement and stress this decoupling allows much greater freedom in building conceptual analytical and numerical models for instance the fluid and heat model may only include the reservoir and a portion of the seals in contrast an appropriate mechanical model must include substantial fractions of the surrounding rock to accurately determine stress and strain in the reservoir and even the entire overburden in order to assess up lift of the surface the numerical modelling revealed that the laforce et al 2014a b solution for the front in co 2 saturation is accurate and largely unaffected by the assumptions made similarly the front in temperature is reasonably accurate with the main error originating from the heat conduction into the seals and throughout the reservoir which are not perfectly captured by the lauwerier model used by laforce et al 2014a b the porepressure is significantly altered by capillarity as well as pressure and temperature dependent fluid properties the bulk modulus for co 2 is not infinite as assumed by laforce et al 2014a b and brine s thermal expansion coefficient is nonzero another assumption which means that porepressure at earlier times tends to be lower and higher at later times compared with the semi analytic solutions when using realistic fluid properties the porepressure response to injection is also impacted by the seals because of their effect on temperature distribution these observations suggest that the semi analytical solutions are most useful at predicting the temperature and fluid fronts and only qualitatively describing the porepressure displacement stress and magnitude of gas saturation armed with this understanding the laforce et al 2014a b solutions are useful for rapid investigation of projects involving injection of colder fluid into warm aquifers in the general setting moose s ability to include high precision equations of state capillarity heterogeneity anisotropy rock plasticity fractures and fracture propogation geochemistry and multicomponent flows may be vital for accurate predictions also of note is moose s advanced computational scalability which leads to small model runtimes we conclude that the enhancements afforded by moose mean it should be preferred for more sophisticated analyses validating complex coupled codes is challenging the laforce et al 2014a b model employs many different physics and couplings so we propose that the model contained herein can be used as a benchmark for other coupled codes input files for this model are provided on the moose website alger et al 2019 and as part of the moose repository to allow readers to replicate these results 6 computer code availability the porousflow modelling tool used in this study is freely available at https github com idaholab moose tree master modules porous flow it is bundled within the moose framework https github com idaholab moose to install moose and porousflow please follow the instructions at https mooseframework org getting started index html the porousflow input file for the basic model described here is available at https github com idaholab moose tree master modules porous flow examples thm example 2d i the porousflow input files for all models described here along with results are available at https github com wilkandy tara cf moose models declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors wish to acknowledge financial assistance provided through australian national low emissions coal research and development anlec r d anlec r d is supported by australian coal association low emissions technology limited and the australian government through the clean energy initiative sandia national laboratories is a multi mission laboratory managed and operated by national technology and engineering solutions of sandia llc a wholly owned subsidiary of honeywell international inc for the u s department of energys national nuclear security administration under contract de na 0003525 this paper describes objective technical results and analysis any subjective views or opinions that might be expressed in the paper do not necessarily represent the views of the u s department of energy or the united states government this paper is sandia publication sand no sand2020 3282 j appendix a governing equations the governing equations of fluid transport heat transport and solid mechanics implemented in moose are presented here in brief wilkins et al 2020 the mass of fluid species κ per volume of rock with units kg m 3 for instance is written as a sum over all phases β present in the system 5 m κ ϕ β s β ρ β χ β κ 1 ϕ c κ where ϕ is porosity s is saturation ρ is fluid density χ is mass fraction and c is adsorbed fluid mass per unit volume of rock mass conservation for fluid species κ is described by the continuity equation 6 0 m κ t m κ v s f κ λ m κ q κ here v s is the velocity of the solid skeleton so the second term ensures mass conservation in a deforming rock f κ is flux of fluid species κ λ m describes radioactive decay while q is a fluid source including geochemistry the heat energy per unit volume is 7 e 1 ϕ ρ r c r t ϕ β s β ρ β e β t is the temperature ρ r c r t is the energy density of the solid rock and e is the energy density of the fluid energy conservation for heat is described by the continuity equation 8 0 e t e v s f t q t the second term ensures energy conservation in a deforming rock f t is heat flux a sum of heat conduction and convection with the fluid and so different to f κ and q is a heat source moose uses the convention that a negative stress results from a compression while a positive stress corresponds to tension we denote the effective stress tensor by σ eff defined as 9 σ i j eff σ i j tot α b δ i j p f where σ tot is the total mechanical stress α b is the biot coefficient and p f is an effective fluid porepressure in the case of thermo elasticity used here the constitutive law is 10 σ i j eff e i j k l ϵ k l elastic δ k l α t t t ref where e i j k l is the elasticity tensor and α t a coefficient of thermal expansion conservation of momentum is 11 ρ mat v s j t i σ i j tot ρ mat b j i σ i j eff α b j p f ρ mat b j here ρ mat is the undrained density of the fluid filled rock and b j is a body acceleration due to gravity for instance appendix b assumptions made in laforce et al 2014a b here we describe the assumptions made by laforce et al 2014a b to derive their governing equations we then describe boundary conditions b1 fluid flow laforce et al 2014a b assume 1 the porosity ϕ is constant it is independent of time fluid pressure temperature and volumetric expansion however it is dependent on rock type 2 there are two phases liquid and gas hence β liquid gas 3 the liquid is water and the gas is co 2 hence κ water co2 the water component exists only in the liquid phase and the co 2 component exists only in the gas phase hence χ liquid water 1 χ liquid co 2 0 χ gas water 0 and χ gas co 2 1 4 the density of each phase is constant so the total volumetric flow rate is constant across the entire system when the rate of injection is constant this simplifies the fluid equations which eventually reduce to a well studied form that models advection of a saturation shock front however in order to derive solutions for the pressure distribution laforce et al 2014a b assume a small fluid compressibility which is the same for each phase to satisfy both the incompressibility and small compressibility requirements the moose model uses a fluid bulk modulus that is 10 7 larger than any porepressures 5 there is no adsorbed fluid with these assumptions eq 5 becomes for two fluid species water and co 2 12 m water ϕ s water ρ water m co 2 ϕ 1 s water ρ co 2 because of the assumptions regarding the mass fractions there is no diffusion or dispersion the advective fluid flux is 13 f κ β χ β κ f β advective which is governed by darcy s law 14 f β advective ρ β v β ρ β k k r β μ β p β ρ β g laforce et al 2014a b assume 6 the permeability tensor is radially symmetric and constant independent of fluid pressure temperature and rock stress and strain its z z component is zero it is dependent on rock type 7 there is a constant and nonzero residual water saturation s water res and constant and nonzero residual co 2 saturation s co 2 res 8 the relative permeability functions are functions of the effective saturation 15 s s water s water res 1 s water res s co 2 res and the functions are 16 k r water s 4 k r co 2 1 s 2 1 s 2 9 the viscosity is a function of temperature only laforce et al 2014a b use a particular function of temperature that is not included in porousflow therefore we use a constant viscosity for each phase that is equal to the average viscosity of laforce et al 2014a b and re calculate the solution based on that constant viscosity this largely decouples the fluid and heat flow this results in only very tiny modifications to laforce et al 2014a b solutions which would be difficult to see in the moose model anyway 10 there is no capillarity therefore p water p co 2 define p p water 11 there is no gravity with these assumptions the fluid mass fluxes are 17 f water ρ water k k r water μ water p f co 2 ρ co 2 k k r co 2 μ co 2 p laforce et al 2014a b also simplify mass conservation by assuming 12 the term v s is ignored 13 there is no radioactive decay λ 0 14 sources and sinks only occur on the boundary so q 0 except for on the boundary under these assumptions eq 6 reduces to 18 0 ϕ s water k k r water μ water p 0 ϕ s water k k r co 2 μ co 2 p the sum of these yields the total flow rate 19 q t k k r water μ water k r co 2 μ co 2 p this total flow rate is dependent on time controlled by the boundary conditions but satisfies q 0 for later use we define the component flows 20 q water k k r water μ water p q co 2 k k r co 2 μ co 2 p b2 heat flow laforce et al 2014a b assume 15 the rock grain density ρ r is constant 16 the specific heat capacity of the rock grains c r is constant 17 the internal energy of the liquid phase is e liquid c water t where c water is constant and independent of all other parameters in the system 18 the internal energy of the gas phase is e gas c co 2 t where c co 2 is constant and independent of all other parameters of the system with these assumptions eq 7 is 21 e 1 ϕ ρ r c r t ϕ s water ρ water c water t ϕ 1 s water ρ co 2 c co 2 t the heat flux is a sum of heat conduction and convection with the fluid 22 f t λ t β h β f β where λ is the thermal conductivity of the rock and h β is the enthalpy of phase β in addition it is assumed that 19 the only non zero component of the thermal conductivity is the z z component it varies with water saturation 23 λ z z λ z z 0 λ z z 1 λ z z 0 s water the coefficients λ z z 0 and λ z z 1 are independent of time fluid pressure temperature and mechanical deformation but they are dependent on rock type 20 the enthalpy of the liquid phase is h liquid c water t 21 the enthalpy of the liquid phase is h gas c co 2 t with the assumptions made so far 24 f t λ t c water ρ water q water t c co 2 ρ co 2 q co 2 t where the component flows of eq 20 have been employed energy conservation is simplified by assuming 22 there are no heat sources save for on the boundary with the assumptions made so far eq 8 becomes 25 0 t ρ c t λ t ρ c q t where the following two variables ρ c and ρ c q have been defined 26 ρ c 1 ϕ ρ r c r ϕ s water ρ water c water ϕ 1 s water ρ co 2 c co 2 ρ c q ρ water c water q water ρ co 2 c co 2 q co 2 eqs 25 and 26 are exactly eq a1 in laforce et al 2014a during the course of their analysis laforce et al 2014a b replace the diffusive term λ t with a lauwerier heat loss expression lauwerier 1955 27 λ t λ t t ref the new heat loss coefficient is then 28 λ u l h k a ρ c a h t this is a particularly nice approximation because it means that the overburden and underburden don t need to be considered any further in the analysis it does mean however that the mechanical effects of these surrounding rocks on the aquifer are not modelled by laforce et al 2014a b b3 solid mechanics laforce et al 2014a b simplify the solid mechanics by assuming 23 the biot coefficient α b is constant and independent of all other parameters in the theory 24 the effective fluid pressure is p f p the constitutive law is 29 σ i j eff e i j k l ϵ k l elastic δ k l α t t t ref furthermore it is assumed 25 there is no plasticity 26 the drained elasticity tensor e i j k l is isotropic constant and independent of all other parameters in the theory 27 the drained thermal expansion coefficient α t is constant and independent of all other parameters in the theory to simplify eq 11 laforce et al 2014a b assume 28 the acceleration of the solid skeleton v s is zero 29 there are no body forces b 0 except on the boundary the effective stress not the total stress enters into the constitutive law and the the in situ stresses moose also outputs effective stresses by default however when specifying neumann boundary conditions in moose total stresses are used b4 final assumptions initial and boundary conditions finally it is assumed that 30 the reservoir is initially fully water saturated 31 there is no displacement in the z direction u z 0 32 the reservoir is free to contract and expand radially without being hindered by the impermeable seals there is no dependence on the axial coordinates z because of the use of the lauwerier heat loss model eqs 27 and 28 that approximates axial heat conduction therefore all independent variables the water saturation s water fluid porepressure p temperature t and radial displacement u r are dependent on radius r only the problem is completed by employing the following boundary conditions the total radial compressive stress at the well is equal to the porepressure in the well the value of wellbore pressure is dictated by the dynamics of the problem since the injection rate is constant the porepressure will increase with time 30 σ r r tot r bh p the porepressure at the outer boundary is 31 p r max p 0 the temperature at the outer boundary is 32 t r max t 0 all displacements at the outer boundary are zero 33 u r max 0 appendix c parameter values the numerical values of the parameters used in this study are presented in tables 1 and 2 for the full physics models and benchmark verification model respectively appendix d laforce et al 2014b erratum there are some errors in laforce et al 2014b that we correct below equation a 2 of that paper should read 34 a b ξ 1 2 u p r ξ 1 ξ 1 b 1 2 ν σ d ξ 1 t d u p r ξ 1 ξ 1 1 2 ν 1 ξ 1 2 the value of the non dimensionalised stress in the expression for b is 35 σ d ξ 1 t d p d w t d p 0 d σ h d e 1 ν α t r e where p d w t d p 0 d is the porepressure increase at the well the graphs of displacements shown in laforce et al 2014b are largely unchanged with these corrections however the stresses close to the well are impacted compare fig 5 of laforce et al 2014b with fig 2 of this study 
292,the geomechanical response of a porous reservoir due to injection of fluid can result from a complex interplay between the changes in porepressure and temperature near the wellbore as a result predictions are usually made using either simplified analytical models which may apply unrealistic assumptions in order to produce a tractable model or detailed numerical simulations that can be computationally expensive laforce et al 2014a 2014b developed a semi analytical model for the geomechanical response of a reservoir to nonisothermal multi phase fluid injection which has been used in studies of co 2 sequestration we demonstrate that a numerical solution using the moose software precisely matches the analytical formulae we then include various effects in the numerical model that relax the simplifying assumptions made in the analytical derivation we find the analytic and numerical solutions for the fluid and temperature fronts still agree reasonably while only qualitative agreement is observed for other quantities such as stress and displacement we conclude the laforce et al 2014a b solutions are useful for rapid investigation of projects involving injection of cold fluid into warm aquifers however the enhancements afforded by moose such as high precision fluid equations of state and the ability to more accurately capture geological complexity along with its computational scalability which greatly reduces runtimes means that moose should be preferred for more sophisticated analyses because validating complex coupled codes is challenging we propose that the model contained herein can be used as a benchmark for other coupled codes 1 introduction injection or production of fluid into or from the subsurface changes the pressure near the wellbore which can affect the stresses in the reservoir rock complicating this is the possible temperature difference between injected fluid and the ambient reservoir temperature which leads to thermally induced stress changes near the wellbore 1 1 fluid production typically does not change the reservoir temperature near the wellbore unless via the joule thomson effect or if coning is induced where warmer formation water below the injection depth is drawn up to the wellbore this change in reservoir stress can lead to a number of possible effects in the reservoir some adverse such as uplift or subsidence at the surface changes in pressure in overlaying or underlying aquifers reactivation of nearby faults or fractures and even the possibility of creating new fractures a number of studies have investigated coupled geomechanics and multiphase fluid flow scenarios using various numerical tools and coupling schemes e g rutqvist et al 2002 rutqvist and tsang 2002 minkoff et al 2003 dean et al 2006 rutqvist et al 2008 xu et al 2012 kim and moridis 2013 kim et al 2015 rutqvist 2017 one area of concern that has previously been addressed in the literature is the risk that increased reservoir pressure due to fluid injection may cause reactivation of existing faults near the wellbore particularly in the context of geological storage of co 2 e g cappa and rutqvist 2011 morris et al 2011 mazzoldi et al 2012 bao et al 2013 uplift or subsidence of the caprock reservoir interface and subsequent deformation at the ground surface have also been the subject of a number of numerical studies again commonly in regard to large scale underground storage of co 2 one notable example of this is the co 2 storage project at in salah in algeria where a measurable uplift in the surface was observed as a result of injection of co 2 into a low permeability formation mathieson et al 2011 rinaldi et al 2017 a number of studies have attempted to interpret these observations in order to increase understanding of important reservoir parameters e g rutqvist et al 2010 typically these numerical models are computationally expensive and require significant effort to properly characterise the reservoir in contrast analytical models can provide rapid and concise descriptions of how the system responds to variations of the input parameters without having to resort to time consuming and sometimes rather opaque numerical simulation for both the numerical and analytical cases conceptual models simplify the complex physical reality however it is usually necessary to further simplify the mathematics in order to construct an analytical solution and so modellers are left wondering if the physical situation really responds in the same way as the analytic solution in this study we explore injection of a cool fluid into a warmer idealized reservoir and examine the applicability of the semi analytical model of laforce et al 2014a b once the simplifying assumptions are relaxed we investigate coupled pressure and thermal effects on the stress and displacement and vice versa using fully coupled physics in the porousflow module wilkins et al 2020 of moose permann et al 2019 alger et al 2019 this is a high performance open source code that is particularly designed for fully coupled multi physics problems sample input files that replicate the results presented in this study are provided by the authors as part of the moose framework for readers to use alger et al 2019 this study is comprised of two parts in the first we verify the moose numerical model against the semi analytical solutions of laforce et al 2014a b for a simplified two phase thm problem involving injection of a cold fluid into a warmer elastic axially symmetric reservoir in the second part we relax the simplifications implemented in the code verification to explore the interplay between pressure temperature displacement and stress and evaluate the suitability of the semi analytical solutions of laforce et al 2014a b for cases where the simplifying assumptions used in their derivation no longer hold the following effects are explored 1 the dependence on volumetric strain rate is included so that fluid mass conservation and heat energy conservation is guaranteed and the physics is fully coupled 2 the porosity is allowed to evolve according to standard thermo poro elasticity theory 3 a nonzero capillary pressure is included 4 high precision equations of state for brine and co 2 are used which relaxes the assumptions of constant density constant viscosity and simplified internal energy and enthalpy 5 low permeability seals that largely trap the injected fluid but allow thermal conduction and impact the mechanical stresses and strains are included with all these extensions active we find the analytic and numerical solutions for the fluid and temperature fronts agree reasonably while only qualitative agreement is observed for other quantities capillarity perturbs the effective porepressure a weighted average of liquid and gas porepressure around the saturation front and reduces co 2 saturation the seals retard temperature evolution reduce displacement and increase stress the realistic fluid properties mean porepressure is lower at early times but higher at later times displacement and stress are governed by an interplay between the effect of the seals and fluid properties dynamically changing porosity makes little difference in this example the fluid heat evolution drives the mechanical response but not vice versa suggesting that an appropriate modelling strategy is to solve the fluid heat evolution separately and then impose the porepressure and temperature upon a mechanical model to determine displacement and stress based on the results we propose that the laforce et al 2014a b solutions are useful for rapid investigation of projects involving injection of cold fluid into warm aquifers in contrast to the analytic approach moose can easily employ high precision fluid equations of state capillarity and geological complexity all which impact porepressure gas saturation stress and strain distributions in the current model moose models can also incorporate heterogeneity anisotropy rock plasticity fractures and fracture propogation geochemistry and multicomponent flows all of which may be important in certain situations in addition moose s advanced computational scalability means that model runtimes are much lower than when using traditional codes we conclude that the enhancements afforded by moose mean it should be preferred for more sophisticated analyses when data is available to populate the complex model validating complex coupled codes is challenging because the physics contained in the codes is often subtly different than that of the analytical models such as the assumption of incompressibility in only some parts but not all parts of the laforce et al 2014a b derivation and because numerical artifacts such as time step sizes discretisation error and numerical stabilization schemes all impact the numerical solution the laforce et al 2014a b solutions are extremely useful in engineering assessments of contemporary projects such as co 2 sequestration or subsurface energy storage proposals and the model employs many different physics and couplings for these reasons this article s code validation is significant and can provide a demanding benchmark for other coupled codes 2 model description we consider an axially symmetric model of a reservoir bounded above and below by impermeable caprock see fig 1 the radial coordinate is labeled r and axial coordinate z the reservoir and seals are oriented horizontally normal to z a vertical wellbore intersects the reservoir and injects fluid in this case supercritical co 2 into it at a constant rate the co 2 is colder than the initial reservoir temperature the injected fluid moves through the reservoir heat or cold advects with the fluid slowly cooling the reservoir and conducting into the surrounding seals the porousflow module used in this study to undertake numerical simulations describes multiphase multicomponent flow of fluid and heat in porous media when used with the tensormechanics module also freely available as part of the moose framework permann et al 2019 alger et al 2019 fully coupled thermo hydro mechanical thm simulations are possible we summarise the governing equations used in appendix a 3 numerical model verification in order to verify the moose model for this coupled thm problem of injection of cold fluid into a warm elastic reservoir we replicate the simplified model used in laforce et al 2014a b we call this the benchmark model laforce et al 2014a b develop a semi analytical solution for this problem by extending and combining ideas and results derived by lauwerier 1955 rehbinder 1995 dindoruk and dindoruk 2008 however to make this problem tractable and enable a semi analytical solution laforce et al 2014a b make several important simplifications to the governing equations which we list in detail in appendix b one of the features of the porousflow module and moose in general is the ability to easily include or exclude physics as desired so that it is relatively simple to solve the simplified governing equations used by laforce et al 2014a b nearly exactly in this instance there are three minor differences between the moose model and the model used by laforce et al 2014a b a constant fluid viscosity is used in the moose model whereas a special form of a temperature dependent fluid viscosity is used by laforce et al 2014a b the biot coefficient has been chosen as α b 1 0 in the moose model whereas a value of α b 0 72 was used in laforce et al 2014a b at various stages in their analyses laforce et al 2014a b assume either a constant fluid density or a small fluid compressibility which is the same for each phase in order to simplify the analysis in order to satisfy both the constant density assumption and small but finite compressibility requirements of the semi analytical solution the moose model uses a fluid bulk modulus that is 10 7 larger than any porepressures see table 2 these first two changes were implemented in the solutions of laforce et al 2014a b to enable the comparisons presented below the assumption of constant fluid viscosity results in only very small changes to the semi analytical solutions which would be difficult to observe due to the finite resolution of the numerical model a two dimensional radially symmetric finite element mesh was constructed for the model described in section 2 with a finer mesh resolution in the vicinity of the injection well and a successively coarser mesh resolution away from the well the model geometry reservoir properties and simplified fluid properties representative of water and co 2 at the given pressure and temperature used in this comparison are summarised in tables 1 and 2 in appendix c figure 2 shows the excellent agreement between the moose results and the semi analytical solutions of laforce et al 2014a b when some typographical errors in those solutions are corrected see appendix d for details minor discrepancies near the fronts are observed due to the finite mesh resolution but these can be reduced by simply increasing the resolution of the mesh in these regions this comparison between the semi analytical solutions of laforce et al 2014a b verifies that moose s porousflow module in conjunction with the tensormechanics module is capable of accurately solving this fully coupled thm problem over a wide range of length and time scales 4 extensions to full governing physics extensions to the benchmark problem are explored in this section to assess the effect of relaxing the assumptions of laforce et al 2014a b described in appendix b a 3d model is used to explicitly represent the overlying and underlying seals the height of the reservoir is 11 m while the top and bottom seals have height 40 m roller boundary conditions are placed on the top and bottom of the model and it is assumed that these boundaries are impermeable to fluid and heat a non zero capillary pressure between the gas and liquid phases is introduced this relaxes assumption 10 of appendix b and causes the effective fluid pressure in assumption 24 to be dependent on saturation a van genuchten 1980 expression 1 s water 1 α p gas p water 1 1 m m where s water is the liquid saturation p gas and p water are the gas and liquid phase porepressures respectively is used with α 10 5 pa 1 and m 0 5 using a nonzero capillary pressure means that the stress boundary condition at the wellbore can depend on both liquid and gas pressure to most closely mimic the boundary condition used by laforce et al 2014a b where the effective stress is zero at the wellbore the boundary condition σ r r tot r bh p is replaced by 2 σ r r tot r bh p f where σ r r tot is the total radial stress r bh is the radius of the wellbore and p f is the effective fluid pressure defined as 3 p f s water p water s gas p gas where s gas is the gas saturation assumption 12 in appendix b is relaxed so that the dynamical equations depend on the volumetric strain rate this couples solid mechanics into the fluid and heat equations consistent with this relaxation the reservoir porosity is also assumed to be a function of porepressure volumetric strain and temperature which relaxes assumption 1 the porosity ϕ evolves as detournay and cheng 1993 chen and zhang 2009 4 ϕ α b ϕ 0 α b exp α b 1 k drained p f p ref ϵ i i total 3 α t t t ref where α b is the biot coefficient ϕ 0 is the porosity at zero elastic strain and at reference porepressure p ref and temperature t ref k drained is the drained bulk modulus of the porous skeleton ϵ i i total is the total strain tensor of the porous solid and t is the temperature brine fluid properties based on driesner and heinrich 2007 driesner 2007 and the iapws if97 formulation iapws 2007 are used with a small salt mass fraction of 1 co 2 fluid properties from span and wagner 1996 are used this relaxes the assumptions of constant density 4 of appendix b constant viscosity 9 simplified internal energy 17 and 18 and simplified enthalpy 20 and 21 thermal conduction through the seals is included rather than using the lauwerier heat loss model see eq 27 in appendix b and the seals can inhibit the radial expansion and contraction of the reservoir assumption 32 moreover an isotropic thermal conductivity is used which relaxes assumption 19 to allow radial thermal conduction the numerical results for this full case are presented in fig 3 along with the semi analytical solutions of laforce et al 2014a b for comparison 2 2 note that in this case we plot the effective porepressure rather than liquid pressure as in the benchmark verification results it is clear that including the additional physics neglected in the analysis of laforce et al 2014a b results in significant changes most strikingly while the temperature and saturation fronts are still adequately captured large discrepancies in porepressure predictions and the geomechanical response of the reservoir are observed see fig 3 due to the flexible nature of the porousflow module we are able to determine which facets of the full governing physics have impacted the solution the following sections demonstrate that the main impacts of capillarity are to introduce bumps on the effective porepressure curves at the saturation front and to reduce the co 2 saturation including the seals retards temperature evolution reduces radial displacement and increases stress in the reservoir this is because the seals conduct heat from the reservoir and inhibit its movement using realistic co 2 properties tends to decrease the porepressure at early times but increase it at later times in order to accommodate the linearly increasing volume of co 2 compared with the semi analytic solution at later times the displacement and stress are governed by a complicated interplay between the seals and the fluid properties in the case studied the fluids counter chiefly using their thermal contraction both the diminished displacement and increased stress due to the seals dynamically changing porosity and ensuring mass and heat conservation appears to make little difference 4 1 nonzero capillary pressure enhancing the benchmark model by including capillarity effects the gas saturation as shown in fig 4 this figure plots the effective fluid pressure p f instead of the water porepressure the water porepressure is lower than p f while the gas porepressure is higher capillarity does not substantially affect the mechanical stresses the displacement or the temperature 4 2 dependence on volumetric strain rate and dynamic porosity enhancing the benchmark model by including the dependence on the volumetric strain rate and using dynamically changing porosity has little impact as can be seen from fig 5 4 3 realistic fluid properties the results of using realistic fluid properties are shown in fig 6 the most obvious change is in the porepressure because of the porepressure and temperature dependence of the density and viscosity the porepressure increment is initially a little smaller than laforce et al 2014a b but as time progresses the porepressure must increase substantially to support the continual injection of co 2 the temperature distribution is largely unaffected the co 2 saturation distribution is also largely unaffected although there is a noticeable wiggle at the position of the temperature front this wiggle was studied in detail by laforce et al 2014a b who showed it is due to the change in fluid viscosity at the temperature front when capillarity is included the wiggle virtually disappears the displacement is initially less since the outward displacement is largely driven by porepressure changes but as time progresses and temperature effects start to dominate the displacement in this case reverts to the one found by laforce et al 2014a b in this case the stresses are largely unaffected by the use of realistic fluid properties 4 4 seals and thermal conduction the results of including seals and thermal conduction are shown in fig 7 the temperature front moves slightly slower than the lauwerier heat loss model lauwerier 1955 meaning the cool temperature diffuses away to the seals slightly faster than the lauwerier model predicts the difference is quite small however and largely supports the use of the lauwerier model in the laforce et al 2014a b setup the most noticeable effect is on the displacement and the stresses the presence of the seals inhibits the radial contraction of the reservoir and the stresses are consequently higher 4 5 seals thermal conduction and realistic fluid properties the results of including seals thermal conduction and realistic fluid properties are shown in fig 8 which may be compared with the full case shown in fig 3 at early times the porepressure temperature and co 2 saturation are governed by the realistic fluid properties while the displacement and stresses are the same as when just seals and thermal conduction are included however at later times there is a complicated interplay between the enhancements with the fluid properties countering both the diminished displacement and increased stress due to the seals 5 conclusions the semi analytical solutions of laforce et al 2014a b were derived for a mathematically simplified conceptual model the results have been accurately reproduced by a benchmark numerical model using the moose software fig 3 demonstrates the semi analytical solutions are only qualitatively correct when the the assumptions of laforce et al 2014a b are removed the fluid and temperature fronts are reasonably accurately represented while other quantities have greater error in the case studied coupling the mechanics into the fluid and heat equations by including dependence on the volumetric strain rate and using dynamically changing porosity had negligible impact the practical consequence is that an accurate modelling strategy is to solve the fluid and heat evolution in one model and then introduce porepressure and temperature into a separate mechanical model to derive the displacement and stress this decoupling allows much greater freedom in building conceptual analytical and numerical models for instance the fluid and heat model may only include the reservoir and a portion of the seals in contrast an appropriate mechanical model must include substantial fractions of the surrounding rock to accurately determine stress and strain in the reservoir and even the entire overburden in order to assess up lift of the surface the numerical modelling revealed that the laforce et al 2014a b solution for the front in co 2 saturation is accurate and largely unaffected by the assumptions made similarly the front in temperature is reasonably accurate with the main error originating from the heat conduction into the seals and throughout the reservoir which are not perfectly captured by the lauwerier model used by laforce et al 2014a b the porepressure is significantly altered by capillarity as well as pressure and temperature dependent fluid properties the bulk modulus for co 2 is not infinite as assumed by laforce et al 2014a b and brine s thermal expansion coefficient is nonzero another assumption which means that porepressure at earlier times tends to be lower and higher at later times compared with the semi analytic solutions when using realistic fluid properties the porepressure response to injection is also impacted by the seals because of their effect on temperature distribution these observations suggest that the semi analytical solutions are most useful at predicting the temperature and fluid fronts and only qualitatively describing the porepressure displacement stress and magnitude of gas saturation armed with this understanding the laforce et al 2014a b solutions are useful for rapid investigation of projects involving injection of colder fluid into warm aquifers in the general setting moose s ability to include high precision equations of state capillarity heterogeneity anisotropy rock plasticity fractures and fracture propogation geochemistry and multicomponent flows may be vital for accurate predictions also of note is moose s advanced computational scalability which leads to small model runtimes we conclude that the enhancements afforded by moose mean it should be preferred for more sophisticated analyses validating complex coupled codes is challenging the laforce et al 2014a b model employs many different physics and couplings so we propose that the model contained herein can be used as a benchmark for other coupled codes input files for this model are provided on the moose website alger et al 2019 and as part of the moose repository to allow readers to replicate these results 6 computer code availability the porousflow modelling tool used in this study is freely available at https github com idaholab moose tree master modules porous flow it is bundled within the moose framework https github com idaholab moose to install moose and porousflow please follow the instructions at https mooseframework org getting started index html the porousflow input file for the basic model described here is available at https github com idaholab moose tree master modules porous flow examples thm example 2d i the porousflow input files for all models described here along with results are available at https github com wilkandy tara cf moose models declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the authors wish to acknowledge financial assistance provided through australian national low emissions coal research and development anlec r d anlec r d is supported by australian coal association low emissions technology limited and the australian government through the clean energy initiative sandia national laboratories is a multi mission laboratory managed and operated by national technology and engineering solutions of sandia llc a wholly owned subsidiary of honeywell international inc for the u s department of energys national nuclear security administration under contract de na 0003525 this paper describes objective technical results and analysis any subjective views or opinions that might be expressed in the paper do not necessarily represent the views of the u s department of energy or the united states government this paper is sandia publication sand no sand2020 3282 j appendix a governing equations the governing equations of fluid transport heat transport and solid mechanics implemented in moose are presented here in brief wilkins et al 2020 the mass of fluid species κ per volume of rock with units kg m 3 for instance is written as a sum over all phases β present in the system 5 m κ ϕ β s β ρ β χ β κ 1 ϕ c κ where ϕ is porosity s is saturation ρ is fluid density χ is mass fraction and c is adsorbed fluid mass per unit volume of rock mass conservation for fluid species κ is described by the continuity equation 6 0 m κ t m κ v s f κ λ m κ q κ here v s is the velocity of the solid skeleton so the second term ensures mass conservation in a deforming rock f κ is flux of fluid species κ λ m describes radioactive decay while q is a fluid source including geochemistry the heat energy per unit volume is 7 e 1 ϕ ρ r c r t ϕ β s β ρ β e β t is the temperature ρ r c r t is the energy density of the solid rock and e is the energy density of the fluid energy conservation for heat is described by the continuity equation 8 0 e t e v s f t q t the second term ensures energy conservation in a deforming rock f t is heat flux a sum of heat conduction and convection with the fluid and so different to f κ and q is a heat source moose uses the convention that a negative stress results from a compression while a positive stress corresponds to tension we denote the effective stress tensor by σ eff defined as 9 σ i j eff σ i j tot α b δ i j p f where σ tot is the total mechanical stress α b is the biot coefficient and p f is an effective fluid porepressure in the case of thermo elasticity used here the constitutive law is 10 σ i j eff e i j k l ϵ k l elastic δ k l α t t t ref where e i j k l is the elasticity tensor and α t a coefficient of thermal expansion conservation of momentum is 11 ρ mat v s j t i σ i j tot ρ mat b j i σ i j eff α b j p f ρ mat b j here ρ mat is the undrained density of the fluid filled rock and b j is a body acceleration due to gravity for instance appendix b assumptions made in laforce et al 2014a b here we describe the assumptions made by laforce et al 2014a b to derive their governing equations we then describe boundary conditions b1 fluid flow laforce et al 2014a b assume 1 the porosity ϕ is constant it is independent of time fluid pressure temperature and volumetric expansion however it is dependent on rock type 2 there are two phases liquid and gas hence β liquid gas 3 the liquid is water and the gas is co 2 hence κ water co2 the water component exists only in the liquid phase and the co 2 component exists only in the gas phase hence χ liquid water 1 χ liquid co 2 0 χ gas water 0 and χ gas co 2 1 4 the density of each phase is constant so the total volumetric flow rate is constant across the entire system when the rate of injection is constant this simplifies the fluid equations which eventually reduce to a well studied form that models advection of a saturation shock front however in order to derive solutions for the pressure distribution laforce et al 2014a b assume a small fluid compressibility which is the same for each phase to satisfy both the incompressibility and small compressibility requirements the moose model uses a fluid bulk modulus that is 10 7 larger than any porepressures 5 there is no adsorbed fluid with these assumptions eq 5 becomes for two fluid species water and co 2 12 m water ϕ s water ρ water m co 2 ϕ 1 s water ρ co 2 because of the assumptions regarding the mass fractions there is no diffusion or dispersion the advective fluid flux is 13 f κ β χ β κ f β advective which is governed by darcy s law 14 f β advective ρ β v β ρ β k k r β μ β p β ρ β g laforce et al 2014a b assume 6 the permeability tensor is radially symmetric and constant independent of fluid pressure temperature and rock stress and strain its z z component is zero it is dependent on rock type 7 there is a constant and nonzero residual water saturation s water res and constant and nonzero residual co 2 saturation s co 2 res 8 the relative permeability functions are functions of the effective saturation 15 s s water s water res 1 s water res s co 2 res and the functions are 16 k r water s 4 k r co 2 1 s 2 1 s 2 9 the viscosity is a function of temperature only laforce et al 2014a b use a particular function of temperature that is not included in porousflow therefore we use a constant viscosity for each phase that is equal to the average viscosity of laforce et al 2014a b and re calculate the solution based on that constant viscosity this largely decouples the fluid and heat flow this results in only very tiny modifications to laforce et al 2014a b solutions which would be difficult to see in the moose model anyway 10 there is no capillarity therefore p water p co 2 define p p water 11 there is no gravity with these assumptions the fluid mass fluxes are 17 f water ρ water k k r water μ water p f co 2 ρ co 2 k k r co 2 μ co 2 p laforce et al 2014a b also simplify mass conservation by assuming 12 the term v s is ignored 13 there is no radioactive decay λ 0 14 sources and sinks only occur on the boundary so q 0 except for on the boundary under these assumptions eq 6 reduces to 18 0 ϕ s water k k r water μ water p 0 ϕ s water k k r co 2 μ co 2 p the sum of these yields the total flow rate 19 q t k k r water μ water k r co 2 μ co 2 p this total flow rate is dependent on time controlled by the boundary conditions but satisfies q 0 for later use we define the component flows 20 q water k k r water μ water p q co 2 k k r co 2 μ co 2 p b2 heat flow laforce et al 2014a b assume 15 the rock grain density ρ r is constant 16 the specific heat capacity of the rock grains c r is constant 17 the internal energy of the liquid phase is e liquid c water t where c water is constant and independent of all other parameters in the system 18 the internal energy of the gas phase is e gas c co 2 t where c co 2 is constant and independent of all other parameters of the system with these assumptions eq 7 is 21 e 1 ϕ ρ r c r t ϕ s water ρ water c water t ϕ 1 s water ρ co 2 c co 2 t the heat flux is a sum of heat conduction and convection with the fluid 22 f t λ t β h β f β where λ is the thermal conductivity of the rock and h β is the enthalpy of phase β in addition it is assumed that 19 the only non zero component of the thermal conductivity is the z z component it varies with water saturation 23 λ z z λ z z 0 λ z z 1 λ z z 0 s water the coefficients λ z z 0 and λ z z 1 are independent of time fluid pressure temperature and mechanical deformation but they are dependent on rock type 20 the enthalpy of the liquid phase is h liquid c water t 21 the enthalpy of the liquid phase is h gas c co 2 t with the assumptions made so far 24 f t λ t c water ρ water q water t c co 2 ρ co 2 q co 2 t where the component flows of eq 20 have been employed energy conservation is simplified by assuming 22 there are no heat sources save for on the boundary with the assumptions made so far eq 8 becomes 25 0 t ρ c t λ t ρ c q t where the following two variables ρ c and ρ c q have been defined 26 ρ c 1 ϕ ρ r c r ϕ s water ρ water c water ϕ 1 s water ρ co 2 c co 2 ρ c q ρ water c water q water ρ co 2 c co 2 q co 2 eqs 25 and 26 are exactly eq a1 in laforce et al 2014a during the course of their analysis laforce et al 2014a b replace the diffusive term λ t with a lauwerier heat loss expression lauwerier 1955 27 λ t λ t t ref the new heat loss coefficient is then 28 λ u l h k a ρ c a h t this is a particularly nice approximation because it means that the overburden and underburden don t need to be considered any further in the analysis it does mean however that the mechanical effects of these surrounding rocks on the aquifer are not modelled by laforce et al 2014a b b3 solid mechanics laforce et al 2014a b simplify the solid mechanics by assuming 23 the biot coefficient α b is constant and independent of all other parameters in the theory 24 the effective fluid pressure is p f p the constitutive law is 29 σ i j eff e i j k l ϵ k l elastic δ k l α t t t ref furthermore it is assumed 25 there is no plasticity 26 the drained elasticity tensor e i j k l is isotropic constant and independent of all other parameters in the theory 27 the drained thermal expansion coefficient α t is constant and independent of all other parameters in the theory to simplify eq 11 laforce et al 2014a b assume 28 the acceleration of the solid skeleton v s is zero 29 there are no body forces b 0 except on the boundary the effective stress not the total stress enters into the constitutive law and the the in situ stresses moose also outputs effective stresses by default however when specifying neumann boundary conditions in moose total stresses are used b4 final assumptions initial and boundary conditions finally it is assumed that 30 the reservoir is initially fully water saturated 31 there is no displacement in the z direction u z 0 32 the reservoir is free to contract and expand radially without being hindered by the impermeable seals there is no dependence on the axial coordinates z because of the use of the lauwerier heat loss model eqs 27 and 28 that approximates axial heat conduction therefore all independent variables the water saturation s water fluid porepressure p temperature t and radial displacement u r are dependent on radius r only the problem is completed by employing the following boundary conditions the total radial compressive stress at the well is equal to the porepressure in the well the value of wellbore pressure is dictated by the dynamics of the problem since the injection rate is constant the porepressure will increase with time 30 σ r r tot r bh p the porepressure at the outer boundary is 31 p r max p 0 the temperature at the outer boundary is 32 t r max t 0 all displacements at the outer boundary are zero 33 u r max 0 appendix c parameter values the numerical values of the parameters used in this study are presented in tables 1 and 2 for the full physics models and benchmark verification model respectively appendix d laforce et al 2014b erratum there are some errors in laforce et al 2014b that we correct below equation a 2 of that paper should read 34 a b ξ 1 2 u p r ξ 1 ξ 1 b 1 2 ν σ d ξ 1 t d u p r ξ 1 ξ 1 1 2 ν 1 ξ 1 2 the value of the non dimensionalised stress in the expression for b is 35 σ d ξ 1 t d p d w t d p 0 d σ h d e 1 ν α t r e where p d w t d p 0 d is the porepressure increase at the well the graphs of displacements shown in laforce et al 2014b are largely unchanged with these corrections however the stresses close to the well are impacted compare fig 5 of laforce et al 2014b with fig 2 of this study 
293,water management by the impoundment of reservoirs has been found to influence evapotranspiration not only locally but also at the basin scale highly regulated hydrological basins generally show the effect of a net increase in evapotranspiration accompanying the successive impoundment of reservoirs however understanding and isolating the effect from a particular single impounded reservoir remains a challenge due to the lack of long term observation data required and the existence of many other drivers present at the basin scale focusing on the hydrological basin having the largest hydropower potential in china we isolated in time and space and quantified the effects of a single impounded reservoir on evapotranspiration and the evaporative ratio i e the ratio of actual evapotranspiration to precipitation before and after the construction of the ertan dam in 1998 we find that the dam has increased evapotranspiration in the smallest subbasin by 46 15 mm yr and the evaporative ratio by 0 05 0 015 from the period before impoundment 1983 1997 to that after impoundment 2000 2012 this increase is found only within the smallest differential subbasin holding the impounded reservoir and cannot be explained by other changes in land use or vegetation we use this result from our hydrological basin constrained approach to calculate the water footprint of the hydroelectric project as 16 5 m3 gj which accounts for additional hydroclimatic effects of the impoundment of the reservoir beyond the water surface hence this study finds that when runoff data is available the water consumption and the water footprint of hydropower projects can be calculated by water mass balance at the scale of their hydrological basins keywords hydropower reservoir evapotranspiration water footprint climate change hydrological basin 1 introduction in recent decades many hydropower stations and reservoirs have been constructed worldwide to manage and store water for agriculture and hydropower reducing energy production from fossil fuel lehner et al 2011 yao et al 2019 zarfl et al 2015 due to technical economic and environmental advantages chu et al 2019 yüksel 2010 water reservoirs will continue to be constructed in asia africa and latin american ellabban et al 2014 zhang et al 2018 although highly beneficial in this sense the impoundment of reservoirs alters the physical and socioecological systems around them by limiting the connectivity of the fluvial system suppressing downstream hydrological peaks and altering considerably the in stream sediment budgets aquatic ecosystems and water quality cooper et al 2017 grill et al 2019 li et al 2021 jager smith 2008 olivares et al 2015 shi et al 2017c yang et al 2007 furthermore impounded reservoirs have been found to affect the local climate the impoundment has been related to an increase in atmospheric moisture and wind velocity and increase or decrease in temperature depending on the type of simulations or assumptions degu hossain 2012 iakunin et al 2018 vendrov malik 1965 wang et al 2018 spatial gradients of convective available potential energy air temperature specific humidity and surface evaporation have been found to extend beyond the shore of the reservoirs up to 100 kilometers in plain surfaces degu et al 2011 friedrich et al 2018 jaramillo destouni 2015b for the particular case of evapotranspiration hydrological analyses at the hydrological basin scale have found a long term increase in the ratio of actual evapotranspiration to precipitation known as the evaporative ratio as the hydrological basins become regulated by successive impounded reservoirs and dams jaramillo destouni 2015b wang hejazi 2011 this is probably due to the increase of open water surfaces in the basin associated water uses such as irrigation that come along with flow regulation and related effects on other climatic variables from regulation that may enhance evapotranspiration degu et al 2011 jaramillo destouni 2015b nevertheless in humid hydrological basins this effect is more difficult to detect zamora et al 2020 furthermore mao et al 2016 argue that in the case of china this increase might be related to an unaccounted change in water storage at the basin scale due to the impounded water in the reservoirs when estimating the evaporative ratio by water mass balance although these studies find an increase in the evaporative ratio after the construction of successive reservoirs in the hydrological basin no basin constrained hydrological study to date has been able to isolate this effect from one single reservoir this is mainly due to 1 the lack of availability of long term and continuous runoff data before and after impoundment used for the hydrological analysis 2 a negligible effect on evapotranspiration from impoundment in humid climates degu hossain 2012 zamora et al 2020 and 3 the existence of other natural processes and human activities within the basin that may also increase the evaporative ratio such as reforestation agriculture development donohue et al 2007 hasper et al 2016 jaramillo et al 2018 jaramillo et al 2013 mcvicar et al 2012 zhang et al 2019 the increase in evapotranspiration between to time periods and due to human activities is also referred to as the water footprint or water consumption as water is sent back to the atmosphere due to human activities bakken et al 2017 bakken et al 2013 destouni et al 2013 the water consumption of hydropower i e water impoundment also known as the water footprint of hydropower has been calculated in three different ways in the literature 1 as gross evaporation from the reservoir 2 the difference in evaporation from the reservoir in relation to that of the original state before the reservoir and 3 the quotient between the evaporation and precipitation over the reservoir bakken et al 2013 the three estimates of evaporation or its change can be then expressed per unit of hydropower energy production in this paper we investigate the possible change in evapotranspiration and the evaporative ratio i e the ratio of actual evapotranspiration to precipitation of the regulated jinsha river basin china associated to the impounded of a reservoir in 1998 the jinsha river basin holds the ertan reservoir and dam and also twelve other reservoirs and dams constructed after 2011 we here aim to determine any possible influence of the impoundment of the ertan dam on the evaporative ratio in the region after isolating this potential effect from climatic and human drivers and calculate the corresponding water consumption and water footprint of the reservoir we use discharge stations and their corresponding upstream nested basins to obtain four differential subbasins i e not overlapping to spatially isolate the effect of the impounded reservoir on evapotranspiration and evaporative ratio we first estimate for all differential subbasins the temporal change in the evaporative ratio during the period 1998 2012 by catchment scale water mass balance and based on observed precipitation and runoff data step 1 we then estimate a theoretical purely climatological estimate based on available precipitation data and estimates of potential evapotranspiration step 2 and then calculate a residual by subtracting the estimate in step 2 from that in step 1 step 3 we finally isolate any potential effect on the residual from the impoundment of the ertan reservoir from other potential vegetation and land cover changes that could be driving the change in this residual and calculate water consumption and water footprint from hydropower step 4 we calculate the water footprint in a similar way as the second option mentioned by bakken et al 2013 however our method still differs as we here account for changes in net evapotranspiration from the smallest subbasin rather than from the surface water body as done in the previous references assuming that effects of evapotranspiration from the reservoir go beyond the water surface and 2 remove the contribution of changes in potential evapotranspiration and precipitation on evapotranspiration change furthermore we show how this can be achieved from water mass balance at the scale of the hydrological basin it is worth clarifying that in this study we use the term evapotranspiration rather than evaporation since we assume possible increases in the vicinity of the reservoir thorough transpiration and other regional effects jaramillo destouni 2015b we finally discuss if the water consumption here obtained from impoundment agrees with those of other regulated hydrological basins around the world 2 materials and methods 2 1 study area the jinsha river basin located in southwestern china comprises two main river tributaries the jinsha and yalong rivers both of the tributaries have already been regulated by several large dams constructed recently since 2011 zhang et al 2020 except for the older ertan dam and reservoir 1998 on the yalong river fig 1 and table a 5 the upper regions of the drainage basin are located in the qinghai tibet plateau and the middle and lower regions are located in the hengduan mountains with high mountains and deep river valleys sun et al 2019 fig a 13 except for the river sources upstream the jinsha river basin is in a monsoon climatological zone with distinct dry and wet seasons sun wang 2005 sun et al 2020 the amount of precipitation during the wet season june to october contributes to more than 80 of total annual precipitation the mean air temperature in january and july are the lowest and highest respectively the mean monthly air temperature in the river headwaters varies from 16 4 c to 5 8 c and that downstream in the lower drainage basin between 11 8 c to 24 4 c the four available discharge stations yajiang wali deshi on the mainstream of the yalong river and pingshan on the mainstream of the jinsha river correspond to four nested hydrological subbasins the term nested as each subbasin is included within the boundaries of the next largest subbasin the original subbasins are found in fig a 11 of the supplementary materials names s1 s2 s3 and s4 by subtracting the runoff between consecutive nested basins we calculate runoff in the resulting four differential subbasins without overlapping spatial extent i e r1 n1 n2 n3 fig 1 and table 1 the differential subbasin r1 has the ertan reservoir within their boundaries while n1 n2 and n3 do not hold the reservoir the annual discharge of each differential subbasin is obtained by subtracting the annual discharge data of the station upstream from the one downstream the differential subbasins r1 n1 and the lower reaches of n3 are in the mountainous hengduan mountains region and n2 and the upper reaches of n3 are part of the qinghai tibet plateau n2 has lower air temperature and less precipitation than n1 fig 1 the regulated r1 has the largest mean annual runoff and precipitation followed by n1 forests and grasslands are dominant in r1 and n3 respectively table 3 2 2 data collection and datasets 2 2 1 runoff we used both station and gridded data series of runoff evapotranspiration temperature potential evapotranspiration and other climatic factors in the region during the period 1983 2012 annual runoff r data were collected from the annual hydrological report bureau of hydrology 1983 1986 2006 2012 and cheng and lu 2011 li et al 2017 and wang 2014 the details of runoff data comparison between sources and analysis are in supplementary text a1 2 2 2 precipitation due to the complex topography spanning across a large elevational range yu yang 2018 we used three precipitation p gridded datasets to obtain an uncertainty range for our p calculations the satellite based dataset precipitation estimation from remotely sensed information using an artificial neural networks climate data record cdr ashouri et al 2015 and two observation based datasets the climatic research unit ts v 4 02 cru harris et al 2014 and the china monthly precipitation gridded dataset v2 0 from the national meteorological information center nmic zhao et al 2014 of the china meteorological administration table 2 the cdr is based on remote sensing data of high resolution performing better than reanalysis data specifically in the monsoon china in terms of spatial and temporal patterns of precipitation miao et al 2015 zhu et al 2016 however its annual precipitation estimates have been reported to be higher than other fine satellite based and ground based datasets chen et al 2018 the cru is a monthly observational dataset based on meteorological stations and spatially interpolated using a thin spline interpolation algorithm mitchell jones 2005 although the dataset has a large temporal availability going back to 1901 for the case of the jinsha river basin the stations used for interpolation contributing to each grid value are not consistent in time comparatively the nmic considers all the observational meteorological stations fig a 2 since the 1950s and the data are spatially interpolated with the thin plate spline interpolation algorithm shen et al 2010 it is worth noting that the stations used in cru and nmic are located at the bottom of the valleys at lower elevations of the jinsha river basin and as such the current interpolation algorithms cannot capture the largely vertical profiles of precipitation in the hengduan mountains region possible underestimating precipitation shi et al 2017b for a more detailed analysis of the variability of the three datasets please refer to section a3 2 in the supplementary materials 2 2 3 other climatic parameters monthly data of wind velocity surface temperature air temperature air vapor pressure during 1983 2012 were taken from 53 national meteorological observatory stations yang et al 2018 within or near the jinsha river basin it is worth noting that only one station falls within the boundaries of basin r1 the locations and codes of these stations can be seen in fig a 2 see further section 2 4 for the use of these parameters in the calculations of potential evapotranspiration 2 3 step 1 observed evaporative ratio e p we used the basic water mass balance equation to calculate total annual actual evapotranspiration e mm yr for each subbasin according to runoff r mm yr and precipitation p mm yr observations 1 e p r d s d t where ds dt mm yr is the change in annual water storage within the hydrologic basin we assumed ds dt 0 due to the large area of the drainage basins and after confirming that the contribution of the additional impounded water volume is negligible when compared to r see fig a 14 for the differential subbasins r1 n1 and n2 r was calculated as the difference between the discharge at the downstream station and that at the upstream station and then divided by the area of the subbasins of r1 n1 and n2 respectively we finally calculated the evaporative ratio e p after dividing the total annual values of e obtained from eq 1 by total annual p 2 4 step 2 calculations of evaporative ratio based on p and pet data ec p we calculated a purely climatological driven actual evapotranspiration ec and corresponding evaporative ratio ec p by the fu equation fu 1981 commonly used to calculate actual evapotranspiration when data on precipitation p and climatic parameters to calculate potential evapotranspiration e0 are available eq 2 2 e c p 1 e 0 p 1 e 0 p ω 1 ω the fu equation integrates the properties of climatological seasonality and land surface characteristics including vegetation geographical topographical and soil properties by an additional parameter ω and has been used to calculate actual evapotranspiration when p and e0 data are available greve et al 2015 the equation is a typical budyko type curve where e p is expected to increase linearly with e0 p at low values of e0 p while gradually reducing its increasing rate at higher e0 p values following wang and hejazi 2011 and jaramillo et al 2018 we calibrated the general parameter ω for the period before the construction of the dam by replacing mean e from eq 1 into eq 2 along with mean data of p and e0 for the first period and assuming the same ω value before and after impoundment since e0 is a conceptual parameter that is difficult to measure and the values obtained can differ among datasets guo et al 2016 jaramillo destouni 2014 we used two methods to obtain a range of uncertainty the penman monteith equation monteith 1981 and the method proposed by shi et al 2014 for the region of the eastern qinghai tibet plateau and the hengduan mountains area see supplementary materials a2 for their formulae parameters and assumptions the penman monteith equation is considered one of the most reliable equations used to calculate e0 kingston et al 2009 and we used the penman function in spei package in r programming to calculate monthly penman monteith e0 for each meteorological station and aggregated them to obtain annual e0 values the penman function requires the following monthly data minimum and maximum air temperature bright sunshine duration wind speed and relative humidity also the latitude and elevation of each station are required the shi model for monthly e0 is a modification of dalton s model singh 1988 that includes the influence of vapor pressure and the temperature differences between the land surface and the atmosphere suitable for mountainous area and verified in the eastern qinghai tibet plateau and the hengduan mountains area shi et al 2014 shi et al 2017a the calculation of shi e0 requires historical monthly data of wind velocity surface and air temperature and air vapor pressure during 1983 2012 we interpolated spatially e0 between stations by using the inverse distance weighting interpolation method in programming arcgis the two e0 datasets correlated well with each other r 0 90 p 10 8 table a 3 but the trends of shi e0 before and after 1998 were different from those obtained by the penman monteith for a more detailed analysis on the variability of the two datasets please refer to section a3 3 in the supplementary materials finally to relate the temporal changes in all evaporative ratios to the impoundment of the ertan reservoir we calculated their changes δ e0 p and δ e p as the difference between the mean of the annual values after impoundment 2000 2012 and before impoundment 1983 1997 ignoring the two years of reservoir filling 1998 and 1999 following a previous visualization of hydroclimatic change between these two periods destouni et al 2013 we analyzed changes in e0 p e p and ec p in budyko space budyko et al 1974 to distinguish the hydroclimate change from climatological and non climatological changes the budyko framework establishes the long term relationship between water and energy availability and the partitioning of water on land budyko et al 1974 li et al 2013 explanation of hydroclimatic change as observed in budyko space has been used in several studies to visualize the characteristics of the change and potentially identify the climatological or non climatological nature of these changes jaramillo et al 2018 jaramillo destouni 2014 piemontese et al 2019 van der velde et al 2014 2 5 step 3 residual evaporative ratio er p we obtained residual actual evapotranspiration for each year er corresponding evaporative ratio er p and changes from before to after the construction of the dam δer and δ er p by subtracting the purely climatological estimate ec step 2 from the basin constrained estimate e obtained from the water mass balance 3 e r e e c the idea behind the calculation of this residual is to isolate the changes in actual evapotranspiration that do not correspond to purely climatic changes i e in e0 and p this similar approach has been used in several regions worldwide to distinguish the effect on evapotranspiration from other drivers such as irrigation rained agriculture forestry changes e g destouni et al 2013 jaramillo et al 2013 and jaramillo et al 2018 2 6 step 4 distinguishing influences from other vegetation changes on er p in order to verify that general vegetation changes are not the reason for the observed differences in δ er p among subbasins we calculated land cover changes within the basins we first used a 1 km landsat satellite product in 1990 and 2010 to identify and quantify the coverage of the main land use and land cover in each subbasin table 3 we selected the years of 1990 and 2010 because the source products from the resource and environment data cloud platform see the section of acknowledgements are provided for every five year period and these two years are before and after the impoundment of the ertan reservoir as several studies have shown that the normalized difference vegetation index ndvi especially in the growing season is positively and linearly correlated with vegetation transpiration rossato et al 2005 running nemani 1988 srivastava et al 1997 sun et al 2004 szilagyi 2000 we used ndvi as a proxy of vegetation change in these subbasins donohue et al 2007 thereby we calculated mean ndvi during the growing season june to november between 1983 and 2012 from the 1 km resolution grid of the us national oceanic and atmospheric administration noaa advanced very high resolution radiometer avhrr for specific days vegetation may be shielded by clouds when detected by satellite to remove the disturbance from clouds and since the greatest ndvi value will come from almost clear sky imaging of vegetation we used the maximum value compositing mvc method to compose 15 day ndvi image data for the region containing the largest ndvi value of each 15 day pixel rundquist et al 2000 we assume that the resulting mean value of ndvi by mvc of each basin is representative of the vegetation in each subbasin and can be compared with the trends in er p observed in each differential subbasin 3 results 3 1 steps 1 and 2 total changes and those due to climatic drivers the location in budyko space shows that all differential subbasins are water limited as their e p values are larger than one fig 2 a furthermore in the subbasin r1 which holds the ertan reservoir and n3 precipitation is partitioned more or less equally into runoff than evapotranspiration in contrast to the other subbasins the largest increase in the observation based evaporative ratio δ e p step 1 from before impoundment to after impoundment occurs in r1 regardless of the selection of e0 and p data fig 2b on the contrary observation based e p in subbasin n2 and n3 decrease from the first to the second period from a more thermodynamic perspective only considering the changes in e0 and p would have increased the evaporative ratio in r1 but in a much smaller magnitude in accordance to the vertical component of the movement over the curve representing the fu equation from the period before impoundment to the period after step 2 as such for the particular case of r1 the actual movement based on observations step 1 implies an increase in the evaporative ratio that is much larger than this thermodynamic increase hence other drivers besides changes in p and e0 are changing the evaporative ratio in r1 on the contrary we can see that subbasin n1 is moving in a direction similar to the curve that visualizes the fu equation i e increase in e0 p and a small increase in e p in this sense its movement is as expected from the occurring climatological changes in e0 and p 3 2 step 3 evaporative ratio changes not explained by climate the temporal developments of the residual of the evaporative ratio er p for subbasin r1 holding the ertan reservoir evidence an increase that occurs around the end of the twentieth century the time when the ertan reservoir was constructed and that take er p to a higher level fig 3 a and fig a 15 of supplementary materials comparatively the subbasins n1 n2 and n3 which exclude the ertan reservoir show a decreasing or stable er p notice that the effect of increasing er by changes in p and e o after the impoundment of the dam has already been removed and is not included in this residual the annual time series of er p has no significant linear correlation with p or e0 r 0 34 p 0 05 df 28 by pearson correlation analysis the magnitudes of the increase in er p are generally higher for all subbasins when using the cdr p dataset and lower when using that of nmic table a 6 to investigate the statistical significance of the changes in er p before and after the impoundment of the ertan reservoir we performed a two sample t test the increase in er p is significant in r1 p 0 05 t test in four of the six combinations of e0 and p data and the decrease in n1 and n2 is significant only in the e0 p combination of nmic shi model p 0 05 t test table a 6 it is worth noting that although significant the change in er p in n2 is not characteristic of flow regulation as found in other studies as it decreases rather than increases in time accounting for the range of all e0 and p combinations the range of increase in er p from the period 1983 1997 to the period 2000 2012 as shown by the standard error is always larger in r1 0 05 0 015 than that of its neighboring small differential basin n1 or the others n2 and n3 fig 3b 3 2 step 4 influences of changes from other factors human activities such as irrigation and hydropower development can induce changes in e p by modifying evapotranspiration by changing the spatial extent and density of vegetation from the year 1990 to the year 2010 the vegetation and land cover have changed little in all subbasins table 3 grass and forest lands accounted for between 75 and 89 of the area in all subbasins whereas croplands occupied only between 0 8 and 12 table 3 in total the three vegetation types of land use i e forestland grassland and cropland contributed to 81 97 of the total area with negligible changes during the 20 years the jinsha river basin is dominated by extensive mountains with a limited extent of irrigated croplands the major agricultural irrigation areas located in the narrow riverine valleys of anning longchuan and binchuan are located within subbasin n3 even in the most densely populated areas of n3 irrigated croplands contribute to less than 1 to the total land use according to yin and xiang 2010 as such it is highly unlikely that the observed increase in e r p in r1 is due to the development or expansion of irrigated agriculture fig 4 shows the variation of ndvi by mvc during the growing season in the period 1983 2012 the ndvi has increased consistently across all differential subbasins r1 n1 n2 and n3 however the absolute increase in r1 is smaller than in the other subbasins probably since 0 3 of croplands and 0 1 of forestlands were submerged by reservoir impoundment table 3 assuming a close correlation between ndvi and transpiration we can infer that the change of evapotranspiration due to change in land cover and vegetation density should be similar in all subbasins and at least smaller in r1 than in the other subbasins hence ndvi development as a proxy of vegetation growth cannot fully explain the differences between the change in evaporative ratio in the four differential subbasins fig 3a b for instance by comparing er p in subbasins r1 and n1 that are spatially adjacent and have similarly climatological characteristics we find that ndvi has increased more in n1 than in r1 going against the finding of a higher increase in er p in r1 than in n1 the large increase in er p found in r1 is then the effct of drivers different from climate variability steps 1 and 2 or changes in vegetation occurring within this basin and most likely from the impoundment of the ertan reservoir 4 discussion and conclusion in our calculations of er p we have accounted for various datasets of p and different methods for calculating e0 regarding the influence of these datasets on the values of er p the time series of er p were derived for each combination of e0 and p we found that er p is more sensitive to the dataset selection of p than to the method of calculation of e0 fig a 16 and a 17 supplementary materials for example among the three precipitation datasets p from cdr has the largest magnitude and also the largest increasing trend in p in the four differential subbasins fig a 4 and the largest resulting trends of er p fig a 16 regarding the difference of e0 among datasets the corresponding differences in er p are small fig a 17 we find that the estimates of e0 by the shi method show a more pronounced increase in e0 during the second period than the penman monteith furthermore we find that the shi estimate is higher at lower r1 and n1 than higher elevations n2 and n3 when compared to penman monteith the observed increase in er p in the smallest regulated subbasin r1 0 054 0 015 corresponds to an increase in er of 46 15 mm yr from pre damming to post damming period this change is beyond the one expected from the change in p and e0 as we have already removed this contribution in step 2 we attribute these changes to the impoundment of the reservoir due to i the absence of other known drivers of this change that could explain such increase ii the occurrence of this increase around the time of the construction of the reservoir iii and the comparison of this increase with the milder increases or even decrease in er p for the other differential subbasins not holding the ertan reservoir our results fall in line with other studies identifying basin scale increases in evapotranspiration in regulated basins in sweden destouni et al 2013 and eastern europe levi et al 2015 as a marked difference from these other studies we here can attribute most of the increase in er p to the impoundment of one single reservoir performing the same analysis on the nested catchments as for the differential subbasins also shows that the increase in er p is more evident as the area of the hydrological basin holding the reservoir decreases fig a 12 we can further calculate the water footprint of the ertan hydroelectric project by converting the residual increase in evapotranspiration er in r1 to volume based on the area of subbasin r1 i e 1 001 km3 yr and dividing by the annual hydroelectric production of the hydroelectric project 17 tw h yr we obtain a water footprint of 16 54 m3 gj this value falls within the range of water footprints of hydropower found by herath et al 2011 in new zealand actually the result of ertan reservoir is very close to that of the tekapo reservoir in new zealand the water area of ertan is 10 100 ha and the water evaporation is between 1200 and 1300 mm yr liu et al 2015 which is very close to the area of 9733 ha and the water evaporation 1153 mm yr of the tekapo reservoir herath et al 2011 for comparison purposes we now assess the wf of hydroelectricity by three different methods using new zealand as a case study the first wf 1 and second wf 2 methods only consider the consumptive water use of the hydroelectricity generation system while our third method wf 3 accounts for the net water balance irrespective of the method the wf of new zealand s hydroelectricity was found much smaller than the commonly cited international value of 22 m3 gj gerbens leenes et al 2009 depending on the method the national wf ranged from 1 55 m3 gj wf 3 to 6 05 m3 gj wf 1 the wf 3 considers the net water balance including rainfall which is the key driver for replenishing water resources it provides meaningful information that helps our understanding of the differences of the wf in locations which are diverse in terms of water resource availability we highlight the effects of local climatic differences and the structural specifics of a hydroelectricity scheme on the wf the large variation in the wf of hydropower across new zealand illustrates the inappropriateness of using global average values local values calculated using our hydrologically rational method must be used interestingly the water footprint of the ertan reservoir is only half of the average water footprint of the 35 hydroelectric stations calculated by mekonnen and hoekstra 2012 i e 39 m3 gj this is explained by the difference in methodology as we here take into account only the change in residual evapotranspiration rather than in total evapotranspiration bakken et al 2013 however the physical processes underlying these increases in evapotranspiration cannot be identified from our results nor methodology and then can only be assumed we infer that the increase occurs because of 1 higher availability of water by the reservoir s extended water surface increasing evaporation jaramillo destouni 2015a mekonnen hoekstra 2012 shiklomanov 2000 ii higher water tables around the reservoir making water more available to these dry surrounding vegetation and thus enhancing transpiration iii more convective potential energy in the valley which is more evident as the surface area of the subbasin decreases degu et al 2011 or iv reservoir related effects on other climatic parameters that may increase potential evapotranspiration regarding the latter it is worth noting that the calculations of potential evapotranspiration used in this analysis at least for the case of subbasin r1 are based on spatial extrapolations rather than actual measurements for instance only one of the 53 climatic stations used in this study and containing wind velocity surface temperature air temperature and air vapor used for the calculations of potential evapotranspiration is located within this differential subbasin fig a 2 as such the possible local effects from the impounded reservoir on potential and actual evapotranspiration may be missed in our calculations of e0 and ec and rather be included in the residual er another possibility of uncertainty may be related to the assumption of negligible storage change within the differential subbasins used to calculate e step 1 for instance mao et al 2016 assessed the larger six major river basins in china 27 104 180 104 km2 including the yangtze river basin 180 104 km2 whose source basin is the jinsha river basin they found that accumulated storage of water by the impoundment of consecutive reservoirs could explain part of the increase of e p in china i e eq 1 however their result is based on assumptions of increases in water storage in these basins that are much higher than the actually reported water storages in the impounded reservoirs similarly there may be additional hidden water storage around the reservoirs by seepage as estimated by chao et al 2008 and mentioned by bakken et al 2017 which may increase the water storage within the basin calculated by eq 1 and decrease the estimate of e nonetheless jaramillo and destouni 2015b show that even when considering this additional water storage in the form of seepage is still negligible and does not affect the calculations of evapotranspiration in large basins such as the ones analyzed here we here show how the water footprint of hydropower can be achieved from simple water mass balance at the scale of the hydrological basin of the reservoir this method should be preferable to calculating water consumption from estimates of potential evapotranspiration as the water mass balance constraints the value of evapotranspiration based on actual observations furthermore our methodology includes any unforeseen effects of the construction of the reservoir extending beyond the limits of the water surface such as enhanced evapotranspiration by vegetation around the reservoir and seepage increase in atmospheric moisture and wind velocity or in potential energy by convection our study also shows how the effect of the reservoir on evapotranspiration in the vicinity of the reservoir er p becomes more evident as the area of the hydrological basin holding the reservoir decreases figure a 12 of supplementary materials in our study basin constrained water mall balance could not identify a positive increase of evapotranspiration subbasin beyond the size of subbasin s3 188 4 103 km2 e g the entire jinsha river basin or subbasin s4 figure a 18 this is expected as the area and effect of the reservoir decreases in relation to the effects of other drivers and the area of the hydrological basin therefore our method can be used in any other hydrological basin but the effects from hydropower will be more evident for smaller basins of analysis while the influence of non climatological factors as reforestation and irrigation may play a more important role in larger basins of analysis cao et al 2014 sun et al 2006 credit author statement lian sun conceptualization methodology data curation programming writing original draft yanpeng cai conceptualization writing review editing supervision funding acquisition aifang chen validation david zamora programming fernando jaramillo conceptualization methodology writing original draft writing review editing supervision funding acquisition declaration of competing interest the authors declare no competing interests acknowledgments and data this work was supported by the national key research program of china 2016yfc0502209 the national natural science foundation of china no 51879007 the guangdong provincial science and technology project 2020b1111380003 and the china scholarship council no 201806040090 contribution of f j was funded by the swedish research council vr project 2015 06503 the swedish research council for environment agricultural sciences and spatial planning formas 942 2015 740 the cdr precipitation data are available from persiann cdr website http chrsdata eng uci edu the cru precipitation and potential evapotranspiration data are obtained in climatic research unit https crudata uea ac uk cru data hrg the nmic precipitation data are available in national meteorological information center of the chinese meteorological administration including china monthly precipitation gridded dataset v2 0 http data cma cn data detail datacode surf cli chn pre mon grid 0 5 keywords 2472 html the monthly observational meteorological data including mean minimum maximum air temperature soil temperature in the depth of 0 cm vapor pressure sunshine duration wind speed and relative humidity can be accessed in the nmic monthly dataset http data cma cn data cdcdetail datacode surf cli chn mul mon html the ndvi data can be downloaded in us national oceanic and atmospheric administration noaa advanced very high resolution radiometer avhrr https www ncei noaa gov data avhrr land normalized difference vegetation index access the lulc data are derived from resource and environment data cloud platform http www resdc cn default aspx supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2021 103947 appendix supplementary materials image application 1 
293,water management by the impoundment of reservoirs has been found to influence evapotranspiration not only locally but also at the basin scale highly regulated hydrological basins generally show the effect of a net increase in evapotranspiration accompanying the successive impoundment of reservoirs however understanding and isolating the effect from a particular single impounded reservoir remains a challenge due to the lack of long term observation data required and the existence of many other drivers present at the basin scale focusing on the hydrological basin having the largest hydropower potential in china we isolated in time and space and quantified the effects of a single impounded reservoir on evapotranspiration and the evaporative ratio i e the ratio of actual evapotranspiration to precipitation before and after the construction of the ertan dam in 1998 we find that the dam has increased evapotranspiration in the smallest subbasin by 46 15 mm yr and the evaporative ratio by 0 05 0 015 from the period before impoundment 1983 1997 to that after impoundment 2000 2012 this increase is found only within the smallest differential subbasin holding the impounded reservoir and cannot be explained by other changes in land use or vegetation we use this result from our hydrological basin constrained approach to calculate the water footprint of the hydroelectric project as 16 5 m3 gj which accounts for additional hydroclimatic effects of the impoundment of the reservoir beyond the water surface hence this study finds that when runoff data is available the water consumption and the water footprint of hydropower projects can be calculated by water mass balance at the scale of their hydrological basins keywords hydropower reservoir evapotranspiration water footprint climate change hydrological basin 1 introduction in recent decades many hydropower stations and reservoirs have been constructed worldwide to manage and store water for agriculture and hydropower reducing energy production from fossil fuel lehner et al 2011 yao et al 2019 zarfl et al 2015 due to technical economic and environmental advantages chu et al 2019 yüksel 2010 water reservoirs will continue to be constructed in asia africa and latin american ellabban et al 2014 zhang et al 2018 although highly beneficial in this sense the impoundment of reservoirs alters the physical and socioecological systems around them by limiting the connectivity of the fluvial system suppressing downstream hydrological peaks and altering considerably the in stream sediment budgets aquatic ecosystems and water quality cooper et al 2017 grill et al 2019 li et al 2021 jager smith 2008 olivares et al 2015 shi et al 2017c yang et al 2007 furthermore impounded reservoirs have been found to affect the local climate the impoundment has been related to an increase in atmospheric moisture and wind velocity and increase or decrease in temperature depending on the type of simulations or assumptions degu hossain 2012 iakunin et al 2018 vendrov malik 1965 wang et al 2018 spatial gradients of convective available potential energy air temperature specific humidity and surface evaporation have been found to extend beyond the shore of the reservoirs up to 100 kilometers in plain surfaces degu et al 2011 friedrich et al 2018 jaramillo destouni 2015b for the particular case of evapotranspiration hydrological analyses at the hydrological basin scale have found a long term increase in the ratio of actual evapotranspiration to precipitation known as the evaporative ratio as the hydrological basins become regulated by successive impounded reservoirs and dams jaramillo destouni 2015b wang hejazi 2011 this is probably due to the increase of open water surfaces in the basin associated water uses such as irrigation that come along with flow regulation and related effects on other climatic variables from regulation that may enhance evapotranspiration degu et al 2011 jaramillo destouni 2015b nevertheless in humid hydrological basins this effect is more difficult to detect zamora et al 2020 furthermore mao et al 2016 argue that in the case of china this increase might be related to an unaccounted change in water storage at the basin scale due to the impounded water in the reservoirs when estimating the evaporative ratio by water mass balance although these studies find an increase in the evaporative ratio after the construction of successive reservoirs in the hydrological basin no basin constrained hydrological study to date has been able to isolate this effect from one single reservoir this is mainly due to 1 the lack of availability of long term and continuous runoff data before and after impoundment used for the hydrological analysis 2 a negligible effect on evapotranspiration from impoundment in humid climates degu hossain 2012 zamora et al 2020 and 3 the existence of other natural processes and human activities within the basin that may also increase the evaporative ratio such as reforestation agriculture development donohue et al 2007 hasper et al 2016 jaramillo et al 2018 jaramillo et al 2013 mcvicar et al 2012 zhang et al 2019 the increase in evapotranspiration between to time periods and due to human activities is also referred to as the water footprint or water consumption as water is sent back to the atmosphere due to human activities bakken et al 2017 bakken et al 2013 destouni et al 2013 the water consumption of hydropower i e water impoundment also known as the water footprint of hydropower has been calculated in three different ways in the literature 1 as gross evaporation from the reservoir 2 the difference in evaporation from the reservoir in relation to that of the original state before the reservoir and 3 the quotient between the evaporation and precipitation over the reservoir bakken et al 2013 the three estimates of evaporation or its change can be then expressed per unit of hydropower energy production in this paper we investigate the possible change in evapotranspiration and the evaporative ratio i e the ratio of actual evapotranspiration to precipitation of the regulated jinsha river basin china associated to the impounded of a reservoir in 1998 the jinsha river basin holds the ertan reservoir and dam and also twelve other reservoirs and dams constructed after 2011 we here aim to determine any possible influence of the impoundment of the ertan dam on the evaporative ratio in the region after isolating this potential effect from climatic and human drivers and calculate the corresponding water consumption and water footprint of the reservoir we use discharge stations and their corresponding upstream nested basins to obtain four differential subbasins i e not overlapping to spatially isolate the effect of the impounded reservoir on evapotranspiration and evaporative ratio we first estimate for all differential subbasins the temporal change in the evaporative ratio during the period 1998 2012 by catchment scale water mass balance and based on observed precipitation and runoff data step 1 we then estimate a theoretical purely climatological estimate based on available precipitation data and estimates of potential evapotranspiration step 2 and then calculate a residual by subtracting the estimate in step 2 from that in step 1 step 3 we finally isolate any potential effect on the residual from the impoundment of the ertan reservoir from other potential vegetation and land cover changes that could be driving the change in this residual and calculate water consumption and water footprint from hydropower step 4 we calculate the water footprint in a similar way as the second option mentioned by bakken et al 2013 however our method still differs as we here account for changes in net evapotranspiration from the smallest subbasin rather than from the surface water body as done in the previous references assuming that effects of evapotranspiration from the reservoir go beyond the water surface and 2 remove the contribution of changes in potential evapotranspiration and precipitation on evapotranspiration change furthermore we show how this can be achieved from water mass balance at the scale of the hydrological basin it is worth clarifying that in this study we use the term evapotranspiration rather than evaporation since we assume possible increases in the vicinity of the reservoir thorough transpiration and other regional effects jaramillo destouni 2015b we finally discuss if the water consumption here obtained from impoundment agrees with those of other regulated hydrological basins around the world 2 materials and methods 2 1 study area the jinsha river basin located in southwestern china comprises two main river tributaries the jinsha and yalong rivers both of the tributaries have already been regulated by several large dams constructed recently since 2011 zhang et al 2020 except for the older ertan dam and reservoir 1998 on the yalong river fig 1 and table a 5 the upper regions of the drainage basin are located in the qinghai tibet plateau and the middle and lower regions are located in the hengduan mountains with high mountains and deep river valleys sun et al 2019 fig a 13 except for the river sources upstream the jinsha river basin is in a monsoon climatological zone with distinct dry and wet seasons sun wang 2005 sun et al 2020 the amount of precipitation during the wet season june to october contributes to more than 80 of total annual precipitation the mean air temperature in january and july are the lowest and highest respectively the mean monthly air temperature in the river headwaters varies from 16 4 c to 5 8 c and that downstream in the lower drainage basin between 11 8 c to 24 4 c the four available discharge stations yajiang wali deshi on the mainstream of the yalong river and pingshan on the mainstream of the jinsha river correspond to four nested hydrological subbasins the term nested as each subbasin is included within the boundaries of the next largest subbasin the original subbasins are found in fig a 11 of the supplementary materials names s1 s2 s3 and s4 by subtracting the runoff between consecutive nested basins we calculate runoff in the resulting four differential subbasins without overlapping spatial extent i e r1 n1 n2 n3 fig 1 and table 1 the differential subbasin r1 has the ertan reservoir within their boundaries while n1 n2 and n3 do not hold the reservoir the annual discharge of each differential subbasin is obtained by subtracting the annual discharge data of the station upstream from the one downstream the differential subbasins r1 n1 and the lower reaches of n3 are in the mountainous hengduan mountains region and n2 and the upper reaches of n3 are part of the qinghai tibet plateau n2 has lower air temperature and less precipitation than n1 fig 1 the regulated r1 has the largest mean annual runoff and precipitation followed by n1 forests and grasslands are dominant in r1 and n3 respectively table 3 2 2 data collection and datasets 2 2 1 runoff we used both station and gridded data series of runoff evapotranspiration temperature potential evapotranspiration and other climatic factors in the region during the period 1983 2012 annual runoff r data were collected from the annual hydrological report bureau of hydrology 1983 1986 2006 2012 and cheng and lu 2011 li et al 2017 and wang 2014 the details of runoff data comparison between sources and analysis are in supplementary text a1 2 2 2 precipitation due to the complex topography spanning across a large elevational range yu yang 2018 we used three precipitation p gridded datasets to obtain an uncertainty range for our p calculations the satellite based dataset precipitation estimation from remotely sensed information using an artificial neural networks climate data record cdr ashouri et al 2015 and two observation based datasets the climatic research unit ts v 4 02 cru harris et al 2014 and the china monthly precipitation gridded dataset v2 0 from the national meteorological information center nmic zhao et al 2014 of the china meteorological administration table 2 the cdr is based on remote sensing data of high resolution performing better than reanalysis data specifically in the monsoon china in terms of spatial and temporal patterns of precipitation miao et al 2015 zhu et al 2016 however its annual precipitation estimates have been reported to be higher than other fine satellite based and ground based datasets chen et al 2018 the cru is a monthly observational dataset based on meteorological stations and spatially interpolated using a thin spline interpolation algorithm mitchell jones 2005 although the dataset has a large temporal availability going back to 1901 for the case of the jinsha river basin the stations used for interpolation contributing to each grid value are not consistent in time comparatively the nmic considers all the observational meteorological stations fig a 2 since the 1950s and the data are spatially interpolated with the thin plate spline interpolation algorithm shen et al 2010 it is worth noting that the stations used in cru and nmic are located at the bottom of the valleys at lower elevations of the jinsha river basin and as such the current interpolation algorithms cannot capture the largely vertical profiles of precipitation in the hengduan mountains region possible underestimating precipitation shi et al 2017b for a more detailed analysis of the variability of the three datasets please refer to section a3 2 in the supplementary materials 2 2 3 other climatic parameters monthly data of wind velocity surface temperature air temperature air vapor pressure during 1983 2012 were taken from 53 national meteorological observatory stations yang et al 2018 within or near the jinsha river basin it is worth noting that only one station falls within the boundaries of basin r1 the locations and codes of these stations can be seen in fig a 2 see further section 2 4 for the use of these parameters in the calculations of potential evapotranspiration 2 3 step 1 observed evaporative ratio e p we used the basic water mass balance equation to calculate total annual actual evapotranspiration e mm yr for each subbasin according to runoff r mm yr and precipitation p mm yr observations 1 e p r d s d t where ds dt mm yr is the change in annual water storage within the hydrologic basin we assumed ds dt 0 due to the large area of the drainage basins and after confirming that the contribution of the additional impounded water volume is negligible when compared to r see fig a 14 for the differential subbasins r1 n1 and n2 r was calculated as the difference between the discharge at the downstream station and that at the upstream station and then divided by the area of the subbasins of r1 n1 and n2 respectively we finally calculated the evaporative ratio e p after dividing the total annual values of e obtained from eq 1 by total annual p 2 4 step 2 calculations of evaporative ratio based on p and pet data ec p we calculated a purely climatological driven actual evapotranspiration ec and corresponding evaporative ratio ec p by the fu equation fu 1981 commonly used to calculate actual evapotranspiration when data on precipitation p and climatic parameters to calculate potential evapotranspiration e0 are available eq 2 2 e c p 1 e 0 p 1 e 0 p ω 1 ω the fu equation integrates the properties of climatological seasonality and land surface characteristics including vegetation geographical topographical and soil properties by an additional parameter ω and has been used to calculate actual evapotranspiration when p and e0 data are available greve et al 2015 the equation is a typical budyko type curve where e p is expected to increase linearly with e0 p at low values of e0 p while gradually reducing its increasing rate at higher e0 p values following wang and hejazi 2011 and jaramillo et al 2018 we calibrated the general parameter ω for the period before the construction of the dam by replacing mean e from eq 1 into eq 2 along with mean data of p and e0 for the first period and assuming the same ω value before and after impoundment since e0 is a conceptual parameter that is difficult to measure and the values obtained can differ among datasets guo et al 2016 jaramillo destouni 2014 we used two methods to obtain a range of uncertainty the penman monteith equation monteith 1981 and the method proposed by shi et al 2014 for the region of the eastern qinghai tibet plateau and the hengduan mountains area see supplementary materials a2 for their formulae parameters and assumptions the penman monteith equation is considered one of the most reliable equations used to calculate e0 kingston et al 2009 and we used the penman function in spei package in r programming to calculate monthly penman monteith e0 for each meteorological station and aggregated them to obtain annual e0 values the penman function requires the following monthly data minimum and maximum air temperature bright sunshine duration wind speed and relative humidity also the latitude and elevation of each station are required the shi model for monthly e0 is a modification of dalton s model singh 1988 that includes the influence of vapor pressure and the temperature differences between the land surface and the atmosphere suitable for mountainous area and verified in the eastern qinghai tibet plateau and the hengduan mountains area shi et al 2014 shi et al 2017a the calculation of shi e0 requires historical monthly data of wind velocity surface and air temperature and air vapor pressure during 1983 2012 we interpolated spatially e0 between stations by using the inverse distance weighting interpolation method in programming arcgis the two e0 datasets correlated well with each other r 0 90 p 10 8 table a 3 but the trends of shi e0 before and after 1998 were different from those obtained by the penman monteith for a more detailed analysis on the variability of the two datasets please refer to section a3 3 in the supplementary materials finally to relate the temporal changes in all evaporative ratios to the impoundment of the ertan reservoir we calculated their changes δ e0 p and δ e p as the difference between the mean of the annual values after impoundment 2000 2012 and before impoundment 1983 1997 ignoring the two years of reservoir filling 1998 and 1999 following a previous visualization of hydroclimatic change between these two periods destouni et al 2013 we analyzed changes in e0 p e p and ec p in budyko space budyko et al 1974 to distinguish the hydroclimate change from climatological and non climatological changes the budyko framework establishes the long term relationship between water and energy availability and the partitioning of water on land budyko et al 1974 li et al 2013 explanation of hydroclimatic change as observed in budyko space has been used in several studies to visualize the characteristics of the change and potentially identify the climatological or non climatological nature of these changes jaramillo et al 2018 jaramillo destouni 2014 piemontese et al 2019 van der velde et al 2014 2 5 step 3 residual evaporative ratio er p we obtained residual actual evapotranspiration for each year er corresponding evaporative ratio er p and changes from before to after the construction of the dam δer and δ er p by subtracting the purely climatological estimate ec step 2 from the basin constrained estimate e obtained from the water mass balance 3 e r e e c the idea behind the calculation of this residual is to isolate the changes in actual evapotranspiration that do not correspond to purely climatic changes i e in e0 and p this similar approach has been used in several regions worldwide to distinguish the effect on evapotranspiration from other drivers such as irrigation rained agriculture forestry changes e g destouni et al 2013 jaramillo et al 2013 and jaramillo et al 2018 2 6 step 4 distinguishing influences from other vegetation changes on er p in order to verify that general vegetation changes are not the reason for the observed differences in δ er p among subbasins we calculated land cover changes within the basins we first used a 1 km landsat satellite product in 1990 and 2010 to identify and quantify the coverage of the main land use and land cover in each subbasin table 3 we selected the years of 1990 and 2010 because the source products from the resource and environment data cloud platform see the section of acknowledgements are provided for every five year period and these two years are before and after the impoundment of the ertan reservoir as several studies have shown that the normalized difference vegetation index ndvi especially in the growing season is positively and linearly correlated with vegetation transpiration rossato et al 2005 running nemani 1988 srivastava et al 1997 sun et al 2004 szilagyi 2000 we used ndvi as a proxy of vegetation change in these subbasins donohue et al 2007 thereby we calculated mean ndvi during the growing season june to november between 1983 and 2012 from the 1 km resolution grid of the us national oceanic and atmospheric administration noaa advanced very high resolution radiometer avhrr for specific days vegetation may be shielded by clouds when detected by satellite to remove the disturbance from clouds and since the greatest ndvi value will come from almost clear sky imaging of vegetation we used the maximum value compositing mvc method to compose 15 day ndvi image data for the region containing the largest ndvi value of each 15 day pixel rundquist et al 2000 we assume that the resulting mean value of ndvi by mvc of each basin is representative of the vegetation in each subbasin and can be compared with the trends in er p observed in each differential subbasin 3 results 3 1 steps 1 and 2 total changes and those due to climatic drivers the location in budyko space shows that all differential subbasins are water limited as their e p values are larger than one fig 2 a furthermore in the subbasin r1 which holds the ertan reservoir and n3 precipitation is partitioned more or less equally into runoff than evapotranspiration in contrast to the other subbasins the largest increase in the observation based evaporative ratio δ e p step 1 from before impoundment to after impoundment occurs in r1 regardless of the selection of e0 and p data fig 2b on the contrary observation based e p in subbasin n2 and n3 decrease from the first to the second period from a more thermodynamic perspective only considering the changes in e0 and p would have increased the evaporative ratio in r1 but in a much smaller magnitude in accordance to the vertical component of the movement over the curve representing the fu equation from the period before impoundment to the period after step 2 as such for the particular case of r1 the actual movement based on observations step 1 implies an increase in the evaporative ratio that is much larger than this thermodynamic increase hence other drivers besides changes in p and e0 are changing the evaporative ratio in r1 on the contrary we can see that subbasin n1 is moving in a direction similar to the curve that visualizes the fu equation i e increase in e0 p and a small increase in e p in this sense its movement is as expected from the occurring climatological changes in e0 and p 3 2 step 3 evaporative ratio changes not explained by climate the temporal developments of the residual of the evaporative ratio er p for subbasin r1 holding the ertan reservoir evidence an increase that occurs around the end of the twentieth century the time when the ertan reservoir was constructed and that take er p to a higher level fig 3 a and fig a 15 of supplementary materials comparatively the subbasins n1 n2 and n3 which exclude the ertan reservoir show a decreasing or stable er p notice that the effect of increasing er by changes in p and e o after the impoundment of the dam has already been removed and is not included in this residual the annual time series of er p has no significant linear correlation with p or e0 r 0 34 p 0 05 df 28 by pearson correlation analysis the magnitudes of the increase in er p are generally higher for all subbasins when using the cdr p dataset and lower when using that of nmic table a 6 to investigate the statistical significance of the changes in er p before and after the impoundment of the ertan reservoir we performed a two sample t test the increase in er p is significant in r1 p 0 05 t test in four of the six combinations of e0 and p data and the decrease in n1 and n2 is significant only in the e0 p combination of nmic shi model p 0 05 t test table a 6 it is worth noting that although significant the change in er p in n2 is not characteristic of flow regulation as found in other studies as it decreases rather than increases in time accounting for the range of all e0 and p combinations the range of increase in er p from the period 1983 1997 to the period 2000 2012 as shown by the standard error is always larger in r1 0 05 0 015 than that of its neighboring small differential basin n1 or the others n2 and n3 fig 3b 3 2 step 4 influences of changes from other factors human activities such as irrigation and hydropower development can induce changes in e p by modifying evapotranspiration by changing the spatial extent and density of vegetation from the year 1990 to the year 2010 the vegetation and land cover have changed little in all subbasins table 3 grass and forest lands accounted for between 75 and 89 of the area in all subbasins whereas croplands occupied only between 0 8 and 12 table 3 in total the three vegetation types of land use i e forestland grassland and cropland contributed to 81 97 of the total area with negligible changes during the 20 years the jinsha river basin is dominated by extensive mountains with a limited extent of irrigated croplands the major agricultural irrigation areas located in the narrow riverine valleys of anning longchuan and binchuan are located within subbasin n3 even in the most densely populated areas of n3 irrigated croplands contribute to less than 1 to the total land use according to yin and xiang 2010 as such it is highly unlikely that the observed increase in e r p in r1 is due to the development or expansion of irrigated agriculture fig 4 shows the variation of ndvi by mvc during the growing season in the period 1983 2012 the ndvi has increased consistently across all differential subbasins r1 n1 n2 and n3 however the absolute increase in r1 is smaller than in the other subbasins probably since 0 3 of croplands and 0 1 of forestlands were submerged by reservoir impoundment table 3 assuming a close correlation between ndvi and transpiration we can infer that the change of evapotranspiration due to change in land cover and vegetation density should be similar in all subbasins and at least smaller in r1 than in the other subbasins hence ndvi development as a proxy of vegetation growth cannot fully explain the differences between the change in evaporative ratio in the four differential subbasins fig 3a b for instance by comparing er p in subbasins r1 and n1 that are spatially adjacent and have similarly climatological characteristics we find that ndvi has increased more in n1 than in r1 going against the finding of a higher increase in er p in r1 than in n1 the large increase in er p found in r1 is then the effct of drivers different from climate variability steps 1 and 2 or changes in vegetation occurring within this basin and most likely from the impoundment of the ertan reservoir 4 discussion and conclusion in our calculations of er p we have accounted for various datasets of p and different methods for calculating e0 regarding the influence of these datasets on the values of er p the time series of er p were derived for each combination of e0 and p we found that er p is more sensitive to the dataset selection of p than to the method of calculation of e0 fig a 16 and a 17 supplementary materials for example among the three precipitation datasets p from cdr has the largest magnitude and also the largest increasing trend in p in the four differential subbasins fig a 4 and the largest resulting trends of er p fig a 16 regarding the difference of e0 among datasets the corresponding differences in er p are small fig a 17 we find that the estimates of e0 by the shi method show a more pronounced increase in e0 during the second period than the penman monteith furthermore we find that the shi estimate is higher at lower r1 and n1 than higher elevations n2 and n3 when compared to penman monteith the observed increase in er p in the smallest regulated subbasin r1 0 054 0 015 corresponds to an increase in er of 46 15 mm yr from pre damming to post damming period this change is beyond the one expected from the change in p and e0 as we have already removed this contribution in step 2 we attribute these changes to the impoundment of the reservoir due to i the absence of other known drivers of this change that could explain such increase ii the occurrence of this increase around the time of the construction of the reservoir iii and the comparison of this increase with the milder increases or even decrease in er p for the other differential subbasins not holding the ertan reservoir our results fall in line with other studies identifying basin scale increases in evapotranspiration in regulated basins in sweden destouni et al 2013 and eastern europe levi et al 2015 as a marked difference from these other studies we here can attribute most of the increase in er p to the impoundment of one single reservoir performing the same analysis on the nested catchments as for the differential subbasins also shows that the increase in er p is more evident as the area of the hydrological basin holding the reservoir decreases fig a 12 we can further calculate the water footprint of the ertan hydroelectric project by converting the residual increase in evapotranspiration er in r1 to volume based on the area of subbasin r1 i e 1 001 km3 yr and dividing by the annual hydroelectric production of the hydroelectric project 17 tw h yr we obtain a water footprint of 16 54 m3 gj this value falls within the range of water footprints of hydropower found by herath et al 2011 in new zealand actually the result of ertan reservoir is very close to that of the tekapo reservoir in new zealand the water area of ertan is 10 100 ha and the water evaporation is between 1200 and 1300 mm yr liu et al 2015 which is very close to the area of 9733 ha and the water evaporation 1153 mm yr of the tekapo reservoir herath et al 2011 for comparison purposes we now assess the wf of hydroelectricity by three different methods using new zealand as a case study the first wf 1 and second wf 2 methods only consider the consumptive water use of the hydroelectricity generation system while our third method wf 3 accounts for the net water balance irrespective of the method the wf of new zealand s hydroelectricity was found much smaller than the commonly cited international value of 22 m3 gj gerbens leenes et al 2009 depending on the method the national wf ranged from 1 55 m3 gj wf 3 to 6 05 m3 gj wf 1 the wf 3 considers the net water balance including rainfall which is the key driver for replenishing water resources it provides meaningful information that helps our understanding of the differences of the wf in locations which are diverse in terms of water resource availability we highlight the effects of local climatic differences and the structural specifics of a hydroelectricity scheme on the wf the large variation in the wf of hydropower across new zealand illustrates the inappropriateness of using global average values local values calculated using our hydrologically rational method must be used interestingly the water footprint of the ertan reservoir is only half of the average water footprint of the 35 hydroelectric stations calculated by mekonnen and hoekstra 2012 i e 39 m3 gj this is explained by the difference in methodology as we here take into account only the change in residual evapotranspiration rather than in total evapotranspiration bakken et al 2013 however the physical processes underlying these increases in evapotranspiration cannot be identified from our results nor methodology and then can only be assumed we infer that the increase occurs because of 1 higher availability of water by the reservoir s extended water surface increasing evaporation jaramillo destouni 2015a mekonnen hoekstra 2012 shiklomanov 2000 ii higher water tables around the reservoir making water more available to these dry surrounding vegetation and thus enhancing transpiration iii more convective potential energy in the valley which is more evident as the surface area of the subbasin decreases degu et al 2011 or iv reservoir related effects on other climatic parameters that may increase potential evapotranspiration regarding the latter it is worth noting that the calculations of potential evapotranspiration used in this analysis at least for the case of subbasin r1 are based on spatial extrapolations rather than actual measurements for instance only one of the 53 climatic stations used in this study and containing wind velocity surface temperature air temperature and air vapor used for the calculations of potential evapotranspiration is located within this differential subbasin fig a 2 as such the possible local effects from the impounded reservoir on potential and actual evapotranspiration may be missed in our calculations of e0 and ec and rather be included in the residual er another possibility of uncertainty may be related to the assumption of negligible storage change within the differential subbasins used to calculate e step 1 for instance mao et al 2016 assessed the larger six major river basins in china 27 104 180 104 km2 including the yangtze river basin 180 104 km2 whose source basin is the jinsha river basin they found that accumulated storage of water by the impoundment of consecutive reservoirs could explain part of the increase of e p in china i e eq 1 however their result is based on assumptions of increases in water storage in these basins that are much higher than the actually reported water storages in the impounded reservoirs similarly there may be additional hidden water storage around the reservoirs by seepage as estimated by chao et al 2008 and mentioned by bakken et al 2017 which may increase the water storage within the basin calculated by eq 1 and decrease the estimate of e nonetheless jaramillo and destouni 2015b show that even when considering this additional water storage in the form of seepage is still negligible and does not affect the calculations of evapotranspiration in large basins such as the ones analyzed here we here show how the water footprint of hydropower can be achieved from simple water mass balance at the scale of the hydrological basin of the reservoir this method should be preferable to calculating water consumption from estimates of potential evapotranspiration as the water mass balance constraints the value of evapotranspiration based on actual observations furthermore our methodology includes any unforeseen effects of the construction of the reservoir extending beyond the limits of the water surface such as enhanced evapotranspiration by vegetation around the reservoir and seepage increase in atmospheric moisture and wind velocity or in potential energy by convection our study also shows how the effect of the reservoir on evapotranspiration in the vicinity of the reservoir er p becomes more evident as the area of the hydrological basin holding the reservoir decreases figure a 12 of supplementary materials in our study basin constrained water mall balance could not identify a positive increase of evapotranspiration subbasin beyond the size of subbasin s3 188 4 103 km2 e g the entire jinsha river basin or subbasin s4 figure a 18 this is expected as the area and effect of the reservoir decreases in relation to the effects of other drivers and the area of the hydrological basin therefore our method can be used in any other hydrological basin but the effects from hydropower will be more evident for smaller basins of analysis while the influence of non climatological factors as reforestation and irrigation may play a more important role in larger basins of analysis cao et al 2014 sun et al 2006 credit author statement lian sun conceptualization methodology data curation programming writing original draft yanpeng cai conceptualization writing review editing supervision funding acquisition aifang chen validation david zamora programming fernando jaramillo conceptualization methodology writing original draft writing review editing supervision funding acquisition declaration of competing interest the authors declare no competing interests acknowledgments and data this work was supported by the national key research program of china 2016yfc0502209 the national natural science foundation of china no 51879007 the guangdong provincial science and technology project 2020b1111380003 and the china scholarship council no 201806040090 contribution of f j was funded by the swedish research council vr project 2015 06503 the swedish research council for environment agricultural sciences and spatial planning formas 942 2015 740 the cdr precipitation data are available from persiann cdr website http chrsdata eng uci edu the cru precipitation and potential evapotranspiration data are obtained in climatic research unit https crudata uea ac uk cru data hrg the nmic precipitation data are available in national meteorological information center of the chinese meteorological administration including china monthly precipitation gridded dataset v2 0 http data cma cn data detail datacode surf cli chn pre mon grid 0 5 keywords 2472 html the monthly observational meteorological data including mean minimum maximum air temperature soil temperature in the depth of 0 cm vapor pressure sunshine duration wind speed and relative humidity can be accessed in the nmic monthly dataset http data cma cn data cdcdetail datacode surf cli chn mul mon html the ndvi data can be downloaded in us national oceanic and atmospheric administration noaa advanced very high resolution radiometer avhrr https www ncei noaa gov data avhrr land normalized difference vegetation index access the lulc data are derived from resource and environment data cloud platform http www resdc cn default aspx supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2021 103947 appendix supplementary materials image application 1 
294,multiphase displacements in porous media are expected to be stable if the injectant has a smaller mobility than the resident phase and injection velocity is small we investigate two phase displacements aqueous phase displacing oleic phase at favorable mobility ratios which are expected to be stable and find that the presence of low viscosity irreducible water promotes the formation of viscous instabilities microfluidic experiments and lattice boltzmann lb simulations were utilized to identify the effects of pore scale mobilization of irreducible water on centimeter scale flow patterns during favorable displacements displacements in glass micromodels showed the presence of low viscosity irreducible water resulted in fingering and early breakthrough compared to experiments with high viscosity irreducible water glycerol solution the lb simulations were used to explain that fingers formed because irreducible water was mobilized ahead of the injected water the low viscosity aqueous front fingered through the oil as the viscosity of the oil was larger than that of the low viscosity aqueous phase bank additionally we conducted a coreflood that showed breakthrough of the aqueous phase occurred slightly earlier when irreducible aqueous phase viscosity was low 1 cp than when irreducible aqueous phase viscosity was large 69 cp the novelty of this work lies in showing that presence of low viscosity irreducible water may result in an unstable displacement of medium viscosity oil by high viscosity aqueous solution at small flooding velocities keywords fingering immiscible irreducible water waterflood 1 introduction viscous fingering occurs when a perturbation at the interface between a high mobility fluid displacing a low mobility fluid grows continuously the phenomenon was formally studied by imaging two immiscible fluids in hele shaw cells saffman taylor 1958 and has since been widely investigated in porous media homsy 1987 at miscible conditions jha et al 2011 and reactive conditions de wit 2001 comprehensive simulation and experimental studies of multiphase displacements in porous media have shown the emergence of fingers depends on the velocity of the displacement wettability and the mobility relative permeability viscosity λl krl µl where k and µ are the relative permeability and viscosity of phase l of the fluids lenormand et al 1988 zhang et al 2011 zhao mohanty 2019 in subsurface processes such as co2 storage or waterflooding the flooding velocity is usually small especially far away from the injection and production wells and fingering largely depends on the viscosity of the fluids it is widely accepted that at very favorable mobility ratios and low flooding rates fingering does not occur during two phase displacements in porous media homsy 1987 however if the mobility at the shock changes due to compositional changes as in water alternating gas wag processes originally stable displacements may finger moortgat 2016 the aim of this article is to experimentally evaluate the effect of irreducible water on two phase displacement stability if the presence of low viscosity irreducible water results in marked changes in displacement stability and overall sweep of oleic phase by viscous aqueous phase the findings of this research are pertinent for applications such as polymer flooding and non aqueous phase liquids removal by a viscous aqueous phase irreducible water is defined as the volume of water that remains trapped in a porous medium after injecting infinite pore volumes of another immiscible phase at constant flow rate zhou et al 2000 in water wet rocks irreducible water may exist as thin films in dead end crevices or as capillary trapped phase in well connected pores due to network by passing in water wet rock cores this volume of water is around 15 40 at flooding velocities of 1 20 ft day 3 5 10 6 m s chen wood 2001 pore scale studies of steady co injection of water and oil have shown water in stagnant zones some of which may include irreducible water is subject to diffusion with injected water aziz et al 2018 additionally at transient conditions the irreducible water or the resident water may be advected ahead of injected water as evidenced by coreflood experiments graue et al 2014 if irreducible water accumulates in a bank during a polymer flood a two front stability analysis may be necessary to determine if fingers form bouquet et al 2020 the displacement may be unstable at the downstream front resident water oil or at the upstream front injected polymer solution resident water or both several studies have considered the effect of irreducible water on viscous fingering at unfavorable viscosity ratios where injectant is less viscous than the resident fluid the presence of irreducible water has been shown to reduce the displacement efficiency of polymer flooding in laboratory corefloods kelley caudle 1966 visual studies in columns packed with glass beads found that irreducible water changes the morphology of fingers during unfavorable displacements modifying fingering patterns into mixed regions where no fingers were clearly discernible perkins johnston 1969 importantly these experiments did not show irreducible water affected favorable displacements although they reported some mixed zone regions where saturations at the front appeared disperse in their listed favorable mobility experiments more recently visual investigations in packed beds confirmed irreducible water affects the shapes of fingers during unfavorable displacements thibodeau et al 1997 these experiments found that at low rates irreducible water increases the degree of finger branching a recent study utilized fluorescent microscopy to track the displacement of irreducible water during an unfavorable mobility polymer flood in a micromodel födisch et al 2015 this group injected 10 cp polymer into a micromodel saturated with 20 cp oil and irreducible brine 1 cp they concluded irreducible water was mobilized by injected polymer when it was contacted by the polymer solution at low rates additionally they classified the front into three regions 1 irreducible water followed by 2 a mixing zone followed by 3 injected polymer their findings agree with graue s conclusion that injected water displaces irreducible water in a bank graue et al 2014 and provided visual evidence as to how the polymer displaces irreducible water in addition to oil however these experiments focused on unfavorable mobility displacements and did not address the possibility that irreducible water may cause fingering when the injectant is more viscous than the oil considering the findings by graue et al 2014 and fodish et al 2015 it is evident that irreducible water can be displaced ahead of aqueous injectant moreover displacements in visual models have shown irreducible water affects fingering patterns during unfavorable displacements yet the very few experiments investigating the effect of irreducible water on favorable displacements have not directly connected the pore scale mobilization of irreducible water to changes in flow patterns such as the emergence of fingers perkins johnston 1969 however irreducible water mobilization may change the viscosity of the front and render the displacement unstable as it progresses in a process analogous to frontal mobility alteration during water alternating gas wag floods moortgat 2016 we propose that as irreducible water is mobilized ahead of injected viscous aqueous phase the displacement may become unstable as the viscosity profile becomes non monotonic across the shock front fingering resulting from irreducible water has implications for subsurface processes designed to be stable displacements such as polymer flooding napl removal or wag flooding as fast movement by irreducible water fingers may result in earlier than expected aqueous phase breakthrough times or smaller than expected oil recoveries moreover the identification of this behavior may encourage the utilization of reservoir simulation tools that capture two phase fingering luo et al 2016 sorbie et al 2020 even when injectant viscosity is much larger than the resident oil to adequately describe the displacement we perform displacement experiments in microfluidic devices and multiphase simulations using a lattice boltzmann lb scheme to study irreducible water fingering during favorable displacements and finally conduct coreflood experiments to evaluate implications on larger scale porous media first we performed displacements in micromodels to control the porous medium configuration and visualize the displacements with ease the micromodel experiments allowed us to confirm our findings were repeatable at controlled conditions then we utilized lattice boltzmann simulations to determine what physics control the fingering due to irreducible water the simulations helped us to better interpret the results from the micromodel experiments finally we conducted coreflood experiments to observe if the fingering due to irreducible water occurred in real 3d rocks 2 materials and methods 2 1 microfluidic devices fluids and experimental setup visualization experiments were conducted in glass microfluidic devices we transferred two pore scale patterns to the glass devices 1 arrays of hollow grains as shown in fig 1 a and 2 random percolating geometries generated by thresholding gaussian random fields shown in fig 1b hollow grains in fig 1a consist of squares with an opening pore throat in the direction opposite to flow and a cavity that is approximately 0 1 mm2 the base unit of the regular array geometries allowed us to control the location and volume of irreducible water any irreducible water remained trapped only within the hollow grains at very large oil rates 5000 µl hr additionally the volume of irreducible water in these hollow grains may be controlled by rotating or closing the grains introducing solid rather than hollow grains reduces the amount of irreducible water placing a hollow grain s pore throat in directions tangential to flow reduces the oil flow rate required to mobilize water inside it rock like structures shown in fig 1b were constructed by convolving a set of random points with a gaussian kernel and thresholding the result details about the mathematics of correlated fields for pore scale flow in rocks may be found in hyman winter 2014 and their implementation in micromodels in mejia et al 2020 the properties of the two micromodels utilized in this study are presented in table 1 glass micromodels were fabricated using a standard lithography procedure first we coated a soda lime glass wafer with a thin 20 nm layer of chromium followed by a thicker 500 nm layer of copper second we applied positive photoresist microposit s1818 on the wafers by spin coating at 3000 rpm for 45 seconds third a suss ma6 mask aligner transferred the patterns to the photoresist by dosing uv light at 150 mj cm2 fourth uv exposed photoresist and the underlying copper and chromium were removed using appropriate liquid solvents fifth we etched the exposed glass pattern using buffered oxide etchant finally we drilled holes on the wafer at the entry and exit ports and thermally bonded the wafers to another non manipulated glass slide airtight connections and syringes used in our previous studies were used for this investigation mejia et al 2019 fluids for the microfluidic experiments consisted of 18 µω deionized di water light crude oil 0 8 g cm3 12 cp and glycerol solution 99 9 purity fisher scientific we prepared 87 wt glycerol solution 100 cp by mixing di water and glycerol syringe pumps harvard phd2000 were used to inject fluids into the microfluidic devices and optical cameras lumera 42 nikon d50 captured images of the displacements we measured saturations by performing image analysis subtracting background enhancing contrast and applying global otsu thresholding on images of the displacements as discussed in our previous studies du et al 2019 additional details on the image analysis methods may be found in our previous work mejia et al 2019 du et al 2020 2 2 lattice boltzmann simulations we conducted two dimensional 2d lattice boltzmann lb simulations to analyze displacements in micromodels the code used in this study models three phases two of which are miscible it assumes instantaneous viscosity averaging between adjacent lattice nodes when miscible phases come into contact and the aqueous phase completely wets the solid this lb implementation is based on a multiphase rothman keller type lb model leclaire et al 2012 2013 2013 2014 and variations have successfully been applied to study multiphase flow at the pore scale for newtonian and non newtonian fluids xie et al 2018 2020 2021 this realization of lb describes the fluids using the following set of equations for each phase 1 f i k x c i δ t t δ t f i k x t ω i k f i k x t γ i ρ k ρ f x t 2 γ i ρ k ρ f x t ρ k ρ δ t 1 1 2 τ f 3 c i u f c 2 w i 3 c i u c 2 9 c i u 2 2 c 4 3 u 2 2 c 2 3 τ f 1 2 3 ν c 2 δ t in eq 1 f is the distribution function i is the direction of the lattice velocity k denotes each fluid phase x is the lattice position ci is the lattice velocity in direction i t is time δt is the time step ρ k is the macroscopic phase density ρ is the total density ω i k is the collision operator combined by three sub operators the single phase operator ω i k s for the momentum evolution the perturbation operator ω i k i to account for the interfacial tension and the recoloring operator ω i k m to ensure mass conservation γ i eq 2 is the forcing term guo et al 2011 to account for the body force f where wi is the weight parameter τ f eq 3 is the relaxation parameter determined by the kinematic viscosity ν the lattice speed c and the timestep in the simulations presented here we used the d2q9 scheme the hollow grains domain was represented by a lattice of 2795 892 nodes while the rock like geometry consisted of 1000 393 nodes simulations were performed on the stampede2 system at the texas advanced computing center on 48 intel xeon platinum 8160 cores 2 3 coreflood experiments we performed coreflood experiments in bentheimer sandstone rocks with the coreflooding apparatus detailed in mejía et al 2021 the cylindrical rock core was isolated in a steel coreholder fluids were injected at a constant rate of 0 07 ml min equivalent to 1 1 ft day in this rock from the bottom and collected at the top and pressures were measured along the core in four sections the experiments consisted of viscous glycerol solution displacing oil and large or low viscosity irreducible aqueous phase the rock was 2300 md and had a porosity of 0 27 table 2 experiments were conducted at room temperature and pressure for the first experiment low viscosity irreducible water consisted of 10 wt nacl in di while injected aqueous phase was 83 wt glycerol solution with 0 1 wt nacl in deionized di water for the second experiment the large viscosity irreducible water consisted of 83 wt glycerol solution with 0 1 wt nacl while the injectant was 74 wt glycerol solution with 9 5 wt nacl the salinities were selected such that injectant viscosities were similar for the two experiments table 3 the viscosity of the injectant and residual aqueous solution in the second experiment were similar 68 cp and 69 cp and the composition of the outflow could be measured by refractometry to measure the concentration of injected and resident water at the outlet takamura et al 2012 3 results and discussion 3 1 displacements in micromodels we performed experiments in a 6 cm long 1 cm wide micromodel with a 2d array of hollow squares containing irreducible water inside the repeating structures fig 1a the irreducible water saturation for this micromodel was 47 fluids entered the chip in the following sequence 1 aqueous phase 1 cp or 100 cp displacing air 2 12 cp crude oil displacing aqueous phase 3 viscous glycerol 100 cp displacing the oil and irreducible aqueous phase fig 2a shows the displacement for the case where the aqueous phase was water 1 cp the displacement became unstable after the front traversed about 0 5 cm and the aqueous phase broke through at 0 22 pvi at the time of breakthrough two large fingers are visible in the displacement with the low viscosity irreducible water fig 2a however the displacement with the large viscosity irreducible glycerol solution is stable at 0 22 pvi fig 2b experiments presented in fig 2 were conducted at 10 µl hr corresponding to injection velocity 1 9 10 5 m s and images were captured at 1 img min the light blue represents aqueous phase that mobilized oil and the black represents non mobilized phase oil or aqueous phase and the solid phase after observing fingering in an ordered geometry with a large amount of irreducible water saturation 47 we conducted displacements in a serpentine porous micromodel with a flow length of 40 cm and a cross sectional length of 0 6 cm a core on a chip where the locations and volumes of irreducible aqueous phase ganglia were not controlled microscopic images captured before glycerol injection showed this chip had 9 irreducible water saturation a long flow domain was selected because previous studies by our group showed fingering due to irreducible water was not observable in short 1 2 cm micromodels mejia et al 2020 we introduced a heterogeneous pore scale geometry in the core on a chip micromodel by convolving random points with a gaussian kernel the design includes shallow pore throats as introduced by xu et al 2017 the method involves positioning during lithography disconnected adjacent pores a distance away from each other such that upon isotropic wet etching the pores connect the connection between the adjacent pores the pore throat is wedge like and is shallower than the etching depth at the middle of each pore body shallow pore throats also known as 2 5d throats introduce sharp capillary pressure barriers between grains promoting non wetting phase snap off and resulting in disperse non wetting phase ganglia distributions additionally shallow throats provide a larger degree of continuity of the solid phase compared to traditional 2d micromodels these characteristics make 2 5d micromodels more similar to real rocks than traditional 2d micromodels xu et al 2017 details on the design of this long micromodel may be found in mejia et al 2020 displacements in the long micromodel were conducted at an injection rate of 5 µl hr corresponding to an injection velocity of 1 3 10 5 m s 3 7 ft day images of the displacements are presented at 0 35 pvi in fig 3 where a shows the displacement of oil with 1 cp irreducible water by 100 cp glycerol solution and b shows the displacement of oil with 100 cp irreducible glycerol solution by 100 cp glycerol solution the blue represents aqueous phase that has displaced oleic phase and the black is the solid phase and un mobilized fluids the outline of the domain is colored in white and the inlet is the solid white arrow when the viscosity of the irreducible water was low 1 cp the displacement became unstable after about 5 cm when the viscosity of the irreducible aqueous phase was large the displacement was stable the image in fig 3a shows aqueous phase light blue reaching the outlet for the low viscosity irreducible water case at 0 35 pvi the aqueous phase looks dispersed as the fingers have lost most of their structure in this frame but the tip of the finger that first breaks through is discernible at the same dimensionless time the flood front in the case with high viscosity irreducible water shown in fig 3b remains stable and the aqueous phase light blue is about halfway to the outlet phase saturations over dimensionless time pvi in the micromodel are presented in fig 4 the experiments solid lines are shown along with a fractional flow interpretation dotted lines the models were fitted by minimizing the sum of squared errors of the difference between the oil saturation in the experiments and the models fitted fractional flow solutions and their parameters are provided in the supplementary information using a single set of relative permeability curves was unfeasible as this approach only described one of the displacements adequately therefore we increased the residual oil saturation for the low viscosity irreducible water displacement from 0 1 to 0 2 and increased the oil exponent from 1 2 to 2 obtaining the fit shown in fig 4 other than the increase in s or and increase in the oil exponent and a small change in s wr from 0 11 to 0 09 to fit the y intercept the parameters for the relative permeability curves are the same for the two displacements it is notable the fractional flow solution black arrow with bt ff for the low viscosity irreducible water largely overestimates breakthrough time compared to the observed experimental breakthrough time black arrow with bt exp the fractional flow solution adequately describes the large viscosity irreducible water displacement additionally comparison of the two experiments indicates aqueous phase in the low viscosity irreducible water displacement reached the outlet in half the time as the displacement with high viscosity irreducible water about 0 35 pvi vs 0 75 pvi the displacement with low viscosity irreducible water broke through earlier because the low viscosity front 1 cp fingered and later dispersed rapidly through the oil 12 cp the displacement with large viscosity irreducible glycerol solution remained stable throughout breakthrough time in the low viscosity irreducible water case was determined by visual inspection of the displacement and corresponds to fig 3a moreover the oil saturation difference at the end of this displacement is about 9 for the two investigated cases while irreducible water arrived rapidly when its viscosity was small ultimate recovery varies modestly for the two cases displacements in the core on a chip indicate low viscosity irreducible water seems to greatly affect the shape of the front and time of aqueous phase breakthrough in micromodels the effect of irreducible water viscosity on the displacement front is evident from fig 3 at 0 35 pvi the displacement with low viscosity irreducible water has a very disperse aqueous phase front where droplets of blue are scattered from about 1 3 of the flow length to the outlet the displacement with high viscosity irreducible water on the other hand shows a sharp piston like front the shape of the downstream front depends on the mobility of the fluids at that front the micromodel experiments suggest 1cp irreducible water is collected at the front of the injected glycerol solution 100 cp forming a low viscosity bank that then fingers through the 12 cp oil lattice boltzmann simulations presented in section 3 2 explore this proposed mechanism in more detail moreover residual oil saturation s or is about 10 larger in the micromodel experiment with low viscosity irreducible water than in the experiment with high viscosity irreducible water as shown in fig 4 at 1 pvi the difference in sor may be due to the difference in phase distributions for the two cases juárez morejón et al 2018 the second half of the flow domain in the low viscosity irreducible water case fig 3a shows dispersed water ganglia as fingers have lost their structure fingers lose their structure as shown in fig 5 because the irreducible water content is small 10 and the width length w l ratio is small 0 6 cm 40 cm the irreducible water that initially forms fingers later disperses as the small irreducible water saturation is not sufficient to maintain and propagate finger structures the small w l ratio also constrains finger propagation in the direction perpendicular to injection and allows for the breaking of the structures this is in contrast with the case shown in fig 2a where the irreducible water saturation is 47 and the w l is larger 1 cm 6 cm 3 2 lattice boltzmann simulations if the local viscosity in the downstream front low viscosity swirr mobilizing medium viscosity oil becomes unfavorable due to the accumulation of irreducible water then the downstream front should become unstable as fingers of low viscosity irreducible water form and grow through the medium viscosity oil we conducted lattice boltzmann simulations at injection velocities of 10 5 m s in small domains with hollow grains fig 6 to analyze the microfluidic experiments specifically we wanted to evaluate more clearly the configuration of the aqueous solutions to determine if low viscosity irreducible water collected at the front of the high viscosity aqueous injectant the simulations show formation of viscous instabilities at the aqueous oleic interface when the irreducible water light blue was less viscous than the oil green in fig 6a but not when the irreducible aqueous phase was more viscous dark blue than the oil fig 6b fig 6 shows the simulations at 0 36 pvi with a low viscosity irreducible water and b high viscosity irreducible aqueous phase the displacement in fig 6a has three distinct fingers with the middle one slightly longer than the other two the instabilities were present at the front of the mixing zone but not at the rear of the mixing zone furthermore the fingers have a large concentration of irreducible water white light blue this explains why fingers in the microfluidic experiments fig 2a propagated faster than the mixing zone behind them as fingers form they contact and mobilize irreducible water maintaining a local unfavorable viscosity ratio as aqueous phase from the fingers intermixes with low viscosity water from the hollow grains the fingers viscosity is reduced to almost that of the irreducible water 1 cp white light blue and fingers continue to propagate through the 10 cp oil green we also performed lb simulations in a rock like 2d domain the pore space was generated by convolving a set of random points with a gaussian kernel the simulations consisted of 1 saturating the domain with irreducible water or viscous aqueous phase 2 displacing the water with oil and 3 displacing the oil with viscous aqueous phase results of displacements with low viscosity residual aqueous phase at the beginning of step 3 are shown in fig 7 for a low viscosity irreducible water and b high viscosity irreducible water at 0 46 pvi at this dimensionless time the low viscosity irreducible water breaks through but the high viscosity irreducible water has not yet reached the outlet fig 7a shows most of the irreducible water moves at the front of the displacement and a mixing zone exists between the mobilized irreducible water and the aqueous injectant fingering was not evident in either of the cases we attribute this to the small size of the simulated domain as previous preliminary experiments by our group suggest small rock like porous media may not have sufficient flow length to allow for the formation of banks and other larger scale aggregations thus was the motivation to conduct the experiment in the core on a chip micromodel mejia et al 2020 additionally simulations in a long domain were computationally unfeasible requiring several months for completion so we conducted simulations in a small domain to identify mechanisms that explained experimental observations visualizations of the displacements at 1 25 pvi are presented in fig 8 image a shows the phase distributions for the low viscosity irreducible water case and b shows the distributions for large viscosity irreducible water case in both the oil green is well dispersed the residual oil saturation is not significantly different however image a shows some irreducible water white light blue is present at isolated locations this water became inaccessible to the injected water because of phase entrapment residual oil clusters blocked the throats of pores where residual water was present preventing it from contacting injected aqueous phase plots of fluid content in the porous medium over time fig 9 a show the ultimate oil recovery is similar for the two cases additionally breakthrough occurred earlier in the displacement with low viscosity irreducible water by monitoring the glycerol concentration over time for the low viscosity irreducible water case fig 9b we found initially produced aqueous phase blue curve consisted at least partly of irreducible water the trend that mobilized irreducible water tends to the front of the aqueous oleic front holds for this simulation the initial spikes on the water cut curve ratio of rate of water at outlet and total effluent rate occur while glycerol concentration in the domain was around 0 5 figure 9b shows irreducible water was mobilized but neither fig 8 nor fig 9 provide evidence of fingering this is likely due to the small size of the simulated domain 3 3 implications to real rocks and large scale media we conducted coreflood experiments to determine if fingering due to irreducible water occurred in 3d natural porous media pressure versus time data of the coreflood experiments are presented in fig 10 pressures were measured along four sections of the core and across the whole core pressure response of the low viscosity irreducible water experiment deviates from shock like when the pressure front reaches the fourth section fig 10a aqueous phase breaks through at 0 28 pv earlier than the experiment with large viscosity irreducible water after breakthrough the whole core pressure drop looks nearly linear up until 0 35 pv while we cannot ascertain there was fingering in this experiment due to lack of visual evidence we confirmed the irreducible water moves ahead of the injected aqueous phase the experiment with large viscosity irreducible aqueous phase fig 10b had the pressure response of a piston like displacement pressure increased nearly linearly across the core and across each section as the shock like front traversed it until the shock front reached the outlet at breakthrough 0 34 pv measurements of collected fluids at the outlet show the low viscosity irreducible water appears to smear the shock like displacement fig 11 a the oil cut at the outlet solid line is more step like for the large viscosity irreducible water saturation case red than for the low viscosity irreducible water saturation case black and from the solid curves it is straightforward to observe injectant in the low viscosity irreducible water saturation coreflood broke through earlier oil saturation dashed lines is similar for the two displacements with the low viscosity irreducible water case having a larger residual oil saturation 31 vs 34 refractometry measurements of injected aqueous phase concentration at the outlet dotted curves indicate a more shock like arrival for the residual aqueous phase in the case with large viscosity irreducible aqueous phase red and a more disperse and earlier arrival for the residual aqueous phase in case with low viscosity irreducible water black presentation of the recovery data in the form of cumulative oil recovery versus time fig 11b shows how the coreflood experiments may be interpreted as a two front problem the dotted vertical lines in fig 11b represent the first arrival of aqueous phase for each displacement these are indicators of the arrival times for the downstream front irreducible water oil the black dotted line marks the arrival of low viscosity irreducible water and the red dotted line marks the arrival of high viscosity irreducible water clearly the low viscosity irreducible water arrives more rapidly than the large viscosity irreducible water additionally there is change in slope in the oil recovery solid black curve after the irreducible water breaks through the dashed lines mark the arrival of aqueous phase with 90 injected water these dashed lines are indicators of the arrival of the upstream front where high viscosity glycerol solution displaces oil and resident water the downstream front appears to move at approximately the same velocity for both the cases smaller final recovery in the low viscosity irreducible water coreflood is likely the result of by passing by the unstable front as the same core was utilized for both displacements and the initial fluid saturations were similar for both experiments difference in arrival time for low and high viscosity irreducible water was significantly larger in micromodels than in corefloods 0 3 pvi versus 0 04 pvi respectively there are several reasons for the large difference in arrival times of low viscosity water in corefloods versus micromodels the capillary pressure gradients which are much more pronounced in cores than micromodels stabilize fingering daripa paşa 2008 moreover the w l ratio is larger in corefloods this may prevent fingers from collapsing after growing a small distance preventing a rapid dispersion of the low viscosity irreducible water in the oil finally there may be overestimated dispersive mixing in 2d versus 3d afshari et al 2020 as injected aqueous phase likely mixes more readily with irreducible water in lower dimensional space 4 conclusions apparently stable two phase displacements in micromodels at very favorable viscosity ratios became unstable due to the presence of low viscosity residual aqueous phase in micromodels lattice boltzmann simulations showed fingers were mostly composed of low viscosity irreducible water comparison of results in the three investigated systems micromodels simulations and corefloods indicates fingering due to low viscosity irreducible water is enhanced by large residual water saturations as propagating fingers at the downstream front encounter pockets of irreducible water more readily fingers mix with the contacted irreducible water which allows them to maintain a low viscosity compared to the oil and grow the observed fingering is hindered by low w l ratios that promote phase dispersion rather than finger propagation by large capillary pressure gradients daripa paşa 2008 and a smaller degree of pore scale mixing in 3d vs 2d afshari et al 2020 residual oil can trap residual water this phase interference reduces contact areas between the injectant and irreducible water limiting the mobilization of residual water experiments in micromodels and corefloods indicate the emergence of instabilities modestly affects ultimate oil recovery and time of recovery even though breakthrough occurred significantly earlier in micromodels with low viscosity irreducible water ultimate oil recovery was similar for cases with low and high viscosity residual water saturation with a modest reduction in s or for cases with high viscosity residual water saturation in corefloods the effect of low viscosity irreducible water for secondary viscous waterflooding appears to be a smearing effect similar to capillary pressure when low viscosity irreducible water is present the effluent between the arrival of the first front and the second front has aqueous and oleic phases with a decreasing water cut on the other hand the effluent for the case with high viscosity irreducible water consisted only of aqueous phase after the arrival of the first front low viscosity irreducible water arrived slightly faster than high viscosity irreducible water the case with low viscosity irreducible water produced an earlier pressure distortion in the fourth section of the core than the case with large viscosity irreducible water acknowledgements the authors thank the kfupm university of texas at austin chemical eor global partnership project cpg 17 01 and the chemical enhanced oil recovery joint industry project for partial funding of this work we would also like to acknowledge the texas materials institute tmi at ut austin for providing the cleanroom and microfabrication equipment and the texas advanced computing center tacc for providing the computational resources for conducting the lb simulations supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2021 103943 appendix supplementary materials image application 1 
294,multiphase displacements in porous media are expected to be stable if the injectant has a smaller mobility than the resident phase and injection velocity is small we investigate two phase displacements aqueous phase displacing oleic phase at favorable mobility ratios which are expected to be stable and find that the presence of low viscosity irreducible water promotes the formation of viscous instabilities microfluidic experiments and lattice boltzmann lb simulations were utilized to identify the effects of pore scale mobilization of irreducible water on centimeter scale flow patterns during favorable displacements displacements in glass micromodels showed the presence of low viscosity irreducible water resulted in fingering and early breakthrough compared to experiments with high viscosity irreducible water glycerol solution the lb simulations were used to explain that fingers formed because irreducible water was mobilized ahead of the injected water the low viscosity aqueous front fingered through the oil as the viscosity of the oil was larger than that of the low viscosity aqueous phase bank additionally we conducted a coreflood that showed breakthrough of the aqueous phase occurred slightly earlier when irreducible aqueous phase viscosity was low 1 cp than when irreducible aqueous phase viscosity was large 69 cp the novelty of this work lies in showing that presence of low viscosity irreducible water may result in an unstable displacement of medium viscosity oil by high viscosity aqueous solution at small flooding velocities keywords fingering immiscible irreducible water waterflood 1 introduction viscous fingering occurs when a perturbation at the interface between a high mobility fluid displacing a low mobility fluid grows continuously the phenomenon was formally studied by imaging two immiscible fluids in hele shaw cells saffman taylor 1958 and has since been widely investigated in porous media homsy 1987 at miscible conditions jha et al 2011 and reactive conditions de wit 2001 comprehensive simulation and experimental studies of multiphase displacements in porous media have shown the emergence of fingers depends on the velocity of the displacement wettability and the mobility relative permeability viscosity λl krl µl where k and µ are the relative permeability and viscosity of phase l of the fluids lenormand et al 1988 zhang et al 2011 zhao mohanty 2019 in subsurface processes such as co2 storage or waterflooding the flooding velocity is usually small especially far away from the injection and production wells and fingering largely depends on the viscosity of the fluids it is widely accepted that at very favorable mobility ratios and low flooding rates fingering does not occur during two phase displacements in porous media homsy 1987 however if the mobility at the shock changes due to compositional changes as in water alternating gas wag processes originally stable displacements may finger moortgat 2016 the aim of this article is to experimentally evaluate the effect of irreducible water on two phase displacement stability if the presence of low viscosity irreducible water results in marked changes in displacement stability and overall sweep of oleic phase by viscous aqueous phase the findings of this research are pertinent for applications such as polymer flooding and non aqueous phase liquids removal by a viscous aqueous phase irreducible water is defined as the volume of water that remains trapped in a porous medium after injecting infinite pore volumes of another immiscible phase at constant flow rate zhou et al 2000 in water wet rocks irreducible water may exist as thin films in dead end crevices or as capillary trapped phase in well connected pores due to network by passing in water wet rock cores this volume of water is around 15 40 at flooding velocities of 1 20 ft day 3 5 10 6 m s chen wood 2001 pore scale studies of steady co injection of water and oil have shown water in stagnant zones some of which may include irreducible water is subject to diffusion with injected water aziz et al 2018 additionally at transient conditions the irreducible water or the resident water may be advected ahead of injected water as evidenced by coreflood experiments graue et al 2014 if irreducible water accumulates in a bank during a polymer flood a two front stability analysis may be necessary to determine if fingers form bouquet et al 2020 the displacement may be unstable at the downstream front resident water oil or at the upstream front injected polymer solution resident water or both several studies have considered the effect of irreducible water on viscous fingering at unfavorable viscosity ratios where injectant is less viscous than the resident fluid the presence of irreducible water has been shown to reduce the displacement efficiency of polymer flooding in laboratory corefloods kelley caudle 1966 visual studies in columns packed with glass beads found that irreducible water changes the morphology of fingers during unfavorable displacements modifying fingering patterns into mixed regions where no fingers were clearly discernible perkins johnston 1969 importantly these experiments did not show irreducible water affected favorable displacements although they reported some mixed zone regions where saturations at the front appeared disperse in their listed favorable mobility experiments more recently visual investigations in packed beds confirmed irreducible water affects the shapes of fingers during unfavorable displacements thibodeau et al 1997 these experiments found that at low rates irreducible water increases the degree of finger branching a recent study utilized fluorescent microscopy to track the displacement of irreducible water during an unfavorable mobility polymer flood in a micromodel födisch et al 2015 this group injected 10 cp polymer into a micromodel saturated with 20 cp oil and irreducible brine 1 cp they concluded irreducible water was mobilized by injected polymer when it was contacted by the polymer solution at low rates additionally they classified the front into three regions 1 irreducible water followed by 2 a mixing zone followed by 3 injected polymer their findings agree with graue s conclusion that injected water displaces irreducible water in a bank graue et al 2014 and provided visual evidence as to how the polymer displaces irreducible water in addition to oil however these experiments focused on unfavorable mobility displacements and did not address the possibility that irreducible water may cause fingering when the injectant is more viscous than the oil considering the findings by graue et al 2014 and fodish et al 2015 it is evident that irreducible water can be displaced ahead of aqueous injectant moreover displacements in visual models have shown irreducible water affects fingering patterns during unfavorable displacements yet the very few experiments investigating the effect of irreducible water on favorable displacements have not directly connected the pore scale mobilization of irreducible water to changes in flow patterns such as the emergence of fingers perkins johnston 1969 however irreducible water mobilization may change the viscosity of the front and render the displacement unstable as it progresses in a process analogous to frontal mobility alteration during water alternating gas wag floods moortgat 2016 we propose that as irreducible water is mobilized ahead of injected viscous aqueous phase the displacement may become unstable as the viscosity profile becomes non monotonic across the shock front fingering resulting from irreducible water has implications for subsurface processes designed to be stable displacements such as polymer flooding napl removal or wag flooding as fast movement by irreducible water fingers may result in earlier than expected aqueous phase breakthrough times or smaller than expected oil recoveries moreover the identification of this behavior may encourage the utilization of reservoir simulation tools that capture two phase fingering luo et al 2016 sorbie et al 2020 even when injectant viscosity is much larger than the resident oil to adequately describe the displacement we perform displacement experiments in microfluidic devices and multiphase simulations using a lattice boltzmann lb scheme to study irreducible water fingering during favorable displacements and finally conduct coreflood experiments to evaluate implications on larger scale porous media first we performed displacements in micromodels to control the porous medium configuration and visualize the displacements with ease the micromodel experiments allowed us to confirm our findings were repeatable at controlled conditions then we utilized lattice boltzmann simulations to determine what physics control the fingering due to irreducible water the simulations helped us to better interpret the results from the micromodel experiments finally we conducted coreflood experiments to observe if the fingering due to irreducible water occurred in real 3d rocks 2 materials and methods 2 1 microfluidic devices fluids and experimental setup visualization experiments were conducted in glass microfluidic devices we transferred two pore scale patterns to the glass devices 1 arrays of hollow grains as shown in fig 1 a and 2 random percolating geometries generated by thresholding gaussian random fields shown in fig 1b hollow grains in fig 1a consist of squares with an opening pore throat in the direction opposite to flow and a cavity that is approximately 0 1 mm2 the base unit of the regular array geometries allowed us to control the location and volume of irreducible water any irreducible water remained trapped only within the hollow grains at very large oil rates 5000 µl hr additionally the volume of irreducible water in these hollow grains may be controlled by rotating or closing the grains introducing solid rather than hollow grains reduces the amount of irreducible water placing a hollow grain s pore throat in directions tangential to flow reduces the oil flow rate required to mobilize water inside it rock like structures shown in fig 1b were constructed by convolving a set of random points with a gaussian kernel and thresholding the result details about the mathematics of correlated fields for pore scale flow in rocks may be found in hyman winter 2014 and their implementation in micromodels in mejia et al 2020 the properties of the two micromodels utilized in this study are presented in table 1 glass micromodels were fabricated using a standard lithography procedure first we coated a soda lime glass wafer with a thin 20 nm layer of chromium followed by a thicker 500 nm layer of copper second we applied positive photoresist microposit s1818 on the wafers by spin coating at 3000 rpm for 45 seconds third a suss ma6 mask aligner transferred the patterns to the photoresist by dosing uv light at 150 mj cm2 fourth uv exposed photoresist and the underlying copper and chromium were removed using appropriate liquid solvents fifth we etched the exposed glass pattern using buffered oxide etchant finally we drilled holes on the wafer at the entry and exit ports and thermally bonded the wafers to another non manipulated glass slide airtight connections and syringes used in our previous studies were used for this investigation mejia et al 2019 fluids for the microfluidic experiments consisted of 18 µω deionized di water light crude oil 0 8 g cm3 12 cp and glycerol solution 99 9 purity fisher scientific we prepared 87 wt glycerol solution 100 cp by mixing di water and glycerol syringe pumps harvard phd2000 were used to inject fluids into the microfluidic devices and optical cameras lumera 42 nikon d50 captured images of the displacements we measured saturations by performing image analysis subtracting background enhancing contrast and applying global otsu thresholding on images of the displacements as discussed in our previous studies du et al 2019 additional details on the image analysis methods may be found in our previous work mejia et al 2019 du et al 2020 2 2 lattice boltzmann simulations we conducted two dimensional 2d lattice boltzmann lb simulations to analyze displacements in micromodels the code used in this study models three phases two of which are miscible it assumes instantaneous viscosity averaging between adjacent lattice nodes when miscible phases come into contact and the aqueous phase completely wets the solid this lb implementation is based on a multiphase rothman keller type lb model leclaire et al 2012 2013 2013 2014 and variations have successfully been applied to study multiphase flow at the pore scale for newtonian and non newtonian fluids xie et al 2018 2020 2021 this realization of lb describes the fluids using the following set of equations for each phase 1 f i k x c i δ t t δ t f i k x t ω i k f i k x t γ i ρ k ρ f x t 2 γ i ρ k ρ f x t ρ k ρ δ t 1 1 2 τ f 3 c i u f c 2 w i 3 c i u c 2 9 c i u 2 2 c 4 3 u 2 2 c 2 3 τ f 1 2 3 ν c 2 δ t in eq 1 f is the distribution function i is the direction of the lattice velocity k denotes each fluid phase x is the lattice position ci is the lattice velocity in direction i t is time δt is the time step ρ k is the macroscopic phase density ρ is the total density ω i k is the collision operator combined by three sub operators the single phase operator ω i k s for the momentum evolution the perturbation operator ω i k i to account for the interfacial tension and the recoloring operator ω i k m to ensure mass conservation γ i eq 2 is the forcing term guo et al 2011 to account for the body force f where wi is the weight parameter τ f eq 3 is the relaxation parameter determined by the kinematic viscosity ν the lattice speed c and the timestep in the simulations presented here we used the d2q9 scheme the hollow grains domain was represented by a lattice of 2795 892 nodes while the rock like geometry consisted of 1000 393 nodes simulations were performed on the stampede2 system at the texas advanced computing center on 48 intel xeon platinum 8160 cores 2 3 coreflood experiments we performed coreflood experiments in bentheimer sandstone rocks with the coreflooding apparatus detailed in mejía et al 2021 the cylindrical rock core was isolated in a steel coreholder fluids were injected at a constant rate of 0 07 ml min equivalent to 1 1 ft day in this rock from the bottom and collected at the top and pressures were measured along the core in four sections the experiments consisted of viscous glycerol solution displacing oil and large or low viscosity irreducible aqueous phase the rock was 2300 md and had a porosity of 0 27 table 2 experiments were conducted at room temperature and pressure for the first experiment low viscosity irreducible water consisted of 10 wt nacl in di while injected aqueous phase was 83 wt glycerol solution with 0 1 wt nacl in deionized di water for the second experiment the large viscosity irreducible water consisted of 83 wt glycerol solution with 0 1 wt nacl while the injectant was 74 wt glycerol solution with 9 5 wt nacl the salinities were selected such that injectant viscosities were similar for the two experiments table 3 the viscosity of the injectant and residual aqueous solution in the second experiment were similar 68 cp and 69 cp and the composition of the outflow could be measured by refractometry to measure the concentration of injected and resident water at the outlet takamura et al 2012 3 results and discussion 3 1 displacements in micromodels we performed experiments in a 6 cm long 1 cm wide micromodel with a 2d array of hollow squares containing irreducible water inside the repeating structures fig 1a the irreducible water saturation for this micromodel was 47 fluids entered the chip in the following sequence 1 aqueous phase 1 cp or 100 cp displacing air 2 12 cp crude oil displacing aqueous phase 3 viscous glycerol 100 cp displacing the oil and irreducible aqueous phase fig 2a shows the displacement for the case where the aqueous phase was water 1 cp the displacement became unstable after the front traversed about 0 5 cm and the aqueous phase broke through at 0 22 pvi at the time of breakthrough two large fingers are visible in the displacement with the low viscosity irreducible water fig 2a however the displacement with the large viscosity irreducible glycerol solution is stable at 0 22 pvi fig 2b experiments presented in fig 2 were conducted at 10 µl hr corresponding to injection velocity 1 9 10 5 m s and images were captured at 1 img min the light blue represents aqueous phase that mobilized oil and the black represents non mobilized phase oil or aqueous phase and the solid phase after observing fingering in an ordered geometry with a large amount of irreducible water saturation 47 we conducted displacements in a serpentine porous micromodel with a flow length of 40 cm and a cross sectional length of 0 6 cm a core on a chip where the locations and volumes of irreducible aqueous phase ganglia were not controlled microscopic images captured before glycerol injection showed this chip had 9 irreducible water saturation a long flow domain was selected because previous studies by our group showed fingering due to irreducible water was not observable in short 1 2 cm micromodels mejia et al 2020 we introduced a heterogeneous pore scale geometry in the core on a chip micromodel by convolving random points with a gaussian kernel the design includes shallow pore throats as introduced by xu et al 2017 the method involves positioning during lithography disconnected adjacent pores a distance away from each other such that upon isotropic wet etching the pores connect the connection between the adjacent pores the pore throat is wedge like and is shallower than the etching depth at the middle of each pore body shallow pore throats also known as 2 5d throats introduce sharp capillary pressure barriers between grains promoting non wetting phase snap off and resulting in disperse non wetting phase ganglia distributions additionally shallow throats provide a larger degree of continuity of the solid phase compared to traditional 2d micromodels these characteristics make 2 5d micromodels more similar to real rocks than traditional 2d micromodels xu et al 2017 details on the design of this long micromodel may be found in mejia et al 2020 displacements in the long micromodel were conducted at an injection rate of 5 µl hr corresponding to an injection velocity of 1 3 10 5 m s 3 7 ft day images of the displacements are presented at 0 35 pvi in fig 3 where a shows the displacement of oil with 1 cp irreducible water by 100 cp glycerol solution and b shows the displacement of oil with 100 cp irreducible glycerol solution by 100 cp glycerol solution the blue represents aqueous phase that has displaced oleic phase and the black is the solid phase and un mobilized fluids the outline of the domain is colored in white and the inlet is the solid white arrow when the viscosity of the irreducible water was low 1 cp the displacement became unstable after about 5 cm when the viscosity of the irreducible aqueous phase was large the displacement was stable the image in fig 3a shows aqueous phase light blue reaching the outlet for the low viscosity irreducible water case at 0 35 pvi the aqueous phase looks dispersed as the fingers have lost most of their structure in this frame but the tip of the finger that first breaks through is discernible at the same dimensionless time the flood front in the case with high viscosity irreducible water shown in fig 3b remains stable and the aqueous phase light blue is about halfway to the outlet phase saturations over dimensionless time pvi in the micromodel are presented in fig 4 the experiments solid lines are shown along with a fractional flow interpretation dotted lines the models were fitted by minimizing the sum of squared errors of the difference between the oil saturation in the experiments and the models fitted fractional flow solutions and their parameters are provided in the supplementary information using a single set of relative permeability curves was unfeasible as this approach only described one of the displacements adequately therefore we increased the residual oil saturation for the low viscosity irreducible water displacement from 0 1 to 0 2 and increased the oil exponent from 1 2 to 2 obtaining the fit shown in fig 4 other than the increase in s or and increase in the oil exponent and a small change in s wr from 0 11 to 0 09 to fit the y intercept the parameters for the relative permeability curves are the same for the two displacements it is notable the fractional flow solution black arrow with bt ff for the low viscosity irreducible water largely overestimates breakthrough time compared to the observed experimental breakthrough time black arrow with bt exp the fractional flow solution adequately describes the large viscosity irreducible water displacement additionally comparison of the two experiments indicates aqueous phase in the low viscosity irreducible water displacement reached the outlet in half the time as the displacement with high viscosity irreducible water about 0 35 pvi vs 0 75 pvi the displacement with low viscosity irreducible water broke through earlier because the low viscosity front 1 cp fingered and later dispersed rapidly through the oil 12 cp the displacement with large viscosity irreducible glycerol solution remained stable throughout breakthrough time in the low viscosity irreducible water case was determined by visual inspection of the displacement and corresponds to fig 3a moreover the oil saturation difference at the end of this displacement is about 9 for the two investigated cases while irreducible water arrived rapidly when its viscosity was small ultimate recovery varies modestly for the two cases displacements in the core on a chip indicate low viscosity irreducible water seems to greatly affect the shape of the front and time of aqueous phase breakthrough in micromodels the effect of irreducible water viscosity on the displacement front is evident from fig 3 at 0 35 pvi the displacement with low viscosity irreducible water has a very disperse aqueous phase front where droplets of blue are scattered from about 1 3 of the flow length to the outlet the displacement with high viscosity irreducible water on the other hand shows a sharp piston like front the shape of the downstream front depends on the mobility of the fluids at that front the micromodel experiments suggest 1cp irreducible water is collected at the front of the injected glycerol solution 100 cp forming a low viscosity bank that then fingers through the 12 cp oil lattice boltzmann simulations presented in section 3 2 explore this proposed mechanism in more detail moreover residual oil saturation s or is about 10 larger in the micromodel experiment with low viscosity irreducible water than in the experiment with high viscosity irreducible water as shown in fig 4 at 1 pvi the difference in sor may be due to the difference in phase distributions for the two cases juárez morejón et al 2018 the second half of the flow domain in the low viscosity irreducible water case fig 3a shows dispersed water ganglia as fingers have lost their structure fingers lose their structure as shown in fig 5 because the irreducible water content is small 10 and the width length w l ratio is small 0 6 cm 40 cm the irreducible water that initially forms fingers later disperses as the small irreducible water saturation is not sufficient to maintain and propagate finger structures the small w l ratio also constrains finger propagation in the direction perpendicular to injection and allows for the breaking of the structures this is in contrast with the case shown in fig 2a where the irreducible water saturation is 47 and the w l is larger 1 cm 6 cm 3 2 lattice boltzmann simulations if the local viscosity in the downstream front low viscosity swirr mobilizing medium viscosity oil becomes unfavorable due to the accumulation of irreducible water then the downstream front should become unstable as fingers of low viscosity irreducible water form and grow through the medium viscosity oil we conducted lattice boltzmann simulations at injection velocities of 10 5 m s in small domains with hollow grains fig 6 to analyze the microfluidic experiments specifically we wanted to evaluate more clearly the configuration of the aqueous solutions to determine if low viscosity irreducible water collected at the front of the high viscosity aqueous injectant the simulations show formation of viscous instabilities at the aqueous oleic interface when the irreducible water light blue was less viscous than the oil green in fig 6a but not when the irreducible aqueous phase was more viscous dark blue than the oil fig 6b fig 6 shows the simulations at 0 36 pvi with a low viscosity irreducible water and b high viscosity irreducible aqueous phase the displacement in fig 6a has three distinct fingers with the middle one slightly longer than the other two the instabilities were present at the front of the mixing zone but not at the rear of the mixing zone furthermore the fingers have a large concentration of irreducible water white light blue this explains why fingers in the microfluidic experiments fig 2a propagated faster than the mixing zone behind them as fingers form they contact and mobilize irreducible water maintaining a local unfavorable viscosity ratio as aqueous phase from the fingers intermixes with low viscosity water from the hollow grains the fingers viscosity is reduced to almost that of the irreducible water 1 cp white light blue and fingers continue to propagate through the 10 cp oil green we also performed lb simulations in a rock like 2d domain the pore space was generated by convolving a set of random points with a gaussian kernel the simulations consisted of 1 saturating the domain with irreducible water or viscous aqueous phase 2 displacing the water with oil and 3 displacing the oil with viscous aqueous phase results of displacements with low viscosity residual aqueous phase at the beginning of step 3 are shown in fig 7 for a low viscosity irreducible water and b high viscosity irreducible water at 0 46 pvi at this dimensionless time the low viscosity irreducible water breaks through but the high viscosity irreducible water has not yet reached the outlet fig 7a shows most of the irreducible water moves at the front of the displacement and a mixing zone exists between the mobilized irreducible water and the aqueous injectant fingering was not evident in either of the cases we attribute this to the small size of the simulated domain as previous preliminary experiments by our group suggest small rock like porous media may not have sufficient flow length to allow for the formation of banks and other larger scale aggregations thus was the motivation to conduct the experiment in the core on a chip micromodel mejia et al 2020 additionally simulations in a long domain were computationally unfeasible requiring several months for completion so we conducted simulations in a small domain to identify mechanisms that explained experimental observations visualizations of the displacements at 1 25 pvi are presented in fig 8 image a shows the phase distributions for the low viscosity irreducible water case and b shows the distributions for large viscosity irreducible water case in both the oil green is well dispersed the residual oil saturation is not significantly different however image a shows some irreducible water white light blue is present at isolated locations this water became inaccessible to the injected water because of phase entrapment residual oil clusters blocked the throats of pores where residual water was present preventing it from contacting injected aqueous phase plots of fluid content in the porous medium over time fig 9 a show the ultimate oil recovery is similar for the two cases additionally breakthrough occurred earlier in the displacement with low viscosity irreducible water by monitoring the glycerol concentration over time for the low viscosity irreducible water case fig 9b we found initially produced aqueous phase blue curve consisted at least partly of irreducible water the trend that mobilized irreducible water tends to the front of the aqueous oleic front holds for this simulation the initial spikes on the water cut curve ratio of rate of water at outlet and total effluent rate occur while glycerol concentration in the domain was around 0 5 figure 9b shows irreducible water was mobilized but neither fig 8 nor fig 9 provide evidence of fingering this is likely due to the small size of the simulated domain 3 3 implications to real rocks and large scale media we conducted coreflood experiments to determine if fingering due to irreducible water occurred in 3d natural porous media pressure versus time data of the coreflood experiments are presented in fig 10 pressures were measured along four sections of the core and across the whole core pressure response of the low viscosity irreducible water experiment deviates from shock like when the pressure front reaches the fourth section fig 10a aqueous phase breaks through at 0 28 pv earlier than the experiment with large viscosity irreducible water after breakthrough the whole core pressure drop looks nearly linear up until 0 35 pv while we cannot ascertain there was fingering in this experiment due to lack of visual evidence we confirmed the irreducible water moves ahead of the injected aqueous phase the experiment with large viscosity irreducible aqueous phase fig 10b had the pressure response of a piston like displacement pressure increased nearly linearly across the core and across each section as the shock like front traversed it until the shock front reached the outlet at breakthrough 0 34 pv measurements of collected fluids at the outlet show the low viscosity irreducible water appears to smear the shock like displacement fig 11 a the oil cut at the outlet solid line is more step like for the large viscosity irreducible water saturation case red than for the low viscosity irreducible water saturation case black and from the solid curves it is straightforward to observe injectant in the low viscosity irreducible water saturation coreflood broke through earlier oil saturation dashed lines is similar for the two displacements with the low viscosity irreducible water case having a larger residual oil saturation 31 vs 34 refractometry measurements of injected aqueous phase concentration at the outlet dotted curves indicate a more shock like arrival for the residual aqueous phase in the case with large viscosity irreducible aqueous phase red and a more disperse and earlier arrival for the residual aqueous phase in case with low viscosity irreducible water black presentation of the recovery data in the form of cumulative oil recovery versus time fig 11b shows how the coreflood experiments may be interpreted as a two front problem the dotted vertical lines in fig 11b represent the first arrival of aqueous phase for each displacement these are indicators of the arrival times for the downstream front irreducible water oil the black dotted line marks the arrival of low viscosity irreducible water and the red dotted line marks the arrival of high viscosity irreducible water clearly the low viscosity irreducible water arrives more rapidly than the large viscosity irreducible water additionally there is change in slope in the oil recovery solid black curve after the irreducible water breaks through the dashed lines mark the arrival of aqueous phase with 90 injected water these dashed lines are indicators of the arrival of the upstream front where high viscosity glycerol solution displaces oil and resident water the downstream front appears to move at approximately the same velocity for both the cases smaller final recovery in the low viscosity irreducible water coreflood is likely the result of by passing by the unstable front as the same core was utilized for both displacements and the initial fluid saturations were similar for both experiments difference in arrival time for low and high viscosity irreducible water was significantly larger in micromodels than in corefloods 0 3 pvi versus 0 04 pvi respectively there are several reasons for the large difference in arrival times of low viscosity water in corefloods versus micromodels the capillary pressure gradients which are much more pronounced in cores than micromodels stabilize fingering daripa paşa 2008 moreover the w l ratio is larger in corefloods this may prevent fingers from collapsing after growing a small distance preventing a rapid dispersion of the low viscosity irreducible water in the oil finally there may be overestimated dispersive mixing in 2d versus 3d afshari et al 2020 as injected aqueous phase likely mixes more readily with irreducible water in lower dimensional space 4 conclusions apparently stable two phase displacements in micromodels at very favorable viscosity ratios became unstable due to the presence of low viscosity residual aqueous phase in micromodels lattice boltzmann simulations showed fingers were mostly composed of low viscosity irreducible water comparison of results in the three investigated systems micromodels simulations and corefloods indicates fingering due to low viscosity irreducible water is enhanced by large residual water saturations as propagating fingers at the downstream front encounter pockets of irreducible water more readily fingers mix with the contacted irreducible water which allows them to maintain a low viscosity compared to the oil and grow the observed fingering is hindered by low w l ratios that promote phase dispersion rather than finger propagation by large capillary pressure gradients daripa paşa 2008 and a smaller degree of pore scale mixing in 3d vs 2d afshari et al 2020 residual oil can trap residual water this phase interference reduces contact areas between the injectant and irreducible water limiting the mobilization of residual water experiments in micromodels and corefloods indicate the emergence of instabilities modestly affects ultimate oil recovery and time of recovery even though breakthrough occurred significantly earlier in micromodels with low viscosity irreducible water ultimate oil recovery was similar for cases with low and high viscosity residual water saturation with a modest reduction in s or for cases with high viscosity residual water saturation in corefloods the effect of low viscosity irreducible water for secondary viscous waterflooding appears to be a smearing effect similar to capillary pressure when low viscosity irreducible water is present the effluent between the arrival of the first front and the second front has aqueous and oleic phases with a decreasing water cut on the other hand the effluent for the case with high viscosity irreducible water consisted only of aqueous phase after the arrival of the first front low viscosity irreducible water arrived slightly faster than high viscosity irreducible water the case with low viscosity irreducible water produced an earlier pressure distortion in the fourth section of the core than the case with large viscosity irreducible water acknowledgements the authors thank the kfupm university of texas at austin chemical eor global partnership project cpg 17 01 and the chemical enhanced oil recovery joint industry project for partial funding of this work we would also like to acknowledge the texas materials institute tmi at ut austin for providing the cleanroom and microfabrication equipment and the texas advanced computing center tacc for providing the computational resources for conducting the lb simulations supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2021 103943 appendix supplementary materials image application 1 
