index,text
95,the influence of soil surface gradient on rainfall infiltration and related surface runoff generation are not well understood for representation in hydrologic modeling because of conflicting theoretical formulations and experimental results available in the scientific literature the main objective of this study is to integrate and extend previous laboratory experiments using artificial rainfall over a laboratory setup with adjustable slope angle α and consisting of two adjacent natural bare soils that according to the usda soil classification were of loam soil 1 and sandy loam soil 2 type respectively soil 2 placed downstream was subjected to the run on process due to the overland flow produced over soil 1 the slope effects are discussed on the basis of measurements of runoff surface qs and deep flow qd both strictly linked to the infiltration rate supported by a simplified rainfall runoff model our results indicate that at a time close to the end of rainfall period tre 8 h for α increasing from 1 to 10 qd decreased by about 25 while qs exhibited a corresponding increase in magnitude in the same slope range at t tre the total volume of water collected as deep flow decreased by about 40 for heavy rainfall and up to about 50 for light rainfall on the other hand a growth of the total surface water volume occurred such that the total outflow volume was nearly independent of α the run on effect is seen to modulate the differences in steady deep flows for different slopes the above variations became of minor interest between 10 and 15 the significant differences in the variations of surface and deep flow to changes of slope angle were analyzed and placed in context with those from earlier experiments the differences are attributed to a different level of interaction between capillary and gravitational effects that should be represented in existing infiltration models because appreciable values of α characterize most watershed areas and the decrease of infiltration with increasing α over bare soils can imply a greater contribution to the direct runoff and a significant reduction of the groundwater recharge with respect to a flat surface keywords hillslope infiltration infiltration modeling rainfall runoff run on process slope effect laboratory experiments data availability data will be made available on request 1 introduction partitioning of rainfall into surface runoff and subsurface flow components is needed to understand many events of hydrologic interest such as floods droughts and recharge of aquifers this partition relies upon a rigorous representation of infiltration the focus here is on the horton mechanism that is very common in upslope areas and implies a wetting front moving downward with surface runoff production at a point when the rainfall rate exceeds the soil infiltration rate simulation modeling of infiltration has been widely developed at the local scale and more recently used as a support to obtain a process representation at the field scale that is more suitable for an extension to larger spatial scales corradini et al 2017 it is widely recognized that infiltration at the local scale is strictly linked with rainfall rate r antecedent soil water content θi and soil hydraulic properties such as the saturated hydraulic conductivity ks and the saturated soil water content θs many local or point infiltration models were developed for isolated storms with regular rainfall rate producing immediate ponding over vertically homogeneous soils among them the model proposed by green ampt 1911 and later extended for delayed ponding by mein and larson 1973 and the model formulated by philip 1957a 1957b 1957c then extended to represent pre ponding and post ponding infiltration reeves and miller 1975 chow et al 1988 have been widely used a more general model applicable also to rainfall patterns determining successive infiltration redistribution cycles was later developed by corradini et al 1997 furthermore considering that many natural soils are not vertically homogeneous local infiltration models for layered soils were also proposed corradini et al 2000 formulated a semi analytical conceptual model for a two layered soil under any rainfall pattern under restrictive conditions of a more permeable upper layer corradini et al 2011a 2011b developed two simpler models for typical rainfall patterns areal average infiltration models were generally obtained by upscaling point infiltration models to the field scale assuming vertically homogeneous soils and considering ks russo and bresler 1981 1982 as a random variable with a lognormal univariate probability density function smith and goodrich 2000 and govindaraju et al 2001 presented a simple semi empirical conceptual model and a semi analytical model respectively for field scale infiltration for vertically homogeneous soils models involving a joint spatial variability of ks and r wood et al 1986 castelli 1996 govindaraju et al 2006 and models describing the effects of the spatial variability of θi bronstert and bardossy 1999 smith and goodrich 2000 morbidellli et al 2012 hu et al 2015 were also developed a model for two layered soils was later formulated by corradini et al 2011b under the condition of ks randomly variable at the surface of an upper layer much more permeable all the aforementioned models rely upon the assumption of infiltration into soils with horizontal surface or negligible slope however in natural situations the process is generally associated with rainfall over surfaces characterized by appreciable gradients this to some extent can require an adjustment of the models commonly used for infiltration and surface runoff generation this statement is supported by theoretical and experimental studies that have highlighted two processes determined by the presence of sloping surfaces first overland flow moves downslope over areas that receive water available for infiltration from upstream areas run on process in addition to rainfall the spatial heterogeneity of hydraulic soil properties can produce significant run on effects in some cases the run on role on the production of hortonian runoff was mainly investigated by numerical simulations smith and hebbert 1979 freeze 1980 woolhiser et al 1996 corradini et al 1998 nahar et al 2004 while morbidelli et al 2008 provided laboratory experimental evidence of this process independently of the run on process a second process could affect infiltration and surface runoff on sloping soils in this context theoretical studies philip 1991 chen and young 2006 wang et al 2018 and field laboratory experiments nassif and wilson 1975 sharma et al 1983 poesen 1984 fox et al 1997 assouline and ben hur 2006 essig et al 2009 morbidelli et al 2015 mu et al 2015 khan et al 2016 morbidelli et al 2016 were realized without achieving conclusive results morbidelli et al 2018 poesen 1984 observed through laboratory trials that for light rainfall rates infiltration was unaffected by changes of the slope angle α while for heavy rainfall it increased in steeper slopes chen and young 2006 using a modified green ampt approach obtained an increase of infiltration with increasing α that became negligible for α 10 on the other hand philip 1991 on the basis of a theoretical study nassif and wilson 1975 and sharma et al 1983 from field experiments and fox et al 1997 mu et al 2015 and khan et al 2016 from laboratory trials deduced a decrease of infiltration with increasing α essig et al 2009 and morbidelli et al 2015 carried out laboratory experiments in bare soils and noted that at the end of prolonged rainfall for α 1 saturation was achieved at all depths while for larger α values a maximum soil moisture content θ θ s invariant with depth was noted under steady state conditions surface runoff was observed even for r ks and infiltration was found to decrease with increasing α with variations in magnitude much larger than those resulting from previous investigations later morbidelli et al 2016 performed similar experiments but using a grassy soil to examine the role of soil roughness in the relationship between infiltration and α they showed that the variation of infiltration with α was substantially reduced in comparison with that observed for bare soils overall the last three papers indicated that the effect of α on the gravitational component of infiltration in the presence of high and moderate rainfalls was due to a mechanism linked with the soil surface roughness on the basis of the above mentioned studies the assessment of the role of α on infiltration and surface runoff generation still represents an unresolved problem a quantification of this effect in general terms appears to be obstructed by an incomplete understanding of the governing physics in particular the sensitivity of infiltration in the presence of capillary and gravitational components to variation of gradient should be assessed on the other hand a few studies were focused only on the gravitational component essig et al 2009 morbidelli et al 2015 2016 while other works did not examine these components poesen et al 1984 fox et al 1997 mu et al 2015 khan et al 2016 therefore the last investigations could have been differently affected through the shape of the soil moisture vertical profile by the two infiltration components the main objective of this paper is to address the above issue through laboratory trials performed to obtain at different gradients surface and deep flow produced by quantifiable capillary and gravitational effects in the presence of run on in this context an experimental system with two adjacent homogeneous soils subjected to a uniform rainfall and characterized by different permeabilities was designed to generate the run on process that is really present in natural conditions particularly through the random variability of the soil saturated hydraulic conductivity a rainfall runoff approach based on a reliable point infiltration model corradini et al 1997 2017 has been selected for simulating the experimental data observed for α 1 as a support to interpret the results obtained for significant gradients up to 15 finally the insights of this work are also used to provide an overall integrated interpretation of the outcomes achieved by previously carried out laboratory experiments 2 laboratory experimental system the experiments were performed through a physical model schematized in fig 1 including two adjacent soils of different type soil 1 and soil 2 each soil filled half of a box volume with dimensions of 152 cm length 122 cm width and 78 cm depth soil 1 and soil 2 with thickness of 67 cm were obtained starting from a natural soil with particles first divided into different diameter classes then recombined and carefully packed to obtain vertical homogeneity perfect contact at the interface and negligible flow along the box sides each soil separated by a completely pervious geotextile mesh was placed on a 7 cm deep gravel layer to speed the drainage process the slope angle of the box was adjustable between 1 and 15 in the experiments artificial rainfalls with almost uniform spatial distribution and intensities selected by an appropriate choice of both sprinklers and pressure of water supplied by a pump were generated the relation between rainfall rate and water pressure had been earlier determined by a grid of pans placed on a metal sheet in this context for each selected water pressure slight variations of the associated rainfall rate were found thereby the experiments carried out by the physical model with a selected water pressure could involve small errors in the rainfall rate value 0 5 mmh 1 in the range of rainfall rate investigated surface runoff was collected by a triangular metal funnel screened from rainfall that conveys water to a tipping bucket sensor the collector was placed at the surface lower boundary of soil 2 see the green thick line in fig 1 deep flow was measured by a similar system placed at the bottom of the downstream end of soil 2 see the blue thick line in fig 1 surface runoff and deep flow data were recorded at successive time intervals of 7 min and 21 min respectively the soil moisture content of each soil was continuously monitored by six capacitive sensors drill drop probe sentek technologies placed at different depths 5 15 25 35 45 55 cm many experiments were realized for α 1 5 10 and 15 for each α five trials with r constant in the range 12 34 mmh 1 and a duration of 8 h were performed the sets of experiments associated with different values of α involved quite similar r values obtained by maintaining a known pressure surface runoff and deep flow were observed up to 24 h after the beginning of rainfall and are considered well representative of the soil water interaction this assumption is supported by a previous investigation carried out by essig et al 2009 who found that the downstream boundary of the box did not produce significant distortions in the partitioning of a rainfall into overland and deep flow in the experiments θi of each soil was fairly smaller than θs finally according to the usda soil classification soil 1 and soil 2 were of loam and sandy loam textural classes respectively with significant differences in hydraulic properties as shown in table 1 the quantities ψb λ and c were selected on the basis of the available grain size distributions the other quantities ks θs and θr were determined in advance by experiments on a box filled only by soil 1 or soil 2 the residual soil water content was obtained by capacitive sensor under dry conditions while ks was achieved from measurements of deep flow performed with α 1 under steady conditions when θs was detected 3 experimental results for each slope the minimum r was larger than ks of both soil 1 and soil 2 the same rainfall sequence was adopted for each α to achieve outcomes from experiments with comparable θi values that were checked by the available capacitive sensors see table 2 surface saturation was reached in all the experiments the soil stability was assured by the absence of landslide sites for α up to 15 the outflows associated with each trial are summarized in table 2 where time tre denotes the end of rainfall and the sensitivity of the total surface and deep water volumes to α and r can be deduced the values of surface runoff qs tre and deep flow qd tre refer to the measurements at the time t tre the lack of data on surface and deep flow for α 5 with r 12 mmh 1 and α 10 with r 21 mmh 1 was due to a failure of the recording system associated with the two tipping bucket sensors at time t tre each experiment was characterized by surface runoff and deep flow values associated with quasi steady conditions and the total outflow qs tre qd tre was approximately equal to the rainfall rate see also next section therefore the trend of qs tre as a function of r is complementary to that of qd tre fig 2 shows qd α tre for a few representative rainfall rates some values of deep flow have been computed through interpolation of observed data because as specified in section 2 it was not possible to generate the same experimental values of r for different gradients as can be seen in fig 2 deep flow has an appreciable decrease with values lowered of about 25 with increasing α in the range 1 10 in addition because the qd α tre curves have a similar shape for different rainfalls the rainfall rate does not produce a distortion in this relation at least for r ks of both soil 1 and soil 2 a synthesis of the results for surface and deep water volumes is also presented in fig 3 the trend of the total deep water volume at t tre with increasing α fig 3a is somewhat similar to that observed for qd α tre but with a more pronounced decrease with increasing α between 1 and 10 it decreases by about 40 for r 34 mmh 1 and up to 50 for light rainfall the variation with α of the total surface water volume at the same time fig 3b indicates a growth up to 10 such that the total outflow volume is nearly independent of α an expected common feature of qd α tre and outflow volumes is represented by their larger values with increasing r the variations of the deep flow and total deep volume became of minor interest between 10 and 15 the shape of the outflow hydrographs for different gradients is shown in figs 4 and 5 each referring to a sample event with low and heavy rainfall rate respectively fig 4 highlights that for the lower rainfall rate of about 12 5 mmh 1 and α 1 the surface and deep flow hydrographs exhibit shapes substantially different from those associated with α 10 and 15 which are rather similar the time required to reach quasi steady conditions for deep flow is about 4 h for α 1 while it increases to about 7 h for α 10 and 15 for the surface runoff with α 10 and 15 this time is of about 1 h while with α 1 this time is of about 6 h a common feature of the three outflow hydrographs is that a significant growth in deep flow occurs about two hours later than that of the surface runoff furthermore the surface runoff for α 10 and 15 starts to grow very quickly just after the beginning of the rainfall fig 5 shows that for the heavy rainfall rate of about 33 5 mmh 1 the differences in the shape of the hydrographs for α 1 compared with those for α 5 10 and 15 are less pronounced however quasi steady conditions for the deep flow are reached earlier specifically after approximately 2 h for α 1 and 4 h for the other gradients for overland flow these times are much smaller with a maximum of about 2 h for α 1 a significant increase of deep flow for α 1 is observed after about 1 h and for the larger slopes as with the lower r value after 2 h 4 analysis of results the structure of the soil moisture vertical profile can be investigated through the continuity equation expressed at a time t as 1 r q s q d d v d t where v is the water volume per unit surface area throughout the soil depth focusing our analysis on the outflow hydrographs see figs 4 and 5 for a few sample experiments for t near the end of the rainfall event the outcomes for each value of both r and α indicate approximately steady values of qs and qd which give from eq 1 dv dt close to zero however the aforementioned uncertainty in the estimate of r does not allow one to conclude if fully steady conditions with θ invariant with depth occurred in each soil this issue can be enlightened by examining the trend of qd tre as a function of r for each α fig 2 highlights a growth of qd tre with increasing r in the range 12 5 33 5 mmh 1 thus at least for r up to 33 5 mmh 1 the soil water content had not reached at any depth in both soils a maximum value that is expressed by θ θ s for α 1 and the θ vertical profile was not steady this interpretation is also supported by the θ vertical profile observed by the capacitive sensors in principle the observed surface runoff hydrographs were influenced by rainfall rate and run on process specifically overland flow generation was expected to start earlier on soil 1 with lower permeability subsequently soil 2 as a result of the joint effect of rainfall over its surface and surface water received from soil 1 produced a discharge at the downstream boundary surface runoff was observed after time to ponding of soil 2 regardless of the spatial variability of hydraulic properties of each soil ponding occurred gradually on soil 2 because of the run on process in any case surface runoff observed at the outlet implied maximum values of θ at the soil 1 and soil 2 surface 4 1 interpretation by an infiltration modeling a more in depth interpretation of the observed hydrographs can be made using a simplified simulation modeling applied to experiments carried out for α 1 that is for the α value closer to the horizontal surface for which widely recognized infiltration approaches are available as a first approximation the subsurface water flow between soil 1 and soil 2 has been assumed to be negligible even though capillary and gravitational components parallel to the soil surface exist with a minor role of the gravitational component because of the nearly horizontal box position on this basis a rainfall runoff approach with a one dimensional local model for vertical infiltration on a horizontal surface has been selected corradini et al 1997 2017 this model requires the solution of an ordinary differential equation developed on the basis of a combination of the darcy s law and continuity equation together with an assumption on the shape of the soil moisture vertical profile it was positively tested under very general conditions using the richards equation as a benchmark minor discrepancies were obtained corradini et al 1997 particularly for conditions of steady rainfall rates over homogeneous soils as those characterizing our experiments the choice of the local infiltration model is supported by the homogeneity of each study soil the rainfall runoff approach provides the time evolution of surface runoff and deep flow for both soil 1 and soil 2 as well as the time evolution of the θ vertical profile in each soil neglecting the travel time required for the transfer of water to the outlet of soil 2 it has been applied using the conditions without run on and with run on in the first case the overland and deep flows generated over each soil have been assumed to be independent while in the second case with run on the surface runoff produced over soil 1 has been added to the rainfall falling directly from the sprinklers on soil 2 the two schematizations allow to deduce the role of run on in the rainfall runoff transformation and provide support to investigate the possible existence of other mechanisms influencing slope effects on the partitioning of rainfall into surface and subsurface flow the results derived by model simulations starting from θ i 0 36 for soil 1 and θ i 0 26 for soil 2 are analyzed through two representative cases referred to the extreme rainfalls used in the experiments the input quantities required by the infiltration model for soil 1 and soil 2 are given in table 1 for r 12 5 mmh 1 fig 6 a shows that soil 1 reaches surface saturation about 1 5 h after the beginning of rainfall and this condition persists until the rainfall end when the infiltration rate has a value 6 mmh 1 larger than ks 4 mmh 1 implying an unsteady θ vertical profile for t tre furthermore fig 6b shows that considering separately soil 2 it reaches surface saturation after about 7 h and for t tre the infiltration rate about 12 mmh 1 is larger than ks 10 mmh 1 on the other hand incorporating the run on process surface saturation occurs fig 6c much earlier t 2 h for soil 2 even though for t tre the steady condition for the θ vertical profile has not been reached and the infiltration rate is still larger than ks the role of the run on on the deep flow hydrograph can be deduced from fig 6d by referring to simulations carried out disregarding and including this process the deep flow values represent the discharge per unit draining surface as can be seen at the downstream side of soil 2 the run on process for t tre determines a quasi steady trend that is rather close to the experimental one for r 34 mmh 1 θ at the surface of soil 1 is equal to θ s for t 0 1 h with the infiltration rate less than r fig 7 a until t tre when its value larger than ks indicates an unsteady θ profile soil 2 considered separately is characterized by surface saturation after about 0 3 h fig 7b using this heavy rainfall with r ks for t tre soil 2 with run on gives an unsteady θ vertical profile fig 7c and a quasi steady trend of the deep flow with a magnitude that is the same computed neglecting the run on fig 7d an overall analysis of the model outcomes for α 1 indicates that the main trend of the deep flow hydrographs simulated including run on is fairly similar to that of the corresponding observed hydrographs both with slight and heavy rainfall the model results of unsteady vertical profiles of θ throughout the duration of rainfall indicate that both capillary and gravitational effects are involved and that run on plays a major role for slight rainfall the insights derived from the simulations for a nearly horizontal soil surface provide useful support in the analysis of the experimental results achieved for larger gradients for which a reliable infiltration modeling applicable under real conditions is not available in particular the one derived from the combination of the observed trend of qd tre for different r with the computed infiltration for α 1 at t tre indicates the existence of unsteady θ vertical profiles this deduction is supported by the observed data indicating that for α 5 10 and 15 the total volumes of deep water and surface water at t tre were smaller and larger respectively than the corresponding quantities observed for α 1 fig 3 with a similar trend for the deep flow and surface runoff at t tre 4 2 overall integrated interpretation of the available laboratory experimental studies on the basis of the above outcomes an overall analysis of our results and of the ones obtained in laboratory experiments enables us to identify a few processes that contribute to the determination of the slope effects on infiltration and hortonian surface runoff generation morbidelli et al 2008 carried out trials over two adjacent soils as in our experiments loam and sandy loam but with the downstream soil soil 2 not directly subjected to rainfall in order to give evidence of the run on process due to soil 1 at different slope angles over soil 1 the rainfall rates r 10 and 15 mmh 1 invariant with time and with a duration of 6 h were used the outcomes of their study that we have analyzed in the context of this work indicate that in the absence of run on over soil 2 the reduction of the deep flow with α observed at the outlet of the system substantially determined by soil 1 was of about 40 from 1 to 10 in the presence of run on this variation became of minor interest and was linked with the observed increase of water content in soil 2 that consequently produced a significant growth of the deep flow in any case measurements performed by the time domain reflectometry method suggested that the two soils were not saturated at least in the deep layers thereby the gradient effects associated to soil 1 on the deep flow observed at the system outlet were substantially mitigated by run on through the evolution of the unsaturated θ profile a similar effect is therefore expected to influence the new experimental runs even though its magnitude is more limited as specified in section 3 because of the different deviation of the θ profile from the steady conditions due to the presence of rainfall over soil 2 essig et al 2009 and morbidelli et al 2015 differently from this work examined the role of α for a single soil in the presence of only gravitational effects steady θ profile morbidelli et al 2015 performed experiments using the box shown in fig 1 but filled with a homogeneous loam soil on the basis of an appropriated choice of θ i and rainfall patterns constant r in the range 4 12 mmh 1 with duration 6 h steady conditions for both surface runoff and deep flow as well as for the θ profile were observed at the end of rainfall under these conditions they showed the dependence of outflows on α and for each α they deduced a θ profile invariant with depth with θ θ s for α 1 and θ θ max α θ s for larger gradients the associated variations of the steady outflows were very large and the infiltration rate equal to the deep flow reduced by a factor of 4 with α increased from 1 to 10 under similar experimental conditions but using a sandy loam soil essig et al 2009 found lower effects of α on deep and surface flows an overall interpretation of the results derived by essig et al 2009 and morbidelli et al 2008 2015 together with the results obtained through the new experiments leads to deduce that the deep flow strongly decreases for α up to 10 under the condition that the soil water content vertical profile is invariant with depth in the case of unsteady soil water content vertical profile the aforementioned effect reduces in relation to the deviation from the stationarity infiltration of overland flow into a downstream soil with unsteady soil water content vertical profile lessens the role of slope associated to the upstream soil on the outflow at the system outlet the magnitude of the last aforementioned effect depends on the characteristics of the downstream soil water content vertical profile in terms of wetting degree in this context it is important to remark that in the new experiments with soil 2 subjected to rainfall and run on the slope effects for α up to 10 were in any case significant with a decrease of about 25 for qd α tre and up to 50 for the total deep water volume at the same time while in the previous experiments morbidelli et al 2008 performed in absence of rainfall over soil 2 the run on process produced a nearly completed balancing of the slope effects associated to soil 1 further insights on the trend of infiltration and surface runoff with increasing α can be derived from the assessment of the consistency of our results with those previously obtained from other laboratory experiments that in any case do not consider the run on process poesen et al 1984 using a 200 35 7 5 cm tray filled with fine sand and silt and with α in the range 2 15 realized trials with r equal to 20 7 mmh 1 and duration 1 5 h obtaining outcomes very different from the ones found in this work however as suggested by the authors the infiltration process was influenced by the presence of a thin soil crust and by the rill erosion both very variable with α thereby the results shown cannot be considered representative of the gradient effect fox et al 1997 carried out laboratory 100 40 10 cm trays filled by a sandy loam soil with slope angle in the range 1 5 21 5 and r in the range 38 2 56 3 mmh 1 with duration of 1 5 h interill areas with a surface crust were present and could have influenced the relation between infiltration rate and slope angle even though the sealing intensity did not change with α the wetting front did not reach the tray base and therefore the condition of a soil water content vertical profile invariant with depth was not observed the trend of their results that highlighted a significant decrease of infiltration rate with increasing α up to 11 5 substantially agrees with that deduced in this work see also morbidelli et al 2008 for the deep flow generated by soil 1 that does not involve a steady soil water content vertical profile while a more completed comparison cannot be made because of the different configuration of our experimental system mu et al 2015 performed experiments by a 200 50 60 cm box with slope angle up to 30 and different values of rainfall rate they selected a cultivated sandy loam soil and found a reduction of infiltration rate with increasing α this trend was similar to that deduced in this work for the deep flow produced by soil 1 with a bare soil even though it is expected that the presence of spring maize affected the size of the involved infiltration process khan et al 2016 using trays of 100 30 40 cm developed many trials in mulched and un mulched silty loam soils subjected to rainfalls rates in the range 33 120 mmh 1 and duration of 1 h that did not lead to reach soil steady conditions they found a decrease of the infiltration rate with slope angle in the range 5 25 their trend was quite similar to that associated to soil 1 characterized by unsaturated conditions the last three discussed works agree with our results on the trend of infiltration reducing with increasing the gradient furthermore the magnitude of the infiltration reduction is consistent with that observed in our experiments under unsaturated conditions nevertheless the presence of differences in the experimental system vegetation sealing rainfall pattern soil type and thickness does not allow to exclude distortions on the observed gradient effects 5 conclusion on the basis of the above discussion our results indicate that the sensitivity of deep flow and surface runoff to α varying between 1 and 10 is due to the different role of capillary and gravitational effects in homogeneous soils with steady soil water content vertical profile the very large reduction with increasing α is only due to gravitational effects the coupling of soil 1 and soil 2 with unsaturated conditions below the surfaces implies also the presence of capillary effects that become more significant increasing the deviation of the θ profile from steady conditions in this context our results point out that the presence of run on contributes to modify the role of slope angle with respect to that expected in homogeneous soils strength elements of this work are the observed relation between α and infiltration is not affected by other processes as formation of sealing layer and erosion that lead to its distortion a distinction is made between capillary and gravitational contributions which could be a useful support for their representation in conceptual modeling the modulation of slope effect on heterogeneous infiltrating surfaces in the presence of run on is shown even if through a fictitious experimental apparatus on the other hand it is not possible to provide direct evidence of this process in a soil characterized by large spatial variability of ks under natural conditions credit authorship contribution statement a flammini conceptualization methodology data curation investigation writing original draft writing review editing visualization j dari conceptualization methodology data curation investigation writing original draft writing review editing visualization c saltalippi conceptualization methodology data curation investigation writing original draft writing review editing r morbidelli conceptualization methodology data curation investigation writing original draft writing review editing c corradini conceptualization methodology data curation investigation writing original draft writing review editing supervision r s govindaraju conceptualization writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgment the authors would like to acknowledge dr marco stoppini for the technical support 
95,the influence of soil surface gradient on rainfall infiltration and related surface runoff generation are not well understood for representation in hydrologic modeling because of conflicting theoretical formulations and experimental results available in the scientific literature the main objective of this study is to integrate and extend previous laboratory experiments using artificial rainfall over a laboratory setup with adjustable slope angle α and consisting of two adjacent natural bare soils that according to the usda soil classification were of loam soil 1 and sandy loam soil 2 type respectively soil 2 placed downstream was subjected to the run on process due to the overland flow produced over soil 1 the slope effects are discussed on the basis of measurements of runoff surface qs and deep flow qd both strictly linked to the infiltration rate supported by a simplified rainfall runoff model our results indicate that at a time close to the end of rainfall period tre 8 h for α increasing from 1 to 10 qd decreased by about 25 while qs exhibited a corresponding increase in magnitude in the same slope range at t tre the total volume of water collected as deep flow decreased by about 40 for heavy rainfall and up to about 50 for light rainfall on the other hand a growth of the total surface water volume occurred such that the total outflow volume was nearly independent of α the run on effect is seen to modulate the differences in steady deep flows for different slopes the above variations became of minor interest between 10 and 15 the significant differences in the variations of surface and deep flow to changes of slope angle were analyzed and placed in context with those from earlier experiments the differences are attributed to a different level of interaction between capillary and gravitational effects that should be represented in existing infiltration models because appreciable values of α characterize most watershed areas and the decrease of infiltration with increasing α over bare soils can imply a greater contribution to the direct runoff and a significant reduction of the groundwater recharge with respect to a flat surface keywords hillslope infiltration infiltration modeling rainfall runoff run on process slope effect laboratory experiments data availability data will be made available on request 1 introduction partitioning of rainfall into surface runoff and subsurface flow components is needed to understand many events of hydrologic interest such as floods droughts and recharge of aquifers this partition relies upon a rigorous representation of infiltration the focus here is on the horton mechanism that is very common in upslope areas and implies a wetting front moving downward with surface runoff production at a point when the rainfall rate exceeds the soil infiltration rate simulation modeling of infiltration has been widely developed at the local scale and more recently used as a support to obtain a process representation at the field scale that is more suitable for an extension to larger spatial scales corradini et al 2017 it is widely recognized that infiltration at the local scale is strictly linked with rainfall rate r antecedent soil water content θi and soil hydraulic properties such as the saturated hydraulic conductivity ks and the saturated soil water content θs many local or point infiltration models were developed for isolated storms with regular rainfall rate producing immediate ponding over vertically homogeneous soils among them the model proposed by green ampt 1911 and later extended for delayed ponding by mein and larson 1973 and the model formulated by philip 1957a 1957b 1957c then extended to represent pre ponding and post ponding infiltration reeves and miller 1975 chow et al 1988 have been widely used a more general model applicable also to rainfall patterns determining successive infiltration redistribution cycles was later developed by corradini et al 1997 furthermore considering that many natural soils are not vertically homogeneous local infiltration models for layered soils were also proposed corradini et al 2000 formulated a semi analytical conceptual model for a two layered soil under any rainfall pattern under restrictive conditions of a more permeable upper layer corradini et al 2011a 2011b developed two simpler models for typical rainfall patterns areal average infiltration models were generally obtained by upscaling point infiltration models to the field scale assuming vertically homogeneous soils and considering ks russo and bresler 1981 1982 as a random variable with a lognormal univariate probability density function smith and goodrich 2000 and govindaraju et al 2001 presented a simple semi empirical conceptual model and a semi analytical model respectively for field scale infiltration for vertically homogeneous soils models involving a joint spatial variability of ks and r wood et al 1986 castelli 1996 govindaraju et al 2006 and models describing the effects of the spatial variability of θi bronstert and bardossy 1999 smith and goodrich 2000 morbidellli et al 2012 hu et al 2015 were also developed a model for two layered soils was later formulated by corradini et al 2011b under the condition of ks randomly variable at the surface of an upper layer much more permeable all the aforementioned models rely upon the assumption of infiltration into soils with horizontal surface or negligible slope however in natural situations the process is generally associated with rainfall over surfaces characterized by appreciable gradients this to some extent can require an adjustment of the models commonly used for infiltration and surface runoff generation this statement is supported by theoretical and experimental studies that have highlighted two processes determined by the presence of sloping surfaces first overland flow moves downslope over areas that receive water available for infiltration from upstream areas run on process in addition to rainfall the spatial heterogeneity of hydraulic soil properties can produce significant run on effects in some cases the run on role on the production of hortonian runoff was mainly investigated by numerical simulations smith and hebbert 1979 freeze 1980 woolhiser et al 1996 corradini et al 1998 nahar et al 2004 while morbidelli et al 2008 provided laboratory experimental evidence of this process independently of the run on process a second process could affect infiltration and surface runoff on sloping soils in this context theoretical studies philip 1991 chen and young 2006 wang et al 2018 and field laboratory experiments nassif and wilson 1975 sharma et al 1983 poesen 1984 fox et al 1997 assouline and ben hur 2006 essig et al 2009 morbidelli et al 2015 mu et al 2015 khan et al 2016 morbidelli et al 2016 were realized without achieving conclusive results morbidelli et al 2018 poesen 1984 observed through laboratory trials that for light rainfall rates infiltration was unaffected by changes of the slope angle α while for heavy rainfall it increased in steeper slopes chen and young 2006 using a modified green ampt approach obtained an increase of infiltration with increasing α that became negligible for α 10 on the other hand philip 1991 on the basis of a theoretical study nassif and wilson 1975 and sharma et al 1983 from field experiments and fox et al 1997 mu et al 2015 and khan et al 2016 from laboratory trials deduced a decrease of infiltration with increasing α essig et al 2009 and morbidelli et al 2015 carried out laboratory experiments in bare soils and noted that at the end of prolonged rainfall for α 1 saturation was achieved at all depths while for larger α values a maximum soil moisture content θ θ s invariant with depth was noted under steady state conditions surface runoff was observed even for r ks and infiltration was found to decrease with increasing α with variations in magnitude much larger than those resulting from previous investigations later morbidelli et al 2016 performed similar experiments but using a grassy soil to examine the role of soil roughness in the relationship between infiltration and α they showed that the variation of infiltration with α was substantially reduced in comparison with that observed for bare soils overall the last three papers indicated that the effect of α on the gravitational component of infiltration in the presence of high and moderate rainfalls was due to a mechanism linked with the soil surface roughness on the basis of the above mentioned studies the assessment of the role of α on infiltration and surface runoff generation still represents an unresolved problem a quantification of this effect in general terms appears to be obstructed by an incomplete understanding of the governing physics in particular the sensitivity of infiltration in the presence of capillary and gravitational components to variation of gradient should be assessed on the other hand a few studies were focused only on the gravitational component essig et al 2009 morbidelli et al 2015 2016 while other works did not examine these components poesen et al 1984 fox et al 1997 mu et al 2015 khan et al 2016 therefore the last investigations could have been differently affected through the shape of the soil moisture vertical profile by the two infiltration components the main objective of this paper is to address the above issue through laboratory trials performed to obtain at different gradients surface and deep flow produced by quantifiable capillary and gravitational effects in the presence of run on in this context an experimental system with two adjacent homogeneous soils subjected to a uniform rainfall and characterized by different permeabilities was designed to generate the run on process that is really present in natural conditions particularly through the random variability of the soil saturated hydraulic conductivity a rainfall runoff approach based on a reliable point infiltration model corradini et al 1997 2017 has been selected for simulating the experimental data observed for α 1 as a support to interpret the results obtained for significant gradients up to 15 finally the insights of this work are also used to provide an overall integrated interpretation of the outcomes achieved by previously carried out laboratory experiments 2 laboratory experimental system the experiments were performed through a physical model schematized in fig 1 including two adjacent soils of different type soil 1 and soil 2 each soil filled half of a box volume with dimensions of 152 cm length 122 cm width and 78 cm depth soil 1 and soil 2 with thickness of 67 cm were obtained starting from a natural soil with particles first divided into different diameter classes then recombined and carefully packed to obtain vertical homogeneity perfect contact at the interface and negligible flow along the box sides each soil separated by a completely pervious geotextile mesh was placed on a 7 cm deep gravel layer to speed the drainage process the slope angle of the box was adjustable between 1 and 15 in the experiments artificial rainfalls with almost uniform spatial distribution and intensities selected by an appropriate choice of both sprinklers and pressure of water supplied by a pump were generated the relation between rainfall rate and water pressure had been earlier determined by a grid of pans placed on a metal sheet in this context for each selected water pressure slight variations of the associated rainfall rate were found thereby the experiments carried out by the physical model with a selected water pressure could involve small errors in the rainfall rate value 0 5 mmh 1 in the range of rainfall rate investigated surface runoff was collected by a triangular metal funnel screened from rainfall that conveys water to a tipping bucket sensor the collector was placed at the surface lower boundary of soil 2 see the green thick line in fig 1 deep flow was measured by a similar system placed at the bottom of the downstream end of soil 2 see the blue thick line in fig 1 surface runoff and deep flow data were recorded at successive time intervals of 7 min and 21 min respectively the soil moisture content of each soil was continuously monitored by six capacitive sensors drill drop probe sentek technologies placed at different depths 5 15 25 35 45 55 cm many experiments were realized for α 1 5 10 and 15 for each α five trials with r constant in the range 12 34 mmh 1 and a duration of 8 h were performed the sets of experiments associated with different values of α involved quite similar r values obtained by maintaining a known pressure surface runoff and deep flow were observed up to 24 h after the beginning of rainfall and are considered well representative of the soil water interaction this assumption is supported by a previous investigation carried out by essig et al 2009 who found that the downstream boundary of the box did not produce significant distortions in the partitioning of a rainfall into overland and deep flow in the experiments θi of each soil was fairly smaller than θs finally according to the usda soil classification soil 1 and soil 2 were of loam and sandy loam textural classes respectively with significant differences in hydraulic properties as shown in table 1 the quantities ψb λ and c were selected on the basis of the available grain size distributions the other quantities ks θs and θr were determined in advance by experiments on a box filled only by soil 1 or soil 2 the residual soil water content was obtained by capacitive sensor under dry conditions while ks was achieved from measurements of deep flow performed with α 1 under steady conditions when θs was detected 3 experimental results for each slope the minimum r was larger than ks of both soil 1 and soil 2 the same rainfall sequence was adopted for each α to achieve outcomes from experiments with comparable θi values that were checked by the available capacitive sensors see table 2 surface saturation was reached in all the experiments the soil stability was assured by the absence of landslide sites for α up to 15 the outflows associated with each trial are summarized in table 2 where time tre denotes the end of rainfall and the sensitivity of the total surface and deep water volumes to α and r can be deduced the values of surface runoff qs tre and deep flow qd tre refer to the measurements at the time t tre the lack of data on surface and deep flow for α 5 with r 12 mmh 1 and α 10 with r 21 mmh 1 was due to a failure of the recording system associated with the two tipping bucket sensors at time t tre each experiment was characterized by surface runoff and deep flow values associated with quasi steady conditions and the total outflow qs tre qd tre was approximately equal to the rainfall rate see also next section therefore the trend of qs tre as a function of r is complementary to that of qd tre fig 2 shows qd α tre for a few representative rainfall rates some values of deep flow have been computed through interpolation of observed data because as specified in section 2 it was not possible to generate the same experimental values of r for different gradients as can be seen in fig 2 deep flow has an appreciable decrease with values lowered of about 25 with increasing α in the range 1 10 in addition because the qd α tre curves have a similar shape for different rainfalls the rainfall rate does not produce a distortion in this relation at least for r ks of both soil 1 and soil 2 a synthesis of the results for surface and deep water volumes is also presented in fig 3 the trend of the total deep water volume at t tre with increasing α fig 3a is somewhat similar to that observed for qd α tre but with a more pronounced decrease with increasing α between 1 and 10 it decreases by about 40 for r 34 mmh 1 and up to 50 for light rainfall the variation with α of the total surface water volume at the same time fig 3b indicates a growth up to 10 such that the total outflow volume is nearly independent of α an expected common feature of qd α tre and outflow volumes is represented by their larger values with increasing r the variations of the deep flow and total deep volume became of minor interest between 10 and 15 the shape of the outflow hydrographs for different gradients is shown in figs 4 and 5 each referring to a sample event with low and heavy rainfall rate respectively fig 4 highlights that for the lower rainfall rate of about 12 5 mmh 1 and α 1 the surface and deep flow hydrographs exhibit shapes substantially different from those associated with α 10 and 15 which are rather similar the time required to reach quasi steady conditions for deep flow is about 4 h for α 1 while it increases to about 7 h for α 10 and 15 for the surface runoff with α 10 and 15 this time is of about 1 h while with α 1 this time is of about 6 h a common feature of the three outflow hydrographs is that a significant growth in deep flow occurs about two hours later than that of the surface runoff furthermore the surface runoff for α 10 and 15 starts to grow very quickly just after the beginning of the rainfall fig 5 shows that for the heavy rainfall rate of about 33 5 mmh 1 the differences in the shape of the hydrographs for α 1 compared with those for α 5 10 and 15 are less pronounced however quasi steady conditions for the deep flow are reached earlier specifically after approximately 2 h for α 1 and 4 h for the other gradients for overland flow these times are much smaller with a maximum of about 2 h for α 1 a significant increase of deep flow for α 1 is observed after about 1 h and for the larger slopes as with the lower r value after 2 h 4 analysis of results the structure of the soil moisture vertical profile can be investigated through the continuity equation expressed at a time t as 1 r q s q d d v d t where v is the water volume per unit surface area throughout the soil depth focusing our analysis on the outflow hydrographs see figs 4 and 5 for a few sample experiments for t near the end of the rainfall event the outcomes for each value of both r and α indicate approximately steady values of qs and qd which give from eq 1 dv dt close to zero however the aforementioned uncertainty in the estimate of r does not allow one to conclude if fully steady conditions with θ invariant with depth occurred in each soil this issue can be enlightened by examining the trend of qd tre as a function of r for each α fig 2 highlights a growth of qd tre with increasing r in the range 12 5 33 5 mmh 1 thus at least for r up to 33 5 mmh 1 the soil water content had not reached at any depth in both soils a maximum value that is expressed by θ θ s for α 1 and the θ vertical profile was not steady this interpretation is also supported by the θ vertical profile observed by the capacitive sensors in principle the observed surface runoff hydrographs were influenced by rainfall rate and run on process specifically overland flow generation was expected to start earlier on soil 1 with lower permeability subsequently soil 2 as a result of the joint effect of rainfall over its surface and surface water received from soil 1 produced a discharge at the downstream boundary surface runoff was observed after time to ponding of soil 2 regardless of the spatial variability of hydraulic properties of each soil ponding occurred gradually on soil 2 because of the run on process in any case surface runoff observed at the outlet implied maximum values of θ at the soil 1 and soil 2 surface 4 1 interpretation by an infiltration modeling a more in depth interpretation of the observed hydrographs can be made using a simplified simulation modeling applied to experiments carried out for α 1 that is for the α value closer to the horizontal surface for which widely recognized infiltration approaches are available as a first approximation the subsurface water flow between soil 1 and soil 2 has been assumed to be negligible even though capillary and gravitational components parallel to the soil surface exist with a minor role of the gravitational component because of the nearly horizontal box position on this basis a rainfall runoff approach with a one dimensional local model for vertical infiltration on a horizontal surface has been selected corradini et al 1997 2017 this model requires the solution of an ordinary differential equation developed on the basis of a combination of the darcy s law and continuity equation together with an assumption on the shape of the soil moisture vertical profile it was positively tested under very general conditions using the richards equation as a benchmark minor discrepancies were obtained corradini et al 1997 particularly for conditions of steady rainfall rates over homogeneous soils as those characterizing our experiments the choice of the local infiltration model is supported by the homogeneity of each study soil the rainfall runoff approach provides the time evolution of surface runoff and deep flow for both soil 1 and soil 2 as well as the time evolution of the θ vertical profile in each soil neglecting the travel time required for the transfer of water to the outlet of soil 2 it has been applied using the conditions without run on and with run on in the first case the overland and deep flows generated over each soil have been assumed to be independent while in the second case with run on the surface runoff produced over soil 1 has been added to the rainfall falling directly from the sprinklers on soil 2 the two schematizations allow to deduce the role of run on in the rainfall runoff transformation and provide support to investigate the possible existence of other mechanisms influencing slope effects on the partitioning of rainfall into surface and subsurface flow the results derived by model simulations starting from θ i 0 36 for soil 1 and θ i 0 26 for soil 2 are analyzed through two representative cases referred to the extreme rainfalls used in the experiments the input quantities required by the infiltration model for soil 1 and soil 2 are given in table 1 for r 12 5 mmh 1 fig 6 a shows that soil 1 reaches surface saturation about 1 5 h after the beginning of rainfall and this condition persists until the rainfall end when the infiltration rate has a value 6 mmh 1 larger than ks 4 mmh 1 implying an unsteady θ vertical profile for t tre furthermore fig 6b shows that considering separately soil 2 it reaches surface saturation after about 7 h and for t tre the infiltration rate about 12 mmh 1 is larger than ks 10 mmh 1 on the other hand incorporating the run on process surface saturation occurs fig 6c much earlier t 2 h for soil 2 even though for t tre the steady condition for the θ vertical profile has not been reached and the infiltration rate is still larger than ks the role of the run on on the deep flow hydrograph can be deduced from fig 6d by referring to simulations carried out disregarding and including this process the deep flow values represent the discharge per unit draining surface as can be seen at the downstream side of soil 2 the run on process for t tre determines a quasi steady trend that is rather close to the experimental one for r 34 mmh 1 θ at the surface of soil 1 is equal to θ s for t 0 1 h with the infiltration rate less than r fig 7 a until t tre when its value larger than ks indicates an unsteady θ profile soil 2 considered separately is characterized by surface saturation after about 0 3 h fig 7b using this heavy rainfall with r ks for t tre soil 2 with run on gives an unsteady θ vertical profile fig 7c and a quasi steady trend of the deep flow with a magnitude that is the same computed neglecting the run on fig 7d an overall analysis of the model outcomes for α 1 indicates that the main trend of the deep flow hydrographs simulated including run on is fairly similar to that of the corresponding observed hydrographs both with slight and heavy rainfall the model results of unsteady vertical profiles of θ throughout the duration of rainfall indicate that both capillary and gravitational effects are involved and that run on plays a major role for slight rainfall the insights derived from the simulations for a nearly horizontal soil surface provide useful support in the analysis of the experimental results achieved for larger gradients for which a reliable infiltration modeling applicable under real conditions is not available in particular the one derived from the combination of the observed trend of qd tre for different r with the computed infiltration for α 1 at t tre indicates the existence of unsteady θ vertical profiles this deduction is supported by the observed data indicating that for α 5 10 and 15 the total volumes of deep water and surface water at t tre were smaller and larger respectively than the corresponding quantities observed for α 1 fig 3 with a similar trend for the deep flow and surface runoff at t tre 4 2 overall integrated interpretation of the available laboratory experimental studies on the basis of the above outcomes an overall analysis of our results and of the ones obtained in laboratory experiments enables us to identify a few processes that contribute to the determination of the slope effects on infiltration and hortonian surface runoff generation morbidelli et al 2008 carried out trials over two adjacent soils as in our experiments loam and sandy loam but with the downstream soil soil 2 not directly subjected to rainfall in order to give evidence of the run on process due to soil 1 at different slope angles over soil 1 the rainfall rates r 10 and 15 mmh 1 invariant with time and with a duration of 6 h were used the outcomes of their study that we have analyzed in the context of this work indicate that in the absence of run on over soil 2 the reduction of the deep flow with α observed at the outlet of the system substantially determined by soil 1 was of about 40 from 1 to 10 in the presence of run on this variation became of minor interest and was linked with the observed increase of water content in soil 2 that consequently produced a significant growth of the deep flow in any case measurements performed by the time domain reflectometry method suggested that the two soils were not saturated at least in the deep layers thereby the gradient effects associated to soil 1 on the deep flow observed at the system outlet were substantially mitigated by run on through the evolution of the unsaturated θ profile a similar effect is therefore expected to influence the new experimental runs even though its magnitude is more limited as specified in section 3 because of the different deviation of the θ profile from the steady conditions due to the presence of rainfall over soil 2 essig et al 2009 and morbidelli et al 2015 differently from this work examined the role of α for a single soil in the presence of only gravitational effects steady θ profile morbidelli et al 2015 performed experiments using the box shown in fig 1 but filled with a homogeneous loam soil on the basis of an appropriated choice of θ i and rainfall patterns constant r in the range 4 12 mmh 1 with duration 6 h steady conditions for both surface runoff and deep flow as well as for the θ profile were observed at the end of rainfall under these conditions they showed the dependence of outflows on α and for each α they deduced a θ profile invariant with depth with θ θ s for α 1 and θ θ max α θ s for larger gradients the associated variations of the steady outflows were very large and the infiltration rate equal to the deep flow reduced by a factor of 4 with α increased from 1 to 10 under similar experimental conditions but using a sandy loam soil essig et al 2009 found lower effects of α on deep and surface flows an overall interpretation of the results derived by essig et al 2009 and morbidelli et al 2008 2015 together with the results obtained through the new experiments leads to deduce that the deep flow strongly decreases for α up to 10 under the condition that the soil water content vertical profile is invariant with depth in the case of unsteady soil water content vertical profile the aforementioned effect reduces in relation to the deviation from the stationarity infiltration of overland flow into a downstream soil with unsteady soil water content vertical profile lessens the role of slope associated to the upstream soil on the outflow at the system outlet the magnitude of the last aforementioned effect depends on the characteristics of the downstream soil water content vertical profile in terms of wetting degree in this context it is important to remark that in the new experiments with soil 2 subjected to rainfall and run on the slope effects for α up to 10 were in any case significant with a decrease of about 25 for qd α tre and up to 50 for the total deep water volume at the same time while in the previous experiments morbidelli et al 2008 performed in absence of rainfall over soil 2 the run on process produced a nearly completed balancing of the slope effects associated to soil 1 further insights on the trend of infiltration and surface runoff with increasing α can be derived from the assessment of the consistency of our results with those previously obtained from other laboratory experiments that in any case do not consider the run on process poesen et al 1984 using a 200 35 7 5 cm tray filled with fine sand and silt and with α in the range 2 15 realized trials with r equal to 20 7 mmh 1 and duration 1 5 h obtaining outcomes very different from the ones found in this work however as suggested by the authors the infiltration process was influenced by the presence of a thin soil crust and by the rill erosion both very variable with α thereby the results shown cannot be considered representative of the gradient effect fox et al 1997 carried out laboratory 100 40 10 cm trays filled by a sandy loam soil with slope angle in the range 1 5 21 5 and r in the range 38 2 56 3 mmh 1 with duration of 1 5 h interill areas with a surface crust were present and could have influenced the relation between infiltration rate and slope angle even though the sealing intensity did not change with α the wetting front did not reach the tray base and therefore the condition of a soil water content vertical profile invariant with depth was not observed the trend of their results that highlighted a significant decrease of infiltration rate with increasing α up to 11 5 substantially agrees with that deduced in this work see also morbidelli et al 2008 for the deep flow generated by soil 1 that does not involve a steady soil water content vertical profile while a more completed comparison cannot be made because of the different configuration of our experimental system mu et al 2015 performed experiments by a 200 50 60 cm box with slope angle up to 30 and different values of rainfall rate they selected a cultivated sandy loam soil and found a reduction of infiltration rate with increasing α this trend was similar to that deduced in this work for the deep flow produced by soil 1 with a bare soil even though it is expected that the presence of spring maize affected the size of the involved infiltration process khan et al 2016 using trays of 100 30 40 cm developed many trials in mulched and un mulched silty loam soils subjected to rainfalls rates in the range 33 120 mmh 1 and duration of 1 h that did not lead to reach soil steady conditions they found a decrease of the infiltration rate with slope angle in the range 5 25 their trend was quite similar to that associated to soil 1 characterized by unsaturated conditions the last three discussed works agree with our results on the trend of infiltration reducing with increasing the gradient furthermore the magnitude of the infiltration reduction is consistent with that observed in our experiments under unsaturated conditions nevertheless the presence of differences in the experimental system vegetation sealing rainfall pattern soil type and thickness does not allow to exclude distortions on the observed gradient effects 5 conclusion on the basis of the above discussion our results indicate that the sensitivity of deep flow and surface runoff to α varying between 1 and 10 is due to the different role of capillary and gravitational effects in homogeneous soils with steady soil water content vertical profile the very large reduction with increasing α is only due to gravitational effects the coupling of soil 1 and soil 2 with unsaturated conditions below the surfaces implies also the presence of capillary effects that become more significant increasing the deviation of the θ profile from steady conditions in this context our results point out that the presence of run on contributes to modify the role of slope angle with respect to that expected in homogeneous soils strength elements of this work are the observed relation between α and infiltration is not affected by other processes as formation of sealing layer and erosion that lead to its distortion a distinction is made between capillary and gravitational contributions which could be a useful support for their representation in conceptual modeling the modulation of slope effect on heterogeneous infiltrating surfaces in the presence of run on is shown even if through a fictitious experimental apparatus on the other hand it is not possible to provide direct evidence of this process in a soil characterized by large spatial variability of ks under natural conditions credit authorship contribution statement a flammini conceptualization methodology data curation investigation writing original draft writing review editing visualization j dari conceptualization methodology data curation investigation writing original draft writing review editing visualization c saltalippi conceptualization methodology data curation investigation writing original draft writing review editing r morbidelli conceptualization methodology data curation investigation writing original draft writing review editing c corradini conceptualization methodology data curation investigation writing original draft writing review editing supervision r s govindaraju conceptualization writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgment the authors would like to acknowledge dr marco stoppini for the technical support 
96,the displacement of non aqueous phase liquid napl in permeable porous rock by water saturating the surrounding fractures is studied in many situations of practical interest capillarity is the dominant driving force using the global pressure concept it is shown that the water saturation is driven by a generic non linear diffusion equation governing the matrix block counter current spontaneous imbibition in addition in most cases the saturation dependent diffusion coefficient vanishes at the saturation end points that renders the driving equation highly singular in this paper two exact asymptotic solutions valid for short and long times are presented under the assumption that the conductivity vanishes as a power law of both phase saturations at the extreme values of the fluid saturation focusing on the late time domain the asymptotic solution is derived using an ansatz that is written under the form of a power law time decay of the napl saturation in the spatial domain this solution is an eigenvector of the non linear diffusion operator driving the saturation for a problem with dirichlet boundary conditions if the diffusion coefficient varies as a power law of the napl saturation the spatial variations of the solution are given analytically for a one dimensional porous medium corresponding to parallel fracture planes the analytical solution is in very good agreement with results of numerical simulations involving various realistic sets of input transport parameters generalization to the case of two or three dimensional matrix blocks of arbitrary shape is proposed using a similar ansatz solution of a non linear eigenvalue problem a fast converging algorithm based on a fixed point sequence starting from a suitable first guess was developed comparisons with full time simulations for several typical block geometries show an excellent agreement these results permit to set up an analytical formulation generalizing linear single phase representation of matrix to fracture exchange term it accounts for the non linearity of the local flow equations using the power law dependence of the conductivity for low napl saturation the corresponding exponent can be predicted from the input conductivity parameters similar findings are also presented and validated numerically for two or three dimensional matrix blocks that original approach paves the way to research leading to a more faithful description of matrix to fracture exchanges when considering a realistic fractured medium composed of a population of matrix blocks of various size and shapes graphical abstract keywords multiphase flow capillary imbibition non linear diffusion fractured porous media inter porosity flux data availability data will be made available on request nomenclature x dimensions of the quantities considered are given in parenthesis with m mass l length t time where stands for dimension s of x vectors are noted in bold d md darcy milli darcy unit of permeability l 2 1d 2d 3d one two three dimensional napl non aqueous phase liquid t time t τ 0 m characteristic time t x position in space l x y z cartesian space coordinates l r radial coordinate cylindrical spherical geometries l ξ boltzmann variable x 4 d 0 t dimensionless gradient operator l 1 2 laplacian operator l 2 l c characteristic length l l l x y lengths l r radius l l cap capillary length l ϕ porous medium porosity dimensionless fraction k porous medium permeability l 2 φ subscript denoting either water φ w or napl φ o phase ρ φ density of phase φ m l 3 δ ρ density difference ρ w ρ o between water and napl phases m l 3 μ φ dynamic viscosity of phase φ m l 1 t 1 γ interfacial tension m t 2 θ contact angle between fluid and rock dimensionless s φ saturation of phase φ dimensionless fraction s w i irreducible water saturation dimensionless fraction s o r w residual napl saturation dimensionless fraction s normalized water saturation s w s w i 1 s o r w s w i dimensionless fraction p φ pressure in phase φ m l 1 t 2 p c capillary pressure p o p w between water and napl phases m l 1 t 2 p t global pressure m l 1 t 2 k r φ relative permeability to phase φ dimensionless λ φ mobility k r φ μ φ of phase φ m 1 l t λ t total mobility sum of all considered phases mobilities m 1 l t u t total darcy velocity sum of all considered phases darcy velocities l t 1 κ φ maximum relative permeability to phase φ dimensionless p e entry capillary pressure m l 1 t 2 p q r m α 0 1 u v exponents dimensionless d s saturation dependent diffusion function l 2 t 1 d 0 1 constants that are homogeneous to a diffusion coefficient l 2 t 1 β γ constants dimensionless m end point mobility ratio μ o κ w μ w κ o dimensionless space averaging operator dimensionless φ mf matrix to fracture flux l t 1 a 0 matrix to fracture flux prefactors l t 1 2 b x a b euler incomplete beta function b x y euler beta function γ z euler gamma function σ shape factor dimensionless ω ω n domain domain boundary domain boundary outward normal unitary vector ω measure of domain ω l 3 l 2 or l depending on whether ω is a volume a surface or a path 2 l 2 norm 1 introduction in many situations fluid transport processes in complex porous systems may be described by the solution of a non linear diffusion equation with a diffusion coefficient that depends on the local concentration or saturation of the solute or phase of interest in the geosciences context that can be the case when considering napl 1 1 hydrocarbons in liquid or gaseous state pollutants organic compounds air displacement by water in aquifers or hydrocarbon recovery in rock matrix brutsaert 1968 kashchiev and firoozabadi 2003 mcwhorter and sunada 2011 silin and patzek 2004 tavassoli et al 2005 jerbi et al 2017 li et al 2020 in the context of soil mechanics one derives semi analytical or numerical solutions of the richards equation describing unsaturated flows with such non linear forms bruce and klute 1956 parlange et al 1984 1992 barry et al 2010 other systems may receive similar descriptions ranging from filtration to astrophysics including compressible gas flows in porous media granular media flows heaslet and alksne 1961 hansen et al 2020 among others the non linearity of the driving diffusion equation implies that most of standard methods based on superposition properties such as green s functions and fourier decomposition fail down in addition the popular assumption that the diffusion coefficient vanishes at the limiting saturations sharing a power law dependence with the saturation adds a mathematical difficulty babu and van genuchten 1979 in particular singular behaviors are to be expected close to the forcing boundaries where the diffusion coefficient may vanish in order to be more specific in the geosciences context such a generic problem arises when considering a counter current capillary imbibition process on a finite size matrix block approximated by a layer of length l embedded in a fracture network of high conductivity kashchiev and firoozabadi 2003 mcwhorter and sunada 2011 tavassoli et al 2005 li et al 2020 the most standard approach to account for the presence of fractures is to adopt a dual porosity description that involves two averaged equations for the macro scale fracture and matrix effective media in which some exchange term needs to be modeled barenblatt et al 1960 haggerty and gorelick 1995 quintard and whitaker 1998 landereau et al 2001 cherblanc et al 2003 in the single phase case the simplest model is the pseudo steady state dual porosity model that can be improved to account for additional internal matrix relaxation times using a time convolution with some kernel that is the solution of a linear diffusion problem on a representative matrix block landereau et al 2001 nœtinger 2015 such convolution models are not practical in numerical modeling but retain the multiple time scales which are naturally observed dual porosity models involving a linear closure local inter porosity flux proportional to pressure saturation concentration difference imply an exponential relaxation of the average quantity of interest i e a single relaxation time the associated characteristic time corresponds to the diffusion time over the matrix size τ 0 l 2 d 0 defined using some representative diffusion coefficient d 0 and a representative matrix block size l at short times a boundary layer behavior is observed and can be estimated using the standard boltzmann transformation leading to a matrix to fracture flux varying as 1 t hansen et al 2020 li et al 2020 this regime may be observed while the diffusion distance remains lower than the typical size of the matrix blocks fewer results are reported regarding the long time regime description occurring when water has invaded most of the pore volume of the rock using an overall dual porosity description with a linear closure leads to first order differential equations for the description of the matrix fracture exchange the solution of which implies an exponential relaxation of the napl saturation at long times silin and patzek 2004 that is reminiscent of the dual porosity solutions obtained while interpreting pumping tests in fractured formations the associated relaxation time still involves a characteristic diffusion time τ 0 conveniently weighted by a dimensionless shape factor that characterizes the overall matrix block geometrical shape landereau et al 2001 in order to account more accurately for non linear effects an alternative approach is to change the analytical form of the exchange term by looking for a form involving a non linear function of the average matrix block saturation semi analytical developments in that direction were proposed by tavassoli et al 2005 li et al 2020 solving a weak form of the full problem at hand the authors introduce an approximation of the late time solution using a suitably chosen spatial ansatz the model predicts a power law time decay of the napl average saturation in the blocks the corresponding exponent may be related directly to the exponent involved in the local diffusion coefficient dependence with saturation both papers show a good agreement between experimental data and simulation results for completeness li et al 2020 proposed an explicit representation of the exchanges using a non linear term valid over the entire time scale in the present paper we develop an alternative approach for the late time asymptotics looking for solutions having a power law time decay at every location of the matrix block following this assumption a complete determination of the solution can be obtained this solution which compares very well with numerical solutions can be useful to propose a non linear formula relating the matrix to fracture exchange flux to the remaining average napl saturation in the matrix generalizations of our approach to more complex fractured media are discussed the paper is organized as follows first the generic problem to be solved is presented in section 2 2 and the notations and driving equations are introduced in section 2 3 in particular it is shown that the emergence of a non linear diffusion equation driving the time evolution of water saturation is not limited to specific fracture network geometries a straightforward derivation is provided using the concept of global pressure that allows to show that the mean fluid velocity vanishes under various geometrical and physical conditions restricting ourselves to one dimensional counter current displacements results of semi analytical short time analysis using boltzmann transformation are reviewed shortly in section 3 then the long time asymptotic solution is presented in section 4 the spatial dependence of which can be fully determined analytically still in the case of a one dimensional matrix geometry in both sections these solutions are compared with numerical simulations carried out at both short and long times in section 5 the time variation of the overall flux at the matrix boundary is studied that allows to set up a formulation of the exchange term accounting for the non linearity coming back to 2d or 3d cases the approach is generalized for arbitrary matrix block shapes in section 6 the corresponding ansatz that describes the space dependency of the asymptotic behavior is solution of a non linear steady state eigenvalue problem that solution can be evaluated numerically using a fast converging original fixed point algorithm presented in section 6 3 that solution plays the role of the analytical solution developed in the one dimensional case comparisons to full simulations showing an excellent agreement are presented in section 6 4 for various matrix block geometries including the one dimensional previous solution section 7 concludes and an appendix detailing the numerical scheme used to solve the counter current equation closes the article 2 analytical and numerical models in this section we present the mathematical model and the numerical solution that will be used as a reference 2 1 driving forces involved in matrix fracture transfers and considered flow regime in a network of diffuse fractures where flow is taking place the exchange interaction with the matrix blocks delineated by the fracture network as sketched in fig 1 involves four forces gravity viscous forces capillarity and molecular diffusion in the following we will assume on the one hand that the molecular diffusion forces which are by far the weakest are negligible on the other hand we consider such a high permeability contrast between the fractures and the matrix that the overall pressure gradient acting on one matrix block through the fracture is negligible this leaves capillarity and gravity as dominant forces the capillary length l cap is defined as the length beyond which gravity becomes important de gennes et al 2004 in porous media it can be estimated by comparing the laplace pressure 2 γ cos θ r where γ is the interfacial tension between water and napl θ is the contact angle and r is the characteristic capillary tube radius of the equivalent porous medium represented as a bundle of capillary tubes to the gravity driven hydrostatic pressure δ ρ g h where δ ρ ρ w ρ o is the density difference between water and napl h denotes the matrix block height and g the gravity acceleration equating these two pressures setting r 8 k ϕ where k and ϕ denote the matrix block average permeability and porosity defines the capillary length 1 l cap 2 γ cos θ δ ρ g r γ cos θ ϕ δ ρ g 2 k this capillary length which corresponds to a block height such that gravity and capillary forces are balanced i e a unit bond number 2 bo δ ρ g h r 2 γ cos θ δ ρ g h 2 k γ cos θ ϕ h l cap defines two regimes depending on whether l cap h or bo 1 gravity is negligible for block height h l cap bo 1 when this condition is met it is as sought the fluid is in a zero gravity environment and capillary effects dominate the opposite case when h l cap is referred to as the gravity regime bo 1 in what follows we consider only the capillary regime that is rock fluid configurations such that the block height is much lower than the capillary length h l cap for instance assuming napl is a light oil ϕ 0 1 and θ π 3 one gets a capillary length of about l cap 4 9 m for k 10 md depending on temperature and pressure conditions basically we are considering blocks of small height of the order of a few tens of centimeters to one meter 2 2 counter current imbibition in the three dimensional incompressible two phase flow case without gravity we start with general considerations about three dimensional spontaneous counter current capillary imbibition then detail in section 2 3 the corresponding one dimensional problem under the same assumptions we consider two phase flow of incompressible fluids without gravity following the generalized multiphase darcy s laws the driving equations read barenblatt et al 1990 3 ϕ s w t k λ w p w 0 4 ϕ s o t k λ o p o 0 5 s w s o 1 6 p o p w p c s w where ϕ and k denote the porosity and the permeability of the porous medium under consideration here and in the following we assume that the permeability tensor is isotropic s w x t s w i 1 s o r w is the aqueous phase saturation s o x t s o r w 1 s w i is the non aqueous phase saturation s w i is the connate immobile aqueous phase saturation s o r w is the residual immobile non aqueous phase saturation λ φ s w k r φ s w μ φ is the phase φ mobility where φ w o denotes the aqueous and the non aqueous phase respectively k r φ is the relative permeability to phase φ μ φ is phase φ viscosity p φ the intrinsic average pressure in phase φ and p c s p o p w is the capillary pressure between the non aqueous and aqueous phases it is useful to introduce the concept of global pressure p t that depends implicitly on position x and time t introduced by chavent 1975 chavent et al 1984 chavent and jaffré 1986 jeannin et al 2000 7 p t p w s i s λ o λ t d p c d s d s where λ t λ w λ o is the total mobility and s 0 1 the normalized mobile aqueous phase saturation defined as 8 s x t s w x t s w i 1 s o r w s w i where the mobile saturation range 1 s o r w s w i is non zero global pressure is defined up to an arbitrary constant which is accounted for by choosing s i that is an arbitrary saturation value in 0 1 with some algebraic manipulations the original set of eqs 3 6 can thus be transformed as 9 u t 0 10 u t k λ t p t 11 ϕ s w t λ w λ t u t k λ w λ o λ t p c 0 where u t u w u o denotes the total darcy velocity with u φ k λ φ p φ and φ w o eq 10 can be derived from eqs 3 6 and using eq 7 defining global pressure it can be noticed that λ t p t λ w p w λ o p o global pressure may be interpreted as a pressure which would give for a fictitious fluid with mobility λ t equal to the sum of the mobilities of aqueous and non aqueous phases a flux equal to the sum of the flux of the aqueous and non aqueous phases combining eqs 9 and 10 one is led to solve a quasi laplace equation that reads k λ t p t 0 to be solved on the matrix domain with given boundary conditions imposing the rather general boundary conditions at the boundaries of the block i e uniform pressure and saturation we obtain that the global pressure 7 p t is uniform at the block boundaries thus it can be shown that the unique solution of the quasi laplace equation fulfilling these boundary conditions is a constant p t does not depend on position therefore 2 2 this result can be derived using a variational formulation of laplace equation the total velocity vanishes u t 0 this result requires the absence of gravity effects incompressible fluids and the matrix permeability k may be heterogeneous setting u t 0 in eq 11 shows that the saturation is driven by the following non linear diffusion equation 12 s t d s s 13 d s k ϕ 1 s o r w s w i λ w s λ o s λ t s d p c s d s that result shows that counter current imbibition is not restricted to one dimensional cases up to our knowledge that result as well as its direct derivation introducing the global pressure for 2d or 3d situations under quite general conditions appear to be original and shows this non linear diffusion equation is likely to describe the water saturation evolution in many situations of interest 2 3 driving equations in the one dimensional case spontaneous counter current capillary imbibition of a one dimensional matricial porous medium block of size l initially saturated with a non aqueous phase that is drowned in water can be described neglecting gravity and assuming the two phases are incompressible as the non linear diffusion eq 12 for the normalized mobile aqueous phase saturation 8 with initial condition s 0 for all x 0 l and t 0 and boundary conditions s 1 for x 0 and x l for all t 0 in order to analyze the early and late time behaviors we express d s as a function of the mobile aqueous phase saturation s mobile non aqueous phase saturation being 1 s setting the relative permeabilities to the aqueous and non aqueous phases and the capillary pressure as brooks corey saturation power laws brooks and corey 1966 14 k r w s κ w s p 15 k r o s κ o 1 s q 16 p c s p e s 1 m where p q and m are positive exponents κ φ is the maximum relative permeability to phase φ and p e is the entry pressure of the porous medium under consideration while specifying relative permeabilities and capillary pressure saturation dependence is certainly a restriction it should be noted that brooks and corey relationships are widely used for many rock types in addition it does not matter what the choice is as long as a power law behavior is obtained at long times for s 1 this last statement is less true regarding the early time regime which is not the major contribution of this paper as it is discussed later we highlight this by making a more versatile choice later at the end of this section the diffusion coefficient d s given in eq 12 then writes 17 d s d 0 s r 1 s q m s p 1 s q d 1 s r 1 s q s p 1 m 1 s q with 18 d 0 k κ w p e m ϕ μ w 1 s o r w s w i m d 1 19 m μ o κ w μ w κ o λ w s 1 λ o s 0 20 r p m 1 m where m denotes the end point mobility ratio between the aqueous and the non aqueous phases defined as the maximum aqueous phase mobility k r w μ w taken at s 1 over the maximum non aqueous phase mobility k r o μ o taken at s 0 bouquet et al 2020 it is worth noting that eq 12 is of singular type for r 0 or q 0 because d s cancels with either the aqueous phase mobility for s 0 or the non aqueous phase mobility for s 1 it means that mathematical singularities can be expected near the boundary where d 0 for s 0 as well as in the long time limit inside the rock for which d 0 for s 1 a singular regime can be expected at very short times too due to the sharp jump of the water saturation from 1 to 0 near the boundary clearly the balance of forces at play that lies in a capillary pressure difference between the fracture where p c 0 and the matrix where p c 0 media commands that a flow is established and terminates when the equilibrium condition p c s 0 is reached i e s x t 1 or s w x t 1 s o r w noteworthy a non zero solution of eq 12 should satisfy the boundary condition s x x 0 and therefore present a vertical asymptote at the front face of the porous medium indeed this is a necessary condition to get a non zero fracture to matrix flux d s s x x 0 while d cancels at the boundary thereafter two limiting cases are particularly useful to consider on the one hand the case where s 0 which corresponds to the early time counter current spontaneous imbibition of the non aqueous phase saturated block by an aqueous phase and on the other hand the case where s 1 which corresponds to the late time imbibition of the same type for early and late time regimes d s behaves asymptotically as 21 d s d 0 s α 0 with α 0 r for s 0 d 1 1 s α 1 with α 1 q for s 1 thus each of these two limiting cases reduces to a non linear diffusion equation of the singular type with a power law d s specifically one gets for s 0 22 s t x d 0 s α 0 s x and for s 1 23 1 s t x d 1 1 s α 1 1 s x where d 0 d 1 α 0 and α 1 are given in eqs 18 19 20 and 21 typical d s curves are reported in fig 2 coming back to the general case considering a matrix block ω of boundary ω with initial boundary value problem s x t 0 in ω for t 0 and s x t 1 on ω for all t 0 eqs 22 and 23 read respectively 24 s t d 0 s α 0 s 25 1 s t d 1 1 s α 1 1 s given the initial boundary value problem under investigation the late time regime has an expected limit s 1 when t the early time regime has a more subtle behavior since the initial condition corresponds to a jump at x 0 because of the boundary condition s 1 and the initial condition s 0 as a consequence any series solution will feature a full spectrum of saturation functions we come back to this point in section 3 to finish with it is worth noting that relationships 21 23 still hold when considering more versatile relative permeabilities such as lomeland et al 2005 lomeland and ebeltoft 2008 26 k r w s κ w s p s p β 1 s u 27 k r o s κ o 1 s q 1 s q γ s v in this case one gets 28 d s d 0 s p m 1 m 1 s q m s p 1 s q γ s v 1 s q s p β 1 s u hence d s d 0 s p m 1 m β for s 0 and d s d 0 1 s q m γ for s 1 which is precisely eq 21 up to the dimensionless constants β and γ although this type of correlation has no physical basis unlike power law relative permeabilities 14 15 which can be derived by analogy with a bundle of capillary tubes purcell 1949 burdine 1953 wyllie and rose 1950 wyllie and spangler 1952 wyllie and gardner 1958a b standing 1975 rose 1999 it can nevertheless be useful when considering natural porous media for which power laws are not good enough to match measurements our starting point is thus relatively general and is valid as long as an asymptotic power law behavior is obtained at the extreme saturations independently of any detail at intermediate saturation values and regardless of any empirical correlation used 3 early time solution the goal of present work is to set up a description of the fluid transfer valid for the whole time range the literature is very abundant on the short time scale regime that can be assimilated to flow in a semi infinite medium we recall some outstanding works of heaslet and alksne 1961 parlange et al 1984 that are relatively little cited nowadays whereas they give very accurate fudge factor free solutions in the early time regime following bruce and klute 1956 heaslet and alksne 1961 parlange et al 1984 and references therein the idea is to consider that the overall size of the block may be ignored leading to considering a semi infinite medium that suggests to seek a solution using the boltzmann variable ξ x 4 d 0 t with boundary conditions s 0 1 s 0 and d s d s d ξ 0 that yields thus the following equation 29 d d ξ d s d 0 d s d ξ 2 ξ d s d ξ 0 a remarkable fact observed by many authors heaslet and alksne 1961 brutsaert 1968 parlange et al 1984 kashchiev and firoozabadi 2003 tavassoli et al 2005 hansen et al 2020 li et al 2020 is that the solution of this equation has a finite toe located at a distance ξ 0 from the boundary that depends on the input parameters of the equation in order to go farther the saturation dependence of d s suggests to express ξ as a function of s a further transformation allows to treat the case of a d s function given by eq 17 following bruce and klute 1956 parlange et al 1984 eq 29 can be recast under the equivalent form 30 d s 2 d 0 d ξ d s 0 s ξ d s this form assumes the existence of a finite front ξ 0 for which the saturation and the flux proportional to d s d s d ξ cancel out an iterative sequence of approximations parlange et al 1984 can be built by approximating the right hand side integral of eq 30 which yields at the lowest order approximation 31 1 2 d 0 0 s d s s d s ξ 0 ξ 0 ξ and at the higher order approximation 32 1 2 d 0 0 s d s s d s ξ 0 ξ 0 ξ a 2 ξ 0 ξ 2 where a is a constant equal to 1 α 0 1 for a power law d s which is approximately the case for a d s function given by eq 17 if α 0 is large enough the determination of ξ 0 follows directly from the boundary condition s ξ 0 1 these approximations provide an excellent accuracy not only in the neighborhood of ξ 0 for low saturation values in the power law case the solution proposed by parlange et al 1984 is consistent with the findings of heaslet and alksne 1961 whose solution later extended by parlange et al 1992 reads 33 s ξ 2 α 0 ξ 0 ξ 0 ξ 1 α 0 f ξ ξ 0 if ξ 0 ξ 0 0 if ξ ξ 0 here the function f ξ ξ 0 is a regular function that may be expressed as a power series of ξ ξ 0 involving the exponent α 0 as a parameter heaslet and alksne 1961 the complete early time saturation profile thus may be estimated analytically with an excellent accuracy as reported in fig 3 which compares for a few configurations parlange et al 1984 solution 32 obtained by setting a 1 α 0 1 with the numerical solution obtained with the numerical scheme described in appendix saturation presents a vertical asymptote at the front face of the porous medium for x ξ 0 because a non zero fracture to matrix flux d s s x d s 4 d 0 t d s d ξ while d s 0 for s 1 at the boundary is only possible if s x d s d ξ flux vanishes as well at the toe position ξ ξ 0 where d s d ξ 2 ξ 0 2 α 0 ξ 0 ξ 0 ξ 1 α 0 α 0 1 ξ 0 ξ α 0 1 α 0 heaslet and alksne 1961 therefore the larger α 0 the sharper the front as shown in fig 3 to finish with dimensional analysis suggests to normalize the timescale by the diffusion time τ 0 l 2 4 d 0 following our work objective expressions for the matrix to fracture exchange term are investigated in section 5 4 late time asymptotic solution now we focus on the late time regime solution for which the medium can no longer be assumed to be semi infinite and for which the authors have not found to their best knowledge any published exact solution an asymptotic solution for large t is sought using the ansatz 1 s x t y x t β inserting this solution into eq 23 shows that this may be possible if the following condition is satisfied 34 β 1 α 1 the asymptotic solution of eq 23 thus writes 35 1 s x t y x t 1 α 1 where y x is a solution of the ordinary differential equation d d x y α 1 d y d x 1 α 1 d 1 y which we shall rewrite 36 d 2 d x 2 y α 1 1 α 1 1 α 1 d 1 y further transformations g y α 1 1 and h λ g with λ a constant yield 37 d 2 h d x 2 λ α 1 α 1 1 α 1 1 α 1 d 1 h 1 α 1 1 choosing λ α 1 d 1 α 1 1 α 1 1 α 1 eq 37 may be written under the following form 38 d 2 h d x 2 h 1 α 1 1 39 h λ g λ y α 1 1 α 1 d 1 α 1 1 α 1 1 α 1 y α 1 1 for x 0 l boundary conditions 1 s 0 for all t 0 at x 0 and x l yield y 0 y l 0 that is h 0 h l 0 the solution being symmetric around x l 2 one must have d y d x 0 for x 0 l 2 and d y d x 0 for x l 2 l therefore the condition d y d x l 2 0 must hold before going further it is worth noting that eq 38 simplifies into d 2 h d x 2 1 when exponent α 1 is very large whose solution is the parabola h x 1 2 x l x such that h l 2 l 2 8 coming back to the general case it can be remarked that multiplying each member of eq 38 by d h d x the equation can be integrated once to yield 40 1 2 d h d x 2 α 1 1 α 1 2 h α 1 2 α 1 1 l 2 h α 1 2 α 1 1 where the right hand side α 1 1 α 1 2 h α 1 2 α 1 1 l 2 is an integration constant that is determined by the condition d h d x l 2 0 for x 0 l 2 this last form integrates into 41 x α 1 2 2 α 1 1 0 h d h h α 1 2 α 1 1 l 2 h α 1 2 α 1 1 α 1 1 h α 1 α 1 1 l 2 2 α 1 2 0 h h l 2 α 1 2 α 1 1 t α 1 1 α 1 2 1 1 t d t setting t h h l 2 α 1 2 α 1 1 this relationship set with x l 2 yields h l 2 in implicit form 42 l 2 α 1 1 h α 1 α 1 2 l 2 2 α 1 2 0 1 t α 1 1 α 1 2 1 1 t d t using euler incomplete beta and gamma 3 3 incomplete beta beta and gamma function are respectively defined as abramowitz and stegun 1964 b x a b 0 x t a 1 1 t b 1 d t b x y 0 1 t x 1 1 t y 1 d t γ x γ y γ x y and γ z 0 t z 1 e t d t functions the solution rewrites as 43 x α 1 1 h α 1 α 1 1 l 2 2 α 1 2 b h h l 2 α 1 2 α 1 1 α 1 1 α 1 2 1 2 with h l 2 given by 44 h l 2 l 2 2 π α 1 α 1 1 α 1 2 γ α 1 2 α 1 2 γ α 1 1 α 1 2 2 α 1 1 α 1 noteworthy this solution converges for α 1 to the parabola that was previously obtained by direct calculation in the specific case of a very large α 1 exponent which writes implicitly x l 2 l 2 2 2 h with h l 2 l 2 8 going back to the main unknown y related to h by eq 38 the following implicit expression that fulfills all the boundary conditions may be obtained 45 x α 1 d 1 y α 1 l 2 2 α 1 2 b y y l 2 α 1 2 α 1 1 α 1 2 1 2 with y l 2 given by 46 y l 2 l 2 α 1 2 π α 1 2 d 1 γ α 1 2 α 1 2 γ α 1 1 α 1 2 2 α 1 the solution for y l 2 and y x y l 2 are reported in figs 4 a and b unlike solutions 32 and 33 obtained for the early time regime by assuming the porous block to be semi infinite the late time asymptotic solution 45 derived on a finite size domain involves a characteristic length which is the block length l contrary to the early time solution in the late time regime the water saturation is close to unity at every location in the matrix therefore the power law assumption given in eq 23 is automatically satisfied a good agreement can be expected for the long time asymptotic behavior independently of the details of d s over the whole range of saturations as reported in figs 4 c d where the timescale is normalized by the diffusion time τ 0 l 2 4 d 0 in the displayed example the time convergence of the numerical solution to the asymptotic one given in eqs 35 45 and 46 is pretty slow that can be accurately quantified by comparing the time evolution of the numerical solution 1 s or 1 s t 1 α 1 with the asymptotic one for fixed x l values specifically the numerical solution time convergence to the asymptotic one is slower than the asymptotic solution 1 t trend for α 1 2 and intermediate t τ 0 values the reader may wish to consult fig 5 given later in section 5 which reports the time evolution of the matrix to fracture flux to spot the transition between the early and the late time regimes that occurs around t τ 0 40 50 in the example displayed in figs 4 c d ultimately the numerical solution time evolution matches the asymptotic solution one as figs 4 c d indicate about 7 and 2 relative difference between numerical and asymptotic solutions s s num 1 s for t τ 0 512 and 5120 respectively the larger the exponent α 1 the slower this convergence this is consistent with the typical behavior of a porous medium that is preferentially wettable to the non aqueous phase for which the exponent q α 1 of the relative permeability to the non aqueous phase assuming a power law saturation dependency 14 16 is generally large for it imbibes more slowly than a water wet porous medium to conclude this section unlike the early time regime in the late time regime the low napl assumption s t 1 becomes more and more valid as time increases the asymptotic solution is likely to be independent on the details of d s once d s d 1 1 s α 1 as s 1 5 towards a non linear closure for matrix to fracture flux when large discrete fracture networks embedded in a permeable porous matrix are considered it is customary to adopt a dual porosity framework in which the coupling with the matrix may be accounted for via a source term φ mf t landereau et al 2001 cherblanc et al 2003 nœtinger and jarrige 2012 nœtinger 2015 nœtinger et al 2016 this source term φ mf t corresponds to a volume average of the normal flux between matrix and fractures in the case of linear local flow equations the generic closure of φ mf t appears as being a time convolution of the local variable s x t with a time dependent kernel that may be evaluated solving a relaxation problem on a representative matrix block landereau et al 2001 nœtinger 2015 nœtinger et al 2016 in particular focusing on the long time limit when the relaxation of the block reaches its exponential decay it can be shown that φ mf t s x t s f x t τ m with x the block centroid and s f the surrounding fracture saturation the relaxation time τ m may be related to the block typical dimensions via the relation τ m σ l 2 d 0 where σ is the so called shape factor of the matrix block in the stratified case σ 12 in the more general case it is a geometric quantity that is known for several block shapes and that is related to the smallest eigenvalue of the laplacian operator with dirichlet boundary conditions on the block landereau et al 2001 coming back to the non linear case at first sight the convolution approach is useless so other closure must be proposed if any in both short and long time regimes the time variation of the matrix to fracture flux φ mf t d s s x x 0 can be estimated using the previously presented solutions in the short time case using the boltzmann variable φ mf t may be estimated directly as φ mf t d s 4 d 0 t d s d ξ ξ 0 1 t up to a prefactor a 0 in the long time case it is useful to introduce the spatial average of the matrix saturation defined by s t 1 l 2 0 l 2 s x t d x averaging the diffusion eq 12 and swapping the time partial derivative and the spatial average one gets l 2 d s d t 0 l 2 x d s s x d x d s s x x 0 hence φ mf t l 2 d s d t in all the considered cases similar results were obtained using the time derivative of the average saturation or the global flux at the boundary so the former definition was retained inserting the late time ansatz in this expression it may be shown that the matrix to fracture flux varies asymptotically as φ mf t 1 t α 1 1 α 1 the proportionality factor a can be evaluated using the analytical solution y x starting from eqs 40 and 44 the same algebraic decay was already discovered by tavassoli et al 2005 li et al 2020 in both papers the authors selected ansatz dealing with the spatial variable valid close to the matrix fracture boundary although that approach leads to analogous long time variations of the napl saturation it does not provide a complete solution in the space domain and it appears less general especially in the multi dimensional case summarizing the results we get 47 φ mf t a 0 t for t 0 a t α 1 1 α 1 for t both constants a 0 and a encapsulate the spatial details of the corresponding asymptotic solutions and may be obtained manipulating the expressions 29 for a 0 and 39 40 43 and 44 to obtain a that gives the following expressions 48 a 0 d 0 0 1 ξ s d s 49 a 1 α 1 α 1 1 α 1 d 1 1 α 1 2 α 1 1 α 1 2 l 2 2 π α 1 α 1 1 α 1 2 γ α 1 2 α 1 2 γ α 1 1 α 1 2 α 1 2 α 1 if one plots φ mf t using a log log scale two straight lines can be observed the transition time from one regime to the other corresponds to a time t such that ξ 0 l 2 this is illustrated in fig 5 a which reports the time evolution of the matrix to fracture flux for a few α 0 1 values simulated early and late time slopes are in excellent agreement with the early and late time predictions 1 2 and α 1 1 α 1 respectively the transition between the early and late time regimes which is observed for t τ 0 5 10 in fig 5 a and is very clear with a very tight and sharp cross over could be rescaled to t τ 0 1 by considering not the characteristic time τ 0 l 2 4 d 0 suggested by dimensional analysis but τ 0 l 2 16 ξ 0 2 d 0 derived from ξ x 4 d 0 t setting ξ ξ 0 and x l 2 it is worth noting the low influence of the early time exponent α 0 fig 5 b reports the time evolution of the simulated fracture to matrix flux φ mf multiplied by its asymptotic time dependencies 47 and divided by its asymptotic prefactors a 0 and a 48 and 49 for the same α 0 and α 1 exponents as in fig 5 a except for the cross over between the short and long time regimes the asymptotic solutions 47 are found with excellent accuracy and dominate most of the exchange dynamics over several orders of magnitude it can be observed that using the long time asymptotics s t 1 α 1 one can write the matrix to fracture flux under the following form φ mf t s α 1 1 that non linear closure between the local matrix to fracture flux and the average matrix saturation generalizes the usual linear closure relation that gives rise to most dual porosity models the underlying proportionality factor may be obtained directly from the fixed point solution that will be presented in section 6 and could be related to usual shape factors of the literature landereau et al 2001 to finish with it can be remarked that using the relation φ mf t l 2 d s d t if α 1 0 is inserted in that formula it provides an exponential relaxation of the matrix saturation that is consistent with the corresponding findings of the constant diffusion case in the non linear case a non linear closure is obtained estimations of that closure for a whole range of time scales accounting for both the short time and long time scales were proposed by li et al 2020 6 generalization to 2d or 3d matrix blocks we now generalize the results obtained in one dimension of space to any dimension of space for any matrix block geometry under the given boundary conditions the porous medium still undergoes counter current imbibition as demonstrated in section 2 2 without the need for the matrix block to exhibit symmetries we first indicate in sections 6 1 and 6 2 which quantitative features are preserved with respect to the one dimensional early and late time asymptotic solutions and corresponding fluxes and which are not and require additional investigation we show in section 6 3 how the late time asymptotic solution separate form 35 can be exploited to develop a simple and efficient fixed point numerical solution method which advantageously replaces the delicate solving of the initial nonlinear singular diffusion equation finally we demonstrate in section 6 4 by considering some simple two dimensional block geometries that the full dynamics of capillary imbibition can be accurately and efficiently predicted the matrix block imbibition still presents two regimes whose saturation and fracture to matrix flux can be computed a diffusive early time regime and an anomalous late time regime that cross over tightly eventually residual points to investigate are discussed 6 1 early time regime in the general case of matrix blocks having arbitrary shapes there is no simple approximation working yielding a detailed description of the short time regime a generalization of parlange s results might be worth investigating although nothing simple is apparent at first sight at very short time keeping the boltzmann assumption of a dependency on x t is equivalent to set up a boundary layer approximation lamb 1932 landau and lifshitz 1987 tritton 1988 physically it corresponds to consider that locally the block boundary can be assumed to be planar and then to use the one dimensional solution such an approximation can be assumed to be valid if the diffusion length d 0 t is much smaller than any characteristic lengthscale of the block the occurrence of such a regime is confirmed once considering the matrix to fracture flux that is observed hereafter in fig 11 of section 6 4 to vary as 1 t at short times for simple matrix block geometries then a transient regime leading to the long time asymptotic solution can be observed 6 2 late time regime as detailed in the next section the late time asymptotic solution in the separate form 35 remains valid for any dimension of space and any block shape except that the function y x whose analytical expression 45 has been derived in one dimension of space and which we will henceforth denote f x remains to be determined thus except for this detail which we will show hereafter how to manage quickly and accurately numerically the late time asymptotic solution 1 s x t preserves a time dependence in 1 t 1 α 1 and the corresponding asymptotic flux 47 still presents an algebraic anomalous decay that is proportional to 1 t α 1 1 α 1 whose prefactor a remains to be computed and no longer writes as in 49 as it obviously depends on the space solution f x 6 3 fixed point algorithm the late time asymptotic approach 35 remains valid for any dimension of space and any block shape the solution of 25 writes 50 1 s x t f x t 1 α 1 where f x satisfies f α 1 f f α 1 d 1 which is rewritten as already done in eqs 36 39 51 2 h h 1 α 1 1 52 h α 1 d 1 α 1 1 α 1 1 α 1 f α 1 1 as already noted in section 4 h satisfies 2 h 1 when the exponent α 1 is very large whose solution is a parabola in one dimension this will serve as an initial guess to implement a fixed point method to solve 51 we are thus led to solve a laplace equation in a domain ω of boundary ω on which h 0 specifically a sequence of functions h k k 0 such that 53 2 h k h k 1 1 α 1 1 in ω h k 0 on ω for all k 1 is looked for with the following initial guess 54 2 h 0 1 in ω h 0 0 on ω at each iteration of the algorithm we solve the non singular elliptic problem 53 using a newton raphson method embedded in the finite element method framework provided by the freefem open source pde solver hecht 2012 in 2d that code generates meshes with triangular elements and lagrangian p1 basis functions the iterative algorithm is performed until h k h k 1 and h k h k 1 2 are small enough residuals less than 10 12 have been imposed so that a few iterations about 20 are enough to converge which makes the algorithm fast and allows the use of fine meshes to obtain very accurate solutions also as the initial guess corresponds to the solution of eq 54 with α 1 a faster convergence is expected for higher values of α 1 for a given geometry 6 4 results running the algorithm in the one dimensional case gives an excellent agreement with the analytical solution as reported in fig 4 d a similar result has been obtained but is not shown here as it does not bring much by considering not the one dimensional segment 0 l but a two dimensional rectangle as shown in fig 6 with the same initial and boundary conditions i e one pair of faces facing each other with imposed saturation and the other with zero flux four two dimensional geometries were considered in order to validate the fixed point algorithm considering the saturation imposed on the whole boundary of the matrix block from the most to the least symmetrical as shown in fig 6 disk of radius r square of side l rectangle of sides l x and l y quadrangle of medians l x and l y for the record the spherical geometry has also been treated but is not reported because except for some elementary algebra details it does not differ significantly from the cylindrical geometry shown hereafter both are systems with one degree of freedom in each case the diffusion time is defined by τ 0 l c 2 4 d 0 where l c is a characteristic length of the considered geometry that is l c 2 r l or l x or l y depending on whether the medium is a disk square rectangle or quadrangle we will come back to this point later which at this stage is more of a dimensional analysis but requires further analysis as we shall see when analyzing the fluxes the considered flow configuration is one of those previously studied in sections 4 and 5 such that α 1 2 p 3 m 6 m 2 k 10 md p e 5 bar ϕ 0 25 and s w i s o r w 0 figs 7 a 8 a 9 a b and 10 a b report the saturation profiles 1 s x t projected on the domain paths indicated in fig 6 while figs 7 b 8 b 9 c d and 10 c d give the space dependence of the solution by plotting 1 s x t t 1 α 1 in all cases an excellent agreement between the numerical and the fixed point solution is observed for late times specifically from t τ 0 511 for the disk t τ 0 511 for the square t τ 0 5 for the rectangle and t τ 0 838 for the quadrangle now let us look at the flux time evolution over the entire dynamic range as already explained in section 5 flux can be computed in two ways either by the time derivative of the block average saturation or by the flux at the boundary indeed integrating eq 12 on the considered domain ω defining the average saturation as s t 1 ω ω s x t d x and using stokes theorem one gets a napl flux of opposite sign to the water flux of dimension l d t 1 where d is the space dimension that reads 55 φ mf t ω d s t d t ω d s n s d σ with n the ω outward normal unitary vector and ω the measure of ω in two three space dimensions ω is ω area volume ω is its contour surface and d σ is an infinitesimal contour surface element of ω flux time evolution that is more convenient to compute by the average saturation but which we made sure does not depend on the mode of calculation using the left or right hand side of 55 is reported in fig 11 for all the tested geometries whatever the geometry considered several points are worth noting we observe once again as in one dimension an early time diffusive regime that is characterized by a flux which varies proportionally to 1 t and an anomalous late time regime that is driven by a flux proportional to 1 t α 1 1 α 1 flux prefactor a is no longer known analytically as in one dimension following eq 49 but can be quickly obtained numerically from the fixed point algorithm subject to having an accurate estimate of a finite value of t τ 0 for which the numerical solution has almost converged to the asymptotic solution for t the cross over between the early and late time regimes is very narrow therefore the early and late time asymptotic solutions that dominate completely the fracture to matrix dynamic exchange are sufficient to determine the flux over the whole exchange dynamics in other words if the asymptotic solutions are determined then the whole dynamic response of the exchange is also determined to a very good approximation this remains of course to be demonstrated in practice on more complex geometries than those tested flux prefactor a can be computed numerically by a spatial integration of the fixed point solution this being said fig 11 clearly shows that fluxes are all translated in time with respect to each other depending on the geometry considered only the square and the disk are very close this means that the relevant characteristic length l c involved in the diffusion time τ 0 l c 2 4 d 0 remains to be found instead of setting as we did l c 2 r l l x or l y depending on whether the medium is a disk square rectangle or quadrangle once this one is found if it exists whatever the geometry considered all the corresponding fluxes would be in phase and would superimpose if φ mf t a is considered for t following 47 this will be the subject of another work to finish with the constant flux that can be observed at very short times in fig 11 for the square and the quadrangle should be discarded because they are artifacts related to the domain discretization the exchange affecting the first row of cells near the domain boundary only this was verified by further refining the mesh the plateau shifts to even shorter times 7 summary and discussion the long time relaxation of the napl saturation inside a matrix block in contact with water was studied in the case of counter current imbibition for one or two dimensional matrix blocks of arbitrary shape gravity effects were neglected so only the pure capillary regime was investigated the time variations of the matrix to fracture transfer flow rate was also studied the transition from a boltzmann square root regime to an anomalous algebraic power law decay was confirmed qualitatively and quantitatively by numerical simulations in the short time regime the semi infinite assumption is quite robust so the results may remain useful even considering general fractured media response in that regime on the other hand the long time decay exponent is directly related to input data combining capillary pressure and relative permeabilities features as in the long time regime the napl saturation is uniformly small inside the matrix block the power law assumption may be expected to be quite robust controlled by the low napl saturation transport properties the transition between both regimes is sharp occurring as soon as the toe of the short time boltzmann solution reaches half the block size the associated matrix to fracture flux term φ mf t closure may be represented as being proportional to s α 1 1 the exponent α 1 describing the singularity of the diffusion coefficient with napl saturation for general matrix blocks in 2 dimensions a similar study was carried out under the same counter current flow regime the occurrence of such regime appears to be quite general thanks to a derivation involving the global pressure concept a similar ansatz driving the long time regime was proposed it predicts a power law time dependency and the spatial dependence can be determined numerically using a fast fixed point algorithm these findings were confirmed by several comparisons with direct simulations for various typical matrix block shapes similar results are obtained for the time evolution of the corresponding matrix to fracture flux a quite sharp transition between a boltzmann regime involving a 1 t diffusion time dependence and the anomalous long time regime driven by the exponent 1 α 1 can be observed that transition corresponds to the interplay between the diffusion lengthscale and the characteristic size of the matrix block in summary a promising very fast and accurate computational approach is emerging which should eventually make it possible after some additional efforts to predict counter current imbibition over a distribution of blocks of various shapes and sizes which is more representative of naturally fractured porous media to this end the following points require further investigation a generalization of parlange s asymptotic early time solution in any dimension of space might be worth investigating although nothing simple is apparent at first sight late time estimates of t τ 0 such that the fixed point asymptotic solution obtained for t is valid and the flux prefactor a is accurately computed should be consolidated to that end the relevant characteristic length involved in the diffusion time τ 0 should be determined beforehand as previously discussed to make t τ 0 estimates generic indeed if the timescale differs from one geometry to another determining t τ 0 on a case by case basis may be tedious these findings pave the way to research leading to a more faithful description of matrix to fracture exchanges when considering a realistic fractured medium composed of a population of matrix block of various size and shapes in particular the proportionality constant relating the late time flux φ mf t to s α 1 1 appears to play a similar role than a shape factor that may be evaluated using single phase averaging techniques quintard and whitaker 1998 nœtinger et al 2001 2016 looking for simple geometric descriptors quantifying the transition time between diffusion regimes will be of interest for such applications in parallel developing averaging methods lumping these various matrix blocks within one macro scale single exchange flux description will be another research avenue credit authorship contribution statement f douarche investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing b braconnier investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing s momeni investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing m quintard investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing b nœtinger investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper appendix conservative numerical scheme in this appendix we detail the numerical scheme used to solve the singular elliptic partial differential equation 12 in the matrix block domain ω we consider neither the boltzmann variable form 29 for short times nor the asymptotic form 23 for long times but the generic pde 12 that drives the solution s x t for all x and t the singular character of this equation comes from the diffusion coefficient d given by eq 13 which vanishes and is not differentiable with respect to s for s 0 1 except for particular values of the exponents r p and q because d cancels at the boundary ω of the porous medium one must have s ω in order to get a non zero fracture to matrix flux d s s ω as can be seen in fig 3 to prevent numerical instabilities or large rounding errors we set up a conservative scheme which does not require to compute the product d s s and is based on the following reformulation of eq 12 as a conservation law a 1 s t 2 g s where g s 0 s d s d s with s the normalized mobile aqueous phase saturation 8 the physical domain considered is ω with boundary conditions s x t 1 on the boundary ω for all t 0 to start with the function g defined in eq a 1 does not admit a simple expression that can be easily handled except in the limiting cases m 1 and m 1 g is then a power law or an incomplete beta function respectively where m is the mobility ratio defined in eq 19 to derive a conservative numerical scheme we resort to a discrete integration of the diffusion function d denoted g h to do so we discretize the normalized saturation interval 0 1 with the sequence s k k 0 n s k δ s composed of n s 1 points and where δ s 1 n s for convenience let us introduce the operator i g h which defines the discrete integral of g over two increasing saturation values s α and s β using the third order simpson s method i g h writes a 2 i g h s α s β s β s α 6 d s α 4 d s α s β 2 d s β for any saturation value s such that s s k s k 1 we approximate the function g s with g h s i g h s k s l 1 k i g h s l 1 s l regarding the domain ω discretization let m h be an admissible finite volume mesh of the domain ω given by a family of control volumes or cells noted k for any k of m h k is its measure k l k l is the common interface between k and a neighboring cell l the set of neighbors of cell k is denoted n k that is n k l m h k l 0 time is discretized with the non decreasing sequence t n such that t 0 0 and δ t t n 1 t n let also s i n be the approximation of the saturation on the interval c i t n t n δ t finally it is useful to introduce the vector s n such that s n i s i n in order to formulate the scheme vectorially partial differential equation a 1 is recast in a discrete manner with the following finite volume implicit scheme accounting for the boundary condition of an imposed saturation i e s x 0 t 1 x ω t 0 the numerical scheme can be written by introducing the function z n defined for all k m h as a 3 z n s k s k s k n 1 l n k λ k l g k g l λ k ω g k g 1 with g k g s k λ k l δ t k l k d k l where k l is the face measure and d k l the distance between the center of cells k and l the term λ k ω g k g 1 stands for the boundary condition contributions non null when the cell k is a boundary cell as we use polyhedral mesh cells it is the sum of several contributions if cell k has several boundary faces for each boundary face k j that contribution is δ t k j k d k k j where k j is the measure of the face and d k k j the distance between the cell center and the face the updated numerical solution s n of this numerical scheme is the zero of the function z n as this function is non linear because g s non linearly depends on saturation a newton raphson algorithm is required specifically for each time step we construct a sequence s n k such that z n k z n s n k k 0 and recursively defined by s n k 1 s n k δ s n k where δ s n k denotes the increment vector given by a 4 δ s n k s z n k 1 z n k where the matrix s z n k 1 is the inverse of the jacobian matrix s z n k s z n s n k the increment vector δ s n k is thus determined by solving a linear system the jacobian matrix is sparse and its non null terms are given by for all k m h a 5 s z n k k k 1 λ k ω l n k λ k l d k n k s z n k k l λ k l d l n k in addition as the function g is approximated numerically we used the function g h instead of g in relation a 3 to compute the newton residue z n k to end with the newton algorithm is performed until the l 2 norms of the residue z n k 2 and of the increment δ s n k 2 are sufficiently small a 1 cylindrical geometry for a cylindrical domain ω 0 r 0 2 π 0 h invariant by rotation and translation along the z axis the solution depends only on the radius r 0 r we therefore consider a uniform mesh composed of n 1 embedded cylinder of first cell k 0 0 δ r 2 0 2 π 0 h and the following embedded k i i 1 2 δ r i 1 2 δ r 0 2 π 0 h for 1 i n k where δ r r n k 1 2 after some straightforward calculations the scheme writes in the form a 3 with a 6 λ k 0 k 1 4 δ t δ r 2 λ k i k i 1 1 1 2 i δ t δ r 2 for 1 i n k λ k n ω δ t 1 1 δ r r 2 r δ r a 2 spherical geometry for a spherical domain ω 0 r 3 invariant by rotation we consider a uniform mesh composed of n 1 embedded sphere of first cell k 0 0 δ r 2 3 and the following embedded k i i 1 2 δ r i 1 2 δ r 3 for 1 i n k with δ r r n k 1 2 in this case the coefficients of the numerical scheme a 3 are a 7 λ k 0 k 1 6 δ t δ r 2 λ k i k i 1 i 1 2 2 i 1 2 3 i 1 2 3 3 δ t δ r 2 for 1 i n k λ k n ω 3 δ t 1 1 δ r r 3 r δ r 
96,the displacement of non aqueous phase liquid napl in permeable porous rock by water saturating the surrounding fractures is studied in many situations of practical interest capillarity is the dominant driving force using the global pressure concept it is shown that the water saturation is driven by a generic non linear diffusion equation governing the matrix block counter current spontaneous imbibition in addition in most cases the saturation dependent diffusion coefficient vanishes at the saturation end points that renders the driving equation highly singular in this paper two exact asymptotic solutions valid for short and long times are presented under the assumption that the conductivity vanishes as a power law of both phase saturations at the extreme values of the fluid saturation focusing on the late time domain the asymptotic solution is derived using an ansatz that is written under the form of a power law time decay of the napl saturation in the spatial domain this solution is an eigenvector of the non linear diffusion operator driving the saturation for a problem with dirichlet boundary conditions if the diffusion coefficient varies as a power law of the napl saturation the spatial variations of the solution are given analytically for a one dimensional porous medium corresponding to parallel fracture planes the analytical solution is in very good agreement with results of numerical simulations involving various realistic sets of input transport parameters generalization to the case of two or three dimensional matrix blocks of arbitrary shape is proposed using a similar ansatz solution of a non linear eigenvalue problem a fast converging algorithm based on a fixed point sequence starting from a suitable first guess was developed comparisons with full time simulations for several typical block geometries show an excellent agreement these results permit to set up an analytical formulation generalizing linear single phase representation of matrix to fracture exchange term it accounts for the non linearity of the local flow equations using the power law dependence of the conductivity for low napl saturation the corresponding exponent can be predicted from the input conductivity parameters similar findings are also presented and validated numerically for two or three dimensional matrix blocks that original approach paves the way to research leading to a more faithful description of matrix to fracture exchanges when considering a realistic fractured medium composed of a population of matrix blocks of various size and shapes graphical abstract keywords multiphase flow capillary imbibition non linear diffusion fractured porous media inter porosity flux data availability data will be made available on request nomenclature x dimensions of the quantities considered are given in parenthesis with m mass l length t time where stands for dimension s of x vectors are noted in bold d md darcy milli darcy unit of permeability l 2 1d 2d 3d one two three dimensional napl non aqueous phase liquid t time t τ 0 m characteristic time t x position in space l x y z cartesian space coordinates l r radial coordinate cylindrical spherical geometries l ξ boltzmann variable x 4 d 0 t dimensionless gradient operator l 1 2 laplacian operator l 2 l c characteristic length l l l x y lengths l r radius l l cap capillary length l ϕ porous medium porosity dimensionless fraction k porous medium permeability l 2 φ subscript denoting either water φ w or napl φ o phase ρ φ density of phase φ m l 3 δ ρ density difference ρ w ρ o between water and napl phases m l 3 μ φ dynamic viscosity of phase φ m l 1 t 1 γ interfacial tension m t 2 θ contact angle between fluid and rock dimensionless s φ saturation of phase φ dimensionless fraction s w i irreducible water saturation dimensionless fraction s o r w residual napl saturation dimensionless fraction s normalized water saturation s w s w i 1 s o r w s w i dimensionless fraction p φ pressure in phase φ m l 1 t 2 p c capillary pressure p o p w between water and napl phases m l 1 t 2 p t global pressure m l 1 t 2 k r φ relative permeability to phase φ dimensionless λ φ mobility k r φ μ φ of phase φ m 1 l t λ t total mobility sum of all considered phases mobilities m 1 l t u t total darcy velocity sum of all considered phases darcy velocities l t 1 κ φ maximum relative permeability to phase φ dimensionless p e entry capillary pressure m l 1 t 2 p q r m α 0 1 u v exponents dimensionless d s saturation dependent diffusion function l 2 t 1 d 0 1 constants that are homogeneous to a diffusion coefficient l 2 t 1 β γ constants dimensionless m end point mobility ratio μ o κ w μ w κ o dimensionless space averaging operator dimensionless φ mf matrix to fracture flux l t 1 a 0 matrix to fracture flux prefactors l t 1 2 b x a b euler incomplete beta function b x y euler beta function γ z euler gamma function σ shape factor dimensionless ω ω n domain domain boundary domain boundary outward normal unitary vector ω measure of domain ω l 3 l 2 or l depending on whether ω is a volume a surface or a path 2 l 2 norm 1 introduction in many situations fluid transport processes in complex porous systems may be described by the solution of a non linear diffusion equation with a diffusion coefficient that depends on the local concentration or saturation of the solute or phase of interest in the geosciences context that can be the case when considering napl 1 1 hydrocarbons in liquid or gaseous state pollutants organic compounds air displacement by water in aquifers or hydrocarbon recovery in rock matrix brutsaert 1968 kashchiev and firoozabadi 2003 mcwhorter and sunada 2011 silin and patzek 2004 tavassoli et al 2005 jerbi et al 2017 li et al 2020 in the context of soil mechanics one derives semi analytical or numerical solutions of the richards equation describing unsaturated flows with such non linear forms bruce and klute 1956 parlange et al 1984 1992 barry et al 2010 other systems may receive similar descriptions ranging from filtration to astrophysics including compressible gas flows in porous media granular media flows heaslet and alksne 1961 hansen et al 2020 among others the non linearity of the driving diffusion equation implies that most of standard methods based on superposition properties such as green s functions and fourier decomposition fail down in addition the popular assumption that the diffusion coefficient vanishes at the limiting saturations sharing a power law dependence with the saturation adds a mathematical difficulty babu and van genuchten 1979 in particular singular behaviors are to be expected close to the forcing boundaries where the diffusion coefficient may vanish in order to be more specific in the geosciences context such a generic problem arises when considering a counter current capillary imbibition process on a finite size matrix block approximated by a layer of length l embedded in a fracture network of high conductivity kashchiev and firoozabadi 2003 mcwhorter and sunada 2011 tavassoli et al 2005 li et al 2020 the most standard approach to account for the presence of fractures is to adopt a dual porosity description that involves two averaged equations for the macro scale fracture and matrix effective media in which some exchange term needs to be modeled barenblatt et al 1960 haggerty and gorelick 1995 quintard and whitaker 1998 landereau et al 2001 cherblanc et al 2003 in the single phase case the simplest model is the pseudo steady state dual porosity model that can be improved to account for additional internal matrix relaxation times using a time convolution with some kernel that is the solution of a linear diffusion problem on a representative matrix block landereau et al 2001 nœtinger 2015 such convolution models are not practical in numerical modeling but retain the multiple time scales which are naturally observed dual porosity models involving a linear closure local inter porosity flux proportional to pressure saturation concentration difference imply an exponential relaxation of the average quantity of interest i e a single relaxation time the associated characteristic time corresponds to the diffusion time over the matrix size τ 0 l 2 d 0 defined using some representative diffusion coefficient d 0 and a representative matrix block size l at short times a boundary layer behavior is observed and can be estimated using the standard boltzmann transformation leading to a matrix to fracture flux varying as 1 t hansen et al 2020 li et al 2020 this regime may be observed while the diffusion distance remains lower than the typical size of the matrix blocks fewer results are reported regarding the long time regime description occurring when water has invaded most of the pore volume of the rock using an overall dual porosity description with a linear closure leads to first order differential equations for the description of the matrix fracture exchange the solution of which implies an exponential relaxation of the napl saturation at long times silin and patzek 2004 that is reminiscent of the dual porosity solutions obtained while interpreting pumping tests in fractured formations the associated relaxation time still involves a characteristic diffusion time τ 0 conveniently weighted by a dimensionless shape factor that characterizes the overall matrix block geometrical shape landereau et al 2001 in order to account more accurately for non linear effects an alternative approach is to change the analytical form of the exchange term by looking for a form involving a non linear function of the average matrix block saturation semi analytical developments in that direction were proposed by tavassoli et al 2005 li et al 2020 solving a weak form of the full problem at hand the authors introduce an approximation of the late time solution using a suitably chosen spatial ansatz the model predicts a power law time decay of the napl average saturation in the blocks the corresponding exponent may be related directly to the exponent involved in the local diffusion coefficient dependence with saturation both papers show a good agreement between experimental data and simulation results for completeness li et al 2020 proposed an explicit representation of the exchanges using a non linear term valid over the entire time scale in the present paper we develop an alternative approach for the late time asymptotics looking for solutions having a power law time decay at every location of the matrix block following this assumption a complete determination of the solution can be obtained this solution which compares very well with numerical solutions can be useful to propose a non linear formula relating the matrix to fracture exchange flux to the remaining average napl saturation in the matrix generalizations of our approach to more complex fractured media are discussed the paper is organized as follows first the generic problem to be solved is presented in section 2 2 and the notations and driving equations are introduced in section 2 3 in particular it is shown that the emergence of a non linear diffusion equation driving the time evolution of water saturation is not limited to specific fracture network geometries a straightforward derivation is provided using the concept of global pressure that allows to show that the mean fluid velocity vanishes under various geometrical and physical conditions restricting ourselves to one dimensional counter current displacements results of semi analytical short time analysis using boltzmann transformation are reviewed shortly in section 3 then the long time asymptotic solution is presented in section 4 the spatial dependence of which can be fully determined analytically still in the case of a one dimensional matrix geometry in both sections these solutions are compared with numerical simulations carried out at both short and long times in section 5 the time variation of the overall flux at the matrix boundary is studied that allows to set up a formulation of the exchange term accounting for the non linearity coming back to 2d or 3d cases the approach is generalized for arbitrary matrix block shapes in section 6 the corresponding ansatz that describes the space dependency of the asymptotic behavior is solution of a non linear steady state eigenvalue problem that solution can be evaluated numerically using a fast converging original fixed point algorithm presented in section 6 3 that solution plays the role of the analytical solution developed in the one dimensional case comparisons to full simulations showing an excellent agreement are presented in section 6 4 for various matrix block geometries including the one dimensional previous solution section 7 concludes and an appendix detailing the numerical scheme used to solve the counter current equation closes the article 2 analytical and numerical models in this section we present the mathematical model and the numerical solution that will be used as a reference 2 1 driving forces involved in matrix fracture transfers and considered flow regime in a network of diffuse fractures where flow is taking place the exchange interaction with the matrix blocks delineated by the fracture network as sketched in fig 1 involves four forces gravity viscous forces capillarity and molecular diffusion in the following we will assume on the one hand that the molecular diffusion forces which are by far the weakest are negligible on the other hand we consider such a high permeability contrast between the fractures and the matrix that the overall pressure gradient acting on one matrix block through the fracture is negligible this leaves capillarity and gravity as dominant forces the capillary length l cap is defined as the length beyond which gravity becomes important de gennes et al 2004 in porous media it can be estimated by comparing the laplace pressure 2 γ cos θ r where γ is the interfacial tension between water and napl θ is the contact angle and r is the characteristic capillary tube radius of the equivalent porous medium represented as a bundle of capillary tubes to the gravity driven hydrostatic pressure δ ρ g h where δ ρ ρ w ρ o is the density difference between water and napl h denotes the matrix block height and g the gravity acceleration equating these two pressures setting r 8 k ϕ where k and ϕ denote the matrix block average permeability and porosity defines the capillary length 1 l cap 2 γ cos θ δ ρ g r γ cos θ ϕ δ ρ g 2 k this capillary length which corresponds to a block height such that gravity and capillary forces are balanced i e a unit bond number 2 bo δ ρ g h r 2 γ cos θ δ ρ g h 2 k γ cos θ ϕ h l cap defines two regimes depending on whether l cap h or bo 1 gravity is negligible for block height h l cap bo 1 when this condition is met it is as sought the fluid is in a zero gravity environment and capillary effects dominate the opposite case when h l cap is referred to as the gravity regime bo 1 in what follows we consider only the capillary regime that is rock fluid configurations such that the block height is much lower than the capillary length h l cap for instance assuming napl is a light oil ϕ 0 1 and θ π 3 one gets a capillary length of about l cap 4 9 m for k 10 md depending on temperature and pressure conditions basically we are considering blocks of small height of the order of a few tens of centimeters to one meter 2 2 counter current imbibition in the three dimensional incompressible two phase flow case without gravity we start with general considerations about three dimensional spontaneous counter current capillary imbibition then detail in section 2 3 the corresponding one dimensional problem under the same assumptions we consider two phase flow of incompressible fluids without gravity following the generalized multiphase darcy s laws the driving equations read barenblatt et al 1990 3 ϕ s w t k λ w p w 0 4 ϕ s o t k λ o p o 0 5 s w s o 1 6 p o p w p c s w where ϕ and k denote the porosity and the permeability of the porous medium under consideration here and in the following we assume that the permeability tensor is isotropic s w x t s w i 1 s o r w is the aqueous phase saturation s o x t s o r w 1 s w i is the non aqueous phase saturation s w i is the connate immobile aqueous phase saturation s o r w is the residual immobile non aqueous phase saturation λ φ s w k r φ s w μ φ is the phase φ mobility where φ w o denotes the aqueous and the non aqueous phase respectively k r φ is the relative permeability to phase φ μ φ is phase φ viscosity p φ the intrinsic average pressure in phase φ and p c s p o p w is the capillary pressure between the non aqueous and aqueous phases it is useful to introduce the concept of global pressure p t that depends implicitly on position x and time t introduced by chavent 1975 chavent et al 1984 chavent and jaffré 1986 jeannin et al 2000 7 p t p w s i s λ o λ t d p c d s d s where λ t λ w λ o is the total mobility and s 0 1 the normalized mobile aqueous phase saturation defined as 8 s x t s w x t s w i 1 s o r w s w i where the mobile saturation range 1 s o r w s w i is non zero global pressure is defined up to an arbitrary constant which is accounted for by choosing s i that is an arbitrary saturation value in 0 1 with some algebraic manipulations the original set of eqs 3 6 can thus be transformed as 9 u t 0 10 u t k λ t p t 11 ϕ s w t λ w λ t u t k λ w λ o λ t p c 0 where u t u w u o denotes the total darcy velocity with u φ k λ φ p φ and φ w o eq 10 can be derived from eqs 3 6 and using eq 7 defining global pressure it can be noticed that λ t p t λ w p w λ o p o global pressure may be interpreted as a pressure which would give for a fictitious fluid with mobility λ t equal to the sum of the mobilities of aqueous and non aqueous phases a flux equal to the sum of the flux of the aqueous and non aqueous phases combining eqs 9 and 10 one is led to solve a quasi laplace equation that reads k λ t p t 0 to be solved on the matrix domain with given boundary conditions imposing the rather general boundary conditions at the boundaries of the block i e uniform pressure and saturation we obtain that the global pressure 7 p t is uniform at the block boundaries thus it can be shown that the unique solution of the quasi laplace equation fulfilling these boundary conditions is a constant p t does not depend on position therefore 2 2 this result can be derived using a variational formulation of laplace equation the total velocity vanishes u t 0 this result requires the absence of gravity effects incompressible fluids and the matrix permeability k may be heterogeneous setting u t 0 in eq 11 shows that the saturation is driven by the following non linear diffusion equation 12 s t d s s 13 d s k ϕ 1 s o r w s w i λ w s λ o s λ t s d p c s d s that result shows that counter current imbibition is not restricted to one dimensional cases up to our knowledge that result as well as its direct derivation introducing the global pressure for 2d or 3d situations under quite general conditions appear to be original and shows this non linear diffusion equation is likely to describe the water saturation evolution in many situations of interest 2 3 driving equations in the one dimensional case spontaneous counter current capillary imbibition of a one dimensional matricial porous medium block of size l initially saturated with a non aqueous phase that is drowned in water can be described neglecting gravity and assuming the two phases are incompressible as the non linear diffusion eq 12 for the normalized mobile aqueous phase saturation 8 with initial condition s 0 for all x 0 l and t 0 and boundary conditions s 1 for x 0 and x l for all t 0 in order to analyze the early and late time behaviors we express d s as a function of the mobile aqueous phase saturation s mobile non aqueous phase saturation being 1 s setting the relative permeabilities to the aqueous and non aqueous phases and the capillary pressure as brooks corey saturation power laws brooks and corey 1966 14 k r w s κ w s p 15 k r o s κ o 1 s q 16 p c s p e s 1 m where p q and m are positive exponents κ φ is the maximum relative permeability to phase φ and p e is the entry pressure of the porous medium under consideration while specifying relative permeabilities and capillary pressure saturation dependence is certainly a restriction it should be noted that brooks and corey relationships are widely used for many rock types in addition it does not matter what the choice is as long as a power law behavior is obtained at long times for s 1 this last statement is less true regarding the early time regime which is not the major contribution of this paper as it is discussed later we highlight this by making a more versatile choice later at the end of this section the diffusion coefficient d s given in eq 12 then writes 17 d s d 0 s r 1 s q m s p 1 s q d 1 s r 1 s q s p 1 m 1 s q with 18 d 0 k κ w p e m ϕ μ w 1 s o r w s w i m d 1 19 m μ o κ w μ w κ o λ w s 1 λ o s 0 20 r p m 1 m where m denotes the end point mobility ratio between the aqueous and the non aqueous phases defined as the maximum aqueous phase mobility k r w μ w taken at s 1 over the maximum non aqueous phase mobility k r o μ o taken at s 0 bouquet et al 2020 it is worth noting that eq 12 is of singular type for r 0 or q 0 because d s cancels with either the aqueous phase mobility for s 0 or the non aqueous phase mobility for s 1 it means that mathematical singularities can be expected near the boundary where d 0 for s 0 as well as in the long time limit inside the rock for which d 0 for s 1 a singular regime can be expected at very short times too due to the sharp jump of the water saturation from 1 to 0 near the boundary clearly the balance of forces at play that lies in a capillary pressure difference between the fracture where p c 0 and the matrix where p c 0 media commands that a flow is established and terminates when the equilibrium condition p c s 0 is reached i e s x t 1 or s w x t 1 s o r w noteworthy a non zero solution of eq 12 should satisfy the boundary condition s x x 0 and therefore present a vertical asymptote at the front face of the porous medium indeed this is a necessary condition to get a non zero fracture to matrix flux d s s x x 0 while d cancels at the boundary thereafter two limiting cases are particularly useful to consider on the one hand the case where s 0 which corresponds to the early time counter current spontaneous imbibition of the non aqueous phase saturated block by an aqueous phase and on the other hand the case where s 1 which corresponds to the late time imbibition of the same type for early and late time regimes d s behaves asymptotically as 21 d s d 0 s α 0 with α 0 r for s 0 d 1 1 s α 1 with α 1 q for s 1 thus each of these two limiting cases reduces to a non linear diffusion equation of the singular type with a power law d s specifically one gets for s 0 22 s t x d 0 s α 0 s x and for s 1 23 1 s t x d 1 1 s α 1 1 s x where d 0 d 1 α 0 and α 1 are given in eqs 18 19 20 and 21 typical d s curves are reported in fig 2 coming back to the general case considering a matrix block ω of boundary ω with initial boundary value problem s x t 0 in ω for t 0 and s x t 1 on ω for all t 0 eqs 22 and 23 read respectively 24 s t d 0 s α 0 s 25 1 s t d 1 1 s α 1 1 s given the initial boundary value problem under investigation the late time regime has an expected limit s 1 when t the early time regime has a more subtle behavior since the initial condition corresponds to a jump at x 0 because of the boundary condition s 1 and the initial condition s 0 as a consequence any series solution will feature a full spectrum of saturation functions we come back to this point in section 3 to finish with it is worth noting that relationships 21 23 still hold when considering more versatile relative permeabilities such as lomeland et al 2005 lomeland and ebeltoft 2008 26 k r w s κ w s p s p β 1 s u 27 k r o s κ o 1 s q 1 s q γ s v in this case one gets 28 d s d 0 s p m 1 m 1 s q m s p 1 s q γ s v 1 s q s p β 1 s u hence d s d 0 s p m 1 m β for s 0 and d s d 0 1 s q m γ for s 1 which is precisely eq 21 up to the dimensionless constants β and γ although this type of correlation has no physical basis unlike power law relative permeabilities 14 15 which can be derived by analogy with a bundle of capillary tubes purcell 1949 burdine 1953 wyllie and rose 1950 wyllie and spangler 1952 wyllie and gardner 1958a b standing 1975 rose 1999 it can nevertheless be useful when considering natural porous media for which power laws are not good enough to match measurements our starting point is thus relatively general and is valid as long as an asymptotic power law behavior is obtained at the extreme saturations independently of any detail at intermediate saturation values and regardless of any empirical correlation used 3 early time solution the goal of present work is to set up a description of the fluid transfer valid for the whole time range the literature is very abundant on the short time scale regime that can be assimilated to flow in a semi infinite medium we recall some outstanding works of heaslet and alksne 1961 parlange et al 1984 that are relatively little cited nowadays whereas they give very accurate fudge factor free solutions in the early time regime following bruce and klute 1956 heaslet and alksne 1961 parlange et al 1984 and references therein the idea is to consider that the overall size of the block may be ignored leading to considering a semi infinite medium that suggests to seek a solution using the boltzmann variable ξ x 4 d 0 t with boundary conditions s 0 1 s 0 and d s d s d ξ 0 that yields thus the following equation 29 d d ξ d s d 0 d s d ξ 2 ξ d s d ξ 0 a remarkable fact observed by many authors heaslet and alksne 1961 brutsaert 1968 parlange et al 1984 kashchiev and firoozabadi 2003 tavassoli et al 2005 hansen et al 2020 li et al 2020 is that the solution of this equation has a finite toe located at a distance ξ 0 from the boundary that depends on the input parameters of the equation in order to go farther the saturation dependence of d s suggests to express ξ as a function of s a further transformation allows to treat the case of a d s function given by eq 17 following bruce and klute 1956 parlange et al 1984 eq 29 can be recast under the equivalent form 30 d s 2 d 0 d ξ d s 0 s ξ d s this form assumes the existence of a finite front ξ 0 for which the saturation and the flux proportional to d s d s d ξ cancel out an iterative sequence of approximations parlange et al 1984 can be built by approximating the right hand side integral of eq 30 which yields at the lowest order approximation 31 1 2 d 0 0 s d s s d s ξ 0 ξ 0 ξ and at the higher order approximation 32 1 2 d 0 0 s d s s d s ξ 0 ξ 0 ξ a 2 ξ 0 ξ 2 where a is a constant equal to 1 α 0 1 for a power law d s which is approximately the case for a d s function given by eq 17 if α 0 is large enough the determination of ξ 0 follows directly from the boundary condition s ξ 0 1 these approximations provide an excellent accuracy not only in the neighborhood of ξ 0 for low saturation values in the power law case the solution proposed by parlange et al 1984 is consistent with the findings of heaslet and alksne 1961 whose solution later extended by parlange et al 1992 reads 33 s ξ 2 α 0 ξ 0 ξ 0 ξ 1 α 0 f ξ ξ 0 if ξ 0 ξ 0 0 if ξ ξ 0 here the function f ξ ξ 0 is a regular function that may be expressed as a power series of ξ ξ 0 involving the exponent α 0 as a parameter heaslet and alksne 1961 the complete early time saturation profile thus may be estimated analytically with an excellent accuracy as reported in fig 3 which compares for a few configurations parlange et al 1984 solution 32 obtained by setting a 1 α 0 1 with the numerical solution obtained with the numerical scheme described in appendix saturation presents a vertical asymptote at the front face of the porous medium for x ξ 0 because a non zero fracture to matrix flux d s s x d s 4 d 0 t d s d ξ while d s 0 for s 1 at the boundary is only possible if s x d s d ξ flux vanishes as well at the toe position ξ ξ 0 where d s d ξ 2 ξ 0 2 α 0 ξ 0 ξ 0 ξ 1 α 0 α 0 1 ξ 0 ξ α 0 1 α 0 heaslet and alksne 1961 therefore the larger α 0 the sharper the front as shown in fig 3 to finish with dimensional analysis suggests to normalize the timescale by the diffusion time τ 0 l 2 4 d 0 following our work objective expressions for the matrix to fracture exchange term are investigated in section 5 4 late time asymptotic solution now we focus on the late time regime solution for which the medium can no longer be assumed to be semi infinite and for which the authors have not found to their best knowledge any published exact solution an asymptotic solution for large t is sought using the ansatz 1 s x t y x t β inserting this solution into eq 23 shows that this may be possible if the following condition is satisfied 34 β 1 α 1 the asymptotic solution of eq 23 thus writes 35 1 s x t y x t 1 α 1 where y x is a solution of the ordinary differential equation d d x y α 1 d y d x 1 α 1 d 1 y which we shall rewrite 36 d 2 d x 2 y α 1 1 α 1 1 α 1 d 1 y further transformations g y α 1 1 and h λ g with λ a constant yield 37 d 2 h d x 2 λ α 1 α 1 1 α 1 1 α 1 d 1 h 1 α 1 1 choosing λ α 1 d 1 α 1 1 α 1 1 α 1 eq 37 may be written under the following form 38 d 2 h d x 2 h 1 α 1 1 39 h λ g λ y α 1 1 α 1 d 1 α 1 1 α 1 1 α 1 y α 1 1 for x 0 l boundary conditions 1 s 0 for all t 0 at x 0 and x l yield y 0 y l 0 that is h 0 h l 0 the solution being symmetric around x l 2 one must have d y d x 0 for x 0 l 2 and d y d x 0 for x l 2 l therefore the condition d y d x l 2 0 must hold before going further it is worth noting that eq 38 simplifies into d 2 h d x 2 1 when exponent α 1 is very large whose solution is the parabola h x 1 2 x l x such that h l 2 l 2 8 coming back to the general case it can be remarked that multiplying each member of eq 38 by d h d x the equation can be integrated once to yield 40 1 2 d h d x 2 α 1 1 α 1 2 h α 1 2 α 1 1 l 2 h α 1 2 α 1 1 where the right hand side α 1 1 α 1 2 h α 1 2 α 1 1 l 2 is an integration constant that is determined by the condition d h d x l 2 0 for x 0 l 2 this last form integrates into 41 x α 1 2 2 α 1 1 0 h d h h α 1 2 α 1 1 l 2 h α 1 2 α 1 1 α 1 1 h α 1 α 1 1 l 2 2 α 1 2 0 h h l 2 α 1 2 α 1 1 t α 1 1 α 1 2 1 1 t d t setting t h h l 2 α 1 2 α 1 1 this relationship set with x l 2 yields h l 2 in implicit form 42 l 2 α 1 1 h α 1 α 1 2 l 2 2 α 1 2 0 1 t α 1 1 α 1 2 1 1 t d t using euler incomplete beta and gamma 3 3 incomplete beta beta and gamma function are respectively defined as abramowitz and stegun 1964 b x a b 0 x t a 1 1 t b 1 d t b x y 0 1 t x 1 1 t y 1 d t γ x γ y γ x y and γ z 0 t z 1 e t d t functions the solution rewrites as 43 x α 1 1 h α 1 α 1 1 l 2 2 α 1 2 b h h l 2 α 1 2 α 1 1 α 1 1 α 1 2 1 2 with h l 2 given by 44 h l 2 l 2 2 π α 1 α 1 1 α 1 2 γ α 1 2 α 1 2 γ α 1 1 α 1 2 2 α 1 1 α 1 noteworthy this solution converges for α 1 to the parabola that was previously obtained by direct calculation in the specific case of a very large α 1 exponent which writes implicitly x l 2 l 2 2 2 h with h l 2 l 2 8 going back to the main unknown y related to h by eq 38 the following implicit expression that fulfills all the boundary conditions may be obtained 45 x α 1 d 1 y α 1 l 2 2 α 1 2 b y y l 2 α 1 2 α 1 1 α 1 2 1 2 with y l 2 given by 46 y l 2 l 2 α 1 2 π α 1 2 d 1 γ α 1 2 α 1 2 γ α 1 1 α 1 2 2 α 1 the solution for y l 2 and y x y l 2 are reported in figs 4 a and b unlike solutions 32 and 33 obtained for the early time regime by assuming the porous block to be semi infinite the late time asymptotic solution 45 derived on a finite size domain involves a characteristic length which is the block length l contrary to the early time solution in the late time regime the water saturation is close to unity at every location in the matrix therefore the power law assumption given in eq 23 is automatically satisfied a good agreement can be expected for the long time asymptotic behavior independently of the details of d s over the whole range of saturations as reported in figs 4 c d where the timescale is normalized by the diffusion time τ 0 l 2 4 d 0 in the displayed example the time convergence of the numerical solution to the asymptotic one given in eqs 35 45 and 46 is pretty slow that can be accurately quantified by comparing the time evolution of the numerical solution 1 s or 1 s t 1 α 1 with the asymptotic one for fixed x l values specifically the numerical solution time convergence to the asymptotic one is slower than the asymptotic solution 1 t trend for α 1 2 and intermediate t τ 0 values the reader may wish to consult fig 5 given later in section 5 which reports the time evolution of the matrix to fracture flux to spot the transition between the early and the late time regimes that occurs around t τ 0 40 50 in the example displayed in figs 4 c d ultimately the numerical solution time evolution matches the asymptotic solution one as figs 4 c d indicate about 7 and 2 relative difference between numerical and asymptotic solutions s s num 1 s for t τ 0 512 and 5120 respectively the larger the exponent α 1 the slower this convergence this is consistent with the typical behavior of a porous medium that is preferentially wettable to the non aqueous phase for which the exponent q α 1 of the relative permeability to the non aqueous phase assuming a power law saturation dependency 14 16 is generally large for it imbibes more slowly than a water wet porous medium to conclude this section unlike the early time regime in the late time regime the low napl assumption s t 1 becomes more and more valid as time increases the asymptotic solution is likely to be independent on the details of d s once d s d 1 1 s α 1 as s 1 5 towards a non linear closure for matrix to fracture flux when large discrete fracture networks embedded in a permeable porous matrix are considered it is customary to adopt a dual porosity framework in which the coupling with the matrix may be accounted for via a source term φ mf t landereau et al 2001 cherblanc et al 2003 nœtinger and jarrige 2012 nœtinger 2015 nœtinger et al 2016 this source term φ mf t corresponds to a volume average of the normal flux between matrix and fractures in the case of linear local flow equations the generic closure of φ mf t appears as being a time convolution of the local variable s x t with a time dependent kernel that may be evaluated solving a relaxation problem on a representative matrix block landereau et al 2001 nœtinger 2015 nœtinger et al 2016 in particular focusing on the long time limit when the relaxation of the block reaches its exponential decay it can be shown that φ mf t s x t s f x t τ m with x the block centroid and s f the surrounding fracture saturation the relaxation time τ m may be related to the block typical dimensions via the relation τ m σ l 2 d 0 where σ is the so called shape factor of the matrix block in the stratified case σ 12 in the more general case it is a geometric quantity that is known for several block shapes and that is related to the smallest eigenvalue of the laplacian operator with dirichlet boundary conditions on the block landereau et al 2001 coming back to the non linear case at first sight the convolution approach is useless so other closure must be proposed if any in both short and long time regimes the time variation of the matrix to fracture flux φ mf t d s s x x 0 can be estimated using the previously presented solutions in the short time case using the boltzmann variable φ mf t may be estimated directly as φ mf t d s 4 d 0 t d s d ξ ξ 0 1 t up to a prefactor a 0 in the long time case it is useful to introduce the spatial average of the matrix saturation defined by s t 1 l 2 0 l 2 s x t d x averaging the diffusion eq 12 and swapping the time partial derivative and the spatial average one gets l 2 d s d t 0 l 2 x d s s x d x d s s x x 0 hence φ mf t l 2 d s d t in all the considered cases similar results were obtained using the time derivative of the average saturation or the global flux at the boundary so the former definition was retained inserting the late time ansatz in this expression it may be shown that the matrix to fracture flux varies asymptotically as φ mf t 1 t α 1 1 α 1 the proportionality factor a can be evaluated using the analytical solution y x starting from eqs 40 and 44 the same algebraic decay was already discovered by tavassoli et al 2005 li et al 2020 in both papers the authors selected ansatz dealing with the spatial variable valid close to the matrix fracture boundary although that approach leads to analogous long time variations of the napl saturation it does not provide a complete solution in the space domain and it appears less general especially in the multi dimensional case summarizing the results we get 47 φ mf t a 0 t for t 0 a t α 1 1 α 1 for t both constants a 0 and a encapsulate the spatial details of the corresponding asymptotic solutions and may be obtained manipulating the expressions 29 for a 0 and 39 40 43 and 44 to obtain a that gives the following expressions 48 a 0 d 0 0 1 ξ s d s 49 a 1 α 1 α 1 1 α 1 d 1 1 α 1 2 α 1 1 α 1 2 l 2 2 π α 1 α 1 1 α 1 2 γ α 1 2 α 1 2 γ α 1 1 α 1 2 α 1 2 α 1 if one plots φ mf t using a log log scale two straight lines can be observed the transition time from one regime to the other corresponds to a time t such that ξ 0 l 2 this is illustrated in fig 5 a which reports the time evolution of the matrix to fracture flux for a few α 0 1 values simulated early and late time slopes are in excellent agreement with the early and late time predictions 1 2 and α 1 1 α 1 respectively the transition between the early and late time regimes which is observed for t τ 0 5 10 in fig 5 a and is very clear with a very tight and sharp cross over could be rescaled to t τ 0 1 by considering not the characteristic time τ 0 l 2 4 d 0 suggested by dimensional analysis but τ 0 l 2 16 ξ 0 2 d 0 derived from ξ x 4 d 0 t setting ξ ξ 0 and x l 2 it is worth noting the low influence of the early time exponent α 0 fig 5 b reports the time evolution of the simulated fracture to matrix flux φ mf multiplied by its asymptotic time dependencies 47 and divided by its asymptotic prefactors a 0 and a 48 and 49 for the same α 0 and α 1 exponents as in fig 5 a except for the cross over between the short and long time regimes the asymptotic solutions 47 are found with excellent accuracy and dominate most of the exchange dynamics over several orders of magnitude it can be observed that using the long time asymptotics s t 1 α 1 one can write the matrix to fracture flux under the following form φ mf t s α 1 1 that non linear closure between the local matrix to fracture flux and the average matrix saturation generalizes the usual linear closure relation that gives rise to most dual porosity models the underlying proportionality factor may be obtained directly from the fixed point solution that will be presented in section 6 and could be related to usual shape factors of the literature landereau et al 2001 to finish with it can be remarked that using the relation φ mf t l 2 d s d t if α 1 0 is inserted in that formula it provides an exponential relaxation of the matrix saturation that is consistent with the corresponding findings of the constant diffusion case in the non linear case a non linear closure is obtained estimations of that closure for a whole range of time scales accounting for both the short time and long time scales were proposed by li et al 2020 6 generalization to 2d or 3d matrix blocks we now generalize the results obtained in one dimension of space to any dimension of space for any matrix block geometry under the given boundary conditions the porous medium still undergoes counter current imbibition as demonstrated in section 2 2 without the need for the matrix block to exhibit symmetries we first indicate in sections 6 1 and 6 2 which quantitative features are preserved with respect to the one dimensional early and late time asymptotic solutions and corresponding fluxes and which are not and require additional investigation we show in section 6 3 how the late time asymptotic solution separate form 35 can be exploited to develop a simple and efficient fixed point numerical solution method which advantageously replaces the delicate solving of the initial nonlinear singular diffusion equation finally we demonstrate in section 6 4 by considering some simple two dimensional block geometries that the full dynamics of capillary imbibition can be accurately and efficiently predicted the matrix block imbibition still presents two regimes whose saturation and fracture to matrix flux can be computed a diffusive early time regime and an anomalous late time regime that cross over tightly eventually residual points to investigate are discussed 6 1 early time regime in the general case of matrix blocks having arbitrary shapes there is no simple approximation working yielding a detailed description of the short time regime a generalization of parlange s results might be worth investigating although nothing simple is apparent at first sight at very short time keeping the boltzmann assumption of a dependency on x t is equivalent to set up a boundary layer approximation lamb 1932 landau and lifshitz 1987 tritton 1988 physically it corresponds to consider that locally the block boundary can be assumed to be planar and then to use the one dimensional solution such an approximation can be assumed to be valid if the diffusion length d 0 t is much smaller than any characteristic lengthscale of the block the occurrence of such a regime is confirmed once considering the matrix to fracture flux that is observed hereafter in fig 11 of section 6 4 to vary as 1 t at short times for simple matrix block geometries then a transient regime leading to the long time asymptotic solution can be observed 6 2 late time regime as detailed in the next section the late time asymptotic solution in the separate form 35 remains valid for any dimension of space and any block shape except that the function y x whose analytical expression 45 has been derived in one dimension of space and which we will henceforth denote f x remains to be determined thus except for this detail which we will show hereafter how to manage quickly and accurately numerically the late time asymptotic solution 1 s x t preserves a time dependence in 1 t 1 α 1 and the corresponding asymptotic flux 47 still presents an algebraic anomalous decay that is proportional to 1 t α 1 1 α 1 whose prefactor a remains to be computed and no longer writes as in 49 as it obviously depends on the space solution f x 6 3 fixed point algorithm the late time asymptotic approach 35 remains valid for any dimension of space and any block shape the solution of 25 writes 50 1 s x t f x t 1 α 1 where f x satisfies f α 1 f f α 1 d 1 which is rewritten as already done in eqs 36 39 51 2 h h 1 α 1 1 52 h α 1 d 1 α 1 1 α 1 1 α 1 f α 1 1 as already noted in section 4 h satisfies 2 h 1 when the exponent α 1 is very large whose solution is a parabola in one dimension this will serve as an initial guess to implement a fixed point method to solve 51 we are thus led to solve a laplace equation in a domain ω of boundary ω on which h 0 specifically a sequence of functions h k k 0 such that 53 2 h k h k 1 1 α 1 1 in ω h k 0 on ω for all k 1 is looked for with the following initial guess 54 2 h 0 1 in ω h 0 0 on ω at each iteration of the algorithm we solve the non singular elliptic problem 53 using a newton raphson method embedded in the finite element method framework provided by the freefem open source pde solver hecht 2012 in 2d that code generates meshes with triangular elements and lagrangian p1 basis functions the iterative algorithm is performed until h k h k 1 and h k h k 1 2 are small enough residuals less than 10 12 have been imposed so that a few iterations about 20 are enough to converge which makes the algorithm fast and allows the use of fine meshes to obtain very accurate solutions also as the initial guess corresponds to the solution of eq 54 with α 1 a faster convergence is expected for higher values of α 1 for a given geometry 6 4 results running the algorithm in the one dimensional case gives an excellent agreement with the analytical solution as reported in fig 4 d a similar result has been obtained but is not shown here as it does not bring much by considering not the one dimensional segment 0 l but a two dimensional rectangle as shown in fig 6 with the same initial and boundary conditions i e one pair of faces facing each other with imposed saturation and the other with zero flux four two dimensional geometries were considered in order to validate the fixed point algorithm considering the saturation imposed on the whole boundary of the matrix block from the most to the least symmetrical as shown in fig 6 disk of radius r square of side l rectangle of sides l x and l y quadrangle of medians l x and l y for the record the spherical geometry has also been treated but is not reported because except for some elementary algebra details it does not differ significantly from the cylindrical geometry shown hereafter both are systems with one degree of freedom in each case the diffusion time is defined by τ 0 l c 2 4 d 0 where l c is a characteristic length of the considered geometry that is l c 2 r l or l x or l y depending on whether the medium is a disk square rectangle or quadrangle we will come back to this point later which at this stage is more of a dimensional analysis but requires further analysis as we shall see when analyzing the fluxes the considered flow configuration is one of those previously studied in sections 4 and 5 such that α 1 2 p 3 m 6 m 2 k 10 md p e 5 bar ϕ 0 25 and s w i s o r w 0 figs 7 a 8 a 9 a b and 10 a b report the saturation profiles 1 s x t projected on the domain paths indicated in fig 6 while figs 7 b 8 b 9 c d and 10 c d give the space dependence of the solution by plotting 1 s x t t 1 α 1 in all cases an excellent agreement between the numerical and the fixed point solution is observed for late times specifically from t τ 0 511 for the disk t τ 0 511 for the square t τ 0 5 for the rectangle and t τ 0 838 for the quadrangle now let us look at the flux time evolution over the entire dynamic range as already explained in section 5 flux can be computed in two ways either by the time derivative of the block average saturation or by the flux at the boundary indeed integrating eq 12 on the considered domain ω defining the average saturation as s t 1 ω ω s x t d x and using stokes theorem one gets a napl flux of opposite sign to the water flux of dimension l d t 1 where d is the space dimension that reads 55 φ mf t ω d s t d t ω d s n s d σ with n the ω outward normal unitary vector and ω the measure of ω in two three space dimensions ω is ω area volume ω is its contour surface and d σ is an infinitesimal contour surface element of ω flux time evolution that is more convenient to compute by the average saturation but which we made sure does not depend on the mode of calculation using the left or right hand side of 55 is reported in fig 11 for all the tested geometries whatever the geometry considered several points are worth noting we observe once again as in one dimension an early time diffusive regime that is characterized by a flux which varies proportionally to 1 t and an anomalous late time regime that is driven by a flux proportional to 1 t α 1 1 α 1 flux prefactor a is no longer known analytically as in one dimension following eq 49 but can be quickly obtained numerically from the fixed point algorithm subject to having an accurate estimate of a finite value of t τ 0 for which the numerical solution has almost converged to the asymptotic solution for t the cross over between the early and late time regimes is very narrow therefore the early and late time asymptotic solutions that dominate completely the fracture to matrix dynamic exchange are sufficient to determine the flux over the whole exchange dynamics in other words if the asymptotic solutions are determined then the whole dynamic response of the exchange is also determined to a very good approximation this remains of course to be demonstrated in practice on more complex geometries than those tested flux prefactor a can be computed numerically by a spatial integration of the fixed point solution this being said fig 11 clearly shows that fluxes are all translated in time with respect to each other depending on the geometry considered only the square and the disk are very close this means that the relevant characteristic length l c involved in the diffusion time τ 0 l c 2 4 d 0 remains to be found instead of setting as we did l c 2 r l l x or l y depending on whether the medium is a disk square rectangle or quadrangle once this one is found if it exists whatever the geometry considered all the corresponding fluxes would be in phase and would superimpose if φ mf t a is considered for t following 47 this will be the subject of another work to finish with the constant flux that can be observed at very short times in fig 11 for the square and the quadrangle should be discarded because they are artifacts related to the domain discretization the exchange affecting the first row of cells near the domain boundary only this was verified by further refining the mesh the plateau shifts to even shorter times 7 summary and discussion the long time relaxation of the napl saturation inside a matrix block in contact with water was studied in the case of counter current imbibition for one or two dimensional matrix blocks of arbitrary shape gravity effects were neglected so only the pure capillary regime was investigated the time variations of the matrix to fracture transfer flow rate was also studied the transition from a boltzmann square root regime to an anomalous algebraic power law decay was confirmed qualitatively and quantitatively by numerical simulations in the short time regime the semi infinite assumption is quite robust so the results may remain useful even considering general fractured media response in that regime on the other hand the long time decay exponent is directly related to input data combining capillary pressure and relative permeabilities features as in the long time regime the napl saturation is uniformly small inside the matrix block the power law assumption may be expected to be quite robust controlled by the low napl saturation transport properties the transition between both regimes is sharp occurring as soon as the toe of the short time boltzmann solution reaches half the block size the associated matrix to fracture flux term φ mf t closure may be represented as being proportional to s α 1 1 the exponent α 1 describing the singularity of the diffusion coefficient with napl saturation for general matrix blocks in 2 dimensions a similar study was carried out under the same counter current flow regime the occurrence of such regime appears to be quite general thanks to a derivation involving the global pressure concept a similar ansatz driving the long time regime was proposed it predicts a power law time dependency and the spatial dependence can be determined numerically using a fast fixed point algorithm these findings were confirmed by several comparisons with direct simulations for various typical matrix block shapes similar results are obtained for the time evolution of the corresponding matrix to fracture flux a quite sharp transition between a boltzmann regime involving a 1 t diffusion time dependence and the anomalous long time regime driven by the exponent 1 α 1 can be observed that transition corresponds to the interplay between the diffusion lengthscale and the characteristic size of the matrix block in summary a promising very fast and accurate computational approach is emerging which should eventually make it possible after some additional efforts to predict counter current imbibition over a distribution of blocks of various shapes and sizes which is more representative of naturally fractured porous media to this end the following points require further investigation a generalization of parlange s asymptotic early time solution in any dimension of space might be worth investigating although nothing simple is apparent at first sight late time estimates of t τ 0 such that the fixed point asymptotic solution obtained for t is valid and the flux prefactor a is accurately computed should be consolidated to that end the relevant characteristic length involved in the diffusion time τ 0 should be determined beforehand as previously discussed to make t τ 0 estimates generic indeed if the timescale differs from one geometry to another determining t τ 0 on a case by case basis may be tedious these findings pave the way to research leading to a more faithful description of matrix to fracture exchanges when considering a realistic fractured medium composed of a population of matrix block of various size and shapes in particular the proportionality constant relating the late time flux φ mf t to s α 1 1 appears to play a similar role than a shape factor that may be evaluated using single phase averaging techniques quintard and whitaker 1998 nœtinger et al 2001 2016 looking for simple geometric descriptors quantifying the transition time between diffusion regimes will be of interest for such applications in parallel developing averaging methods lumping these various matrix blocks within one macro scale single exchange flux description will be another research avenue credit authorship contribution statement f douarche investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing b braconnier investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing s momeni investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing m quintard investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing b nœtinger investigation conceptualization methodology formal analysis data curation resources visualization writing original draft writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper appendix conservative numerical scheme in this appendix we detail the numerical scheme used to solve the singular elliptic partial differential equation 12 in the matrix block domain ω we consider neither the boltzmann variable form 29 for short times nor the asymptotic form 23 for long times but the generic pde 12 that drives the solution s x t for all x and t the singular character of this equation comes from the diffusion coefficient d given by eq 13 which vanishes and is not differentiable with respect to s for s 0 1 except for particular values of the exponents r p and q because d cancels at the boundary ω of the porous medium one must have s ω in order to get a non zero fracture to matrix flux d s s ω as can be seen in fig 3 to prevent numerical instabilities or large rounding errors we set up a conservative scheme which does not require to compute the product d s s and is based on the following reformulation of eq 12 as a conservation law a 1 s t 2 g s where g s 0 s d s d s with s the normalized mobile aqueous phase saturation 8 the physical domain considered is ω with boundary conditions s x t 1 on the boundary ω for all t 0 to start with the function g defined in eq a 1 does not admit a simple expression that can be easily handled except in the limiting cases m 1 and m 1 g is then a power law or an incomplete beta function respectively where m is the mobility ratio defined in eq 19 to derive a conservative numerical scheme we resort to a discrete integration of the diffusion function d denoted g h to do so we discretize the normalized saturation interval 0 1 with the sequence s k k 0 n s k δ s composed of n s 1 points and where δ s 1 n s for convenience let us introduce the operator i g h which defines the discrete integral of g over two increasing saturation values s α and s β using the third order simpson s method i g h writes a 2 i g h s α s β s β s α 6 d s α 4 d s α s β 2 d s β for any saturation value s such that s s k s k 1 we approximate the function g s with g h s i g h s k s l 1 k i g h s l 1 s l regarding the domain ω discretization let m h be an admissible finite volume mesh of the domain ω given by a family of control volumes or cells noted k for any k of m h k is its measure k l k l is the common interface between k and a neighboring cell l the set of neighbors of cell k is denoted n k that is n k l m h k l 0 time is discretized with the non decreasing sequence t n such that t 0 0 and δ t t n 1 t n let also s i n be the approximation of the saturation on the interval c i t n t n δ t finally it is useful to introduce the vector s n such that s n i s i n in order to formulate the scheme vectorially partial differential equation a 1 is recast in a discrete manner with the following finite volume implicit scheme accounting for the boundary condition of an imposed saturation i e s x 0 t 1 x ω t 0 the numerical scheme can be written by introducing the function z n defined for all k m h as a 3 z n s k s k s k n 1 l n k λ k l g k g l λ k ω g k g 1 with g k g s k λ k l δ t k l k d k l where k l is the face measure and d k l the distance between the center of cells k and l the term λ k ω g k g 1 stands for the boundary condition contributions non null when the cell k is a boundary cell as we use polyhedral mesh cells it is the sum of several contributions if cell k has several boundary faces for each boundary face k j that contribution is δ t k j k d k k j where k j is the measure of the face and d k k j the distance between the cell center and the face the updated numerical solution s n of this numerical scheme is the zero of the function z n as this function is non linear because g s non linearly depends on saturation a newton raphson algorithm is required specifically for each time step we construct a sequence s n k such that z n k z n s n k k 0 and recursively defined by s n k 1 s n k δ s n k where δ s n k denotes the increment vector given by a 4 δ s n k s z n k 1 z n k where the matrix s z n k 1 is the inverse of the jacobian matrix s z n k s z n s n k the increment vector δ s n k is thus determined by solving a linear system the jacobian matrix is sparse and its non null terms are given by for all k m h a 5 s z n k k k 1 λ k ω l n k λ k l d k n k s z n k k l λ k l d l n k in addition as the function g is approximated numerically we used the function g h instead of g in relation a 3 to compute the newton residue z n k to end with the newton algorithm is performed until the l 2 norms of the residue z n k 2 and of the increment δ s n k 2 are sufficiently small a 1 cylindrical geometry for a cylindrical domain ω 0 r 0 2 π 0 h invariant by rotation and translation along the z axis the solution depends only on the radius r 0 r we therefore consider a uniform mesh composed of n 1 embedded cylinder of first cell k 0 0 δ r 2 0 2 π 0 h and the following embedded k i i 1 2 δ r i 1 2 δ r 0 2 π 0 h for 1 i n k where δ r r n k 1 2 after some straightforward calculations the scheme writes in the form a 3 with a 6 λ k 0 k 1 4 δ t δ r 2 λ k i k i 1 1 1 2 i δ t δ r 2 for 1 i n k λ k n ω δ t 1 1 δ r r 2 r δ r a 2 spherical geometry for a spherical domain ω 0 r 3 invariant by rotation we consider a uniform mesh composed of n 1 embedded sphere of first cell k 0 0 δ r 2 3 and the following embedded k i i 1 2 δ r i 1 2 δ r 3 for 1 i n k with δ r r n k 1 2 in this case the coefficients of the numerical scheme a 3 are a 7 λ k 0 k 1 6 δ t δ r 2 λ k i k i 1 i 1 2 2 i 1 2 3 i 1 2 3 3 δ t δ r 2 for 1 i n k λ k n ω 3 δ t 1 1 δ r r 3 r δ r 
97,recently developed remote sensing data including satellite based products show promising performance in estimating precipitation at high spatiotemporal resolution however the inherent uncertainties associated with indirect precipitation measurements can limit their applications in this study a novel approach based on regression based quantile mapping rqm combined with spatial interpolation and a clustering algorithm is proposed to adjust the spatial and temporal biases of integrated multi satellite retrievals for global precipitation measurement imerg v06 final run across canada from 2014 to 2018 at a daily time scale ground precipitation observed at a total of 530 gauges is provided by environment and climate change canada eccc a set of invariant and time varying topographic and climatic explanatory variables are selected and resampled to the satellite grid spatial resolution 0 1 to develop the rqm model the bias adjustment method is applied at gauged sites to estimate the parameters for different quantile levels of precipitation amounts the parameters are then interpolated for the ungauged grids based on the climatic similarities between different locations and the spatial distribution of rain gauges the proposed method shows promising results reducing the overall relative bias rbias by 32 and increasing the correlation by 0 31 for 2014 2018 the correlation coefficient cc values averaged over the clusters during the cold november to march and warm april to october months are improved by 167 from 0 3 to 0 8 and 50 from 0 6 to 0 9 respectively in terms of probability of detection pod and false alarm ratio far bias adjusted data indicates more than 50 improvement for all seasons the results indicate that the proposed approach can be applied for the bias correction of other remotely sensed products worldwide keywords precipitation imerg v06 regression quantile mapping covariate interpolation clustering canada data availability data is publicly available 1 introduction precipitation as one of the most significant component of the hydrological cycle is the main driver of water related hazards such as flooding and droughts mahmoudi et al 2021 singh et al 2022 accurate estimation of the precipitation amount is important for reliable risk analysis infrastructure design and planning and water resources management the conventional approach for precipitation measurement relies on ground based rain gauges however in situ observations are commonly sparse particularly in remote areas and complex terrains rainfall measurement undercatch can also undermine the quality of ground based precipitation observations at some locations duchon and biddle 2010 mekonen et al 2015 pollock et al 2018 ehsani and behrangi 2021 besides point measurements might not represent precipitation variations of the surrounding areas accurately derin et al 2016 radar and satellite records are promising alternatives that provide indirect estimates at high spatiotemporal resolution radar networks however are not available globally further the accuracy of ground based radar is undermined by beam blockage ground clutter and signal attenuation uijlenhoet and berne 2008 friedrich et al 2009 krajewski et al 2010 ryzhkov et al 2014 although satellite precipitation products spps are less influenced by radar sources of errors they are affected by the inherent remote sensing uncertainties due to the indirect estimation of precipitation the two corresponding types of errors include systematic errors which are constant and predictable and are associated with the sensors and instrumentation and random errors that are unpredictable and related to the spatial and temporal variations types and the heterogeneity of precipitation in the sensor footprint massari and maggioni 2020 in recent decades the application of spps has increased considerably in different parts of the globe several studies have attempted to evaluate and adjust the spps systematic biases using reliable ground based gauge and radar observations diaz nieto and wilby 2005 ines and hansen 2006 acharya et al 2013 hay et al 2000 lafon et al 2013 considering the spatial heterogeneity of precipitation events limitations in the availability of in situ observations and differences in spatial and temporal scales of satellite and in situ records comparisons between the two datasets and subsequent bias adjustment of satellite areal data can be challenging tang et al 2018 the bias adjustment approaches developed and applied for spps can be categorized into three general approaches the first approach uses rain gauge data directly to remove the spps mean bias values at a specific time scale e g daily monthly it has been commonly applied to adjust radar and satellite estimates smith and krajewski 1991 seo et al 1999 boushaki et al 2009 as well as global and regional climate model simulations which is also referred to as linear scaling hay and clark 2003 ines and hansen 2006 lenderink et al 2007 however both satellite and ground based data may not be available at a given location limiting the application of this method over sparsely gauged areas regions yang et al 2016 further it does not capture the temporal variabilities and cannot adjust the higher order moments in a simple form the method can be applied to adjust the spatially averaged biases over the region of interest seo et al 1999 which may not be suitable for large scale basins 5000 km2 with strong spatial variation in rainfall habib et al 2014 boushaki et al 2009 applied a merging method to adjust the biases in precipitation estimation from remotely sensed information using artificial neural networks cloud cluster system persiann ccs which was first introduced by hong et al 2004 in hourly temporal and 0 04 spatial resolution over the southwestern united states they used daily gridded climate prediction center cpc measurements as the true data the biases at daily temporal and 0 25 spatial resolution consistent with the original cpc data were adjusted and downscaled to 0 04 the daily biases were then redistributed proportionally to the hourly rainfall estimates the results indicated that the method could improve satellite precipitation estimates at a daily scale effectively however limited improvements were made at sub daily scales similarly ma et al 2020 developed a bias adjusted product the aimerg precipitation dataset 0 1 half hourly 2000 2015 asia that is spatiotemporally calibrated by gridded precipitation data based on ground observations from multi sources asian precipitation highly resolved observational data integration towards evaluation of water resources aphrodite 0 25 daily in daily scale over asia its quality was assessed using hourly observations from more than 50 000 meteorological stations over the six subregions of china in 2015 the second approach adjusts the biases of some stochastic model parameters related to rainfall occurrence and intensity by comparing them at the satellite s spatial scale müller and thompson 2013 it tunes the spatial patterns of parameters based on different regression based techniques such as stepwise regression step and geographically weighted regression gwr to find a relation between satellite precipitation and other covariates as well as interpolation techniques such as inverse distance weighting idw nearest neighbour and kriging to adjust the biases especially at ungauged grids yang et al 2016 lu et al 2019 müller and thompson 2013 applied a first order markov chain model to represent rainfall occurrence and spatially aggregated and interpolated the parameters to adjust the biases of satellite precipitation estimates in nepal they concluded that space variant adjustment schemes are effective in reducing the bias of the tropical rainfall measurement mission trmm bhatti et al 2016 interpolated the grid based bias estimates of the high resolution national oceanic and atmospheric administration s climate prediction centre morphing technique satellite rainfall product cmorph using the idw method to yield the distribution of grid based bias factor that covers the study area similar studies have been carried out considering stochastic variations or spatial heterogeneities vernimmen et al 2012 gumindoga et al 2019 yeh et al 2020 although this method is robust for estimating rainfall properties over minimally gauged regions by effectively combining satellite data with sparse rain gauge records it suffers from adjusting the biases in real time further it cannot capture the temporal variation of the true data and is incapable of adjusting the biases in the timing of the events ajaaj et al 2016 besides interpolation techniques may lead to additional uncertainties as the quality of interpolated precipitation in grid cells without gauges can be quite lower than that in grid cells with gauges tang et al 2018 the third approach applies quantile mapping qm to adjust the spps biases by changing the corresponding quantiles using ground based data the qm method adjusts the mean variance and higher moments of the corresponding distribution it has been reviewed in the context of hydrological impact studies and found to outperform simpler methods that adjust only the mean or variance of precipitation series gudmundsson et al 2012 teutschbein and seibert 2012 qm has been widely used in previous studies and is considered an effective approach to reducing systematic biases of regional climate model simulations and remotely sensed rs precipitation estimates cannon et al 2015 ajaaj et al 2016 yang et al 2016 ringard et al 2017 katiraie boroujerdy et al 2020 although this technique can effectively represent the evolution of the mean and the variability of precipitation ajaaj et al 2016 the adjustments to the temporal structure of precipitation are missing resulting in a misrepresentation of wet and dry spell lengths ringard et al 2017 applied the qm method to adjust the daily rainfall estimates from trmm multi satellite precipitation analysis research version 7 mpa 3b42v7 the method reduced 70 of the biases in rainfall intensities less than 25 mm d however it showed weaker performance for more intense events yang et al 2016 proposed a coupled nonparametric qm and gaussian weighting interpolation scheme to adjust the biases of persiann ccs over chile shen et al 2021 also proposed a cumulative distribution function cdf based approach based on a self adaptive moving window which systematically integrates the china gauge based daily precipitation analysis cgdpa into the real time trmm mpa to reduce the systematic biases of multi satellite precipitation estimates recent studies have applied merging techniques using different sources of precipitation data or machine learning algorithms for spp bias adjustments for example xu et al 2021 improved the quality of integrated multi satellite retrievals for the global precipitation measurement imerg late run spps by merging with ground based gauge precipitation data similar analyses have been performed by ma et al 2018a 2022a 2022b and lyu et al 2020 yang et al 2022 established a bidirectional long short term memory recurrent network bi lstm framework for the bias adjustment of spps without using ground based gauge observations other machine learning algorithms have been applied by tao et al 2016 le et al 2020 and chen et al 2021 it was found that machine learning can capture the error structure of satellite retrievals of precipitation however major challenge of machine learning lies in the lack of physical interpretability of models xu and liang 2021 moreover further research is required to address the limitations associated with uncertainties caused by low quality and small sample sizes of ground truth data for training xu et al 2019 le et al 2020 chen et al 2021 determining the input features or optimize the model structures and hyper parameters which are application specific li et al 2021 xiao et al 2022 and reducing computational costs kim et al 2022 building on the previous analyses this study proposes a novel framework to address several limitations in current bias adjustment techniques by adjusting both spatial and temporal variations of spps at both gauged and ungauged sites we combine the strengths of quantile regression quantile mapping spatial interpolation and clustering despite its common use qm has a critical limitation in adjusting the temporal structure of precipitation resulting in a misrepresentation of its temporal variability this limitation may not capture systematic biases well and distort the occurrences of the daily precipitation events ajaaj et al 2016 to address these problems this study introduces the use of regression quantile mapping rqm a qm approach based on linear regression models for spp bias adjustment the proposed framework incorporates a suite of invariant and time varying covariates to adjust the spp estimates across the study domain i e canada as well as the timing of rainfall events at a daily time scale it removes systematic biases besides adjusting time or state dependent errors reflected by six time varying climate predictors as covariates further to extend the bias adjustment to ungauged sites we combined rqm with clustering and spatial interpolation techniques based on a suite of invariant covariates selected from a reanalysis product in the remainder of this paper we describe the ground based and remotely sensed satellite data in section 2 the proposed methodology is presented in section 3 followed by the results discussions and conclusions in sections 4 5 and 6 respectively 2 study area and data 2 1 study area the study area is the entire territory of canada the second largest country in the world with an area of 9 9 million km2 canada is surrounded by the pacific ocean in the west the atlantic in the east and the arctic in the north fig 1 the country has a diverse hydroclimate due to its extensive geographical features latitudinal extent and topographic variations considering the diverse climatic conditions as well as extreme weather events experienced over most parts of the country each year jalili and najafi 2020 singh and najafi 2020 singh et al 2021 reliable precipitation measurements are of great importance 2 2 data 2 2 1 ground based observations environment and climate change canada eccc provides hourly ground based precipitation records from the automatic gauge station network the network consists of 585 rain gauge stations located across canada including both surface weather and reference climate stations rcs fig 1 eccc operates and controls the quality of ground observations to correct the existing errors in the rcs weather stations after 2014 however prior to this year quality checks were not implemented at the time this study was conducted eccc 2018 we select 530 station records with less than 10 missing data for each month during the 5 years from 2014 to 2018 bias adjustment and its evaluation are conducted on a daily time scale based on the aggregation of hourly data 2 2 2 imerg satellite data in this study the recently released version of imerg v06 data is bias adjusted based on the ground records the imerg data shows better performance than the other gridded precipitation datasets such as global satellite mapping of precipitation gsmap and persiann ccs at both daily and hourly scales gao et al 2020 xu et al 2022 the imerg v06 satellite data covers the entire globe from 90 s to 90 n latitude with early 4 h after observation time late 14 h after observation time and final 3 5 months after the observation time runs to accommodate different user requirements for latency and accuracy tan et al 2019 among these three types the final run data with high spatial 0 1 and temporal 30 min resolution is selected due to its better accuracy moazami and najafi 2021 half hourly precipitation estimates are aggregated to a daily time scale for the application of the bias adjustment method in this study among 585 eccc automatic stations 71 gauges participate in the global precipitation climatology center mekis et al 2018 therefore 90 of gauges considered in this study have not been used for imerg calibration and are independent of the evaluated datasets more detailed information on the satellite data used in this study is described in moazami and najafi 2021 2 2 3 narr reanalysis data the north american regional reanalysis narr project is an extension of the national centers for environmental prediction ncep global reanalysis over north america it provides estimates of a suite of variables from 1979 until near present at 32 km 0 3 resolution and three hourly daily and monthly time scales based on the northern hemisphere lambert conformal conic grid in this study we use both daily and monthly products at different stages of the bias adjustment approach table 1 describes the characteristics of the 15 covariates from narr considered in this study among them six variables are involved in deriving the regression model r and nine variables were involved in clustering c and spatial interpolation i these covariates are selected based on the variance inflation factor vif described in section 3 2 we incorporate daily explanatory variables time varying covariates obtained from narr in the rqm approach discussed in section 3 to derive bias adjusted satellite estimates for both gauged and ungauged grids further long term monthly mean invariant covariates of selected narr covariates are considered to estimate the climatic distance between satellite grids and perform clustering in the interpolation process the first group of narr variables used for derivation of the regression model includes 1 daily accumulated total precipitation daily mean values of 2 convective potential energy barry and chorley 1998 3 non convective cloud cover 4 dew point temperature at 2m height 5 specific humidity at 2m height 6 vertical velocity the second group used for clustering and interpolation includes invariant parameters such as 1 elevation of ground and the long term monthly mean values of 2 total precipitation 3 convective potential energy 4 non convective cloud cover 5 dew point temperature at 2m 6 specific humidity at 2m height 7 shortwave radiation flux kantha and clayson 2000 8 geopotential height hofmann wellenhof and moritz 2005 and 9 vegetation index green vegetation fraction gvf huete et al 2002 3 methodology we develop a two stage spatial and temporal bias adjustment framework in which the satellite data are adjusted at rain gauge locations followed by the adjustment at ungauged areas the framework integrates the rqm approach passow and donner 2020 with clustering and interpolation techniques and incorporates both constant and time varying predictors the components of the framework and the corresponding modelling stages are shown in fig 2 at first hourly ground based and half hourly satellite precipitation data are aggregated to a daily time scale for the five years from 2014 to 2018 daily data records corresponding to the stations satellite product and narr climatic covariates are extracted at each gauged grid long term monthly averages as invariant covariates are also extracted and resampled at each satellite grid next the rqm model is derived with the daily ground satellite and covariate data and applied to each cdf segment which will be described in section 3 2 separately at gauged grids parameters of the rqm model at all the bias adjusted gauged grids are extracted to interpolate extrapolate over ungauged grids across each cluster separately using the idw method here clusters are inferred using k means based on the climatic distance between locations according to invariant covariates after that the interpolated bias adjusted parameters of the rqm model are applied to the time varying covariates at each ungauged grid to obtain bias adjusted satellite estimates at those grids lastly the performance of our proposed approach is evaluated through cross validation by comparing the bias adjusted satellite estimates at randomly selected gauged grids that are assumed to be ungauged grids and not considered in model training with the corresponding ground observations fig 2 each step of the modelling framework is described in the following sections 3 1 linear quantile regression given a vector y of n continuous random variables yi i 1 n with cdf f y i y p y i y the τth quantile q y i τ of yi is defined as 1 q y i τ f y i 1 τ i n f y ϵ r τ f y i y where the infimum inf is the greatest element in y ϵ r that is less than or equal to all elements of y ϵ r τ f y i y τε 0 1 and f y i 1 is the quantile function i e the inverse cdf of yi in linear quantile regression qr q y i τ is assumed to depend linearly on a vector of p predictor variables xi x i1 xip t such that 2 q y i τ x i x i t β τ where βτ βτ 1 βτ p t is a vector of unknown regression parameters estimated by solving the minimization problem 3 β τ argmin β τ ϵ r p i 1 n ρ τ y i x i t β τ where ρτ z is a linear loss function defined as z τ 1 if z 0 and zτ otherwise here z is a residual between yi and x i t β τ a comprehensive description of the theory application and interpretation of quantile regression can be found in koenker 2005 qr estimates the conditional sample quantile q τ for individual τ values rather than the full conditional distribution of yi since equation 3 is solved separately for each desired τ the estimated quantile functions may intersect with each other in such a case a quantile of a higher order may switch places with a quantile of a lower order a well known problem in qr called quantile crossing qc several approaches are available to avoid qc he 1997 yuan 2006 liu and wu 2009 bondell et al 2010 cannon 2018 here a smoothing spline is considered to smooth the conditional distribution and reduce the possibility of qc see section 3 2 we apply the qr approach considering a linear relationship between the predictors covariates and precipitation dependent or response variable 3 2 regression quantile mapping rqm in this study the rqm approach a novel method that combines qm with regression modelling is proposed to adjust the conditional inverse cdfs of satellite precipitation estimates in addition to removing the overall systematic biases of spp the time varying errors are also adjusted using climatic time varying covariates denoted by x 4 y s f y o x 1 f y s x y s where ys is the quantile of original satellite data f y s x is the cdf of satellite original data conditional on the time varying covariates x f y o x 1 is the inverse cdf or quantile function of the ground observations yo conditional on x and y s is the obtained bias adjusted satellite data the main advantage of the qm method is that it can effectively capture the evolution of mean and variability of spps while adjusting all statistical moments cannon et al 2015 however it may distort the occurrences of the daily precipitation events ajaaj et al 2016 besides qm is unable to adjust estimated values outside the codomain of the observations passow and donner 2020 therefore the linear regression model is combined with qm to adjust the magnitude and timing of imerg precipitation estimates the linear regression model rm establishes the linear relation between independent and dependent variables for each quantile eq 2 in this study ground based precipitation or spp is a dependent variable and multiple time varying climatic predictors are independent variables rm is derived for ground based and satellite records separately with sharing same set of time varying climatic predictors as independent variables eq 6 then the two rms are combined based on qm which is described as eq 4 therefore rqm algorithm which is a combination of rm and qm provides the adjusted predictive cdfs of the corresponding spp at each location with the predictive cdfs rqm enables spp adjustments using transfer functions conditional on time varying covariates using eq 4 it not only removes systematic biases but also adjusts time or state dependent errors reflected by climate variables as covariates resulting in an adjustment of the magnitude and timing of spps simultaneously a set of covariates at a daily scale introduced in section 2 are selected to develop the regression model covariates are selected based on the correlation strength between each independent variable and local precipitation the effects of multicollinearity between multiple independent variables are quantified using the variance inflation factor vif a vif value of 1 indicates no correlation between a specific independent variable and others vifs between 1 and 5 suggest moderate multicollinearity effects the values greater than 5 indicate critical levels of multicollinearity that can result in poorly estimated coefficients and inaccurate p values among 15 climatic variables 6 are selected to derive the regression model which showed the highest correlation with satellite and observed precipitation values individually and had vif values less than 5 to determine the conditional and inverse cdfs we combine qr with a nonparametric smoothing spline estimator let τ1 τ k be a set of quantiles where τ ϵ 0 1 and τ1 τ k qr is applied to each time series yo and ys to estimate the regression parameters 5 β τ z β τ 1 z β τ k z t for the ground observed z o and satellite z s data for each τi separately the qr model with parameters estimated in eq 5 is applied to predict the quantile curves q τ at each month t for the 5 year period tp based on the time varying covariates xp and their corresponding time dependent effects i e β τ o a n d β τ s as 6 q τ z t x p β τ z t t p based on eq 6 two quantile curves corresponding to the ground based and satellite precipitation data are obtained q τ o and q τ s using the same set of time varying covariates xp over the study period tp to obtain a continuous approximation of f y o x 1 and provide estimates for unknown quantile values we use the smoothing spline estimator b splines are applied as the basis functions because of their flexibility and fast computation de boor 1978 ramsay et al 2009 we adopt cdf segmentation to better transfer statistical characteristics of ground observation to satellite estimates the idea of using partitioned cdf in this study comes from grillakis et al 2013 they presented an improved quantile mapping based bias correction method named multi segment statistical bias correction msbc quantile mapping for general circulation model gcm simulated daily precipitation they used different instances of gamma function that were fitted on multiple discrete segments of the precipitation cdf instead of the common approach that uses one distribution to fit the entire cdf we split the precipitation cdf into five equal discrete sequential segments from 0 to 0 2 0 21 to 0 4 0 41 to 0 6 0 61 to 0 8 and 0 81 to 1 then rqm is performed at each segment separately to correct the cdf of satellite data in the range of that segment 3 2 1 interpolation of regression model parameters over ungauged locations after developing the rqm model at gauged locations the estimated parameters of rqm model are interpolated extrapolated for ungauged sites the satellite data are clustered based on the euclidean distance in the climate space using the k means clustering method a set of nine invariant covariates table 1 at the monthly time scale from the narr data resampled to grid cells at 0 1 degree resolution consistent with imerg is used to calculate the climatic distance between satellite grids based on the silhouette criterion an optimal number of nine clusters is obtained rousseeuw 1987 the parameters of rqm model estimated at gauged grids are interpolated to ungauged grids across each cluster bias adjusted satellite precipitation at ungauged grids is obtained by applying the interpoltated parameters to time varying climate predictors at the ungauged grids the flowchart in section 3 fig 2 clearly shows a whole procedure of bias adjustment for ungauged grids including spatial interpolation in this study we use the idw interpolation method to determine the parameters of the rqm model at ungauged locations across each cluster idw is a deterministic spatial interpolation approach to estimate an unknown value at a location using some known weighted values at other locations eq 7 idw is simple and easy to compute and straightforward to interpret mueller et al 2004 lu and wong 2008 even though kriging or regression could be alternatives it is known that idw can also produce equally good representation of spatially distributed rainfall dirks et al 1998 kong and tong 2008 kurtzman et al 2009 wu et al 2010 for the purpose of spp bias adjustment the idw is shown to be an effective method bhatti et al 2016 alharbi et al 2018 let x be an unknown value at a location w be the weight and x the known point values in neighboring sites the weight is the inverse distance between the ungauged grid and each gauged grid eq 8 7 x w 1 x 1 w 2 x 2 w n x n w 1 w 2 w n 8 w i 1 d i x p where d is the distance between ungauged and gauged locations and x is the parameters of the rqm model at ungauged cells here we use climatic distance which could bear important information in describing the latent spatial dependence between gauged grids and ungauged grids cooley et al 2007 a higher p i e power value results in a lower weight we determine the optimum p by taking a portion of sample points as a testing validation dataset the idw interpolation is applied considering different p values a p value of 2 results in the smallest difference between the interpolated and actual data i e the lowest rmse and is therefore selected in this study 3 3 performance verification the widely used continuous metrics including the root mean square error rmse relative bias rbias pearson correlation coefficient cc and kling gupta efficiency kge are applied to measure the accuracy of the estimated precipitation magnitudes from the original and bias adjusted imerg product rbias describes the systematic biases of imerg rmse is used to measure the average of the squares of error cc characterizes the degrees of consistencies in temporal variabilities and kge combines the three components of model errors i e correlation bias ratio of variances or coefficients of variation in a more balanced way to measure the ability of imerg data to detect rain no rain events based on a threshold of 0 1 mm d 1 three categorical metrics are used which include the probability of detection pod false alarm ratio far and heidke skill score hss the equations and a brief description of these metrics are listed in table 2 taylor diagrams for each cluster are also used for the performance assessment we evaluate the performance of the bias adjustment approach using cross validation in which 10 of gauged grids within each cluster are bias adjusted based on information from other gauged locations the parameters estimated at the 90 gauged grids are interpolated over the 10 randomly selected grids that are assumed to be ungauged the covariates at the selected grids are then applied based on the interpolated parameters to adjust the satellite data at ungauged locations finally we compare the bias adjusted spp with observed gauge records and evaluate the performance using metrics provided in table 1 this process is repeated 1000 times based on the bootstrapping method 4 results the results of the proposed rqm method are discussed for gauged grids which include at least one rain gauge and for randomly sampled ungauged grids that are bias adjusted based on interpolated parameters in each cluster fig 3 the performance of the rqm method is quantitatively evaluated by comparing bias adjusted satellite precipitation with ground observations based on the metrics provided in table 2 and the taylor diagram all the metrics estimated at each grid in a daily time scale are summarized by boxplots for each month and cluster the mean values of metrics are provided as supplementary information tables s1 and s2 as shown in table 3 the total number of grids and the number of gauged grids are different between clusters which can affect the interpolation of rqm parameters and the overall performance of the bias adjustment approach in different areas clusters no 3 5 and 6 located in high latitudes have relatively lower gauge densities than clusters no 7 8 and 9 located in low latitudes 4 1 bias adjustment at gauged locations the time series of the original hereafter imerg ori and bias adjusted hereafter imerg bc imerg precipitation products at gauged grids in each cluster are compared with the corresponding ground based observations for each month from 2014 to 2018 in all clusters imerg ori over or under estimates the observed precipitation overall the magnitude and to a larger extent the timing of precipitation occurrence are improved in imerg bc in all months especially in clusters no 2 4 5 7 and 8 in eastern and western regions figure s1 further comparisons between precipitation rates an amount of precipitation per day mm day for each month show clear improvements in imerg products based on the proposed rqm approach imerg bc closely follows the observed temporal patterns however it underestimates the magnitude of precipitation in some clusters particularly in central canada 4 1 1 statistical evaluation precipitation estimates from imerg ori and imerg bc are assessed using cc rbias rmse and kge at each cluster and each month figs 4 5 s2 s3 the performance metrics are based on daily gauged grids located within each cluster each month rqm significantly improves the precipitation estimates according to these performance metrics for example in cluster no 1 the overall cc value is increased from 0 49 imerg ori to 0 85 imerg bc and the rmse is reduced from 2 9 to 1 5 mm d average value of all months these improvements are promising especially in the cold months november to march for which the performance of imerg is weak with lower correlation and higher biases moazami and najafi 2021 similarly imerg bc shows significant improvements over imerg ori in cluster no 2 southeastern part of the country based on kge an overall increase from 0 30 to 0 69 and rmse decreases from 8 2 to 4 6 mm d improvements in the imerg precipitation estimates based on the rqm bias adjustment approach are shown for all clusters using cc rmse rbias and kge in table s1 the cc values averaged over the clusters during the cold november to march and warm months april to october are improved by 167 from 0 3 to 0 8 and 50 from 0 6 to 0 9 respectively as discussed in the previous section different levels of precipitation are adjusted separately based on cdf segmentation therefore the rate of precipitation does not have a considerable effect on the adjustment the mean rbias values also show improvements based on the rqm bias adjustment approach except for clusters no 2 5 6 and 8 table s1 although the rmse kge and cc metrics show improved performance this is due to the variation of rbias values from negative to positive ranges in some months which generally leads to the lower mean values as shown in the boxplots figure s3 fig 6 shows taylor diagrams of daily imerg ori and imerg bc against gauge observations in each cluster each taylor diagram has a total of 24 dots which are 12 sets for each month with blue dots corresponding to the bias adjusted satellite precipitation and red dots to the original satellite precipitation overall bias adjusted satellite precipitation shows a higher correlation with ground observation and less centered rmse crmse from observation than original satellite estimates among nine clusters the difference between original and bias adjusted satellite precipitation is relatively larger for clusters 7 and 9 with a high density of gauge network in low latitude but smaller for clusters 1 3 and 6 with sparse gauge network in high latitude these results show the importance of gauge network density in improving the performance of the rqm method 4 1 2 evaluating the spatial pattern of precipitation we further evaluate the seasonal precipitation estimates from imerg ori and imerg bc at gauged grids across canada figs 7 9 s4 s5 show the results based on rmse cc hss pod and far respectively overall the performance metrics show significant improvements especially over interior plains imerg bc satellite precipitation data bias adjusted based on rqm has significantly lower rmse values compared to imerg ori particularly over the west and east coasts the spatial pattern of rmse corresponding to bias adjusted data follows that of the original data but with improved performance for example both imerg ori bc have higher lower rmse values during summer winter respectively fig 7 the improvement is notable based on cc with most sites showing correlation values greater than 0 7 imerg ori has a very low correlation during winter while imerg bc s precipitation estimates are much more temporally consistent with the observed data fig 8 hss and pod corresponding to imerg bc are in good agreement with the gauge observations during all seasons with values more than 0 8 over most grids figs 9 and s4 imerg ori s performance in detecting the precipitation events is relatively weak particularly in cold seasons both hss and pod values for winter are below 0 2 the difference between imerg ori and imerg bc is larger for hss than pod indicating that the bias adjustment performance becomes stronger when the random chance of precipitation occurrence is excluded further the far metric shows reasonable values less than 0 2 associated with imerg bc for all seasons while it is generally more than 0 4 for imerg ori data indicating larger errors in detecting precipitation events i e false detection overall the bias adjustment technique proposed in this study considerably improved the estimates of precipitation intensity as well as the detection of precipitation occurrence across canada 4 2 bias adjustment at ungauged sites the parameters obtained from rqm developed over the gauged locations are applied to adjust imerg data in areas without ground based observations the performance of the bias adjusted product over ungauged areas is evaluated using cross validation in each cluster 10 of gauged grids are randomly selected and the corresponding ground observations are assumed to be unknown the rqm parameters estimated from other gauged locations are interpolated to adjust the ungauged imerg data the original and bias adjusted imerg are then evaluated based on the existing ground observations this bootstrapping process is repeated 1000 times the following results represent the average value of the 10 ungauged grids i e validation grids overall the results show improved performance of imerg bc in representing the observed precipitation climatology compared to imerg ori over all clusters figure s6 4 2 1 statistical evaluation fig 10 compares the cc values of original and bias adjusted imerg data against gauge observations for validation grids across different clusters overall the mean correlation coefficient values associated with imerg bc are higher than the ones corresponding to imerg ori by 16 imerg bc shows slightly lower performance in terms of cc in a few warm months in clusters no 5 6 where gauge density is sparse besides clusters no 7 8 show relatively consistent and higher bias adjustment performance regardless of seasons this might be partly because of the number of gauged observations in these clusters compared to the others that can affect the reliability of the interpolated parameters in these areas table 3 the sparse gauge density at ungauged site is the more lack of known information and higher uncertainty of spatial interpolation figs 11 and 12 show the performance of imerg bc against imerg ori based on rmse and kge respectively in cluster no 1 the mean value of rmse over all months is improved by 16 from 2 4 in imerg ori to 2 0 in imerg bc the mean value of kge over all months in cluster no 1 is also improved by 19 from 0 195 in imerg ori to 0 241 in imerg bc further in most clusters the rates of improvement by bc are above zero table s2 however only cluster no 5 indicates higher rmse values corresponding to imerg bc than imerg ori with rates of 10 the mean value of kge in cluster no 5 also decreases by 24 from 0 844 in imerg ori to 1 113 in imerg bc overall the bias adjustment approach has improved the satellite estimates over ungauged locations by 15 based on rmse kge shows higher performance of bias adjustment particulararly in cold months november to march improved by 24 from 0 200 in imerg ori to 0 153 in imerg bc imerg bc outperforms imerg ori in terms of rbias in most areas especially for clusters no 1 2 and 8 with improvements in 70 of the months figure s7 however clusters no 4 5 and 6 show higher rbias values in imerg bc in almost 50 of the months there is not any consistency between cc and rbias as the underestimation overestimation of both imerg ori and imerg bc data leads to negative positive values of rbias that may decrease increase its mean value in clusters no 1 2 3 and 8 imerg bc has lower rbias values of 0 031 0 024 0 020 and 0 083 respectively while the values corresponding to imerg ori are 0 320 0 079 0 061 and 0 215 in other clusters like no 5 and 6 imerg bc shows relatively high rbias with values of 0 559 and 0 321 compared to values of 0 785 and 0 238 in imerg ori this suggests that the bias adjustment performance could be restrained for the regions with sparse gauge networks overall there is a 66 improvement considering the entire regions and all months mean rbias of imerg bc ori are 0 071 and 0 211 respectively table s2 lists the spatial mean values of cc kge rbias and rmse performance metrics at validation grids for each cluster further we evaluate the performance of the bias adjustment method developed in this study over the ungauged grids by comparing the spatial average quantiles of imerg ori and imerg bc data against gauge observed precipitation at all clusters the satellite estimates closely represent the quantiles of observed data after bias adjustment while imerg ori shows significant under or over estimations figures s8 the empirical cdf ecdf associated with the observed data is compared with the corresponding imerg ori and imerg bc estimates figure s9 shows the ecdfs based on spatially average daily precipitation during the five years at each cluster the observed and imerg bc cdfs closely match all clusters except in cluster no 5 in which imerg bc shows an underestimation imerg ori however tends to systematically overestimate the ground based daily precipitation over clusters no 1 to 5 and 8 and underestimate it over clusters no 6 7 and 9 respectively 5 discussion in this study a novel approach based on regression model based quantile mapping is proposed to adjust biases of spp at un gauged locations across canada and the performance is evaluated through cross validation in summary the evaluation results show the promising performance of rqm for both gauged and ungauged sites for the case of gauged grids the magnitude and to a larger extent the timing of precipitation rates are improved in all months especially in clusters no 2 4 7 and 8 in eastern and western regions figs 7 9 bias adjusted imerg precipitation closely follows the observed temporal and spatial patterns however it underestimates the magnitude of precipitation in some clusters particularly in central canada rqm significantly improves the satellite precipitation estimates according to the performance metrics particularly in the cold months for example the mean kge value for every month and cluster highly increases from 0 2 imerg ori to 0 63 imerg bc hss corresponding to imerg bc is in good agreement with the gauge observations during all seasons with values more than 0 7 over most grids imerg ori s performance in detecting the precipitation events is relatively weak particularly in cold seasons those for the ungauged locations also show the improvement of bias adjusted imerg overall the bias adjustment technique proposed in this study considerably improves the estimates of precipitation intensity as well as the detection of precipitation occurrence across canada higher improvement of bias adjustment performance especially in cold months november to march in high latitudes is due to the weak performance of spp the weak spp performance in high latitudes can be associated with the high uncertainty of imerg precipitation retrieval at snow and ice surface errors of imerg can be traced from the passive microwave pmw sensors they use the pwm retrieval which is in contact with the precipitation particles has problems in distinguishing between precipitation and frozen surface chen et al 2019 furthermore imerg v06 which is used in this study has gaps over snow and ice surfaces poleward of 60 latitude where pmw have a low quality ehsani et al 2021 huffman et al 2019 stated that all merged pmw estimates have low accuracies in regions with frozen or icy surfaces the weaker performance of imerg estimates in cold months has also been indicated by sadeghi et al 2019 based on the latest comprehensive evaluation study of imerg v06 moazami and najafi 2021 the performance of imerg products is mostly consistent during fall spring and summer with weaker performance in winter therefore the bias adjustment performance in winter is improved relatively higher than in other seasons due to the low accuracy of imerg v06 in cold months even though overall biases of satellite precipitation are considerably reduced the performance of imerg bc in cold months is still lower than in warmer months these results are caused by combined errors from ground observation and satellite products as rqm uses both ground and satellite precipitation data high uncertainty of imerg products in cold months can negatively affect the bias adjustment performance the other source of higher biases of imerg bc in winter is the lack of reliable ground based precipitation observations during cold seasons precipitation gauges across most parts of canada show poor performance in solid precipitation measurement moazami and najafi 2021 besides even though we use the quality controlled precipitation data observed at ground gauges some inherent systematic errors such as undercatch remain undercatch is considered to be the most significant systematic error resulting in an underestimation of actual precipitation in gauge measurements benning and yang 2005 rasmussen et al 2012 the reason of undercatch problem could be the deformation of the local wind field by the elevated gauge that results in the deformation of rain particle trajectory sevruk et al 2009 mekonen et al 2015 pollock et al 2018 it could also stems from missed measurements during the finite time required for the bucket to tip from one side to the other duchon and essenberg 2001 duchon and biddle 2010 the use of appropriate adjustment methods such as legates correction factor developed by legates and willmott 1990 or fuchs correction factor proposed by fuchs et al 2001 to mitigate the precipitation undercatch can have a large impact on the accuracy of observed precipitation ehsani and behrangi 2021 quality control of ground observations is an ongoing task to improve for higher performance of remotely sensed products bias adjustment differences in spatial resolution between point based ground gauges and areal imerg estimates can also contribute to the uncertainties which can be investigated in future studies as mentioned before the performance of spp bias adjustment highly depends on the accuracy and density of ground based observation therefore adding more station gauges in high latitude regions or improving the quality of gauge precipitation observations is recommended other challenges associated with rainfall undercatch evaporation wetting losses orographic effects and sparse gauge density can still affect the bias adjustment performance metcalfe et al 1997 devine and mekis 2008 mekis et al 2018 the method proposed in this study could give reasonable bias adjusting performance with other satellite products as well it is promising to be applied in continental scale or even global by dividing the large territory into several clusters based on climatic distance which considers climatic dis similarities between grids nevertheless it should be noted that invariant or long term climatic predictors for clustering must be carefully determined reliable ground based observation gauge precipitation and covariates are also needed plus if interpolation gives low performance for ungauged locations the other interpolation methods should be considered in this study we apply the proposed bias adjustment approach on imerg satellite precipitation estimates at a daily scale we target daily time scale as reliable precipitation estimates at daily scales are critical for hydrological modelling analyses and water resources management behrangi et al 2011 ma et al 2018b maggioni and massari 2018 yuan et al 2018 yeh et al 2020 secondly our analyses at daily scales is consistent with majority of the previous studies that developed and assessed bias adjustment methods targeting daily satellite estimates boushaki et al 2009 casse et al 2015 valdes pineda et al 2016 worqlul et al 2018 ma et al 2020 yang et al 2022 furthermore moazami and najafi 2021 investigated the performance of gpm imerg v06 precipitation estimates over canada for 2014 2018 in both hourly and daily scale and highlighted several issues associated with ground observations at subdaily scales especially during cold seasons besides it should be noted that the highest temporal resolution of narr data which was used as covariates in this study is 3 hours mesinger et al 2006 for hourly analyses other products such as era 5 can be considered hersbach et al 2020 considering the above we opt to do bias adjustment at daily scale in this research but will consider extending it to subdaily scale in a future research work because of the importance of reliable hourly precipitation products for flash flood assessments 6 summary and conclusion in this study a novel statistical approach is proposed to adjust the biases of imerg satellite products and provide reliable high resolution remotely sensed data over canada imerg and ground based precipitation data and a set of invariant and time varying reanalysis covariates resampled to match the satellite spatial resolution 0 1 considered as independent variables are used to develop a regression based quantile mapping model the k means clustering technique is applied to categorize the study area based on the climatic similarities and ground observations between satellite grids as well as the spatial distribution of rain gauges first the bias adjustment method is implemented at each cluster and the related parameters obtained from the gauged grids for different quantile levels of precipitation data are estimated then using idw the parameters are interpolated over the ungauged grids in the corresponding cluster to apply the idw technique we consider the climatic distance based on the set of covariates selected from the reanalysis product instead of geographical distance finally by applying the reanalysis covariates at each ungauged grid in the interpolated model parameters of that grid the bias adjusted satellite data was obtained the performance of the developed model at ungauged grids is evaluated using cross validation 10 of gauged grids at each cluster are selected randomly and assumed to be ungauged grids the satellite product is then bias adjusted at these validation grids based on parameters estimated from other gauged locations overall the results for both gauged and validation grids show major improvements in the intensity and occurrence of bias adjusted imerg precipitation estimates especially over regions where the original data shows relatively low performance e g western canada and coastal areas further the variation of precipitation time series is well captured by the bias adjusted data however the bias adjustment approach did not perform well in northwest regions where there are only a few stations available that are unevenly distributed the large uncertainties in the interpolated information can undermine the reliability of bias adjusted data at ungauged sites besides the diversity in the topographic and climatic conditions in these regions makes it challenging to find the accurate climatic distance between the grids the point scale measurements of ground observations unevenly dispersed gauge records across the country and the spatio temporal variability of precipitation are other sources of uncertainties associated with the reference data particularly during winters and for solid precipitation for detailed information see rasmussen et al 2012 mekis et al 2018 moazami and najafi 2021 from the results of this study we can conclude that rqm adjusts the magnitude and timing of satellite precipitation estimates simultaneously to provide the adjusted predictive cdfs of satellite precipitation further this approach is capable of adjusting spps at locations where ground based observations are lacking by pooling information from other station records this procedure addresses a major limitation of conventional methods that are incapable of adjusting spps at ungauged locations the proposed bias adjustment approach and the generated products can be applied by researchers and stakeholders for the adjustment and analysis of extreme precipitation events water resources management and design of infrastructure in canada as well as other countries around the globe eq 1 declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement this project was funded by an nserc alliance grant through a collaboration with the institute for catastrophic loss reduction iclr the imerg dataset was downloaded from the precipitation measurement mission pmm websites https pmm nasa gov data access downloads gpm and ftp arthurhou pps eosdis nasa gov gpmdata the station dataset was downloaded from eccc websites the authors would like to thank kh yau bridget thomas and chantale cerny from eccc for their support in accessing the ground precipitation dataset and for providing information about their quality supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2022 104300 appendix supplementary materials image application 1 
97,recently developed remote sensing data including satellite based products show promising performance in estimating precipitation at high spatiotemporal resolution however the inherent uncertainties associated with indirect precipitation measurements can limit their applications in this study a novel approach based on regression based quantile mapping rqm combined with spatial interpolation and a clustering algorithm is proposed to adjust the spatial and temporal biases of integrated multi satellite retrievals for global precipitation measurement imerg v06 final run across canada from 2014 to 2018 at a daily time scale ground precipitation observed at a total of 530 gauges is provided by environment and climate change canada eccc a set of invariant and time varying topographic and climatic explanatory variables are selected and resampled to the satellite grid spatial resolution 0 1 to develop the rqm model the bias adjustment method is applied at gauged sites to estimate the parameters for different quantile levels of precipitation amounts the parameters are then interpolated for the ungauged grids based on the climatic similarities between different locations and the spatial distribution of rain gauges the proposed method shows promising results reducing the overall relative bias rbias by 32 and increasing the correlation by 0 31 for 2014 2018 the correlation coefficient cc values averaged over the clusters during the cold november to march and warm april to october months are improved by 167 from 0 3 to 0 8 and 50 from 0 6 to 0 9 respectively in terms of probability of detection pod and false alarm ratio far bias adjusted data indicates more than 50 improvement for all seasons the results indicate that the proposed approach can be applied for the bias correction of other remotely sensed products worldwide keywords precipitation imerg v06 regression quantile mapping covariate interpolation clustering canada data availability data is publicly available 1 introduction precipitation as one of the most significant component of the hydrological cycle is the main driver of water related hazards such as flooding and droughts mahmoudi et al 2021 singh et al 2022 accurate estimation of the precipitation amount is important for reliable risk analysis infrastructure design and planning and water resources management the conventional approach for precipitation measurement relies on ground based rain gauges however in situ observations are commonly sparse particularly in remote areas and complex terrains rainfall measurement undercatch can also undermine the quality of ground based precipitation observations at some locations duchon and biddle 2010 mekonen et al 2015 pollock et al 2018 ehsani and behrangi 2021 besides point measurements might not represent precipitation variations of the surrounding areas accurately derin et al 2016 radar and satellite records are promising alternatives that provide indirect estimates at high spatiotemporal resolution radar networks however are not available globally further the accuracy of ground based radar is undermined by beam blockage ground clutter and signal attenuation uijlenhoet and berne 2008 friedrich et al 2009 krajewski et al 2010 ryzhkov et al 2014 although satellite precipitation products spps are less influenced by radar sources of errors they are affected by the inherent remote sensing uncertainties due to the indirect estimation of precipitation the two corresponding types of errors include systematic errors which are constant and predictable and are associated with the sensors and instrumentation and random errors that are unpredictable and related to the spatial and temporal variations types and the heterogeneity of precipitation in the sensor footprint massari and maggioni 2020 in recent decades the application of spps has increased considerably in different parts of the globe several studies have attempted to evaluate and adjust the spps systematic biases using reliable ground based gauge and radar observations diaz nieto and wilby 2005 ines and hansen 2006 acharya et al 2013 hay et al 2000 lafon et al 2013 considering the spatial heterogeneity of precipitation events limitations in the availability of in situ observations and differences in spatial and temporal scales of satellite and in situ records comparisons between the two datasets and subsequent bias adjustment of satellite areal data can be challenging tang et al 2018 the bias adjustment approaches developed and applied for spps can be categorized into three general approaches the first approach uses rain gauge data directly to remove the spps mean bias values at a specific time scale e g daily monthly it has been commonly applied to adjust radar and satellite estimates smith and krajewski 1991 seo et al 1999 boushaki et al 2009 as well as global and regional climate model simulations which is also referred to as linear scaling hay and clark 2003 ines and hansen 2006 lenderink et al 2007 however both satellite and ground based data may not be available at a given location limiting the application of this method over sparsely gauged areas regions yang et al 2016 further it does not capture the temporal variabilities and cannot adjust the higher order moments in a simple form the method can be applied to adjust the spatially averaged biases over the region of interest seo et al 1999 which may not be suitable for large scale basins 5000 km2 with strong spatial variation in rainfall habib et al 2014 boushaki et al 2009 applied a merging method to adjust the biases in precipitation estimation from remotely sensed information using artificial neural networks cloud cluster system persiann ccs which was first introduced by hong et al 2004 in hourly temporal and 0 04 spatial resolution over the southwestern united states they used daily gridded climate prediction center cpc measurements as the true data the biases at daily temporal and 0 25 spatial resolution consistent with the original cpc data were adjusted and downscaled to 0 04 the daily biases were then redistributed proportionally to the hourly rainfall estimates the results indicated that the method could improve satellite precipitation estimates at a daily scale effectively however limited improvements were made at sub daily scales similarly ma et al 2020 developed a bias adjusted product the aimerg precipitation dataset 0 1 half hourly 2000 2015 asia that is spatiotemporally calibrated by gridded precipitation data based on ground observations from multi sources asian precipitation highly resolved observational data integration towards evaluation of water resources aphrodite 0 25 daily in daily scale over asia its quality was assessed using hourly observations from more than 50 000 meteorological stations over the six subregions of china in 2015 the second approach adjusts the biases of some stochastic model parameters related to rainfall occurrence and intensity by comparing them at the satellite s spatial scale müller and thompson 2013 it tunes the spatial patterns of parameters based on different regression based techniques such as stepwise regression step and geographically weighted regression gwr to find a relation between satellite precipitation and other covariates as well as interpolation techniques such as inverse distance weighting idw nearest neighbour and kriging to adjust the biases especially at ungauged grids yang et al 2016 lu et al 2019 müller and thompson 2013 applied a first order markov chain model to represent rainfall occurrence and spatially aggregated and interpolated the parameters to adjust the biases of satellite precipitation estimates in nepal they concluded that space variant adjustment schemes are effective in reducing the bias of the tropical rainfall measurement mission trmm bhatti et al 2016 interpolated the grid based bias estimates of the high resolution national oceanic and atmospheric administration s climate prediction centre morphing technique satellite rainfall product cmorph using the idw method to yield the distribution of grid based bias factor that covers the study area similar studies have been carried out considering stochastic variations or spatial heterogeneities vernimmen et al 2012 gumindoga et al 2019 yeh et al 2020 although this method is robust for estimating rainfall properties over minimally gauged regions by effectively combining satellite data with sparse rain gauge records it suffers from adjusting the biases in real time further it cannot capture the temporal variation of the true data and is incapable of adjusting the biases in the timing of the events ajaaj et al 2016 besides interpolation techniques may lead to additional uncertainties as the quality of interpolated precipitation in grid cells without gauges can be quite lower than that in grid cells with gauges tang et al 2018 the third approach applies quantile mapping qm to adjust the spps biases by changing the corresponding quantiles using ground based data the qm method adjusts the mean variance and higher moments of the corresponding distribution it has been reviewed in the context of hydrological impact studies and found to outperform simpler methods that adjust only the mean or variance of precipitation series gudmundsson et al 2012 teutschbein and seibert 2012 qm has been widely used in previous studies and is considered an effective approach to reducing systematic biases of regional climate model simulations and remotely sensed rs precipitation estimates cannon et al 2015 ajaaj et al 2016 yang et al 2016 ringard et al 2017 katiraie boroujerdy et al 2020 although this technique can effectively represent the evolution of the mean and the variability of precipitation ajaaj et al 2016 the adjustments to the temporal structure of precipitation are missing resulting in a misrepresentation of wet and dry spell lengths ringard et al 2017 applied the qm method to adjust the daily rainfall estimates from trmm multi satellite precipitation analysis research version 7 mpa 3b42v7 the method reduced 70 of the biases in rainfall intensities less than 25 mm d however it showed weaker performance for more intense events yang et al 2016 proposed a coupled nonparametric qm and gaussian weighting interpolation scheme to adjust the biases of persiann ccs over chile shen et al 2021 also proposed a cumulative distribution function cdf based approach based on a self adaptive moving window which systematically integrates the china gauge based daily precipitation analysis cgdpa into the real time trmm mpa to reduce the systematic biases of multi satellite precipitation estimates recent studies have applied merging techniques using different sources of precipitation data or machine learning algorithms for spp bias adjustments for example xu et al 2021 improved the quality of integrated multi satellite retrievals for the global precipitation measurement imerg late run spps by merging with ground based gauge precipitation data similar analyses have been performed by ma et al 2018a 2022a 2022b and lyu et al 2020 yang et al 2022 established a bidirectional long short term memory recurrent network bi lstm framework for the bias adjustment of spps without using ground based gauge observations other machine learning algorithms have been applied by tao et al 2016 le et al 2020 and chen et al 2021 it was found that machine learning can capture the error structure of satellite retrievals of precipitation however major challenge of machine learning lies in the lack of physical interpretability of models xu and liang 2021 moreover further research is required to address the limitations associated with uncertainties caused by low quality and small sample sizes of ground truth data for training xu et al 2019 le et al 2020 chen et al 2021 determining the input features or optimize the model structures and hyper parameters which are application specific li et al 2021 xiao et al 2022 and reducing computational costs kim et al 2022 building on the previous analyses this study proposes a novel framework to address several limitations in current bias adjustment techniques by adjusting both spatial and temporal variations of spps at both gauged and ungauged sites we combine the strengths of quantile regression quantile mapping spatial interpolation and clustering despite its common use qm has a critical limitation in adjusting the temporal structure of precipitation resulting in a misrepresentation of its temporal variability this limitation may not capture systematic biases well and distort the occurrences of the daily precipitation events ajaaj et al 2016 to address these problems this study introduces the use of regression quantile mapping rqm a qm approach based on linear regression models for spp bias adjustment the proposed framework incorporates a suite of invariant and time varying covariates to adjust the spp estimates across the study domain i e canada as well as the timing of rainfall events at a daily time scale it removes systematic biases besides adjusting time or state dependent errors reflected by six time varying climate predictors as covariates further to extend the bias adjustment to ungauged sites we combined rqm with clustering and spatial interpolation techniques based on a suite of invariant covariates selected from a reanalysis product in the remainder of this paper we describe the ground based and remotely sensed satellite data in section 2 the proposed methodology is presented in section 3 followed by the results discussions and conclusions in sections 4 5 and 6 respectively 2 study area and data 2 1 study area the study area is the entire territory of canada the second largest country in the world with an area of 9 9 million km2 canada is surrounded by the pacific ocean in the west the atlantic in the east and the arctic in the north fig 1 the country has a diverse hydroclimate due to its extensive geographical features latitudinal extent and topographic variations considering the diverse climatic conditions as well as extreme weather events experienced over most parts of the country each year jalili and najafi 2020 singh and najafi 2020 singh et al 2021 reliable precipitation measurements are of great importance 2 2 data 2 2 1 ground based observations environment and climate change canada eccc provides hourly ground based precipitation records from the automatic gauge station network the network consists of 585 rain gauge stations located across canada including both surface weather and reference climate stations rcs fig 1 eccc operates and controls the quality of ground observations to correct the existing errors in the rcs weather stations after 2014 however prior to this year quality checks were not implemented at the time this study was conducted eccc 2018 we select 530 station records with less than 10 missing data for each month during the 5 years from 2014 to 2018 bias adjustment and its evaluation are conducted on a daily time scale based on the aggregation of hourly data 2 2 2 imerg satellite data in this study the recently released version of imerg v06 data is bias adjusted based on the ground records the imerg data shows better performance than the other gridded precipitation datasets such as global satellite mapping of precipitation gsmap and persiann ccs at both daily and hourly scales gao et al 2020 xu et al 2022 the imerg v06 satellite data covers the entire globe from 90 s to 90 n latitude with early 4 h after observation time late 14 h after observation time and final 3 5 months after the observation time runs to accommodate different user requirements for latency and accuracy tan et al 2019 among these three types the final run data with high spatial 0 1 and temporal 30 min resolution is selected due to its better accuracy moazami and najafi 2021 half hourly precipitation estimates are aggregated to a daily time scale for the application of the bias adjustment method in this study among 585 eccc automatic stations 71 gauges participate in the global precipitation climatology center mekis et al 2018 therefore 90 of gauges considered in this study have not been used for imerg calibration and are independent of the evaluated datasets more detailed information on the satellite data used in this study is described in moazami and najafi 2021 2 2 3 narr reanalysis data the north american regional reanalysis narr project is an extension of the national centers for environmental prediction ncep global reanalysis over north america it provides estimates of a suite of variables from 1979 until near present at 32 km 0 3 resolution and three hourly daily and monthly time scales based on the northern hemisphere lambert conformal conic grid in this study we use both daily and monthly products at different stages of the bias adjustment approach table 1 describes the characteristics of the 15 covariates from narr considered in this study among them six variables are involved in deriving the regression model r and nine variables were involved in clustering c and spatial interpolation i these covariates are selected based on the variance inflation factor vif described in section 3 2 we incorporate daily explanatory variables time varying covariates obtained from narr in the rqm approach discussed in section 3 to derive bias adjusted satellite estimates for both gauged and ungauged grids further long term monthly mean invariant covariates of selected narr covariates are considered to estimate the climatic distance between satellite grids and perform clustering in the interpolation process the first group of narr variables used for derivation of the regression model includes 1 daily accumulated total precipitation daily mean values of 2 convective potential energy barry and chorley 1998 3 non convective cloud cover 4 dew point temperature at 2m height 5 specific humidity at 2m height 6 vertical velocity the second group used for clustering and interpolation includes invariant parameters such as 1 elevation of ground and the long term monthly mean values of 2 total precipitation 3 convective potential energy 4 non convective cloud cover 5 dew point temperature at 2m 6 specific humidity at 2m height 7 shortwave radiation flux kantha and clayson 2000 8 geopotential height hofmann wellenhof and moritz 2005 and 9 vegetation index green vegetation fraction gvf huete et al 2002 3 methodology we develop a two stage spatial and temporal bias adjustment framework in which the satellite data are adjusted at rain gauge locations followed by the adjustment at ungauged areas the framework integrates the rqm approach passow and donner 2020 with clustering and interpolation techniques and incorporates both constant and time varying predictors the components of the framework and the corresponding modelling stages are shown in fig 2 at first hourly ground based and half hourly satellite precipitation data are aggregated to a daily time scale for the five years from 2014 to 2018 daily data records corresponding to the stations satellite product and narr climatic covariates are extracted at each gauged grid long term monthly averages as invariant covariates are also extracted and resampled at each satellite grid next the rqm model is derived with the daily ground satellite and covariate data and applied to each cdf segment which will be described in section 3 2 separately at gauged grids parameters of the rqm model at all the bias adjusted gauged grids are extracted to interpolate extrapolate over ungauged grids across each cluster separately using the idw method here clusters are inferred using k means based on the climatic distance between locations according to invariant covariates after that the interpolated bias adjusted parameters of the rqm model are applied to the time varying covariates at each ungauged grid to obtain bias adjusted satellite estimates at those grids lastly the performance of our proposed approach is evaluated through cross validation by comparing the bias adjusted satellite estimates at randomly selected gauged grids that are assumed to be ungauged grids and not considered in model training with the corresponding ground observations fig 2 each step of the modelling framework is described in the following sections 3 1 linear quantile regression given a vector y of n continuous random variables yi i 1 n with cdf f y i y p y i y the τth quantile q y i τ of yi is defined as 1 q y i τ f y i 1 τ i n f y ϵ r τ f y i y where the infimum inf is the greatest element in y ϵ r that is less than or equal to all elements of y ϵ r τ f y i y τε 0 1 and f y i 1 is the quantile function i e the inverse cdf of yi in linear quantile regression qr q y i τ is assumed to depend linearly on a vector of p predictor variables xi x i1 xip t such that 2 q y i τ x i x i t β τ where βτ βτ 1 βτ p t is a vector of unknown regression parameters estimated by solving the minimization problem 3 β τ argmin β τ ϵ r p i 1 n ρ τ y i x i t β τ where ρτ z is a linear loss function defined as z τ 1 if z 0 and zτ otherwise here z is a residual between yi and x i t β τ a comprehensive description of the theory application and interpretation of quantile regression can be found in koenker 2005 qr estimates the conditional sample quantile q τ for individual τ values rather than the full conditional distribution of yi since equation 3 is solved separately for each desired τ the estimated quantile functions may intersect with each other in such a case a quantile of a higher order may switch places with a quantile of a lower order a well known problem in qr called quantile crossing qc several approaches are available to avoid qc he 1997 yuan 2006 liu and wu 2009 bondell et al 2010 cannon 2018 here a smoothing spline is considered to smooth the conditional distribution and reduce the possibility of qc see section 3 2 we apply the qr approach considering a linear relationship between the predictors covariates and precipitation dependent or response variable 3 2 regression quantile mapping rqm in this study the rqm approach a novel method that combines qm with regression modelling is proposed to adjust the conditional inverse cdfs of satellite precipitation estimates in addition to removing the overall systematic biases of spp the time varying errors are also adjusted using climatic time varying covariates denoted by x 4 y s f y o x 1 f y s x y s where ys is the quantile of original satellite data f y s x is the cdf of satellite original data conditional on the time varying covariates x f y o x 1 is the inverse cdf or quantile function of the ground observations yo conditional on x and y s is the obtained bias adjusted satellite data the main advantage of the qm method is that it can effectively capture the evolution of mean and variability of spps while adjusting all statistical moments cannon et al 2015 however it may distort the occurrences of the daily precipitation events ajaaj et al 2016 besides qm is unable to adjust estimated values outside the codomain of the observations passow and donner 2020 therefore the linear regression model is combined with qm to adjust the magnitude and timing of imerg precipitation estimates the linear regression model rm establishes the linear relation between independent and dependent variables for each quantile eq 2 in this study ground based precipitation or spp is a dependent variable and multiple time varying climatic predictors are independent variables rm is derived for ground based and satellite records separately with sharing same set of time varying climatic predictors as independent variables eq 6 then the two rms are combined based on qm which is described as eq 4 therefore rqm algorithm which is a combination of rm and qm provides the adjusted predictive cdfs of the corresponding spp at each location with the predictive cdfs rqm enables spp adjustments using transfer functions conditional on time varying covariates using eq 4 it not only removes systematic biases but also adjusts time or state dependent errors reflected by climate variables as covariates resulting in an adjustment of the magnitude and timing of spps simultaneously a set of covariates at a daily scale introduced in section 2 are selected to develop the regression model covariates are selected based on the correlation strength between each independent variable and local precipitation the effects of multicollinearity between multiple independent variables are quantified using the variance inflation factor vif a vif value of 1 indicates no correlation between a specific independent variable and others vifs between 1 and 5 suggest moderate multicollinearity effects the values greater than 5 indicate critical levels of multicollinearity that can result in poorly estimated coefficients and inaccurate p values among 15 climatic variables 6 are selected to derive the regression model which showed the highest correlation with satellite and observed precipitation values individually and had vif values less than 5 to determine the conditional and inverse cdfs we combine qr with a nonparametric smoothing spline estimator let τ1 τ k be a set of quantiles where τ ϵ 0 1 and τ1 τ k qr is applied to each time series yo and ys to estimate the regression parameters 5 β τ z β τ 1 z β τ k z t for the ground observed z o and satellite z s data for each τi separately the qr model with parameters estimated in eq 5 is applied to predict the quantile curves q τ at each month t for the 5 year period tp based on the time varying covariates xp and their corresponding time dependent effects i e β τ o a n d β τ s as 6 q τ z t x p β τ z t t p based on eq 6 two quantile curves corresponding to the ground based and satellite precipitation data are obtained q τ o and q τ s using the same set of time varying covariates xp over the study period tp to obtain a continuous approximation of f y o x 1 and provide estimates for unknown quantile values we use the smoothing spline estimator b splines are applied as the basis functions because of their flexibility and fast computation de boor 1978 ramsay et al 2009 we adopt cdf segmentation to better transfer statistical characteristics of ground observation to satellite estimates the idea of using partitioned cdf in this study comes from grillakis et al 2013 they presented an improved quantile mapping based bias correction method named multi segment statistical bias correction msbc quantile mapping for general circulation model gcm simulated daily precipitation they used different instances of gamma function that were fitted on multiple discrete segments of the precipitation cdf instead of the common approach that uses one distribution to fit the entire cdf we split the precipitation cdf into five equal discrete sequential segments from 0 to 0 2 0 21 to 0 4 0 41 to 0 6 0 61 to 0 8 and 0 81 to 1 then rqm is performed at each segment separately to correct the cdf of satellite data in the range of that segment 3 2 1 interpolation of regression model parameters over ungauged locations after developing the rqm model at gauged locations the estimated parameters of rqm model are interpolated extrapolated for ungauged sites the satellite data are clustered based on the euclidean distance in the climate space using the k means clustering method a set of nine invariant covariates table 1 at the monthly time scale from the narr data resampled to grid cells at 0 1 degree resolution consistent with imerg is used to calculate the climatic distance between satellite grids based on the silhouette criterion an optimal number of nine clusters is obtained rousseeuw 1987 the parameters of rqm model estimated at gauged grids are interpolated to ungauged grids across each cluster bias adjusted satellite precipitation at ungauged grids is obtained by applying the interpoltated parameters to time varying climate predictors at the ungauged grids the flowchart in section 3 fig 2 clearly shows a whole procedure of bias adjustment for ungauged grids including spatial interpolation in this study we use the idw interpolation method to determine the parameters of the rqm model at ungauged locations across each cluster idw is a deterministic spatial interpolation approach to estimate an unknown value at a location using some known weighted values at other locations eq 7 idw is simple and easy to compute and straightforward to interpret mueller et al 2004 lu and wong 2008 even though kriging or regression could be alternatives it is known that idw can also produce equally good representation of spatially distributed rainfall dirks et al 1998 kong and tong 2008 kurtzman et al 2009 wu et al 2010 for the purpose of spp bias adjustment the idw is shown to be an effective method bhatti et al 2016 alharbi et al 2018 let x be an unknown value at a location w be the weight and x the known point values in neighboring sites the weight is the inverse distance between the ungauged grid and each gauged grid eq 8 7 x w 1 x 1 w 2 x 2 w n x n w 1 w 2 w n 8 w i 1 d i x p where d is the distance between ungauged and gauged locations and x is the parameters of the rqm model at ungauged cells here we use climatic distance which could bear important information in describing the latent spatial dependence between gauged grids and ungauged grids cooley et al 2007 a higher p i e power value results in a lower weight we determine the optimum p by taking a portion of sample points as a testing validation dataset the idw interpolation is applied considering different p values a p value of 2 results in the smallest difference between the interpolated and actual data i e the lowest rmse and is therefore selected in this study 3 3 performance verification the widely used continuous metrics including the root mean square error rmse relative bias rbias pearson correlation coefficient cc and kling gupta efficiency kge are applied to measure the accuracy of the estimated precipitation magnitudes from the original and bias adjusted imerg product rbias describes the systematic biases of imerg rmse is used to measure the average of the squares of error cc characterizes the degrees of consistencies in temporal variabilities and kge combines the three components of model errors i e correlation bias ratio of variances or coefficients of variation in a more balanced way to measure the ability of imerg data to detect rain no rain events based on a threshold of 0 1 mm d 1 three categorical metrics are used which include the probability of detection pod false alarm ratio far and heidke skill score hss the equations and a brief description of these metrics are listed in table 2 taylor diagrams for each cluster are also used for the performance assessment we evaluate the performance of the bias adjustment approach using cross validation in which 10 of gauged grids within each cluster are bias adjusted based on information from other gauged locations the parameters estimated at the 90 gauged grids are interpolated over the 10 randomly selected grids that are assumed to be ungauged the covariates at the selected grids are then applied based on the interpolated parameters to adjust the satellite data at ungauged locations finally we compare the bias adjusted spp with observed gauge records and evaluate the performance using metrics provided in table 1 this process is repeated 1000 times based on the bootstrapping method 4 results the results of the proposed rqm method are discussed for gauged grids which include at least one rain gauge and for randomly sampled ungauged grids that are bias adjusted based on interpolated parameters in each cluster fig 3 the performance of the rqm method is quantitatively evaluated by comparing bias adjusted satellite precipitation with ground observations based on the metrics provided in table 2 and the taylor diagram all the metrics estimated at each grid in a daily time scale are summarized by boxplots for each month and cluster the mean values of metrics are provided as supplementary information tables s1 and s2 as shown in table 3 the total number of grids and the number of gauged grids are different between clusters which can affect the interpolation of rqm parameters and the overall performance of the bias adjustment approach in different areas clusters no 3 5 and 6 located in high latitudes have relatively lower gauge densities than clusters no 7 8 and 9 located in low latitudes 4 1 bias adjustment at gauged locations the time series of the original hereafter imerg ori and bias adjusted hereafter imerg bc imerg precipitation products at gauged grids in each cluster are compared with the corresponding ground based observations for each month from 2014 to 2018 in all clusters imerg ori over or under estimates the observed precipitation overall the magnitude and to a larger extent the timing of precipitation occurrence are improved in imerg bc in all months especially in clusters no 2 4 5 7 and 8 in eastern and western regions figure s1 further comparisons between precipitation rates an amount of precipitation per day mm day for each month show clear improvements in imerg products based on the proposed rqm approach imerg bc closely follows the observed temporal patterns however it underestimates the magnitude of precipitation in some clusters particularly in central canada 4 1 1 statistical evaluation precipitation estimates from imerg ori and imerg bc are assessed using cc rbias rmse and kge at each cluster and each month figs 4 5 s2 s3 the performance metrics are based on daily gauged grids located within each cluster each month rqm significantly improves the precipitation estimates according to these performance metrics for example in cluster no 1 the overall cc value is increased from 0 49 imerg ori to 0 85 imerg bc and the rmse is reduced from 2 9 to 1 5 mm d average value of all months these improvements are promising especially in the cold months november to march for which the performance of imerg is weak with lower correlation and higher biases moazami and najafi 2021 similarly imerg bc shows significant improvements over imerg ori in cluster no 2 southeastern part of the country based on kge an overall increase from 0 30 to 0 69 and rmse decreases from 8 2 to 4 6 mm d improvements in the imerg precipitation estimates based on the rqm bias adjustment approach are shown for all clusters using cc rmse rbias and kge in table s1 the cc values averaged over the clusters during the cold november to march and warm months april to october are improved by 167 from 0 3 to 0 8 and 50 from 0 6 to 0 9 respectively as discussed in the previous section different levels of precipitation are adjusted separately based on cdf segmentation therefore the rate of precipitation does not have a considerable effect on the adjustment the mean rbias values also show improvements based on the rqm bias adjustment approach except for clusters no 2 5 6 and 8 table s1 although the rmse kge and cc metrics show improved performance this is due to the variation of rbias values from negative to positive ranges in some months which generally leads to the lower mean values as shown in the boxplots figure s3 fig 6 shows taylor diagrams of daily imerg ori and imerg bc against gauge observations in each cluster each taylor diagram has a total of 24 dots which are 12 sets for each month with blue dots corresponding to the bias adjusted satellite precipitation and red dots to the original satellite precipitation overall bias adjusted satellite precipitation shows a higher correlation with ground observation and less centered rmse crmse from observation than original satellite estimates among nine clusters the difference between original and bias adjusted satellite precipitation is relatively larger for clusters 7 and 9 with a high density of gauge network in low latitude but smaller for clusters 1 3 and 6 with sparse gauge network in high latitude these results show the importance of gauge network density in improving the performance of the rqm method 4 1 2 evaluating the spatial pattern of precipitation we further evaluate the seasonal precipitation estimates from imerg ori and imerg bc at gauged grids across canada figs 7 9 s4 s5 show the results based on rmse cc hss pod and far respectively overall the performance metrics show significant improvements especially over interior plains imerg bc satellite precipitation data bias adjusted based on rqm has significantly lower rmse values compared to imerg ori particularly over the west and east coasts the spatial pattern of rmse corresponding to bias adjusted data follows that of the original data but with improved performance for example both imerg ori bc have higher lower rmse values during summer winter respectively fig 7 the improvement is notable based on cc with most sites showing correlation values greater than 0 7 imerg ori has a very low correlation during winter while imerg bc s precipitation estimates are much more temporally consistent with the observed data fig 8 hss and pod corresponding to imerg bc are in good agreement with the gauge observations during all seasons with values more than 0 8 over most grids figs 9 and s4 imerg ori s performance in detecting the precipitation events is relatively weak particularly in cold seasons both hss and pod values for winter are below 0 2 the difference between imerg ori and imerg bc is larger for hss than pod indicating that the bias adjustment performance becomes stronger when the random chance of precipitation occurrence is excluded further the far metric shows reasonable values less than 0 2 associated with imerg bc for all seasons while it is generally more than 0 4 for imerg ori data indicating larger errors in detecting precipitation events i e false detection overall the bias adjustment technique proposed in this study considerably improved the estimates of precipitation intensity as well as the detection of precipitation occurrence across canada 4 2 bias adjustment at ungauged sites the parameters obtained from rqm developed over the gauged locations are applied to adjust imerg data in areas without ground based observations the performance of the bias adjusted product over ungauged areas is evaluated using cross validation in each cluster 10 of gauged grids are randomly selected and the corresponding ground observations are assumed to be unknown the rqm parameters estimated from other gauged locations are interpolated to adjust the ungauged imerg data the original and bias adjusted imerg are then evaluated based on the existing ground observations this bootstrapping process is repeated 1000 times the following results represent the average value of the 10 ungauged grids i e validation grids overall the results show improved performance of imerg bc in representing the observed precipitation climatology compared to imerg ori over all clusters figure s6 4 2 1 statistical evaluation fig 10 compares the cc values of original and bias adjusted imerg data against gauge observations for validation grids across different clusters overall the mean correlation coefficient values associated with imerg bc are higher than the ones corresponding to imerg ori by 16 imerg bc shows slightly lower performance in terms of cc in a few warm months in clusters no 5 6 where gauge density is sparse besides clusters no 7 8 show relatively consistent and higher bias adjustment performance regardless of seasons this might be partly because of the number of gauged observations in these clusters compared to the others that can affect the reliability of the interpolated parameters in these areas table 3 the sparse gauge density at ungauged site is the more lack of known information and higher uncertainty of spatial interpolation figs 11 and 12 show the performance of imerg bc against imerg ori based on rmse and kge respectively in cluster no 1 the mean value of rmse over all months is improved by 16 from 2 4 in imerg ori to 2 0 in imerg bc the mean value of kge over all months in cluster no 1 is also improved by 19 from 0 195 in imerg ori to 0 241 in imerg bc further in most clusters the rates of improvement by bc are above zero table s2 however only cluster no 5 indicates higher rmse values corresponding to imerg bc than imerg ori with rates of 10 the mean value of kge in cluster no 5 also decreases by 24 from 0 844 in imerg ori to 1 113 in imerg bc overall the bias adjustment approach has improved the satellite estimates over ungauged locations by 15 based on rmse kge shows higher performance of bias adjustment particulararly in cold months november to march improved by 24 from 0 200 in imerg ori to 0 153 in imerg bc imerg bc outperforms imerg ori in terms of rbias in most areas especially for clusters no 1 2 and 8 with improvements in 70 of the months figure s7 however clusters no 4 5 and 6 show higher rbias values in imerg bc in almost 50 of the months there is not any consistency between cc and rbias as the underestimation overestimation of both imerg ori and imerg bc data leads to negative positive values of rbias that may decrease increase its mean value in clusters no 1 2 3 and 8 imerg bc has lower rbias values of 0 031 0 024 0 020 and 0 083 respectively while the values corresponding to imerg ori are 0 320 0 079 0 061 and 0 215 in other clusters like no 5 and 6 imerg bc shows relatively high rbias with values of 0 559 and 0 321 compared to values of 0 785 and 0 238 in imerg ori this suggests that the bias adjustment performance could be restrained for the regions with sparse gauge networks overall there is a 66 improvement considering the entire regions and all months mean rbias of imerg bc ori are 0 071 and 0 211 respectively table s2 lists the spatial mean values of cc kge rbias and rmse performance metrics at validation grids for each cluster further we evaluate the performance of the bias adjustment method developed in this study over the ungauged grids by comparing the spatial average quantiles of imerg ori and imerg bc data against gauge observed precipitation at all clusters the satellite estimates closely represent the quantiles of observed data after bias adjustment while imerg ori shows significant under or over estimations figures s8 the empirical cdf ecdf associated with the observed data is compared with the corresponding imerg ori and imerg bc estimates figure s9 shows the ecdfs based on spatially average daily precipitation during the five years at each cluster the observed and imerg bc cdfs closely match all clusters except in cluster no 5 in which imerg bc shows an underestimation imerg ori however tends to systematically overestimate the ground based daily precipitation over clusters no 1 to 5 and 8 and underestimate it over clusters no 6 7 and 9 respectively 5 discussion in this study a novel approach based on regression model based quantile mapping is proposed to adjust biases of spp at un gauged locations across canada and the performance is evaluated through cross validation in summary the evaluation results show the promising performance of rqm for both gauged and ungauged sites for the case of gauged grids the magnitude and to a larger extent the timing of precipitation rates are improved in all months especially in clusters no 2 4 7 and 8 in eastern and western regions figs 7 9 bias adjusted imerg precipitation closely follows the observed temporal and spatial patterns however it underestimates the magnitude of precipitation in some clusters particularly in central canada rqm significantly improves the satellite precipitation estimates according to the performance metrics particularly in the cold months for example the mean kge value for every month and cluster highly increases from 0 2 imerg ori to 0 63 imerg bc hss corresponding to imerg bc is in good agreement with the gauge observations during all seasons with values more than 0 7 over most grids imerg ori s performance in detecting the precipitation events is relatively weak particularly in cold seasons those for the ungauged locations also show the improvement of bias adjusted imerg overall the bias adjustment technique proposed in this study considerably improves the estimates of precipitation intensity as well as the detection of precipitation occurrence across canada higher improvement of bias adjustment performance especially in cold months november to march in high latitudes is due to the weak performance of spp the weak spp performance in high latitudes can be associated with the high uncertainty of imerg precipitation retrieval at snow and ice surface errors of imerg can be traced from the passive microwave pmw sensors they use the pwm retrieval which is in contact with the precipitation particles has problems in distinguishing between precipitation and frozen surface chen et al 2019 furthermore imerg v06 which is used in this study has gaps over snow and ice surfaces poleward of 60 latitude where pmw have a low quality ehsani et al 2021 huffman et al 2019 stated that all merged pmw estimates have low accuracies in regions with frozen or icy surfaces the weaker performance of imerg estimates in cold months has also been indicated by sadeghi et al 2019 based on the latest comprehensive evaluation study of imerg v06 moazami and najafi 2021 the performance of imerg products is mostly consistent during fall spring and summer with weaker performance in winter therefore the bias adjustment performance in winter is improved relatively higher than in other seasons due to the low accuracy of imerg v06 in cold months even though overall biases of satellite precipitation are considerably reduced the performance of imerg bc in cold months is still lower than in warmer months these results are caused by combined errors from ground observation and satellite products as rqm uses both ground and satellite precipitation data high uncertainty of imerg products in cold months can negatively affect the bias adjustment performance the other source of higher biases of imerg bc in winter is the lack of reliable ground based precipitation observations during cold seasons precipitation gauges across most parts of canada show poor performance in solid precipitation measurement moazami and najafi 2021 besides even though we use the quality controlled precipitation data observed at ground gauges some inherent systematic errors such as undercatch remain undercatch is considered to be the most significant systematic error resulting in an underestimation of actual precipitation in gauge measurements benning and yang 2005 rasmussen et al 2012 the reason of undercatch problem could be the deformation of the local wind field by the elevated gauge that results in the deformation of rain particle trajectory sevruk et al 2009 mekonen et al 2015 pollock et al 2018 it could also stems from missed measurements during the finite time required for the bucket to tip from one side to the other duchon and essenberg 2001 duchon and biddle 2010 the use of appropriate adjustment methods such as legates correction factor developed by legates and willmott 1990 or fuchs correction factor proposed by fuchs et al 2001 to mitigate the precipitation undercatch can have a large impact on the accuracy of observed precipitation ehsani and behrangi 2021 quality control of ground observations is an ongoing task to improve for higher performance of remotely sensed products bias adjustment differences in spatial resolution between point based ground gauges and areal imerg estimates can also contribute to the uncertainties which can be investigated in future studies as mentioned before the performance of spp bias adjustment highly depends on the accuracy and density of ground based observation therefore adding more station gauges in high latitude regions or improving the quality of gauge precipitation observations is recommended other challenges associated with rainfall undercatch evaporation wetting losses orographic effects and sparse gauge density can still affect the bias adjustment performance metcalfe et al 1997 devine and mekis 2008 mekis et al 2018 the method proposed in this study could give reasonable bias adjusting performance with other satellite products as well it is promising to be applied in continental scale or even global by dividing the large territory into several clusters based on climatic distance which considers climatic dis similarities between grids nevertheless it should be noted that invariant or long term climatic predictors for clustering must be carefully determined reliable ground based observation gauge precipitation and covariates are also needed plus if interpolation gives low performance for ungauged locations the other interpolation methods should be considered in this study we apply the proposed bias adjustment approach on imerg satellite precipitation estimates at a daily scale we target daily time scale as reliable precipitation estimates at daily scales are critical for hydrological modelling analyses and water resources management behrangi et al 2011 ma et al 2018b maggioni and massari 2018 yuan et al 2018 yeh et al 2020 secondly our analyses at daily scales is consistent with majority of the previous studies that developed and assessed bias adjustment methods targeting daily satellite estimates boushaki et al 2009 casse et al 2015 valdes pineda et al 2016 worqlul et al 2018 ma et al 2020 yang et al 2022 furthermore moazami and najafi 2021 investigated the performance of gpm imerg v06 precipitation estimates over canada for 2014 2018 in both hourly and daily scale and highlighted several issues associated with ground observations at subdaily scales especially during cold seasons besides it should be noted that the highest temporal resolution of narr data which was used as covariates in this study is 3 hours mesinger et al 2006 for hourly analyses other products such as era 5 can be considered hersbach et al 2020 considering the above we opt to do bias adjustment at daily scale in this research but will consider extending it to subdaily scale in a future research work because of the importance of reliable hourly precipitation products for flash flood assessments 6 summary and conclusion in this study a novel statistical approach is proposed to adjust the biases of imerg satellite products and provide reliable high resolution remotely sensed data over canada imerg and ground based precipitation data and a set of invariant and time varying reanalysis covariates resampled to match the satellite spatial resolution 0 1 considered as independent variables are used to develop a regression based quantile mapping model the k means clustering technique is applied to categorize the study area based on the climatic similarities and ground observations between satellite grids as well as the spatial distribution of rain gauges first the bias adjustment method is implemented at each cluster and the related parameters obtained from the gauged grids for different quantile levels of precipitation data are estimated then using idw the parameters are interpolated over the ungauged grids in the corresponding cluster to apply the idw technique we consider the climatic distance based on the set of covariates selected from the reanalysis product instead of geographical distance finally by applying the reanalysis covariates at each ungauged grid in the interpolated model parameters of that grid the bias adjusted satellite data was obtained the performance of the developed model at ungauged grids is evaluated using cross validation 10 of gauged grids at each cluster are selected randomly and assumed to be ungauged grids the satellite product is then bias adjusted at these validation grids based on parameters estimated from other gauged locations overall the results for both gauged and validation grids show major improvements in the intensity and occurrence of bias adjusted imerg precipitation estimates especially over regions where the original data shows relatively low performance e g western canada and coastal areas further the variation of precipitation time series is well captured by the bias adjusted data however the bias adjustment approach did not perform well in northwest regions where there are only a few stations available that are unevenly distributed the large uncertainties in the interpolated information can undermine the reliability of bias adjusted data at ungauged sites besides the diversity in the topographic and climatic conditions in these regions makes it challenging to find the accurate climatic distance between the grids the point scale measurements of ground observations unevenly dispersed gauge records across the country and the spatio temporal variability of precipitation are other sources of uncertainties associated with the reference data particularly during winters and for solid precipitation for detailed information see rasmussen et al 2012 mekis et al 2018 moazami and najafi 2021 from the results of this study we can conclude that rqm adjusts the magnitude and timing of satellite precipitation estimates simultaneously to provide the adjusted predictive cdfs of satellite precipitation further this approach is capable of adjusting spps at locations where ground based observations are lacking by pooling information from other station records this procedure addresses a major limitation of conventional methods that are incapable of adjusting spps at ungauged locations the proposed bias adjustment approach and the generated products can be applied by researchers and stakeholders for the adjustment and analysis of extreme precipitation events water resources management and design of infrastructure in canada as well as other countries around the globe eq 1 declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgement this project was funded by an nserc alliance grant through a collaboration with the institute for catastrophic loss reduction iclr the imerg dataset was downloaded from the precipitation measurement mission pmm websites https pmm nasa gov data access downloads gpm and ftp arthurhou pps eosdis nasa gov gpmdata the station dataset was downloaded from eccc websites the authors would like to thank kh yau bridget thomas and chantale cerny from eccc for their support in accessing the ground precipitation dataset and for providing information about their quality supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2022 104300 appendix supplementary materials image application 1 
98,surfactant flooding is widely used in subsurface applications where high displacement efficiency is needed such as nonaqueous phase liquid napl remediation and enhanced oil recovery eor for surfactant water oil systems the partitioning of surfactants in each phase is controlled by external factors such as salinity the third phase microemulsions which locates between water and oil can be formed spontaneously at certain salinities therefore the transfer of surfactants from water to other phases which depends on salinity can occur during surfactant flooding resulting in spatially non homogeneous surfactant concentrations the critical parameters governing the displacement dynamics such as contact angle and interfacial tension ift can vary considerably due to spatially non homogeneous surfactant concentrations however the influence of spatially non homogeneous contact angle and ift on the displacement in porous media has not been sufficiently explored in this work we visualized the surfactant flooding at different salinities in 2d micromodels our results suggest that the displacement patterns vary considerably with salinity one displacement front was observed at low salinity while displacement front separation occurred at intermediate and high salinity forming two different displacement fronts at intermediate and high salinity we noticed that the downstream displacement was imbibition while the upstream displacement was drainage we suggest that the separation of displacement fronts was capillary driven arising from spatially non homogeneous contact angle and ift our study provides new insights into the effect of the phase behavior of surfactant water oil systems on displacement patterns keywords napl remediation displacement patterns surfactant phase behavior microfluidics data availability data will be made available on request 1 introduction fluid fluid displacement is essential in many subsurface applications including oil recovery healy and reed 1977 aquifer remediation dwarakanath et al 1999 ouyang et al 2002 zhong et al 2001 and co2 sequestration berg et al 2013 hu et al 2017 li et al 2019 in these processes a high displacement efficiency is desired capillary trapping which occurs at low capillary numbers ca µv γ where µ is the viscosity of invading fluids v is the interstitial velocity and γ is the interfacial tension is one of the primary mechanisms that limit the recovery of displaced fluid from porous media chatzis and morrow 1984 iglauer et al 2015 reducing interfacial tension ift is an effective method to increase the capillary number and therefore improve the displacement efficiency of the trapped fluid surfactants are widely used to reduce ift to low or ultralow levels for enhanced oil recovery eor and surfactant enhanced aquifer remediation sear healy et al 1975 hirasaki et al 2011 jayanti et al 2002 phase behavior describes the behavior of liquids gases and solids as a function of temperature pressure and more factors whitson and brulé 2000 specifically the phase behavior of surfactant water oil systems is a function of salinity it is more complex than the phase behavior of water oil systems due to the formation of microemulsions healy and reed 1977 microemulsions are thermodynamically stable macroscopically homogeneous mixtures of oil water and surfactants since the free energy of microemulsions is lower than that of the separated water and oil phases they form spontaneously when appropriate surfactants are introduced to the water oil systems to reduce the ift miller 1988 according to winsor winsor 1954 microemulsions can be classified into lower phase oil in water middle phase bicontinuous and upper phase water in oil microemulsions depending on the curvature of the surfactant film the corresponding phase behaviors are known as type i type iii and type ii respectively fig 1 depicts a schematic of the phase behavior of surfactant water oil systems as a function of salinity the formation of type iii microemulsions the third phase results in the lowest oil water ift because the surfactants have a similar affinity for oil and water healy and reed 1977 huh 1979 the interfacial curvature of the surfactant film for anionic surfactants used in eor and sear is primarily influenced by the salinity of the water type i type iii and type ii microemulsions are formed at low medium and high salinity respectively as shown in fig 1 the majority of the surfactants partition in the microemulsions once the water surfactant oil systems have reached equilibrium while the water and oil coexisting with the microemulsion have very low surfactant concentrations huh 1979 during surfactant flooding although the surfactants are initially dissolved in water they leave the aqueous phase and accumulate in microemulsions in type iii and type ii phase environments therefore surfactant depleted water generated during the formation of type iii and type ii microemulsions leads to the spatial heterogeneity of surfactant concentration in the aqueous phase in type iii and type ii phase environments the oil surfactant solution ift is ultralow and low respectively while the oil water ift is high which leads to spatial heterogeneity in ift moreover the contact angle of microemulsions on pore surfaces varies with the composition of microemulsions this is because the microemulsions surfactant solution ift varies with the composition of microemulsions and the contact angle is a function of the microemulsions surfactant solution ift according to young s equation reed and healy 1984 de gennes 1985 these two factors can greatly affect the pore scale displacement pattern and the recovery of the defending fluid in addition the type iii microemulsions are immiscible with oil while the type ii microemulsions are miscible with oil which has different effects on flow dynamics the efficiency of a surfactant flooding process is one of the most important factors considered in subsurface applications the fingering of the injected surfactant solution significantly limits the displacement efficiency and should be avoided therefore it is necessary to understand the factors affecting displacement stability two phase immiscible displacement in 2d porous media has been extensively studied and described in the present literature cieplak and robbins 1990 hu et al 2018 jung et al 2016 lenormand et al 1988 zhao et al 2016 in the phase diagrams developed in these and other prior works the composition of each phase is in thermodynamic equilibrium so that the factors governing the displacement such as wettability and ift are spatially and temporally homogeneous recent pore scale studies show that the compositions of microemulsions formed under flow conditions vary spatially mejia et al 2019 tagavifar et al 2017 yang et al 2021 the surfactant solution oil solid systems are only in local thermodynamic equilibrium under flow conditions tagavifar et al 2017 israelachvili 1994 which indicates that the factors governing the displacement such as ift and contact angle can be spatially non homogeneous to the best of our knowledge the impact of surfactant phase behavior induced non homogeneous contact angle and ift on pore scale displacement is rarely considered which may make the displacement pattern deviate from that predicted by the conventional phase diagrams significantly although the surfactant flooding process has been extensively studied by performing coreflood experiments healy and reed 1977 dwarakanath et al 1999 flaaten et al 2009 lu et al 2014 lu and pope 2016 zheng et al 2022 the focus is mainly on macroscopic parameters such as displacement efficiency fractional flow and pressure the effect of surfactant phase behavior and the resulting spatial heterogeneity of ift and contact angle on microscopic displacement dynamics could not be revealed it is commonly believed that the oil is displaced by the formed type iii microemulsions and the type iii microemulsions are displaced by the aqueous chasing phase surfactant solution or water and the ift is assumed to be constant during the displacement process lu et al 2014 alzahid et al 2019 this assumption however may not hold during surfactant flooding because of the phase behavior induced spatial ift and contact angle heterogeneity it is still unknown how and to what extent the phase behavior of the surfactant water oil systems affects the displacement process which is critical for optimizing strategies for surfactant flooding and accurately modeling multiphase displacements involving surfactants direct experimental evidence is required to gain insights into the displacement patterns impacted by this spatial ift and contact angle heterogeneity micromodels have been proven to be a powerful tool for visualizing the small scale multiphase flow to understand the flow physics zhong et al 2001 li et al 2019 du et al 2020 xu et al 2017 yang et al 2021 zhang et al 2020 chang et al 2019 unsal et al 2016 mehmani et al mehmani et al 2019 conducted displacements in micromodels with different roughness they found that capillary trapping highly depends on grain surface roughness after a certain media dependent threshold broens and unsal broens and unsal 2018 performed surfactant flooding in microfluidic chips to investigate spontaneous emulsification in dead end pores the emulsification rate in dead end pores was determined by visualizing the emulsification processes therefore we utilize microfluidics to investigate the effect of phase behavior surfactant fluid fluid systems on multiphase displacement in this study we conducted experiments in all three phase environments in 2d homogenous inch scale reservoir on a chip glass micromodels decane was used as the representative of napl for micromodel displacement experiments we show that the displacement pattern varies significantly in different phase environments in particular the separation of displacement fronts was observed during the displacement process in type iii and type ii phase environments therefore we concluded that the spatial heterogeneity in ift and contact angle due to the different partitioning preferences of surfactants in different phase environments could lead to a more complex displacement pattern during the surfactant flooding process our study provides new insights into the effect of phase behavior on the displacement patterns during sear which is important for designing and optimizing the sear 2 materials and methods 2 1 materials two anionic surfactants internal olefin sulfonate ios c20 24 ios and alcohol propoxy sulfate aps c13 13po so4 were obtained from stepan company isobutanol iba purity 99 0 was purchased from alfa aesar and used as a co solvent to eliminate the formation of macroemulsions and reduce the viscosity of microemulsions sodium chloride nacl purity 99 0 was purchased from milipore simga and used to adjust the salinity of the surfactant solution to obtain different types of microemulsions decane purity 99 0 was purchased from alfa aesar and used as a representative of napl deionized water was used to prepare the surfactant solution 2 2 static phase behavior tests since we are interested in investigating the fluid fluid displacement in different phase environments a suitable surfactant formulation should be used and the phase behavior of the surfactant water oil system needs to be determined therefore static phase behavior tests were conducted to determine the diagram of the phase behavior of surfactant water oil systems the surfactant formulation consists of 1 0 wt ios 1 0 wt aps and 5 0 wt iba and the concentration of nacl in the surfactant solution increases in 0 1 wt increments to determine the phase diagram a glass pipette was filled with 2 ml of oil and 2 ml of surfactant solution and the pipette was then sealed the oil and surfactant solution in the pipette was mixed vigorously by hand shaking and incubated at 21 c until the system reached equilibrium the microemulsion water and microemulsion oil ifts were calculated using the chun huh equation huh 1979 which is shown below 1 γ c σ 2 where c is a constant and approximately equals 0 3 mn m for typical oils and surfactants σ is the solubilization ratio of oil or water details about the phase diagram are illustrated in test s1 and figures s1 and s2 the fluid properties in different phase environments are shown in table 1 2 3 fluid fluid displacement in micromodels figure s3 shows the experimental setup used in this study yang et al 2021 2d homogeneous glass micromodels were used in this experiment the micromodels were fabricated by the following processes uv lithography wet hydrofluoric acid etching and fusion bonding the images and dimensions of the micromodels are shown in figure s4 and table s1 respectively the micromodels used are water wet without any treatment to modify their wettability the in situ static water oil solid contact angle is 33 1o the viscosity of the surfactant solutions is 1 5 mpa s in all type i type iii and type ii phase environments and the viscosity of decane is 0 87 mpa s the oil soluble dye oil red egn was added to the decane to increase the contrast between phases to conduct fluid fluid displacement in the micromodel oil was first injected until the micromodel was fully saturated with oil then surfactant solution was injected into the micromodel from the inlet at the flow rate of 0 05 μl min velocity of 0 3 m day using a syringe pump harvard phd ultra and the corresponding ca is shown in table 1 the displacement stopped at 2 0 pv of surfactant solution injection a digital camera sony a7r2 with a macro lens 50mm f 2 8 was used to capture the displacement process every 90 seconds the captured images have 5126 pixels in width and 2961 pixels in height and the pixel size is 4 88 um 2 4 image processing the captured images are analyzed and processed using imagej for immiscible displacement the captured images are usually converted to grayscale images and then binarized to determine the saturation in a binary image the saturation of each phase at a given position can only be 0 or 1 the formation of microemulsions especially in type iii and type ii phase environments makes this method inapplicable because the oil content in microemulsions varies from 0 to 1 therefore we used the lambert beer law to relate the oil saturation with the grayscale value chen et al 2021 unsal et al 2019 the original image of the fully oil saturated micromodel was first subtracted from the light background and then converted to the 16 bits grayscale image the histogram of the 16 bits grayscale image is shown on the left of fig 2 a and the grayscale values of the pure oil phase and aqueous phase can be determined from the two peaks in the histogram there was noise in the images taken by the camera which impeded us from identifying the peaks in the histogram therefore the 16 bits grayscale images were further filtered using the non local means denoising filter to remove the noise from the images then as seen on the right of fig 2 a the peaks can be found in the histogram of the filtered image the workflow of image processing is shown in fig 2 b a calibration curve was created experimentally to determine the relationship between the grayscale value and the oil content the microemulsions with different oil contents were prepared by mixing surfactant solution with different salinities and decane dyed with oil red egn the detailed experimental procedure is shown in section 2 2 after the phase equilibrium was reached we extracted the microemulsions using a syringe with a needle then we injected the microemulsions into a micromodel to obtain the transmitted light intensity i at different oil contents finally the following relationship between oil content and normalized transmitted light intensity i i 0 was determined 2 i i 0 10 0 05931 c where i 0 is the intensity of the incident lights and c is the oil content the generated calibration curve is shown in figure s5 therefore the oil saturation in a micromodel can be calculated based on the grayscale value of images 3 results 3 1 displacement patterns the oil water displacements in different phase environments were performed in micromodels results show that the displacement dynamics are significantly influenced by the phase behavior of surfactants water oil systems in the type i phase environment the displacement pattern is uniform and consistent throughout the process while the displacement patterns in type iii and type ii phase environments are significantly different from that in the type i phase environment that is two displacement fronts are formed the surfactant phase behavior induced spatial heterogeneity in contact angle and ift is the possible reason leading to the unique displacement patterns in type iii and type ii phase environments which will be discussed later type i surfactant flood one displacement front was observed during the displacement in the type i phase environment emulsification took place as soon as the surfactant solution invaded the micromodel from the left column of fig 3 we can see that a significant amount of oil droplets was formed at the 0 1 pv of surfactant solution injection the emulsified area and the number of oil droplets continued to increase as more surfactant solution was injected the generated oil droplets could block the pore throat thus reducing the relative permeability of water since the displacement was unstable a preferential flow path was formed where the relative permeability of water was high the high flow rate in the preferential flow path led to the fast solubilization of oil droplets causing the number and the size of oil droplets in the preferential flow path to decrease during the displacement which further increased the relative permeability of water in the preferential flow path as a result a dissolution finger without the presence of oil droplets was formed after 2 0 pv of surfactant solution injection due to the formation of the dissolution finger most of the flow occurred through the finger which prevented the residual oil droplets from being efficiently recovered t y pe iii surfactant flood the displacement patterns in the type iii phase environment are shown in the middle column of fig 3 it can be seen that the displacement patterns in the type iii phase environment differ dramatically from those in the type i phase environment initially the oil saturation in the micromodel was 100 with no connate water several water ganglia appeared in the oil phase at the 0 1 pv of surfactant solution injection as the displacement continued more water fingers and ganglia were observed in the oil phase therefore we can say that two distinct displacement patterns are observed during the displacement in the type iii phase environment one of which is fingering and the other is a relatively more stable displacement meanwhile the water fingers moved faster than the stable displacement front resulting in the formation of two displacement fronts and a fast breakthrough 0 56 pv unlike the fingers formed at high ift the fingers were not stable and were easily broken up into several water ganglia more water ganglia were formed as the displacement proceeded after all the oil was displaced out of the micromodel the large ganglia of microemulsions with lower oil concentration and higher viscosity remained trapped to further reduce the saturation of the microemulsions continuous injection of surfactant solution is required t y pe ii surfactant flood fig 3 shows that the overall displacement patterns in the type ii phase environment are similar to those in the type iii phase environment the difference is that more water fingers and ganglia were observed in the oil phase during the displacement large water ganglia in oil appeared at 0 2 pv of surfactant solution injection as a result the second displacement front became less pronounced since the oil phase became discontinuous after the invasion of a large amount of water the water breakthrough occurred at only 0 35 pv of surfactant solution injection for the same volume of surfactant solution injection the displacement efficiency in the type ii phase environment is lower than in the type iii phase environment there were still oil ganglia in the micromodel after 2 pv of surfactant solution injection in the type ii phase environment in contrast after injecting the same volume of surfactant in the type iii phase environment all the oil was displaced out and only the microemulsions remained in the micromodel in summary the displacement pattern in the type i phase environment is similar to that of conventional immiscible displacement in contrast the two displacement fronts observed in type iii and type ii phase environments have been rarely reported water produced in type iii and type ii phase environments may be responsible for the unique displacement patterns 3 2 recovery efficiency to better understand the effect of phase behavior on the displacement dynamics we quantified the evolution of oil saturation in different phase environments as shown in fig 4 a summary of oil saturation at breakthrough and the injection of 2 0 pv surfactant solution is also shown in table 2 t y pe i surfactant flood the surfactant solution breakthrough occurred at a surfactant solution injection of 0 39 pv after the surfactant solution breakthrough the displacement efficiency reduced evidenced by a decrease in the slope of the oil saturation curve most of the residual large oil ganglia were broken up into smaller pore size oil ganglia as the displacement continued the further injection of surfactant solution reduced the oil saturation by solubilizing and mobilizing the small oil droplets due to the relatively high ift and low oil solubility in the micellar solution these residual oil droplets cannot be efficiently recovered the rate of oil saturation reduction was further slowed down with the formation of the solubilization finger as a result oil droplets near the solubilization finger were mobilized and solubilized first and the oil droplets far from the solubilization finger were less easily displaced the oil saturation was reduced to 0 2 after 2 0 pv of surfactant solution injection t y pe iii surfactant flood the water breakthrough happened when the surfactant solution was injected with 0 56 pv the slope of the oil saturation curve does not decrease significantly until the surfactant solution injection volume reaches 0 81 pv then the oil saturation reaches a plateau between 0 82 pv and 1 0 pv as shown in fig 4 the emergence of the plateau region is because of fingering the unstable displacement led to a rapid water breakthrough due to the capillary discontinuity the water accumulated in the downstream porous part of the micromodel capillary discontinuity also known as the capillary end effect refers to the accumulation of the wetting fluid in the end part of porous media because of the vanishing capillary pressures at the outlet gupta and maloney 2016 the capillary discontinuity can be suppressed as the capillary number increases which can be realized by increasing the flow rate or reducing the ift liang et al 2017 here the strong capillary end effect also indicates that the ift between oil and water is high rather than ultralow the oil saturation continued to decrease after the injection volume exceeded 1 0 pv which is mainly contributed by the stable upstream displacement the oil saturation was reduced to 0 025 after 2 0 pv of surfactant solution injection t y pe ii surfactant flood the change of oil saturation with the injection volume in the type ii phase environment is similar to that in the type iii phase environment which is also due to the presence of two different displacement patterns the water breakthrough occurred at only 0 3 pv injection of surfactant solution due to more water being produced and entering the oil phase from fig 4 we can see that the plateau of oil saturation of the type ii phase environment is broader than that of the type iii phase environment because more water is produced in the type ii phase environment than in the type iii phase environment the accumulated water in the downstream porous zone led to the appearance of the plateau in fig 4 see figure s7 for more details the oil saturation in the type ii phase environment was reduced to 0 15 after 2 0 pv of surfactant solution injection which is higher than that in the type iii phase environment besides producing more water the higher oil water ift γ 0 010 mn m and lower solubilization rate in the type ii phase environment than in the type iii phase environment also accounted for the lower displacement efficiency after the water breakthrough in conclusion the fluid fluid displacement is least efficient in the type i phase environment the displacement is unstable and the oil cannot be efficiently displaced after a water breakthrough in contrast in type iii and type ii phase environments the displacement efficiency is higher because of the presence of a more stable displacement front nevertheless the unstable displacement front due to fingering led to early water breakthrough which reduced the displacement efficiency 4 discussion 4 1 evolution of oil saturation profiles more insights into the displacement processes in different phase environments can be obtained from the change of oil saturation profiles as a function of normalized distance x x l where x is the distance from the inlet to a point and l is the length of the micromodel as shown in fig 5 from fig 5 a we can see that the general trend of the oil saturation profile before the injected surfactant solution breakthrough in a type i phase environment is monotonically increasing from the inlet to the outlet in the type i phase environment the surfactant concentration at the displacement front did not significantly decrease as the displacement proceeds because surfactant molecules prefer to partition in the aqueous phase resulting in almost no change in the oil water ift throughout the displacement process additionally we observed no change in micromodel wettability in the type i phase environment therefore we can say that the two major factors determining the displacement patterns ift and contact angle were spatially and temporally homogeneous in the type i phase environment the oil saturation profile becomes nonmonotonic as the displacement proceeds in type iii and type ii phase environments corresponding to the formation of two displacement fronts as shown in fig 5 b c the steep slope of the upstream oil saturation profile indicates the relatively stable displacement front in comparison the unstable displacement fronts were gradually formed during the displacement processes as evidenced by the gradual emergence of dips in the downstream oil saturation profiles the dip formed in the oil saturation profile in the type ii phase environment is larger than that formed in the type iii phase environment at the same pore volume of surfactant solution injection as mentioned in section 3 1 the water fingers were occasionally broken into ganglia these water ganglia correspond to the dips in the saturation profiles the injected water typically forms connected pathways rather than ganglia for oil water displacement without surfactant in contrast due to the presence of two displacement fronts in type iii and type ii phase environments the oil behind the water fingers also flows as it was displaced by the surfactant solution second front as a result the water that formed fingers was also displaced by oil making it disconnected for the equilibrated surfactant water oil systems in type iii and type ii phase environments most of the surfactants partition in the microemulsion phase and the amount of surfactant partitioned in the water phase is negligible thus for surfactant flooding in type iii and type ii phase environments the surfactant concentration in the aqueous phase adjacent to the oil phase is significantly lower compared to the aqueous phase away from the oil phase as mentioned earlier the conventional notion is that the microemulsions formed during type iii surfactant flooding locate between the aqueous and oil phases so the water and oil do not come into contact however recent studies have shown a lag in the formation of microemulsions liang et al 2020 moreover due to the nonwetting nature of microemulsions at optimum salinity the microemulsions do not spread at the oil water interface sottmann and strey 1997 making contact between the oil and aqueous phases inevitable additionally since the displacement is not completely piston like in both type iii and type ii phase environments the residual oil acts as a surfactant absorber thereby reducing the surfactant concentration in the aqueous phase therefore we can infer that the downstream oil was displaced by water while the surfactant solution displaced only the upstream oil the significant difference in ift caused the displacement to take place at two significantly different capillary numbers which is a critical reason for the formation of the two displacement fronts moreover the surfactant solution oil and water oil contact angles on the pore surface were dramatically different which is another key factor leading to the formation of the two displacement fronts additionally saturation overshoot was observed in type iii and type ii phase environments namely the water saturation in the fingertip was higher than in the finger tail at water breakthrough the water saturation of the fingertip was 0 42 and 0 59 for type iii and type ii phase environments respectively spatially non homogeneous contact angle and ift led to a nonmonotonic capillary pressure which may be the reason for saturation overshoot dicarlo 2007 therefore the saturation overshoot which is not considered to play a role in the surfactant flooding process can also take place in the surfactant process and affect the displacement efficiency 4 2 phase behavior induced separation of displacement fronts the main reason for the formation of two displacement fronts in type iii and type ii phase environments as discussed previously is that oil surfactant solutions and oil water have different ifts and exhibit different contact angles at the pore surface here we illustrate the details of the phase behavior induced separation of displacement fronts fig 6 shows the image captured during the displacement in the type iii phase environment we can see that there are two displacement fronts in the image the water displaced oil in a fingering manner forming the first front while the surfactant displaced the oil in a more stable manner which formed the second front it is worth noting that the displacement of oil by water at the first front appeared as imbibition in contrast the displacement of oil by surfactant solution at the second front appeared as drainage suggesting that the contact angle was spatially non homogeneous during the displacement in the type iii phase environment here we quantified the advancing contact angle at the two fronts as shown in fig 7 remember that the micromodels used were initially water wet however from fig 7 we can see that for both type iii and type ii phase behavior the water advancing contact angle is mostly in the range of 30 40o while the surfactant advancing contact angle is mainly in the range of 130 140o for the displacement in the type ii phase environment the surfactant in the aqueous phase had already been depleted by diffusing into the microemulsions upstream at late times as a result the surfactant advancing contact angle for a normalized distance greater than 0 6 was not presented the oil became the wetting phase at the second displacement front compared to the surfactant solution it is perhaps due to the diffusion of surfactant molecules from the aqueous phase to the oil phase under non equilibrium conditions resulting in a change in surface energy in addition the ultralow oil water ift increased the capillary number leading to an increase in dynamic contact angle the relationship between the dynamic contact angle and the capillary number is described by cox law snoeijer and andreotti 2013 3 θ d 3 θ s 3 9 c a l n α l 0 l i where θ d and θ s are the dynamic and static contact angles respectively α is a numerical constant and l 0 and li are macroscopic and microscopic lengths respectively thus the ultralow ift also contributed to the displacement appearing as drainage since the oil surfactant solution displacement was drainage the capillary forces acted as resistances to the displacement while at the first displacement front the oil water displacement was imbibition the capillary forces were the driving forces of the displacement therefore driven by the capillary forces the water flowed at a higher velocity than the surfactant solution it formed the fingers which led to the formation of two displacement fronts as shown in fig 6 to better understand the process of displacement front separation we determined the change of the displacement front location as a function of pore volume injected illustrated in fig 8 the dashed line is used as a reference showing the displacement front position change at the injection velocity 0 3 m day it can be noted that the water front was formed as soon as the surfactant solution invaded the micromodel the curves of the first front are above the reference line since more water was produced in the type ii phase environment than in the type iii phase environment the average velocity of the first front is 0 91 m day in the type ii phase environment which is faster than 0 55 m day in the type iii phase environment in contrast initially the second front moved at a velocity close to 0 3 m day the velocity decreased as displacement proceeded the reason for this is that as the displacement progressed the surfactant solution interacted with the remaining oil to create microemulsions that depleted the surfactant in the aqueous phase and produced more water which caused the second front velocity to decrease the second front moved at an average velocity of 0 17 m day in the type ii phase environment which was slower than the average second front velocity of 0 22 m day in the type iii phase environment from fig 8 it can also be noticed that the distance between the two fronts increased as the displacement proceeded and showed no sign of slowing down because the velocity difference between two fronts was more prominent in the type ii phase environment the distance between two fronts in the type ii phase environment was greater than that in the type iii phase environment for the same pore volumes of surfactant solution injected at water breakthrough the normalized distance between the two fronts was 0 83 in the type ii phase environment while it was 0 51 in the type iii phase environment 4 3 temporal and spatial variations of ift and contact angle ift and contact angle are temporally and spatially constant for immiscible displacement without interphase mass transfer in our study phase behavior induced significant temporal and spatial variations in ift and contact angle in type iii and type ii phase environments as demonstrated previously two displacement fronts were formed in type iii and type ii phase environments considering that the faster front was formed by water and the slower front was formed by surfactant solution the ultralow or low ift existed only in the region behind the slower front and the ift was high in the region between these two fronts here we roughly showed the heterogeneity of ifts in fig 8 when the surfactant solution was introduced into the micromodel high ift regions appeared and their area increased as the displacement proceeded at water breakthrough the distances between the water front and the surfactant solution front were 0 51 and 0 83 in type iii and type ii phase environments respectively therefore we can infer that there may be a large high ift region in a surfactant flooding process which may even be larger than the ultralow ift region therefore ift is spatially heterogeneous in type iii and type ii phase environments and the ift obtained from phase behavior tests is only applicable at the second displacement front from fig 8 we can also infer that the surfactant concentration was not spatially uniformly during the displacement there were almost no surfactants in both the aqueous and oil phases in the high ift region in contrast in the ultralow or low ift region surfactants presented in both the aqueous and microemulsion phases the concentration of surfactants in microemulsions was even higher than that in the aqueous phase moreover for the residual microemulsion ganglia behind the second displacement front the microemulsion ganglia kept being diluted by the injected fresh surfactant solution their compositions approached the left side binodal in the ternary phase diagram nelson and pope 1978 figure s8 shows the change of a microemulsion ganglion during the displacement in the type iii phase environment we can see that the ganglion became larger and lighter in color and finally disappeared as the displacement proceeded which indicates the ganglion was becoming more water rich during this process the ift was continuously decreasing rather than remaining constant eventually the microemulsion ganglion was solubilized in the aqueous phase when the total composition entered the single phase region therefore the ift between the microemulsion ganglia and the injected surfactant solution varies with time the ift in this process is expected to be lower than the ift calculated from the phase behavior tests reed and healy 1984 besides the ift the phase behavior of surfactant oil water systems also resulted in temporal and spatial variations in contact angle figs 6 and 7 show that the contact angle at the first and second displacement fronts significantly differed in type iii and type ii phase environments water was the wetting phase at the first front while oil was the wetting phase at the second front in addition to the displacement front the contact angle in the region behind the second front showed a temporal variation during the displacement as can be seen from fig 9 a at 0 54 pv of surfactant solution injection the pore surface was perfectly wetted by the residual oil microemulsions dark red color with high oil content leading to the formation of water in oil emulsions while for the residual microemulsions light red color with low oil content the pore surface was only partially wetted by them the formed water in oil emulsions were not stable and most of them ruptured at a later stage as shown in fig 9 b the change of contact angle led to the destabilization of the water in oil emulsions fig 9 b shows that the micromodel was partially wetted by the microemulsions which had a higher water content than the microemulsions that completely wetted the micromodel in summary the initially water wet micromodel can be perfectly wet by the oil rich microemulsions oil compared to the surfactant solutions then the microemulsions become more water rich as water and surfactants diffuse into them during the displacement the dilution of the oil rich microemulsions is accompanied by dewetting the microemulsions on the pore surface resulting in the rupture of water in oil emulsions 5 implications and limitations 5 1 field scale implications as discussed previously in type iii and type ii phase environments the phase behavior induced heterogeneity in capillary pressures leads to two displacement fronts with different velocities this phenomenon can have a non negligible impact on large scale displacement here we illustrate on what scales and to what extent the surfactant phase behavior can affect the fluid fluid displacement we use a circular capillary as a simplification of the aquifer although the circular capillary is one of the most straightforward cases of an idealized porous medium with fundamental physics much insight can be gained from studying this simple system mason and morrow 2013 the radius of the capillary is r the viscosities μ of surfactant solution water and oil are all assumed to be 1 0 mpa s and the surfactant solution oil ift and water oil ift are set to be 3 0 10 3 mn m and 9 0 mn m respectively the advancing contact angles for the displacement of oil by surfactant solution and the displacement of oil by water are assumed to be 134o and 40o respectively the applied pressure and capillary pressure are assumed to be constant during displacement since the typical velocity of a subsurface process is about 0 3 m day the applied pressure is set to the pressure at which a single aqueous phase flows at a velocity of 0 3 m day the applied pressure can be obtained using the hagen poiseuille equation δp applied 8 μ l v r 2 the capillary pressure can be described using the young laplace equation δp c 2 γ c o s θ r the length of the capillary l is varied from 0 3 m to 300 m which covers the typical well spacing for aquifer remediation and oil production finally the total pressures during the oil water displacement and the oil surfactant solution displacement are δpapplied δp c o w and δpapplied δp c o s respectively where δp c o w is the capillary pressure between oil and water δp c o w is the capillary pressure between oil and surfactant solution fig 10 shows the pressure ratio for oil water displacement and the oil surfactant solution displacement as the capillary length increases the applied pressure increases linearly while the capillary pressure remains constant making the pressure ratio approaches 1 this indicates that in field applications the two displacement fronts caused by the phase behavior become less pronounced as the well distance increases eventually the phase behavior does not affect the displacement pattern additionally since δ p a p p l i e d 1 r 2 and δ p c 1 r this indicates that the applied pressure increases faster than the capillary pressure as the capillary radius decreases from fig 10 a we can see that the capillary pressure significantly affects the displacement when the capillary radius is larger we also determined the velocity change as a function of capillary length for different capillary radii as shown in fig 10 b the velocity of oil water displacement and oil surfactant solution displacement can be expressed by the hagen poiseuille equation 4 v water δ p applied δ p c o w r 2 8 μ l 5 v surfactant δ p applied δ p c o s r 2 8 μ l we can see that the velocity of surfactant solution is almost independent of capillary length and radius close to 0 3 m day which indicates that viscous forces dominate capillary forces due to the ultralow ift in contrast capillary pressures play a significant role in the oil water displacement especially for small capillary lengths the water velocity at l 0 3 m is 25 1 2 78 and 0 548 m day when r 50 5 and 0 5 um respectively which is much higher than 0 3 m day the water velocity decreases as the capillary length and radius increase and approaches 0 3 m day this suggests that the effect of the phase behavior of surfactant water oil systems on the displacement is more significant for aquifers with higher permeability and smaller well distance which can lead to an early water breakthrough and a reduction in displacement efficiency 5 2 mitigating the impact of phase behavior on displacement for sear a single stable displacement front is favored to obtain a high displacement efficiency based on our study it can be inferred that an unstable displacement will occur in the type iii phase environment during sear in water wet aquifers even if the surfactant solution is slightly more viscous than napl the early water breakthrough reduces the displacement efficiency and a continuous surfactant solution injection is required until all the residual napl is extracted therefore the production of water during sear is undesirable and needs to be suppressed or eliminated as far as we can see one possible solution is to limit the mass transfer rate of surfactants to form microemulsions which may allow the upstream surfactant to diffuse to the displacement front and maintain an ultralow ift throughout the displacement process this may be realized by using slow release technologies such as encapsulated surfactant systems furthermore we know from the phase behavior tests that for the surfactant water oil systems at the optimum salinity the volume of water in equilibrium with the microemulsion phase depends on the solubilization ratio and surfactant concentration thus another possible solution is to develop a robust surfactant formulation that produces little or no water at optimal salinity at low surfactant concentrations 5 3 limitations our study shows that the phase behavior of surfactant water oil systems significantly affects the displacement dynamics in 2d microfluidic chips microfluidics is a powerful tool for understanding the physics associated with multiphase displacements while providing enough detail to study the spatial and temporal variations of ift and contact angle the 2d microfluidic chips we used have some limitations in representing natural rocks since the chips are homogeneous and lack 3d connectivity from fig 8 we know that the average water velocity is 0 91 m day in the type ii phase environment which is much lower than that calculated using the hagen poiseuille equation the reason is that the water fingers intermittently break into ganglia because of the flow of oil upstream 3d porous media typically have higher connectivity than 2d porous media which may favor the formation of connected water pathways therefore the impact of the phase behavior of surfactant water oil systems on the displacement in natural rocks needs to be further investigated 6 conclusions the displacements in different phase environments were conducted in water wet micromodels to investigate the effect of the phase behavior of surfactant water oil systems on displacement our study suggests that phase behavior significantly affects pore scale displacement patterns and recovery of the displaced fluid the main findings are as follows 1 the spatial heterogeneity in contact angle and ift in type iii and type ii phase environments led to the formation of two distinct displacement fronts which resulted in the variation of displacement patterns in different phase environments 2 in the type i phase environment most surfactants remained in the water the oil water ift maintained constant during the displacement which led to a single constant displacement pattern 3 in type iii and type ii phase environments ift varied significantly along the flow direction due to the transfer of surfactant from the aqueous phase to the microemulsion phase coexistence of high and ultralow ifts the contact angle also changed significantly along the flow direction which resulted in the separation of displacement fronts credit authorship contribution statement weipeng yang conceptualization investigation writing original draft guoyu chu investigation yujing du writing review editing ke xu formal analysis writing review editing erdong yao writing review editing tianbo liang writing review editing bing wei writing review editing haiyang yu writing review editing jian hou writing review editing jun lu conceptualization writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research was supported in part by a faculty research grant at the university of tulsa the authors acknowledge the mcdougall school of petroleum engineering at the university of tulsa for supporting this research supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2022 104288 appendix supplementary materials image application 1 
98,surfactant flooding is widely used in subsurface applications where high displacement efficiency is needed such as nonaqueous phase liquid napl remediation and enhanced oil recovery eor for surfactant water oil systems the partitioning of surfactants in each phase is controlled by external factors such as salinity the third phase microemulsions which locates between water and oil can be formed spontaneously at certain salinities therefore the transfer of surfactants from water to other phases which depends on salinity can occur during surfactant flooding resulting in spatially non homogeneous surfactant concentrations the critical parameters governing the displacement dynamics such as contact angle and interfacial tension ift can vary considerably due to spatially non homogeneous surfactant concentrations however the influence of spatially non homogeneous contact angle and ift on the displacement in porous media has not been sufficiently explored in this work we visualized the surfactant flooding at different salinities in 2d micromodels our results suggest that the displacement patterns vary considerably with salinity one displacement front was observed at low salinity while displacement front separation occurred at intermediate and high salinity forming two different displacement fronts at intermediate and high salinity we noticed that the downstream displacement was imbibition while the upstream displacement was drainage we suggest that the separation of displacement fronts was capillary driven arising from spatially non homogeneous contact angle and ift our study provides new insights into the effect of the phase behavior of surfactant water oil systems on displacement patterns keywords napl remediation displacement patterns surfactant phase behavior microfluidics data availability data will be made available on request 1 introduction fluid fluid displacement is essential in many subsurface applications including oil recovery healy and reed 1977 aquifer remediation dwarakanath et al 1999 ouyang et al 2002 zhong et al 2001 and co2 sequestration berg et al 2013 hu et al 2017 li et al 2019 in these processes a high displacement efficiency is desired capillary trapping which occurs at low capillary numbers ca µv γ where µ is the viscosity of invading fluids v is the interstitial velocity and γ is the interfacial tension is one of the primary mechanisms that limit the recovery of displaced fluid from porous media chatzis and morrow 1984 iglauer et al 2015 reducing interfacial tension ift is an effective method to increase the capillary number and therefore improve the displacement efficiency of the trapped fluid surfactants are widely used to reduce ift to low or ultralow levels for enhanced oil recovery eor and surfactant enhanced aquifer remediation sear healy et al 1975 hirasaki et al 2011 jayanti et al 2002 phase behavior describes the behavior of liquids gases and solids as a function of temperature pressure and more factors whitson and brulé 2000 specifically the phase behavior of surfactant water oil systems is a function of salinity it is more complex than the phase behavior of water oil systems due to the formation of microemulsions healy and reed 1977 microemulsions are thermodynamically stable macroscopically homogeneous mixtures of oil water and surfactants since the free energy of microemulsions is lower than that of the separated water and oil phases they form spontaneously when appropriate surfactants are introduced to the water oil systems to reduce the ift miller 1988 according to winsor winsor 1954 microemulsions can be classified into lower phase oil in water middle phase bicontinuous and upper phase water in oil microemulsions depending on the curvature of the surfactant film the corresponding phase behaviors are known as type i type iii and type ii respectively fig 1 depicts a schematic of the phase behavior of surfactant water oil systems as a function of salinity the formation of type iii microemulsions the third phase results in the lowest oil water ift because the surfactants have a similar affinity for oil and water healy and reed 1977 huh 1979 the interfacial curvature of the surfactant film for anionic surfactants used in eor and sear is primarily influenced by the salinity of the water type i type iii and type ii microemulsions are formed at low medium and high salinity respectively as shown in fig 1 the majority of the surfactants partition in the microemulsions once the water surfactant oil systems have reached equilibrium while the water and oil coexisting with the microemulsion have very low surfactant concentrations huh 1979 during surfactant flooding although the surfactants are initially dissolved in water they leave the aqueous phase and accumulate in microemulsions in type iii and type ii phase environments therefore surfactant depleted water generated during the formation of type iii and type ii microemulsions leads to the spatial heterogeneity of surfactant concentration in the aqueous phase in type iii and type ii phase environments the oil surfactant solution ift is ultralow and low respectively while the oil water ift is high which leads to spatial heterogeneity in ift moreover the contact angle of microemulsions on pore surfaces varies with the composition of microemulsions this is because the microemulsions surfactant solution ift varies with the composition of microemulsions and the contact angle is a function of the microemulsions surfactant solution ift according to young s equation reed and healy 1984 de gennes 1985 these two factors can greatly affect the pore scale displacement pattern and the recovery of the defending fluid in addition the type iii microemulsions are immiscible with oil while the type ii microemulsions are miscible with oil which has different effects on flow dynamics the efficiency of a surfactant flooding process is one of the most important factors considered in subsurface applications the fingering of the injected surfactant solution significantly limits the displacement efficiency and should be avoided therefore it is necessary to understand the factors affecting displacement stability two phase immiscible displacement in 2d porous media has been extensively studied and described in the present literature cieplak and robbins 1990 hu et al 2018 jung et al 2016 lenormand et al 1988 zhao et al 2016 in the phase diagrams developed in these and other prior works the composition of each phase is in thermodynamic equilibrium so that the factors governing the displacement such as wettability and ift are spatially and temporally homogeneous recent pore scale studies show that the compositions of microemulsions formed under flow conditions vary spatially mejia et al 2019 tagavifar et al 2017 yang et al 2021 the surfactant solution oil solid systems are only in local thermodynamic equilibrium under flow conditions tagavifar et al 2017 israelachvili 1994 which indicates that the factors governing the displacement such as ift and contact angle can be spatially non homogeneous to the best of our knowledge the impact of surfactant phase behavior induced non homogeneous contact angle and ift on pore scale displacement is rarely considered which may make the displacement pattern deviate from that predicted by the conventional phase diagrams significantly although the surfactant flooding process has been extensively studied by performing coreflood experiments healy and reed 1977 dwarakanath et al 1999 flaaten et al 2009 lu et al 2014 lu and pope 2016 zheng et al 2022 the focus is mainly on macroscopic parameters such as displacement efficiency fractional flow and pressure the effect of surfactant phase behavior and the resulting spatial heterogeneity of ift and contact angle on microscopic displacement dynamics could not be revealed it is commonly believed that the oil is displaced by the formed type iii microemulsions and the type iii microemulsions are displaced by the aqueous chasing phase surfactant solution or water and the ift is assumed to be constant during the displacement process lu et al 2014 alzahid et al 2019 this assumption however may not hold during surfactant flooding because of the phase behavior induced spatial ift and contact angle heterogeneity it is still unknown how and to what extent the phase behavior of the surfactant water oil systems affects the displacement process which is critical for optimizing strategies for surfactant flooding and accurately modeling multiphase displacements involving surfactants direct experimental evidence is required to gain insights into the displacement patterns impacted by this spatial ift and contact angle heterogeneity micromodels have been proven to be a powerful tool for visualizing the small scale multiphase flow to understand the flow physics zhong et al 2001 li et al 2019 du et al 2020 xu et al 2017 yang et al 2021 zhang et al 2020 chang et al 2019 unsal et al 2016 mehmani et al mehmani et al 2019 conducted displacements in micromodels with different roughness they found that capillary trapping highly depends on grain surface roughness after a certain media dependent threshold broens and unsal broens and unsal 2018 performed surfactant flooding in microfluidic chips to investigate spontaneous emulsification in dead end pores the emulsification rate in dead end pores was determined by visualizing the emulsification processes therefore we utilize microfluidics to investigate the effect of phase behavior surfactant fluid fluid systems on multiphase displacement in this study we conducted experiments in all three phase environments in 2d homogenous inch scale reservoir on a chip glass micromodels decane was used as the representative of napl for micromodel displacement experiments we show that the displacement pattern varies significantly in different phase environments in particular the separation of displacement fronts was observed during the displacement process in type iii and type ii phase environments therefore we concluded that the spatial heterogeneity in ift and contact angle due to the different partitioning preferences of surfactants in different phase environments could lead to a more complex displacement pattern during the surfactant flooding process our study provides new insights into the effect of phase behavior on the displacement patterns during sear which is important for designing and optimizing the sear 2 materials and methods 2 1 materials two anionic surfactants internal olefin sulfonate ios c20 24 ios and alcohol propoxy sulfate aps c13 13po so4 were obtained from stepan company isobutanol iba purity 99 0 was purchased from alfa aesar and used as a co solvent to eliminate the formation of macroemulsions and reduce the viscosity of microemulsions sodium chloride nacl purity 99 0 was purchased from milipore simga and used to adjust the salinity of the surfactant solution to obtain different types of microemulsions decane purity 99 0 was purchased from alfa aesar and used as a representative of napl deionized water was used to prepare the surfactant solution 2 2 static phase behavior tests since we are interested in investigating the fluid fluid displacement in different phase environments a suitable surfactant formulation should be used and the phase behavior of the surfactant water oil system needs to be determined therefore static phase behavior tests were conducted to determine the diagram of the phase behavior of surfactant water oil systems the surfactant formulation consists of 1 0 wt ios 1 0 wt aps and 5 0 wt iba and the concentration of nacl in the surfactant solution increases in 0 1 wt increments to determine the phase diagram a glass pipette was filled with 2 ml of oil and 2 ml of surfactant solution and the pipette was then sealed the oil and surfactant solution in the pipette was mixed vigorously by hand shaking and incubated at 21 c until the system reached equilibrium the microemulsion water and microemulsion oil ifts were calculated using the chun huh equation huh 1979 which is shown below 1 γ c σ 2 where c is a constant and approximately equals 0 3 mn m for typical oils and surfactants σ is the solubilization ratio of oil or water details about the phase diagram are illustrated in test s1 and figures s1 and s2 the fluid properties in different phase environments are shown in table 1 2 3 fluid fluid displacement in micromodels figure s3 shows the experimental setup used in this study yang et al 2021 2d homogeneous glass micromodels were used in this experiment the micromodels were fabricated by the following processes uv lithography wet hydrofluoric acid etching and fusion bonding the images and dimensions of the micromodels are shown in figure s4 and table s1 respectively the micromodels used are water wet without any treatment to modify their wettability the in situ static water oil solid contact angle is 33 1o the viscosity of the surfactant solutions is 1 5 mpa s in all type i type iii and type ii phase environments and the viscosity of decane is 0 87 mpa s the oil soluble dye oil red egn was added to the decane to increase the contrast between phases to conduct fluid fluid displacement in the micromodel oil was first injected until the micromodel was fully saturated with oil then surfactant solution was injected into the micromodel from the inlet at the flow rate of 0 05 μl min velocity of 0 3 m day using a syringe pump harvard phd ultra and the corresponding ca is shown in table 1 the displacement stopped at 2 0 pv of surfactant solution injection a digital camera sony a7r2 with a macro lens 50mm f 2 8 was used to capture the displacement process every 90 seconds the captured images have 5126 pixels in width and 2961 pixels in height and the pixel size is 4 88 um 2 4 image processing the captured images are analyzed and processed using imagej for immiscible displacement the captured images are usually converted to grayscale images and then binarized to determine the saturation in a binary image the saturation of each phase at a given position can only be 0 or 1 the formation of microemulsions especially in type iii and type ii phase environments makes this method inapplicable because the oil content in microemulsions varies from 0 to 1 therefore we used the lambert beer law to relate the oil saturation with the grayscale value chen et al 2021 unsal et al 2019 the original image of the fully oil saturated micromodel was first subtracted from the light background and then converted to the 16 bits grayscale image the histogram of the 16 bits grayscale image is shown on the left of fig 2 a and the grayscale values of the pure oil phase and aqueous phase can be determined from the two peaks in the histogram there was noise in the images taken by the camera which impeded us from identifying the peaks in the histogram therefore the 16 bits grayscale images were further filtered using the non local means denoising filter to remove the noise from the images then as seen on the right of fig 2 a the peaks can be found in the histogram of the filtered image the workflow of image processing is shown in fig 2 b a calibration curve was created experimentally to determine the relationship between the grayscale value and the oil content the microemulsions with different oil contents were prepared by mixing surfactant solution with different salinities and decane dyed with oil red egn the detailed experimental procedure is shown in section 2 2 after the phase equilibrium was reached we extracted the microemulsions using a syringe with a needle then we injected the microemulsions into a micromodel to obtain the transmitted light intensity i at different oil contents finally the following relationship between oil content and normalized transmitted light intensity i i 0 was determined 2 i i 0 10 0 05931 c where i 0 is the intensity of the incident lights and c is the oil content the generated calibration curve is shown in figure s5 therefore the oil saturation in a micromodel can be calculated based on the grayscale value of images 3 results 3 1 displacement patterns the oil water displacements in different phase environments were performed in micromodels results show that the displacement dynamics are significantly influenced by the phase behavior of surfactants water oil systems in the type i phase environment the displacement pattern is uniform and consistent throughout the process while the displacement patterns in type iii and type ii phase environments are significantly different from that in the type i phase environment that is two displacement fronts are formed the surfactant phase behavior induced spatial heterogeneity in contact angle and ift is the possible reason leading to the unique displacement patterns in type iii and type ii phase environments which will be discussed later type i surfactant flood one displacement front was observed during the displacement in the type i phase environment emulsification took place as soon as the surfactant solution invaded the micromodel from the left column of fig 3 we can see that a significant amount of oil droplets was formed at the 0 1 pv of surfactant solution injection the emulsified area and the number of oil droplets continued to increase as more surfactant solution was injected the generated oil droplets could block the pore throat thus reducing the relative permeability of water since the displacement was unstable a preferential flow path was formed where the relative permeability of water was high the high flow rate in the preferential flow path led to the fast solubilization of oil droplets causing the number and the size of oil droplets in the preferential flow path to decrease during the displacement which further increased the relative permeability of water in the preferential flow path as a result a dissolution finger without the presence of oil droplets was formed after 2 0 pv of surfactant solution injection due to the formation of the dissolution finger most of the flow occurred through the finger which prevented the residual oil droplets from being efficiently recovered t y pe iii surfactant flood the displacement patterns in the type iii phase environment are shown in the middle column of fig 3 it can be seen that the displacement patterns in the type iii phase environment differ dramatically from those in the type i phase environment initially the oil saturation in the micromodel was 100 with no connate water several water ganglia appeared in the oil phase at the 0 1 pv of surfactant solution injection as the displacement continued more water fingers and ganglia were observed in the oil phase therefore we can say that two distinct displacement patterns are observed during the displacement in the type iii phase environment one of which is fingering and the other is a relatively more stable displacement meanwhile the water fingers moved faster than the stable displacement front resulting in the formation of two displacement fronts and a fast breakthrough 0 56 pv unlike the fingers formed at high ift the fingers were not stable and were easily broken up into several water ganglia more water ganglia were formed as the displacement proceeded after all the oil was displaced out of the micromodel the large ganglia of microemulsions with lower oil concentration and higher viscosity remained trapped to further reduce the saturation of the microemulsions continuous injection of surfactant solution is required t y pe ii surfactant flood fig 3 shows that the overall displacement patterns in the type ii phase environment are similar to those in the type iii phase environment the difference is that more water fingers and ganglia were observed in the oil phase during the displacement large water ganglia in oil appeared at 0 2 pv of surfactant solution injection as a result the second displacement front became less pronounced since the oil phase became discontinuous after the invasion of a large amount of water the water breakthrough occurred at only 0 35 pv of surfactant solution injection for the same volume of surfactant solution injection the displacement efficiency in the type ii phase environment is lower than in the type iii phase environment there were still oil ganglia in the micromodel after 2 pv of surfactant solution injection in the type ii phase environment in contrast after injecting the same volume of surfactant in the type iii phase environment all the oil was displaced out and only the microemulsions remained in the micromodel in summary the displacement pattern in the type i phase environment is similar to that of conventional immiscible displacement in contrast the two displacement fronts observed in type iii and type ii phase environments have been rarely reported water produced in type iii and type ii phase environments may be responsible for the unique displacement patterns 3 2 recovery efficiency to better understand the effect of phase behavior on the displacement dynamics we quantified the evolution of oil saturation in different phase environments as shown in fig 4 a summary of oil saturation at breakthrough and the injection of 2 0 pv surfactant solution is also shown in table 2 t y pe i surfactant flood the surfactant solution breakthrough occurred at a surfactant solution injection of 0 39 pv after the surfactant solution breakthrough the displacement efficiency reduced evidenced by a decrease in the slope of the oil saturation curve most of the residual large oil ganglia were broken up into smaller pore size oil ganglia as the displacement continued the further injection of surfactant solution reduced the oil saturation by solubilizing and mobilizing the small oil droplets due to the relatively high ift and low oil solubility in the micellar solution these residual oil droplets cannot be efficiently recovered the rate of oil saturation reduction was further slowed down with the formation of the solubilization finger as a result oil droplets near the solubilization finger were mobilized and solubilized first and the oil droplets far from the solubilization finger were less easily displaced the oil saturation was reduced to 0 2 after 2 0 pv of surfactant solution injection t y pe iii surfactant flood the water breakthrough happened when the surfactant solution was injected with 0 56 pv the slope of the oil saturation curve does not decrease significantly until the surfactant solution injection volume reaches 0 81 pv then the oil saturation reaches a plateau between 0 82 pv and 1 0 pv as shown in fig 4 the emergence of the plateau region is because of fingering the unstable displacement led to a rapid water breakthrough due to the capillary discontinuity the water accumulated in the downstream porous part of the micromodel capillary discontinuity also known as the capillary end effect refers to the accumulation of the wetting fluid in the end part of porous media because of the vanishing capillary pressures at the outlet gupta and maloney 2016 the capillary discontinuity can be suppressed as the capillary number increases which can be realized by increasing the flow rate or reducing the ift liang et al 2017 here the strong capillary end effect also indicates that the ift between oil and water is high rather than ultralow the oil saturation continued to decrease after the injection volume exceeded 1 0 pv which is mainly contributed by the stable upstream displacement the oil saturation was reduced to 0 025 after 2 0 pv of surfactant solution injection t y pe ii surfactant flood the change of oil saturation with the injection volume in the type ii phase environment is similar to that in the type iii phase environment which is also due to the presence of two different displacement patterns the water breakthrough occurred at only 0 3 pv injection of surfactant solution due to more water being produced and entering the oil phase from fig 4 we can see that the plateau of oil saturation of the type ii phase environment is broader than that of the type iii phase environment because more water is produced in the type ii phase environment than in the type iii phase environment the accumulated water in the downstream porous zone led to the appearance of the plateau in fig 4 see figure s7 for more details the oil saturation in the type ii phase environment was reduced to 0 15 after 2 0 pv of surfactant solution injection which is higher than that in the type iii phase environment besides producing more water the higher oil water ift γ 0 010 mn m and lower solubilization rate in the type ii phase environment than in the type iii phase environment also accounted for the lower displacement efficiency after the water breakthrough in conclusion the fluid fluid displacement is least efficient in the type i phase environment the displacement is unstable and the oil cannot be efficiently displaced after a water breakthrough in contrast in type iii and type ii phase environments the displacement efficiency is higher because of the presence of a more stable displacement front nevertheless the unstable displacement front due to fingering led to early water breakthrough which reduced the displacement efficiency 4 discussion 4 1 evolution of oil saturation profiles more insights into the displacement processes in different phase environments can be obtained from the change of oil saturation profiles as a function of normalized distance x x l where x is the distance from the inlet to a point and l is the length of the micromodel as shown in fig 5 from fig 5 a we can see that the general trend of the oil saturation profile before the injected surfactant solution breakthrough in a type i phase environment is monotonically increasing from the inlet to the outlet in the type i phase environment the surfactant concentration at the displacement front did not significantly decrease as the displacement proceeds because surfactant molecules prefer to partition in the aqueous phase resulting in almost no change in the oil water ift throughout the displacement process additionally we observed no change in micromodel wettability in the type i phase environment therefore we can say that the two major factors determining the displacement patterns ift and contact angle were spatially and temporally homogeneous in the type i phase environment the oil saturation profile becomes nonmonotonic as the displacement proceeds in type iii and type ii phase environments corresponding to the formation of two displacement fronts as shown in fig 5 b c the steep slope of the upstream oil saturation profile indicates the relatively stable displacement front in comparison the unstable displacement fronts were gradually formed during the displacement processes as evidenced by the gradual emergence of dips in the downstream oil saturation profiles the dip formed in the oil saturation profile in the type ii phase environment is larger than that formed in the type iii phase environment at the same pore volume of surfactant solution injection as mentioned in section 3 1 the water fingers were occasionally broken into ganglia these water ganglia correspond to the dips in the saturation profiles the injected water typically forms connected pathways rather than ganglia for oil water displacement without surfactant in contrast due to the presence of two displacement fronts in type iii and type ii phase environments the oil behind the water fingers also flows as it was displaced by the surfactant solution second front as a result the water that formed fingers was also displaced by oil making it disconnected for the equilibrated surfactant water oil systems in type iii and type ii phase environments most of the surfactants partition in the microemulsion phase and the amount of surfactant partitioned in the water phase is negligible thus for surfactant flooding in type iii and type ii phase environments the surfactant concentration in the aqueous phase adjacent to the oil phase is significantly lower compared to the aqueous phase away from the oil phase as mentioned earlier the conventional notion is that the microemulsions formed during type iii surfactant flooding locate between the aqueous and oil phases so the water and oil do not come into contact however recent studies have shown a lag in the formation of microemulsions liang et al 2020 moreover due to the nonwetting nature of microemulsions at optimum salinity the microemulsions do not spread at the oil water interface sottmann and strey 1997 making contact between the oil and aqueous phases inevitable additionally since the displacement is not completely piston like in both type iii and type ii phase environments the residual oil acts as a surfactant absorber thereby reducing the surfactant concentration in the aqueous phase therefore we can infer that the downstream oil was displaced by water while the surfactant solution displaced only the upstream oil the significant difference in ift caused the displacement to take place at two significantly different capillary numbers which is a critical reason for the formation of the two displacement fronts moreover the surfactant solution oil and water oil contact angles on the pore surface were dramatically different which is another key factor leading to the formation of the two displacement fronts additionally saturation overshoot was observed in type iii and type ii phase environments namely the water saturation in the fingertip was higher than in the finger tail at water breakthrough the water saturation of the fingertip was 0 42 and 0 59 for type iii and type ii phase environments respectively spatially non homogeneous contact angle and ift led to a nonmonotonic capillary pressure which may be the reason for saturation overshoot dicarlo 2007 therefore the saturation overshoot which is not considered to play a role in the surfactant flooding process can also take place in the surfactant process and affect the displacement efficiency 4 2 phase behavior induced separation of displacement fronts the main reason for the formation of two displacement fronts in type iii and type ii phase environments as discussed previously is that oil surfactant solutions and oil water have different ifts and exhibit different contact angles at the pore surface here we illustrate the details of the phase behavior induced separation of displacement fronts fig 6 shows the image captured during the displacement in the type iii phase environment we can see that there are two displacement fronts in the image the water displaced oil in a fingering manner forming the first front while the surfactant displaced the oil in a more stable manner which formed the second front it is worth noting that the displacement of oil by water at the first front appeared as imbibition in contrast the displacement of oil by surfactant solution at the second front appeared as drainage suggesting that the contact angle was spatially non homogeneous during the displacement in the type iii phase environment here we quantified the advancing contact angle at the two fronts as shown in fig 7 remember that the micromodels used were initially water wet however from fig 7 we can see that for both type iii and type ii phase behavior the water advancing contact angle is mostly in the range of 30 40o while the surfactant advancing contact angle is mainly in the range of 130 140o for the displacement in the type ii phase environment the surfactant in the aqueous phase had already been depleted by diffusing into the microemulsions upstream at late times as a result the surfactant advancing contact angle for a normalized distance greater than 0 6 was not presented the oil became the wetting phase at the second displacement front compared to the surfactant solution it is perhaps due to the diffusion of surfactant molecules from the aqueous phase to the oil phase under non equilibrium conditions resulting in a change in surface energy in addition the ultralow oil water ift increased the capillary number leading to an increase in dynamic contact angle the relationship between the dynamic contact angle and the capillary number is described by cox law snoeijer and andreotti 2013 3 θ d 3 θ s 3 9 c a l n α l 0 l i where θ d and θ s are the dynamic and static contact angles respectively α is a numerical constant and l 0 and li are macroscopic and microscopic lengths respectively thus the ultralow ift also contributed to the displacement appearing as drainage since the oil surfactant solution displacement was drainage the capillary forces acted as resistances to the displacement while at the first displacement front the oil water displacement was imbibition the capillary forces were the driving forces of the displacement therefore driven by the capillary forces the water flowed at a higher velocity than the surfactant solution it formed the fingers which led to the formation of two displacement fronts as shown in fig 6 to better understand the process of displacement front separation we determined the change of the displacement front location as a function of pore volume injected illustrated in fig 8 the dashed line is used as a reference showing the displacement front position change at the injection velocity 0 3 m day it can be noted that the water front was formed as soon as the surfactant solution invaded the micromodel the curves of the first front are above the reference line since more water was produced in the type ii phase environment than in the type iii phase environment the average velocity of the first front is 0 91 m day in the type ii phase environment which is faster than 0 55 m day in the type iii phase environment in contrast initially the second front moved at a velocity close to 0 3 m day the velocity decreased as displacement proceeded the reason for this is that as the displacement progressed the surfactant solution interacted with the remaining oil to create microemulsions that depleted the surfactant in the aqueous phase and produced more water which caused the second front velocity to decrease the second front moved at an average velocity of 0 17 m day in the type ii phase environment which was slower than the average second front velocity of 0 22 m day in the type iii phase environment from fig 8 it can also be noticed that the distance between the two fronts increased as the displacement proceeded and showed no sign of slowing down because the velocity difference between two fronts was more prominent in the type ii phase environment the distance between two fronts in the type ii phase environment was greater than that in the type iii phase environment for the same pore volumes of surfactant solution injected at water breakthrough the normalized distance between the two fronts was 0 83 in the type ii phase environment while it was 0 51 in the type iii phase environment 4 3 temporal and spatial variations of ift and contact angle ift and contact angle are temporally and spatially constant for immiscible displacement without interphase mass transfer in our study phase behavior induced significant temporal and spatial variations in ift and contact angle in type iii and type ii phase environments as demonstrated previously two displacement fronts were formed in type iii and type ii phase environments considering that the faster front was formed by water and the slower front was formed by surfactant solution the ultralow or low ift existed only in the region behind the slower front and the ift was high in the region between these two fronts here we roughly showed the heterogeneity of ifts in fig 8 when the surfactant solution was introduced into the micromodel high ift regions appeared and their area increased as the displacement proceeded at water breakthrough the distances between the water front and the surfactant solution front were 0 51 and 0 83 in type iii and type ii phase environments respectively therefore we can infer that there may be a large high ift region in a surfactant flooding process which may even be larger than the ultralow ift region therefore ift is spatially heterogeneous in type iii and type ii phase environments and the ift obtained from phase behavior tests is only applicable at the second displacement front from fig 8 we can also infer that the surfactant concentration was not spatially uniformly during the displacement there were almost no surfactants in both the aqueous and oil phases in the high ift region in contrast in the ultralow or low ift region surfactants presented in both the aqueous and microemulsion phases the concentration of surfactants in microemulsions was even higher than that in the aqueous phase moreover for the residual microemulsion ganglia behind the second displacement front the microemulsion ganglia kept being diluted by the injected fresh surfactant solution their compositions approached the left side binodal in the ternary phase diagram nelson and pope 1978 figure s8 shows the change of a microemulsion ganglion during the displacement in the type iii phase environment we can see that the ganglion became larger and lighter in color and finally disappeared as the displacement proceeded which indicates the ganglion was becoming more water rich during this process the ift was continuously decreasing rather than remaining constant eventually the microemulsion ganglion was solubilized in the aqueous phase when the total composition entered the single phase region therefore the ift between the microemulsion ganglia and the injected surfactant solution varies with time the ift in this process is expected to be lower than the ift calculated from the phase behavior tests reed and healy 1984 besides the ift the phase behavior of surfactant oil water systems also resulted in temporal and spatial variations in contact angle figs 6 and 7 show that the contact angle at the first and second displacement fronts significantly differed in type iii and type ii phase environments water was the wetting phase at the first front while oil was the wetting phase at the second front in addition to the displacement front the contact angle in the region behind the second front showed a temporal variation during the displacement as can be seen from fig 9 a at 0 54 pv of surfactant solution injection the pore surface was perfectly wetted by the residual oil microemulsions dark red color with high oil content leading to the formation of water in oil emulsions while for the residual microemulsions light red color with low oil content the pore surface was only partially wetted by them the formed water in oil emulsions were not stable and most of them ruptured at a later stage as shown in fig 9 b the change of contact angle led to the destabilization of the water in oil emulsions fig 9 b shows that the micromodel was partially wetted by the microemulsions which had a higher water content than the microemulsions that completely wetted the micromodel in summary the initially water wet micromodel can be perfectly wet by the oil rich microemulsions oil compared to the surfactant solutions then the microemulsions become more water rich as water and surfactants diffuse into them during the displacement the dilution of the oil rich microemulsions is accompanied by dewetting the microemulsions on the pore surface resulting in the rupture of water in oil emulsions 5 implications and limitations 5 1 field scale implications as discussed previously in type iii and type ii phase environments the phase behavior induced heterogeneity in capillary pressures leads to two displacement fronts with different velocities this phenomenon can have a non negligible impact on large scale displacement here we illustrate on what scales and to what extent the surfactant phase behavior can affect the fluid fluid displacement we use a circular capillary as a simplification of the aquifer although the circular capillary is one of the most straightforward cases of an idealized porous medium with fundamental physics much insight can be gained from studying this simple system mason and morrow 2013 the radius of the capillary is r the viscosities μ of surfactant solution water and oil are all assumed to be 1 0 mpa s and the surfactant solution oil ift and water oil ift are set to be 3 0 10 3 mn m and 9 0 mn m respectively the advancing contact angles for the displacement of oil by surfactant solution and the displacement of oil by water are assumed to be 134o and 40o respectively the applied pressure and capillary pressure are assumed to be constant during displacement since the typical velocity of a subsurface process is about 0 3 m day the applied pressure is set to the pressure at which a single aqueous phase flows at a velocity of 0 3 m day the applied pressure can be obtained using the hagen poiseuille equation δp applied 8 μ l v r 2 the capillary pressure can be described using the young laplace equation δp c 2 γ c o s θ r the length of the capillary l is varied from 0 3 m to 300 m which covers the typical well spacing for aquifer remediation and oil production finally the total pressures during the oil water displacement and the oil surfactant solution displacement are δpapplied δp c o w and δpapplied δp c o s respectively where δp c o w is the capillary pressure between oil and water δp c o w is the capillary pressure between oil and surfactant solution fig 10 shows the pressure ratio for oil water displacement and the oil surfactant solution displacement as the capillary length increases the applied pressure increases linearly while the capillary pressure remains constant making the pressure ratio approaches 1 this indicates that in field applications the two displacement fronts caused by the phase behavior become less pronounced as the well distance increases eventually the phase behavior does not affect the displacement pattern additionally since δ p a p p l i e d 1 r 2 and δ p c 1 r this indicates that the applied pressure increases faster than the capillary pressure as the capillary radius decreases from fig 10 a we can see that the capillary pressure significantly affects the displacement when the capillary radius is larger we also determined the velocity change as a function of capillary length for different capillary radii as shown in fig 10 b the velocity of oil water displacement and oil surfactant solution displacement can be expressed by the hagen poiseuille equation 4 v water δ p applied δ p c o w r 2 8 μ l 5 v surfactant δ p applied δ p c o s r 2 8 μ l we can see that the velocity of surfactant solution is almost independent of capillary length and radius close to 0 3 m day which indicates that viscous forces dominate capillary forces due to the ultralow ift in contrast capillary pressures play a significant role in the oil water displacement especially for small capillary lengths the water velocity at l 0 3 m is 25 1 2 78 and 0 548 m day when r 50 5 and 0 5 um respectively which is much higher than 0 3 m day the water velocity decreases as the capillary length and radius increase and approaches 0 3 m day this suggests that the effect of the phase behavior of surfactant water oil systems on the displacement is more significant for aquifers with higher permeability and smaller well distance which can lead to an early water breakthrough and a reduction in displacement efficiency 5 2 mitigating the impact of phase behavior on displacement for sear a single stable displacement front is favored to obtain a high displacement efficiency based on our study it can be inferred that an unstable displacement will occur in the type iii phase environment during sear in water wet aquifers even if the surfactant solution is slightly more viscous than napl the early water breakthrough reduces the displacement efficiency and a continuous surfactant solution injection is required until all the residual napl is extracted therefore the production of water during sear is undesirable and needs to be suppressed or eliminated as far as we can see one possible solution is to limit the mass transfer rate of surfactants to form microemulsions which may allow the upstream surfactant to diffuse to the displacement front and maintain an ultralow ift throughout the displacement process this may be realized by using slow release technologies such as encapsulated surfactant systems furthermore we know from the phase behavior tests that for the surfactant water oil systems at the optimum salinity the volume of water in equilibrium with the microemulsion phase depends on the solubilization ratio and surfactant concentration thus another possible solution is to develop a robust surfactant formulation that produces little or no water at optimal salinity at low surfactant concentrations 5 3 limitations our study shows that the phase behavior of surfactant water oil systems significantly affects the displacement dynamics in 2d microfluidic chips microfluidics is a powerful tool for understanding the physics associated with multiphase displacements while providing enough detail to study the spatial and temporal variations of ift and contact angle the 2d microfluidic chips we used have some limitations in representing natural rocks since the chips are homogeneous and lack 3d connectivity from fig 8 we know that the average water velocity is 0 91 m day in the type ii phase environment which is much lower than that calculated using the hagen poiseuille equation the reason is that the water fingers intermittently break into ganglia because of the flow of oil upstream 3d porous media typically have higher connectivity than 2d porous media which may favor the formation of connected water pathways therefore the impact of the phase behavior of surfactant water oil systems on the displacement in natural rocks needs to be further investigated 6 conclusions the displacements in different phase environments were conducted in water wet micromodels to investigate the effect of the phase behavior of surfactant water oil systems on displacement our study suggests that phase behavior significantly affects pore scale displacement patterns and recovery of the displaced fluid the main findings are as follows 1 the spatial heterogeneity in contact angle and ift in type iii and type ii phase environments led to the formation of two distinct displacement fronts which resulted in the variation of displacement patterns in different phase environments 2 in the type i phase environment most surfactants remained in the water the oil water ift maintained constant during the displacement which led to a single constant displacement pattern 3 in type iii and type ii phase environments ift varied significantly along the flow direction due to the transfer of surfactant from the aqueous phase to the microemulsion phase coexistence of high and ultralow ifts the contact angle also changed significantly along the flow direction which resulted in the separation of displacement fronts credit authorship contribution statement weipeng yang conceptualization investigation writing original draft guoyu chu investigation yujing du writing review editing ke xu formal analysis writing review editing erdong yao writing review editing tianbo liang writing review editing bing wei writing review editing haiyang yu writing review editing jian hou writing review editing jun lu conceptualization writing review editing supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments this research was supported in part by a faculty research grant at the university of tulsa the authors acknowledge the mcdougall school of petroleum engineering at the university of tulsa for supporting this research supplementary materials supplementary material associated with this article can be found in the online version at doi 10 1016 j advwatres 2022 104288 appendix supplementary materials image application 1 
99,dual grid models address the computational bottlenecks of large scale 1 0 3 km 2 urban flood modeling with solution updates on a coarse grid that are informed by topographic data on a fine grid however dual grid models may poorly resolve levees leading to loss of accuracy here we present a grid edge classification method whereby specific edges of the coarse grid are flagged to gather nearby topographic data from the fine grid and create a contiguous physical barrier the method relies on levee location data in a polyline format and does not require levee height data since that information is stored on the fine grid using a 6804 km 2 model of the los angeles metropolitan region with 3 m topographic data and 987 km of levees the proposed method is implemented and evaluated simulations using coarse grids of 15 30 and 60 m capture flood extent consistent with fine grid models based on a critical success index csi of 90 87 and 82 respectively edge classification improves csi up to 7 percentage points over a model with unclassified coarse grid edges and reduces the false alarm ratio up to 10 percentage points differences in model performance across the study area are noted including lower accuracy on urbanized alluvial fans with compute costs that scale with the coarse grid dual grid models can efficiently realize more accurate large scale models of urban flood hazards keywords flood risk inundation levees urban flooding hazards data availability the grid edge classification code is available on github 1 introduction flooding from extreme weather events including tropical storms storm surge heavy rainfall and flash floods poses major risks to human populations assets and economic activities flood losses have been on the rise for decades both in the u s and globally while fatalities have fallen over the same period gall et al 2011 wmo 2021 the five largest disasters ever recorded when measured by economic losses were hurricanes katrina sandy irma harvey and maria and involved significant flooding in addition to wind and other storm damage wmo 2021 moreover flood impacts are increasingly concentrated in urban areas characterized by high population densities and high physical and social vulnerabilities galloway et al 2018 hino and nance 2021 and there have been calls for new approaches and strategies to curb impacts and build resilience task committee on flood safety policies and practices 2014 nasem 2019 spatially distributed flood hazard inundation modeling is important for characterizing risks and assisting flood risk adaptation processes ward et al 2015 sanders et al 2020 bates et al 2021 wing et al 2022 flood simulations have supported adaptation at local levels for decades by enabling the mapping of flood zones the guidance of mitigation measures such as levees and drainage infrastructure and planning for physical vulnerability reduction through land use and zoning restrictions nrc 2009 recently large scale defined here as 1 0 3 km 2 flood simulation models have been developed to support national level and international risk management needs including data for insurance schemes identification of global flood risk hot spots and planning of sustainable development ward et al 2015 large scale national continental and or global flood hazard modeling has mainly been pursued with modeling frameworks of two different types statistical hydrologic and hydrologic statistical the statistical hydrologic approach begins with available statistics on flood hazard drivers such as rainfall and streamflow and continues with the application of a hydrodynamic flood inundation model on a regional domain to map flood hazards sampson et al 2015 dottori et al 2016 schumann et al 2016 national continental and or global coverage is subsequently achieved by assembling results of numerous regional models conversely the hydrologic statistical approach begins with simulating the hydrologic cycle over the scale of interest national continental global to generate a spatially distributed data set of peak flood volumes e g annual maxima next a probability distribution is fit to model output to estimate extremes and in a third step extreme flood volumes are downscaled with the aid of topographic data to map hazard distributions over the large scale domain pappenberger et al 2012 winsemius et al 2013 both the statistical hydrologic method and the hydrologic statistical method have proven successful at advancing understanding of present and future risks at large scales for example household level flood risk and inequities have been estimated for the continental u s based on a statistical hydrologic framework bates et al 2021 wing et al 2022 and the hydrologic statistical framework has enabled global estimation of future flood risk winsemius et al 2016 critical insights into strategies to manage future riverine flooding jongman et al 2015 and guidance for provision of aid and assistance during flooding disasters ward et al 2015 one of the weaknesses of large scale modeling frameworks is that flood hazards in urban areas where population density and physical and social vulnerabilities are greatest are somewhat crudely estimated jonkman 2013 for example ward et al 2017 report a median critical success index of only 46 across eight urban areas within the u s u k germany and thailand for estimation of the 100 year flood zone and wing et al 2017 report a critical success index of 23 for areas of the u s classified as high intensity development based on data from the national land cover database large scale flood models tend to use somewhat coarse grids by urban flood modeling standards and also lack sensitivity to flood management infrastructure which is essential for shaping flood risk adaptation jonkman 2013 urban flood modeling is now a relatively mature field following decades of research into model structure and numerical methods teng et al 2017 guo et al 2021 dewals et al 2021 mignot and dewals 2022 and thus methods for accurate urban flood modeling are well known including reliance on local knowledge urban drainage infrastructure data and sufficient grid resolution to resolve flow paths and obstructions jonkman 2013 the main barriers facing large scale modeling are that 1 detailed data relied upon by urban flood models are not widely available to support large scale modeling ward et al 2015 and 2 the computational and memory demands of fine grid urban flood modeling e g russo et al 2015 become prohibitively expensive at large scales sanders et al 2010 ivanov et al 2021 considerable recent research has been directed at overcoming the computational bottlenecks of urban flood modeling for example mignot and dewals 2022 review a number of different methods including using graphical processing units gpus porosity models and fast surrogate models dewals et al 2021 ivanov et al 2021 mignot and dewals 2022 of these applications at large scale have mostly used fast surrogate model approaches dewals et al 2021 dual grid modeling approaches have recently emerged as a highly promising approach to overcome the computational challenges of large scale urban flood modeling described above derived from multi grid approaches to solving the hydrodynamic equations governing flood inundation stelling 2012 henonin et al 2013 dual grid models are limited to two grid resolutions a fine resolution grid to resolve topographic data and a coarse resolution grid for solution updates volp et al 2013 sanders and schubert 2019 shamkhalchian and de almeida 2021 cartesian grids are used to simplify data structures for upscaling and downscaling and to simplify data management which is paramount in large scale flooding applications due to high data volumes dual grid models can also support ideal parallel scaling enabling simulation domains of any size given available computational resources due to well balanced data structures sanders and schubert 2019 here we refer to the fine grid of topographic data with a resolution δ z as the zgrid and the coarse grid with a resolution δ u as the ugrid the zgrid is also known as a digital elevation model dem while the ugrid is the basis for mass conservation and momentum balance updates the ratio of grid sizes represents the upscale factor α δ u δ z and practical applications of the dual grid parallel raster inundation model primo with α ranging from 10 20 have been shown to reduce computational costs by orders of magnitude compared to fine grid modeling without overly sacrificing accuracy sanders and schubert 2019 dual grid models are a type of subgrid model which refers to any type of analytical or empirical model that calculates the solution at scales finer than the ugrid resolution examples of subgrid models include multi grid models hénonin et al 2015 stelling 2012 porosity models dewals et al 2021 analytical models of subgrid scale channel flows neal et al 2012 and data driven empirical models of storage conveyance and flow resistance casulli and stelling 2011 brunner 2022 the general idea behind subgrid models is to leverage knowledge about fine resolution details that affect flood inundation such as the shape of the land surface resolved on a zgrid e g casulli and stelling 2011 the width of a channel visible from aerial imagery e g neal et al 2012 or the presence of blockage features that affect floodplain storage and conveyance e g sanders et al 2008 while avoiding prohibitively high compute costs the development of subgrid models in general and dual grid models in particular has also led to new approaches to the representation of flood management infrastructure such as curb inlets subsurface pipes and pumps at the scale of the ugrid for example to account for drainage from curb inlets through pipes to flood channels primo can use pairs of inlets and outlets that transfer water between ugrid cells which can be done sequentially in the solution update process without negatively impacting parallel scaling that is crucial for model efficiency at large scales sanders and schubert 2019 for each hydraulic link flow is routed from the inlet to the outlet each time step in accordance with the type and size of the infrastructure chang et al 2018 when applied to the historical baldwin hills dam break flood scenario gallegos et al 2009 an uncalibrated dual grid primo model simulated inundation with a critical success index of 70 using an upscale factor of 10 and previously reported drainage infrastructure parameters sanders and schubert 2019 delineating blockage and overtopping features such as levees and flood walls is of paramount importance when developing flood hazard models for both urban and rural areas and especially when using a subgrid model because the widths of ugrid cells are likely to be coarse compared to levee widths sanders and schubert 2019 demonstrated that with increased upscaling of a dual grid model representation of blockage features progressively worsened unstructured grid models address this problem by positioning edges of the computational mesh along levee crests to directly resolve the blockage feature brunner 2022 gallien et al 2011 luke et al 2015 while structured grid models resolve blockage features by moving the location and in some cases the width of the levee to the nearest topographic cell wing et al 2019a shustikova et al 2020 moreover frameworks that automate the representation of blockage features in flood inundation models have been a focal point of research hodges 2015 and li and hodges 2019 2020 presented a semi automated approach that begins by calculating an elevation differential raster between the zgrid the ugrid values above a specified cutoff height in the differential raster signify unresolved features on the ugrid and the connected nonzero values are registered as blockage features that are transferred to the nearest coarse grid edges wing et al 2019b developed a method whereby five geomorphometric characteristics of the zgrid were computed as indicators of levee features a probabilistic model for levee features was trained using known levee locations from the u s army corps of engineers usace national levee database usace 2015 and then selected grid cells of the hazard model were elevated to represent the blockage feature in summary previous work shows that accurately representing blockage features is an important and especially challenging aspect of flood inundation modeling using subgrid models furthermore in the context of dual grid models previous research points to value of methods that register the location of blockage features on the ugrid and adapt the processing of zgrid data for solution updates depending on the presence or absence of blockage features data to improve the representation of levees in flood inundation models is increasingly available the national levee database usace 2015 contains data on over 7 000 levee systems spanning over 40 000 km in the u s and the database is constantly being updated due to efforts from local state federal and tribal agencies there have also been calls for regional to global infrastructure data tourment et al 2018 özer et al 2020 and a new international levee database opendelve was recently introduced o dell et al 2021 high resolution zgrid data is also widely available across urban areas of developed nations to support detailed inundation modeling and the need for greater global coverage of high quality topographic data has been recognized schumann and bates 2020 the purpose of this study is to present a new semi automated method to improve the representation of blockage features in dual grid flood inundation models based on the following preconditions consistent with the literature review above a the location and continuity of flow barriers have been characterized as a polyline or can be readily characterized as a polyline using geospatial tools and data and b data characterizing the height of obstructions such as levees are resolved on the zgrid specifically in this study we present a semi automated workflow that flags ugrid edges based on the presence of a barrier levee so that the flow solver is guided to enforce blockage effects when such features are present and simulate overtopping when flood levels exceed blockage feature heights hence herein we present a workflow for ugrid edge classification that enables the dual grid solver to utilize available topographic data for solution updates more intelligently with the aim of achieving fine grid model accuracy at the computational cost of running a coarse grid model we acknowledge possible exceptions to the preconditions above such as errors in levee polyline data and blockage features that are not resolved by the zgrid but argue that these exceptions can be addressed with additional editing and processing of data and thus a push towards a semi automated workflow could offer immense value for future modeling the remainder of the paper continues as follows methods including the proposed grid edge classification method are presented in section 2 applications of the method and results are presented in section 3 and we close with discussion section 4 and summary and conclusion section 5 2 methods 2 1 large scale flood hazard model primo simulates flood hazards by solving the two dimensional shallow water equations with a godunov type finite volume scheme that is conditionally stable in accordance with a courant friedrichs lewy cfl condition sanders and schubert 2019 simulations can be forced in several different ways spatially distributed and time varying precipitation non point sources time varying inputs from streams entering a model domain and or concentrated runoff from catchments point sources time varying water levels at model domain boundaries boundary water levels and point sink point source pairs that account for water transfers through storm water infrastructure such as drainage pipes water transfers additionally flow resistance is modeled using a spatially distributed manning resistance parameter and soil infiltration is modeled with a runoff coefficient that transforms precipitation into runoff noh et al 2019 and approaches unity in urban areas due to impervious surfaces and soil saturation during extreme events bates et al 2010 wing et al 2017 noh et al 2019 for this study emphasis is placed on fluvial flooding scenarios to document potential overtopping of levees and thus model forcing is based on point sources of streamflow added to drainage channels that are representative of lateral inflows the fine resolution zgrid used by primo corresponds to a dem with n x columns and n y rows of ground elevation data z i j for i 1 n x and j 1 n y with a uniform cell size of δ z here i and j represent indices in a conventional cartesian coordinate system with the origin in the lower left corner of the spatial domain the coarse resolution ugrid corresponds to a spatial domain congruent with the zgrid where the number of columns and rows is based on the upscale factor n x n x α and n y n y α respectively introducing capitalized indices for the coarse grid i 1 n x and j 1 n y the solution state in each coarse grid cell is given by u i j η i j p i j q i j where η represents the elevation of the water surface p represents the discharge per unit width in the x direction and q represents the discharge per unit width in the y direction furthermore slopes in the free surface elevation δ x η i j and δ y η i j are computed using the minmod limiter sanders and bradford 2006 and used to downscale flood depth d from the ugrid to the zgrid as follows d i j max η i j z i j 0 for i α i 1 1 α i and j α j 1 1 α j where 1 η i j η i j δ x η i j x i x i δ y η i j y j y j and where x i and y j represent cell centered coordinates on the ugrid primo leverages the dual grid data structure in three distinct ways to support accurate flood hazard modeling first the α 2 z values within each ugrid cell are used to create tables of water storage per unit area h versus water level η once established in a pre processing step these tables are used each time step to compute η in each cell based on the storage h computed from the mass balance equation second the 2 α z values from the two sides of each ugrid edge are used to establish the cross sectional shape for mass and momentum fluxes between neighboring cells z ˆ k k 1 α including momentum fluxes that account for the bed slope source term valiani and begnudelli 2006 and third primo uses a bilinear reconstruction of the free surface elevation eq 1 for accurate downscaling of flood depth bradford and sanders 2005 note that the weakness of primo addressed herein the representation of blockage effects relates to the estimation of z ˆ k k 1 α for each ugrid edge connecting neighboring cells 2 2 study area and supporting data the proposed ugrid edge classification method is presented in the context of the los angeles metropolitan region fig 1 home to the 8 t h largest megacity in the world and the second largest in the u s based on a population of 19 million people blackburn et al 2019 with urban development blanketing a coastal plain below steep mountains rising to over 3000 m above sea level the region is vulnerable to flooding disasters from atmospheric river rainfall events that generate fast moving runoff and floodwater filled with mud and debris that may overwhelm infrastructure jones 2019 sanders and grant 2020 a 3 m zgrid was prepared with 756 1000 1000 cell tiles that span an area of 6804 km 2 see model domain in fig 1 levee polyline data were obtained from the national levee database usace 2015 and further edited for coverage and spatial alignment with blockage features red lines in fig 1 topographic data for the zgrid were derived from aerial lidar survey data obtained from the united states geological survey usgs and national oceanic and atmospheric administration noaa for los angeles county and orange county the topographic data effectively captures the height of most levees but additional processing of the data was carried out i e hydro conditioning for accurate representation of drainage pathways on the land surface bales and wagner 2009 for example aerial lidar encounters line of sight obstruction of flow pathways from bridges roads and other structures leading to gaps in data coverage or non physical blockage features in the land surface here these errors were corrected by intersecting openstreetmap osm road network data openstreetmap contributors 2022 with the dem to identify and correct erroneous changes in road elevations a second class of problems arises with drainage pathways through subsurface pipes which are not resolved by aerial lidar surveys using urban drainage geometry data representing open channels and connecting culverts from los angeles county and orange county public works open channel pathways were burned into the dem to support open channel flow routing as a result of hydro conditioning the zgrid the los angeles metropolitan region model developed here resolves both level 1 infrastructure major channels and levees and level 2 infrastructure secondary drainage channels and culverts pipes however level 3 infrastructure curb inlets and small storm pipes that connect curb inlets to large pipes or channels are not integrated into the model for this study a 3 m resolution raster grid of manning coefficients was also developed for flow resistance based on osm land use information see table 1 2 3 proposed edge classification herein we present a five step process or workflow fig 2 to improve the representation of levees along ugrid edges the process begins with a spatial domain of interest that is spanned by a ugrid zgrid and levee location data in a polyline format p x 1 y 1 x 2 y 2 x n y n and ends with the estimation of edge based elevation data z ˆ k k 1 α along edges of the ugrid the workflow is illustrated with a channel junction from the coyote creek subdomain of the los angeles metropolitan region fig 1a as follows 1 the first step fig 2a involves manual or semi automated editing of p such that levee polylines delineate both sides of any channel with a levee or flood wall on either side levee polylines may be acquired from available repositories e g national levee database opendelve and may also be created using geospatial tools 2 the second step fig 2b involves intersecting levee polylines with ugrid cells to establish a logical matrix m or mask at the same size and resolution as the u g r i d whereby true indicates that the grid cell contains a levee and false indicates that it does not this is accomplished by breaking the polylines into a set of points with a linear spacing comparable to δ z and flagging all ugrid cells that contain one or more of these points 3 the third step fig 2c involves filling holes within the logical matrix m these holes correspond to the channel space between levees on opposite sides of a channel this is accomplished using the imfill command in matlab mathworks natick ma 2 m i m f i l l m h where h x 1 y 1 x 2 y 2 x m y m represent the coordinates of points within the m holes of the mask m in fig 2b there is only one hole indicated by black coloring and the hole is filled as shown by the red mask in fig 2c we also note based on experience using the imfill command that the majority of holes are filled automatically so only a limited number of hole coordinates are typically required several iterations of inspecting results and adding additional points are typically required to complete the step an important consideration for this stage of the workflow to be successful is whether channel areas are fully encircled by m true cells if not then manual editing of m or the polyline data which generates m step 2 will be needed to produce channel areas that are completely surrounded and or encompassed by m true cells 4 the fourth step involves classifying edges of the u g r i d to guide the calculation of z ˆ using z g r i d data u g r i d edges that are representative of levees correspond to edges of the region defined by m true and appear in fig 2d as blue lines in the case of vertical grid edges the edge classification includes three possible options 1 for when the physical levee is to the left of the u g r i d edge 0 when there is no levee present and 1 for when the physical levee is to the right of the u g r i d edge in the case of horizontal levees 1 corresponds to a physical levee below the u g r i d edge and 1 corresponds to a physical levee above the u g r i d edge the edge classification is saved as two separate arrays for vertical edges and horizontal edges e v with a dimension n x 1 n y and e h with dimension n x n y 1 respectively mathematically this classification appears as follows for e v 3 e i j v 1 if m i 1 j 1 m i j 0 1 if m i 1 j 0 m i j 1 0 otherwise and similarly elements of e h are set as follows 4 e i j h 1 if m i j 1 1 m i j 0 1 if m i j 1 0 m i j 1 0 otherwise 5 in the fifth step manual re classification may be required to avoid blockage features in channels fig 2e presents an example where the initial levee polyline data fig 2a intersected a secondary drainage channel and the automated steps resulted in a non physical blockage feature the mask editing described in step 3 and edge re classification described in step 5 above are representative of the two types of manual editing that may be needed to implement this method one is related to the creation of holes within the mask m which requires the use of the imfill command and the other is related to the removal of edges incorrectly classified as levees in a practical large scale application as shown in fig 1 the need for manual editing can result from channels that intersect the model domain boundary fig 3a channels with discontinuous levee coverage which leaves openings in levee polylines fig 3b that need to be closed manually step 1 or 2 and edges incorrectly classified as levees fig 3c as a consequence of the openings in levee polylines that are closed manually fig 3b the grid edge classification matrices e v and e h guide the processing of zgrid data to produce a distribution of topographic data for each edge z ˆ k with k 1 α for solution updates as follows for edges classified as non levee edges pairs of zgrid data from opposite sides of the ugrid edge are averaged to estimate z ˆ as reported by sanders and schubert 2019 when the edge is classified as 1 z ˆ k is specified based on data from the ugrid cell on the left hand side of the edge in particular the maximum z value among the α 2 zgrid data points in the left hand ugrid cell is computed and assigned to all α values of z ˆ k conversely when the edge is classified as 1 z ˆ k is specified based on data from the ugrid cell on the right hand side of the edge and the maximum z value from the zgrid within the right hand ugrid cell is assigned to all α values representing the edge fig 4 illustrates the transfer of high topographic heights representative of a levee fig 4a to edges of a ugrid fig 4b for the estimation of z ˆ k for k 1 α note that the levee representation fig 4b is contiguous along ugrid edges no gaps to enforce a barrier to flow in both horizontal and vertical directions when water levels are below the crest of the levee upon exceeding the crest elevation the model simulates overtopping flows in accordance with mass and momentum fluxes resolved by the approximate riemann solver and solution updates by the flood inundation model sanders and schubert 2019 the proposed method to resolve levees results in spatially variable distributions of z ˆ for edges that are classified as 0 while it results in constant values of z ˆ across each ugrid edge classified as a levee 1 or 1 this could bias the method towards overprediction of flood protection in cases where levee heights vary significantly along the ugrid cell such as with a sloping channel as shown in fig 4 other sampling strategies could also be considered to create a distribution of edge based topographic heights z ˆ k for k 1 α but for this study a simple approach was used to promote continuity of flow barriers and avoid non physical flood spreading through blockage features previous work has emphasized the importance of continuity in the gridded representation of blockage features hodges 2015 with the implementation of this method in primo the edge classification matrices are written to a file and loaded at the beginning of a simulation to guide the computation of edge topography z ˆ k k 1 α for all edges prior to time integration alternatively edge topography could be computed off line and saved in separate sets of files to be loaded at the beginning of the simulation the former approach was implemented here to minimize the number of input files and the file storage requirements of the model and because the calculation of edge topography happens very fast in parallel and has negligible impact on overall compute times to illustrate the results of this workflow based on data from the los angeles region ugrid edges classified as levees for the coyote creek subdomain fig 1a are presented in fig 5a b and c white lines for α 10 20 and 50 respectively while the representation of levees becomes less precise with increasing upscale factor the method guarantees two important attributes for flood hazard modeling first continuity in flood defenses is preserved irrespective of the upscale factor which is critical for avoiding artificial leakage through levees and second levee heights are based on fine resolution zgrid data irrespective of the upscale factor 2 4 performance assessment fig 5 shows that as the upscale factor increases the planform area between levees also increases note the distance between the white lines and the red lines in fig 5 which could affect the accuracy of predictions increasing the upscale factor also increases numerical truncation errors i e numerical diffusion that may impact accuracy therefore simulation accuracy and biases are examined by comparing dual grid simulations with α 5 10 20 and 50 to fine grid simulation as has been done in previous studies of flood model performance e g haile and rientjes 2005 fewtrell et al 2008 the fine grid simulation is based on α 2 6 m without the edge classification method use of α 2 ensures that every topographic data point is used for flux calculations and thus all blockage features are resolved for accuracy considerations a fine grid model based on α 1 was not possible due to prohibitively expensive compute costs corresponding to simulations fully utilizing 756 compute cores and lasting for many months accuracy and biases in flood extent predictions are evaluated using a contingency table that quantifies the frequency with which the simulation predicts flooded cells above a threshold of 3 cm correctly or incorrectly compared to the fine resolution reference case the contingency table includes the number of cells correctly predicted as flooded a the number of cells where flooded cells are incorrectly predicted to be dry b and the number of dry cells incorrectly predicted to be flooded c these three measures are used to compute a critical success index csi false alarm ratio far and the hit ratio h as follows schaefer 1990 5 c s i a a b c f a r c a c h a a b where far serves as a measure of overprediction h serves as a measure of underprediction and csi provides a measure of overall accuracy we note that a perfect prediction corresponds to c s i 1 f a r 0 and h 1 dual grid model compute times t dg are recorded with all simulations and two different indicators are used as measures of model performance the first measure is model speed s defined as follows 6 s t rt t dg where t rt represents the real time covered by the simulation or model duration the concept of model speed is borrowed from weather forecasting where model simulations must execute substantially faster than real time to provide timely information for example woods 2006 suggests use of models with s 20 for timely information forecasting is not the focus of this study but given the immense computational demands of large scale modeling compute times are an important consideration and model speed offers an intuitive dimensionless number to interpret compute costs a second measure considered here is the ratio r of dual grid model to single coarse grid model compute times 7 r t dg t sg where t sg represents the compute time of a single grid model while no single grid models are actually implemented in this study an estimate of single grid model compute times can be made from a dual grid model compute time measured under low levels of upscaling the compute times of any well behaved spatially explicit flood inundation model constrained by the cfl condition can be estimated as follows assuming fixed computing power sanders et al 2010 8 t c 0 1 δ 3 where δ is the grid size and c 0 is a constant that depends on the spatial extent of the model the real time duration of the model and details of the algorithm eq 8 shows that compute times increase by a factor of eight with every halving of the grid size δ which illustrates the origin of computational bottlenecks in fine grid flood inundation modeling nevertheless when compute times are measured at one specific resolution δ 0 compute times for any other resolution can be estimated by rearranging eq 8 as follows 9 t sg δ t sg 0 δ 0 δ 3 where t sg 0 represents the compute time for grid size δ 0 for this study we estimate t sg 0 based on the dual grid model compute time at very low levels of upscaling α 0 2 the finest resolution that was feasible to implement at large scale and recalling that δ α δ z we estimate single grid model compute times at coarse resolution as follows 10 t sg α t sg 0 α 0 α 3 which allows eq 7 to be computed as follows 11 r α t dg t sg 0 α α 0 3 values of r equal to unity indicate that dual grid model compute times are equivalent to those of a coarse grid model while values greater than unity indicate that the dual grid model is more computationally demanding than a coarse grid model at the same coarse grid resolution 3 applications two test cases are considered both taken from the los angeles metropolitan region domain shown in fig 1 the first test case utilizes the coyote creek subdomain shown in fig 1a while the second test case utilizes the entire domain shown in fig 1 both test cases involve fluvial flood hazard scenarios whereby flooding is forced by point sources of flow added to channels and routed by the flow solver focusing attention on the accuracy with which coarse grid flow models characterize levee overtopping and floodplain inundation 3 1 coyote creek test case the coyote creek test case involves a 56 km 2 domain with 30 km of levee polylines along three different channels as shown in fig 1a fig 5 provides a magnified view which better illustrates the channel configuration topography and resistance are based on a 2500 2500 zgrid and the grid edge classification method was applied for ugrids defined by α 5 10 20 and 50 this test case is configured to measure the how accurately dual grid model simulations contain design flows within flood channels with and without the edge classification method point sources of flow are added to the upstream end of coyote creek carbon creek and the unnamed channel west of coyote creek at a rate of 800 225 and 7 m 3 s respectively see fig 5 these flow rates represent 90 of the maximum allowable flow rate in each channel determined empirically through an iterative process using model simulations with α 2 with flow at 90 capacity simulated overtopping will not occur until there is more than a 10 error in the simulated capacity of the channel each simulation was executed from a dry initial condition with steady inflow from point sources and a critical flow outflow boundary condition at the southwest corner of the domain which yields a subcritical flow regime upstream a 3 hour model duration was found to be sufficient to reach a steady state and is used in all simulations compute times for execution using α 2 5 10 20 and 50 corresponded to 9 75 h 30 5 1 and 1 min respectively on a laptop computer using 4 cores and there was negligible change to compute times using classified versus unclassified levees fig 6 shows flood extent based on a depth threshold of 3 cm for all model simulations and flood extent error statistics are reported in table 2 these results show that the model correctly predicts no levee overtopping for α 5 and 10 and only a minor amount of overtopping far 2 using α 20 when using classified edges in contrast the model incorrectly predicts moderate levee overtopping far 7 22 for α 5 and 20 when using unclassified edges use of α 50 results in incorrect prediction of overtopping regardless of the edge classification method which highlights limits to the amount of upscaling that can be implemented before accuracy levels become unacceptable to summarize these results show that the proposed edge classification method reduces or eliminates the incorrect prediction of levee overtopping for the cases with α 5 10 and 20 far values are roughly an order of magnitude smaller using classified versus unclassified edges 3 2 los angeles metropolitan region test case application of the edge classification method to the entire los angeles metropolitan domain involved consideration of 987 km of polylines with 92 different channel openings and levee input files were prepared for ugrids defined by α 5 10 20 and 50 manual editing over several hours was required to address the types of irregularities shown in figs 2e and 3 a 100 year return period fluvial hazard is used to evaluate the grid edge classification at the metropolitan scale use of a fluvial scenario focuses attention on the containment of flow in flood channels and potential biases from inaccurate prediction of levee overtopping the fluvial flood hazard scenario was developed using data from 51 streamgages across the region maintained by usgs los angeles county public works and orange county public works see fig 1 to estimate 100 year flow rates frequency analysis was completed using hec ssp software developed by the u s army corps of engineers hydraulic engineering center 2021 which follows usgs bulletin 17c england jr et al 2019 flow was forced with a distributed set of point sources in channels that accumulate to match the 100 year flow rate at each gaging station in consideration of all upstream point sources using 756 compute cores on the cheyenne cluster at the ncar wyoming supercomputing center flow was simulated for a 48 hour duration to reach a steady state and dual grid compute time t dg model speed s and the dual grid single grid compute time ratio r are reported in table 3 based on the speed criterion for usefulness reported by woods 2006 and results in table 3 model simulations involving α 10 20 and 50 provide sufficient speed to provide timely forecast information i e speed is greater than 20 furthermore model simulations involving α 5 10 and 20 and classified edges have compute costs that closely track the compute costs of an equivalent coarse grid model based on r values close to unity 0 9 1 2 use of α 50 results in a model speed s that is lower than ideal and a dual grid single grid ratio r that does not match an equivalent single grid model we attribute this to the computational demands of data output which are typically small compared to computing demands but become a larger fraction of the overall costs as upscaling increases we also note that our model for single grid compute times eq 8 does not account for the cost of data output an overview of the flood hazard distribution is presented in fig 7 and reveals several parts of the region where channels are unable to contain the 100 year flow rate including communities between los angeles and long beach fig 7b communities near burbank fig 7b and coastal communities such as huntington beach fig 7c e also show three levels of magnification to illustrate the level of detail that is captured by the model fig 7e shows the finest level of detail characterized by street level details with flood water moving along the road network of particular interest for this study is whether and to what extent the proposed edge classification method alters the simulated distribution of flooding to this end table 4 provides a summary of flood extent accuracy metrics using a fine grid model as a reference case for the entire model domain as well as long beach and san fernando subdomains shown in fig 1 the long beach subdomain encompasses a region that was historically occupied by riparian and coastal marshlands of the los angeles and san gabriel rivers and is presently defended from flooding by engineered flood channels with levees orsi 2004 due to its low topography and position along major rivers the deepest and most severe flooding of the region is simulated to occur within this subdomain the san fernando subdomain is representative of an urbanized alluvial fan where convex topography is capable of producing overtopping flows with diverging flow paths that are highly sensitive to localized changes in topography nrc 1996 garcia et al 2004 santangelo et al 2011 hence accuracy metrics are computed in areas of highest importance based on the depth of flooding and in areas where high accuracy is expected to be most challenging to achieve table 4 shows that across the full domain the proposed ugrid edge classification leads to lower far and equal or lower h compared to the model with unclassified edges and the overall accuracy represented by csi is 2 7 percentage points higher using classified edges the overall error computed as 100 csi at the scale of the full domain can be estimated to be 10 13 and 18 for α 5 10 and 20 respectively for context the highest csi values achieved in validation studies relative to flood extent measurements in the study area have been 80 corresponding to a 20 overall error gallegos et al 2009 schubert and sanders 2012 hence the errors of the dual grid flood model with grid edge classification presented here can be viewed at worst as being slightly smaller than overall errors considering uncertainty in flow topography resistance and storm drain infrastructure table 4 also illuminates different levels of sensitivity to upscaling between the long beach and san fernando subdomains in the long beach subdomain where changes in topography are relatively mild and there are numerous channels with levees where overtopping is simulated to occur the dual grid model using classified edges yields high accuracy csi 80 for α 5 10 and 20 conversely in the san fernando subdomain characterized as an urbanized alluvial fan csi drops to 72 and 61 with α 5 and 10 respectively additionally for the long beach subdomain csi is increased by 5 12 percentage points far is reduced 12 16 percentage points less overprediction and h is reduced 0 7 percentage points more underprediction from using classified grid edges conversely in the san fernando subdomain far is reduced only 0 4 percentage points and h is reduced 0 3 percentage points excluding the case with α 50 fig 8 provides a magnified view of the long beach subdomain and shows areas of agreement green overprediction blue and underprediction red compared to the fine grid model overall the level of agreement appears very good using classified edges and the amount of underprediction and overprediction appears minimal when using classified edges and α 10 additionally this shows that for all four upscale factors overprediction is reduced using classified edges compared to unclassified edges less blue comparing classified to unclassified cases across the same value of α furthermore the cause of high overprediction for the case with α 50 and unclassified edges can be attributed to incorrect prediction of channel overtopping see upper left quadrant of top right panel underprediction may be of particular interest based on the possibility of incorrectly predicting safety from flooding the amount of underprediction is reflected by the difference between 100 and the hit rate as a percentage using classified edges α 5 yields more underprediction than α 10 20 or 50 indeed both the α 5 and α 10 cases result in csi 88 using classified edges but the α 5 is better from a perspective of less overprediction and α 10 is better from a less perspective of underprediction the patterns of flooding simulated in the san fernando subdomain are presented in fig 9 flow initiates at the northern edge of the domain where channel capacity is insufficient to contain the 100 year flow and simulated channel overtopping generates divergent flow paths in the downstream southerly direction note here that a single channel with levees is responsible for the excess flows fig 9 shows that east west roadways enable dispersal of flooding to the east through neighborhoods here errors in the over and underprediction of flood extent blue and red respectively strikingly increase between α 20 and α 50 this is attributed to the high sensitivity of alluvial fan flooding to differences in topography resolved by each model pelletier et al 2005 conversely differences in flood extent between the classified and unclassified cases are minimal except when using α 50 hence the results in this sub domain draw greater attention to the sensitivity of the dual grid model to increased upscaling versus representation of levees 4 discussion as mentioned in the introduction urban flood hazards have proven difficult to accurately simulate using large scale models and accuracies reported have ranged from csi 23 wing et al 2017 to csi 46 ward et al 2017 in these previous studies csi is measured relative to flood zones mapped by different models and thus accounts for numerous factors that contribute to uncertainty such as the magnitude of flood peaks representation of topography and other factors in contrast csi values reported here only reflect the effects of upscaling and the proposed ugrid edge classification nevertheless high csi values 80 demonstrate the potential for large scale models to reduce errors associated with grid resolution a finding that is responsive to calls for greater attention to local data for urban flood hazard modeling e g jonkman 2013 these results also highlight the challenges of accurate modeling of flood hazards on steep and convex topography associated alluvial fans see nrc 1996 based on csi values of roughly 60 with α 10 for the san fernando subdomain table 4 these results also demonstrate the value of levee polyline data available from the national levee database usace 2015 and the importance of the new global database for levee data opendelve o dell et al 2021 in fact efforts to utilize levee data in flood hazard modeling studies also present opportunities to scrutinize and further expand existing levee data repositories and could help to accelerate the availability and coverage of data dual grid model simulations with forecast ready speeds s 20 compute times comparable to those of single grid models r 1 and consistency with respect to fine grid models csi 80 at the metropolitan scale constitute an important advance with respect to developing flood simulations with fine grid accuracy at the cost of coarse grid models widespread utilization of dual grid model structures could help to improve the accuracy of nationwide flood risk assessments e g wing et al 2017 bates et al 2021 expand simulation enhanced flood risk adaptation e g luke et al 2018 sanders et al 2020 from the community level to the regional level and enable real time flood inundation forecasting with a process based modeling approach ivanov et al 2021 we acknowledge however the need for future research to consider the role of level 3 drainage infrastructure e g curb inlets and small pipe connections to level 2 drainage infrastructure and the need for systematic approaches to model calibration and validation urban flooding during extreme events is rarely well monitored and a lack of data for model calibration and validation e g flow and depth distribution through street network and uncertainties in hydrologic drivers e g precipitation streamflow storm surge hinder the estimation of model parameters and the development of accurate models given high uncertainties in hydrologic drivers it is reasonable to be somewhat pessimistic about achieving major benefits from enhanced land surface process representation see bates 2012 additional research is needed on process based models strategies for model calibration validation and implications for simulation accuracy timeliness and uncertainties to deepen understanding and build capacity on this important frontier of hydrologic science and engineering 5 summary and conclusion herein we present a grid edge classification method to improve the representation of blockage effects and levee overtopping in large scale dual grid flood inundation models that sample topographic data from a fine resolution zgrid to account for mass and momentum fluxes between neighboring coarse resolution ugrid cells while previous work envisioned the redistribution of blockage features such as levees along coarse grid edges e g hodges 2015 li and hodges 2019 2020 here we present a new workflow that leverages available polyline data to create a coarse grid edge classification the workflow sharpens the representation of levees as barriers to flood spreading and constraints on overtopping furthermore we present an application of the workflow that is unprecedented in scale at a fine resolution 3 m covering the los angeles metropolitan region which is home to roughly 19 million people vulnerable to major flooding from a severe atmospheric river event application of the model across the los angeles metropolitan region shows that flood extent accuracy with α 10 30 m effective resolution is characterized by a critical success index of 87 a false alarm ratio of 5 and a hit rate of 91 when compared to a fine grid model and compute times are 30 times faster than real time similarly an α 20 model 60 m effective resolution achieves a critical success index of 82 a false alarm ratio of 12 a hit rate of 93 and compute times 300 times faster than real time furthermore these dual grid compute times closely match within 10 the compute costs of a single grid model run at the same coarse grid resolution hence we find that the proposed grid edge classification method based on levee location data enhances dual grid model accuracy such that it is comparable to fine grid model accuracy at compute costs comparable to those of single grid models the proposed grid edge classification method is particularly effective at reducing the overprediction of flood extent which is a drawback of existing dual grid models sanders and schubert 2019 this work also validates the importance of the national levee database usace 2015 new global levee databases o dell et al 2021 and accessible high resolution topographic databases to enable systematic advances in the modeling of urban flood hazards schumann and bates 2020 differences in dual grid model accuracy were observed across two subregions of the study area with differing topographical features in a fluvial corridor near long beach historically occupied by riparian and coastal wetlands the dual grid model with α 5 and 10 demonstrated high accuracy marked by a critical success index of 88 on the other hand on alluvial fan topography near san fernando with relatively steep topography the dual grid model with α 5 and 10 demonstrated only moderate accuracy marked by a critical success index of 72 and 61 respectively furthermore simulated flood extent in the san fernando subdomain was more sensitive to upscaling than to the proposed grid edge classification lower accuracy is attributed to convex topography whereby local scale variability in the representation of topographic heights can trigger divergent flow paths nrc 1996 pelletier et al 2005 furthermore lower sensitivity to the edge classification method is attributed to flows that far exceed channel capacity such that changes in levee representation do not substantially alter the amount of overtopping flow these results call attention to the need for more robust dual grid upscaling methods for steep and convex topography with higher sensitivity to topographic variability credit authorship contribution statement daniel t kahl methodology software validation formal analysis writing original draft jochen e schubert validation writing original draft review and editing ariane jong levinger validation review and editing brett f sanders conceptualization methodology software review and editing supervision declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests brett f sanders reports a relationship with zeppelin floods llc that includes equity or stocks jochen e schubert reports a relationship with zeppelin floods llc that includes equity or stocks acknowledgments this research is made possible with support from the national science foundation usa under grants hdbe 2031535 and icer 1940171 this work was also supported by the noaa effects of sea level rise program usa under grant na16nos4780206 and by the ridge to reef nsf research traineeship usa award dge 1735040 we also acknowledge high performance computing support from the ncar wyoming supercomputing center provided by the national science foundation and the state of wyoming and supported by ncar s computational and information systems laboratory 
99,dual grid models address the computational bottlenecks of large scale 1 0 3 km 2 urban flood modeling with solution updates on a coarse grid that are informed by topographic data on a fine grid however dual grid models may poorly resolve levees leading to loss of accuracy here we present a grid edge classification method whereby specific edges of the coarse grid are flagged to gather nearby topographic data from the fine grid and create a contiguous physical barrier the method relies on levee location data in a polyline format and does not require levee height data since that information is stored on the fine grid using a 6804 km 2 model of the los angeles metropolitan region with 3 m topographic data and 987 km of levees the proposed method is implemented and evaluated simulations using coarse grids of 15 30 and 60 m capture flood extent consistent with fine grid models based on a critical success index csi of 90 87 and 82 respectively edge classification improves csi up to 7 percentage points over a model with unclassified coarse grid edges and reduces the false alarm ratio up to 10 percentage points differences in model performance across the study area are noted including lower accuracy on urbanized alluvial fans with compute costs that scale with the coarse grid dual grid models can efficiently realize more accurate large scale models of urban flood hazards keywords flood risk inundation levees urban flooding hazards data availability the grid edge classification code is available on github 1 introduction flooding from extreme weather events including tropical storms storm surge heavy rainfall and flash floods poses major risks to human populations assets and economic activities flood losses have been on the rise for decades both in the u s and globally while fatalities have fallen over the same period gall et al 2011 wmo 2021 the five largest disasters ever recorded when measured by economic losses were hurricanes katrina sandy irma harvey and maria and involved significant flooding in addition to wind and other storm damage wmo 2021 moreover flood impacts are increasingly concentrated in urban areas characterized by high population densities and high physical and social vulnerabilities galloway et al 2018 hino and nance 2021 and there have been calls for new approaches and strategies to curb impacts and build resilience task committee on flood safety policies and practices 2014 nasem 2019 spatially distributed flood hazard inundation modeling is important for characterizing risks and assisting flood risk adaptation processes ward et al 2015 sanders et al 2020 bates et al 2021 wing et al 2022 flood simulations have supported adaptation at local levels for decades by enabling the mapping of flood zones the guidance of mitigation measures such as levees and drainage infrastructure and planning for physical vulnerability reduction through land use and zoning restrictions nrc 2009 recently large scale defined here as 1 0 3 km 2 flood simulation models have been developed to support national level and international risk management needs including data for insurance schemes identification of global flood risk hot spots and planning of sustainable development ward et al 2015 large scale national continental and or global flood hazard modeling has mainly been pursued with modeling frameworks of two different types statistical hydrologic and hydrologic statistical the statistical hydrologic approach begins with available statistics on flood hazard drivers such as rainfall and streamflow and continues with the application of a hydrodynamic flood inundation model on a regional domain to map flood hazards sampson et al 2015 dottori et al 2016 schumann et al 2016 national continental and or global coverage is subsequently achieved by assembling results of numerous regional models conversely the hydrologic statistical approach begins with simulating the hydrologic cycle over the scale of interest national continental global to generate a spatially distributed data set of peak flood volumes e g annual maxima next a probability distribution is fit to model output to estimate extremes and in a third step extreme flood volumes are downscaled with the aid of topographic data to map hazard distributions over the large scale domain pappenberger et al 2012 winsemius et al 2013 both the statistical hydrologic method and the hydrologic statistical method have proven successful at advancing understanding of present and future risks at large scales for example household level flood risk and inequities have been estimated for the continental u s based on a statistical hydrologic framework bates et al 2021 wing et al 2022 and the hydrologic statistical framework has enabled global estimation of future flood risk winsemius et al 2016 critical insights into strategies to manage future riverine flooding jongman et al 2015 and guidance for provision of aid and assistance during flooding disasters ward et al 2015 one of the weaknesses of large scale modeling frameworks is that flood hazards in urban areas where population density and physical and social vulnerabilities are greatest are somewhat crudely estimated jonkman 2013 for example ward et al 2017 report a median critical success index of only 46 across eight urban areas within the u s u k germany and thailand for estimation of the 100 year flood zone and wing et al 2017 report a critical success index of 23 for areas of the u s classified as high intensity development based on data from the national land cover database large scale flood models tend to use somewhat coarse grids by urban flood modeling standards and also lack sensitivity to flood management infrastructure which is essential for shaping flood risk adaptation jonkman 2013 urban flood modeling is now a relatively mature field following decades of research into model structure and numerical methods teng et al 2017 guo et al 2021 dewals et al 2021 mignot and dewals 2022 and thus methods for accurate urban flood modeling are well known including reliance on local knowledge urban drainage infrastructure data and sufficient grid resolution to resolve flow paths and obstructions jonkman 2013 the main barriers facing large scale modeling are that 1 detailed data relied upon by urban flood models are not widely available to support large scale modeling ward et al 2015 and 2 the computational and memory demands of fine grid urban flood modeling e g russo et al 2015 become prohibitively expensive at large scales sanders et al 2010 ivanov et al 2021 considerable recent research has been directed at overcoming the computational bottlenecks of urban flood modeling for example mignot and dewals 2022 review a number of different methods including using graphical processing units gpus porosity models and fast surrogate models dewals et al 2021 ivanov et al 2021 mignot and dewals 2022 of these applications at large scale have mostly used fast surrogate model approaches dewals et al 2021 dual grid modeling approaches have recently emerged as a highly promising approach to overcome the computational challenges of large scale urban flood modeling described above derived from multi grid approaches to solving the hydrodynamic equations governing flood inundation stelling 2012 henonin et al 2013 dual grid models are limited to two grid resolutions a fine resolution grid to resolve topographic data and a coarse resolution grid for solution updates volp et al 2013 sanders and schubert 2019 shamkhalchian and de almeida 2021 cartesian grids are used to simplify data structures for upscaling and downscaling and to simplify data management which is paramount in large scale flooding applications due to high data volumes dual grid models can also support ideal parallel scaling enabling simulation domains of any size given available computational resources due to well balanced data structures sanders and schubert 2019 here we refer to the fine grid of topographic data with a resolution δ z as the zgrid and the coarse grid with a resolution δ u as the ugrid the zgrid is also known as a digital elevation model dem while the ugrid is the basis for mass conservation and momentum balance updates the ratio of grid sizes represents the upscale factor α δ u δ z and practical applications of the dual grid parallel raster inundation model primo with α ranging from 10 20 have been shown to reduce computational costs by orders of magnitude compared to fine grid modeling without overly sacrificing accuracy sanders and schubert 2019 dual grid models are a type of subgrid model which refers to any type of analytical or empirical model that calculates the solution at scales finer than the ugrid resolution examples of subgrid models include multi grid models hénonin et al 2015 stelling 2012 porosity models dewals et al 2021 analytical models of subgrid scale channel flows neal et al 2012 and data driven empirical models of storage conveyance and flow resistance casulli and stelling 2011 brunner 2022 the general idea behind subgrid models is to leverage knowledge about fine resolution details that affect flood inundation such as the shape of the land surface resolved on a zgrid e g casulli and stelling 2011 the width of a channel visible from aerial imagery e g neal et al 2012 or the presence of blockage features that affect floodplain storage and conveyance e g sanders et al 2008 while avoiding prohibitively high compute costs the development of subgrid models in general and dual grid models in particular has also led to new approaches to the representation of flood management infrastructure such as curb inlets subsurface pipes and pumps at the scale of the ugrid for example to account for drainage from curb inlets through pipes to flood channels primo can use pairs of inlets and outlets that transfer water between ugrid cells which can be done sequentially in the solution update process without negatively impacting parallel scaling that is crucial for model efficiency at large scales sanders and schubert 2019 for each hydraulic link flow is routed from the inlet to the outlet each time step in accordance with the type and size of the infrastructure chang et al 2018 when applied to the historical baldwin hills dam break flood scenario gallegos et al 2009 an uncalibrated dual grid primo model simulated inundation with a critical success index of 70 using an upscale factor of 10 and previously reported drainage infrastructure parameters sanders and schubert 2019 delineating blockage and overtopping features such as levees and flood walls is of paramount importance when developing flood hazard models for both urban and rural areas and especially when using a subgrid model because the widths of ugrid cells are likely to be coarse compared to levee widths sanders and schubert 2019 demonstrated that with increased upscaling of a dual grid model representation of blockage features progressively worsened unstructured grid models address this problem by positioning edges of the computational mesh along levee crests to directly resolve the blockage feature brunner 2022 gallien et al 2011 luke et al 2015 while structured grid models resolve blockage features by moving the location and in some cases the width of the levee to the nearest topographic cell wing et al 2019a shustikova et al 2020 moreover frameworks that automate the representation of blockage features in flood inundation models have been a focal point of research hodges 2015 and li and hodges 2019 2020 presented a semi automated approach that begins by calculating an elevation differential raster between the zgrid the ugrid values above a specified cutoff height in the differential raster signify unresolved features on the ugrid and the connected nonzero values are registered as blockage features that are transferred to the nearest coarse grid edges wing et al 2019b developed a method whereby five geomorphometric characteristics of the zgrid were computed as indicators of levee features a probabilistic model for levee features was trained using known levee locations from the u s army corps of engineers usace national levee database usace 2015 and then selected grid cells of the hazard model were elevated to represent the blockage feature in summary previous work shows that accurately representing blockage features is an important and especially challenging aspect of flood inundation modeling using subgrid models furthermore in the context of dual grid models previous research points to value of methods that register the location of blockage features on the ugrid and adapt the processing of zgrid data for solution updates depending on the presence or absence of blockage features data to improve the representation of levees in flood inundation models is increasingly available the national levee database usace 2015 contains data on over 7 000 levee systems spanning over 40 000 km in the u s and the database is constantly being updated due to efforts from local state federal and tribal agencies there have also been calls for regional to global infrastructure data tourment et al 2018 özer et al 2020 and a new international levee database opendelve was recently introduced o dell et al 2021 high resolution zgrid data is also widely available across urban areas of developed nations to support detailed inundation modeling and the need for greater global coverage of high quality topographic data has been recognized schumann and bates 2020 the purpose of this study is to present a new semi automated method to improve the representation of blockage features in dual grid flood inundation models based on the following preconditions consistent with the literature review above a the location and continuity of flow barriers have been characterized as a polyline or can be readily characterized as a polyline using geospatial tools and data and b data characterizing the height of obstructions such as levees are resolved on the zgrid specifically in this study we present a semi automated workflow that flags ugrid edges based on the presence of a barrier levee so that the flow solver is guided to enforce blockage effects when such features are present and simulate overtopping when flood levels exceed blockage feature heights hence herein we present a workflow for ugrid edge classification that enables the dual grid solver to utilize available topographic data for solution updates more intelligently with the aim of achieving fine grid model accuracy at the computational cost of running a coarse grid model we acknowledge possible exceptions to the preconditions above such as errors in levee polyline data and blockage features that are not resolved by the zgrid but argue that these exceptions can be addressed with additional editing and processing of data and thus a push towards a semi automated workflow could offer immense value for future modeling the remainder of the paper continues as follows methods including the proposed grid edge classification method are presented in section 2 applications of the method and results are presented in section 3 and we close with discussion section 4 and summary and conclusion section 5 2 methods 2 1 large scale flood hazard model primo simulates flood hazards by solving the two dimensional shallow water equations with a godunov type finite volume scheme that is conditionally stable in accordance with a courant friedrichs lewy cfl condition sanders and schubert 2019 simulations can be forced in several different ways spatially distributed and time varying precipitation non point sources time varying inputs from streams entering a model domain and or concentrated runoff from catchments point sources time varying water levels at model domain boundaries boundary water levels and point sink point source pairs that account for water transfers through storm water infrastructure such as drainage pipes water transfers additionally flow resistance is modeled using a spatially distributed manning resistance parameter and soil infiltration is modeled with a runoff coefficient that transforms precipitation into runoff noh et al 2019 and approaches unity in urban areas due to impervious surfaces and soil saturation during extreme events bates et al 2010 wing et al 2017 noh et al 2019 for this study emphasis is placed on fluvial flooding scenarios to document potential overtopping of levees and thus model forcing is based on point sources of streamflow added to drainage channels that are representative of lateral inflows the fine resolution zgrid used by primo corresponds to a dem with n x columns and n y rows of ground elevation data z i j for i 1 n x and j 1 n y with a uniform cell size of δ z here i and j represent indices in a conventional cartesian coordinate system with the origin in the lower left corner of the spatial domain the coarse resolution ugrid corresponds to a spatial domain congruent with the zgrid where the number of columns and rows is based on the upscale factor n x n x α and n y n y α respectively introducing capitalized indices for the coarse grid i 1 n x and j 1 n y the solution state in each coarse grid cell is given by u i j η i j p i j q i j where η represents the elevation of the water surface p represents the discharge per unit width in the x direction and q represents the discharge per unit width in the y direction furthermore slopes in the free surface elevation δ x η i j and δ y η i j are computed using the minmod limiter sanders and bradford 2006 and used to downscale flood depth d from the ugrid to the zgrid as follows d i j max η i j z i j 0 for i α i 1 1 α i and j α j 1 1 α j where 1 η i j η i j δ x η i j x i x i δ y η i j y j y j and where x i and y j represent cell centered coordinates on the ugrid primo leverages the dual grid data structure in three distinct ways to support accurate flood hazard modeling first the α 2 z values within each ugrid cell are used to create tables of water storage per unit area h versus water level η once established in a pre processing step these tables are used each time step to compute η in each cell based on the storage h computed from the mass balance equation second the 2 α z values from the two sides of each ugrid edge are used to establish the cross sectional shape for mass and momentum fluxes between neighboring cells z ˆ k k 1 α including momentum fluxes that account for the bed slope source term valiani and begnudelli 2006 and third primo uses a bilinear reconstruction of the free surface elevation eq 1 for accurate downscaling of flood depth bradford and sanders 2005 note that the weakness of primo addressed herein the representation of blockage effects relates to the estimation of z ˆ k k 1 α for each ugrid edge connecting neighboring cells 2 2 study area and supporting data the proposed ugrid edge classification method is presented in the context of the los angeles metropolitan region fig 1 home to the 8 t h largest megacity in the world and the second largest in the u s based on a population of 19 million people blackburn et al 2019 with urban development blanketing a coastal plain below steep mountains rising to over 3000 m above sea level the region is vulnerable to flooding disasters from atmospheric river rainfall events that generate fast moving runoff and floodwater filled with mud and debris that may overwhelm infrastructure jones 2019 sanders and grant 2020 a 3 m zgrid was prepared with 756 1000 1000 cell tiles that span an area of 6804 km 2 see model domain in fig 1 levee polyline data were obtained from the national levee database usace 2015 and further edited for coverage and spatial alignment with blockage features red lines in fig 1 topographic data for the zgrid were derived from aerial lidar survey data obtained from the united states geological survey usgs and national oceanic and atmospheric administration noaa for los angeles county and orange county the topographic data effectively captures the height of most levees but additional processing of the data was carried out i e hydro conditioning for accurate representation of drainage pathways on the land surface bales and wagner 2009 for example aerial lidar encounters line of sight obstruction of flow pathways from bridges roads and other structures leading to gaps in data coverage or non physical blockage features in the land surface here these errors were corrected by intersecting openstreetmap osm road network data openstreetmap contributors 2022 with the dem to identify and correct erroneous changes in road elevations a second class of problems arises with drainage pathways through subsurface pipes which are not resolved by aerial lidar surveys using urban drainage geometry data representing open channels and connecting culverts from los angeles county and orange county public works open channel pathways were burned into the dem to support open channel flow routing as a result of hydro conditioning the zgrid the los angeles metropolitan region model developed here resolves both level 1 infrastructure major channels and levees and level 2 infrastructure secondary drainage channels and culverts pipes however level 3 infrastructure curb inlets and small storm pipes that connect curb inlets to large pipes or channels are not integrated into the model for this study a 3 m resolution raster grid of manning coefficients was also developed for flow resistance based on osm land use information see table 1 2 3 proposed edge classification herein we present a five step process or workflow fig 2 to improve the representation of levees along ugrid edges the process begins with a spatial domain of interest that is spanned by a ugrid zgrid and levee location data in a polyline format p x 1 y 1 x 2 y 2 x n y n and ends with the estimation of edge based elevation data z ˆ k k 1 α along edges of the ugrid the workflow is illustrated with a channel junction from the coyote creek subdomain of the los angeles metropolitan region fig 1a as follows 1 the first step fig 2a involves manual or semi automated editing of p such that levee polylines delineate both sides of any channel with a levee or flood wall on either side levee polylines may be acquired from available repositories e g national levee database opendelve and may also be created using geospatial tools 2 the second step fig 2b involves intersecting levee polylines with ugrid cells to establish a logical matrix m or mask at the same size and resolution as the u g r i d whereby true indicates that the grid cell contains a levee and false indicates that it does not this is accomplished by breaking the polylines into a set of points with a linear spacing comparable to δ z and flagging all ugrid cells that contain one or more of these points 3 the third step fig 2c involves filling holes within the logical matrix m these holes correspond to the channel space between levees on opposite sides of a channel this is accomplished using the imfill command in matlab mathworks natick ma 2 m i m f i l l m h where h x 1 y 1 x 2 y 2 x m y m represent the coordinates of points within the m holes of the mask m in fig 2b there is only one hole indicated by black coloring and the hole is filled as shown by the red mask in fig 2c we also note based on experience using the imfill command that the majority of holes are filled automatically so only a limited number of hole coordinates are typically required several iterations of inspecting results and adding additional points are typically required to complete the step an important consideration for this stage of the workflow to be successful is whether channel areas are fully encircled by m true cells if not then manual editing of m or the polyline data which generates m step 2 will be needed to produce channel areas that are completely surrounded and or encompassed by m true cells 4 the fourth step involves classifying edges of the u g r i d to guide the calculation of z ˆ using z g r i d data u g r i d edges that are representative of levees correspond to edges of the region defined by m true and appear in fig 2d as blue lines in the case of vertical grid edges the edge classification includes three possible options 1 for when the physical levee is to the left of the u g r i d edge 0 when there is no levee present and 1 for when the physical levee is to the right of the u g r i d edge in the case of horizontal levees 1 corresponds to a physical levee below the u g r i d edge and 1 corresponds to a physical levee above the u g r i d edge the edge classification is saved as two separate arrays for vertical edges and horizontal edges e v with a dimension n x 1 n y and e h with dimension n x n y 1 respectively mathematically this classification appears as follows for e v 3 e i j v 1 if m i 1 j 1 m i j 0 1 if m i 1 j 0 m i j 1 0 otherwise and similarly elements of e h are set as follows 4 e i j h 1 if m i j 1 1 m i j 0 1 if m i j 1 0 m i j 1 0 otherwise 5 in the fifth step manual re classification may be required to avoid blockage features in channels fig 2e presents an example where the initial levee polyline data fig 2a intersected a secondary drainage channel and the automated steps resulted in a non physical blockage feature the mask editing described in step 3 and edge re classification described in step 5 above are representative of the two types of manual editing that may be needed to implement this method one is related to the creation of holes within the mask m which requires the use of the imfill command and the other is related to the removal of edges incorrectly classified as levees in a practical large scale application as shown in fig 1 the need for manual editing can result from channels that intersect the model domain boundary fig 3a channels with discontinuous levee coverage which leaves openings in levee polylines fig 3b that need to be closed manually step 1 or 2 and edges incorrectly classified as levees fig 3c as a consequence of the openings in levee polylines that are closed manually fig 3b the grid edge classification matrices e v and e h guide the processing of zgrid data to produce a distribution of topographic data for each edge z ˆ k with k 1 α for solution updates as follows for edges classified as non levee edges pairs of zgrid data from opposite sides of the ugrid edge are averaged to estimate z ˆ as reported by sanders and schubert 2019 when the edge is classified as 1 z ˆ k is specified based on data from the ugrid cell on the left hand side of the edge in particular the maximum z value among the α 2 zgrid data points in the left hand ugrid cell is computed and assigned to all α values of z ˆ k conversely when the edge is classified as 1 z ˆ k is specified based on data from the ugrid cell on the right hand side of the edge and the maximum z value from the zgrid within the right hand ugrid cell is assigned to all α values representing the edge fig 4 illustrates the transfer of high topographic heights representative of a levee fig 4a to edges of a ugrid fig 4b for the estimation of z ˆ k for k 1 α note that the levee representation fig 4b is contiguous along ugrid edges no gaps to enforce a barrier to flow in both horizontal and vertical directions when water levels are below the crest of the levee upon exceeding the crest elevation the model simulates overtopping flows in accordance with mass and momentum fluxes resolved by the approximate riemann solver and solution updates by the flood inundation model sanders and schubert 2019 the proposed method to resolve levees results in spatially variable distributions of z ˆ for edges that are classified as 0 while it results in constant values of z ˆ across each ugrid edge classified as a levee 1 or 1 this could bias the method towards overprediction of flood protection in cases where levee heights vary significantly along the ugrid cell such as with a sloping channel as shown in fig 4 other sampling strategies could also be considered to create a distribution of edge based topographic heights z ˆ k for k 1 α but for this study a simple approach was used to promote continuity of flow barriers and avoid non physical flood spreading through blockage features previous work has emphasized the importance of continuity in the gridded representation of blockage features hodges 2015 with the implementation of this method in primo the edge classification matrices are written to a file and loaded at the beginning of a simulation to guide the computation of edge topography z ˆ k k 1 α for all edges prior to time integration alternatively edge topography could be computed off line and saved in separate sets of files to be loaded at the beginning of the simulation the former approach was implemented here to minimize the number of input files and the file storage requirements of the model and because the calculation of edge topography happens very fast in parallel and has negligible impact on overall compute times to illustrate the results of this workflow based on data from the los angeles region ugrid edges classified as levees for the coyote creek subdomain fig 1a are presented in fig 5a b and c white lines for α 10 20 and 50 respectively while the representation of levees becomes less precise with increasing upscale factor the method guarantees two important attributes for flood hazard modeling first continuity in flood defenses is preserved irrespective of the upscale factor which is critical for avoiding artificial leakage through levees and second levee heights are based on fine resolution zgrid data irrespective of the upscale factor 2 4 performance assessment fig 5 shows that as the upscale factor increases the planform area between levees also increases note the distance between the white lines and the red lines in fig 5 which could affect the accuracy of predictions increasing the upscale factor also increases numerical truncation errors i e numerical diffusion that may impact accuracy therefore simulation accuracy and biases are examined by comparing dual grid simulations with α 5 10 20 and 50 to fine grid simulation as has been done in previous studies of flood model performance e g haile and rientjes 2005 fewtrell et al 2008 the fine grid simulation is based on α 2 6 m without the edge classification method use of α 2 ensures that every topographic data point is used for flux calculations and thus all blockage features are resolved for accuracy considerations a fine grid model based on α 1 was not possible due to prohibitively expensive compute costs corresponding to simulations fully utilizing 756 compute cores and lasting for many months accuracy and biases in flood extent predictions are evaluated using a contingency table that quantifies the frequency with which the simulation predicts flooded cells above a threshold of 3 cm correctly or incorrectly compared to the fine resolution reference case the contingency table includes the number of cells correctly predicted as flooded a the number of cells where flooded cells are incorrectly predicted to be dry b and the number of dry cells incorrectly predicted to be flooded c these three measures are used to compute a critical success index csi false alarm ratio far and the hit ratio h as follows schaefer 1990 5 c s i a a b c f a r c a c h a a b where far serves as a measure of overprediction h serves as a measure of underprediction and csi provides a measure of overall accuracy we note that a perfect prediction corresponds to c s i 1 f a r 0 and h 1 dual grid model compute times t dg are recorded with all simulations and two different indicators are used as measures of model performance the first measure is model speed s defined as follows 6 s t rt t dg where t rt represents the real time covered by the simulation or model duration the concept of model speed is borrowed from weather forecasting where model simulations must execute substantially faster than real time to provide timely information for example woods 2006 suggests use of models with s 20 for timely information forecasting is not the focus of this study but given the immense computational demands of large scale modeling compute times are an important consideration and model speed offers an intuitive dimensionless number to interpret compute costs a second measure considered here is the ratio r of dual grid model to single coarse grid model compute times 7 r t dg t sg where t sg represents the compute time of a single grid model while no single grid models are actually implemented in this study an estimate of single grid model compute times can be made from a dual grid model compute time measured under low levels of upscaling the compute times of any well behaved spatially explicit flood inundation model constrained by the cfl condition can be estimated as follows assuming fixed computing power sanders et al 2010 8 t c 0 1 δ 3 where δ is the grid size and c 0 is a constant that depends on the spatial extent of the model the real time duration of the model and details of the algorithm eq 8 shows that compute times increase by a factor of eight with every halving of the grid size δ which illustrates the origin of computational bottlenecks in fine grid flood inundation modeling nevertheless when compute times are measured at one specific resolution δ 0 compute times for any other resolution can be estimated by rearranging eq 8 as follows 9 t sg δ t sg 0 δ 0 δ 3 where t sg 0 represents the compute time for grid size δ 0 for this study we estimate t sg 0 based on the dual grid model compute time at very low levels of upscaling α 0 2 the finest resolution that was feasible to implement at large scale and recalling that δ α δ z we estimate single grid model compute times at coarse resolution as follows 10 t sg α t sg 0 α 0 α 3 which allows eq 7 to be computed as follows 11 r α t dg t sg 0 α α 0 3 values of r equal to unity indicate that dual grid model compute times are equivalent to those of a coarse grid model while values greater than unity indicate that the dual grid model is more computationally demanding than a coarse grid model at the same coarse grid resolution 3 applications two test cases are considered both taken from the los angeles metropolitan region domain shown in fig 1 the first test case utilizes the coyote creek subdomain shown in fig 1a while the second test case utilizes the entire domain shown in fig 1 both test cases involve fluvial flood hazard scenarios whereby flooding is forced by point sources of flow added to channels and routed by the flow solver focusing attention on the accuracy with which coarse grid flow models characterize levee overtopping and floodplain inundation 3 1 coyote creek test case the coyote creek test case involves a 56 km 2 domain with 30 km of levee polylines along three different channels as shown in fig 1a fig 5 provides a magnified view which better illustrates the channel configuration topography and resistance are based on a 2500 2500 zgrid and the grid edge classification method was applied for ugrids defined by α 5 10 20 and 50 this test case is configured to measure the how accurately dual grid model simulations contain design flows within flood channels with and without the edge classification method point sources of flow are added to the upstream end of coyote creek carbon creek and the unnamed channel west of coyote creek at a rate of 800 225 and 7 m 3 s respectively see fig 5 these flow rates represent 90 of the maximum allowable flow rate in each channel determined empirically through an iterative process using model simulations with α 2 with flow at 90 capacity simulated overtopping will not occur until there is more than a 10 error in the simulated capacity of the channel each simulation was executed from a dry initial condition with steady inflow from point sources and a critical flow outflow boundary condition at the southwest corner of the domain which yields a subcritical flow regime upstream a 3 hour model duration was found to be sufficient to reach a steady state and is used in all simulations compute times for execution using α 2 5 10 20 and 50 corresponded to 9 75 h 30 5 1 and 1 min respectively on a laptop computer using 4 cores and there was negligible change to compute times using classified versus unclassified levees fig 6 shows flood extent based on a depth threshold of 3 cm for all model simulations and flood extent error statistics are reported in table 2 these results show that the model correctly predicts no levee overtopping for α 5 and 10 and only a minor amount of overtopping far 2 using α 20 when using classified edges in contrast the model incorrectly predicts moderate levee overtopping far 7 22 for α 5 and 20 when using unclassified edges use of α 50 results in incorrect prediction of overtopping regardless of the edge classification method which highlights limits to the amount of upscaling that can be implemented before accuracy levels become unacceptable to summarize these results show that the proposed edge classification method reduces or eliminates the incorrect prediction of levee overtopping for the cases with α 5 10 and 20 far values are roughly an order of magnitude smaller using classified versus unclassified edges 3 2 los angeles metropolitan region test case application of the edge classification method to the entire los angeles metropolitan domain involved consideration of 987 km of polylines with 92 different channel openings and levee input files were prepared for ugrids defined by α 5 10 20 and 50 manual editing over several hours was required to address the types of irregularities shown in figs 2e and 3 a 100 year return period fluvial hazard is used to evaluate the grid edge classification at the metropolitan scale use of a fluvial scenario focuses attention on the containment of flow in flood channels and potential biases from inaccurate prediction of levee overtopping the fluvial flood hazard scenario was developed using data from 51 streamgages across the region maintained by usgs los angeles county public works and orange county public works see fig 1 to estimate 100 year flow rates frequency analysis was completed using hec ssp software developed by the u s army corps of engineers hydraulic engineering center 2021 which follows usgs bulletin 17c england jr et al 2019 flow was forced with a distributed set of point sources in channels that accumulate to match the 100 year flow rate at each gaging station in consideration of all upstream point sources using 756 compute cores on the cheyenne cluster at the ncar wyoming supercomputing center flow was simulated for a 48 hour duration to reach a steady state and dual grid compute time t dg model speed s and the dual grid single grid compute time ratio r are reported in table 3 based on the speed criterion for usefulness reported by woods 2006 and results in table 3 model simulations involving α 10 20 and 50 provide sufficient speed to provide timely forecast information i e speed is greater than 20 furthermore model simulations involving α 5 10 and 20 and classified edges have compute costs that closely track the compute costs of an equivalent coarse grid model based on r values close to unity 0 9 1 2 use of α 50 results in a model speed s that is lower than ideal and a dual grid single grid ratio r that does not match an equivalent single grid model we attribute this to the computational demands of data output which are typically small compared to computing demands but become a larger fraction of the overall costs as upscaling increases we also note that our model for single grid compute times eq 8 does not account for the cost of data output an overview of the flood hazard distribution is presented in fig 7 and reveals several parts of the region where channels are unable to contain the 100 year flow rate including communities between los angeles and long beach fig 7b communities near burbank fig 7b and coastal communities such as huntington beach fig 7c e also show three levels of magnification to illustrate the level of detail that is captured by the model fig 7e shows the finest level of detail characterized by street level details with flood water moving along the road network of particular interest for this study is whether and to what extent the proposed edge classification method alters the simulated distribution of flooding to this end table 4 provides a summary of flood extent accuracy metrics using a fine grid model as a reference case for the entire model domain as well as long beach and san fernando subdomains shown in fig 1 the long beach subdomain encompasses a region that was historically occupied by riparian and coastal marshlands of the los angeles and san gabriel rivers and is presently defended from flooding by engineered flood channels with levees orsi 2004 due to its low topography and position along major rivers the deepest and most severe flooding of the region is simulated to occur within this subdomain the san fernando subdomain is representative of an urbanized alluvial fan where convex topography is capable of producing overtopping flows with diverging flow paths that are highly sensitive to localized changes in topography nrc 1996 garcia et al 2004 santangelo et al 2011 hence accuracy metrics are computed in areas of highest importance based on the depth of flooding and in areas where high accuracy is expected to be most challenging to achieve table 4 shows that across the full domain the proposed ugrid edge classification leads to lower far and equal or lower h compared to the model with unclassified edges and the overall accuracy represented by csi is 2 7 percentage points higher using classified edges the overall error computed as 100 csi at the scale of the full domain can be estimated to be 10 13 and 18 for α 5 10 and 20 respectively for context the highest csi values achieved in validation studies relative to flood extent measurements in the study area have been 80 corresponding to a 20 overall error gallegos et al 2009 schubert and sanders 2012 hence the errors of the dual grid flood model with grid edge classification presented here can be viewed at worst as being slightly smaller than overall errors considering uncertainty in flow topography resistance and storm drain infrastructure table 4 also illuminates different levels of sensitivity to upscaling between the long beach and san fernando subdomains in the long beach subdomain where changes in topography are relatively mild and there are numerous channels with levees where overtopping is simulated to occur the dual grid model using classified edges yields high accuracy csi 80 for α 5 10 and 20 conversely in the san fernando subdomain characterized as an urbanized alluvial fan csi drops to 72 and 61 with α 5 and 10 respectively additionally for the long beach subdomain csi is increased by 5 12 percentage points far is reduced 12 16 percentage points less overprediction and h is reduced 0 7 percentage points more underprediction from using classified grid edges conversely in the san fernando subdomain far is reduced only 0 4 percentage points and h is reduced 0 3 percentage points excluding the case with α 50 fig 8 provides a magnified view of the long beach subdomain and shows areas of agreement green overprediction blue and underprediction red compared to the fine grid model overall the level of agreement appears very good using classified edges and the amount of underprediction and overprediction appears minimal when using classified edges and α 10 additionally this shows that for all four upscale factors overprediction is reduced using classified edges compared to unclassified edges less blue comparing classified to unclassified cases across the same value of α furthermore the cause of high overprediction for the case with α 50 and unclassified edges can be attributed to incorrect prediction of channel overtopping see upper left quadrant of top right panel underprediction may be of particular interest based on the possibility of incorrectly predicting safety from flooding the amount of underprediction is reflected by the difference between 100 and the hit rate as a percentage using classified edges α 5 yields more underprediction than α 10 20 or 50 indeed both the α 5 and α 10 cases result in csi 88 using classified edges but the α 5 is better from a perspective of less overprediction and α 10 is better from a less perspective of underprediction the patterns of flooding simulated in the san fernando subdomain are presented in fig 9 flow initiates at the northern edge of the domain where channel capacity is insufficient to contain the 100 year flow and simulated channel overtopping generates divergent flow paths in the downstream southerly direction note here that a single channel with levees is responsible for the excess flows fig 9 shows that east west roadways enable dispersal of flooding to the east through neighborhoods here errors in the over and underprediction of flood extent blue and red respectively strikingly increase between α 20 and α 50 this is attributed to the high sensitivity of alluvial fan flooding to differences in topography resolved by each model pelletier et al 2005 conversely differences in flood extent between the classified and unclassified cases are minimal except when using α 50 hence the results in this sub domain draw greater attention to the sensitivity of the dual grid model to increased upscaling versus representation of levees 4 discussion as mentioned in the introduction urban flood hazards have proven difficult to accurately simulate using large scale models and accuracies reported have ranged from csi 23 wing et al 2017 to csi 46 ward et al 2017 in these previous studies csi is measured relative to flood zones mapped by different models and thus accounts for numerous factors that contribute to uncertainty such as the magnitude of flood peaks representation of topography and other factors in contrast csi values reported here only reflect the effects of upscaling and the proposed ugrid edge classification nevertheless high csi values 80 demonstrate the potential for large scale models to reduce errors associated with grid resolution a finding that is responsive to calls for greater attention to local data for urban flood hazard modeling e g jonkman 2013 these results also highlight the challenges of accurate modeling of flood hazards on steep and convex topography associated alluvial fans see nrc 1996 based on csi values of roughly 60 with α 10 for the san fernando subdomain table 4 these results also demonstrate the value of levee polyline data available from the national levee database usace 2015 and the importance of the new global database for levee data opendelve o dell et al 2021 in fact efforts to utilize levee data in flood hazard modeling studies also present opportunities to scrutinize and further expand existing levee data repositories and could help to accelerate the availability and coverage of data dual grid model simulations with forecast ready speeds s 20 compute times comparable to those of single grid models r 1 and consistency with respect to fine grid models csi 80 at the metropolitan scale constitute an important advance with respect to developing flood simulations with fine grid accuracy at the cost of coarse grid models widespread utilization of dual grid model structures could help to improve the accuracy of nationwide flood risk assessments e g wing et al 2017 bates et al 2021 expand simulation enhanced flood risk adaptation e g luke et al 2018 sanders et al 2020 from the community level to the regional level and enable real time flood inundation forecasting with a process based modeling approach ivanov et al 2021 we acknowledge however the need for future research to consider the role of level 3 drainage infrastructure e g curb inlets and small pipe connections to level 2 drainage infrastructure and the need for systematic approaches to model calibration and validation urban flooding during extreme events is rarely well monitored and a lack of data for model calibration and validation e g flow and depth distribution through street network and uncertainties in hydrologic drivers e g precipitation streamflow storm surge hinder the estimation of model parameters and the development of accurate models given high uncertainties in hydrologic drivers it is reasonable to be somewhat pessimistic about achieving major benefits from enhanced land surface process representation see bates 2012 additional research is needed on process based models strategies for model calibration validation and implications for simulation accuracy timeliness and uncertainties to deepen understanding and build capacity on this important frontier of hydrologic science and engineering 5 summary and conclusion herein we present a grid edge classification method to improve the representation of blockage effects and levee overtopping in large scale dual grid flood inundation models that sample topographic data from a fine resolution zgrid to account for mass and momentum fluxes between neighboring coarse resolution ugrid cells while previous work envisioned the redistribution of blockage features such as levees along coarse grid edges e g hodges 2015 li and hodges 2019 2020 here we present a new workflow that leverages available polyline data to create a coarse grid edge classification the workflow sharpens the representation of levees as barriers to flood spreading and constraints on overtopping furthermore we present an application of the workflow that is unprecedented in scale at a fine resolution 3 m covering the los angeles metropolitan region which is home to roughly 19 million people vulnerable to major flooding from a severe atmospheric river event application of the model across the los angeles metropolitan region shows that flood extent accuracy with α 10 30 m effective resolution is characterized by a critical success index of 87 a false alarm ratio of 5 and a hit rate of 91 when compared to a fine grid model and compute times are 30 times faster than real time similarly an α 20 model 60 m effective resolution achieves a critical success index of 82 a false alarm ratio of 12 a hit rate of 93 and compute times 300 times faster than real time furthermore these dual grid compute times closely match within 10 the compute costs of a single grid model run at the same coarse grid resolution hence we find that the proposed grid edge classification method based on levee location data enhances dual grid model accuracy such that it is comparable to fine grid model accuracy at compute costs comparable to those of single grid models the proposed grid edge classification method is particularly effective at reducing the overprediction of flood extent which is a drawback of existing dual grid models sanders and schubert 2019 this work also validates the importance of the national levee database usace 2015 new global levee databases o dell et al 2021 and accessible high resolution topographic databases to enable systematic advances in the modeling of urban flood hazards schumann and bates 2020 differences in dual grid model accuracy were observed across two subregions of the study area with differing topographical features in a fluvial corridor near long beach historically occupied by riparian and coastal wetlands the dual grid model with α 5 and 10 demonstrated high accuracy marked by a critical success index of 88 on the other hand on alluvial fan topography near san fernando with relatively steep topography the dual grid model with α 5 and 10 demonstrated only moderate accuracy marked by a critical success index of 72 and 61 respectively furthermore simulated flood extent in the san fernando subdomain was more sensitive to upscaling than to the proposed grid edge classification lower accuracy is attributed to convex topography whereby local scale variability in the representation of topographic heights can trigger divergent flow paths nrc 1996 pelletier et al 2005 furthermore lower sensitivity to the edge classification method is attributed to flows that far exceed channel capacity such that changes in levee representation do not substantially alter the amount of overtopping flow these results call attention to the need for more robust dual grid upscaling methods for steep and convex topography with higher sensitivity to topographic variability credit authorship contribution statement daniel t kahl methodology software validation formal analysis writing original draft jochen e schubert validation writing original draft review and editing ariane jong levinger validation review and editing brett f sanders conceptualization methodology software review and editing supervision declaration of competing interest the authors declare the following financial interests personal relationships which may be considered as potential competing interests brett f sanders reports a relationship with zeppelin floods llc that includes equity or stocks jochen e schubert reports a relationship with zeppelin floods llc that includes equity or stocks acknowledgments this research is made possible with support from the national science foundation usa under grants hdbe 2031535 and icer 1940171 this work was also supported by the noaa effects of sea level rise program usa under grant na16nos4780206 and by the ridge to reef nsf research traineeship usa award dge 1735040 we also acknowledge high performance computing support from the ncar wyoming supercomputing center provided by the national science foundation and the state of wyoming and supported by ncar s computational and information systems laboratory 
