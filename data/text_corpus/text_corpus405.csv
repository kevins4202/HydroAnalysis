index,text
2025,the streamflow estimation in ungauged or poorly gauged basins is a fundamental and challenging problem in hydrology which has often been solved by transferring hydrological information from gauged basins i e by regionalisation most studies on streamflow regionalisation focus on identifying the best methods to transfer the hydrologic model parameters and uses primarily physiographic attributes or climate information for these purposes in the present study the sequential data assimilation method the kalman filter has been used to determine streamflow in a poorly gauged unknown basin to combine in an optimal way observations of neighbouring basins and model simulation of a given basin the methodology is based on the concept of concatenated upstream catchments where the aggregation of unobserved states can be estimated the streamflow estimate is further divided between the unknown sub catchments using linear regression on the catchments hydrological characteristics which are subsequently used to approximate error statistics and operators in the kalman filter application the results were evaluated on 165 catchments in the czech republic using rmse mase and mae criteria and indicate that in 87 3 of the cases the proposed methodology improved the accuracy of streamflow estimations by an average of 40 in combined evaluated measurements compared to the original simulations within the system for drought monitoring and forecasting in the czech republic hamr keywords streamflow poorly gauged basins data assimilation kalman filter data availability the authors do not have permission to share data 1 introduction despite the slow onset drought belongs among the most devastating natural disasters accounting for 34 of all fatalities and 7 of the economic losses caused worldwide by weather climate and water related extremes from 1970 to 2019 wmo 2021 drought risk management requires the improvement and application of shorter term forecasts as well as climate outlooks within which the impact on the main components of the hydrological cycle is often considered sene 2016 however data quality and availability are common limiting factors for real time assessment and model calibration according to the definition given by sivapalan et al 2003 basins where inadequate in situ records prevent the computation of hydrological variables of interest are classified as ungauged with respect to this variable as a special case in basins where adequate records of the variable of interest e g streamflow at basin outlet are lacking some information can be derived from the subbasins observations such basins are further referred to as poorly gauged the modelling tools for ungauged basins are numerous yet generally the process known as regionalisation is frequently used to transfer information about hydrological behaviour between basins he et al 2011 regionalisation approaches include methods such as physical similarity based on similar catchment attributes spatial proximity or regression which identifies the relationship between hydrological parameters and catchment characteristics guo et al 2021 at the same time hydrologic modelling is affected by various uncertainties the main sources being models inputs outputs structure and parameters renard et al 2010 data assimilation da methods developed for the optimal combination of information from model simulations and observations have proven to be suitable for assessing such modelling uncertainties and refining simulations liu et al 2012 due to convincing performances the da procedures have been used extensively in the field of hydrology in recent decades the approaches according to asch et al 2016 can be generally classified in the following way variational where the solution is sought via the minimalisation of a suitable error function i e 3d var 4d var nudging sequential the solution with minimal variance is sought for instance kalman filter and its extensions and hybrid namely 4denvar ienks and eda with newer approaches continuously becoming available several overviews of hydrological da methods are available including walker and houser 2005 reichle 2008 and liu et al 2012 a consensus is emerging in favour of sequential da methods due to their simple implementation and lower computational requirements with similar or higher performance compared to other da methods abaza et al 2014 specifically according to the review of the kalman type hydrological data assimilation studies by sun et al 2016 the kalman filter kf introduced by kalman 1960 is considered to be one of the most widely used methods moreover according to the same review streamflow is the most commonly used and in some cases the only available variable for prognostic purposes in sequential da the applications in this area are vast and numerous among them are for example the improvement of streamflow forecasting accuracy via model output or error corrections using linear wu et al 2012 chen et al 2015 and non linear anctil et al 2003 abebe and price 2004 processes in some cases the streamflow is updated directly fairbairn et al 2017 and in other approaches the streamflow is treated as a diagnostic assimilated variable whilst other state variables and parameters are corrected moradkhani et al 2005 coustau et al 2013 furthermore approaches based on in situ lee et al 2011 or remote sensing satellite data alvarez garreton et al 2015 have been investigated where the potential of other assimilated variables and states such as soil moisture and soil water stores given their role in runoff generation or interior flows on streamflow prediction has been assessed studies focusing on streamflow estimation in fully ungauged basins often deal with inadequate records by utilising synthetic satellite data in particular studies by durand et al 2016 and frasson et al 2021 work with topography data such as height width and slope for rivers wider than 50 100 m where algorithms based on data assimilation inversion and big data techniques are explored produced results are laid as a groundwork for future surface water and ocean topography swot discharge algorithm development which is intended to complement river discharge modelling at a continental scale and to help reduce current model annual runoff errors rather than to be a replacement for in situ discharge measurements furthermore the swot satellite mission provides synthetic observations of water depth and water elevation anomalies which can be utilised as well as other satellite altimetry based discharge products in poorly gauged basins as shown by emery et al 2018 and emery et al 2020 in their studies the assimilation into a large scale river routing model to correct its input parameters showed a promising perspective for water depth simulation as the da converged quite quickly towards the true value of the associated control variable at the same time the correction of the state variables for discharge simulation reduced the modelling errors for all experiments few studies propose new da methods accompanying regionalisation for streamflow simulations in ungauged or poorly gauged basins for example parada and liang 2010 implements a combination of the kernel techniques variational bayesian kalman filter and smoother while focusing on ungauged basins whose hydrological and system properties or behaviour are non linear as well as non gaussian although limited to two watersheds and leaning on computationally demanding methods the study provides promising results another example could be a study by dumedah and coulibaly 2012 where a unique approach for transferring ensemble members from gauged to ungauged watersheds is proposed which is an integration of pareto optimality into particle filter and enkf in the czech republic where drought was evaluated as the second most severe hydrometeorological extreme after floods br√°zdil et al 2015 a drought monitoring and prediction system called hamr has been created vizina et al 2018 covering more than 1000 water bodies the majority of them being poorly gauged the hydrological model for such water bodies was calibrated using estimated hydrological characteristics signatures although these characteristics were in general captured well in the simulations the simulated extremes and components of hydrological balance are accompanied with considerable uncertainties due to equifinality the present study proposes the kf based method to estimate the streamflow of unknown poorly gauged water bodies through the assimilation of streamflow observations from the neighbouring hydrological units to obtain a more accurate streamflow estimate for said unknown water bodies the hamr modelling scheme contains the reservoir manipulation plans nevertheless it is also the extraordinary manipulations which may largely affect the streamflow and the kf method is expected to be able to carry this information however the effectiveness of the kalman filter for assimilating reservoir manipulation data depends on the quality and availability of the data as well as the accuracy of the modelling scheme accurate and timely data on reservoir storage releases and other operational parameters are needed to incorporate reservoir manipulation information into the hydrological model effectively in future studies such estimates should as a result yield more accurate simulated components of the hydrological cycle within the hamr system a description of the available data and their sources is provided in section 2 section 3 1 introduces the data assimilation and kalman filter framework while section 3 2 introduces the approach for improving the accuracy of the hamr streamflow estimates on poorly gauged water bodies section 3 3 describes the process of the performed validation the validation results are further presented in section 4 and are discussed later in section 5 2 data the hydrologic system of the czech republic is formed by three main catchment areas the rivers elbe odra and morava which are divided for organisational purposes into eight river basin districts rbds see fig 1 upper and middle elbe river upper vltava river river berounka lower vltava river river oh≈ôe and lower elbe river river odra river morava and river dyje thaya the hydrological system is further divided into 1112 hydrological units water bodies langhammer et al 2010 a water body wb is classified as a stream or reservoir based on the type of outlet it represents for the purposes of this study the daily discharge time series for 406 water bodies of various lengths were used the majority of which were obtained from freely available resources czech hydrometeorological institute chmi ƒçhm√∫ 2021 while the rest were obtained from rbd authorities the spatial distribution of water bodies and data availability is shown in fig 2 the long term flow rates and other flow characteristics of the river bodies in the czech republic were provided by the chmi including the accuracy class based on the length and quality of the data used for the estimation which represents the uncertainty propagated from the observations in the current study approximations for long term 1981 2010 average discharges q a and m day continuous discharges q m d are used where q m d is another form of showing the discharge exceedance value of the flow duration curve fdc stevanoviƒá 2015 in other words m indicates the average number of days of reaching or exceeding the corresponding discharge in the year furthermore for calculation purposes the information about water use in 2000 2019 was acquired from the rbd authorities to whom users report this data as monthly sums the latest reports are available in the water usage database of the czech republic ministry of agriculture of the czech republic 2021 the water use information was aggregated for each wb and transformed to the daily step uniformly so that the aggregate of those days equals the reported monthly value finally a significant component of the drought prediction system is the description of the hydrographic network which provides information about the upstream and downstream linkages of each wb the data for the czech republic are available from the tgm wri hydroecological information system wri heis tgm wri 2021a the kf based methodology proposed in this paper section 3 2 uses the simulated streamflow time series for stream type wbs for the years 1981 to 2019 from the drought information system hamr estimations of the hydrological balance components within the system result from the coupling of the soilclim model for water balance and soil climate estimates introduced by hlavinka et al 2011 bilan water balance model appendix b and wateres reservoir water use and river network model appendix c the hamr calibration process for the unknown wbs relies on the wbs hydrological characteristics q m d and q a estimates pavl√≠k et al 2023 for the reservoir type wbs the results of the wateres model were used 3 methods 3 1 data assimilation and kalman filter data assimilation problems are principally solved using two classical approaches both approaches seek the optimal solution either through the search for minimal variance sequential approach or through the minimisation of the error function variational approach asch et al 2016 the notation for sequential da problems formalised by ide et al 1997 can be written as a set of the following equations 1 x k 1 m k 1 x k w k w k n 0 q k 2 y k h k x k v k v k n 0 r k eq 1 is an equation of the dynamic stochastic system in discrete time k where m is called a dynamics operator an operator describing the evolution of the states from time k to time k 1 eq 2 defines the relationship between the observed and modelled quantities and represents the mapping from the model space x k into the observations space y k it is done using the observation operator h which can also be time dependent the random vectors w k and v k represent the process or modelling and measurement observation errors respectively which are assumed to be independent normally distributed white noise the covariance matrices q and r represent model and observational error respectively which are assumed to be known and can in general be time dependent stemming from eqs 1 and 2 the kalman filter provides an update at each observation time k of the a priori forecast estimate x k f by the available observations y k and the corresponding model simulation h k x k f both weighted by their respective uncertainties the outcome x k a is called an a posteriori or analysis estimate and under certain assumptions such as i the errors in the measurements and the system dynamics are both gaussian and ii the model is linear is equivalent to the best linear unbiased estimator blue therefore the kf can be written in the form of the following equation 3 x k a x k f k k y k h k x k f where k is called the kalman gain an optimal gain matrix chosen to quantify the updated weight represented by the forecast error covariance matrix p k f the latter combines the uncertainties of the a priori forecast estimate and the unknown true state x k t specifically by the equation 4 p k f cov x k f x k t the kalman gain is thus estimated as follows 5 k k p k f h t h p k f h t r 1 algorithm 1 illustrates the predictor corrector loop based on the detailed description of the kalman filter method provided in asch et al 2016 to apply da methods to hydrological modelling and more specifically to establish the kf method the following assumptions are made in addition to those already mentioned i the observation operator is linear ii the error statistics biases and covariances are functions of physical processes and are assumed to be known iii the errors are unbiased and uncorrelated nevertheless in real life problems those assumptions must often be relaxed asch et al 2016 for instance the only way to estimate the error statistics is to assume ergodicity i e to assume that these statistics are stationary over a period of time and uniform over a domain bouttier and courtier 2002 dr√©court 2003 argues that while the ergodicity assumption is crucial for real life hydrological systems the stationarity assumptions are not required by the filter and the assumption of the gaussian and additive noise structures is questionable regarding the accuracy of the outcome due to the analysis equation being linear therefore correcting only the first two moments of the probability distribution of the state vector 3 2 application of kf in the upstream water body structure using the information about the configuration of water bodies i e their upstream linkages and the information on neighbouring water bodies structures with strictly given interconnections can be constructed such a structure fig 3 is closed by the gauging station determining the upstream wbs for the purposes of this study the elements of the structure are termed as follows the main water body includes the outlet typically a gauging station of the whole structure the direct water bodies are the adjacent wbs themselves direct water bodies are then labelled as known if their discharge data are available and unknown otherwise this structure allows the calculation of the streamflow estimate for the unknown water body x e s t t as follows 6 x e s t t y m a i n t i 1 k y i t u m a i n t t 1 t where y m a i n t is the observed discharge at time t and u m a i n t is the reported water usage for the main wb y i t are the observed discharge of the direct wbs and k is the number of known direct wbs for simplicity in the following notations time index t is omitted eq 6 considers only the water use of the main wb u m a i n designated in yellow in fig 3 which is calculated as an aggregation of reported water abstractions and discharges the reason is that such information is not present at the outlet points represented by the gauging stations of adjacent direct wbs but rather at the outlet of the main wb after the entirety of the water use registered on the main wb took place this means that if all direct wbs are known the difference between their streamflow aggregate and the main wb will result in the water use time series for the main wb in the absence of known wbs the component i 1 k y i equals zero and the estimated discharge for unknown wbs is calculated as x e s t y m a i n u m a i n in the case of multiple unknown wbs in the structure the estimate for the water body i is established using the auxiliary linear regression model 7 log r i Œ≤ 0 Œ≤ 1 q a i Œ≤ 2 q 364 d i Œ≤ 3 area i …õ i where r i is the median discharge calculated on the last five years of available data q a i is the estimated long term 1981 2010 discharge q 364 d i the discharge that is reached or exceeded on average for 364 days in a year for the same period area i is the area of the wb and …õ i is the error term the final variables in eq 7 were selected from a larger set of flow and wb characteristics by stepwise forward selection with akaike information criterion aic the parameters of the model were estimated by the ordinary least squares ols method using the model from eq 7 the estimates of the average discharge for the unknown wbs are made which are further divided by their sum to scale them to the range of 0 1 and notated r r a t as for discharge ratio the estimations for the unknown wbs x e s t j are then calculated using the following transformation 8 x e s t j x e s t r r a t j j 1 m where m is the number of the unknown wbs in the structure the streamflow estimates x e s t j are subsequently used to approximate the observational error covariance matrix r and the linearised observation operator h for those purposes the observed time series for known wbs in the structure are scaled to match the range of x e s t j in the following steps 9 y s c i y i m i n y i iqr y i i 1 k 10 y s c i y s c i iqr x e s t j m i n x e s t j i 1 k j 1 m where y s c i is the scaled observed discharge and iqr is the interquartile range the minimum is used instead of the mean median to avoid negative values and iqr is considered instead of the standard deviation to reduce the impact of extreme values on the variability estimate then using the simple linear regression model the relationship between discharge for known wbs and the estimated discharge for the selected unknown wbs is established 11 y s c i Œ≤ x e s t j …õ the observation operator h k 1 is subsequently represented by the regression coefficients of the model from eq 11 non diagonal elements of the matrix r k k are represented by the covariance of the model s residuals 12 r l h cov y s c i y s c i l h l h while diagonal elements are calculated as its variance with a penalisation in the form of the chmi accuracy class to represent the observation uncertainty as well as a penalisation for the imprecise division of the x e s t 13 r l h v ar y s c i y s c i e a c c 1 r r a t j l h the penalisation member 1 r r a t j is introduced to account for the uncertainty caused by the relationship between wbs and their surroundings the e a c c member is calculated as 14 e a c c 1 n t 1 n y i t a c c i 2 where y i is an observed discharge on the direct wb and a c c i is the accuracy class provided by chmi which represents an approximate value of the mean square error for the q a of the given wb provided in percentages based on the quality and length of the observational time series available for the estimation and n is the number of observations model error covariance matrix q is estimated as the average squared difference eq 15 between the simulations of the bilan or wateres model x s i m and the long term average discharge q a for the given water body due to the q a being an estimate the error is further increased following the accuracy class associated with the estimate a c c see eq 16 the mean squared error mse criterion can be written as follows 15 mse 1 n t 1 n f t y t 2 with y t being the observation at time t and f t the forecast of y t 16 q 1 n t 1 n x s i m t j q a j 2 q a j a c c j estimated matrix variables r q h as well as the state error covariance p which has an assigned value of one are assessed individually for each of the unknown wbs in the structure along with the matrices the state vector x k f represented by the bilan wateres simulations x s i m and the observation vector y k represented by the scaled observed discharge y s c both estimated for the given unknown wb are introduced into the kf algorithm see algorithm 1 the kalman filter loop is therefore repeated the number of times equal to the number of unknown wbs in the structure the kalman filter function updates the state estimate x k a and its covariance p while other fields of the system are left unchanged the above described steps have been summarised into an algorithm via diagram see fig 4 to represent individual steps intent and function 3 3 method validation for validation purposes out of 406 water bodies with available discharge observation 165 were selected based on the condition that the main wb in their structure is known and that there are wbs directly adjacent to them these 165 wbs were assumed to be unknown for validation purposes with their time series left aside for the result evaluation the results were split into categories based on their outlet type reservoir or stream in this case the reservoirs are represented by the water bodies with the controlling water sources capacity at the place of transition between water bodies and not the water reservoir itself as can be seen in fig 5 the streams were further divided into categories derived from the distribution of the long term average discharge over wbs q a quantiles being calculated on the whole set of czech republic s wbs i e 1121 hydrological units the categories are specified in table 1 and the resulting categorisation of wbs over the czech republic is shown in fig 5 the categories including their names are introduced here merely as a more apprehensible and detailed way to analogise and present the results the application of this classification reveals that between the validated wbs there are no low flow ones which is consistent with the fact that smaller wbs are less likely to be observed due to maintenance costs medium and high flow wbs represent the majority of the set at 50 9 and 39 4 respectively while reservoir wbs represent the remaining 9 7 of the set the number of wbs in each category is shown in table 1 the number of wbs based on rbd is shown in table 2 for the validation of the kf algorithm at each water body multiple criteria were calculated specifically mean absolute error mae 17 mae 1 n t 1 n f t y t mean absolute scaled error mase hyndman and koehler 2006 18 mase 1 n t 1 n y t f t 1 n 1 t 2 n y t y t 1 and the root mean square error rmse 19 rmse 1 n t 1 n f t y t 2 where the denomination is consistent with previous notations these criteria were evaluated simultaneously if two of those criteria exceeded the value of the corresponding criterion for the benchmark model hamr simulations the wb would be considered problematic 4 results the methods described in sections 3 1 and 3 2 were applied to the validation set of water bodies the description of the validation process is available in section 3 3 the spatial distribution of the validation results considering the combined criteria is shown in fig 6 whilst the criteria values for each wb within the assigned wb category are shown in fig a 14 reservoirs fig a 15 high flow stream wbs and fig a 16 medium flow stream wbs the results can be evaluated as a whole through the percentual decrease of error calculated using the formula k f b e n c h m a r k 1 100 compared to the simulation benchmark the median reduction in error corresponds to 38 7 for high flow wbs 39 3 for medium flow wbs and 47 for reservoir type wbs fig 7 those numbers are similar throughout rbds fig 8 with the slight exception of the odra river basin where benchmark model simulations tend to have higher precision with respect to the observed time series while the oh≈ôe and lower elbe river basin effectively provide precise kf simulations but the low number of validated wbs precisely ten should be taken into account the overall median percentual error reduction corresponds to 39 4 no considerable difference in the median percentual error reduction between categories and rbds can be seen in figs 7 and 8 the time series of the best performing wbs are shown in figs 9 and 10 out of 165 validated water bodies 15 wbs 9 1 could be considered problematic 5 wbs or 3 correspond to the benchmark model and the model results in na value for 1 wb cases where the kf results match the bilan or wateres simulations or even ensue into the na value are seen as desirable behaviour of the algorithm it is explained by the fact that such cases result directly from the distinct spatial position where other known wbs in the structure are incomparable to the considered wb to the extent that the linear model from eq 11 does not find the relation resulting in the observation operator h represented by missing values or zeros the reasons behind the problematic wbs could be categorised on the basis of their inferred origin for instance wbs ohl 1110 and ohl 1140 see fig a 17 situated in the rbd of the oh≈ôe river and lower elbe river are both parts of the same structure where the wb with the identifier ohl 1150 represents the main wb of the structure ohl 1150 is the point where the major watercourse flows into the neighbouring state of germany which corresponds to the upstream catchment for the elbe river basin this wb has the highest average discharge 300 m 3 s 1 in the czech republic more than 100 times the discharge of the adjacent ohl 1140 and 37 times the discharge of the ohl 1110 the significant differences in discharges would typically lead to the low value of the kalman gain estimate resulting in a higher weight for the benchmark model in the particular cases of those wbs the differences are so steep that it results into the imprecise division of the estimate for the unknown wb x e s t which combined with low values of the kalman gain reduces the bilan simulations that steep difference in the average discharges between water bodies in the structure appears to be an exception although preserving original simulations might be preferable if such a case occurs in the case of wbs dvl 0810 lower vltava river district and ber 0770 berounka river district unexpected behaviour in the x e s t estimate occurs where the mean value of the estimate is more than 8 times higher than the estimated long term average q a for these wbs the severe difference implies insufficient information to establish more accurate estimates most probably caused by unreported water use see fig a 18 such behaviour might be addressed via the adjustment of the x e s t estimate albeit the definitive method has not yet been concluded the most frequent reason behind the problematic wbs lies in chmi s long term flow characteristic overestimations compared to their observation determined values these characteristics play a significant role in establishing matrices r q as well as discharge ratio r r a t see section 3 2 as a result the majority of problematic wbs are represented by a time series with correlated but overestimated development the overestimation of the q a in high flow wbs varies from 2 13 to 9 1 times the average of the observed discharge leading to significant error that is the case of ohl 0030 oh≈ôe and lower elbe mov 0820 morava ber 2070 berounka and hsl 2040 upper and middle elbe wbs see fig 11 in the case of reservoir wb hsl 1845 j upper and middle elbe the q a is overestimated by 3 38 whilst for medium flow wbs mov 1320 morava hod 0590 odra dyj 0140 dyj 0050 thaya and ber 0480 berounka the overestimation varies from 1 3 to 7 4 times see fig 12 the observed time series for hod 0820 hod 0590 odra fig 13 and ber 2070 berounka fig 11 wbs have specific behaviour due to the direct proximity of reservoir wbs to them specifically these wbs act as the main wbs for structures that include a reservoir the direction of the calculation hierarchy proceeds from the main wb and will not acknowledge such patterns marking such cases as special these results are nevertheless valuable since they provide better insight into method performance as shown in fig 13 the method is capable of assessing the corresponding temporal evolution of discharge in contrast to the benchmark model when more accurate flow characteristics estimates are obtained by the proposed methodology 5 discussion the assessment of the methodology proposed in this study suggests considerable improvement over benchmark models overall the median percentual decrease of error kf method compared to benchmark model fluctuates around 40 showing the consistency of the presented approach across river basin districts and wb categories given this a similar median percentual error decrease can be expected while applying the described methodology on poorly gauged wbs within the hamr drought prediction system in the czech republic to the best of the authors knowledge there is no previous research on the subject of streamflow simulation on poorly gauged basins using the kalman filter as a form of a merger between model simulation for an unknown basin and observations on neighbouring basins using hydrological signatures estimates as a primary descriptor of basins behaviour while the idea of streamflow simulation on a target catchment using its neighbours is not new within the regionalisation merz and bl√∂schl 2004 oudin et al 2008 or paired catchment studies andr√©assian et al 2012 the approach presented in this paper extends these methods by using neighbour s hydrological signatures to estimate the kalman filter s parameters relying on the rules derived from catchments nested nature the hydrological literature has seldom addressed the topic of neighbour catchment data assimilation for streamflow simulation as an exception randrianasolo et al 2011 focused on ensemble forecasting at poorly gauged basins where regionalisation was used to define the hydrological model s parameters and to apply a forecast updating procedure the contribution of the study presented in this paper is on the contrary in the improvement of existing streamflow simulations through the assimilation of neighbour s concurrent streamflow measurements while the strength of the proposed kf based method lies in the simplicity of its implementation and efficiency of the calculation its application is related to a number of uncertainties and subjective choices such as 1 the quality of measured data the innate problem of all physical measurements involves multiple sources of systematic and random errors the proposed methodology includes the approximation of such errors in the form of the observation error covariance matrix r these approximations are only the simplification of reality additional research into possible ways of its representation can prove to be beneficial for da efficiency 2 the choice of the hydrological model the reported performance improvement considers a specific hydrological model the choice of the model and the quality of its initial calibration play a crucial role in the assimilation s efficiency 3 hydrological signatures estimates both the benchmark model as well as the assimilation method in each wb rely on the fdc estimates which especially in wbs significantly influenced by water use may be unreliable 4 reported water use the temporal scale of the water use reports monthly does not match the required daily resolution and as a result series are uniformly transformed to the daily time step such an approach does not correspond to the reality primarily since the water use in some sectors e g agriculture is associated with variable meteorological conditions and socio economic factors 5 unreported water use and other unobserved interferences 6 error statistics of the kf method inherently the application of the method implies subjective choices on the error statistics biases and covariances the errors are dependent on the a priori knowledge of functions for the governing physical processes implying that the only way to estimate them is to assume ergodicity and make empirical statistics the exact quantification of these uncertainties is beyond the scope of this paper however several ways to reduce uncertainties can be proposed such as the introduction of additional data sources to fdc s hydrological signatures e g minimal residual flows balv√≠n et al 2021 or incorporation of the fdc correction method as a suggestion for future research it is worth looking into the performance of the kf based method compared to the predominantly used regionalisation methods in terms of precision and accuracy further research should focus on the evaluation of i the direct application of the kf method on poorly gauged wbs and ii the improvement in the drought impact assessment related to higher precision introduced by the proposed method 6 conclusions this paper presents a data assimilation methodology for streamflow estimation in poorly gauged water bodies unlike estimations carried out through regionalisation the presented methodology is designed to account for uncertainties associated with streamflow observations and selected hydrological models the process utilises attributes of water bodies with the long term flow duration curve acting as a primary descriptor of catchment behaviour although estimates of these characteristics are often available their quality should be taken into consideration for the given site or region the validation results from 165 czech water bodies show that while the accuracy of water bodies attributes requires further attention the proposed approach is capable of improving the accuracy of the available estimations by an average of 40 in combined evaluated measurements in 87 3 of validated cases the given results together with the flexibility of the proposed approach in terms of available data the simplicity of the implementation and low computational demand prove the method to be efficient for the streamflow simulation in poorly gauged water bodies credit authorship contribution statement irina georgievov√° conceptualisation methodology software validation formal analysis investigation data curation writing original draft writing review editing visualisation martin hanel conceptualisation resources writing review editing supervision project administration funding acquisition petr pavl√≠k resources data curation writing review editing adam vizina resources data curation writing review editing project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was supported by the technology agency of the czech republic and the ministry of the environment czech republic within the water systems and water management in the czech republic in conditions of climate change project no ss02030027 the authors declare no conflict of interest appendix a figures see figs a 14 a 18 appendix b bilan water balance model bilan is a lumped conceptual hydrological model developed to simulate components of the water balance in a catchment meli≈°ov√° et al 2020 the model exists in daily and monthly versions and is formed on a set of relationships that describe the basic principles of the water balance for the saturated and unsaturated zones ka≈°p√°rek and novick√Ω 1991 the model simulates the time series of potential evapotranspiration basin evaporation water reserves in the snow infiltration into the soil and recharge of the groundwater reserves in each step the total runoff for the daily step consists in direct runoff and baseflow the runoff for the monthly step is modelled as the sum of direct runoff interflow and baseflow the diagrams of relationships described for the model s monthly and daily time resolution are shown in fig b 19 m√°ca 2015 model variables and their abbreviations are then available in table b 3 where the variables p r t are the default input variables for the model and the input variables h b and p e t are optional tgm wri 2015 the model parameters can be calibrated using one of two available optimisation algorithms the local gradient algorithm binary search and the global shuffled complex evolution differential evolution algorithm the parameters calibration using the gradient method is executed in two steps which is explained by the need to mitigate the drawback of mean squared error mse or mean absolute error mae criteria in the low flow parts of the hydrograph and deterioration of mean absolute percentage error mape criterion fit in the case of the mean runoff other criteria available for the local gradient algorithm are the nash sutcliffe model efficiency coefficient nse and its logarithmic variant lnnse the global optimisation algorithm employs shuffled complex evolution sce ua described in duan et al 1993 combined with differential evolution de for complex evolution by storn and price 1997 the methodology was investigated further in publications by vrugt et al 2009 mariani et al 2011 and m√°ca et al 2013 appendix c wateres water balance model for reservoirs the wateres model is a water management model developed by the tgm wri which focuses on calculating characteristics and performing simulation for water reservoirs the model is suitable for providing a long term reservoir balance in the monthly time step although certain calculations for hourly and daily data are additionally supported the project is open source available in the form of the r package on github tgm wri 2021b and can be used to calculate 1 long term water balances of reservoirs and water management systems 2 characteristics and estimated efficiencies of water reservoirs 3 deficits in catchment areas of water reservoirs and water management systems for the purpose of drought assessments 4 transformation of flood waves the set of wateres simulated time series used in this paper were calculated using the following inputs bilan simulated runoff time series reservoir evaporation catchment characteristics provided by chmi water abstraction data as well as minimal residual flows mrf estimated using the approach of balv√≠n et al 2021 the hydrological units were linked by a river network model rnm for each selected hydrological unit a river network diagram was constructed that uses two methods to transform the runoff linear reservoir pedersen et al 1980 and muskingum gill 1978 if the hydrological unit contains a reservoir located on the main stream the transformation of the total runoff by this reservoir is solved the reservoir manipulations are solved mrf the harmless flow and the individual reservoir volumes are subtracted from the manipulation rule if the reservoir level is below the design level and inflow the reservoir releases the mrf and accumulates if the inflow is greater than the mrf if the reservoir level is above the design level the reservoir releases water until the design level is reached surface water abstraction in a given hydrologic unit means the withdrawal of water from the mainstream or the discharge of water to the mainstream the input to the balance of the total discharge from the hydrological unit is the time series of surface water abstraction on the main stream m 3 s 1 and discharge to the main stream m 3 s 1 if the hydrological unit does not contain a reservoir on the main stream the surface water abstraction is governed by the following rules which address the possible reduction of the main stream abstraction if the total discharge from the hydrological unit is not guaranteed to be at least equal to the mrf if the hydrological unit contains a reservoir on the main stream the abstraction is dealt with within the balance on this reservoir by the wateres model the calibration of the rnm was made in steps first a channel runoff transformation method was selected and a collection of various physical geographic characteristics fgcs that were thought to affect its parameters was constructed then a mathematical relationship between the fgc hydrological unit and the parameter values of the selected transformation method was proposed the water management model was verified by a detailed water management model performing similar simulations in a smaller river basin 
2025,the streamflow estimation in ungauged or poorly gauged basins is a fundamental and challenging problem in hydrology which has often been solved by transferring hydrological information from gauged basins i e by regionalisation most studies on streamflow regionalisation focus on identifying the best methods to transfer the hydrologic model parameters and uses primarily physiographic attributes or climate information for these purposes in the present study the sequential data assimilation method the kalman filter has been used to determine streamflow in a poorly gauged unknown basin to combine in an optimal way observations of neighbouring basins and model simulation of a given basin the methodology is based on the concept of concatenated upstream catchments where the aggregation of unobserved states can be estimated the streamflow estimate is further divided between the unknown sub catchments using linear regression on the catchments hydrological characteristics which are subsequently used to approximate error statistics and operators in the kalman filter application the results were evaluated on 165 catchments in the czech republic using rmse mase and mae criteria and indicate that in 87 3 of the cases the proposed methodology improved the accuracy of streamflow estimations by an average of 40 in combined evaluated measurements compared to the original simulations within the system for drought monitoring and forecasting in the czech republic hamr keywords streamflow poorly gauged basins data assimilation kalman filter data availability the authors do not have permission to share data 1 introduction despite the slow onset drought belongs among the most devastating natural disasters accounting for 34 of all fatalities and 7 of the economic losses caused worldwide by weather climate and water related extremes from 1970 to 2019 wmo 2021 drought risk management requires the improvement and application of shorter term forecasts as well as climate outlooks within which the impact on the main components of the hydrological cycle is often considered sene 2016 however data quality and availability are common limiting factors for real time assessment and model calibration according to the definition given by sivapalan et al 2003 basins where inadequate in situ records prevent the computation of hydrological variables of interest are classified as ungauged with respect to this variable as a special case in basins where adequate records of the variable of interest e g streamflow at basin outlet are lacking some information can be derived from the subbasins observations such basins are further referred to as poorly gauged the modelling tools for ungauged basins are numerous yet generally the process known as regionalisation is frequently used to transfer information about hydrological behaviour between basins he et al 2011 regionalisation approaches include methods such as physical similarity based on similar catchment attributes spatial proximity or regression which identifies the relationship between hydrological parameters and catchment characteristics guo et al 2021 at the same time hydrologic modelling is affected by various uncertainties the main sources being models inputs outputs structure and parameters renard et al 2010 data assimilation da methods developed for the optimal combination of information from model simulations and observations have proven to be suitable for assessing such modelling uncertainties and refining simulations liu et al 2012 due to convincing performances the da procedures have been used extensively in the field of hydrology in recent decades the approaches according to asch et al 2016 can be generally classified in the following way variational where the solution is sought via the minimalisation of a suitable error function i e 3d var 4d var nudging sequential the solution with minimal variance is sought for instance kalman filter and its extensions and hybrid namely 4denvar ienks and eda with newer approaches continuously becoming available several overviews of hydrological da methods are available including walker and houser 2005 reichle 2008 and liu et al 2012 a consensus is emerging in favour of sequential da methods due to their simple implementation and lower computational requirements with similar or higher performance compared to other da methods abaza et al 2014 specifically according to the review of the kalman type hydrological data assimilation studies by sun et al 2016 the kalman filter kf introduced by kalman 1960 is considered to be one of the most widely used methods moreover according to the same review streamflow is the most commonly used and in some cases the only available variable for prognostic purposes in sequential da the applications in this area are vast and numerous among them are for example the improvement of streamflow forecasting accuracy via model output or error corrections using linear wu et al 2012 chen et al 2015 and non linear anctil et al 2003 abebe and price 2004 processes in some cases the streamflow is updated directly fairbairn et al 2017 and in other approaches the streamflow is treated as a diagnostic assimilated variable whilst other state variables and parameters are corrected moradkhani et al 2005 coustau et al 2013 furthermore approaches based on in situ lee et al 2011 or remote sensing satellite data alvarez garreton et al 2015 have been investigated where the potential of other assimilated variables and states such as soil moisture and soil water stores given their role in runoff generation or interior flows on streamflow prediction has been assessed studies focusing on streamflow estimation in fully ungauged basins often deal with inadequate records by utilising synthetic satellite data in particular studies by durand et al 2016 and frasson et al 2021 work with topography data such as height width and slope for rivers wider than 50 100 m where algorithms based on data assimilation inversion and big data techniques are explored produced results are laid as a groundwork for future surface water and ocean topography swot discharge algorithm development which is intended to complement river discharge modelling at a continental scale and to help reduce current model annual runoff errors rather than to be a replacement for in situ discharge measurements furthermore the swot satellite mission provides synthetic observations of water depth and water elevation anomalies which can be utilised as well as other satellite altimetry based discharge products in poorly gauged basins as shown by emery et al 2018 and emery et al 2020 in their studies the assimilation into a large scale river routing model to correct its input parameters showed a promising perspective for water depth simulation as the da converged quite quickly towards the true value of the associated control variable at the same time the correction of the state variables for discharge simulation reduced the modelling errors for all experiments few studies propose new da methods accompanying regionalisation for streamflow simulations in ungauged or poorly gauged basins for example parada and liang 2010 implements a combination of the kernel techniques variational bayesian kalman filter and smoother while focusing on ungauged basins whose hydrological and system properties or behaviour are non linear as well as non gaussian although limited to two watersheds and leaning on computationally demanding methods the study provides promising results another example could be a study by dumedah and coulibaly 2012 where a unique approach for transferring ensemble members from gauged to ungauged watersheds is proposed which is an integration of pareto optimality into particle filter and enkf in the czech republic where drought was evaluated as the second most severe hydrometeorological extreme after floods br√°zdil et al 2015 a drought monitoring and prediction system called hamr has been created vizina et al 2018 covering more than 1000 water bodies the majority of them being poorly gauged the hydrological model for such water bodies was calibrated using estimated hydrological characteristics signatures although these characteristics were in general captured well in the simulations the simulated extremes and components of hydrological balance are accompanied with considerable uncertainties due to equifinality the present study proposes the kf based method to estimate the streamflow of unknown poorly gauged water bodies through the assimilation of streamflow observations from the neighbouring hydrological units to obtain a more accurate streamflow estimate for said unknown water bodies the hamr modelling scheme contains the reservoir manipulation plans nevertheless it is also the extraordinary manipulations which may largely affect the streamflow and the kf method is expected to be able to carry this information however the effectiveness of the kalman filter for assimilating reservoir manipulation data depends on the quality and availability of the data as well as the accuracy of the modelling scheme accurate and timely data on reservoir storage releases and other operational parameters are needed to incorporate reservoir manipulation information into the hydrological model effectively in future studies such estimates should as a result yield more accurate simulated components of the hydrological cycle within the hamr system a description of the available data and their sources is provided in section 2 section 3 1 introduces the data assimilation and kalman filter framework while section 3 2 introduces the approach for improving the accuracy of the hamr streamflow estimates on poorly gauged water bodies section 3 3 describes the process of the performed validation the validation results are further presented in section 4 and are discussed later in section 5 2 data the hydrologic system of the czech republic is formed by three main catchment areas the rivers elbe odra and morava which are divided for organisational purposes into eight river basin districts rbds see fig 1 upper and middle elbe river upper vltava river river berounka lower vltava river river oh≈ôe and lower elbe river river odra river morava and river dyje thaya the hydrological system is further divided into 1112 hydrological units water bodies langhammer et al 2010 a water body wb is classified as a stream or reservoir based on the type of outlet it represents for the purposes of this study the daily discharge time series for 406 water bodies of various lengths were used the majority of which were obtained from freely available resources czech hydrometeorological institute chmi ƒçhm√∫ 2021 while the rest were obtained from rbd authorities the spatial distribution of water bodies and data availability is shown in fig 2 the long term flow rates and other flow characteristics of the river bodies in the czech republic were provided by the chmi including the accuracy class based on the length and quality of the data used for the estimation which represents the uncertainty propagated from the observations in the current study approximations for long term 1981 2010 average discharges q a and m day continuous discharges q m d are used where q m d is another form of showing the discharge exceedance value of the flow duration curve fdc stevanoviƒá 2015 in other words m indicates the average number of days of reaching or exceeding the corresponding discharge in the year furthermore for calculation purposes the information about water use in 2000 2019 was acquired from the rbd authorities to whom users report this data as monthly sums the latest reports are available in the water usage database of the czech republic ministry of agriculture of the czech republic 2021 the water use information was aggregated for each wb and transformed to the daily step uniformly so that the aggregate of those days equals the reported monthly value finally a significant component of the drought prediction system is the description of the hydrographic network which provides information about the upstream and downstream linkages of each wb the data for the czech republic are available from the tgm wri hydroecological information system wri heis tgm wri 2021a the kf based methodology proposed in this paper section 3 2 uses the simulated streamflow time series for stream type wbs for the years 1981 to 2019 from the drought information system hamr estimations of the hydrological balance components within the system result from the coupling of the soilclim model for water balance and soil climate estimates introduced by hlavinka et al 2011 bilan water balance model appendix b and wateres reservoir water use and river network model appendix c the hamr calibration process for the unknown wbs relies on the wbs hydrological characteristics q m d and q a estimates pavl√≠k et al 2023 for the reservoir type wbs the results of the wateres model were used 3 methods 3 1 data assimilation and kalman filter data assimilation problems are principally solved using two classical approaches both approaches seek the optimal solution either through the search for minimal variance sequential approach or through the minimisation of the error function variational approach asch et al 2016 the notation for sequential da problems formalised by ide et al 1997 can be written as a set of the following equations 1 x k 1 m k 1 x k w k w k n 0 q k 2 y k h k x k v k v k n 0 r k eq 1 is an equation of the dynamic stochastic system in discrete time k where m is called a dynamics operator an operator describing the evolution of the states from time k to time k 1 eq 2 defines the relationship between the observed and modelled quantities and represents the mapping from the model space x k into the observations space y k it is done using the observation operator h which can also be time dependent the random vectors w k and v k represent the process or modelling and measurement observation errors respectively which are assumed to be independent normally distributed white noise the covariance matrices q and r represent model and observational error respectively which are assumed to be known and can in general be time dependent stemming from eqs 1 and 2 the kalman filter provides an update at each observation time k of the a priori forecast estimate x k f by the available observations y k and the corresponding model simulation h k x k f both weighted by their respective uncertainties the outcome x k a is called an a posteriori or analysis estimate and under certain assumptions such as i the errors in the measurements and the system dynamics are both gaussian and ii the model is linear is equivalent to the best linear unbiased estimator blue therefore the kf can be written in the form of the following equation 3 x k a x k f k k y k h k x k f where k is called the kalman gain an optimal gain matrix chosen to quantify the updated weight represented by the forecast error covariance matrix p k f the latter combines the uncertainties of the a priori forecast estimate and the unknown true state x k t specifically by the equation 4 p k f cov x k f x k t the kalman gain is thus estimated as follows 5 k k p k f h t h p k f h t r 1 algorithm 1 illustrates the predictor corrector loop based on the detailed description of the kalman filter method provided in asch et al 2016 to apply da methods to hydrological modelling and more specifically to establish the kf method the following assumptions are made in addition to those already mentioned i the observation operator is linear ii the error statistics biases and covariances are functions of physical processes and are assumed to be known iii the errors are unbiased and uncorrelated nevertheless in real life problems those assumptions must often be relaxed asch et al 2016 for instance the only way to estimate the error statistics is to assume ergodicity i e to assume that these statistics are stationary over a period of time and uniform over a domain bouttier and courtier 2002 dr√©court 2003 argues that while the ergodicity assumption is crucial for real life hydrological systems the stationarity assumptions are not required by the filter and the assumption of the gaussian and additive noise structures is questionable regarding the accuracy of the outcome due to the analysis equation being linear therefore correcting only the first two moments of the probability distribution of the state vector 3 2 application of kf in the upstream water body structure using the information about the configuration of water bodies i e their upstream linkages and the information on neighbouring water bodies structures with strictly given interconnections can be constructed such a structure fig 3 is closed by the gauging station determining the upstream wbs for the purposes of this study the elements of the structure are termed as follows the main water body includes the outlet typically a gauging station of the whole structure the direct water bodies are the adjacent wbs themselves direct water bodies are then labelled as known if their discharge data are available and unknown otherwise this structure allows the calculation of the streamflow estimate for the unknown water body x e s t t as follows 6 x e s t t y m a i n t i 1 k y i t u m a i n t t 1 t where y m a i n t is the observed discharge at time t and u m a i n t is the reported water usage for the main wb y i t are the observed discharge of the direct wbs and k is the number of known direct wbs for simplicity in the following notations time index t is omitted eq 6 considers only the water use of the main wb u m a i n designated in yellow in fig 3 which is calculated as an aggregation of reported water abstractions and discharges the reason is that such information is not present at the outlet points represented by the gauging stations of adjacent direct wbs but rather at the outlet of the main wb after the entirety of the water use registered on the main wb took place this means that if all direct wbs are known the difference between their streamflow aggregate and the main wb will result in the water use time series for the main wb in the absence of known wbs the component i 1 k y i equals zero and the estimated discharge for unknown wbs is calculated as x e s t y m a i n u m a i n in the case of multiple unknown wbs in the structure the estimate for the water body i is established using the auxiliary linear regression model 7 log r i Œ≤ 0 Œ≤ 1 q a i Œ≤ 2 q 364 d i Œ≤ 3 area i …õ i where r i is the median discharge calculated on the last five years of available data q a i is the estimated long term 1981 2010 discharge q 364 d i the discharge that is reached or exceeded on average for 364 days in a year for the same period area i is the area of the wb and …õ i is the error term the final variables in eq 7 were selected from a larger set of flow and wb characteristics by stepwise forward selection with akaike information criterion aic the parameters of the model were estimated by the ordinary least squares ols method using the model from eq 7 the estimates of the average discharge for the unknown wbs are made which are further divided by their sum to scale them to the range of 0 1 and notated r r a t as for discharge ratio the estimations for the unknown wbs x e s t j are then calculated using the following transformation 8 x e s t j x e s t r r a t j j 1 m where m is the number of the unknown wbs in the structure the streamflow estimates x e s t j are subsequently used to approximate the observational error covariance matrix r and the linearised observation operator h for those purposes the observed time series for known wbs in the structure are scaled to match the range of x e s t j in the following steps 9 y s c i y i m i n y i iqr y i i 1 k 10 y s c i y s c i iqr x e s t j m i n x e s t j i 1 k j 1 m where y s c i is the scaled observed discharge and iqr is the interquartile range the minimum is used instead of the mean median to avoid negative values and iqr is considered instead of the standard deviation to reduce the impact of extreme values on the variability estimate then using the simple linear regression model the relationship between discharge for known wbs and the estimated discharge for the selected unknown wbs is established 11 y s c i Œ≤ x e s t j …õ the observation operator h k 1 is subsequently represented by the regression coefficients of the model from eq 11 non diagonal elements of the matrix r k k are represented by the covariance of the model s residuals 12 r l h cov y s c i y s c i l h l h while diagonal elements are calculated as its variance with a penalisation in the form of the chmi accuracy class to represent the observation uncertainty as well as a penalisation for the imprecise division of the x e s t 13 r l h v ar y s c i y s c i e a c c 1 r r a t j l h the penalisation member 1 r r a t j is introduced to account for the uncertainty caused by the relationship between wbs and their surroundings the e a c c member is calculated as 14 e a c c 1 n t 1 n y i t a c c i 2 where y i is an observed discharge on the direct wb and a c c i is the accuracy class provided by chmi which represents an approximate value of the mean square error for the q a of the given wb provided in percentages based on the quality and length of the observational time series available for the estimation and n is the number of observations model error covariance matrix q is estimated as the average squared difference eq 15 between the simulations of the bilan or wateres model x s i m and the long term average discharge q a for the given water body due to the q a being an estimate the error is further increased following the accuracy class associated with the estimate a c c see eq 16 the mean squared error mse criterion can be written as follows 15 mse 1 n t 1 n f t y t 2 with y t being the observation at time t and f t the forecast of y t 16 q 1 n t 1 n x s i m t j q a j 2 q a j a c c j estimated matrix variables r q h as well as the state error covariance p which has an assigned value of one are assessed individually for each of the unknown wbs in the structure along with the matrices the state vector x k f represented by the bilan wateres simulations x s i m and the observation vector y k represented by the scaled observed discharge y s c both estimated for the given unknown wb are introduced into the kf algorithm see algorithm 1 the kalman filter loop is therefore repeated the number of times equal to the number of unknown wbs in the structure the kalman filter function updates the state estimate x k a and its covariance p while other fields of the system are left unchanged the above described steps have been summarised into an algorithm via diagram see fig 4 to represent individual steps intent and function 3 3 method validation for validation purposes out of 406 water bodies with available discharge observation 165 were selected based on the condition that the main wb in their structure is known and that there are wbs directly adjacent to them these 165 wbs were assumed to be unknown for validation purposes with their time series left aside for the result evaluation the results were split into categories based on their outlet type reservoir or stream in this case the reservoirs are represented by the water bodies with the controlling water sources capacity at the place of transition between water bodies and not the water reservoir itself as can be seen in fig 5 the streams were further divided into categories derived from the distribution of the long term average discharge over wbs q a quantiles being calculated on the whole set of czech republic s wbs i e 1121 hydrological units the categories are specified in table 1 and the resulting categorisation of wbs over the czech republic is shown in fig 5 the categories including their names are introduced here merely as a more apprehensible and detailed way to analogise and present the results the application of this classification reveals that between the validated wbs there are no low flow ones which is consistent with the fact that smaller wbs are less likely to be observed due to maintenance costs medium and high flow wbs represent the majority of the set at 50 9 and 39 4 respectively while reservoir wbs represent the remaining 9 7 of the set the number of wbs in each category is shown in table 1 the number of wbs based on rbd is shown in table 2 for the validation of the kf algorithm at each water body multiple criteria were calculated specifically mean absolute error mae 17 mae 1 n t 1 n f t y t mean absolute scaled error mase hyndman and koehler 2006 18 mase 1 n t 1 n y t f t 1 n 1 t 2 n y t y t 1 and the root mean square error rmse 19 rmse 1 n t 1 n f t y t 2 where the denomination is consistent with previous notations these criteria were evaluated simultaneously if two of those criteria exceeded the value of the corresponding criterion for the benchmark model hamr simulations the wb would be considered problematic 4 results the methods described in sections 3 1 and 3 2 were applied to the validation set of water bodies the description of the validation process is available in section 3 3 the spatial distribution of the validation results considering the combined criteria is shown in fig 6 whilst the criteria values for each wb within the assigned wb category are shown in fig a 14 reservoirs fig a 15 high flow stream wbs and fig a 16 medium flow stream wbs the results can be evaluated as a whole through the percentual decrease of error calculated using the formula k f b e n c h m a r k 1 100 compared to the simulation benchmark the median reduction in error corresponds to 38 7 for high flow wbs 39 3 for medium flow wbs and 47 for reservoir type wbs fig 7 those numbers are similar throughout rbds fig 8 with the slight exception of the odra river basin where benchmark model simulations tend to have higher precision with respect to the observed time series while the oh≈ôe and lower elbe river basin effectively provide precise kf simulations but the low number of validated wbs precisely ten should be taken into account the overall median percentual error reduction corresponds to 39 4 no considerable difference in the median percentual error reduction between categories and rbds can be seen in figs 7 and 8 the time series of the best performing wbs are shown in figs 9 and 10 out of 165 validated water bodies 15 wbs 9 1 could be considered problematic 5 wbs or 3 correspond to the benchmark model and the model results in na value for 1 wb cases where the kf results match the bilan or wateres simulations or even ensue into the na value are seen as desirable behaviour of the algorithm it is explained by the fact that such cases result directly from the distinct spatial position where other known wbs in the structure are incomparable to the considered wb to the extent that the linear model from eq 11 does not find the relation resulting in the observation operator h represented by missing values or zeros the reasons behind the problematic wbs could be categorised on the basis of their inferred origin for instance wbs ohl 1110 and ohl 1140 see fig a 17 situated in the rbd of the oh≈ôe river and lower elbe river are both parts of the same structure where the wb with the identifier ohl 1150 represents the main wb of the structure ohl 1150 is the point where the major watercourse flows into the neighbouring state of germany which corresponds to the upstream catchment for the elbe river basin this wb has the highest average discharge 300 m 3 s 1 in the czech republic more than 100 times the discharge of the adjacent ohl 1140 and 37 times the discharge of the ohl 1110 the significant differences in discharges would typically lead to the low value of the kalman gain estimate resulting in a higher weight for the benchmark model in the particular cases of those wbs the differences are so steep that it results into the imprecise division of the estimate for the unknown wb x e s t which combined with low values of the kalman gain reduces the bilan simulations that steep difference in the average discharges between water bodies in the structure appears to be an exception although preserving original simulations might be preferable if such a case occurs in the case of wbs dvl 0810 lower vltava river district and ber 0770 berounka river district unexpected behaviour in the x e s t estimate occurs where the mean value of the estimate is more than 8 times higher than the estimated long term average q a for these wbs the severe difference implies insufficient information to establish more accurate estimates most probably caused by unreported water use see fig a 18 such behaviour might be addressed via the adjustment of the x e s t estimate albeit the definitive method has not yet been concluded the most frequent reason behind the problematic wbs lies in chmi s long term flow characteristic overestimations compared to their observation determined values these characteristics play a significant role in establishing matrices r q as well as discharge ratio r r a t see section 3 2 as a result the majority of problematic wbs are represented by a time series with correlated but overestimated development the overestimation of the q a in high flow wbs varies from 2 13 to 9 1 times the average of the observed discharge leading to significant error that is the case of ohl 0030 oh≈ôe and lower elbe mov 0820 morava ber 2070 berounka and hsl 2040 upper and middle elbe wbs see fig 11 in the case of reservoir wb hsl 1845 j upper and middle elbe the q a is overestimated by 3 38 whilst for medium flow wbs mov 1320 morava hod 0590 odra dyj 0140 dyj 0050 thaya and ber 0480 berounka the overestimation varies from 1 3 to 7 4 times see fig 12 the observed time series for hod 0820 hod 0590 odra fig 13 and ber 2070 berounka fig 11 wbs have specific behaviour due to the direct proximity of reservoir wbs to them specifically these wbs act as the main wbs for structures that include a reservoir the direction of the calculation hierarchy proceeds from the main wb and will not acknowledge such patterns marking such cases as special these results are nevertheless valuable since they provide better insight into method performance as shown in fig 13 the method is capable of assessing the corresponding temporal evolution of discharge in contrast to the benchmark model when more accurate flow characteristics estimates are obtained by the proposed methodology 5 discussion the assessment of the methodology proposed in this study suggests considerable improvement over benchmark models overall the median percentual decrease of error kf method compared to benchmark model fluctuates around 40 showing the consistency of the presented approach across river basin districts and wb categories given this a similar median percentual error decrease can be expected while applying the described methodology on poorly gauged wbs within the hamr drought prediction system in the czech republic to the best of the authors knowledge there is no previous research on the subject of streamflow simulation on poorly gauged basins using the kalman filter as a form of a merger between model simulation for an unknown basin and observations on neighbouring basins using hydrological signatures estimates as a primary descriptor of basins behaviour while the idea of streamflow simulation on a target catchment using its neighbours is not new within the regionalisation merz and bl√∂schl 2004 oudin et al 2008 or paired catchment studies andr√©assian et al 2012 the approach presented in this paper extends these methods by using neighbour s hydrological signatures to estimate the kalman filter s parameters relying on the rules derived from catchments nested nature the hydrological literature has seldom addressed the topic of neighbour catchment data assimilation for streamflow simulation as an exception randrianasolo et al 2011 focused on ensemble forecasting at poorly gauged basins where regionalisation was used to define the hydrological model s parameters and to apply a forecast updating procedure the contribution of the study presented in this paper is on the contrary in the improvement of existing streamflow simulations through the assimilation of neighbour s concurrent streamflow measurements while the strength of the proposed kf based method lies in the simplicity of its implementation and efficiency of the calculation its application is related to a number of uncertainties and subjective choices such as 1 the quality of measured data the innate problem of all physical measurements involves multiple sources of systematic and random errors the proposed methodology includes the approximation of such errors in the form of the observation error covariance matrix r these approximations are only the simplification of reality additional research into possible ways of its representation can prove to be beneficial for da efficiency 2 the choice of the hydrological model the reported performance improvement considers a specific hydrological model the choice of the model and the quality of its initial calibration play a crucial role in the assimilation s efficiency 3 hydrological signatures estimates both the benchmark model as well as the assimilation method in each wb rely on the fdc estimates which especially in wbs significantly influenced by water use may be unreliable 4 reported water use the temporal scale of the water use reports monthly does not match the required daily resolution and as a result series are uniformly transformed to the daily time step such an approach does not correspond to the reality primarily since the water use in some sectors e g agriculture is associated with variable meteorological conditions and socio economic factors 5 unreported water use and other unobserved interferences 6 error statistics of the kf method inherently the application of the method implies subjective choices on the error statistics biases and covariances the errors are dependent on the a priori knowledge of functions for the governing physical processes implying that the only way to estimate them is to assume ergodicity and make empirical statistics the exact quantification of these uncertainties is beyond the scope of this paper however several ways to reduce uncertainties can be proposed such as the introduction of additional data sources to fdc s hydrological signatures e g minimal residual flows balv√≠n et al 2021 or incorporation of the fdc correction method as a suggestion for future research it is worth looking into the performance of the kf based method compared to the predominantly used regionalisation methods in terms of precision and accuracy further research should focus on the evaluation of i the direct application of the kf method on poorly gauged wbs and ii the improvement in the drought impact assessment related to higher precision introduced by the proposed method 6 conclusions this paper presents a data assimilation methodology for streamflow estimation in poorly gauged water bodies unlike estimations carried out through regionalisation the presented methodology is designed to account for uncertainties associated with streamflow observations and selected hydrological models the process utilises attributes of water bodies with the long term flow duration curve acting as a primary descriptor of catchment behaviour although estimates of these characteristics are often available their quality should be taken into consideration for the given site or region the validation results from 165 czech water bodies show that while the accuracy of water bodies attributes requires further attention the proposed approach is capable of improving the accuracy of the available estimations by an average of 40 in combined evaluated measurements in 87 3 of validated cases the given results together with the flexibility of the proposed approach in terms of available data the simplicity of the implementation and low computational demand prove the method to be efficient for the streamflow simulation in poorly gauged water bodies credit authorship contribution statement irina georgievov√° conceptualisation methodology software validation formal analysis investigation data curation writing original draft writing review editing visualisation martin hanel conceptualisation resources writing review editing supervision project administration funding acquisition petr pavl√≠k resources data curation writing review editing adam vizina resources data curation writing review editing project administration funding acquisition declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this research was supported by the technology agency of the czech republic and the ministry of the environment czech republic within the water systems and water management in the czech republic in conditions of climate change project no ss02030027 the authors declare no conflict of interest appendix a figures see figs a 14 a 18 appendix b bilan water balance model bilan is a lumped conceptual hydrological model developed to simulate components of the water balance in a catchment meli≈°ov√° et al 2020 the model exists in daily and monthly versions and is formed on a set of relationships that describe the basic principles of the water balance for the saturated and unsaturated zones ka≈°p√°rek and novick√Ω 1991 the model simulates the time series of potential evapotranspiration basin evaporation water reserves in the snow infiltration into the soil and recharge of the groundwater reserves in each step the total runoff for the daily step consists in direct runoff and baseflow the runoff for the monthly step is modelled as the sum of direct runoff interflow and baseflow the diagrams of relationships described for the model s monthly and daily time resolution are shown in fig b 19 m√°ca 2015 model variables and their abbreviations are then available in table b 3 where the variables p r t are the default input variables for the model and the input variables h b and p e t are optional tgm wri 2015 the model parameters can be calibrated using one of two available optimisation algorithms the local gradient algorithm binary search and the global shuffled complex evolution differential evolution algorithm the parameters calibration using the gradient method is executed in two steps which is explained by the need to mitigate the drawback of mean squared error mse or mean absolute error mae criteria in the low flow parts of the hydrograph and deterioration of mean absolute percentage error mape criterion fit in the case of the mean runoff other criteria available for the local gradient algorithm are the nash sutcliffe model efficiency coefficient nse and its logarithmic variant lnnse the global optimisation algorithm employs shuffled complex evolution sce ua described in duan et al 1993 combined with differential evolution de for complex evolution by storn and price 1997 the methodology was investigated further in publications by vrugt et al 2009 mariani et al 2011 and m√°ca et al 2013 appendix c wateres water balance model for reservoirs the wateres model is a water management model developed by the tgm wri which focuses on calculating characteristics and performing simulation for water reservoirs the model is suitable for providing a long term reservoir balance in the monthly time step although certain calculations for hourly and daily data are additionally supported the project is open source available in the form of the r package on github tgm wri 2021b and can be used to calculate 1 long term water balances of reservoirs and water management systems 2 characteristics and estimated efficiencies of water reservoirs 3 deficits in catchment areas of water reservoirs and water management systems for the purpose of drought assessments 4 transformation of flood waves the set of wateres simulated time series used in this paper were calculated using the following inputs bilan simulated runoff time series reservoir evaporation catchment characteristics provided by chmi water abstraction data as well as minimal residual flows mrf estimated using the approach of balv√≠n et al 2021 the hydrological units were linked by a river network model rnm for each selected hydrological unit a river network diagram was constructed that uses two methods to transform the runoff linear reservoir pedersen et al 1980 and muskingum gill 1978 if the hydrological unit contains a reservoir located on the main stream the transformation of the total runoff by this reservoir is solved the reservoir manipulations are solved mrf the harmless flow and the individual reservoir volumes are subtracted from the manipulation rule if the reservoir level is below the design level and inflow the reservoir releases the mrf and accumulates if the inflow is greater than the mrf if the reservoir level is above the design level the reservoir releases water until the design level is reached surface water abstraction in a given hydrologic unit means the withdrawal of water from the mainstream or the discharge of water to the mainstream the input to the balance of the total discharge from the hydrological unit is the time series of surface water abstraction on the main stream m 3 s 1 and discharge to the main stream m 3 s 1 if the hydrological unit does not contain a reservoir on the main stream the surface water abstraction is governed by the following rules which address the possible reduction of the main stream abstraction if the total discharge from the hydrological unit is not guaranteed to be at least equal to the mrf if the hydrological unit contains a reservoir on the main stream the abstraction is dealt with within the balance on this reservoir by the wateres model the calibration of the rnm was made in steps first a channel runoff transformation method was selected and a collection of various physical geographic characteristics fgcs that were thought to affect its parameters was constructed then a mathematical relationship between the fgc hydrological unit and the parameter values of the selected transformation method was proposed the water management model was verified by a detailed water management model performing similar simulations in a smaller river basin 
2026,watershed classification is considered necessary for various purposes including improving the transferability of streamflow information and allowing the generalization of hydrologic theories in this paper we proposed a classification method using shape based time series clustering techniques to define hydrologically homogeneous classes for a set of 638 gauged watersheds in the conterminous united states we defined 15 distinct flow regime classes based on standardized weekly step mean annual hydrographs of the watersheds analyzed most classes showed regionality though to various degrees classes in the atlantic coast region showed strong geographical contiguity indicating that spatial proximity may be an appropriate indicator of flow regime similarity but on the other hand nearby watersheds may exhibit different intra annual variabilities and watersheds far apart from one another may exhibit a similar flow regime such cases show that spatial proximity may not be used as a universal indicator of flow regime similarity to expand the flow regime classification to ungauged watersheds where no streamflow data are available we proposed a physical characteristic classification method using the random forests algorithm based on a set of physical climatic attributes based on the boruta feature selection algorithm attributes related to snowiness precipitation seasonality and green vegetation coverage stood out as the most relevant controls on regime class memberships by analyzing the within class variability of the watershed attributes we found that watersheds of the same flow regime class may be very different in terms of individual attribute values indicating that flow regime dis similarity may not be equated to dis similarity in individual watershed attributes instead it is the interplay among attributes that determines the streamflow behavior overall methods proposed for the classification of gauged and ungauged watersheds are believed to be of value in a range of applications including selecting gauged donor watersheds for estimating historical streamflow records at ungauged watersheds keywords shape based time series clustering random forests boruta conterminous united states camels ungauged watersheds data availability i have shared the link to some data and r scripts in the data availability section editable data and scripts are available upon request 1 introduction classification is considered a necessary preliminary in most sciences grigg 1965 in hydrology watershed classification is needed for a variety of reasons including improving the transferability of hydrologic information from gauged to ungauged watersheds and allowing the generalization of hydrologic theories sawicz et al 2011 toth 2013 wagener et al 2007 in this study we propose a novel classification method that groups together watersheds that exhibit similar streamflow regimes described by standardized weekly step annual hydrographs using shape based time series clustering techniques over the past few decades numerous approaches have been developed and applied for watershed classification while some postulate that nearby watersheds are hydrologically similar and therefore should be grouped together e g nerc 1975 others apply cluster analysis based on similarity in a suite of physical properties such as topography soil and land cover use e g acreman and sinclair 1986 auerbach et al 2016 begou et al 2015 meanwhile some find that watershed classification could benefit from incorporating remote sensing based statistics such as normalized difference moisture index and soil adjusted vegetation index e g choubin et al 2017 choubin et al 2019 in general classification methods based on geographical locations or physical climatic attributes have the advantage of being directly applicable to ungauged watersheds but on the other hand spatial proximity or physical similarity may have an elusive correlation with the similarity in streamflow characteristics brunner et al 2020 merz and bl√∂schl 2009 sawicz et al 2011 moreover there is no consensus on a single set of watershed attributes that controls hydrologic behavior and additionally the reason that certain attributes are used for grouping watersheds is sometimes left out except for data availability ali et al 2012 alternatively some prefer to classify gauged watersheds based on hydrologic signatures which are indices derived from streamflow data for characterizing the natural streamflow regime or the watershed function regarding how landscapes filter rainfall to runoff e g kennard et al 2010 olden and poff 2003 sawicz et al 2014 however inconsistent development use and evaluation of hydrologic signatures have resulted in little agreement on the set of signatures that comprehensively captures all aspects of the streamflow regime mcmillan et al 2017 mcmillan 2020 additionally many hydrologic signatures were developed to characterize statistical properties e g mean and quantiles hence cannot retain all the information embedded in the streamflow data to preserve more information other studies have applied time series analysis e g chiang et al 2002a chiang et al 2002b corduas 2011 wavelet analysis e g agarwal et al 2016 ciria and chiogna 2020 zoppou et al 2002 and functional data analysis e g brunner et al 2020 ternynck et al 2016 to describe streamflow data using fitted time series model parameters wavelet coefficients or smoothed curve function coefficients respectively based on the fitted model parameters or coefficients gauged watersheds are grouped together different from those studies we here use shape based time series clustering techniques to identify hydrologically homogeneous classes of gauged watersheds based on their streamflow regimes in the format of time series data each streamflow regime is described by a mean annual hydrograph at a weekly time step that is a time series composed of 52 streamflow values each of which is the average of seven consecutive mean daily streamflow values and a mean daily streamflow value is calculated by averaging multiple streamflow values observed on the same day across multiple water years oct 1st sep 30th shape based time series clustering to our knowledge has not been explored for flow regime classification before although it has been used for example for grouping weather stations based on daily precipitation data in north cyprus zaifoglu et al 2018 and for identifying monitoring sites of similar groundwater level data in switzerland rinderer et al 2017 rinderer et al 2019 shape based time series clustering of the streamflow regimes hereinafter referred to as the flow regime classification avoids representing the mean annual hydrograph by a few statistics and the fitting of a mathematical function to the data instead it makes use of as much of the information embedded in the flow series as possible flow regime classification however cannot be directly applied to ungauged watersheds therefore another main objective of this study is to investigate whether physical climatic attributes can be mapped into flow regime classes studies that had a similar goal have investigated the capability of a few supervised classification methods including linear discriminant analysis e g sanborn and bledsoe 2006 toth 2013 k nearest neighbors e g papageorgaki and nalbantis 2016 classification and regression tree e g reidy liermann et al 2012 and random forests e g brunner et al 2020 praskievicz and luo 2019 in the present study the process of inferring flow regime class memberships for ungauged watersheds is hereinafter referred to as the physical characteristic classification this classification uses breiman 2001 s random forests rf mainly because of rf s capabilities to efficiently handle a large number of attributes to allow nonlinear interactions among attributes and to circumvent overfitting liaw and wiener 2002 given that it is unknown beforehand which watershed attributes control the regime class membership several physical and climatological attributes are compiled to describe the watersheds analyzed to avoid introducing redundant attributes to the rf model a mutual information mi analysis yan et al 2022 was also applied in addition the boruta feature selection algorithm was applied to assess the importance of each watershed attribute in classifying ungauged watersheds kursa et al 2010 kursa and rudnicki 2010 in general the present study aims to explore the applicability of the proposed classification methods in streamlining gauged and ungauged watersheds into hydrologically homogeneous classes to this end a database of streamflow regimes and various watershed attributes of 638 watersheds distributed across the conterminous united states conus was compiled and analyzed the study is guided by the following questions is there regionality in the streamflow regime to what degree can we infer streamflow regimes based on spatial proximity to what degree can we infer streamflow regime based on physical climatic watershed attributes and if it can which are the most relevant attributes 2 methodology fig 1 shows a flowchart of the major steps and data involved in the proposed flow regime and physical characteristic classifications described below 2 1 flow regime classification of gauged watersheds flow regime classification was applied to group together similar gauged watersheds based on the shape temporal variability of their weekly step mean annual hydrographs note that at this temporal resolution sub monthly and sub seasonal variabilities are preserved however variabilities at finer scales e g hourly daily and at interannual scales are not considered brunner et al 2020 a weekly resolution was chosen to reduce the effect of extreme short duration events and to focus on a more general regime behavior of watersheds flow regime classification used a clustering method developed to discover inherent groupings of time series data without prior knowledge of their relationships to form non overlapping classes a hard partitional clustering procedure was applied the four key aspects involved in this classification were 1 data pre processing 2 determination of the distance measure 3 determination of the prototyping function and 4 determination of the number of classes into which the watersheds were partitioned the terms distance measure and prototyping function are explained below data pre processing aimed at removing differences in flow magnitudes to place focus on the shape of the hydrographs to this end streamflow values were converted to z scores using the following equation 1 z ij q ij q i œÉ i where z ij is the z score for week j j 1 2 52 at gauge i q ij is the flow value of week j at gauge i and q i and œÉ i are the mean and standard deviation of the flow series at gauge i respectively afterwards a crucial aspect to consider is the distance measure that quantifies the dis similarities between two compared entities traditionally the euclidean distance measure is applied because it is fast and straightforward to implement however according to ratanamahatana and keogh 2005 the dynamic time warping dtw sakoe and chiba 1978 distance measure is superior to euclidean for clustering time series data in a variety of domains this superiority is because the euclidean distance measure aligns the i th point in one sequence with the i th point in another sequence while dtw focuses instead of on the discrepancies in the time axis on similarities in the overall temporal variability which is particularly useful when the compared series are not synchronized in time dtw tries all possible temporal alignments between two sequences to find the alignment that corresponds to the minimum distance some alignments however may be inappropriate meaningless for clustering if a small section of one sequence is mapped on to a somewhat large section of another sequence which is referred to as the problem of pathological alignment warping ratanamahatana and keogh 2005 to avoid it a warping constraint method called the sakoe chiba band sakoe and chiba 1978 which is widely applied by the data mining community ratanamahatana and keogh 2005 zhang et al 2015 can be used to define the maximum admissible shift in time depending on the user defined size of the warping window between 0 no warping allowed and 100 no constraint of the length of a sequence can be mapped on to another sequence dtw with no warping allowed is equivalent to the euclidean distance measure meanwhile dtw without any warping constraint means that two sequences can be compared with no regard to time a warping window size of 10 of the sequence length is commonly used by the speech processing community to which the dtw distance measure was first introduced ratanamahatana and keogh 2005 however ratanamahatana and keogh 2005 conclude that an ideal warping window size should not be generalized from other studies and recommend narrower constraints for more accurate classification results in this study we tested a few warping constraints on the flow data analyzed and made a somewhat arbitrary decision in addition to the warping constraint because dtw is computationally expensive lower bounding lb techniques that consist of discarding matches without computing the full dtw measure ratanamahatana and keogh 2005 have been developed among existing lb techniques lb keogh keogh and ratanamahatana 2005 and lb improved lemire 2009 are considered the most effective sard√° espinosa 2017 in the present study we applied lb keogh with dtw because through trial and error it yielded more homogeneous classes in terms of the within class variability quantified by the average dtw distance of flow series to their closest centroid series a centroid series is a summary sequence that captures the most salient characteristics of all series in a class to generate a centroid series for each class which is an essential procedure in partitional clustering a prototyping function is needed sard√° espinosa 2017 when choosing among existing prototyping functions it is critical to consider their compatibility with the selected distance measure sard√° espinosa 2017 for example the arithmetic mean prototyping function is frequently used to generate centroid series when the euclidean distance measure is used it is however incompatible with dtw because the arithmetic mean function simply takes the average of each time step across all series in a class with no regard to the dtw alignment sard√° espinosa 2017 that said we applied a prototyping function tailored to working with dtw called the dtw barycenter averaging dba to generate centroid series petitjean et al 2011 a major challenge associated with partitional clustering is that the number of classes needs to be defined by the user previously different numbers of hydrologic classes have been defined for the conus for instance poff 1996 groups 420 unregulated gauges into ten classes coopersmith et al 2012 group the 428 watersheds in the model parameter estimation project mopex dataset duan et al 2006 into 24 classes mccabe and wolock 2014 group 516 gauges into 14 classes berghuijs et al 2014 partition 372 mopex watersheds into ten classes sawicz et al 2014 group 314 mopex watersheds into twelve classes fouad et al 2018 group 918 watersheds contained in the geospatial attributes of gages for evaluating streamflow version ii gages ii dataset into 14 classes brunner et al 2020 group 671 watersheds contained in the catchment attributes and meteorology for large sample studies camels dataset addor et al 2017 newman et al 2015 into five classes ghotbi et al 2020 group 300 mopex watersheds into seven classes these studies show that there is no consensus on a single number of classes into which the watersheds in the conus should be classified and the decision is typically made with respect to what is the most appropriate for the data at hand in the present study we put to test a series numbers of classes and plotted the inertia sum of squared distance of flow series to their closest centroid series on the y axis and the number of classes on the x axis to find the elbow point i e the point after which the inertia starts to decrease in a linear fashion and this point theoretically corresponds to the best number of classes he et al 2011 it is worth mentioning that in some cases the optimal number of classes may be determined with the help of cluster validation indices cvis which are developed to measure the compactness and separation of the resulting classes based on the input data alone arbelaitz et al 2013 such as the silhouette index used in brunner et al 2020 however cvis were not considered here because many of them assume that the cross distance matrix a square two dimensional table containing the values of pairwise distances between flow series is symmetric the matrix equals to its transpose which cannot be fulfilled when lb keogh dtw is used 2 2 physical characteristic classification of ungauged watersheds this classification aimed at expanding the flow regime classification to ungauged watersheds to this end we applied breiman 2001 s rf algorithm to build a mapping between regime class memberships and watershed attributes using gauged watersheds to avoid introducing redundant information to this classification we first applied an mi analysis yan et al 2022 to measure the correlation between watershed attributes the greater the mi correlation value the more information that one attribute contains about the other and vice versa suggesting that one of them may be redundant given that an rf model makes use of numerous decision trees we here briefly describe how a decision tree is built using a sample training dataset which consists of 118 gauged watersheds based on the flow regime classification 62 watersheds in the training dataset are classified as nivo pluvial characterized predominantly by snowmelt mixed with rainfall and the other 56 watersheds are classified as pluvial characterized by rainfall meanwhile each gauged watershed is described by four watershed attributes frac snow fraction of annual precipitation falling as snow frac forest fraction of drainage area covered by forests p mean mean precipitation and pet mean mean potential evapotranspiration as shown in fig 2 the decision tree grows from a root node that classifies the entire training dataset as nivo pluvial which means that 56 watersheds are in the wrong class hence 56 118 to resolve this issue a splitting rule or an inequality expression i e frac snow 0 015 is devised and based on which 40 watersheds take the right branch i e no and form a pluvial node where no watersheds are misclassified hence 0 40 this node is referred to as a leaf node which does not further split into finer sub nodes meanwhile 78 watersheds take the right branch i e yes and form a nivo pluvial node where 16 watersheds are misclassified hence 16 78 this node is referred to as a decision node that unlike a leaf node is further split into finer sub nodes based on frac forest 0 072 and so forth after reaching a series of leaf nodes a decision tree model is built and can be used to predict whether an ungauged watershed is nivo pluvial or pluvial by running its attribute values down the splitting rules it is worth pointing out that depending on the chosen splitting criterion a node that contains misclassified entities may also be considered a leaf node here we used gini index as the splitting criterion breiman 1996 the number of attributes to be considered for splitting a decision node i e mtry is a user defined parameter here mtry was set equal to the square root of the total number of input watershed attributes which is a typical default option probst et al 2019 note that pet mean is not used in this sample decision tree indicating that it is of little use in distinguishing between the two classes as shown in fig 3 through randomly sampling gauged watersheds from the training dataset multiple sub datasets can be used to build numerous independent decision trees the number of decision trees to grow in the forest i e ntree is another user defined parameter based on the recommendation of reiday et al 2012 ntree was set equal to 1 000 after growing the decision trees we say that an rf model is established based on the attribute values of an ungauged watershed each decision tree provides a classification or votes for a class and the class with the most votes is where the ungauged watershed most likely belongs breiman et al 1984 therefore an advantage of rf is leveraging the wisdom of crowds and consequently to circumvent overfitting liaw and wiener 2002 to evaluate the performance of the rf algorithm in classifying ungauged watersheds we applied the k fold cross validation procedure which includes the following key steps i shuffling the dataset of gauged watersheds and splitting it into k folds sub datasets ii in the first iteration using one fold as the test data and the remaining k 1 folds as the training data iii establishing an rf model following the workflow in fig 3 and obtaining its classification accuracy using the test data iv iterating steps ii and iii k times using a different fold each time as the test data and the remaining k 1 folds as the training data v estimating an overall model performance by averaging the k classification accuracies common values set for k are five ten and 20 depending on how much or little training data is considered sufficient anguita et al 2012 in addition we applied the boruta feature selection algorithm developed in kursa et al 2010 to analyze the usefulness of each attribute in inferring class memberships boruta estimates a unitless importance score for each input attribute by comparing its usefulness to that of a randomized version of the original attribute based on the average change in classification accuracy across all decision trees a randomized shadow attribute set is one in which for each entity the attribute value is drawn from another randomly selected entity a higher importance score indicates a relatively more useful attribute or a more crucial control on class memberships 3 application 3 1 study area and data the study area consists of the conus where 638 gauged watersheds ranging in drainage area from 4 to 25 524 km2 with a median size of 329 km2 were identified the watersheds were selected from the camels dataset addor et al 2017 newman et al 2015 based on the criteria documented below fig 4 shows the spatial extent of the study area overlain the geographic regions defined in noaa ncei 2022 for all the gauges daily streamflow data were retrieved from the usgs nwis 2022 for the period oct 1st 1989 sep 30th 2009 this study period was chosen mainly to coincide with the climate data available in the camels dataset afterwards mean annual flow series were calculated by averaging the 20 daily flow values for each day excluding feb 29th these averaged flow values were then averaged over seven day periods to generate mean annual hydrographs for each gauge at a weekly resolution that is a streamflow time series with 52 values note that sep 30th was excluded from generating the weekly hydrographs to describe the physical climatic characteristics of the watersheds 30 attributes were chosen from the camels dataset and are listed in table 1 the camels dataset consists of 671 gauged watersheds selected from the geospatial attributes of gages for evaluating streamflow version ii gages ii dataset falcone 2011 based on several criteria newman et al 2015 including long term streamflow data availability and minimally impacted by human activities including dam and reservoir operations we only considered near natural watersheds because the impact of anthropogenic activities on hydrologic variability is sometimes unknown primarily due to the lack of data describing the local water management and regulation schemes which is also discussed in kuentz et al 2017 the camels watersheds spread across the conus and show a wide range of hydro climatic conditions newman et al 2015 which are described by a set of 47 attributes including gauge name usgs identification number location topography climate land cover soil and geology addor et al 2017 for the intended analysis a watershed had to satisfy the following criteria 1 its outlet gauged location should not be located closely to other stream gauges of the same flcomid attribute which is a unique identification number assigned to each flowline feature in the national hydrography dataset plus version 2 mckay et al 2012 and if it was the watershed with the smallest contributing drainage area was kept and the one s nested closely downstream was eliminated 2 it should have complete flow data reported for the period of interest and 3 it should have complete measurements for all watershed attributes listed in table 1 after applying these criteria 638 gauged watersheds were left for analysis 3 2 flow regime classification of gauged watersheds for the lb keogh dtw distance measure since there is no optimal warping window size that can be generalized from other studies this parameter was determined through experimenting with warping window sizes of one two three and four time steps weeks temporal shifts greater than four weeks were considered inadmissible to avoid misalignment of peaks to illustrate how the warping constraint determines the alignment of two sequences we used the standardized mean annual hydrographs of the usgs gauges 01 031 500 and 01 516 500 that have been confirmed by the authors to be similar in shape intra annual variability but are slightly out of synchronization in time in the preliminary analysis fig 5 shows the alignment of the compared hydrographs by warping window size a one week b two weeks c three weeks and d four weeks the solid line represents the hydrograph of gauging station 01 031 500 and the dashed line 01516500 we determined that lb keogh dtw with a two week warping window size was the most suitable for our dataset because a one week warping window was not too different from calculating the euclidean distance while larger warping window sizes caused pathological warping as discussed previously there is no consensus on a single number of hydrologically homogeneous classes in the conus we therefore put to test four to up to 20 classes and plotted the inertia against the number of classes see fig 6 the minimum number of classes put to test was four because it is well acknowledged that a natural flow regime in the conus can be broadly classified as nival snowmelt nivo pluvial snowmelt dominant mixed with rainfall pluvio nival rainfall dominant mixed with snowmelt or pluvial rainfall meanwhile the maximum number of classes put to test was 20 because when partitioning the 638 flow series into 21 classes the smallest class consisted of only one member based on fig 6 we found that the elbow point corresponded to 15 classes therefore we partitioned the 638 watersheds into 15 flow regime classes due to the involvement of randomness in the clustering process including the initialization of the dba prototyping function we assessed sensitivity of the result to the randomness by repeating the same clustering procedure 500 times and then computing the number of times that a watershed deviated from its main class membership i e the class into which the flow series is partitioned most of the times the result showed that all watersheds were consistently partitioned into the same classes showing that the clustering result was not influenced by randomness and was stable table 2 tabulates the number of watersheds in each of the 15 classes fig 7 shows the standardized hydrographs and the centroid series of the 15 classes the thick line corresponds to the centroid series the thin line to the standardized hydrograph of a watershed and the dashed line to zero z score i e mean flow fig 8 shows the box and whisker plots of the lb keogh dtw distance between the flow series of a class and the class centroid series the thick lines in the boxes correspond to the median the upper and lower box boundaries to the 75th and 25th percentiles respectively the upper lower whisker to the upper lower boundary plus minus 1 5 times of the interquartile range iqr and the solid points are outliers a shorter box indicates a smaller within class variability and a taller box a greater variability it is apparent that within class variabilities exist which is expected because the goal of classification is to limit the difference within a class or to maximize the difference between classes while each class will still contain a large internal complexity especially when it comes to classifying natural entities mcdonnell and woods 2004 wagener et al 2007 fig 9 shows the spatial distribution of the 15 flow regime classes 3 3 physical characteristic classification of ungauged watersheds prior to establishing an rf classification model we applied an mi analysis to avoid introducing redundant information fig 10 shows the pairwise correlation between the 30 attributes listed in table 1 it was apparent to us that lai max lai diff and gvf max were highly correlated and soil conductivity was highly correlated with sand frac which were also found in addor et al 2018 besides it was observed that high prec freq was highly correlated with low prec freq therefore lai max lai diff sand frac and low prec freq were deemed redundant and removed from the following analysis afterwards we applied the ten fold cross validation by which the 638 gauged watersheds were divided into ten equal sub datasets and each sub dataset in turn was used as the test data to evaluate the rf model established using the remaining nine sub datasets this procedure thus established ten rf models each of which were fitted to 26 watershed attributes input variables and 15 flow regime classes target variable meanwhile ten classification accuracies were obtained and the overall accuracy was 77 10 fig 11 shows the spatial distribution of correctly and falsely classified watersheds falsely classified watersheds are indicated by red circles afterwards we applied the boruta feature selection algorithm kursa and rudnicki 2010 to estimate the usefulness of the 26 watershed attributes in the rf model according to boruta all attributes contributed to distinguishing between classes though some were more useful than others the reported importance scores ranged from 3 67 water frac to 37 00 frac snow with a median score of 19 05 and a mean score of 18 83 see fig 12 fig 13 shows the box and whisker plots of the six most useful watershed attributes i e frac snow p seasonality gvf diff low prec dur elev mean and pet mean due to page limit as well as the fact that they received much higher importance scores than other attributes that is close to or more than one standard deviation 7 02 greater than the mean 4 results and discussion flow regime classification grouped the 638 gauged watersheds distributed across the conus into 15 somewhat homogeneous classes based exclusively on their standardized mean annual hydrographs at a weekly resolution based on the boruta algorithm fig 12 flow regime class memberships are strongly controlled by climate e g frac snow p seasonality low prec dur and p mean vegetation e g gvf diff and topology e g elev mean and slope mean among them snow and precipitation seasonality are the most important controls which shows that the timing of streamflow is controlled by the timing of water input storages and release mcdonnell 2004 moreover climate related attributes in general are found to be more pertinent to large time scale flow characteristics while physical characteristics are more relevant to rainfall event based flow characteristics brunner et al 2020 on the other hand this finding is different from that of other studies e g brunner et al 2020 jenh et al 2020 where the aridity index is regarded as the most significant control on hydrologic class memberships table 3 provides a brief description of each class with respect to its streamflow pattern fig 7 spatial distribution fig 9 and significant physical climatic controls fig 13 it is apparent to us that even though flow data were the only input all classes displayed regionality though to various degrees among them class 2 which was the largest class with 161 members presented a strong geographic contiguity indicating that spatial proximity may be a satisfactory indicator of similarity in flow regime variability in the mid and southern atlantic coast region this finding is consistent with that of previous studies e g sawicz et al 2014 and the rationale is that the climate and landscape conditions vary smoothly in this area which lead to a smooth varying flow behavior in space on the other hand flow regime classification allowed us to discover that different classes of regime behaviors may coincide in the same area for example classes 1 5 and 11 in general exhibit a snowmelt pattern however due to the difference in elevation and fraction of snow timings of their peaks differ this finding shows that the natural flow regime as does streamflow characteristics in general can vary over short distances parajka et al 2013 either because of abrupt changes in climate and or landscape burn et al 1997 or accumulated minor differences across several attributes e g classes 2 and 6 moreover watersheds that exhibit a similar flow regime pattern may be far apart from one another for example watersheds in class 4 displayed a similar flow variability however they were clustered in two regions that are distant from each other and are under the impact of very different climate and topography this finding confirms the theory that it is the interplay between climate and landscape that determines the flow regime variability e g burn et al 1997 jehn et al 2020 physical characteristic classification as mentioned above achieved an overall 77 accuracy in inferring flow regime class memberships for pseudo ungauged watersheds gauged watersheds used as test data and assumed to have no streamflow records this result indicates that if an ungauged watershed is classified to say class 5 by the rf model fitted to the 26 watershed attributes we can reasonably assume that it has a snowmelt dominant flow pattern however it is worth discussing the instances of misclassification and the potential causes firstly we found that some misclassification incidents were exchanges between classes for example several watersheds in class 1 were falsely assigned to class 11 and vice versa and many watersheds in class 2 were falsely assigned to class 6 and vice versa as shown in fig 9 and table 3 both examples involve classes that coincide in the same region and for this type of misclassification we theorize that it may be improved by incorporating high spatial resolution attributes the authors intend to investigate both theories at a later date secondly as shown in fig 13 the ranges of attribute values across classes may not be discernible which may have imposed difficulties on the rf algorithm to establish splitting rules that explicitly distinguish among classes we theorize that this problem may be mitigated by excluding watersheds that are outliers i e watersheds that are significantly different from the others in the study area the proposed classification scheme can be applied to solve a variety of problems some of which are discussed in the following paragraphs the first potential use which is currently investigated by the authors is to identify appropriate gauged donor watersheds for ungauged target watersheds in the conus and subsequently transfer streamflow regimes using statistical methods such as the drainage area ratio to estimate historical streamflow regimes at the target watersheds the outlook is that the proposed classification scheme may yield a more satisfactory estimation result than that by using the nearest neighbor donor selection method particularly in places where stream gauge networks are sparse moreover we will pursue classifying and transferring daily step streamflow regimes in which case the clustering algorithm will be used to group mean annual hydrographs of 365 values instead of 52 as a result the processing time will inevitably increase in addition algorithms configured in the present study for clustering weekly step mean annual hydrographs may need to be adjusted such as the warping window constraint and the number of classes furthermore another potential use of the proposed classification scheme is to perform a global classification of streamflow regimes which has been a long standing research topic e g haines et al 1988 sauquet et al 2021 however a major challenge would be data availability of streamflow watershed boundaries and watershed attributes the outlook is that similar to our findings in the conus spatial proximity may be a satisfactory indicator of streamflow similarity in regions that are densely gauged whereas for places that have a sparse stream gauge network and or heterogeneous climate landscape conditions spatial proximity may have an elusive relationship with hydrologic similarity it is also worth discussing the limitations of the proposed classification scheme as mentioned before we used the camels dataset to focus on the near natural watersheds therefore the method may not be applicable to watersheds under significant impact of anthropogenic activities however if there is data quantifying such an impact on flow variability across the study area the classification scheme could be extended to those watersheds in addition as much as we attempted to limit the number of decisions that are not based on quantitative results in the study a few parameters such as the warping window constraint had to be determined based on qualitative assessment therefore the classification result might change if using a different set of parameter values 5 summary and conclusion in this study we classified 638 gauged watersheds distributed across the conus into 15 distinctive classes using shape based time series clustering techniques based on standardized weekly step annual hydrographs in general all classes showed regionality though to various degrees classes located in the atlantic coast region exhibited particularly strong geographic contiguity indicating that spatial proximity may be a satisfactory indicator of similarity in flow regime variability in that region on the other hand watersheds that were distant from one another may exhibit a similar flow pattern while nearby watersheds may have different flow patterns these cases revealed the issue of equating spatial proximity to similarity in streamflow especially in regions where climate and or landscape conditions change abruptly since the flow regime classification cannot be directly applied to ungauged watersheds we therefore applied the rf algorithm to establish a mapping between watershed physical climatic attributes and the 15 flow regime classes based on the ten fold cross validation the rf model fitted to the 26 watershed attributes and 15 classes achieved an overall 77 10 accuracy in inferring the class memberships of pseudo ungauged watersheds particularly significant controls on the membership were fraction of precipitation falling as snow precipitation seasonality and changes in green vegetation coverage based on this model we could reasonably infer the streamflow regime behavior of an ungauged watershed e g nival pluvial nivo pluvial or pluvio nival however watersheds of the same class may exhibit different individual physical climatic characteristics indicating the importance of considering the interplay among various watershed attributes when classifying ungauged watersheds potential applications of the proposed classification scheme include selecting suitable gauged donor watersheds for transferring streamflow data to ungauged target watersheds and classifying streamflow regimes at a global scale data availability statement some data and r scripts supporting the findings of this study are available to view at https osf io d69yh view only 111595d443b74eed89e3700485785441 more data and code are available from the corresponding author upon request credit authorship contribution statement mingyue yang conceptualization methodology validation software formal analysis writing original draft writing review editing visualization francisco olivera writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
2026,watershed classification is considered necessary for various purposes including improving the transferability of streamflow information and allowing the generalization of hydrologic theories in this paper we proposed a classification method using shape based time series clustering techniques to define hydrologically homogeneous classes for a set of 638 gauged watersheds in the conterminous united states we defined 15 distinct flow regime classes based on standardized weekly step mean annual hydrographs of the watersheds analyzed most classes showed regionality though to various degrees classes in the atlantic coast region showed strong geographical contiguity indicating that spatial proximity may be an appropriate indicator of flow regime similarity but on the other hand nearby watersheds may exhibit different intra annual variabilities and watersheds far apart from one another may exhibit a similar flow regime such cases show that spatial proximity may not be used as a universal indicator of flow regime similarity to expand the flow regime classification to ungauged watersheds where no streamflow data are available we proposed a physical characteristic classification method using the random forests algorithm based on a set of physical climatic attributes based on the boruta feature selection algorithm attributes related to snowiness precipitation seasonality and green vegetation coverage stood out as the most relevant controls on regime class memberships by analyzing the within class variability of the watershed attributes we found that watersheds of the same flow regime class may be very different in terms of individual attribute values indicating that flow regime dis similarity may not be equated to dis similarity in individual watershed attributes instead it is the interplay among attributes that determines the streamflow behavior overall methods proposed for the classification of gauged and ungauged watersheds are believed to be of value in a range of applications including selecting gauged donor watersheds for estimating historical streamflow records at ungauged watersheds keywords shape based time series clustering random forests boruta conterminous united states camels ungauged watersheds data availability i have shared the link to some data and r scripts in the data availability section editable data and scripts are available upon request 1 introduction classification is considered a necessary preliminary in most sciences grigg 1965 in hydrology watershed classification is needed for a variety of reasons including improving the transferability of hydrologic information from gauged to ungauged watersheds and allowing the generalization of hydrologic theories sawicz et al 2011 toth 2013 wagener et al 2007 in this study we propose a novel classification method that groups together watersheds that exhibit similar streamflow regimes described by standardized weekly step annual hydrographs using shape based time series clustering techniques over the past few decades numerous approaches have been developed and applied for watershed classification while some postulate that nearby watersheds are hydrologically similar and therefore should be grouped together e g nerc 1975 others apply cluster analysis based on similarity in a suite of physical properties such as topography soil and land cover use e g acreman and sinclair 1986 auerbach et al 2016 begou et al 2015 meanwhile some find that watershed classification could benefit from incorporating remote sensing based statistics such as normalized difference moisture index and soil adjusted vegetation index e g choubin et al 2017 choubin et al 2019 in general classification methods based on geographical locations or physical climatic attributes have the advantage of being directly applicable to ungauged watersheds but on the other hand spatial proximity or physical similarity may have an elusive correlation with the similarity in streamflow characteristics brunner et al 2020 merz and bl√∂schl 2009 sawicz et al 2011 moreover there is no consensus on a single set of watershed attributes that controls hydrologic behavior and additionally the reason that certain attributes are used for grouping watersheds is sometimes left out except for data availability ali et al 2012 alternatively some prefer to classify gauged watersheds based on hydrologic signatures which are indices derived from streamflow data for characterizing the natural streamflow regime or the watershed function regarding how landscapes filter rainfall to runoff e g kennard et al 2010 olden and poff 2003 sawicz et al 2014 however inconsistent development use and evaluation of hydrologic signatures have resulted in little agreement on the set of signatures that comprehensively captures all aspects of the streamflow regime mcmillan et al 2017 mcmillan 2020 additionally many hydrologic signatures were developed to characterize statistical properties e g mean and quantiles hence cannot retain all the information embedded in the streamflow data to preserve more information other studies have applied time series analysis e g chiang et al 2002a chiang et al 2002b corduas 2011 wavelet analysis e g agarwal et al 2016 ciria and chiogna 2020 zoppou et al 2002 and functional data analysis e g brunner et al 2020 ternynck et al 2016 to describe streamflow data using fitted time series model parameters wavelet coefficients or smoothed curve function coefficients respectively based on the fitted model parameters or coefficients gauged watersheds are grouped together different from those studies we here use shape based time series clustering techniques to identify hydrologically homogeneous classes of gauged watersheds based on their streamflow regimes in the format of time series data each streamflow regime is described by a mean annual hydrograph at a weekly time step that is a time series composed of 52 streamflow values each of which is the average of seven consecutive mean daily streamflow values and a mean daily streamflow value is calculated by averaging multiple streamflow values observed on the same day across multiple water years oct 1st sep 30th shape based time series clustering to our knowledge has not been explored for flow regime classification before although it has been used for example for grouping weather stations based on daily precipitation data in north cyprus zaifoglu et al 2018 and for identifying monitoring sites of similar groundwater level data in switzerland rinderer et al 2017 rinderer et al 2019 shape based time series clustering of the streamflow regimes hereinafter referred to as the flow regime classification avoids representing the mean annual hydrograph by a few statistics and the fitting of a mathematical function to the data instead it makes use of as much of the information embedded in the flow series as possible flow regime classification however cannot be directly applied to ungauged watersheds therefore another main objective of this study is to investigate whether physical climatic attributes can be mapped into flow regime classes studies that had a similar goal have investigated the capability of a few supervised classification methods including linear discriminant analysis e g sanborn and bledsoe 2006 toth 2013 k nearest neighbors e g papageorgaki and nalbantis 2016 classification and regression tree e g reidy liermann et al 2012 and random forests e g brunner et al 2020 praskievicz and luo 2019 in the present study the process of inferring flow regime class memberships for ungauged watersheds is hereinafter referred to as the physical characteristic classification this classification uses breiman 2001 s random forests rf mainly because of rf s capabilities to efficiently handle a large number of attributes to allow nonlinear interactions among attributes and to circumvent overfitting liaw and wiener 2002 given that it is unknown beforehand which watershed attributes control the regime class membership several physical and climatological attributes are compiled to describe the watersheds analyzed to avoid introducing redundant attributes to the rf model a mutual information mi analysis yan et al 2022 was also applied in addition the boruta feature selection algorithm was applied to assess the importance of each watershed attribute in classifying ungauged watersheds kursa et al 2010 kursa and rudnicki 2010 in general the present study aims to explore the applicability of the proposed classification methods in streamlining gauged and ungauged watersheds into hydrologically homogeneous classes to this end a database of streamflow regimes and various watershed attributes of 638 watersheds distributed across the conterminous united states conus was compiled and analyzed the study is guided by the following questions is there regionality in the streamflow regime to what degree can we infer streamflow regimes based on spatial proximity to what degree can we infer streamflow regime based on physical climatic watershed attributes and if it can which are the most relevant attributes 2 methodology fig 1 shows a flowchart of the major steps and data involved in the proposed flow regime and physical characteristic classifications described below 2 1 flow regime classification of gauged watersheds flow regime classification was applied to group together similar gauged watersheds based on the shape temporal variability of their weekly step mean annual hydrographs note that at this temporal resolution sub monthly and sub seasonal variabilities are preserved however variabilities at finer scales e g hourly daily and at interannual scales are not considered brunner et al 2020 a weekly resolution was chosen to reduce the effect of extreme short duration events and to focus on a more general regime behavior of watersheds flow regime classification used a clustering method developed to discover inherent groupings of time series data without prior knowledge of their relationships to form non overlapping classes a hard partitional clustering procedure was applied the four key aspects involved in this classification were 1 data pre processing 2 determination of the distance measure 3 determination of the prototyping function and 4 determination of the number of classes into which the watersheds were partitioned the terms distance measure and prototyping function are explained below data pre processing aimed at removing differences in flow magnitudes to place focus on the shape of the hydrographs to this end streamflow values were converted to z scores using the following equation 1 z ij q ij q i œÉ i where z ij is the z score for week j j 1 2 52 at gauge i q ij is the flow value of week j at gauge i and q i and œÉ i are the mean and standard deviation of the flow series at gauge i respectively afterwards a crucial aspect to consider is the distance measure that quantifies the dis similarities between two compared entities traditionally the euclidean distance measure is applied because it is fast and straightforward to implement however according to ratanamahatana and keogh 2005 the dynamic time warping dtw sakoe and chiba 1978 distance measure is superior to euclidean for clustering time series data in a variety of domains this superiority is because the euclidean distance measure aligns the i th point in one sequence with the i th point in another sequence while dtw focuses instead of on the discrepancies in the time axis on similarities in the overall temporal variability which is particularly useful when the compared series are not synchronized in time dtw tries all possible temporal alignments between two sequences to find the alignment that corresponds to the minimum distance some alignments however may be inappropriate meaningless for clustering if a small section of one sequence is mapped on to a somewhat large section of another sequence which is referred to as the problem of pathological alignment warping ratanamahatana and keogh 2005 to avoid it a warping constraint method called the sakoe chiba band sakoe and chiba 1978 which is widely applied by the data mining community ratanamahatana and keogh 2005 zhang et al 2015 can be used to define the maximum admissible shift in time depending on the user defined size of the warping window between 0 no warping allowed and 100 no constraint of the length of a sequence can be mapped on to another sequence dtw with no warping allowed is equivalent to the euclidean distance measure meanwhile dtw without any warping constraint means that two sequences can be compared with no regard to time a warping window size of 10 of the sequence length is commonly used by the speech processing community to which the dtw distance measure was first introduced ratanamahatana and keogh 2005 however ratanamahatana and keogh 2005 conclude that an ideal warping window size should not be generalized from other studies and recommend narrower constraints for more accurate classification results in this study we tested a few warping constraints on the flow data analyzed and made a somewhat arbitrary decision in addition to the warping constraint because dtw is computationally expensive lower bounding lb techniques that consist of discarding matches without computing the full dtw measure ratanamahatana and keogh 2005 have been developed among existing lb techniques lb keogh keogh and ratanamahatana 2005 and lb improved lemire 2009 are considered the most effective sard√° espinosa 2017 in the present study we applied lb keogh with dtw because through trial and error it yielded more homogeneous classes in terms of the within class variability quantified by the average dtw distance of flow series to their closest centroid series a centroid series is a summary sequence that captures the most salient characteristics of all series in a class to generate a centroid series for each class which is an essential procedure in partitional clustering a prototyping function is needed sard√° espinosa 2017 when choosing among existing prototyping functions it is critical to consider their compatibility with the selected distance measure sard√° espinosa 2017 for example the arithmetic mean prototyping function is frequently used to generate centroid series when the euclidean distance measure is used it is however incompatible with dtw because the arithmetic mean function simply takes the average of each time step across all series in a class with no regard to the dtw alignment sard√° espinosa 2017 that said we applied a prototyping function tailored to working with dtw called the dtw barycenter averaging dba to generate centroid series petitjean et al 2011 a major challenge associated with partitional clustering is that the number of classes needs to be defined by the user previously different numbers of hydrologic classes have been defined for the conus for instance poff 1996 groups 420 unregulated gauges into ten classes coopersmith et al 2012 group the 428 watersheds in the model parameter estimation project mopex dataset duan et al 2006 into 24 classes mccabe and wolock 2014 group 516 gauges into 14 classes berghuijs et al 2014 partition 372 mopex watersheds into ten classes sawicz et al 2014 group 314 mopex watersheds into twelve classes fouad et al 2018 group 918 watersheds contained in the geospatial attributes of gages for evaluating streamflow version ii gages ii dataset into 14 classes brunner et al 2020 group 671 watersheds contained in the catchment attributes and meteorology for large sample studies camels dataset addor et al 2017 newman et al 2015 into five classes ghotbi et al 2020 group 300 mopex watersheds into seven classes these studies show that there is no consensus on a single number of classes into which the watersheds in the conus should be classified and the decision is typically made with respect to what is the most appropriate for the data at hand in the present study we put to test a series numbers of classes and plotted the inertia sum of squared distance of flow series to their closest centroid series on the y axis and the number of classes on the x axis to find the elbow point i e the point after which the inertia starts to decrease in a linear fashion and this point theoretically corresponds to the best number of classes he et al 2011 it is worth mentioning that in some cases the optimal number of classes may be determined with the help of cluster validation indices cvis which are developed to measure the compactness and separation of the resulting classes based on the input data alone arbelaitz et al 2013 such as the silhouette index used in brunner et al 2020 however cvis were not considered here because many of them assume that the cross distance matrix a square two dimensional table containing the values of pairwise distances between flow series is symmetric the matrix equals to its transpose which cannot be fulfilled when lb keogh dtw is used 2 2 physical characteristic classification of ungauged watersheds this classification aimed at expanding the flow regime classification to ungauged watersheds to this end we applied breiman 2001 s rf algorithm to build a mapping between regime class memberships and watershed attributes using gauged watersheds to avoid introducing redundant information to this classification we first applied an mi analysis yan et al 2022 to measure the correlation between watershed attributes the greater the mi correlation value the more information that one attribute contains about the other and vice versa suggesting that one of them may be redundant given that an rf model makes use of numerous decision trees we here briefly describe how a decision tree is built using a sample training dataset which consists of 118 gauged watersheds based on the flow regime classification 62 watersheds in the training dataset are classified as nivo pluvial characterized predominantly by snowmelt mixed with rainfall and the other 56 watersheds are classified as pluvial characterized by rainfall meanwhile each gauged watershed is described by four watershed attributes frac snow fraction of annual precipitation falling as snow frac forest fraction of drainage area covered by forests p mean mean precipitation and pet mean mean potential evapotranspiration as shown in fig 2 the decision tree grows from a root node that classifies the entire training dataset as nivo pluvial which means that 56 watersheds are in the wrong class hence 56 118 to resolve this issue a splitting rule or an inequality expression i e frac snow 0 015 is devised and based on which 40 watersheds take the right branch i e no and form a pluvial node where no watersheds are misclassified hence 0 40 this node is referred to as a leaf node which does not further split into finer sub nodes meanwhile 78 watersheds take the right branch i e yes and form a nivo pluvial node where 16 watersheds are misclassified hence 16 78 this node is referred to as a decision node that unlike a leaf node is further split into finer sub nodes based on frac forest 0 072 and so forth after reaching a series of leaf nodes a decision tree model is built and can be used to predict whether an ungauged watershed is nivo pluvial or pluvial by running its attribute values down the splitting rules it is worth pointing out that depending on the chosen splitting criterion a node that contains misclassified entities may also be considered a leaf node here we used gini index as the splitting criterion breiman 1996 the number of attributes to be considered for splitting a decision node i e mtry is a user defined parameter here mtry was set equal to the square root of the total number of input watershed attributes which is a typical default option probst et al 2019 note that pet mean is not used in this sample decision tree indicating that it is of little use in distinguishing between the two classes as shown in fig 3 through randomly sampling gauged watersheds from the training dataset multiple sub datasets can be used to build numerous independent decision trees the number of decision trees to grow in the forest i e ntree is another user defined parameter based on the recommendation of reiday et al 2012 ntree was set equal to 1 000 after growing the decision trees we say that an rf model is established based on the attribute values of an ungauged watershed each decision tree provides a classification or votes for a class and the class with the most votes is where the ungauged watershed most likely belongs breiman et al 1984 therefore an advantage of rf is leveraging the wisdom of crowds and consequently to circumvent overfitting liaw and wiener 2002 to evaluate the performance of the rf algorithm in classifying ungauged watersheds we applied the k fold cross validation procedure which includes the following key steps i shuffling the dataset of gauged watersheds and splitting it into k folds sub datasets ii in the first iteration using one fold as the test data and the remaining k 1 folds as the training data iii establishing an rf model following the workflow in fig 3 and obtaining its classification accuracy using the test data iv iterating steps ii and iii k times using a different fold each time as the test data and the remaining k 1 folds as the training data v estimating an overall model performance by averaging the k classification accuracies common values set for k are five ten and 20 depending on how much or little training data is considered sufficient anguita et al 2012 in addition we applied the boruta feature selection algorithm developed in kursa et al 2010 to analyze the usefulness of each attribute in inferring class memberships boruta estimates a unitless importance score for each input attribute by comparing its usefulness to that of a randomized version of the original attribute based on the average change in classification accuracy across all decision trees a randomized shadow attribute set is one in which for each entity the attribute value is drawn from another randomly selected entity a higher importance score indicates a relatively more useful attribute or a more crucial control on class memberships 3 application 3 1 study area and data the study area consists of the conus where 638 gauged watersheds ranging in drainage area from 4 to 25 524 km2 with a median size of 329 km2 were identified the watersheds were selected from the camels dataset addor et al 2017 newman et al 2015 based on the criteria documented below fig 4 shows the spatial extent of the study area overlain the geographic regions defined in noaa ncei 2022 for all the gauges daily streamflow data were retrieved from the usgs nwis 2022 for the period oct 1st 1989 sep 30th 2009 this study period was chosen mainly to coincide with the climate data available in the camels dataset afterwards mean annual flow series were calculated by averaging the 20 daily flow values for each day excluding feb 29th these averaged flow values were then averaged over seven day periods to generate mean annual hydrographs for each gauge at a weekly resolution that is a streamflow time series with 52 values note that sep 30th was excluded from generating the weekly hydrographs to describe the physical climatic characteristics of the watersheds 30 attributes were chosen from the camels dataset and are listed in table 1 the camels dataset consists of 671 gauged watersheds selected from the geospatial attributes of gages for evaluating streamflow version ii gages ii dataset falcone 2011 based on several criteria newman et al 2015 including long term streamflow data availability and minimally impacted by human activities including dam and reservoir operations we only considered near natural watersheds because the impact of anthropogenic activities on hydrologic variability is sometimes unknown primarily due to the lack of data describing the local water management and regulation schemes which is also discussed in kuentz et al 2017 the camels watersheds spread across the conus and show a wide range of hydro climatic conditions newman et al 2015 which are described by a set of 47 attributes including gauge name usgs identification number location topography climate land cover soil and geology addor et al 2017 for the intended analysis a watershed had to satisfy the following criteria 1 its outlet gauged location should not be located closely to other stream gauges of the same flcomid attribute which is a unique identification number assigned to each flowline feature in the national hydrography dataset plus version 2 mckay et al 2012 and if it was the watershed with the smallest contributing drainage area was kept and the one s nested closely downstream was eliminated 2 it should have complete flow data reported for the period of interest and 3 it should have complete measurements for all watershed attributes listed in table 1 after applying these criteria 638 gauged watersheds were left for analysis 3 2 flow regime classification of gauged watersheds for the lb keogh dtw distance measure since there is no optimal warping window size that can be generalized from other studies this parameter was determined through experimenting with warping window sizes of one two three and four time steps weeks temporal shifts greater than four weeks were considered inadmissible to avoid misalignment of peaks to illustrate how the warping constraint determines the alignment of two sequences we used the standardized mean annual hydrographs of the usgs gauges 01 031 500 and 01 516 500 that have been confirmed by the authors to be similar in shape intra annual variability but are slightly out of synchronization in time in the preliminary analysis fig 5 shows the alignment of the compared hydrographs by warping window size a one week b two weeks c three weeks and d four weeks the solid line represents the hydrograph of gauging station 01 031 500 and the dashed line 01516500 we determined that lb keogh dtw with a two week warping window size was the most suitable for our dataset because a one week warping window was not too different from calculating the euclidean distance while larger warping window sizes caused pathological warping as discussed previously there is no consensus on a single number of hydrologically homogeneous classes in the conus we therefore put to test four to up to 20 classes and plotted the inertia against the number of classes see fig 6 the minimum number of classes put to test was four because it is well acknowledged that a natural flow regime in the conus can be broadly classified as nival snowmelt nivo pluvial snowmelt dominant mixed with rainfall pluvio nival rainfall dominant mixed with snowmelt or pluvial rainfall meanwhile the maximum number of classes put to test was 20 because when partitioning the 638 flow series into 21 classes the smallest class consisted of only one member based on fig 6 we found that the elbow point corresponded to 15 classes therefore we partitioned the 638 watersheds into 15 flow regime classes due to the involvement of randomness in the clustering process including the initialization of the dba prototyping function we assessed sensitivity of the result to the randomness by repeating the same clustering procedure 500 times and then computing the number of times that a watershed deviated from its main class membership i e the class into which the flow series is partitioned most of the times the result showed that all watersheds were consistently partitioned into the same classes showing that the clustering result was not influenced by randomness and was stable table 2 tabulates the number of watersheds in each of the 15 classes fig 7 shows the standardized hydrographs and the centroid series of the 15 classes the thick line corresponds to the centroid series the thin line to the standardized hydrograph of a watershed and the dashed line to zero z score i e mean flow fig 8 shows the box and whisker plots of the lb keogh dtw distance between the flow series of a class and the class centroid series the thick lines in the boxes correspond to the median the upper and lower box boundaries to the 75th and 25th percentiles respectively the upper lower whisker to the upper lower boundary plus minus 1 5 times of the interquartile range iqr and the solid points are outliers a shorter box indicates a smaller within class variability and a taller box a greater variability it is apparent that within class variabilities exist which is expected because the goal of classification is to limit the difference within a class or to maximize the difference between classes while each class will still contain a large internal complexity especially when it comes to classifying natural entities mcdonnell and woods 2004 wagener et al 2007 fig 9 shows the spatial distribution of the 15 flow regime classes 3 3 physical characteristic classification of ungauged watersheds prior to establishing an rf classification model we applied an mi analysis to avoid introducing redundant information fig 10 shows the pairwise correlation between the 30 attributes listed in table 1 it was apparent to us that lai max lai diff and gvf max were highly correlated and soil conductivity was highly correlated with sand frac which were also found in addor et al 2018 besides it was observed that high prec freq was highly correlated with low prec freq therefore lai max lai diff sand frac and low prec freq were deemed redundant and removed from the following analysis afterwards we applied the ten fold cross validation by which the 638 gauged watersheds were divided into ten equal sub datasets and each sub dataset in turn was used as the test data to evaluate the rf model established using the remaining nine sub datasets this procedure thus established ten rf models each of which were fitted to 26 watershed attributes input variables and 15 flow regime classes target variable meanwhile ten classification accuracies were obtained and the overall accuracy was 77 10 fig 11 shows the spatial distribution of correctly and falsely classified watersheds falsely classified watersheds are indicated by red circles afterwards we applied the boruta feature selection algorithm kursa and rudnicki 2010 to estimate the usefulness of the 26 watershed attributes in the rf model according to boruta all attributes contributed to distinguishing between classes though some were more useful than others the reported importance scores ranged from 3 67 water frac to 37 00 frac snow with a median score of 19 05 and a mean score of 18 83 see fig 12 fig 13 shows the box and whisker plots of the six most useful watershed attributes i e frac snow p seasonality gvf diff low prec dur elev mean and pet mean due to page limit as well as the fact that they received much higher importance scores than other attributes that is close to or more than one standard deviation 7 02 greater than the mean 4 results and discussion flow regime classification grouped the 638 gauged watersheds distributed across the conus into 15 somewhat homogeneous classes based exclusively on their standardized mean annual hydrographs at a weekly resolution based on the boruta algorithm fig 12 flow regime class memberships are strongly controlled by climate e g frac snow p seasonality low prec dur and p mean vegetation e g gvf diff and topology e g elev mean and slope mean among them snow and precipitation seasonality are the most important controls which shows that the timing of streamflow is controlled by the timing of water input storages and release mcdonnell 2004 moreover climate related attributes in general are found to be more pertinent to large time scale flow characteristics while physical characteristics are more relevant to rainfall event based flow characteristics brunner et al 2020 on the other hand this finding is different from that of other studies e g brunner et al 2020 jenh et al 2020 where the aridity index is regarded as the most significant control on hydrologic class memberships table 3 provides a brief description of each class with respect to its streamflow pattern fig 7 spatial distribution fig 9 and significant physical climatic controls fig 13 it is apparent to us that even though flow data were the only input all classes displayed regionality though to various degrees among them class 2 which was the largest class with 161 members presented a strong geographic contiguity indicating that spatial proximity may be a satisfactory indicator of similarity in flow regime variability in the mid and southern atlantic coast region this finding is consistent with that of previous studies e g sawicz et al 2014 and the rationale is that the climate and landscape conditions vary smoothly in this area which lead to a smooth varying flow behavior in space on the other hand flow regime classification allowed us to discover that different classes of regime behaviors may coincide in the same area for example classes 1 5 and 11 in general exhibit a snowmelt pattern however due to the difference in elevation and fraction of snow timings of their peaks differ this finding shows that the natural flow regime as does streamflow characteristics in general can vary over short distances parajka et al 2013 either because of abrupt changes in climate and or landscape burn et al 1997 or accumulated minor differences across several attributes e g classes 2 and 6 moreover watersheds that exhibit a similar flow regime pattern may be far apart from one another for example watersheds in class 4 displayed a similar flow variability however they were clustered in two regions that are distant from each other and are under the impact of very different climate and topography this finding confirms the theory that it is the interplay between climate and landscape that determines the flow regime variability e g burn et al 1997 jehn et al 2020 physical characteristic classification as mentioned above achieved an overall 77 accuracy in inferring flow regime class memberships for pseudo ungauged watersheds gauged watersheds used as test data and assumed to have no streamflow records this result indicates that if an ungauged watershed is classified to say class 5 by the rf model fitted to the 26 watershed attributes we can reasonably assume that it has a snowmelt dominant flow pattern however it is worth discussing the instances of misclassification and the potential causes firstly we found that some misclassification incidents were exchanges between classes for example several watersheds in class 1 were falsely assigned to class 11 and vice versa and many watersheds in class 2 were falsely assigned to class 6 and vice versa as shown in fig 9 and table 3 both examples involve classes that coincide in the same region and for this type of misclassification we theorize that it may be improved by incorporating high spatial resolution attributes the authors intend to investigate both theories at a later date secondly as shown in fig 13 the ranges of attribute values across classes may not be discernible which may have imposed difficulties on the rf algorithm to establish splitting rules that explicitly distinguish among classes we theorize that this problem may be mitigated by excluding watersheds that are outliers i e watersheds that are significantly different from the others in the study area the proposed classification scheme can be applied to solve a variety of problems some of which are discussed in the following paragraphs the first potential use which is currently investigated by the authors is to identify appropriate gauged donor watersheds for ungauged target watersheds in the conus and subsequently transfer streamflow regimes using statistical methods such as the drainage area ratio to estimate historical streamflow regimes at the target watersheds the outlook is that the proposed classification scheme may yield a more satisfactory estimation result than that by using the nearest neighbor donor selection method particularly in places where stream gauge networks are sparse moreover we will pursue classifying and transferring daily step streamflow regimes in which case the clustering algorithm will be used to group mean annual hydrographs of 365 values instead of 52 as a result the processing time will inevitably increase in addition algorithms configured in the present study for clustering weekly step mean annual hydrographs may need to be adjusted such as the warping window constraint and the number of classes furthermore another potential use of the proposed classification scheme is to perform a global classification of streamflow regimes which has been a long standing research topic e g haines et al 1988 sauquet et al 2021 however a major challenge would be data availability of streamflow watershed boundaries and watershed attributes the outlook is that similar to our findings in the conus spatial proximity may be a satisfactory indicator of streamflow similarity in regions that are densely gauged whereas for places that have a sparse stream gauge network and or heterogeneous climate landscape conditions spatial proximity may have an elusive relationship with hydrologic similarity it is also worth discussing the limitations of the proposed classification scheme as mentioned before we used the camels dataset to focus on the near natural watersheds therefore the method may not be applicable to watersheds under significant impact of anthropogenic activities however if there is data quantifying such an impact on flow variability across the study area the classification scheme could be extended to those watersheds in addition as much as we attempted to limit the number of decisions that are not based on quantitative results in the study a few parameters such as the warping window constraint had to be determined based on qualitative assessment therefore the classification result might change if using a different set of parameter values 5 summary and conclusion in this study we classified 638 gauged watersheds distributed across the conus into 15 distinctive classes using shape based time series clustering techniques based on standardized weekly step annual hydrographs in general all classes showed regionality though to various degrees classes located in the atlantic coast region exhibited particularly strong geographic contiguity indicating that spatial proximity may be a satisfactory indicator of similarity in flow regime variability in that region on the other hand watersheds that were distant from one another may exhibit a similar flow pattern while nearby watersheds may have different flow patterns these cases revealed the issue of equating spatial proximity to similarity in streamflow especially in regions where climate and or landscape conditions change abruptly since the flow regime classification cannot be directly applied to ungauged watersheds we therefore applied the rf algorithm to establish a mapping between watershed physical climatic attributes and the 15 flow regime classes based on the ten fold cross validation the rf model fitted to the 26 watershed attributes and 15 classes achieved an overall 77 10 accuracy in inferring the class memberships of pseudo ungauged watersheds particularly significant controls on the membership were fraction of precipitation falling as snow precipitation seasonality and changes in green vegetation coverage based on this model we could reasonably infer the streamflow regime behavior of an ungauged watershed e g nival pluvial nivo pluvial or pluvio nival however watersheds of the same class may exhibit different individual physical climatic characteristics indicating the importance of considering the interplay among various watershed attributes when classifying ungauged watersheds potential applications of the proposed classification scheme include selecting suitable gauged donor watersheds for transferring streamflow data to ungauged target watersheds and classifying streamflow regimes at a global scale data availability statement some data and r scripts supporting the findings of this study are available to view at https osf io d69yh view only 111595d443b74eed89e3700485785441 more data and code are available from the corresponding author upon request credit authorship contribution statement mingyue yang conceptualization methodology validation software formal analysis writing original draft writing review editing visualization francisco olivera writing review editing declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper 
2027,discharges of warm water from shallow stormwater management ponds during summer months into receiving headwater streams pose a risk to aquatic ecosystems in urban watersheds especially in cool and cold water streams physically based models such as minuhet have been used to assess the effects of thermal loading on receiving streams however these models require a significant amount of data and are complex to calibrate and use for the optimized designs that ensure protection of vulnerable aquatic life in urban stream ecosystems this research introduces a user friendly and more accurate machine learning method to predict thermal profiles in stormwater ponds and the pond outlet discharge temperature to the receiving streams during storm events monitoring data were collected between 2014 and 2016 from three stormwater ponds in southern ontario to train and test the new model the new model is used to demonstrate the degree to which cooling effects can be achieved from remedial actions such as increasing the pond depth by dredging one meter and if a bottom draw outlet is used instead of a mid depth draw outlet the methods presented in this study can be used to support an improved stormwater management pond design guidelines based on the key design objective that the thermal regime of the stormwater pond outlet discharge water must match the thermal regime of the receiving stream the main objective is to avoid any discernable warming of the stream due to the stormwater pond discharge under a range of summer temperatures and storm event sizes keywords stormwater management temperature profile urbanization wet weather pond data availability data will be made available on request 1 introduction urbanization can have detrimental effects on stream hydrology and ecology due to the risks associated with release of thermally enriched water to receiving streams from outfalls and stormwater detention ponds urbanization tends to reduce infiltration and baseflow and ultimately increases the temperature of urban streams cockerill et al 2017 ham et al 2006 hester bauman 2013 sabouri et al 2013 binns et al 2019 mackenzie et al 2022a b increases of receiving water body temperatures have significant potential to impact the biological physical and chemical processes occurring in water systems maintaining an appropriate and stable temperature regime in streams rivers is essential for ensuring that aquatic ecosystems are healthy especially for cold water streams vulnerable to prolonged warming and rapid temperature changes cvc and mnr 2002 mnrf 2016 sattar et al 2017 credit valley conservation 2022 stormwater retention ponds are a structural best management practice bmp used to control stormwater quality and quantity by mitigating uncontrolled runoff however their ability to absorb solar radiation during summer months may cause intense and persistent thermal stratification exceeding 9 c between the pond surface and bottom song et al 2013 van seters et al 2019a this thermally enriched water may then be released during rainfall events into sensitive receiving streams sabouri et al 2016a herb et al 2009a thermal energy loading in ponds and receiving streams is further exacerbated by the flow of heated runoff from impervious surfaces mcbean et al 2022 herb 2008 wardynski et al 2013 observed that thermally enriched runoff from a wet weather event caused a stream s temperature to increase by 9 4 c similarly nelson and palmer 2007 observed an increase of 7 c due to stormwater runoff to an urban stream in maryland warming thermal regimes affect temperature sensitive aquatic species which are limited to geographical areas which accommodate their temperature thresholds warming thermal profiles may affect fish migration and distribution and impact their metabolism reproductive success and their ability to resist diseases and parasites armour 1991 brook trout a temperature sensitive species which is accustomed to 15 c water may experience death after exposure to a 10 minute duration 28 c spike or after a 10 hour duration of exposure 24 c temperature spike wardynski et al 2014 prolonged thermal stratification can also deplete oxygen in the bottom of ponds posing a significant risk to aquatic species mcenroe et al 2013 stajkowski et al 2020b there are many thermal mitigation practices tmp that may be implemented within the contributing watershed upstream of the pond as well as downstream within the riparian corridor of the receiving stream which may reduce the impact of urban runoff on stream temperature herb 2008 prudencio and null 2018 ketabchy et al 2018 ketabchy et al 2019 van seters et al 2019b timm et al 2020 stormwater retention ponds are an end of pipe bmp that is common globally marsalek and chocat 2002 since these ponds control the outflow and influence the final temperature of the stormwater discharging into the receiving stream it is important to have a clear understanding of their thermal performance for this study the focus is only on modelling the processes within stormwater management ponds and the impact of their design characteristics on thermal stratification and outflow runoff temperature understanding the extent and behavior of thermal gradients in a stormwater pond is essential for predicting the temperatures of outlet discharges flow patterns and temperature stratification are highly dependent upon site and event specific conditions studies have investigated the impact of buoyant neutrally buoyant and negatively buoyant inflows on flow patterns in stormwater detention ponds adamsson bergdahl 2006 hendi et al 2018 oertli and parris 2019 perron and pick 2020 taguchi et al 2020 marsalek et al 2003 song et al 2013 and radosavljevic et al 2022 investigated stratification that forms in stormwater ponds and shallow urban lakes and reduces dissolved oxygen concentrations near pond bottoms resulting in the release of contaminants from pond sediments into the water column and ultimately discharge into receiving streams a study by nakhaei et al 2019 modeled the temperature dynamics using three dimensional hydrodynamic simulation and found that a correction for atmospheric stability at the surface boundary layer was necessary which resulted in an increase of sensible and latent heat loss many existing models used to predict temperatures in lakes and ponds are process based numerical models e g buren et al 2000 herb et al 2009b lamoureux et al 2006 nakhaei et al 2019 these models rely on both physical and empirical relationships using meteorological and site specific flow data to quantify heat transfer and hydraulic processes the models solve thermal energy equations using numerical methods and their accuracy ultimately depends on the input data s availability and precision the minnesota urban heat export tool minuhet is a comprehensive analytical model used to simulate stormwater and heat flow in a watershed herb et al 2009a minuhet can predict thermal stratification simulating 1 dimensional vertical mixing but its use is complex and requires calibration with a climate specific training dataset and site specific pond characteristics process based models require significant amounts of data as input which can be costly to obtain and time consuming to calibrate and use in contrast machine learning algorithms may be used to solve non linear input output models for complex hydrology applications the machine learning methods that have been applied within hydrology have been progressing from the simpler methods ann gep to more advanced models with deep learning architecture gmdh and variants lstm as seen in table 1 sabouri et al 2013 developed a feed forward artificial neural network ann to predict the temperature of runoff at stormwater pond inlets during the summer using catchment and climate data a similar study sabouri et al 2016b was performed to develop an ann to estimate the event mean temperature of outflow from a stormwater pond building on existing models sabouri et al 2016a used ann and gene expression programming gep techniques to investigate the factors affecting the thermal enrichment of ponds the results suggest that while ann models enable more accurate predictions for specific sites gep models have the advantage of providing simple relationships between interacting parameters sattar et al 2017 developed three equations using gene expression programming gep models to predict the event mean temperature of stormwater inflow into the pond pond outflow and outflow at cooling trench more recently stajkowski et al 2020a studied the applicability of using a genetic algorithm integrated with a long short term memory ga lstm to estimate the water temperature in a river the ga lstm network outperformed the recurrent neural network rnn it was tested against and the study concluded that a ga lstm is an appropriate deep learning technique that can be used to make time series predictions further stajkowski et al 2021 introduced a modeling methodology to predict the hourly thermal profiles of a pond during dry weather summer months utilizing a new mathematical equation that separated the lower more stable part of the pond and the upper more active part of the pond when characterizing thermal profiles the study then successfully used the general method of data handling gmdh a machine learning method to predict the bottom and surface temperatures in a pond for this study the gmdh model was chosen due the previous success in modeling a variety of processes in hydrology table 1 as well as the ability to predict stormwater pond temperature profiles stajkowski et al 2021 the group method of data handling gmdh is a self organizing machine learning method that can solve non linear systems for complex hydrology problems this method integrates a multilayer structure and quadratic polynomials to predict the outcome of input output relationships bonakdari et al 2019 the gmdh has the advantage of providing empirical polynomials when modeling a system that can be used to investigate processes of interest elkurdy et al 2021 the equations are simple to export and can be utilized for example by government agencies to develop monitoring procedures and to evaluate designs stajkowski et al 2021 this study introduces an alternative to established physical models such as minuhet by applying the gmdh method to quantify pond temperature profiles and outlet temperature during wet weather events 2 methodology 2 1 monitoring site locations between 2014 and 2016 three ponds in the greater toronto area in ontario canada were monitored to determine the impact of wet weather events on the thermal loading of receiving cold water streams the monitoring was performed using temperature sensors installed at various depths to determine each water column s thermal profile table 2 shows an overview of the instrumentation used to monitor each pond all three ponds studied are in urban locations with percent impervious ranging between 55 and 59 and have surface areas ranging from 4000 to 10000 m2 and maximum depths between 2 and 3 m the depths of the pond outlets vary between 1 1 and 2 5 m a summary of the ponds studied can be found in table 3 urban growth is increasingly encroaching on cold water habitats as municipalities expand primarily for low and mid density housing this expansion is occurring upstream on all major river systems where cool headwaters exist and an example case study of this can be seen in the credit river the credit river spans 90 km through nine municipalities in southern ontario draining into lake ontario data were collected from seven stations of the real time credit valley conservation water quality monitoring network fig 2 and were used to illustrate the variability in the thermal regime of the credit river at the watershed scale 2 2 shallow water thermocline equation an equation developed by stajkowski et al 2021 was utilized to predict temperatures in a thermally stratified stormwater pond for this the depths of each pond are normalized to allow for comparison between ponds with different depths as a result of normalization z 0 corresponds to the bottom of any pond and z 1 corresponds to the top of any pond the equation was developed based on the relationship between outlet temperatures and corresponding outlet depths equation 1 incorporates i the pond bottom temperature ii an exponential equation that describes the temperature at deeper portion of the pond temperature profile and iii a logistic function that describes the more active upper portion of the temperature profile closer to the water surface and most influenced by the diurnal air temperature fluctuations the temperature in the lower portion of a pond is usually stable and does not experience significant fluctuation during diurnal heating and cooling in contrast a pond s upper active part gains energy from longwave radiation the sun and reflected shortwave radiation during the day and experiences cooling at night using the equation requires the input of the bottom and surface temperatures and is specifically constructed so the surface temperature ts is intercepted by the logistic function a scaling factor Œ± which is a function of all four parameters eq 2 ensures these conditions are met 1 t z t b a 1 e b z Œ± 1 e c z d 2 Œ± t s t b a 1 e b 1 e c 1 d where ts pond surface water temperature tb pond bottom water temperature a lower mixed zone temperature rise coefficient b growth parameter for the first equation c growth parameter of the second equation d x value of inflection point for logistic equation and Œ± stratification scaling factor parameter a controls the lower temperatures in the temperature profile of a pond b controls the curve s exponential growth and how rapidly the value of a is reached c controls the curve s logistic growth and d determines the curve s inflection point stajkowski et al 2021 2 3 temperature profile curve fitting method the four parameters a b c d of the thermal profile equation was fit to the monitoring data for each hour using the scipy scientific computing library in python virtanen et al 2020 in this case parameter a had no constraints parameter b was constrained between 0 and 20 c between 0 and 60 and d between 0 and 2 when fitting hourly temperature profiles unfixing parameters b and c was found to be necessary to capture the full diurnal temperature cycle since thermal loading and elevated outlet temperatures are of concern we selected a subset of the data comprising only the months of july and august to be used for further modelling when maximum summer temperatures occur it should be noted that this methodology can be extended to other critical time periods within the lifecycle of coldwater species such as spawning and the requirements for the growth and development of juvenile fish 2 4 group method of data handling although climate factors are easily measured a significant degree of uncertainty exists when studying the air temperature water surface boundary this study relied upon advanced machine learning the group method of data handling gmdh to develop accurate hourly pond water temperature profiles the flowchart of the gmdh method is presented in fig 3 as shown the first step splits the data into training and testing sets the next step is the design of the architecture of the neural network including setting the number of inputs for each neuron and the maximum number of hidden layers for deep learning in gmdh the best model architecture is selected based on the akaike information criteria aic by minimizing the objective function representing the square of the difference between the actual eq 3 and estimated eq 4 outcomes as shown in equation 5 the volterra functional series eq 6 was employed to construct a high order polynomial equation the gmdh method uses two independent variables and all possible combinations thereof to create a regression polynomial eq 7 the objective function is then utilized with m observed values to determine the best fit between the values 3 y i f x i 1 x i 2 x i 3 x i n 4 y i f x i 1 x i 2 x i 3 x i n 5 m i n i 1 m f x i 1 x i 2 x i 3 x i n f x i 1 x i 2 x i 3 x i n 2 6 y a 0 i 1 m a i x i i 1 m j 1 m a ij x i x j i 1 m j 1 m k 1 m a ijk x i x j x k 7 y i f x i x j a 0 a 1 x i a 2 x j a 3 x i 2 a 4 x j 2 a 5 x i x j each of the input parameters used in the model were specifically chosen because of their significant impact on thermal gradients in a pond and the subsequent outlet temperature table 4 presents the list of input parameters used in the gmdh models the ordinal date affects pond temperatures in predictable long term annual cycles hour determines the time of day capturing the daily cycles in ponds pond temperatures experience predictable daily fluctuations due to heating by the sun during the day and cooling at night the intertwined relationship between depth and thermal stratification was considered to mean that both maximum pond depth and the location of the pond outlet depth were considered the upper portions of the pond heat up while lower portions remain cooler climate parameters such as air temperature rainfall wind speed and solar radiation determine the heat transfer that occurs at the pond s surface the final equation for the outlet temperature gmdh model is shown in box 1 the model equations for the temperature profile parameters can be found in the provided supplemental material box 1 the optimal equation for the pond outlet temperature to for the wet weather model to 47917 4 md at cubert 99 5697 atavg3 atavg14 25 9172 md atavg3 cubert 4041 38 md cubert at cubert 542 149 atavg14 2 135 991 atavg14 pd cubert 50 3902 md atavg14 197 217 md atavg3 178 967 pd cubert atavg3 cubert 275 597 md atavg14 cubert 3691 39 atavg14 atavg3 cubert 560 522 atavg14 cubert 2 28622 9 atavg14 md cubert 1215 02 atavg3 md cubert 1023 2 od at cubert 1 50345 at pd cubert 1 20327 od atavg14 8 55099 pd cubert r cubert 0 505648 atavg14 cubert 92900 3 pd atavg3 30 8142 md pd 816 565 md cubert pd cubert 1715 12 pd cubert at cubert 23 9887 atavg14 atavg14 cubert 7098 16 r pd cubert 0 0686667 atavg14 17703 8 od atavg3 5 23603 pd pd cubert 411 388 atavg3 od cubert 561 925 od atavg3 cubert 122 433 od cubert atavg3 cubert 13141 2 md cubert atavg3 cubert 23159 od cubert 6280 65 od md 45 4007 od cubert md cubert 25532 3 od od cubert 7 48245 od cubert atavg14 cubert 21076 3 od cubert at cubert 155 078 pd md cubert 4640 02 pd 3501 22 pd atavg3 cubert 714 804 pd cubert 2 180 469 atavg3 cubert 2 2144 87 pd cubert atavg14 cubert 1061 26 md pd cubert 295 281 pd 2 118 632 od md cubert 245 49 md od cubert 4720 83 atavg3 pd cubert 12 8573 pd cubert 1157 92 pd atavg14 43 5694 od cubert pd cubert 241 642 od pd cubert 2 2307 atavg3 atavg14 cubert 635 244 atavg3 cubert atavg14 cubert 13786 6 pd atavg14 cubert 897 288 md cubert atavg14 cubert 23100 5 at w 0 0630767 w atavg3 cubert 7 44654 atavg14 w 0 0879987 md w 0 300911 atavg3 w 0 327387 w at cubert 1 91799 at atavg14 0 203531 atavg14 at cubert 4 31985 hour w cubert 0 0566643 hour md cubert 0 986994 atavg14 w cubert 0 178155 w cubert 2 0 766866 w cubert 463 821 hour cubert 53 9121 hour hour cubert 0 108744 hour cubert w cubert 0 478831 md 68311 7 md md cubert 31635 3 md cubert 59370 1 hour atavg3 cubert 0 793179 hour cubert md cubert 4 29624 atavg3 at cubert 3 44959 at atavg3 cubert 1 83406 od at 0 00126489 at cubert atavg3 cubert 35 0857 hour at cubert 0 0566192 hour cubert at cubert 0 515239 w 114 862 hour cubert atavg3 cubert 1 03109 od cubert w cubert 117 666 od w 0 255053 od w cubert 1 10199 w od cubert 27 2105 hour w 0 00124952 od cubert 2 158 394 pd at 1 16408 w pd cubert 0 134702 pd at cubert 26 7025 hour atavg14 0 0576477 atavg14 hour cubert 0 0611143 hour od cubert 0 0448952 atavg3 430 62 atavg3 2 0 669215 od hour cubert 0 119097 od cubert hour cubert 12 4891 atavg14 od cubert 949 517 od atavg14 cubert 189 678 hour atavg14 cubert 1 45315 md at 0 0964006 hour atavg3 0 028997 hour md 0 255443 note in the equation above the cubert is the cube root function 2 5 minuhet model for comparison of gmdh model with minuhet three rainfall events were selected from the shallowest of the three ponds pond duffin with a depth of 2 m the outlet temperature for duffin was typically higher compared to the two ponds and exceeded 25 c and therefore provides conditions where accurate outlet temperature prediction is critical if the receiving stream is thermally sensitive the minuhet model links runoff and routing processes with physical modelling of heat transfer through the urban catchment required climatic parameters include air temperature rainfall depth windspeed solar radiation relative humidity and cloud cover fraction the purpose of this modelling was to compare the accuracy of the minuhet pond module with the gmdh wet weather model and therefore the accuracy of the other components of minuhet was not considered a simplified model layout was used consisting of three units a single subwatershed a single oversized pipe routing runoff from the subwatershed to the pond which captures the cooling effect of the storm sewer network and a storage unit representing the pond with a single outlet indirect surface drainage from the pond block is considered negligible since the area is insignificant compared to the pond drainage area observed flow and temperature data was used as input to the pond but since there is no practical way to link the observed data as input to the pond model directly the subwatershed and sewer pipe network had to be included and were calibrated to match the observed data the subwatershed requires catchment characteristics such as drainage area percent impervious area flow length slope land use and usda soil type and initial soil moisture of pervious area subwatershed characteristics were initially determined from provided design reports for the development that this pond services the bathymetry of the storage unit is represented by a stage area curve and the outlet of the unit which requires outlet type orifice weir or pipe and width diameter withdrawal depth and control elevation calibration of the model proceeded in three steps first using the hydrologic component by changing subwatershed characteristics to match measured inflow and temperature into the pond second by calibrating the thermal parameters of the subwatershed as well as length and depth of the pipe to match pond inflow temperatures and third by calibrating pond characteristics that control the heat transfer secchi depth shading and wind sheltering to match observed outlet temperature initial thermodynamic parameters for the pond were selected from the minuhet user manual recommended values herb et al 2010 2 6 relative thermal resistance to mixing the relative thermal resistance to mixing rtrm is a density barrier between a pond s top and bottom layers created by a given pond s temperature profile the rtrm of a pond may have significant decreases at the pond bottom caused by the infrequent mixing the rtrm pattern can be determined using equation 8 after wetzel 2001 8 rtrm œÅ s œÅ b œÅ 4 œÅ 5 where œÅ4 and œÅ5 are water densities kg m 3 at 4 c and 5 c and œÅs and œÅb are water densities at the surface and the bottom of the pond respectively chimney et al 2006 song et al 2013 3 results and discussion 3 1 impact of wet weather on the temperature profile model parameters the temperature profile model parameters a b c and d experience diurnal fluctuations before a wet weather event occurs fig 4 a and 4b during this dry period the behavior of parameters a and b as well as c and d are out of phase i e while one increases the other decreases once the event occurs diurnal fluctuation is less evident and the behavior of all parameters becomes random due to mixing within the water column the thermal profile of a pond consists of an active upper portion and a lower stable portion the lower temperature in a pond is described by parameter a the plot shows that as parameter a increases it takes longer to reach the a value parameter b decreases similarly parameter c determines the growth of the top portion of the pond and parameter d determines the inflection point that separates the lower and upper parts of a pond logically as parameter c increases the inflection point occurs deeper in the pond parameter d decreases 3 2 impact of wet weather on the temperature profile within the pond from observing the temperature at various locations and depths in a stormwater pond during rainfall events where the inlet water temperature is cooler than the pond water temperature it is evident that the temperature stratification and mixing behavior is driven by this temperature difference fig 5 the spike in inflow corresponds with a spike in inlet temperature and both fluctuate similarly the surface temperature of the pond experiences diurnal fluctuation during cooling the temperatures in the surface temperature converges once again at locations deeper in the pond temperatures experience significantly less mixing and thermal stratification is more pronounced temperatures at these depths are also more stable and experience minimal fluctuation during the event and diurnal cycle in contrast the thermal behavior in a stormwater pond during an event where the inlet water temperature is warmer than the pond temperature experiences significantly more pronounced temperature fluctuation during the diurnal cycle fig 6 similar to the case with cooler inlet temperatures the top 75 cm of the pond experiences thermal separation during warming and converges when cooling locations deeper in the pond are more stable and experience less fluctuation this case also experiences less significant thermal stratification over the entire depth of the pond 3 3 impact on pond aquatic habitat recently ecologists have studied the role of stormwater ponds as key habitat in urban environments for a range of species including amphibians sauer et al 2022 holtmann et al 2017 le viol et al 2012 and macroinvertebrates perron and pick 2020 meland et al 2020 holtmann et al 2018 as cities become more urbanized and developed more pressure is placed on surviving aquatic habitat and which in some cases stormwater management infrastructure ponds wetlands may become colonized and replace lost natural habitat prudencio and null 2018 hassall and anderson 2015 hassall 2014 stormwater ponds are key infrastructure in the management of flooding erosion and water quality and normally are not designed to provide aquatic habitat and it is therefore an unintended consequence due to the degradation and fragmentation of aquatic habitat in urban areas as well as future stress from climate change developing frameworks to balance the social ecological and human health consequences of stormwater infrastructure is an area of active research cantonati et al 2020 taguchi et al 2020 oertli and parris 2019 viewing stormwater as a resource and designing multi functional infrastructure are key components in the progress towards water sensitive cities wong and brown 2009 the model we have developed can assist designers in meeting ecological design criteria by predicting the thermal performance of stormwater ponds both in outflow and in pond temperature and stratification under various design scenarios the model output can be used to assess the impact on habitat suitability with a stormwater pond and receiving stream using reference temperature thresholds for the species of concern understanding the thermal performance of the pond also assists with balancing the ecosystem services provided by the pond with primary design objectives flood mitigation erosion control water quality and to better understand trade offs in pond design decisions 3 4 gmdh model performance the gmdh model was set up to predict outlet temperatures using 80 of the dataset for training and the remaining 20 for testing table 5 shows the statistical error indices of the performance results of the gmdh model for training and testing the results indicate that the model accurately predicted pond outlet temperature r2 0 94 rmse 0 58 c in comparison to previous studies that used minuhet by herb et al 2009b which produced an r2 0 89 and rmse 0 69 c and ketabchy et al 2018 which had an r2 0 83 pond outlet temperature was predicted for each pond with r2 range between 0 76 and 0 89 and a rmse 0 77 c table 6 3 5 minuhet model performance the new gmdh model outperformed the minuhet model for the case study pond monitoring events with improved prediction error statistics r2 rmse and mae as shown in fig 7 in the beginning of the june 2016 storm event the minuhet model underpredicts the monitored pond outlet temperature and then eventually exceeds the observed values the error statistics of the gmdh model predictions for the entire monitoring period r2 0 70 rmse 0 49 mae 0 39 outperforms the minuhet model predictions error statistics r2 0 34 rmse 1 04 mae 0 86 we also noticed that at the beginning of every rainfall period the minuhet model simulates an unusual rapid spike in outlet temperature which may be caused by numerical errors due to the limited number of layers in the pond model the pond depth is only 1 m for the whole pond except for an outlet sump with an area of 110 m2 that is at a depth of 2 m the numerical error may then be due to issues with capturing this small volume although the minuhet model performs well the amount of calibration and data collection needed may be a barrier of use for pond designers due to time and cost constraints 3 6 assessing thermal regime of the receiving stream the groundwater fed and much cooler headwaters of the credit river west credit at belfountain station 1 in fig 8 is much colder than the subsequent downstream stations of the main credit river e g the credit river at mgcc station 5 in fig 8 there is a clear spatial trend in the credit river water temperature duration curve tdc as it shifts from left to right from upstream to downstream as more surface runoff from the urbanized downstream portions of the watershed is discharged into the river fig 8 thermal regimes which are warming the water in the receiving streams are a significant concern due to the presence of cold water species in the credit river system guidance for protecting fish habitat is provided by the credit river fisheries management plan which classifies management zones based on the thermal regime cvc and mnr 2002 these three zones and corresponding maximum tolerable temperature are coldwater 22 c mixed water 24 c and warmwater 26 c with common coldwater species including brook trout and brown trout one endangered species of concern is the small minnow known as the redside dace clinostomus elongatus which has a target maximum temperature of 24 c redside dace recovery team 2010 mnrf 2016 the temperatures often define a stream s ability to support cold water fisheries through summer july and august classification of a stream s thermal regime can be based on the graphed results of stream and air temperature in july and august between 16 00 and 18 00 h following the methods presented by stoneman and jones 1996 and chu et al 2009 three water quality monitoring stations in the credit river west credit river at belfountain credit river at mgcc and credit river at huttonville lgcc provide an example of the classification of three different thermal regimes cool water cool warm water and warmwater fig 9 the assessment of the thermal regime of the receiving stream i e the credit river guides the design of the stormwater pond depth and the outlet features e g bottom draw to ensure no discernable warming of the stream due to the stormwater pond discharge under a range of summer temperatures and storm event sizes different pond retrofit scenarios can be considered to optimize temperature at the outlet that is released into the stream two stormwater ponds configurations were considered existing duffin 2 0 m depth and dredged duffin 3 0 m depth for the analysis the outlet depth was changed for each pond to both have a bottom draw Œ¥ 0 2d and mid depth draw Œ¥ 0 5d where d is normalized depth of pond and Œ¥ is the normalized outlet elevation from the bottom i e ratio of the elevation of the outlet from the bottom to the depth of the pond a deeper pond provides a cooler layer to draw water from as the outlet is located closer to the bottom the duffin pond outlet discharge water temperature was reduced into the cool warmwater and cool water zone fig 10 a significant temperature decreases of about 7 c when the pond maximum depth is increased from 2 m to 3 m hypothetically dredged by 1 m modifications to existing stormwater ponds can be made to allow the pond discharge to meet the temperature standard for mitigation of environmental impacts this agrees with a recent analysis of stormwater thermal mitigation methods conducted by the ontario conservation authorities van seeters et al 2019 using ponds with greater depth and deeper outlets is an effective measure to control the thermal impact on the receiving stream however the temperature is not the only water quality parameter of concern german et al 2003 hassall and anderson 2015 maintaining adequate dissolved oxygen do concentrations is essential for the health of aquatic ecosystems for deep ponds there is the potential for anoxic conditions to develop near the bottom which may cause the leaching of phosphorous and heavy metals from bottom sediments due to the reducing environment if the outlet is located near the bottom in these conditions water with low do and the contaminants mentioned above near the sediment layer will be released relative thermal resistance to mixing rtrm index of duffin pond was determined for the as built case depth of 2 m and a hypothetical retrofit where the pond is dredged by 1 m to increase the max pond depth to 3 m fig 11 the deeper pond experienced stronger thermal stratification for an extended period and reduced vertical mixing within the pond the 3 m pond shows a much higher level of stability meaning a greater chance of anoxic conditions and release of contaminants from the bottom sediments the reduced mixing and anoxic conditions risk not meeting the target do and releasing contaminants from the sediments into the water column and discharge into the stream 4 conclusions stormwater management wet ponds are widely used in urban areas to attenuate flood peaks and treat stormwater runoff by providing storage controlled release and water quality benefit through retention of suspended solids despite the benefits of these ponds there are potential drawbacks during the summer months the large volumes of water in shallow ponds act as heat storage reservoirs the daily absorption of solar radiation is greater than the nighttime cooling rate resulting in thermal heat build up this warm water is then released to the receiving cool and cold water streams during intense summer thunderstorm events adversely affecting aquatic life due to the thermal shock water temperature is a crucial biological regulator in aquatic ecosystems influencing respiration rates and dissolved oxygen solubility and it can negatively impact aquatic species stormwater management pond design parameters such as the location and depth of the outlet and the depth and shape of the pond can significantly affect the pond outlet discharge water temperature a deeper pond provides a more stable cooler layer to from which draw water if the outlet is close to the bottom modeling and monitoring pond outlet discharge water temperatures is essential to ensure proper design and protection of temperature sensitive aquatic ecosystems in the receiving cool and cold water streams to predict pond outlet temperatures during wet weather events the general method of data handling gmdh was employed to develop an hourly pond outlet discharge temperature prediction model the gmdh outlet temperature model performed favorably in comparison to the minuhet model and was more accurate for the three test events the application of the model was showcased for the duffin pond calculating the cooling effect one can expect if the pond depth were to be changed to increase from 2 m to 3 m and if a bottom draw outlet was to be designed instead of a mid depth draw outlet the model described herein can help municipal engineers and environmental professionals with the design and approvals process for new stormwater management ponds and retrofit existing ones to help minimize the potential adverse effects of these ponds on the receiving streams however the applicability of the models would be limited to ponds with similar characteristics and climate conditions as the case study ponds this model can be used as a design tool to assess the theoretical performance of a new pond by using long term climatic data to evaluate the risk of thermal impact on receiving streams the climate analysis could also be extended to assess the future impact of ponds due to climate change using various emission scenarios what if design scenarios may also be assessed on important pond design considerations such as a pond s depth outlet orifice design pond retention time and nighttime release nevertheless further studies are needed to better understand the increased risk of anoxic conditions developing in deeper ponds and to develop a holistic stormwater management pond design guidelines considering flood risk mitigation water quality improvement performance as well as a thermal design to ensure optimal stormwater management performance of the ponds and a holistic approach for the protection of the sensitive eco systems within urban stream declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this project has received funding support from the natural science and engineering research council of canada nserc discovery grant 400675 and the ontario ministry of transportation the authors would also like to thank the toronto and region conservation authority and the credit valley conservation authority for generously providing temperature data used in the study 
2027,discharges of warm water from shallow stormwater management ponds during summer months into receiving headwater streams pose a risk to aquatic ecosystems in urban watersheds especially in cool and cold water streams physically based models such as minuhet have been used to assess the effects of thermal loading on receiving streams however these models require a significant amount of data and are complex to calibrate and use for the optimized designs that ensure protection of vulnerable aquatic life in urban stream ecosystems this research introduces a user friendly and more accurate machine learning method to predict thermal profiles in stormwater ponds and the pond outlet discharge temperature to the receiving streams during storm events monitoring data were collected between 2014 and 2016 from three stormwater ponds in southern ontario to train and test the new model the new model is used to demonstrate the degree to which cooling effects can be achieved from remedial actions such as increasing the pond depth by dredging one meter and if a bottom draw outlet is used instead of a mid depth draw outlet the methods presented in this study can be used to support an improved stormwater management pond design guidelines based on the key design objective that the thermal regime of the stormwater pond outlet discharge water must match the thermal regime of the receiving stream the main objective is to avoid any discernable warming of the stream due to the stormwater pond discharge under a range of summer temperatures and storm event sizes keywords stormwater management temperature profile urbanization wet weather pond data availability data will be made available on request 1 introduction urbanization can have detrimental effects on stream hydrology and ecology due to the risks associated with release of thermally enriched water to receiving streams from outfalls and stormwater detention ponds urbanization tends to reduce infiltration and baseflow and ultimately increases the temperature of urban streams cockerill et al 2017 ham et al 2006 hester bauman 2013 sabouri et al 2013 binns et al 2019 mackenzie et al 2022a b increases of receiving water body temperatures have significant potential to impact the biological physical and chemical processes occurring in water systems maintaining an appropriate and stable temperature regime in streams rivers is essential for ensuring that aquatic ecosystems are healthy especially for cold water streams vulnerable to prolonged warming and rapid temperature changes cvc and mnr 2002 mnrf 2016 sattar et al 2017 credit valley conservation 2022 stormwater retention ponds are a structural best management practice bmp used to control stormwater quality and quantity by mitigating uncontrolled runoff however their ability to absorb solar radiation during summer months may cause intense and persistent thermal stratification exceeding 9 c between the pond surface and bottom song et al 2013 van seters et al 2019a this thermally enriched water may then be released during rainfall events into sensitive receiving streams sabouri et al 2016a herb et al 2009a thermal energy loading in ponds and receiving streams is further exacerbated by the flow of heated runoff from impervious surfaces mcbean et al 2022 herb 2008 wardynski et al 2013 observed that thermally enriched runoff from a wet weather event caused a stream s temperature to increase by 9 4 c similarly nelson and palmer 2007 observed an increase of 7 c due to stormwater runoff to an urban stream in maryland warming thermal regimes affect temperature sensitive aquatic species which are limited to geographical areas which accommodate their temperature thresholds warming thermal profiles may affect fish migration and distribution and impact their metabolism reproductive success and their ability to resist diseases and parasites armour 1991 brook trout a temperature sensitive species which is accustomed to 15 c water may experience death after exposure to a 10 minute duration 28 c spike or after a 10 hour duration of exposure 24 c temperature spike wardynski et al 2014 prolonged thermal stratification can also deplete oxygen in the bottom of ponds posing a significant risk to aquatic species mcenroe et al 2013 stajkowski et al 2020b there are many thermal mitigation practices tmp that may be implemented within the contributing watershed upstream of the pond as well as downstream within the riparian corridor of the receiving stream which may reduce the impact of urban runoff on stream temperature herb 2008 prudencio and null 2018 ketabchy et al 2018 ketabchy et al 2019 van seters et al 2019b timm et al 2020 stormwater retention ponds are an end of pipe bmp that is common globally marsalek and chocat 2002 since these ponds control the outflow and influence the final temperature of the stormwater discharging into the receiving stream it is important to have a clear understanding of their thermal performance for this study the focus is only on modelling the processes within stormwater management ponds and the impact of their design characteristics on thermal stratification and outflow runoff temperature understanding the extent and behavior of thermal gradients in a stormwater pond is essential for predicting the temperatures of outlet discharges flow patterns and temperature stratification are highly dependent upon site and event specific conditions studies have investigated the impact of buoyant neutrally buoyant and negatively buoyant inflows on flow patterns in stormwater detention ponds adamsson bergdahl 2006 hendi et al 2018 oertli and parris 2019 perron and pick 2020 taguchi et al 2020 marsalek et al 2003 song et al 2013 and radosavljevic et al 2022 investigated stratification that forms in stormwater ponds and shallow urban lakes and reduces dissolved oxygen concentrations near pond bottoms resulting in the release of contaminants from pond sediments into the water column and ultimately discharge into receiving streams a study by nakhaei et al 2019 modeled the temperature dynamics using three dimensional hydrodynamic simulation and found that a correction for atmospheric stability at the surface boundary layer was necessary which resulted in an increase of sensible and latent heat loss many existing models used to predict temperatures in lakes and ponds are process based numerical models e g buren et al 2000 herb et al 2009b lamoureux et al 2006 nakhaei et al 2019 these models rely on both physical and empirical relationships using meteorological and site specific flow data to quantify heat transfer and hydraulic processes the models solve thermal energy equations using numerical methods and their accuracy ultimately depends on the input data s availability and precision the minnesota urban heat export tool minuhet is a comprehensive analytical model used to simulate stormwater and heat flow in a watershed herb et al 2009a minuhet can predict thermal stratification simulating 1 dimensional vertical mixing but its use is complex and requires calibration with a climate specific training dataset and site specific pond characteristics process based models require significant amounts of data as input which can be costly to obtain and time consuming to calibrate and use in contrast machine learning algorithms may be used to solve non linear input output models for complex hydrology applications the machine learning methods that have been applied within hydrology have been progressing from the simpler methods ann gep to more advanced models with deep learning architecture gmdh and variants lstm as seen in table 1 sabouri et al 2013 developed a feed forward artificial neural network ann to predict the temperature of runoff at stormwater pond inlets during the summer using catchment and climate data a similar study sabouri et al 2016b was performed to develop an ann to estimate the event mean temperature of outflow from a stormwater pond building on existing models sabouri et al 2016a used ann and gene expression programming gep techniques to investigate the factors affecting the thermal enrichment of ponds the results suggest that while ann models enable more accurate predictions for specific sites gep models have the advantage of providing simple relationships between interacting parameters sattar et al 2017 developed three equations using gene expression programming gep models to predict the event mean temperature of stormwater inflow into the pond pond outflow and outflow at cooling trench more recently stajkowski et al 2020a studied the applicability of using a genetic algorithm integrated with a long short term memory ga lstm to estimate the water temperature in a river the ga lstm network outperformed the recurrent neural network rnn it was tested against and the study concluded that a ga lstm is an appropriate deep learning technique that can be used to make time series predictions further stajkowski et al 2021 introduced a modeling methodology to predict the hourly thermal profiles of a pond during dry weather summer months utilizing a new mathematical equation that separated the lower more stable part of the pond and the upper more active part of the pond when characterizing thermal profiles the study then successfully used the general method of data handling gmdh a machine learning method to predict the bottom and surface temperatures in a pond for this study the gmdh model was chosen due the previous success in modeling a variety of processes in hydrology table 1 as well as the ability to predict stormwater pond temperature profiles stajkowski et al 2021 the group method of data handling gmdh is a self organizing machine learning method that can solve non linear systems for complex hydrology problems this method integrates a multilayer structure and quadratic polynomials to predict the outcome of input output relationships bonakdari et al 2019 the gmdh has the advantage of providing empirical polynomials when modeling a system that can be used to investigate processes of interest elkurdy et al 2021 the equations are simple to export and can be utilized for example by government agencies to develop monitoring procedures and to evaluate designs stajkowski et al 2021 this study introduces an alternative to established physical models such as minuhet by applying the gmdh method to quantify pond temperature profiles and outlet temperature during wet weather events 2 methodology 2 1 monitoring site locations between 2014 and 2016 three ponds in the greater toronto area in ontario canada were monitored to determine the impact of wet weather events on the thermal loading of receiving cold water streams the monitoring was performed using temperature sensors installed at various depths to determine each water column s thermal profile table 2 shows an overview of the instrumentation used to monitor each pond all three ponds studied are in urban locations with percent impervious ranging between 55 and 59 and have surface areas ranging from 4000 to 10000 m2 and maximum depths between 2 and 3 m the depths of the pond outlets vary between 1 1 and 2 5 m a summary of the ponds studied can be found in table 3 urban growth is increasingly encroaching on cold water habitats as municipalities expand primarily for low and mid density housing this expansion is occurring upstream on all major river systems where cool headwaters exist and an example case study of this can be seen in the credit river the credit river spans 90 km through nine municipalities in southern ontario draining into lake ontario data were collected from seven stations of the real time credit valley conservation water quality monitoring network fig 2 and were used to illustrate the variability in the thermal regime of the credit river at the watershed scale 2 2 shallow water thermocline equation an equation developed by stajkowski et al 2021 was utilized to predict temperatures in a thermally stratified stormwater pond for this the depths of each pond are normalized to allow for comparison between ponds with different depths as a result of normalization z 0 corresponds to the bottom of any pond and z 1 corresponds to the top of any pond the equation was developed based on the relationship between outlet temperatures and corresponding outlet depths equation 1 incorporates i the pond bottom temperature ii an exponential equation that describes the temperature at deeper portion of the pond temperature profile and iii a logistic function that describes the more active upper portion of the temperature profile closer to the water surface and most influenced by the diurnal air temperature fluctuations the temperature in the lower portion of a pond is usually stable and does not experience significant fluctuation during diurnal heating and cooling in contrast a pond s upper active part gains energy from longwave radiation the sun and reflected shortwave radiation during the day and experiences cooling at night using the equation requires the input of the bottom and surface temperatures and is specifically constructed so the surface temperature ts is intercepted by the logistic function a scaling factor Œ± which is a function of all four parameters eq 2 ensures these conditions are met 1 t z t b a 1 e b z Œ± 1 e c z d 2 Œ± t s t b a 1 e b 1 e c 1 d where ts pond surface water temperature tb pond bottom water temperature a lower mixed zone temperature rise coefficient b growth parameter for the first equation c growth parameter of the second equation d x value of inflection point for logistic equation and Œ± stratification scaling factor parameter a controls the lower temperatures in the temperature profile of a pond b controls the curve s exponential growth and how rapidly the value of a is reached c controls the curve s logistic growth and d determines the curve s inflection point stajkowski et al 2021 2 3 temperature profile curve fitting method the four parameters a b c d of the thermal profile equation was fit to the monitoring data for each hour using the scipy scientific computing library in python virtanen et al 2020 in this case parameter a had no constraints parameter b was constrained between 0 and 20 c between 0 and 60 and d between 0 and 2 when fitting hourly temperature profiles unfixing parameters b and c was found to be necessary to capture the full diurnal temperature cycle since thermal loading and elevated outlet temperatures are of concern we selected a subset of the data comprising only the months of july and august to be used for further modelling when maximum summer temperatures occur it should be noted that this methodology can be extended to other critical time periods within the lifecycle of coldwater species such as spawning and the requirements for the growth and development of juvenile fish 2 4 group method of data handling although climate factors are easily measured a significant degree of uncertainty exists when studying the air temperature water surface boundary this study relied upon advanced machine learning the group method of data handling gmdh to develop accurate hourly pond water temperature profiles the flowchart of the gmdh method is presented in fig 3 as shown the first step splits the data into training and testing sets the next step is the design of the architecture of the neural network including setting the number of inputs for each neuron and the maximum number of hidden layers for deep learning in gmdh the best model architecture is selected based on the akaike information criteria aic by minimizing the objective function representing the square of the difference between the actual eq 3 and estimated eq 4 outcomes as shown in equation 5 the volterra functional series eq 6 was employed to construct a high order polynomial equation the gmdh method uses two independent variables and all possible combinations thereof to create a regression polynomial eq 7 the objective function is then utilized with m observed values to determine the best fit between the values 3 y i f x i 1 x i 2 x i 3 x i n 4 y i f x i 1 x i 2 x i 3 x i n 5 m i n i 1 m f x i 1 x i 2 x i 3 x i n f x i 1 x i 2 x i 3 x i n 2 6 y a 0 i 1 m a i x i i 1 m j 1 m a ij x i x j i 1 m j 1 m k 1 m a ijk x i x j x k 7 y i f x i x j a 0 a 1 x i a 2 x j a 3 x i 2 a 4 x j 2 a 5 x i x j each of the input parameters used in the model were specifically chosen because of their significant impact on thermal gradients in a pond and the subsequent outlet temperature table 4 presents the list of input parameters used in the gmdh models the ordinal date affects pond temperatures in predictable long term annual cycles hour determines the time of day capturing the daily cycles in ponds pond temperatures experience predictable daily fluctuations due to heating by the sun during the day and cooling at night the intertwined relationship between depth and thermal stratification was considered to mean that both maximum pond depth and the location of the pond outlet depth were considered the upper portions of the pond heat up while lower portions remain cooler climate parameters such as air temperature rainfall wind speed and solar radiation determine the heat transfer that occurs at the pond s surface the final equation for the outlet temperature gmdh model is shown in box 1 the model equations for the temperature profile parameters can be found in the provided supplemental material box 1 the optimal equation for the pond outlet temperature to for the wet weather model to 47917 4 md at cubert 99 5697 atavg3 atavg14 25 9172 md atavg3 cubert 4041 38 md cubert at cubert 542 149 atavg14 2 135 991 atavg14 pd cubert 50 3902 md atavg14 197 217 md atavg3 178 967 pd cubert atavg3 cubert 275 597 md atavg14 cubert 3691 39 atavg14 atavg3 cubert 560 522 atavg14 cubert 2 28622 9 atavg14 md cubert 1215 02 atavg3 md cubert 1023 2 od at cubert 1 50345 at pd cubert 1 20327 od atavg14 8 55099 pd cubert r cubert 0 505648 atavg14 cubert 92900 3 pd atavg3 30 8142 md pd 816 565 md cubert pd cubert 1715 12 pd cubert at cubert 23 9887 atavg14 atavg14 cubert 7098 16 r pd cubert 0 0686667 atavg14 17703 8 od atavg3 5 23603 pd pd cubert 411 388 atavg3 od cubert 561 925 od atavg3 cubert 122 433 od cubert atavg3 cubert 13141 2 md cubert atavg3 cubert 23159 od cubert 6280 65 od md 45 4007 od cubert md cubert 25532 3 od od cubert 7 48245 od cubert atavg14 cubert 21076 3 od cubert at cubert 155 078 pd md cubert 4640 02 pd 3501 22 pd atavg3 cubert 714 804 pd cubert 2 180 469 atavg3 cubert 2 2144 87 pd cubert atavg14 cubert 1061 26 md pd cubert 295 281 pd 2 118 632 od md cubert 245 49 md od cubert 4720 83 atavg3 pd cubert 12 8573 pd cubert 1157 92 pd atavg14 43 5694 od cubert pd cubert 241 642 od pd cubert 2 2307 atavg3 atavg14 cubert 635 244 atavg3 cubert atavg14 cubert 13786 6 pd atavg14 cubert 897 288 md cubert atavg14 cubert 23100 5 at w 0 0630767 w atavg3 cubert 7 44654 atavg14 w 0 0879987 md w 0 300911 atavg3 w 0 327387 w at cubert 1 91799 at atavg14 0 203531 atavg14 at cubert 4 31985 hour w cubert 0 0566643 hour md cubert 0 986994 atavg14 w cubert 0 178155 w cubert 2 0 766866 w cubert 463 821 hour cubert 53 9121 hour hour cubert 0 108744 hour cubert w cubert 0 478831 md 68311 7 md md cubert 31635 3 md cubert 59370 1 hour atavg3 cubert 0 793179 hour cubert md cubert 4 29624 atavg3 at cubert 3 44959 at atavg3 cubert 1 83406 od at 0 00126489 at cubert atavg3 cubert 35 0857 hour at cubert 0 0566192 hour cubert at cubert 0 515239 w 114 862 hour cubert atavg3 cubert 1 03109 od cubert w cubert 117 666 od w 0 255053 od w cubert 1 10199 w od cubert 27 2105 hour w 0 00124952 od cubert 2 158 394 pd at 1 16408 w pd cubert 0 134702 pd at cubert 26 7025 hour atavg14 0 0576477 atavg14 hour cubert 0 0611143 hour od cubert 0 0448952 atavg3 430 62 atavg3 2 0 669215 od hour cubert 0 119097 od cubert hour cubert 12 4891 atavg14 od cubert 949 517 od atavg14 cubert 189 678 hour atavg14 cubert 1 45315 md at 0 0964006 hour atavg3 0 028997 hour md 0 255443 note in the equation above the cubert is the cube root function 2 5 minuhet model for comparison of gmdh model with minuhet three rainfall events were selected from the shallowest of the three ponds pond duffin with a depth of 2 m the outlet temperature for duffin was typically higher compared to the two ponds and exceeded 25 c and therefore provides conditions where accurate outlet temperature prediction is critical if the receiving stream is thermally sensitive the minuhet model links runoff and routing processes with physical modelling of heat transfer through the urban catchment required climatic parameters include air temperature rainfall depth windspeed solar radiation relative humidity and cloud cover fraction the purpose of this modelling was to compare the accuracy of the minuhet pond module with the gmdh wet weather model and therefore the accuracy of the other components of minuhet was not considered a simplified model layout was used consisting of three units a single subwatershed a single oversized pipe routing runoff from the subwatershed to the pond which captures the cooling effect of the storm sewer network and a storage unit representing the pond with a single outlet indirect surface drainage from the pond block is considered negligible since the area is insignificant compared to the pond drainage area observed flow and temperature data was used as input to the pond but since there is no practical way to link the observed data as input to the pond model directly the subwatershed and sewer pipe network had to be included and were calibrated to match the observed data the subwatershed requires catchment characteristics such as drainage area percent impervious area flow length slope land use and usda soil type and initial soil moisture of pervious area subwatershed characteristics were initially determined from provided design reports for the development that this pond services the bathymetry of the storage unit is represented by a stage area curve and the outlet of the unit which requires outlet type orifice weir or pipe and width diameter withdrawal depth and control elevation calibration of the model proceeded in three steps first using the hydrologic component by changing subwatershed characteristics to match measured inflow and temperature into the pond second by calibrating the thermal parameters of the subwatershed as well as length and depth of the pipe to match pond inflow temperatures and third by calibrating pond characteristics that control the heat transfer secchi depth shading and wind sheltering to match observed outlet temperature initial thermodynamic parameters for the pond were selected from the minuhet user manual recommended values herb et al 2010 2 6 relative thermal resistance to mixing the relative thermal resistance to mixing rtrm is a density barrier between a pond s top and bottom layers created by a given pond s temperature profile the rtrm of a pond may have significant decreases at the pond bottom caused by the infrequent mixing the rtrm pattern can be determined using equation 8 after wetzel 2001 8 rtrm œÅ s œÅ b œÅ 4 œÅ 5 where œÅ4 and œÅ5 are water densities kg m 3 at 4 c and 5 c and œÅs and œÅb are water densities at the surface and the bottom of the pond respectively chimney et al 2006 song et al 2013 3 results and discussion 3 1 impact of wet weather on the temperature profile model parameters the temperature profile model parameters a b c and d experience diurnal fluctuations before a wet weather event occurs fig 4 a and 4b during this dry period the behavior of parameters a and b as well as c and d are out of phase i e while one increases the other decreases once the event occurs diurnal fluctuation is less evident and the behavior of all parameters becomes random due to mixing within the water column the thermal profile of a pond consists of an active upper portion and a lower stable portion the lower temperature in a pond is described by parameter a the plot shows that as parameter a increases it takes longer to reach the a value parameter b decreases similarly parameter c determines the growth of the top portion of the pond and parameter d determines the inflection point that separates the lower and upper parts of a pond logically as parameter c increases the inflection point occurs deeper in the pond parameter d decreases 3 2 impact of wet weather on the temperature profile within the pond from observing the temperature at various locations and depths in a stormwater pond during rainfall events where the inlet water temperature is cooler than the pond water temperature it is evident that the temperature stratification and mixing behavior is driven by this temperature difference fig 5 the spike in inflow corresponds with a spike in inlet temperature and both fluctuate similarly the surface temperature of the pond experiences diurnal fluctuation during cooling the temperatures in the surface temperature converges once again at locations deeper in the pond temperatures experience significantly less mixing and thermal stratification is more pronounced temperatures at these depths are also more stable and experience minimal fluctuation during the event and diurnal cycle in contrast the thermal behavior in a stormwater pond during an event where the inlet water temperature is warmer than the pond temperature experiences significantly more pronounced temperature fluctuation during the diurnal cycle fig 6 similar to the case with cooler inlet temperatures the top 75 cm of the pond experiences thermal separation during warming and converges when cooling locations deeper in the pond are more stable and experience less fluctuation this case also experiences less significant thermal stratification over the entire depth of the pond 3 3 impact on pond aquatic habitat recently ecologists have studied the role of stormwater ponds as key habitat in urban environments for a range of species including amphibians sauer et al 2022 holtmann et al 2017 le viol et al 2012 and macroinvertebrates perron and pick 2020 meland et al 2020 holtmann et al 2018 as cities become more urbanized and developed more pressure is placed on surviving aquatic habitat and which in some cases stormwater management infrastructure ponds wetlands may become colonized and replace lost natural habitat prudencio and null 2018 hassall and anderson 2015 hassall 2014 stormwater ponds are key infrastructure in the management of flooding erosion and water quality and normally are not designed to provide aquatic habitat and it is therefore an unintended consequence due to the degradation and fragmentation of aquatic habitat in urban areas as well as future stress from climate change developing frameworks to balance the social ecological and human health consequences of stormwater infrastructure is an area of active research cantonati et al 2020 taguchi et al 2020 oertli and parris 2019 viewing stormwater as a resource and designing multi functional infrastructure are key components in the progress towards water sensitive cities wong and brown 2009 the model we have developed can assist designers in meeting ecological design criteria by predicting the thermal performance of stormwater ponds both in outflow and in pond temperature and stratification under various design scenarios the model output can be used to assess the impact on habitat suitability with a stormwater pond and receiving stream using reference temperature thresholds for the species of concern understanding the thermal performance of the pond also assists with balancing the ecosystem services provided by the pond with primary design objectives flood mitigation erosion control water quality and to better understand trade offs in pond design decisions 3 4 gmdh model performance the gmdh model was set up to predict outlet temperatures using 80 of the dataset for training and the remaining 20 for testing table 5 shows the statistical error indices of the performance results of the gmdh model for training and testing the results indicate that the model accurately predicted pond outlet temperature r2 0 94 rmse 0 58 c in comparison to previous studies that used minuhet by herb et al 2009b which produced an r2 0 89 and rmse 0 69 c and ketabchy et al 2018 which had an r2 0 83 pond outlet temperature was predicted for each pond with r2 range between 0 76 and 0 89 and a rmse 0 77 c table 6 3 5 minuhet model performance the new gmdh model outperformed the minuhet model for the case study pond monitoring events with improved prediction error statistics r2 rmse and mae as shown in fig 7 in the beginning of the june 2016 storm event the minuhet model underpredicts the monitored pond outlet temperature and then eventually exceeds the observed values the error statistics of the gmdh model predictions for the entire monitoring period r2 0 70 rmse 0 49 mae 0 39 outperforms the minuhet model predictions error statistics r2 0 34 rmse 1 04 mae 0 86 we also noticed that at the beginning of every rainfall period the minuhet model simulates an unusual rapid spike in outlet temperature which may be caused by numerical errors due to the limited number of layers in the pond model the pond depth is only 1 m for the whole pond except for an outlet sump with an area of 110 m2 that is at a depth of 2 m the numerical error may then be due to issues with capturing this small volume although the minuhet model performs well the amount of calibration and data collection needed may be a barrier of use for pond designers due to time and cost constraints 3 6 assessing thermal regime of the receiving stream the groundwater fed and much cooler headwaters of the credit river west credit at belfountain station 1 in fig 8 is much colder than the subsequent downstream stations of the main credit river e g the credit river at mgcc station 5 in fig 8 there is a clear spatial trend in the credit river water temperature duration curve tdc as it shifts from left to right from upstream to downstream as more surface runoff from the urbanized downstream portions of the watershed is discharged into the river fig 8 thermal regimes which are warming the water in the receiving streams are a significant concern due to the presence of cold water species in the credit river system guidance for protecting fish habitat is provided by the credit river fisheries management plan which classifies management zones based on the thermal regime cvc and mnr 2002 these three zones and corresponding maximum tolerable temperature are coldwater 22 c mixed water 24 c and warmwater 26 c with common coldwater species including brook trout and brown trout one endangered species of concern is the small minnow known as the redside dace clinostomus elongatus which has a target maximum temperature of 24 c redside dace recovery team 2010 mnrf 2016 the temperatures often define a stream s ability to support cold water fisheries through summer july and august classification of a stream s thermal regime can be based on the graphed results of stream and air temperature in july and august between 16 00 and 18 00 h following the methods presented by stoneman and jones 1996 and chu et al 2009 three water quality monitoring stations in the credit river west credit river at belfountain credit river at mgcc and credit river at huttonville lgcc provide an example of the classification of three different thermal regimes cool water cool warm water and warmwater fig 9 the assessment of the thermal regime of the receiving stream i e the credit river guides the design of the stormwater pond depth and the outlet features e g bottom draw to ensure no discernable warming of the stream due to the stormwater pond discharge under a range of summer temperatures and storm event sizes different pond retrofit scenarios can be considered to optimize temperature at the outlet that is released into the stream two stormwater ponds configurations were considered existing duffin 2 0 m depth and dredged duffin 3 0 m depth for the analysis the outlet depth was changed for each pond to both have a bottom draw Œ¥ 0 2d and mid depth draw Œ¥ 0 5d where d is normalized depth of pond and Œ¥ is the normalized outlet elevation from the bottom i e ratio of the elevation of the outlet from the bottom to the depth of the pond a deeper pond provides a cooler layer to draw water from as the outlet is located closer to the bottom the duffin pond outlet discharge water temperature was reduced into the cool warmwater and cool water zone fig 10 a significant temperature decreases of about 7 c when the pond maximum depth is increased from 2 m to 3 m hypothetically dredged by 1 m modifications to existing stormwater ponds can be made to allow the pond discharge to meet the temperature standard for mitigation of environmental impacts this agrees with a recent analysis of stormwater thermal mitigation methods conducted by the ontario conservation authorities van seeters et al 2019 using ponds with greater depth and deeper outlets is an effective measure to control the thermal impact on the receiving stream however the temperature is not the only water quality parameter of concern german et al 2003 hassall and anderson 2015 maintaining adequate dissolved oxygen do concentrations is essential for the health of aquatic ecosystems for deep ponds there is the potential for anoxic conditions to develop near the bottom which may cause the leaching of phosphorous and heavy metals from bottom sediments due to the reducing environment if the outlet is located near the bottom in these conditions water with low do and the contaminants mentioned above near the sediment layer will be released relative thermal resistance to mixing rtrm index of duffin pond was determined for the as built case depth of 2 m and a hypothetical retrofit where the pond is dredged by 1 m to increase the max pond depth to 3 m fig 11 the deeper pond experienced stronger thermal stratification for an extended period and reduced vertical mixing within the pond the 3 m pond shows a much higher level of stability meaning a greater chance of anoxic conditions and release of contaminants from the bottom sediments the reduced mixing and anoxic conditions risk not meeting the target do and releasing contaminants from the sediments into the water column and discharge into the stream 4 conclusions stormwater management wet ponds are widely used in urban areas to attenuate flood peaks and treat stormwater runoff by providing storage controlled release and water quality benefit through retention of suspended solids despite the benefits of these ponds there are potential drawbacks during the summer months the large volumes of water in shallow ponds act as heat storage reservoirs the daily absorption of solar radiation is greater than the nighttime cooling rate resulting in thermal heat build up this warm water is then released to the receiving cool and cold water streams during intense summer thunderstorm events adversely affecting aquatic life due to the thermal shock water temperature is a crucial biological regulator in aquatic ecosystems influencing respiration rates and dissolved oxygen solubility and it can negatively impact aquatic species stormwater management pond design parameters such as the location and depth of the outlet and the depth and shape of the pond can significantly affect the pond outlet discharge water temperature a deeper pond provides a more stable cooler layer to from which draw water if the outlet is close to the bottom modeling and monitoring pond outlet discharge water temperatures is essential to ensure proper design and protection of temperature sensitive aquatic ecosystems in the receiving cool and cold water streams to predict pond outlet temperatures during wet weather events the general method of data handling gmdh was employed to develop an hourly pond outlet discharge temperature prediction model the gmdh outlet temperature model performed favorably in comparison to the minuhet model and was more accurate for the three test events the application of the model was showcased for the duffin pond calculating the cooling effect one can expect if the pond depth were to be changed to increase from 2 m to 3 m and if a bottom draw outlet was to be designed instead of a mid depth draw outlet the model described herein can help municipal engineers and environmental professionals with the design and approvals process for new stormwater management ponds and retrofit existing ones to help minimize the potential adverse effects of these ponds on the receiving streams however the applicability of the models would be limited to ponds with similar characteristics and climate conditions as the case study ponds this model can be used as a design tool to assess the theoretical performance of a new pond by using long term climatic data to evaluate the risk of thermal impact on receiving streams the climate analysis could also be extended to assess the future impact of ponds due to climate change using various emission scenarios what if design scenarios may also be assessed on important pond design considerations such as a pond s depth outlet orifice design pond retention time and nighttime release nevertheless further studies are needed to better understand the increased risk of anoxic conditions developing in deeper ponds and to develop a holistic stormwater management pond design guidelines considering flood risk mitigation water quality improvement performance as well as a thermal design to ensure optimal stormwater management performance of the ponds and a holistic approach for the protection of the sensitive eco systems within urban stream declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this project has received funding support from the natural science and engineering research council of canada nserc discovery grant 400675 and the ontario ministry of transportation the authors would also like to thank the toronto and region conservation authority and the credit valley conservation authority for generously providing temperature data used in the study 
2028,climate change is a key factor that profoundly affects aquatic environments because of climate warming the increase in the intensity and frequency of extreme climate events has aggravated the uncertainty of nitrogen pollution however the risk of nitrogen loss under different climatic conditions has not been well assessed which is of great significance for controlling diffuse pollution in this study we used the upper and middle wei river basin umwb as the study area and selected organic nitrogen org n and nitrate no3 n as the two forms of nitrogen pollution then we quantified the contributions of 10 climate factors and combined the soil and water assessment tool swat and copula to analyze the risk of pollution when extreme weather occurs our results showed that during periods of high precipitation and temperature org n loss accounted for 96 and 83 of the total loss and nitrate loss accounted for 74 and 67 respectively org n loss responded more strongly to high precipitation than nitrate loss because org n was transported with soil particles the attribution analysis indicated that high precipitation amount r95p contributed to the largest org n loss as for the nitrate loss r95p normal precipitation amount and consecutive days with no precipitation were the most important climatic drivers accounting for 35 32 and 13 of the watershed area respectively after selecting critical source areas by identification method an optimized copula model for nitrogen loss and the main climatic factors was proposed the risk of nitrogen pollution under the defined climate severity was then quantified the probabilities of org n and nitrate loss exceeding the top 1 20 were 0 2 15 and 0 8 10 when the precipitation exceeded the top 20 the pollution risk caused by high temperatures is lower than that caused by precipitation this study emphasized the dominant role of extreme climate in driving nitrogen loss and proposed a method for quantifying the risk of nitrogen pollution under specific climate conditions which enabled managers to identify high risk pollution areas and optimize management measures to prevent diffuse nitrogen pollution keywords extreme climate diffuse pollution different forms of nitrogen risk assessment copula analysis data availability data will be made available on request 1 introduction nitrogen n is a primary nutrient for plants and a key substance in water eutrophication and increasingly serious n pollution has become a global concern camargo alonso 2006 subbarao searchinger 2021 nitrogen in water mainly comes from chemical fertilizers soil nitrogen sources and atmospheric sedimentation thomazo et al 2018 as the main component of inorganic nitrogen nitrate is easily absorbed by aquatic plants algae and bacteria which can accelerate eutrophication and endanger human health gilliam et al 2019 excess organic nitrogen consumes a large amount of oxygen when used by organisms which promotes the formation of anoxic zones in water bodies zhu et al 2020 wannicke et al 2018 since the middle of the last century researchers have proved that nitrogen loss is the final product of the interaction of terrestrial biogeochemistry atmosphere surface exchange hydrology and land management in which the frequency and intensity of climate factors are the main driving factors wu et al 2012 shields et al 2008 hu et al 2019 the assessment report of the intergovernmental panel on climate change ipcc ar6 reported that global warming has caused extreme climate conditions to undergo drastic changes and these slight changes may have profound impacts on the physical and chemical properties of substances in the basin masson delmotte et al 2021 zhang et al 2021 understanding the response of land to aquatic nitrogen loading to climate events is critical in addition to human activities climate change is one of the major factors affecting the physical migration and chemical transformation processes of nitrogen as a nitrogen carrier runoff provides power for the migration of nitrogen loss chen et al 2021 precipitation infiltrates the soil to generate runoff and erodes nitrogen rich soil fines causing disproportionate loss of dissolved nitrogen nitrate and absorbed nitrogen organic nitrogen in the soil ao et al 2019 keene et al 2002 worsfold et al 2008 in addition higher soil water content results in changes in dissolved oxygen content which may affect nitrogen mineralization and nitrification stoliker et al 2016 hutchins et al 2020 temperature can regulate the chemical reaction rate and microbial and biological activities by influencing nitrogen conversion li et al 2019 with an increase in temperature nitrogen mineralization and nitrification rates increase and the uptake of inorganic nitrogen by plants increases leading to more complex results blecken et al 2010 many studies have been conducted on the relationship between nitrogen loss and climate factors sinha et al 2017 tian et al 2020 ballard et al 2019 although these two climate factors can measure climate change to a certain extent these simple indices may not fully reflect the characteristics of climate change particularly the frequency intensity or duration of extreme conditions which could play an important role in enhancing nitrogen pollution carpenter et al 2018 zhang et al 2021 most existing studies have not disentangled the contributions of extreme events versus normal climate factors and the relative importance of specific climate drivers to nitrogen pollution in different formats has not been well described quantifying the importance of extreme events and normal climate factors on nitrogen loss and selecting the dominant factors would allow managers to pay more attention to extreme climate changes and take countermeasures in advance this has theoretical significance for understanding the driving effects of climate change on nitrogen loss and has practical significance for prevention and control of diffuse pollution due to spatial heterogeneity in topography land use soil and human activities nitrogen loss are spatially inhomogeneous most of the n loss comes from a small portion of the watershed known as the critical source area csa pionke et al 2000 csas were not only the main output unit of non point source pollutants in watershed but also important hydrological sensitive areas where surface and subsurface runoff mobilize and transfer n from terrestrial to reach niraula et al 2013 heathwaite et al 2005 this method can identify areas with high risk of diffuse n pollution which is the basis for sustainable watershed development and management however the traditional csa method can only assess the areas with high n loss separately when extreme weather occurs it is difficult to fully reflect the variation characteristics under extreme climate conditions and could reduce the accuracy of the risk assessment peng et al 2020 wang et al 2019 considering the increasing frequency and intensity of extreme climate events more detailed and accurate investigations are required therefore it is necessary to explore nitrogen loss under extreme weather conditions to improve the accuracy of pollution risk assessment simple correlation analysis may not fully capture the relationship between the tail part of climate data i e extreme conditions and diffuse n loss because of the complex biogeochemical cycles in aquatic and terrestrial environments collins mcgonigle 2008 mamun et al 2020 as an important method to study multivariate joint probability distribution the copula function has been gradually used to study the combined distribution of hydrological drought and other variables tahroudi et al 2020 zang et al 2022 saghafian mehdikhani 2013 the main advantage of the copula function is that any marginal probability distribution can be built into a joint distribution model to describe the nonlinear and asymmetric relationships between variables without distorting the information contained in the random variables durante sempi 2015 besides copula function can also describe the relationship between the tail values of two sets of data very well zscheischler et al 2017 therefore we chose copula function to construct the joint distribution of climate and nitrogen loss and finally analyze the probability of variables exceeding the threshold when constructing the copula function although limited measurement data can be used to build the copula more data would improve the fitting degree of the data distribution characteristics and the accuracy of description for actual situation mansour et al 2020 due to the sparse distribution traditional monitoring data cannot support spatially analysis in a watershed and cannot overcome the inherent spatial and temporal heterogeneities in hydrological connectivity and climate variability niraula et al 2011 researchers have developed many long time distributed and physically based models to solve this problem which have become widely used methods to simulate hydrological processes sediment yield and nutrients demb√©l√© et al 2020 singh 2018 among them the soil and water assessment tool swat with hydrological response unit hru discretization based on topography climate land cover and soil type attributes is an efficient model to simulate the spatiotemporal distribution of natural loss processes of nitrogen meshesha et al 2020 therefore we applied the swat simulation results to a copula function to analyze how to identify priority management intervals i e areas with high risk under extreme weather conditions prone to diffuse nitrogen pollution which is conducive to better nitrogen management and assessment many measures and regulations have been taken to deal with excessive diffuse n loss but these measures may not achieve the desired effect if the impact of extreme climate is not considered combining swat and copulas to quantify probability of nitrogen loss exceeding specific thresholds under extreme climate conditions is an application to assess the risk of diffuse n pollution from a new perspective the specific objectives of our study were to 1 analyze the spatiotemporal characteristics of organic nitrogen org n and nitrate loss no3 n during typical climate periods and identify the main climatic drivers 2 identify the critical source areas generate the marginal probability distribution of variables for these csas by parameter estimation and fit evaluation and then construct a copula model for climate factors and nitrogen loss and 3 quantify the diffuse pollution risk under extreme climate conditions with four specific thresholds in a typical semi arid watershed in northwestern china using this method can help avoid the limitation of existing pollution control management which only considers nitrogen variables and ultimately provides more objective and accurate information for effectively protecting and managing the water environment under climate change 2 materials and methods 2 1 study area description the wei river which is 828 km long is the largest tributary of the yellow river our study area is in the upper and middle wei river basin wrb with an area of 515 000 km2 accounting for 38 of the wrb fig 1 the elevation of the upper and middle wei river basin umwb ranges from 352 m in the eastern region to 3903 m in the west the average precipitation from 1971 to 2020 was 546 5 mm and the average annual temperature was approximately 10 2 there are three major land use types in this region cropland 40 forest 31 and grassland 24 fig s1 the serious soil erosion caused by precipitation with a short duration and high intensity in summer and a large amount of fertilization from cropland caused diffuse pollution and water pollution in this basin 2 2 data collection the meteorological data used in this study included the daily maximum and minimum temperatures precipitation wind speed solar radiation and relative humidity climate data were collected from 11 meteorological stations between 1961 and 2020 by the china meteorological administration cma https data cma cn a 90 90 m shuttle radar topography mission srtm digital elevation model dem was used to extract the flow direction and accumulation create streams delineate the watershed and calculate the sub basin parameters land use data for the year 2017 30 m 30 m were provided by the national earth system science data center https www geodata cn and soil data at a scale of 1 1 000 000 were provided by the environmental and ecological science data center for west china https westdc westgis ac cn the monthly streamflow data observed from 2007 to 2020 at the xianyang hydrological station were obtained from the yellow river water resources commission https www yrcc gov cn the concentration of total nitrogen tn data 2018 2020 at the xianyangtieqiao monitoring station was obtained from a water quality monitoring station point source pollution livestock and poultry breeding and agricultural management measures crop types and fertilizer application were obtained from the shaanxi gansu and ningxia statistical yearbook https www yearbookchina com index aspx 2 3 model setup calibration and validation the swat was developed by the united states department of agriculture agricultural research service usda ars and has been widely used to project the impact of climate change and land use and cover change on water sediment and chemical components arnold et al 2012 the hydrological components in swat are based on the water balance equation gassman et al 2007 1 sw t s w i 1 t r i q i et i p i ql i where sw is the soil water content i is the time t days for the simulation period r mm q mm et mm p mm and ql mm are the daily amounts of precipitation surface runoff evapotranspiration percolation and subsurface lateral flow respectively the hru the basic unit in swat is defined as a unique aggregation of land use soil properties and terrain slopes in swat nitrogen may be added to the soil by fertilizer manure or residue application fixation by symbiotic or nonsymbiotic bacteria and rain nitrogen is removed from the soil by plant uptake leaching volatilization denitrification and erosion the nitrogen mass balance equation 2 Œ¥ n n app n atm n fix n up n leach n denit n volat n ero where n app is n in fertilizer manure or residue application n atm is atmospheric n deposition n fix is n fixated by symbiotic or nonsymbiotic bacteria n up is plant uptake n n leach is n exported by leaching n denit is n removed by denitrification n volat is n removed by volatilization n ero is n exported by erosion in our research nitrogen loss indicated the dissolved nitrogen and adsorbed nitrogen transported out of the hru to main channel which might cause non point source pollution epelde et al 2015 arnold et al 2012 organic n attached to soil particles may be transported out of the hru to the main channel because retention of nitrate by soils is minimal nitrate is very susceptible to leaching the algorithms used by swat to calculated nitrate leaching simultaneously solve for loss of nitrate in surface runoff and lateral flow also besides groundwater flow entering the main channel from the shallow aquifer can contain nitrate nitrate loss could be calculated as follows 3 no 3 n s u r q n l a t q no 3 g w where no 3 k g h a is nitrate transported with runoff from the hru into the reach during the time step nsurq k g h a is nitrate transported out of the hru with surface runoff into the reach during the time step nlatq k g h a is nitrate transported out of the hru with lateral flow into the reach during the time step no 3 g w k g h a is nitrate transported into main channel in the groundwater loading from the hru we delineated the umwb into 93 subbasins and 1404 hrus and calibrated the model based on monthly streamflow and tn using the swat cup calibration and uncertainty procedures with the sequential uncertainty fitting version 2 sufi 2 algorithm kumar et al 2017 fig 2 we used swat cup to identify the set of parameters based on the sensitivity analysis and generate the optimized values of the parameters table s1 finally we used numerical criteria to evaluate model performance including the nash sutcliffe efficiency nse coefficient of determination r2 and percentage bias pbias supplementary doc although there were two underestimated i e 2013 and 2018 peak flows during years with extreme water quantities the monthly streamflow simulations corresponded well with observations in addition the performance of the sediment simulation was acceptable fig s2 as for the tn simulation the evaluation showed that the nse was above 0 55 r2 was above 0 75 and pbias was lower than 25 based on the performance ratings given by donizete et al 2016 moriasi 2007 our simulations were evaluated as good for streamflow and sediment simulation and satisfactory for tn simulation 2 4 framework for risk assessment the processes for diffuse nitrogen pollution i e org n and no3 n analysis considering the joint distribution of climatic variables i e precipitation and temperature are summarized as follows a identify the spatial distribution of the critical source areas at hru scale b constructing marginal probability distributions for these critical source areas c constructing a copula model and d establishing conditions where the precipitation temperature exceeds specific thresholds to analyze and assess the corresponding n loss risk in the umwb 2 4 1 identifying the critical source areas after analyzing the nitrogen loss of each hru the total loss of n was calculated as follows 4 n ti n i a i 5 n t i 1 n n ti where n i k g h a is the loss intensity of n in hru i a i h a is the area of the hru n ti k g is the total diffuse n exported from hru n t k g is the accumulative loss of diffuse n n is the number of hru we plotted the cumulative loss curve based on total loss of n fig s3 wei et al 2016 then the areas were divided into 5 levels based on the percentage of cumulative loss of n in each hru the majority 80 of n losses originate from a small proportion of catchment area a situation known as the 80 20 rule djodjic villa 2015 sharpley et al 2009 therefore we selected areas contributing 80 of cumulative nitrogen loss as the critical source areas which were generally considered to cause non point source pollution and needed to be focused on 2 4 2 fitting the marginal probability distributions the marginal probability distributions of org n and no3 n loss precipitation and temperature were first established using normal log normal gamma weibull and exponential distribution table s2 for those critical source areas we choose the maximum likelihood estimation mle method to obtain the parameters of these candidate functions and generate the corresponding marginal probability distribution functions myung 2003 the akaike information criterion aic and kolmogorov smirnov k s test d were used to compare the effect of distributions using the goodness of fit portet 2020 the smaller the aic and d values the better the fitting effect of the candidates aic and d values were calculated as follows 6 d max ij f x i g y j 7 mse 1 n ij 1 n f x i g y j 2 8 aic 2 k n l n m s e where d is the statistic d in the k s test f x is the empirical distribution function g y is the theoretical distribution function mse is the root mean square error k is the number of estimated parameters in the model and n is the number of observations according to the k s test and aic evaluation gamma and normal distributions were finally selected to describe the marginal distribution characteristics of monthly precipitation maximum temperature org n and nitrate loss fig s4 the fitting degree between the theoretical and empirical cumulative frequency was acceptable therefore the probability distribution of the variables was appropriate 2 4 3 copula function of climate indices precipitation and temperature and n loss there is a certain interdependence between random variables and the occurrence of one event may affect the probability of another variable higher correlation between two variables results in more accurate copula zang et al 2022 based on this we chose spearman rank correlation coefficient to quantify the variable dependency croux dehon 2010 winter et al 2016 and the spearman rank correlation coefficient between the monthly precipitation maximum temperature and nitrogen loss organic nitrogen and nitrate was 0 93 0 81 and 0 82 0 73 which indicated that the copula function could be a good tool for describing the correlation between variables and it was feasible to build a copula function the copula function first proposed by sklar 1973 has been widely used in the frequency analysis of multivariate droughts and floods the copula is a multidimensional joint distribution function with a domain of 0 1 that can connect the marginal distributions of multiple variables without distorting the information the joint distribution f x y can be calculated as 9 f x y p x x y y c Œ∏ f x x f y y where f x x is marginal probability distribution of x f y y is marginal probability distribution of y c is copula function Œ∏ is the parameter of copula common copula functions include the archimedean type frank clayton gumbel elliptical type t gaussian and mixed type plackett in this study three commonly used copulas clayton gumbel and frank copulas were used to fit the distribution and aic and bic information criteria were used to evaluate the goodness of fit 10 c l a y t o n c u 1 u 2 u 1 Œ∏ u 2 Œ∏ 1 1 Œ∏ 11 g u m b e l c u 1 u 2 e x p l n u 1 Œ∏ l n u 2 Œ∏ 1 Œ∏ 12 f r a n k c u 1 u 2 1 Œ∏ l n 1 e Œ∏ u 1 1 e Œ∏ u 2 1 e Œ∏ 1 where c u 1 u 2 is a two dimensional copula function of u 1 u 2 with u 1 f x x u 2 f y y and Œ∏ is a parameter of the copula function 2 4 4 construction framework for nitrogen risk assessment to explore the extreme risk of nitrogen loss under different extreme precipitation and temperature conditions four thresholds for monthly precipitation temperature were selected up 20 10 5 and 1 which represented light moderate severe and extreme high precipitation high temperature conditions respectively after identifying csas prone to diffuse n pollution we set the conditions for mild moderate severe and extreme diffuse n pollution to occur when the n loss exceeded 80 90 95 and 99 of historical loss data the threshold of org n or nitrate pollution was determined to be 20 10 5 and 1 representing light moderate severe and extreme pollution conditions respectively we then analyzed the probability of nitrogen loss at different thresholds and precipitation or temperature exceeded four thresholds which can be expressed as follows x x i y y j where x is the n loss y is the climate factor precipitation or temperature i and j are the four thresholds 20 10 5 and 1 x i and y j are the values of the factors at thresholds i and j therefore the joint and marginal probability p 1 and p 2 is calculated as follows 13 p 1 f x x i y y j 1 f x x f y y c u 1 u 2 14 p 2 f x x i 1 f x x where p 1 is the probability of nitrogen loss exceeding the threshold in extreme climate conditions p 2 is the probability of nitrogen loss exceeding the threshold p 1 p 2 means the proportion of events associated with climate extremes in total high loss events in this case p 1 of event can be defined as risk when x exceeds a certain threshold the larger the p 1 the greater the probability of the simultaneous occurrence of events that is the greater the risk of high nitrogen loss under extreme conditions the larger the p 2 the greater the probability of event in which nitrogen loss exceeds the set threshold the larger the p 1 p 2 the greater the proportion of events related to extreme climate in all high loss events 2 5 extreme climate indices considering the multiple aspects of climate change we adopted eight temperature precipitation dependent extreme indices established by the expert team on climate change detection and indices etccdi sillmann et al 2013 as well as two climate indices normal precipitation and temperature to investigate the impacts of climate change on n table 1 these indices have been widely used at regional continental and global scales and are generated based on daily precipitation and maximum minimum temperature data the base period is 1971 2000 2 6 statistical analysis we used the lindeman merenda gold lmg method to quantify the relative importance of the 10 climate change indices to the nitrogen loss at each hru li et al 2021 this method avoids the order effect of regression variables and thereby quantifies the relative importance or contribution of each explanatory variable to the dependent variable fern√°ndez mart√≠nez et al 2014 the dominant climatic driver of the organic nitrogen and nitrate loss of an hru was defined as the one with the largest relative importance score among these indices in addition we chose the unitary linear regression method to evaluate the linear trend of nitrogen loss over time and used the mann kendall mk test for significance tests in the time series the statistical significance of the linear trend was assessed at a 95 confidence level mk 1 96 yue wang 2004 3 results 3 1 spatiotemporal distribution of the organic nitrogen and nitrate loss the variation in different formats of the nitrogen loss of the umwb was analyzed from 1971 to 2020 fig 3 we found that the annual average organic nitrogen org n and nitrate loss were 0 62 kg ha and 2 04 kg ha the loss of nitrate from surface runoff lateral flow and groundwater accounted for 9 90 6 and 0 4 respectively the org n loss of the basin increased at a rate of 13 g ha year whereas the nitrate loss decreased significantly by 20 g ha per year p 0 05 the monthly analysis showed that the nitrogen loss was mainly concentrated from june to october accounting for 87 of the annual loss and the nitrogen loss was dominated by the nitrate loss fig 3b the correlation results showed that there was a significant positive correlation between nitrogen loss and precipitation the correlation between org n loss and precipitation was the strongest the same results were also observed in the analysis of the water yield and sediment the correlation between temperature and org n loss was not obvious whereas there was a significant negative correlation with the nitrate loss spatially the org n loss ranged from 0 to 5 8 kg ha with higher values observed in the southwestern area and lower values in the eastern region fig s5 the org n loss showed an upward trend in approximately 63 of the basin and the increasing trend in 21 of the areas passed the significance test the regions with decreasing nitrate loss were mainly located in the middle and headwaters of the umwb and the proportions of areas with significant and insignificant trends were 31 and 41 respectively in addition the nitrate loss was highest in cropland followed by forest and grassland 3 2 impacts of monthly precipitation and temperature on nitrogen loss in different forms the monthly precipitation or maximum temperature data from 1971 to 2020 were divided into three categories to explore the impact of climate change on the nitrogen loss on a monthly scale the high precipitation period indicates precipitation of the first 20th percentile of the base period p1 the common precipitation period experienced precipitation between the 20th and 80th percentile of the base period p2 and the low precipitation period was the precipitation of the last 20th percentile p3 the monthly temperature was divided similarly corresponding to t1 t2 and t3 the variations in org n and no3 n for different precipitation periods are shown in fig 4 org n and nitrate accounted for 96 and 74 of the overall loss respectively during the sufficient precipitation period p1 the analysis of the correlation between org n and precipitation during p1 p3 showed that the org n loss was positively correlated with precipitation and precipitation had the strongest control effect during p1 although nitrate was the main nitrogen loss under the three conditions the proportion of organic nitrogen loss increased with an increase in precipitation from 1 under p3 to 35 during p1 the relationship between nitrogen loss and the temperature was more complex fig 4d and e during t2 and t3 org n and nitrate increased with temperature whereas temperature was negatively correlated with the nitrogen loss during t1 we classified the org n loss into three main land use types and found that cropland had the highest org n loss followed by grassland during the high precipitation period fig s6 the spatial distribution showed that when the temperature was high the headwater and middle area of the basin were the main nitrogen contributing areas after the temperature decreased only the headwater area exhibited a higher nitrogen loss 3 3 dominant climatic drivers to nitrogen loss the lmg method was applied to quantify the relative importance scores ris of 10 climate change indices affecting the org n loss for each hru fig s7 the riss of the different climatic indices showed spatial heterogeneity the highest riss of extreme precipitation indices r95p and r20mm were in the western part of the basin and the pdf showed that the riss of these indices in grassland and cropland were higher than those in the forest we further generated a dominance map of climatic drivers on the org n loss based on the riss map over the umwb fig 5 a and b overall the extreme precipitation amount r95p was the most important climatic driver that positively affected the org n loss of the entire basin accounting for 82 r95p dominated 98 of the org n loss in cropland and grasslands for different ecosystems in forest the dominant areas of tx90p and r95p were similar accounting for 45 of the total area the spatial distribution of riss in influencing no3 n loss for the hru showed that the high tx90p was mainly distributed in the western region whereas those of r95p were primarily concentrated in the eastern part fig s8 based on the riss map we found that extreme precipitation r95p normal precipitation amount and cdd were the most important climatic drivers accounting for 35 32 and 13 respectively fig 5 r95p was mainly distributed over the eastern regions normal precipitation was concentrated in the middle and southwest of the basin and cdd was mostly found in the northwest area in addition areas dominated by precipitation were larger than those dominated by temperature indices suggesting that nitrate loss s may be more sensitive to precipitation indices dtr was another notable index dominating over 20 of the nitrate loss in the forest in grassland normal precipitation amounts played a substantially dominant role in the nitrate loss with a total dominant area proportion of 54 3 4 risk analysis for nitrogen pollution based on bivariate copula model hrus with risk of n loss were firstly identified as csas using traditional method fig s9 we found that csas were mainly concentrated in cropland with the least amount in grassland then the risk of nitrogen loss under extreme climate conditions was further analyzed in these csas using copula function based on the aic and bic results the frank and clayton functions were selected as joint distribution functions table 2 visual analysis showed that the contour lines of the joint distribution for precipitation and nitrogen loss were very dense at low precipitation intervals 50 mm indicating that the variation in probability was greatly affected by precipitation fig 6 the changes in temperature and nitrogen loss showed that at low nitrogen loss intervals the contour lines were dense indicating that the probability change was significantly affected by n loss based on the marginal probability p 2 corresponding to each threshold the probability of nitrogen loss under the defined meteorological conditions p 1 was calculated and the p 1 p 2 was also calculated to show the proportion of events associated with climate extremes in total high loss events fig 7 the results showed that with the variation in the organic nitrogen loss threshold there was a significant difference in the probability of nitrogen loss exceeding the threshold when precipitation was in the top 20 the probability of the org n loss exceeding the thresholds of 20 10 5 and 1 were 0 15 0 1 0 03 and 0 002 respectively the probability of an org n loss under the top 20 and 10 thresholds of temperature was lower than that under the same threshold of precipitation in comparison the risk was much higher when the temperature conditions were extreme fig 7b we also compared the conditional and total risks of org n pollution under the same extreme threshold fig 7e although the probability exceeding the 1 threshold was the lowest it accounted for the highest proportion of the total risk the top 1 20 high org n loss probability under the top 20 precipitation condition accounted for 77 75 63 and 46 of the total probability respectively spatial analysis showed that the probability in the headwater area and area near the outlet of the basin was high indicating that high precipitation and temperature increased the pollution risk in these areas fig s10 when no3 n exceeded the top 20 and 10 thresholds the risk of nitrate loss under specific precipitation thresholds was lower than that of organic nitrogen however the pollution risk was greater when no3 n exceeded the top 5 and 1 thresholds fig 7c the risk accounted for 32 36 under the top 20 temperature condition and 16 19 under the top 1 temperature of the total risk of nitrate pollution fig 7h the spatial risk map can provide information about which regions are more sensitive to the pressure of nitrate loss when meteorological factors occur at a specific severity fig s11 the risk in cropland was higher than that in forest and grassland under the nitrate loss which indicated that the nitrate loss was more vulnerable to increased precipitation and temperature in cropland 4 discussion 4 1 effects of climate on organic nitrogen and nitrate loss the migration and transformation of diffuse pollutants are mainly driven by the hydrological cycle and influenced by climate conditions land use co2 concentration and other factors dunn et al 2012 the correlation analysis showed that annual nitrogen loss was positively correlated with precipitation water yield and sediment which is supported by previous studies zhang et al 2020 xia et al 2020 we found that no3 n loss accounted for 73 of the total loss and org n accounted for 27 indicating that nitrate was the main nitrogen source in this area ji et al 2021 also demonstrated higher nitrate content in the wei river basin and the major sources of nitrate in water were chemical fertilizers and soil organic n the monthly variation showed that nitrogen loss was mainly concentrated in summer and autumn in winter nitrogen accumulates in the soil owing to soil frost and lack of runoff combined with low application leading to lower nitrogen loss in this season in cropland excess nitrogen leaches into the water body because of artificial fertilization resulting in the highest no3 n huang et al 2017 forest had the lowest org n but it had more no3 n than grassland forest residue is easily degraded by microorganisms which may lead to a diffuse nitrate potential in forest watersheds gorsevski et al 2008 ouyang et al 2022 our analysis showed that the increase in org n in the extreme wet period was more intense than in other precipitation conditions as adsorbed nitrogen org n is easily adsorbed by soil colloids and lost through soil erosion ouyang et al 2017 high precipitation and abundant soil water were more likely to generate runoff and more nitrogen was removed when the temperature rises microbial activity is stimulated and the related chemical reaction i e mineralization and nitrification rate increases leading to increased n storage in the soil layer and nitrogen loss however when the temperature was too high the denitrification efficiency and efficiency of n absorption by the plants increased which could reduce the nitrogen loss veraart et al 2011 we also found that the condition of underlying surface was also a key factor affecting the spatial distribution of n loss xing et al 2016 under high temperature condition the nitrogen loss in headwater areas with high slope and middle areas where cropland is concentrated were high at low temperatures even if n input was less nitrogen in headwater areas was more likely to migrate because of steep slope so n loss was larger than that in middle basin 4 2 influence and driving factors of extreme climate indices on diffuse nitrogen loss based on the lmg method the factors related to extreme precipitation dominated the loss of org n in nearly 80 of the basin especially in cropland and grassland highlighting the high sensitivity of org n variation to precipitation fluctuation in water deficient regions the enhancement of the summer monsoon brings more extreme precipitation with a higher frequency and intensity to the monsoon region such as our study area which can greatly promote org n loss freychet et al 2015 forest could intercept the precipitation through the canopy litter and root layers to improve the soil erosion resistance so the proportion of areas where precipitation is the driving factor was small du et al 2019 extremely high temperatures are an important driving factor in forest the forest might rely on the death of animals and plants to supplement the organic nitrogen pool therefore an increase in temperature would accelerate biodegradation and increase organic nitrogen philben et al 2016 organic nitrogen with high bioavailability is an important link between the nutrient cycle and life processes in water bodies zhu et al 2019 the degradation of excess org n consumes more oxygen and releases inorganic n affecting nutrient conversion and destroying healthy ecosystems in addition to heavy precipitation cdd is an important driving factor in cropland mainly contributing negatively long term precipitation reduces soil water and intensifies water stress which may slow material migration the driving force for extreme precipitation events is relatively high compared with temperature events although the impact of extremely high temperatures is relatively small the temperature is the decisive factor in the eutrophication of water bodies most water blooms occur during periods of high temperature and strong light which may still cause serious water pollution zhao et al 2022 the cmip6 model predicted that under different ssp scenarios more frequent and intense extreme events would cause a greater proportion of pollution in the future almazroui et al 2021 our study area is semi arid and the limited water quantity would be further reduced by water pollution which might cause more severe water stress than in humid areas mateo sagasta et al 2018 more effective nutritional management interventions are needed to reverse this trend 4 3 implications for pollution risk assessment and uncertainty analysis traditional identification method for critical source area is a compromise solution to determine the csa because it mainly focuses on the annual diffuse n loss and mainly reflects the comprehensive influence of various factors on spatial distribution collick et al 2015 our results showed that extreme climates promoted the loss of n indicating that it is necessary to pay attention to the emission of nitrogen under extreme conditions mellander et al 2018 however traditional method could not adequately reflect area with potential high n loss under extreme precipitation and temperature conditions which might implement relevant control measures inadequately based on this we chose copula function to analyze the probability of bivariate data exceeding the threshold we found that the headwater and lower basin sections had the greatest pollution risk under different precipitation conditions which might be related to human activities and terrain characteristics agricultural measures in cropland and steeper slopes in headwater areas have made the nitrogen loss more affected by climate mamun et al 2020 high temperatures stimulated soil nitrogen mineralization and promoted soil nitrification by increasing the environmental oxidation capacity it has been reported that nitrate loss intensity is extremely sensitive to high temperatures and regions with annual average temperatures higher than 10 c have a higher risk of nitrogen loss meyer et al 2018 it should be emphasized that nitrogen pollution in cropland with many artificial measures was easily affected by high precipitation and temperature since 2000 land use in the chinese loess plateau has changed greatly because of the large scale ecological restoration program e g the grain for green program which has alleviated the loss of n compared with cropland forest and grassland have a stronger water and soil conservation capacity which could make the nitrogen elements better intercepted resulting in less risk hu et al 2021 furthermore from the probability ratio analysis we found that 7 77 of the high loss risks were caused by extreme weather which further explained the importance of extreme meteorological factors therefore management should prioritize the control measures in these high risk areas when extreme events occur to prevent threats to the water environment because of extreme climate conditions the risk assessment for nitrogen loss by copulas in this study also had some uncertainties in addition to climatic factors variations in the water environment are affected by various factors in future studies we need to identify the influencing factors including hydrology land use and human activities and the uncertainty of their impact on water security in basins to obtain more reasonable results and support actual risk management decisions furthermore our risk assessment method only considers monthly data not daily data this assumption may underestimate the nitrogen loss risk caused by high precipitation and temperature therefore our method can be treated as a lower estimation bound of the risk of real world nitrogen loss induced by climate a more detailed assessment merits further analysis 5 conclusion in this study the dominant climatic drivers for different forms of nitrogen loss in the umwb were identified and the pollution risk under different climate conditions was quantified based on swat and copulas during the past 50 years 1971 2020 the nitrate loss decreased at an average rate of 0 02 kg ha year whereas the organic nitrogen loss increased during the study period the loss of org n was highest under sufficient precipitation conditions mainly in cropland and grassland the results of the correlation analysis showed that precipitation and nitrogen loss had a nonlinear positive correlation whereas the correlation between temperature and nitrogen loss was more complex under different climate conditions in this semi arid basin the org n loss was mainly driven by high precipitation r95p and the control area accounted for 82 tx90p is also more important than the other drivers especially in forest regarding nitrate loss r95p normal precipitation amount and cdd were the most important climatic drivers finally after identifying critical source areas prone to diffuse pollution this study quantified the risk of pollution in basin under extreme climatic conditions with four thresholds from the new perspective of considering the combined effects of climate factors and nitrogen loss the probabilities of org n and nitrate loss exceeding the top 1 20 were 0 2 15 and 0 8 10 when the precipitation exceeded the top 20 given the future changing climate and enhanced hydroclimatic extreme events the methods provided in this study have implications for watershed nitrogen management and eutrophication reduction declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the present work was financially supported by the key project of national natural science foundation of china 52239005 the fund for innovative research group of the national natural science foundation of china 52221003 and national natural science foundation of china 42271326 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129412 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2028,climate change is a key factor that profoundly affects aquatic environments because of climate warming the increase in the intensity and frequency of extreme climate events has aggravated the uncertainty of nitrogen pollution however the risk of nitrogen loss under different climatic conditions has not been well assessed which is of great significance for controlling diffuse pollution in this study we used the upper and middle wei river basin umwb as the study area and selected organic nitrogen org n and nitrate no3 n as the two forms of nitrogen pollution then we quantified the contributions of 10 climate factors and combined the soil and water assessment tool swat and copula to analyze the risk of pollution when extreme weather occurs our results showed that during periods of high precipitation and temperature org n loss accounted for 96 and 83 of the total loss and nitrate loss accounted for 74 and 67 respectively org n loss responded more strongly to high precipitation than nitrate loss because org n was transported with soil particles the attribution analysis indicated that high precipitation amount r95p contributed to the largest org n loss as for the nitrate loss r95p normal precipitation amount and consecutive days with no precipitation were the most important climatic drivers accounting for 35 32 and 13 of the watershed area respectively after selecting critical source areas by identification method an optimized copula model for nitrogen loss and the main climatic factors was proposed the risk of nitrogen pollution under the defined climate severity was then quantified the probabilities of org n and nitrate loss exceeding the top 1 20 were 0 2 15 and 0 8 10 when the precipitation exceeded the top 20 the pollution risk caused by high temperatures is lower than that caused by precipitation this study emphasized the dominant role of extreme climate in driving nitrogen loss and proposed a method for quantifying the risk of nitrogen pollution under specific climate conditions which enabled managers to identify high risk pollution areas and optimize management measures to prevent diffuse nitrogen pollution keywords extreme climate diffuse pollution different forms of nitrogen risk assessment copula analysis data availability data will be made available on request 1 introduction nitrogen n is a primary nutrient for plants and a key substance in water eutrophication and increasingly serious n pollution has become a global concern camargo alonso 2006 subbarao searchinger 2021 nitrogen in water mainly comes from chemical fertilizers soil nitrogen sources and atmospheric sedimentation thomazo et al 2018 as the main component of inorganic nitrogen nitrate is easily absorbed by aquatic plants algae and bacteria which can accelerate eutrophication and endanger human health gilliam et al 2019 excess organic nitrogen consumes a large amount of oxygen when used by organisms which promotes the formation of anoxic zones in water bodies zhu et al 2020 wannicke et al 2018 since the middle of the last century researchers have proved that nitrogen loss is the final product of the interaction of terrestrial biogeochemistry atmosphere surface exchange hydrology and land management in which the frequency and intensity of climate factors are the main driving factors wu et al 2012 shields et al 2008 hu et al 2019 the assessment report of the intergovernmental panel on climate change ipcc ar6 reported that global warming has caused extreme climate conditions to undergo drastic changes and these slight changes may have profound impacts on the physical and chemical properties of substances in the basin masson delmotte et al 2021 zhang et al 2021 understanding the response of land to aquatic nitrogen loading to climate events is critical in addition to human activities climate change is one of the major factors affecting the physical migration and chemical transformation processes of nitrogen as a nitrogen carrier runoff provides power for the migration of nitrogen loss chen et al 2021 precipitation infiltrates the soil to generate runoff and erodes nitrogen rich soil fines causing disproportionate loss of dissolved nitrogen nitrate and absorbed nitrogen organic nitrogen in the soil ao et al 2019 keene et al 2002 worsfold et al 2008 in addition higher soil water content results in changes in dissolved oxygen content which may affect nitrogen mineralization and nitrification stoliker et al 2016 hutchins et al 2020 temperature can regulate the chemical reaction rate and microbial and biological activities by influencing nitrogen conversion li et al 2019 with an increase in temperature nitrogen mineralization and nitrification rates increase and the uptake of inorganic nitrogen by plants increases leading to more complex results blecken et al 2010 many studies have been conducted on the relationship between nitrogen loss and climate factors sinha et al 2017 tian et al 2020 ballard et al 2019 although these two climate factors can measure climate change to a certain extent these simple indices may not fully reflect the characteristics of climate change particularly the frequency intensity or duration of extreme conditions which could play an important role in enhancing nitrogen pollution carpenter et al 2018 zhang et al 2021 most existing studies have not disentangled the contributions of extreme events versus normal climate factors and the relative importance of specific climate drivers to nitrogen pollution in different formats has not been well described quantifying the importance of extreme events and normal climate factors on nitrogen loss and selecting the dominant factors would allow managers to pay more attention to extreme climate changes and take countermeasures in advance this has theoretical significance for understanding the driving effects of climate change on nitrogen loss and has practical significance for prevention and control of diffuse pollution due to spatial heterogeneity in topography land use soil and human activities nitrogen loss are spatially inhomogeneous most of the n loss comes from a small portion of the watershed known as the critical source area csa pionke et al 2000 csas were not only the main output unit of non point source pollutants in watershed but also important hydrological sensitive areas where surface and subsurface runoff mobilize and transfer n from terrestrial to reach niraula et al 2013 heathwaite et al 2005 this method can identify areas with high risk of diffuse n pollution which is the basis for sustainable watershed development and management however the traditional csa method can only assess the areas with high n loss separately when extreme weather occurs it is difficult to fully reflect the variation characteristics under extreme climate conditions and could reduce the accuracy of the risk assessment peng et al 2020 wang et al 2019 considering the increasing frequency and intensity of extreme climate events more detailed and accurate investigations are required therefore it is necessary to explore nitrogen loss under extreme weather conditions to improve the accuracy of pollution risk assessment simple correlation analysis may not fully capture the relationship between the tail part of climate data i e extreme conditions and diffuse n loss because of the complex biogeochemical cycles in aquatic and terrestrial environments collins mcgonigle 2008 mamun et al 2020 as an important method to study multivariate joint probability distribution the copula function has been gradually used to study the combined distribution of hydrological drought and other variables tahroudi et al 2020 zang et al 2022 saghafian mehdikhani 2013 the main advantage of the copula function is that any marginal probability distribution can be built into a joint distribution model to describe the nonlinear and asymmetric relationships between variables without distorting the information contained in the random variables durante sempi 2015 besides copula function can also describe the relationship between the tail values of two sets of data very well zscheischler et al 2017 therefore we chose copula function to construct the joint distribution of climate and nitrogen loss and finally analyze the probability of variables exceeding the threshold when constructing the copula function although limited measurement data can be used to build the copula more data would improve the fitting degree of the data distribution characteristics and the accuracy of description for actual situation mansour et al 2020 due to the sparse distribution traditional monitoring data cannot support spatially analysis in a watershed and cannot overcome the inherent spatial and temporal heterogeneities in hydrological connectivity and climate variability niraula et al 2011 researchers have developed many long time distributed and physically based models to solve this problem which have become widely used methods to simulate hydrological processes sediment yield and nutrients demb√©l√© et al 2020 singh 2018 among them the soil and water assessment tool swat with hydrological response unit hru discretization based on topography climate land cover and soil type attributes is an efficient model to simulate the spatiotemporal distribution of natural loss processes of nitrogen meshesha et al 2020 therefore we applied the swat simulation results to a copula function to analyze how to identify priority management intervals i e areas with high risk under extreme weather conditions prone to diffuse nitrogen pollution which is conducive to better nitrogen management and assessment many measures and regulations have been taken to deal with excessive diffuse n loss but these measures may not achieve the desired effect if the impact of extreme climate is not considered combining swat and copulas to quantify probability of nitrogen loss exceeding specific thresholds under extreme climate conditions is an application to assess the risk of diffuse n pollution from a new perspective the specific objectives of our study were to 1 analyze the spatiotemporal characteristics of organic nitrogen org n and nitrate loss no3 n during typical climate periods and identify the main climatic drivers 2 identify the critical source areas generate the marginal probability distribution of variables for these csas by parameter estimation and fit evaluation and then construct a copula model for climate factors and nitrogen loss and 3 quantify the diffuse pollution risk under extreme climate conditions with four specific thresholds in a typical semi arid watershed in northwestern china using this method can help avoid the limitation of existing pollution control management which only considers nitrogen variables and ultimately provides more objective and accurate information for effectively protecting and managing the water environment under climate change 2 materials and methods 2 1 study area description the wei river which is 828 km long is the largest tributary of the yellow river our study area is in the upper and middle wei river basin wrb with an area of 515 000 km2 accounting for 38 of the wrb fig 1 the elevation of the upper and middle wei river basin umwb ranges from 352 m in the eastern region to 3903 m in the west the average precipitation from 1971 to 2020 was 546 5 mm and the average annual temperature was approximately 10 2 there are three major land use types in this region cropland 40 forest 31 and grassland 24 fig s1 the serious soil erosion caused by precipitation with a short duration and high intensity in summer and a large amount of fertilization from cropland caused diffuse pollution and water pollution in this basin 2 2 data collection the meteorological data used in this study included the daily maximum and minimum temperatures precipitation wind speed solar radiation and relative humidity climate data were collected from 11 meteorological stations between 1961 and 2020 by the china meteorological administration cma https data cma cn a 90 90 m shuttle radar topography mission srtm digital elevation model dem was used to extract the flow direction and accumulation create streams delineate the watershed and calculate the sub basin parameters land use data for the year 2017 30 m 30 m were provided by the national earth system science data center https www geodata cn and soil data at a scale of 1 1 000 000 were provided by the environmental and ecological science data center for west china https westdc westgis ac cn the monthly streamflow data observed from 2007 to 2020 at the xianyang hydrological station were obtained from the yellow river water resources commission https www yrcc gov cn the concentration of total nitrogen tn data 2018 2020 at the xianyangtieqiao monitoring station was obtained from a water quality monitoring station point source pollution livestock and poultry breeding and agricultural management measures crop types and fertilizer application were obtained from the shaanxi gansu and ningxia statistical yearbook https www yearbookchina com index aspx 2 3 model setup calibration and validation the swat was developed by the united states department of agriculture agricultural research service usda ars and has been widely used to project the impact of climate change and land use and cover change on water sediment and chemical components arnold et al 2012 the hydrological components in swat are based on the water balance equation gassman et al 2007 1 sw t s w i 1 t r i q i et i p i ql i where sw is the soil water content i is the time t days for the simulation period r mm q mm et mm p mm and ql mm are the daily amounts of precipitation surface runoff evapotranspiration percolation and subsurface lateral flow respectively the hru the basic unit in swat is defined as a unique aggregation of land use soil properties and terrain slopes in swat nitrogen may be added to the soil by fertilizer manure or residue application fixation by symbiotic or nonsymbiotic bacteria and rain nitrogen is removed from the soil by plant uptake leaching volatilization denitrification and erosion the nitrogen mass balance equation 2 Œ¥ n n app n atm n fix n up n leach n denit n volat n ero where n app is n in fertilizer manure or residue application n atm is atmospheric n deposition n fix is n fixated by symbiotic or nonsymbiotic bacteria n up is plant uptake n n leach is n exported by leaching n denit is n removed by denitrification n volat is n removed by volatilization n ero is n exported by erosion in our research nitrogen loss indicated the dissolved nitrogen and adsorbed nitrogen transported out of the hru to main channel which might cause non point source pollution epelde et al 2015 arnold et al 2012 organic n attached to soil particles may be transported out of the hru to the main channel because retention of nitrate by soils is minimal nitrate is very susceptible to leaching the algorithms used by swat to calculated nitrate leaching simultaneously solve for loss of nitrate in surface runoff and lateral flow also besides groundwater flow entering the main channel from the shallow aquifer can contain nitrate nitrate loss could be calculated as follows 3 no 3 n s u r q n l a t q no 3 g w where no 3 k g h a is nitrate transported with runoff from the hru into the reach during the time step nsurq k g h a is nitrate transported out of the hru with surface runoff into the reach during the time step nlatq k g h a is nitrate transported out of the hru with lateral flow into the reach during the time step no 3 g w k g h a is nitrate transported into main channel in the groundwater loading from the hru we delineated the umwb into 93 subbasins and 1404 hrus and calibrated the model based on monthly streamflow and tn using the swat cup calibration and uncertainty procedures with the sequential uncertainty fitting version 2 sufi 2 algorithm kumar et al 2017 fig 2 we used swat cup to identify the set of parameters based on the sensitivity analysis and generate the optimized values of the parameters table s1 finally we used numerical criteria to evaluate model performance including the nash sutcliffe efficiency nse coefficient of determination r2 and percentage bias pbias supplementary doc although there were two underestimated i e 2013 and 2018 peak flows during years with extreme water quantities the monthly streamflow simulations corresponded well with observations in addition the performance of the sediment simulation was acceptable fig s2 as for the tn simulation the evaluation showed that the nse was above 0 55 r2 was above 0 75 and pbias was lower than 25 based on the performance ratings given by donizete et al 2016 moriasi 2007 our simulations were evaluated as good for streamflow and sediment simulation and satisfactory for tn simulation 2 4 framework for risk assessment the processes for diffuse nitrogen pollution i e org n and no3 n analysis considering the joint distribution of climatic variables i e precipitation and temperature are summarized as follows a identify the spatial distribution of the critical source areas at hru scale b constructing marginal probability distributions for these critical source areas c constructing a copula model and d establishing conditions where the precipitation temperature exceeds specific thresholds to analyze and assess the corresponding n loss risk in the umwb 2 4 1 identifying the critical source areas after analyzing the nitrogen loss of each hru the total loss of n was calculated as follows 4 n ti n i a i 5 n t i 1 n n ti where n i k g h a is the loss intensity of n in hru i a i h a is the area of the hru n ti k g is the total diffuse n exported from hru n t k g is the accumulative loss of diffuse n n is the number of hru we plotted the cumulative loss curve based on total loss of n fig s3 wei et al 2016 then the areas were divided into 5 levels based on the percentage of cumulative loss of n in each hru the majority 80 of n losses originate from a small proportion of catchment area a situation known as the 80 20 rule djodjic villa 2015 sharpley et al 2009 therefore we selected areas contributing 80 of cumulative nitrogen loss as the critical source areas which were generally considered to cause non point source pollution and needed to be focused on 2 4 2 fitting the marginal probability distributions the marginal probability distributions of org n and no3 n loss precipitation and temperature were first established using normal log normal gamma weibull and exponential distribution table s2 for those critical source areas we choose the maximum likelihood estimation mle method to obtain the parameters of these candidate functions and generate the corresponding marginal probability distribution functions myung 2003 the akaike information criterion aic and kolmogorov smirnov k s test d were used to compare the effect of distributions using the goodness of fit portet 2020 the smaller the aic and d values the better the fitting effect of the candidates aic and d values were calculated as follows 6 d max ij f x i g y j 7 mse 1 n ij 1 n f x i g y j 2 8 aic 2 k n l n m s e where d is the statistic d in the k s test f x is the empirical distribution function g y is the theoretical distribution function mse is the root mean square error k is the number of estimated parameters in the model and n is the number of observations according to the k s test and aic evaluation gamma and normal distributions were finally selected to describe the marginal distribution characteristics of monthly precipitation maximum temperature org n and nitrate loss fig s4 the fitting degree between the theoretical and empirical cumulative frequency was acceptable therefore the probability distribution of the variables was appropriate 2 4 3 copula function of climate indices precipitation and temperature and n loss there is a certain interdependence between random variables and the occurrence of one event may affect the probability of another variable higher correlation between two variables results in more accurate copula zang et al 2022 based on this we chose spearman rank correlation coefficient to quantify the variable dependency croux dehon 2010 winter et al 2016 and the spearman rank correlation coefficient between the monthly precipitation maximum temperature and nitrogen loss organic nitrogen and nitrate was 0 93 0 81 and 0 82 0 73 which indicated that the copula function could be a good tool for describing the correlation between variables and it was feasible to build a copula function the copula function first proposed by sklar 1973 has been widely used in the frequency analysis of multivariate droughts and floods the copula is a multidimensional joint distribution function with a domain of 0 1 that can connect the marginal distributions of multiple variables without distorting the information the joint distribution f x y can be calculated as 9 f x y p x x y y c Œ∏ f x x f y y where f x x is marginal probability distribution of x f y y is marginal probability distribution of y c is copula function Œ∏ is the parameter of copula common copula functions include the archimedean type frank clayton gumbel elliptical type t gaussian and mixed type plackett in this study three commonly used copulas clayton gumbel and frank copulas were used to fit the distribution and aic and bic information criteria were used to evaluate the goodness of fit 10 c l a y t o n c u 1 u 2 u 1 Œ∏ u 2 Œ∏ 1 1 Œ∏ 11 g u m b e l c u 1 u 2 e x p l n u 1 Œ∏ l n u 2 Œ∏ 1 Œ∏ 12 f r a n k c u 1 u 2 1 Œ∏ l n 1 e Œ∏ u 1 1 e Œ∏ u 2 1 e Œ∏ 1 where c u 1 u 2 is a two dimensional copula function of u 1 u 2 with u 1 f x x u 2 f y y and Œ∏ is a parameter of the copula function 2 4 4 construction framework for nitrogen risk assessment to explore the extreme risk of nitrogen loss under different extreme precipitation and temperature conditions four thresholds for monthly precipitation temperature were selected up 20 10 5 and 1 which represented light moderate severe and extreme high precipitation high temperature conditions respectively after identifying csas prone to diffuse n pollution we set the conditions for mild moderate severe and extreme diffuse n pollution to occur when the n loss exceeded 80 90 95 and 99 of historical loss data the threshold of org n or nitrate pollution was determined to be 20 10 5 and 1 representing light moderate severe and extreme pollution conditions respectively we then analyzed the probability of nitrogen loss at different thresholds and precipitation or temperature exceeded four thresholds which can be expressed as follows x x i y y j where x is the n loss y is the climate factor precipitation or temperature i and j are the four thresholds 20 10 5 and 1 x i and y j are the values of the factors at thresholds i and j therefore the joint and marginal probability p 1 and p 2 is calculated as follows 13 p 1 f x x i y y j 1 f x x f y y c u 1 u 2 14 p 2 f x x i 1 f x x where p 1 is the probability of nitrogen loss exceeding the threshold in extreme climate conditions p 2 is the probability of nitrogen loss exceeding the threshold p 1 p 2 means the proportion of events associated with climate extremes in total high loss events in this case p 1 of event can be defined as risk when x exceeds a certain threshold the larger the p 1 the greater the probability of the simultaneous occurrence of events that is the greater the risk of high nitrogen loss under extreme conditions the larger the p 2 the greater the probability of event in which nitrogen loss exceeds the set threshold the larger the p 1 p 2 the greater the proportion of events related to extreme climate in all high loss events 2 5 extreme climate indices considering the multiple aspects of climate change we adopted eight temperature precipitation dependent extreme indices established by the expert team on climate change detection and indices etccdi sillmann et al 2013 as well as two climate indices normal precipitation and temperature to investigate the impacts of climate change on n table 1 these indices have been widely used at regional continental and global scales and are generated based on daily precipitation and maximum minimum temperature data the base period is 1971 2000 2 6 statistical analysis we used the lindeman merenda gold lmg method to quantify the relative importance of the 10 climate change indices to the nitrogen loss at each hru li et al 2021 this method avoids the order effect of regression variables and thereby quantifies the relative importance or contribution of each explanatory variable to the dependent variable fern√°ndez mart√≠nez et al 2014 the dominant climatic driver of the organic nitrogen and nitrate loss of an hru was defined as the one with the largest relative importance score among these indices in addition we chose the unitary linear regression method to evaluate the linear trend of nitrogen loss over time and used the mann kendall mk test for significance tests in the time series the statistical significance of the linear trend was assessed at a 95 confidence level mk 1 96 yue wang 2004 3 results 3 1 spatiotemporal distribution of the organic nitrogen and nitrate loss the variation in different formats of the nitrogen loss of the umwb was analyzed from 1971 to 2020 fig 3 we found that the annual average organic nitrogen org n and nitrate loss were 0 62 kg ha and 2 04 kg ha the loss of nitrate from surface runoff lateral flow and groundwater accounted for 9 90 6 and 0 4 respectively the org n loss of the basin increased at a rate of 13 g ha year whereas the nitrate loss decreased significantly by 20 g ha per year p 0 05 the monthly analysis showed that the nitrogen loss was mainly concentrated from june to october accounting for 87 of the annual loss and the nitrogen loss was dominated by the nitrate loss fig 3b the correlation results showed that there was a significant positive correlation between nitrogen loss and precipitation the correlation between org n loss and precipitation was the strongest the same results were also observed in the analysis of the water yield and sediment the correlation between temperature and org n loss was not obvious whereas there was a significant negative correlation with the nitrate loss spatially the org n loss ranged from 0 to 5 8 kg ha with higher values observed in the southwestern area and lower values in the eastern region fig s5 the org n loss showed an upward trend in approximately 63 of the basin and the increasing trend in 21 of the areas passed the significance test the regions with decreasing nitrate loss were mainly located in the middle and headwaters of the umwb and the proportions of areas with significant and insignificant trends were 31 and 41 respectively in addition the nitrate loss was highest in cropland followed by forest and grassland 3 2 impacts of monthly precipitation and temperature on nitrogen loss in different forms the monthly precipitation or maximum temperature data from 1971 to 2020 were divided into three categories to explore the impact of climate change on the nitrogen loss on a monthly scale the high precipitation period indicates precipitation of the first 20th percentile of the base period p1 the common precipitation period experienced precipitation between the 20th and 80th percentile of the base period p2 and the low precipitation period was the precipitation of the last 20th percentile p3 the monthly temperature was divided similarly corresponding to t1 t2 and t3 the variations in org n and no3 n for different precipitation periods are shown in fig 4 org n and nitrate accounted for 96 and 74 of the overall loss respectively during the sufficient precipitation period p1 the analysis of the correlation between org n and precipitation during p1 p3 showed that the org n loss was positively correlated with precipitation and precipitation had the strongest control effect during p1 although nitrate was the main nitrogen loss under the three conditions the proportion of organic nitrogen loss increased with an increase in precipitation from 1 under p3 to 35 during p1 the relationship between nitrogen loss and the temperature was more complex fig 4d and e during t2 and t3 org n and nitrate increased with temperature whereas temperature was negatively correlated with the nitrogen loss during t1 we classified the org n loss into three main land use types and found that cropland had the highest org n loss followed by grassland during the high precipitation period fig s6 the spatial distribution showed that when the temperature was high the headwater and middle area of the basin were the main nitrogen contributing areas after the temperature decreased only the headwater area exhibited a higher nitrogen loss 3 3 dominant climatic drivers to nitrogen loss the lmg method was applied to quantify the relative importance scores ris of 10 climate change indices affecting the org n loss for each hru fig s7 the riss of the different climatic indices showed spatial heterogeneity the highest riss of extreme precipitation indices r95p and r20mm were in the western part of the basin and the pdf showed that the riss of these indices in grassland and cropland were higher than those in the forest we further generated a dominance map of climatic drivers on the org n loss based on the riss map over the umwb fig 5 a and b overall the extreme precipitation amount r95p was the most important climatic driver that positively affected the org n loss of the entire basin accounting for 82 r95p dominated 98 of the org n loss in cropland and grasslands for different ecosystems in forest the dominant areas of tx90p and r95p were similar accounting for 45 of the total area the spatial distribution of riss in influencing no3 n loss for the hru showed that the high tx90p was mainly distributed in the western region whereas those of r95p were primarily concentrated in the eastern part fig s8 based on the riss map we found that extreme precipitation r95p normal precipitation amount and cdd were the most important climatic drivers accounting for 35 32 and 13 respectively fig 5 r95p was mainly distributed over the eastern regions normal precipitation was concentrated in the middle and southwest of the basin and cdd was mostly found in the northwest area in addition areas dominated by precipitation were larger than those dominated by temperature indices suggesting that nitrate loss s may be more sensitive to precipitation indices dtr was another notable index dominating over 20 of the nitrate loss in the forest in grassland normal precipitation amounts played a substantially dominant role in the nitrate loss with a total dominant area proportion of 54 3 4 risk analysis for nitrogen pollution based on bivariate copula model hrus with risk of n loss were firstly identified as csas using traditional method fig s9 we found that csas were mainly concentrated in cropland with the least amount in grassland then the risk of nitrogen loss under extreme climate conditions was further analyzed in these csas using copula function based on the aic and bic results the frank and clayton functions were selected as joint distribution functions table 2 visual analysis showed that the contour lines of the joint distribution for precipitation and nitrogen loss were very dense at low precipitation intervals 50 mm indicating that the variation in probability was greatly affected by precipitation fig 6 the changes in temperature and nitrogen loss showed that at low nitrogen loss intervals the contour lines were dense indicating that the probability change was significantly affected by n loss based on the marginal probability p 2 corresponding to each threshold the probability of nitrogen loss under the defined meteorological conditions p 1 was calculated and the p 1 p 2 was also calculated to show the proportion of events associated with climate extremes in total high loss events fig 7 the results showed that with the variation in the organic nitrogen loss threshold there was a significant difference in the probability of nitrogen loss exceeding the threshold when precipitation was in the top 20 the probability of the org n loss exceeding the thresholds of 20 10 5 and 1 were 0 15 0 1 0 03 and 0 002 respectively the probability of an org n loss under the top 20 and 10 thresholds of temperature was lower than that under the same threshold of precipitation in comparison the risk was much higher when the temperature conditions were extreme fig 7b we also compared the conditional and total risks of org n pollution under the same extreme threshold fig 7e although the probability exceeding the 1 threshold was the lowest it accounted for the highest proportion of the total risk the top 1 20 high org n loss probability under the top 20 precipitation condition accounted for 77 75 63 and 46 of the total probability respectively spatial analysis showed that the probability in the headwater area and area near the outlet of the basin was high indicating that high precipitation and temperature increased the pollution risk in these areas fig s10 when no3 n exceeded the top 20 and 10 thresholds the risk of nitrate loss under specific precipitation thresholds was lower than that of organic nitrogen however the pollution risk was greater when no3 n exceeded the top 5 and 1 thresholds fig 7c the risk accounted for 32 36 under the top 20 temperature condition and 16 19 under the top 1 temperature of the total risk of nitrate pollution fig 7h the spatial risk map can provide information about which regions are more sensitive to the pressure of nitrate loss when meteorological factors occur at a specific severity fig s11 the risk in cropland was higher than that in forest and grassland under the nitrate loss which indicated that the nitrate loss was more vulnerable to increased precipitation and temperature in cropland 4 discussion 4 1 effects of climate on organic nitrogen and nitrate loss the migration and transformation of diffuse pollutants are mainly driven by the hydrological cycle and influenced by climate conditions land use co2 concentration and other factors dunn et al 2012 the correlation analysis showed that annual nitrogen loss was positively correlated with precipitation water yield and sediment which is supported by previous studies zhang et al 2020 xia et al 2020 we found that no3 n loss accounted for 73 of the total loss and org n accounted for 27 indicating that nitrate was the main nitrogen source in this area ji et al 2021 also demonstrated higher nitrate content in the wei river basin and the major sources of nitrate in water were chemical fertilizers and soil organic n the monthly variation showed that nitrogen loss was mainly concentrated in summer and autumn in winter nitrogen accumulates in the soil owing to soil frost and lack of runoff combined with low application leading to lower nitrogen loss in this season in cropland excess nitrogen leaches into the water body because of artificial fertilization resulting in the highest no3 n huang et al 2017 forest had the lowest org n but it had more no3 n than grassland forest residue is easily degraded by microorganisms which may lead to a diffuse nitrate potential in forest watersheds gorsevski et al 2008 ouyang et al 2022 our analysis showed that the increase in org n in the extreme wet period was more intense than in other precipitation conditions as adsorbed nitrogen org n is easily adsorbed by soil colloids and lost through soil erosion ouyang et al 2017 high precipitation and abundant soil water were more likely to generate runoff and more nitrogen was removed when the temperature rises microbial activity is stimulated and the related chemical reaction i e mineralization and nitrification rate increases leading to increased n storage in the soil layer and nitrogen loss however when the temperature was too high the denitrification efficiency and efficiency of n absorption by the plants increased which could reduce the nitrogen loss veraart et al 2011 we also found that the condition of underlying surface was also a key factor affecting the spatial distribution of n loss xing et al 2016 under high temperature condition the nitrogen loss in headwater areas with high slope and middle areas where cropland is concentrated were high at low temperatures even if n input was less nitrogen in headwater areas was more likely to migrate because of steep slope so n loss was larger than that in middle basin 4 2 influence and driving factors of extreme climate indices on diffuse nitrogen loss based on the lmg method the factors related to extreme precipitation dominated the loss of org n in nearly 80 of the basin especially in cropland and grassland highlighting the high sensitivity of org n variation to precipitation fluctuation in water deficient regions the enhancement of the summer monsoon brings more extreme precipitation with a higher frequency and intensity to the monsoon region such as our study area which can greatly promote org n loss freychet et al 2015 forest could intercept the precipitation through the canopy litter and root layers to improve the soil erosion resistance so the proportion of areas where precipitation is the driving factor was small du et al 2019 extremely high temperatures are an important driving factor in forest the forest might rely on the death of animals and plants to supplement the organic nitrogen pool therefore an increase in temperature would accelerate biodegradation and increase organic nitrogen philben et al 2016 organic nitrogen with high bioavailability is an important link between the nutrient cycle and life processes in water bodies zhu et al 2019 the degradation of excess org n consumes more oxygen and releases inorganic n affecting nutrient conversion and destroying healthy ecosystems in addition to heavy precipitation cdd is an important driving factor in cropland mainly contributing negatively long term precipitation reduces soil water and intensifies water stress which may slow material migration the driving force for extreme precipitation events is relatively high compared with temperature events although the impact of extremely high temperatures is relatively small the temperature is the decisive factor in the eutrophication of water bodies most water blooms occur during periods of high temperature and strong light which may still cause serious water pollution zhao et al 2022 the cmip6 model predicted that under different ssp scenarios more frequent and intense extreme events would cause a greater proportion of pollution in the future almazroui et al 2021 our study area is semi arid and the limited water quantity would be further reduced by water pollution which might cause more severe water stress than in humid areas mateo sagasta et al 2018 more effective nutritional management interventions are needed to reverse this trend 4 3 implications for pollution risk assessment and uncertainty analysis traditional identification method for critical source area is a compromise solution to determine the csa because it mainly focuses on the annual diffuse n loss and mainly reflects the comprehensive influence of various factors on spatial distribution collick et al 2015 our results showed that extreme climates promoted the loss of n indicating that it is necessary to pay attention to the emission of nitrogen under extreme conditions mellander et al 2018 however traditional method could not adequately reflect area with potential high n loss under extreme precipitation and temperature conditions which might implement relevant control measures inadequately based on this we chose copula function to analyze the probability of bivariate data exceeding the threshold we found that the headwater and lower basin sections had the greatest pollution risk under different precipitation conditions which might be related to human activities and terrain characteristics agricultural measures in cropland and steeper slopes in headwater areas have made the nitrogen loss more affected by climate mamun et al 2020 high temperatures stimulated soil nitrogen mineralization and promoted soil nitrification by increasing the environmental oxidation capacity it has been reported that nitrate loss intensity is extremely sensitive to high temperatures and regions with annual average temperatures higher than 10 c have a higher risk of nitrogen loss meyer et al 2018 it should be emphasized that nitrogen pollution in cropland with many artificial measures was easily affected by high precipitation and temperature since 2000 land use in the chinese loess plateau has changed greatly because of the large scale ecological restoration program e g the grain for green program which has alleviated the loss of n compared with cropland forest and grassland have a stronger water and soil conservation capacity which could make the nitrogen elements better intercepted resulting in less risk hu et al 2021 furthermore from the probability ratio analysis we found that 7 77 of the high loss risks were caused by extreme weather which further explained the importance of extreme meteorological factors therefore management should prioritize the control measures in these high risk areas when extreme events occur to prevent threats to the water environment because of extreme climate conditions the risk assessment for nitrogen loss by copulas in this study also had some uncertainties in addition to climatic factors variations in the water environment are affected by various factors in future studies we need to identify the influencing factors including hydrology land use and human activities and the uncertainty of their impact on water security in basins to obtain more reasonable results and support actual risk management decisions furthermore our risk assessment method only considers monthly data not daily data this assumption may underestimate the nitrogen loss risk caused by high precipitation and temperature therefore our method can be treated as a lower estimation bound of the risk of real world nitrogen loss induced by climate a more detailed assessment merits further analysis 5 conclusion in this study the dominant climatic drivers for different forms of nitrogen loss in the umwb were identified and the pollution risk under different climate conditions was quantified based on swat and copulas during the past 50 years 1971 2020 the nitrate loss decreased at an average rate of 0 02 kg ha year whereas the organic nitrogen loss increased during the study period the loss of org n was highest under sufficient precipitation conditions mainly in cropland and grassland the results of the correlation analysis showed that precipitation and nitrogen loss had a nonlinear positive correlation whereas the correlation between temperature and nitrogen loss was more complex under different climate conditions in this semi arid basin the org n loss was mainly driven by high precipitation r95p and the control area accounted for 82 tx90p is also more important than the other drivers especially in forest regarding nitrate loss r95p normal precipitation amount and cdd were the most important climatic drivers finally after identifying critical source areas prone to diffuse pollution this study quantified the risk of pollution in basin under extreme climatic conditions with four thresholds from the new perspective of considering the combined effects of climate factors and nitrogen loss the probabilities of org n and nitrate loss exceeding the top 1 20 were 0 2 15 and 0 8 10 when the precipitation exceeded the top 20 given the future changing climate and enhanced hydroclimatic extreme events the methods provided in this study have implications for watershed nitrogen management and eutrophication reduction declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgments the present work was financially supported by the key project of national natural science foundation of china 52239005 the fund for innovative research group of the national natural science foundation of china 52221003 and national natural science foundation of china 42271326 appendix a supplementary data supplementary data to this article can be found online at https doi org 10 1016 j jhydrol 2023 129412 appendix a supplementary data the following are the supplementary data to this article supplementary data 1 
2029,soil moisture plays an important role in numerical weather forecasting and climate projection studies surface runoff is significant not only in soil moisture monitoring but also in flood forecasting however the current noah land surface model with multi parameterization options noah mp is nearly vertical and one dimensional and it does not consider surface water ponding and overland flow to address this lateral terrestrial water flow schemes has been developed for noah mp on both natural and urban land surfaces to improve the simulation of soil moisture these schemes have enabled the conversion of noah mp to a three dimensional land surface model noah mp 3d water balance schemes for natural and urban surfaces have also been developed and coupled with noah mp 3d to improve water inundation simulation the performance of noah mp and noah mp 3d has been compared and validated at two soil moisture observation sites the results indicate that after using the terrestrial lateral flow schemes has significantly improved the simulations for 10 cm and 40 cm volumetric soil moisture keywords lateral terrestrial water flow soil moisture noah mp water balance schemes 1 introduction soil moisture is a crucial surface state variable in numerical weather forecasting and climate projection studies as highlighted by various studies koster et al 2004 santanello et al 2019 kumar et al 2020 humphrey et al 2021 infiltration plays a pivotal role in modeling surface soil moisture as it is not only impacted by precipitation and soil evaporation but also influences surface runoff surface runoff is an indispensable component not only for soil moisture monitoring but also in flood forecasting tellman et al 2021 land surface models are crucial component of numerical weather forecasts and earth system models however current models such as the noah land surface model with multi parameterization options noah mp chen et al 1996 chen et al 1997 niu et al 2011 are mostly vertical and one dimensional and do not account for surface water ponding and overland flow to address this limitation hydrological models bouilloud et al 2010 li et al 2013 shi et al 2014 have been coupled with land surface models for instance the variable infiltration capacity model version 5 vic 5 hamman et al 2018 the community land model version 5 clm5 lawrence et al 2019 and the hydrologic enhanced version of the weather research and forecasting model wrf hydro rummler et al 2019 zhang et al 2019 arnault et al 2021 gochis et al 2021 pal et al 2021 are widely used to simulate surface water routing and water inundation however these models have limitations vic 5 for example has a relatively coarse spatial resolution and is unsuitable for urban surfaces clm5 addresses the problem of surface water routing by incorporating the model for scale adaptive river transport mosart still it needs to consider the mechanisms of the water balance scheme in both natural and urban surfaces wrf hydro on the other hand considers lateral terrestrial water flow at the subgrid scale by regarding excess infiltration capacity as ponded water that is subsequently available for lateral redistribution gochis et al 2021 to fully parameterize lateral terrestrial water flow and routing in both natural and urban areas land surface routing schemes should be coupled with the vertical water balance schemes and the land surface model should be converted to a three dimensional model this paper presents lateral terrestrial water flow schemes for noah mp niu et al 2011 on both natural and urban land surfaces to improve soil moisture simulation water balance schemes for natural and urban surfaces meng 2021 are developed and coupled with noah mp to improve water inundation simulation by using the lateral terrestrial water flow schemes and coupling them with the water balance schemes noah mp is transformed into a three dimensional land surface model noah mp 3d compared to vertical one dimensional models the main advantages of 3d models are their spatial representation and resolution however 3d models are usually computationally expensive which is their major disadvantage so in this paper they are only validated on a relatively small scale the noah mp 3d model can be used for flooding simulation on both natural and urban land surfaces and coupled with numerical weather forecast models the ponded water depth is used as the prognostic variable to validate the improvement of noah mp 3d in the simulation of soil moisture noah mp and noah mp 3d are compared and validated at two soil moisture observation sites the findings of this paper are important for flooding simulation numerical weather forecasting and climate projection 2 model development the noah mp niu et al 2011 was developed by incorporating improved physics and multiple options of various parameterization schemes of land surface processes based on the noah land surface model lsm chen et al 1996 chen et al 1997 noah mp is a vertical one dimensional land surface model that does not consider surface water ponding and overland flow in noah mp the soil moisture is the unique prognostic variable in water balance modeling and its variation is associated with precipitation surface runoff and evapotranspiration to parameterize the land surface overland flow noah mp needs to be converted into a three dimensional model noah mp 3d and all the parameters related to the surface overland flow must be converted to three dimensional parameters one dimensional parameters that are only associated with soil depth must be converted to three dimensional parameters that are not only associated with soil depth but also associated with longitude and latitude zero dimensional parameters must be converted to two dimensional parameters associated with longitude and latitude the diffusive wave formulation julien et al 1995 ogden 1997 calculates the surface overland flow which is considered as the net flow between the outflow and the inflow to simplify the scheme the one dimensional overland flow routing method is used here the surface water only flows to the grid surrounding the central grid with the largest slope and the amount of the outflow can be described as follows gochis et al 2021 1 r out m i n depth dt depth 5 3 maxslope z 0 m where r out is the surface outflow m s 1 depth is the ponded water depth m dt is the time step s z 0 m is the surface roughness length m and maxslope is the maximum terrain slope which is calculated based on the elevation and ponded water depth of the central grid and the surrounding grids for corner grids the number of surrounding grids is 3 for boundary grids the number of surrounding grids is 5 and for other grids the number of surrounding grids is 8 see fig 1 2 maxslope m a x slope 1 slope n s l o p e hgt w d dr where n is the number of surrounding grids slope is the terrain slope hgt is the elevation height m wd is the ponded water depth m and dr is the distance between the central grid and the surrounding grid m for north east south and west surrounding grids dr is equal to the grid spacing while for northwest northeast southwest and southeast surrounding grids dr is equal to the square root of two multiplied by the grid spacing at the same time as the outflow grid is defined the outflow direction and the amount of inflow r in are also determined for natural surfaces infiltration is associated with surface water flow and can be described as follows 3 i n m i n i max p l dew e n t r in r out where i n is the infiltration m s 1 and i max is the maximum infiltration m s 1 which is associated with the porosity and the volumetric soil moisture and can be described as follows 4 i max p o r s 1 z 1 1 Œ∏ 1 p o r s 2 z 2 1 Œ∏ 2 d t where p o r s 1 and p o r s 2 are the porosities of the first and second layers of soil z 1 and z 2 are the depths of first and second layers of soil m and Œ∏ 1 and Œ∏ 2 are the volumetric soil moistures of the first and second layers of soil p is the precipitation m s 1 l dew is the leaf interception m s 1 e n is the evaporation m s 1 of the natural surface and t is the transpiration m s 1 the ponded water depths for natural and urban surfaces are based on meng 2021 after considering the surface water flow the ponded water depths on natural and urban surfaces are calculated as follows 5 w n t p l dew e n t i n r in r out w n 0 6 w r t p e r d i r r in r out w u 0 where w n and w r are the ponded water depths m on natural and urban surfaces respectively e r is the evaporation m s 1 of the urban surface d is the drainage rate m s 1 and i r is the infiltration m s 1 of urban surfaces the infiltration of the urban surface is calculated as follows 7 i r m i n w r dt p er i n where p er is the fraction of pervious surfaces for natural land surfaces soil moisture is calculated based on the water balance scheme 8 Œ¥ z Œ∏ 1 t i n q 1 f root j e tr where Œ¥ z is the surface layer soil depth m Œ∏ 1 is the surface soil moisture f root j is the surface layer root fraction e tr is the transpiration m s 1 and q 1 is the outflow of the surface soil layer mm s 1 which is calculated based on darcy s law dingman 2002 9 q 1 k 1 œà z 1 where k 1 is the surface layer water conductivity m s 1 and œà is the soil matrix potential m 3 data and method 3 1 study sites and area this study focuses on the southwestern municipal area of beijing where the terrain slopes from northwest to southeast see fig 2 a the dominant land use categories lucs for each grid are determined based on the moderate resolution imaging spectroradiometer modis land cover type mcd12q1 version 6 data from 2012 see fig 2b the terra and aqua combined modis land cover type mcd12q1 version 6 data product provides global land cover types at yearly intervals from 2001 to 2020 the data are derived from six different classification schemes listed in sulla menashe and friedl 2018 the mcd12q1 version 6 data product is obtained through supervised classifications of modis terra and aqua reflectance data these classifications are further refined through additional post processing incorporating prior knowledge and ancillary information to further refine specific classes two automatic soil moisture observation sites panggezhuang and longfengling were selected to validate the soil moisture simulation fig 2a the slopes in eight directions at these two sites are shown in fig 3 a positive number indicates that the elevation of the surrounding grids is lower than that of the observation site while a negative number means that the elevation of the surrounding grids is higher panggezhuang site is located in low lying land and has relatively flat relief in contrast the longfengling site is situated on a hillside with relatively steep relief and a maximum positive slope 3 2 data this paper uses the 7 21 extreme rainstorm case to perform simulations precipitation data fig 4 along with near surface air temperature wind speed and direction near surface relative air humidity downward solar radiation downward longwave radiation near surface air pressure data and the initial field of soil temperature and moisture data are from the european centre for medium range weather forecasts ecmwf h√≥lm and petersen 2002 the ecmwf data have a spatial resolution of 3 km and a temporal resolution of 1 h the spatial distribution of aggregate precipitation in the research region is shown in fig 4 a the ecmwf data were spatially interpolated to 333 m by using a nearest neighbor method the values of rainfall have an uneven distribution in the study region with relatively large amounts especially in the southwest the spatially averaged precipitation is shown in fig 4 b rainfall occurred from 9 00 local solar time lst on july 21 2012 to 6 00 lst on july 22 2012 the soil moisture data were obtained using an automatic monitoring device that measures at depths of 10 cm and 40 cm the observation data were downloaded from national meteorological information center of china at data cma cn the soil moisture data were observed using an automatic tensiometer 3 3 experimental design two sets of experiments were designed to perform the simulation set 1 is the control run and the lateral terrestrial flow schemes were not used the noah mp was used to implement the simulation set 2 is the contrast run and the lateral terrestrial flow schemes were used the noah mp 3d was used to implement the simulation the simulation time period is from 8 00 lst on july 21 2012 to 20 00 lst on july 22 2012 the spatial resolution of the two experiments is 333 m table 1 listed the sources of the initial values for the time variant variables and forcing variables as well as the values of the time invariant variables for the two models to ensure the objectivity of the intercomparison identical values were used for variables in both in noah mp and noah mp 3d all other variables mentioned in section 2 of the paper are intermediate variables calculated by the models themselves 4 results and discussion according to equation 1 the lateral flow flux on terrestrial surfaces is contingent upon the maximum slope of the terrain in the surrounding grid cells as illustrated in fig 5 the study area exhibits pronounced variability in maximum terrain slope with particularly steep slopes observed in the western portion and greater elevational gradients overall fig 6 illustrated the accumulated surface runoff during the study period for both the control run and the contrast run in the control run the accumulated surface runoff for the entire research region is greater than or equal to zero as the water flow direction is not taken into consideration see fig 6a conversely the contrast run shows that some areas exhibit positive accumulated surface runoff while others exhibit negative accumulated surface runoff see fig 6b and 6c respectively equation 1 demonstrates that the accumulated surface runoff is closely associated with the maximum terrain slope specifically the hillside grid shows positive accumulated terrestrial lateral flows while for the low lying land grid shows negative accumulated terrestrial lateral flows in the contrast run we include water inundation depth as a prognostic variable to simulate the urban inundation and mountain flooding fig 7 illustrates the flood s advancement and retreat along with the variation in the water inundation depth the water inundation depth is related to terrain height and the maximum slope as shown in fig 8 which displays inundation areas categorized by three different water depths the flood initiation time is at lst 6 00 on july 21 while the inundation area reaches its maximum value at lst 23 00 on the same day the maximum inundation areas with water depths greater than 1 cm 5 cm and 10 cm are approximately 1900 km2 1600 km2 and 1200 km2 respectively we conducted a comparative analysis of the inundation area data with wang et al 2013 and our results shows a close resemblance to theirs as depicted in equations 3 and 8 the terrestrial lateral flow flux is closely linked to infiltration which represents a critical parameter for characterizing volumetric soil moisture therefore we conducted a comparative analysis of the simulated volumetric soil moisture during the simulation period for both the control run and the contrast run as illustrated in figs 9 10 in this paper we define the surface volumetric soil moisture as zero for urban underlying surfaces for hillside regions where the terrestrial lateral flows are positive the volumetric soil moisture for all four layers is lower in the contrast run than in the control run in most areas in low lying regions the volumetric soil moisture for all four layers is affected not only by terrestrial lateral flow but also by the maximum infiltration leading to complex comparison results to validate the volumetric soil moisture simulation results we compared the control runs and contrast runs with observations at two automatic soil moisture observation sites fig 11 table 2 displays the biases mean errors mes root mean square errors rmses and correlation coefficients rs for 10 cm and 40 cm volumetric soil moisture simulations relative to observations terrestrial lateral flow schemes significantly improved simulations of 10 cm and 40 cm volumetric soil moisture the panggezhuang site located in low lying land had a negative terrestrial lateral flow flux and using these schemes increased both 10 cm and 40 cm volumetric soil moisture compared to simulation results in the experiment set 1 quantitative comparisons showed that using these schemes decreased biases of 10 cm and 40 cm volumetric soil moisture by approximately 81 and 64 respectively the longfengling site located on a hillside had a positive terrestrial lateral flow flux and using these schemes decreased both 10 cm and 40 cm volumetric soil moisture compared to simulation results in the experiment set 1 quantitative comparisons showed that using these schemes decreased biases of 10 cm and 40 cm volumetric soil moisture by approximately 35 and 25 respectively 5 summary in this paper lateral terrestrial water flow schemes have been developed for noah mp on both natural and urban land surfaces to improve the simulation of soil moisture the depths of water inundation in both natural and urban land surfaces are used as prognostic variables to simulation the floods and urban waterlogging as the results the findings of this paper can be not only used in numerical forecast but can be used in agriculture and hydrology in both mountainous and urban regions these schemes have enabled the conversion of noah mp to a three dimensional land surface model noah mp 3d the results demonstrate that the depth of water inundation correlates with both the height of the terrain and the maximum slope in hillside areas the positive terrestrial lateral flow led to a decrease in volumetric soil moisture in most regions when compared to the control run for low lying regions volumetric soil moisture is influenced not only by terrestrial lateral flow but also by the maximum infiltration resulting in complex comparison results however the use of terrestrial lateral flow schemes led to a definite improvement in simulations of the 10 cm and 40 cm volumetric soil moisture in the foreseeable future it is imperative to conduct a thorough investigation of the parameters employed in terrestrial lateral flow schemes including surface roughness length drainage rate maximum infiltration and fraction of impervious surface to enhance the accuracy of the simulation of terrestrial lateral flow flux the implementation of the two dimensional diffusive wave formulation is strongly recommended furthermore it is essential to validate the terrestrial lateral flow schemes over extended time periods and larger regions by means of comparative analysis with observational data credit authorship contribution statement chunlei meng conceptualization methodology software validation writing original draft project administration funding acquisition haidong jin formal analysis investigation resources data curation wenlong zhang writing review editing visualization supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by the national natural science foundation of china under grant 42130108 and typhoon foundation of shanghai typhoon institute cma under grant tfjj202106 we thank modis for lulc data https lpdaac usgs gov products mcd12q2v006 dr chengcheng huang and haibo hu for the ecmwf meteorological reanalysis data ms jing chen for the soil moisture observation data 
2029,soil moisture plays an important role in numerical weather forecasting and climate projection studies surface runoff is significant not only in soil moisture monitoring but also in flood forecasting however the current noah land surface model with multi parameterization options noah mp is nearly vertical and one dimensional and it does not consider surface water ponding and overland flow to address this lateral terrestrial water flow schemes has been developed for noah mp on both natural and urban land surfaces to improve the simulation of soil moisture these schemes have enabled the conversion of noah mp to a three dimensional land surface model noah mp 3d water balance schemes for natural and urban surfaces have also been developed and coupled with noah mp 3d to improve water inundation simulation the performance of noah mp and noah mp 3d has been compared and validated at two soil moisture observation sites the results indicate that after using the terrestrial lateral flow schemes has significantly improved the simulations for 10 cm and 40 cm volumetric soil moisture keywords lateral terrestrial water flow soil moisture noah mp water balance schemes 1 introduction soil moisture is a crucial surface state variable in numerical weather forecasting and climate projection studies as highlighted by various studies koster et al 2004 santanello et al 2019 kumar et al 2020 humphrey et al 2021 infiltration plays a pivotal role in modeling surface soil moisture as it is not only impacted by precipitation and soil evaporation but also influences surface runoff surface runoff is an indispensable component not only for soil moisture monitoring but also in flood forecasting tellman et al 2021 land surface models are crucial component of numerical weather forecasts and earth system models however current models such as the noah land surface model with multi parameterization options noah mp chen et al 1996 chen et al 1997 niu et al 2011 are mostly vertical and one dimensional and do not account for surface water ponding and overland flow to address this limitation hydrological models bouilloud et al 2010 li et al 2013 shi et al 2014 have been coupled with land surface models for instance the variable infiltration capacity model version 5 vic 5 hamman et al 2018 the community land model version 5 clm5 lawrence et al 2019 and the hydrologic enhanced version of the weather research and forecasting model wrf hydro rummler et al 2019 zhang et al 2019 arnault et al 2021 gochis et al 2021 pal et al 2021 are widely used to simulate surface water routing and water inundation however these models have limitations vic 5 for example has a relatively coarse spatial resolution and is unsuitable for urban surfaces clm5 addresses the problem of surface water routing by incorporating the model for scale adaptive river transport mosart still it needs to consider the mechanisms of the water balance scheme in both natural and urban surfaces wrf hydro on the other hand considers lateral terrestrial water flow at the subgrid scale by regarding excess infiltration capacity as ponded water that is subsequently available for lateral redistribution gochis et al 2021 to fully parameterize lateral terrestrial water flow and routing in both natural and urban areas land surface routing schemes should be coupled with the vertical water balance schemes and the land surface model should be converted to a three dimensional model this paper presents lateral terrestrial water flow schemes for noah mp niu et al 2011 on both natural and urban land surfaces to improve soil moisture simulation water balance schemes for natural and urban surfaces meng 2021 are developed and coupled with noah mp to improve water inundation simulation by using the lateral terrestrial water flow schemes and coupling them with the water balance schemes noah mp is transformed into a three dimensional land surface model noah mp 3d compared to vertical one dimensional models the main advantages of 3d models are their spatial representation and resolution however 3d models are usually computationally expensive which is their major disadvantage so in this paper they are only validated on a relatively small scale the noah mp 3d model can be used for flooding simulation on both natural and urban land surfaces and coupled with numerical weather forecast models the ponded water depth is used as the prognostic variable to validate the improvement of noah mp 3d in the simulation of soil moisture noah mp and noah mp 3d are compared and validated at two soil moisture observation sites the findings of this paper are important for flooding simulation numerical weather forecasting and climate projection 2 model development the noah mp niu et al 2011 was developed by incorporating improved physics and multiple options of various parameterization schemes of land surface processes based on the noah land surface model lsm chen et al 1996 chen et al 1997 noah mp is a vertical one dimensional land surface model that does not consider surface water ponding and overland flow in noah mp the soil moisture is the unique prognostic variable in water balance modeling and its variation is associated with precipitation surface runoff and evapotranspiration to parameterize the land surface overland flow noah mp needs to be converted into a three dimensional model noah mp 3d and all the parameters related to the surface overland flow must be converted to three dimensional parameters one dimensional parameters that are only associated with soil depth must be converted to three dimensional parameters that are not only associated with soil depth but also associated with longitude and latitude zero dimensional parameters must be converted to two dimensional parameters associated with longitude and latitude the diffusive wave formulation julien et al 1995 ogden 1997 calculates the surface overland flow which is considered as the net flow between the outflow and the inflow to simplify the scheme the one dimensional overland flow routing method is used here the surface water only flows to the grid surrounding the central grid with the largest slope and the amount of the outflow can be described as follows gochis et al 2021 1 r out m i n depth dt depth 5 3 maxslope z 0 m where r out is the surface outflow m s 1 depth is the ponded water depth m dt is the time step s z 0 m is the surface roughness length m and maxslope is the maximum terrain slope which is calculated based on the elevation and ponded water depth of the central grid and the surrounding grids for corner grids the number of surrounding grids is 3 for boundary grids the number of surrounding grids is 5 and for other grids the number of surrounding grids is 8 see fig 1 2 maxslope m a x slope 1 slope n s l o p e hgt w d dr where n is the number of surrounding grids slope is the terrain slope hgt is the elevation height m wd is the ponded water depth m and dr is the distance between the central grid and the surrounding grid m for north east south and west surrounding grids dr is equal to the grid spacing while for northwest northeast southwest and southeast surrounding grids dr is equal to the square root of two multiplied by the grid spacing at the same time as the outflow grid is defined the outflow direction and the amount of inflow r in are also determined for natural surfaces infiltration is associated with surface water flow and can be described as follows 3 i n m i n i max p l dew e n t r in r out where i n is the infiltration m s 1 and i max is the maximum infiltration m s 1 which is associated with the porosity and the volumetric soil moisture and can be described as follows 4 i max p o r s 1 z 1 1 Œ∏ 1 p o r s 2 z 2 1 Œ∏ 2 d t where p o r s 1 and p o r s 2 are the porosities of the first and second layers of soil z 1 and z 2 are the depths of first and second layers of soil m and Œ∏ 1 and Œ∏ 2 are the volumetric soil moistures of the first and second layers of soil p is the precipitation m s 1 l dew is the leaf interception m s 1 e n is the evaporation m s 1 of the natural surface and t is the transpiration m s 1 the ponded water depths for natural and urban surfaces are based on meng 2021 after considering the surface water flow the ponded water depths on natural and urban surfaces are calculated as follows 5 w n t p l dew e n t i n r in r out w n 0 6 w r t p e r d i r r in r out w u 0 where w n and w r are the ponded water depths m on natural and urban surfaces respectively e r is the evaporation m s 1 of the urban surface d is the drainage rate m s 1 and i r is the infiltration m s 1 of urban surfaces the infiltration of the urban surface is calculated as follows 7 i r m i n w r dt p er i n where p er is the fraction of pervious surfaces for natural land surfaces soil moisture is calculated based on the water balance scheme 8 Œ¥ z Œ∏ 1 t i n q 1 f root j e tr where Œ¥ z is the surface layer soil depth m Œ∏ 1 is the surface soil moisture f root j is the surface layer root fraction e tr is the transpiration m s 1 and q 1 is the outflow of the surface soil layer mm s 1 which is calculated based on darcy s law dingman 2002 9 q 1 k 1 œà z 1 where k 1 is the surface layer water conductivity m s 1 and œà is the soil matrix potential m 3 data and method 3 1 study sites and area this study focuses on the southwestern municipal area of beijing where the terrain slopes from northwest to southeast see fig 2 a the dominant land use categories lucs for each grid are determined based on the moderate resolution imaging spectroradiometer modis land cover type mcd12q1 version 6 data from 2012 see fig 2b the terra and aqua combined modis land cover type mcd12q1 version 6 data product provides global land cover types at yearly intervals from 2001 to 2020 the data are derived from six different classification schemes listed in sulla menashe and friedl 2018 the mcd12q1 version 6 data product is obtained through supervised classifications of modis terra and aqua reflectance data these classifications are further refined through additional post processing incorporating prior knowledge and ancillary information to further refine specific classes two automatic soil moisture observation sites panggezhuang and longfengling were selected to validate the soil moisture simulation fig 2a the slopes in eight directions at these two sites are shown in fig 3 a positive number indicates that the elevation of the surrounding grids is lower than that of the observation site while a negative number means that the elevation of the surrounding grids is higher panggezhuang site is located in low lying land and has relatively flat relief in contrast the longfengling site is situated on a hillside with relatively steep relief and a maximum positive slope 3 2 data this paper uses the 7 21 extreme rainstorm case to perform simulations precipitation data fig 4 along with near surface air temperature wind speed and direction near surface relative air humidity downward solar radiation downward longwave radiation near surface air pressure data and the initial field of soil temperature and moisture data are from the european centre for medium range weather forecasts ecmwf h√≥lm and petersen 2002 the ecmwf data have a spatial resolution of 3 km and a temporal resolution of 1 h the spatial distribution of aggregate precipitation in the research region is shown in fig 4 a the ecmwf data were spatially interpolated to 333 m by using a nearest neighbor method the values of rainfall have an uneven distribution in the study region with relatively large amounts especially in the southwest the spatially averaged precipitation is shown in fig 4 b rainfall occurred from 9 00 local solar time lst on july 21 2012 to 6 00 lst on july 22 2012 the soil moisture data were obtained using an automatic monitoring device that measures at depths of 10 cm and 40 cm the observation data were downloaded from national meteorological information center of china at data cma cn the soil moisture data were observed using an automatic tensiometer 3 3 experimental design two sets of experiments were designed to perform the simulation set 1 is the control run and the lateral terrestrial flow schemes were not used the noah mp was used to implement the simulation set 2 is the contrast run and the lateral terrestrial flow schemes were used the noah mp 3d was used to implement the simulation the simulation time period is from 8 00 lst on july 21 2012 to 20 00 lst on july 22 2012 the spatial resolution of the two experiments is 333 m table 1 listed the sources of the initial values for the time variant variables and forcing variables as well as the values of the time invariant variables for the two models to ensure the objectivity of the intercomparison identical values were used for variables in both in noah mp and noah mp 3d all other variables mentioned in section 2 of the paper are intermediate variables calculated by the models themselves 4 results and discussion according to equation 1 the lateral flow flux on terrestrial surfaces is contingent upon the maximum slope of the terrain in the surrounding grid cells as illustrated in fig 5 the study area exhibits pronounced variability in maximum terrain slope with particularly steep slopes observed in the western portion and greater elevational gradients overall fig 6 illustrated the accumulated surface runoff during the study period for both the control run and the contrast run in the control run the accumulated surface runoff for the entire research region is greater than or equal to zero as the water flow direction is not taken into consideration see fig 6a conversely the contrast run shows that some areas exhibit positive accumulated surface runoff while others exhibit negative accumulated surface runoff see fig 6b and 6c respectively equation 1 demonstrates that the accumulated surface runoff is closely associated with the maximum terrain slope specifically the hillside grid shows positive accumulated terrestrial lateral flows while for the low lying land grid shows negative accumulated terrestrial lateral flows in the contrast run we include water inundation depth as a prognostic variable to simulate the urban inundation and mountain flooding fig 7 illustrates the flood s advancement and retreat along with the variation in the water inundation depth the water inundation depth is related to terrain height and the maximum slope as shown in fig 8 which displays inundation areas categorized by three different water depths the flood initiation time is at lst 6 00 on july 21 while the inundation area reaches its maximum value at lst 23 00 on the same day the maximum inundation areas with water depths greater than 1 cm 5 cm and 10 cm are approximately 1900 km2 1600 km2 and 1200 km2 respectively we conducted a comparative analysis of the inundation area data with wang et al 2013 and our results shows a close resemblance to theirs as depicted in equations 3 and 8 the terrestrial lateral flow flux is closely linked to infiltration which represents a critical parameter for characterizing volumetric soil moisture therefore we conducted a comparative analysis of the simulated volumetric soil moisture during the simulation period for both the control run and the contrast run as illustrated in figs 9 10 in this paper we define the surface volumetric soil moisture as zero for urban underlying surfaces for hillside regions where the terrestrial lateral flows are positive the volumetric soil moisture for all four layers is lower in the contrast run than in the control run in most areas in low lying regions the volumetric soil moisture for all four layers is affected not only by terrestrial lateral flow but also by the maximum infiltration leading to complex comparison results to validate the volumetric soil moisture simulation results we compared the control runs and contrast runs with observations at two automatic soil moisture observation sites fig 11 table 2 displays the biases mean errors mes root mean square errors rmses and correlation coefficients rs for 10 cm and 40 cm volumetric soil moisture simulations relative to observations terrestrial lateral flow schemes significantly improved simulations of 10 cm and 40 cm volumetric soil moisture the panggezhuang site located in low lying land had a negative terrestrial lateral flow flux and using these schemes increased both 10 cm and 40 cm volumetric soil moisture compared to simulation results in the experiment set 1 quantitative comparisons showed that using these schemes decreased biases of 10 cm and 40 cm volumetric soil moisture by approximately 81 and 64 respectively the longfengling site located on a hillside had a positive terrestrial lateral flow flux and using these schemes decreased both 10 cm and 40 cm volumetric soil moisture compared to simulation results in the experiment set 1 quantitative comparisons showed that using these schemes decreased biases of 10 cm and 40 cm volumetric soil moisture by approximately 35 and 25 respectively 5 summary in this paper lateral terrestrial water flow schemes have been developed for noah mp on both natural and urban land surfaces to improve the simulation of soil moisture the depths of water inundation in both natural and urban land surfaces are used as prognostic variables to simulation the floods and urban waterlogging as the results the findings of this paper can be not only used in numerical forecast but can be used in agriculture and hydrology in both mountainous and urban regions these schemes have enabled the conversion of noah mp to a three dimensional land surface model noah mp 3d the results demonstrate that the depth of water inundation correlates with both the height of the terrain and the maximum slope in hillside areas the positive terrestrial lateral flow led to a decrease in volumetric soil moisture in most regions when compared to the control run for low lying regions volumetric soil moisture is influenced not only by terrestrial lateral flow but also by the maximum infiltration resulting in complex comparison results however the use of terrestrial lateral flow schemes led to a definite improvement in simulations of the 10 cm and 40 cm volumetric soil moisture in the foreseeable future it is imperative to conduct a thorough investigation of the parameters employed in terrestrial lateral flow schemes including surface roughness length drainage rate maximum infiltration and fraction of impervious surface to enhance the accuracy of the simulation of terrestrial lateral flow flux the implementation of the two dimensional diffusive wave formulation is strongly recommended furthermore it is essential to validate the terrestrial lateral flow schemes over extended time periods and larger regions by means of comparative analysis with observational data credit authorship contribution statement chunlei meng conceptualization methodology software validation writing original draft project administration funding acquisition haidong jin formal analysis investigation resources data curation wenlong zhang writing review editing visualization supervision declaration of competing interest the authors declare that they have no known competing financial interests or personal relationships that could have appeared to influence the work reported in this paper acknowledgements this work was supported by the national natural science foundation of china under grant 42130108 and typhoon foundation of shanghai typhoon institute cma under grant tfjj202106 we thank modis for lulc data https lpdaac usgs gov products mcd12q2v006 dr chengcheng huang and haibo hu for the ecmwf meteorological reanalysis data ms jing chen for the soil moisture observation data 
